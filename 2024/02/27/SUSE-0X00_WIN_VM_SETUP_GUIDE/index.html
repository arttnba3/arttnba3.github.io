

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.png">
  <link rel="icon" href="/img/avatar.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="arttnba3">
  <meta name="keywords" content="">
  
    <meta name="description" content="4202 年了，Linux Desktop 还会好吗？">
<meta property="og:type" content="article">
<meta property="og:title" content="【SUSE.0x00】在 openSUSE 上食用 Win VM">
<meta property="og:url" content="https://arttnba3.github.io/2024/02/27/SUSE-0X00_WIN_VM_SETUP_GUIDE/index.html">
<meta property="og:site_name" content="arttnba3&#39;s blog">
<meta property="og:description" content="4202 年了，Linux Desktop 还会好吗？">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2024/02/21/MRftUv7gSXDbn8I.png">
<meta property="article:published_time" content="2024-02-27T03:22:58.000Z">
<meta property="article:modified_time" content="2024-02-27T18:00:15.622Z">
<meta property="article:author" content="arttnba3">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="虚拟化">
<meta property="article:tag" content="openSUSE">
<meta property="article:tag" content="openSUSE Tumbleweed">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://s2.loli.net/2024/02/21/MRftUv7gSXDbn8I.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>【SUSE.0x00】在 openSUSE 上食用 Win VM - arttnba3&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"arttnba3.github.io","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"§"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="arttnba3's blog" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 80vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>arttnba3&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/atom.xml">
                <i class="iconfont icon-rss"></i>
                rss
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://s2.loli.net/2024/02/28/5mcCALesxZbzUfq.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="【SUSE.0x00】在 openSUSE 上食用 Win VM"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-02-27 14:22" pubdate>
          2024年2月27日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          14k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          119 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">【SUSE.0x00】在 openSUSE 上食用 Win VM</h1>
            
              <p class="note note-info">
                
                  
                    本文最后更新于：2024年2月28日 凌晨
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>4202 年了，Linux Desktop 还会好吗？</p>
<span id="more"></span>

<h1 id="0x00-一切开始之前"><a href="#0x00-一切开始之前" class="headerlink" title="0x00. 一切开始之前"></a>0x00. 一切开始之前</h1><p>笔者自从 <code>Win 物理机 + Linux VM</code> 转到 <code>Almost all in Linux</code> 的生活已经过了大半年了，用 openSUSE 也已经小半年了，除了 Nvidia on Wayland 日常撕裂以及盒盖行为设定为 <code>Lock Screen</code> 会醒不来以外似乎还没有太多问题，但除了代码以外的日常生活总感觉不是特别彳亍：</p>
<h3 id="音乐"><a href="#音乐" class="headerlink" title="音乐"></a>音乐</h3><p>笔者比较喜欢使用酷狗音乐进行听歌（ <del>👴一直都是高贵的酷狗年费会员啊</del> ），但是酷狗是没有官方的 Linux 安装包的，使用 wine 兼任层可以跑起来但是笔者捣鼓了大半天都没有声音：(</p>
<blockquote>
<p>Arch 社区打的酷狗 AUR 包似乎可以正常播放，但是笔者也没有时间重新弄回 Arch 了，更没有那个闲时间去研究怎么在 SUSE 上弄了</p>
</blockquote>
<p>网易云音乐 <em>曾经有 Linux 版，但是用的 deb 打包，而且也非常久没有更新了，现在官网上也下架 Linux 版了</em> 因为笔者不常用网易云所以也没有尝试用 wine 跑过，但以 wine 现在的水平估计也不会好到哪去（</p>
<blockquote>
<p>腾讯音乐之类的就没有用过也不太打算尝试了：）</p>
</blockquote>
<p>海外的大部分听歌软件像 <a target="_blank" rel="noopener" href="https://www.spotify.com/">Spotify</a> 都是有 <a target="_blank" rel="noopener" href="https://www.spotify.com/au/download/linux/">Linux 版</a> 的，但是笔者也会听一些非常小众的歌，这些在 Spotify 上都是没有的，上边只有那些国际化大歌曲（ <del>这就不得不提国内很多小众音乐人的含金量了，什么叫世界第一强国啊</del> ）</p>
<p>但这还不算最要命的，Sportify 有个非常致命且非常 sb 的设计——<strong>电脑端的 Spotify 每听个一两首歌就会插入一段广告来逼你开会员</strong>，这样的产品策略让笔者很难去使用一些比较正面的词汇去进行评价</p>
<p><img src="https://s2.loli.net/2024/02/21/MRftUv7gSXDbn8I.png" srcset="/img/loading.gif" lazyload alt="try not to c*m in 30 seconds"></p>
<h3 id="Office-套件"><a href="#Office-套件" class="headerlink" title="Office 套件"></a>Office 套件</h3><p><a target="_blank" rel="noopener" href="https://www.libreoffice.org/discover/libreoffice/">LibreOffice</a> 作为大部分 Linux 发行版都会默认带着的开源 Office 套件，用着感觉虽然还行但是和 Microsoft Office 相比总感觉有哪里差点意思（<del>就是用着总感觉有哪里不得劲</del>），当然临时顶用其实还好但是 <em>直接重启切回 Windows 写文档不好么</em></p>
<p>——Microsoft Office 虽然没有 Linux 版但是有个网页版，支持在网页进行编辑甚至在网页上完成 PPT 演示的功能，但是网页版的用着总感觉 <em>也还是差点意思</em> ，而且和 native app 相比总感觉有些卡卡的，唯一的优点大概就是 all on cloud 不用担心数据丢失了：</p>
<p><img src="https://s2.loli.net/2024/02/21/K4tE6BdfTzigPDL.png" srcset="/img/loading.gif" lazyload alt="临时做个 PPT 演示还行，但是这样为什么不直接用 Windows 呢"></p>
<blockquote>
<p>至于国产 Office 套件 <a target="_blank" rel="noopener" href="https://www.wps.com/">WPS</a>，技术水平暂且不谈,当笔者在自家老母亲的旧电脑上打开这软件后跳出一堆各种花花绿绿的广告铺满屏幕然后让电脑变得特别特别卡的时候笔者就决定<strong>哪怕再多花点钱多买几套正版的 Office 也不会再考虑这一款国产软件</strong></p>
<blockquote>
<p>当然，除了这个问题以外，WPS 还存在<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/542676012">数据安全问题</a>，那这是否就有点…</p>
</blockquote>
</blockquote>
<h3 id="办公软件"><a href="#办公软件" class="headerlink" title="办公软件"></a>办公软件</h3><p>在这个 QQ 都转向 NTQQ 的 4202 年微信还是迟迟不出 Linux 版就令人很难评了<del>这就不得不提某人的含马量了（）</del>，使用 wine 来运行 WeChat 勉强算是一个可行的策略，但是强行用 wine 跑起来的微信只能说是勉强能用，各种功能缺失以及不完整再加上 wine 的功能不完善带来的令人难以直视的各种边框更是让人想要毁灭世界，而功能本就缺失的网页版微信也慢慢变得不再可用，想要在 openSUSE 上完美使用微信似乎已经变成了一种奢求</p>
<p><img src="https://s2.loli.net/2024/02/23/FoyxtmMUnrJzel9.png" srcset="/img/loading.gif" lazyload alt="有没有深圳上单能去猎一下某人的🐎.jpg"></p>
<p>海外的办公软件如 Slack 和 Discord （这个大概勉强也能算办公软件）倒是有原生 Linux 版，What’s App 有网页版但是笔者倒是没有用过，Teams 则只有网页版可用</p>
<blockquote>
<p>飞书以及其海外版 Lark 却是都有非常好用的原生 Linux 版， <del>那这里👴就不得不夸一夸👴的前东家国际化大企业字节跳动的含金量了</del> </p>
<p>至于像钉钉这样的软件似乎也是有 Linux 版，不过笔者基本用不到这个软件所以暂且就不进行深入了解了</p>
</blockquote>
<h3 id="游戏及各类其它问题"><a href="#游戏及各类其它问题" class="headerlink" title="游戏及各类其它问题"></a>游戏及各类其它问题</h3><p>这里就不展开说了，因为前面已经讲了这么多废话了，同时笔者也懒得再打字了，总而言之 Linux 除了与计算机专业直接强相关的东西以外似乎都没有比较完美的原生解决方案，这令笔者十分苦恼 ：(</p>
<h2 id="How-to-解决？"><a href="#How-to-解决？" class="headerlink" title="How to 解决？"></a>How to 解决？</h2><p>让我们重新回顾《虚拟化导论》中的一个基本概念：<code>只要我们能够通过某种方式向上层提供表现相同的抽象接口，在上层看来我们就是正常的该层所提供的资源，从而就实现了对该层的虚拟化</code> ；因此对于 <code>想要在 Linux 下运行 Windows 独占的软件</code> 这个需求而言，我们只需要提供一个相应的兼容层便能运行——<a target="_blank" rel="noopener" href="https://www.winehq.org/">wine</a> 便是这样一个软件，其通过提供相应的 Windows 执行环境（如重新实现各种 DLL）来实现，虽然说目前已经能够流畅地运行很多原生 Windows 软件，但是要把整个 Windows 都给重新实现一遍的工作量相当巨大，至少就目前而言还是缺少相当多的各种不同的运行库，难以真正地在 *NIX 系统上完美无缝运行 Windows 下的二进制程序</p>
<p><img src="https://s2.loli.net/2024/02/23/6asVIrGX1WygDmq.png" srcset="/img/loading.gif" lazyload alt="网易云其实原本是有 Linux 原生的，可惜前几年终止开发了"></p>
<p>重新再看虚拟化层次的划分，Wine 是通过实现了 API 抽象层来完成 Windows 各种运行库的虚拟化，那么再往下一层呢——若是我们能够实现硬件抽象层，我们便能完成操作系统级的虚拟化，这样我们自然便有了一个对应操作系统的完整运行环境——即通过<strong>虚拟机</strong>（Virtual Machine）来运行一个完整的 Windows 系统，这样<strong>我们便能完美运行原生的 Windows 程序</strong> ，若是之后我们再将一些必要的设备给 passthrough 进 Windows 中（或是纯模拟也行）、建立好完善的共享文件夹等机制，我们便能舒适地将 Windows 虚拟机融入到我们的 Linux 物理机当中：）</p>
<blockquote>
<p>当然，虚拟机的性能损耗肯定是有的，但很多情况下这些性能损耗其实无所谓 ：）</p>
</blockquote>
<p><img src="https://s2.loli.net/2022/08/02/lDLgE6tyNe87M12.png" srcset="/img/loading.gif" lazyload></p>
<p>因此本篇文章将教大家如何在 Linux 上优雅地食用 Windows 虚拟机</p>
<blockquote>
<p>——好吧， <em>运行一个 Windows 虚拟机来跑 Windows 程序这件事似乎是没有任何的新意</em> ，<strong>但若是我们能够通过 RDP 连接直接映射不同的程序窗口而非整个桌面呢？</strong> ——<code>远程桌面协议</code>（Remote Desktop Protocol）让通过网络的远程计算机桌面图像传输与鼠标键盘事件传输成为了可能，同时 xfreerdp 支持仅传输单个应用窗口，由此<strong>我们就能达成在 Linux 桌面中近乎完美地原生运行 Windows 程序的效果</strong></p>
<p><img src="https://s2.loli.net/2024/02/21/uqlDdERXCQpo3Z7.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>不过由于各种问题，<strong>目前这种办法依然存在较大的 bug，没办法足够舒适地运行</strong>，目前而言只能继续期待后人的努力：）</p>
</blockquote>
<h1 id="0x01-通过-Virt-Manager-KVM-运行一个-Windows-虚拟机"><a href="#0x01-通过-Virt-Manager-KVM-运行一个-Windows-虚拟机" class="headerlink" title="0x01. 通过 Virt-Manager + KVM 运行一个 Windows 虚拟机"></a>0x01. 通过 Virt-Manager + KVM 运行一个 Windows 虚拟机</h1><h2 id="安装虚拟化相关组件"><a href="#安装虚拟化相关组件" class="headerlink" title="安装虚拟化相关组件"></a>安装虚拟化相关组件</h2><blockquote>
<p>参考 <a target="_blank" rel="noopener" href="https://doc.opensuse.org/documentation/leap/virtualization/html/book-virtualization/index.html">openSUSE - Virtualization Guide</a> 和 <a target="_blank" rel="noopener" href="https://zh.opensuse.org/KVM">openSUSE wiki - KVM</a> 以及 <a target="_blank" rel="noopener" href="https://documentation.suse.com/zh-cn/sles/15-SP4/html/SLES-all/cha-kvm-intro.html"> SUSE Linux Enterprise Server 文档 - 虚拟化指南</a></p>
</blockquote>
<p>首先检查自己的 CPU 是否支持硬件虚拟化（<del>不过这个年代应该没有不支持硬件虚拟化的 CPU 了吧</del>）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo LC_ALL=C lscpu | grep Virtualization</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>如果没有结果的话重启进 BIOS&#x2F;UEFI 里开一下，有些机型默认不会开启 CPU 虚拟化，<del>若是真的不支持硬件虚拟化那笔者还是建议你赶紧换一台电脑，或者至少换个 U 吧，都什么年代还在用传统电脑</del></p>
</blockquote>
<p>然后安装 libvirt,一个非常舒适的虚拟机管理库，这里直接用 YaST 来安会非常方便：</p>
<p><img src="https://s2.loli.net/2024/02/21/MeTP9qdfWFSRG6g.png" srcset="/img/loading.gif" lazyload alt="这就是我们 SUSE 的 YaST 啊，你们有没有这样的 YaST 啊，真是 YY 又 aa、SS 又 TT 啊.jpg"></p>
<blockquote>
<p>这里笔者安完才发现忘了勾上 <code>KVM server</code> 了，但是再打开发现按钮灰了没办法补勾上…..不过也无所谓了反正看这篇文章的小伙伴记得勾上就好 ：）</p>
</blockquote>
<p>然后安装 virt-manager 和 libvirt-daemon：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo zypper <span class="hljs-keyword">in</span> virt-manager libvirt-daemon</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl <span class="hljs-built_in">enable</span> libvirtd</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl start libvirtd</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>QEMU 的话因为要做 kernel pwn 的缘故笔者很早就安装上了所以安装步骤这里就略过了，这里大家就自己想办法安吧（笑</p>
</blockquote>
<p>在 <code>.bash_profile</code> 里导入这个变量：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> LIBVIRT_DEFAULT_URI=qemu:///system<br></code></pre></td></tr></table></figure>

<p>把自己加相应的组里再重启：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo usermod -a -G libvirt $(<span class="hljs-built_in">whoami</span>)</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo usermod -a -G kvm $(<span class="hljs-built_in">whoami</span>)</span><br></code></pre></td></tr></table></figure>

<p>配置 default 网络：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo virsh net-define /usr/share/libvirt/networks/default.xml</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo virsh net-autostart default</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo virsh net-start default</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>注：libvirt 默认的 NAT 网络<strong>似乎有些小问题</strong> （参见 <a target="_blank" rel="noopener" href="https://doc.opensuse.org/documentation/leap/virtualization/html/book-virtualization/cha-libvirt-host.html">openSUSE doc</a>），如果你没法联网那笔者还是建议使用桥接模式</p>
</blockquote>
<h2 id="安装-Windows-虚拟机"><a href="#安装-Windows-虚拟机" class="headerlink" title="安装 Windows 虚拟机"></a>安装 Windows 虚拟机</h2><p>首先在 virt-manager 里 enable 上 xml 编辑：</p>
<p><img src="https://s2.loli.net/2024/02/22/ZgwYWakbBunNDTR.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>然后下载 <a target="_blank" rel="noopener" href="https://www.microsoft.com/software-download/windows11">Windows ISO</a> 和 <a target="_blank" rel="noopener" href="https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso">KVM virtio Drivers</a></p>
<p>之后在 virt-manager 里创建一个虚拟机，创建过程中别忘了勾上 <code>Customize configuration before install</code> ，完成基本配置后挂上第二个 ISO：</p>
<p><img src="https://s2.loli.net/2024/02/22/BrWcYaihNm83lu9.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>然后在 CPU 的 XML 里编辑 <code>clock</code> ，<strong>修改为如下配置</strong> ,这样可以减少待机开销：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">clock</span> <span class="hljs-attr">offset</span>=<span class="hljs-string">&#x27;localtime&#x27;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">timer</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&#x27;hpet&#x27;</span> <span class="hljs-attr">present</span>=<span class="hljs-string">&#x27;yes&#x27;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">timer</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&#x27;hypervclock&#x27;</span> <span class="hljs-attr">present</span>=<span class="hljs-string">&#x27;yes&#x27;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">clock</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>启用 <code>shared memory</code> ：</p>
<p><img src="https://s2.loli.net/2024/02/22/lgUtwfdYejPDprI.png" srcset="/img/loading.gif" lazyload></p>
<p>其他的比如说：</p>
<ul>
<li>virt-manager 里该 VM 名字改为 <code>RDPWindows</code></li>
<li>配置自启动</li>
<li>硬盘类型改为 virtio</li>
<li>网卡模型改为 virtio（可选）</li>
</ul>
<p>之类的过程笔者这里就略过了，网上资料一大把：）</p>
<p>接下来 <code>Begin Installation</code> 然后就是：Windows，启动————</p>
<blockquote>
<p>忘了截开始界面了，无所谓了</p>
</blockquote>
<p>我们的硬盘是 virtio 的，所以首先是 <code>加载驱动程序</code>：</p>
<p><img src="https://s2.loli.net/2024/02/22/iKncHYCWN3XwAkU.png" srcset="/img/loading.gif" lazyload></p>
<p>Windows 安装程序会自动扫到我们的 virtio 驱动的 CD，直接选对应版本：</p>
<p><img src="https://s2.loli.net/2024/02/22/7JUZdRSg68VINnk.png" srcset="/img/loading.gif" lazyload></p>
<p>Windows 11 默认没有网不给安装非常 sb，不过 <code>shift + F10</code> 唤出 cmd 输入 <code>OOBE\BYPASSNRO</code> 重新开始就能绕过了：</p>
<p><img src="https://s2.loli.net/2024/02/22/pOfl2IcSr9YbxtC.png" srcset="/img/loading.gif" lazyload></p>
<p>进系统以后找到我们的 virtio 驱动光碟，运行 <code>virtio-win-gt-x64.msi</code> 和 <code>virtio-win-guest-tools.exe</code> 安驱动（全选就行），然后就有网了：</p>
<p><img src="https://s2.loli.net/2024/02/22/AIfG5mivr6zN9yu.png" srcset="/img/loading.gif" lazyload></p>
<p>然后开浏览器把 <a target="_blank" rel="noopener" href="https://github.com/Fmstrat/winapps/blob/main/install/RDPApps.reg">https://github.com/Fmstrat/winapps/blob/main/install/RDPApps.reg</a> 下载到本地并右键 <code>合并</code> ：</p>
<p><img src="https://s2.loli.net/2024/02/22/Ilq7dp9ocfCzFTm.png" srcset="/img/loading.gif" lazyload></p>
<p>然后进设置里开远程桌面就行：</p>
<p><img src="https://s2.loli.net/2024/02/22/yWUONuJ5z9CX2hg.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="配置-Guest-与-Host-间的数据共享"><a href="#配置-Guest-与-Host-间的数据共享" class="headerlink" title="配置 Guest 与 Host 间的数据共享"></a>配置 Guest 与 Host 间的数据共享</h2><p>为了方便直接通过 virt-manager 使用 VM，还可以进 VM 里安装 <a target="_blank" rel="noopener" href="https://www.spice-space.org/download/windows/spice-guest-tools/spice-guest-tools-latest.exe">spice-guest-tools</a>，这样便能支持 Host 与 Guest 之间各种不管是文本还是图片的各种互相复制粘贴了</p>
<blockquote>
<p>如果剪贴板共享坏了，在 <code>服务</code> 里检查一下 <code>SPICE</code> 相关服务是不是挂了，如果经常挂的话建议配置为 <code>自动（延迟启动）</code></p>
</blockquote>
<p>对于 Host 与 Guest 之间的文件传输，使用 <code>共享文件夹</code> 似乎是一个不错的方法，将 VM 关机后进入设置中添加一个新的 <code>Filesystem</code> virtio 设备即可：</p>
<p><img src="https://s2.loli.net/2024/02/22/l9ASvEDfMkzyBUt.png" srcset="/img/loading.gif" lazyload></p>
<p>接下来在 Guest VM 中安装 <a target="_blank" rel="noopener" href="https://winfsp.dev/">WinFSP</a>（Windows File System Proxy），aka FUSE for Windows，用以挂载我们的共享文件夹</p>
<p><img src="https://s2.loli.net/2024/02/22/O8BhKgX5WY47tuR.png" srcset="/img/loading.gif" lazyload alt="只安装 Core 其实也行"></p>
<p>前面我们已经安装过 virtio 驱动了，所以这里直接重启就行，打开设备管理器后我们便能看到一个 VirtIO FS 设备：</p>
<p><img src="https://s2.loli.net/2024/02/22/ksPrQjNEvtylWwA.png" srcset="/img/loading.gif" lazyload></p>
<p>在 <code>服务</code> 中找到 <code>VirtIO-FS Service</code> 将其设为 <code>自动</code> ，<code>应用</code> 后点击 <code>启动</code>：</p>
<p><img src="https://s2.loli.net/2024/02/22/Pabrv2cozpUhKYu.png" srcset="/img/loading.gif" lazyload></p>
<p>然后就 ok 了：</p>
<p><img src="https://s2.loli.net/2024/02/22/atYk9XEob2nf6h4.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>如果你在配置了共享文件夹后 VM 无法启动，且提示 <code>virtiofsd died unexpectedly</code> ，首先检查 <code>/var/log/libvirt/qemu/</code> 下的相关日志文件，若有类似 <code>libvirt:  error : cannot execute binary /usr/libexec/virtiofsd/virtiofsd: Permission denied</code> 这样的提示，则有可能是 <code>AppArmor</code> 的原因</p>
<p>解决方案是在 <code>/etc/apparmor.d/usr.sbin.libvirtd</code> 中适当的位置添加一行：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/usr/</span>&#123;lib,lib64,lib<span class="hljs-regexp">/qemu,libexec&#125;/</span>virtiofsd/* PUx,<br></code></pre></td></tr></table></figure>

<p>之后 <code>sudo service apparmor restart</code> 重启 AppArmor，理论上此时便能正常启动了</p>
<p>若还是不行，则检查 <strong>libvirtd 服务是否存活</strong>，并进行重启</p>
</blockquote>
<blockquote>
<p>如果重启后你的 VM 无法连上网，可能是防火墙禁止了转发（通过 <code>iptables -A FORWARD -j ACCEPT</code> 命令启用转发），也可能是 libvirtd 莫名其妙挂了，<del>也可能是玄学问题多重启几遍就莫名其妙好了</del></p>
</blockquote>
<h2 id="Extra-同一物理磁盘分区直通-（not-so-recommend）"><a href="#Extra-同一物理磁盘分区直通-（not-so-recommend）" class="headerlink" title="_Extra. 同一物理磁盘分区直通_（not so recommend）"></a>_Extra. 同一物理磁盘分区直通_（not so recommend）</h2><blockquote>
<p>参考<a target="_blank" rel="noopener" href="https://jianmin.dev/2020/jul/19/boot-your-windows-partition-from-linux-using-kvm/">这篇文章</a></p>
</blockquote>
<blockquote>
<p>注：如果你是在已有数据的分区上进行操作，<strong>请首先确保已经完成了数据备份</strong>！！！</p>
<p>注2：仅分区直通很容易把 Windows 干碎，然后出现各种问题，<strong>推荐大家还是买个双盘位电脑然后单独通一个盘给 Windows</strong></p>
</blockquote>
<p>虚拟机硬盘直通放在 4202 年自然已经不是一件稀奇的事情，但是通常的硬盘直通架构都是要将一整块物理硬盘通给单个虚拟机，若是你和笔者一样买了一部只有单盘位的笔记本（但是笔者的上一部笔记本有三盘位， <del>这次属于是经典考虑不周了</del> ），<strong>同时希望保留原有物理硬盘的 Windows 直接启动的能力</strong>，那么我们只能先预先分好区，之后再<strong>通过将分区建立为新的虚拟磁盘设备的方式</strong>将这部分分区作为一块新磁盘通给虚拟机</p>
<h3 id="创建-virtual-RAID-disk"><a href="#创建-virtual-RAID-disk" class="headerlink" title="创建 virtual RAID disk"></a>创建 virtual RAID disk</h3><p>首先载入点必要的驱动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo modprobe loop</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo modprobe linear</span><br></code></pre></td></tr></table></figure>

<p>接下来创建三个文件作为 GPT 表、 EFI 分区、 GPT 元数据，并挂载为 loopback 设备：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/zero of=gpt bs=1M count=1</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/zero of=efi1 bs=1M count=100</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/zero of=efi2 bs=1M count=1</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo losetup -f gpt</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo losetup -f efi1</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo losetup -f efi2</span><br></code></pre></td></tr></table></figure>

<p>此时用 <code>losetup -a</code> 应当能看到三个 loopback 设备：</p>
<p><img src="https://s2.loli.net/2024/02/26/yTtnwX52JzfZYFc.png" srcset="/img/loading.gif" lazyload></p>
<p>打开 YaST2 Partitioner （或是其他你所熟悉的能够查看分区信息的工具比如说 <code>fdisk -l</code>），找到原本属于 Windows 的那几个分区<strong>当中的数据分区</strong>：</p>
<blockquote>
<p>注：如果你原本就没有已经装好了的 Windows 分区，直接在待用分区上创建一个新的逻辑卷给 Windows 用就行</p>
</blockquote>
<p><img src="https://s2.loli.net/2024/02/24/VWeF4iTcSs3qL9n.png" srcset="/img/loading.gif" lazyload alt="需要注意的是，笔者在安装 Linux 时使用了新的 EFI 分区，而并非和 Windows 共用一个"></p>
<p>然后使用 madam （Multiple Disk and Device Administration）创建 RAID，以及注意不要把物理盘的 EFI 分区选进来了）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo mdadm --build --verbose /dev/md0 --chunk=512 --level=linear --raid-devices=6 /dev/loop0 /dev/loop1 /dev/nvme0n1p2 /dev/nvme0n1p3 /dev/nvme0n1p4 /dev/loop2</span><br></code></pre></td></tr></table></figure>

<p>然后进入 parted 进行分区，<strong>注意分区大小</strong>，注意 <code>mkpart</code>  子命令的格式为 <code>mkpart [part‐type name fs‐type] start end</code> ，<strong>注意自行计算分区起始位置</strong>：</p>
<blockquote>
<p>数据无价，谨慎操作！</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo parted /dev/md0</span><br>GNU Parted 3.6<br>Using /dev/md0<br>Welcome to GNU Parted! Type &#x27;help&#x27; to view a list of commands.<br>(parted) unit s                                                           <br>(parted) mktable gpt<br>(parted) mkpart primary fat32 2048 206847                                 <br>(parted) mkpart msr 206848 239615                                         <br>(parted) mkpart primary ntfs 239616 1677961215                            <br>(parted) mkpart primary ntfs 1677961216 -2049                             <br>(parted) set 1 boot on                                                    <br>(parted) set 1 esp on                                                <br>(parted) set 2 msftres on                                                 <br>(parted) set 3 msftdata on                                                <br>(parted) set 4 hidden on                                                  <br>(parted) set 4 diag on                                                    <br>(parted) name 1 EFI                                                       <br>(parted) name 3 Windows                                                   <br>(parted) quit                                                             <br>Information: You may need to update /etc/fstab.<br></code></pre></td></tr></table></figure>

<p>然后用 <code>mkfs.msdos</code> 格式化 EFI 分区：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo mkfs.msdos -F 32 -n EFI /dev/md0p1</span><br></code></pre></td></tr></table></figure>

<p>接下来编辑虚拟机磁盘：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">disk</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;block&quot;</span> <span class="hljs-attr">device</span>=<span class="hljs-string">&quot;disk&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">driver</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;qemu&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;raw&quot;</span> <span class="hljs-attr">cache</span>=<span class="hljs-string">&quot;none&quot;</span> <span class="hljs-attr">io</span>=<span class="hljs-string">&quot;native&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">dev</span>=<span class="hljs-string">&quot;/dev/md0&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">target</span> <span class="hljs-attr">dev</span>=<span class="hljs-string">&quot;vda&quot;</span> <span class="hljs-attr">bus</span>=<span class="hljs-string">&quot;virtio&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">boot</span> <span class="hljs-attr">order</span>=<span class="hljs-string">&quot;1&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">address</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;pci&quot;</span> <span class="hljs-attr">domain</span>=<span class="hljs-string">&quot;0x0000&quot;</span> <span class="hljs-attr">bus</span>=<span class="hljs-string">&quot;0x04&quot;</span> <span class="hljs-attr">slot</span>=<span class="hljs-string">&quot;0x00&quot;</span> <span class="hljs-attr">function</span>=<span class="hljs-string">&quot;0x0&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">disk</span>&gt;</span><br><br></code></pre></td></tr></table></figure>

<p>然后重新把我们的 Windows 安装光碟与 virtio 驱动挂上去，放到第一个启动：</p>
<blockquote>
<p>注：你需要在启动时 <code>press any key</code> 才会从 CDROM 启动</p>
</blockquote>
<p><img src="https://s2.loli.net/2024/02/24/CKQAUWexdacbl3m.png" srcset="/img/loading.gif" lazyload></p>
<p>重启后首先按惯例进入安装界面装载 virtio 驱动：</p>
<p><img src="https://s2.loli.net/2024/02/24/ekb9Qsd82oOc1Nf.png" srcset="/img/loading.gif" lazyload></p>
<p>完成后 <code>shift + f10</code> 唤出 cmd，在 <code>diskpart</code> 中找到 EFI 分区，分配驱动号 <code>B</code>：</p>
<p><img src="https://s2.loli.net/2024/02/24/KOLZMNRl1o6iu3q.png" srcset="/img/loading.gif" lazyload></p>
<p>最后通过如下命令将 virtio 驱动注入 C 盘，并在 EFI 分区中配置好启动项：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cmd">dism /image:c:\ /add-driver /driver:e:\viostor\w11\amd64\viostor.inf<br>bcdboot C:\Windows /s B: /f ALL<br></code></pre></td></tr></table></figure>

<p>重启，重新进行账户验证，然后就是见证奇迹的时刻——</p>
<p><img src="https://s2.loli.net/2024/02/24/P4IqVFUflRMNtsa.png" srcset="/img/loading.gif" lazyload alt="唉👴的桌面这么私密的空间都给大家看了.jpg"></p>
<h3 id="通过-libvirt-hook-配置-RAID-自创建与卸载"><a href="#通过-libvirt-hook-配置-RAID-自创建与卸载" class="headerlink" title="通过 libvirt hook 配置 RAID 自创建与卸载"></a>通过 libvirt hook 配置 RAID 自创建与卸载</h3><p>RAID 的配置不能持久化，因此需要我们写一个脚本来在每次启动 VM 前先检查是否创建了 RAID，若否，则先创建 RAID 再启动</p>
<p>这里我们可以通过创建 <code>/etc/libvirt/hooks/qemu</code> 脚本来实现 VM 启动前的 hook，在其中写入如下内容即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br>VM_NAME=<span class="hljs-string">&quot;Windows11PhysVM&quot;</span><br><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$1</span> == <span class="hljs-variable">$VM_NAME</span> ]] &amp;&amp; [[ <span class="hljs-variable">$2</span> == <span class="hljs-string">&quot;prepare&quot;</span> || <span class="hljs-variable">$2</span> == <span class="hljs-string">&quot;stopped&quot;</span> ]] ; <span class="hljs-keyword">then</span><br>   <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$2</span> == <span class="hljs-string">&quot;prepare&quot;</span> ]] ; <span class="hljs-keyword">then</span><br>     <span class="hljs-comment"># startup logic here</span><br>     modprobe loop<br>     modprobe linear<br>     LOOP1=$(sudo losetup -f)<br>     losetup <span class="hljs-variable">$&#123;LOOP2&#125;</span>  /home/arttnba3/Desktop/VM/win11vm/disk/gpt<br>     LOOP2=$(sudo losetup -f)<br>     losetup <span class="hljs-variable">$&#123;LOOP2&#125;</span>  /home/arttnba3/Desktop/VM/win11vm/disk/efi1<br>     LOOP3=$(sudo losetup -f)<br>     losetup <span class="hljs-variable">$&#123;LOOP3&#125;</span>  /home/arttnba3/Desktop/VM/win11vm/disk/efi2<br>     mdadm --build --verbose /dev/md0 --chunk=512 --level=linear --raid-devices=6 /dev/loop0 /dev/loop1 /dev/nvme0n1p2 /dev/nvme0n1p3 /dev/nvme0n1p4 /dev/loop2<br>   <span class="hljs-keyword">else</span><br>     <span class="hljs-comment"># shutdown logic here</span><br>     <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Stopping array&quot;</span><br>     mdadm --stop /dev/md0<br>     <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;removing loopback devices&quot;</span><br>     losetup | grep -i <span class="hljs-string">&quot;win11vm&quot;</span> | awk <span class="hljs-string">&#x27;&#123;print $1&#125;&#x27;</span> | xargs sudo losetup -d<br>   <span class="hljs-keyword">fi</span><br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure>

<h3 id="配置-TPM-直通"><a href="#配置-TPM-直通" class="headerlink" title="配置 TPM 直通"></a>配置 TPM 直通</h3><p><strong>可信平台模块</strong>（<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/security/hardware-security/tpm/trusted-platform-module-overview">Trusted Platform Module</a>）芯片是主板上的一块用来确保物理安全性的芯片，Windows 用其确保系统的物理安全性，包括 Pin 码等，自 Win 11 起 TPM 成为了操作系统启动的硬性要求</p>
<p>QEMU 虽然可以模拟 vTPM，但是与物理机 TPM 的非一致性会让系统在 Win 物理机与虚拟机间切换时造成一定的问题（在 Windows 看来这破坏了系统的完整性），由于在 Linux PC 上我们通常并不使用 TPM 特性，因此这里我们可以选择直接将 TPM 模块直通给虚拟机</p>
<p>TPM 模块的设备路径通常为 <code>/dev/tpm0</code> （v1.2）与 <code>/dev/tpmrm0</code> （v2.0），通常我们应当将前者进行直通才能达到完整直通的效果：</p>
<p><img src="https://s2.loli.net/2024/02/26/wnPzW97uJxqKXFI.png" srcset="/img/loading.gif" lazyload alt="真是简简又单单，你们有没有这样的 virt-manager 啊">)</p>
<p>然后就能用 pin 登录了：</p>
<p><img src="https://s2.loli.net/2024/02/28/GFo179iyWNLetIX.png" srcset="/img/loading.gif" lazyload></p>
<h1 id="0x02-在-Host-侧配置-RDP-连接"><a href="#0x02-在-Host-侧配置-RDP-连接" class="headerlink" title="0x02. 在 Host 侧配置 RDP 连接"></a>0x02. 在 Host 侧配置 RDP 连接</h1><h2 id="配置-RDP-硬体加速"><a href="#配置-RDP-硬体加速" class="headerlink" title="配置 RDP 硬体加速"></a>配置 RDP 硬体加速</h2><p>运行 <code>gpedit.msc</code> 找到 <code>*计算机配置-&gt;管理模板-&gt;Windows组件-&gt;远程桌面服务-&gt;远程桌面会话主机-&gt;远程会话环境</code>，在其中配置 RDP 硬体加速，以此获得更好的 RDP 性能：</p>
<p><img src="https://s2.loli.net/2024/02/26/ILEM9OrqKZFApou.png" srcset="/img/loading.gif" lazyload></p>
<p>然后打开注册表编辑器路径 <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations</code> ，新建一个名为 <code>DWMFRAMEINTERVAL</code> 的 DWORD 值并设为 <code>15</code>：</p>
<p><img src="https://s2.loli.net/2024/02/26/gXABCzNwMH8KRYE.png" srcset="/img/loading.gif" lazyload></p>
<p>重启即可</p>
<h2 id="配置-RDP-连接"><a href="#配置-RDP-连接" class="headerlink" title="配置 RDP 连接"></a>配置 RDP 连接</h2><blockquote>
<p>如果你的 RDP 连接没有声音，可以参见 <a target="_blank" rel="noopener" href="https://www.anyviewer.cn/how-to/rdp-audio-not-working-6540.html">这个链接</a> 进行修复</p>
<p>如果无法连接上 Guest ，也可以检查一下是不是 Windows 防火墙的问题</p>
</blockquote>
<h3 id="使用-xfreerdp-仅运行单个应用"><a href="#使用-xfreerdp-仅运行单个应用" class="headerlink" title="使用 xfreerdp 仅运行单个应用"></a>使用 xfreerdp 仅运行单个应用</h3><p>首先安装上 freedrp：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo zypper <span class="hljs-keyword">in</span> freerdp</span><br></code></pre></td></tr></table></figure>

<p>接下来输入如下命令进行测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">xfreerdp /rfx /d:<span class="hljs-string">&quot;你的 VM 主机名&quot;</span> /u:<span class="hljs-string">&quot;你的 VM 用户名&quot;</span> /p:<span class="hljs-string">&quot;你的 VM 密码&quot;</span> /v:<span class="hljs-string">&quot;你的 VM 的 IP&quot;</span> +auto-reconnect +home-drive +clipboard /scale:100 /dynamic-resolution /audio-mode:0 /microphone /app:<span class="hljs-string">&quot;explorer.exe&quot;</span></span><br></code></pre></td></tr></table></figure>

<p>接下来就是见证奇迹的时刻——</p>
<p><img src="https://s2.loli.net/2024/02/22/GgCDkhwiznLF1fZ.png" srcset="/img/loading.gif" lazyload alt="碉堡了好吗"></p>
<p>这里的 RDP 命令帮我们配置好了共享 <code>/home</code> 文件夹和剪贴板，所以你可以<strong>直接往 VM 里粘贴包括文件在内的东西</strong>，也可以在 VM 中访问 Host 侧的文件夹：）</p>
<blockquote>
</blockquote>
<h3 id="使用-sdl-freerdp"><a href="#使用-sdl-freerdp" class="headerlink" title="使用 sdl-freerdp"></a><em>使用 sdl-freerdp</em></h3><blockquote>
<p>和 wlfreerdp 一样，不支持仅转发单个应用（似乎是 wayland 缺失了某些特性）</p>
</blockquote>
<p>zypper 官方源里没有，可以手动添加，也可以像笔者一样通过 flatpak 进行安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">flatpak install com.freerdp.FreeRDP</span><br></code></pre></td></tr></table></figure>

<p>然后运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">flatpak run com.freerdp.FreeRDP /rfx /d:<span class="hljs-string">&quot;你的 VM 主机名&quot;</span> /u:<span class="hljs-string">&quot;你的 VM 用户名&quot;</span> /p:<span class="hljs-string">&quot;你的 VM 密码&quot;</span> /v:<span class="hljs-string">&quot;你的 VM 的 IP&quot;</span> +auto-reconnect +home-drive +clipboard /scale:100 /dynamic-resolution /audio-mode:0 /microphone</span><br></code></pre></td></tr></table></figure>



<h3 id="在应用列表中添加-Windows-程序图标"><a href="#在应用列表中添加-Windows-程序图标" class="headerlink" title="在应用列表中添加 Windows 程序图标"></a>在应用列表中添加 Windows 程序图标</h3><p>把自己想要运行的 Windows 程序路径写成 Desktop Entry 就行，后缀名改为 <code>.desktop</code> 并放在 <code>/usr/share/applicaitions/</code> 目录下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">[Desktop Entry]<br><span class="hljs-comment"># 该入口的类型</span><br>Type=Application<br><span class="hljs-comment"># 是否显示终端（可选）</span><br>Terminal=<span class="hljs-literal">false</span><br><span class="hljs-comment"># 点击该入口执行的命令</span><br>Exec=xfreerdp /rfx /d:<span class="hljs-string">&quot;你的 VM 主机名&quot;</span> /u:<span class="hljs-string">&quot;你的 VM 用户名&quot;</span> /p:<span class="hljs-string">&quot;你的 VM 密码&quot;</span> /v:<span class="hljs-string">&quot;你的 VM 的 IP&quot;</span> +auto-reconnect +home-drive +clipboard /scale:100 /dynamic-resolution /audio-mode:0 /microphone /app:<span class="hljs-string">&quot;VM 里的可执行程序路径名&quot;</span><br><span class="hljs-comment"># 该程序名称</span><br>Name=Name of Application<br><span class="hljs-comment"># 入口显示的图标路径（可选）</span><br>Icon=/path/to/icon<br></code></pre></td></tr></table></figure>

<h1 id="0x03-实现显卡直通-，这样就能玩👴最爱的-Genshin-Impact-了"><a href="#0x03-实现显卡直通-，这样就能玩👴最爱的-Genshin-Impact-了" class="headerlink" title="0x03. 实现显卡直通 ，这样就能玩👴最爱的 Genshin Impact 了"></a>0x03. 实现显卡直通 <del>，这样就能玩👴最爱的 <code>Genshin Impact</code> 了</del></h1><blockquote>
<p>参考 <a target="_blank" rel="noopener" href="https://doc.opensuse.org/documentation/leap/virtualization/html/book-virtualization/app-gpu-passthru.html">SUSE - Configuring GPU Pass-Through for NVIDIA cards</a></p>
</blockquote>
<p>众所周知，《原神》是由米哈游自主研发的一款全新开放世界冒险游戏。游戏发生在一个被称作「提瓦特」的幻想世界，在这里，被神选中的人将被授予「神之眼」，导引元素之力。你将扮演一位名为「旅行者」的神秘角色，在自由的旅行中邂逅性格各异、能力独特的同伴们，和他们一起击败强敌，找回失散的亲人——同时，逐步发掘「原神」的真相。我现在每天玩原神都能赚150原石，每个月差不多5000原石的收入， 也就是现实生活中每个月5000美元的收入水平，换算过来最少也30000人民币，虽然我 只有14岁，但是已经超越了中国绝大多数人(包括你)的水平，这便是原神给我的骄傲的资本…</p>
<p><img src="https://s2.loli.net/2024/02/22/kNXAmoqZslUjEYb.png" srcset="/img/loading.gif" lazyload alt="差不多得了😅屁大点事都要拐上原神，原神一没招你惹你，二没干伤天害理的事情，到底怎么你了让你一直无脑抹黑，米哈游每天费尽心思的文化输出弘扬中国文化，你这种喷子只会在网上敲键盘诋毁良心公司，中国游戏的未来就是被你这种人毁掉的😅 作者：我永远单推Cierra https://www.bilibili.com/read/cv17996308/ 出处：bilibili"></p>
<p><del>扯得有些远了，</del> 总而言之有的时候我们想要在 Windows 上进行一些需要用显卡才能完成的任务，亦或是使用显卡进行图形加速等，virt-manager 默认提供的 RedHat QXL 终究只是一个由 QEMU 进行模拟的设备，性能上自然很难与真正的显卡相比拟</p>
<p>而笔者的笔记本刚好有两个显卡：一个是 Intel 的核显，另一个是一张 NVIDIA 的卡，因为笔者日常也不用这台电脑炼丹（ <del>再说了就一张小破 4060 能练个啥玩意出来</del> ），因此笔者决定将 N 卡直通到 VM 当中以提高 VM 的图形化性能， <del>同时闲暇之余还能打开 VM 玩玩游戏这样子</del></p>
<h2 id="配置-IOMMU"><a href="#配置-IOMMU" class="headerlink" title="配置 IOMMU"></a>配置 IOMMU</h2><p>在 <a target="_blank" rel="noopener" href="https://arttnba3.cn/2022/08/29/VURTUALIZATION-0X02-BASIC_KNOWLEDGE/">《系统虚拟化导论》</a> 中我们知道集成在北桥上的 IOMMU 可以通过 DMA 重映射与中断重映射的方式让我们实现 I&#x2F;O 虚拟化：</p>
<p><img src="https://s2.loli.net/2022/09/03/k8mOSalVRWtseMi.png" srcset="/img/loading.gif" lazyload></p>
<p>IOMMU 默认是关闭的，因此首先我们要先启用 IOMMU 这一功能，首先检查一下你是否有两张卡以及是否在 UEFI 里开启了虚拟化相关特性：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">dmesg | grep -e <span class="hljs-string">&quot;Directed I/O&quot;</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">lspci | grep -i <span class="hljs-string">&quot;vga&quot;</span></span><br></code></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/02/22/SKYOdgF1s9U2Za4.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>如果你只有一张显示卡的话，<strong>那笔者不推荐弄显卡直通</strong>，因为同一时间只有一个系统能够占用显卡，Guest 拿掉之后 Host 肯定是没有图形输出的，Guest 关机后才能回到 Host 图形界面，<strong>这种直通还不如直接装双系统后重启回 Windows</strong></p>
</blockquote>
<p>在 <code>/etc/default/grub</code> 的 <code>GRUB_CMDLINE_LINUX_DEFAULT</code> 参数中添加 <code>intel_iommu=on iommu=pt rd.driver.pre=vfio-pci</code> （AMD CPU 则添加 <code>iommu=pt amd_iommu=on rd.driver.pre=vfio-pci</code>），之后通过如下命令更新 grub：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo grub2-mkconfig -o /boot/grub2/grub.cfg</span> <br></code></pre></td></tr></table></figure>

<p>重启后通过 <code>dmesg |  grep -e DMAR -e IOMMU</code> 命令我们便能看到 IOMMU 已经开启：</p>
<p><img src="https://s2.loli.net/2024/02/22/kDgealrxURMKE6d.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>接下来我们运行 <code>lspci -nn | grep -i nvidia</code> 命令找到 N 卡后面的设备 id,记录下这串数字：</p>
<p><img src="https://s2.loli.net/2024/02/22/fNKQEu2z8VSoHOv.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="实现显卡动态直通"><a href="#实现显卡动态直通" class="headerlink" title="实现显卡动态直通"></a>实现显卡动态直通</h2><p>大部分双显卡直通的教程上来就是让把老 N 卡的 nouveau 驱动给卸了，但是笔者<a target="_blank" rel="noopener" href="https://arttnba3.cn/2023/11/24/DISTRO-0X01-INSTALL_TUMBLEWEED_WINDOWS/">一开始就装了 N 卡闭源驱动</a>，现在再给卸了有点不太现实，而且万一以后有空了也想用这台电脑小练点丹也说不定，所以这里笔者选择配置<strong>动态显卡重装载策略</strong>——</p>
<ul>
<li>默认卸载 N 卡驱动，在需要时再装载 N 卡驱动</li>
<li>在 VM 启动时卸载 N 卡驱动，在 VM 结束运行后再重新装载，<strong>桌面环境则仅在核显上运行</strong>（其实 Linux 桌面环境通常情况下用核显的性能基本上都是足够的）</li>
</ul>
<h3 id="配置-VFIO"><a href="#配置-VFIO" class="headerlink" title="配置 VFIO"></a>配置 VFIO</h3><p>首先配置 VFIO，这里我们要防止 nvidia 驱动在开机时便被装载（后面用到再手动装载，否则会比较麻烦），首先在 <code>/etc/modprobe.d/</code> 中创建文件 <code>vfio.conf</code> 并写入我们刚刚获取到的标识符：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">options</span> vfio-pci ids=<span class="hljs-number">10</span>de:<span class="hljs-number">28</span>a0<br></code></pre></td></tr></table></figure>

<p>然后创建文件 <code>/etc/dracut.conf.d/gpu-passthrough.conf</code> 以装载 <a target="_blank" rel="noopener" href="https://documentation.suse.com/zh-cn/sles/15-SP3/html/SLES-all/gloss-vt-glossary.html#gloss-vt-acronym-vfio">VFIO</a> 驱动：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs makefile">add_drivers+=<span class="hljs-string">&quot;vfio vfio_iommu_type1 vfio_pci vfio_virqfd&quot;</span><br></code></pre></td></tr></table></figure>

<p>接下来使用 dracut 重新生成 initrd：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo dracut --force /boot/initrd $(uname -r)<br></code></pre></td></tr></table></figure>

<p>然后为 Guest VM 禁用 MSR（防止崩溃），创建 <code>/etc/modprobe.d/kvm.conf</code> 文件并写入：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">options</span> kvm ignore_msrs=<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<p>重启电脑后你就会发现 N 卡驱动载入失败，因为此时 VFIO 先一步取得了N 卡的所有权：）</p>
<p><img src="https://s2.loli.net/2024/02/25/xZzI4O9J5niXDqf.png" srcset="/img/loading.gif" lazyload></p>
<p>如果你想再用上 N 卡闭源驱动搞事情，可以通过如下脚本装载回 N 卡驱动，这里我们用 <code>virsh</code> 来重新装载设备，注意查看 N 卡对应的 pci 号设备：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br>sudo modprobe -r vfio-pci<br>virsh nodedev-reattach pci_0000_01_00_0<br>sudo modprobe nvidia<br>sudo modprobe nvidia_modeset<br>sudo modprobe nvidia_uvm<br>sudo modprobe nvidia_drm<br></code></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/02/25/sfDjCAB149aK5Ye.png" srcset="/img/loading.gif" lazyload></p>
<p>重新用回 VFIO 的话就是反着来的脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br>sudo modprobe -r nvidia_drm<br>sudo modprobe -r nvidia_uvm<br>sudo modprobe -r nvidia_modeset<br>sudo modprobe -r nvidia<br>virsh nodedev-detach pci_0000_01_00_0<br>sudo modprobe vfio-pci<br></code></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/02/25/PDVGtKZJ3TSujkF.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="配置显卡直通"><a href="#配置显卡直通" class="headerlink" title="配置显卡直通"></a>配置显卡直通</h3><p>接下来我们将这张卡通进 VM 中，首先用如下脚本查看显卡所在 IOMMU 组都有哪些设备：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-built_in">shopt</span> -s nullglob<br><span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> /sys/kernel/iommu_groups/*/devices/*; <span class="hljs-keyword">do</span> <br>    n=<span class="hljs-variable">$&#123;d#*/iommu_groups/*&#125;</span>; n=<span class="hljs-variable">$&#123;n%%/*&#125;</span><br>    <span class="hljs-built_in">printf</span> <span class="hljs-string">&#x27;IOMMU Group %s &#x27;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$n</span>&quot;</span><br>    lspci -nns <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;d##*/&#125;</span>&quot;</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2024/02/25/uWZP85BcjrdQs7x.png" srcset="/img/loading.gif" lazyload alt="比较幸运的是笔者的 N 卡所在组只有一个设备"></p>
<p>接下来在 virt-manager 中添加 <code>PCI Host Device</code> 选<strong>显卡所在的整个 IOMMU group 设备</strong>即可：</p>
<p><img src="https://s2.loli.net/2024/02/25/AKMU9xRwONFc4jC.png" srcset="/img/loading.gif" lazyload alt="小学生都会做"></p>
<blockquote>
<p>启动前注意把 Video 换成 <code>virtio</code> 而非 <code>QXL</code> ，否则在 SPICE 服务启动后鼠标没法正常工作：(</p>
</blockquote>
<p>之后就完成直通了：</p>
<p><img src="https://s2.loli.net/2024/02/26/9Ycy386z1DJwiWB.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://s2.loli.net/2024/02/25/LVaHAEvjuQZhdqy.png" srcset="/img/loading.gif" lazyload></p>
<p>如果你和笔者一样电脑自带的视频输出口都走独显，则可以通过外接显示器直接输出虚拟机内容，这样就不需要忍受 virtio&#x2F;qxl 那极其底下的性能了：</p>
<p><img src="https://s2.loli.net/2024/02/28/5mcCALesxZbzUfq.jpg" srcset="/img/loading.gif" lazyload></p>
<h3 id="配置-libvirt-hook-动态装载显卡"><a href="#配置-libvirt-hook-动态装载显卡" class="headerlink" title="配置 libvirt hook 动态装载显卡"></a>配置 libvirt hook 动态装载显卡</h3><p>我们只需要将前面的两个脚本写到  <code>/etc/libvirt/hooks/qemu</code> 脚本中即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br>VM_NAME=<span class="hljs-string">&quot;Windows11PhysVM&quot;</span><br><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$1</span> == <span class="hljs-variable">$VM_NAME</span> ]] &amp;&amp; [[ <span class="hljs-variable">$2</span> == <span class="hljs-string">&quot;prepare&quot;</span> || <span class="hljs-variable">$2</span> == <span class="hljs-string">&quot;stopped&quot;</span> ]] ; <span class="hljs-keyword">then</span><br>   <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$2</span> == <span class="hljs-string">&quot;prepare&quot;</span> ]] ; <span class="hljs-keyword">then</span><br>     sudo modprobe -r nvidia_drm<br>     sudo modprobe -r nvidia_uvm<br>     sudo modprobe -r nvidia_modeset<br>     sudo modprobe -r nvidia<br>     virsh nodedev-detach pci_0000_01_00_0<br>     sudo modprobe vfio-pci<br>   <span class="hljs-keyword">else</span><br>     sudo modprobe -r vfio-pci<br>     virsh nodedev-reattach pci_0000_01_00_0<br>     sudo modprobe nvidia<br>     sudo modprobe nvidia_modeset<br>     sudo modprobe nvidia_uvm<br>     sudo modprobe nvidia_drm<br>   <span class="hljs-keyword">fi</span><br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure>

<h3 id="在虚拟机里玩原神-（To-do）"><a href="#在虚拟机里玩原神-（To-do）" class="headerlink" title="在虚拟机里玩原神 （To do）"></a><em><del>在虚拟机里玩原神</del></em> （To do）</h3><p><del>最后自然就是大家最喜欢的，原神，启动——</del> 家人们大事不妙了，👴发现原神有 VM 检测， <del>今天玩不了了，咱们下回再见吧</del></p>
<p><img src="https://s2.loli.net/2024/02/28/JcLyUmIOVAjeYv2.png" srcset="/img/loading.gif" lazyload></p>
<h1 id="0x04-一些亟待解决的小问题"><a href="#0x04-一些亟待解决的小问题" class="headerlink" title="0x04. 一些亟待解决的小问题"></a>0x04. 一些亟待解决的小问题</h1><h2 id="虚拟化组件问题汇总"><a href="#虚拟化组件问题汇总" class="headerlink" title="虚拟化组件问题汇总"></a>虚拟化组件问题汇总</h2><h3 id="1-libvirtd-不会自启动"><a href="#1-libvirtd-不会自启动" class="headerlink" title="1. libvirtd 不会自启动"></a>1. libvirtd 不会自启动</h3><p>似乎是因为 libvirtd 被拆成了数个小组件，所以不管怎么 <code>enable</code> 都没法让他自启动，但是 libvirtd 不启动的话 virtiofsd 也没法正常工作，因此暂时还需要每次启动后都得手动 <code>systemctl start libvirtd.service</code></p>
<h2 id="xfreerdp-问题综合汇总"><a href="#xfreerdp-问题综合汇总" class="headerlink" title="xfreerdp 问题综合汇总"></a>xfreerdp 问题综合汇总</h2><h3 id="1-存在画面撕裂"><a href="#1-存在画面撕裂" class="headerlink" title="1. 存在画面撕裂"></a>1. 存在画面撕裂</h3><p>尤其是在仅转发单个应用而非整个桌面时</p>
<h3 id="2-新开单应用转发导致所有窗口重新开启"><a href="#2-新开单应用转发导致所有窗口重新开启" class="headerlink" title="2. 新开单应用转发导致所有窗口重新开启"></a>2. 新开单应用转发导致所有窗口重新开启</h3><p>其实桌面都在同一个 session 里，但是 xfreerdp 需要重新建一遍窗口，感觉是设计上的缺陷 ：(</p>
<h3 id="3-app-参数纯后台应用无法保持窗口留存"><a href="#3-app-参数纯后台应用无法保持窗口留存" class="headerlink" title="3. /app 参数纯后台应用无法保持窗口留存"></a>3. <code>/app</code> 参数纯后台应用无法保持窗口留存</h3><p>开个酷狗&#x2F;网易云之类的窗口一关 RDP 连接就也没了，感觉还是设计上的缺陷 ：(</p>
<h2 id="不能玩-👴-最爱的-Genshin-Impact"><a href="#不能玩-👴-最爱的-Genshin-Impact" class="headerlink" title="不能玩 👴 最爱的 Genshin Impact"></a><del>不能玩 👴 最爱的 Genshin Impact</del></h2><p>原神似乎用了比较严苛的虚拟化检查方案，所以这个后日再议了（笑）</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/SUSE/" class="category-chain-item">SUSE</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Linux/">#Linux</a>
      
        <a href="/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/">#虚拟化</a>
      
        <a href="/tags/openSUSE/">#openSUSE</a>
      
        <a href="/tags/openSUSE-Tumbleweed/">#openSUSE Tumbleweed</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>【SUSE.0x00】在 openSUSE 上食用 Win VM</div>
      <div>https://arttnba3.github.io/2024/02/27/SUSE-0X00_WIN_VM_SETUP_GUIDE/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>arttnba3</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年2月27日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/01/01/VIRUS-0X00-LINUX_ROOTKIT/" title="【VIRUS.0x00】现代 Linux rootkit 开发导论">
                        <span class="hidden-mobile">【VIRUS.0x00】现代 Linux rootkit 开发导论</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.17/Valine.min.js', function() {
        var options = Object.assign(
          {"appid":"ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz","appkey":"tuvJh3xYxPFcW2JB6K26RKP2","path":"window.location.pathname","placeholder":"说点什么呗（笑）","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false,"appId":"ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz","appKey":"tuvJh3xYxPFcW2JB6K26RKP2"},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  <!-- 网站运行时间的设置 -->
  <span id="timeDate">载入天数...</span>
  <span id="times">载入时分秒...</span>
  <script>
      var now = new Date();
      function createtime() {
          var grt= new Date("04/20/2020 17:48:48");//此处修改你的建站时间或者网站上线时间
          now.setTime(now.getTime()+250);
          days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
          hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
          if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
          mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
          seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
          snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
          document.getElementById("timeDate").innerHTML = "arttnba3的小屋已经安全存在了 "+dnum+" 天 ";
          document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
      }
  setInterval("createtime()",250);
  </script>
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.1/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
