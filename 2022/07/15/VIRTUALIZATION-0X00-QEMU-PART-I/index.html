

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.png">
  <link rel="icon" href="/img/avatar.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="arttnba3">
  <meta name="keywords" content="">
  
    <meta name="description" content="‰∏çÂ¶Ç VMWareüëã">
<meta property="og:type" content="article">
<meta property="og:title" content="„ÄêVIRT.0x00„ÄëQemu - IÔºöQemu ÁÆÄÊòìÈ£üÁî®ÊåáÂçó">
<meta property="og:url" content="https://arttnba3.github.io/2022/07/15/VIRTUALIZATION-0X00-QEMU-PART-I/index.html">
<meta property="og:site_name" content="arttnba3&#39;s blog">
<meta property="og:description" content="‰∏çÂ¶Ç VMWareüëã">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/08/20/qg5Uni1hzxETecX.png">
<meta property="article:published_time" content="2022-07-15T06:45:17.000Z">
<meta property="article:modified_time" content="2025-02-03T14:57:34.767Z">
<meta property="article:author" content="arttnba3">
<meta property="article:tag" content="PCI">
<meta property="article:tag" content="ËôöÊãüÂåñ">
<meta property="article:tag" content="Qemu">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://s2.loli.net/2022/08/20/qg5Uni1hzxETecX.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>„ÄêVIRT.0x00„ÄëQemu - IÔºöQemu ÁÆÄÊòìÈ£üÁî®ÊåáÂçó - arttnba3&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ‰∏ªÈ¢ò‰æùËµñÁöÑÂõæÊ†áÂ∫ìÔºå‰∏çË¶ÅËá™Ë°å‰øÆÊîπ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"arttnba3.github.io","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"¬ß"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.1.1"><link rel="alternate" href="/atom.xml" title="arttnba3's blog" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 80vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>arttnba3&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                È¶ñÈ°µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                ÂΩíÊ°£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                ÂàÜÁ±ª
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Ê†áÁ≠æ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                ÂÖ≥‰∫é
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                ÂèãÈìæ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" target="_blank" rel="noopener" href="https://github.com/arttnba3">
                <i class="iconfont icon-github-fill"></i>
                GitHub
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/atom.xml">
                <i class="iconfont icon-rss"></i>
                rss
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://s2.loli.net/2022/07/26/9L7HtFUQlyZdwXD.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="„ÄêVIRT.0x00„ÄëQemu - IÔºöQemu ÁÆÄÊòìÈ£üÁî®ÊåáÂçó"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-07-15 16:45" pubdate>
          2022Âπ¥7Êúà15Êó• ‰∏ãÂçà
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          33k Â≠ó
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          279 ÂàÜÈíü
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> Ê¨°
        </span>
        
      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">„ÄêVIRT.0x00„ÄëQemu - IÔºöQemu ÁÆÄÊòìÈ£üÁî®ÊåáÂçó</h1>
            
              <p class="note note-info">
                
                  
                    Êú¨ÊñáÊúÄÂêéÊõ¥Êñ∞‰∫éÔºö2025Âπ¥2Êúà4Êó• ÂáåÊô®
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>‰∏çÂ¶Ç VMWareüëã</p>
<span id="more"></span>

<h1 id="0x00-‰∏ÄÂàáÂºÄÂßã‰πãÂâç"><a href="#0x00-‰∏ÄÂàáÂºÄÂßã‰πãÂâç" class="headerlink" title="0x00.‰∏ÄÂàáÂºÄÂßã‰πãÂâç"></a>0x00.‰∏ÄÂàáÂºÄÂßã‰πãÂâç</h1><p>Qemu ÊòØ‰∏ÄÊ¨æÂºÄÊ∫êÁöÑËôöÊãüÊú∫ËΩØ‰ª∂ÔºåÊîØÊåÅÂ§öÁßç‰∏çÂêåÊû∂ÊûÑÁöÑÊ®°ÊãüÔºàEmulationÔºâ‰ª•ÂèäÈÖçÂêà kvm ÂÆåÊàêÂΩìÂâçÊû∂ÊûÑÁöÑËôöÊãüÂåñÔºàVirtualizationÔºâÁöÑÁâπÊÄßÔºåÊòØÂΩìÂâçÊúÄÁÅ´ÁÉ≠ÁöÑÂºÄÊ∫êËôöÊãüÊú∫ËΩØ‰ª∂</p>
<p><img src="https://s2.loli.net/2022/07/22/jfIDUCx5ZtMsHAY.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>Qemu ÁöÑÂü∫Êú¨ËøêË°åÊû∂ÊûÑÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö</p>
<p><img src="https://s2.loli.net/2022/07/26/9L7HtFUQlyZdwXD.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>Êú¨ÁØáÊñáÁ´†Á¨îËÄÖÂ∞ÜÁÆÄË¶ÅÂèôËø∞Â¶Ç‰Ωï‰ªéÊ∫êÁ†ÅÁºñËØëÁâπÂÆöÊû∂ÊûÑÁöÑ Qemu Âπ∂ËøõË°å‰∏ÄÂÆöÁ®ãÂ∫¶ÁöÑÊîπÈÄ†Â∑•‰Ωú</p>
<h2 id="PRE-ÂÆâË£Ö‰æùËµñ"><a href="#PRE-ÂÆâË£Ö‰æùËµñ" class="headerlink" title="PRE.ÂÆâË£Ö‰æùËµñ"></a>PRE.ÂÆâË£Ö‰æùËµñ</h2><p>Â§ßÊ¶ÇÈúÄË¶ÅÂÆâË£ÖËøô‰∫õ‰æùËµñÔºö</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt -y install ninja-build build-essential zlib1g-dev pkg-config libglib2.0-dev binutils-dev libpixman-1-dev libfdt-dev</span><br></code></pre></td></tr></table></figure>

<h1 id="0x01-‰ªéÊ∫êÁ†ÅÁºñËØë-QEMU"><a href="#0x01-‰ªéÊ∫êÁ†ÅÁºñËØë-QEMU" class="headerlink" title="0x01.‰ªéÊ∫êÁ†ÅÁºñËØë QEMU"></a>0x01.‰ªéÊ∫êÁ†ÅÁºñËØë QEMU</h1><h2 id="‰∏Ä„ÄÅËé∑Âèñ-QEMU-Ê∫êÁ†Å"><a href="#‰∏Ä„ÄÅËé∑Âèñ-QEMU-Ê∫êÁ†Å" class="headerlink" title="‰∏Ä„ÄÅËé∑Âèñ QEMU Ê∫êÁ†Å"></a>‰∏Ä„ÄÅËé∑Âèñ QEMU Ê∫êÁ†Å</h2><p>Â§ßÊ¶ÇÊúâ‰∏§ÁßçÈÄîÂæÑÔºö‰ªéÂÆòÁΩë‰∏ãËΩΩÊàñÊòØÁõ¥Êé•‰ªé Qemu ÁöÑGitHub ‰ªìÂ∫ìÊãâ‰∏ãÊù•„ÄÇ</p>
<h3 id="I-ÂÆòÁΩë‰∏ãËΩΩÊ∫êÁ†Å"><a href="#I-ÂÆòÁΩë‰∏ãËΩΩÊ∫êÁ†Å" class="headerlink" title="I.ÂÆòÁΩë‰∏ãËΩΩÊ∫êÁ†Å"></a>I.ÂÆòÁΩë‰∏ãËΩΩÊ∫êÁ†Å</h3><p>ÂâçÂæÄ <a target="_blank" rel="noopener" href="https://download.qemu.org/">qemu ÁöÑÂÆòÁΩë</a>ËøõË°å‰∏ãËΩΩÔºö</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">wget https://download.qemu.org/qemu-7.0.0.tar.xz</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">tar -xf qemu-7.0.0.tar.xz</span><br></code></pre></td></tr></table></figure>

<h3 id="II-GitHub-Ëé∑ÂèñÊ∫êÁ†Å"><a href="#II-GitHub-Ëé∑ÂèñÊ∫êÁ†Å" class="headerlink" title="II. GitHub Ëé∑ÂèñÊ∫êÁ†Å"></a>II. GitHub Ëé∑ÂèñÊ∫êÁ†Å</h3><p>Áõ¥Êé•‰ªé <a target="_blank" rel="noopener" href="https://github.com/qemu/qemu">GitHub</a> ‰∏äÈù¢Êãâ‰πüË°åÔºö</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> git@github.com:qemu/qemu.git</span><br></code></pre></td></tr></table></figure>

<h2 id="‰∫å„ÄÅÈÖçÁΩÆÁºñËØëÈÄâÈ°π"><a href="#‰∫å„ÄÅÈÖçÁΩÆÁºñËØëÈÄâÈ°π" class="headerlink" title="‰∫å„ÄÅÈÖçÁΩÆÁºñËØëÈÄâÈ°π"></a>‰∫å„ÄÅÈÖçÁΩÆÁºñËØëÈÄâÈ°π</h2><p>Êé•‰∏ãÊù•ÂàõÂª∫ build ÁõÆÂΩïÂπ∂ÈÖçÁΩÆÂØπÂ∫îÁöÑÁºñËØëÈÄâÈ°πÔºö</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> build &amp;&amp; <span class="hljs-built_in">cd</span> build</span><br><span class="hljs-meta prompt_">build$ </span><span class="language-bash">../qemu-7.0.0/configure --enable-kvm --target-list=x86_64-softmmu --enable-debug</span><br></code></pre></td></tr></table></figure>

<p>ËøôÈáåÊàë‰ª¨ÊâãÂä®ÊåáÂÆö‰∫ÜËøôÂá†‰∏™ÁºñËØëÈÄâÈ°πÔºö</p>
<ul>
<li><code>--enable-kvm</code>ÔºöÂºÄÂêØ kvm ÊîØÊåÅ</li>
<li><code>--target-list=&lt;Êû∂ÊûÑÂêç&gt;</code>ÔºöÊåáÂÆöË¶ÅÁºñËØëÁöÑ CPU Êû∂ÊûÑÔºåËøôÈáåÊàë‰ª¨ÊåáÂÆö‰∏∫ <code>x86_64-softmmu</code> Âç≥Ë°®Á§∫Êàë‰ª¨Ë¶ÅÁºñËØë x86 Êû∂ÊûÑÁöÑ 64‰Ωç CPU</li>
<li><code>--enable-debug</code>ÔºöËÉΩÂ§üÂØπ Qemu ËøõË°åË∞ÉËØï</li>
</ul>
<blockquote>
<p>Â¶ÇÊûúÊàë‰ª¨‰∏çÊåáÂÆöÁöÑËØù‰ºöÊääÊâÄÊúâÊû∂ÊûÑÈÉΩÁºñËØë‰∏ÄÈÅçÔºå‰∏çËøáËøôÈáåÁ¨îËÄÖÂè™ÈúÄË¶Å x86 ÁöÑÔºõÔºâ</p>
</blockquote>
<h2 id="‰∏â„ÄÅÂºÄÂßãÁºñËØë"><a href="#‰∏â„ÄÅÂºÄÂßãÁºñËØë" class="headerlink" title="‰∏â„ÄÅÂºÄÂßãÁºñËØë"></a>‰∏â„ÄÅÂºÄÂßãÁºñËØë</h2><p>Áõ¥Êé• make Â∞±ÂÆå‰∫ã‰∫Ü</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">build$ </span><span class="language-bash">make -j$(<span class="hljs-built_in">nproc</span>)</span><br></code></pre></td></tr></table></figure>

<p>ÈúÄË¶ÅËä±ÁöÑÊó∂Èó¥ËøòÊòØ‰∏çÁü≠ÁöÑÔºåÂú®Á¨îËÄÖÁöÑÂ∞èÁ†¥ÊúçÂä°Âô®‰∏äÁºñËØëÂ§ßÊ¶ÇÈúÄË¶ÅÂçÅÂá†ÂàÜÈíüÂ∑¶Âè≥ÔºåÂ§ßÊ¶ÇÁºñËØë‰∫Ü‰∏§ÂçÉÂ§ö‰∏™Êñá‰ª∂ÔºåÂÆåÊàê‰πãÂêéÂú®ÂΩìÂâçÁõÆÂΩï‰∏ãÂ∞±‰ºöÊúâ‰∏Ä‰∏™ÁÉ≠‰πé‰πéÁöÑÂèØÊâßË°åÊñá‰ª∂ <code>qemu-system_x86-64</code>ÔºåËøô‰∏™Â∞±ÊòØ Qemu ÁöÑÊú¨‰Ωì‰∫Ü</p>
<p>Â¶ÇÊûúÈúÄË¶ÅÁöÑËØùÂèØ‰ª•ÈÄöËøá <code>make install</code> ÂÆâË£ÖÂà∞Á≥ªÁªü‰∏≠ÔºåËøôÊ†∑Â∞±ËÉΩÁõ¥Êé•‰ªéÂëΩ‰ª§Ë°åÂêØÂä®‰∫Ü</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">build$ </span><span class="language-bash">sudo make install</span><br></code></pre></td></tr></table></figure>

<h1 id="0x02-ÊûÑÂª∫Á≥ªÁªüÈïúÂÉèÂπ∂‰ΩøÁî®-vnc-ËøûÊé•"><a href="#0x02-ÊûÑÂª∫Á≥ªÁªüÈïúÂÉèÂπ∂‰ΩøÁî®-vnc-ËøûÊé•" class="headerlink" title="0x02.ÊûÑÂª∫Á≥ªÁªüÈïúÂÉèÂπ∂‰ΩøÁî® vnc ËøûÊé•"></a>0x02.ÊûÑÂª∫Á≥ªÁªüÈïúÂÉèÂπ∂‰ΩøÁî® vnc ËøûÊé•</h1><p>Á©∫Êúâ‰∏Ä‰∏™ <code>qemu</code> ÁöÑÂèØÊâßË°åÊñá‰ª∂Ëøò‰∏çË°åÔºåÊàë‰ª¨ÊúÄÁªàËøòÊòØË¶ÅÂú® qemu ‰∏äÈù¢Ë∑ë‰∏Ä‰∏™ÂÆåÊï¥ÁöÑÊìç‰ΩúÁ≥ªÁªüÁöÑÔºåÈÇ£‰πàËøôÈáåÊúâ‰∏§ÁßçÊñπÊ≥ïÔºö</p>
<ul>
<li>‰ΩøÁî® <code>qemu-img</code> ÂàõÂª∫ËôöÊãüÊú∫ÈïúÂÉèÊñá‰ª∂ÔºåÈÄöËøá <code>-cdrom</code> ÂèÇÊï∞ÊåáÂÆöËΩΩÂÖ•‰∏Ä‰∏™ ISO ÈïúÂÉèÊñá‰ª∂Êù•ÂÆâË£Ö‰∏Ä‰∏™Áé∞ÊúâÁöÑÊìç‰ΩúÁ≥ªÁªü</li>
<li>‰ΩøÁî® <code>debootstrap</code> ÂàõÂª∫ ext4 Á°¨ÁõòÈïúÂÉèÔºåÂπ∂Áõ¥Êé•ËøêË°å‰∏Ä‰∏™Áé∞ÊàêÁöÑË£∏ÁöÑÂÜÖÊ†∏ÈïúÂÉèÊñá‰ª∂ÔºàbzImageÔºâ</li>
</ul>
<h2 id="‰∏Ä„ÄÅÂàõÂª∫ËôöÊãüÊú∫ÈïúÂÉèÊñá‰ª∂Âπ∂ÈÄöËøá-CDROM-ÂÆâË£Ö-Ubuntu"><a href="#‰∏Ä„ÄÅÂàõÂª∫ËôöÊãüÊú∫ÈïúÂÉèÊñá‰ª∂Âπ∂ÈÄöËøá-CDROM-ÂÆâË£Ö-Ubuntu" class="headerlink" title="‰∏Ä„ÄÅÂàõÂª∫ËôöÊãüÊú∫ÈïúÂÉèÊñá‰ª∂Âπ∂ÈÄöËøá CDROM ÂÆâË£Ö Ubuntu"></a>‰∏Ä„ÄÅÂàõÂª∫ËôöÊãüÊú∫ÈïúÂÉèÊñá‰ª∂Âπ∂ÈÄöËøá CDROM ÂÆâË£Ö Ubuntu</h2><h3 id="I-‰ΩøÁî®-qemu-img-ÂàõÂª∫ËôöÊãüÊú∫Á£ÅÁõòÈïúÂÉèÊñá‰ª∂"><a href="#I-‰ΩøÁî®-qemu-img-ÂàõÂª∫ËôöÊãüÊú∫Á£ÅÁõòÈïúÂÉèÊñá‰ª∂" class="headerlink" title="I.‰ΩøÁî® qemu-img ÂàõÂª∫ËôöÊãüÊú∫Á£ÅÁõòÈïúÂÉèÊñá‰ª∂"></a>I.‰ΩøÁî® <code>qemu-img</code> ÂàõÂª∫ËôöÊãüÊú∫Á£ÅÁõòÈïúÂÉèÊñá‰ª∂</h3><p>Ëøô‰∏ÄÊ≠•ÊØîËæÉÁÆÄÂçïÔºå‰∏ªË¶ÅÊòØÁî® <code>build</code> ÁõÆÂΩï‰∏ãÁöÑ <code>qemu-img</code> Êù•ÂÆåÊàêÊûÑÂª∫Ôºö</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./build/qemu-img create -f qcow2 test.qcow2 20G</span><br>Formatting &#x27;test.qcow2&#x27;, fmt=qcow2 cluster_size=65536 extended_l2=off compression_type=zlib size=21474836480 lazy_refcounts=off refcount_bits=16<br></code></pre></td></tr></table></figure>

<p>ËøôÈáåÁöÑ <code>-f</code> ÂèÇÊï∞ÊåáÂÆöÁöÑÁ¨¨‰∏Ä‰∏™ÂèÇÊï∞‰∏∫ÈïúÂÉèÊ†ºÂºèÔºåËøôÈáå‰ΩøÁî® QEMU ÊúÄÈÄöÁî®ÁöÑÊ†ºÂºè <code>qcow2</code>ÔºõÁ¨¨‰∫å‰∏™ÂèÇÊï∞‰∏∫Êñá‰ª∂Ë∑ØÂæÑÔºõÁ¨¨‰∏â‰∏™ÂèÇÊï∞‰∏∫ÈïúÂÉèÂ§ßÂ∞è</p>
<blockquote>
<p>ÂèÇËßÅ<a target="_blank" rel="noopener" href="https://docs.fedoraproject.org/zh-CN/Fedora/12/html/Virtualization_Guide/sect-Virtualization_Guide-Tips_and_tricks-Using_qemu_img.html">ËøôÈáå</a></p>
</blockquote>
<h3 id="II-ÈÄöËøá-vnc-ËøûÊé•ÂÆåÊàêÂÆâË£Ö"><a href="#II-ÈÄöËøá-vnc-ËøûÊé•ÂÆåÊàêÂÆâË£Ö" class="headerlink" title="II.ÈÄöËøá vnc ËøûÊé•ÂÆåÊàêÂÆâË£Ö"></a>II.ÈÄöËøá vnc ËøûÊé•ÂÆåÊàêÂÆâË£Ö</h3><p>Âú® qemu ÂêØÂä®Êó∂ÈÄöËøá <code>-cdrom</code> ÂèÇÊï∞ÂèØ‰ª•ÊåáÂÆöÂä†ËΩΩÁöÑISOÊñá‰ª∂Ë∑ØÂæÑÔºåËøôÈáåÁ¨îËÄÖÈÄâÊã©ÂÆâË£Ö‰∏Ä‰∏™ Ubuntu 22.04Ôºö</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo ./build/qemu-system-x86_64 -m 2G -drive format=qcow2,file=test.qcow2 -enable-kvm -cdrom ~/Download/ubuntu-22.04-desktop-amd64.iso</span><br>VNC server running on ::1:5900<br></code></pre></td></tr></table></figure>

<p>ÂèÇÊï∞ËØ¥ÊòéÂ¶Ç‰∏ãÔºö</p>
<ul>
<li><code>-m</code>ÔºöËôöÊãüÊú∫ÁöÑÂÜÖÂ≠òÂ§ßÂ∞è</li>
<li><code>-drive</code> Ôºöqemu ÂêØÂä®Êó∂È¢ùÂ§ñÂä†ËΩΩÁöÑËÆæÂ§áÔºåËøôÈáåÊàë‰ª¨‰ΩøÁî® <code>format=qcow2,file=test.qcow2</code> ÊåáÂÆö‰∫ÜÂä†ËΩΩËÆæÂ§á <code>test.qcow2</code>„ÄÅÊ†ºÂºè‰∏∫ <code>qcow2</code></li>
<li><code>-enable-kvm</code> ÔºöÂêØÁî® kvm Ê®°ÂºèÔºåÈúÄË¶ÅÊ≥®ÊÑèÁöÑÊòØËØ•ÈÄâÈ°π<strong>Ë¶ÅÊ±Ç‰ª• root ÊùÉÈôêËøêË°å</strong></li>
<li><code>-cdrom</code>ÔºöÊåáÂÆö qemu ÂêØÂä®Êó∂Ë£ÖËΩΩÁöÑÂÖâÁ¢üÊñá‰ª∂Ë∑ØÂæÑ</li>
</ul>
<p>ÂêØÂä®Âêé qemu ÈªòËÆ§‰ºöÂú® 5900 Á´ØÂè£ÂêØÂä®‰∏Ä‰∏™ VNC serverÔºåÊ≠§Êó∂Êàë‰ª¨‰æøËÉΩÈÄöËøá VNC ËøûÊé•Âà∞ qemu ‰∏äÔºåÈúÄË¶ÅÊ≥®ÊÑèÁöÑÊòØËøôÈáå<strong>Âè™ËÉΩÂú®Êú¨Âú∞ËøõË°åËøûÊé•</strong></p>
<blockquote>
<p>Ê≥®ÔºöÊàë‰ª¨ÈªòËÆ§‰ªéÂåÖÁÆ°ÁêÜÂô®ÂÆâË£ÖÁöÑ QEMU ‰ΩøÁî®ÁöÑÊòØ GTK ÂõæÂΩ¢ÁïåÈù¢ÔºåÂ¶ÇÊûú‰Ω†Êõ¥ÂñúÊ¨¢‰ΩøÁî®Ëøô‰∏™ÔºåÂàôÂèØ‰ª•Âú®ÁºñËØëÈÄâÈ°π‰∏≠È¢ùÂ§ñÂä†‰∏ä <code>--enable-gtk</code> ÔºåËøôÊ†∑ÈªòËÆ§Â∞±ÊòØÁî® gtk Âú®Êú¨Âú∞ÁªòÂà∂ÂõæÂΩ¢ÁïåÈù¢Ôºå‰∏çËøáËøôÈÄöÂ∏∏È¢ùÂ§ñÈúÄË¶ÅÁ±ª‰ºº <code>gtk-devel</code> ÁöÑÂ∫ì</p>
</blockquote>
<p>Â¶ÇÊûúÊòØËøêË°åÂú®ËøúÁ®ãÊúçÂä°Âô®‰∏äÁöÑËØùÔºåÊàë‰ª¨ËøòÈúÄË¶ÅÈ¢ùÂ§ñÊåáÂÆö <code>-vnc</code> ÂèÇÊï∞Ôºö</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo ./build/qemu-system-x86_64 -m 2G -drive format=qcow2,file=test.qcow2 -enable-kvm -cdrom ~/Download/ubuntu-22.04-desktop-amd64.iso -vnc yourip:0</span><br></code></pre></td></tr></table></figure>

<p>ÈúÄË¶ÅÊ≥®ÊÑèÁöÑÊòØ <code>vnc</code> ÂèÇÊï∞‰∏≠ ip ÂêéÈù¢Ë∑üÁùÄÁöÑ‰∏çÊòØÁ´ØÂè£Âè∑ÔºåËÄåÊòØ <code>display numer</code>ÔºåÂØπ‰∫éÈªòËÆ§ÁöÑ <code>display 0</code> ËÄåË®ÄÂÖ∂ÁõëÂê¨ÁöÑÁ´ØÂè£Âè∑‰∏∫ <code>5900</code>ÔºåËÄå <code>display 1</code> Â∞±ÊòØ <code>5901</code> Á´ØÂè£Ôºå‰ª•Ê≠§Á±ªÊé®</p>
<p>‰πãÂêéÊàë‰ª¨‰æøËÉΩÈÄöËøá vnc ËøûÊé•‰∏äËøúÁ®ãÊúçÂä°Âô®‰∏äÁöÑ qemu ‰∫ÜÔºåËøôÈáåÁ¨îËÄÖÈÄâÊã©‰ΩøÁî® <code>VNC Viewer</code> ËøõË°åËøûÊé•Ôºö</p>
<p><img src="https://s2.loli.net/2022/07/11/3juM5iAgFERhYsS.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ÊàêÂäüËøûÊé•‰∏äËøúÁ®ãÊúçÂä°Âô®‰∏äÁöÑ qemuÔºö</p>
<p><img src="https://s2.loli.net/2022/07/11/UdlOA6DGaPFJqx2.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>‰πãÂêéÂ∞±ÊòØÂ∏∏ËßÑÁöÑÂÆâË£ÖÊµÅÁ®ã‰∫ÜÔºå‰∏çËøáÂèØËÉΩÊòØÁî±‰∫é qemu Ê®°ÊãüÊòæÂç°ÁöÑÈóÆÈ¢òÔºàÊàñËÄÖÊòØ VNC ÈÖçÁΩÆÁöÑÈóÆÈ¢òÔºâÔºåÂú®‰∏ÄÂºÄÂßãÁöÑÊó∂ÂÄôÂÆâË£ÖÁïåÈù¢ÁöÑÈ¢úËâ≤‰ºöÊúâÁÇπÂ§±ÁúüÔºö</p>
<p><img src="https://s2.loli.net/2022/07/11/lsp4rnZqSdbcIGL.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>‰∏çËøáÂú®ÂÆâË£ÖÂáÜÂ§áÁªìÊùüÁöÑÊó∂ÂÄôÂèàÊÅ¢Â§çÊ≠£Â∏∏ÁöÑÈ¢úËâ≤‰∫ÜÔºåÁ¨îËÄÖÁõÆÂâçÊé®ÊµãÂ∫îËØ•ÊòØÂíåÊòæÂç°È©±Âä®ÊúâÂÖ≥Ôºö</p>
<p><img src="https://s2.loli.net/2022/07/11/g5jCb8yzmQYsvMd.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>‰πãÂêéÂ∞±ÂíåÊ≠£Â∏∏‰ΩøÁî®ËôöÊãüÊú∫Ê≤°Êúâ‰ªÄ‰πàÂå∫Âà´‰∫ÜÔºå‰∏ãÊ¨°ÂÜçÊ¨°ÂêØÂä®Â∞±‰∏çÈúÄË¶ÅÊåáÂÆö <code>-cdrom</code> ÂèÇÊï∞‰∫Ü</p>
<p><img src="https://s2.loli.net/2022/07/11/WZiEx6vqnYapdl7.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="Extra-Êâ©Â±ï-qcow2-Á£ÅÁõòÈïúÂÉèÂ§ßÂ∞è"><a href="#Extra-Êâ©Â±ï-qcow2-Á£ÅÁõòÈïúÂÉèÂ§ßÂ∞è" class="headerlink" title="Extra. Êâ©Â±ï qcow2 Á£ÅÁõòÈïúÂÉèÂ§ßÂ∞è"></a>Extra. Êâ©Â±ï qcow2 Á£ÅÁõòÈïúÂÉèÂ§ßÂ∞è</h3><p>Á£ÅÁõòÈïúÂÉèÁöÑÁ©∫Èó¥ÂæÄÂæÄ‰ºöÈöèÁùÄ‰ΩøÁî®Ë¢´‰∏çÊñ≠Ë£ÖÂ°´Áõ¥Ëá≥ÁàÜÊª°ÔºåÂõ†Ê≠§ÊúâÁöÑÊó∂ÂÄôÊàë‰ª¨ËøòÈúÄË¶ÅÂØπ qcow2 ÈïúÂÉèÊñá‰ª∂ËøõË°åÊâ©Â±ï</p>
<p>‰ΩøÁî® <code>qemu-img info</code> ÂëΩ‰ª§ÂèØ‰ª•Êü•Áúã‰∏Ä‰∏™ qcow2 Êñá‰ª∂ÁöÑËÆæËÆ°Â§ßÂ∞è‰∏éÂç†Áî®ÁöÑÁ°¨ÁõòÁ©∫Èó¥Â§ßÂ∞èÔºàËøôÈÄöÂ∏∏Á≠âÂêå‰∫éÂ∑≤‰ΩøÁî®Â§ßÂ∞èÔºâÔºö</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">qemu-img info ./test.qcow2</span> <br>image: ./test.qcow2<br>file format: qcow2<br>virtual size: 20 GiB (21474836480 bytes)<br>disk size: 19.9 GiB<br>cluster_size: 65536<br>Format specific information:<br>    compat: 1.1<br>    compression type: zlib<br>    lazy refcounts: true<br>    refcount bits: 16<br>    corrupt: false<br>    extended l2: false<br>Child node &#x27;/file&#x27;:<br>    filename: ./test.qcow2<br>    protocol type: file<br>    file length: 20 GiB (21478375424 bytes)<br>    disk size: 19.9 GiB<br></code></pre></td></tr></table></figure>

<p>ËÄå‰ΩøÁî® <code>qemu-img resize</code> ÂëΩ‰ª§ÂàôÂèØ‰ª•Âä®ÊÄÅ‰øÆÊîπ qcow2 Êñá‰ª∂ÁöÑÂ§ßÂ∞èÔºå‰æãÂ¶ÇÂ¶Ç‰∏ãÂëΩ‰ª§‰∏∫ qcow2 ÈïúÂÉèÊñá‰ª∂Êñ∞Â¢û‰∫Ü 20G ÁöÑÂ§ßÂ∞èÔºö</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">qemu-img resize test.qcow2 +20G</span><br></code></pre></td></tr></table></figure>

<p>Ê≠§Êó∂ÂÜçÊü•ÁúãÂ∞±‰ºöÂèëÁé∞ qcow2 ÁöÑÂ§ßÂ∞è‰∏äÈôêÂ∑≤ÁªèÂèëÁîüÊîπÂèòÔºö</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">qemu-img info ./test.qcow2</span> <br>image: ./test.qcow2<br>file format: qcow2<br>virtual size: 40 GiB (42949672960 bytes)<br>disk size: 19.9 GiB<br></code></pre></td></tr></table></figure>



<h2 id="‰∫å„ÄÅÊûÑÂª∫-ext4-Á£ÅÁõòÈïúÂÉèÂπ∂ËøêË°å-kernel-bzImage"><a href="#‰∫å„ÄÅÊûÑÂª∫-ext4-Á£ÅÁõòÈïúÂÉèÂπ∂ËøêË°å-kernel-bzImage" class="headerlink" title="‰∫å„ÄÅÊûÑÂª∫ ext4 Á£ÅÁõòÈïúÂÉèÂπ∂ËøêË°å kernel bzImage"></a>‰∫å„ÄÅÊûÑÂª∫ ext4 Á£ÅÁõòÈïúÂÉèÂπ∂ËøêË°å kernel bzImage</h2><p>Â¶ÇÊûú‰Ω†‰∏çÈúÄË¶Å‰∏Ä‰∏™ÂÆåÊï¥ÁöÑÂèëË°åÁâà Linux Á≥ªÁªüÁéØÂ¢ÉÔºåÂè™ÊòØÊÉ≥Ë∑ë‰∏Ä‰∏™Ë£∏ÁöÑÁÆÄÊòìÁöÑÂÜÖÊ†∏Ôºå‰πüÂèØ‰ª•ÈÄöËøá‰∏ãÈù¢ÁöÑÊñπÂºèÂÆåÊàêÔºö</p>
<h3 id="I-ÊûÑÂª∫Á£ÅÁõòÈïúÂÉè"><a href="#I-ÊûÑÂª∫Á£ÅÁõòÈïúÂÉè" class="headerlink" title="I.ÊûÑÂª∫Á£ÅÁõòÈïúÂÉè"></a>I.ÊûÑÂª∫Á£ÅÁõòÈïúÂÉè</h3><p>ËøôÈáåÊàë‰ª¨‰ΩøÁî® <code>debootstrap</code> Êù•ÂàõÂª∫ext4Á°¨ÁõòÈïúÂÉèÔºåÁõ¥Êé•‰ΩøÁî®Áî± Google Âõ¢Èòü‰∏∫ syzkaller ÊûÑÂª∫Á£ÅÁõòÈïúÂÉèÁöÑËÑöÊ≠•Âç≥ÂèØ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get install debootstrap</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> image</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> image</span><br><span class="hljs-meta prompt_">image$ </span><span class="language-bash">wget https://raw.githubusercontent.com/google/syzkaller/master/tools/create-image.sh -O create-image.sh</span><br><span class="hljs-meta prompt_">image$ </span><span class="language-bash"><span class="hljs-built_in">chmod</span> +x create-image.sh</span><br><span class="hljs-meta prompt_">image$ </span><span class="language-bash">./create-image.sh</span><br></code></pre></td></tr></table></figure>

<p>ÂÆåÊàê‰πãÂêéÂú®ÂΩìÂâçÁõÆÂΩï‰∏ãÂ∞±‰ºöÊúâ‰∏Ä‰∏™ÁÉ≠‰πé‰πéÁöÑ <code>stretch.img</code>ÔºåËøô‰æøÊòØ ext4 Á£ÅÁõòÈïúÂÉèÊñá‰ª∂‰∫Ü</p>
<blockquote>
<p>wget ÁöÑËøô‰∏ÄÊ≠•<strong>ÈúÄË¶ÅÁøªÂ¢ô</strong>Ôºà<code>raw.githubusercontent.com</code> Âú®ÂõΩÂÜÖ‰ºº‰πéÊòØË¢´Â¢ô‰∫ÜÔºåÊÄª‰πãÁ¨îËÄÖËÆ∞ÂøÜÈáå‰ªéÊ≤°ÊàêÂäüÂú®‰∏çÁøªÂ¢ôÁöÑÊÉÖÂÜµ‰∏ãÊàêÂäü‰∏äÂéªËøáÔºâÔºåËã•Â´åÈ∫ªÁÉ¶ÂèØ‰ª•Áõ¥Êé• copy <a href="/download/create-image.sh">Á¨îËÄÖÂ∑≤Áªè‰∏ãÂ•ΩÁöÑ</a></p>
</blockquote>
<h3 id="II-Ëé∑Âèñ-kernel-bzImage"><a href="#II-Ëé∑Âèñ-kernel-bzImage" class="headerlink" title="II.Ëé∑Âèñ kernel bzImage"></a>II.Ëé∑Âèñ kernel bzImage</h3><p>ËøôÈÉ®ÂàÜÂèÇËßÅ<a target="_blank" rel="noopener" href="http://arttnba3.cn/2021/02/21/OS-0X01-LINUX-KERNEL-PART-II/#0x01-%E8%8E%B7%E5%8F%96%E5%86%85%E6%A0%B8%E9%95%9C%E5%83%8F%EF%BC%88bzImage%EF%BC%89">ËøôÈáå</a></p>
<h3 id="III-ËøêË°å-qemu-Âπ∂ÈÄöËøá-vnc-ËøõË°åËøûÊé•"><a href="#III-ËøêË°å-qemu-Âπ∂ÈÄöËøá-vnc-ËøõË°åËøûÊé•" class="headerlink" title="III.ËøêË°å qemu Âπ∂ÈÄöËøá vnc ËøõË°åËøûÊé•"></a>III.ËøêË°å qemu Âπ∂ÈÄöËøá vnc ËøõË°åËøûÊé•</h3><p>ÂàõÂª∫Â¶Ç‰∏ã bash ËÑöÊú¨Âπ∂ËøêË°åÔºö</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br>qemu-system-x86_64 \<br>	-m 2G \<br>	-smp 2 \<br>	-kernel ./bzImage \<br>	-append <span class="hljs-string">&quot;root=/dev/sda&quot;</span> \<br>	-drive file=./stretch.img,format=raw \<br>	-enable-kvm \<br>	-vnc yourip:0<br></code></pre></td></tr></table></figure>

<p>‰πãÂêéËøòÊòØÁõ¥Êé•Áî® vnc ËøõË°åËøûÊé•Âç≥ÂèØÔºàÂ¶ÇÊûúÂè™ÈúÄË¶ÅÂú®Êú¨Âú∞ËøêË°åÁöÑËØùÂèØ‰ª•‰∏çÁî®ÈôÑÂä† <code>-vnc</code> ÂèÇÊï∞ÔºåËÄåÊòØÂä†‰∏ä <code>-nographic</code> ÂèÇÊï∞ÔºâÔºö</p>
<p><img src="https://s2.loli.net/2022/07/12/yjcVlhtYOz4pQvC.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h1 id="0x03-QEMU-Ê∫êÁ†ÅË∞ÉËØï"><a href="#0x03-QEMU-Ê∫êÁ†ÅË∞ÉËØï" class="headerlink" title="0x03. QEMU Ê∫êÁ†ÅË∞ÉËØï"></a>0x03. QEMU Ê∫êÁ†ÅË∞ÉËØï</h1><p>QEMU ÂÖÅËÆ∏Êàë‰ª¨ÈÄöËøá <code>-s</code> ÊàñÊòØ <code>-gdb tcp::1234</code> ËøôÊ†∑ÁöÑÈôÑÂä†ÂèÇÊï∞Êù•Ë∞ÉËØïËôöÊãüÊú∫ÔºàÊØîÂ¶ÇËØ¥Ë∞ÉËØï Linux kernelÔºâÔºå‰ΩÜÊúâÁöÑÊó∂ÂÄôÊàë‰ª¨ÊÉ≥Ë¶Å<strong>Áõ¥Êé•Ë∞ÉËØï QEMU Êú¨‰Ωì</strong>ÔºàÊØîÂ¶ÇËØ¥Ë∞ÉËØï‰∏Ä‰∫õËá™Â∑±ÂÜôÁöÑÊ®°ÊãüËÆæÂ§áÔºâÔºåËøô‰∏™Êó∂ÂÄôÂ∞±ÈúÄË¶ÅÊàë‰ª¨Â∞Ü Host ‰∏äÁöÑ QEMU ËøõÁ®ã‰Ωú‰∏∫ÂæÖË∞ÉËØïÂØπË±°</p>
<p>Âõ†‰∏∫ QEMU Êú¨Ë∫´‰πüÊòØÂú® Host ‰∏äËøêË°åÁöÑ‰∏Ä‰∏™ËøõÁ®ãÔºåÊâÄ‰ª•Á¨îËÄÖËøôÈáåÁªôÂá∫‰∏Ä‰∏™ÊØîËæÉÁõ¥Êé•ÁöÑË∞ÉËØï QEMU ÁöÑÂäûÊ≥ïÔºöÊää QEMU Êú¨‰ΩìÂêØÂä®Ëµ∑Êù•ÂêéÁõ¥Êé•Áî® <code>ps</code> Êâæ QEMU ËøõÁ®ãÁÑ∂Âêé gdb attach  Âç≥ÂèØÂÉèÊ≠£Â∏∏Ë∞ÉËØï‰∏Ä‰∏™ÊôÆÈÄöËøõÁ®ã‰∏ÄÊ†∑Ë∞ÉËØï QEMUÔºö</p>
<p><img src="https://s2.loli.net/2023/04/13/ocrYWTQ4Nw3LEh5.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>Â¶ÇÊûúÊòØËá™Â∑±ÁºñËØëÁöÑ QEMU ËøôÊ†∑Â∞±ÂèØ‰ª•Áõ¥Êé•‰ªéÊ∫êÁ†ÅËøõË°åË∞ÉËØï‰∫ÜÔºö</p>
<p><img src="https://s2.loli.net/2023/04/13/ol9OLkRDcusndU4.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h1 id="0x04-ÁÆÄÊòì-QEMU-ËÆæÂ§áÁºñÂÜô"><a href="#0x04-ÁÆÄÊòì-QEMU-ËÆæÂ§áÁºñÂÜô" class="headerlink" title="0x04.ÁÆÄÊòì QEMU ËÆæÂ§áÁºñÂÜô"></a>0x04.ÁÆÄÊòì QEMU ËÆæÂ§áÁºñÂÜô</h1><p>ËôΩÁÑ∂ Qemu ÊîØÊåÅÊ®°ÊãüÂ§öÁßçËÆæÂ§áÔºå‰ΩÜÊòØÂπ∂‰∏çËÉΩÊ∂µÁõñÁé∞Â≠òÊâÄÊúâÁöÑËÆæÂ§áÁ±ªÂûãÔºåÂêåÊó∂ÊúâÁöÑÊó∂ÂÄôÂá∫‰∫é‰∏Ä‰∫õÁâπÊÆäÁöÑÁõÆÁöÑÊàë‰ª¨‰πüÈúÄË¶ÅËá™ÂÆö‰πâ‰∏Ä‰∫õËÆæÂ§áÔºåÂõ†Ê≠§Êú¨ËäÇ‰∏ªË¶ÅËÆ≤Ëø∞Â¶Ç‰ΩïÂú® Qemu ÂΩì‰∏≠ÁºñÂÜô‰∏Ä‰∏™Êñ∞ÁöÑ PCI Á±ªÂûãÁöÑËÆæÂ§á</p>
<blockquote>
<p>Ê≥®1ÔºöÂú®ÂºÄÂßã‰πãÂâç‰Ω†ÂèØËÉΩÈúÄË¶ÅË°•ÂÖÖ‰∏Ä‰∫õ<a target="_blank" rel="noopener" href="https://arttnba3.cn/2022/08/30/HARDWARE-0X00-PCI_DEVICE/">PCI ËÆæÂ§áÁöÑÂü∫Á°ÄÁü•ËØÜ</a></p>
<p>Ê≥®2Ôºöqemu ÂÆòÊñπÂú® <code>hw/misc/edu.c</code> ‰∏≠‰πüÊèê‰æõ‰∫Ü‰∏Ä‰∏™ÊïôÂ≠¶Áî®ÁöÑËÆæÂ§áÊ†∑‰æãÔºåred hat ÂàôÂú® <code>hw/misc/pci-testdev.c</code> ‰∏≠Êèê‰æõ‰∫Ü‰∏Ä‰∏™ÊµãËØïËÆæÂ§áÔºåÊàë‰ª¨ÂèØ‰ª•ÂèÇËÄÉËøô‰∏§‰∏™ËÆæÂ§áÊù•ÊûÑÂª∫Êàë‰ª¨ÁöÑËÆæÂ§á</p>
</blockquote>
<h2 id="‰∏Ä„ÄÅQemu-Object-Model"><a href="#‰∏Ä„ÄÅQemu-Object-Model" class="headerlink" title="‰∏Ä„ÄÅQemu Object Model"></a>‰∏Ä„ÄÅQemu Object Model</h2><p>ËôΩÁÑ∂ Qemu ÊòØ‰ΩøÁî® C ÁºñÂÜôÁöÑÔºå‰ΩÜÊòØÂÖ∂‰ª£Á†Å‰πüÂÖÖÊª°‰∫Ü OOP ÁöÑÊÄùÊÉ≥ÔºåÂú® Qemu ÂΩì‰∏≠ÊúâÁùÄ‰∏ÄÂ•óÂè´ÂÅö <strong>Qemu Object Model</strong> ÁöÑ‰∏úË•øÊù•ÂÆûÁé∞Èù¢ÂêëÂØπË±°Ôºå‰∏ªË¶ÅÁî±ËøôÂõõ‰∏™ÁªÑ‰ª∂ÊûÑÊàêÔºö</p>
<ul>
<li><code>Type</code>ÔºöÁî®Êù•ÂÆö‰πâ‰∏Ä‰∏™„ÄåÁ±ª„ÄçÁöÑÂü∫Êú¨Â±ûÊÄßÔºå‰æãÂ¶ÇÁ±ªÁöÑÂêçÂ≠ó„ÄÅÂ§ßÂ∞è„ÄÅÊûÑÈÄ†ÂáΩÊï∞Á≠â</li>
<li><code>Class</code>ÔºöÁî®Êù•ÂÆö‰πâ‰∏Ä‰∏™„ÄåÁ±ª„ÄçÁöÑÈùôÊÄÅÂÜÖÂÆπÔºå‰æãÂ¶ÇÁ±ª‰∏≠Â≠òÂÇ®ÁöÑÈùôÊÄÅÊï∞ÊçÆ„ÄÅÊñπÊ≥ïÂáΩÊï∞ÊåáÈíàÁ≠â</li>
<li><code>Object</code>ÔºöÂä®ÊÄÅÂàÜÈÖçÁöÑ‰∏Ä‰∏™„ÄåÁ±ª„ÄçÁöÑÂÖ∑‰ΩìÁöÑÂÆû‰æãÔºàinstanceÔºâÔºåÂÇ®Â≠òÁ±ªÁöÑÂä®ÊÄÅÊï∞ÊçÆ</li>
<li><code>Property</code>ÔºöÂä®ÊÄÅÂØπË±°Êï∞ÊçÆÁöÑËÆøÈóÆÂô®ÔºàaccessorÔºâÔºåÂèØ‰ª•ÈÄöËøáÁõëËßÜÂô®Êé•Âè£ËøõË°åÊ£ÄÊü•</li>
</ul>
<p>Á±ª‰ºº‰∫é GolangÔºåÂú® QOM ÂΩì‰∏≠‰ΩøÁî®ÊàêÂëòÂµåÂ•óÁöÑÊñπÂºèÊù•ÂÆåÊàêÁ±ªÁöÑÁªßÊâøÔºåÁà∂Á±ª‰Ωú‰∏∫Á±ªÁªìÊûÑ‰ΩìÁöÑÁ¨¨‰∏Ä‰∏™ÊàêÂëò <code>parent</code> ËÄåÂ≠òÂú®ÔºåÂõ†Ê≠§‰πü‰∏çÊîØÊåÅÂ§öÁªßÊâø</p>
<blockquote>
<p>ÂèÇËßÅËøô‰∏™<a target="_blank" rel="noopener" href="https://www.linux-kvm.org/images/f/f6/2012-forum-QOM_CPU.pdf">ppt</a></p>
</blockquote>
<h3 id="I„ÄÅTypeInfo-Á±ªÁöÑÂü∫Êú¨Â±ûÊÄß"><a href="#I„ÄÅTypeInfo-Á±ªÁöÑÂü∫Êú¨Â±ûÊÄß" class="headerlink" title="I„ÄÅTypeInfo - Á±ªÁöÑÂü∫Êú¨Â±ûÊÄß"></a>I„ÄÅTypeInfo - Á±ªÁöÑÂü∫Êú¨Â±ûÊÄß</h3><p><code>TypeInfo</code> Ëøô‰∏ÄÁªìÊûÑ‰ΩìÁî®Êù•ÂÆö‰πâ‰∏Ä‰∏™„ÄåÁ±ª„ÄçÁöÑÂü∫Êú¨Â±ûÊÄßÔºåËØ•ÁªìÊûÑ‰ΩìÂÆö‰πâ‰∫é <code>include/qom/object.h</code> ÂΩì‰∏≠Ôºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * TypeInfo:</span><br><span class="hljs-comment"> * @name: Á±ªÂûãÂêç.</span><br><span class="hljs-comment"> * @parent: Áà∂Á±ªÂûãÂêç.</span><br><span class="hljs-comment"> * @instance_size: ÂØπË±°Â§ßÂ∞è (#Object ÁöÑË°çÁîüÁâ©). </span><br><span class="hljs-comment"> *   Ëã• @instance_size ‰∏∫ 0, ÂàôÂØπË±°ÁöÑÂ§ßÂ∞è‰∏∫ÂÖ∂Áà∂Á±ªÁöÑÂ§ßÂ∞è</span><br><span class="hljs-comment"> * @instance_init: ËØ•ÂáΩÊï∞Ë¢´Ë∞ÉÁî®‰ª•ÂàùÂßãÂåñÂØπË±°ÔºàËØëÊ≥®ÔºöÊûÑÈÄ†ÂáΩÊï∞Ôºâ. </span><br><span class="hljs-comment"> *   ÔºàËØëÊ≥®ÔºöË∞ÉÁî®ÂâçÔºâÁà∂Á±ªÂ∑≤Ë¢´ÂàùÂßãÂåñÔºåÂõ†Ê≠§Â≠êÁ±ªÂè™ÈúÄË¶ÅÂàùÂßãÂåñ‰ªñËá™Â∑±ÁöÑÊàêÂëò„ÄÇ</span><br><span class="hljs-comment"> * @instance_post_init: ËØ•ÂáΩÊï∞Ë¢´Ë∞ÉÁî®‰ª•ÁªìÊùü‰∏Ä‰∏™ÂØπË±°ÁöÑÂàùÂßãÂåñÔºå</span><br><span class="hljs-comment"> *   Âú®ÊâÄÊúâÁöÑ @instance_init ÂáΩÊï∞Ë¢´Ë∞ÉÁî®‰πãÂêé.</span><br><span class="hljs-comment"> * @instance_finalize: ËØ•ÂáΩÊï∞Âú®ÂØπË±°Ë¢´ÊûêÊûÑÊó∂Ë∞ÉÁî®. ÂÖ∂Âú®</span><br><span class="hljs-comment"> *   Áà∂Á±ªÁöÑ @instance_finalize Ë¢´Ë∞ÉÁî®‰πãÂâçË¢´Ë∞ÉÁî®.</span><br><span class="hljs-comment"> *   Âú®ËØ•ÂáΩÊï∞‰∏≠‰∏Ä‰∏™ÂØπË±°Â∫îÂΩì‰ªÖÈáäÊîæËØ•ÂØπË±°ÁâπÊúâÁöÑÊàêÂëò„ÄÇ</span><br><span class="hljs-comment"> * @abstract: Ëã•ËØ•Âüü‰∏∫ÁúüÔºåÂàôËØ•Á±ª‰∏∫‰∏Ä‰∏™ËôöÁ±ªÔºå‰∏çËÉΩË¢´Áõ¥Êé•ÂÆû‰æãÂåñ„ÄÇ</span><br><span class="hljs-comment"> * @class_size: Ëøô‰∏™ÂØπË±°ÁöÑÁ±ªÂØπË±°ÁöÑÂ§ßÂ∞è (#Object ÁöÑË°çÁîüÁâ©)</span><br><span class="hljs-comment"> *   Ëã• @class_size ‰∏∫ 0, ÂàôÁ±ªÁöÑÂ§ßÂ∞è‰∏∫ÂÖ∂Áà∂Á±ªÁöÑÂ§ßÂ∞è„ÄÇ</span><br><span class="hljs-comment"> *   ËøôÂÖÅËÆ∏‰∏Ä‰∏™Á±ªÂûãÂú®Ê≤°ÊúâÊ∑ªÂä†È¢ùÂ§ñÁöÑËôöÂáΩÊï∞Êó∂ÈÅøÂÖçÂÆûÁé∞‰∏Ä‰∏™ÊòæÂºèÁöÑÁ±ªÂûã„ÄÇ</span><br><span class="hljs-comment"> * @class_init: ËØ•ÂáΩÊï∞Âú®ÊâÄÊúâÁà∂Á±ªÂàùÂßãÂåñÁªìÊùüÂêéË¢´Ë∞ÉÁî®Ôºå</span><br><span class="hljs-comment"> *   ‰ª•ÂÖÅËÆ∏‰∏Ä‰∏™Á±ªËÆæÁΩÆ‰ªñÁöÑÈªòËÆ§ËôöÊñπÊ≥ïÊåáÈíà.</span><br><span class="hljs-comment"> *   Ëøô‰πüÂÖÅËÆ∏ËØ•ÂáΩÊï∞ÈáçÂÜôÁà∂Á±ªÁöÑËôöÊñπÊ≥ï„ÄÇ</span><br><span class="hljs-comment"> * @class_base_init: Âú®ÊâÄÊúâÁöÑÁà∂Á±ªË¢´ÂàùÂßãÂåñÂêé„ÄÅ‰ΩÜ</span><br><span class="hljs-comment"> *   Âú®Á±ªËá™Ë∫´ÂàùÂßãÂåñÂâçÔºå‰∏∫ÊâÄÊúâÁöÑÂü∫Á±ªË∞ÉÁî®ËØ•ÂáΩÊï∞„ÄÇ</span><br><span class="hljs-comment"> *   ËØ•ÂáΩÊï∞Áî®‰ª•Êí§ÈîÄ‰ªéÁà∂Á±ª memcpy Âà∞Â≠êÁ±ªÁöÑÂΩ±Âìç.</span><br><span class="hljs-comment"> * @class_data: ‰º†ÈÄíÁªô @class_init ‰∏é @class_base_init ÁöÑÊï∞ÊçÆ,</span><br><span class="hljs-comment"> *   Ëøô‰ºöÂú®Âª∫Á´ãÂä®ÊÄÅÁ±ªÂûãÊó∂ÊúâÁî®„ÄÇ</span><br><span class="hljs-comment"> * @interfaces: ‰∏éËøô‰∏™Á±ªÂûãÁõ∏ÂÖ≥ÁöÑÊé•Âè£. </span><br><span class="hljs-comment"> *   ÂÖ∂Â∫îÂΩìÊåáÂêë‰∏Ä‰∏™‰ª• 0 Â°´ÂÖÖÂÖÉÁ¥†ÁªìÂ∞æÁöÑÈùôÊÄÅÊï∞ÁªÑ</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">TypeInfo</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *parent;<br><br>    <span class="hljs-type">size_t</span> instance_size;<br>    <span class="hljs-type">void</span> (*instance_init)(Object *obj);<br>    <span class="hljs-type">void</span> (*instance_post_init)(Object *obj);<br>    <span class="hljs-type">void</span> (*instance_finalize)(Object *obj);<br><br>    <span class="hljs-type">bool</span> abstract;<br>    <span class="hljs-type">size_t</span> class_size;<br><br>    <span class="hljs-type">void</span> (*class_init)(ObjectClass *klass, <span class="hljs-type">void</span> *data);<br>    <span class="hljs-type">void</span> (*class_base_init)(ObjectClass *klass, <span class="hljs-type">void</span> *data);<br>    <span class="hljs-type">void</span> *class_data;<br><br>    InterfaceInfo *interfaces;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>ÂΩìÊàë‰ª¨Âú® Qemu ‰∏≠Ë¶ÅÂÆö‰πâ‰∏Ä‰∏™„ÄåÁ±ª„ÄçÁöÑÊó∂ÂÄôÔºåÊàë‰ª¨ÂÆûÈôÖ‰∏äÈúÄË¶ÅÂÆö‰πâ‰∏Ä‰∏™ TypeInfo Á±ªÂûãÁöÑÂèòÈáèÔºå‰æãÂ¶Ç‰∏ãÈù¢Â∞±ÊòØ‰∏Ä‰∏™Âú® Qemu ÂÆö‰πâ‰∏Ä‰∏™Ëá™ÂÆö‰πâÁ±ªÁöÑüå∞Ôºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3_type_info = &#123;<br>    .name = <span class="hljs-string">&quot;a3_type&quot;</span>,<br>    .parent = TYPE_OBJECT,<br>    .interfaces = (InterfaceInfo[]) &#123;<br>        &#123; &#125;,<br>    &#125;,<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> a3_register_types(<span class="hljs-type">void</span>) &#123;<br>    type_register_static(&amp;a3_type_info);<br>&#125;<br><br>type_init(a3_register_types);<br></code></pre></td></tr></table></figure>

<p><code>type_init()</code> ÂÖ∂ÂÆûÂ∞±ÊòØ <code>constructor</code> Ëøô‰∏Ä gcc attribute ÁöÑÂ∞ÅË£ÖÔºåÂÖ∂‰ΩúÁî®Â∞±ÊòØÂ∞Ü‰∏Ä‰∏™ÂáΩÊï∞Âä†ÂÖ•Âà∞‰∏Ä‰∏™ <code>init_array</code> ÂΩì‰∏≠ÔºåÂú® Qemu Á®ãÂ∫èÂêØÂä®Êó∂Âú®ËøõÂÖ•Âà∞ main ÂáΩÊï∞‰πãÂâç‰ºöÂÖàË∞ÉÁî® <code>init_array</code> ‰∏≠ÁöÑÂáΩÊï∞ÔºåÂõ†Ê≠§ËøôÈáå‰ºöË∞ÉÁî®Êàë‰ª¨Ëá™ÂÆö‰πâÁöÑÂáΩÊï∞ÔºåÂÖ∂‰ΩúÁî®‰æøÊòØË∞ÉÁî® <code>type_register_static()</code> Â∞ÜÊàë‰ª¨Ëá™ÂÆö‰πâÁöÑÁ±ªÂûã <code>a3_type_info</code> Ê≥®ÂÜåÂà∞ÂÖ®Â±ÄÁöÑÁ±ªÂûãË°®‰∏≠</p>
<h3 id="II„ÄÅClass-Á±ªÁöÑÈùôÊÄÅÂÜÖÂÆπ"><a href="#II„ÄÅClass-Á±ªÁöÑÈùôÊÄÅÂÜÖÂÆπ" class="headerlink" title="II„ÄÅClass - Á±ªÁöÑÈùôÊÄÅÂÜÖÂÆπ"></a>II„ÄÅClass - Á±ªÁöÑÈùôÊÄÅÂÜÖÂÆπ</h3><p>ÂΩìÊàë‰ª¨ÈÄöËøá‰∏Ä‰∏™ <code>TypeInfo</code> ÁªìÊûÑ‰ΩìÂÆö‰πâ‰∫Ü‰∏Ä‰∏™Á±ª‰πãÂêéÔºåÊàë‰ª¨ËøòÈúÄË¶ÅÂÆö‰πâ‰∏Ä‰∏™ Class ÁªìÊûÑ‰ΩìÊù•ÂÆö‰πâËøô‰∏™Á±ªÁöÑÈùôÊÄÅÂÜÖÂÆπÔºåÂåÖÊã¨ÂáΩÊï∞Ë°®„ÄÅÈùôÊÄÅÊàêÂëòÁ≠âÔºåÂÖ∂Â∫îÂΩìÁªßÊâø‰∫éÂØπÂ∫îÁöÑ Class ÁªìÊûÑ‰ΩìÁ±ªÂûãÔºå‰æãÂ¶ÇÊàë‰ª¨Ëã•ÊòØË¶ÅÂÆö‰πâ‰∏Ä‰∏™Êñ∞ÁöÑÊú∫Âô®Á±ªÔºåÂàôÂÖ∂ Class Â∫îÂΩìÁªßÊâø‰∫é <code>MachineClass</code></p>
<p>ÊâÄÊúâ Class ÁªìÊûÑ‰ΩìÁ±ªÂûãÁöÑÊúÄÁªàÁöÑÁà∂Á±ªÈÉΩÊòØ <code>ObjectClass</code> ÁªìÊûÑ‰ΩìÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ObjectClass:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ÊâÄÊúâÁ±ªÁöÑÂü∫Á±ª.  #ObjectClass ‰ªÖÂåÖÂê´‰∏Ä‰∏™Êï¥ÂûãÁ±ªÂûã handler</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ObjectClass</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    Type type;<br>    GSList *interfaces;<br><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *object_cast_cache[OBJECT_CLASS_CAST_CACHE];<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *class_cast_cache[OBJECT_CLASS_CAST_CACHE];<br><br>    ObjectUnparent *unparent;<br><br>    GHashTable *properties;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>‰∏ãÈù¢ÊòØ‰∏Ä‰∏™ÊúÄÁÆÄÂçïÁöÑüå∞Ôºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3Class</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    ObjectClass parent;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÂÆåÊàê Class ÁöÑÂÆö‰πâ‰πãÂêéÊàë‰ª¨ËøòÂ∫îÂΩìÂú®ÂâçÈù¢ÂÆö‰πâÁöÑ <code>a3_type_info</code> ‰∏≠Ê∑ªÂä†‰∏ä Class size ‰∏é Class ÁöÑÊûÑÈÄ†ÂáΩÊï∞Ôºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_class_init</span><span class="hljs-params">(ObjectClass *oc, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>    <span class="hljs-comment">// ËøôÈáåÁöÑ oc ÂèÇÊï∞‰æøÊòØÊñ∞ÂàõÂª∫ÁöÑ ClassÔºåÂÖ®Â±ÄÂè™Êúâ‰∏Ä‰∏™ËØ•ÂÆû‰æã</span><br>    <span class="hljs-comment">// Êàë‰ª¨Â∫îÂΩì cast ‰∏∫Êàë‰ª¨Ëá™Â∑±ÁöÑ Class Á±ªÂûãÔºå‰πãÂêéÂÜçËøõË°åÁõ∏Â∫îÊìç‰Ωú</span><br>    <span class="hljs-comment">// do something</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3_type_info = &#123;<br>    .name = <span class="hljs-string">&quot;a3_type&quot;</span>,<br>    .parent = TYPE_OBJECT,<br>    .class_size = <span class="hljs-keyword">sizeof</span>(A3Class),<br>    .class_init = a3_class_init,<br>    .interfaces = (InterfaceInfo[]) &#123;<br>        &#123; &#125;,<br>    &#125;,<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="III„ÄÅObject-Á±ªÁöÑÂÆû‰æãÂØπË±°"><a href="#III„ÄÅObject-Á±ªÁöÑÂÆû‰æãÂØπË±°" class="headerlink" title="III„ÄÅObject - Á±ªÁöÑÂÆû‰æãÂØπË±°"></a>III„ÄÅObject - Á±ªÁöÑÂÆû‰æãÂØπË±°</h3><p>Êàë‰ª¨ËøòÈúÄË¶ÅÂÆö‰πâ‰∏Ä‰∏™Áõ∏Â∫îÁöÑ Object Á±ªÂûãÊù•Ë°®Á§∫‰∏Ä‰∏™ÂÆû‰æãÂØπË±°ÔºåÂÖ∂ÂåÖÂê´ÊúâËøô‰∏™Á±ªÂÆûÈôÖÁöÑÂÖ∑‰ΩìÊï∞ÊçÆÔºå‰∏îÂ∫îÂΩìÁªßÊâø‰∫éÂØπÂ∫îÁöÑ Object ÁªìÊûÑ‰ΩìÁ±ªÂûãÔºå‰æãÂ¶ÇÊàë‰ª¨Ëã•ÊòØË¶ÅÂÆö‰πâ‰∏Ä‰∏™Êñ∞ÁöÑÊú∫Âô®Á±ªÂûãÔºåÂÖ∂ÂÆû‰æãÁ±ªÂûãÂ∫îÂΩìÁªßÊâøËá™ <code>MachineState</code></p>
<p>ÊâÄÊúâ Object ÁªìÊûÑ‰ΩìÁ±ªÂûãÁöÑÊúÄÁªàÁöÑÁà∂Á±ªÈÉΩÊòØ <code>Object</code> ÁªìÊûÑ‰ΩìÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Object:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ÊâÄÊúâÂØπË±°ÁöÑÂü∫Á±ª„ÄÇËØ•ÂØπË±°ÁöÑÁ¨¨‰∏Ä‰∏™ÊàêÂëò‰∏∫‰∏Ä‰∏™ÊåáÂêë #ObjectClass ÁöÑÊåáÈíà„ÄÇ</span><br><span class="hljs-comment"> * Âõ†‰∏∫ C ‰∏≠Â∞Ü‰∏Ä‰∏™ÁªìÊûÑ‰ΩìÁöÑÁ¨¨‰∏Ä‰∏™ÊàêÂëòÁªÑÁªáÂú®ËØ•ÁªìÊûÑ‰ΩìÁöÑ 0 Â≠óËäÇËµ∑ÂßãÂ§ÑÔºå</span><br><span class="hljs-comment"> * Âè™Ë¶Å‰ªª‰ΩïÁöÑÂ≠êÁ±ªÂ∞ÜÂÖ∂Áà∂Á±ª‰Ωú‰∏∫Á¨¨‰∏Ä‰∏™ÊàêÂëòÔºåÊàë‰ª¨ÈÉΩËÉΩÁõ¥Êé•ËΩ¨Âåñ‰∏∫‰∏Ä‰∏™ #Object.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Âõ†Ê≠§, #Object ÂåÖÂê´‰∏Ä‰∏™ÂØπÂØπË±°Á±ªÁöÑÂºïÁî®‰Ωú‰∏∫ÂÖ∂Á¨¨‰∏Ä‰∏™ÊàêÂëò„ÄÇ </span><br><span class="hljs-comment"> * ËøôÂÖÅËÆ∏Âú®ËøêË°åÊó∂ËØÜÂà´ÂØπË±°ÁöÑÁúüÂÆûÁ±ªÂûã</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Object</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    ObjectClass *<span class="hljs-class"><span class="hljs-keyword">class</span>;</span><br>    ObjectFree *<span class="hljs-built_in">free</span>;<br>    GHashTable *properties;<br>    <span class="hljs-type">uint32_t</span> ref;<br>    Object *parent;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>‰∏ãÈù¢ÊòØ‰∏Ä‰∏™üå∞Ôºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3Object</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    Object parent;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÂÆåÊàê Object ÁöÑÂÆö‰πâ‰πãÂêéÊàë‰ª¨ËøòÂ∫îÂΩìÂú®ÂâçÈù¢ÂÆö‰πâÁöÑ <code>a3_type_info</code> ‰∏≠Ê∑ªÂä†‰∏ä Object size ‰∏é Object ÁöÑÊûÑÈÄ†ÂáΩÊï∞Ôºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_object_init</span><span class="hljs-params">(Object *obj)</span><br>&#123;<br>    <span class="hljs-comment">// ËøôÈáåÁöÑ obj ÂèÇÊï∞‰æøÊòØÂä®ÊÄÅÂàõÂª∫ÁöÑÁ±ªÂûãÂÆû‰æã</span><br>    <span class="hljs-comment">// do something</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3_type_info = &#123;<br>    .name = <span class="hljs-string">&quot;a3_type&quot;</span>,<br>    .parent = TYPE_OBJECT,<br>    .instance_init = a3_object_init,<br>    .instance_size = <span class="hljs-keyword">sizeof</span>(A3Object),<br>    .class_size = <span class="hljs-keyword">sizeof</span>(A3Class),<br>    .class_init = a3_class_init,<br>    .interfaces = (InterfaceInfo[]) &#123;<br>        &#123; &#125;,<br>    &#125;,<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="IV„ÄÅÁ±ªÁöÑÂàõÂª∫‰∏éÈáäÊîæ"><a href="#IV„ÄÅÁ±ªÁöÑÂàõÂª∫‰∏éÈáäÊîæ" class="headerlink" title="IV„ÄÅÁ±ªÁöÑÂàõÂª∫‰∏éÈáäÊîæ"></a>IV„ÄÅÁ±ªÁöÑÂàõÂª∫‰∏éÈáäÊîæ</h3><p>Á±ª‰ºº‰∫éÂú® C++ ÂΩì‰∏≠‰ΩøÁî® <code>new</code> ‰∏é <code>delete</code> Êù•ÂàõÂª∫‰∏éÈáäÊîæ‰∏Ä‰∏™Á±ªÂÆû‰æãÔºåÂú® QOM ‰∏≠Êàë‰ª¨Â∫îÂΩì‰ΩøÁî® <code>object_new()</code> ‰∏é <code>object_delete()</code> Êù•ÂàõÂª∫‰∏éÈîÄÊØÅ‰∏Ä‰∏™ QOM Á±ªÂÆû‰æãÔºåÊú¨Ë¥®‰∏äÂ∞±ÊòØ <code>ÂàÜÈÖç/ÈáäÊîæÁ±ªÁ©∫Èó¥ + ÊòæÁ§∫Ë∞ÉÁî®ÊûÑÈÄ†/ÊûêÊûÑÂáΩÊï∞</code></p>
<p>QOM Âà§Êñ≠ÂàõÂª∫Á±ªÂÆû‰æãÁöÑÁ±ªÂûãÊòØÈÄöËøáÁ±ªÁöÑÂêçÂ≠óÔºåÂç≥ <code>TypeInfo-&gt;name</code>ÔºåÂΩìÂàõÂª∫Á±ªÂÆû‰æãÊó∂ Qemu ‰ºöÈÅçÂéÜÊâÄÊúâÁöÑ TypeInfo Âπ∂ÂØªÊâæÂêçÂ≠óÂåπÈÖçÁöÑÈÇ£‰∏™Ôºå‰ªéËÄåË∞ÉÁî®Âà∞ÂØπÂ∫îÁöÑÊûÑÈÄ†ÂáΩÊï∞ÔºåÂπ∂Â∞ÜÂÖ∂Âü∫Á±ª <code>Object-&gt;class</code> ÊåáÂêëÂØπÂ∫îÁöÑ class</p>
<p>‰∏ãÈù¢ÊòØ‰∏Ä‰∏™üå∞Ôºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// create a QOM object</span><br>A3Object *a3obj = object_new(<span class="hljs-string">&quot;a3_type&quot;</span>);<br><span class="hljs-comment">// delete a QOM object</span><br>object_delete(a3obj);<br></code></pre></td></tr></table></figure>

<h2 id="‰∫å„ÄÅMemoryRegion-Qemu-‰∏≠ÁöÑ‰∏ÄÂùóÂÜÖÂ≠òÂå∫Âüü"><a href="#‰∫å„ÄÅMemoryRegion-Qemu-‰∏≠ÁöÑ‰∏ÄÂùóÂÜÖÂ≠òÂå∫Âüü" class="headerlink" title="‰∫å„ÄÅMemoryRegion - Qemu ‰∏≠ÁöÑ‰∏ÄÂùóÂÜÖÂ≠òÂå∫Âüü"></a>‰∫å„ÄÅMemoryRegion - Qemu ‰∏≠ÁöÑ‰∏ÄÂùóÂÜÖÂ≠òÂå∫Âüü</h2><p>Âú® Qemu ÂΩì‰∏≠‰ΩøÁî® <code>MemoryRegion</code> ÁªìÊûÑ‰ΩìÁ±ªÂûãÊù•Ë°®Á§∫‰∏ÄÂùóÂÖ∑‰ΩìÁöÑ Guest Áâ©ÁêÜÂÜÖÂ≠òÂå∫ÂüüÔºåËØ•ÁªìÊûÑ‰ΩìÂÆö‰πâ‰∫é <code>include/exec/memory.h</code> ÂΩì‰∏≠Ôºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/** MemoryRegion:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Ë°®Á§∫‰∏ÄÂùóÂÜÖÂ≠òÂå∫ÂüüÁöÑ‰∏Ä‰∏™ÁªìÊûÑ‰Ωì.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">MemoryRegion</span> &#123;</span><br>    Object parent_obj;<br><br>    <span class="hljs-comment">/* private: */</span><br><br>    <span class="hljs-comment">/* The following fields should fit in a cache line */</span><br>    <span class="hljs-type">bool</span> romd_mode;<br>    <span class="hljs-type">bool</span> ram;<br>    <span class="hljs-type">bool</span> subpage;<br>    <span class="hljs-type">bool</span> readonly; <span class="hljs-comment">/* For RAM regions */</span><br>    <span class="hljs-type">bool</span> nonvolatile;<br>    <span class="hljs-type">bool</span> rom_device;<br>    <span class="hljs-type">bool</span> flush_coalesced_mmio;<br>    <span class="hljs-type">bool</span> global_locking;<br>    <span class="hljs-type">uint8_t</span> dirty_log_mask;<br>    <span class="hljs-type">bool</span> is_iommu;<br>    RAMBlock *ram_block;<br>    Object *owner;<br><br>    <span class="hljs-type">const</span> MemoryRegionOps *ops;<br>    <span class="hljs-type">void</span> *opaque;<br>    MemoryRegion *container;	<span class="hljs-comment">// ÊåáÂêëÁà∂ MemoryRegion</span><br>    Int128 size;	<span class="hljs-comment">// ÂÜÖÂ≠òÂå∫ÂüüÂ§ßÂ∞è</span><br>    hwaddr addr;	<span class="hljs-comment">// Âú®Áà∂ MR ‰∏≠ÁöÑÂÅèÁßªÈáè</span><br>    <span class="hljs-type">void</span> (*destructor)(MemoryRegion *mr);<br>    <span class="hljs-type">uint64_t</span> align;<br>    <span class="hljs-type">bool</span> terminates;<br>    <span class="hljs-type">bool</span> ram_device;<br>    <span class="hljs-type">bool</span> enabled;<br>    <span class="hljs-type">bool</span> warning_printed; <span class="hljs-comment">/* For reservations */</span><br>    <span class="hljs-type">uint8_t</span> vga_logging_count;<br>    MemoryRegion *alias;	<span class="hljs-comment">// ‰ªÖÂú® alias MR ‰∏≠ÔºåÊåáÂêëÂÆûÈôÖÁöÑ MR</span><br>    hwaddr alias_offset;<br>    <span class="hljs-type">int32_t</span> priority;<br>    QTAILQ_HEAD(, MemoryRegion) subregions;<br>    QTAILQ_ENTRY(MemoryRegion) subregions_link;<br>    QTAILQ_HEAD(, CoalescedMemoryRange) coalesced;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;<br>    <span class="hljs-type">unsigned</span> ioeventfd_nb;<br>    MemoryRegionIoeventfd *ioeventfds;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>Âú® Qemu ÂΩì‰∏≠Êúâ‰∏âÁßçÁ±ªÂûãÁöÑ MemoryRegionÔºö</p>
<ul>
<li>MemoryRegion Ê†πÔºöÈÄöËøá <code>memory_region_init()</code> ËøõË°åÂàùÂßãÂåñÔºåÂÖ∂Áî®‰ª•Ë°®Á§∫‰∏éÁÆ°ÁêÜÁî±Â§ö‰∏™ sub-MemoryRegion ÁªÑÊàêÁöÑ‰∏Ä‰∏™ÂÜÖÂ≠òÂå∫ÂüüÔºåÂπ∂‰∏çÂÆûÈôÖÊåáÂêë‰∏ÄÂùóÂÜÖÂ≠òÂå∫ÂüüÔºå‰æãÂ¶Ç <code>system_memory</code></li>
<li>MemoryRegion ÂÆû‰ΩìÔºöÈÄöËøá <code>memory_region_init_ram()</code> ÂàùÂßãÂåñÔºåË°®Á§∫ÂÖ∑‰ΩìÁöÑ‰∏ÄÂùóÂ§ßÂ∞è‰∏∫ size ÁöÑÂÜÖÂ≠òÁ©∫Èó¥ÔºåÊåáÂêë‰∏ÄÂùóÂÖ∑‰ΩìÁöÑÂÜÖÂ≠ò</li>
<li>MemoryRegion Âà´ÂêçÔºöÈÄöËøá <code>memory_region_init_alias()</code> ÂàùÂßãÂåñÔºå‰Ωú‰∏∫Âè¶‰∏Ä‰∏™ MemoryRegion ÂÆû‰ΩìÁöÑÂà´ÂêçËÄåÂ≠òÂú®Ôºå‰∏çÊåáÂêë‰∏ÄÂùóÂÆûÈôÖÂÜÖÂ≠ò</li>
</ul>
<p>MR ÂÆπÂô®‰∏é MR ÂÆû‰ΩìÈó¥ÊûÑÊàêÊ†ëÂΩ¢ÁªìÊûÑÔºåÂÖ∂‰∏≠ÂÆπÂô®‰∏∫Ê†πËäÇÁÇπËÄåÂÆû‰Ωì‰∏∫Â≠êËäÇÁÇπÔºö</p>
<blockquote>
<p>‰∏ãÂõæÊù•Ëá™‰∫é<a target="_blank" rel="noopener" href="https://richardweiyang-2.gitbook.io/understanding_qemu/00-as/02-memoryregion">ËøôÈáå</a></p>
</blockquote>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">                       struct MemoryRegion<br>                       +------------------------+                                         <br>                       |<span class="hljs-string">name                    </span>|<span class="hljs-string">                                         </span><br><span class="hljs-string">                       </span>|<span class="hljs-string">  (const char *)        </span>|<span class="hljs-string">                                         </span><br><span class="hljs-string">                       +------------------------+                                         </span><br><span class="hljs-string">                       </span>|<span class="hljs-string">addr                    </span>|<span class="hljs-string">                                         </span><br><span class="hljs-string">                       </span>|<span class="hljs-string">  (hwaddr)              </span>|<span class="hljs-string">                                         </span><br><span class="hljs-string">                       </span>|<span class="hljs-string">size                    </span>|<span class="hljs-string">                                         </span><br><span class="hljs-string">                       </span>|<span class="hljs-string">  (Int128)              </span>|<span class="hljs-string">                                         </span><br><span class="hljs-string">                       +------------------------+                                         </span><br><span class="hljs-string">                       </span>|<span class="hljs-string">subregions              </span>|<span class="hljs-string">                                         </span><br><span class="hljs-string">                       </span>|<span class="hljs-string">    QTAILQ_HEAD()       </span>|<span class="hljs-string">                                         </span><br><span class="hljs-string">                       +------------------------+                                         </span><br><span class="hljs-string">                                  </span>|<br>                                  |<span class="hljs-string"></span><br><span class="hljs-string">          ----+-------------------+---------------------+----</span><br><span class="hljs-string">              </span>|<span class="hljs-string">                                         </span>|<br>              |<span class="hljs-string">                                         </span>|<br>              |<span class="hljs-string">                                         </span>|<br><br>struct MemoryRegion                            struct MemoryRegion<br>+------------------------+                     +------------------------+<br>|<span class="hljs-string">name                    </span>|<span class="hljs-string">                     </span>|<span class="hljs-string">name                    </span>|<br>|<span class="hljs-string">  (const char *)        </span>|<span class="hljs-string">                     </span>|<span class="hljs-string">  (const char *)        </span>|<br>+------------------------+                     +------------------------+<br>|<span class="hljs-string">addr                    </span>|<span class="hljs-string">                     </span>|<span class="hljs-string">addr                    </span>|<br>|<span class="hljs-string">  (hwaddr)              </span>|<span class="hljs-string">                     </span>|<span class="hljs-string">  (hwaddr)              </span>|<br>|<span class="hljs-string">size                    </span>|<span class="hljs-string">                     </span>|<span class="hljs-string">size                    </span>|<br>|<span class="hljs-string">  (Int128)              </span>|<span class="hljs-string">                     </span>|<span class="hljs-string">  (Int128)              </span>|<br>+------------------------+                     +------------------------+<br>|<span class="hljs-string">subregions              </span>|<span class="hljs-string">                     </span>|<span class="hljs-string">subregions              </span>|<br>|<span class="hljs-string">    QTAILQ_HEAD()       </span>|<span class="hljs-string">                     </span>|<span class="hljs-string">    QTAILQ_HEAD()       </span>|<br>+------------------------+                     +------------------------+<br></code></pre></td></tr></table></figure>

<p>Áõ∏Â∫îÂú∞ÔºåÂü∫‰∫é OOP ÁöÑÊÄùÊÉ≥ÔºåMemoryRegion ÁöÑÊàêÂëòÂáΩÊï∞Ë¢´Â∞ÅË£ÖÂú®ÂáΩÊï∞Ë°® <code>MemoryRegionOps</code> ÂΩì‰∏≠Ôºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Memory region callbacks</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">MemoryRegionOps</span> &#123;</span><br>    <span class="hljs-comment">/* ‰ªéÂÜÖÂ≠òÂå∫Âüü‰∏äËØª. @addr ‰∏é @mr ÊúâÂÖ≥; @size Âçï‰Ωç‰∏∫Â≠óËäÇ. */</span><br>    <span class="hljs-type">uint64_t</span> (*read)(<span class="hljs-type">void</span> *opaque,<br>                     hwaddr addr,<br>                     <span class="hljs-type">unsigned</span> size);<br>    <span class="hljs-comment">/* ÂæÄÂÜÖÂ≠òÂå∫Âüü‰∏äÂÜô. @addr ‰∏é @mr ÊúâÂÖ≥; @size Âçï‰Ωç‰∏∫Â≠óËäÇ. */</span><br>    <span class="hljs-type">void</span> (*write)(<span class="hljs-type">void</span> *opaque,<br>                  hwaddr addr,<br>                  <span class="hljs-type">uint64_t</span> data,<br>                  <span class="hljs-type">unsigned</span> size);<br><br>    MemTxResult (*read_with_attrs)(<span class="hljs-type">void</span> *opaque,<br>                                   hwaddr addr,<br>                                   <span class="hljs-type">uint64_t</span> *data,<br>                                   <span class="hljs-type">unsigned</span> size,<br>                                   MemTxAttrs attrs);<br>    MemTxResult (*write_with_attrs)(<span class="hljs-type">void</span> *opaque,<br>                                    hwaddr addr,<br>                                    <span class="hljs-type">uint64_t</span> data,<br>                                    <span class="hljs-type">unsigned</span> size,<br>                                    MemTxAttrs attrs);<br><br>    <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">device_endian</span> <span class="hljs-title">endianness</span>;</span><br>    <span class="hljs-comment">/* GuestÂèØËßÅÁ∫¶Êùü: */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>        <span class="hljs-comment">/* Ëã•Èùû 0ÔºåÂàôÊåáÂÆö‰∫ÜË∂ÖÂá∫Êú∫Âô®Ê£ÄÊü•ËåÉÂõ¥ÁöÑËÆøÈóÆÂ§ßÂ∞èÁïåÈôê</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">unsigned</span> min_access_size;<br>        <span class="hljs-type">unsigned</span> max_access_size;<br>        <span class="hljs-comment">/* If true, unaligned accesses are supported.  Otherwise unaligned</span><br><span class="hljs-comment">         * accesses throw machine checks.</span><br><span class="hljs-comment">         */</span><br>         <span class="hljs-type">bool</span> unaligned;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * Ëã•Â≠òÂú®‰∏î #false, ÂàôËØ•‰∫ãÂä°‰∏ç‰ºöË¢´ËÆæÂ§áÊâÄÊé•Âèó</span><br><span class="hljs-comment">         * (Âπ∂ÂØºËá¥Êú∫Âô®ÁöÑÁõ∏ÂÖ≥Ë°å‰∏∫Ôºå‰æãÂ¶ÇÊú∫Âô®Ê£ÄÊü•ÂºÇÂ∏∏).</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">bool</span> (*accepts)(<span class="hljs-type">void</span> *opaque, hwaddr addr,<br>                        <span class="hljs-type">unsigned</span> size, <span class="hljs-type">bool</span> is_write,<br>                        MemTxAttrs attrs);<br>    &#125; valid;<br>    <span class="hljs-comment">/* ÂÜÖÈÉ®Â∫îÁî®Á∫¶Êùü: */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>        <span class="hljs-comment">/* Ëã•Èùû 0ÔºåÂàôÂÜ≥ÂÆö‰∫ÜÊúÄÂ∞èÁöÑÂÆûÁé∞ÁöÑ size .</span><br><span class="hljs-comment">         * Êõ¥Â∞èÁöÑ size Â∞ÜË¢´Âêë‰∏äÂõûÁªïÔºå‰∏îÂ∞ÜËøîÂõûÈÉ®ÂàÜÁªìÊûú.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">unsigned</span> min_access_size;<br>        <span class="hljs-comment">/* Ëã•Èùû 0ÔºåÂàôÂÜ≥ÂÆö‰∫ÜÊúÄÂ§ßÁöÑÂÆûÁé∞ÁöÑ size . </span><br><span class="hljs-comment">         * Êõ¥Â§ßÁöÑ size Â∞ÜË¢´‰Ωú‰∏∫‰∏ÄÁ≥ªÂàóÁöÑÊõ¥Â∞èÁöÑ size ÁöÑËÆøÈóÆËÄåÂÆåÊàê.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">unsigned</span> max_access_size;<br>        <span class="hljs-comment">/* Ëã•‰∏∫ true, ÊîØÊåÅÈùûÂØπÈΩêÁöÑËÆøÈóÆ.  </span><br><span class="hljs-comment">         * Âê¶ÂàôÊâÄÊúâÁöÑËÆøÈóÆÈÉΩÂ∞ÜË¢´ËΩ¨Êç¢‰∏∫ÔºàÂèØËÉΩÂ§öÁßçÔºâÂØπÈΩêÁöÑËÆøÈóÆ.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">bool</span> unaligned;<br>    &#125; impl;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>ÂΩìÊàë‰ª¨ÁöÑ Guest Ë¶ÅËØªÂÜôËôöÊãüÊú∫‰∏äÁöÑÂÜÖÂ≠òÊó∂ÔºåÂú® Qemu ÂÜÖÈÉ®ÂÆûÈôÖ‰∏ä‰ºöË∞ÉÁî® <code>address_space_rw()</code>ÔºåÂØπ‰∫é‰∏ÄËà¨ÁöÑ RAM ÂÜÖÂ≠òËÄåË®ÄÂàôÁõ¥Êé•ÂØπ MR ÂØπÂ∫îÁöÑÂÜÖÂ≠òËøõË°åÊìç‰ΩúÔºåÂØπ‰∫é MMIO ËÄåË®ÄÂàôÊúÄÁªàË∞ÉÁî®Âà∞ÂØπÂ∫îÁöÑ <code>MR-&gt;ops-&gt;read()</code> Êàñ <code>MR-&gt;ops-&gt;write()</code></p>
<p>ÂÖ≥‰∫é Qemu ÂÜÖÂ≠òÁÆ°ÁêÜÊõ¥Â§öÁöÑÂÜÖÂÆπÂ∞±ÊöÇ‰∏î‰∏çÂú®Ê≠§Â±ïÂºÄ‰∫ÜÔºå‰∏çËøáÁé∞Âú®Êàë‰ª¨Áü•ÈÅìÁöÑÊòØÂú® Qemu ‰∏≠‰ΩøÁî® <code>MemoryRegion</code> ÁªìÊûÑ‰ΩìÊù•Ë°®Á§∫‰∏ÄÊÆµÂÜÖÂ≠òÂå∫ÂüüÔºå<strong>ÈÇ£‰πàÊàë‰ª¨ÂêåÊ†∑ÂèØ‰ª•ÈÄöËøáÂú®ËÆæÂ§á‰∏≠Ê∑ªÂä† MemoryRegion ÁöÑÊñπÂºèÊù•‰∏∫ËÆæÂ§áÊ∑ªÂä†ÂÜÖÂ≠òÔºå‰ªéËÄåÂÆûÁé∞‰∏éËÆæÂ§áÈó¥ÁöÑ MMIO ÈÄö‰ø°</strong></p>
<p>ÂêåÊ†∑ÁöÑÔºå‰∏∫‰∫ÜÁªü‰∏ÄÊé•Âè£ÔºåÂú® Qemu ÂΩì‰∏≠ <strong>PMIO ÁöÑÂÆûÁé∞ÂêåÊ†∑ÊòØÈÄöËøá MemoryRegion Êù•ÂÆåÊàêÁöÑ</strong></p>
<h2 id="‰∏â„ÄÅQemu-‰∏≠-PCI-ËÆæÂ§áÁöÑÁºñÂÜô"><a href="#‰∏â„ÄÅQemu-‰∏≠-PCI-ËÆæÂ§áÁöÑÁºñÂÜô" class="headerlink" title="‰∏â„ÄÅQemu ‰∏≠ PCI ËÆæÂ§áÁöÑÁºñÂÜô"></a>‰∏â„ÄÅQemu ‰∏≠ PCI ËÆæÂ§áÁöÑÁºñÂÜô</h2><p>Âú®Ë°•ÂÖÖ‰∫ÜËøô‰πàÂ§öÁöÑ Qemu Áõ∏ÂÖ≥ÁöÑÁü•ËØÜ‰πãÂêéÔºåÁé∞Âú®Êàë‰ª¨ÂèØ‰ª•ÂºÄÂßãÂú® Qemu ‰∏≠ÁºñÂÜô PCI ËÆæÂ§á‰∫ÜÔºåËøôÈáåÁ¨îËÄÖÂ∞ÜÁºñÂÜô‰∏Ä‰∏™ÊúÄÁÆÄÂçïÁöÑ Qemu ËÆæÂ§áÔºåÂπ∂Â∞ÜÊ∫êÁ†ÅÊîæÂú® <code>hw/misc/a3dev.c</code> ‰∏≠</p>
<p>Qemu ÂΩì‰∏≠ PCI ËÆæÂ§áÂÆû‰æãÁöÑÂü∫Á±ªÊòØ <code>PCIDevice</code>ÔºåÂõ†Ê≠§Êàë‰ª¨Â∫îÂΩìÂàõÂª∫‰∏Ä‰∏™ÁªßÊâøËá™ <code>PCIDevice</code> ÁöÑÁ±ªÊù•Ë°®Á§∫Êàë‰ª¨ÁöÑËÆæÂ§áÂÆû‰æãÔºåËøôÈáåÁ¨îËÄÖ‰ªÖÂ£∞Êòé‰∫Ü‰∏§‰∏™ <code>MemoryRegion</code> Áî®‰Ωú MMIO ‰∏é PMIOÔºå‰ª•Âèä‰∏Ä‰∏™Áî®‰ΩúÊï∞ÊçÆÂ≠òÂÇ®ÁöÑ bufferÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3DEV_BUF_SIZE 0x100</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCIDevState</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    PCIDevice parent_obj;<br><br>    <span class="hljs-comment">/*&lt; public &gt;*/</span><br>    MemoryRegion mmio;<br>    MemoryRegion pmio;<br>    <span class="hljs-type">uint8_t</span> buf[A3DEV_BUF_SIZE];<br>&#125; A3PCIDevState;<br></code></pre></td></tr></table></figure>

<p>‰ª•ÂèäÂÆö‰πâ‰∏Ä‰∏™Á©∫ÁöÑ Class Ê®°ÊùøÔºåÁªßÊâøËá™ PCI ËÆæÂ§áÁöÑÈùôÊÄÅÁ±ªÂûã <code>PCIDeviceClass</code>Ôºå‰∏çËøáËøô‰∏ÄÊ≠•Âπ∂‰∏çÊòØÂøÖÈ°ªÁöÑÔºå‰∫ãÂÆû‰∏äÊàë‰ª¨ÂèØ‰ª•Áõ¥Êé•Áî® <code>PCIDeviceClass</code> ‰Ωú‰∏∫Êàë‰ª¨ËÆæÂ§áÁ±ªÁöÑ ClassÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCIDevClass</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    PCIDeviceClass parent;<br>&#125; A3PCIDevClass;<br></code></pre></td></tr></table></figure>

<p>‰ª•Âèä‰∏§‰∏™Â∞ÜÁà∂Á±ªËΩ¨‰∏∫Â≠êÁ±ªÁöÑÂÆèÔºåÂõ†‰∏∫ QOM Âü∫Êú¨ÂáΩÊï∞‰º†ÈÄíÁöÑÂ§ßÈÉΩÊòØÁà∂Á±ªÊåáÈíàÔºåÊâÄ‰ª•Êàë‰ª¨ÈúÄË¶Å‰∏Ä‰∏™ÂÆèÊù•ËøõË°åÁ±ªÂûãÊ£ÄÊü• + ËΩ¨ÂûãÔºåËøô‰πüÊòØ Qemu ‰∏≠ÊÉØÁî®ÁöÑÂÅöÊ≥ïÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> TYPE_A3DEV_PCI <span class="hljs-string">&quot;a3dev-pci&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3DEV_PCI(obj) \</span><br><span class="hljs-meta">    OBJECT_CHECK(A3PCIDevState, (obj), TYPE_A3DEV_PCI)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3DEV_PCI_GET_CLASS(obj) \</span><br><span class="hljs-meta">    OBJECT_GET_CLASS(A3PCIDevClass, obj, TYPE_A3DEV_PCI)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3DEV_PCI_CLASS(klass) \</span><br><span class="hljs-meta">    OBJECT_CLASS_CHECK(A3PCIDevClass, klass, TYPE_A3DEV_PCI)</span><br></code></pre></td></tr></table></figure>

<p>‰∏ãÈù¢Êàë‰ª¨ÂºÄÂßãÂÆö‰πâ MMIO ‰∏é PMIO ÁöÑÊìç‰ΩúÂáΩÊï∞ÔºåËøôÈáåÁ¨îËÄÖÂ∞±ÁÆÄÂçïÂú∞ËÆæÁΩÆ‰∏∫ËØªÂÜôËÆæÂ§áÂÜÖÈÉ®ÁöÑ bufferÔºåÂπ∂Â£∞Êòé‰∏ä‰∏§‰∏™ MemoryRegion ÂØπÂ∫îÁöÑÂáΩÊï∞Ë°®ÔºåÈúÄË¶ÅÊ≥®ÊÑèÁöÑÊòØËøôÈáå‰º†ÂÖ•ÁöÑ <code>hwaddr</code> Á±ªÂûãÂèÇÊï∞ÂÖ∂ÂÆû‰∏∫Áõ∏ÂØπÂú∞ÂùÄËÄåÈùûÁªùÂØπÂú∞ÂùÄÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">uint64_t</span><br><span class="hljs-title function_">a3dev_read</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    A3PCIDevState *ds = A3DEV_PCI(opaque);<br>    <span class="hljs-type">uint64_t</span> val = ~<span class="hljs-number">0LL</span>;<br><br>    <span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">8</span>)<br>        <span class="hljs-keyword">return</span> val;<br><br>    <span class="hljs-keyword">if</span> (addr + size &gt; A3DEV_BUF_SIZE)<br>        <span class="hljs-keyword">return</span> val;<br>    <br>    <span class="hljs-built_in">memcpy</span>(&amp;val, &amp;ds-&gt;buf[addr], size);<br>    <span class="hljs-keyword">return</span> val;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">a3dev_write</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">uint64_t</span> val, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    A3PCIDevState *ds = A3DEV_PCI(opaque);<br><br>    <span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">8</span>)<br>        <span class="hljs-keyword">return</span> ;<br><br>    <span class="hljs-keyword">if</span> (addr + size &gt; A3DEV_BUF_SIZE)<br>        <span class="hljs-keyword">return</span> ;<br>    <br>    <span class="hljs-built_in">memcpy</span>(&amp;ds-&gt;buf[addr], &amp;val, size);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">uint64_t</span><br><span class="hljs-title function_">a3dev_mmio_read</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> a3dev_read(opaque, addr, size);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">uint64_t</span><br><span class="hljs-title function_">a3dev_pmio_read</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> a3dev_read(opaque, addr, size);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">a3dev_mmio_write</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">uint64_t</span> val, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    a3dev_write(opaque, addr, val, size);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">a3dev_pmio_write</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">uint64_t</span> val, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    a3dev_write(opaque, addr, val, size);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> MemoryRegionOps a3dev_mmio_ops = &#123;<br>    .read = a3dev_mmio_read,<br>    .write = a3dev_mmio_write,<br>    .endianness = DEVICE_LITTLE_ENDIAN,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> MemoryRegionOps a3dev_pmio_ops = &#123;<br>    .read = a3dev_pmio_read,<br>    .write = a3dev_pmio_write,<br>    .endianness = DEVICE_LITTLE_ENDIAN,<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>ÁÑ∂ÂêéÊòØËÆæÂ§áÂÆû‰æãÁöÑÂàùÂßãÂåñÂáΩÊï∞ÔºåÂú® <code>PCIDeviceClass</code> ÂΩì‰∏≠ÂÆö‰πâ‰∫Ü‰∏Ä‰∏™Âêç‰∏∫ <code>realize</code> ÁöÑÂáΩÊï∞ÊåáÈíàÔºåÂΩì PCI ËÆæÂ§áË¢´ËΩΩÂÖ•Êó∂‰æø‰ºöË∞ÉÁî®Ëøô‰∏™ÂáΩÊï∞ÊåáÈíàÊåáÂêëÁöÑÂáΩÊï∞Êù•ÂàùÂßãÂåñÔºåÊâÄ‰ª•ËøôÈáåÊàë‰ª¨‰πüÂÆö‰πâ‰∏Ä‰∏™Ëá™Â∑±ÁöÑÂàùÂßãÂåñÂáΩÊï∞Ôºå‰∏çËøáÊàë‰ª¨ÈúÄË¶ÅÂÅöÁöÑÂ∑•‰ΩúÂÖ∂ÂÆûÂü∫Êú¨‰∏äÂ∞±Âè™ÊúâÂàùÂßãÂåñ‰∏§‰∏™ <code>MemoryRegion</code>Ôºå<code>memory_region_init_io()</code> ‰ºö‰∏∫Ëøô‰∏§‰∏™ <code>MemoryRegion</code> ËøõË°åÂàùÂßãÂåñÁöÑÂ∑•‰ΩúÔºåÂπ∂ËÆæÁΩÆÂáΩÊï∞Ë°®‰∏∫Êàë‰ª¨ÊåáÂÆöÁöÑÂáΩÊï∞Ë°®Ôºå<code>pci_register_bar()</code> ÂàôÁî®Êù•Ê≥®ÂÜå BARÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3dev_realize</span><span class="hljs-params">(PCIDevice *pci_dev, Error **errp)</span><br>&#123;<br>    A3PCIDevState *ds = A3DEV_PCI(pci_dev);<br><br>    memory_region_init_io(&amp;ds-&gt;mmio, OBJECT(ds), &amp;a3dev_mmio_ops,<br>                        pci_dev, <span class="hljs-string">&quot;a3dev-mmio&quot;</span>, A3DEV_BUF_SIZE);<br>    pci_register_bar(pci_dev, <span class="hljs-number">0</span>, PCI_BASE_ADDRESS_SPACE_MEMORY, &amp;ds-&gt;mmio);<br>    memory_region_init_io(&amp;ds-&gt;pmio, OBJECT(ds), &amp;a3dev_pmio_ops,<br>                        pci_dev, <span class="hljs-string">&quot;a3dev-pmio&quot;</span>, A3DEV_BUF_SIZE);<br>    pci_register_bar(pci_dev, <span class="hljs-number">1</span>, PCI_BASE_ADDRESS_SPACE_IO, &amp;ds-&gt;pmio);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÊúÄÂêéÊòØ Class ‰∏é ObjectÔºà‰πüÂ∞±ÊòØ instanceÔºâÁöÑÂàùÂßãÂåñÂáΩÊï∞ÔºåËøôÈáåÈúÄË¶ÅÊ≥®ÊÑèÁöÑÊòØÂú® Class ÁöÑÂàùÂßãÂåñÂáΩÊï∞‰∏≠Êàë‰ª¨Â∫îÂΩìËÆæÁΩÆÁà∂Á±ª <code>PCIDeviceClass</code> ÁöÑ‰∏ÄÁ≥ªÂàóÂü∫Êú¨Â±ûÊÄßÔºà‰πüÂ∞±ÊòØ PCI ËÆæÂ§áÁöÑÂü∫Êú¨Â±ûÊÄßÔºâÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3dev_instance_init</span><span class="hljs-params">(Object *obj)</span><br>&#123;<br>    <span class="hljs-comment">// do something</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3dev_class_init</span><span class="hljs-params">(ObjectClass *oc, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>    DeviceClass *dc = DEVICE_CLASS(oc);<br>    PCIDeviceClass *pci = PCI_DEVICE_CLASS(oc);<br><br>    pci-&gt;realize = a3dev_realize;<br>    pci-&gt;vendor_id = PCI_VENDOR_ID_QEMU;<br>    pci-&gt;device_id = <span class="hljs-number">0x1919</span>;<br>    pci-&gt;revision = <span class="hljs-number">0x81</span>;<br>    pci-&gt;class_id = PCI_CLASS_OTHERS;<br><br>    dc-&gt;desc = <span class="hljs-string">&quot;arttnba3 test PCI device&quot;</span>;<br>    set_bit(DEVICE_CATEGORY_MISC, dc-&gt;categories);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÊúÄÂêéÂ∞±ÊòØ‰∏∫Êàë‰ª¨ÁöÑ PCI ËÆæÂ§áÁ±ªÂûãÊ≥®ÂÜå TypeInfo ‰∫ÜÔºåËøôÈáåÂà´Âøò‰∫Ü<strong>Êàë‰ª¨ÁöÑÊé•Âè£‰∏≠Â∫îÂΩìÂ¢ûÂä†‰∏ä PCI ÁöÑÊé•Âè£</strong>Ôºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3dev_type_info = &#123;<br>    .name = TYPE_A3DEV_PCI,<br>    .parent = TYPE_PCI_DEVICE,<br>    .instance_init = a3dev_instance_init,<br>    .instance_size = <span class="hljs-keyword">sizeof</span>(A3PCIDevState),<br>    .class_size = <span class="hljs-keyword">sizeof</span>(A3PCIDevClass),<br>    .class_init = a3dev_class_init,<br>    .interfaces = (InterfaceInfo[]) &#123;<br>        &#123; INTERFACE_CONVENTIONAL_PCI_DEVICE &#125;,<br>        &#123; &#125;,<br>    &#125;,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3dev_register_types</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>    type_register_static(&amp;a3dev_type_info);<br>&#125;<br><br>type_init(a3dev_register_types);<br></code></pre></td></tr></table></figure>

<p>ÊúÄÂêéÊàë‰ª¨Âú® meson ÊûÑÂª∫Á≥ªÁªü‰∏≠Âä†ÂÖ•Êàë‰ª¨Êñ∞Â¢ûÁöÑËøô‰∏™ËÆæÂ§áÔºåÂú® <code>hw/misc/meson.build</code> ‰∏≠Âä†ÂÖ•Â¶Ç‰∏ãËØ≠Âè•Ôºö</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs meson">softmmu_ss.add(when: &#x27;CONFIG_PCI_A3DEV&#x27;, if_true: files(&#x27;a3dev.c&#x27;))<br></code></pre></td></tr></table></figure>

<p>Âπ∂Âú® <code>hw/misc/Kconfig</code> ‰∏≠Ê∑ªÂä†Â¶Ç‰∏ãÂÜÖÂÆπÔºåËøôË°®Á§∫Êàë‰ª¨ÁöÑËÆæÂ§á‰ºöÂú® <code>CONFIG_PCI_DEVICES=y</code> Êó∂ÁºñËØëÔºö</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kconfig">config PCI_A3DEV<br>    bool<br>    default y if PCI_DEVICES<br>    depends on PCI<br></code></pre></td></tr></table></figure>

<p>‰πãÂêéÁºñËØë Qemu Âπ∂ÈôÑÂä†‰∏ä <code>-device a3dev-pci</code> Ôºå‰πãÂêéÈöè‰æøËµ∑‰∏Ä‰∏™ Linux Á≥ªÁªüÔºåÊ≠§Êó∂‰ΩøÁî® <code>lspci</code> Êåá‰ª§Êàë‰ª¨‰æøËÉΩÁúãÂà∞Êàë‰ª¨Êñ∞Ê∑ªÂä†ÁöÑ pci ËÆæÂ§áÔºö</p>
<p><img src="https://s2.loli.net/2022/07/28/Eu82rKgSlJBtbic.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>Êàë‰ª¨‰ΩøÁî®Â¶Ç‰∏ãÁ®ãÂ∫èÊù•ÊµãËØïÊàë‰ª¨ÁöÑËÆæÂ§áÁöÑËæìÂÖ•ËæìÂá∫ÔºåÈúÄË¶ÅÊ≥®ÊÑèÁöÑÊòØËøôÈúÄË¶Å root ÊùÉÈôêÔºö</p>
<blockquote>
<p>PMIOÔºå‰ΩøÁî® iopl Êõ¥ÊîπÁ´ØÂè£ÊùÉÈôêÂêé‰æøËÉΩÈÄöËøá in&#x2F;out Á±ªÊåá‰ª§ËØªÂÜôÁ´ØÂè£</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/io.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> port_addr;<br><br>        <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">2</span>) &#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] no port provided!&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (iopl(<span class="hljs-number">3</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] no privilege!&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br><br>        port_addr = atoi(argv[<span class="hljs-number">1</span>]);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] a3dev port addr start at: %d\n&quot;</span>, port_addr);<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] now writing into a3dev-pci...&quot;</span>);<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100</span> / <span class="hljs-number">4</span>; i++) &#123;<br>                outl(i, port_addr + i * <span class="hljs-number">4</span>);<br>        &#125;<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] writing done!&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] now reading from a3dev-pci...&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100</span> / <span class="hljs-number">4</span>; i++) &#123;<br>                <span class="hljs-keyword">if</span> (i % <span class="hljs-number">8</span> == <span class="hljs-number">0</span>) &#123;<br>                        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n[--%d--]&quot;</span>, port_addr + i * <span class="hljs-number">4</span>);<br>                &#125;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; %d &quot;</span>, inl(port_addr + i * <span class="hljs-number">4</span>));<br>        &#125;<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n[+] reading done!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>PMIO ÊµãËØïÊàêÂäüÔºåËÆæÂ§áËØªÂÜôÂäüËÉΩÊ≠£Â∏∏Ôºö</p>
<p><img src="https://s2.loli.net/2022/07/28/k4G1cOvNHwUtsjQ.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>MMIOÔºå‰ΩøÁî® mmap Êò†Â∞Ñ <code>sys</code> ÁõÆÂΩï‰∏ãËÆæÂ§áÁöÑ <code>resource0</code> Êñá‰ª∂Âç≥ÂèØÁõ¥Êé•ËØªÂÜô</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">mmio_write</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> *addr, <span class="hljs-type">uint32_t</span> val)</span><br>&#123;<br>        *addr = val;<br>&#125;<br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">mmio_read</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> *addr)</span><br>&#123;<br>        <span class="hljs-keyword">return</span> *addr;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>        <span class="hljs-type">uint32_t</span> *mmio_addr;<br>        <span class="hljs-type">int</span> dev_fd;<br><br>        dev_fd = open(<span class="hljs-string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>,<br>                        O_RDWR | O_SYNC);<br>        <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] failed to open mmio file! wrong path or no root!&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br><br>        mmio_addr = (<span class="hljs-type">uint32_t</span>*)<br>                mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, dev_fd, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (mmio_addr == MAP_FAILED) &#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;failed to mmap!&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] start writing to a3dev-pci...&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100</span> / <span class="hljs-number">4</span>; i++) &#123;<br>                mmio_write(mmio_addr + i, i);<br>        &#125;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] write done!&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] start reading from a3dev-pci...&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100</span> / <span class="hljs-number">4</span>; i++) &#123;<br>                <span class="hljs-keyword">if</span> (i % <span class="hljs-number">8</span> == <span class="hljs-number">0</span>) &#123;<br>                        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n[--%p--]&quot;</span>, mmio_addr);<br>                &#125;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; %u &quot;</span>, mmio_read(mmio_addr + i));<br>        &#125;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n[+] read done!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>MMIO ÊµãËØïÊàêÂäüÔºåËÆæÂ§áËØªÂÜôÂäüËÉΩÊ≠£Â∏∏Ôºö</p>
<p><img src="https://s2.loli.net/2022/07/28/RCoHF7SWPIyD54j.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h1 id="0x05-Ëá™ÂÆö‰πâ-QEMU-Êú∫Âô®Á±ªÂûãÔºàüïäÔºâ"><a href="#0x05-Ëá™ÂÆö‰πâ-QEMU-Êú∫Âô®Á±ªÂûãÔºàüïäÔºâ" class="headerlink" title="0x05.Ëá™ÂÆö‰πâ QEMU Êú∫Âô®Á±ªÂûãÔºàüïäÔºâ"></a>0x05.Ëá™ÂÆö‰πâ QEMU Êú∫Âô®Á±ªÂûãÔºàüïäÔºâ</h1><p>‰ºóÊâÄÂë®Áü•Âú® Qemu ÂΩì‰∏≠ÊúâÂæàÂ§öÁßç‰∏çÂêåÁöÑÊú∫Âô®Á±ªÂûãÔºåÂÖ∂Ë°®Á§∫ÁùÄÂåÖÂê´‰∏Ä‰∫õÈªòËÆ§ËÆæÂ§áÔºàÂåÖÂê´PCIeÊòæÂç°„ÄÅ‰ª•Â§™ÁΩëÊéßÂà∂Âô®„ÄÅSATAÊéßÂà∂Âô®Á≠âÔºâÁöÑËôöÊãüËäØÁâáÁªÑÔºå‰æãÂ¶Ç <code>pc</code> ÂØπÂ∫î‰∫é Intel ÁöÑ <code>440FX</code> ËäØÁâáÁªÑÔºàËøô‰πüÊòØ Qemu ÈªòËÆ§ÈÄâÊã©ÁöÑÊú∫Âô®Á±ªÂûãÔºâ</p>
<p><img src="https://s2.loli.net/2022/07/14/d1uhrIAYl682WSj.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>Qemu ‰∏ªË¶ÅÊîØÊåÅ‰∏§ÁßçÂ§ßÁöÑ x86 ËäØÁâáÁªÑÔºöi440FX Âíå Q35ÔºåÂêéËÄÖÁõ∏ÊØîÂâçËÄÖËÄåË®ÄÁöÑ‰∏Ä‰∏™Â§ßÁöÑ‰∫ÆÁÇπ‰æøÊòØÂ¢ûÂä†‰∫ÜÂØπ PCIe ÁöÑÊîØÊåÅÔºö</p>
<p><img src="https://s2.loli.net/2022/07/14/2xgwV7GeSskzWc4.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>Êàë‰ª¨ÂèØ‰ª•‰ΩøÁî® <code>-machine</code> ÈÄâÈ°πÊù•ÊåáÂÆöÊàë‰ª¨Ë¶ÅÂàõÂª∫ÁöÑËôöÊãüÊú∫ÁöÑÊú∫Âô®Á±ªÂûãÔºåÈÄöËøá <code>-machine ?</code> ÈÄâÈ°πÂèØ‰ª•Êü•ÁúãÂΩìÂâçÊîØÊåÅÁöÑÊú∫Âô®Á±ªÂûãÔºö</p>
<p><img src="https://s2.loli.net/2022/07/14/v6G5DV4SK7hCbRZ.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>‰ΩÜËá™Â∏¶ÁöÑÊú∫Âô®Á±ªÂûãÈÄöÂ∏∏ÂæÄÂæÄÊó†Ê≥ïÊª°Ë∂≥Êàë‰ª¨Â§öÊ†∑ÂåñÁöÑË¶ÅÊ±ÇÔºåÂõ†Ê≠§ÊúâÁöÑÊó∂ÂÄôÊàë‰ª¨ÈúÄË¶ÅËá™Ë°åÁºñÂÜô‰∏ÄÁßçÊú∫Âô®Á±ªÂûãÊù•Êª°Ë∂≥Êàë‰ª¨ÁöÑÈúÄÊ±Ç</p>
<h2 id="‰∏Ä„ÄÅÊ∑ªÂä†Ê∫êÁ†ÅÊñá‰ª∂‰∏éÁºñËØëÈÄâÈ°π"><a href="#‰∏Ä„ÄÅÊ∑ªÂä†Ê∫êÁ†ÅÊñá‰ª∂‰∏éÁºñËØëÈÄâÈ°π" class="headerlink" title="‰∏Ä„ÄÅÊ∑ªÂä†Ê∫êÁ†ÅÊñá‰ª∂‰∏éÁºñËØëÈÄâÈ°π"></a>‰∏Ä„ÄÅÊ∑ªÂä†Ê∫êÁ†ÅÊñá‰ª∂‰∏éÁºñËØëÈÄâÈ°π</h2><p>Âú® Qemu Ê∫êÁ†ÅÁõÆÂΩï‰∏≠Ôºå‰∏éÂÖ∑‰ΩìÊîØÊåÅÁöÑÁ°¨‰ª∂Áõ∏ÂÖ≥ÁöÑ‰ª£Á†ÅÈÉΩÊîæÂú® <code>hw/</code> ÁõÆÂΩï‰∏ãÔºå‰æãÂ¶ÇÈªòËÆ§ÁöÑ <code>PC</code> Êû∂ÊûÑ‰æøÂÆö‰πâ‰∫é <code>hw/i386/pc.c</code>ÔºåÂõ†Ê≠§Ëã•ÊòØÊàë‰ª¨ÊÉ≥Ë¶ÅÂÆö‰πâ‰∏ÄÁßçÊñ∞ÁöÑÊú∫Âô®Á±ªÂûãÂàôÂú®ËØ•ÁõÆÂΩï‰∏ãËøõË°åÂÆö‰πâÊòØÊúÄÂ•ΩÁöÑ</p>
<p>ËÄÅÁâàÊú¨ÁöÑ Qemu ÊòØÁ∫ØÁ≤πÂü∫‰∫é Makefile ËøõË°åÊûÑÂª∫ÁöÑÔºåËÄåÁé∞Âú®ÁöÑÊñ∞ÁâàÊú¨ Qemu ‰∏≠ÂàôÊòØ‰ΩøÁî® meson ËøõË°åÈ°πÁõÆÊûÑÂª∫ÔºåÂõ†Ê≠§Á¨îËÄÖÊé•‰∏ãÊù•Â∞Ü‰ºöÂêåÊó∂‰ªãÁªç‰∏§ÁßçÈÖçÁΩÆÊñπÊ≥ï</p>
<h3 id="I„ÄÅÊñ∞ÁâàÊú¨-Qemu-ÈÖçÁΩÆÊñπÂºèÔºàmesonÔºâ"><a href="#I„ÄÅÊñ∞ÁâàÊú¨-Qemu-ÈÖçÁΩÆÊñπÂºèÔºàmesonÔºâ" class="headerlink" title="I„ÄÅÊñ∞ÁâàÊú¨ Qemu ÈÖçÁΩÆÊñπÂºèÔºàmesonÔºâ"></a>I„ÄÅÊñ∞ÁâàÊú¨ Qemu ÈÖçÁΩÆÊñπÂºèÔºàmesonÔºâ</h3><p>ËøôÈáåÊàë‰ª¨ÈÄâÊã©ÂÆö‰πâ‰∏ÄÁßçÊñ∞ÁöÑÊú∫Âô®Á±ªÂûãÂêç‰∏∫ <code>a3-pc</code>ÔºåÂπ∂Âú® <code>hw/i386/a3-pc</code> ‰∏ãÂàõÂª∫Â¶Ç‰∏ãÁõÆÂΩïÁªìÊûÑÔºö</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">tree hw/i386/a3-pc/</span><br>hw/i386/a3-pc/<br>‚îú‚îÄ‚îÄ accel.c<br>‚îú‚îÄ‚îÄ machine.c<br>‚îî‚îÄ‚îÄ meson.build<br><br>0 directories, 3 files<br></code></pre></td></tr></table></figure>

<p>‰∏â‰∏™Êñá‰ª∂ËØ¥ÊòéÂ¶Ç‰∏ãÔºö</p>
<ul>
<li><code>meson.build</code>Ôºömeson È°πÁõÆÊûÑÂª∫Êñá‰ª∂</li>
<li><code>machine.c</code>ÔºöÊú∫Âô®ÁöÑ‰∏ª‰Ωì‰ª£Á†Å</li>
<li><code>accel.c</code>ÔºöËá™ÂÆö‰πâÁöÑ accelerator ‰ª£Á†Å</li>
</ul>
<p>Âú® <code>meson.build</code> ‰∏≠ÂÜôÂÖ•Â¶Ç‰∏ãÂÜÖÂÆπÔºö</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs meson">a3pc_ss = ss.source_set()<br>a3pc_ss.add(files(&#x27;accel.c&#x27;))<br>a3pc_ss.add(files(&#x27;machine.c&#x27;))<br><br>i386_ss.add_all(when: &#x27;CONFIG_A3_PC&#x27;, if_true: a3pc_ss)<br></code></pre></td></tr></table></figure>

<p>‰πãÂêéÂú® <code>hw/i386/meson.build</code> ‰∏≠Ê∑ªÂä†ËØ•ËØ≠Âè•Ôºö</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs meson">subdir(&#x27;a3-pc&#x27;)<br></code></pre></td></tr></table></figure>

<p>ËøôÈáåÁ¨îËÄÖÈÄâÊã©ÂàõÂª∫‰∏Ä‰∏™ i386 Á±ªÂûãÁöÑÊú∫Âô®ÔºåÂõ†Ê≠§Êàë‰ª¨ËøòÈúÄË¶Å‰øÆÊîπ <code>hw/i386/Kconfig</code>ÔºåÊ∑ªÂä†Â¶Ç‰∏ãÂÜÖÂÆπÔºö</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs kconfig">config A3_PC<br>    bool<br></code></pre></td></tr></table></figure>

<p>Âú® <code>configs/devices/i386-softmmu/default.mak</code> Êú´Â∞æÊ∑ªÂä†Â¶Ç‰∏ãÂÜÖÂÆπÔºå‰ΩøÂæóÊàë‰ª¨ÁöÑÊñ∞ÁöÑÊú∫Âô®Á±ªÂûã‰ºöË¢´ÈªòËÆ§ÁºñËØëËøõÂéªÔºö</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs makefile">CONFIG_A3_PC=y<br></code></pre></td></tr></table></figure>

<h3 id="II„ÄÅËÄÅÁâàÊú¨-Qemu-ÈÖçÁΩÆÊñπÂºèÔºàmakefileÔºâ"><a href="#II„ÄÅËÄÅÁâàÊú¨-Qemu-ÈÖçÁΩÆÊñπÂºèÔºàmakefileÔºâ" class="headerlink" title="II„ÄÅËÄÅÁâàÊú¨ Qemu ÈÖçÁΩÆÊñπÂºèÔºàmakefileÔºâ"></a>II„ÄÅËÄÅÁâàÊú¨ Qemu ÈÖçÁΩÆÊñπÂºèÔºàmakefileÔºâ</h3><p>Â¶ÇÊûúÊòØÁâàÊú¨Á®çÂæÆËÄÅ‰∏ÄÁÇπÁöÑ Qemu ÂàôÂ∫îÂΩìÂú® <code>hw/a3-pc</code> ‰∏ãÂàõÂª∫Â¶Ç‰∏ãÁõÆÂΩïÁªìÊûÑÔºö</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">tree ./hw/a3-pc/</span><br>./hw/a3-pc/<br>‚îú‚îÄ‚îÄ accel.c<br>‚îú‚îÄ‚îÄ machine.c<br>‚îî‚îÄ‚îÄ Makefile.objs<br><br>0 directories, 3 files<br></code></pre></td></tr></table></figure>

<p>‰∏â‰∏™Êñá‰ª∂ËØ¥ÊòéÂ¶Ç‰∏ãÔºö</p>
<ul>
<li><code>Makefile.objs</code>ÔºöÊú∫Âô®ÁöÑ Makefile Êñá‰ª∂</li>
<li><code>machine.c</code>ÔºöÊú∫Âô®ÁöÑ‰∏ª‰Ωì‰ª£Á†Å</li>
<li><code>accel.c</code>ÔºöËá™ÂÆö‰πâÁöÑ accelerator ‰ª£Á†ÅÔºå‰πüÂèØ‰ª•Áõ¥Êé•Áî®ÈªòËÆ§ÁöÑ TCG accelerator</li>
</ul>
<p>Âπ∂Âú® <code>Makefile.objs</code> ‰∏≠Ê∑ªÂä†Â¶Ç‰∏ãÂÜÖÂÆπÔºö</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs makefile">obj-<span class="hljs-variable">$(CONFIG_A3_PC)</span> += accel.o<br>obj-<span class="hljs-variable">$(CONFIG_A3_PC)</span> += machine.o<br></code></pre></td></tr></table></figure>

<p>‰πãÂêéÂú® <code>hw/Makefile.objs</code> ‰∏≠Ê∑ªÂä†‰∏äËØ•ÈÖçÁΩÆÔºö</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs makefile">devices-dirs-y = core/<br><span class="hljs-keyword">ifeq</span> (<span class="hljs-variable">$(CONFIG_SOFTMMU)</span>, y)<br><span class="hljs-comment"># ...</span><br>devices-dirs-<span class="hljs-variable">$(CONFIG_A3_PC)</span> += a3-pc/<br><span class="hljs-keyword">endif</span><br></code></pre></td></tr></table></figure>

<p>ËøôÈáåÊàë‰ª¨ÈÄöËøáÊ∑ªÂä†‰∏Ä‰∏™Êñ∞ÁöÑÈÄâÈ°π <code>CONFIG_A3_PC</code> Êù•ÊéßÂà∂ÊòØÂê¶Ë¶ÅËøõË°åËØ•Á±ªÂûãÊú∫Âô®ÁöÑÁºñËØë</p>
<p>Á¨îËÄÖÈÄâÊã©ÂàõÂª∫‰∏Ä‰∏™ i386 Á±ªÂûãÁöÑÊú∫Âô®ÔºåÂõ†Ê≠§Êàë‰ª¨ËøòÈúÄË¶Å‰øÆÊîπ <code>hw/i386/Kconfig</code>ÔºåÊ∑ªÂä†Â¶Ç‰∏ãÂÜÖÂÆπÔºåË°®Á§∫‰∏Ä‰∏™Á©∫ÁôΩÁöÑÊú∫Âô®ÔºåÂêéÈù¢Êàë‰ª¨Ëã•ÊòØÈúÄË¶ÅÊ∑ªÂä†Á°¨‰ª∂ÂàôËøòÈúÄË¶ÅÂú®ËøôÈÉ®ÂàÜËøõË°åÊîπÂä®Ôºö</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs kconfig">config A3_PC<br>    bool<br></code></pre></td></tr></table></figure>

<p>ÊúÄÂêéÊàë‰ª¨Âú®Ê∫êÁ†ÅÊ†πÁõÆÂΩïÁöÑ <code>configure</code> Êñá‰ª∂‰∏≠Ê∑ªÂä†Â¶Ç‰∏ãÂÜÖÂÆπÂç≥ÂèØÔºö</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-function"><span class="hljs-title">supported_a3_pc_target</span></span>() &#123;<br>    <span class="hljs-built_in">test</span> <span class="hljs-string">&quot;<span class="hljs-variable">$a3_pc</span>&quot;</span> = <span class="hljs-string">&quot;yes&quot;</span> || <span class="hljs-built_in">return</span> 1<br>    glob <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> <span class="hljs-string">&quot;*-softmmu&quot;</span> || <span class="hljs-built_in">return</span> 1<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;1%-softmmu&#125;</span>&quot;</span> <span class="hljs-keyword">in</span><br>	x86_64)<br>	    <span class="hljs-built_in">return</span> 0<br>	    ;;<br>    <span class="hljs-keyword">esac</span><br>    <span class="hljs-built_in">return</span> 1<br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">supported_target</span></span>() &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> <span class="hljs-keyword">in</span><br><span class="hljs-comment"># ...</span><br>    supported_a3_pc_target <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> &amp;&amp; <span class="hljs-built_in">return</span> 0<br>    print_error <span class="hljs-string">&quot;TCG disabled, but hardware accelerator not available for &#x27;<span class="hljs-variable">$target</span>&#x27;&quot;</span><br>    <span class="hljs-built_in">return</span> 1<br>&#125;<br><span class="hljs-comment"># ...</span><br><span class="hljs-keyword">for</span> opt <span class="hljs-keyword">do</span><br>  optarg=$(<span class="hljs-built_in">expr</span> <span class="hljs-string">&quot;x<span class="hljs-variable">$opt</span>&quot;</span> : <span class="hljs-string">&#x27;x[^=]*=\(.*\)&#x27;</span>)<br>  <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;<span class="hljs-variable">$opt</span>&quot;</span> <span class="hljs-keyword">in</span><br>  --<span class="hljs-built_in">help</span>|-h) show_help=<span class="hljs-built_in">yes</span><br>  ;;<br>  <span class="hljs-comment">#...</span><br>  ;;<br>  --enable-a3-pc) a3_pc=<span class="hljs-string">&quot;yes&quot;</span><br>  ;;<br><span class="hljs-comment"># ...</span><br><span class="hljs-comment"># Ëøô‰∏ÄÂùóÂèØ‰ª•ÊîæÂú® supported_whpx_target ÁöÑÈÇ£‰∏™ËØ≠Âè•Âùó‰∏ãÈù¢</span><br><span class="hljs-keyword">if</span> supported_a3_pc_target <span class="hljs-variable">$target</span>; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;CONFIG_A3_PC=y&quot;</span> &gt;&gt; <span class="hljs-variable">$config_target_mak</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;CONFIG_A3_PC=y&quot;</span> &gt;&gt; <span class="hljs-variable">$config_host_mak</span><br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure>

<p>Â¶ÇÊûúÊàë‰ª¨ÊÉ≥Ë¶ÅÊîπÂèòÁºñËØëÂá∫Êù•ÁöÑÂèØÊâßË°åÊñá‰ª∂ÁöÑÂêçÂ≠óÔºåËøòÂèØ‰ª•Âú® <code>Makefile.target</code> ‰∏≠‰øÆÊîπÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-keyword">ifdef</span> CONFIG_USER_ONLY<br><span class="hljs-comment"># user emulator name</span><br>QEMU_PROG=qemu-<span class="hljs-variable">$(TARGET_NAME)</span><br>QEMU_PROG_BUILD = <span class="hljs-variable">$(QEMU_PROG)</span><br><span class="hljs-keyword">else</span><br><span class="hljs-keyword">ifdef</span> CONFIG_A3_PC<br><span class="hljs-comment"># arttnba3 type machine</span><br>QEMU_PROG=a3-pc<br><span class="hljs-keyword">else</span><br><span class="hljs-comment"># system emulator name</span><br>QEMU_PROG=qemu-system-<span class="hljs-variable">$(TARGET_NAME)</span><span class="hljs-variable">$(EXESUF)</span><br><span class="hljs-keyword">endif</span><br></code></pre></td></tr></table></figure>

<h2 id="‰∫å„ÄÅÂÆö‰πâÊñ∞ÁöÑ-Machine-Type"><a href="#‰∫å„ÄÅÂÆö‰πâÊñ∞ÁöÑ-Machine-Type" class="headerlink" title="‰∫å„ÄÅÂÆö‰πâÊñ∞ÁöÑ Machine Type"></a>‰∫å„ÄÅÂÆö‰πâÊñ∞ÁöÑ Machine Type</h2><h3 id="I„ÄÅmachine-cÔºömachine-Âü∫Êú¨ÂÆö‰πâ"><a href="#I„ÄÅmachine-cÔºömachine-Âü∫Êú¨ÂÆö‰πâ" class="headerlink" title="I„ÄÅmachine.cÔºömachine Âü∫Êú¨ÂÆö‰πâ"></a>I„ÄÅmachine.cÔºömachine Âü∫Êú¨ÂÆö‰πâ</h3><p>ËôΩÁÑ∂ Qemu ÊòØ‰ΩøÁî® C ËØ≠Ë®ÄÁºñÂÜôÁöÑÔºå‰ΩÜÊòØÂú® Qemu ÂΩì‰∏≠ÂêåÊ†∑‰ΩøÁî®‰∫Ü OOP ÁöÑÊÄùÊÉ≥ÔºåÈÄöËøáÁªìÊûÑ‰ΩìÂµåÂ•óÁöÑÂΩ¢ÂºèÂÆûÁé∞ÁªßÊâø</p>
<p>Âú® Qemu ÂΩì‰∏≠‰ΩøÁî® <code>MachineState</code> ÁªìÊûÑ‰ΩìÁ±ªÂûãË°®Á§∫‰∏Ä‰∏™ÈÄöÁî®ËôöÊãüÊú∫ÁöÑÁä∂ÊÄÅÔºå‰ΩøÁî® <code>MachineClass</code> ÁªìÊûÑ‰ΩìÁ±ªÂûãË°®Á§∫‰∏Ä‰∏™ÈÄöÁî®ÁöÑËôöÊãüÊú∫Á±ªÂûãÔºåÂõ†Ê≠§ÂØπ‰∫éÊàë‰ª¨ÈúÄË¶ÅÂàõÂª∫ÁöÑÊñ∞ÁöÑÊú∫Âô®Á±ªÂûãÔºåÊàë‰ª¨ÈúÄË¶ÅÂàÜÂà´ÂÆö‰πâ‰ªñÁöÑÁä∂ÊÄÅÁ±ª‰∏éÁ±ªÂûãÁ±ªÔºåÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu/osdep.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu-common.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/boards.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qom/object.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;sysemu/sysemu.h&quot;</span></span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCMachineState</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    MachineState parent;<br><br>    Notifier machine_done;<br>&#125; A3PCMachineState;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCMachineClass</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    MachineClass parent;<br>&#125; A3PCMachineClass;<br></code></pre></td></tr></table></figure>

<p>ËøôÈáåÂØπ‰∫éÁªßÊâøËá™ MachineState ÁöÑÂ≠êÁ±ªÊàë‰ª¨Ê∑ªÂä†‰∫Ü‰∏Ä‰∏™Êñ∞ÁöÑ <code>Notifier</code> Á±ªÂûãÁöÑÊàêÂëòÔºåÂèØ‰ª•Áî®Êù•Âú®ÂêéÈù¢ÊûÑÂª∫‰∫ã‰ª∂ÈÄöÁü•Èìæ</p>
<p>Êàë‰ª¨ËøòÈúÄË¶ÅÂÆö‰πâ‰∏Ä‰∫õÁõ∏Â∫îÁöÑÁà∂Â≠êÁ±ªÈó¥ËΩ¨ÂûãÁöÑÂÆèÔºå‰ª•Âèä‰∏Ä‰∏™Ë°®Á§∫Êñ∞Â¢ûÁöÑ <code>a3-pc</code> Á±ªÂûãÁöÑÂÆèÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> TYPE_A3PC_MACHINE MACHINE_TYPE_NAME(<span class="hljs-string">&quot;a3-pc&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3PC_MACHINE(obj) \</span><br><span class="hljs-meta">    OBJECT_CHECK(A3PCMachineState, (obj), TYPE_A3PC_MACHINE)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3PC_MACHINE_GET_CLASS(obj) \</span><br><span class="hljs-meta">    OBJECT_GET_CLASS(A3PCMachineClass, obj, TYPE_A3PC_MACHINE)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3PC_MACHINE_CLASS(klass) \</span><br><span class="hljs-meta">    OBJECT_CLASS_CHECK(A3PCMachineClass, klass, TYPE_A3PC_MACHINE)</span><br></code></pre></td></tr></table></figure>

<p>Êé•‰∏ãÊù•Êàë‰ª¨ÂÆö‰πâ MachineState ‰∏é MachineClass ÁöÑÂàùÂßãÂåñÂáΩÊï∞ÔºåËøôÈáåÂè™ÊòØ‰∏Ä‰∏™ÊúÄÊúÄÁÆÄÂçïÁöÑÁ©∫Ê®°ÊùøÔºåÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_machine_init_done</span><span class="hljs-params">(Notifier *notifier, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_machine_init</span><span class="hljs-params">(MachineState *machine)</span><br>&#123;<br>    A3PCMachineState *ms = A3PC_MACHINE(machine);<br><br>    ms-&gt;machine_done.notify = a3_pc_machine_init_done;<br>    qemu_add_machine_init_done_notifier(&amp;ms-&gt;machine_done);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_machine_class_init</span><span class="hljs-params">(ObjectClass *oc, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>    MachineClass *mc = MACHINE_CLASS(oc);<br><br>    mc-&gt;init = a3_pc_machine_init;<br>    <span class="hljs-comment">// ËøôÈáåËÆæÁΩÆ‰∫Ü‰∏Ä‰∏™ÂèÇÊï∞ÔºåÊåáÂÆö‰∫Ü‰ΩøÁî®Êàë‰ª¨Ëá™Â∑±ÁöÑ accelerator</span><br>    mc-&gt;default_machine_opts = <span class="hljs-string">&quot;accel=a3acl&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Êé•‰∏ãÊù•Êàë‰ª¨ÈúÄË¶ÅÂ£∞Êòé‰∏Ä‰∏™ <code>TypeInfo</code> Á±ªÂûãÁöÑÂèòÈáèÔºåÁî®Êù•Ë°®Á§∫Êàë‰ª¨Êñ∞Âª∫ÁöÑËøô‰∏ÄÁßçÊú∫Âô®Á±ªÂûãÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3_pc_machine_info = &#123;<br>    .name = TYPE_A3PC_MACHINE,<br>    .parent = TYPE_MACHINE,<br>    .instance_size = <span class="hljs-keyword">sizeof</span>(A3PCMachineState),<br>    .class_size = <span class="hljs-keyword">sizeof</span>(A3PCMachineClass),<br>    .class_init = a3_pc_machine_class_init,<br>    .interfaces = (InterfaceInfo[]) &#123;<br>        &#123; &#125;,<br>    &#125;,<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>ÊúÄÂêéÂ∞±ÊòØÊ≥®ÂÜåÊàë‰ª¨ÁöÑÊñ∞Êú∫Âô®Á±ªÂûã‰∫ÜÔºåËøôÈáå‰ΩøÁî® <code>type_init()</code> Êù•ÂÆåÊàêÔºåÂéüÁêÜÊòØ gcc constructor attribute ‰ΩøÂÖ∂‰ºöË∞ÉÁî® <code>a3_pc_machine_register()</code> Êù•Ê≥®ÂÜå <code>a3_pc_machine_info</code> Ôºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_machine_register</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    type_register_static(&amp;a3_pc_machine_info);<br>&#125;<br>type_init(a3_pc_machine_register);<br></code></pre></td></tr></table></figure>

<h3 id="II„ÄÅaccel-cÔºöaccelerator-ÂÆö‰πâ"><a href="#II„ÄÅaccel-cÔºöaccelerator-ÂÆö‰πâ" class="headerlink" title="II„ÄÅaccel.cÔºöaccelerator ÂÆö‰πâ"></a>II„ÄÅaccel.cÔºöaccelerator ÂÆö‰πâ</h3><p>Êé•‰∏ãÊù•Â∞±ÊòØÂÆö‰πâÊàë‰ª¨Ëá™Â∑±ÁöÑ acceleratorÔºåÂõ†‰∏∫ Qemu ÈªòËÆ§ÈúÄË¶Å‰∏Ä‰∏™ acceleratorÔºå‰ΩÜÂ¶ÇÊûúÂÜçÂéªÂíåÂéüÊúâÁöÑ accelerator ÂÅöÈÄÇÈÖçÂ∞±Â§™È∫ªÁÉ¶‰∫ÜÔºà<del>Âõ†‰∏∫üë¥ÊòØÊáíüêï</del>ÔºâÔºåÊâÄ‰ª•ËøôÈáåÊàë‰ª¨Ëá™Â∑±ÂÆö‰πâ‰∏Ä‰∏™Á©∫ÁöÑ acceleratorÔºå‰∏çËøáËøô‰∏ÄÈÉ®ÂàÜÊàë‰ª¨Âè™ÈúÄË¶ÅÂ£∞Êòé‰∏Ä‰∏™Êñ∞ÁöÑ <code>TypeInfo</code> Á±ªÂûãÂèòÈáèÂç≥ÂèØ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu/osdep.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu/module.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/boards.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/qdev-core.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;sysemu/accel.h&quot;</span></span><br><br><span class="hljs-type">bool</span> a3_pc_allowed;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3_pc_init</span><span class="hljs-params">(MachineState *ms)</span><br>&#123;<br>    MachineClass *mc = MACHINE_GET_CLASS(ms);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * opt out of system RAM being allocated by generic code</span><br><span class="hljs-comment">     */</span><br>    mc-&gt;default_ram_id = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_accel_class_init</span><span class="hljs-params">(ObjectClass *oc, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>    AccelClass *ac = ACCEL_CLASS(oc);<br>    <span class="hljs-type">static</span> GlobalProperty compat[] = &#123;<br>        &#123; <span class="hljs-string">&quot;migration&quot;</span>, <span class="hljs-string">&quot;store-global-state&quot;</span>, <span class="hljs-string">&quot;off&quot;</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;migration&quot;</span>, <span class="hljs-string">&quot;send-configuration&quot;</span>, <span class="hljs-string">&quot;off&quot;</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;migration&quot;</span>, <span class="hljs-string">&quot;send-section-footer&quot;</span>, <span class="hljs-string">&quot;off&quot;</span> &#125;,<br>    &#125;;<br><br>    ac-&gt;name = <span class="hljs-string">&quot;A3ACL&quot;</span>;<br>    ac-&gt;init_machine = a3_pc_init;<br>    ac-&gt;allowed = &amp;a3_pc_allowed;<br>    ac-&gt;compat_props = g_ptr_array_new();<br><br>    compat_props_add(ac-&gt;compat_props, compat, G_N_ELEMENTS(compat));<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TYPE_A3_ACCEL ACCEL_CLASS_NAME(<span class="hljs-string">&quot;a3acl&quot;</span>)</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3_pc_accel_type = &#123;<br>    .name = TYPE_A3_ACCEL,<br>    .parent = TYPE_ACCEL,<br>    .class_init = a3_pc_accel_class_init,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_type_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    type_register_static(&amp;a3_pc_accel_type);<br>&#125;<br><br>type_init(a3_pc_type_init);<br></code></pre></td></tr></table></figure>

<h4 id="Êñ∞ÁâàÊú¨-accelerator-È¢ùÂ§ñÊ∑ªÂä†-ops"><a href="#Êñ∞ÁâàÊú¨-accelerator-È¢ùÂ§ñÊ∑ªÂä†-ops" class="headerlink" title="*Êñ∞ÁâàÊú¨ accelerator È¢ùÂ§ñÊ∑ªÂä† ops"></a>*Êñ∞ÁâàÊú¨ accelerator È¢ùÂ§ñÊ∑ªÂä† ops</h4><p>ÈúÄË¶ÅÊ≥®ÊÑèÁöÑÊòØ qemu ÁöÑ 7.0 Âíå 5.0 ÁöÑÁâàÊú¨‰πãÈó¥‰ª£Á†ÅÊû∂ÊûÑÊúâ‰∏ÄÂÆöÁöÑÊîπÂä®ÔºåÊâÄ‰ª•ÂØπ‰∫é 7.0 ÁâàÊú¨Êàë‰ª¨ËøòÈúÄË¶ÅÈ¢ùÂ§ñÂÆö‰πâ‰∏Ä‰∏™ AccelClassOpsÔºö</p>
<blockquote>
<p> ÂΩìÁÑ∂Ôºå‰πüÂèØ‰ª•Áõ¥Êé•Áî®ÂéüÊúâÁöÑ accelerator ÔºåÊØîÂ¶ÇËØ¥ <code>tcg</code>ÔºåÁõ¥Êé•Âú® machine.c ‰ª£Á†Å‰∏≠ÊåáÂÆö <code>accel=tcg</code> Âç≥ÂèØ</p>
</blockquote>
<blockquote>
<p>Ê∑ªÂä†Êñá‰ª∂Ôºöaccel&#x2F;a3acl&#x2F;a3acl-accel-ops.c</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * QEMU A3ACL vCPU common functionality</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Copyright (c) 22 arttnba3</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * Just modify it like what you want : )</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu/osdep.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu-common.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;sysemu/accel-ops.h&quot;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3acl_handle_interrupt</span><span class="hljs-params">(CPUState *cpu, <span class="hljs-type">int</span> mask)</span><br>&#123;<br>    <span class="hljs-comment">// do nothing</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3acl_kick_vcpu_thread</span><span class="hljs-params">(CPUState *unused)</span><br>&#123;<br>    <span class="hljs-comment">// do nothing</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3acl_start_vcpu_thread</span><span class="hljs-params">(CPUState *cpu)</span><br>&#123;<br>    <span class="hljs-comment">// do nothing</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3acl_accel_ops_init</span><span class="hljs-params">(AccelOpsClass *ops)</span><br>&#123;<br>    <span class="hljs-comment">// ËøôÂá†‰∏™ÂáΩÊï∞ÂèØ‰ª•ÊåâÁÖß‰∏™‰∫∫ÈúÄË¶ÅÊù•ËøõË°åÊîπÈÄ†ÔºåÁ¨îËÄÖËøôÈáå‰ªÖ‰ΩúÂç†‰ΩçÁ¨¶</span><br>    ops-&gt;create_vcpu_thread = a3acl_start_vcpu_thread;<br>    ops-&gt;kick_vcpu_thread = a3acl_kick_vcpu_thread;<br>    ops-&gt;handle_interrupt = a3acl_handle_interrupt;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3acl_accel_ops_class_init</span><span class="hljs-params">(ObjectClass *oc, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>    AccelOpsClass *ops = ACCEL_OPS_CLASS(oc);<br><br>    ops-&gt;ops_init = a3acl_accel_ops_init;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3acl_accel_ops_type = &#123;<br>    .name = ACCEL_OPS_NAME(<span class="hljs-string">&quot;a3acl&quot;</span>),<br>    .parent = TYPE_ACCEL_OPS,<br>    .class_init = a3acl_accel_ops_class_init,<br>    .abstract = <span class="hljs-literal">true</span>,<br>&#125;;<br>module_obj(ACCEL_OPS_NAME(<span class="hljs-string">&quot;a3acl&quot;</span>));<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3acl_accel_ops_register_types</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    type_register_static(&amp;a3acl_accel_ops_type);<br>&#125;<br>type_init(a3acl_accel_ops_register_types);<br><br></code></pre></td></tr></table></figure>

<blockquote>
<p>Ê∑ªÂä†Êñá‰ª∂Ôºöaccel&#x2F;a3acl&#x2F;meson.build</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs meson">a3acl_ss = ss.source_set()<br>a3acl_ss.add(files(<br>  &#x27;a3acl-accel-ops.c&#x27;,<br>))<br><br>specific_ss.add_all(when: &#x27;CONFIG_A3ACL&#x27;, if_true: a3acl_ss)<br></code></pre></td></tr></table></figure>

<blockquote>
<p>‰øÆÊîπÊñá‰ª∂Ôºöaccel&#x2F;meson.build</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs meson">if have_system<br>  subdir(&#x27;hvf&#x27;)<br>  subdir(&#x27;qtest&#x27;)<br>  subdir(&#x27;kvm&#x27;)<br>  subdir(&#x27;xen&#x27;)<br>  subdir(&#x27;stubs&#x27;)<br>  subdir(&#x27;a3acl&#x27;) # Âä†‰∏äËøôÂè•<br>endif<br></code></pre></td></tr></table></figure>

<blockquote>
<p>‰øÆÊîπÊñá‰ª∂Ôºöaccel&#x2F;Kconfig</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kconfig"># Ê∑ªÂä†‰∏äËøôÔºö<br>config A3ACL<br>    bool<br>    default y<br></code></pre></td></tr></table></figure>

<h2 id="‰∏â„ÄÅÊ∑ªÂä†ËÆæÂ§áÁªìÊûÑüïä"><a href="#‰∏â„ÄÅÊ∑ªÂä†ËÆæÂ§áÁªìÊûÑüïä" class="headerlink" title="‰∏â„ÄÅÊ∑ªÂä†ËÆæÂ§áÁªìÊûÑüïä"></a>‰∏â„ÄÅÊ∑ªÂä†ËÆæÂ§áÁªìÊûÑüïä</h2><p>Áé∞Âú®Êàë‰ª¨Â∑≤ÁªèÊúâ‰∫Ü‰∏ÄÂè∞ÂèØ‰ª•ËøêË°åÁöÑÁ©∫ÁôΩÁöÑÊú∫Âô®‚Äî‚Äî‰ΩÜÂåÖÊã¨ CPU Âú®ÂÜÖÁöÑÊâÄÊúâËÆæÂ§áÁõÆÂâçÊöÇ‰∏îÈÉΩÊòØ‰∏çÂ≠òÂú®ÁöÑÔºåÂõ†Ê≠§Êàë‰ª¨ÈúÄË¶ÅÊâãÂä®Âú∞ÊûÑÈÄ†Êú∫Âô®ÁöÑËÆæÂ§áÁªìÊûÑ</p>
<h3 id="I„ÄÅÊ∑ªÂä†Êñ∞ÁöÑ-PCIe-Host-Bridge"><a href="#I„ÄÅÊ∑ªÂä†Êñ∞ÁöÑ-PCIe-Host-Bridge" class="headerlink" title="I„ÄÅÊ∑ªÂä†Êñ∞ÁöÑ PCIe Host Bridge"></a>I„ÄÅÊ∑ªÂä†Êñ∞ÁöÑ PCIe Host Bridge</h3><p>‰∏Ä‰∏™Á©∫ÁöÑÊú∫Âô®‰ªÄ‰πàÈÉΩÊ≤°ÊúâÔºåÈÇ£Ëá™ÁÑ∂ÊòØ‰ªÄ‰πàÈÉΩÂπ≤‰∏ç‰∫ÜÁöÑÔºåÊâÄ‰ª•Êàë‰ª¨È¶ñÂÖàÈúÄË¶Å‰∏∫Ëøô‰∏™Êú∫Âô®Ê∑ªÂä†‰∏ä‰∏Ä‰∏™ <code>PCIe Host Bridge</code>Ôºå‰ªéËÄåËÆ©Êàë‰ª¨ÁöÑÊú∫Âô®ÂèØ‰ª•Ê∑ªÂä†Êñ∞ÁöÑ PCIe ËÆæÂ§á</p>
<p>ÊÉØ‰æãÂú∞Â∞±ÊòØÂÆö‰πâ‰∏Ä‰∏™Êñ∞ÁöÑ <code>PCIe Host Bridge</code> Á±ªÂûãÁöÑÊñ∞ PCIe ËÆæÂ§áÔºö</p>
<blockquote>
<p>Ê∑ªÂä†Êñá‰ª∂Ôºöinclude&#x2F;hw&#x2F;pci-host&#x2F;a3pc.h</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> HW_A3_PC_PCIE_HOST_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HW_A3_PC_PCIE_HOST_H</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;exec/memory.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/pci/pcie_host.h&quot;</span></span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCPCIEHost</span> &#123;</span><br>    PCIExpressHost parent_obj;<br><br>    MemoryRegion mem;<br>    MemoryRegion io;<br>&#125; A3PCPCIEHost;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TYPE_A3_PC_PCIE_HOST <span class="hljs-string">&quot;a3-pc-pcie-host&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3_PC_PCIE_HOST(obj) \</span><br><span class="hljs-meta">    OBJECT_CHECK(A3PCPCIEHost, (obj), TYPE_A3_PC_PCIE_HOST)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* HW_A3_PC_PCIE_HOST_H */</span></span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>Ê∑ªÂä†Êñá‰ª∂Ôºöhw&#x2F;pci-host&#x2F;a3pc.c</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu/osdep.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu-common.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;exec/memory.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/qdev-properties.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/pci/pci.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/pci/pcie_host.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/pci-host/a3pc.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu/error-report.h&quot;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_host_init</span><span class="hljs-params">(Object *obj)</span><br>&#123;<br>    <span class="hljs-comment">// nothing to do</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_pcie_set_irq</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, <span class="hljs-type">int</span> irq_num, <span class="hljs-type">int</span> level)</span><br>&#123;<br>    warn_report(<span class="hljs-string">&quot;A3-PC: not support INTx (irq %d, level %d)&quot;</span>,<br>                irq_num, level);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3_pc_pcie_swizzle_map_irq_fn</span><span class="hljs-params">(PCIDevice *pci_dev, <span class="hljs-type">int</span> pin)</span><br>&#123;<br>    warn_report(<span class="hljs-string">&quot;A3-PC: not support INTx (pin %d)&quot;</span>, pin);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_pcie_host_realize</span><span class="hljs-params">(DeviceState *dev, Error **errp)</span><br>&#123;<br>    PCIHostState *pci = PCI_HOST_BRIDGE(dev);<br>    A3PCPCIEHost *h = A3_PC_PCIE_HOST(dev);<br>    SysBusDevice *sbd = SYS_BUS_DEVICE(dev);<br><br>    memory_region_init(&amp;h-&gt;mem, OBJECT(h), <span class="hljs-string">&quot;a3-pc-mem&quot;</span>, <span class="hljs-number">16</span>);<br>    memory_region_init(&amp;h-&gt;io, OBJECT(h), <span class="hljs-string">&quot;a3-pc-io&quot;</span>, <span class="hljs-number">16</span>);<br>    sysbus_init_mmio(sbd, &amp;h-&gt;mem);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * A PCIe host in QEMU is required to provide</span><br><span class="hljs-comment">     * a pair of callbacks: set_irq() and map_irq()</span><br><span class="hljs-comment">     */</span><br>    pci-&gt;bus = pci_register_root_bus(dev, <span class="hljs-string">&quot;a3-pcie0&quot;</span>,<br>                                    a3_pc_pcie_set_irq,<br>                                    a3_pc_pcie_swizzle_map_irq_fn,<br>                                    h, &amp;h-&gt;mem, &amp;h-&gt;io, <br>                                    <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, TYPE_PCIE_BUS);<br>&#125;<br><br><span class="hljs-type">static</span> Property a3_pc_pcie_host_props[] = &#123;<br>    DEFINE_PROP_END_OF_LIST(),<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_class_init</span><span class="hljs-params">(ObjectClass *oc, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>    DeviceClass *dc = DEVICE_CLASS(oc);<br><br>    dc-&gt;realize = a3_pc_pcie_host_realize;<br>    set_bit(DEVICE_CATEGORY_BRIDGE, dc-&gt;categories);<br>    device_class_set_props(dc, a3_pc_pcie_host_props);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3_pc_pcie_host = &#123;<br>    .name = TYPE_A3_PC_PCIE_HOST,<br>    .parent = TYPE_PCI_HOST_BRIDGE,<br>    .instance_size = <span class="hljs-keyword">sizeof</span>(A3PCPCIEHost),<br>    .instance_init = a3_pc_host_init,<br>    .class_init = a3_pc_class_init,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_pcie_host_register</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    type_register(&amp;a3_pc_pcie_host);<br>&#125;<br><br>type_init(a3_pc_pcie_host_register);<br></code></pre></td></tr></table></figure>

<blockquote>
<p>‰øÆÊîπÊñá‰ª∂Ôºöhw&#x2F;pci-host&#x2F;meson.build</p>
<blockquote>
<p>ËÄÅÁâàÊú¨Ê≤°Êµã‰∫ÜÔºåËá™Â∑±ÊÉ≥ËØ•ÊÄé‰πàÊîπÂêßÔºàÁ¨ëÔºâ</p>
</blockquote>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs meson"># A3 devices<br>pci_ss.add(when: &#x27;CONFIG_PCI&#x27;, if_true: files(&#x27;a3pc.c&#x27;))<br></code></pre></td></tr></table></figure>

<p>‰πãÂêéÊàë‰ª¨Âú®Êàë‰ª¨ÁöÑÊú∫Âô®Á±ªÂûã‰∏≠Âä†‰∏ä PCI Áõ∏ÂÖ≥ÁöÑ‰∏§‰∏™ÊåáÈíàÊàêÂëòÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCMachineState</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    MachineState parent;<br><br>    <span class="hljs-comment">/* &lt;public&gt; */</span><br><br>    <span class="hljs-comment">/* State for other subsystems/APIs: */</span><br>    Notifier machine_done;<br><br>    <span class="hljs-comment">/* Pointers to devices and objects: */</span><br>    PCIBus *bus;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * QEMU requires the entire PCI(e) hierarchy be attached to</span><br><span class="hljs-comment">     * a PCI(e) bus, so BES-VNC machine has to implement one.</span><br><span class="hljs-comment">     */</span><br>    PCIHostState *pci;<br>&#125; A3PCMachineState;<br></code></pre></td></tr></table></figure>

<p>ÊúÄÂêéÂú®Êú∫Âô®ÂàùÂßãÂåñÂáΩÊï∞‰∏≠ÂàùÂßãÂåñ‰∏Ä‰∏™Êàë‰ª¨Ëá™ÂÆö‰πâÁöÑËøô‰∏™ PCIe ËÆæÂ§áÂç≥ÂèØÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_machine_init</span><span class="hljs-params">(MachineState *machine)</span><br>&#123;<br>    A3PCMachineState *ms = A3PC_MACHINE(machine);<br>    DeviceState *dev = qdev_new(TYPE_A3_PC_PCIE_HOST);<br><br>    sysbus_realize_and_unref(SYS_BUS_DEVICE(dev), &amp;error_fatal);<br>    ms-&gt;pci = PCI_HOST_BRIDGE(dev);<br><br>    memory_region_add_subregion(get_system_memory(), <span class="hljs-number">0</span>,<br>                                sysbus_mmio_get_region(SYS_BUS_DEVICE(dev), <span class="hljs-number">0</span>));<br><br>    ms-&gt;machine_done.notify = a3_pc_machine_init_done;<br>    qemu_add_machine_init_done_notifier(&amp;ms-&gt;machine_done);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Ê≥®ÊÑèÊñ∞ÁâàÊú¨ÂíåËÄÅÁâàÊú¨ÁöÑ API ‰∏çÂêåÔºåÂú®ËÄÅÁâàÊú¨‰∏≠Â∫îÂΩì‰ΩøÁî®Â¶Ç‰∏ã APIÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_machine_init</span><span class="hljs-params">(MachineState *machine)</span><br>&#123;<br>    A3PCMachineState *ms = A3PC_MACHINE(machine);<br><br>    DeviceState *dev = qdev_create(<span class="hljs-literal">NULL</span>, TYPE_A3_PC_PCIE_HOST);<br><br>    qdev_init_nofail(dev);<br>    ms-&gt;pci = PCI_HOST_BRIDGE(dev);<br><br>    memory_region_add_subregion(get_system_memory(), <span class="hljs-number">0</span>,<br>                                sysbus_mmio_get_region(SYS_BUS_DEVICE(dev), <span class="hljs-number">0</span>));<br><br>    ms-&gt;machine_done.notify = a3_pc_machine_init_done;<br>    qemu_add_machine_init_done_notifier(&amp;ms-&gt;machine_done);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÂÆåÊàêËøô‰∫õÊ≠•È™§‰πãÂêéÊàë‰ª¨ÁöÑÊñ∞Êú∫Âô®Â∞±ËÉΩÈöèÊÑèÊèíÂÖ•ÂêÑÁßç PCI ËÆæÂ§á‰∫ÜÔºõÔºâ</p>
<h3 id="II„ÄÅÊ∑ªÂä†Êñ∞ÁöÑ-CPU-ÊèíÊßΩüïä"><a href="#II„ÄÅÊ∑ªÂä†Êñ∞ÁöÑ-CPU-ÊèíÊßΩüïä" class="headerlink" title="II„ÄÅÊ∑ªÂä†Êñ∞ÁöÑ CPU ÊèíÊßΩüïä"></a>II„ÄÅÊ∑ªÂä†Êñ∞ÁöÑ CPU ÊèíÊßΩüïä</h3><p>ÂΩìÁÑ∂ÔºåÊàë‰ª¨ÁöÑÊú∫Âô®ËøòÁº∫Â∞ë‰∫Ü CPUÔºåÊ≤°Êúâ CPU ÁöÑÊú∫Âô®Ëá™ÁÑ∂ÊòØË∑ë‰∏çËµ∑Êù•ÁöÑÔºåÂõ†Ê≠§ËøôÈáåÊàë‰ª¨ËøòÈúÄË¶ÅÂú®Êàë‰ª¨ÁöÑÊú∫Âô®Á±ªÂûãÂΩì‰∏≠Ê∑ªÂä†‰∏äÁõ∏Â∫îÁöÑ CPU ÊèíÊßΩÔºåÁî±‰∫é Qemu ÂÜÖÈÉ®ÁöÑÂü∫Á°Ä x86 Êú∫Âô®Êû∂ÊûÑÂ∑≤ÁªèÂÆûÁé∞Â•Ω‰∫ÜÂü∫Á°ÄÊ°ÜÊû∂ÔºåÊâÄ‰ª•Êàë‰ª¨Áõ¥Êé•Êîπ‰∏∫ÁªßÊâøËá™ÂØπÂ∫îÁöÑ x86 Âü∫Á°ÄÊú∫Âô®Á±ªÂç≥ÂèØ</p>
<blockquote>
<p>ÂΩìÁÑ∂ÔºåÂ¶ÇÊûúÊòØÁ∫ØÁ∫ØËá™ÂÆö‰πâÁöÑÂºÇÊû∂ÊûÑÔºåËøôÈáåËøòÊòØÂæóËá™Â∑±ÊâãÂä®ÂÜô‰∏ÄÂ•ó‚Ä¶</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCMachineState</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    X86MachineState parent;<br><br>    <span class="hljs-comment">/* &lt;public&gt; */</span><br><br>    <span class="hljs-comment">/* State for other subsystems/APIs: */</span><br>    Notifier machine_done;<br><br>    <span class="hljs-comment">/* Pointers to devices and objects: */</span><br>    PCIBus *bus;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * QEMU requires the entire PCI(e) hierarchy be attached to</span><br><span class="hljs-comment">     * a PCI(e) bus, so BES-VNC machine has to implement one.</span><br><span class="hljs-comment">     */</span><br>    PCIHostState *pci;<br>&#125; A3PCMachineState;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCMachineClass</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    X86MachineClass parent;<br><br>    <span class="hljs-comment">/*&lt; public &gt;*/</span><br><br>    <span class="hljs-comment">/* Default CPU model version.  See x86_cpu_set_default_version(). */</span><br>    <span class="hljs-type">int</span> default_cpu_version;<br>&#125; A3PCMachineClass;<br></code></pre></td></tr></table></figure>

<p>‰∏çËøáÊú∫Âô®ÂÆö‰πâÁöÑÊñá‰ª∂ÂΩì‰∏≠ÈúÄË¶ÅÊîπÂä®ÁöÑÈÉ®ÂàÜ‰ºöÊØîÈ¢ÑÊÉ≥ÁöÑË¶ÅÂ§öÔºå<del>ÊâÄ‰ª•ËøôÈáåÂ∞±ÂÖàüïäüïäüïä‰∫Ü</del></p>
<h3 id="Extra-Ëá™ÂÆö‰πâ-CPU-üïä"><a href="#Extra-Ëá™ÂÆö‰πâ-CPU-üïä" class="headerlink" title="Extra.Ëá™ÂÆö‰πâ CPU üïä"></a>Extra.Ëá™ÂÆö‰πâ CPU üïä</h3><blockquote>
<p>üïäüïäüïä</p>
</blockquote>
<h2 id="Âõõ„ÄÅÁºñËØëËøêË°åüïä"><a href="#Âõõ„ÄÅÁºñËØëËøêË°åüïä" class="headerlink" title="Âõõ„ÄÅÁºñËØëËøêË°åüïä"></a>Âõõ„ÄÅÁºñËØëËøêË°åüïä</h2><p>Áî±‰∫éÊàë‰ª¨Êñ∞Âª∫Á´ãÁöÑÊú∫Âô®Á±ªÂûã‰∏∫ <code>x86</code> Êû∂ÊûÑÁöÑÊú∫Âô®ÔºåÂõ†Ê≠§Êàë‰ª¨ÈúÄË¶ÅÂú®ÊâßË°å configure ËÑöÊú¨Êó∂ÊåáÂÆö <code>--target-list=x86_64-softmmu</code> </p>
<p>ËøôÈáåÈúÄË¶ÅÊ≥®ÊÑèÁöÑÊòØÂâçÂâçÈù¢Á¨îËÄÖÊèê‰æõ‰∫Ü‰∏§ÁßçËÆæÁΩÆ <code>CONFIG_A3_PC</code> ÁöÑÈÄâÈ°πÔºöÂ¶ÇÊûúÊàë‰ª¨ÊòØÁõ¥Êé•ÈÄöËøá‰øÆÊîπ <code>default.mak</code> ‰ΩøÂæó <code>CONFIG_A3_PC=y</code>ÔºåÂàôÁõ¥Êé•ÁºñËØëÂç≥ÂèØÔºõËã•Êàë‰ª¨ÊòØÈÄöËøá‰øÆÊîπ‰∫Ü <code>configure</code> Êù•ÊåáÂÆö <code>CONFIG_A3_PC</code> ÁöÑÂÄºÔºåÂàôÂàõÂª∫ÁºñËØëËÑöÊú¨ÁöÑÊó∂ÂÄôÊàë‰ª¨ÈúÄË¶ÅÊâãÂä®ÊåáÂÆö <code>--enable-a3-pc</code> Êù•ÁºñËØë‰∏äÊàë‰ª¨Êñ∞Â¢ûÁöÑÊú∫Âô®Á±ªÂûã</p>
<p>ÁºñËØëÂÆåÊàêÂêéÊàë‰ª¨‰æøËÉΩÂ§üÁúãÂà∞Êàë‰ª¨Êñ∞Ê∑ªÂä†ÁöÑÊú∫Âô®Á±ªÂûã <code>a3-pc</code>Ôºö</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">build$ </span><span class="language-bash">./qemu-system-x86_64 -machine ?</span><br>Supported machines are:<br>microvm              microvm (i386)<br>pc                   Standard PC (i440FX + PIIX, 1996) (alias of pc-i440fx-7.0)<br>pc-i440fx-7.0        Standard PC (i440FX + PIIX, 1996) (default)<br><span class="hljs-meta prompt_">#</span><span class="language-bash">...</span><br>a3-pc                (null)<br></code></pre></td></tr></table></figure>

<blockquote>
<p>üïäüïäüïä</p>
</blockquote>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/VIRTUALIZATION/" class="category-chain-item">VIRTUALIZATION</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/PCI/">#PCI</a>
      
        <a href="/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/">#ËôöÊãüÂåñ</a>
      
        <a href="/tags/Qemu/">#Qemu</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>„ÄêVIRT.0x00„ÄëQemu - IÔºöQemu ÁÆÄÊòìÈ£üÁî®ÊåáÂçó</div>
      <div>https://arttnba3.github.io/2022/07/15/VIRTUALIZATION-0X00-QEMU-PART-I/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>‰ΩúËÄÖ</div>
          <div>arttnba3</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>ÂèëÂ∏É‰∫é</div>
          <div>2022Âπ¥7Êúà15Êó•</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>ËÆ∏ÂèØÂçèËÆÆ</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - ÁΩ≤Âêç">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/07/22/VIRTUALIZATION-0X01-QEMU-PART-II/" title="„ÄêVIRT.0x01„ÄëQemu - IIÔºöVNC Ê®°ÂùóÊ∫êÁ†ÅÂàÜÊûê">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">„ÄêVIRT.0x01„ÄëQemu - IIÔºöVNC Ê®°ÂùóÊ∫êÁ†ÅÂàÜÊûê</span>
                        <span class="visible-mobile">‰∏ä‰∏ÄÁØá</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/06/30/OS-0X03-LINUX-KERNEL-MEMORY-5.11-PART-II/" title="„ÄêOS.0x03„ÄëLinuxÂÜÖÊ†∏ÂÜÖÂ≠òÁÆ°ÁêÜII - Buddy System">
                        <span class="hidden-mobile">„ÄêOS.0x03„ÄëLinuxÂÜÖÊ†∏ÂÜÖÂ≠òÁÆ°ÁêÜII - Buddy System</span>
                        <span class="visible-mobile">‰∏ã‰∏ÄÁØá</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.17/Valine.min.js', function() {
        var options = Object.assign(
          {"appid":"ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz","appkey":"tuvJh3xYxPFcW2JB6K26RKP2","path":"window.location.pathname","placeholder":"ËØ¥ÁÇπ‰ªÄ‰πàÂëóÔºàÁ¨ëÔºâ","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false,"appId":"ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz","appKey":"tuvJh3xYxPFcW2JB6K26RKP2"},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ÁõÆÂΩï</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">ÊêúÁ¥¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">ÂÖ≥ÈîÆËØç</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  <!-- ÁΩëÁ´ôËøêË°åÊó∂Èó¥ÁöÑËÆæÁΩÆ -->
  <span id="timeDate">ËΩΩÂÖ•Â§©Êï∞...</span>
  <span id="times">ËΩΩÂÖ•Êó∂ÂàÜÁßí...</span>
  <script>
      var now = new Date();
      function createtime() {
          var grt= new Date("04/20/2020 17:48:48");//Ê≠§Â§Ñ‰øÆÊîπ‰Ω†ÁöÑÂª∫Á´ôÊó∂Èó¥ÊàñËÄÖÁΩëÁ´ô‰∏äÁ∫øÊó∂Èó¥
          now.setTime(now.getTime()+250);
          days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
          hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
          if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
          mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
          seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
          snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
          document.getElementById("timeDate").innerHTML = "arttnba3ÁöÑÂ∞èÂ±ãÂ∑≤ÁªèÂÆâÂÖ®Â≠òÂú®‰∫Ü "+dnum+" Â§© ";
          document.getElementById("times").innerHTML = hnum + " Â∞èÊó∂ " + mnum + " ÂàÜ " + snum + " Áßí";
      }
  setInterval("createtime()",250);
  </script>
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        ÊÄªËÆøÈóÆÈáè 
        <span id="busuanzi_value_site_pv"></span>
         Ê¨°
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        ÊÄªËÆøÂÆ¢Êï∞ 
        <span id="busuanzi_value_site_uv"></span>
         ‰∫∫
      </span>
    
    
  
</div>

  
  
    <!-- Â§áÊ°à‰ø°ÊÅØ ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      Ê°ÇICPÂ§á2022005068Âè∑-1
    </a>
  </span>
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.1/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- ‰∏ªÈ¢òÁöÑÂêØÂä®È°πÔºåÂ∞ÜÂÆÉ‰øùÊåÅÂú®ÊúÄÂ∫ïÈÉ® -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">ÂçöÂÆ¢Âú®ÂÖÅËÆ∏ JavaScript ËøêË°åÁöÑÁéØÂ¢É‰∏ãÊµèËßàÊïàÊûúÊõ¥‰Ω≥</div>
  </noscript>
</body>
</html>
