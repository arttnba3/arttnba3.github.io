

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.png">
  <link rel="icon" href="/img/avatar.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="arttnba3">
  <meta name="keywords" content="">
  
    <meta name="description" content="HEY DUDE!">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€OS.0x03ã€‘Linuxå†…æ ¸å†…å­˜ç®¡ç†II - Buddy System">
<meta property="og:url" content="https://arttnba3.github.io/2022/06/30/OS-0X03-LINUX-KERNEL-MEMORY-5.11-PART-II/index.html">
<meta property="og:site_name" content="arttnba3&#39;s blog">
<meta property="og:description" content="HEY DUDE!">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/07/06/ktV7cNlohiQCSWP.png">
<meta property="article:published_time" content="2022-06-30T13:44:49.000Z">
<meta property="article:modified_time" content="2024-08-19T06:19:34.604Z">
<meta property="article:author" content="arttnba3">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Linux Kernel">
<meta property="article:tag" content="æ“ä½œç³»ç»Ÿ">
<meta property="article:tag" content="å†…å­˜ç®¡ç†">
<meta property="article:tag" content="buddy system">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://s2.loli.net/2022/07/06/ktV7cNlohiQCSWP.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>ã€OS.0x03ã€‘Linuxå†…æ ¸å†…å­˜ç®¡ç†II - Buddy System - arttnba3&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"arttnba3.github.io","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"Â§"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.1.1"><link rel="alternate" href="/atom.xml" title="arttnba3's blog" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 80vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>arttnba3&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                å‹é“¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" target="_blank" rel="noopener" href="https://github.com/arttnba3">
                <i class="iconfont icon-github-fill"></i>
                GitHub
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/atom.xml">
                <i class="iconfont icon-rss"></i>
                rss
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://i.loli.net/2021/11/30/9srbaMvWeTSO1hc.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="ã€OS.0x03ã€‘Linuxå†…æ ¸å†…å­˜ç®¡ç†II - Buddy System"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-06-30 23:44" pubdate>
          2022å¹´6æœˆ30æ—¥ æ™šä¸Š
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          35k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          296 åˆ†é’Ÿ
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> æ¬¡
        </span>
        
      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">ã€OS.0x03ã€‘Linuxå†…æ ¸å†…å­˜ç®¡ç†II - Buddy System</h1>
            
              <p class="note note-info">
                
                  
                    æœ¬æ–‡æœ€åæ›´æ–°äºï¼š2024å¹´8æœˆ19æ—¥ ä¸‹åˆ
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>HEY DUDE!</p>
<span id="more"></span>

<h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>åœ¨<a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/11/28/OS-0X02-LINUX-KERNEL-MEMORY-5.11-PART-I/">ä¸Šä¸€ç¯‡æ–‡ç« </a>ä¸­ç¬”è€…ç®€è¦é˜è¿°äº† Linux å†…æ ¸å½“ä¸­å†…å­˜çš„åŸºæœ¬ç»„ç»‡æ¶æ„ï¼šé¡µã€åŒºã€èŠ‚ç‚¹ï¼Œåœ¨æœ¬ç¯‡æ–‡ç« å½“ä¸­ç¬”è€…å°†é˜è¿°å†…æ ¸ä¸­æœ€<strong>åŸºç¡€</strong>çš„å†…å­˜åˆ†é…å™¨â€”â€”<strong>Buddy Systen</strong>ï¼ˆä¼™ä¼´ç³»ç»Ÿï¼‰</p>
<blockquote>
<p>é€šè¿‡è¯»å– <code>/proc/buddyinfo</code> å¯ä»¥è·å–å½“å‰ç³»ç»Ÿä¸­ buddy system çš„è¯¦ç»†ä¿¡æ¯</p>
<p><img src="https://i.loli.net/2021/11/30/eRiVXpyUkncYZus.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>ç¬”è€…çš„ğŸ’»é…ç½®æ¯”è¾ƒğŸš®ï¼Œæ‰€ä»¥åªæœ‰ä¸€ä¸ª nodeï¼Œéå¸¸æŠ±æ­‰â€¦</p>
</blockquote>
</blockquote>
<blockquote>
<p>è¿™ç¯‡æ–‡ç« å…¶å®å¾ˆæ—©å°±å†™äº†ä¸ªæ¡†æ¶äº†ï¼Œä½†æ˜¯åé¢ä¸€ç›´æ²¡æœ‰æ¥å¾—åŠè¿›è¡Œè¡¥å®Œâ€¦ï¼ˆå…¶å®å°±æ˜¯æ‡’è€Œå·²å§ï¼ˆæ¼ï¼‰ï¼‰</p>
<p><img src="https://s2.loli.net/2022/06/08/7VaQ6riZOcmDuEg.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
</blockquote>
<h1 id="0x01-buddy-system-ä¸­çš„å†…å­˜ç»„ç»‡å½¢å¼"><a href="#0x01-buddy-system-ä¸­çš„å†…å­˜ç»„ç»‡å½¢å¼" class="headerlink" title="0x01.buddy system ä¸­çš„å†…å­˜ç»„ç»‡å½¢å¼"></a>0x01.buddy system ä¸­çš„å†…å­˜ç»„ç»‡å½¢å¼</h1><h2 id="zone-ä¸­çš„-free-area-ç»“æ„ä½“æ•°ç»„"><a href="#zone-ä¸­çš„-free-area-ç»“æ„ä½“æ•°ç»„" class="headerlink" title="zone ä¸­çš„ free_area ç»“æ„ä½“æ•°ç»„"></a>zone ä¸­çš„ free_area ç»“æ„ä½“æ•°ç»„</h2><p>å‰æ–‡ä¸­æˆ‘ä»¬è®²åˆ°ï¼Œæ¯ä¸ª zone ç»“æ„ä½“ä¸­éƒ½æœ‰ä¸€ä¸ª free_area ç»“æ„ä½“æ•°ç»„ï¼Œç”¨ä»¥å­˜å‚¨ buddy system <strong>æŒ‰ç…§ order ç®¡ç†çš„é¡µé¢</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zone</span> &#123;</span><br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">free_area</span>	<span class="hljs-title">free_area</span>[<span class="hljs-title">MAX_ORDER</span>];</span><br>    <span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure>

<p>å…¶ä¸­çš„ <code>MAX_ORDER</code> ä¸ºä¸€ä¸ªå¸¸é‡ï¼Œå€¼ä¸º 11</p>
<p>åœ¨ buddy system ä¸­æŒ‰ç…§ç©ºé—²é¡µé¢çš„è¿ç»­å¤§å°è¿›è¡Œåˆ†é˜¶ç®¡ç†ï¼Œè¿™é‡Œçš„ order çš„å®é™…å«ä¹‰ä¸º<strong>è¿ç»­çš„ç©ºé—²é¡µé¢çš„å¤§å°</strong>ï¼Œä¸è¿‡å•ä½ä¸æ˜¯é¡µé¢æ•°ï¼Œè€Œæ˜¯<code>é˜¶</code>ï¼Œå³å¯¹äºæ¯ä¸ªä¸‹æ ‡è€Œè¨€ï¼Œå…¶ä¸­æ‰€å­˜å‚¨çš„é¡µé¢å¤§å°ä¸ºï¼š<br>$$<br>2^{order}<br>$$<br>åœ¨ free_area ä¸­å­˜æ”¾çš„é¡µé¢é€šè¿‡è‡ªèº«çš„ç›¸åº”å­—æ®µè¿æ¥æˆåŒå‘é“¾è¡¨ç»“æ„ï¼Œç”±æ­¤æˆ‘ä»¬å¾—åˆ°è¿™æ ·ä¸€å¼ _Overview_ï¼š</p>
<p><img src="https://i.loli.net/2021/11/30/sOwdI5YMNUjLSib.png" srcset="/img/loading.gif" lazyload alt="è‡ªå·±ç”»çš„å›¾.png"></p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥è§£æ <code>free_area</code> çš„å…·ä½“ç»“æ„ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">free_area</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span>	<span class="hljs-title">free_list</span>[<span class="hljs-title">MIGRATE_TYPES</span>];</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>		nr_free;<br>&#125;;<br></code></pre></td></tr></table></figure>

<h3 id="free-listï¼šç©ºé—²é¡µé¢åŒå‘é“¾è¡¨"><a href="#free-listï¼šç©ºé—²é¡µé¢åŒå‘é“¾è¡¨" class="headerlink" title="free_listï¼šç©ºé—²é¡µé¢åŒå‘é“¾è¡¨"></a>free_listï¼šç©ºé—²é¡µé¢åŒå‘é“¾è¡¨</h3><p>æˆ‘ä»¬ä¸éš¾çœ‹å‡ºï¼šfree_area çš„ free_list å­—æ®µä¾¿æ˜¯ç”¨ä»¥å­˜æ”¾æŒ‡å‘ç©ºé—²é¡µé¢çš„æŒ‡é’ˆï¼Œå…¶é€šè¿‡ page ç»“æ„ä½“çš„ <code>lru</code> å­—æ®µå°† page ç»“æ„ä½“è¿æ¥æˆåŒå‘é“¾è¡¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> &#123;</span><br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span>	<span class="hljs-comment">/* é¡µç¼“å­˜ä¸åŒ¿åé¡µ */</span><br>			<span class="hljs-comment">/**</span><br><span class="hljs-comment">			 * @lru: Pageout é“¾è¡¨, ä¾‹å¦‚ active_list ä¾¿ç”±</span><br><span class="hljs-comment">			 * lruvec-&gt;lru_lock ä¿æŠ¤ã€‚  </span><br><span class="hljs-comment">			 * æœ‰æ—¶ä¼šè¢«é¡µæ‰€æœ‰è€…ä½œä¸ºå¸¸è§„é“¾è¡¨ä½¿ç”¨ã€‚</span><br><span class="hljs-comment">			 */</span><br>			<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">lru</span>;</span><br>    <span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure>

<p>page ç»“æ„ä½“ä¸­çš„ <code>lru</code> è¿™ä¸€å­—æ®µçš„ç±»å‹ä¸º <code>struct list_head</code>ï¼Œè¿™æ˜¯å†…æ ¸ç¼–ç¨‹ä¸­é€šç”¨çš„åŒå‘é“¾è¡¨ç»“æ„ï¼Œ<strong>free_list ä¸ lru é“¾è¡¨éƒ½ä½¿ç”¨è¯¥å­—æ®µ</strong> å°†é¡µç»“æ„ä½“ç»„ç»‡ä¸º_åŒå‘é“¾è¡¨_ï¼Œå³_ä¸€ä¸ªé¡µæ˜¯ä¸å¯èƒ½åŒæ—¶å‡ºç°åœ¨ lru é“¾è¡¨ä¸ buddy system ä¸­çš„_</p>
<h4 id="è¿ç§»ç±»å‹åˆ†é“¾è¡¨"><a href="#è¿ç§»ç±»å‹åˆ†é“¾è¡¨" class="headerlink" title="è¿ç§»ç±»å‹åˆ†é“¾è¡¨"></a><em>è¿ç§»ç±»å‹åˆ†é“¾è¡¨</em></h4><p>åœ¨è¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ°free_area ä¸­<strong>å¹¶éåªæœ‰ä¸€ä¸ªåŒå‘é“¾è¡¨</strong>ï¼Œè€Œæ˜¯æŒ‰ç…§ä¸åŒçš„â€œè¿ç§»ç±»å‹â€ï¼ˆmigrate typeï¼‰è¿›è¡Œåˆ†å¼€å­˜æ”¾ï¼Œè¿™æ˜¯ç”±äº_é¡µé¢è¿ç§»_æœºåˆ¶çš„å­˜åœ¨</p>
<p>é¡µé¢è¿ç§»ä¸»è¦ç”¨ä»¥è§£å†³å†…æ ¸ç©ºé—´ä¸­çš„<strong>ç¢ç‰‡é—®é¢˜</strong>ï¼Œåœ¨é•¿æœŸçš„è¿è¡Œä¹‹åå†…å­˜å½“ä¸­ç©ºé—²é¡µé¢çš„åˆ†å¸ƒå¯èƒ½æ˜¯é›¶æ•£çš„ï¼Œè¿™ä¾¿å¯¼è‡´äº†å†…æ ¸<strong>æœ‰å¯èƒ½æ— æ³•æ˜ å°„åˆ°è¶³å¤Ÿå¤§çš„è¿ç»­å†…å­˜</strong>ï¼Œå› æ­¤éœ€è¦è¿›è¡Œ_é¡µé¢è¿ç§»_â€”â€”å°†æ—§çš„é¡µé¢è¿ç§»åˆ°æ–°çš„ä½ç½®</p>
<p><img src="https://i.loli.net/2021/11/30/q7T6EjtIb9PVFY3.png" srcset="/img/loading.gif" lazyload alt="ä»çŸ¥ä¹å·çš„å›¾.png"></p>
<p>ä½†<strong>å¹¶éæ‰€æœ‰çš„é¡µé¢éƒ½æ˜¯èƒ½å¤Ÿéšæ„è¿ç§»çš„</strong>ï¼Œå› æ­¤æˆ‘ä»¬åœ¨ buddy system å½“ä¸­è¿˜éœ€è¦å°†é¡µé¢æŒ‰ç…§è¿ç§»ç±»å‹è¿›è¡Œåˆ†ç±»</p>
<p>è¿ç§»ç±»å‹ç”±ä¸€ä¸ªæšä¸¾ç±»å‹å®šä¹‰ï¼Œå®šä¹‰äº <code>/include/linux/mmzone.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">migratetype</span> &#123;</span><br>	MIGRATE_UNMOVABLE,<br>	MIGRATE_MOVABLE,<br>	MIGRATE_RECLAIMABLE,<br>	MIGRATE_PCPTYPES,	<span class="hljs-comment">/* the number of types on the pcp lists */</span><br>	MIGRATE_HIGHATOMIC = MIGRATE_PCPTYPES,<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_CMA</span><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * MIGRATE_CMA migration type is designed to mimic the way</span><br><span class="hljs-comment">	 * ZONE_MOVABLE works.  Only movable pages can be allocated</span><br><span class="hljs-comment">	 * from MIGRATE_CMA pageblocks and page allocator never</span><br><span class="hljs-comment">	 * implicitly change migration type of MIGRATE_CMA pageblock.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * The way to use it is to change migratetype of a range of</span><br><span class="hljs-comment">	 * pageblocks to MIGRATE_CMA which can be done by</span><br><span class="hljs-comment">	 * __free_pageblock_cma() function.  What is important though</span><br><span class="hljs-comment">	 * is that a range of pageblocks must be aligned to</span><br><span class="hljs-comment">	 * MAX_ORDER_NR_PAGES should biggest page be bigger then</span><br><span class="hljs-comment">	 * a single pageblock.</span><br><span class="hljs-comment">	 */</span><br>	MIGRATE_CMA,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_MEMORY_ISOLATION</span><br>	MIGRATE_ISOLATE,	<span class="hljs-comment">/* can&#x27;t allocate from here */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	MIGRATE_TYPES<br>&#125;;<br></code></pre></td></tr></table></figure>

<ul>
<li><strong>MIGRATE_UNMOVABLE</strong>ï¼šè¿™ç±»å‹é¡µé¢åœ¨å†…å­˜å½“ä¸­æœ‰ç€å›ºå®šçš„ä½ç½®ï¼Œ<strong>ä¸èƒ½ç§»åŠ¨</strong></li>
<li><strong>MIGRATE_MOVABLE</strong>ï¼šè¿™ç±»é¡µé¢<strong>å¯ä»¥éšæ„ç§»åŠ¨</strong>ï¼Œä¾‹å¦‚ç”¨æˆ·ç©ºé—´çš„é¡µé¢ï¼Œæˆ‘ä»¬åªéœ€è¦å¤åˆ¶æ•°æ®åæ”¹å˜é¡µè¡¨æ˜ å°„å³å¯</li>
<li><strong>MIGRATE_RECLAIMABLE</strong>ï¼šè¿™ç±»é¡µé¢<strong>ä¸èƒ½ç›´æ¥ç§»åŠ¨ï¼Œä½†æ˜¯å¯ä»¥åˆ é™¤</strong>ï¼Œä¾‹å¦‚æ˜ å°„è‡ªæ–‡ä»¶çš„é¡µ</li>
<li><strong>MIGRATE_PCPTYPES</strong>ï¼š<code>per_cpu_pageset</code>ï¼Œå³æ¯ CPU é¡µå¸§ç¼“å­˜ï¼Œå…¶è¿ç§»<strong>ä»…é™äºåŒä¸€èŠ‚ç‚¹å†…</strong></li>
<li><strong>MIGRATE_CMA</strong>ï¼š<code>Contiguous Memory Allocator</code>ï¼Œå³<strong>è¿ç»­çš„ç‰©ç†å†…å­˜</strong></li>
<li><strong>MIGRATE_ISOLATE</strong>ï¼š<strong>ä¸èƒ½ä»è¯¥é“¾è¡¨åˆ†é…é¡µé¢</strong>ï¼Œè¯¥é“¾è¡¨ç”¨äºè·¨ NUMA èŠ‚ç‚¹è¿›è¡Œé¡µé¢ç§»åŠ¨ï¼Œå°†é¡µé¢ç§»åŠ¨åˆ°ä½¿ç”¨è¯¥é¡µé¢æœ€ä¸ºé¢‘ç¹çš„ CPU æ‰€å¤„èŠ‚ç‚¹</li>
<li><em>MIGRATE_TYPES_ï¼šè¡¨ç¤ºè¿ç§»ç±»å‹çš„æ•°ç›®ï¼Œ_å¹¶ä¸å­˜åœ¨è¿™ä¸€é“¾è¡¨</em></li>
</ul>
<p>ä»¥ <em>free_list[0]</em> ä½œä¸ºä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹ overviewï¼š</p>
<p><img src="https://i.loli.net/2021/11/30/sbNImKo6tBS5GUe.png" srcset="/img/loading.gif" lazyload alt="è‡ªå·±ç”»çš„å›¾.png"></p>
<h3 id="nr-freeï¼šç©ºé—²é¡µé¢ï¼ˆå—ï¼‰è®¡æ•°"><a href="#nr-freeï¼šç©ºé—²é¡µé¢ï¼ˆå—ï¼‰è®¡æ•°" class="headerlink" title="nr_freeï¼šç©ºé—²é¡µé¢ï¼ˆå—ï¼‰è®¡æ•°"></a>nr_freeï¼šç©ºé—²é¡µé¢ï¼ˆå—ï¼‰è®¡æ•°</h3><p>è¯¥å­—æ®µè®°å½•äº†åœ¨å½“å‰ free_area ä¸­çš„ç©ºé—²é¡µé¢å—çš„æ•°é‡ï¼Œå¯¹äº free_area[0] ä»¥å¤–çš„ free_area è€Œè¨€å…¶å•ä½å¹¶éæ˜¯å•ä¸ªé¡µæ¡†ï¼Œè€Œæ˜¯ä»¥_å†…å­˜å—_ä¸ºå•ä½</p>
<h1 id="0x02-é¡µçš„åˆ†é…"><a href="#0x02-é¡µçš„åˆ†é…" class="headerlink" title="0x02.é¡µçš„åˆ†é…"></a>0x02.é¡µçš„åˆ†é…</h1><p>buddy system æä¾›äº†ä¸€ç»„ç”¨ä»¥è¿›è¡Œé¡µé¢åˆ†é…çš„æ¥å£ï¼Œæ¥ä¸‹æ¥ç¬”è€…å°†ä»¥è‡ªåº•å‘ä¸Šçš„æ–¹å¼è¿›è¡Œæºç åˆ†æ</p>
<h2 id="ä¸€ã€GFPï¼ˆget-free-pageï¼‰æ ‡å¿—ä½"><a href="#ä¸€ã€GFPï¼ˆget-free-pageï¼‰æ ‡å¿—ä½" class="headerlink" title="ä¸€ã€GFPï¼ˆget free pageï¼‰æ ‡å¿—ä½"></a>ä¸€ã€GFPï¼ˆget free pageï¼‰æ ‡å¿—ä½</h2><blockquote>
<p>GFPæ ‡å¿—ä½è¿™ä¸€èŠ‚åŸºæœ¬ä¸Šæ¬è¿è‡ª<a target="_blank" rel="noopener" href="https://blog.csdn.net/yhb1047818384/article/details/112298996">è¿™ç¯‡æ–‡ç« </a></p>
</blockquote>
<p>åœ¨ kernel memory allocation ä¸­æˆ‘ä»¬ç»å¸¸èƒ½è§åˆ° <code>gfp_t</code> ç±»å‹ï¼Œå…¶è¡¨ç¤ºåˆ†é…æ—¶çš„æ ‡å¿—ä½ï¼Œå®šä¹‰åœ¨ <code>include/linux/gfp.h</code> ä¸­ï¼Œå¤§æ¦‚æœ‰å¦‚ä¸‹è¿™äº›å¯ç”¨æ ‡å¿—ä½ï¼š</p>
<ul>
<li><strong>å†…å­˜ç®¡ç†åŒºä¿®é¥°ç¬¦ (zone modifiers)</strong></li>
</ul>
<p>å†…å­˜ç®¡ç†åŒºä¿®é¥°ç¬¦ä¸»è¦æè¿°ä»å“ªäº›å†…å­˜ç®¡ç†åŒºæ¥åˆ†é…å†…å­˜</p>
<table>
<thead>
<tr>
<th align="left">flag</th>
<th align="left">description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">__GFP_DMA</td>
<td align="left">ä»ZONE_DMAåŒºä¸­åˆ†é…å†…å­˜</td>
</tr>
<tr>
<td align="left">__GFP_HIGNMEM</td>
<td align="left">ä»ZONE_HIGHMEMåŒºä¸­åˆ†é…å†…å­˜</td>
</tr>
<tr>
<td align="left">__GFP_DMA32</td>
<td align="left">ä»ZONE_DMA32åŒºä¸­åˆ†é…å†…å­˜</td>
</tr>
<tr>
<td align="left">__GFP_MOVABLE</td>
<td align="left">å†…å­˜è§„æ•´æ—¶å¯ä»¥è¿ç§»æˆ–å›æ”¶é¡µé¢</td>
</tr>
</tbody></table>
<ul>
<li><strong>ç§»åŠ¨å’Œæ›¿æ¢ä¿®é¥°ç¬¦(mobility and placement modifiers)</strong></li>
</ul>
<p>ç§»åŠ¨å’Œæ›¿æ¢ä¿®é¥°ç¬¦ä¸»è¦è¡¨ç¤ºåˆ†é…å‡ºæ¥çš„é¡µé¢å…·æœ‰çš„è¿ç§»å±æ€§</p>
<table>
<thead>
<tr>
<th align="left">flag</th>
<th align="left">description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">__GFP_RECLAIMABLE</td>
<td align="left">åˆ†é…çš„å†…å­˜é¡µé¢å¯ä»¥å›æ”¶</td>
</tr>
<tr>
<td align="left">__GFP_WRITE</td>
<td align="left">ç”³è¯·çš„é¡µé¢ä¼šè¢«å¼„æˆè„é¡µ</td>
</tr>
<tr>
<td align="left">__GFP_HARDWALL</td>
<td align="left">å¼ºåˆ¶ä½¿ç”¨cpusetå†…å­˜åˆ†é…ç­–ç•¥</td>
</tr>
<tr>
<td align="left">__GFP_THISNODE</td>
<td align="left">åœ¨æŒ‡å®šçš„èŠ‚ç‚¹ä¸Šåˆ†é…å†…å­˜</td>
</tr>
<tr>
<td align="left">__GFP_ACCOUNT</td>
<td align="left">kmemcgä¼šè®°å½•åˆ†é…è¿‡ç¨‹</td>
</tr>
</tbody></table>
<ul>
<li><strong>æ°´ä½ä¿®é¥°ç¬¦ ï¼ˆwatermark modifiersï¼‰</strong></li>
</ul>
<p>ä¸æ°´ä½çº¿ç›¸å…³çš„æ ‡å¿—ä½</p>
<table>
<thead>
<tr>
<th align="left">flag</th>
<th align="left">description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">__GFP_ATOMIC</td>
<td align="left">é«˜ä¼˜å…ˆçº§åˆ†é…å†…å­˜ï¼Œåˆ†é…å™¨å¯ä»¥åˆ†é…æœ€ä½è­¦æˆ’æ°´ä½çº¿ä¸‹çš„é¢„ç•™å†…å­˜</td>
</tr>
<tr>
<td align="left">__GFP_HIGH</td>
<td align="left">åˆ†é…å†…å­˜çš„è¿‡ç¨‹ä¸­ä¸å¯ä»¥ç¡çœ æˆ–æ‰§è¡Œé¡µé¢å›æ”¶åŠ¨ä½œ</td>
</tr>
<tr>
<td align="left">__GFP_MEMALLOC</td>
<td align="left">å…è®¸è®¿é—®æ‰€æœ‰çš„å†…å­˜</td>
</tr>
<tr>
<td align="left">__GFP_NOMEMALLOC</td>
<td align="left">ä¸å…è®¸è®¿é—®æœ€ä½è­¦æˆ’æ°´ä½çº¿ä¸‹çš„ç³»ç»Ÿé¢„ç•™å†…å­˜</td>
</tr>
</tbody></table>
<ul>
<li><strong>é¡µé¢å›æ”¶ä¿®é¥°ç¬¦ï¼ˆreclaim modifiers)</strong></li>
</ul>
<p>ä¸é¡µé¢å›æ”¶ç›¸å…³çš„æ ‡å¿—ä½</p>
<table>
<thead>
<tr>
<th align="left">flag</th>
<th align="left">description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">__GFP_IO</td>
<td align="left">å¯åŠ¨ç‰©ç†I&#x2F;Oä¼ è¾“</td>
</tr>
<tr>
<td align="left">__GFP_FS</td>
<td align="left">å…è®¸è°ƒç”¨åº•å±‚FSæ–‡ä»¶ç³»ç»Ÿã€‚å¯é¿å…åˆ†é…å™¨é€’å½’åˆ°å¯èƒ½å·²ç»æŒæœ‰é”çš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œ é¿å…æ­»é”</td>
</tr>
<tr>
<td align="left">__GFP_DIRECT_RECLAIM</td>
<td align="left">åˆ†é…å†…å­˜è¿‡ç¨‹ä¸­å¯ä»¥ä½¿ç”¨ç›´æ¥å†…å­˜å›æ”¶</td>
</tr>
<tr>
<td align="left">__GFP_KSWAPD_RECLAIM</td>
<td align="left">å†…å­˜åˆ°è¾¾ä½æ°´ä½æ—¶å”¤é†’kswapdçº¿ç¨‹å¼‚æ­¥å›æ”¶å†…å­˜</td>
</tr>
<tr>
<td align="left">__GFP_RECLAIM</td>
<td align="left">è¡¨ç¤ºæ˜¯å¦å¯ä»¥ç›´æ¥å†…å­˜å›æ”¶æˆ–è€…ä½¿ç”¨kswapdçº¿ç¨‹è¿›è¡Œå›æ”¶</td>
</tr>
<tr>
<td align="left">__GFP_RETRY_MAYFAIL</td>
<td align="left">åˆ†é…å†…å­˜å¯ä»¥å¯èƒ½ä¼šå¤±è´¥ï¼Œä½†æ˜¯åœ¨ç”³è¯·è¿‡ç¨‹ä¸­ä¼šå›æ”¶ä¸€äº›ä¸å¿…è¦çš„å†…å­˜ï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿå—ç›Š</td>
</tr>
<tr>
<td align="left">__GFP_NOFAIL</td>
<td align="left">å†…å­˜åˆ†é…å¤±è´¥åæ— é™åˆ¶çš„é‡å¤å°è¯•ï¼ŒçŸ¥é“åˆ†é…æˆåŠŸ</td>
</tr>
<tr>
<td align="left">__GFP_NORETRY</td>
<td align="left">ç›´æ¥é¡µé¢å›æ”¶æˆ–è€…å†…å­˜è§„æ•´åè¿˜æ˜¯æ— æ³•åˆ†é…å†…å­˜æ—¶ï¼Œä¸å¯ç”¨retryåå¤å°è¯•åˆ†é…å†…å­˜ï¼Œç›´æ¥è¿”å›NULL</td>
</tr>
</tbody></table>
<ul>
<li><strong>è¡Œä¸ºä¿®é¥°ç¬¦ (action modifiers)</strong></li>
</ul>
<p>ä¸åˆ†é…æ—¶çš„è¡Œä¸ºç›¸å…³çš„æ ‡å¿—ä½</p>
<table>
<thead>
<tr>
<th align="left">flag</th>
<th align="left">description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">__GFP_NOWARN</td>
<td align="left">å…³é—­å†…å­˜åˆ†é…è¿‡ç¨‹ä¸­çš„WARNING</td>
</tr>
<tr>
<td align="left">__GFP_COMP</td>
<td align="left">åˆ†é…çš„å†…å­˜é¡µé¢å°†è¢«ç»„åˆæˆå¤åˆé¡µcompound page</td>
</tr>
<tr>
<td align="left">__GFP_ZERO</td>
<td align="left">è¿”å›ä¸€ä¸ªå…¨éƒ¨å¡«å……ä¸º0çš„é¡µé¢</td>
</tr>
</tbody></table>
<ul>
<li><strong>ç»„åˆç±»å‹æ ‡å¿—(Useful GFP flag combinations)</strong></li>
</ul>
<p>å‰é¢æè¿°çš„ä¿®é¥°ç¬¦ç§è¿‡äºç¹å¤šï¼Œå› æ­¤linuxå®šä¹‰äº†ä¸€äº›ç»„åˆçš„ç±»å‹æ ‡å¿—ï¼Œä¾›å¼€å‘è€…ä½¿ç”¨ã€‚</p>
<table>
<thead>
<tr>
<th align="left">flag</th>
<th align="left">element</th>
<th align="left">description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">GFP_ATOMIC</td>
<td align="left">__GFP_HIGH |__GFP_ATOMIC |__GFP_KSWAPD_RECLAIM</td>
<td align="left">åˆ†é…è¿‡ç¨‹ä¸èƒ½ä¼‘çœ ï¼Œåˆ†é…å…·æœ‰é«˜ä¼˜å…ˆçº§ï¼Œå¯ä»¥è®¿é—®ç³»ç»Ÿé¢„ç•™å†…å­˜</td>
</tr>
<tr>
<td align="left">GFP_KERNEL</td>
<td align="left">__GFP_RECLAIM |__GFP_IO |__GFP_FS</td>
<td align="left">åˆ†é…å†…å­˜æ—¶å¯ä»¥è¢«é˜»å¡(å³ä¼‘çœ )</td>
</tr>
<tr>
<td align="left">GFP_KERNEL_ACCOUNT</td>
<td align="left">GFP_KERNEL |__GFP_ACCOUNT</td>
<td align="left">å’ŒGFP_KERNELä½œç”¨ä¸€æ ·ï¼Œä½†æ˜¯åˆ†é…çš„è¿‡ç¨‹ä¼šè¢«kmemcgè®°å½•</td>
</tr>
<tr>
<td align="left">GFP_NOWAIT</td>
<td align="left">__GFP_KSWAPD_RECLAIM</td>
<td align="left">åˆ†é…è¿‡ç¨‹ä¸­ä¸å…è®¸å› ç›´æ¥å†…å­˜å›æ”¶è€Œå¯¼è‡´åœé¡¿</td>
</tr>
<tr>
<td align="left">GFP_NOIO</td>
<td align="left">__GFP_RECLAIM</td>
<td align="left">ä¸éœ€è¦å¯åŠ¨ä»»ä½•çš„I&#x2F;Oæ“ä½œ</td>
</tr>
<tr>
<td align="left">GFP_NOFS</td>
<td align="left">__GFP_RECLAIM |__GFP_IO</td>
<td align="left">ä¸ä¼šæœ‰è®¿é—®ä»»ä½•æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œ</td>
</tr>
<tr>
<td align="left">GFP_USER</td>
<td align="left">__GFP_RECLAIM |__GFP_IO |__GFP_FS |__GFP_HARDWALL</td>
<td align="left">ç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹åˆ†é…å†…å­˜</td>
</tr>
<tr>
<td align="left">GFP_DMA</td>
<td align="left">__GFP_DMA</td>
<td align="left">ä»ZONE_DMAåŒºåˆ†é…å†…å­˜</td>
</tr>
<tr>
<td align="left">GFP_DMA32</td>
<td align="left">__GFP_DMA32</td>
<td align="left">ä»ZONE_DMA32åŒºåˆ†é…å†…å­˜</td>
</tr>
<tr>
<td align="left">GFP_HIGHUSER</td>
<td align="left">GFP_USER | __GFP_HIGHMEM</td>
<td align="left">ç”¨æˆ·è¿›ç¨‹åˆ†é…å†…å­˜ï¼Œä¼˜å…ˆä½¿ç”¨ZONE_HIGHMEMï¼Œ ä¸”è¿™äº›é¡µé¢ä¸å…è®¸è¿ç§»</td>
</tr>
<tr>
<td align="left">GFP_HIGHUSER_MOVABLE</td>
<td align="left">GFP_HIGHUSER | __GFP_MOVABLE</td>
<td align="left">å’ŒGFP_HIGHUSERç±»ä¼¼ï¼Œä½†æ˜¯é¡µé¢å¯ä»¥è¿ç§»</td>
</tr>
<tr>
<td align="left">GFP_TRANSHUGE_LIGHT</td>
<td align="left">GFP_HIGHUSER_MOVABLE | __GFP_COMP | __GFP_NOMEMALLOC | __GFP_NOWARN) &amp; ~__GFP_RECLAIM</td>
<td align="left">é€æ˜å¤§é¡µçš„å†…å­˜åˆ†é…ï¼Œ lightè¡¨ç¤ºä¸è¿›è¡Œå†…å­˜å‹ç¼©å’Œå›æ”¶</td>
</tr>
<tr>
<td align="left">GFP_TRANSHUGE</td>
<td align="left">GFP_TRANSHUGE_LIGHT | __GFP_DIRECT_RECLAIM</td>
<td align="left">å’ŒGFP_TRANSHUGE_LIGHTç±»ä¼¼ï¼Œé€šå¸¸khugepagedä½¿ç”¨è¯¥æ ‡å¿—</td>
</tr>
</tbody></table>
<h2 id="äºŒã€alloc-context-ç»“æ„ä½“ï¼šåˆ†é…çš„ä¸Šä¸‹æ–‡"><a href="#äºŒã€alloc-context-ç»“æ„ä½“ï¼šåˆ†é…çš„ä¸Šä¸‹æ–‡" class="headerlink" title="äºŒã€alloc_context ç»“æ„ä½“ï¼šåˆ†é…çš„ä¸Šä¸‹æ–‡"></a>äºŒã€alloc_context ç»“æ„ä½“ï¼šåˆ†é…çš„ä¸Šä¸‹æ–‡</h2><p>è¿™æ˜¯ä¸€ä¸ªåˆ†é…è¿‡ç¨‹ä¸­éå¸¸é‡è¦çš„ç»“æ„ä½“ï¼Œç”¨æ¥è¡¨ç¤ºæˆ‘ä»¬å•æ¬¡å†…å­˜åˆ†é…çš„ä¸Šä¸‹æ–‡ä¿¡æ¯</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ç”¨ä»¥ä¿å­˜åœ¨åˆ†é…æ—¶æ¶‰åŠåˆ°çš„å‡½æ•°é—´ä¼ é€’çš„</span><br><span class="hljs-comment"> * ç»å¤§éƒ¨åˆ†çš„ä¸å¯å˜çš„åˆ†é…å‚æ•°çš„ç»“æ„ä½“ï¼Œ</span><br><span class="hljs-comment"> * åŒ…æ‹¬ alloc_pages å‡½æ•°æ—</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * nodemask, migratetype ä¸ highest_zoneidx ä»…åœ¨</span><br><span class="hljs-comment"> * __alloc_pages_nodemask() ä¸­è¢«åˆå§‹åŒ–ä¸€æ¬¡ï¼Œä¹‹åä¸å†æ”¹å˜.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * zonelist, preferred_zone ä¸ highest_zoneidx æœ€åˆåœ¨</span><br><span class="hljs-comment"> * __alloc_pages_nodemask() ä¸­ä¸ºå¿«é€Ÿè·¯å¾„è®¾ç½®, ä¹‹åå¯èƒ½ä¼šåœ¨</span><br><span class="hljs-comment"> * __alloc_pages_slowpath() ä¸­è¢«æ”¹å˜. å…¶ä»–æ‰€æœ‰çš„å‡½æ•°é€šè¿‡</span><br><span class="hljs-comment"> * å¸¸é‡æŒ‡é’ˆä¼ é€’è¯¥ç»“æ„ä½“ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">alloc_context</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zonelist</span> *<span class="hljs-title">zonelist</span>;</span><br>	<span class="hljs-type">nodemask_t</span> *nodemask;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zoneref</span> *<span class="hljs-title">preferred_zoneref</span>;</span><br>	<span class="hljs-type">int</span> migratetype;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * highest_zoneidx è¡¨ç¤ºåˆ†é…è¯·æ±‚ä¸­æœ€é«˜çš„å¯ç”¨ zone çš„ä¸‹æ ‡ã€‚</span><br><span class="hljs-comment">	 * ç”±äº zone çš„æ€§è´¨, ç›¸è¾ƒäº highest_zoneidxï¼Œ</span><br><span class="hljs-comment">	 * åœ¨æ›´ä½çš„ zone ä¸Šçš„å†…å­˜ä¼šç”± lowmem_reserve[highest_zoneidx] ä¿æŠ¤ã€‚</span><br><span class="hljs-comment">	 * è¯‘æ³¨ï¼šå°±æ˜¯æ°´ä½çº¿æœºåˆ¶ï¼Œä¸è®°å¾—çš„å›å»çœ‹ä¸Šä¸€ç¯‡æ–‡ç« </span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * highest_zoneidx åŒæ ·è¢«å›æ”¶/å‹ç¼©ä½¿ç”¨ä»¥é™åˆ¶ç›®æ ‡ zoneï¼Œ</span><br><span class="hljs-comment">	 * å› ä¸ºé«˜äºè¯¥ä¸‹æ ‡çš„ zone æ— æ³•ç”¨äºæ­¤åˆ†é…è¯·æ±‚</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">zone_type</span> <span class="hljs-title">highest_zoneidx</span>;</span><br>	<span class="hljs-type">bool</span> spread_dirty_pages;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä¸»è¦å…³æ³¨å¦‚ä¸‹æˆå‘˜ï¼š</p>
<ul>
<li>zonelist</li>
</ul>
<p>è¯¥æˆå‘˜è¡¨ç¤ºåœ¨<strong>è¿™ä¸€æ¬¡çš„åˆ†é…ä¸Šä¸‹æ–‡</strong>ä¸­ï¼Œæˆ‘ä»¬å°†è¦æ“ä½œçš„ zone çš„<strong>åˆ—è¡¨</strong>ï¼Œå…¶ä¸ºä¸€ä¸ª <code>zonelist</code> ç±»å‹çš„<strong>ç»“æ„ä½“æ•°ç»„</strong>ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å•æ¬¡åˆ†é…è¯·æ±‚åœ¨ä¸€ä¸ª zonelist ä¸Šæ“ä½œ. ä¸€ä¸ª zonelist ä¾¿æ˜¯ä¸€ç»„ zone çš„åˆ—è¡¨ï¼Œ</span><br><span class="hljs-comment"> * å…¶ä¸­ç¬¬ä¸€ä¸ª zone ä¸ºåˆ†é…çš„â€œç›®æ ‡â€ï¼Œè€Œå…¶ä»–çš„ zone ä¸ºåå¤‡çš„zoneï¼Œä¼˜å…ˆçº§é™ä½ã€‚</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ä¸ºäº†æé«˜ zonelist çš„è¯»å–é€Ÿåº¦, åœ¨ zonerefs ä¸­åŒ…å«æ­£åœ¨è¢«è¯»å–çš„ entry çš„ zone indexã€‚</span><br><span class="hljs-comment"> * ç”¨æ¥è®¿é—®æ‰€ç»™çš„ zoneref ç»“æ„ä½“ä¿¡æ¯çš„å¸®åŠ©å‡½æ•°æœ‰ï¼š</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * zonelist_zone()	- è¿”å›ä¸€ä¸ª struct zone çš„æŒ‡é’ˆä½œä¸º _zonerefs ä¸­çš„ä¸€ä¸ª entry</span><br><span class="hljs-comment"> * zonelist_zone_idx()	- è¿”å›ä½œä¸º entry çš„ zone çš„ index</span><br><span class="hljs-comment"> * zonelist_node_idx()	- è¿”å›ä½œä¸º entry çš„ node çš„ index</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zonelist</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zoneref</span> _<span class="hljs-title">zonerefs</span>[<span class="hljs-title">MAX_ZONES_PER_ZONELIST</span> + 1];</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°çš„æ˜¯å…¶ä¸ºä¸€ä¸ª  <code>zoneref</code> ç±»å‹çš„ç»“æ„ä½“æ•°ç»„ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼ŒåŒ…å«äº†ä¸€ä¸ª zone çš„æŒ‡é’ˆä»¥åŠä¸€ä¸ª indexï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è¯¥ç»“æ„åŒ…å«äº† zonelist ä¸­ä¸€ä¸ª zone çš„ä¿¡æ¯ã€‚ </span><br><span class="hljs-comment"> * å…¶è¢«å‚¨å­˜åœ¨è¿™é‡Œä»¥é¢„é˜²å¯¹å¤§ç»“æ„ä½“çš„è§£å¼•ç”¨ä¸å¯¹è¡¨çš„æŸ¥è¯¢ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zoneref</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zone</span> *<span class="hljs-title">zone</span>;</span>	<span class="hljs-comment">/* æŒ‡å‘å®é™…ä¸Šçš„ zone çš„æŒ‡é’ˆ */</span><br>	<span class="hljs-type">int</span> zone_idx;		<span class="hljs-comment">/* zone_idx(zoneref-&gt;zone) */</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<ul>
<li>preferred_zoneref</li>
</ul>
<p>è¯¥æˆå‘˜ä¸ºä¸€ä¸ª <code>zoneref</code> ç±»å‹çš„ç»“æ„ä½“ï¼Œè¡¨ç¤º<strong>ä¼˜å…ˆç”¨æ¥è¿›è¡Œåˆ†é…çš„ zone</strong></p>
<ul>
<li>spread_dirty_pages</li>
</ul>
<p>å¸ƒå°”å€¼ï¼Œè¡¨ç¤º<strong>æ­¤æ¬¡åˆ†é…æ˜¯å¦å¯èƒ½äº§ç”Ÿè„é¡µ</strong>ï¼ˆéœ€è¦è¿›è¡Œå†™å›ï¼‰ï¼Œé€šå¸¸åˆ†é…éœ€è¦å†™å…¥çš„é¡µä¼šå‡ºç°</p>
<h2 id="ä¸‰ã€-alloc-pages-nodemask-ï¼šåˆ†é…é¡µé¢çš„ã€Œæ ¸å¿ƒå‡½æ•°ã€ï¼Œè¿”å›-page-ç»“æ„ä½“"><a href="#ä¸‰ã€-alloc-pages-nodemask-ï¼šåˆ†é…é¡µé¢çš„ã€Œæ ¸å¿ƒå‡½æ•°ã€ï¼Œè¿”å›-page-ç»“æ„ä½“" class="headerlink" title="ä¸‰ã€__alloc_pages_nodemask()ï¼šåˆ†é…é¡µé¢çš„ã€Œæ ¸å¿ƒå‡½æ•°ã€ï¼Œè¿”å› page ç»“æ„ä½“"></a>ä¸‰ã€__alloc_pages_nodemask()ï¼šåˆ†é…é¡µé¢çš„ã€Œæ ¸å¿ƒå‡½æ•°ã€ï¼Œè¿”å› page ç»“æ„ä½“</h2><p>è¯¥å‡½æ•°æ˜¯ buddy system ä¸­ç”¨ä»¥è¿›è¡Œé¡µé¢åˆ†é…çš„<strong>æ ¸å¿ƒå‡½æ•°</strong>ï¼Œæ‰€æœ‰çš„é¡µé¢åˆ†é… API éƒ½æ˜¯åŸºäºè¯¥å‡½æ•°çš„å°è£…ï¼Œå…¶éœ€è¦ä¼ å…¥çš„å››ä¸ªå‚æ•°ä¸ºï¼š</p>
<ul>
<li><code>gfp_mask</code>ï¼šåˆ†é…è¡Œä¸ºå‚æ•°ï¼ˆå¯ä»¥å‚è§ <a target="_blank" rel="noopener" href="https://blog.csdn.net/choumin/article/details/109603011">è¿™é‡Œ</a>ï¼‰</li>
<li><code>order</code>ï¼šåˆ†é…çš„è¿ç»­ç‰©ç†é¡µæ¡†çš„é˜¶</li>
<li><code>preferred_nid</code> é€‰å–çš„èŠ‚ç‚¹çš„ id</li>
<li><code>nodemask</code>ï¼š</li>
</ul>
<p>è¿”å›å€¼ä¸ºåˆ†é…çš„<strong>è¿ç»­ç‰©ç†é¡µ</strong>ä¸­çš„ç¬¬ä¸€å¼ ç‰©ç†é¡µçš„ <code>page</code> ç»“æ„ä½“</p>
<blockquote>
<p>å¦‚æœä½ å·²ç»ä¸è®°å¾— page ç»“æ„ä½“ä¸ç‰©ç†é¡µçš„é¡µæ¡†å·é—´çš„è½¬æ¢å…¬å¼äº†ï¼Œå¯ä»¥å›å»çœ‹<a target="_blank" rel="noopener" href="http://localhost:4000/2021/11/28/OS-0X02-LINUX-KERNEL-MEMORY-5.11-PART-I/#%EF%BC%881%EF%BC%89page-%E7%BB%93%E6%9E%84%E4%BD%93%E5%88%B0-PFN%EF%BC%9Apage-%E7%BB%93%E6%9E%84%E4%BD%93%E5%9C%B0%E5%9D%80%E5%87%8F%E5%8E%BB%E5%AF%B9%E5%BA%94-mem-section-gt-section-mem-map">ä¸Šä¸€ç¯‡æ–‡ç« </a></p>
<p>å½“ç„¶ï¼Œç¬”è€…æ¯”è¾ƒå¥½å¿ƒï¼ˆç¬‘ï¼‰ï¼Œè¿™é‡Œç›´æ¥ç»™å‡ºè®¡ç®—å…¬å¼ï¼Œ<code>mem_section</code> ç»“æ„ä½“ä¸­çš„ <code>section_mem_map</code> æˆå‘˜å­˜å‚¨äº†å…¶èµ·å§‹åœ°å€å‡æ‰å…¶èµ·å§‹åœ°å€å¯¹åº”çš„ç‰©ç†é¡µæ¡†çš„é¡µæ¡†å·çš„å·®å€¼ï¼Œè¯¥æˆå‘˜ä¸ page ç»“æ„ä½“é—´åš<strong>æŒ‡é’ˆå·®å€¼è¿ç®—</strong>ä¾¿èƒ½è·å¾— page ç»“æ„ä½“å¯¹åº”çš„ç‰©ç†é¡µæ¡†å·ï¼š<br>$$<br>address_{struct\ page} - section_mem_map &#x3D; address_{struct\ page} - (address_{mem_map} - start_PFN)\<br>&#x3D;(address_{struct\ page} - address_{mem_map}) + start_PFN<br>\<br>&#x3D;PFN<br>$$</p>
</blockquote>
<p>è¿™æ˜¯ä¸€å¼ _Overview_</p>
<p><img src="https://i.loli.net/2021/11/30/9srbaMvWeTSO1hc.png" srcset="/img/loading.gif" lazyload alt="ä»çŸ¥ä¹å·çš„.png"></p>
<p>è¯¥å‡½æ•°å®šä¹‰äº <code>/mm/page_alloc.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * This is the &#x27;heart&#x27; of the zoned buddy allocator.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *</span><br><span class="hljs-class">__<span class="hljs-title">alloc_pages_nodemask</span>(<span class="hljs-title">gfp_t</span> <span class="hljs-title">gfp_mask</span>, <span class="hljs-title">unsigned</span> <span class="hljs-title">int</span> <span class="hljs-title">order</span>, <span class="hljs-title">int</span> <span class="hljs-title">preferred_nid</span>,</span><br><span class="hljs-class">							<span class="hljs-title">nodemask_t</span> *<span class="hljs-title">nodemask</span>)</span><br><span class="hljs-class">&#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> alloc_flags = ALLOC_WMARK_LOW;<br>	<span class="hljs-type">gfp_t</span> alloc_mask; <span class="hljs-comment">/* å®é™…ç”¨äºåˆ†é…çš„ gfp_t ï¼Œè¿™æ˜¯ä¸€ä¸ªintç±»å‹çš„æ•´å‹*/</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">alloc_context</span> <span class="hljs-title">ac</span> =</span> &#123; &#125;;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * æˆ‘ä»¬å‡å®š order çš„å€¼åœ¨ä¸€äº›åœ°æ–¹æ˜¯æ­£å¸¸çš„ï¼Œ</span><br><span class="hljs-comment">	 * å› æ­¤è‹¥è¯·æ±‚è¶…å‡ºèŒƒå›´åˆ™æå‰é€€å‡º</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (unlikely(order &gt;= MAX_ORDER)) &#123;<br>		WARN_ON_ONCE(!(gfp_mask &amp; __GFP_NOWARN));<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>	&#125;<br><br>	gfp_mask &amp;= gfp_allowed_mask;<br>	alloc_mask = gfp_mask;<br>	<span class="hljs-keyword">if</span> (!prepare_alloc_pages(gfp_mask, order, preferred_nid, nodemask, &amp;ac, &amp;alloc_mask, &amp;alloc_flags))<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * ç›´åˆ°æ‰€æœ‰çš„ local zone éƒ½è¢«è€ƒè™‘ä¹‹å‰ï¼Œ</span><br><span class="hljs-comment">	 * ç¦æ­¢ä» falling back åˆ°å†…å­˜ç¢ç‰‡ç§ç±»çš„ç¬¬ä¸€æ¬¡ä¼ é€’</span><br><span class="hljs-comment">	 */</span><br>	alloc_flags |= alloc_flags_nofragment(ac.preferred_zoneref-&gt;zone, gfp_mask);<br><br>	<span class="hljs-comment">/* ç¬¬ä¸€æ¬¡åˆ†é…å°è¯• */</span><br>	page = get_page_from_freelist(alloc_mask, order, alloc_flags, &amp;ac);<br>	<span class="hljs-keyword">if</span> (likely(page))<br>		<span class="hljs-keyword">goto</span> out;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * åº”ç”¨ä½œç”¨åŸŸåˆ†é…çº¦æŸ è¿™ä¸»è¦ä¸ GFP_NOFS æœ‰å…³ã€‚</span><br><span class="hljs-comment">	 * GFP_NOIO å¿…é¡»ä»ä¸€ä¸ªç‰¹å®šçš„ç”± memalloc_no&#123;fs,io&#125;_&#123;save,restore&#125;</span><br><span class="hljs-comment">	 * æ‰€æ ‡è®°çš„ä¸Šä¸‹æ–‡ä¸­æ‰€æœ‰çš„åˆ†é…è¯·æ±‚ä¸­ç»§æ‰¿</span><br><span class="hljs-comment">	 */</span><br>	alloc_mask = current_gfp_context(gfp_mask);<br>	ac.spread_dirty_pages = <span class="hljs-literal">false</span>;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * æ¢å¤æœ€åˆçš„ nodemask ï¼ˆå…¶å¯èƒ½è¢«æ›¿æ¢ä¸º &amp;cpuset_current_mems_allowed</span><br><span class="hljs-comment">	 * ä»¥ä¼˜åŒ–å¿«é€Ÿï¼ˆåˆ†é…ï¼‰è·¯å¾„çš„å°è¯•ï¼‰</span><br><span class="hljs-comment">	 */</span><br>	ac.nodemask = nodemask;<br><br>	page = __alloc_pages_slowpath(alloc_mask, order, &amp;ac);<br><br>out:<br>	<span class="hljs-keyword">if</span> (memcg_kmem_enabled() &amp;&amp; (gfp_mask &amp; __GFP_ACCOUNT) &amp;&amp; page &amp;&amp;<br>	    unlikely(__memcg_kmem_charge_page(page, gfp_mask, order) != <span class="hljs-number">0</span>)) &#123;<br>		__free_pages(page, order);<br>		page = <span class="hljs-literal">NULL</span>;<br>	&#125;<br><br>	trace_mm_page_alloc(page, order, alloc_mask, ac.migratetype);<br><br>	<span class="hljs-keyword">return</span> page;<br>&#125;<br>EXPORT_SYMBOL(__alloc_pages_nodemask);<br></code></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°çš„å…·ä½“æ­¥éª¤ä¸»è¦åˆ†ä¸ºä¸‰æ­¥ï¼š</p>
<ul>
<li>æ£€æŸ¥å‚æ•°åˆæ³•æ€§ï¼Œå¹¶åšåˆ†é…å‰å‡†å¤‡å·¥ä½œ</li>
<li>è¿›è¡Œ<strong>å¿«é€Ÿåˆ†é…</strong>ï¼ŒæˆåŠŸåˆ™ç›´æ¥è¿”å›ç»“æœ</li>
<li>è‹¥å¿«é€Ÿåˆ†é…å¤±è´¥ï¼Œåˆ™è¿›è¡Œ<strong>æ…¢é€Ÿåˆ†é…</strong></li>
</ul>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥æ·±å…¥å¿«é€Ÿåˆ†é…ä¸æ…¢é€Ÿåˆ†é…çš„å†…éƒ¨ç»†èŠ‚</p>
<h3 id="I-prepare-alloc-pages-ï¼šåˆ†é…å‰çš„å‡†å¤‡å·¥ä½œ"><a href="#I-prepare-alloc-pages-ï¼šåˆ†é…å‰çš„å‡†å¤‡å·¥ä½œ" class="headerlink" title="I. prepare_alloc_pages()ï¼šåˆ†é…å‰çš„å‡†å¤‡å·¥ä½œ"></a>I. prepare_alloc_pages()ï¼šåˆ†é…å‰çš„å‡†å¤‡å·¥ä½œ</h3><p>è¿™ä¸ªå‡½æ•°æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯åšåˆ†é…å‰çš„ä¸€äº›å‡†å¤‡çš„å·¥ä½œï¼ŒåŒ…æ‹¬åˆå§‹åŒ– <code>alloc_context</code> ç»“æ„ä½“ã€è·å– zone æ•°ç»„ç­‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">prepare_alloc_pages</span><span class="hljs-params">(<span class="hljs-type">gfp_t</span> gfp_mask, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order,</span><br><span class="hljs-params">		<span class="hljs-type">int</span> preferred_nid, <span class="hljs-type">nodemask_t</span> *nodemask,</span><br><span class="hljs-params">		<span class="hljs-keyword">struct</span> alloc_context *ac, <span class="hljs-type">gfp_t</span> *alloc_mask,</span><br><span class="hljs-params">		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *alloc_flags)</span><br>&#123;<br>	ac-&gt;highest_zoneidx = gfp_zone(gfp_mask);<br>	ac-&gt;zonelist = node_zonelist(preferred_nid, gfp_mask); <span class="hljs-comment">// è·å– zonelist</span><br>	ac-&gt;nodemask = nodemask;<br>	ac-&gt;migratetype = gfp_migratetype(gfp_mask);<br><br>    <span class="hljs-comment">// è‹¥å¼€å¯äº† cpusetï¼ˆé™åˆ¶æŸä¸€ç»„è¿›ç¨‹åªè¿è¡Œåœ¨æŸäº›cpuå’Œå†…å­˜èŠ‚ç‚¹ä¸Šï¼‰ï¼Œåˆ™è®¾ç½®å¯¹åº”çš„æ ‡å¿—ä½ã€‚</span><br>	<span class="hljs-keyword">if</span> (cpusets_enabled()) &#123;<br>		*alloc_mask |= __GFP_HARDWALL;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * è‹¥æˆ‘ä»¬åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­, åˆ™è¿™ä¸å½“å‰è¿›ç¨‹ä¸Šä¸‹æ–‡æ— å…³ã€‚</span><br><span class="hljs-comment">		 * è¿™æ„å‘³ç€ä»»ä¸€ node éƒ½æ˜¯ ok çš„.</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (!in_interrupt() &amp;&amp; !ac-&gt;nodemask)<br>			ac-&gt;nodemask = &amp;cpuset_current_mems_allowed;<br>		<span class="hljs-keyword">else</span><br>			*alloc_flags |= ALLOC_CPUSET;<br>	&#125;<br><br>	fs_reclaim_acquire(gfp_mask);<br>	fs_reclaim_release(gfp_mask);<br><br>	might_sleep_if(gfp_mask &amp; __GFP_DIRECT_RECLAIM);<br><br>	<span class="hljs-keyword">if</span> (should_fail_alloc_page(gfp_mask, order))<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>	*alloc_flags = current_alloc_flags(gfp_mask, *alloc_flags);<br><br>	<span class="hljs-comment">/* Dirty zone çš„å¹³è¡¡ä»…åœ¨ fast path ä¸­å®Œæˆ */</span><br>	ac-&gt;spread_dirty_pages = (gfp_mask &amp; __GFP_WRITE);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * preferred zone è¢«ç”¨äºè¿›è¡Œæ•°æ®ç»Ÿè®¡ï¼Œ ä½†éå¸¸é‡è¦çš„æ˜¯å…¶é¡µè¢«ç”¨ä½œ</span><br><span class="hljs-comment">	 * zonelist è¿­ä»£å™¨çš„èµ·å§‹ç‚¹. å¯¹äºå¿½ç•¥å†…å­˜ç­–ç•¥çš„åˆ†é…ï¼Œå…¶å¯èƒ½ä¼šè¢«é‡ç½®ã€‚</span><br><span class="hljs-comment">	 */</span><br>	ac-&gt;preferred_zoneref = first_zones_zonelist(ac-&gt;zonelist,<br>					ac-&gt;highest_zoneidx, ac-&gt;nodemask);<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>é¦–å…ˆè°ƒç”¨ <code>node_zonelist()</code> ä» <code>preferred_nid</code> å‚æ•°æ‰€æŒ‡å®šçš„ node ä¸­è·å–ä¸€ä¸ª zonelistï¼Œå…¶å®å°±æ˜¯å– <code>pglist_data-&gt;node_zonelists[gfp_zonelist(flags)]</code></li>
<li>è¿›è¡Œ cpuset ç›¸å…³åˆ¤æ–­ä¸æ ‡å¿—ä½è®¾ç½®ï¼Œè‹¥æ˜¯åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡åˆ™ç›´æ¥å°† nodemask è®¾ä¸º <code>cpuset_current_mems_allowed</code></li>
<li>æœ€åè°ƒç”¨ <code>first_zones_zonelist()</code> è®¾ç½® preferred zoneï¼Œå¤§æ¦‚æ˜¯åœ¨ zonelist ä¸­â†’nodemask æ‰€åŒ…å«çš„ zone ä¸­â†’ <code>highest_zoneidx</code> ä»¥ä¸‹çš„ç¬¬ä¸€ä¸ª zone</li>
</ul>
<blockquote>
<p>åæ­£æºç æ³¨é‡Šæ˜¯è¿™ä¹ˆå†™çš„hhh</p>
</blockquote>
<h3 id="II-get-page-from-freelist-ï¼šå¿«é€Ÿåˆ†é…è·¯å¾„ï¼ˆæ ¸å¿ƒåˆ†é…å‡½æ•°ï¼‰"><a href="#II-get-page-from-freelist-ï¼šå¿«é€Ÿåˆ†é…è·¯å¾„ï¼ˆæ ¸å¿ƒåˆ†é…å‡½æ•°ï¼‰" class="headerlink" title="II. get_page_from_freelist()ï¼šå¿«é€Ÿåˆ†é…è·¯å¾„ï¼ˆæ ¸å¿ƒåˆ†é…å‡½æ•°ï¼‰"></a>II. get_page_from_freelist()ï¼šå¿«é€Ÿåˆ†é…è·¯å¾„ï¼ˆæ ¸å¿ƒåˆ†é…å‡½æ•°ï¼‰</h3><p>è¯¥å‡½æ•°å®šä¹‰äº <code>/mm/page_alloc.c</code> ä¸­ï¼Œä¸»è¦æ˜¯éå†åˆ†é…ä¸Šä¸‹æ–‡å¯¹åº”çš„ zonelist ä¸­çš„ zone è¿›è¡Œå†…å­˜åˆ†é…ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * get_page_from_freelist éå† zonelist å°è¯•åˆ†é…é¡µé¢</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> page *<br><span class="hljs-title function_">get_page_from_freelist</span><span class="hljs-params">(<span class="hljs-type">gfp_t</span> gfp_mask, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order, <span class="hljs-type">int</span> alloc_flags,</span><br><span class="hljs-params">						<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> alloc_context *ac)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zoneref</span> *<span class="hljs-title">z</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zone</span> *<span class="hljs-title">zone</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pglist_data</span> *<span class="hljs-title">last_pgdat_dirty_limit</span> =</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-type">bool</span> no_fallback;<br><br>retry:<br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * æ‰«æ zonelist, å¯»æ‰¾æœ‰ç€è¶³å¤Ÿç©ºé—²é¡µé¢çš„ zone.</span><br><span class="hljs-comment">	 * å‚è§ __cpuset_node_allowed() çš„æ³¨é‡Šï¼ˆkernel/cpuset.cï¼‰</span><br><span class="hljs-comment">	 */</span><br>	no_fallback = alloc_flags &amp; ALLOC_NOFRAGMENT; <span class="hljs-comment">// é¿å…å†…å­˜ç¢ç‰‡çš„flag</span><br>	z = ac-&gt;preferred_zoneref; <span class="hljs-comment">// å…ˆå°è¯•ä» preferred zone ä¸­åˆ†é…</span><br>    <span class="hljs-comment">// è¿™æ˜¯ä¸€ä¸ªå°è£…å®ï¼Œè¡¨ç¤ºä» z å¼€å§‹éå† zonelist ä¸­çš„ zoneref æ•°ç»„ï¼Œ</span><br>    <span class="hljs-comment">// å…¶æ ¸å¿ƒæ˜¯å•æ¬¡è¿­ä»£è°ƒç”¨ next_zones_zonelist()ï¼Œè¯¥å‡½æ•°è¿”å›:</span><br>    <span class="hljs-comment">// 		åœ¨ nodemask çš„ zone ä¸­ï¼Œä»¥å½“å‰ zone ä½œä¸ºèµ·ç‚¹æ¸¸æ ‡çš„</span><br>    <span class="hljs-comment">// 		ã€ä½äºæˆ–ä½äºã€‘highest_zoneidx çš„ä¸‹ä¸€ä¸ª zone</span><br>	for_next_zone_zonelist_nodemask(zone, z, ac-&gt;highest_zoneidx,<br>					ac-&gt;nodemask) &#123;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> mark;<br><br>        <span class="hljs-comment">// å¼€å¯äº† cpuset ä¸” flag ä¸­æœ‰ ALLOC_CPUSET æ ‡å¿—ä½ï¼Œ</span><br>        <span class="hljs-comment">// ä½†æ˜¯ cpuset ä¸­ä¸å…è®¸ä»¥è¯¥ gfp_mask åœ¨è¯¥ zone ä¸­åˆ†é…ï¼Œ</span><br>        <span class="hljs-comment">// è¿›è¡Œä¸‹ä¸€æ¬¡è¿­ä»£</span><br>		<span class="hljs-keyword">if</span> (cpusets_enabled() &amp;&amp;<br>			(alloc_flags &amp; ALLOC_CPUSET) &amp;&amp;<br>			!__cpuset_zone_allowed(zone, gfp_mask))<br>				<span class="hljs-keyword">continue</span>;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * åœ¨åˆ†é…é¡µç¼“å­˜ï¼ˆpage cacheï¼‰é¡µä»¥è¿›è¡Œå†™å…¥æ—¶, æˆ‘ä»¬æƒ³è¦</span><br><span class="hljs-comment">		 * åœ¨ä¸€ä¸ªèŠ‚ç‚¹çš„â€œè„é™åˆ¶â€ï¼ˆdirty limitï¼‰å†…è·å¾—ä»–, </span><br><span class="hljs-comment">         * ç”±æ­¤ï¼Œæ²¡æœ‰ä¸€ä¸ªèŠ‚ç‚¹æœ‰ç€è¶…è¿‡å…¨å±€å…è®¸çš„è„é¡µæ¯”ä¾‹ã€‚</span><br><span class="hljs-comment">		 * è„é™åˆ¶è€ƒè™‘äº†èŠ‚ç‚¹çš„ä½ç«¯å†…å­˜ä¿ç•™å’Œé«˜æ°´ä½çº¿ï¼Œ</span><br><span class="hljs-comment">		 * ä»¥ä¾¿äº kswapd èƒ½å¹³è¡¡å®ƒï¼Œè€Œä¸å¿…ä»å…¶ LRU åˆ—è¡¨ä¸­å†™å…¥é¡µé¢ã€‚</span><br><span class="hljs-comment">		 *</span><br><span class="hljs-comment">		 * <span class="hljs-doctag">XXX:</span> ç°åœ¨, åœ¨è¿›å…¥å›æ”¶ä¹‹å‰ï¼Œ</span><br><span class="hljs-comment">		 * å…è®¸åˆ†é…å¯èƒ½è¶…è¿‡ æ…¢é€Ÿè·¯å¾„ä¸­ (spread_dirty_pages unset)</span><br><span class="hljs-comment">		 * å•èŠ‚ç‚¹çš„ dirty limitï¼Œè¿™åœ¨ä¸€ä¸ªå…è®¸èŠ‚ç‚¹ä»¬åœ¨ä¸€èµ·éƒ½æœªå¤Ÿå¤§ä»¥è¾¾åˆ°å…¨å±€é™åˆ¶</span><br><span class="hljs-comment">         * çš„ NUMA è®¾ç½®ä¸­æ˜¯å¾ˆé‡è¦çš„ã€‚å¯¹äºè¿™äº›æƒ…å†µçš„åˆé€‚çš„ä¿®è¡¥å°†éœ€è¦å¯¹</span><br><span class="hljs-comment">		 * dirty-throttling ä¸ flusher threads ä¸­èŠ‚ç‚¹çš„æ„è¯†.</span><br><span class="hljs-comment">		 */</span><br>        <span class="hljs-comment">// è¯‘æ³¨ï¼šåŸæ–‡å°±æ˜¯XXXï¼Œç¬”è€…ä¹Ÿä¸çŸ¥é“è¿™ä¸ªXXXæ˜¯ä»€ä¹ˆ...</span><br>        <span class="hljs-comment">// å¤§æ¦‚å°±æ˜¯æ£€æŸ¥å½“å‰zoneå¯¹åº”nodeçš„è„é¡µæ•°é‡æ˜¯ä¸æ˜¯è¾¾åˆ°é™åˆ¶äº†</span><br>		<span class="hljs-keyword">if</span> (ac-&gt;spread_dirty_pages) &#123;<br>			<span class="hljs-keyword">if</span> (last_pgdat_dirty_limit == zone-&gt;zone_pgdat)<br>				<span class="hljs-keyword">continue</span>;<br><br>			<span class="hljs-keyword">if</span> (!node_dirty_ok(zone-&gt;zone_pgdat)) &#123;<br>				last_pgdat_dirty_limit = zone-&gt;zone_pgdat;<br>				<span class="hljs-keyword">continue</span>;<br>			&#125;<br>		&#125;<br><br>        <span class="hljs-comment">// node æ•°é‡å¤§äº1ï¼Œä¸”å½“å‰ zone å¹¶é preferred zone</span><br>		<span class="hljs-keyword">if</span> (no_fallback &amp;&amp; nr_online_nodes &gt; <span class="hljs-number">1</span> &amp;&amp;<br>		    zone != ac-&gt;preferred_zoneref-&gt;zone) &#123;<br>			<span class="hljs-type">int</span> local_nid;<br><br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * è‹¥ç§»åŠ¨åˆ°äº† remote nodeï¼ˆè¯‘æ³¨ï¼šéå½“å‰nodeï¼Ÿï¼‰, åˆ™é‡è¯•ï¼Œ</span><br><span class="hljs-comment">			 * ä½†å…è®¸ fragmenting fallbacks. å±€éƒ¨æ€§æ¯”é¿å…ç¢ç‰‡æ›´åŠ é‡è¦ã€‚</span><br><span class="hljs-comment">			 */</span><br>            <span class="hljs-comment">// æ¯”å¯¹å½“å‰ zone æ˜¯å¦åœ¨ local nodeï¼ˆå°±æ˜¯ç¦»å½“å‰CPUæœ€è¿‘é‚£ä¸ª nodeï¼‰</span><br>            <span class="hljs-comment">// è‹¥å¦ï¼Œåˆ™å»æ‰ ALLOC_NOFRAGMENT æ ‡å¿—ä½ï¼Œå¹¶ä» preferred zone å¼€å§‹é‡è¯•ã€‚</span><br>            <span class="hljs-comment">// å³ï¼škernel æ›´å€¾å‘äºä¼˜å…ˆä» local zone è¿›è¡Œåˆ†é…ï¼Œå“ªæ€•ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡</span><br>			local_nid = zone_to_nid(ac-&gt;preferred_zoneref-&gt;zone);<br>			<span class="hljs-keyword">if</span> (zone_to_nid(zone) != local_nid) &#123;<br>				alloc_flags &amp;= ~ALLOC_NOFRAGMENT;<br>				<span class="hljs-keyword">goto</span> retry;<br>			&#125;<br>		&#125;<br><br>        <span class="hljs-comment">// è·å–å½“å‰ zone çš„æ°´ä½çº¿æ ‡è®°</span><br>		mark = wmark_pages(zone, alloc_flags &amp; ALLOC_WMARK_MASK);<br>		<span class="hljs-keyword">if</span> (!zone_watermark_fast(zone, order, mark,<br>				       ac-&gt;highest_zoneidx, alloc_flags,<br>				       gfp_mask)) &#123; <span class="hljs-comment">// æ°´ä½çº¿ç›¸å…³æ“ä½œ</span><br>			<span class="hljs-type">int</span> ret;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DEFERRED_STRUCT_PAGE_INIT</span><br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * è¯¥ zone çš„æ°´ä½çº¿å¤±è´¥, ä½†è‹¥å…¶åŒ…å«äº† deferred pagesï¼Œ</span><br><span class="hljs-comment">			 * åˆ™æˆ‘ä»¬ä¼šçœ‹è¯¥ zone æ˜¯å¦è¿˜èƒ½å†è¿›è¡Œæ‰©å±•</span><br><span class="hljs-comment">			 */</span><br>			<span class="hljs-keyword">if</span> (static_branch_unlikely(&amp;deferred_pages)) &#123;<br>				<span class="hljs-keyword">if</span> (_deferred_grow_zone(zone, order))<br>					<span class="hljs-keyword">goto</span> try_this_zone;<br>			&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>			<span class="hljs-comment">/* Checked here to keep the fast path fast */</span><br>			BUILD_BUG_ON(ALLOC_NO_WATERMARKS &lt; NR_WMARK);<br>            <span class="hljs-comment">// è¯¥æ ‡å¿—ä½æ„ä¸ºã€ä¸æ£€æŸ¥æ°´ä½çº¿ã€‘ï¼Œæ­¤æ—¶æˆ‘ä»¬ç›´æ¥å°è¯•ä»è¯¥ zone ä¸­åˆ†é…</span><br>			<span class="hljs-keyword">if</span> (alloc_flags &amp; ALLOC_NO_WATERMARKS)<br>				<span class="hljs-keyword">goto</span> try_this_zone;<br><br>			<span class="hljs-keyword">if</span> (node_reclaim_mode == <span class="hljs-number">0</span> ||<br>			    !zone_allows_reclaim(ac-&gt;preferred_zoneref-&gt;zone, zone))<br>				<span class="hljs-keyword">continue</span>;<br><br>            <span class="hljs-comment">// é¦–å…ˆè¿›è¡Œé¡µé¢å›æ”¶ï¼Œä¹‹åæŸ¥çœ‹æ˜¯å¦æ»¡è¶³æ°´ä½çº¿è¦æ±‚ï¼Œè‹¥â€˜</span><br>            <span class="hljs-comment">// 		ä¸æ‰«æ/æ²¡æœ‰å¯å›æ”¶/æ£€æŸ¥æœªé€šè¿‡</span><br>            <span class="hljs-comment">// åˆ™éƒ½ä¼šè¿›è¡Œä¸‹ä¸€æ¬¡è¿­ä»£ï¼Œå°è¯•ä¸‹ä¸€ä¸ª zone</span><br>			ret = node_reclaim(zone-&gt;zone_pgdat, gfp_mask, order);<br>			<span class="hljs-keyword">switch</span> (ret) &#123;<br>			<span class="hljs-keyword">case</span> NODE_RECLAIM_NOSCAN:<br>				<span class="hljs-comment">/* ä¸æ‰«æ */</span><br>				<span class="hljs-keyword">continue</span>;<br>			<span class="hljs-keyword">case</span> NODE_RECLAIM_FULL:<br>				<span class="hljs-comment">/* æ‰«æäº†ä½†ä¸å¯å›æ”¶ */</span><br>				<span class="hljs-keyword">continue</span>;<br>			<span class="hljs-keyword">default</span>:<br>				<span class="hljs-comment">/* æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦å›æ”¶äº†è¶³å¤Ÿé¡µé¢ */</span><br>				<span class="hljs-keyword">if</span> (zone_watermark_ok(zone, order, mark,<br>					ac-&gt;highest_zoneidx, alloc_flags))<br>					<span class="hljs-keyword">goto</span> try_this_zone;<br><br>				<span class="hljs-keyword">continue</span>;<br>			&#125;<br>		&#125;<br><br>try_this_zone:<br>        <span class="hljs-comment">// æ¥åˆ°è¯¥ label è¡¨ç¤ºæˆ‘ä»¬ç»ˆäºé€šè¿‡äº†å‰é¢ä¸€ç³»åˆ—çš„å„ç§æ£€æŸ¥ï¼Œç°åœ¨å¼€å§‹æ­£å¼è¿›è¡Œé¡µé¢åˆ†é…</span><br>        <span class="hljs-comment">// **************************</span><br>        <span class="hljs-comment">// rmqueue() å³ä¸ºæˆ‘ä»¬åœ¨OSæ•™ç§‘ä¹¦ä¸Šçœ‹åˆ°çš„çš„ buddy system æ¨¡å‹,</span><br>        <span class="hljs-comment">// å– freelist å¯¹åº”ä¸‹æ ‡ pageï¼Œè‹¥æ— åˆ™å‘ä¸Šéå†æ‹†æ›´é«˜ order çš„ page</span><br>        <span class="hljs-comment">// **************************</span><br>		page = rmqueue(ac-&gt;preferred_zoneref-&gt;zone, zone, order,<br>				gfp_mask, alloc_flags, ac-&gt;migratetype);<br>		<span class="hljs-keyword">if</span> (page) &#123;<br>			prep_new_page(page, order, gfp_mask, alloc_flags);<br><br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * è‹¥è¿™æ˜¯ä¸€ä¸ªé«˜é˜¶çš„åŸå­åˆ†é…ï¼Œ</span><br><span class="hljs-comment">			 * æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦è¯¥ä¸ºå°†æ¥ä¿ç•™ pageblock</span><br><span class="hljs-comment">			 */</span><br>			<span class="hljs-keyword">if</span> (unlikely(order &amp;&amp; (alloc_flags &amp; ALLOC_HARDER)))<br>				reserve_highatomic_pageblock(page, zone, order);<br><br>			<span class="hljs-keyword">return</span> page;	<span class="hljs-comment">// å–åˆ°äº†ï¼Œè¿”å›</span><br>		&#125; <span class="hljs-keyword">else</span> &#123;	<span class="hljs-comment">// æ²¡å–åˆ°</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DEFERRED_STRUCT_PAGE_INIT</span><br>			<span class="hljs-comment">/* è‹¥è¯¥ zone æœ‰ deferred pagesï¼Œå†è¯•ä¸€é */</span><br>			<span class="hljs-keyword">if</span> (static_branch_unlikely(&amp;deferred_pages)) &#123;<br>				<span class="hljs-keyword">if</span> (_deferred_grow_zone(zone, order))<br>					<span class="hljs-keyword">goto</span> try_this_zone;<br>			&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * åœ¨ä¸€å° UMA æœºå™¨ä¸Šå¯èƒ½æ‰€ä»¥çš„ zone éƒ½æ˜¯ç ´ç¢çš„ï¼Œ</span><br><span class="hljs-comment">	 * è‹¥é¿å…ç¢ç‰‡, é‡ç½®å¹¶é‡è¯•.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (no_fallback) &#123;<br>		alloc_flags &amp;= ~ALLOC_NOFRAGMENT;<br>		<span class="hljs-keyword">goto</span> retry;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°æµç¨‹æ€»ç»“å¦‚ä¸‹ï¼š</p>
<ul>
<li><p><code>for_next_zone_zonelist_nodemask</code> è¿­ä»£éå†åˆ†é…ä¸Šä¸‹æ–‡ä¸­ zonelist ä¸­çš„ zoneref æ•°ç»„ å¯¹åº”çš„ zone</p>
<blockquote>
<p>å…¶æ ¸å¿ƒæ˜¯å•æ¬¡è¿­ä»£è°ƒç”¨ next_zones_zonelist()ï¼Œè¯¥å‡½æ•°è¿”å›:</p>
<ul>
<li>åœ¨ nodemask çš„ zone ä¸­ï¼Œä»¥å½“å‰ zone ä½œä¸ºèµ·ç‚¹æ¸¸æ ‡çš„ã€ä½äºæˆ–ä½äºã€‘highest_zoneidx çš„ä¸‹ä¸€ä¸ª zone</li>
</ul>
</blockquote>
<ul>
<li><p>è‹¥å¼€å¯äº† cpusetï¼Œæ£€æŸ¥å½“å‰ zone æ˜¯å¦æ»¡è¶³ cpuset çš„è¦æ±‚ï¼Œè‹¥å¦ï¼Œåˆ™å°è¯•ä¸‹ä¸€ä¸ª zone</p>
</li>
<li><p>æ£€æŸ¥å½“å‰ zone å¯¹åº” node çš„è„é¡µæ•°é‡æ˜¯å¦è¶…å‡ºé™åˆ¶ï¼Œè‹¥å¦ï¼Œåˆ™å°è¯•ä¸‹ä¸€ä¸ª zone</p>
</li>
<li><p>è‹¥ <code>ALLOC_NOFRAGMENT</code> ä½†æ˜¯å½“å‰ zone é preferred zoneã€ä¸”å¯¹åº” node ä¸º remote nodeï¼Œåˆ™æ¸…é™¤è¯¥æ ‡å¿—ä½å<strong>é‡æ–°å¼€å§‹åˆ†é…</strong>ï¼Œå› ä¸º locality æ¯”é¿å…ç¢ç‰‡æ›´åŠ é‡è¦</p>
</li>
<li><p>è·å–å½“å‰ zone çš„æ°´ä½çº¿æ ‡è®°</p>
<ul>
<li>è‹¥æ˜¯è®¾ç½®äº† <code>ALLOC_NO_WATERMARKS</code> åˆ™ç›´æ¥åˆ°ä¸‹ä¸€æ­¥è¿›è¡Œåˆ†é…</li>
<li>è‹¥æ°´ä½çº¿æ£€æŸ¥æœªé€šè¿‡ï¼Œè°ƒç”¨ <code>node_reclaim()</code> è¿›è¡Œé¡µé¢å›æ”¶</li>
<li>è‹¥å›æ”¶åé¡µé¢è¿˜æ˜¯ä¸è¶³ï¼Œåˆ™å°è¯•ä¸‹ä¸€ä¸ª zone</li>
</ul>
</li>
<li><p>è°ƒç”¨ <code>rmqueue()</code> æ­£å¼è¿›è¡Œå†…å­˜åˆ†é…ï¼Œè¯¥å‡½æ•°å³ä¸º buddy system åˆ†é…ç®—æ³•</p>
</li>
</ul>
</li>
</ul>
<p><img src="https://s2.loli.net/2022/07/05/SJMKys31ofnTPXc.png" srcset="/img/loading.gif" lazyload alt="å·çš„å›¾.png"></p>
<h4 id="rmqueue-ï¼šä»ç»™å®šçš„-page-ä¸­è¿›è¡Œé¡µé¢åˆ†é…"><a href="#rmqueue-ï¼šä»ç»™å®šçš„-page-ä¸­è¿›è¡Œé¡µé¢åˆ†é…" class="headerlink" title="rmqueue()ï¼šä»ç»™å®šçš„ page ä¸­è¿›è¡Œé¡µé¢åˆ†é…"></a>rmqueue()ï¼šä»ç»™å®šçš„ page ä¸­è¿›è¡Œé¡µé¢åˆ†é…</h4><p>è¯¥å‡½æ•°å®šä¹‰äº <code>/mm/page_alloc.c</code> ä¸­ï¼Œä¸»è¦æ˜¯ä»ç»™å®š zone ä¸­è¿›è¡Œå†…å­˜åˆ†é…</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä»ç»™å®š zone ä¸­è¿›è¡Œå†…å­˜åˆ†é…. å¯¹äº order-0 çš„åˆ†é…åˆ™ä½¿ç”¨ pcplists.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span><br><span class="hljs-keyword">struct</span> page *<span class="hljs-title function_">rmqueue</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> zone *preferred_zone,</span><br><span class="hljs-params">			<span class="hljs-keyword">struct</span> zone *zone, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order,</span><br><span class="hljs-params">			<span class="hljs-type">gfp_t</span> gfp_flags, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> alloc_flags,</span><br><span class="hljs-params">			<span class="hljs-type">int</span> migratetype)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><br>	<span class="hljs-keyword">if</span> (likely(order == <span class="hljs-number">0</span>)) &#123;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * MIGRATE_MOVABLE çš„ pcplist å¯èƒ½åœ¨ CMA åŒºåŸŸæœ‰ç€é¡µé¢ï¼Œ</span><br><span class="hljs-comment">		 * å½“ä» CMA çš„åˆ†é…ä¸è¢«å…è®¸æ—¶æˆ‘ä»¬éœ€è¦ç•¥è¿‡å®ƒ</span><br><span class="hljs-comment">		 */</span><br>        <span class="hljs-comment">// å¯¹äº order-0 çš„åˆ†é…ï¼Œ</span><br>        <span class="hljs-comment">// è‹¥æ²¡æœ‰å¼€å¯ CMA | è®¾ç½®äº† ALLOC_CMA | è¿ç§»ç±»å‹é MIGRATE_MOVABLE</span><br>        <span class="hljs-comment">// åˆ™å…ˆä» pcplist ä¸Šåˆ†é…</span><br>		<span class="hljs-keyword">if</span> (!IS_ENABLED(CONFIG_CMA) || alloc_flags &amp; ALLOC_CMA ||<br>				migratetype != MIGRATE_MOVABLE) &#123;<br>			page = rmqueue_pcplist(preferred_zone, zone, gfp_flags,<br>					migratetype, alloc_flags);<br>			<span class="hljs-keyword">goto</span> out;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * æˆ‘ä»¬ç»ä¸å¸Œæœ› callers å°è¯•</span><br><span class="hljs-comment">	 * åœ¨å¸¦æœ‰ __GFP_NOFAIL æ—¶åˆ†é…å¤§äº order-1 çš„é¡µ</span><br><span class="hljs-comment">	 */</span><br>	WARN_ON_ONCE((gfp_flags &amp; __GFP_NOFAIL) &amp;&amp; (order &gt; <span class="hljs-number">1</span>));<br>	spin_lock_irqsave(&amp;zone-&gt;lock, flags);<br><br>	<span class="hljs-keyword">do</span> &#123;<br>		page = <span class="hljs-literal">NULL</span>;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * è‹¥ç”±äºéCMAçš„åˆ†é…ä¸Šä¸‹æ–‡å¯¼è‡´ç•¥è¿‡äº† pcplistï¼Œåˆ™order-0 çš„è¯·æ±‚å¯ä»¥åˆ°è¾¾æ­¤å¤„.</span><br><span class="hljs-comment">		 * HIGHATOMIC åŒºåŸŸä¸ºæ›´é«˜ order çš„åŸå­åˆ†é…æ‰€ä¿ç•™ï¼Œ</span><br><span class="hljs-comment">		 * æ•… order-0 çš„è¯·æ±‚åº”ç•¥è¿‡å®ƒã€‚</span><br><span class="hljs-comment">		 */</span><br>        <span class="hljs-comment">// è‹¥ order &gt; 0 ä¸”å¸¦æœ‰ ALLOC_HARDER æ ‡å¿—ä½ï¼Œè°ƒç”¨ __rmqueue_smallest() åˆ†é…</span><br>        <span class="hljs-comment">// è¿™ä¸ªæ ‡å¿—ä½æ„ä¸ºå°†æ°´ä½çº¿å‡å» 1/4ï¼Œå®é™…ä¸Š GFP_ATOMIC ä¸­ä¾¿ä¼šåŒ…å«è¯¥æ ‡å¿—ä½</span><br>		<span class="hljs-keyword">if</span> (order &gt; <span class="hljs-number">0</span> &amp;&amp; alloc_flags &amp; ALLOC_HARDER) &#123;<br>			page = __rmqueue_smallest(zone, order, MIGRATE_HIGHATOMIC);<br>			<span class="hljs-keyword">if</span> (page)<br>				trace_mm_page_alloc_zone_locked(page, order, migratetype);<br>		&#125;<br>        <span class="hljs-comment">// è°ƒç”¨ __rmqueue() è¿›è¡Œåˆ†é…ï¼Œè¿™ä¸ªå°±æ˜¯çœŸæ­£çš„æ ¸å¿ƒåˆ†é…å‡½æ•°äº†</span><br>		<span class="hljs-keyword">if</span> (!page)<br>			page = __rmqueue(zone, order, migratetype, alloc_flags);<br>	&#125; <span class="hljs-keyword">while</span> (page &amp;&amp; check_new_pages(page, order)); <span class="hljs-comment">// è¿™ä¸ªæ£€æŸ¥å‡½æ•°é€šè¿‡äº†è¿”å›false</span><br>	spin_unlock(&amp;zone-&gt;lock);<br>	<span class="hljs-keyword">if</span> (!page)<br>		<span class="hljs-keyword">goto</span> failed;<br>	__mod_zone_freepage_state(zone, -(<span class="hljs-number">1</span> &lt;&lt; order),<br>				  get_pcppage_migratetype(page));<br><br>	__count_zid_vm_events(PGALLOC, page_zonenum(page), <span class="hljs-number">1</span> &lt;&lt; order);<br>	zone_statistics(preferred_zone, zone);<br>	local_irq_restore(flags);<br><br>out:<br>	<span class="hljs-comment">/* Separate test+clear to avoid unnecessary atomics */</span><br>	<span class="hljs-keyword">if</span> (test_bit(ZONE_BOOSTED_WATERMARK, &amp;zone-&gt;flags)) &#123;<br>		clear_bit(ZONE_BOOSTED_WATERMARK, &amp;zone-&gt;flags);<br>		wakeup_kswapd(zone, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, zone_idx(zone));<br>	&#125;<br><br>	VM_BUG_ON_PAGE(page &amp;&amp; bad_range(zone, page), page);<br>	<span class="hljs-keyword">return</span> page;<br><br>failed:<br>	local_irq_restore(flags);<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åˆ†æå‡½æ•°æµç¨‹å‰æˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹è¿™ä¸ªæ¦‚å¿µâ€”â€”<code>per-cpu pageset</code> ï¼Œè¿™æ˜¯ zone ä¸Šçš„ä¸€ä¸ª per-cpu çš„é¡µé¢é›†ï¼Œåœ¨åˆ†é…æ—¶ä¼šä¼˜å…ˆä»è¿™é‡Œè¿›è¡Œåˆ†é…</p>
<p>è¯¥å‡½æ•°å…¶å®è¿˜æ˜¯å¯¹åˆ†é…çš„æ ¸å¿ƒé€»è¾‘çš„å°è£…ï¼Œä¸»è¦æ˜¯ä»¥ä¸‹æµç¨‹ï¼š</p>
<ul>
<li>åˆ†é…çš„ order ä¸º 0ï¼Œè‹¥æ²¡æœ‰å¼€å¯ CMA | è®¾ç½®äº† ALLOC_CMA | è¿ç§»ç±»å‹é MIGRATE_MOVABLEï¼Œåˆ™å°è¯•ä» per-cpu pageset ä¸­åˆ†é…å¹¶è¿”å›</li>
<li>order &gt; 0ï¼Œè°ƒç”¨ <code>__rmqueue_smallest()</code> è¿›è¡Œé¡µé¢åˆ†é…</li>
<li>ä¹‹å‰æœªåˆ†é…æˆåŠŸï¼Œè°ƒç”¨ <code>__rmqueue()</code> è¿›è¡Œé¡µé¢åˆ†é…</li>
<li>ç»“æœæ£€æŸ¥ï¼Œå…¶ä¸­å¾ªç¯å†…æ˜¯ç”¨ <code>check_new_pages()</code>ï¼Œæœªé€šè¿‡åˆ™é‡æ–°å¾ªç¯ï¼ˆå›åˆ°ç¬¬äºŒæ­¥ï¼‰</li>
</ul>
<h5 id="â‘ -rmqueue-pcplist-ï¼šä»-per-cpu-pageset-ä¸Šåš-order-0-çš„åˆ†é…"><a href="#â‘ -rmqueue-pcplist-ï¼šä»-per-cpu-pageset-ä¸Šåš-order-0-çš„åˆ†é…" class="headerlink" title="â‘  rmqueue_pcplist()ï¼šä» per-cpu pageset ä¸Šåš order-0 çš„åˆ†é…"></a>â‘  rmqueue_pcplist()ï¼šä» per-cpu pageset ä¸Šåš order-0 çš„åˆ†é…</h5><p>ä¸»è¦æ˜¯å…³ä¸­æ–­â†’é¡µé¢åˆ†é…â†’å¼€ä¸­æ–­ä¸‰æ­¥èµ°ï¼Œæœ€ååˆ†é…è°ƒç”¨åˆ°çš„æ˜¯ <code>__rmqueue_pcplist()</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Lock and remove page from the per-cpu list */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> page *<span class="hljs-title function_">rmqueue_pcplist</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> zone *preferred_zone,</span><br><span class="hljs-params">			<span class="hljs-keyword">struct</span> zone *zone, <span class="hljs-type">gfp_t</span> gfp_flags,</span><br><span class="hljs-params">			<span class="hljs-type">int</span> migratetype, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> alloc_flags)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">per_cpu_pages</span> *<span class="hljs-title">pcp</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> *<span class="hljs-title">list</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><br>	local_irq_save(flags); <span class="hljs-comment">// å…³ä¸­æ–­</span><br>	pcp = &amp;this_cpu_ptr(zone-&gt;pageset)-&gt;pcp;<br>	<span class="hljs-built_in">list</span> = &amp;pcp-&gt;lists[migratetype]; <span class="hljs-comment">// è·å–è¿ç§»ç±»å‹é“¾è¡¨</span><br>	page = __rmqueue_pcplist(zone,  migratetype, alloc_flags, pcp, <span class="hljs-built_in">list</span>); <span class="hljs-comment">// åˆ†é…</span><br>	<span class="hljs-keyword">if</span> (page) &#123;<br>		__count_zid_vm_events(PGALLOC, page_zonenum(page), <span class="hljs-number">1</span>);<br>		zone_statistics(preferred_zone, zone);<br>	&#125;<br>	local_irq_restore(flags); <span class="hljs-comment">// å¼€ä¸­æ–­</span><br>	<span class="hljs-keyword">return</span> page;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>__rmqueue_pcplist()</code> ä¸»è¦å°±æ˜¯ä¸€ä¸ªå¤§å¾ªç¯ï¼Œè‹¥ pcplist ä¸ºç©ºåˆ™è°ƒç”¨ <code>rmqueue_bulk()</code> å…ˆä» zone ä¸Šæ‹¿ pagesï¼Œä¹‹åå°±æ˜¯ç®€å•çš„é“¾è¡¨è„±é“¾ï¼Œåˆ†é…ç»“æœä½¿ç”¨ <code>check_new_page()</code> è¿›è¡Œæ£€æŸ¥ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* ä» per-cpu é“¾è¡¨ä¸Šå–å‡º page, è°ƒç”¨è€…å¿…é¡»ä¿æŠ¤é“¾è¡¨ */</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *__<span class="hljs-title">rmqueue_pcplist</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title">zone</span> *<span class="hljs-title">zone</span>, <span class="hljs-title">int</span> <span class="hljs-title">migratetype</span>,</span><br><span class="hljs-class">			<span class="hljs-title">unsigned</span> <span class="hljs-title">int</span> <span class="hljs-title">alloc_flags</span>,</span><br><span class="hljs-class">			<span class="hljs-keyword">struct</span> <span class="hljs-title">per_cpu_pages</span> *<span class="hljs-title">pcp</span>,</span><br><span class="hljs-class">			<span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> *<span class="hljs-title">list</span>)</span><br><span class="hljs-class">&#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><br>	<span class="hljs-keyword">do</span> &#123;<br>		<span class="hljs-keyword">if</span> (list_empty(<span class="hljs-built_in">list</span>)) &#123; <span class="hljs-comment">// list æ˜¯ç©ºçš„</span><br>            <span class="hljs-comment">// </span><br>			pcp-&gt;count += rmqueue_bulk(zone, <span class="hljs-number">0</span>,<br>					READ_ONCE(pcp-&gt;batch), <span class="hljs-built_in">list</span>,<br>					migratetype, alloc_flags);<br>			<span class="hljs-keyword">if</span> (unlikely(list_empty(<span class="hljs-built_in">list</span>)))<br>				<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>		&#125;<br><br>        <span class="hljs-comment">// é“¾è¡¨è„±é“¾</span><br>		page = list_first_entry(<span class="hljs-built_in">list</span>, <span class="hljs-keyword">struct</span> page, lru);<br>		list_del(&amp;page-&gt;lru);<br>		pcp-&gt;count--;<br>	&#125; <span class="hljs-keyword">while</span> (check_new_pcp(page));<br><br>	<span class="hljs-keyword">return</span> page;<br>&#125;<br></code></pre></td></tr></table></figure>

<p> <code>rmqueue_bulk()</code> åˆ™æœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>__rmqueue()</code> ä¸º pcplist è¿›è¡Œ <code>pcp-&gt;batch</code> æ¬¡çš„ order-0 çš„é¡µé¢åˆ†é…ï¼Œå¹¶å»ºç«‹é“¾è¡¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä¸ºäº†é«˜æ•ˆç‡ï¼Œä» buddy åˆ†é…å™¨è·å¾—æŒ‡å®šæ•°é‡çš„å…ƒç´ , </span><br><span class="hljs-comment"> * æ‰€æœ‰çš„å•ä¸ªå…ƒç´ éƒ½åœ¨æŒæœ‰é”çš„æƒ…å†µä¸‹è¿›è¡Œ.  å°†å…¶æ·»åŠ åˆ°æä¾›çš„é“¾è¡¨ä¸­.</span><br><span class="hljs-comment"> * è¿”å›æ”¾ç½®åœ¨ *list é“¾è¡¨ä¸Šçš„ pages æ•°é‡.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">rmqueue_bulk</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> zone *zone, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order,</span><br><span class="hljs-params">			<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> count, <span class="hljs-keyword">struct</span> list_head *<span class="hljs-built_in">list</span>,</span><br><span class="hljs-params">			<span class="hljs-type">int</span> migratetype, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> alloc_flags)</span><br>&#123;<br>	<span class="hljs-type">int</span> i, alloced = <span class="hljs-number">0</span>;<br><br>	spin_lock(&amp;zone-&gt;lock);<br>	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; count; ++i) &#123;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> __rmqueue(zone, order, migratetype,<br>								alloc_flags);<br>		<span class="hljs-keyword">if</span> (unlikely(page == <span class="hljs-literal">NULL</span>))<br>			<span class="hljs-keyword">break</span>;<br><br>		<span class="hljs-keyword">if</span> (unlikely(check_pcp_refill(page)))<br>			<span class="hljs-keyword">continue</span>;<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * ç”± expand() è¿”å›çš„åˆ†å‰² buddy é¡µé¢åœ¨æ­¤å¤„ä»¥ç‰©ç†é¡µæ¡†é¡ºåºæ¥æ”¶ã€‚</span><br><span class="hljs-comment">		 * é¡µé¢è¢«æ·»åŠ åˆ° caller çš„é“¾è¡¨å°¾éƒ¨ã€‚ä» caller çš„è§’åº¦çœ‹ï¼Œé“¾è¡¨åœ¨</span><br><span class="hljs-comment">		 * æŸäº›æƒ…å†µä¸‹æ˜¯æŒ‰ç…§é¡µç æ’åºçš„ã€‚è¿™å¯¹ä¸€äº›å¯ä»¥ä»å¤´éƒ¨å‰å‘çš„IOè®¾å¤‡æ˜¯æœ‰ç”¨çš„ï¼Œ</span><br><span class="hljs-comment">		 * å› ä¸ºé“¾è¡¨ä¹Ÿæ˜¯åœ¨ç‰©ç†é¡µçš„é¡ºåºä¸Šçš„ã€‚è¿™å¯¹äºå¯ä»¥åœ¨ç‰©ç†é¡µåˆç†æ’åºçš„æƒ…å†µä¸‹</span><br><span class="hljs-comment">		 * åˆå¹¶IOè¯·æ±‚çš„IOè®¾å¤‡æ˜¯æœ‰ç”¨çš„ã€‚</span><br><span class="hljs-comment">		 */</span><br>		list_add_tail(&amp;page-&gt;lru, <span class="hljs-built_in">list</span>);<br>		alloced++;<br>		<span class="hljs-keyword">if</span> (is_migrate_cma(get_pcppage_migratetype(page)))<br>			__mod_zone_page_state(zone, NR_FREE_CMA_PAGES,<br>					      -(<span class="hljs-number">1</span> &lt;&lt; order));<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * i pages were removed from the buddy list even if some leak due</span><br><span class="hljs-comment">	 * to check_pcp_refill failing so adjust NR_FREE_PAGES based</span><br><span class="hljs-comment">	 * on i. Do not confuse with &#x27;alloced&#x27; which is the number of</span><br><span class="hljs-comment">	 * pages added to the pcp list.</span><br><span class="hljs-comment">	 */</span><br>	__mod_zone_page_state(zone, NR_FREE_PAGES, -(i &lt;&lt; order));<br>	spin_unlock(&amp;zone-&gt;lock);<br>	<span class="hljs-keyword">return</span> alloced;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="â‘¡-rmqueue-smallest-ï¼šéå†æŒ‡å®š-migrationtype-é“¾è¡¨çš„-buddy-ç®—æ³•ï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼‰"><a href="#â‘¡-rmqueue-smallest-ï¼šéå†æŒ‡å®š-migrationtype-é“¾è¡¨çš„-buddy-ç®—æ³•ï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼‰" class="headerlink" title="â‘¡ __rmqueue_smallest()ï¼šéå†æŒ‡å®š migrationtype é“¾è¡¨çš„ buddy ç®—æ³•ï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼‰"></a>â‘¡ __rmqueue_smallest()ï¼šéå†æŒ‡å®š migrationtype é“¾è¡¨çš„ buddy ç®—æ³•ï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼‰</h5><p>æˆ‘ä»¬é‡æ–°æ¥å›é¡¾ä¸€ä¸‹ <code>free_area</code> çš„ç»“æ„ï¼Œåœ¨å…¶ä¸­æ ¹æ®è¿ç§»ç±»å‹åˆ†æˆäº†å¤šä¸ªé“¾è¡¨ï¼š</p>
<p><img src="https://i.loli.net/2021/11/30/sbNImKo6tBS5GUe.png" srcset="/img/loading.gif" lazyload alt="è‡ªå·±ç”»çš„å›¾.png"></p>
<p>è€Œä¸€ä¸ª zone æ˜¯ç”±å¤šä¸ª <code>free_area</code> ç»„æˆçš„ï¼Œä¸€ä¸ª <code>free_area</code> å¯¹åº”ä¸€ä¸ª orderï¼Œé‚£ä¹ˆå¯¹äºè¯¥å‡½æ•°è€Œè¨€å…¶åªä¼šéå†ç‰¹å®šçš„ orderï¼Œé‚£ä¹ˆå°±æˆäº†ä¸‹é¢çš„æ¨¡å‹ï¼š</p>
<p><img src="https://i.loli.net/2021/11/30/sOwdI5YMNUjLSib.png" srcset="/img/loading.gif" lazyload alt="è‡ªå·±ç”»çš„å›¾.png"></p>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥ä»¥æ¥çœ‹è¿™ä¸ªå‡½æ•°äº†ï¼šä»å¾…åˆ†é… order æ‰€å¯¹åº”çš„ <code>free_area</code> çš„æŒ‡å®šçš„ migration type é“¾è¡¨ä¸Šåˆ†é…ï¼Œè‹¥ä¸å¤Ÿåˆ™ä¸€ç›´å‘æ›´é«˜ order è¿›è¡Œåˆ†é…åå¯¹åŠå‘ä¸‹æ‹†åˆ°ä½ orderï¼Œè¿™é‡Œå‘æ›´é«˜ order åˆ†é…æ˜¯é€šè¿‡ç®€å•çš„å¾ªç¯ + é“¾è¡¨è„±é“¾æ“ä½œå®Œæˆçš„ï¼Œè€Œæ‹†é«˜é˜¶ page çš„æ“ä½œåˆ™æ˜¯é€šè¿‡ <code>expand()</code> å®Œæˆçš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å¯¹ç»™å®šçš„ migrationtype éå† free lists </span><br><span class="hljs-comment"> * å¹¶ä» freelists ä¸Šç§»é™¤æœ€å°å¯ç”¨çš„é¡µé¢</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> __always_inline<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *__<span class="hljs-title">rmqueue_smallest</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title">zone</span> *<span class="hljs-title">zone</span>, <span class="hljs-title">unsigned</span> <span class="hljs-title">int</span> <span class="hljs-title">order</span>,</span><br><span class="hljs-class">						<span class="hljs-title">int</span> <span class="hljs-title">migratetype</span>)</span><br><span class="hljs-class">&#123;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> current_order;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">free_area</span> *<span class="hljs-title">area</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><br>	<span class="hljs-comment">/* åœ¨ preferred list ä¸Šå¯»æ‰¾ä¸€ä¸ªåˆé€‚ size çš„ page */</span><br>	<span class="hljs-keyword">for</span> (current_order = order; current_order &lt; MAX_ORDER; ++current_order) &#123;<br>		area = &amp;(zone-&gt;free_area[current_order]);<br>		page = get_page_from_free_area(area, migratetype);<br>		<span class="hljs-keyword">if</span> (!page)<br>			<span class="hljs-keyword">continue</span>;<br>		del_page_from_free_list(page, zone, current_order);<br>		expand(zone, page, order, current_order, migratetype);<br>		set_pcppage_migratetype(page, migratetype);<br>		<span class="hljs-keyword">return</span> page;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>expand()</code> çš„é€»è¾‘å°±æ¯”è¾ƒç®€å•ï¼Œä»é«˜é˜¶ order ä¸€ç›´å¾ªç¯åˆ°å¾…åˆ†é…çš„ orderï¼š</p>
<ul>
<li>é¦–å…ˆé«˜é˜¶ orderâ€“ï¼Œä¹‹åé¡µé¢æ‹†ä¸¤åŠï¼ŒæŠŠååŠéƒ¨åˆ†æŒ‚åˆ°é“¾è¡¨ä¸Šï¼Œå‰åŠéƒ¨åˆ†ç•™åˆ°ä¸‹æ¬¡å¾ªç¯ç»§ç»­æ‹†</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ­¤å¤„å†åˆ†å‰²çš„é¡ºåºå¯¹ IO subsystem è€Œè¨€æ˜¯ååˆ†é‡è¦çš„.</span><br><span class="hljs-comment"> * è¯·ä¸è¦åœ¨æœ‰å¥½çš„ç†ç”±åŠå›å½’æµ‹è¯•å‰æ”¹å˜è¿™ä¸ªé¡ºåºã€‚</span><br><span class="hljs-comment"> * ç‰¹åˆ«åœ°ï¼Œå½“å¤§å—çš„å†…å­˜è¢«åˆ†å‰²ï¼Œæ›´å°å—ï¼ˆå†…å­˜ï¼‰è¢«ä¼ é€’çš„é¡ºåº</span><br><span class="hljs-comment"> * åˆ™ç”±ä»–ä»¬åœ¨è¯¥å‡½æ•°ä¸­è¢«åˆ†å‰²çš„é¡ºåºå†³å®šã€‚</span><br><span class="hljs-comment"> * æ ¹æ®å®é™…æµ‹è¯•ï¼Œè¿™æ˜¯å½±å“ä¼ é€’ç»™IOå­ç³»ç»Ÿçš„ pages é¡ºåºçš„ä¸»è¦å› ç´ ï¼Œ</span><br><span class="hljs-comment"> * è€ƒè™‘åˆ°åŒ…å«ä¸€ä¸ªå†…å­˜å¤§å—ï¼ˆç”±ä¸€ç³»åˆ—å°çš„åˆ†é…ä½œç”¨ï¼‰çš„ buddy system çš„è¡Œä¸ºï¼Œ</span><br><span class="hljs-comment"> * è¿™ä¹Ÿæ˜¯åˆç†çš„ã€‚è¿™ç§è¡Œä¸ºæ˜¯ sglist åˆå¹¶æˆåŠŸçš„å…³é”®å› ç´ ã€‚</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * -- nyc</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">expand</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> zone *zone, <span class="hljs-keyword">struct</span> page *page,</span><br><span class="hljs-params">	<span class="hljs-type">int</span> low, <span class="hljs-type">int</span> high, <span class="hljs-type">int</span> migratetype)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> size = <span class="hljs-number">1</span> &lt;&lt; high;<br><br>	<span class="hljs-keyword">while</span> (high &gt; low) &#123;<br>		high--;<br>		size &gt;&gt;= <span class="hljs-number">1</span>;<br>		VM_BUG_ON_PAGE(bad_range(zone, &amp;page[size]), &amp;page[size]);<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * æ ‡è®°ä¸º guard pages (æˆ– page), è¿™å°†å…è®¸åœ¨ buddy å°†è¢«</span><br><span class="hljs-comment">		 * é‡Šæ”¾æ—¶åˆå¹¶å›åˆ†é…å™¨.å¯¹åº”çš„é¡µè¡¨é¡¹ä¸ä¼šè¢«åˆ›å»ºï¼Œ</span><br><span class="hljs-comment">		 * pages åœ¨ è™šæ‹Ÿåœ°å€ç©ºé—´ä¸Šä»å°†ä¿æŒä¸å­˜åœ¨ã€‚</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (set_page_guard(zone, &amp;page[size], high, migratetype))<br>			<span class="hljs-keyword">continue</span>;<br><br>		add_to_free_list(&amp;page[size], zone, high, migratetype);<br>		set_buddy_order(&amp;page[size], high);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="â‘¢-rmqueue-ï¼šåˆ†é…å°è£…å‡½æ•°"><a href="#â‘¢-rmqueue-ï¼šåˆ†é…å°è£…å‡½æ•°" class="headerlink" title="â‘¢ __rmqueue()ï¼šåˆ†é…å°è£…å‡½æ•°"></a>â‘¢ __rmqueue()ï¼šåˆ†é…å°è£…å‡½æ•°</h5><p>è¿™ä¸ªå‡½æ•°å…¶å®ä¸»è¦æ˜¯å¯¹å…¶ä»–åˆ†é…å‡½æ•°çš„å°è£…ï¼Œæœ€ç»ˆçš„æ ¸å¿ƒå‡½æ•°å…¶å®éƒ½è¿˜æ˜¯ <code>__rmqueue_smallest()</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä» buddy allocator ä¸Šç§»é™¤ä¸€ä¸ªå…ƒç´ .</span><br><span class="hljs-comment"> * åœ¨æŒæœ‰ zone-&gt;lock æ—¶è°ƒç”¨.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> __always_inline <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *</span><br><span class="hljs-class">__<span class="hljs-title">rmqueue</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title">zone</span> *<span class="hljs-title">zone</span>, <span class="hljs-title">unsigned</span> <span class="hljs-title">int</span> <span class="hljs-title">order</span>, <span class="hljs-title">int</span> <span class="hljs-title">migratetype</span>,</span><br><span class="hljs-class">						<span class="hljs-title">unsigned</span> <span class="hljs-title">int</span> <span class="hljs-title">alloc_flags</span>)</span><br><span class="hljs-class">&#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><br>	<span class="hljs-keyword">if</span> (IS_ENABLED(CONFIG_CMA)) &#123;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * é€šè¿‡å½“åŠæ•°ç©ºé—²å†…å­˜åœ¨ CMA åŒºåŸŸæ—¶ä» CMA ä¸­åˆ†é…</span><br><span class="hljs-comment">		 * ä»¥å¹³è¡¡å¸¸è§„çš„ä¸CMAåŒºåŸŸçš„å¯è¿ç§»çš„åˆ†é…ã€‚</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (alloc_flags &amp; ALLOC_CMA &amp;&amp;<br>		    zone_page_state(zone, NR_FREE_CMA_PAGES) &gt;<br>		    zone_page_state(zone, NR_FREE_PAGES) / <span class="hljs-number">2</span>) &#123;<br>			page = __rmqueue_cma_fallback(zone, order);<br>			<span class="hljs-keyword">if</span> (page)<br>				<span class="hljs-keyword">goto</span> out;<br>		&#125;<br>	&#125;<br>retry:<br>	page = __rmqueue_smallest(zone, order, migratetype);<br>	<span class="hljs-keyword">if</span> (unlikely(!page)) &#123;<br>		<span class="hljs-keyword">if</span> (alloc_flags &amp; ALLOC_CMA)<br>			page = __rmqueue_cma_fallback(zone, order);<br><br>		<span class="hljs-keyword">if</span> (!page &amp;&amp; __rmqueue_fallback(zone, order, migratetype,<br>								alloc_flags))<br>			<span class="hljs-keyword">goto</span> retry;<br>	&#125;<br>out:<br>	<span class="hljs-keyword">if</span> (page)<br>		trace_mm_page_alloc_zone_locked(page, order, migratetype);<br>	<span class="hljs-keyword">return</span> page;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>è‹¥å¼€å¯äº† CMAï¼Œæ¯”å¯¹å¸¸è§„åŒºåŸŸä¸ CMA åŒºåŸŸçš„ç©ºé—²é¡µé¢æ•°é‡ï¼Œè‹¥ CMA çš„å¤šåˆ™è°ƒç”¨ <code>__rmqueue_cma_fallback()</code> ä» CMA åŒºåŸŸåˆ†é…ï¼ˆå…¶å®å°±æ˜¯è°ƒç”¨ <code>__rmqueue_smallest()</code> ä»è¿ç§»ç±»å‹ä¸º <code>MIGRATE_CMA</code> çš„é“¾è¡¨ä¸Šåˆ†é…ï¼‰ï¼ŒæˆåŠŸåˆ™ç›´æ¥è¿”å›</li>
<li>è°ƒç”¨ <code>__rmqueue_smallest()</code> ä»æŒ‡å®šè¿ç§»ç±»å‹é“¾è¡¨è¿›è¡Œåˆ†é…ï¼Œè‹¥æœªæˆåŠŸï¼š<ul>
<li>è‹¥è®¾ç½®äº† <code>ALLOC_CMA</code> çš„åˆ†é… flagï¼Œè°ƒç”¨ <code>__rmqueue_cma_fallback()</code> ä» CMA åŒºåŸŸè¿›è¡Œåˆ†é…</li>
<li>è‹¥ä¸Šä¸€æ­¥å¤±è´¥åˆ™è°ƒç”¨ <code>__rmqueue_fallback()</code> å°è¯•ä»å…¶ä»–è¿ç§»ç±»å‹é“¾è¡¨è·å–é¡µé¢ï¼Œè‹¥è¿˜æ˜¯å¤±è´¥åˆ™é‡è¯•è¿™ä¸€ä¸ªå¤§æ­¥éª¤</li>
</ul>
</li>
</ul>
<h3 id="III-alloc-pages-slowpath-ï¼šæ…¢é€Ÿåˆ†é…è·¯å¾„"><a href="#III-alloc-pages-slowpath-ï¼šæ…¢é€Ÿåˆ†é…è·¯å¾„" class="headerlink" title="III. __alloc_pages_slowpath()ï¼šæ…¢é€Ÿåˆ†é…è·¯å¾„"></a>III. __alloc_pages_slowpath()ï¼šæ…¢é€Ÿåˆ†é…è·¯å¾„</h3><p>å½“å¿«é€Ÿè·¯å¾„çš„åˆ†é…ä¸æˆåŠŸæ—¶ï¼Œè¯´æ˜ç³»ç»Ÿå½“å‰å¯èƒ½å·²ç»æ²¡æœ‰è¶³å¤Ÿçš„è¿ç»­çš„ç©ºé—²é¡µé¢ï¼Œè¿™æ—¶æˆ‘ä»¬å°±è¦è¿›å…¥åˆ°æ…¢é€Ÿè·¯å¾„çš„åˆ†é…ï¼Œ<strong>è¿›è¡Œå†…å­˜ç¢ç‰‡æ•´ç†ä¸å†…å­˜å›æ”¶</strong>ï¼Œä¹‹åå†è¿›è¡Œåˆ†é…</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *</span><br><span class="hljs-class">__<span class="hljs-title">alloc_pages_slowpath</span>(<span class="hljs-title">gfp_t</span> <span class="hljs-title">gfp_mask</span>, <span class="hljs-title">unsigned</span> <span class="hljs-title">int</span> <span class="hljs-title">order</span>,</span><br><span class="hljs-class">						<span class="hljs-keyword">struct</span> <span class="hljs-title">alloc_context</span> *<span class="hljs-title">ac</span>)</span><br><span class="hljs-class">&#123;</span><br>	<span class="hljs-type">bool</span> can_direct_reclaim = gfp_mask &amp; __GFP_DIRECT_RECLAIM;<br>	<span class="hljs-type">const</span> <span class="hljs-type">bool</span> costly_order = order &gt; PAGE_ALLOC_COSTLY_ORDER;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> alloc_flags;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> did_some_progress;<br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">compact_priority</span> <span class="hljs-title">compact_priority</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">compact_result</span> <span class="hljs-title">compact_result</span>;</span><br>	<span class="hljs-type">int</span> compaction_retries;<br>	<span class="hljs-type">int</span> no_progress_loops;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cpuset_mems_cookie;<br>	<span class="hljs-type">int</span> reserve_flags;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * æˆ‘ä»¬è¿˜è¿›è¡Œäº†å¥å…¨æ€§æ£€æŸ¥ï¼Œä»¥å‘ç°éåŸå­ä¸Šä¸‹æ–‡ä¸­çš„ caller æ»¥ç”¨åŸå­å‚¨å¤‡ï¼ˆçš„è¡Œä¸ºï¼‰ã€‚</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (WARN_ON_ONCE((gfp_mask &amp; (__GFP_ATOMIC|__GFP_DIRECT_RECLAIM)) ==<br>				(__GFP_ATOMIC|__GFP_DIRECT_RECLAIM)))<br>		gfp_mask &amp;= ~__GFP_ATOMIC;<br><br>retry_cpuset:<br>	compaction_retries = <span class="hljs-number">0</span>;<br>	no_progress_loops = <span class="hljs-number">0</span>;<br>	compact_priority = DEF_COMPACT_PRIORITY;<br>	cpuset_mems_cookie = read_mems_allowed_begin();<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * ä»…åœ¨ kswapd éœ€è¦è¢«å”¤é†’å‰ï¼Œå¿«é€Ÿè·¯å¾„ä½¿ç”¨ä¿å®ˆçš„ alloc_flags æ‰èƒ½æˆåŠŸï¼Œ</span><br><span class="hljs-comment">	 * å¹¶ä¸”é¿å…ç²¾ç¡®åœ°è®¾ç½® alloc_flagsã€‚ æ‰€ä»¥æˆ‘ä»¬ç°åœ¨è¿™ä¹ˆåšã€‚</span><br><span class="hljs-comment">	 */</span><br>    <span class="hljs-comment">// é‡æ–°è®¾ç½® alloc_flagsï¼Œå› ä¸ºå¿«é€Ÿè·¯å¾„çš„åˆ†é…åœ¨ kswapd è¢«å”¤é†’ä¹‹å‰</span><br>    <span class="hljs-comment">// åªæœ‰ä½¿ç”¨ä¿å®ˆçš„ alloc_flags æ‰èƒ½æˆåŠŸï¼Œè€Œç°åœ¨æˆ‘ä»¬å°†å”¤é†’ kswapdï¼Œ</span><br>    <span class="hljs-comment">// å› æ­¤æ¢å¤ä½¿ç”¨åŸæœ‰çš„ gfp_mask å¯¹åº”çš„ alloc_flags</span><br>	alloc_flags = gfp_to_alloc_flags(gfp_mask);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * æˆ‘ä»¬éœ€è¦ä¸º zonelist è¿­ä»£å™¨é‡æ–°è®¡ç®—èµ·å§‹ç‚¹ï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½åœ¨å¿«é€Ÿè·¯å¾„ä¸­</span><br><span class="hljs-comment">	 * ä½¿ç”¨äº†ä¸åŒçš„ nodemask ï¼Œæˆ–æ˜¯æœ‰ä¸ª cpuset çš„ä¿®æ”¹è€Œæˆ‘ä»¬æ­£åœ¨é‡è¯•</span><br><span class="hljs-comment">	 * - å¦åˆ™æˆ‘ä»¬å¯èƒ½ä¼šæ— ä¼‘æ­¢åœ°è¿­ä»£ä¸åˆæ ¼çš„ zone</span><br><span class="hljs-comment">	 */</span><br>	ac-&gt;preferred_zoneref = first_zones_zonelist(ac-&gt;zonelist,<br>					ac-&gt;highest_zoneidx, ac-&gt;nodemask);<br>	<span class="hljs-keyword">if</span> (!ac-&gt;preferred_zoneref-&gt;zone)<br>		<span class="hljs-keyword">goto</span> nopage;<br><br>    <span class="hljs-comment">// å¦‚æœ ALLOC_KSWAPDï¼Œå”¤é†’ kswapd çº¿ç¨‹å›æ”¶å†…å­˜</span><br>	<span class="hljs-keyword">if</span> (alloc_flags &amp; ALLOC_KSWAPD)<br>		wake_all_kswapds(order, gfp_mask, ac);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * è°ƒæ•´åçš„ alloc_flags å¯èƒ½ä¼šç«‹å³æˆåŠŸï¼Œæ‰€ä»¥å…ˆè¿›è¡Œå°è¯•</span><br><span class="hljs-comment">	 */</span><br>	page = get_page_from_freelist(gfp_mask, order, alloc_flags, ac);<br>	<span class="hljs-keyword">if</span> (page)<br>		<span class="hljs-keyword">goto</span> got_pg;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * å¯¹äºä»£ä»·é«˜çš„åˆ†é…, é¦–å…ˆå°è¯•ç›´æ¥çš„ compactionï¼ˆè¯‘æ³¨ï¼šç¢ç‰‡æ•´ç†æœºåˆ¶ï¼‰,</span><br><span class="hljs-comment">	 * å› ä¸ºæœ‰å¯èƒ½æˆ‘ä»¬ä»æœ‰è¶³å¤Ÿçš„åŸºæœ¬é¡µé¢ï¼Œå¹¶ä¸éœ€è¦å»å›æ”¶. å¯¹äºä¸å¯è¿ç§»çš„é«˜é˜¶åˆ†é…ï¼Œ</span><br><span class="hljs-comment">	 * åŒæ ·è¿™ä¹ˆåš, å› ä¸º compaction å°†å°è¯•é€šè¿‡ä»ç›¸åŒè¿ç§»ç±»å‹çš„å—è¿›è¡Œè¿ç§»</span><br><span class="hljs-comment">	 * ä»¥é¿å…æ°¸ä¹…çš„ç¢ç‰‡. åˆ«å¯¹å…è®¸å¿½è§†æ°´ä½çº¿çš„åˆ†é…å°è¯•è¿™ä¸ªï¼Œå› ä¸º</span><br><span class="hljs-comment">	 * ALLOC_NO_WATERMARKS è¿˜æ²¡å‘ç”Ÿã€‚</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (can_direct_reclaim &amp;&amp;<br>			(costly_order ||<br>			   (order &gt; <span class="hljs-number">0</span> &amp;&amp; ac-&gt;migratetype != MIGRATE_MOVABLE))<br>			&amp;&amp; !gfp_pfmemalloc_allowed(gfp_mask)) &#123;<br>		page = __alloc_pages_direct_compact(gfp_mask, order,<br>						alloc_flags, ac,<br>						INIT_COMPACT_PRIORITY,<br>						&amp;compact_result);<br>		<span class="hljs-keyword">if</span> (page)<br>			<span class="hljs-keyword">goto</span> got_pg;<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * æ£€æŸ¥å¸¦æœ‰ __GFP_NORETRY çš„ä»£ä»·é«˜çš„åˆ†é…, å…¶</span><br><span class="hljs-comment">		 * åŒ…æ‹¬ä¸€äº› THP page fault çš„åˆ†é…</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (costly_order &amp;&amp; (gfp_mask &amp; __GFP_NORETRY)) &#123;<br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * è‹¥åˆ†é…æ•´ä¸ª pageblock(s) ä¸” compaction ç”±äºæ‰€æœ‰çš„ zone</span><br><span class="hljs-comment">			 * éƒ½åœ¨æ°´ä½çº¿ä¸‹å¤±è´¥äº†ï¼Œæˆ–æ˜¯è¢«ç¦æ­¢äº†å› ä¸ºå…¶æœ€è¿‘åœ¨è¯¥orderä¸Šå¤±è´¥äº†ï¼Œ</span><br><span class="hljs-comment">			 * é™¤éåˆ†é…å™¨æœ‰è¯·æ±‚çš„ compaction ä¸å›æ”¶å°è¯•ï¼Œå¦åˆ™ç›´æ¥å¤±è´¥</span><br><span class="hljs-comment">			 *</span><br><span class="hljs-comment">			 * å›æ”¶æ˜¯ï¼š</span><br><span class="hljs-comment">			 *  - å¯èƒ½éå¸¸æ˜‚è´µå› ä¸º zones å¯èƒ½è¿œä½äºä»–ä»¬çš„ä½æ°´ä½çº¿ï¼Œ</span><br><span class="hljs-comment">			 *    æˆ–æ˜¯è¿™æ˜¯éå¸¸çªå‘çš„é«˜é˜¶åˆ†é…çš„ä¸€éƒ¨åˆ†,</span><br><span class="hljs-comment">			 *  - ä¸ä¸€å®šä¼šæœ‰å¸®åŠ©å› ä¸º isolate_freepages() å¯èƒ½ä¸ä¼šåœ¨</span><br><span class="hljs-comment">			 *    è¢«é‡Šæ”¾çš„é¡µé¢ä¸Šè¿­ä»£ä½œä¸ºå…¶çº¿æ€§æ‰«æçš„ä¸€éƒ¨åˆ†ï¼Œä¸”</span><br><span class="hljs-comment">			 *  - ä¸å¤§å¯èƒ½ä¼šè®©æ•´ä¸ª pageblocks è‡ªå·±é‡Šæ”¾</span><br><span class="hljs-comment">			 */</span><br>			<span class="hljs-keyword">if</span> (compact_result == COMPACT_SKIPPED ||<br>			    compact_result == COMPACT_DEFERRED)<br>				<span class="hljs-keyword">goto</span> nopage;<br><br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * çœ‹èµ·æ¥å¥½åƒ reclaim/compaction æ˜¯å€¼å¾—å°è¯•çš„, ä½†</span><br><span class="hljs-comment">			 * åŒæ­¥çš„ compaction å¯èƒ½ä¼šéå¸¸ expensive, æ•…ä¿æŒ</span><br><span class="hljs-comment">			 * ä½¿ç”¨å¼‚æ­¥çš„ compaction.</span><br><span class="hljs-comment">			 */</span><br>			compact_priority = INIT_COMPACT_PRIORITY;<br>		&#125;<br>	&#125;<br><br>retry:<br>	<span class="hljs-comment">/* ç¡®ä¿åªè¦æˆ‘ä»¬å¾ªç¯ï¼Œ kswapd ä¾¿ä¸ä¼šæ„å¤–åœ°ä¼‘çœ  */</span><br>	<span class="hljs-keyword">if</span> (alloc_flags &amp; ALLOC_KSWAPD)<br>		wake_all_kswapds(order, gfp_mask, ac);<br><br>	reserve_flags = __gfp_pfmemalloc_flags(gfp_mask);<br>	<span class="hljs-keyword">if</span> (reserve_flags)<br>		alloc_flags = current_alloc_flags(gfp_mask, reserve_flags);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * è‹¥å†…å­˜ç­–ç•¥å¯ä»¥å¿½ç•¥ï¼Œé‡ç½® nodemask ä¸ zonelist è¿­ä»£å™¨ã€‚</span><br><span class="hljs-comment">	 * è¿™äº›åˆ†é…å…·æœ‰é«˜ä¼˜å…ˆçº§ä¸ç³»ç»Ÿæ€§ï¼Œè€Œéç”¨æˆ·å¯¼å‘ã€‚</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (!(alloc_flags &amp; ALLOC_CPUSET) || reserve_flags) &#123;<br>		ac-&gt;nodemask = <span class="hljs-literal">NULL</span>;<br>		ac-&gt;preferred_zoneref = first_zones_zonelist(ac-&gt;zonelist,<br>					ac-&gt;highest_zoneidx, ac-&gt;nodemask);<br>	&#125;<br><br>	<span class="hljs-comment">/* å¸¦ç€å¯èƒ½è°ƒæ•´è¿‡ zonelist ä¸ alloc_flags å†æ¬¡å°è¯• */</span><br>	page = get_page_from_freelist(gfp_mask, order, alloc_flags, ac);<br>	<span class="hljs-keyword">if</span> (page)<br>		<span class="hljs-keyword">goto</span> got_pg;<br><br>	<span class="hljs-comment">/* è°ƒç”¨æ–¹ä¸æƒ³è¦å›æ”¶, æˆ‘ä»¬æ— æ³•å¹³è¡¡ä»»ä½•äº‹ */</span><br>	<span class="hljs-keyword">if</span> (!can_direct_reclaim)<br>		<span class="hljs-keyword">goto</span> nopage;<br><br>	<span class="hljs-comment">/* é¿å…é€’å½’åœ°ç›´æ¥å›æ”¶ */</span><br>	<span class="hljs-keyword">if</span> (current-&gt;flags &amp; PF_MEMALLOC)<br>		<span class="hljs-keyword">goto</span> nopage;<br><br>	<span class="hljs-comment">/* å°è¯•ç›´æ¥å›æ”¶ååˆ†é… */</span><br>	page = __alloc_pages_direct_reclaim(gfp_mask, order, alloc_flags, ac,<br>							&amp;did_some_progress);<br>	<span class="hljs-keyword">if</span> (page)<br>		<span class="hljs-keyword">goto</span> got_pg;<br><br>	<span class="hljs-comment">/* å°è¯•ç›´æ¥ compaction ååˆ†é… */</span><br>	page = __alloc_pages_direct_compact(gfp_mask, order, alloc_flags, ac,<br>					compact_priority, &amp;compact_result);<br>	<span class="hljs-keyword">if</span> (page)<br>		<span class="hljs-keyword">goto</span> got_pg;<br><br>	<span class="hljs-comment">/* è‹¥æ˜¯ç‰¹åˆ«æŒ‡å®šçš„è¯·æ±‚ï¼Œä¸è¦å¾ªç¯ */</span><br>	<span class="hljs-keyword">if</span> (gfp_mask &amp; __GFP_NORETRY)<br>		<span class="hljs-keyword">goto</span> nopage;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * ä¸è¦é‡è¯•é«˜èŠ±é”€çš„é«˜é˜¶åˆ†é…é™¤éä»–ä»¬æ˜¯</span><br><span class="hljs-comment">	 * __GFP_RETRY_MAYFAIL</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (costly_order &amp;&amp; !(gfp_mask &amp; __GFP_RETRY_MAYFAIL))<br>		<span class="hljs-keyword">goto</span> nopage;<br><br>	<span class="hljs-keyword">if</span> (should_reclaim_retry(gfp_mask, order, ac, alloc_flags,<br>				 did_some_progress &gt; <span class="hljs-number">0</span>, &amp;no_progress_loops))<br>		<span class="hljs-keyword">goto</span> retry;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * è‹¥0é˜¶çš„å›æ”¶æ— æ³•å–å¾—ä»»ä½•è¿›å±•ï¼Œåˆ™é‡è¯• compaction æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œ</span><br><span class="hljs-comment">	 * å› ä¸ºå½“å‰å¯¹ compaction çš„å®ç°æ˜¯åŸºäºæœ‰è¶³å¤Ÿçš„ç©ºé—²å†…å­˜çš„</span><br><span class="hljs-comment">	 *  (å‚è§ __compaction_suitable)</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (did_some_progress &gt; <span class="hljs-number">0</span> &amp;&amp;<br>			should_compact_retry(ac, order, alloc_flags,<br>				compact_result, &amp;compact_priority,<br>				&amp;compaction_retries))<br>		<span class="hljs-keyword">goto</span> retry;<br><br><br>	<span class="hljs-comment">/* åœ¨æˆ‘ä»¬å¼€å§‹ OOM killing ä¹‹å‰å¤„ç†å¯èƒ½çš„ cpuset æ›´æ–°ç«äº‰ */</span><br>	<span class="hljs-keyword">if</span> (check_retry_cpuset(cpuset_mems_cookie, ac))<br>		<span class="hljs-keyword">goto</span> retry_cpuset;<br><br>	<span class="hljs-comment">/* å›æ”¶å¤±è´¥äº†, å¼€å§‹ killing ä¸€äº›ä¸œè¥¿ */</span><br>    <span class="hljs-comment">// è¦æ€ä¸€äº›è¿›ç¨‹æˆ–æ˜¯åˆ«çš„ä¸œè¥¿æ¥è…¾å†…å­˜äº†</span><br>	page = __alloc_pages_may_oom(gfp_mask, order, ac, &amp;did_some_progress);<br>	<span class="hljs-keyword">if</span> (page)<br>		<span class="hljs-keyword">goto</span> got_pg;<br><br>	<span class="hljs-comment">/* åœ¨æ— å°½çš„å¾ªç¯ä¸­é¿å…æ²¡æœ‰æ°´ä½çº¿çš„åˆ†é… */</span><br>	<span class="hljs-keyword">if</span> (tsk_is_oom_victim(current) &amp;&amp;<br>	    (alloc_flags &amp; ALLOC_OOM ||<br>	     (gfp_mask &amp; __GFP_NOMEMALLOC)))<br>		<span class="hljs-keyword">goto</span> nopage;<br><br>	<span class="hljs-comment">/* è‹¥ OOM killer å–å¾—äº†ä¸€äº›æˆæ•ˆï¼Œé‡è¯• */</span><br>	<span class="hljs-keyword">if</span> (did_some_progress) &#123;<br>		no_progress_loops = <span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">goto</span> retry;<br>	&#125;<br><br>nopage:<br>	<span class="hljs-comment">/* åœ¨æˆ‘ä»¬å¤±è´¥ä¹‹å‰å¤„ç†å¯èƒ½çš„ cpuset çš„æ›´æ–°ç«äº‰ */</span><br>	<span class="hljs-keyword">if</span> (check_retry_cpuset(cpuset_mems_cookie, ac))<br>		<span class="hljs-keyword">goto</span> retry_cpuset;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * ç¡®ä¿ __GFP_NOFAIL è¯·æ±‚æ²¡æœ‰æ³„éœ²ä¸”ç¡®ä¿æˆ‘ä»¬ä¸€ç›´åœ¨é‡è¯•</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (gfp_mask &amp; __GFP_NOFAIL) &#123;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * æ‰€æœ‰å­˜åœ¨çš„ __GFP_NOFAIL ç”¨æˆ·éƒ½æ˜¯å¯ä»¥è¢«é˜»å¡çš„, </span><br><span class="hljs-comment">		 * æ•…å¯¹ä»»ä½•æ–°çš„å®é™…ä¸Šéœ€è¦ GFP_NOWAIT çš„ç”¨æˆ·è¿›è¡Œè­¦å‘Š</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (WARN_ON_ONCE(!can_direct_reclaim))<br>			<span class="hljs-keyword">goto</span> fail;<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * è¿™ä¸ªä¸Šä¸‹æ–‡çš„ PF_MEMALLOC è¯·æ±‚éå¸¸å¥‡æ€ª</span><br><span class="hljs-comment">		 * å› ä¸ºæˆ‘ä»¬ä¸èƒ½å›æ”¶ä»»ä½•ä¸œè¥¿åªèƒ½å¾ªç¯ç­‰å¾…</span><br><span class="hljs-comment">		 * æŸäººæ¥ä¸ºæˆ‘ä»¬åšäº›ä»€ä¹ˆ</span><br><span class="hljs-comment">		 */</span><br>		WARN_ON_ONCE(current-&gt;flags &amp; PF_MEMALLOC);<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * æ— å¤±è´¥çš„é«˜å¼€é”€çš„ orders æ˜¯ä¸€é¡¹è‰°å·¨çš„è¦æ±‚ï¼Œ</span><br><span class="hljs-comment">		 * æˆ‘ä»¬å¯¹æ­¤å¹¶æ²¡æœ‰å¤ªå¤šå‡†å¤‡ï¼Œæ•…è®©æˆ‘ä»¬è­¦å‘Šè¿™äº›ç”¨æˆ·</span><br><span class="hljs-comment">		 * ä»¥ä¾¿äºæˆ‘ä»¬èƒ½å¤Ÿè¯†åˆ«å‡ºä»–ä»¬å¹¶å°†ä¹‹è½¬åŒ–ä¸ºåˆ«çš„ä¸œè¥¿</span><br><span class="hljs-comment">		 */</span><br>		WARN_ON_ONCE(order &gt; PAGE_ALLOC_COSTLY_ORDER);<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * é€šè¿‡è®©ä»–ä»¬èƒ½è®¿é—®ä¿ç•™çš„å†…å­˜æ¥å¸®åŠ©éå¤±è´¥çš„åˆ†é…</span><br><span class="hljs-comment">		 * ä½†ä¸ä½¿ç”¨ ALLOC_NO_WATERMARKS å› ä¸ºè¿™å¯èƒ½</span><br><span class="hljs-comment">		 * å¤§é‡å‡å°‘å†…å­˜ä¿ç•™åŒºè€Œè®©æƒ…å†µæ›´å</span><br><span class="hljs-comment">		 */</span><br>		page = __alloc_pages_cpuset_fallback(gfp_mask, order, ALLOC_HARDER, ac);<br>		<span class="hljs-keyword">if</span> (page)<br>			<span class="hljs-keyword">goto</span> got_pg;<br><br>		cond_resched();<br>		<span class="hljs-keyword">goto</span> retry;<br>	&#125;<br>fail:<br>	warn_alloc(gfp_mask, ac-&gt;nodemask,<br>			<span class="hljs-string">&quot;page allocation failure: order:%u&quot;</span>, order);<br>got_pg:<br>	<span class="hljs-keyword">return</span> page;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œæˆ‘ä»¬å…ˆè¡¥å……ä¸€ä¸ªæ¦‚å¿µâ€”â€”<code>Memory compaction</code> æœºåˆ¶ï¼Œå…¶å®å°±æ˜¯æ•´ç†å†…å­˜ç¢ç‰‡ï¼Œå¯¹é›¶æ•£çš„å†…å­˜é¡µè¿›è¡Œè¿ç§»ï¼Œä»è€Œå°†é›¶æ•£çš„ç©ºé—²å†…å­˜é¡µå˜æˆå¤§å—çš„ç©ºé—²å†…å­˜ï¼Œä¸è¿‡è¿™é‡Œåªæ•´ç†å¯ä»¥ç§»åŠ¨çš„ç¢ç‰‡ï¼š</p>
<p><img src="https://i.loli.net/2021/11/30/q7T6EjtIb9PVFY3.png" srcset="/img/loading.gif" lazyload alt="ä»çŸ¥ä¹å·çš„å›¾.png"></p>
<p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹æ…¢é€Ÿåˆ†é…çš„æ•´ä¸ªæµç¨‹ï¼š</p>
<ul>
<li>ä½¿ç”¨åŸæœ‰çš„ gfp_flag é‡æ–°è®¾ç½® alloc_flagï¼Œå¹¶é‡æ–°è®¡ç®— preferred zoneï¼Œè‹¥è®¾ç½®äº† <code>ALLOC_KSWAPD</code> åˆ™è°ƒç”¨ <code>wake_all_kswapds()</code> å”¤é†’ kswapd çº¿ç¨‹è¿›è¡Œå†…å­˜å›æ”¶</li>
<li>ä¹‹åé‡æ–°å°è¯•å¿«é€Ÿè·¯å¾„çš„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›</li>
<li>æ¥ä¸‹æ¥è°ƒç”¨ <code>__alloc_pages_direct_compact()</code> è¿›è¡Œ compactionï¼Œè¯¥å‡½æ•°å†…éƒ¨åœ¨æ•´ç†å®Œåä¼šé‡æ–°å°è¯•å¿«é€Ÿè·¯å¾„çš„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›</li>
<li>ï¼ˆretryï¼‰æ¥ä¸‹æ¥è°ƒç”¨ <code>wake_all_kswapds()</code> å”¤é†’ kswapd çº¿ç¨‹è¿›è¡Œå†…å­˜å›æ”¶</li>
<li>è°ƒæ•´ zonelist ä¸ alloc_flagï¼Œä¹‹åå†æ¬¡å°è¯•å¿«é€Ÿè·¯å¾„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›</li>
<li>è‹¥ gfp_flag ä¸­æ²¡æœ‰ <code>__GFP_DIRECT_RECLAIM</code> æˆ–æ˜¯è¿›ç¨‹ PCB çš„ flag ä¸­æœ‰ <code>PF_MEMALLOC</code>ï¼Œç›´æ¥è·³è½¬åˆ° ï¼ˆnopageï¼‰</li>
<li>è°ƒç”¨ <code>__alloc_pages_direct_reclaim()</code> è¿›è¡Œå†…å­˜å›æ”¶ï¼ˆå†…éƒ¨è°ƒç”¨ <code>__perform_reclaim()</code>ï¼‰ä¸å¿«é€Ÿè·¯å¾„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›</li>
<li>è°ƒç”¨ <code>__alloc_pages_direct_compact()</code> è¿›è¡Œ compaction ä¸å¿«é€Ÿè·¯å¾„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›</li>
<li>å¦‚æœè®¾ç½®äº† <code>__GFP_NORETRY</code> ï¼Œæˆ–æ˜¯è¯¥æ¬¡å†…å­˜åˆ†é…å¼€é”€è¾ƒé«˜ï¼ˆ<code>order &gt; PAGE_ALLOC_COSTLY_ORDER</code>ï¼‰ä¸”æœªè®¾ç½® <code>__GFP_RETRY_MAYFAIL</code>ï¼Œç›´æ¥è·³åˆ° ï¼ˆnopageï¼‰</li>
<li>è°ƒç”¨ <code>should_reclaim_retry()</code> åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°å›æ”¶ï¼Œè‹¥æ˜¯åˆ™è·³å›ï¼ˆretryï¼‰</li>
<li>è°ƒç”¨ <code>should_compact_retry()</code> åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°è¿›è¡Œ compactionï¼Œè‹¥æ˜¯åˆ™è·³å›ï¼ˆretryï¼‰</li>
<li>è°ƒç”¨ <code>check_retry_cpuset()</code> æ£€æŸ¥ cpuset æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œè‹¥æ˜¯åˆ™è·³è½¬å›å¼€å¤´</li>
<li>è°ƒç”¨ <code>__alloc_pages_may_oom()</code> å°è¯• kill ä¸€äº›è¿›ç¨‹æ¥é‡Šæ”¾å†…å­˜ï¼Œè¯¥å‡½æ•°å†…é¦–å…ˆè¿˜æ˜¯ä¼šå…ˆè¿›è¡Œä¸€æ¬¡å¿«é€Ÿåˆ†é…ï¼Œä¹‹åæ‰æ˜¯è°ƒç”¨ <code>out_of_memory()</code> æ¥æ€æ‰æœ€é€‚åˆçš„è¿›ç¨‹ä»¥é‡Šæ”¾å†…å­˜ï¼Œæœ€åè‹¥è®¾ç½®äº† <code>__GFP_NOFAIL</code> åˆ™è°ƒç”¨ <code>__alloc_pages_cpuset_fallback()</code> å†æ¬¡å°è¯•å†…å­˜åˆ†é…ï¼Œåœ¨è¯¥å‡½æ•°ä¸­ä¼šä¸¤æ¬¡èµ°å¿«é€Ÿè·¯å¾„è¿›è¡Œåˆ†é…ï¼ˆç¬¬ä¸€æ¬¡ä¼šé¢å¤–é™„åŠ ä¸Š <code>ALLOC_CPUSET</code> çš„ flagï¼‰</li>
<li>å¦‚æœæŠŠå½“å‰è¿›ç¨‹æ€æ‰äº†ï¼Œè·³åˆ°ï¼ˆnopageï¼‰ï¼›å¦‚æœæ€è¿›ç¨‹å–å¾—äº†æˆæ•ˆï¼Œè·³å›ï¼ˆretryï¼‰</li>
<li>ï¼ˆnopageï¼‰è°ƒç”¨ <code>check_retry_cpuset()</code> æ£€æŸ¥ cpuset æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œè‹¥æ˜¯åˆ™è·³è½¬å›å¼€å¤´</li>
<li>è‹¥è®¾ç½®äº† <code>__GFP_NOFAIL</code> åˆ™è¿›è¡Œä¸€ç³»åˆ—çš„è­¦å‘Šï¼Œå¹¶è°ƒç”¨ <code>__alloc_pages_cpuset_fallback()</code> å†æ¬¡å°è¯•å†…å­˜åˆ†é…ï¼Œè‹¥æœªæˆåŠŸåˆ™è·³å›ï¼ˆretryï¼‰</li>
<li>è¿”å›ç»“æœ</li>
</ul>
<p><img src="https://s2.loli.net/2022/07/06/eCg12KJIZuw9aon.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="å››ã€ä¸Šå±‚å°è£…åˆ†é…å‡½æ•°"><a href="#å››ã€ä¸Šå±‚å°è£…åˆ†é…å‡½æ•°" class="headerlink" title="å››ã€ä¸Šå±‚å°è£…åˆ†é…å‡½æ•°"></a>å››ã€<em>ä¸Šå±‚å°è£…åˆ†é…å‡½æ•°</em></h2><p>åœ¨ <code>__alloc_pages_nodemask()</code> ä¸Šå±‚ä¸»è¦æœ‰ä¸‰ä¸ªé¡µé¢åˆ†é…å‡½æ•°ï¼Œå…¶è°ƒç”¨è·¯å¾„å¦‚ä¸‹ï¼š</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-variable">__alloc_pages_node</span>  <span class="hljs-comment">/*è¿”å›struct pageçš„æŒ‡é’ˆ*/</span><br>    <span class="hljs-variable">__alloc_pages</span><br>    	<span class="hljs-variable">__alloc_pages_nodemask</span><br><br>alloc_pages         <span class="hljs-comment">/*è¿”å›struct pageçš„æŒ‡é’ˆ*/</span><br>    alloc_pages_current<br>    	<span class="hljs-variable">__alloc_pages_nodemask</span><br>        <br><span class="hljs-variable">__get_free_pages</span>    <span class="hljs-comment">/*è¿”å›é¡µé¢çš„è™šæ‹Ÿåœ°å€*/</span><br>    alloc_pages<br>        alloc_pages_current<br>            <span class="hljs-variable">__alloc_pages_nodemask</span><br></code></pre></td></tr></table></figure>

<h1 id="0x03-é¡µçš„é‡Šæ”¾"><a href="#0x03-é¡µçš„é‡Šæ”¾" class="headerlink" title="0x03.é¡µçš„é‡Šæ”¾"></a>0x03.é¡µçš„é‡Šæ”¾</h1><p>å‰é¢æˆ‘ä»¬è®²äº†é¡µé¢æ˜¯å¦‚ä½•åˆ†é…çš„ï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹é¡µé¢æ˜¯å¦‚ä½•é‡Šæ”¾çš„</p>
<h2 id="ä¸€ã€-free-one-page-ï¼šé‡Šæ”¾é¡µé¢çš„æ ¸å¿ƒå‡½æ•°"><a href="#ä¸€ã€-free-one-page-ï¼šé‡Šæ”¾é¡µé¢çš„æ ¸å¿ƒå‡½æ•°" class="headerlink" title="ä¸€ã€__free_one_page()ï¼šé‡Šæ”¾é¡µé¢çš„æ ¸å¿ƒå‡½æ•°"></a>ä¸€ã€__free_one_page()ï¼šé‡Šæ”¾é¡µé¢çš„æ ¸å¿ƒå‡½æ•°</h2><p>è¯¥å‡½æ•°æ˜¯ buddy system ä¸­ç”¨ä»¥è¿›è¡Œé¡µé¢é‡Šæ”¾çš„<strong>æ ¸å¿ƒå‡½æ•°</strong>ï¼Œæ‰€æœ‰çš„é¡µé¢é‡Šæ”¾ API éƒ½æ˜¯åŸºäºè¯¥å‡½æ•°çš„å°è£…</p>
<p>è¯¥å‡½æ•°å®šä¹‰äº <code>/mm/page_alloc.c</code> ä¸­ï¼Œä¸»è¦ä½œç”¨æ˜¯å°†ç‰¹å®šé¡µé¢é‡Šæ”¾åˆ°ç‰¹å®š zone ä¸Šï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œçš„ <code>one page</code> ä¸æ˜¯ä¸€å¼ é¡µæ¡†è€Œæ˜¯ä¸€å—è¿ç»­å†…å­˜ï¼ˆå¯èƒ½æœ‰å¤šå¼ é¡µï¼‰</p>
<p>è¿˜éœ€è¦æ³¨æ„çš„æ˜¯è¿™æ˜¯ä¸€ä¸ªé‡Šæ”¾é¡µé¢çš„<strong>åŸºæœ¬å‡½æ•°</strong>ï¼Œæ•…æˆ‘ä»¬éœ€è¦æä¾›å¾…é‡Šæ”¾é¡µé¢çš„é¡µç»“æ„ä½“ï¼ˆstruct pageï¼‰ã€é¡µæ¡†å·ã€é¡µé¢å—çš„é˜¶ï¼ˆorderï¼‰ã€ç›®æ ‡ zoneã€è¿ç§»ç±»å‹ç­‰ä¿¡æ¯â€”â€”è¿™äº›ä¿¡æ¯é€šå¸¸ç”±ä¸Šå±‚å°è£…å‡½æ•°æä¾›ï¼Œè¿™ä¸ªå‡½æ•°æ‰€åšçš„åªæ˜¯ç®€å•åœ°å°†é¡µæŒ‚å›å¯¹åº”é“¾è¡¨å¹¶æ£€æŸ¥åˆå¹¶çš„æ“ä½œ</p>
<p>å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * buddy system åˆ†é…å™¨çš„é‡Šæ”¾å‡½æ•°.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * buddy system çš„æƒ³æ³•æ˜¯ä¸ºå¤šç§â€œordersâ€çš„å†…å­˜å—</span><br><span class="hljs-comment"> * ç»´æŠ¤ä¸€ä¸ªç›´æ¥æ˜ å°„è¡¨ï¼ˆåŒ…å«ä½å€¼ï¼‰. åº•éƒ¨çº§åˆ«çš„è¡¨åŒ…å«</span><br><span class="hljs-comment"> * å¯¹æœ€å°çš„å¯åˆ†é…å†…å­˜å•å…ƒï¼ˆè¿™é‡Œä¾¿æ˜¯é¡µé¢ï¼‰çš„æ˜ å°„,</span><br><span class="hljs-comment"> * è€Œå¾€ä¸Šæ¯æ›´é«˜ä¸€çº§åˆ™æè¿°äº†ä»å…¶ä¸‹çš„ä¸€çº§çš„ä¸€å¯¹å•å…ƒï¼Œå› æ­¤æ˜¯&quot;buddies&quot;.</span><br><span class="hljs-comment"> * ä»é«˜å±‚çœ‹ï¼Œè¿™é‡Œæ‰€åšçš„ä»…æ˜¯åœ¨æ ‡è®°åº•å±‚å¯ç”¨çš„è¡¨é¡¹ï¼Œ</span><br><span class="hljs-comment"> * å¹¶æ ¹æ®éœ€è¦å‘ä¸Šä¼ æ’­æ›´æ”¹ï¼Œå†åŠ ä¸Šä¸€äº›ä¸ VM ç³»ç»Ÿçš„å…¶ä»–éƒ¨åˆ†</span><br><span class="hljs-comment"> * è‰¯å¥½åä½œæ‰€éœ€è¦çš„è®¡æ•°ã€‚</span><br><span class="hljs-comment"> * åœ¨æ¯ä¸ªçº§åˆ«, æˆ‘ä»¬éƒ½ä¿æŒä¸€ä¸ª pages çš„ list, ä½œä¸ºè¿ç»­çš„</span><br><span class="hljs-comment"> * é•¿åº¦ä¸º(1 &lt;&lt; order)çš„ç©ºé—²é¡µçš„å¤´èŠ‚ç‚¹å¹¶æ ‡è®°ä¸Š PageBuddy.</span><br><span class="hljs-comment"> * Page&#x27;s order è¢«è®°å½•åœ¨ page_private(page) åŸŸ.</span><br><span class="hljs-comment"> * æ•…å½“æˆ‘ä»¬åœ¨åˆ†é…æˆ–é‡Šæ”¾å…¶ä¸€æ—¶, æˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦ä¸€ä¸ªçš„çŠ¶æ€ã€‚</span><br><span class="hljs-comment"> * ä¹Ÿå°±æ˜¯è¯´ï¼Œè‹¥æˆ‘ä»¬åˆ†é…ä¸€ä¸ªå°çš„å—ï¼Œè€Œä¸¤ä¸ªéƒ½æ˜¯ç©ºé—²çš„ï¼Œ</span><br><span class="hljs-comment"> * åŒºåŸŸçš„å‰©ä½™éƒ¨åˆ†å¿…é¡»è¢«åˆ†å‰²æˆå—. è‹¥ä¸€ä¸ªå—è¢«é‡Šæ”¾äº†ï¼Œ</span><br><span class="hljs-comment"> * è€Œä»–çš„ buddy ä¹Ÿæ˜¯é—²ç½®çš„, é‚£ä¹ˆè¿™å°†è§¦å‘åˆå¹¶æˆä¸€ä¸ªæ›´å¤§çš„å—</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * -- nyc</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> __free_one_page(<span class="hljs-keyword">struct</span> page *page,<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> pfn,<br>		<span class="hljs-keyword">struct</span> zone *zone, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order,<br>		<span class="hljs-type">int</span> migratetype, <span class="hljs-type">fpi_t</span> fpi_flags)<br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">capture_control</span> *<span class="hljs-title">capc</span> =</span> task_capc(zone);<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> buddy_pfn;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> combined_pfn;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> max_order;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">buddy</span>;</span><br>	<span class="hljs-type">bool</span> to_tail;<br><br>    <span class="hljs-comment">// è¿™é‡Œçš„ MAX_ORDER å’Œ pageblock_order éƒ½æ˜¯å®</span><br>	max_order = <span class="hljs-type">min_t</span>(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, MAX_ORDER - <span class="hljs-number">1</span>, pageblock_order);<br><br>	VM_BUG_ON(!zone_is_initialized(zone));<br>	VM_BUG_ON_PAGE(page-&gt;flags &amp; PAGE_FLAGS_CHECK_AT_PREP, page);<br><br>	VM_BUG_ON(migratetype == <span class="hljs-number">-1</span>);<br>	<span class="hljs-keyword">if</span> (likely(!is_migrate_isolate(migratetype)))<br>		__mod_zone_freepage_state(zone, <span class="hljs-number">1</span> &lt;&lt; order, migratetype);<br><br>	VM_BUG_ON_PAGE(pfn &amp; ((<span class="hljs-number">1</span> &lt;&lt; order) - <span class="hljs-number">1</span>), page);<br>	VM_BUG_ON_PAGE(bad_range(zone, page), page);<br><br>continue_merging:<br>	<span class="hljs-keyword">while</span> (order &lt; max_order) &#123;<br>		<span class="hljs-keyword">if</span> (compaction_capture(capc, page, order, migratetype)) &#123;<br>			__mod_zone_freepage_state(zone, -(<span class="hljs-number">1</span> &lt;&lt; order),<br>								migratetype);<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br>		buddy_pfn = __find_buddy_pfn(pfn, order);	<span class="hljs-comment">// è®¡ç®— buddy é¡µæ¡†å·</span><br>		buddy = page + (buddy_pfn - pfn);		<span class="hljs-comment">// è®¡ç®— buddy çš„é¡µç»“æ„ä½“ï¼Œæ³¨æ„è¿™é‡Œæ˜¯æŒ‡é’ˆåŠ æ³•</span><br><br>		<span class="hljs-keyword">if</span> (!pfn_valid_within(buddy_pfn)) <span class="hljs-comment">// é¡µæ¡†å·åˆæ³•æ€§æ£€æŸ¥</span><br>			<span class="hljs-keyword">goto</span> done_merging;<br>		<span class="hljs-keyword">if</span> (!page_is_buddy(page, buddy, order))  <span class="hljs-comment">// æ£€æŸ¥ page å’Œ buddy æ˜¯å¦æ˜¯ä¸€å¯¹</span><br>			<span class="hljs-keyword">goto</span> done_merging;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * æˆ‘ä»¬çš„ buddyï¼ˆè¯‘æ³¨ï¼šé‡Šæ”¾é¡µé¢çš„â€œé…å¯¹â€é¡µé¢ï¼Œå¯ä»¥çœ‹å¼€å¤´çš„æ³¨é‡Šï¼‰ æ˜¯ç©ºé—²çš„</span><br><span class="hljs-comment">		 * æˆ–å…¶ä¸º CONFIG_DEBUG_PAGEALLOC çš„ guard pageï¼Œ</span><br><span class="hljs-comment">		 * ä¸å…¶åˆå¹¶åå‡åˆ°é«˜ä¸€çº§çš„orderã€‚</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (page_is_guard(buddy))<br>			clear_page_guard(zone, buddy, order, migratetype);<br>		<span class="hljs-keyword">else</span><br>			del_page_from_free_list(buddy, zone, order);<br>		combined_pfn = buddy_pfn &amp; pfn;<br>		page = page + (combined_pfn - pfn);<br>		pfn = combined_pfn;<br>		order++;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (order &lt; MAX_ORDER - <span class="hljs-number">1</span>) &#123;<br>		<span class="hljs-comment">/* è‹¥æˆ‘ä»¬åˆ°äº†è¿™ï¼Œè¿™æ„å‘³ç€ order &gt;= pageblock_order.</span><br><span class="hljs-comment">		 * æˆ‘ä»¬æƒ³è¦é¢„é˜²åœ¨å¸¸è§„ pageblock ä¸ç‹¬ç«‹çš„pageblock ä¹‹é—´çš„åˆå¹¶ã€‚</span><br><span class="hljs-comment">		 * æ²¡æœ‰è¿™ä¸ªï¼Œpageblockéš”ç¦»å¯èƒ½é€ æˆé”™è¯¯çš„ç©ºé—²é¡µæˆ–CMAè®¡æ•°. </span><br><span class="hljs-comment">		 *</span><br><span class="hljs-comment">		 * æˆ‘ä»¬ä¸æƒ³ä¸ºäº†æ›´é¢‘ç¹çš„ä½é˜¶åˆå¹¶ä½¿ç”¨è¿™ä¸ªä»£ç </span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (unlikely(has_isolate_pageblock(zone))) &#123;<br>			<span class="hljs-type">int</span> buddy_mt;<br><br>			buddy_pfn = __find_buddy_pfn(pfn, order);<br>			buddy = page + (buddy_pfn - pfn);<br>			buddy_mt = get_pageblock_migratetype(buddy);<br><br>			<span class="hljs-keyword">if</span> (migratetype != buddy_mt<br>					&amp;&amp; (is_migrate_isolate(migratetype) ||<br>						is_migrate_isolate(buddy_mt)))<br>				<span class="hljs-keyword">goto</span> done_merging;<br>		&#125;<br>		max_order = order + <span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">goto</span> continue_merging;<br>	&#125;<br><br>done_merging:<br>	set_buddy_order(page, order); <span class="hljs-comment">// åœ¨ page-&gt;private ä¸­å‚¨å­˜å…¶ order</span><br><br>    <span class="hljs-comment">// åˆ¤æ–­æ˜¯æ’åˆ°é“¾è¡¨å¤´è¿˜æ˜¯é“¾è¡¨å°¾ï¼Œé€šå¸¸æ˜¯é“¾è¡¨å¤´ï¼Œå³éµå¾ª LIFO</span><br>	<span class="hljs-keyword">if</span> (fpi_flags &amp; FPI_TO_TAIL)<br>		to_tail = <span class="hljs-literal">true</span>;<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (is_shuffle_order(order))<br>		to_tail = shuffle_pick_tail();<br>	<span class="hljs-keyword">else</span><br>        <span class="hljs-comment">// è¯¥å‡½æ•°ä¼šæ£€æŸ¥æ˜¯å¦ä¸‹ä¸€ä¸ªæœ€é«˜é˜¶çš„ buddy æ˜¯å¦ç©ºé—²</span><br>        <span class="hljs-comment">// è‹¥æ˜¯ï¼Œåˆ™å¯èƒ½æ­£åœ¨é‡Šæ”¾çš„é¡µé¢å—å°†å¾ˆå¿«è¢«åˆå¹¶ï¼Œæ­¤æ—¶æˆ‘ä»¬åº”å½“å°†å…¶æ·»åŠ åˆ°é“¾è¡¨çš„å°¾éƒ¨</span><br>        <span class="hljs-comment">// è¿™æ ·å°±ä¸å¤§å¯èƒ½åˆè¢«åˆ«çš„è¿›ç¨‹å¾ˆå¿«å°±åˆ†é…èµ°äº†ï¼Œè€Œæ˜¯å¯èƒ½è¢«åˆå¹¶ä¸ºé«˜é˜¶é¡µé¢</span><br>		to_tail = buddy_merge_likely(pfn, buddy_pfn, page, order);<br><br>    <span class="hljs-comment">// æ’å…¥ç‰¹å®šè¿ç§»é“¾è¡¨</span><br>	<span class="hljs-keyword">if</span> (to_tail)<br>		add_to_free_list_tail(page, zone, order, migratetype);<br>	<span class="hljs-keyword">else</span><br>		add_to_free_list(page, zone, order, migratetype);<br><br>	<span class="hljs-comment">/* Notify page reporting subsystem of freed page */</span><br>	<span class="hljs-keyword">if</span> (!(fpi_flags &amp; FPI_SKIP_REPORT_NOTIFY))<br>		page_reporting_notify_free(order);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å°†ä¸å¾…é‡Šæ”¾é¡µé¢å‡‘æˆä¸€å¯¹çš„å†…å­˜å—ç§°ä¸º buddyï¼Œæ‰€è°“å‡‘æˆä¸€å¯¹ä¾¿æ˜¯<strong>è¿™ä¸¤ä¸ªå†…å­˜å—åœ¨ç‰©ç†ä¸Šè¿ç»­ï¼Œä¸”èƒ½å‡‘æˆä¸€ä¸ªæ›´é«˜ä¸€é˜¶çš„å¤§å†…å­˜å—</strong>ï¼Œç”±æ­¤ç§°ä¹‹ä¸ºä¸€å¯¹ buddies</p>
<p>è¯¥å‡½æ•°ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>ï¼ˆcontinue_mergingï¼Œå¾ªç¯å¼€å¤´ï¼‰è°ƒç”¨ <code>__find_buddy_pfn()</code> è®¡ç®—å¾…é‡Šæ”¾é¡µé¢çš„ buddy çš„ç¬¬ä¸€å¼ ç‰©ç†é¡µçš„é¡µæ¡†å·ï¼Œç®—æ³•æ¯”è¾ƒæš´åŠ›ï¼š<code>page_pfn ^ (1 &lt;&lt; order)</code></li>
<li>è°ƒç”¨ <code>page_is_buddy()</code> æ£€æŸ¥ buddy ä¸ å¾…é‡Šæ”¾é¡µé¢æ˜¯å¦æ˜¯ä¸€å¯¹ buddiesï¼Œè‹¥å¦ï¼Œåˆ™è·³åˆ°ï¼ˆdone_mergingï¼‰ï¼Œè¿™é‡Œçš„æ£€æŸ¥éœ€è¦æ»¡è¶³å››ä¸ªè¦ç´ ï¼š<ul>
<li>buddy ä¸åœ¨ç©ºæ´ä¸­</li>
<li>buddy åœ¨ buddy system ä¸­ï¼ˆå³ buddy ä¹Ÿæ˜¯ç©ºé—²å†…å­˜å—ï¼‰</li>
<li>å¾…é‡Šæ”¾é¡µé¢ä¸å…¶ buddy åœ¨åŒä¸€ä¸ª zone ä¸­</li>
<li>å¾…é‡Šæ”¾é¡µé¢ä¸å…¶ buddy æœ‰ç€åŒæ ·çš„é˜¶ï¼ˆorderï¼‰</li>
</ul>
</li>
<li>è‹¥ buddy ä¸º guard pageï¼Œåˆ™è°ƒç”¨ <code>clear_page_guard()</code> æ¸…æ¥šè¿™ä¸ªå±æ€§è®©å…¶å˜æˆç©ºé—²é¡µé¢ï¼Œè¿™é‡Œæ¸…é™¤çš„æ“ä½œæ˜¯é€šè¿‡å°† page ç»“æ„ä½“çš„ private å­—æ®µç½® 0 å®ç°çš„ï¼›è‹¥å¦ï¼Œåˆ™è¯´æ˜æ˜¯å¸¸è§„çš„ç©ºé—²é¡µé¢ï¼Œè°ƒç”¨ <code>del_page_from_free_list()</code> å°†å…¶è„±é“¾</li>
<li>æ­¤æ—¶æˆ‘ä»¬çš„æ–°çš„é«˜é˜¶å†…å­˜å—å°±å®Œæˆåˆæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å›åˆ°å¾ªç¯å¼€å¤´é‡æ–°å¯»æ‰¾è¿™ä¸ªåˆæˆçš„æ–°å†…å­˜å—çš„ buddyï¼Œè¿™ä¸ªå¾ªç¯ä¸€ç›´æŒç»­åˆ° <code>max_order</code> ï¼ˆä¸€èˆ¬æ˜¯10ï¼‰ï¼Œä½œä¸ºä¸‹ä¸€æ¬¡å¾ªç¯çš„é¡µæ¡†å·çš„è®¡ç®—æ–¹å¼æ˜¯ <code>buddy_pfn &amp; pfn</code>ï¼Œä¹‹ååšæŒ‡é’ˆè¿ç®— <code>page + (combined_pfn - pfn)</code> æ‰¾åˆ°å¯¹åº”çš„ page ç»“æ„ä½“</li>
<li>è‹¥é€€å‡ºå¾ªç¯æ—¶çš„ order æ»¡è¶³ <code>order &lt; MAX_ORDER - 1</code> ï¼Œåˆ™è°ƒç”¨ <code>has_isolate_pageblock()</code> æ£€æŸ¥ zone ä¸­æ˜¯å¦æœ‰ isolate blockï¼Œè‹¥æ˜¯åˆ™è¿›è¡Œç›¸å…³æ“ä½œï¼ˆ<del>è¿™å—ä»£ç è¿˜æ²¡çœ‹æ‡‚</del>ï¼‰ï¼Œæœ€åè·³è½¬å›ï¼ˆcontinue_mergingï¼‰ï¼›è¿™ä¸€æ­¥ä¸»è¦æ˜¯é˜²æ­¢ isolate pageblock ä¸å¸¸è§„çš„ pageblock å‘ç”Ÿåˆå¹¶</li>
<li>ï¼ˆdone_mergingï¼‰è¿™ä¸€æ­¥ä¸»è¦æ˜¯è°ƒç”¨ <code>set_buddy_order()</code> åœ¨ page ç»“æ„ä½“çš„ private å­—æ®µå­˜æ”¾è¯¥å†…å­˜å—çš„ order</li>
<li>è‹¥æ˜¯è®¾ç½®äº† <code>FPI_TO_TAIL</code> flagï¼Œåˆ™å°† <code>to_tail</code> ç½®ä¸º trueï¼›å¦åˆ™ï¼Œè‹¥å†…å­˜å—çš„ <code>order &gt;= SHUFFLE_ORDER</code>ï¼ˆ<code>MAX_ORDER - 1</code>ï¼‰ï¼Œåˆ™å°† <code>to_tail</code> ç½®ä¸ºéšæœºç»“æœï¼ˆ<code>shuffle_pick_tail()</code>ï¼‰ï¼›å¦åˆ™ç½®ä¸ºè°ƒç”¨ <code>buddy_merge_likely()</code> çš„ç»“æœï¼Œè¯¥å‡½æ•°ä¼šæ£€æŸ¥æ˜¯å¦ä¸‹ä¸€ä¸ªæœ€é«˜é˜¶çš„ buddy æ˜¯å¦ç©ºé—²ï¼Œè‹¥æ˜¯ï¼Œåˆ™å¯èƒ½æ­£åœ¨é‡Šæ”¾çš„é¡µé¢å—å°†å¾ˆå¿«è¢«åˆå¹¶ï¼Œæ­¤æ—¶æˆ‘ä»¬åº”å½“å°†å…¶æ·»åŠ åˆ°é“¾è¡¨çš„å°¾éƒ¨ï¼Œè¿™æ ·å°±ä¸å¤§å¯èƒ½åˆè¢«åˆ«çš„è¿›ç¨‹å¾ˆå¿«å°±åˆ†é…èµ°äº†ï¼Œè€Œæ˜¯å¯èƒ½è¢«åˆå¹¶ä¸ºé«˜é˜¶é¡µé¢</li>
<li>è‹¥ <code>to_tail</code> ä¸ºçœŸï¼Œåˆ™è°ƒç”¨ <code>add_to_free_list_tail()</code> å°†è¯¥ç©ºé—²é¡µæ·»åŠ åˆ°é“¾è¡¨æœ«å°¾ï¼Œå¦åˆ™è°ƒç”¨ <code>add_to_free_list()</code> æ·»åŠ åˆ°é“¾è¡¨å¼€å¤´</li>
</ul>
<h2 id="äºŒã€ä¸Šå±‚å°è£…å‡½æ•°"><a href="#äºŒã€ä¸Šå±‚å°è£…å‡½æ•°" class="headerlink" title="äºŒã€ä¸Šå±‚å°è£…å‡½æ•°"></a>äºŒã€<em>ä¸Šå±‚å°è£…å‡½æ•°</em></h2><p>æ‰€æœ‰é¡µé¢é‡Šæ”¾çš„å‡½æ•°å…¶å®éƒ½æ˜¯å¯¹ <code>__free_one_page()</code> çš„å°è£…ï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ°è¿™ä¸ªå‡½æ•°ï¼Œè·¯å¾„å¦‚ä¸‹ï¼š</p>
<p><img src="https://s2.loli.net/2022/07/06/ktV7cNlohiQCSWP.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/OS/" class="category-chain-item">OS</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Linux/">#Linux</a>
      
        <a href="/tags/Linux-Kernel/">#Linux Kernel</a>
      
        <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">#æ“ä½œç³»ç»Ÿ</a>
      
        <a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">#å†…å­˜ç®¡ç†</a>
      
        <a href="/tags/buddy-system/">#buddy system</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>ã€OS.0x03ã€‘Linuxå†…æ ¸å†…å­˜ç®¡ç†II - Buddy System</div>
      <div>https://arttnba3.github.io/2022/06/30/OS-0X03-LINUX-KERNEL-MEMORY-5.11-PART-II/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>arttnba3</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2022å¹´6æœˆ30æ—¥</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>è®¸å¯åè®®</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/07/15/VIRTUALIZATION-0X00-QEMU-PART-I/" title="ã€VIRT.0x00ã€‘Qemu - Iï¼šQemu ç®€æ˜“é£Ÿç”¨æŒ‡å—">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ã€VIRT.0x00ã€‘Qemu - Iï¼šQemu ç®€æ˜“é£Ÿç”¨æŒ‡å—</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/05/28/ALGORITHM-0X04-RED_BLACK_TREE/" title="ã€ALGORITHM.0x04ã€‘ä»äºŒå‰æœç´¢æ ‘åˆ°çº¢é»‘æ ‘">
                        <span class="hidden-mobile">ã€ALGORITHM.0x04ã€‘ä»äºŒå‰æœç´¢æ ‘åˆ°çº¢é»‘æ ‘</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.17/Valine.min.js', function() {
        var options = Object.assign(
          {"appid":"ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz","appkey":"tuvJh3xYxPFcW2JB6K26RKP2","path":"window.location.pathname","placeholder":"è¯´ç‚¹ä»€ä¹ˆå‘—ï¼ˆç¬‘ï¼‰","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false,"appId":"ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz","appKey":"tuvJh3xYxPFcW2JB6K26RKP2"},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  <!-- ç½‘ç«™è¿è¡Œæ—¶é—´çš„è®¾ç½® -->
  <span id="timeDate">è½½å…¥å¤©æ•°...</span>
  <span id="times">è½½å…¥æ—¶åˆ†ç§’...</span>
  <script>
      var now = new Date();
      function createtime() {
          var grt= new Date("04/20/2020 17:48:48");//æ­¤å¤„ä¿®æ”¹ä½ çš„å»ºç«™æ—¶é—´æˆ–è€…ç½‘ç«™ä¸Šçº¿æ—¶é—´
          now.setTime(now.getTime()+250);
          days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
          hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
          if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
          mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
          seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
          snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
          document.getElementById("timeDate").innerHTML = "arttnba3çš„å°å±‹å·²ç»å®‰å…¨å­˜åœ¨äº† "+dnum+" å¤© ";
          document.getElementById("times").innerHTML = hnum + " å°æ—¶ " + mnum + " åˆ† " + snum + " ç§’";
      }
  setInterval("createtime()",250);
  </script>
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="busuanzi_value_site_pv"></span>
         æ¬¡
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="busuanzi_value_site_uv"></span>
         äºº
      </span>
    
    
  
</div>

  
  
    <!-- å¤‡æ¡ˆä¿¡æ¯ ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      æ¡‚ICPå¤‡2022005068å·-1
    </a>
  </span>
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.1/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
